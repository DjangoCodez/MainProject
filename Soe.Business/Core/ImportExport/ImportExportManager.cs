using ExcelDataReader;
using Newtonsoft.Json;
using OfficeOpenXml.Style;
using Soe.Edi.Common.DTO;
using SoftOne.Communicator.Shared.DTO;
using SoftOne.Soe.Business.Core.PaymentIO;
using SoftOne.Soe.Business.Core.Reporting;
using SoftOne.Soe.Business.Core.Reporting.Matrix.Models;
using SoftOne.Soe.Business.Core.Reporting.Models.Time;
using SoftOne.Soe.Business.Core.TimeEngine;
using SoftOne.Soe.Business.Core.Util.ICA;
using SoftOne.Soe.Business.DataCache;
using SoftOne.Soe.Business.DTO;
using SoftOne.Soe.Business.Util;
using SoftOne.Soe.Business.Util.API.Zetes;
using SoftOne.Soe.Business.Util.BatchHelper;
using SoftOne.Soe.Business.Util.Config;
using SoftOne.Soe.Business.Util.ExportFiles;
using SoftOne.Soe.Business.Util.ImportSpecials;
using SoftOne.Soe.Business.Util.ImportSpecials.Interfaces;
using SoftOne.Soe.Business.Util.IO;
using SoftOne.Soe.Business.Util.LogCollector;
using SoftOne.Soe.Business.Util.SOPExport;
using SoftOne.Soe.Common.DTO;
using SoftOne.Soe.Common.DTO.ApiExternal;
using SoftOne.Soe.Common.Util;
using SoftOne.Soe.Data;
using SoftOne.Soe.Data.Util;
using SoftOne.Soe.Shared.DTO;
using SoftOne.Soe.Util;
using SoftOne.Soe.Util.Exceptions;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Data.Entity.Core.Objects;
using System.Data.Entity.Core.Objects.DataClasses;
using System.Diagnostics;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Transactions;
using System.Xml;
using System.Xml.Linq;
using SoftOne.Soe.Business.Core.ImportExport;
using SoftOne.Soe.Business.Core.ManagerFacades;

namespace SoftOne.Soe.Business.Core
{
    public class ImportExportManager : ImportExportCacheManager
    {
        #region Variables

        // Create a logger for use in this class
        private readonly log4net.ILog log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);

        private ParameterObject _parameterObject;

        #endregion

        #region Constructor

        public ImportExportManager(ParameterObject parameterObject) : base(parameterObject)
        {
            this._parameterObject = parameterObject;
        }

        #endregion

        #region XEConnect

        #region Export

        public Export GetExport(int actorCompanyId, int exportId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Export.NoTracking();
            return GetExport(entities, actorCompanyId, exportId);
        }

        private Export GetExport(CompEntities entities, int actorCompanyId, int exportId)
        {
            return (from e in entities.Export
                    where e.ExportId == exportId &&
                    e.ActorCompanyId == actorCompanyId &&
                    e.State == (int)SoeEntityState.Active
                    select e).FirstOrDefault();
        }

        public List<Export> GetExports(int actorCompanyId, SoeModule module, int? exportId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ImportDefinition.NoTracking();
            return GetExports(entities, actorCompanyId, module, exportId);
        }

        private List<Export> GetExports(CompEntities entities, int actorCompanyId, SoeModule module, int? exportId = null)
        {
            IQueryable<Export> query = (from i in entities.Export
                                        where i.ActorCompanyId == actorCompanyId &&
                                        i.Module == (int)module &&
                                        i.State == (int)SoeEntityState.Active
                                        select i);
            if (exportId.HasValue)
                query = query.Where(e => e.ExportId == exportId.Value);

            return query.OrderBy(e => e.Name).ToList();
        }

        public Dictionary<int, string> GetExportsDict(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Export.NoTracking();
            return (from i in entities.Export
                    where i.ActorCompanyId == actorCompanyId &&
                    i.State == (int)SoeEntityState.Active
                    orderby i.Name
                    select new
                    {
                        i.ExportId,
                        i.Name
                    }).ToDictionary(a => a.ExportId, a => a.Name);
        }

        public ActionResult SaveExport(int actorCompanyId, ExportDTO exportInput)
        {
            if (exportInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "Export");

            // Default result is successful
            ActionResult result = new ActionResult();

            int exportId = exportInput.ExportId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Export

                        // Get existing export
                        Export export = GetExport(entities, actorCompanyId, exportId);
                        if (export == null)
                        {
                            #region Add

                            export = new Export()
                            {
                                ActorCompanyId = actorCompanyId,
                            };

                            SetCreatedPropertiesOnEntity(export);

                            entities.Export.AddObject(export);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedPropertiesOnEntity(export);

                            #endregion
                        }

                        #region Common

                        export.ExportDefinitionId = exportInput.ExportDefinitionId;
                        export.Module = exportInput.Module;
                        export.Standard = exportInput.Standard;
                        export.Name = exportInput.Name;
                        export.Filename = exportInput.Filename;
                        export.Emailaddress = exportInput.Emailaddress;
                        export.Subject = exportInput.Subject;
                        export.AttachFile = exportInput.AttachFile;
                        export.SendDirect = exportInput.SendDirect;
                        export.Guid = exportInput.Guid;
                        export.SpecialFunctionality = exportInput.SpecialFunctionality;
                        export.SpecialFunctionality = exportInput.SpecialFunctionality;

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);

                        if (result.Success)
                        {
                            // Commit transaction
                            transaction.Complete();

                            exportId = export.ExportId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                        result.IntegerValue = exportId;
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteExport(int actorCompanyId, int exportId)
        {
            using (CompEntities entities = new CompEntities())
            {
                Export export = GetExport(entities, actorCompanyId, exportId);
                if (export == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "Export");

                return ChangeEntityState(entities, export, SoeEntityState.Deleted, true);
            }
        }

        #region Files

        public FileExportResult GetFileExportResult(CompEntities entities, Guid trackingGuid, int actorCompanyId, int exportId, string fileName, bool forceNoColumnHeaders, string eventInfo = null)
        {
            try
            {
                FileExportResult file = null;
                var export = entities.Export.FirstOrDefault(w => w.ActorCompanyId == actorCompanyId && w.ExportId == exportId && w.State == (int)SoeEntityState.Active);

                if (export?.ExportDefinitionId == null)
                    return null;

                var exportDefinition = entities.ExportDefinition.Include("ExportDefinitionLevel.ExportDefinitionLevelColumn").FirstOrDefault(w => w.ActorCompanyId == actorCompanyId && w.ExportDefinitionId == export.ExportDefinitionId && w.State == (int)SoeEntityState.Active);

                if (exportDefinition == null)
                {
                    var company = entities.Company.FirstOrDefault(f => f.ActorCompanyId == actorCompanyId);
                    var exportDefinitionOnOtherCompanyOnLicense = entities.ExportDefinition.FirstOrDefault(w => w.Company.LicenseId == company.LicenseId && w.ExportDefinitionId == export.ExportDefinitionId && w.State == (int)SoeEntityState.Active && w.SharedOnLicense);

                    if (exportDefinitionOnOtherCompanyOnLicense != null)
                        exportDefinition = entities.ExportDefinition.Include("ExportDefinitionLevel.ExportDefinitionLevelColumn").FirstOrDefault(w => w.Company.LicenseId == company.LicenseId && w.ExportDefinitionId == export.ExportDefinitionId && w.State == (int)SoeEntityState.Active);
                }

                if (exportDefinition?.ExportDefinitionLevel == null)
                    return null;

                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                var reportUserSelection = exportDefinition.ReportUserSelectionId.HasValue ? entitiesReadOnly.ReportUserSelection.FirstOrDefault(w => exportDefinition.ReportUserSelectionId.HasValue && exportDefinition.ReportUserSelectionId == w.ReportUserSelectionId && w.State == (int)SoeEntityState.Active) : null;

                if (reportUserSelection == null)
                {
                    reportUserSelection = FileExportMatrix.TryGetReportSelectionFromExport(export.ToDTO(), actorCompanyId, base.UserId);
                    reportUserSelection.Report = entities.Report.FirstOrDefault(f => f.ReportId == reportUserSelection.ReportId);
                }

                if (reportUserSelection != null)
                {
                    if (!reportUserSelection.UserId.HasValue)
                        reportUserSelection.UserId = base.UserId;

                    if (reportUserSelection.UserId.HasValue)
                    {
                        parameterObject.SetSoeUser(UserManager.GetSoeUser(actorCompanyId, reportUserSelection.UserId.Value));
                        parameterObject.SetSoeCompany(CompanyManager.GetSoeCompany(actorCompanyId));
                    }
                    ReportDataManager reportDataManager = new ReportDataManager(parameterObject);
                    file = reportDataManager.CreateFileForExportFileFromReportUserSelectionDTO(reportUserSelection, actorCompanyId, 0, fileName, exportId, exportDefinition, forceNoColumnHeaders, eventInfo);
                }

                return file;
            }
            catch (Exception ex)
            {
                base.LogError(new Exception($"Tracking guid {trackingGuid} {ex.Message}", ex), this.log);
                return new FileExportResult() { Result = new ActionResult(false) };
            }
        }

        #endregion

        #endregion

        #region ExportDefinition

        public ExportDefinition GetExportDefinition(int actorCompanyId, int exportDefinitionId, bool includeLevelColumns = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ExportDefinition.NoTracking();
            return GetExportDefinition(entities, actorCompanyId, exportDefinitionId, includeLevelColumns);
        }

        private ExportDefinition GetExportDefinition(CompEntities entities, int actorCompanyId, int exportDefinitionId, bool includeLevelColumns = false)
        {
            IQueryable<ExportDefinition> query = entities.ExportDefinition.Include("ExportDefinitionLevel");

            if (includeLevelColumns)
                query.Include("ExportDefinitionLevel.ExportDefinitionLevelColumn");

            return (from i in query
                    where i.ExportDefinitionId == exportDefinitionId &&
                    i.ActorCompanyId == actorCompanyId &&
                    i.State == (int)SoeEntityState.Active
                    select i).FirstOrDefault();

        }

        public List<ExportDefinition> GetExportDefinitions(int actorCompanyId, int? exportDefinitionId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ImportDefinition.NoTracking();
            return GetExportDefinitions(entities, actorCompanyId, exportDefinitionId);
        }

        private List<ExportDefinition> GetExportDefinitions(CompEntities entities, int actorCompanyId, int? exportDefinitionId = null)
        {
            IQueryable<ExportDefinition> query = (from i in entities.ExportDefinition
                                                  where i.ActorCompanyId == actorCompanyId &&
                                                  (i.State == (int)SoeEntityState.Active || i.State == (int)SoeEntityState.Inactive)
                                                  select i);

            if (exportDefinitionId.HasValue)
                query = query.Where(ed => ed.ExportDefinitionId == exportDefinitionId.Value);

            return query.ToList();
        }

        public Dictionary<int, string> GetExportDefinitionsDict(int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = GetExportDefinitions(actorCompanyId).ToDictionary(k => k.ExportDefinitionId, v => v.Name);
            if (addEmptyRow)
                dict.Add(0, " ");

            return dict.Sort();
        }

        public ActionResult SaveExportDefinition(int actorCompanyId, ExportDefinitionDTO exportDefinitionInput)
        {
            if (exportDefinitionInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ExportDefinition");

            // Default result is successful
            ActionResult result = new ActionResult();

            int exportDefinitionId = exportDefinitionInput.ExportDefinitionId;
            List<ExportDefinitionLevelDTO> levelsInput = exportDefinitionInput.ExportDefinitionLevels;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region ExportDefinition

                        // Get existing definition
                        ExportDefinition exportDefinition = GetExportDefinition(entities, actorCompanyId, exportDefinitionId, true);
                        if (exportDefinition == null)
                        {
                            #region ExportDefinition Add

                            exportDefinition = new ExportDefinition()
                            {
                                ActorCompanyId = actorCompanyId,
                                SysExportHeadId = exportDefinitionInput.SysExportHeadId,
                                Name = exportDefinitionInput.Name,
                                Type = (int)exportDefinitionInput.Type,
                                Separator = exportDefinitionInput.Separator,
                                XmlTagHead = exportDefinitionInput.XmlTagHead,
                                SpecialFunctionality = exportDefinitionInput.SpecialFunctionality
                                // ReportUserSelectionId = 0 // TO-DO
                            };

                            SetCreatedPropertiesOnEntity(exportDefinition);

                            entities.ExportDefinition.AddObject(exportDefinition);


                            #endregion
                        }
                        else
                        {
                            #region ExportDefinition Update

                            exportDefinition.SysExportHeadId = exportDefinitionInput.SysExportHeadId;
                            exportDefinition.Name = exportDefinitionInput.Name;
                            exportDefinition.Type = (int)exportDefinitionInput.Type;
                            exportDefinition.Separator = exportDefinitionInput.Separator;
                            exportDefinition.XmlTagHead = exportDefinitionInput.XmlTagHead;
                            exportDefinition.SpecialFunctionality = exportDefinitionInput.SpecialFunctionality;
                            exportDefinition.State = (int)exportDefinitionInput.State;
                            // exportDefinition.ReportUserSelectionId = 0; // TO-DO

                            SetModifiedPropertiesOnEntity(exportDefinition);

                            #endregion
                        }

                        #endregion

                        #region ExportDefinitionLevel

                        #region ExportDefinitionLevel Update/Delete

                        // Update or Delete existing ExportDefinitionLevel records
                        foreach (ExportDefinitionLevel level in exportDefinition.ExportDefinitionLevel.ToList())
                        {
                            // Try get level from input
                            ExportDefinitionLevelDTO levelInput = (from s in exportDefinitionInput.ExportDefinitionLevels
                                                                   where s.ExportDefinitionLevelId == level.ExportDefinitionLevelId
                                                                   select s).FirstOrDefault();

                            if (levelInput != null)
                            {
                                #region ExportDefinitionLevel Update

                                // Update existing record
                                level.Level = levelInput.Level;
                                level.Xml = levelInput.Xml;

                                #endregion

                                #region ExportDefinitionLevelColumn

                                foreach (ExportDefinitionLevelColumn column in level.ExportDefinitionLevelColumn.ToList())
                                {
                                    // Try get column from input
                                    ExportDefinitionLevelColumnDTO columnInput = (from s in levelInput.ExportDefinitionLevelColumns
                                                                                  where s.ExportDefinitionLevelColumnId == column.ExportDefinitionLevelColumnId
                                                                                  select s).FirstOrDefault();

                                    if (columnInput != null)
                                    {
                                        #region ExportDefinitionLevelColumn Update

                                        // Update existing record
                                        column.Name = columnInput.Name;
                                        column.Description = columnInput.Description;
                                        column.Key = columnInput.Key;
                                        column.Position = columnInput.Position;
                                        column.DefaultValue = columnInput.DefaultValue;
                                        column.ColumnLength = columnInput.ColumnLength;
                                        column.ConvertValue = columnInput.ConvertValue;

                                        #endregion
                                    }
                                    else
                                    {
                                        #region ExportDefinitionLevelColumn Delete

                                        // Delete existing record
                                        column.State = (int)SoeEntityState.Deleted;

                                        #endregion
                                    }
                                }

                                #region ExportDefinitionLevelColumn Add

                                // Get new records
                                IEnumerable<ExportDefinitionLevelColumnDTO> columnsToAdd = (from s in levelInput.ExportDefinitionLevelColumns
                                                                                            where s.ExportDefinitionLevelColumnId == 0
                                                                                            select s).ToList();

                                foreach (ExportDefinitionLevelColumnDTO columnToAdd in columnsToAdd)
                                {
                                    // Add columns to level
                                    ExportDefinitionLevelColumn exportDefinitionLevelColumn = new ExportDefinitionLevelColumn()
                                    {
                                        Name = columnToAdd.Name,
                                        Description = columnToAdd.Description,
                                        Key = columnToAdd.Key,
                                        Position = columnToAdd.Position,
                                        DefaultValue = columnToAdd.DefaultValue,
                                        ColumnLength = columnToAdd.ColumnLength,
                                        ConvertValue = columnToAdd.ConvertValue
                                    };
                                    level.ExportDefinitionLevelColumn.Add(exportDefinitionLevelColumn);
                                }

                                #endregion

                                #endregion
                            }
                            else
                            {
                                #region ExportDefinitionLevel Delete

                                // Delete existing record
                                level.State = (int)SoeEntityState.Deleted;

                                #endregion
                            }
                        }

                        #endregion

                        #region ExportDefinitionLevel Add

                        // Get new records
                        IEnumerable<ExportDefinitionLevelDTO> levelsToAdd = (from s in levelsInput
                                                                             where s.ExportDefinitionLevelId == 0
                                                                             select s).ToList();

                        foreach (ExportDefinitionLevelDTO levelToAdd in levelsToAdd)
                        {
                            // Add level to definition
                            ExportDefinitionLevel exportDefinitionLevel = new ExportDefinitionLevel()
                            {
                                Level = levelToAdd.Level,
                                Xml = levelToAdd.Xml
                            };

                            #region ExportDefinitionLevelColumn Add

                            // Get new records
                            IEnumerable<ExportDefinitionLevelColumnDTO> columnsToAdd = (from s in levelToAdd.ExportDefinitionLevelColumns
                                                                                        where s.ExportDefinitionLevelColumnId == 0
                                                                                        select s).ToList();

                            foreach (ExportDefinitionLevelColumnDTO columnToAdd in columnsToAdd)
                            {
                                // Add columns to level
                                ExportDefinitionLevelColumn exportDefinitionLevelColumn = new ExportDefinitionLevelColumn()
                                {
                                    Name = columnToAdd.Name,
                                    Description = columnToAdd.Description,
                                    Key = columnToAdd.Key,
                                    Position = columnToAdd.Position,
                                    DefaultValue = columnToAdd.DefaultValue,
                                    ColumnLength = columnToAdd.ColumnLength,
                                    ConvertValue = columnToAdd.ConvertValue
                                };
                                exportDefinitionLevel.ExportDefinitionLevelColumn.Add(exportDefinitionLevelColumn);
                            }

                            #endregion

                            exportDefinition.ExportDefinitionLevel.Add(exportDefinitionLevel);
                        }

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);

                        if (result.Success)
                        {
                            // Commit transaction
                            transaction.Complete();

                            exportDefinitionId = exportDefinition.ExportDefinitionId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        result.IntegerValue = exportDefinitionId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteExportDefinition(int actorCompanyId, int exportDefinitionId)
        {
            using (CompEntities entities = new CompEntities())
            {
                ExportDefinition exportDefinition = GetExportDefinition(entities, actorCompanyId, exportDefinitionId);
                if (exportDefinition == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "ExportDefinition");

                return ChangeEntityState(entities, exportDefinition, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region ExportDefinitionLevelColumns

        public List<ExportDefinitionLevelColumn> GetExportDefinitionLevelColumns(CompEntities entities, int exportDefinitionLevelId)
        {
            return (from i in entities.ExportDefinitionLevelColumn
                    where i.ExportDefinitionLevelId == exportDefinitionLevelId &&
                    i.State == (int)SoeEntityState.Active
                    select i).ToList();
        }

        public ExportDefinitionLevelColumn GetExportDefinitionLevelColumn(int exportDefinitionLevelColumnId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ExportDefinitionLevelColumn.NoTracking();
            return GetExportDefinitionLevelColumn(entities, exportDefinitionLevelColumnId);
        }

        private ExportDefinitionLevelColumn GetExportDefinitionLevelColumn(CompEntities entities, int exportDefinitionLevelColumnId)
        {
            return (from i in entities.ExportDefinitionLevelColumn
                    where i.ExportDefinitionLevelColumnId == exportDefinitionLevelColumnId &&
                    i.State == (int)SoeEntityState.Active
                    select i).FirstOrDefault();
        }

        public ActionResult SaveExportDefinitionLevelColumn(ExportDefinitionLevelColumnDTO exportDefinitionLevelColumnInput)
        {
            if (exportDefinitionLevelColumnInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ExportDefinitionLevelColumn");

            // Default result is successful
            ActionResult result = new ActionResult();

            int exportDefinitionLevelColumnId = exportDefinitionLevelColumnInput.ExportDefinitionLevelColumnId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        // Get existing definition
                        ExportDefinitionLevelColumn exportDefinitionLevelColumn = GetExportDefinitionLevelColumn(entities, exportDefinitionLevelColumnId);
                        if (exportDefinitionLevelColumn == null)
                        {
                            #region ExportDefinitionLevelColumn Add

                            exportDefinitionLevelColumn = new ExportDefinitionLevelColumn()
                            {
                                ExportDefinitionLevelId = exportDefinitionLevelColumnInput.ExportDefinitionLevelId,
                                Name = exportDefinitionLevelColumnInput.Name,
                                Description = exportDefinitionLevelColumnInput.Description,
                                Key = exportDefinitionLevelColumnInput.Key,
                                DefaultValue = exportDefinitionLevelColumnInput.DefaultValue,
                                Position = exportDefinitionLevelColumnInput.Position,
                                ColumnLength = exportDefinitionLevelColumnInput.ColumnLength,
                                XmlTag = exportDefinitionLevelColumnInput.XmlTag,
                                FillChar = exportDefinitionLevelColumnInput.FillChar,
                                FillBeginning = exportDefinitionLevelColumnInput.FillBeginning,
                                FormatDate = exportDefinitionLevelColumnInput.FormatDate
                            };

                            SetCreatedPropertiesOnEntity(exportDefinitionLevelColumn);

                            entities.ExportDefinitionLevelColumn.AddObject(exportDefinitionLevelColumn);

                            #endregion
                        }
                        else
                        {
                            #region ExportDefinitionLevelColumn Update

                            exportDefinitionLevelColumn.Name = exportDefinitionLevelColumnInput.Name;
                            exportDefinitionLevelColumn.Description = exportDefinitionLevelColumnInput.Description;
                            exportDefinitionLevelColumn.Key = exportDefinitionLevelColumnInput.Key;
                            exportDefinitionLevelColumn.DefaultValue = exportDefinitionLevelColumnInput.DefaultValue;
                            exportDefinitionLevelColumn.Position = exportDefinitionLevelColumnInput.Position;
                            exportDefinitionLevelColumn.ColumnLength = exportDefinitionLevelColumnInput.ColumnLength;
                            exportDefinitionLevelColumn.XmlTag = exportDefinitionLevelColumnInput.XmlTag;
                            exportDefinitionLevelColumn.FillChar = exportDefinitionLevelColumnInput.FillChar;
                            exportDefinitionLevelColumn.FillBeginning = exportDefinitionLevelColumnInput.FillBeginning;
                            exportDefinitionLevelColumn.FormatDate = exportDefinitionLevelColumnInput.FormatDate;

                            SetModifiedPropertiesOnEntity(exportDefinitionLevelColumn);

                            #endregion
                        }


                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        result.IntegerValue = exportDefinitionLevelColumnId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteExportDefinitionLevelColumn(int exportDefinitionLevelColumnId)
        {
            using (CompEntities entities = new CompEntities())
            {
                ExportDefinitionLevelColumn exportDefinitionLevelColumn = GetExportDefinitionLevelColumn(entities, exportDefinitionLevelColumnId);
                if (exportDefinitionLevelColumn == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "ExportDefinitionLevelColumn");

                return ChangeEntityState(entities, exportDefinitionLevelColumn, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region Import

        #region SysImportHead

        public IEnumerable<SysImportHead> GetSysImportHeads()
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return sysEntitiesReadOnly.SysImportHead.Where(s => s.State == (int)SoeEntityState.Active);
        }

        public Dictionary<int, string> GetSysImportHeadsDict()
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return (from s in sysEntitiesReadOnly.SysImportHead
                    where s.State == (int)SoeEntityState.Active
                    orderby s.Name
                    select new
                    {
                        s.SysImportHeadId,
                        s.Name
                    }).ToDictionary(a => a.SysImportHeadId, a => a.Name);
        }

        public SysImportHead GetSysImportHead(int sysImportHeadId)
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return GetSysImportHead(sysEntitiesReadOnly, sysImportHeadId);
        }

        public SysImportHead GetSysImportHeadWithType(int sysImportHeadId)
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return (from s in sysEntitiesReadOnly.SysImportHead.Include("SysImportHeadType")
                    where s.SysImportHeadId == sysImportHeadId &&
                    s.State == (int)SoeEntityState.Active
                    select s).FirstOrDefault();
        }

        public SysImportHead GetSysImportHead(SOESysEntities entities, int sysImportHeadId)
        {
            var importHead = (from s in entities.SysImportHead.Include("SysImportSelect").Include("SysImportRelation").Include("SysImportHeadType")
                              where s.SysImportHeadId == sysImportHeadId &&
                              s.State == (int)SoeEntityState.Active
                              select s).FirstOrDefault();

            if (importHead == null)
                return null;

            foreach (var importSelect in importHead.SysImportSelect)
            {
                SysImportHeadColumnParser parser = new SysImportHeadColumnParser(importSelect.Settings);
                importSelect.SettingsObject = parser.Columns;
            }

            return importHead;
        }

        public SysImportHead GetSysImportHeadWithTypeFromImportId(int actorCompanyId, int importId, out string specialFunctionality)
        {
            SysImportHead importHead = null;
            specialFunctionality = string.Empty;

            Import import = GetImport(actorCompanyId, importId, false);
            int sysImportHeadId = 0;
            if (import != null)
            {
                if (import.Standard)
                {
                    SysImportDefinition sysImportDefinition = GetSysImportDefinition(import.ImportDefinitionId);
                    if (sysImportDefinition != null && sysImportDefinition.SysImportHeadId.HasValue)
                    {
                        sysImportHeadId = sysImportDefinition.SysImportHeadId.Value;
                        specialFunctionality = !string.IsNullOrEmpty(sysImportDefinition.SpecialFunctionality) ? sysImportDefinition.SpecialFunctionality : string.Empty;

                    }
                }
                else
                {
                    ImportDefinition importDefinition = GetImportDefinition(actorCompanyId, import.ImportDefinitionId);
                    if (importDefinition != null && importDefinition.SysImportHeadId.HasValue)
                    {
                        sysImportHeadId = importDefinition.SysImportHeadId.Value;
                        specialFunctionality = !string.IsNullOrEmpty(importDefinition.SpecialFunctionality) ? importDefinition.SpecialFunctionality : string.Empty;
                    }
                }

                importHead = GetSysImportHeadWithType(sysImportHeadId);
            }

            return importHead;
        }

        public List<string> GetSpecialFunctionality(int actorCompanyId, int importId)
        {
            return this.GetSpecialFunctionalityDict(actorCompanyId, importId).Keys.ToList();
        }

        public Dictionary<string, string> GetSpecialFunctionalityDict(int actorCompanyId, int importId)
        {
            string specialFunctionality = string.Empty;

            Import import = GetImport(actorCompanyId, importId, false);
            if (import != null)
            {
                if (import.Standard)
                {
                    SysImportDefinition sysImportDefinition = GetSysImportDefinition(import.ImportDefinitionId);
                    if (sysImportDefinition != null)
                        specialFunctionality = sysImportDefinition.SpecialFunctionality;
                }
                else
                {
                    ImportDefinition importDefinition = GetImportDefinition(actorCompanyId, import.ImportDefinitionId);
                    if (importDefinition != null)
                        specialFunctionality = importDefinition.SpecialFunctionality;
                }

                if (!string.IsNullOrEmpty(specialFunctionality))
                {
                    char[] separator = { ',', ';' };
                    char[] separator2 = { ':' };

                    Dictionary<string, string> separatedSpecials = specialFunctionality.Split(separator, StringSplitOptions.RemoveEmptyEntries).ToDictionary(s => s.Split(separator2).FirstOrDefault(), s => s.Split(separator2).LastOrDefault());
                    return separatedSpecials;
                }
            }

            return new Dictionary<string, string>(0);
        }

        #endregion

        #region SysImportDefinition

        public List<SysImportDefinition> GetSysImportDefinitions(SoeModule module)
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return sysEntitiesReadOnly.SysImportDefinition.Where(s => s.State == (int)SoeEntityState.Active && s.Module == (int)module).OrderBy(s => s.Name).ToList();
        }

        public IEnumerable<SysImportDefinition> GetSysImportDefinitions()
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return sysEntitiesReadOnly.SysImportDefinition.Where(s => s.State == (int)SoeEntityState.Active);
        }

        public Dictionary<int, string> GetSysImportDefinitionsDict()
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return (from s in sysEntitiesReadOnly.SysImportDefinition
                    where s.State == (int)SoeEntityState.Active
                    orderby s.Name
                    select new
                    {
                        s.SysImportDefinitionId,
                        s.Name
                    }).ToDictionary(a => a.SysImportDefinitionId, a => a.Name);
        }

        public SysImportDefinition GetSysImportDefinition(int sysImportDefinitionId)
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return GetSysImportDefinition(sysEntitiesReadOnly, sysImportDefinitionId);
        }

        public SysImportDefinition GetSysImportDefinition(SOESysEntities entities, int sysImportDefinitionId)
        {
            var importDefinition = (from s in entities.SysImportDefinition.Include("SysImportDefinitionLevel").Include("SysImportHead")
                                    where s.SysImportDefinitionId == sysImportDefinitionId &&
                                    s.State == (int)SoeEntityState.Active
                                    select s).FirstOrDefault();
            if (importDefinition != null)
            {
                foreach (var definitionLevel in importDefinition.SysImportDefinitionLevel)
                {
                    SysImportDefinitionColumnParser parser = new SysImportDefinitionColumnParser(definitionLevel.Xml, definitionLevel.Level);
                    definitionLevel.Columns = parser.Columns;
                }
            }

            return importDefinition;
        }

        public SysImportDefinition GetSysImportDefinition(Guid guid)
        {
            using var sysEntitiesReadOnly = SysEntitiesProvider.LeaseReadOnlyContext();
            return GetSysImportDefinition(sysEntitiesReadOnly, guid);
        }

        public SysImportDefinition GetSysImportDefinition(SOESysEntities entities, Guid guid)
        {
            var importDefinition = (from s in entities.SysImportDefinition
                                    where s.Guid == guid &&
                                    s.State == (int)SoeEntityState.Active
                                    select s).FirstOrDefault();
            return importDefinition;
        }

        public ActionResult SaveSysImportDefinition(SysImportDefinitionDTO sysImportDefinitionInput, List<SysImportDefinitionLevelDTO> levelsInput)
        {
            if (sysImportDefinitionInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "SysImportDefinition");

            // Default result is successful
            ActionResult result = new ActionResult();

            int sysImportDefinitionId = sysImportDefinitionInput.SysImportDefinitionId;

            using (SOESysEntities entities = new SOESysEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region SysImportDefinition

                        // Get existing definition
                        SysImportDefinition sysImportDefinition = GetSysImportDefinition(entities, sysImportDefinitionId);
                        if (sysImportDefinition == null)
                        {
                            #region SysImportDefinition Add

                            sysImportDefinition = new SysImportDefinition()
                            {
                                SysImportHeadId = sysImportDefinitionInput.SysImportHeadId,
                                Name = sysImportDefinitionInput.Name,
                                Type = (int)sysImportDefinitionInput.Type,
                                Separator = sysImportDefinitionInput.Separator,
                                XmlTagHead = sysImportDefinitionInput.XmlTagHead,
                                SpecialFunctionality = sysImportDefinitionInput.SpecialFunctionality,
                                Module = (int)sysImportDefinitionInput.Module,
                                Guid = Guid.NewGuid(),
                            };

                            SetCreatedPropertiesOnEntity(sysImportDefinition);

                            entities.SysImportDefinition.Add(sysImportDefinition);

                            #endregion
                        }
                        else
                        {
                            #region SysImportDefinition Update

                            sysImportDefinition.SysImportHeadId = sysImportDefinitionInput.SysImportHeadId;
                            sysImportDefinition.Name = sysImportDefinitionInput.Name;
                            sysImportDefinition.Type = (int)sysImportDefinitionInput.Type;
                            sysImportDefinition.Separator = sysImportDefinitionInput.Separator;
                            sysImportDefinition.XmlTagHead = sysImportDefinitionInput.XmlTagHead;
                            sysImportDefinition.SpecialFunctionality = sysImportDefinitionInput.SpecialFunctionality;
                            sysImportDefinition.State = (int)sysImportDefinitionInput.State;
                            sysImportDefinition.Module = (int)sysImportDefinitionInput.Module;
                            sysImportDefinition.Guid = sysImportDefinitionInput.Guid;
                            SetModifiedPropertiesOnEntity(sysImportDefinition);

                            #endregion
                        }

                        #endregion

                        #region SysImportDefinitionLevel

                        #region SysImportDefinitionLevel Update/Delete

                        // Update or Delete existing SysImportDefinitionLevel records
                        foreach (SysImportDefinitionLevel level in sysImportDefinition.SysImportDefinitionLevel.ToList())
                        {
                            // Try get level from input
                            SysImportDefinitionLevelDTO levelInput = (from s in levelsInput
                                                                      where s.SysImportDefinitionLevelId == level.SysImportDefinitionLevelId
                                                                      select s).FirstOrDefault();

                            if (levelInput != null)
                            {
                                #region SysImportDefinitionLevel Update

                                SysImportDefinitionColumnParser columnsParser = new SysImportDefinitionColumnParser(levelInput.Columns, sysImportDefinitionInput.Type);

                                // Update existing record
                                level.Level = levelInput.Level;
                                level.Xml = columnsParser.XML;

                                #endregion
                            }
                            else
                            {
                                #region SysImportDefinitionLevel Delete

                                // Delete existing record
                                entities.SysImportDefinitionLevel.Remove(level);

                                #endregion
                            }
                        }

                        #endregion

                        #region SysImportDefinitionLevel Add

                        // Get new records
                        IEnumerable<SysImportDefinitionLevelDTO> levelsToAdd = (from s in levelsInput
                                                                                where s.SysImportDefinitionLevelId == 0
                                                                                select s).ToList();

                        foreach (SysImportDefinitionLevelDTO levelToAdd in levelsToAdd)
                        {
                            SysImportDefinitionColumnParser columnsParser = new SysImportDefinitionColumnParser(levelToAdd.Columns, sysImportDefinitionInput.Type);

                            // Add level to definition
                            SysImportDefinitionLevel sysImportDefinitionLevel = new SysImportDefinitionLevel()
                            {
                                Level = levelToAdd.Level,
                                Xml = columnsParser.XML
                            };
                            sysImportDefinition.SysImportDefinitionLevel.Add(sysImportDefinitionLevel);
                        }

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);

                        if (result.Success)
                        {
                            // Commit transaction
                            transaction.Complete();

                            sysImportDefinitionId = sysImportDefinition.SysImportDefinitionId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        result.IntegerValue = sysImportDefinitionId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteSysImportDefinition(int sysImportDefinitionId)
        {
            using (SOESysEntities entities = new SOESysEntities())
            {
                SysImportDefinition sysImportDefinition = GetSysImportDefinition(entities, sysImportDefinitionId);
                if (sysImportDefinition == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "SysImportDefinition");

                return ChangeEntityStateOnEntity(entities, sysImportDefinition, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region Import

        public List<Import> GetImports(int actorCompanyid, SoeModule module, bool addInfoFromDefinition = true)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Import.NoTracking();

            var imports = (from i in entitiesReadOnly.Import
                           where i.ActorCompanyId == actorCompanyid &&
                                 i.State == (int)SoeEntityState.Active &&
                                 i.Module == (int)module
                           select i).ToList();

            if (addInfoFromDefinition)
            {
                List<GenericType> terms = base.GetTermGroupContent(TermGroup.SysImportDefinitionType);

                foreach (var import in imports)
                {
                    LoadInfoFromDefinition(import, terms);
                }
            }

            return imports;
        }

        public List<Import> GetImports(int actorCompanyid, bool addInfoFromDefinition = true)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var imports = (from i in entitiesReadOnly.Import
                           where i.ActorCompanyId == actorCompanyid &&
                                 i.State == (int)SoeEntityState.Active
                           select i).ToList();

            if (addInfoFromDefinition)
            {
                List<GenericType> terms = base.GetTermGroupContent(TermGroup.SysImportDefinitionType);

                foreach (var import in imports)
                {
                    LoadInfoFromDefinition(import, terms);
                }
            }

            return imports;
        }

        public Import GetImport(int actorComapnyid, int importId, bool addInfoFromDefinition = true)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Import.NoTracking();
            return GetImport(entities, actorComapnyid, importId, addInfoFromDefinition);
        }

        private Import GetImport(CompEntities entities, int actorCompanyid, int importId, bool addInfoFromDefinition = true)
        {
            var import = (from i in entities.Import
                          where i.ImportId == importId &&
                          i.ActorCompanyId == actorCompanyid
                          select i).FirstOrDefault();

            if (addInfoFromDefinition)
                LoadInfoFromDefinition(import);

            return import;
        }

        public Import GetImport(Guid guid)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Import.NoTracking();
            return GetImport(entities, guid);
        }

        private Import GetImport(CompEntities entities, Guid guid)
        {
            var import = (from i in entities.Import
                          where i.Guid == guid
                          select i).FirstOrDefault();

            return import;
        }

        public PaymentImport GetPaymentImport(int actorCompanyId, int paymentImportId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.PaymentImport.NoTracking();
            return GetPaymentImport(entities, actorCompanyId, paymentImportId);
        }

        private PaymentImport GetPaymentImport(CompEntities entities, int actorCompanyid, int paymentImportId)
        {
            var paymentImport = (from i in entities.PaymentImport
                                 where i.PaymentImportId == paymentImportId &&
                                 i.ActorCompanyId == actorCompanyid
                                 select i).FirstOrDefault();

            return paymentImport;
        }

        public List<PaymentImportDTO> GetPaymentImports(
            int actorCompanyId,
            int[] importTypes,
            TermGroup_ChangeStatusGridAllItemsSelection allItemsSelection,
            int? paymentImportId = null)
        {
            DateTime? selectionDate = null;
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            switch (allItemsSelection)
            {
                case TermGroup_ChangeStatusGridAllItemsSelection.One_Month:
                    selectionDate = DateTime.Today.AddMonths(-1);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.Tree_Months:
                    selectionDate = DateTime.Today.AddMonths(-3);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.Six_Months:
                    selectionDate = DateTime.Today.AddMonths(-6);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.Twelve_Months:
                    selectionDate = DateTime.Today.AddYears(-1);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.TwentyFour_Months:
                    selectionDate = DateTime.Today.AddYears(-2);
                    break;
            }

            entitiesReadOnly.PaymentImport.NoTracking();
            var dtos = (from e in entitiesReadOnly.PaymentImport
                        where e.ActorCompanyId == actorCompanyId &&
                           e.ImportType.HasValue &&
                           importTypes.Contains(e.ImportType.Value) &&
                           (selectionDate == null || e.ImportDate >= selectionDate) &&
                           e.State == (int)SoeEntityState.Active
                        orderby e.ImportDate descending
                        select new PaymentImportDTO
                        {
                            PaymentImportId = e.PaymentImportId,
                            ImportDate = e.ImportDate,
                            Filename = e.Filename,
                            Created = e.Created,
                            CreatedBy = e.CreatedBy,
                            ActorCompanyId = e.ActorCompanyId,
                            BatchId = e.BatchId,
                            SysPaymentTypeId = (TermGroup_SysPaymentType)e.SysPaymentTypeId,
                            Type = e.Type,
                            TotalAmount = e.TotalAmount,
                            NumberOfPayments = e.NumberOfPayments,
                            Modified = e.Modified,
                            ModifiedBy = e.ModifiedBy,
                            State = (SoeEntityState)e.State,
                            PaymentLabel = e.PaymentLabel,
                            TransferStatus = e.TransferStatus,
                            StatusName = e.TransferMsg,
                            ImportType = (ImportPaymentType)e.ImportType,
                            ImportPaymentTypeTermId = (TermGroup_ImportPaymentType)e.ImportType
                        }).ToList();

            if (paymentImportId.HasValue)
            {
                dtos = dtos.Where(m => m.PaymentImportId == paymentImportId.Value).ToList();
            }

            // We need to check the rows to set an appropiate status of the import, but only need the state/status columns for that.
            var batchIds = dtos
                .Select(d => d.BatchId)
                .ToList();
            var importStatuses = entitiesReadOnly.PaymentImportIO
                .Where(pi =>
                    pi.ActorCompanyId == actorCompanyId
                    && pi.State != (int)ImportPaymentIOState.Deleted
                    && pi.ImportType.HasValue
                    && importTypes.Contains(pi.ImportType.Value))
                .Where(pi => batchIds.Contains(pi.BatchNr))
                .GroupBy(pi => pi.BatchNr)
                .Select(g => new
                {
                    BatchId = g.Key,
                    Rows = g
                        .Select(pi => new
                        {
                            pi.Status,
                            pi.State
                        })
                        .Distinct()
                        .ToList()
                }).ToList();

            var voidedText = GetText(4627, (int)TermGroup.AngularEconomy, "Makulerad");
            var processingText = GetText(2, (int)TermGroup.EDIStatus, "Under behandling");
            var processedText = GetText(3, (int)TermGroup.EDIStatus, "Behandlad");

            foreach (var dto in dtos)
            {
                var importRows = importStatuses.FirstOrDefault(i => i.BatchId == dto.BatchId);
                if (importRows == null) continue;

                if (importRows.Rows.Any(r => r.Status == (int)ImportPaymentIOStatus.Deleted))
                {
                    dto.State = SoeEntityState.Inactive;
                    dto.StatusName = voidedText;
                }
                else if (!dto.TransferStatus.HasValue || string.IsNullOrEmpty(dto.StatusName))
                {
                    dto.StatusName = importRows.Rows.Any(r => (r.Status != (int)ImportPaymentIOStatus.Paid && r.Status != (int)ImportPaymentIOStatus.ManuallyHandled && r.State == (int)ImportPaymentIOState.Open)) ?
                        processingText :
                        processedText;
                }
            }

            return dtos;
        }

        public Dictionary<int, string> GetSysPaymentTypeDict()
        {
            return base.GetTermGroupDict(TermGroup.SysPaymentType, addEmptyRow: true);
        }

        public ActionResult DeleteImport(int importId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                Import import = GetImport(entities, actorCompanyId, importId, false);
                if (import == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "SysImportDefinition");

                return ChangeEntityState(entities, import, SoeEntityState.Deleted, true);
            }
        }

        public ActionResult SaveImport(ImportDTO importInput, int actorCompanyId)
        {
            if (importInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ImportDTO");

            if (importInput.ImportDefinitionId == 0)
                return new ActionResult((int)ActionResultSave.NothingSaved, "ImportDefinition ej valt");

            ActionResult result = new ActionResult();
            int importId = importInput.ImportId;

            int module;
            if (importInput.IsStandard)
                module = GetSysImportDefinition(importInput.ImportDefinitionId)?.Module ?? 0;
            else
                module = GetImportDefinition(actorCompanyId, importInput.ImportDefinitionId)?.Module ?? 0;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {

                        Import import = GetImport(entities, actorCompanyId, importId, false);

                        if (import == null)
                        {
                            import = new Import()
                            {
                                ActorCompanyId = actorCompanyId,
                                Standard = importInput.IsStandard,
                                ImportDefinitionId = importInput.ImportDefinitionId,
                                Name = importInput.Name,
                                UseAccountDistribution = importInput.UseAccountDistribution,
                                UseAccountDims = importInput.UseAccountDimensions,
                                UpdateExistingInvoice = importInput.UpdateExistingInvoice,
                                Module = module,
                                Guid = Guid.NewGuid(),
                                AccountYearId = importInput.AccountYearId,
                                VoucherSeriesId = importInput.VoucherSeriesId,
                                Dim1AccountId = importInput.Dim1AccountId,
                                Dim2AccountId = importInput.Dim2AccountId,
                                Dim3AccountId = importInput.Dim3AccountId,
                                Dim4AccountId = importInput.Dim4AccountId,
                                Dim5AccountId = importInput.Dim5AccountId,
                                Dim6AccountId = importInput.Dim6AccountId
                            };

                            SetCreatedProperties(import);
                            entities.Import.AddObject(import);
                        }
                        else
                        {
                            import.Standard = importInput.IsStandard;
                            import.ImportDefinitionId = importInput.ImportDefinitionId;
                            import.Name = importInput.Name;
                            import.UseAccountDistribution = importInput.UseAccountDistribution;
                            import.UseAccountDims = importInput.UseAccountDimensions;
                            import.UpdateExistingInvoice = importInput.UpdateExistingInvoice;
                            import.Module = module;
                            import.Guid = importInput.Guid != Guid.Empty ? importInput.Guid : Guid.NewGuid();
                            import.AccountYearId = importInput.AccountYearId;
                            import.VoucherSeriesId = importInput.VoucherSeriesId;
                            import.Dim1AccountId = importInput.Dim1AccountId;
                            import.Dim2AccountId = importInput.Dim2AccountId;
                            import.Dim3AccountId = importInput.Dim3AccountId;
                            import.Dim4AccountId = importInput.Dim4AccountId;
                            import.Dim5AccountId = importInput.Dim5AccountId;
                            import.Dim6AccountId = importInput.Dim6AccountId;
                            SetModifiedProperties(import);
                        }

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            // Commit transaction
                            transaction.Complete();
                            importId = import.ImportId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        result.IntegerValue = importId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }
            return result;
        }

        public List<ImportSelectionGridRowDTO> GetImportSelectionGrid(int actoryCompanyId, IEnumerable<ImportFileDTO> files)
        {
            var result = new List<ImportSelectionGridRowDTO>();

            string duplicateMessage = GetText(217, TermGroup.AngularCommon);
            string fileTypeMissing = GetText(218, TermGroup.AngularCommon);
            string fileDefinitionNotFound = GetText(219, TermGroup.AngularCommon);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var imports = entitiesReadOnly.Import
              .Where(i =>
                  i.ActorCompanyId == actoryCompanyId &&
                  i.State == (int)SoeEntityState.Active &&
                  i.Module == (int)SoeModule.Economy)
              .ToList();

            var dataStorageIds = files.Select(f => f.DataStorageId);
            var fileNames = files.Select(f => f.FileName);
            var duplicateFileNames = entitiesReadOnly.DataStorage
                .Where(ds =>
                    ds.ActorCompanyId == actoryCompanyId &&
                    fileNames.Contains(ds.FileName) &&
                    !dataStorageIds.Contains(ds.DataStorageId))
                .Select(ds => ds.FileName)
                .ToList();

            var importDefinitionList = GetSysImportDefinitions(SoeModule.Economy);
            foreach (var file in files)
            {
                (int? importDefinitionId, string fileType) = GetImportDefinitionIdFromListByFileName(file.FileName, importDefinitionList);
                string message = "";
                Import import = null;

                if (importDefinitionId is null)
                    message = fileTypeMissing;
                else
                    import = imports.FirstOrDefault(i => i.ImportDefinitionId == importDefinitionId);

                if (!(importDefinitionId is null) && import is null)
                    message = fileDefinitionNotFound;

                if (duplicateFileNames.Contains(file.FileName))
                    if (message.Length > 0)
                        message += string.Concat("; ", duplicateMessage);
                    else
                        message = duplicateMessage;

                result.Add(new ImportSelectionGridRowDTO(
                    file.FileName,
                    fileType,
                    file.DataStorageId,
                    import?.ToDTO(),
                    message
                ));
            }

            return result;
        }

        private static (int?, string) GetImportDefinitionIdFromListByFileName(string fileName, IEnumerable<SysImportDefinition> importDefinitionList)
        {
            var fileType = fileName.Split('.')[0];
            int? importDefinitionId = null;
            switch (fileType)
            {
                case "N25":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_VER_KAK))?
                        .SysImportDefinitionId;
                    break;
                case "N26":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_VER_KAK))?
                        .SysImportDefinitionId;
                    break;
                case "FPP26":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_VER_KAK))?
                        .SysImportDefinitionId;
                    break;
                case "FPP3":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_CUST))?
                        .SysImportDefinitionId;
                    break;
                case "FPP5":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_VER_DAK))?
                        .SysImportDefinitionId;
                    break;
                case "FPP32":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_VER_DAK))?
                        .SysImportDefinitionId;
                    break;
                case "FPP45":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_VER_DAK))?
                        .SysImportDefinitionId;
                    break;
                case "ID5":
                    importDefinitionId = importDefinitionList
                        .FirstOrDefault(i => i.Name.Equals(ImportDefinitionEnum.ICA_ORDER))?
                        .SysImportDefinitionId;
                    break;
                default:
                    break;
            }

            return (importDefinitionId, importDefinitionId != null ? fileType : null);
        }

        #endregion

        #region ImportDefinition

        public ImportDefinition GetImportDefinition(int actorCompanyId, int importDefinitionId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ImportDefinition.NoTracking();
            return GetImportDefinition(entities, actorCompanyId, importDefinitionId);
        }

        private ImportDefinition GetImportDefinition(CompEntities entities, int actorCompanyId, int importDefinitionId)
        {
            return (from i in entities.ImportDefinition
                    where i.ImportDefinitionId == importDefinitionId &&
                    i.ActorCompanyId == actorCompanyId
                    select i).FirstOrDefault();
        }

        private void LoadInfoFromDefinition(Import import, List<GenericType> typeTerms = null)
        {
            if (typeTerms == null)
                typeTerms = base.GetTermGroupContent(TermGroup.SysImportDefinitionType);

            if (import.Standard)
            {
                var item = GetSysImportDefinition(import.ImportDefinitionId);
                if (item != null)
                {
                    if (item.SysImportHead != null)
                        import.ImportHeadType = item.SysImportHead.SysImportHeadTypeId;

                    import.HeadName = item.Name;
                    import.Type = (TermGroup_SysImportDefinitionType)item.Type;
                    import.SpecialFunctionality = item.SpecialFunctionality;
                }
            }
            else
            {
                var item = GetImportDefinition(import.ActorCompanyId, import.ImportDefinitionId);
                if (item != null)
                {
                    if (item.SysImportHeadId != null)
                    {
                        var head = GetSysImportHead((int)item.SysImportHeadId);

                        if (head != null)
                            import.ImportHeadType = head.SysImportHeadTypeId;
                    }

                    import.HeadName = item.Name;
                    import.Type = (TermGroup_SysImportDefinitionType)item.Type;
                    import.SpecialFunctionality = item.SpecialFunctionality;
                }
            }

            if (typeTerms.Any(x => x.Id == (int)import.Type))
                import.TypeText = typeTerms.FirstOrDefault(x => x.Id == (int)import.Type)?.Name;
        }

        #endregion

        #region ImportLogic

        static byte[] Decompress(byte[] gzip)
        {
            return ZipUtility.DecompressGZip(gzip);
        }

        public ActionResult XEConnectWebService(int actorcompanyId, User user, int definitionId, bool isCompressed, int importHeadId, List<byte[]> content, bool contentIsByteFromString)
        {
            int importId = 0;
            int accountYearId = 0;
            int voucherSeriesId = 0;
            bool continueDirectlyFromIO = true;

            parameterObject.SetSoeUser(UserManager.GetSoeUser(actorcompanyId, user));

            return XEConnectImport(actorcompanyId, importId, accountYearId, voucherSeriesId, content, isCompressed, definitionId, importHeadId, contentIsByteFromString, continueDirectlyFromIO: continueDirectlyFromIO);
        }

        public ActionResult XEConnectImport(int actorCompanyId, int importId, List<int> dataStorageIds, int accountYearId, int voucherSeriesId, int importDefinitionId)
        {
            //content
            List<byte[]> contents = new List<byte[]>();

            foreach (int dataStorageId in dataStorageIds)
            {
                DataStorage dataStorage = GeneralManager.GetDataStorage(dataStorageId, actorCompanyId, false);
                contents.Add(dataStorage.Data);
            }

            return XEConnectImport(actorCompanyId, importId, accountYearId, voucherSeriesId, contents, false, importDefinitionId);
        }

        public List<ImportGridColumnDTO> GetImportGridColumnsDTOs(int importHeadType)
        {
            List<ImportGridColumnDTO> gridColumns = new List<ImportGridColumnDTO>();
            System.Reflection.PropertyInfo[] props = null;

            switch (importHeadType)
            {
                case (int)TermGroup_IOImportHeadType.Customer:
                    CustomerIO customerIOTable = new CustomerIO();
                    props = customerIOTable.GetType().GetProperties();
                    break;
                case (int)TermGroup_IOImportHeadType.CustomerInvoice:
                    CustomerInvoiceHeadIO customerInvoiceHeadIOTable = new CustomerInvoiceHeadIO();
                    props = customerInvoiceHeadIOTable.GetType().GetProperties();
                    break;
                case (int)TermGroup_IOImportHeadType.CustomerInvoiceRow:
                    CustomerInvoiceRowIO customerInvoiceRowIOTable = new CustomerInvoiceRowIO();
                    props = customerInvoiceRowIOTable.GetType().GetProperties();
                    break;
                case (int)TermGroup_IOImportHeadType.Supplier:
                    SupplierIO supplierIOTable = new SupplierIO();
                    props = supplierIOTable.GetType().GetProperties();
                    break;
                case (int)TermGroup_IOImportHeadType.SupplierInvoice:
                case (int)TermGroup_IOImportHeadType.SupplierInvoiceAnsjo:
                    SupplierInvoiceHeadIO supplierInvoiceIOTable = new SupplierInvoiceHeadIO();
                    props = supplierInvoiceIOTable.GetType().GetProperties();
                    break;
                case (int)TermGroup_IOImportHeadType.Voucher:
                    VoucherHeadIO voucherIOTable = new VoucherHeadIO();
                    props = voucherIOTable.GetType().GetProperties();
                    break;
                case (int)TermGroup_IOImportHeadType.Project:
                    ProjectIO projectIOTable = new ProjectIO();
                    props = projectIOTable.GetType().GetProperties();
                    break;
            }

            if (props == null)
                return gridColumns;

            if (props.Where(i => i.Name == "Status").ToList().Count == 0)
                gridColumns.Add(new ImportGridColumnDTO() { ColumnName = "status", ColumnType = "number", Headername = "status" });
            if (props.Where(i => i.Name == "StatusName").ToList().Count == 0)
                gridColumns.Add(new ImportGridColumnDTO() { ColumnName = "statusName", ColumnType = "string", Headername = "statusName" });
            if (props.Where(i => i.Name == "ErrorMessage").ToList().Count == 0)
                gridColumns.Add(new ImportGridColumnDTO() { ColumnName = "errorMessage", ColumnType = "string", Headername = "errorMessage" });

            foreach (var prop in props)
            {
                string columnName = StringUtility.ToCamelCase(prop.Name);
                string columnType = string.Empty;

                if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                    columnType = "decimal";
                else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                    columnType = "number";
                else if (prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?))
                    columnType = "datetime";
                else if (prop.PropertyType == typeof(Boolean) || prop.PropertyType == typeof(Boolean?))
                    columnType = "boolean";
                else
                    columnType = "string";

                gridColumns.Add(new ImportGridColumnDTO() { ColumnName = columnName, ColumnType = columnType, Headername = columnName });
            }

            return gridColumns;
        }


        public ActionResult XEConnectImport(int actorCompanyId, int importId, int accountYearId, int voucherSeriesId, List<byte[]> contents, bool isCompressed, int definitionId = 0, int importHeadId = 0, bool contentIsByteFromString = false, bool continueDirectlyFromIO = false)
        {
            ActionResult parseResult = new ActionResult();
            ActionResult importResult = new ActionResult();
            List<string> parsedContents = new List<string>();
            SysImportHead importHead = null;
            string specialFunctionality = string.Empty;
            List<byte[]> contentfiles = new List<byte[]>();
            List<string> originalContents = new List<string>();
            SysImportDefinition def = new SysImportDefinition();
            List<dynamic> objects = new List<dynamic>();
            TermGroup_IOImportHeadType type = TermGroup_IOImportHeadType.Unknown;

            //Compressed
            if (isCompressed)
            {
                foreach (var contentToDecompress in contents)
                {
                    byte[] decompressed = Decompress(contentToDecompress);
                    contentfiles.Add(decompressed);
                }
            }
            else
            {
                foreach (var content in contents)
                    contentfiles.Add(content);
            }

            #region Parse File Against Definition

            try
            {
                // If Webservice importId can be zero but then we should have a importHeadId instead
                if (importId == 0 && importHeadId != 0)
                    importHead = GetSysImportHead(importHeadId);
                else
                    importHead = GetSysImportHeadWithTypeFromImportId(actorCompanyId, importId, out specialFunctionality);

                type = (TermGroup_IOImportHeadType)importHead.SysImportHeadTypeId;

                if (definitionId != 0)
                {
                    def = GetSysImportDefinition(definitionId);

                    if (def != null && !string.IsNullOrEmpty(def.SpecialFunctionality))
                        specialFunctionality = def.SpecialFunctionality;
                }

                if (importHead == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "Grunddefinition kunde ej hittas");

                if (importHead.SysImportHeadType == null || (importHead.SysImportHeadType != null && importHead.SysImportHeadType.SoeImportHeadTypeEnum == 0))
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "Grunddefinitionstyp saknas");

                string compConnectionString = SoftOne.Soe.Data.Util.FrownedUponSQLClient.GetADOConnectionString();
                string sysConnectionString = SoftOne.Soe.Data.Util.FrownedUponSQLClient.GetADOConnectionStringForSysEntities();

                foreach (var content in contentfiles)
                {
                    String parsedContent = string.Empty;
                    String importContent = string.Empty;

                    var special = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
                    foreach (var item in specialFunctionality.Split(';'))
                    {
                        var keyValue = item.Split(':');
                        if (special.ContainsKey(keyValue[0]))
                            continue;

                        if (keyValue.Length == 1)
                            special.Add(keyValue[0], "");
                        else
                            special.Add(keyValue[0], keyValue[1]);
                    }

                    var encoding = special.ContainsKey("ENCODING") ? Encoding.GetEncoding(special["ENCODING"]) : Constants.ENCODING_LATIN1;

                    // if UTF8 set, override encoding
                    var utf8 = special.ContainsKey("UTF8") ? Encoding.UTF8 : null;
                    if (utf8 != null) encoding = utf8;

                    var cultureExists = special.TryGetValue("culture", out var cultureCode);
                    if (cultureExists)
                    {
                        var culture = CultureInfo.GetCultures(CultureTypes.AllCultures)
                                    .FirstOrDefault(c => string.Equals(c.Name, cultureCode, StringComparison.OrdinalIgnoreCase))
                                    ?.Name;

                        if (culture != null)
                            base.SetLanguage(culture);
                    }

                    if (contentIsByteFromString)
                    {
                        importContent = System.Text.Encoding.UTF8.GetString(content);
                    }
                    else if (special.Keys.Contains("ICAFakturan") || special.Keys.Contains("ICABudget"))
                    {
                        MemoryStream stream = new MemoryStream(content);
                        IExcelDataReader excelReader = ExcelReaderFactory.CreateReader(stream);
                        DataSet ds = excelReader.AsDataSet(new ExcelDataSetConfiguration() { ConfigureDataTable = (tableReader) => new ExcelDataTableConfiguration() { UseHeaderRow = true } });
                        if (ds != null)
                        {
                            importContent = ds.GetXml();
                        }
                        else
                        {
                            excelReader = ExcelReaderFactory.CreateOpenXmlReader(stream);
                            ds = excelReader.AsDataSet();
                            if (ds != null)
                            {
                                importContent = ds.GetXml();
                            }
                        }
                    }
                    else
                    {
                        MemoryStream stream = new MemoryStream(content);
                        StreamReader sr = new StreamReader(stream, encoding);
                        importContent = sr.ReadToEnd();
                        sr.Close();
                    }

                    #region Special

                    ImportSpecial importSpecial = new ImportSpecial(parameterObject);

                    objects = importSpecial.GetSpecialObjects(importContent, special, content);
                    importContent = importSpecial.ApplySpecials(importContent, content, importHead, special, actorCompanyId, def, contentIsByteFromString, importId, encoding, false, out bool returnSuccess);

                    if (returnSuccess)
                    {
                        importResult.Success = true;
                        return importResult;
                    }

                    bool checkOnContentIsByteFromString = true;

                    if (!special.Keys.Contains("Automaster")) //Do not change, overrides encoding for cardealers
                        importContent = importSpecial.CheckXML(importContent, content, def, contentIsByteFromString, encoding, checkOnContentIsByteFromString);

                    #endregion

                    originalContents.Add(importContent);

                    if (objects.IsNullOrEmpty() && type != TermGroup_IOImportHeadType.TimeMigrationExcel)
                    {
                        parseResult = XEConnectParseContentToDefinition(compConnectionString, sysConnectionString, actorCompanyId, importId, importContent, definitionId, importHead.SysImportHeadId, out parsedContent);
                        if (!parseResult.Success)
                            break;
                    }

                    parsedContents.Add(parsedContent);

                }
            }
            catch (Exception e)
            {
                base.LogError(e, this.log);
                parseResult = new ActionResult(GetText(903, "Ogiltigt format. Kontrollera och försök igen."));
            }

            if (!parseResult.Success)
                return parseResult;

            #endregion

            #region Import File


            importResult = XeConnectImportFile((TermGroup_IOImportHeadType)importHead.SysImportHeadType.SoeImportHeadTypeEnum, importId, parsedContents, actorCompanyId, accountYearId, voucherSeriesId, specialFunctionality, continueDirectlyFromIO, originalContents: originalContents, objects: objects, content: (type == TermGroup_IOImportHeadType.TimeMigrationExcel && !contents.IsNullOrEmpty() ? contents[0] : null));
            if (importResult.Success)
                importResult.IntegerValue = importHead.SysImportHeadType != null ? importHead.SysImportHeadType.SoeImportHeadTypeEnum : 0;

            #endregion

            return importResult;
        }

        public ActionResult CreatePaymentMethodsSOP(CompEntities entities, string pgCustomerNumber, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            Company company = CompanyManager.GetCompany(entities, actorCompanyId);
            PaymentInformation paymentInformation = PaymentManager.GetPaymentInformationFromActor(entities, actorCompanyId, true, false);
            List<PaymentMethod> methods = new List<PaymentMethod>();
            AccountDim dim = AccountManager.GetAccountDimStd(entities, actorCompanyId);

            if (paymentInformation == null || paymentInformation.PaymentInformationRow == null)
            {
                result.Success = false;
                result.ErrorMessage = "Not PaymentInformationRows";
                return result;
            }

            #region BankGiro Customer

            AccountStd accountStdBGCustomer = null;

            Account accountBGCustomer = AccountManager.GetAccountsBySearch(entities, dim.AccountDimId, "bankgiro")?.FirstOrDefault();
            if (accountBGCustomer != null)
                accountStdBGCustomer = AccountManager.GetAccountStd(entities, actorCompanyId, accountBGCustomer.AccountId, true, false);
            if (accountStdBGCustomer == null)
                accountStdBGCustomer = AccountManager.GetAccountStdByNr(entities, "1930", actorCompanyId);
            if (accountStdBGCustomer == null)
                accountStdBGCustomer = AccountManager.GetAccountStdByNr(entities, "1030", actorCompanyId);

            if (accountStdBGCustomer != null)
            {
                PaymentInformationRow paymentInformationRowBGCustomer = paymentInformation.PaymentInformationRow.FirstOrDefault(r => r.SysPaymentTypeId == (int)TermGroup_SysPaymentType.BG);
                if (paymentInformationRowBGCustomer != null)
                {
                    PaymentMethod bankgiroCustomer = new PaymentMethod();
                    bankgiroCustomer.Company = company;
                    bankgiroCustomer.Name = "BankGiro";
                    bankgiroCustomer.PaymentType = (int)SoeOriginType.CustomerPayment;
                    bankgiroCustomer.PaymentInformationRow = paymentInformationRowBGCustomer;
                    bankgiroCustomer.AccountStd = accountStdBGCustomer;
                    bankgiroCustomer.CustomerNr = string.Empty;
                    bankgiroCustomer.SysPaymentTypeId = (int)TermGroup_SysPaymentType.BG;

                    methods.Add(bankgiroCustomer);
                    entities.PaymentMethod.AddObject(bankgiroCustomer);
                }
            }

            #endregion

            #region BankGiro Supplier

            AccountStd accountStdBGSupplier = null;

            Account accountBGSupplier = AccountManager.GetAccountsBySearch(entities, dim.AccountDimId, "bankgiro")?.FirstOrDefault();
            if (accountBGSupplier != null)
                accountStdBGSupplier = AccountManager.GetAccountStd(entities, actorCompanyId, accountBGSupplier.AccountId, true, false);
            if (accountStdBGSupplier == null)
                accountStdBGSupplier = AccountManager.GetAccountStdByNr(entities, "1930", actorCompanyId);
            if (accountStdBGSupplier == null)
                accountStdBGSupplier = AccountManager.GetAccountStdByNr(entities, "1030", actorCompanyId);

            if (accountStdBGSupplier != null)
            {
                PaymentInformationRow paymentInformationRowBGSupplier = paymentInformation.PaymentInformationRow.FirstOrDefault(r => r.SysPaymentTypeId == (int)TermGroup_SysPaymentType.BG);
                if (paymentInformationRowBGSupplier != null)
                {
                    PaymentMethod bankgiroSupplier = new PaymentMethod();
                    bankgiroSupplier.Company = company;
                    bankgiroSupplier.Name = "BankGiro";
                    bankgiroSupplier.SysPaymentTypeId = (int)TermGroup_SysPaymentMethod.LB;
                    bankgiroSupplier.PaymentType = (int)SoeOriginType.SupplierPayment;
                    bankgiroSupplier.PaymentInformationRow = paymentInformationRowBGSupplier;
                    bankgiroSupplier.AccountStd = accountStdBGSupplier;
                    bankgiroSupplier.CustomerNr = string.Empty;
                    bankgiroSupplier.SysPaymentMethodId = (int)TermGroup_SysPaymentMethod.LB;
                    bankgiroSupplier.SysPaymentTypeId = (int)TermGroup_SysPaymentType.BG;

                    methods.Add(bankgiroSupplier);
                    entities.PaymentMethod.AddObject(bankgiroSupplier);
                }
            }

            #endregion

            #region Plusgiro Customer

            Account accountPGCustomer = (AccountManager.GetAccountsBySearch(entities, dim.AccountDimId, "plusgiro")?.FirstOrDefault()) ?? (AccountManager.GetAccountsBySearch(entities, dim.AccountDimId, "postgiro")?.FirstOrDefault());
            AccountStd accountStdPGCustomer = null;
            if (accountPGCustomer != null)
                accountStdPGCustomer = AccountManager.GetAccountStd(entities, dim.AccountDimId, accountPGCustomer.AccountId, true, false);
            if (accountStdPGCustomer == null)
                accountStdPGCustomer = AccountManager.GetAccountStdByNr(entities, "1920", actorCompanyId);
            if (accountStdPGCustomer == null)
                accountStdPGCustomer = AccountManager.GetAccountStdByNr(entities, "1020", actorCompanyId);

            if (accountStdPGCustomer != null)
            {
                PaymentInformationRow paymentInformationRowPGCustomer = paymentInformation.PaymentInformationRow.FirstOrDefault(r => r.SysPaymentTypeId == (int)TermGroup_SysPaymentType.PG);
                if (paymentInformationRowPGCustomer != null)
                {
                    var plusgiroCustomer = new PaymentMethod
                    {
                        Company = company,
                        Name = "Plusgiro",
                        PaymentType = (int)SoeOriginType.CustomerPayment,
                        PaymentInformationRow = paymentInformationRowPGCustomer,
                        AccountStd = accountStdPGCustomer,
                        CustomerNr = pgCustomerNumber,
                        SysPaymentTypeId = (int)TermGroup_SysPaymentType.PG
                    };
                    methods.Add(plusgiroCustomer);
                    entities.PaymentMethod.AddObject(plusgiroCustomer);
                }
            }

            #endregion

            #region Plusgiro Supplier

            AccountStd accountStdPGSupplier = null;

            Account accountPGSupplier = (AccountManager.GetAccountsBySearch(entities, dim.AccountDimId, "plusgiro")?.FirstOrDefault()) ?? (AccountManager.GetAccountsBySearch(entities, dim.AccountDimId, "postgiro")?.FirstOrDefault());
            if (accountPGSupplier != null)
                accountStdPGSupplier = AccountManager.GetAccountStd(entities, actorCompanyId, accountPGSupplier.AccountId, true, false);
            if (accountStdPGSupplier == null)
                accountStdPGSupplier = AccountManager.GetAccountStdByNr(entities, "1920", actorCompanyId);
            if (accountStdPGSupplier == null)
                accountStdPGSupplier = AccountManager.GetAccountStdByNr(entities, "1020", actorCompanyId);

            if (accountStdPGSupplier != null)
            {
                PaymentInformationRow paymentInformationRowPGSupplier = paymentInformation.PaymentInformationRow.FirstOrDefault(r => r.SysPaymentTypeId == (int)TermGroup_SysPaymentType.PG);
                if (paymentInformationRowPGSupplier != null)
                {
                    PaymentMethod plusgiroSupplier = new PaymentMethod();
                    plusgiroSupplier.Company = company;
                    plusgiroSupplier.Name = "Plusgiro";
                    plusgiroSupplier.SysPaymentTypeId = (int)TermGroup_SysPaymentMethod.PG;
                    plusgiroSupplier.PaymentType = (int)SoeOriginType.SupplierPayment;
                    plusgiroSupplier.PaymentInformationRow = paymentInformationRowPGSupplier;
                    plusgiroSupplier.AccountStd = accountStdPGSupplier;
                    plusgiroSupplier.CustomerNr = pgCustomerNumber;
                    plusgiroSupplier.SysPaymentMethodId = (int)TermGroup_SysPaymentMethod.PG;
                    plusgiroSupplier.SysPaymentTypeId = (int)TermGroup_SysPaymentType.PG;

                    methods.Add(plusgiroSupplier);
                    entities.PaymentMethod.AddObject(plusgiroSupplier);
                }
            }

            #endregion

            #region save

            entities.SaveChanges();

            try
            {
                entities.SaveChanges();
            }
            catch (Exception ex)
            {
                LogError(ex.InnerException, this.log);
                result.Success = false;
            }

            #endregion

            return result;
        }

        public int SetCompanySettingTypeSOP(CompEntities entities, int actorCompanyId, string name, string value, out bool saved, out SettingDataType dataType, out bool? boolData, out int? intData, out decimal? decimalData, out string stringData, out DateTime? dateData)
        {
            int settingId = 0;
            dataType = SettingDataType.String;

            boolData = null;
            intData = null;
            decimalData = null;
            stringData = null;
            dateData = null;
            saved = false;

            if (string.IsNullOrEmpty(value) && !name.Equals("KundnrPostgiro"))
                return settingId;

            switch (name)
            {
                case "KundnrPostgiro":
                    CreatePaymentMethodsSOP(entities, value, actorCompanyId);
                    saved = true;
                    break;
                case "Företagsform": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "Dröjmålsränta": settingId = (int)CompanySettingType.CustomerInterestPercent; dataType = SettingDataType.Decimal; break;
                case "ExpAvgift": settingId = (int)CompanySettingType.BillingUseInvoiceFee; dataType = SettingDataType.Boolean; break;
                case "Avrundning": settingId = (int)CompanySettingType.BillingUseCentRounding; dataType = SettingDataType.Boolean; break;
                //case "Handläggare": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "AktuelltÅr": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "NästaÅr": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "SenastePeriod": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "Fskatt": settingId = (int)CompanySettingType.BillingPrintTaxBillText; dataType = SettingDataType.Boolean; break;
                //case "FskattText": settingId = (int)CompanySettingType.BillingPrintTaxBillText; dataType = SettingDataType.String; boolData = true; break;
                case "SenasteOffertnr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "Offer", Convert.ToInt32(value)); saved = true; break;
                case "SenasteAvtalsnr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "Contract", Convert.ToInt32(value)); saved = true; break;
                case "SenasteOrdernr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "Order", Convert.ToInt32(value)); saved = true; break;
                case "SenasteKndDebFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "CustomerInvoiceDebit", Convert.ToInt32(value)); saved = true; break;
                case "SenasteKndKreFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "CustomerInvoiceCredit", Convert.ToInt32(value)); saved = true; break;
                case "SenasteKndRänteFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "CustomerInvoiceInterest", Convert.ToInt32(value)); saved = true; break;
                //case "SenasteKndAcontoFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, SoeEntityType.Offer.ToString(), Convert.ToInt32(value));
                case "SenasteKndKontantFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "CustomerInvoiceCash", Convert.ToInt32(value)); saved = true; break;
                case "SenasteLevDebFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "SupplierInvoiceDebit", Convert.ToInt32(value)); saved = true; break;
                case "SenasteLevKreFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "SupplierInvoiceCredit", Convert.ToInt32(value)); saved = true; break;
                case "SenasteLevRänteFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "SupplierInvoiceInterest", Convert.ToInt32(value)); saved = true; break;
                //case "SenasteLevAcontoFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, SoeEntityType.Offer.ToString(), Convert.ToInt32(value));
                case "SenasteLevKontantFakturanr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "SupplierInvoiceCach", Convert.ToInt32(value)); break;
                //case "SenasteBeställningsnr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, SoeEntityType.Offer.ToString(), Convert.ToInt32(value));
                //case "Årsnr": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "StandardBetVillkor":
                    PaymentCondition paymentCondition = PaymentManager.GetPaymentConditionByCode(value, actorCompanyId);
                    if (paymentCondition != null)
                    {
                        settingId = (int)CompanySettingType.CustomerPaymentDefaultPaymentCondition;
                        dataType = SettingDataType.Integer;
                        value = paymentCondition.PaymentConditionId.ToString();
                    }
                    break;
                case "StandardLevVillkor":
                    DeliveryCondition deliveryCondition = InvoiceManager.GetDeliveryConditionByCode(value, actorCompanyId);
                    if (deliveryCondition != null)
                    {
                        settingId = (int)CompanySettingType.BillingDefaultDeliveryCondition;
                        dataType = SettingDataType.Integer;
                        value = deliveryCondition.DeliveryConditionId.ToString();
                    }
                    break;
                // case "StandardKundKat": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                // case "FTV-KP-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                // case "StandardLevKat": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "StandardLevSätt":
                    DeliveryType deliveryType = InvoiceManager.GetDeliveryTypeByCode(value, actorCompanyId);
                    if (deliveryType != null)
                    {
                        settingId = (int)CompanySettingType.BillingDefaultDeliveryType;
                        dataType = SettingDataType.Integer;
                        value = deliveryType.DeliveryTypeId.ToString();
                    }
                    break;
                //case "StandardDistrikt": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardSäljare": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLandkod": 
                //case "StandardSpråk":
                case "StandardValuta":
                    List<Currency> currencies = CountryCurrencyManager.GetCurrencies(actorCompanyId);
                    Currency currency = currencies?.FirstOrDefault(c => c.Code.ToLower() == value.ToLower());
                    if (currency != null)
                    {
                        settingId = (int)CompanySettingType.CoreBaseCurrency;
                        dataType = SettingDataType.Integer;
                        intData = currency.CurrencyId;
                    }
                    break;
                //case "StandardVarugrupp": settingId = (int)CompanySettingType.; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ART-PRIS-PRIO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "StandardArtikelTyp": settingId = (int)CompanySettingType.BillingDefaultInvoiceProductVatType; dataType = SettingDataType.Integer; break;
                //case "StandardArtikelAntalDec": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "StandardArtikelMomskod":
                    VatCode vatCode = AccountManager.GetVatCodeByCode(actorCompanyId, value);
                    if (vatCode != null)
                    {
                        settingId = (int)CompanySettingType.BillingDefaultVatCode;
                        dataType = SettingDataType.Integer;
                        boolData = true;
                        value = vatCode.VatCodeId.ToString();
                    }
                    break;
                //case "StandardArtikelAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardArtikelAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardKundAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardKundAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLevAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLevAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-ADR2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLevMomskod": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLevInterims": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "LeverantörsBank": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "LevFakturaAttest": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "SammanslagningArtiklar": settingId = (int)CompanySettingType.BillingMergeInvoiceProductRowsMerchandise; dataType = SettingDataType.Boolean; break;
                //case "UtleveranmarkeringOrder": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SPARA-KOPIA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KONT-KONTROLL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FraktExklMoms": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FörsäkringExklMoms": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "ExpavgiftExklMoms": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FraktInklMoms": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FörsäkringInklMoms": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "ExpavgiftInklMoms": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Ränteberäkning": settingId = (int)CompanySettingType.ProductInterestInvoicing; dataType = SettingDataType.Boolean; boolData = true; break;
                //case "StandardLeveransspärrad": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardExpiditionsavgift": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardKravbrev": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardRäntefaktura": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardSamfaktureras": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "VisaUtlevereradeOrderradr": settingId = (int)CompanySettingType.BillingIncludeRemainingAmountOnInvoice; dataType = SettingDataType.Boolean; boolData = true; break;
                //case "PrisinläsningTecken": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INTRASTAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-FAKTDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-REG-ANTAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-REG-PRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-OBETALDA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-FORFDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-KONTERA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardKundAnm1Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardKundAnm2Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLevBetalningssätt": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardLevAvitext": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardArtikelAnm1Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardArtikelAnm2Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PRISHANT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PRISHANT-UPPD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FrågaAvslutVerifBalanserar": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "VerifBehöverEjBalansera": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "EgenNummersättningVerif": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "VerserieMomsverifikat": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-CENTRAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KOP-CENTRAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "TidsdebiteringKlient": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FrågaAutomatkontering": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StannaVerifikattext": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "AvvikelseBelFörMomskont": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LAG-KST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "KontoplanTyp": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "KlarInköp": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "VisaInlevererade": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-STRUKTUR-PRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FörsPrisHämtaPrio1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FörsPrisHämtaPrio2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FörsPrisHämtaPrio3": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "AntalKravbrevInnanInkasso": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-KREDIT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VISA-KREDIT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StannaVerdatumNyttVerif": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAKT-EJ-RESK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "SenasteServiceordernr": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TAX-AAR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "EgenBenämningAvserArbete": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ACONTO-AVR-SPEC": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-NIVA-MOBIL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-BUDMALL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-OBJ-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "TidartFörArtikel":
                    TimeCode timeCode = TimeCodeManager.GetTimeCodesBySearch(actorCompanyId, value, 1)?.FirstOrDefault();
                    if (timeCode != null)
                    {
                        settingId = (int)CompanySettingType.BillingStandardMaterialCode;
                        dataType = SettingDataType.Integer;
                        boolData = true;
                        value = timeCode.TimeCodeId.ToString();
                    }
                    break;
                //case "TidartFörFastpris": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "TidartAconto": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "TidartAvgårAconto": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "TidartUtlägg": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ART-RAB-PRIO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ART-RABATTER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "StandardTidPerson": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-STD-MALL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LK-PRIS-PRIO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-UTSKRIFT-VALUTA-KOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-BEST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-BESTID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMSLAG-ARTID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-OCR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-MOMS-KOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TJANSTE-TEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LOCK-AARNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-STD-MALL-IX": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto3": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto4": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto5": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto6": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto7": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto8": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto9": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Inventariekonto10": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PersonAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PersonAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "ObjektAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "ObjektAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PER-PER-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FrågaInventarieVerifreg": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FrågaInventarieLevfakreg": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "EgenBenämningObjekt": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "EgenBenämningArt": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "OrderAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "OrderAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SORT-UNDERLAG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetTidkodPris1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetTidkodPris2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetTidkodPris3": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetTidkodPris4": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetTidkodPris5": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetKonteringTidförs1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetKonteringTidförs2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetKonteringTidförs3": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PrioritetKonteringTidförs4": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LP-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PG-PERSON-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PG-OBJ-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LONART-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FG-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PK-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "ObjektAnmärkning1Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "ObjektAnmärkning2Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "InventarieAnmärkning1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "InventarieAnmärkning2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PersonAnmärkning1Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "PersonAnmärkning2Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ORDER-ANDRA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-MAXTID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PRIS-ANDR-DAGAR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TIDREG-FRANDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TIDREG-TILLDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-KST-OBL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-PRJ-OBL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-MOMSKOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-AVSLUTA-ORDER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PASL-GRP-FOM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PASL-GRP-ANT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ORDNR-VALFRITT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FTGSTOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ORDERPL-FIRST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-UTLAGG-KONTROLL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ARTBEN-AVTAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AG-AVSTNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AVTAL-PERIODTYP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AVTAL-INTERVALL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-DATUM-LOOK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-ORDER-SUM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TIDREG-ATTEST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-DATUM-SEP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TAK-EXPAVG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SKT-AGAVG-PR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SKT-AGAVG-SL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SKT-AGAVG-PENSION": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-PRJ-RED": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-ANM-BEN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-DEB-KNAPP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-ANM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAKT-MINBEL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-FRAGA-BOK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-FRAGA-LEV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-FRAGA-KND": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ANDRA-KONTERING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-FPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-SJPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ANDRA-FPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ANDRA-SJPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ART-KONT-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ART-MOMS-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-VALUTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-INKL-MOMS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-OBJEKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-ACONTO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-FASTPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-IMP-EJPABORJAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-IMP-KST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-IMP-PRJ": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INTRASTAT-AUTO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-BEL-INKL-MOMS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INLOGG-ANV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SALDOKOLL-FLAG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SALDOKOLL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AG-PG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SKT-SAMMA-MAN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-EURO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-IMPORT-FELKTO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAKT-LAYOUT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-STANNA-ALLTID-TEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AVTAL-STD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-LOSEN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INV-INV-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-REFERENS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BSATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VKOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TEXT-UTLAGG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VALUTA-KOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-ANM-FAKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BETV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BOKFDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VALUTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-KURS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-KASSA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-ART-PRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-RABDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INV-LAGER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-ATTEST-AV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-ATTEST-INS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BGCOM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-MARG-PROC": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-AVITEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-INTRASTAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-UTLAND": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-GEMRAPP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SPRAK-TEXTBLOCK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VSER-PK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-START-UTLAGG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BET-DAGAR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BET-DAG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-BETVILLKOR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-KONTERING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OVERLEV-OK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-NIVA-TID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SENAST-OPPNA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VERNR-LOPNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VSER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "LeverantörAnmärkning1Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "LeverantörAnmärkning2Oblig": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INTRASTAT-LEV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INTRASTAT-INK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-DAGAR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-NIVA-GEM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEVINK-PRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-KND-LOPNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTHANDP-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTRABATT-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTPRKORT-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTTGODO-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTATERBET-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTKUNDF-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-PK-GILTDAG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-KVITTONR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KONT-ORDER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-BS-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-BEN-BGFIL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KST-KST-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PRJ-PRJ-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-LOSEN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-ANM1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-ANM2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-BT-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-ART-SG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INV-ANM1-O": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INV-ANM2-O": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-INKPR-UTLEV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-STANDARD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "E-postadress": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "Webbadress": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-SKRIVARE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-KOPIOR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-RAPPORT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-TKN-ANT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-DEB-KOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FakturerasViaTid": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-OBJEKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ACONTO-OBJEKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-KORT-SYSTEM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-FRAGA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-BEH-ANVANDS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-RABATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-DISPLAY": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMSLAG-ART-EJ-0": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-JAMAAR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-HIDE-DATUM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-HIDE-SKUGGNING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KLIENT-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KUNDRABATT-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KNR-OMBUD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KNR-FAK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-REF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-BETV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-AUTOGIRO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-MOMS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-VALUTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-KURS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FASTPRIS-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-JUSTART-TIDORDER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-KOLL-UTPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-INL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-INL-TXBID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-FAKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-FAKT-TXBID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-AVSL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-AVSL-TXBID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-FAKT-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-FAKTDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-INLOGG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-LAGERINFO": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-STD-LP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-PAS-LP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-AVST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-IK-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-U1-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-U2-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SO-U3-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-FORFDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-FAKTBEL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-MOMSBEL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-AVRUND": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-STOP-RF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-STOP-KR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-STOP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KND-S-KONT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AVTAL-ID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AVTAL-NR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KTO-ANST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-EJ-EXPAVG-KREDIT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-VARNA-EJ-LORD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ACONTO-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-AVR-ACONTO-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SKAPA-LAGER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KONV-AUP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEVPRIS-EJ-BORT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KUNDR-FAKTDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KUNDR-BETDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KUNDR-BOKFDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEVR-FAKTDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEVR-BETDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEVR-BOKFDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TXB-ORDER-INK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAKT-SORT-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAKT-SORT-TEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-EJ-DELLEV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-LEVKUND": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OFFERT-GILTDAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-DIREKT-ALT-BOKF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PERK-AUTOMAT-BORT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-DELSUMMA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KOPPLING-LEVFAKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ACONTO-ART-START": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-SLUTLEV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KONV-KVA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PACKKONTROLL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-MARG-KONTROLL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-AVRUNDN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-MARGPROC": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-MAXBELRAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-TG-GILTDAG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-VB-GILTDAG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-MAXTILLBAKA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-KOLLFPIP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-BYTE-SLJ": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-SLJLIST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-V-LEVANT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-V-RABATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-V-ENHET": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-V-BELOPP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-ANTAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-LEVANT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-ENHET": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-PRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-RABATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-LEVANT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-LAGER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-ENHET": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-PRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-RABATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-ATTBET": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-C-SLURAB": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-V-LAGER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-LAGER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-V-INKPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-ERREF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-LEVADR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-RAD1-2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-RAD2-1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-S-KUND": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAKT-KUNDRABATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-VSER-AKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-IBAN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-BIC": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-RAD2-2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-RAD3-1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAM-RAD3-2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-FAKT-TXBID-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-AVSL-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAST-AVSL-TXBID-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-PRISLORDNING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FORSTA-FRAKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FORSTA-FORS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FORSTA-EXP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LAGSTA-FORSPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VISA-KAMPANJ": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VALUTA-OMRAK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TERMINAL-SERVER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KST-PRJ-ORDER-INK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-CARAT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TID-PRISL-ORDNING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FORSBREV-IPRIS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FTG-SKATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KVITTO-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-HISTORIK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEV-ANTAL-0": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KASSA-KST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KST-ORDER-OBL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-PRJ-ORDER-OBL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LEVFAKT-VARNING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-FAKT-TOTALRAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-UTLEV-TEXTRADER": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-UTLEV-EJ-RESKONTRA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-TEXTBLOCK-FORE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-VSER-NORSTEDTS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-SAMFAK-SORTERING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KST-FRAKT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-BRANSCH-KOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-VISA-BEN2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ALLTID-DEBET": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-LNR-BGFIL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-OBJ-OBL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-EGEN-BEN-BG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-KA-ARTBEVIS-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ORD-ANM3": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                //case "FTV-ORD-ANM4": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                case "ArtikelHusavdrag":
                    Product householdProduct = ProductManager.GetInvoiceProductByProductNr(value, actorCompanyId);
                    if (householdProduct != null)
                    { settingId = (int)CompanySettingType.ProductHouseholdTaxDeduction; dataType = SettingDataType.Integer; boolData = true; value = householdProduct.ProductId.ToString(); }
                    break;
                case "ArtikelHusavdragJournalnr": SequenceNumberManager.UpdateSequenceNumber(actorCompanyId, "HouseholdTaxDeduction", Convert.ToInt32(value)); saved = true; break;
                    //case "FTV-SAMFAKT-BEL-GRANS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-SAMFAKT-BEL-DGR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-SO-ANM3": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-SO-ANM4": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-ORD-ANM5": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-ORD-ANM6": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-ORD-ANM7": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-ORD-ANM8": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-KND-KND-ID-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-LEV-LEV-ID-L": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MTRLSPEC-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-LFH-ANM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AVT-ANM1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AVT-ANM2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-OFF-ANM1": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-OFF-ANM2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AVT-ANM1-OVERF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AVT-ANM2-OVERF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-OFF-ANM1-OVERF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-OFF-ANM2-OVERF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-FAST-INNEH": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-FAST-INNEH-TXBID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-FAST-INNEH-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-FAST-INNEH-TXBID-RAD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-INNEH-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-LAND": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-FASTPRIS-ART-START": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-BEN-PLOCK": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-BEN-FOLJE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-KA-UTLEV": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-REF-FRAGA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-VALUTA-KOD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AUTO-AVTAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-MATERIAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-ARBETE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-BILDHANTERING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-CHECKLISTOR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-MOMS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-PRISLISTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-HUS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-MARKE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-MARKE-ANM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-LEVTEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-LEVTEXT-ANM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-INTERNTEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-VALUTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-LEVADRESS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-FAKTADRESS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-REFERENS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-BELOPP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-TOTAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-DELTAGARE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-DATUM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-STATUS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AVT-INL-TEXT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-AVT-INL-TXBID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-CHECK-SVAR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-CHECK-ADD": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-ORGNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-VATNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-REFERENS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-EPOST": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-EPOST-NR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-HEM": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-HEM-NR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-ARBETE": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-ARBETE-NR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-MOBIL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-MOBIL-NR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-FAX": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-FAX-NR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-FAKTADRESS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-LEVADRESS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-MOMS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-BETVILLKOR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-PRISLISTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-RABATT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-VALUTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MK-ANTECKNING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-HK-NAMN": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-HK-ADRESS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-HK-POSTNR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-HK-POSTADRESS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-SERV-KVITTO-DEF": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-LFH-FAKTNR-SPARR": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-SORTERING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-TXT-RADBRYT": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-ANTAL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-ORDER-EJ-TID": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-OBJ-KND-OBL": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-EDI-ART": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-DATUM-BEN2": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-ER-REFERENS": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-IP-LISTA": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-KND-KTO-NEG": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-MO-KONTERING": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
                    //case "FTV-LEV-CFP": settingId = (int)CompanySettingType.Unknown; dataType = SettingDataType.String; boolData = true; break;
            }

            if (!saved)
            {
                switch (dataType)
                {
                    case SettingDataType.Decimal:
                        decimal dec = 0;
                        if (decimal.TryParse(value, out dec))
                            decimalData = (decimal?)dec;
                        else if (decimal.TryParse(value.Replace(".", ","), out dec))
                            decimalData = (decimal?)dec;
                        break;

                    case SettingDataType.Boolean:
                        bool bo = false;
                        if (value.ToLower() == "j" || value.ToLower() == "ja" || value.ToLower() == "y" || value.ToLower() == "yes" || value.ToLower() == "på" || value.ToLower() == "sant")
                            boolData = true;
                        else if (value.ToLower() == "n" || value.ToLower() == "nej" || value.ToLower() == "no" || value.ToLower() == "av" || value.ToLower() == "falskt")
                            boolData = false;
                        else if (bool.TryParse(value, out bo))
                            boolData = (bool?)bo;
                        else
                            boolData = false;
                        break;

                    case SettingDataType.Date:
                        DateTime dt = CalendarUtility.GetDateTime(value, "yyyyMMdd");
                        if (dt == CalendarUtility.DATETIME_DEFAULT)
                            dt = CalendarUtility.GetDateTime(value, "yyyy-MM-dd");
                        if (dt == CalendarUtility.DATETIME_DEFAULT)
                            dt = CalendarUtility.GetDateTime(value, "yyMMdd");
                        if (dt != CalendarUtility.DATETIME_DEFAULT)
                            dateData = (DateTime?)dt;
                        break;

                    case SettingDataType.Integer:
                        int integer = 0;
                        if (int.TryParse(value, out integer))
                            intData = integer;
                        break;

                    case SettingDataType.String:
                        stringData = value;
                        break;

                    case SettingDataType.Time:
                        dateData = CalendarUtility.GetTime(value);
                        break;
                }
            }

            return settingId;
        }

        private ActionResult XEConnectParseContentToDefinition(string compConnectionString, string sysConnectionString, int actorCompanyId, int importId, string importContent, int sysImportDefinitionId, int sysImportHeadId, out string returnData)
        {
            ImportCreateInput importCreateInputClass = new ImportCreateInput();
            ActionResult result = importCreateInputClass.ImportCreateImport(compConnectionString, sysConnectionString, actorCompanyId, importId, importContent, sysImportDefinitionId, sysImportHeadId, out returnData);

            return result;
        }

        private ActionResult XeConnectImportFile(TermGroup_IOImportHeadType headType, int importId, List<string> contents, int actorCompanyId, int accountYearId, int voucherSeriesId, string specialFunctionality, bool continueDirectlyFromIO = false, List<string> originalContents = null, List<Object> objects = null, byte[] content = null)
        {
            ActionResult result = new ActionResult();
            try
            {


                switch (headType)
                {
                    case TermGroup_IOImportHeadType.Supplier:
                        SupplierIOItem supplierIOItem = new SupplierIOItem(contents, headType);
                        result = ImportSupplierIO(supplierIOItem, headType, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, continueDirectlyFromIO);
                        break;
                    case TermGroup_IOImportHeadType.SupplierInvoice:
                    case TermGroup_IOImportHeadType.SupplierInvoiceAnsjo:
                        SupplierInvoiceIOItem supplierInvoiceIOItem = new SupplierInvoiceIOItem(contents, headType, specialFunctionality);
                        result = ImportSupplierInvoiceIO(supplierInvoiceIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, continueDirectlyFromIO);
                        break;
                    case TermGroup_IOImportHeadType.Contact:
                        break;
                    case TermGroup_IOImportHeadType.Customer:
                        CustomerIOItem customerIOItem = new CustomerIOItem(contents, headType);
                        result = ImportCustomerIO(customerIOItem, headType, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, specialFunctionality, continueDirectlyFromIO);
                        break;
                    case TermGroup_IOImportHeadType.CustomerInvoice:
                        CustomerInvoiceIOItem customerInvoiceIOItem = new CustomerInvoiceIOItem(contents, headType);
                        customerInvoiceIOItem.CreateSelectXML();
                        result = ImportCustomerInvoiceIO(customerInvoiceIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, specialFunctionality, continueDirectlyFromIO);
                        break;
                    case TermGroup_IOImportHeadType.CustomerInvoiceRow:
                        CustomerInvoiceRowIOItem customerInvoiceRowIOItem = new CustomerInvoiceRowIOItem(contents, headType);
                        result = ImportCustomerInvoiceRowIO(customerInvoiceRowIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, continueDirectlyFromIO, specialFunctionality);
                        break;
                    case TermGroup_IOImportHeadType.StaffingNeedsFrequency:
                        StaffingNeedsFrequencyIOItem staffingNeedsFrequencyIOItem = new StaffingNeedsFrequencyIOItem(contents, headType, objects);
                        if (staffingNeedsFrequencyIOItem.frequencies.Any(a => a.FrequencyType == FrequencyType.StaffingNeedsRow))
                            result = ImportStaffingNeedHeadFromFrequencyIO(staffingNeedsFrequencyIOItem, headType, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, true);
                        else
                            result = ImportStaffingNeedsFrequencyIO(staffingNeedsFrequencyIOItem, headType, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, true);
                        break;
                    case TermGroup_IOImportHeadType.Voucher:
                        VoucherHeadIOItem voucherIOItem = new VoucherHeadIOItem(contents, headType);
                        result = ImportVoucherIO(voucherIOItem, TermGroup_IOImportHeadType.Voucher, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, continueDirectlyFromIO, accountYearId, voucherSeriesId);
                        break;
                    case TermGroup_IOImportHeadType.Project:
                        var projectIOItem = new ProjectIOItem(contents);
                        result = ImportProjectIO(projectIOItem, headType, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, continueDirectlyFromIO, importId);
                        break;
                    case TermGroup_IOImportHeadType.AccountDistributionHead:
                        AccountDistributionIOItem accountDistributionIOItem = new AccountDistributionIOItem(contents, headType);
                        result = ImportAccountDistributionIO(accountDistributionIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.AccountYear:
                        AccountYearIOItem accountYearIOItem = new AccountYearIOItem(contents, headType, actorCompanyId);
                        result = ImportAccountYearIO(accountYearIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Account:
                        AccountIOItem accountIOItem = new AccountIOItem(contents, headType, actorCompanyId);
                        result = ImportAccountIO(accountIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, specialFunctionality);
                        break;
                    case TermGroup_IOImportHeadType.AccountYearBalance:
                        AccountYearBalanceIOItem accountYearBalanceIOItem = new AccountYearBalanceIOItem(contents, headType, actorCompanyId);
                        result = ImportAccountYearBalanceIO(accountYearBalanceIOItem, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.InvoiceProduct:
                        CreateSelectXML(typeof(InvoiceProductIODTO));
                        List<PriceListType> pricelists = ProductPricelistManager.GetPriceListTypes(actorCompanyId);
                        InvoiceProductIOItem invoiceProductIOItem = new InvoiceProductIOItem(contents, headType, actorCompanyId, pricelists);
                        result = ImportInvoiceProductIO(invoiceProductIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.SideDictionary:
                        CreateSelectXML(typeof(SideDictionaryIODTO));
                        SideDictionaryIOItem sideDictionaryIOItem = new SideDictionaryIOItem(contents, headType, actorCompanyId);
                        result = ImportSideDictionaryIO(sideDictionaryIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Employee:
                        CreateSelectXML(typeof(EmployeeIO));
                        EmployeeIOItem employeeIOItem = new EmployeeIOItem(contents, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, headType, actorCompanyId);
                        result = ImportEmployees(employeeIOItem.EmployeeIOs, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Budget:
                        CreateSelectXML(typeof(BudgetHeadIODTO));
                        BudgetIOItem budgetIOItem = new BudgetIOItem(contents, headType, actorCompanyId, accountYearId: accountYearId);
                        result = ImportBudgetIO(budgetIOItem, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Inventory:
                        CreateSelectXML(typeof(InventoryIODTO));
                        InventoryIOItem inventoryIOItem = new InventoryIOItem(contents, headType, actorCompanyId);
                        result = ImportInventoryIO(inventoryIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.CompanyInformation:
                        CompanyInformationIOItem CompanyInformationIOItem = new CompanyInformationIOItem(contents, headType, actorCompanyId);
                        result = ImportCompanyInformationIO(CompanyInformationIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, originalContents);
                        break;
                    case TermGroup_IOImportHeadType.Payments:
                        //if (!specialFunctionality.Contains("SOPSettings"))
                        //    originalContents = new List<string>();

                        //SOPPP sOPPP = new SOPPP(parameterObject);
                        //sOPPP.LastControlAfterMigration(actorCompanyId);
                        PaymentIOItem paymentIOItem = new PaymentIOItem(contents, headType, actorCompanyId);
                        result = ImportPaymentIO(paymentIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, false);
                        break;
                    case TermGroup_IOImportHeadType.GrossProfitCodes:
                        GrossProfitCodeIOItem grossProfitCodeIOItem = new GrossProfitCodeIOItem(contents, headType, actorCompanyId);
                        result = ImportGrossProfitCodeIO(grossProfitCodeIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Settings:
                        CreateSelectXML(typeof(UserCompanySettingIODTO));
                        UserCompanySettingIOItem userCompanySettingIOItem = new UserCompanySettingIOItem(contents, headType, actorCompanyId);
                        result = ImportUserCompanySettingIO(userCompanySettingIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.TimeCodeTransaction:
                        CreateSelectXML(typeof(TimeCodeTransactionIODTO));
                        TimeCodeTransactionIOItem timeCodeTransactionIOItem = new TimeCodeTransactionIOItem(contents, headType, actorCompanyId);
                        result = ImportTimeCodeTransactonIO(timeCodeTransactionIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Employment:
                        CreateSelectXML(typeof(EmploymentIODTO));
                        EmploymentIOItem employmentIOItem = new EmploymentIOItem(contents, headType, actorCompanyId);
                        result = ImportEmploymentIO(employmentIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Checklist:
                        CreateSelectXML(typeof(ChecklistHeadIODTO));
                        ChecklistIOItem checklistIOItem = new ChecklistIOItem(contents, headType, actorCompanyId);
                        result = ImportChecklistIO(checklistIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.DistributionCode:
                        CreateSelectXML(typeof(DistributionCodeHeadIODTO));
                        DistributionCodeIOItem distributionCodeIOItem = new DistributionCodeIOItem(contents, headType, actorCompanyId);
                        result = ImportDistributionCodeIO(distributionCodeIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.TextBlock:
                        TextBlockIOItem textBlockIOItemIOItem = new TextBlockIOItem(contents, headType, actorCompanyId);
                        result = ImportTextBlockIO(textBlockIOItemIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.Schedule:
                        TimeScheduleBlockIOItem timeScheduleBlockIOItem = new TimeScheduleBlockIOItem(contents, headType, actorCompanyId, objects);
                        result = ImportTimeScheduleBlockIO(timeScheduleBlockIOItem, headType, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.VactionDays:
                        EmployeeVacationSEIOItem employeeVacationSEIOItem = new EmployeeVacationSEIOItem(contents, headType, actorCompanyId);
                        result = ImportEmployeeVacationSEIO(employeeVacationSEIOItem, TermGroup_IOImportHeadType.VactionDays, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.FixedPayrollRow:
                        FixedPayrollRowIOItem fixedPayrollRowIOItem = new FixedPayrollRowIOItem(contents, headType, actorCompanyId);
                        result = ImportFixedPayrollRowIO(fixedPayrollRowIOItem, TermGroup_IOImportHeadType.FixedPayrollRow, importId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.TimeMigrationExcel:
                        TimeMigrationItem timeMigrationItem = new TimeMigrationItem(content,
                            TimeScheduleManager.GetShiftTypes(actorCompanyId, loadAccountInternals: true, loadAccounts: true, loadSkills: true).ToDTOs(includeAccounts: true, includeSkills: true).ToList(),
                            CategoryManager.GetCategories(SoeCategoryType.Employee, actorCompanyId).ToDTOs(true).ToList(),
                            AttestManager.GetAttestRoles(actorCompanyId, SoeModule.Time, loadAttestRoleUser: true, loadExternalCode: true).ToDTOs().ToList(),
                            AccountManager.GetAccountsInternalsByCompany(actorCompanyId, loadAccount: true, loadAccountDim: true, loadAccountMapping: true).ToDTOs(includeAccountDim: true, includeInternalAccounts: true));
                        result = ExecuteMigration(timeMigrationItem, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.TimeBalance:
                        TimeBalanceIOItem timeBalanceIOItem = new TimeBalanceIOItem(contents);
                        result = ImportTimeBalanceIO(timeBalanceIOItem, headType, importId, TermGroup_IOSource.Connect, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    case TermGroup_IOImportHeadType.TimeCodeTransactionSimple:
                        TimeCodeTransactionSimpleIOItem TimeCodeTransactionSimpleIOItem = new TimeCodeTransactionSimpleIOItem(contents);
                        result = ImportTimeCodeTransactionSimpleIO(TimeCodeTransactionSimpleIOItem, headType, importId, TermGroup_IOSource.Connect, TermGroup_IOType.XEConnect, actorCompanyId);
                        break;
                    default:
                        break;
                }
            }
            catch (Exception ex)
            {
                log.Error("XeConnectImportFile", ex);
                return new ActionResult(ex);
            }

            return result;
        }

        public void CreateSelectXML(Type dto)
        {
            Type elementType = dto;

            List<XElement> elements = new List<XElement>();
            XElement datasetelement = new XElement("NewDataSet");
            int position = 1;

            foreach (var propInfo in elementType.GetProperties())
            {
                string dataType = string.Empty;
                if (propInfo.PropertyType.FullName.Contains("System.String"))
                    dataType = "Sträng";
                else if (propInfo.PropertyType.FullName.Contains("System.Int32"))
                    dataType = "Heltal";
                else if (propInfo.PropertyType.FullName.Contains("System.Decimal"))
                    dataType = "Belopp";
                else if (propInfo.PropertyType.FullName.Contains("System.Boolean"))
                    dataType = "På/Av";
                else if (propInfo.PropertyType.FullName.Contains("System.DateTime"))
                    dataType = "Datum";

                XElement element = new XElement("Columns");
                element.Add(new XElement("Column", propInfo.Name));
                element.Add(new XElement("Text", propInfo.Name));
                element.Add(new XElement("DataType", dataType));
                element.Add(new XElement("Mandatory", "false"));
                element.Add(new XElement("Position", position.ToString()));
                elements.Add(element);

                position++;
            }

            datasetelement.Add(elements);
        }

        #endregion

        #endregion

        #region InvoiceExport

        public IEnumerable<InvoiceExport> GetInvoiceExports(int actorCompanyId, int? invoiceExportId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.InvoiceExport.NoTracking();
            return GetInvoiceExports(entities, actorCompanyId, invoiceExportId);

        }

        public IEnumerable<InvoiceExport> GetInvoiceExports(CompEntities entities, int actorCompanyId, int? invoiceExportId = null)
        {
            var invoiceExportQry = (from i in entities.InvoiceExport
                                    where i.ActorCompanyId == actorCompanyId &&
                                    i.State == (int)SoeEntityState.Active
                                    select i).AsQueryable();

            if (invoiceExportId.HasValue)
                invoiceExportQry = invoiceExportQry.Where(i => i.InvoiceExportId == invoiceExportId);

            return invoiceExportQry.OrderByDescending(i => i.BatchId).ToList();

        }

        public IEnumerable<InvoiceExportIO> GetExportedIOInvoices(int actorCompanyId, int invoiceExportId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.InvoiceExportIO.NoTracking();
            return GetExportedIOInvoices(entities, actorCompanyId, invoiceExportId);

        }

        public IEnumerable<InvoiceExportIO> GetExportedIOInvoices(CompEntities entities, int actorCompanyId, int invoiceExportId)
        {

            var exportedIOInvoices = (from i in entities.InvoiceExportIO
                                      where i.InvoiceExportId == invoiceExportId
                                      select i).ToList();

            return exportedIOInvoices;

        }

        #endregion

        #endregion

        #region CSR

        public byte[] CreateCSRExportFile(Dictionary<string, string> employeeSocialSec, int actorCompanyId, int userId, string year)
        {
            try
            {

                XNamespace xmlns = XNamespace.Get("se/skatteverket/askatt/csr/1.0");
                XNamespace xsi = XNamespace.Get("http://www.w3.org/2001/XMLSchema-instance");
                XNamespace schemaLocation = XNamespace.Get("se/skatteverket/askatt/csr/1.0 http://xmls.skatteverket.se/se/skatteverket/askatt/csr/V1.0/CSRUtdrag.xsd");

                XDocument objXDoc = XmlUtil.CreateDocument(Constants.ENCODING_IBM437, true);

                /* Root */
                XElement rootElement =
                         new XElement(xmlns + "CSRUtdrag",
                            new XAttribute(xsi + "schemaLocation", schemaLocation),
                             new XAttribute(XNamespace.Xmlns + "xsi", xsi.NamespaceName));


                /* Label */
                XElement csrLabelElement = new XElement(xmlns + "Etikett");
                XElement labelInformation = this.CreateCSRLabelElement(actorCompanyId, userId, xmlns, year);
                csrLabelElement.Add(labelInformation);

                /* Register */
                XElement csrRegisterElement = new XElement(xmlns + "Registerutdrag");
                csrRegisterElement = this.CreateCSRRegisterElement(csrRegisterElement, employeeSocialSec, actorCompanyId, xmlns);

                /* create doc */
                rootElement.Add(csrLabelElement);
                rootElement.Add(csrRegisterElement);
                objXDoc.Add(rootElement);
                objXDoc.Declaration = new XDeclaration("1.0", "utf-8", "true");

                MemoryStream stream = new MemoryStream();
                objXDoc.Save(stream);

                return stream.ToArray();
            }
            catch (Exception ex)
            {

                base.LogError(ex, this.log);
                return new byte[1];
            }
        }

        #region Help-methods

        private XElement CreateCSRLabelElement(int actorCompanyId, int userId, XNamespace xmlns, string year)
        {
            string postaladress = string.Empty;
            string postalcode = string.Empty;
            string postaladdr = string.Empty;
            string contactEmail = string.Empty;
            string contactPhone = string.Empty;
            string orgnr = string.Empty;

            ContactAddressRow addr;
            ContactAddressRow postalCode;
            ContactAddressRow postalAddr;
            Company activeCompany;
            List<ContactAddress> cA;
            User currentUser;
            try
            {

                activeCompany = CompanyManager.GetCompany(actorCompanyId);
                cA = ContactManager.GetContactAddressesFromActorCompany(actorCompanyId);
                currentUser = UserManager.GetUser(userId);

                if (cA.Count > 0)
                {
                    addr = cA[0].ContactAddressRow.FirstOrDefault(r => r.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address);
                    postalCode = cA[0].ContactAddressRow.FirstOrDefault(r => r.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode);
                    postalAddr = cA[0].ContactAddressRow.FirstOrDefault(r => r.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress);

                    postaladress = addr != null ? addr.Text : String.Empty;
                    postalcode = postalCode != null ? postalCode.Text : String.Empty;
                    postaladdr = postalAddr != null ? postalAddr.Text : String.Empty;
                }

                var contactEcoms = ContactManager.GetContactEComsFromActor(actorCompanyId, false);
                foreach (var contactEcom in contactEcoms)
                {
                    if (contactEcom.SysContactEComTypeId == (int)TermGroup_SysContactEComType.CompanyAdminEmail)
                    {
                        contactEmail = contactEcom.Text;
                    }

                    if (contactEcom.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneJob)
                    {
                        contactPhone = contactEcom.Text;
                    }
                }

                orgnr = StringUtility.OrgNrWith16(activeCompany.OrgNr);

                return
                        new XElement(xmlns + "Frageetikett",
                        new XElement(xmlns + "Fragestallare",
                        new XAttribute("organisationsNr", orgnr.Replace("-", "")),

                            new XElement(xmlns + "Organisationsnamn", activeCompany.Name.TrimEnd()),

                             new XElement(xmlns + "Kontaktperson",
                                 new XElement(xmlns + "Namn", currentUser != null ? currentUser.Name : "N/A"),

                                     new XElement(xmlns + "Postadress",
                                            new XElement(xmlns + "Gatuadress", postaladress.TrimEnd()),
                                            new XElement(xmlns + "Postnr", postalcode.RemoveWhiteSpace()),
                                            new XElement(xmlns + "Postort", postaladdr.TrimEnd())
                                         ),
                                          new XElement(xmlns + "TelefonNr", contactPhone.TrimEnd()),
                                          new XElement(xmlns + "E-postadress", contactEmail.TrimEnd())
                                 )
                    ),
                     new XElement(xmlns + "Inkomstar", year),
                     new XElement(xmlns + "Programvara", "SoftOne")
                );
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                return new XElement("Error");
            }
        }

        private XElement CreateCSRRegisterElement(XElement csrRegisterElement, Dictionary<string, string> employeeSocialSec, int actorCompanyId, XNamespace xmlns)
        {
            Company activeCompany = CompanyManager.GetCompany(actorCompanyId);
            string orgNr = StringUtility.OrgNrWith16(activeCompany.OrgNr);

            XElement registerInformation =
                            new XElement(xmlns + "Arbetsgivare",
                            new XAttribute("organisationsNr", orgNr)
                            );

            foreach (KeyValuePair<string, string> employee in employeeSocialSec)
            {
                XElement employeeSocialSecNr = (new XElement(xmlns + "Anstalld",
                  new XAttribute("personNr", employee.Value),
                  new XElement(xmlns + "EgenReferens", employee.Key)
                 ));
                registerInformation.Add(employeeSocialSecNr);
            }

            csrRegisterElement.Add(registerInformation);

            return csrRegisterElement;
        }

        #endregion

        #endregion

        #region DI

        public ActionResult CreateDIRegnCustomerInvoiceExportFileFromAngular(List<int> itemsDict, int actorCompanyId, int userId, bool isPayment)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || itemsDict.IsNullOrEmpty())
                return result;

            string validationMsg = null;
            DataStorage dataStorage = null;
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            var diRegnExport = new DIRegnskapExport(company, isPayment);
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate DIRegnskap CustomerInvoiceExport

                        foreach (int invoiceId in itemsDict)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, invoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                #region Validation

                                //Can only get status Export from Origin
                                if ((invoice.Origin.Status != (int)SoeOriginStatus.Origin && !isPayment) &&
                                    (invoice.Origin.Status != (int)SoeOriginStatus.Payment && isPayment))
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }

                                // Invoice must have a invoice date in order to get kid
                                else if (!invoice.InvoiceDate.HasValue)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.DatesInvalid;
                                    result.ErrorMessage = "Invoice date must be set prior to export";
                                    return result;
                                }

                                #endregion

                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                    if (invoice.BillingAddressId > 0)
                                        customerBillingAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.BillingAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                }

                                #endregion

                                if (customer != null)
                                {
                                    var paymentInfoRows = PaymentManager.GetPaymentInformationRowDTOsFromActors(entities, customer.Actor.ActorId).FirstOrDefault();
                                    var kidNr = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), customer.CustomerNr.ToString(), (DateTime)invoice.InvoiceDate, 0);

                                    bool success = diRegnExport.AddForExport(invoice, customer, customerBillingAddress, customerDeliveryAddress, customerContactEcoms, paymentInfoRows.Value, kidNr, invoice.SeqNr);
                                    if (success)
                                    {
                                        generatedInvoices.Add(Tuple.Create(invoice.InvoiceId, invoice.InvoiceNr));

                                        #region UpdatePayments

                                        if (isPayment)
                                        {
                                            var paymentRow = invoice.PaymentRow.FirstOrDefault(i => i.SeqNr == invoice.SeqNr);
                                            if (paymentRow != null)
                                                paymentRow.Status = (int)SoePaymentStatus.Exported;
                                        }
                                        else
                                        {
                                            if (closeWhenExported)
                                                invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                            else
                                                invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;
                                        }

                                        #endregion
                                    }
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "DIRegnskap Customerinvoice Export failed for invoiceId: " + invoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        diRegnExport.Validate(out validationMsg);
                        XDocument document = diRegnExport.ToXml();
                        string generatedData = document.ToString();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "DI_" + DateTime.Now + Constants.SOE_SERVER_FILE_XML_SUFFIX;
                        if (isPayment)
                            description = "DI_Bet_" + DateTime.Now + Constants.SOE_SERVER_FILE_XML_SUFFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.DiRegnskapCustomerInvoiceExport, generatedData, null, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.DiRegnskapCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue = itemsDict.Count;
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult CreateDIRegnCustomerInvoiceExportFile(List<CustomerInvoiceGridDTO> items, int actorCompanyId, int userId, bool isPayment)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            string validationMsg = null;
            DataStorage dataStorage = null;
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            var diRegnExport = new DIRegnskapExport(company, isPayment);
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate SOP CustomerInvoiceExport

                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, item.CustomerInvoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                #region Validation

                                //Can only get status Export from Origin
                                if ((invoice.Origin.Status != (int)SoeOriginStatus.Origin && !isPayment) &&
                                    (invoice.Origin.Status != (int)SoeOriginStatus.Payment && isPayment))
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }

                                // Invoice must have a invoice date in order to get kid
                                else if (!invoice.InvoiceDate.HasValue)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.DatesInvalid;
                                    result.ErrorMessage = "Invoice date must be set prior to export";
                                    return result;
                                }

                                #endregion

                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                    if (invoice.BillingAddressId > 0)
                                        customerBillingAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.BillingAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                }

                                #endregion

                                var paymentInfoRows = PaymentManager.GetPaymentInformationRowDTOsFromActors(entities, customer != null ? customer.Actor.ActorId : 0).FirstOrDefault();
                                var kidNr = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), customer != null ? customer.CustomerNr.ToString() : "", (DateTime)invoice.InvoiceDate, 0);

                                bool success = diRegnExport.AddForExport(invoice, customer, customerBillingAddress, customerDeliveryAddress, customerContactEcoms, paymentInfoRows.Value, kidNr, item.PaymentSeqNr);
                                if (success)
                                {
                                    generatedInvoices.Add(Tuple.Create(item.CustomerInvoiceId, item.InvoiceNr));

                                    #region UpdatePayments

                                    if (isPayment)
                                    {
                                        var paymentRow = invoice.PaymentRow.FirstOrDefault(i => i.SeqNr == item.PaymentSeqNr);
                                        if (paymentRow != null)
                                            paymentRow.Status = (int)SoePaymentStatus.Exported;
                                    }
                                    else
                                    {
                                        if (closeWhenExported)
                                            invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                        else
                                            invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;
                                    }

                                    #endregion
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "DIRegnskap Customerinvoice Export failed for invoiceId: " + item.CustomerInvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        diRegnExport.Validate(out validationMsg);
                        XDocument document = diRegnExport.ToXml();
                        string generatedData = document.ToString();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "DI_" + DateTime.Now + Constants.SOE_SERVER_FILE_XML_SUFFIX;
                        if (isPayment)
                            description = "DI_Bet_" + DateTime.Now + Constants.SOE_SERVER_FILE_XML_SUFFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.DiRegnskapCustomerInvoiceExport, generatedData, null, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.DiRegnskapCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue = items.Count;
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        #endregion

        #region DnB NOR

        public ActionResult CreateDnBNorCustomerInvoiceExportFile(List<CustomerInvoiceGridDTO> items, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            string validationMsg = null;
            DataStorage dataStorage = null;
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();

            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);
            int? dnBNorClientId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceDnBNorClientId, 0, actorCompanyId, 0);
            decimal companyInterestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, actorCompanyId, 0);
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;
                        var dnBNorExport = new DnBNorExport(company, companyInterestPercent);

                        #endregion

                        #region Generate DnBNor CustomerInvoiceExport

                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, item.CustomerInvoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                #region Validation

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }

                                // Invoice must have a invoice date in order to get kid
                                else if (!invoice.InvoiceDate.HasValue)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.DatesInvalid;
                                    result.ErrorMessage = "Invoice date must be set prior to export";
                                    return result;
                                }

                                #endregion

                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                    if (invoice.BillingAddressId > 0)
                                        customerBillingAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.BillingAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);

                                    //ContactAddressRow Delivery   
                                    if (invoice.DeliveryAddressId > 0)
                                        customerDeliveryAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.DeliveryAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerDeliveryAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Delivery);
                                }

                                #endregion

                                var paymentInfoRows = PaymentManager.GetPaymentInformationRowDTOsFromActors(entities, customer != null ? customer.Actor.ActorId : 0).FirstOrDefault();
                                var kidNr = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), customer != null ? customer.CustomerNr.ToString() : "", (DateTime)invoice.InvoiceDate, 0);

                                bool success = dnBNorExport.AddForExport(invoice, customer, customerBillingAddress, customerDeliveryAddress, customerContactEcoms, paymentInfoRows.Value, kidNr, dnBNorClientId);
                                if (success)
                                {
                                    generatedInvoices.Add(Tuple.Create(item.CustomerInvoiceId, item.InvoiceNr));

                                    #region UpdateInvoice

                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;

                                    #endregion
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "DnBNOR Customerinvoice Export failed for invoiceId: " + item.CustomerInvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        dnBNorExport.Validate(out validationMsg);

                        XDocument document = dnBNorExport.ToXml();
                        document.Declaration = new XDeclaration("1.0", "UTF-8", "yes");
                        string generatedData = document.ToString();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "DnBNOR_" + DateTime.Now + Constants.SOE_SERVER_FILE_XML_SUFFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.DnBNorCustomerInvoiceExport, generatedData, null, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.DnBNorCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue = items.Count;
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        #endregion

        #region Zetes

        public ActionResult ExportToZetes(List<CustomerInvoiceGridDTO> items, int actorCompanyId, bool exportPayment)
        {

            var eim = new ElectronicInvoiceMananger(this.parameterObject);
            var zetesConfig = new SoftoneZetesConfiguration();
            zetesConfig.Username = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.ZetesUser, 0, actorCompanyId, 0);
            zetesConfig.Password = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.ZetesPwd, 0, actorCompanyId, 0);
            zetesConfig.StakeholderCode = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.ZetesStakeholderCode, 0, actorCompanyId, 0);
            zetesConfig.ClientCode = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.ZetesClientCode, 0, actorCompanyId, 0);
            var testMode = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ZetesTestMode, 0, actorCompanyId, 0);

            if (SettingManager.isTest() || SettingManager.isDev())
            {
                testMode = true;
            }
#if DEBUG
            testMode = true;
#endif

            var zetesConnector = new ZetesConnector();
            var successCount = 0;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    var tpdCategory = CategoryManager.GetCategory(entities, "tpd", (int)SoeCategoryType.Product, actorCompanyId);

                    if (tpdCategory == null)
                    {
                        return new ActionResult("Artikelkategori TPD saknas!");
                    }

                    foreach (var item in items)
                    {
                        var invoice = InvoiceManager.GetCustomerInvoiceDistribution(entities, SoeOriginType.CustomerInvoice, item.CustomerInvoiceId, actorCompanyId);
                        if (invoice != null)
                        {

                            var originalInvoiceNr = invoice.InvoiceNr;
                            var customerAddresses = eim.GetCustomerDistributionDTO(invoice.ActorId, 0, invoice.BillingAddressId);
                            invoice.IsEUCountryBased = invoice.ActorSysCountryId.HasValue ? CountryCurrencyManager.IsEuCountry(invoice.ActorSysCountryId.Value, DateTime.Today) : true;
                            invoice.ActorCountryCode = invoice.ActorSysCountryId.HasValue ? CountryCurrencyManager.GetCountryCode(invoice.ActorSysCountryId.Value) : "";

                            if (string.IsNullOrEmpty(invoice.ActorSupplierNr))
                            {
                                return new ActionResult(GetText(7718, "Leverantörsnummer saknas på kund") + ": " + invoice.ActorName);
                            }

                            var invoiceRows = InvoiceManager.GetCustomerInvoiceRowsSmall(entities, item.CustomerInvoiceId);
                            var tpdProductIds = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Product, SoeCategoryRecordEntity.Product, actorCompanyId, new List<int>() { tpdCategory.CategoryId }).Select(x => x.RecordId).ToList();

                            invoiceRows = invoiceRows.Where(x => tpdProductIds.Contains(x.ProductId ?? 0)).ToList();

                            if (!invoiceRows.Any())
                            {
                                return new ActionResult("Artikelrader med produkter enligt TPD direktivet saknas");
                            }

                            if (exportPayment)
                            {
                                if (invoice.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndOpen)
                                {
                                    return new ActionResult(GetText(7743, "Fakturan har inte exporterats") + ": " + originalInvoiceNr);
                                }

                                if (!invoice.FullyPayed)
                                {
                                    return new ActionResult(GetText(7744, "Fakturan är inte fullt betald") + ": " + originalInvoiceNr);
                                }
                                var connectedOrders = InvoiceManager.GetMappedInvoices(entities, invoice.InvoiceId, SoeOriginInvoiceMappingType.Order, false, true).Select(x => x.InvoiceNr).ToList();
                                var sendResult = zetesConnector.SendPayment(testMode, zetesConfig, invoice, customerAddresses, connectedOrders, invoiceRows, true);
                                if (sendResult.Success)
                                {
                                    var origin = OriginManager.GetOrigin(entities, invoice.InvoiceId);
                                    origin.Description += " Betalning exporterad till Zetes";
                                }
                                else
                                {
                                    return sendResult;
                                }
                                successCount++;
                            }
                            else
                            {
                                if (invoice.ExportStatus != (int)SoeInvoiceExportStatusType.NotExported)
                                {
                                    return new ActionResult(GetText(7729, "Fakturan har redan exporterats") + ": " + originalInvoiceNr);
                                }

                                if (invoice.BillingType == (int)TermGroup_BillingType.Credit)
                                {
                                    //According to EU a credit invoice substract the original invoice amount
                                    invoice.InvoiceNr = InvoiceManager.GetMappedInvoices(entities, invoice.InvoiceId, SoeOriginInvoiceMappingType.CreditInvoice, true, false).FirstOrDefault()?.InvoiceNr ?? invoice.InvoiceNr;
                                }

                                var connectedOrders = InvoiceManager.GetMappedInvoices(entities, invoice.InvoiceId, SoeOriginInvoiceMappingType.Order, false, true).Select(x => x.InvoiceNr).ToList();

                                var sendResult = zetesConnector.SendInvoice(testMode, zetesConfig, invoice, customerAddresses, connectedOrders, invoiceRows);
                                if (!sendResult.Success)
                                {
                                    sendResult.ErrorMessage = GetText(1910, "Fakturanr") + ":" + originalInvoiceNr + "\n" + sendResult.ErrorMessage;
                                    log.Error("ExportToZetes:" + sendResult.ErrorMessage);
                                    return sendResult;
                                }
                                InvoiceManager.SetExportStatus(entities, actorCompanyId, invoice.InvoiceId, SoeInvoiceExportStatusType.ExportedAndOpen, false);
                                successCount++;
                            }
                        }
                    }

                    if (successCount > 0)
                        entities.SaveChanges();
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(ex.Message);
                }
            }

            return new ActionResult { Success = successCount > 0, IntegerValue = successCount, InfoMessage = $"Exporterade fakturor {successCount} Misslyckade {items.Count - successCount}" };
        }

        #endregion

        #region CustomerPaymentServiceExportFile

        public int GetNextBatchNrFromInvoiceExport(CompEntities entities, int actorCompanyId, int sysPaymentServiceId)
        {
            entities.InvoiceExport.NoTracking();
            int batchId = (from h in entities.InvoiceExport
                           where h.ActorCompanyId == actorCompanyId && h.SysPaymentServiceId == sysPaymentServiceId
                           orderby h.BatchId descending
                           select h.BatchId).FirstOrDefault();

            return batchId + 1;
        }

        public ActionResult CreateCustomerPaymentServiceExportFile(List<InvoiceExportIODTO> items, int actorCompanyId, int userId, int sysPaymentService)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            int invoiceExportId = 0;
            int numberOfInvoices = 0;
            decimal totalAmount = 0;
            foreach (var item in items)
            {
                totalAmount += (decimal)item.InvoiceAmount;
                numberOfInvoices++;
            }
            string validationMsg = null;
            //string description = "AG_" + DateTime.Now + Constants.SOE_SERVER_FILE_TEXT_SUFFIX;
            string fileName = String.Empty;
            List<string> generatedData = null;

            int clientId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceAutogiroClientId, 0, actorCompanyId, 0);
            if (clientId == 0)
            {
                result.ErrorNumber = 10;
                result.ErrorMessage = GetText(27, "Kundnr hos BGC saknas");
                return result;
            }
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();


                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        if (!company.ActorReference.IsLoaded)
                            company.ActorReference.Load();
                        if (!company.Actor.Contact.IsLoaded)
                            company.Actor.Contact.Load();
                        if (company.Actor == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "Actor");

                        if (!company.Actor.PaymentInformation.IsLoaded)
                            company.Actor.PaymentInformation.Load();
                        if (company.Actor.PaymentInformation == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "PaymentInformation");


                        foreach (var item in company.Actor.PaymentInformation)
                        {
                            if (!item.PaymentInformationRow.IsLoaded)
                                item.PaymentInformationRow.Load();
                        }

                        #endregion

                        #region PaymentInformation

                        var paymentInformation = (from pi in company.Actor.PaymentInformation
                                                  where ((pi.PaymentInformationRow.Any(i => i.SysPaymentTypeId == (int)TermGroup_SysPaymentType.BG
                                                      && i.Default
                                                      && i.State == (int)SoeEntityState.Active)) &&
                                                  (pi.State == (int)SoeEntityState.Active))
                                                  select pi).FirstOrDefault()
                                                  ??
                                                  (from pi in company.Actor.PaymentInformation
                                                   where ((pi.PaymentInformationRow.Any(i => i.SysPaymentTypeId == (int)TermGroup_SysPaymentType.BG
                                                       && i.State == (int)SoeEntityState.Active)) &&
                                                   (pi.State == (int)SoeEntityState.Active))
                                                   select pi).FirstOrDefault();
                        if (paymentInformation == null)
                            return new ActionResult((int)ActionResultSave.PaymentFilePaymentInformationMissing);

                        if (!paymentInformation.PaymentInformationRow.IsLoaded)
                            paymentInformation.PaymentInformationRow.Load();

                        #endregion

                        #region PaymentInformationRow

                        if (paymentInformation.PaymentInformationRow == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "PaymentInformationRow");

                        var paymentInformationRows = (from pir in paymentInformation.PaymentInformationRow
                                                      where (pir.SysPaymentTypeId == (int)TermGroup_SysPaymentType.BG)
                                                      select pir).ToList<PaymentInformationRow>();

                        PaymentInformationRow paymentInformationRow = null;
                        if (paymentInformationRows != null)
                        {
                            //Choose the default if more than one PaymentInformationRow's exist
                            if (paymentInformationRows.Count == 1)
                                paymentInformationRow = paymentInformationRows.FirstOrDefault();
                            else if (paymentInformationRows.Count > 1)
                                paymentInformationRow = paymentInformationRows.FirstOrDefault(i => i.Default);
                        }

                        if (paymentInformationRow == null)
                            return new ActionResult((int)ActionResultSave.PaymentFilePaymentInformationMissing);
                        #endregion

                        #region Generate AutogiroExport



                        int companyBg = Utilities.PaymentNumber(paymentInformationRow.PaymentNr);
                        if (companyBg == 0)
                        {
                            result.ErrorNumber = 8;
                            return result;
                        }
                        var autogiroExport = new AutogiroExport(companyBg, clientId);



                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, (int)item.InvoiceId, false, true, false, false, true, true, false, false, false, false, false, false);

                                bool success = autogiroExport.AddForExport(item);
                                if (success && item.InvoiceExportIOId == 0)
                                {
                                    #region UpdateInvoice

                                    invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;

                                    #endregion
                                    InvoiceExport invoiceExport = null;
                                    #region Create InvoiceExport and InvoiceExportIO
                                    if (invoiceExportId == 0)
                                    {
                                        int batchId = GetNextBatchNrFromInvoiceExport(entities, actorCompanyId, sysPaymentService);

                                        invoiceExport = new InvoiceExport()
                                        {
                                            ActorCompanyId = actorCompanyId,
                                            ExportDate = DateTime.Now,
                                            NumberOfInvoices = numberOfInvoices,
                                            SysPaymentServiceId = sysPaymentService,
                                            TotalAmount = totalAmount,
                                            BatchId = batchId,
                                        };


                                        SetCreatedProperties(invoiceExport);
                                        AddEntityItem(entities, invoiceExport, "InvoiceExport");
                                        invoiceExportId = invoiceExport.InvoiceExportId;
                                    }
                                    InvoiceExportIO invoiceExportIO = new InvoiceExportIO
                                    {
                                        InvoiceExportId = invoiceExportId,
                                        BankAccount = item.BankAccount,
                                        Currency = item.Currency,
                                        CustomerId = (int)item.CustomerId,
                                        CustomerName = item.CustomerName?.Left(100) ?? "",
                                        InvoiceDate = item.InvoiceDate,
                                        DueDate = item.DueDate,
                                        InvoiceAmount = item.InvoiceAmount,
                                        InvoiceId = (int)item.InvoiceId,
                                        InvoiceNr = item.InvoiceNr,
                                        InvoiceSeqnr = item.InvoiceSeqnr,
                                        InvoiceType = (int)item.InvoiceType,
                                        PayerId = item.PayerId
                                    };
                                    SetCreatedProperties(invoiceExportIO);
                                    AddEntityItem(entities, invoiceExportIO, "InvoiceExportIO");
                                    #endregion
                                }
                            }

                            catch (Exception exp)
                            {
                                string message = "Autogiro Customerinvoice Export failed for invoiceId: " + item.InvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }
                        #endregion

                        generatedData = autogiroExport.GenerateExportFile();

                        #region Create file

                        StreamWriter sw = null;
                        string guid = Guid.NewGuid().ToString();
                        fileName = Utilities.GetAutogiroFileNameOnServer(guid);
                        string path = ConfigSettings.SOE_SERVER_DIR_TEMP_PHYSICAL + fileName;
                        try
                        {
                            result.StackTrace += "path:" + path;
                            FileStream file = new FileStream(path, FileMode.CreateNew, FileAccess.ReadWrite, FileShare.Read);
                            sw = new StreamWriter(file, Encoding.GetEncoding(1252));

                            foreach (String item in generatedData)
                            {
                                sw.WriteLine(item.ToString());
                            }
                        }
                        catch (Exception ex)
                        {
                            base.LogError(ex, this.log);
                            result.Exception = ex;
                            result.Success = false;
                            return result;
                        }
                        finally
                        {
                            sw?.Close();
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();

                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = fileName;
                        result.IntegerValue = items.Count;
                        result.IntegerValue2 = invoiceExportId;
                    }
                    else
                    {
                        switch (result.ErrorNumber)
                        {
                            case 8:
                                result.ErrorMessage = GetText(28, "Bankgironr saknas i företaget");
                                break;
                            case 10:
                                result.ErrorMessage = GetText(27, "Kundnr hos BGC saknas");
                                break;
                            default:
                                result.ErrorMessage = GetText(22, "Ett fel uppstod, kan inte skapa fil:");
                                break;
                        }
                        base.LogTransactionFailed(this.ToString(), this.log);
                    }

                    entities.Connection.Close();
                }
            }



            return result;
        }

        #endregion

        #region CustomerSpecificExports

        public ActionResult CreateCustomerExport(EvaluatedSelection selection)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                switch (selection.ExportFileType)
                {
                    case TermGroup_ReportExportFileType.ICACustomerBalance:
                    case TermGroup_ReportExportFileType.ICACustomerBalanceMyStore:
                        var icaBalance = new ICACustomerBalance(parameterObject, new Reporting.CreateReportResult() { EvaluatedSelection = selection });
                        result.StringValue = icaBalance.CreateFile(base.ActorCompanyId, selection.ExportFileType == TermGroup_ReportExportFileType.ICACustomerBalanceMyStore);
                        break;
                    case TermGroup_ReportExportFileType.ICACustomerMyStore:
                        var icaCustomers = new ICACustomer(parameterObject, new Reporting.CreateReportResult() { EvaluatedSelection = selection });
                        result.StringValue = icaCustomers.CreateFile(base.ActorCompanyId);
                        break;
                    case TermGroup_ReportExportFileType.PIRATVoucher:
                        var piratVoucher = new PIRATVoucher(parameterObject, new Reporting.CreateReportResult() { EvaluatedSelection = selection });
                        result.StringValue = piratVoucher.CreateFile(entities, base.ActorCompanyId);
                        break;
                    case TermGroup_ReportExportFileType.SafiloCustomers:
                        var safiloCustomers = new ICACustomer(parameterObject, new Reporting.CreateReportResult() { EvaluatedSelection = selection });
                        result.StringValue = safiloCustomers.CreateFileForSafilo(base.ActorCompanyId);
                        break;
                    case TermGroup_ReportExportFileType.SafiloInvoices:
                        var safiloBalance = new ICACustomerBalance(parameterObject, new Reporting.CreateReportResult() { EvaluatedSelection = selection });
                        result.StringValue = safiloBalance.CreateFileForSafilo(base.ActorCompanyId);
                        break;
                }
            }

            return result;
        }

        #endregion

        #region EFH

        public byte[] CreateEHFInvoice(int actorCompanyId, int invoiceId)
        {
            if (actorCompanyId == 0 || invoiceId == 0)
                return null;

            company = CompanyManager.GetCompany(actorCompanyId);
            if (company == null)
                return null;

            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);
            CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(invoiceId, false, true, false, false, true, true, false, true, false, false, false, false);
            List<CustomerInvoiceRow> invoiceRows = invoice.ActiveCustomerInvoiceRows.Where(i => i.Type == (int)SoeInvoiceRowType.ProductRow || i.Type == (int)SoeInvoiceRowType.BaseProductRow).ToList();
            PaymentInformation paymentInformation = PaymentManager.GetPaymentInformationFromActor(company.ActorCompanyId, true, false);
            SysCurrency invoiceCurrency = sysCurrencies.FirstOrDefault(i => i.SysCurrencyId == invoice.Currency.SysCurrencyId);
            Customer customer = invoice.Actor?.Customer;

            List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
            List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
            List<ContactAddressRow> companyAddress = new List<ContactAddressRow>();
            List<ContactAddressRow> companyBoardHQAddress = new List<ContactAddressRow>();
            List<ContactECom> companyContactEcoms = new List<ContactECom>();

            Contact customerContactPreferences = ContactManager.GetContactFromActor(invoice.Actor.ActorId, false, false);
            if (customerContactPreferences != null)
            {
                //ContactAddressRow Billing            
                customerBillingAddress = ContactManager.GetContactAddressRows(customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                //use the billingaddress on the invoie if it exits
                if (customerBillingAddress.Any(a => a.ContactAddress.ContactAddressId == invoice.BillingAddressId))
                    customerBillingAddress = customerBillingAddress.Where(a => a.ContactAddress.ContactAddressId == invoice.BillingAddressId).ToList();

                //ContactAddressRow Delivery            
                customerDeliveryAddress = ContactManager.GetContactAddressRows(customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Delivery);
                //use the deliveryAddress on the invoie if it exits
                if (customerDeliveryAddress.Any(a => a.ContactAddress.ContactAddressId == invoice.DeliveryAddressId))
                    customerDeliveryAddress = customerDeliveryAddress.Where(a => a.ContactAddress.ContactAddressId == invoice.DeliveryAddressId).ToList();
            }

            Contact companyContactPreferences = ContactManager.GetContactFromActor(company.ActorCompanyId, false, false);
            if (companyContactPreferences != null)
            {
                companyContactEcoms = ContactManager.GetContactEComs(companyContactPreferences.ContactId);
                companyAddress = ContactManager.GetContactAddressRows(companyContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Distribution);
                companyBoardHQAddress = ContactManager.GetContactAddressRows(companyContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.BoardHQ);
            }

            bool printHasTaxBillLabel = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingPrintTaxBillText, 0, actorCompanyId, 0);
            string exemptionReason = String.Empty;
            if (printHasTaxBillLabel)
                exemptionReason = GetText(5975, "Godkänd för F-skatt");

            EHFInvoiceItem ehfInvoiceItem = new EHFInvoiceItem(invoice, paymentInformation, company, invoiceCurrency, customer, invoiceRows, customerBillingAddress, customerDeliveryAddress, companyAddress, companyBoardHQAddress, companyContactEcoms, exemptionReason);

            //Document
            XDocument ehfInvoiceXml = XmlUtil.CreateDocument(Constants.ENCODING_IBM437, true);

            ehfInvoiceItem.ToXml(ref ehfInvoiceXml);
            if (ehfInvoiceItem.Validate())
            {
                //Stream data
                MemoryStream stream = new MemoryStream();
                ehfInvoiceXml.Save(stream);
                return stream.ToArray();
            }

            return null;
        }

        #endregion

        #region Finvoice

        public async Task<ActionResult> ImportFinvoiceFiles(List<int> dataStorageIds, int actorCompanyId)
        {
            ActionResult result = new ActionResult(true);

            var imported = 0;
            var total = 0;
            foreach (int dataStorageId in dataStorageIds)
            {
                Encoding iso = Encoding.GetEncoding("ISO-8859-1");
                DataStorage dataStorage = GeneralManager.GetDataStorage(dataStorageId, actorCompanyId);
                string content = iso.GetString(dataStorage.Data);
                var res = await EdiManager.AddFinvoiceFromFileImportAsync(null, dataStorage.FileName, actorCompanyId, content).ConfigureAwait(false);

                imported += res.IntegerValue;
                total += res.IntegerValue2;
            }

            // Add numbers
            result.IntegerValue = imported;
            result.IntegerValue2 = total;

            return result;
        }

        #endregion

        #region GrossProfitCodes

        public ActionResult ImportGrossProfitCodeIO(GrossProfitCodeIOItem grossProfitCodeIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromGrossProfitCodeIO(grossProfitCodeIOItem.grossProfitCodeIOs, actorCompanyId);
        }

        public ActionResult ImportFromGrossProfitCodeIO(List<GrossProfitCodeIODTO> grossProfitCodeIOs, int actorCompanyId)
        {

            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            List<GrossProfitCode> currentCodes = GrossProfitManager.GetGrossProfitCodes(actorCompanyId);
            List<AccountDim> dims = AccountManager.GetAccountDimInternalsByCompany(actorCompanyId, true);

            foreach (var code in grossProfitCodeIOs)
            {
                AccountYear accountYear = AccountManager.GetAccountYear(code.AccountYearDateFrom, actorCompanyId, false);

                if (accountYear == null)
                {
                    result.Success = false;
                    result.ErrorMessage = "No AccountYear found " + code.AccountYearDateFrom.ToShortDateString();
                    return result;
                }

                if (!currentCodes.Any(c => c.Code.ToString().ToLower() == code.Code.ToLower() && c.AccountYearId == accountYear.AccountYearId))
                {
                    AccountDim dim = dims.FirstOrDefault(d => d.AccountDimNr == code.AccountDimNr);
                    Account account = null;

                    if (!string.IsNullOrEmpty(code.AccountNr))
                    {
                        if (dim == null)
                        {
                            result.Success = false;
                            result.ErrorMessage = "No AccounDim found " + code.AccountDimNr.ToString();
                            return result;
                        }

                        account = AccountManager.GetAccountByNr(code.AccountNr, dim.AccountDimId, actorCompanyId, onlyActive: false);
                        if (account == null)
                        {
                            result.Success = false;
                            result.ErrorMessage = "No Internalaccount found " + code.AccountNr;
                            return result;
                        }
                    }

                    GrossProfitCodeDTO dto = new GrossProfitCodeDTO();

                    dto.ActorCompanyId = actorCompanyId;
                    dto.AccountYearId = accountYear.AccountYearId;
                    dto.Code = Convert.ToInt32(code.Code);
                    if (account != null)
                    {
                        dto.AccountDimId = dim.AccountDimId;
                        dto.AccountId = account.AccountId;
                    }
                    dto.Name = code.Name;
                    dto.Period1 = code.Period1;
                    dto.Period2 = code.Period2;
                    dto.Period3 = code.Period3;
                    dto.Period4 = code.Period4;
                    dto.Period5 = code.Period5;
                    dto.Period6 = code.Period6;
                    dto.Period7 = code.Period7;
                    dto.Period8 = code.Period8;
                    dto.Period9 = code.Period9;
                    dto.Period10 = code.Period10;
                    dto.Period11 = code.Period11;
                    dto.Period12 = code.Period12;
                    dto.OpeningBalance = code.OpeningBalance;
                    dto.Description = code.Description;

                    ActionResult saveResult = GrossProfitManager.SaveGrossProfitCode(actorCompanyId, dto);

                    if (saveResult.Success)
                        nbrOfSaved++;

                }
            }

            result.IntegerValue = nbrOfSaved;
            return result;

        }

        #endregion

        #region ICA

        public ActionResult ExportICACustomerBalance(int actorCompanyId)
        {
            ActionResult result = new ActionResult(true);
            var balanceItems = new List<ICACustomerBalanceItem>();

            List<Customer> customers = CustomerManager.GetCustomersByCompany(actorCompanyId, true);

            var invoices = InvoiceManager.GetCustomerInvoicesForGrid(SoeOriginStatusClassification.CustomerInvoicesOpen, (int)SoeOriginType.CustomerInvoice, actorCompanyId, 0, true, false, false, false, TermGroup_ChangeStatusGridAllItemsSelection.All, false);
            invoices = invoices.Where(x => x.Status == 2 || x.Status == 3).ToList();

            #region Create Items

            foreach (Customer customer in customers)
            {
                decimal balance = invoices.Where(i => i.ActorCustomerId == customer.ActorCustomerId).Sum(i => i.TotalAmount - i.PaidAmount);

                var balanceItem = new ICACustomerBalanceItem
                {
                    CustomerNr = customer.CustomerNr,
                    Name = customer.Name.Replace("\n", ","),
                    Discount = 0,
                    InLedger = balance,
                    CancellationFlag = false,
                };

                #region Billing Address

                List<ContactAddressItem> contactAddresses = ContactManager.GetContactAddressItems(customer.ActorCustomerId, ContactAddressItemType.AddressBilling);

                if (contactAddresses != null)
                {
                    ContactAddressItem billingAddress = contactAddresses.FirstOrDefault();

                    if (billingAddress != null)
                    {
                        balanceItem.Address = billingAddress.Address?.Replace("\n", ",");
                        balanceItem.PostalCode = billingAddress.PostalCode;
                        balanceItem.PostalAddress = billingAddress.PostalAddress?.Replace("\n", ",");
                    }
                }

                #endregion

                #region Phone Number

                List<ContactECom> contactPhoneNumbers = ContactManager.GetContactEComsFromActor(customer.ActorCustomerId, true);

                ContactECom phoneNumber = contactPhoneNumbers?.FirstOrDefault(c => c.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneJob);
                if (phoneNumber != null)
                    balanceItem.PhoneNr = phoneNumber.Text;

                ContactECom faxNumber = contactPhoneNumbers?.FirstOrDefault(c => c.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Fax);
                if (faxNumber != null)
                    balanceItem.FaxNr = faxNumber.Text;

                balanceItems.Add(balanceItem);

                #endregion
            }

            #endregion

            #region Create file

            string fileName = $"Kund.dat";
            var sb = new StringBuilder();
            try
            {
                foreach (ICACustomerBalanceItem item in balanceItems)
                {
                    sb.AppendLine(item.ToString());
                }
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
                result.Success = false;
                return result;
            }
            #endregion

            if (result.Success)
            {
                result.StringValue = fileName;
                result.Value = sb;
            }

            return result;
        }

        #endregion

        #region Intrastat

        public ActionResult CreateIntrastatStatisticsExport(EvaluatedSelection selection)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                var intrastat = new Intrastat(parameterObject, new Reporting.CreateReportResult() { EvaluatedSelection = selection });
                result.StringValue = intrastat.CreateFile(base.ActorCompanyId);
            }

            return result;
        }

        #endregion

        #region Sauma

        public byte[] CreateSaumaTimeSalarySpecificationReport(int actorCompanyId, int dataStorageId)
        {
            if (actorCompanyId == 0 || dataStorageId == 0)
                return null;

            company = CompanyManager.GetCompany(actorCompanyId);
            if (company == null)
                return null;
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.DataStorage.NoTracking();
            var record = (from ds in entitiesReadOnly.DataStorage
                          where ds.DataStorageId == dataStorageId && ds.ActorCompanyId == actorCompanyId
                          select ds).FirstOrDefault();

            return record?.Data?.ToArray();
        }

        #endregion

        #region SOP

        public ActionResult CreateSOPCustomerInvoiceExportFileFromAngular(List<int> itemsDict, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);
            if (actorCompanyId == 0 || itemsDict.IsNullOrEmpty())
                return result;

            //Get SysCurrencies
            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);
            DataStorage dataStorage = null;
            SOPCustomerInvoiceExport sopExport = new SOPCustomerInvoiceExport(company);
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate SOP CustomerInvoiceExport

                        foreach (int invoiceId in itemsDict)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, invoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }

                                SysCurrency invoiceCurrency = sysCurrencies.FirstOrDefault(i => i.SysCurrencyId == invoice.Currency.SysCurrencyId);
                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerVisitingAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                    //ContactAddressRow Delivery            
                                    customerVisitingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Visiting);
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                }

                                #endregion

                                bool success = sopExport.AddForExport(invoice, customer, invoiceCurrency, customerBillingAddress, customerVisitingAddress, customerContactEcoms);

                                if (success)
                                {
                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;
                                    generatedInvoices.Add(Tuple.Create(invoice.InvoiceId, invoice.InvoiceNr));
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "SOP Customerinvoice Export failed for invoiceId: " + invoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        byte[] generatedData = sopExport.GenerateExportFile();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "SOP_" + DateTime.Now + Constants.SOE_SERVER_FILE_DEF_SUFFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.SOPCustomerInvoiceExport, null, generatedData, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.SOPCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        if (dataStorage != null)
                        {
                            result.StringValue = dataStorage.Description;
                            result.IntegerValue2 = dataStorage.DataStorageId;
                        }
                        result.IntegerValue = generatedInvoices.Count;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }
            return result;
        }

        public ActionResult CreateSOPCustomerInvoiceExportFile(List<ChangeStatusGridViewDTO> items, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);
            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            //Get SysCurrencies
            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);
            DataStorage dataStorage = null;
            SOPCustomerInvoiceExport sopExport = new SOPCustomerInvoiceExport(company);
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate SOP CustomerInvoiceExport

                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, item.InvoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }

                                SysCurrency invoiceCurrency = sysCurrencies.FirstOrDefault(i => i.SysCurrencyId == invoice.Currency.SysCurrencyId);
                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerVisitingAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                    //ContactAddressRow Delivery            
                                    customerVisitingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Visiting);
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                }

                                #endregion

                                bool success = sopExport.AddForExport(invoice, customer, invoiceCurrency, customerBillingAddress, customerVisitingAddress, customerContactEcoms);
                                if (success)
                                {
                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;
                                    generatedInvoices.Add(Tuple.Create(item.InvoiceId, item.InvoiceNr));
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "SOP Customerinvoice Export failed for invoiceId: " + item.InvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        byte[] generatedData = sopExport.GenerateExportFile();

                        #endregion

                        #region DataStorage

                        if (generatedData == null || generatedInvoices.IsNullOrEmpty())
                            return result;

                        string description = "SOP_" + DateTime.Now + Constants.SOE_SERVER_FILE_DEF_SUFFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.SOPCustomerInvoiceExport, null, generatedData, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.SOPCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                        result.IntegerValue = generatedInvoices.Count;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult CreateSOPCustomerInvoiceExportFile(List<CustomerInvoiceGridDTO> items, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            //Get SysCurrencies
            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);
            DataStorage dataStorage = null;
            SOPCustomerInvoiceExport sopExport = new SOPCustomerInvoiceExport(company);
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate SOP CustomerInvoiceExport

                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, item.CustomerInvoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }

                                SysCurrency invoiceCurrency = sysCurrencies.FirstOrDefault(i => i.SysCurrencyId == invoice.Currency.SysCurrencyId);
                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerVisitingAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                    //ContactAddressRow Delivery            
                                    customerVisitingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Visiting);
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                }

                                #endregion

                                bool success = sopExport.AddForExport(invoice, customer, invoiceCurrency, customerBillingAddress, customerVisitingAddress, customerContactEcoms);

                                if (success)
                                {
                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;
                                    generatedInvoices.Add(Tuple.Create(item.CustomerInvoiceId, item.InvoiceNr));
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "SOP Customerinvoice Export failed for invoiceId: " + item.CustomerInvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        byte[] generatedData = sopExport.GenerateExportFile();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "SOP_" + DateTime.Now + Constants.SOE_SERVER_FILE_DEF_SUFFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.SOPCustomerInvoiceExport, null, generatedData, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.SOPCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                        result.IntegerValue = generatedInvoices.Count;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        #endregion

        #region UniMicro

        public ActionResult CreateUniMicroCustomerInvoiceExportFileFromAngular(List<int> itemsDict, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || itemsDict.IsNullOrEmpty())
                return result;

            string validationMsg = null;
            DataStorage dataStorage = null;
            var exportFile = new UniMicroExport(company);
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate UniMicro CustomerInvoiceExport

                        foreach (int invoiceId in itemsDict)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, invoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                #region Validation

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }
                                // Invoice must have a invoice date in order to get kid
                                else if (!invoice.InvoiceDate.HasValue)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.DatesInvalid;
                                    result.ErrorMessage = "Invoice date must be set prior to export";
                                    return result;
                                }

                                #endregion

                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerVisitingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                    if (invoice.BillingAddressId > 0)
                                        customerBillingAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.BillingAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                }

                                #endregion
                                var paymentInfoRows = PaymentManager.GetPaymentInformationRowDTOsFromActors(entities, customer != null ? customer.Actor.ActorId : 0).FirstOrDefault();
                                // InvoiceDate.HasValue is check in the beginning of the foreach
                                var kidNr = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), customer != null ? customer.CustomerNr.ToString() : "", invoice.InvoiceDate.Value, 0);

                                bool success = exportFile.AddForExport(invoice, customer, customerBillingAddress, customerDeliveryAddress, customerContactEcoms, paymentInfoRows.Value, kidNr);

                                if (success)
                                {
                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;

                                    generatedInvoices.Add(Tuple.Create(invoice.InvoiceId, invoice.InvoiceNr));
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "UNIMicro Customerinvoice Export failed for invoiceId: " + invoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        exportFile.Validate(out validationMsg);
                        byte[] generatedData = exportFile.ToCSV();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "UniMicro_" + DateTime.Now + Constants.SOE_SERVER_FILE_CSV_PREFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.UniMicroCustomerInvoiceExport, null, generatedData, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.UniMicroCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue = itemsDict.Count;
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult CreateUniMicroCustomerInvoiceExportFile(List<ChangeStatusGridViewDTO> items, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            string validationMsg = null;
            DataStorage dataStorage = null;
            var exportFile = new UniMicroExport(company);
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate SOP CustomerInvoiceExport

                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, item.InvoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                #region Validation

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }
                                // Invoice must have a invoice date in order to get kid
                                else if (!invoice.InvoiceDate.HasValue)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.DatesInvalid;
                                    result.ErrorMessage = "Invoice date must be set prior to export";
                                    return result;
                                }

                                #endregion

                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                    if (invoice.BillingAddressId > 0)
                                        customerBillingAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.BillingAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                }

                                #endregion
                                var paymentInfoRows = PaymentManager.GetPaymentInformationRowDTOsFromActors(entities, customer != null ? customer.Actor.ActorId : 0).FirstOrDefault();
                                // InvoiceDate.HasValue is check in the beginning of the foreach
                                var kidNr = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), customer != null ? customer.CustomerNr.ToString() : "", invoice.InvoiceDate.Value, 0);

                                bool success = exportFile.AddForExport(invoice, customer, customerBillingAddress, customerDeliveryAddress, customerContactEcoms, paymentInfoRows.Value, kidNr);

                                if (success)
                                {
                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;

                                    generatedInvoices.Add(Tuple.Create(item.InvoiceId, item.InvoiceNr));
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "UNIMicro Customerinvoice Export failed for invoiceId: " + item.InvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        exportFile.Validate(out validationMsg);
                        byte[] generatedData = exportFile.ToCSV();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "UniMicro_" + DateTime.Now + Constants.SOE_SERVER_FILE_CSV_PREFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.UniMicroCustomerInvoiceExport, null, generatedData, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.UniMicroCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue = items.Count;
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult CreateUniMicroCustomerInvoiceExportFile(List<CustomerInvoiceGridDTO> items, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(false);

            if (actorCompanyId == 0 || items.IsNullOrEmpty())
                return result;

            string validationMsg = null;
            DataStorage dataStorage = null;
            var exportFile = new UniMicroExport(company);
            List<Tuple<int, String>> generatedInvoices = new List<Tuple<int, string>>();
            bool closeWhenExported = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenExported, 0, actorCompanyId, 0);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        #region Prereq

                        company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return result;

                        #endregion

                        #region Generate SOP CustomerInvoiceExport

                        foreach (var item in items)
                        {
                            try
                            {
                                CustomerInvoice invoice = InvoiceManager.GetCustomerInvoice(entities, item.CustomerInvoiceId, false, true, false, false, true, true, false, true, true, false, false, true);

                                #region Validation

                                //Can only get status Export from Origin
                                if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Voucher)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.InvalidStateTransition;
                                    return result;
                                }
                                // Invoice must have a invoice date in order to get kid
                                else if (!invoice.InvoiceDate.HasValue)
                                {
                                    result.Success = false;
                                    result.ErrorNumber = (int)ActionResultSave.DatesInvalid;
                                    result.ErrorMessage = "Invoice date must be set prior to export";
                                    return result;
                                }

                                #endregion

                                Customer customer = invoice.Actor?.Customer;

                                List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                                List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();
                                List<ContactECom> customerContactEcoms = new List<ContactECom>();

                                #region Billing And Delivery Address

                                Contact customerContactPreferences = ContactManager.GetContactFromActor(entities, invoice.Actor.ActorId, false, false);
                                if (customerContactPreferences != null)
                                {
                                    //ContactAddressRow Billing            
                                    customerContactEcoms = ContactManager.GetContactEComs(entities, customerContactPreferences.ContactId);
                                    if (invoice.BillingAddressId > 0)
                                        customerBillingAddress = ContactManager.GetContactAddress(entities, customerContactPreferences.ContactId, invoice.BillingAddressId, false, loadContactAddressRow: true).ContactAddressRow.ToList();
                                    else
                                        customerBillingAddress = ContactManager.GetContactAddressRows(entities, customerContactPreferences.ContactId, (int)TermGroup_SysContactAddressType.Billing);
                                }

                                #endregion
                                var paymentInfoRows = PaymentManager.GetPaymentInformationRowDTOsFromActors(entities, customer != null ? customer.Actor.ActorId : 0).FirstOrDefault();
                                // InvoiceDate.HasValue is check in the beginning of the foreach
                                var kidNr = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), customer != null ? customer.CustomerNr.ToString() : "", invoice.InvoiceDate.Value, 0);

                                bool success = exportFile.AddForExport(invoice, customer, customerBillingAddress, customerDeliveryAddress, customerContactEcoms, paymentInfoRows.Value, kidNr);
                                if (success)
                                {
                                    if (closeWhenExported)
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndClosed;
                                    else
                                        invoice.ExportStatus = (int)SoeInvoiceExportStatusType.ExportedAndOpen;

                                    generatedInvoices.Add(Tuple.Create(item.CustomerInvoiceId, item.InvoiceNr));
                                }
                            }
                            catch (Exception exp)
                            {
                                string message = "UNIMicro Customerinvoice Export failed for invoiceId: " + item.CustomerInvoiceId;
                                SoeGeneralException soeEx = new SoeGeneralException(message, exp, this.ToString());
                                base.LogError(soeEx, this.log);
                            }
                        }

                        exportFile.Validate(out validationMsg);
                        byte[] generatedData = exportFile.ToCSV();

                        #endregion

                        #region DataStorage

                        if (generatedData.IsNullOrEmpty())
                            return result;

                        string description = "UniMicro_" + DateTime.Now + Constants.SOE_SERVER_FILE_CSV_PREFIX;

                        dataStorage = GeneralManager.CreateDataStorage(entities, SoeDataStorageRecordType.UniMicroCustomerInvoiceExport, null, generatedData, null, null, actorCompanyId, description);

                        foreach (var generatedInvoice in generatedInvoices)
                        {
                            GeneralManager.CreateDataStorageRecord(entities, SoeDataStorageRecordType.UniMicroCustomerInvoiceExport, generatedInvoice.Item1, generatedInvoice.Item2, SoeEntityType.CustomerInvoice, dataStorage);
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);

                        //Commmit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        result.ErrorMessage = validationMsg;
                        result.StringValue = dataStorage?.Description ?? "";
                        result.IntegerValue = items.Count;
                        result.IntegerValue2 = dataStorage?.DataStorageId ?? 0;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        #endregion

        #region Automaster

        public ActionResult ImportAutomaster(Stream stream, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            string customerInvoiceHeadIOBatchId = "";
            string customerInvoiceRowIOBatchId = "";
            CustomerIOItem customerIOItem = new CustomerIOItem();
            CustomerInvoiceIOItem invoiceIOItem = new CustomerInvoiceIOItem();
            CustomerInvoiceRowIOItem rowIOItem = new CustomerInvoiceRowIOItem();
            int invoiceImportId = 0;
            int rowImportId = 0;
            string specialFunctionalities = "";

            StreamReader sr = new StreamReader(stream, Constants.ENCODING_LATIN1);

            while (!sr.EndOfStream)
            {
                string line = sr.ReadLine();
                if (string.IsNullOrEmpty(line)) continue;

                if (line.StartsWith("AS"))
                {//Customers
                    string number = line.Substring(2, 9);
                    number = number.TrimStart('0');
                    string name = line.Substring(11, 30).Trim() + " " + line.Substring(111, 20).Trim();
                    string address = line.Substring(231, 30).Trim();
                    string postalcode = line.Substring(281, 5).Trim();
                    string city = line.Substring(286, 12).Trim();
                    string phonework = line.Substring(329, 12).Trim();
                    string phonehome = line.Substring(349, 12).Trim();
                    string orgNr = line.Substring(388, 11).Trim();
                    CustomerIODTO customerToAdd = new CustomerIODTO();
                    customerToAdd.ActorCompanyId = actorCompanyId;
                    customerToAdd.CustomerNr = number;
                    customerToAdd.Name = name;
                    customerToAdd.OrgNr = orgNr;
                    customerToAdd.PhoneHome = phonehome;
                    customerToAdd.PhoneJob = phonework;
                    customerToAdd.BillingAddress = address;
                    customerToAdd.BillingPostalCode = postalcode;
                    customerToAdd.BillingPostalAddress = city;
                    customerIOItem.Customers.Add(customerToAdd);
                }
                else if (line.StartsWith("AL"))
                {//Invoices
                    string customerNumber = line.Substring(2, 9).Trim();
                    customerNumber = customerNumber.TrimStart('0');
                    string transferType = line.Substring(71, 4).Trim();
                    string costPlace = line.Substring(109, 9).Trim();
                    string account = line.Substring(45, 5).Trim();
                    string invoiceNumber = line.Substring(62, 9).Trim();
                    invoiceNumber = invoiceNumber.TrimStart('0');
                    decimal amount = Convert.ToDecimal(line.Substring(33, 12).Trim().Replace(".", ","));
                    string invDate = line.Substring(11, 8);
                    string dueDate = line.Substring(25, 8).Trim();
                    DateTime invDtm = new DateTime(Convert.ToInt32(invDate.Substring(0, 4)), Convert.ToInt32(invDate.Substring(4, 2)), Convert.ToInt32(invDate.Substring(6, 2)));
                    DateTime? dueDtm = null;
                    if (dueDate.Length > 1)
                    {
                        dueDtm = new DateTime(Convert.ToInt32(dueDate.Substring(0, 4)), Convert.ToInt32(dueDate.Substring(4, 2)), Convert.ToInt32(dueDate.Substring(6, 2)));
                    }

                    CustomerInvoiceIODTO invToAdd = new CustomerInvoiceIODTO();
                    invToAdd.CustomerNr = customerNumber;
                    invToAdd.CustomerInvoiceNr = invoiceNumber;
                    invToAdd.SeqNr = Convert.ToInt32(invoiceNumber);
                    invToAdd.RegistrationType = (int)OrderInvoiceRegistrationType.Ledger;
                    invToAdd.OriginType = (int)SoeOriginType.CustomerInvoice;
                    invToAdd.OriginStatus = (int)SoeOriginStatus.Origin;
                    invToAdd.TotalAmount = amount;
                    invToAdd.TotalAmountCurrency = amount;
                    invToAdd.SumAmount = amount;
                    invToAdd.TransferType = transferType;
                    invToAdd.ImportHeadType = (int)TermGroup_IOImportHeadType.CustomerInvoice;
                    invToAdd.BillingAddressCO = account;
                    invToAdd.ClaimAccountNr = account;
                    invToAdd.ClaimAccountNrDim2 = costPlace;
                    invToAdd.InvoiceDate = invDtm;
                    invToAdd.VoucherDate = invDtm;
                    invToAdd.DueDate = dueDtm;
                    invoiceIOItem.CustomerInvoices.Add(invToAdd);
                    //add claim account row to customerinvoicerows
                    CustomerInvoiceRowIODTO invRowToAdd = new CustomerInvoiceRowIODTO();
                    invRowToAdd.InvoiceNr = invoiceNumber;
                    invRowToAdd.CustomerRowType = SoeInvoiceRowType.AccountingRow;
                    //invRowToAdd.Quantity = 1;
                    invRowToAdd.AccountNr = account;
                    invRowToAdd.AccountDim2Nr = costPlace;
                    invRowToAdd.State = 0;
                    invRowToAdd.Amount = amount * -1;
                    invRowToAdd.AmountCurrency = amount * -1;
                    rowIOItem.customerInvoiceRows.Add(invRowToAdd);
                }
                else if (line.StartsWith("JL"))
                {//Invoices
                    string customerNumber = line.Substring(2, 9).Trim();
                    customerNumber = customerNumber.TrimStart('0');
                    string transferType = line.Substring(71, 4).Trim();
                    string costPlace = line.Substring(75, 9).Trim();
                    string account = line.Substring(45, 5).Trim();
                    string invoiceNumber = line.Substring(62, 9).Trim();
                    invoiceNumber = invoiceNumber.TrimStart('0');
                    decimal amount = Convert.ToDecimal(line.Substring(33, 12).Trim().Replace(".", ","));
                    string invDate = line.Substring(11, 8);
                    string dueDate = line.Substring(25, 8).Trim();
                    DateTime invDtm = new DateTime(Convert.ToInt32(invDate.Substring(0, 4)), Convert.ToInt32(invDate.Substring(4, 2)), Convert.ToInt32(invDate.Substring(6, 2)));
                    DateTime? dueDtm = null;
                    if (dueDate.Length > 1)
                    {
                        dueDtm = new DateTime(Convert.ToInt32(dueDate.Substring(0, 4)), Convert.ToInt32(dueDate.Substring(4, 2)), Convert.ToInt32(dueDate.Substring(6, 2)));
                    }
                    CustomerInvoiceIODTO invToAdd = new CustomerInvoiceIODTO();
                    invToAdd.CustomerNr = customerNumber;
                    invToAdd.CustomerInvoiceNr = invoiceNumber;
                    invToAdd.SeqNr = Convert.ToInt32(invoiceNumber);
                    invToAdd.RegistrationType = (int)OrderInvoiceRegistrationType.Ledger;
                    invToAdd.OriginType = (int)SoeOriginType.CustomerInvoice;
                    invToAdd.OriginStatus = (int)SoeOriginStatus.Origin;
                    invToAdd.TotalAmount = amount;
                    invToAdd.TotalAmountCurrency = amount;
                    invToAdd.SumAmount = amount;
                    invToAdd.TransferType = transferType;
                    invToAdd.ImportHeadType = (int)TermGroup_IOImportHeadType.CustomerInvoice;
                    invToAdd.ClaimAccountNr = account;
                    invToAdd.BillingAddressCO = account;
                    invToAdd.ClaimAccountNrDim2 = costPlace;
                    invToAdd.InvoiceDate = invDtm;
                    invToAdd.DueDate = dueDtm;
                    invoiceIOItem.CustomerInvoices.Add(invToAdd);
                    //add claim account row to customerinvoicerows
                    CustomerInvoiceRowIODTO invRowToAdd = new CustomerInvoiceRowIODTO();
                    invRowToAdd.InvoiceNr = invoiceNumber;
                    invRowToAdd.CustomerRowType = SoeInvoiceRowType.AccountingRow;
                    //   invRowToAdd.Quantity = 1;
                    invRowToAdd.AccountNr = account;
                    invRowToAdd.AccountDim2Nr = costPlace;
                    invRowToAdd.State = 0;
                    invRowToAdd.Amount = amount * -1;
                    invRowToAdd.AmountCurrency = amount * -1;
                    rowIOItem.customerInvoiceRows.Add(invRowToAdd);
                }
                else if (line.StartsWith("TI"))
                {//Rows Type always 1
                    string account = line.Substring(39, 5).Trim();
                    string costplace = line.Substring(20, 9).Trim();
                    string invoiceNumber = line.Substring(11, 9).Trim();
                    invoiceNumber = invoiceNumber.TrimStart('0');
                    decimal amount = Convert.ToDecimal(line.Substring(29, 10).Trim().Replace(".", ","));
                    CustomerInvoiceRowIODTO invRowToAdd = new CustomerInvoiceRowIODTO();
                    invRowToAdd.InvoiceNr = invoiceNumber;
                    invRowToAdd.CustomerRowType = SoeInvoiceRowType.AccountingRow;
                    invRowToAdd.AccountNr = account;
                    invRowToAdd.AccountDim2Nr = costplace;
                    invRowToAdd.State = 0;
                    invRowToAdd.Amount = amount;
                    invRowToAdd.AmountCurrency = amount;
                    rowIOItem.customerInvoiceRows.Add(invRowToAdd);
                }
            }
            //sr.Close();

            List<Import> imps = GetImports(actorCompanyId);
            if (imps != null)
            {
                Import invoiceImport = imps.FirstOrDefault(i => i.ImportDefinitionId == 36);
                if (invoiceImport != null)
                    invoiceImportId = invoiceImport.ImportId;
                Import invoiceRowImport = imps.FirstOrDefault(i => i.ImportDefinitionId == 37 || i.ImportDefinitionId == 82);
                if (invoiceRowImport != null)
                {
                    rowImportId = invoiceRowImport.ImportId;
                    specialFunctionalities = "Automaster";
                }
            }
            //Customers
            if (customerIOItem.Customers.Any())
                result = ImportCustomerIO(customerIOItem, TermGroup_IOImportHeadType.Customer, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, "Automaster", true, true);
            if (invoiceIOItem.CustomerInvoices.Any())
            {
                result = ImportCustomerInvoiceIO(invoiceIOItem, TermGroup_IOImportHeadType.CustomerInvoice, invoiceImportId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, "Automaster", true);
                customerInvoiceHeadIOBatchId = result.StringValue;
            }
            if (rowIOItem.customerInvoiceRows.Any())
            {
                result = ImportCustomerInvoiceRowIO(rowIOItem, TermGroup_IOImportHeadType.CustomerInvoiceRow, rowImportId, TermGroup_IOSource.XE, TermGroup_IOType.XEConnect, actorCompanyId, true, specialFunctionalities);
                customerInvoiceRowIOBatchId = result.StringValue;

                //add CustomerInvoiceHeadIOId to rows
                using (var entities = new CompEntities())
                {
                    entities.UpdateCustomerInvoiceRowIOWithHeadId(actorCompanyId, customerInvoiceHeadIOBatchId, customerInvoiceRowIOBatchId);
                }
            }

            result.StringValue = customerInvoiceHeadIOBatchId;

            return result;
        }
        #endregion

        #region IO

        #region Common IO

        public IEnumerable<ImportBatchDTO> GetImportBatches(int actorCompanyId, TermGroup_IOImportHeadType? importHeadType = null, TermGroup_GridDateSelectionType allItemsSelection = TermGroup_GridDateSelectionType.All, string importBatchId = null)
        {
            List<ImportBatchDTO> dtos = new List<ImportBatchDTO>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            // Get terms
            var types = base.GetTermGroupDict(TermGroup.IOType);
            var sources = base.GetTermGroupDict(TermGroup.IOSource);
            var headTypes = base.GetTermGroupDict(TermGroup.IOImportHeadType);
            var statuses = base.GetTermGroupDict(TermGroup.IOStatus);

            List<ImportBatchDTO> batches = new List<ImportBatchDTO>();

            var selectionDate = InvoiceManager.GetSelectionDate(allItemsSelection);

            #region Supplier

            if (!importHeadType.HasValue || importHeadType.Value == TermGroup_IOImportHeadType.Supplier)
            {
                // Get batches
                entitiesReadOnly.SupplierIO.NoTracking();
                var querySupplier = (from io in entitiesReadOnly.SupplierIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     (allItemsSelection == TermGroup_GridDateSelectionType.All || io.Created >= selectionDate) &&
                                     io.State == (int)SoeEntityState.Active
                                     select io.BatchId).Distinct();
                if (!string.IsNullOrEmpty(importBatchId))
                {
                    querySupplier = querySupplier.Where(x => x == importBatchId);
                }
                List<string> batchIds = querySupplier.ToList();
                foreach (string batchId in batchIds)
                {
                    // Get distinct entries for current batch (may differ on Status an Created)
                    batches.AddRange(from io in entitiesReadOnly.SupplierIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     io.BatchId == batchId &&
                                     io.State == (int)SoeEntityState.Active
                                     select new ImportBatchDTO()
                                     {
                                         RecordId = io.SupplierIOId,
                                         Type = (TermGroup_IOType)io.Type,
                                         Source = (TermGroup_IOSource)io.Source,
                                         ImportHeadType = (TermGroup_IOImportHeadType)io.ImportHeadType,
                                         Status = new List<TermGroup_IOStatus>() { (TermGroup_IOStatus)io.Status },
                                         BatchId = io.BatchId,
                                         Created = io.Created
                                     });
                }
            }

            #endregion

            #region SupplierInvoice

            if (!importHeadType.HasValue || importHeadType.Value == TermGroup_IOImportHeadType.SupplierInvoice || importHeadType.Value == TermGroup_IOImportHeadType.SupplierInvoiceAnsjo)
            {
                // Get batches
                entitiesReadOnly.SupplierInvoiceHeadIO.NoTracking();
                var querySupplierInvoice = (from io in entitiesReadOnly.SupplierInvoiceHeadIO
                                            where io.ActorCompanyId == actorCompanyId &&
                                            (allItemsSelection == TermGroup_GridDateSelectionType.All || io.Created >= selectionDate) &&
                                            io.State == (int)SoeEntityState.Active
                                            select io.BatchId).Distinct();
                if (!string.IsNullOrEmpty(importBatchId))
                {
                    querySupplierInvoice = querySupplierInvoice.Where(x => x == importBatchId);
                }
                List<string> batchIds = querySupplierInvoice.ToList();


                foreach (string batchId in batchIds)
                {
                    // Get distinct entries for current batch (may differ on Status an Created)
                    batches.AddRange(from io in entitiesReadOnly.SupplierInvoiceHeadIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     io.BatchId == batchId &&
                                     io.State == (int)SoeEntityState.Active
                                     select new ImportBatchDTO()
                                     {
                                         RecordId = io.SupplierInvoiceHeadIOId,
                                         Type = (TermGroup_IOType)io.Type,
                                         Source = (TermGroup_IOSource)io.Source,
                                         ImportHeadType = (TermGroup_IOImportHeadType)io.ImportHeadType,
                                         Status = new List<TermGroup_IOStatus>() { (TermGroup_IOStatus)io.Status },
                                         BatchId = io.BatchId,
                                         Created = io.Created
                                     });
                }
            }

            #endregion

            #region Customer

            if (!importHeadType.HasValue || importHeadType.Value == TermGroup_IOImportHeadType.Customer)
            {
                // Get batches
                entitiesReadOnly.CustomerIO.NoTracking();
                var queryCustomer = (from io in entitiesReadOnly.CustomerIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     (allItemsSelection == TermGroup_GridDateSelectionType.All || io.Created >= selectionDate) &&
                                     io.State == (int)SoeEntityState.Active
                                     select io.BatchId).Distinct();
                if (!string.IsNullOrEmpty(importBatchId))
                {
                    queryCustomer = queryCustomer.Where(x => x == importBatchId);
                }
                List<string> batchIds = queryCustomer.ToList();

                foreach (string batchId in batchIds)
                {
                    // Get distinct entries for current batch (may differ on Status an Created)
                    batches.AddRange(from io in entitiesReadOnly.CustomerIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     io.BatchId == batchId &&
                                     io.State == (int)SoeEntityState.Active
                                     select new ImportBatchDTO()
                                     {
                                         RecordId = io.CustomerIOId,
                                         Type = (TermGroup_IOType)io.Type,
                                         Source = (TermGroup_IOSource)io.Source,
                                         ImportHeadType = (TermGroup_IOImportHeadType)io.ImportHeadType,
                                         Status = new List<TermGroup_IOStatus>() { (TermGroup_IOStatus)io.Status },
                                         BatchId = io.BatchId,
                                         Created = io.Created
                                     });
                }
            }

            #endregion

            #region CustomerInvoice

            if (!importHeadType.HasValue || importHeadType.Value == TermGroup_IOImportHeadType.CustomerInvoice)
            {
                // Get batches
                entitiesReadOnly.CustomerInvoiceHeadIO.NoTracking();
                var queryCustomerInvoice = (from io in entitiesReadOnly.CustomerInvoiceHeadIO
                                            where io.ActorCompanyId == actorCompanyId &&
                                            (allItemsSelection == TermGroup_GridDateSelectionType.All || io.Created >= selectionDate) &&
                                            io.State == (int)SoeEntityState.Active
                                            select io.BatchId).Distinct();
                if (!string.IsNullOrEmpty(importBatchId))
                {
                    queryCustomerInvoice = queryCustomerInvoice.Where(x => x == importBatchId);
                }
                List<string> batchIds = queryCustomerInvoice.ToList();

                foreach (string batchId in batchIds)
                {
                    // Get distinct entries for current batch (may differ on Status an Created)
                    batches.AddRange(from io in entitiesReadOnly.CustomerInvoiceHeadIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     io.BatchId == batchId &&
                                     io.State == (int)SoeEntityState.Active
                                     select new ImportBatchDTO()
                                     {
                                         RecordId = io.CustomerInvoiceHeadIOId,
                                         Type = (TermGroup_IOType)io.Type,
                                         Source = (TermGroup_IOSource)io.Source,
                                         ImportHeadType = (TermGroup_IOImportHeadType)io.ImportHeadType,
                                         Status = new List<TermGroup_IOStatus>() { (TermGroup_IOStatus)io.Status },
                                         BatchId = io.BatchId,
                                         Created = io.Created
                                     });
                }
            }

            #endregion

            #region CustomerInvoiceRow

            if (!importHeadType.HasValue || importHeadType.Value == TermGroup_IOImportHeadType.CustomerInvoiceRow)
            {
                // Get batches
                entitiesReadOnly.CustomerInvoiceRowIO.NoTracking();
                var queryCustomerInvoiceRow = (from io in entitiesReadOnly.CustomerInvoiceRowIO
                                               where io.ActorCompanyId == actorCompanyId &&
                                               (allItemsSelection == TermGroup_GridDateSelectionType.All || io.Created >= selectionDate) &&
                                               io.State == (int)SoeEntityState.Active
                                               select io.BatchId).Distinct();
                if (!string.IsNullOrEmpty(importBatchId))
                {
                    queryCustomerInvoiceRow = queryCustomerInvoiceRow.Where(x => x == importBatchId);
                }
                List<string> batchIds = queryCustomerInvoiceRow.ToList();

                foreach (string batchId in batchIds)
                {
                    // Get distinct entries for current batch (may differ on Status an Created)
                    batches.AddRange(from io in entitiesReadOnly.CustomerInvoiceRowIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     io.BatchId == batchId &&
                                     io.State == (int)SoeEntityState.Active
                                     select new ImportBatchDTO()
                                     {
                                         RecordId = io.CustomerInvoiceRowIOId,
                                         Type = (TermGroup_IOType)io.Type,
                                         Source = (TermGroup_IOSource)io.Source,
                                         ImportHeadType = (TermGroup_IOImportHeadType)io.ImportHeadType,
                                         Status = new List<TermGroup_IOStatus>() { (TermGroup_IOStatus)io.Status },
                                         BatchId = io.BatchId,
                                         Created = io.Created
                                     });
                }
            }

            #endregion

            #region Voucher

            if (!importHeadType.HasValue || importHeadType.Value == TermGroup_IOImportHeadType.Voucher)
            {
                // Get batches
                entitiesReadOnly.VoucherHeadIO.NoTracking();
                var queryVoucher = (from io in entitiesReadOnly.VoucherHeadIO
                                    where io.ActorCompanyId == actorCompanyId &&
                                    (allItemsSelection == TermGroup_GridDateSelectionType.All || io.Created >= selectionDate) &&
                                    io.State == (int)SoeEntityState.Active
                                    select io.BatchId).Distinct();
                if (!string.IsNullOrEmpty(importBatchId))
                {
                    queryVoucher = queryVoucher.Where(x => x == importBatchId);
                }
                List<string> batchIds = queryVoucher.ToList();
                foreach (string batchId in batchIds)
                {
                    // Get distinct entries for current batch (may differ on Status an Created)
                    batches.AddRange(from io in entitiesReadOnly.VoucherHeadIO
                                     where io.ActorCompanyId == actorCompanyId &&
                                     io.BatchId == batchId &&
                                     io.State == (int)SoeEntityState.Active
                                     select new ImportBatchDTO()
                                     {
                                         RecordId = io.VoucherHeadIOId,
                                         Type = (TermGroup_IOType)io.Type,
                                         Source = (TermGroup_IOSource)io.Source,
                                         ImportHeadType = (TermGroup_IOImportHeadType)io.ImportHeadType,
                                         Status = new List<TermGroup_IOStatus>() { (TermGroup_IOStatus)io.Status },
                                         BatchId = io.BatchId,
                                         Created = io.Created
                                     });
                }
            }

            #endregion

            foreach (ImportBatchDTO batch in batches.OrderByDescending(i => i.Created))
            {
                // Add unique entries to result (concatenating Status)
                if (!dtos.Any(d => d.BatchId == batch.BatchId))
                {
                    // Set display names from terms
                    batch.TypeName = types.ContainsKey((int)batch.Type) ? types[(int)batch.Type] : string.Empty;
                    batch.SourceName = sources.ContainsKey((int)batch.Source) ? sources[(int)batch.Source] : string.Empty;
                    batch.ImportHeadTypeName = headTypes.ContainsKey((int)batch.ImportHeadType) ? headTypes[(int)batch.ImportHeadType] : string.Empty;
                    batch.StatusName = new List<string>() { statuses.ContainsKey((int)batch.Status.First()) ? statuses[(int)batch.Status.First()] : string.Empty };
                    dtos.Add(batch);
                }
                else
                {
                    ImportBatchDTO dto = dtos.FirstOrDefault(d => d.BatchId == batch.BatchId);
                    if (dto != null && !dto.Status.Contains(batch.Status.First()))
                    {
                        dto.Status.Add(batch.Status.First());
                        batch.StatusName = new List<string>() { statuses.ContainsKey((int)batch.Status.First()) ? statuses[(int)batch.Status.First()] : string.Empty };
                        dto.StatusName.Add(batch.StatusName.First());
                    }
                }
            }

            return dtos;
        }


        #endregion

        public ActionResult ImportAccountIO(AccountIOItem accountIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, string specialFunctionality = "")
        {
            return ImportFromAccountIO(accountIOItem.AccountIOs, actorCompanyId, specialFunctionality);
        }

        public ActionResult ImportFromAccountIO(List<AccountIODTO> accountIOs, int actorCompanyId, string specialFunctionality)
        {
            ITextService textService = new TextService(this._parameterObject);
            ILoggerService loggerService = new LoggerService(this._parameterObject);
            var accointIo = new AccountIOService(AccountManager, textService, loggerService);

            return accointIo.ImportFromAccountIO(accountIOs, actorCompanyId, specialFunctionality);
        }

        #region AccountYearIO

        public ActionResult ImportAccountYearIO(AccountYearIOItem accountYearIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromAccountYearIO(accountYearIOItem.AccountYearIOs, actorCompanyId);
        }

        public ActionResult ImportFromAccountYearIO(List<AccountYearIODTO> accountYearIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            int nbrOfSaved = 0;

            using (CompEntities entities = new CompEntities())
            {

                List<VoucherSeriesType> newVoucherSeriesTypes = new List<VoucherSeriesType>();
                List<VoucherSeriesType> oldVoucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(entities, actorCompanyId, false);

                try
                {

                    foreach (var accountYearIO in accountYearIOs)
                    {
                        foreach (var voucherSeriesIODTO in accountYearIO.VoucherSeries)
                        {
                            //Find out if VoucherSeriesType exists
                            if (oldVoucherSeriesTypes.Any(v => v.VoucherSeriesTypeNr == voucherSeriesIODTO.Nr))
                                continue;

                            //Find out if VoucherSeriesType exists
                            if (newVoucherSeriesTypes.Any(v => v.VoucherSeriesTypeNr == voucherSeriesIODTO.Nr))
                                continue;

                            //Skip empty rows SOP
                            if (voucherSeriesIODTO.Nr == -1)
                                continue;

                            //Skip if no name
                            if (voucherSeriesIODTO.Name == string.Empty)
                                continue;

                            //Skip if invalid date
                            if (voucherSeriesIODTO.VoucherDateLatest == CalendarUtility.DATETIME_DEFAULT)
                                continue;

                            VoucherSeriesType newVoucherSeriesType = new VoucherSeriesType();

                            newVoucherSeriesType.ActorCompanyId = actorCompanyId;
                            newVoucherSeriesType.Name = voucherSeriesIODTO.Name;
                            newVoucherSeriesType.VoucherSeriesTypeNr = voucherSeriesIODTO.Nr;
                            newVoucherSeriesType.StartNr = voucherSeriesIODTO.StartNumber;
                            newVoucherSeriesType.State = (int)SoeEntityState.Active;
                            newVoucherSeriesType.Company = CompanyManager.GetCompany(entities, actorCompanyId);

                            newVoucherSeriesTypes.Add(newVoucherSeriesType);

                            entities.VoucherSeriesType.AddObject(newVoucherSeriesType);

                        }
                    }

                    if (newVoucherSeriesTypes.Any())
                    {
                        entities.SaveChanges();

                        VoucherManager voucherManager = new VoucherManager(parameterObject);
                        voucherManager.GetTemplateVoucherSeriesType(actorCompanyId, true);

                        oldVoucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(entities, actorCompanyId, false);
                    }

                    foreach (var accountYearIO in accountYearIOs)
                    {
                        AccountYear accountYear = AccountManager.GetAccountYear(entities, accountYearIO.From, actorCompanyId, true);

                        //Check if exists
                        if (accountYear != null)
                            continue;

                        accountYear = new AccountYear();

                        accountYear.ActorCompanyId = actorCompanyId;
                        accountYear.From = accountYearIO.From;
                        accountYear.To = accountYearIO.To;
                        accountYear.Status = accountYearIO.Status;

                        ActionResult saveResult = AccountManager.AddAccountYear(entities, accountYear, actorCompanyId);

                        if (saveResult.Success)
                            return saveResult;

                        nbrOfSaved += saveResult.ObjectsAffected;
                    }

                    foreach (var accountYearIO in accountYearIOs)
                    {
                        AccountYear accountYear = AccountManager.GetAccountYear(entities, accountYearIO.From, actorCompanyId, true);

                        if (accountYear == null || (accountYear.AccountPeriod != null && accountYear.AccountPeriod.Any()))
                            continue;

                        foreach (var periodIO in accountYearIO.AccountPeriods)
                        {
                            AccountPeriod period = new AccountPeriod();

                            period.From = periodIO.From;
                            period.To = periodIO.To;
                            period.Status = periodIO.Status;
                            period.PeriodNr = periodIO.PeriodNr;
                            period.AccountYear = accountYear;

                            //Check if exists
                            if (accountYear.AccountPeriod != null && accountYear.AccountPeriod.Any(p => p.From != period.From))
                                AccountManager.AddAccountPeriod(entities, period, accountYear);
                        }

                        List<VoucherSeries> voucherSeries = VoucherManager.GetVoucherSeriesByYear(entities, accountYear.AccountYearId, actorCompanyId, false, false);

                        //Add voucherTemplateVoucherSeries
                        VoucherManager voucherManager = new VoucherManager(parameterObject);
                        VoucherSeriesType voucherSeriesType = voucherManager.GetTemplateVoucherSeriesType(actorCompanyId, false);
                        VoucherSeries templateVoucherSerie = new VoucherSeries();
                        templateVoucherSerie.VoucherDateLatest = null;
                        templateVoucherSerie.VoucherNrLatest = null;
                        templateVoucherSerie.VoucherSeriesTypeId = voucherSeriesType.VoucherSeriesTypeId;

                        VoucherManager.AddVoucherSeries(entities, templateVoucherSerie, actorCompanyId, accountYear.AccountYearId, templateVoucherSerie.VoucherSeriesTypeId);

                        foreach (var voucherSeriesIODTO in accountYearIO.VoucherSeries)
                        {

                            VoucherSeries voucherSerie = new VoucherSeries();
                            VoucherSeriesType type = new VoucherSeriesType();

                            if (voucherSeriesIODTO.VoucherDateLatest == CalendarUtility.DATETIME_DEFAULT)
                                continue;

                            if (oldVoucherSeriesTypes.Any(v => v.VoucherSeriesTypeNr == voucherSeriesIODTO.Nr))
                                type = oldVoucherSeriesTypes.FirstOrDefault(v => v.VoucherSeriesTypeNr == voucherSeriesIODTO.Nr);
                            else
                                continue;

                            //Check if exists
                            if (voucherSeries.Any(s => s.VoucherSeriesTypeId == type.VoucherSeriesTypeId))
                                continue;

                            voucherSerie.VoucherDateLatest = voucherSeriesIODTO.VoucherDateLatest;
                            voucherSerie.VoucherNrLatest = voucherSeriesIODTO.VoucherNrLatest;
                            voucherSerie.VoucherSeriesTypeId = type.VoucherSeriesTypeId;

                            VoucherManager.AddVoucherSeries(entities, voucherSerie, actorCompanyId, accountYear.AccountYearId, voucherSerie.VoucherSeriesTypeId);

                        }
                    }
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportFromAccountYearIO");
                }
            }

            result.IntegerValue = nbrOfSaved;
            return result;
        }

        public AccountIODTO GetAccountIODTO(string accountNr, int dimNr, int actorCompanyId)
        {
            var account = AccountManager.GetAccountByDimNr(accountNr, dimNr, actorCompanyId, loadAccountDim: true);
            if (account != null)
            {
                return new AccountIODTO
                {
                    AccountNr = account.AccountNr,
                    Name = account.Name,
                    AccountDimNr = account.AccountDim?.AccountDimNr ?? 0,
                    AccountDimName = account.AccountDim?.Name ?? string.Empty,
                    AccountDimSieNr = account.AccountDim?.SysSieDimNr ?? 0,
                    Created = account.Created ?? DateTime.MinValue
                };
            }
            else
            {
                return null;
            }
        }

        public List<VoucherSeriesIODTO> GetVoucherSeriesIODTOs(int actorCompanyId, DateTime date)
        {
            var voucherSeriesIODTO = new List<VoucherSeriesIODTO>();
            var accountYearId = AccountManager.GetAccountYearId(date, actorCompanyId);
            var voucherSeries = VoucherManager.GetVoucherSeriesByYear(accountYearId, actorCompanyId, false, false);


            foreach (var serie in voucherSeries)
            {
                VoucherSeriesDTO seriesDTO = serie.ToDTO();

                var seriesIODTO = new VoucherSeriesIODTO
                {
                    VoucherSeriesId = seriesDTO.VoucherSeriesId,
                    Name = seriesDTO.VoucherSeriesTypeName,
                    Nr = serie.VoucherSeriesType?.VoucherSeriesTypeNr ?? 0,
                    StartNumber = serie.VoucherSeriesType?.StartNr ?? 0,
                    VoucherNrLatest = seriesDTO.VoucherNrLatest ?? 0
                };

                voucherSeriesIODTO.Add(seriesIODTO);
            }

            return voucherSeriesIODTO;
        }

        public List<AccountYearIODTO> GetAccountYearIODTOs(int actorCompanyId)
        {
            List<AccountYearIODTO> accountYearIODTOs = new List<AccountYearIODTO>();
            var accountYears = AccountManager.GetAccountYears(actorCompanyId, false, true, false, true);

            foreach (var accountYear in accountYears)
            {
                var dto = accountYear.ToDTO();
                AccountYearIODTO ioDTO = new AccountYearIODTO();

                ioDTO.AccountYearId = dto.AccountYearId;
                ioDTO.Created = dto.Created;
                ioDTO.CreatedBy = dto.CreatedBy;
                ioDTO.From = dto.From;
                ioDTO.Modified = dto.Modified;
                ioDTO.Status = (int)dto.Status;
                ioDTO.To = dto.To;
                ioDTO.AccountPeriods = new List<AccountPeriodIODTO>();
                ioDTO.VoucherSeries = new List<VoucherSeriesIODTO>();

                foreach (var period in accountYear.AccountPeriod)
                {
                    AccountPeriodDTO periodDTO = period.ToDTO();
                    AccountPeriodIODTO periodIODTO = new AccountPeriodIODTO();

                    periodIODTO.AccountPeriodId = periodDTO.AccountPeriodId;
                    periodIODTO.Created = periodDTO.Created ?? CalendarUtility.DATETIME_DEFAULT;
                    periodIODTO.CreatedBy = periodDTO.CreatedBy;
                    periodIODTO.From = periodDTO.From;
                    periodIODTO.Modified = periodDTO.Modified ?? CalendarUtility.DATETIME_DEFAULT;
                    periodIODTO.ModifiedBy = periodDTO.ModifiedBy;
                    periodIODTO.PeriodNr = periodDTO.PeriodNr;
                    periodIODTO.Status = (int)periodDTO.Status;
                    periodIODTO.To = periodDTO.To;

                    ioDTO.AccountPeriods.Add(periodIODTO);
                }

                foreach (var serie in accountYear.VoucherSeries)
                {
                    VoucherSeriesDTO seriesDTO = serie.ToDTO();
                    VoucherSeriesIODTO seriesIODTO = new VoucherSeriesIODTO();

                    seriesIODTO.Nr = serie.VoucherSeriesType?.VoucherSeriesTypeNr ?? 0;
                    seriesIODTO.StartNumber = serie.VoucherSeriesType?.StartNr ?? 0;
                    seriesIODTO.VoucherSeriesId = seriesDTO.VoucherSeriesId;
                    seriesIODTO.Name = seriesDTO.VoucherSeriesTypeName;

                    ioDTO.VoucherSeries.Add(seriesIODTO);
                }

                accountYearIODTOs.Add(ioDTO);
            }

            return accountYearIODTOs;
        }

        public ActionResult ImportAccountYearBalanceIO(AccountYearBalanceIOItem accountYearBalanceIOItem, int actorCompanyId)
        {
            return ImportFromAccountYearBalanceIO(accountYearBalanceIOItem.accountYearBalanceIOs, actorCompanyId);
        }

        public ActionResult ImportFromAccountYearBalanceIO(List<AccountYearBalanceIODTO> accountYearBalanceIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            List<AccountDim> internalAccountDims = AccountManager.GetAccountDimInternalsByCompany(actorCompanyId, true);

            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

            foreach (var accountYearBalanceIO in accountYearBalanceIOs)
            {
                using (CompEntities entities = new CompEntities())
                {
                    AccountStd accountStd = AccountManager.GetAccountStdByNr(entities, accountYearBalanceIO.AccountNr, actorCompanyId);
                    AccountYear accountYear = AccountManager.GetAccountYear(entities, accountYearBalanceIO.AccountYearStartDate, actorCompanyId, false);

                    if (accountYear == null)
                        continue;

                    if (accountYear.From != accountYearBalanceIO.AccountYearStartDate)
                    {
                        List<AccountYear> accountYears = AccountManager.GetAccountYears(entities, actorCompanyId, false, false);
                        accountYear = accountYears.FirstOrDefault(a => a.From.Year == accountYearBalanceIO.AccountYearStartDate.Year);
                    }

                    if (accountYear == null)
                    {
                        result.StringValue = "No accountYear";
                        continue;
                    }

                    if (accountStd == null)
                    {
                        result.StringValue = "No accountStd";
                        continue;
                    }

                    AccountYearBalanceHead accountYearBalanceHead = new AccountYearBalanceHead();
                    accountYearBalanceHead.AccountStd = accountStd;
                    accountYearBalanceHead.Balance = accountYearBalanceIO.Balance;
                    accountYearBalanceHead.Quantity = accountYearBalanceIO.Quantity;

                    if (accountSiedim1 != null && accountYearBalanceIO.AccountNrSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 2:
                                accountYearBalanceIO.AccountDim2Nr = accountYearBalanceIO.AccountNrSieDim1;
                                break;
                            case 3:
                                accountYearBalanceIO.AccountDim3Nr = accountYearBalanceIO.AccountNrSieDim1;
                                break;
                            case 4:
                                accountYearBalanceIO.AccountDim4Nr = accountYearBalanceIO.AccountNrSieDim1;
                                break;
                            case 5:
                                accountYearBalanceIO.AccountDim5Nr = accountYearBalanceIO.AccountNrSieDim1;
                                break;
                            case 6:
                                accountYearBalanceIO.AccountDim6Nr = accountYearBalanceIO.AccountNrSieDim1;
                                break;
                        }
                    }
                    if (accountSiedim6 != null && accountYearBalanceIO.AccountNrSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 2:
                                accountYearBalanceIO.AccountDim2Nr = accountYearBalanceIO.AccountNrSieDim6;
                                break;
                            case 3:
                                accountYearBalanceIO.AccountDim3Nr = accountYearBalanceIO.AccountNrSieDim6;
                                break;
                            case 4:
                                accountYearBalanceIO.AccountDim4Nr = accountYearBalanceIO.AccountNrSieDim6;
                                break;
                            case 5:
                                accountYearBalanceIO.AccountDim5Nr = accountYearBalanceIO.AccountNrSieDim6;
                                break;
                            case 6:
                                accountYearBalanceIO.AccountDim6Nr = accountYearBalanceIO.AccountNrSieDim6;
                                break;
                        }
                    }

                    if (internalAccountDims.Any() && (accountYearBalanceIO.AccountDim2Nr != "" || accountYearBalanceIO.AccountDim3Nr != "" || accountYearBalanceIO.AccountDim4Nr != "" || accountYearBalanceIO.AccountDim5Nr != "" || accountYearBalanceIO.AccountDim6Nr != ""))
                    {
                        int accountDim = 2;

                        foreach (AccountDim accountInternalDim in internalAccountDims.OrderBy(d => d.AccountDimNr))
                        {

                            string internalAccountNr = string.Empty;
                            int accountDimNr = accountInternalDim.AccountDimNr;

                            if (accountDim == 2) internalAccountNr = accountYearBalanceIO.AccountDim2Nr;
                            if (accountDim == 3) internalAccountNr = accountYearBalanceIO.AccountDim3Nr;
                            if (accountDim == 4) internalAccountNr = accountYearBalanceIO.AccountDim4Nr;
                            if (accountDim == 5) internalAccountNr = accountYearBalanceIO.AccountDim5Nr;
                            if (accountDim == 6) internalAccountNr = accountYearBalanceIO.AccountDim6Nr;

                            accountDim++;

                            if (internalAccountNr == string.Empty)
                                continue;

                            Account account = AccountManager.GetAccountByDimNr(entities, internalAccountNr, accountDimNr, actorCompanyId, true, loadAccount: true);
                            if (account?.AccountInternal != null)
                                accountYearBalanceHead.AccountInternal.Add(account.AccountInternal);
                        }
                    }

                    AccountBalanceManager abm = new AccountBalanceManager(null, actorCompanyId);
                    ActionResult saveResult = abm.AddAccountYearBalanceHead(entities, accountYearBalanceHead, accountYear.AccountYearId, actorCompanyId, accountYearBalanceIO.AccountNr);

                    nbrOfSaved = saveResult.ObjectsAffected;
                }
            }

            result.IntegerValue = nbrOfSaved;

            return result;
        }

        #endregion

        #region AccountDistributionIO

        public ActionResult ImportAccountDistributionIO(AccountDistributionIOItem accountDistributionIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromAccountDistributionIO(accountDistributionIOItem.AccountDistributionHeads, actorCompanyId);
        }

        public ActionResult ImportAccountDistributionRowIO(AccountDistributionRowIOItem accountDistributionRowIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return new ActionResult();
        }

        public ActionResult ImportFromAccountDistributionIO(List<AccountDistributionHeadIODTO> accountDistributionHeadDTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            using (CompEntities entities = new CompEntities())
            {
                try
                {

                    List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId, true, false, true);
                    accountDims.AddRange(AccountManager.GetAccountDimsByCompany(actorCompanyId, false, true, true));
                    AccountDim AccountDimStd = AccountManager.GetAccountDimStd(actorCompanyId);
                    List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(actorCompanyId, false);
                    //Get AccountDims
                    var sieDim1 = 1;
                    var sieDim6 = 6;
                    var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
                    var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

                    foreach (AccountDistributionHeadIODTO accountDistributionHeadIODTO in accountDistributionHeadDTOs)
                    {
                        #region VoucherSeriesType

                        int? voucherSeriesTypeId = null;
                        int.TryParse(accountDistributionHeadIODTO.VoucherSeriesType, out int typeNr);
                        if (typeNr != 0 && voucherSeriesTypes.Any(v => v.VoucherSeriesTypeNr == typeNr))
                            voucherSeriesTypeId = voucherSeriesTypes.FirstOrDefault(v => v.VoucherSeriesTypeNr == typeNr)?.VoucherSeriesTypeId;

                        if (voucherSeriesTypeId == null && accountDistributionHeadIODTO.Type == (int)SoeAccountDistributionType.Period && voucherSeriesTypes.Any())
                            voucherSeriesTypeId = voucherSeriesTypes.FirstOrDefault()?.VoucherSeriesTypeId;

                        #endregion

                        #region AccountDims
                        if (accountSiedim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 1:
                                    accountDistributionHeadIODTO.Dim1Nr = accountDistributionHeadIODTO.DimSieDim1;
                                    break;
                                case 2:
                                    accountDistributionHeadIODTO.Dim2Nr = accountDistributionHeadIODTO.DimSieDim1;
                                    break;
                                case 3:
                                    accountDistributionHeadIODTO.Dim3Nr = accountDistributionHeadIODTO.DimSieDim1;
                                    break;
                                case 4:
                                    accountDistributionHeadIODTO.Dim4Nr = accountDistributionHeadIODTO.DimSieDim1;
                                    break;
                                case 5:
                                    accountDistributionHeadIODTO.Dim5Nr = accountDistributionHeadIODTO.DimSieDim1;
                                    break;
                                case 6:
                                    accountDistributionHeadIODTO.Dim6Nr = accountDistributionHeadIODTO.DimSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && accountDistributionHeadIODTO.DimExpressionSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 1:
                                    accountDistributionHeadIODTO.Dim1Expression = accountDistributionHeadIODTO.DimExpressionSieDim1;
                                    break;
                                case 2:
                                    accountDistributionHeadIODTO.Dim2Expression = accountDistributionHeadIODTO.DimExpressionSieDim1;
                                    break;
                                case 3:
                                    accountDistributionHeadIODTO.Dim3Expression = accountDistributionHeadIODTO.DimExpressionSieDim1;
                                    break;
                                case 4:
                                    accountDistributionHeadIODTO.Dim4Expression = accountDistributionHeadIODTO.DimExpressionSieDim1;
                                    break;
                                case 5:
                                    accountDistributionHeadIODTO.Dim5Expression = accountDistributionHeadIODTO.DimExpressionSieDim1;
                                    break;
                                case 6:
                                    accountDistributionHeadIODTO.Dim6Expression = accountDistributionHeadIODTO.DimExpressionSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 1:
                                    accountDistributionHeadIODTO.Dim1Nr = accountDistributionHeadIODTO.DimSieDim6;
                                    break;
                                case 2:
                                    accountDistributionHeadIODTO.Dim2Nr = accountDistributionHeadIODTO.DimSieDim6;
                                    break;
                                case 3:
                                    accountDistributionHeadIODTO.Dim3Nr = accountDistributionHeadIODTO.DimSieDim6;
                                    break;
                                case 4:
                                    accountDistributionHeadIODTO.Dim4Nr = accountDistributionHeadIODTO.DimSieDim6;
                                    break;
                                case 5:
                                    accountDistributionHeadIODTO.Dim5Nr = accountDistributionHeadIODTO.DimSieDim6;
                                    break;
                                case 6:
                                    accountDistributionHeadIODTO.Dim6Nr = accountDistributionHeadIODTO.DimSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && accountDistributionHeadIODTO.DimExpressionSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 1:
                                    accountDistributionHeadIODTO.Dim1Expression = accountDistributionHeadIODTO.DimExpressionSieDim6;
                                    break;
                                case 2:
                                    accountDistributionHeadIODTO.Dim2Expression = accountDistributionHeadIODTO.DimExpressionSieDim6;
                                    break;
                                case 3:
                                    accountDistributionHeadIODTO.Dim3Expression = accountDistributionHeadIODTO.DimExpressionSieDim6;
                                    break;
                                case 4:
                                    accountDistributionHeadIODTO.Dim4Expression = accountDistributionHeadIODTO.DimExpressionSieDim6;
                                    break;
                                case 5:
                                    accountDistributionHeadIODTO.Dim5Expression = accountDistributionHeadIODTO.DimExpressionSieDim6;
                                    break;
                                case 6:
                                    accountDistributionHeadIODTO.Dim6Expression = accountDistributionHeadIODTO.DimExpressionSieDim6;
                                    break;
                            }
                        }
                        int accountIdDim1 = 0;
                        int accountIdDim2 = 0;
                        int accountIdDim3 = 0;
                        int accountIdDim4 = 0;
                        int accountIdDim5 = 0;
                        int accountIdDim6 = 0;

                        int accountDimId1 = AccountDimStd.AccountDimId;
                        int accountDimId2 = 0;
                        int accountDimId3 = 0;
                        int accountDimId4 = 0;
                        int accountDimId5 = 0;
                        int accountDimId6 = 0;

                        int accountDimNr = 2;
                        foreach (var dim in accountDims.Where(d => d.AccountDimId != accountDimId1).OrderBy(d => d.AccountDimNr))
                        {
                            if (accountDimNr == 2)
                                accountDimId2 = dim.AccountDimId;

                            if (accountDimNr == 3)
                                accountDimId3 = dim.AccountDimId;

                            if (accountDimNr == 4)
                                accountDimId4 = dim.AccountDimId;

                            if (accountDimNr == 5)
                                accountDimId5 = dim.AccountDimId;

                            if (accountDimNr == 6)
                                accountDimId6 = dim.AccountDimId;

                            accountDimNr++;
                        }



                        accountDimNr = 1;

                        foreach (var accountDim in accountDims.OrderBy(a => a.AccountDimNr))
                        {
                            Account account = AccountManager.GetAccountByNr(accountDistributionHeadIODTO.Dim1Nr.ToString(), accountDim.AccountDimId, actorCompanyId, onlyActive: false);
                            if (account == null)
                                continue;

                            if (accountDistributionHeadIODTO.Dim1Nr != -1 && accountDimNr == 1)
                            {
                                accountIdDim1 = account.AccountId;
                            }

                            if (accountDistributionHeadIODTO.Dim2Nr != -1 && accountDimNr == 2)
                                accountIdDim2 = account.AccountId;

                            if (accountDistributionHeadIODTO.Dim3Nr != -1 && accountDimNr == 3)
                                accountIdDim3 = account.AccountId;

                            if (accountDistributionHeadIODTO.Dim4Nr != -1 && accountDimNr == 4)
                                accountIdDim4 = account.AccountId;

                            if (accountDistributionHeadIODTO.Dim5Nr != -1 && accountDimNr == 5)
                                accountIdDim5 = account.AccountId;

                            if (accountDistributionHeadIODTO.Dim6Nr != -1 && accountDimNr == 6)
                                accountIdDim6 = account.AccountId;

                            accountDimNr++;
                        }

                        #endregion

                        AccountDistributionHeadDTO headDTO = new AccountDistributionHeadDTO();

                        List<AccountDistributionRowDTO> rowDTOs = new List<AccountDistributionRowDTO>();

                        if (accountIdDim1 == 0)
                            accountIdDim1 = AccountDimStd.AccountDimId;

                        if (accountIdDim1 == 0)
                            continue;

                        headDTO.ActorCompanyId = actorCompanyId;
                        headDTO.Name = accountDistributionHeadIODTO.Name;
                        headDTO.Amount = accountDistributionHeadIODTO.Amount;
                        headDTO.AmountOperator = accountDistributionHeadIODTO.AmountOperator;
                        headDTO.Calculate = accountDistributionHeadIODTO.Calculate;
                        headDTO.CalculationType = accountDistributionHeadIODTO.CalculationType < 3 ? (TermGroup_AccountDistributionCalculationType)accountDistributionHeadIODTO.CalculationType : TermGroup_AccountDistributionCalculationType.Percent;
                        headDTO.DayNumber = accountDistributionHeadIODTO.DayNumber;
                        headDTO.Description = accountDistributionHeadIODTO.Description;
                        headDTO.Dim1Expression = accountDistributionHeadIODTO.Dim1Expression;
                        headDTO.Dim2Expression = accountDistributionHeadIODTO.Dim2Expression;
                        headDTO.Dim3Expression = accountDistributionHeadIODTO.Dim3Expression;
                        headDTO.Dim4Expression = accountDistributionHeadIODTO.Dim4Expression;
                        headDTO.Dim5Expression = accountDistributionHeadIODTO.Dim5Expression;
                        headDTO.Dim6Expression = accountDistributionHeadIODTO.Dim6Expression;
                        headDTO.Dim1Id = accountDimId1;
                        headDTO.Dim2Id = accountDimId2;
                        headDTO.Dim3Id = accountDimId3;
                        headDTO.Dim4Id = accountDimId4;
                        headDTO.Dim5Id = accountDimId5;
                        headDTO.Dim6Id = accountDimId6;
                        headDTO.KeepRow = accountDistributionHeadIODTO.KeepRow;
                        headDTO.StartDate = accountDistributionHeadIODTO.StartDate != CalendarUtility.DATETIME_DEFAULT ? accountDistributionHeadIODTO.StartDate : null;
                        headDTO.EndDate = accountDistributionHeadIODTO.EndDate != CalendarUtility.DATETIME_DEFAULT ? accountDistributionHeadIODTO.EndDate : null;
                        headDTO.TriggerType = (TermGroup_AccountDistributionTriggerType)accountDistributionHeadIODTO.TriggerType;
                        headDTO.Type = accountDistributionHeadIODTO.Type;
                        headDTO.UseInCustomerInvoice = accountDistributionHeadIODTO.UseInCustomerInvoice;
                        headDTO.UseInSupplierInvoice = accountDistributionHeadIODTO.UseInSupplierInvoice;
                        headDTO.UseInVoucher = accountDistributionHeadIODTO.UseInVoucher;
                        if (accountDistributionHeadIODTO.Dim1Nr != 0)
                            headDTO.PeriodType = (TermGroup_AccountDistributionPeriodType)accountDistributionHeadIODTO.PeriodType;
                        else
                        {
                            headDTO.PeriodType = TermGroup_AccountDistributionPeriodType.Amount;
                            headDTO.CalculationType = TermGroup_AccountDistributionCalculationType.TotalAmount;
                        }
                        headDTO.PeriodValue = accountDistributionHeadIODTO.PeriodValue;
                        headDTO.VoucherSeriesTypeId = voucherSeriesTypeId;


                        if (string.IsNullOrEmpty(headDTO.Dim1Expression) && accountDistributionHeadIODTO.Dim1Nr != 0)
                            headDTO.Dim1Expression = accountDistributionHeadIODTO.Dim1Nr.ToString();

                        if (string.IsNullOrEmpty(headDTO.Dim2Expression) && accountDistributionHeadIODTO.Dim2Nr != 0)
                            headDTO.Dim2Expression = accountDistributionHeadIODTO.Dim2Nr.ToString();

                        if (string.IsNullOrEmpty(headDTO.Dim3Expression) && accountDistributionHeadIODTO.Dim3Nr != 0)
                            headDTO.Dim3Expression = accountDistributionHeadIODTO.Dim3Nr.ToString();

                        if (string.IsNullOrEmpty(headDTO.Dim4Expression) && accountDistributionHeadIODTO.Dim4Nr != 0)
                            headDTO.Dim4Expression = accountDistributionHeadIODTO.Dim4Nr.ToString();

                        if (string.IsNullOrEmpty(headDTO.Dim5Expression) && accountDistributionHeadIODTO.Dim5Nr != 0)
                            headDTO.Dim5Expression = accountDistributionHeadIODTO.Dim5Nr.ToString();

                        if (string.IsNullOrEmpty(headDTO.Dim6Expression) && accountDistributionHeadIODTO.Dim6Nr != 0)
                            headDTO.Dim6Expression = accountDistributionHeadIODTO.Dim6Nr.ToString();

                        if (string.IsNullOrEmpty(headDTO.Name))
                            headDTO.Name = nbrOfSaved.ToString() + " " + headDTO.Dim1Expression;


                        foreach (var row in accountDistributionHeadIODTO.Rows)
                        {
                            AccountDistributionRowDTO rowDTO = new AccountDistributionRowDTO();
                            if (accountSiedim1 != null && row.DimSieDim1 != null)
                            {
                                switch (accountSiedim1.AccountDimNr)
                                {
                                    case 1:
                                        row.Dim1Nr = row.DimSieDim1.HasValue() ? row.DimSieDim1 : null;
                                        break;
                                    case 2:
                                        row.Dim2Nr = row.DimSieDim1.HasValue() ? row.DimSieDim1 : null;
                                        break;
                                    case 3:
                                        row.Dim3Nr = row.DimSieDim1.HasValue() ? row.DimSieDim1 : null;
                                        break;
                                    case 4:
                                        row.Dim4Nr = row.DimSieDim1.HasValue() ? row.DimSieDim1 : null;
                                        break;
                                    case 5:
                                        row.Dim5Nr = row.DimSieDim1.HasValue() ? row.DimSieDim1 : null;
                                        break;
                                    case 6:
                                        row.Dim6Nr = row.DimSieDim1.HasValue() ? row.DimSieDim1 : null;
                                        break;
                                }
                            }
                            if (accountSiedim1 != null && row.DimNameSieDim1 != null)
                            {
                                switch (accountSiedim1.AccountDimNr)
                                {
                                    case 1:
                                        row.Dim1Name = row.DimNameSieDim1.HasValue() ? row.DimNameSieDim1 : null;
                                        break;
                                    case 2:
                                        row.Dim2Name = row.DimNameSieDim1.HasValue() ? row.DimNameSieDim1 : null;
                                        break;
                                    case 3:
                                        row.Dim3Name = row.DimNameSieDim1.HasValue() ? row.DimNameSieDim1 : null;
                                        break;
                                    case 4:
                                        row.Dim4Name = row.DimNameSieDim1.HasValue() ? row.DimNameSieDim1 : null;
                                        break;
                                    case 5:
                                        row.Dim5Name = row.DimNameSieDim1.HasValue() ? row.DimNameSieDim1 : null;
                                        break;
                                    case 6:
                                        row.Dim6Name = row.DimNameSieDim1.HasValue() ? row.DimNameSieDim1 : null;
                                        break;
                                }
                            }
                            if (accountSiedim1 != null)
                            {
                                switch (accountSiedim1.AccountDimNr)
                                {
                                    case 1:
                                        row.Dim1Mandatory = row.DimMandatorySieDim1;
                                        row.Dim1Disabled = row.DimDisabledSieDim1;
                                        break;
                                    case 2:
                                        row.Dim2Mandatory = row.DimMandatorySieDim1;
                                        row.Dim2Disabled = row.DimDisabledSieDim1;
                                        row.Dim2KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim1;
                                        break;
                                    case 3:
                                        row.Dim3Mandatory = row.DimMandatorySieDim1;
                                        row.Dim3Disabled = row.DimDisabledSieDim1;
                                        row.Dim3KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim1;
                                        break;
                                    case 4:
                                        row.Dim4Mandatory = row.DimMandatorySieDim1;
                                        row.Dim4Disabled = row.DimDisabledSieDim1;
                                        row.Dim4KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim1;
                                        break;
                                    case 5:
                                        row.Dim5Mandatory = row.DimMandatorySieDim1;
                                        row.Dim5Disabled = row.DimDisabledSieDim1;
                                        row.Dim5KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim1;
                                        break;
                                    case 6:
                                        row.Dim6Mandatory = row.DimMandatorySieDim1;
                                        row.Dim6Disabled = row.DimDisabledSieDim1;
                                        row.Dim6KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim1;
                                        break;
                                }
                            }
                            if (accountSiedim6 != null && row.DimSieDim6 != null)
                            {
                                switch (accountSiedim6.AccountDimNr)
                                {
                                    case 1:
                                        row.Dim1Nr = row.DimSieDim6.HasValue() ? row.DimSieDim6 : null;
                                        break;
                                    case 2:
                                        row.Dim2Nr = row.DimSieDim6.HasValue() ? row.DimSieDim6 : null;
                                        break;
                                    case 3:
                                        row.Dim3Nr = row.DimSieDim6.HasValue() ? row.DimSieDim6 : null;
                                        break;
                                    case 4:
                                        row.Dim4Nr = row.DimSieDim6.HasValue() ? row.DimSieDim6 : null;
                                        break;
                                    case 5:
                                        row.Dim5Nr = row.DimSieDim6.HasValue() ? row.DimSieDim6 : null;
                                        break;
                                    case 6:
                                        row.Dim6Nr = row.DimSieDim6.HasValue() ? row.DimSieDim6 : null;
                                        break;
                                }
                            }
                            if (accountSiedim6 != null && row.DimNameSieDim6 != null)
                            {
                                switch (accountSiedim6.AccountDimNr)
                                {
                                    case 1:
                                        row.Dim1Name = row.DimNameSieDim6.HasValue() ? row.DimNameSieDim6 : null;
                                        break;
                                    case 2:
                                        row.Dim2Name = row.DimNameSieDim6.HasValue() ? row.DimNameSieDim6 : null;
                                        break;
                                    case 3:
                                        row.Dim3Name = row.DimNameSieDim6.HasValue() ? row.DimNameSieDim6 : null;
                                        break;
                                    case 4:
                                        row.Dim4Name = row.DimNameSieDim6.HasValue() ? row.DimNameSieDim6 : null;
                                        break;
                                    case 5:
                                        row.Dim5Name = row.DimNameSieDim6.HasValue() ? row.DimNameSieDim6 : null;
                                        break;
                                    case 6:
                                        row.Dim6Name = row.DimNameSieDim6.HasValue() ? row.DimNameSieDim6 : null;
                                        break;
                                }
                            }
                            if (accountSiedim6 != null)
                            {
                                switch (accountSiedim6.AccountDimNr)
                                {
                                    case 1:
                                        row.Dim1Mandatory = row.DimMandatorySieDim6;
                                        row.Dim1Disabled = row.DimDisabledSieDim6;
                                        break;
                                    case 2:
                                        row.Dim2Mandatory = row.DimMandatorySieDim6;
                                        row.Dim2Disabled = row.DimDisabledSieDim6;
                                        row.Dim2KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim6;
                                        break;
                                    case 3:
                                        row.Dim3Mandatory = row.DimMandatorySieDim6;
                                        row.Dim3Disabled = row.DimDisabledSieDim6;
                                        row.Dim3KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim6;
                                        break;
                                    case 4:
                                        row.Dim4Mandatory = row.DimMandatorySieDim6;
                                        row.Dim4Disabled = row.DimDisabledSieDim6;
                                        row.Dim4KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim6;
                                        break;
                                    case 5:
                                        row.Dim5Mandatory = row.DimMandatorySieDim6;
                                        row.Dim5Disabled = row.DimDisabledSieDim6;
                                        row.Dim5KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim6;
                                        break;
                                    case 6:
                                        row.Dim6Mandatory = row.DimMandatorySieDim6;
                                        row.Dim6Disabled = row.DimDisabledSieDim6;
                                        row.Dim6KeepSourceRowAccount = row.DimKeepSourceRowAccountSieDim6;
                                        break;
                                }
                            }
                            accountDimNr = 1;

                            foreach (var accountDim in accountDims.OrderBy(a => a.AccountDimNr))
                            {
                                string dimNr = "";
                                switch (accountDimNr)
                                {
                                    case 1:
                                        dimNr = row.Dim1Nr;
                                        break;
                                    case 2:
                                        dimNr = row.Dim2Nr;
                                        break;
                                    case 3:
                                        dimNr = row.Dim3Nr;
                                        break;
                                    case 4:
                                        dimNr = row.Dim4Nr;
                                        break;
                                    case 5:
                                        dimNr = row.Dim5Nr;
                                        break;
                                    case 6:
                                        dimNr = row.Dim6Nr;
                                        break;
                                    default:
                                        throw new Exception("Unknown dim number");
                                }

                                Account account = AccountManager.GetAccountByNr(dimNr, accountDim.AccountDimId, actorCompanyId, onlyActive: false);
                                if (account == null)
                                    continue;

                                if (row.Dim1Nr != string.Empty && accountDimNr == 1)
                                    accountIdDim1 = account.AccountId;

                                if (row.Dim2Nr != string.Empty && accountDimNr == 2)
                                    accountIdDim2 = account.AccountId;

                                if (row.Dim3Nr != string.Empty && accountDimNr == 3)
                                    accountIdDim3 = account.AccountId;

                                if (row.Dim4Nr != string.Empty && accountDimNr == 4)
                                    accountIdDim4 = account.AccountId;

                                if (row.Dim5Nr != string.Empty && accountDimNr == 5)
                                    accountIdDim5 = account.AccountId;

                                if (row.Dim6Nr != string.Empty && accountDimNr == 6)
                                    accountIdDim6 = account.AccountId;

                                accountDimNr++;
                            }

                            rowDTO.Description = row.Description;
                            rowDTO.SameBalance = row.SameBalance;
                            rowDTO.OppositeBalance = row.OppositeBalance;
                            rowDTO.RowNbr = row.RowNbr;
                            rowDTO.PreviousRowNbr = row.PreviousRowNbr;
                            rowDTO.Dim1Nr = row.Dim1Nr;
                            rowDTO.Dim2Nr = row.Dim2Nr;
                            rowDTO.Dim3Nr = row.Dim3Nr;
                            rowDTO.Dim4Nr = row.Dim4Nr;
                            rowDTO.Dim5Nr = row.Dim5Nr;
                            rowDTO.Dim6Nr = row.Dim6Nr;
                            rowDTO.Dim1Id = accountIdDim1;
                            rowDTO.Dim2Id = accountIdDim2;
                            rowDTO.Dim3Id = accountIdDim3;
                            rowDTO.Dim4Id = accountIdDim4;
                            rowDTO.Dim5Id = accountIdDim5;
                            rowDTO.Dim6Id = accountIdDim6;
                            rowDTO.Dim1Name = row.Dim1Name;
                            rowDTO.Dim2Name = row.Dim2Name;
                            rowDTO.Dim3Name = row.Dim3Name;
                            rowDTO.Dim4Name = row.Dim4Name;
                            rowDTO.Dim5Name = row.Dim5Name;
                            rowDTO.Dim6Name = row.Dim6Name;
                            rowDTO.Dim1Disabled = row.Dim1Disabled;
                            rowDTO.Dim2Disabled = row.Dim2Disabled;
                            rowDTO.Dim3Disabled = row.Dim3Disabled;
                            rowDTO.Dim4Disabled = row.Dim4Disabled;
                            rowDTO.Dim5Disabled = row.Dim5Disabled;
                            rowDTO.Dim6Disabled = row.Dim6Disabled;
                            rowDTO.Dim1Mandatory = row.Dim1Mandatory;
                            rowDTO.Dim2Mandatory = row.Dim2Mandatory;
                            rowDTO.Dim3Mandatory = row.Dim3Mandatory;
                            rowDTO.Dim4Mandatory = row.Dim4Mandatory;
                            rowDTO.Dim5Mandatory = row.Dim5Mandatory;
                            rowDTO.Dim6Mandatory = row.Dim6Mandatory;
                            if (row.Dim2Nr == "*")
                                rowDTO.Dim2KeepSourceRowAccount = true;
                            if (row.Dim3Nr == "*")
                                rowDTO.Dim3KeepSourceRowAccount = true;
                            if (row.Dim4Nr == "*")
                                rowDTO.Dim4KeepSourceRowAccount = true;
                            if (row.Dim5Nr == "*")
                                rowDTO.Dim5KeepSourceRowAccount = true;
                            if (row.Dim6Nr == "*")
                                rowDTO.Dim6KeepSourceRowAccount = true;

                            rowDTOs.Add(rowDTO);

                            accountIdDim1 = 0;
                            accountIdDim2 = 0;
                            accountIdDim3 = 0;
                            accountIdDim4 = 0;
                            accountIdDim5 = 0;
                            accountIdDim6 = 0;

                        }

                        headDTO.Rows = new List<AccountDistributionRowDTO>();
                        headDTO.Rows.AddRange(rowDTOs);

                        ActionResult saveResult = AccountDistributionManager.SaveAccountDistribution(headDTO, rowDTOs, actorCompanyId);
                        nbrOfSaved += saveResult.ObjectsAffected;
                    }
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            result.IntegerValue = nbrOfSaved;

            return result;
        }

        #endregion

        #region BudgetIO

        public ActionResult ImportBudgetIO(BudgetIOItem budgetIOItem, int actorCompanyId)
        {
            return ImportFromBudgetIO(budgetIOItem.budgetIOs, actorCompanyId);
        }


        public ActionResult ImportFromBudgetIO(List<BudgetHeadIODTO> budgetIODTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int NumberOfSavedBudgets = 0;

            #region Prereq

            List<ShiftType> shiftTypes = TimeScheduleManager.GetShiftTypes(actorCompanyId);
            List<Account> accounts = AccountManager.GetAccountsStdsByCompany(actorCompanyId);
            List<DistributionCodeHead> codes = BudgetManager.GetDistributionCodes(actorCompanyId, false);
            List<AccountDim> dims = AccountManager.GetAccountDimInternalsByCompany(actorCompanyId);

            #endregion

            #region Convert and save as BudgetDTOs

            #region Budgets except Sales Budget

            foreach (BudgetHeadIODTO budgetHead in budgetIODTOs.Where(w => w.Type != (int)DistributionCodeBudgetType.SalesBudget))
            {
                #region Prereq

                if (budgetHead.AccountYearStartDate == CalendarUtility.DATETIME_DEFAULT)
                    continue;

                AccountYear accountYear = AccountManager.GetAccountYear(budgetHead.AccountYearStartDate, actorCompanyId, false);
                if (accountYear == null)
                    continue;

                //Distribution Code
                int distributionCodeHeadId = 0;
                if (!string.IsNullOrEmpty(budgetHead.DistributionCodeHeadName))
                    distributionCodeHeadId = codes.FirstOrDefault(c => c.Name.ToLower() == budgetHead.DistributionCodeHeadName.ToLower())?.DistributionCodeHeadId ?? 0;

                //Internal AccountDimensions
                List<AccountInternal> accountsDim2 = new List<AccountInternal>();
                List<AccountInternal> accountsDim3 = new List<AccountInternal>();
                List<AccountInternal> accountsDim4 = new List<AccountInternal>();
                List<AccountInternal> accountsDim5 = new List<AccountInternal>();
                List<AccountInternal> accountsDim6 = new List<AccountInternal>();

                int dim2 = 0;
                int dim3 = 0;
                int dimCounter = 2;

                foreach (var dim in dims.OrderBy(d => d.AccountDimNr))
                {
                    if (dimCounter == 2)
                    {
                        accountsDim2 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                        dim2 = dim.AccountDimId;
                    }
                    if (dimCounter == 3)
                    {
                        accountsDim3 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                        dim3 = dim.AccountDimId;
                    }
                    if (dimCounter == 4)
                    {
                        accountsDim4 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                    }
                    if (dimCounter == 5)
                    {
                        accountsDim5 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                    }
                    if (dimCounter == 6)
                    {
                        accountsDim6 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                    }
                    dimCounter++;
                }

                //Get AccountDims
                var sieDim1 = 1;
                var sieDim6 = 6;
                var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
                var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

                #endregion

                #region BudgetHeadDTO

                var headDTO = new BudgetHeadDTO
                {
                    AccountYearId = accountYear.AccountYearId,
                    ActorCompanyId = actorCompanyId,
                    Dim2Id = dim2,
                    Dim3Id = dim3,
                    DistributionCodeHeadId = distributionCodeHeadId,
                    Name = string.IsNullOrEmpty(budgetHead.Name) ? accountYear.From.Year.ToString() : budgetHead.Name,
                    NoOfPeriods = budgetHead.NoOfPeriods != 0 ? budgetHead.NoOfPeriods : 12,
                    Type = (int)DistributionCodeBudgetType.AccountingBudget,
                    Status = (int)BudgetHeadStatus.Active
                };

                #endregion

                #region BudgetRowDTO

                foreach (var row in budgetHead.Rows)
                {
                    BudgetRowDTO rowDTO = new BudgetRowDTO();
                    rowDTO.TotalQuantity = row.TotalQuantity;
                    rowDTO.TotalAmount = row.TotalAmount;
                    rowDTO.DistributionCodeHeadId = codes.FirstOrDefault(c => c.Name.ToLower() == row.DistributionCodeHeadName.ToLower())?.DistributionCodeHeadId ?? 0;
                    rowDTO.AccountId = accounts.FirstOrDefault(a => a.AccountNr == row.AccountNr)?.AccountId ?? 0;
                    rowDTO.Dim1Id = accounts.FirstOrDefault(a => a.AccountNr == row.AccountNr)?.AccountId ?? 0;
                    rowDTO.Dim2Id = accountsDim2.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm2Nr)?.AccountId ?? 0;
                    rowDTO.Dim3Id = accountsDim3.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm3Nr)?.AccountId ?? 0;
                    rowDTO.Dim4Id = accountsDim4.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm4Nr)?.AccountId ?? 0;
                    rowDTO.Dim5Id = accountsDim5.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm5Nr)?.AccountId ?? 0;
                    rowDTO.Dim6Id = accountsDim6.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm6Nr)?.AccountId ?? 0;

                    if (accountSiedim1 != null && row.AccountSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 2:
                                rowDTO.Dim2Id = accountsDim2.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim1)?.AccountId ?? 0;
                                rowDTO.Dim2Nr = row.AccountSieDim1;
                                break;
                            case 3:
                                rowDTO.Dim3Id = accountsDim3.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim1)?.AccountId ?? 0;
                                rowDTO.Dim3Nr = row.AccountSieDim1;
                                break;
                            case 4:
                                rowDTO.Dim4Id = accountsDim4.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim1)?.AccountId ?? 0;
                                rowDTO.Dim4Nr = row.AccountSieDim1;
                                break;
                            case 5:
                                rowDTO.Dim5Id = accountsDim5.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim1)?.AccountId ?? 0;
                                rowDTO.Dim5Nr = row.AccountSieDim1;
                                break;
                            case 6:
                                rowDTO.Dim6Id = accountsDim6.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim1)?.AccountId ?? 0;
                                rowDTO.Dim6Nr = row.AccountSieDim1;
                                break;
                        }
                    }
                    if (accountSiedim6 != null && row.AccountSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 2:
                                rowDTO.Dim2Id = accountsDim2.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim6)?.AccountId ?? 0;
                                rowDTO.Dim2Nr = row.AccountSieDim6;
                                break;
                            case 3:
                                rowDTO.Dim3Id = accountsDim3.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim6)?.AccountId ?? 0;
                                rowDTO.Dim3Nr = row.AccountSieDim6;
                                break;
                            case 4:
                                rowDTO.Dim4Id = accountsDim4.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim6)?.AccountId ?? 0;
                                rowDTO.Dim4Nr = row.AccountSieDim6;
                                break;
                            case 5:
                                rowDTO.Dim5Id = accountsDim5.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim6)?.AccountId ?? 0;
                                rowDTO.Dim5Nr = row.AccountSieDim6;
                                break;
                            case 6:
                                rowDTO.Dim6Id = accountsDim6.FirstOrDefault(a => a.Account.AccountNr == row.AccountSieDim6)?.AccountId ?? 0;
                                rowDTO.Dim6Nr = row.AccountSieDim6;
                                break;
                        }
                    }

                    #region BudgetPeriodDTO

                    List<BudgetPeriodDTO> periods = new List<BudgetPeriodDTO>();

                    for (var i = 1; i < headDTO.NoOfPeriods + 1; i++)
                    {
                        if (i == 1) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = i; period.Quantity = row.Period1Quantity; period.Amount = row.Period1Amount; periods.Add(period); }
                        if (i == 2) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 2; period.Quantity = row.Period2Quantity; period.Amount = row.Period2Amount; periods.Add(period); }
                        if (i == 3) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 3; period.Quantity = row.Period3Quantity; period.Amount = row.Period3Amount; periods.Add(period); }
                        if (i == 4) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 4; period.Quantity = row.Period4Quantity; period.Amount = row.Period4Amount; periods.Add(period); }
                        if (i == 5) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 5; period.Quantity = row.Period5Quantity; period.Amount = row.Period5Amount; periods.Add(period); }
                        if (i == 6) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 6; period.Quantity = row.Period6Quantity; period.Amount = row.Period6Amount; periods.Add(period); }
                        if (i == 7) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 7; period.Quantity = row.Period7Quantity; period.Amount = row.Period7Amount; periods.Add(period); }
                        if (i == 8) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 8; period.Quantity = row.Period8Quantity; period.Amount = row.Period8Amount; periods.Add(period); }
                        if (i == 9) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 9; period.Quantity = row.Period9Quantity; period.Amount = row.Period9Amount; periods.Add(period); }
                        if (i == 10) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 10; period.Quantity = row.Period10Quantity; period.Amount = row.Period10Amount; periods.Add(period); }
                        if (i == 11) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 11; period.Quantity = row.Period11Quantity; period.Amount = row.Period11Amount; periods.Add(period); }
                        if (i == 12) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 12; period.Quantity = row.Period12Quantity; period.Amount = row.Period12Amount; periods.Add(period); }
                        if (i == 13) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 13; period.Quantity = row.Period13Quantity; period.Amount = row.Period13Amount; periods.Add(period); }
                        if (i == 14) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 14; period.Quantity = row.Period14Quantity; period.Amount = row.Period14Amount; periods.Add(period); }
                        if (i == 15) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 15; period.Quantity = row.Period15Quantity; period.Amount = row.Period15Amount; periods.Add(period); }
                        if (i == 16) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 16; period.Quantity = row.Period16Quantity; period.Amount = row.Period16Amount; periods.Add(period); }
                        if (i == 17) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 17; period.Quantity = row.Period17Quantity; period.Amount = row.Period17Amount; periods.Add(period); }
                        if (i == 18) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 18; period.Quantity = row.Period18Quantity; period.Amount = row.Period18Amount; periods.Add(period); }
                        if (i == 19) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 19; period.Quantity = row.Period19Quantity; period.Amount = row.Period19Amount; periods.Add(period); }
                        if (i == 20) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 20; period.Quantity = row.Period20Quantity; period.Amount = row.Period20Amount; periods.Add(period); }
                        if (i == 21) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 21; period.Quantity = row.Period21Quantity; period.Amount = row.Period21Amount; periods.Add(period); }
                        if (i == 22) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 22; period.Quantity = row.Period22Quantity; period.Amount = row.Period22Amount; periods.Add(period); }
                        if (i == 23) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 23; period.Quantity = row.Period23Quantity; period.Amount = row.Period23Amount; periods.Add(period); }
                        if (i == 24) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 24; period.Quantity = row.Period24Quantity; period.Amount = row.Period24Amount; periods.Add(period); }
                    }
                    if (rowDTO.Periods == null)
                        rowDTO.Periods = new List<BudgetPeriodDTO>();
                    rowDTO.Periods.AddRange(periods);

                    if (headDTO.Rows == null)
                        headDTO.Rows = new List<BudgetRowDTO>();
                    headDTO.Rows.Add(rowDTO);

                    #endregion

                }

                if (headDTO.Rows.Any(r => r.Dim2Id > 0))
                    headDTO.UseDim2 = true;

                if (headDTO.Rows.Any(r => r.Dim3Id > 0))
                    headDTO.UseDim3 = true;

                #endregion

                #region Save

                using (CompEntities entities = new CompEntities())
                {
                    result = BudgetManager.SaveBudgetHead(entities, headDTO);
                }

                if (result.Success)
                    NumberOfSavedBudgets++;
                else
                    return result;

                #endregion
            }

            #endregion

            #region Sales budget

            foreach (var budgetHead in budgetIODTOs.Where(w => w.Type == (int)DistributionCodeBudgetType.SalesBudgetTime))
            {
                #region Convert to salesbudgetDTO

                //Distribution Code
                int distributionCodeHeadId = 0;
                if (!string.IsNullOrEmpty(budgetHead.DistributionCodeHeadName))
                    distributionCodeHeadId = codes.FirstOrDefault(c => c.Name.ToLower() == budgetHead.DistributionCodeHeadName.ToLower())?.DistributionCodeHeadId ?? 0;

                //Internal AccountDimensions
                List<AccountInternal> accountsDim2 = new List<AccountInternal>();
                List<AccountInternal> accountsDim3 = new List<AccountInternal>();
                List<AccountInternal> accountsDim4 = new List<AccountInternal>();
                List<AccountInternal> accountsDim5 = new List<AccountInternal>();
                List<AccountInternal> accountsDim6 = new List<AccountInternal>();

                int dim2 = 0;
                int dim3 = 0;
                int dimCounter = 2;

                foreach (var dim in dims.OrderBy(d => d.AccountDimNr))
                {
                    if (dimCounter == 2)
                    {
                        accountsDim2 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                        dim2 = dim.AccountDimId;
                    }
                    if (dimCounter == 3)
                    {
                        accountsDim3 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                        dim3 = dim.AccountDimId;
                    }
                    if (dimCounter == 4)
                    {
                        accountsDim4 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                    }
                    if (dimCounter == 5)
                    {
                        accountsDim5 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                    }
                    if (dimCounter == 6)
                    {
                        accountsDim6 = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, null);
                    }

                    dimCounter++;
                }

                #endregion

                #region BudgetHeadDTO

                BudgetHeadDTO headDTO = new BudgetHeadDTO();
                headDTO.ActorCompanyId = actorCompanyId;
                headDTO.Dim2Id = dim2;
                headDTO.Dim3Id = dim3;
                headDTO.DistributionCodeHeadId = distributionCodeHeadId;
                headDTO.Name = string.IsNullOrEmpty(budgetHead.Name) ? DateTime.Now.Year.ToString() : budgetHead.Name;
                headDTO.NoOfPeriods = budgetHead.NoOfPeriods != 0 ? budgetHead.NoOfPeriods : 12;
                headDTO.Type = (int)DistributionCodeBudgetType.SalesBudgetTime;
                headDTO.Status = (int)BudgetHeadStatus.Active;

                #endregion

                #region BudgetRowDTO

                foreach (var row in budgetHead.Rows)
                {
                    BudgetRowDTO rowDTO = new BudgetRowDTO();
                    rowDTO.AccountId = accounts.FirstOrDefault(a => a.AccountNr == row.AccountNr)?.AccountId ?? 0;
                    rowDTO.TotalAmount = row.TotalAmount;
                    rowDTO.TotalQuantity = row.TotalQuantity;
                    rowDTO.Dim1Id = accounts.FirstOrDefault(a => a.AccountNr == row.AccountNr)?.AccountId ?? 0;
                    rowDTO.Dim2Id = accountsDim2.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm2Nr)?.AccountId ?? 0;
                    rowDTO.Dim3Id = accountsDim3.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm3Nr)?.AccountId ?? 0;
                    rowDTO.Dim4Id = accountsDim4.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm4Nr)?.AccountId ?? 0;
                    rowDTO.Dim5Id = accountsDim5.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm5Nr)?.AccountId ?? 0;
                    rowDTO.Dim6Id = accountsDim6.FirstOrDefault(a => a.Account.AccountNr == row.AccountDIm6Nr)?.AccountId ?? 0;

                    if (row.ShiftTypeCode.HasValue())
                        rowDTO.ShiftTypeId = shiftTypes?.FirstOrDefault(s => s.Name == row.ShiftTypeCode)?.ShiftTypeId ?? 0;

                    #region BudgetPeriodDTO

                    //comes in weeks
                    List<BudgetPeriodDTO> periods = new List<BudgetPeriodDTO>();

                    if (row.Period1Amount != 0 || row.Period1Quantity != 0) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 1; period.Quantity = row.Period1Quantity; period.Amount = row.Period1Amount; periods.Add(period); }
                    if (row.Period2Amount != 0 || row.Period2Quantity != 0) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 2; period.Quantity = row.Period2Quantity; period.Amount = row.Period2Amount; periods.Add(period); }
                    if (row.Period3Amount != 0 || row.Period3Quantity != 0) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 3; period.Quantity = row.Period3Quantity; period.Amount = row.Period3Amount; periods.Add(period); }
                    if (row.Period4Amount != 0 || row.Period4Quantity != 0) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 4; period.Quantity = row.Period4Quantity; period.Amount = row.Period4Amount; periods.Add(period); }
                    if (row.Period5Amount != 0 || row.Period4Quantity != 0) { BudgetPeriodDTO period = new BudgetPeriodDTO(); period.PeriodNr = 4; period.Quantity = row.Period4Quantity; period.Amount = row.Period4Amount; periods.Add(period); }

                    if (rowDTO.Periods == null)
                        rowDTO.Periods = new List<BudgetPeriodDTO>();
                    rowDTO.Periods.AddRange(periods);

                    if (headDTO.Rows == null)
                        headDTO.Rows = new List<BudgetRowDTO>();
                    headDTO.Rows.Add(rowDTO);

                    #endregion
                }

                #endregion

                #region Save

                using (CompEntities entities = new CompEntities())
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        result = BudgetManager.SaveSalesBudgetHead(transaction, entities, headDTO, true);
                    }
                }

                if (result.Success)
                    NumberOfSavedBudgets++;
                else
                    return result;

                #endregion
            }

            #endregion

            #endregion

            result.IntegerValue = NumberOfSavedBudgets;

            return result;
        }

        #endregion

        #region EmployeeInformation

        public List<EmployeeInformation> GetEmployeeInformations(int actorCompanyId, FetchEmployeeInformation fetchEmployeeInformation)
        {
            try
            {
                var employeeInformations = new List<EmployeeInformation>();

                if (!FeatureManager.HasRolePermission(Feature.Time_Employee_Employees_Edit, Permission.Readonly, parameterObject.RoleId, actorCompanyId))
                    return employeeInformations;

                #region Init

                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                bool HasPermission(Feature feature) => FeatureManager.HasRolePermission(feature, Permission.Readonly, parameterObject.RoleId, actorCompanyId);
                var loadContact = fetchEmployeeInformation.LoadContactInformation;
                var loadEmployment = fetchEmployeeInformation.LoadEmployments && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Employments);
                var loadEmploymentChanges = fetchEmployeeInformation.LoadEmploymentChanges;
                var loadCalenderDayInfo = fetchEmployeeInformation.LoadCalenderInfo;
                var onePerChangeCalenderDayInfo = fetchEmployeeInformation.OnePerChangeCalenderDayInfo;
                var loadVacationInfo = fetchEmployeeInformation.LoadVacationInfo && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_AbsenceVacation_Vacation);
                var loadVacationInfoHistory = fetchEmployeeInformation.LoadVacationInfoHistory && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_AbsenceVacation_Vacation);
                var loadHierarchy = fetchEmployeeInformation.LoadHierarchyAccounts;
                var addVirtualAccounts = fetchEmployeeInformation.AddVirtualHierarchyAccounts;
                var loadPositions = fetchEmployeeInformation.LoadPositions;
                var loadReportSettings = fetchEmployeeInformation.LoadReportSettings && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Reports);
                var loadExtraFields = fetchEmployeeInformation.LoadExtraFields && HasPermission(Feature.Time_Employee_Employees_Edit);
                var loadUser = fetchEmployeeInformation.LoadUser;
                var loadUserRoles = fetchEmployeeInformation.LoadUserRoles;
                var loadSocialSecurity = fetchEmployeeInformation.LoadSocialSec;
                var showSocialSec = loadSocialSecurity && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_SocialSec);
                var loadEmploymentAccounts = fetchEmployeeInformation.LoadEmploymentAccounts;
                var loadSkills = fetchEmployeeInformation.LoadSkills && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Skills);
                var loadExecutives = fetchEmployeeInformation.LoadExecutives;
                var loadNearestExecutive = fetchEmployeeInformation.LoadNearestExecutive;
                var loadPayrollInformation = fetchEmployeeInformation.LoadPayrollInformation && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Employments_Payroll_Salary_IncludeAllPeriods);
                var loadPayrollFormulaResult = fetchEmployeeInformation.LoadPayrollFormulaResult && HasPermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Employments_Payroll_Salary_IncludeAllPeriods);

                #endregion

                #region Load Employees

                var employeeNumbers = fetchEmployeeInformation.EmployeeNrs ?? new List<string>();
                if (!employeeNumbers.IsNullOrEmpty())
                {
                    employeeNumbers = employeeNumbers.Trim();
                    employeeNumbers = employeeNumbers.Where(w => !string.IsNullOrEmpty(w)).ToList();
                }

                var employeeExternalCodes = fetchEmployeeInformation.EmployeeExternalCodes;
                if (!employeeExternalCodes.IsNullOrEmpty())
                {
                    employeeExternalCodes = employeeExternalCodes.Trim();
                    employeeExternalCodes = employeeExternalCodes.Where(w => !string.IsNullOrEmpty(w)).ToList();
                }

                bool loadAllEmployees = employeeNumbers.IsNullOrEmpty() && employeeExternalCodes.IsNullOrEmpty();

                if (!employeeExternalCodes.IsNullOrEmpty())
                {
                    employeeNumbers.AddRange(EmployeeManager

                        .GetAllEmployeesByExternalCodes(entitiesReadOnly, actorCompanyId, employeeExternalCodes)
                        .Select(s => s.EmployeeNr)
                        .ToList());
                }

                var employeeIds = !employeeNumbers.IsNullOrEmpty() ? EmployeeManager.GetAllEmployeeIdsByEmployeeNr(actorCompanyId, employeeNumbers) : null;
                var employees = !employeeIds.IsNullOrEmpty() ?
                    entitiesReadOnly.Employee.Where(w => employeeIds.Contains(w.EmployeeId)).ToList() :
                    entitiesReadOnly.Employee.Where(w => w.ActorCompanyId == actorCompanyId).ToList();

                if (fetchEmployeeInformation.EmployeesChangedOrAddedAfterUtc.HasValue)
                {
                    var localTime = fetchEmployeeInformation.EmployeesChangedOrAddedAfterUtc.Value.ToLocalTime();
                    employees = employees.Where(w => (w.Created.HasValue && w.Created > localTime) || (w.Modified.HasValue && w.Modified.Value > localTime)).ToList();
                }

                if (!loadAllEmployees && employeeNumbers != null && employeeNumbers.Any())
                    employees = employees.Where(e => employeeNumbers.Contains(e.EmployeeNr)).ToList();

                employeeIds = employees.GetIds();
                employees = EmployeeManager.GetEmployeesForUsersAttestRoles(
                    out _,
                    actorCompanyId,
                    parameterObject.UserId,
                    parameterObject.RoleId,
                    fetchEmployeeInformation.DateFrom,
                    fetchEmployeeInformation.DateTo,
                    employeeFilter: employeeIds,
                    active: true,
                    addContactInfo: loadContact,
                    loadEmployment: true,
                    loadEmploymentVacactionGroup: true,  //Needed for VacationGroupName etc
                    loadUser: loadUser);

                employees = employees?.Where(e => !e.Hidden).ToList();

                if (employees.IsNullOrEmpty())
                    return new List<EmployeeInformation>();

                #endregion

                #region Load prereqs

                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                var accountsDict = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId))?.ToDictionary(k => k.AccountId, v => v) ?? new Dictionary<int, AccountDTO>();
                var accountsNotActiveDict = entitiesReadOnly.Account.Include(i => i.AccountInternal).Where(w => w.ActorCompanyId == actorCompanyId && w.State != (int)SoeEntityState.Active).ToDTOs(false, true).ToDictionary(k => k.AccountId, v => v) ?? new Dictionary<int, AccountDTO>();
                var accountDimsDict = base.GetAccountDimsFromCache(entities, CacheConfig.Company(actorCompanyId))?.ToDictionary(k => k.AccountDimId, v => v) ?? new Dictionary<int, AccountDimDTO>();
                var employeeGroups = GetEmployeeGroupsFromCache(actorCompanyId, loadExternalCode: true);
                var employeeGroupsDict = employeeGroups.ToDictionary(k => k.EmployeeGroupId, v => v);
                var payrollGroups = GetPayrollGroupsFromCache(actorCompanyId, loadExternalCode: true);
                var payrollGroupsDict = payrollGroups?.ToDictionary(k => k.PayrollGroupId, v => v) ?? new Dictionary<int, PayrollGroup>();
                var vacationGroups = GetVacationGroupsFromCache(actorCompanyId, loadExternalCode: true);
                var vacationGroupsDict = vacationGroups?.ToDictionary(k => k.VacationGroupId, v => v) ?? new Dictionary<int, VacationGroup>();
                var annualLeaveGroups = GetAnnualLeaveGroupsFromCache(actorCompanyId);

                #endregion

                #region Load Positions

                var posistionDict = new Dictionary<int, List<EmployeeInformationPosition>>();
                if (loadPositions)
                {
                    var positions = EmployeeManager.GetEmployeePositions(employeeIds, true);
                    foreach (var positionsByEmployee in positions.GroupBy(g => g.EmployeeId))
                    {
                        var employeeInformationPositions = new List<EmployeeInformationPosition>();

                        foreach (var position in positionsByEmployee)
                        {
                            employeeInformationPositions.Add(new EmployeeInformationPosition()
                            {
                                Code = position.Position.Name,
                                Name = position.Position.Name,
                                SysCode = position.Position.SysPositionCode,
                                Default = position.Default,
                            });
                        }

                        posistionDict.Add(positionsByEmployee.Key, employeeInformationPositions);
                    }
                }

                #endregion

                #region Load ReportSettings

                var reportSettingDict = new Dictionary<int, List<EmployeeInformationReportSetting>>();
                if (loadReportSettings)
                {
                    var employeeSettings = EmployeeManager.GetEmployeeSettings(actorCompanyId, employeeIds, fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo, TermGroup_EmployeeSettingType.Reporting, null, null);

                    foreach (var employeeSettingsByEmployee in employeeSettings.GroupBy(g => g.EmployeeId))
                    {
                        var employee = employees.FirstOrDefault(f => f.EmployeeId == employeeSettingsByEmployee.Key);
                        if (employee == null)
                            continue;

                        var reportSettings = new List<EmployeeInformationReportSetting>();

                        foreach (var setting in employeeSettingsByEmployee)
                        {
                            reportSettings.Add(new EmployeeInformationReportSetting()
                            {
                                DateFrom = setting.ValidFromDate,
                                DateTo = setting.ValidToDate,
                                Name = EnumUtility.GetName((TermGroup_EmployeeSettingType)setting.EmployeeSettingType),
                                Value = setting.GetEmployeeSettingValueAsString()
                            });
                        }

                        reportSettingDict.Add(employeeSettingsByEmployee.Key, reportSettings);
                    }

                    foreach (var employee in employees)
                    {
                        var employeeInformationReportSettings = new List<EmployeeInformationReportSetting>();

                        if (reportSettingDict.ContainsKey(employee.EmployeeId))
                        {
                            employeeInformationReportSettings.AddRange(reportSettingDict[employee.EmployeeId]);
                            reportSettingDict.Remove(employee.EmployeeId);
                        }

                        if (employee.PayrollStatisticsPersonalCategory != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.PayrollStatisticsPersonalCategory), Value = employee.PayrollStatisticsPersonalCategory.ToString() });
                        if (employee.PayrollStatisticsWorkTimeCategory != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.PayrollStatisticsWorkTimeCategory), Value = employee.PayrollStatisticsWorkTimeCategory.ToString() });
                        if (employee.PayrollStatisticsSalaryType != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.PayrollStatisticsSalaryType), Value = employee.PayrollStatisticsSalaryType.ToString() });
                        if (employee.PayrollStatisticsWorkPlaceNumber != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.PayrollStatisticsWorkPlaceNumber), Value = employee.PayrollStatisticsWorkPlaceNumber.ToString() });
                        if (employee.PayrollStatisticsCFARNumber != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.PayrollStatisticsCFARNumber), Value = employee.PayrollStatisticsCFARNumber.ToString() });
                        if (employee.WorkPlaceSCB != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.WorkPlaceSCB), Value = employee.WorkPlaceSCB });
                        if (employee.PartnerInCloseCompany)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.PartnerInCloseCompany), Value = employee.PartnerInCloseCompany.ToString() });
                        if (employee.BenefitAsPension)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BenefitAsPension), Value = employee.BenefitAsPension.ToString() });
                        if (employee.AFACategory != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AFACategory), Value = employee.AFACategory.ToString() });
                        if (employee.AFASpecialAgreement != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AFASpecialAgreement), Value = employee.AFASpecialAgreement.ToString() });
                        if (employee.AFAWorkplaceNr != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AFAWorkplaceNr), Value = employee.AFAWorkplaceNr });
                        if (employee.AFAParttimePensionCode)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AFAParttimePensionCode), Value = employee.AFAParttimePensionCode.ToString() });
                        if (employee.CollectumITPPlan != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.CollectumITPPlan), Value = employee.CollectumITPPlan.ToString() });
                        if (employee.CollectumAgreedOnProduct != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.CollectumAgreedOnProduct), Value = employee.CollectumAgreedOnProduct });
                        if (employee.CollectumCostPlace != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.CollectumCostPlace), Value = employee.CollectumCostPlace });
                        if (employee.CollectumCancellationDate != null)
                        {
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.CollectumCancellationDate), Value = employee.CollectumCancellationDate.ToString() });
                            if (employee.CollectumCancellationDateIsLeaveOfAbsence)
                                employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.CollectumCancellationDateIsLeaveOfAbsence), Value = employee.CollectumCancellationDateIsLeaveOfAbsence.ToString() });
                        }
                        if (employee.KPARetirementAge != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.KPARetirementAge), Value = employee.KPARetirementAge.ToString() });
                        if (employee.KPABelonging != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.KPABelonging), Value = employee.KPABelonging.ToString() });
                        if (employee.KPAEndCode != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.KPAEndCode), Value = employee.KPAEndCode.ToString() });
                        if (employee.KPAAgreementType != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.KPAAgreementType), Value = employee.KPAAgreementType.ToString() });
                        if (employee.BygglosenAgreementArea != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenAgreementArea), Value = employee.BygglosenAgreementArea });
                        if (employee.BygglosenAllocationNumber != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenAllocationNumber), Value = employee.BygglosenAllocationNumber });
                        if (employee.BygglosenSalaryFormula != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenSalaryFormula), Value = employee.BygglosenSalaryFormula.ToString() });
                        if (employee.BygglosenMunicipalCode != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenMunicipalCode), Value = employee.BygglosenMunicipalCode });
                        if (employee.BygglosenProfessionCategory != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenProfessionCategory), Value = employee.BygglosenProfessionCategory });
                        if (employee.BygglosenSalaryType != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenSalaryType), Value = employee.BygglosenSalaryType.ToString() });
                        if (employee.BygglosenWorkPlaceNumber != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenWorkPlaceNumber), Value = employee.BygglosenWorkPlaceNumber });
                        if (employee.BygglosenLendedToOrgNr != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenLendedToOrgNr), Value = employee.BygglosenLendedToOrgNr });
                        if (employee.BygglosenAgreedHourlyPayLevel != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.BygglosenAgreedHourlyPayLevel), Value = employee.BygglosenAgreedHourlyPayLevel.ToString() });
                        if (employee.GTPAgreementNumber != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.GTPAgreementNumber), Value = employee.GTPAgreementNumber.ToString() });
                        if (employee.GTPExcluded)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.GTPExcluded), Value = employee.GTPExcluded.ToString() });
                        if (employee.AGIPlaceOfEmploymentAddress != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AGIPlaceOfEmploymentAddress), Value = employee.AGIPlaceOfEmploymentAddress });
                        if (employee.AGIPlaceOfEmploymentCity != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AGIPlaceOfEmploymentCity), Value = employee.AGIPlaceOfEmploymentCity });
                        if (employee.AGIPlaceOfEmploymentIgnore)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.AGIPlaceOfEmploymentIgnore), Value = employee.AGIPlaceOfEmploymentIgnore.ToString() });
                        if (employee.IFAssociationNumber != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.IFAssociationNumber), Value = employee.IFAssociationNumber.ToString() });
                        if (employee.IFPaymentCode != 0)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.IFPaymentCode), Value = employee.IFPaymentCode.ToString() });
                        if (employee.IFWorkPlace != null)
                            employeeInformationReportSettings.Add(new EmployeeInformationReportSetting { Name = nameof(employee.IFWorkPlace), Value = employee.IFWorkPlace });

                        if (employeeInformationReportSettings.Any())
                            reportSettingDict.Add(employee.EmployeeId, employeeInformationReportSettings);
                    }


                }

                #endregion

                #region Load ExtraFields

                var extraFieldDict = new Dictionary<int, List<EmployeeInformationExtraField>>();
                if (loadExtraFields)
                {
                    var extraFields = ExtraFieldManager.GetExtraFields((int)SoeEntityType.Employee, ActorCompanyId, true, loadExternalCodes: true).ToDTOs().ToList();

                    foreach (var extraField in extraFields)
                    {
                        foreach (var record in extraField.ExtraFieldRecords)
                        {
                            if (!extraFieldDict.ContainsKey(record.RecordId))
                                extraFieldDict.Add(record.RecordId, new List<EmployeeInformationExtraField>());

                            extraFieldDict[record.RecordId].Add(new EmployeeInformationExtraField()
                            {
                                Name = extraField.Text,
                                Value = record.Value,
                                ExternalCodes = extraField.ExternalCodes,
                                ExtraFieldId = extraField.ExtraFieldId
                            });
                        }
                    }
                }

                #endregion

                #region Load Users

                var employeeUserDict = new Dictionary<int, EmployeeInformationUser>();
                if (loadUser && HasPermission(Feature.Manage_Users_Edit))
                {
                    var users = employees.Select(s => s.User).Where(w => w != null).ToList();
                    var userCompanyRolesDict = new Dictionary<int, List<UserCompanyRole>>();
                    var attestRoleUsersDict = new Dictionary<int, List<AttestRoleUser>>();
                    var includeDefinedManager = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseIsNearestManagerOnAttestRoleUser, 0, actorCompanyId, 0);

                    if (loadUserRoles)
                    {
                        var userIds = users.Select(s => s.UserId).ToList();
                        var userCompanyRoles = entitiesReadOnly.UserCompanyRole
                            .Include("Role")
                            .Where(ucr =>
                                ucr.ActorCompanyId == actorCompanyId &&
                                userIds.Contains(ucr.UserId) &&
                                ucr.State == (int)SoeEntityState.Active)
                            .ToList();
                        userCompanyRolesDict = userCompanyRoles
                            .GroupBy(g => g.UserId)
                            .ToDictionary(k => k.Key, v => v.ToList());

                        if (HasPermission(Feature.Manage_Users_Edit_AttestRoleMapping))
                        {
                            var attestRoles = entitiesReadOnly.AttestRoleUser
                                .Include("AttestRole")
                                .Where(aru =>
                                    aru.AttestRole.ActorCompanyId == actorCompanyId &&
                                    userIds.Contains(aru.UserId) &&
                                    aru.State == (int)SoeEntityState.Active)
                                .ToList();
                            attestRoleUsersDict = attestRoles
                                .GroupBy(g => g.UserId)
                                .ToDictionary(k => k.Key, v => v.ToList());
                        }
                    }

                    foreach (var user in users)
                    {
                        var employee = employees.FirstOrDefault(f => f.UserId == user.UserId);
                        if (employee != null)
                        {
                            EmployeeInformationUser userInfo = new EmployeeInformationUser
                            {
                                UserName = user.LoginName,
                            };

                            if (loadUserRoles)
                            {
                                if (userCompanyRolesDict.TryGetValue(user.UserId, out List<UserCompanyRole> userCompanyRolesForUser))
                                {
                                    foreach (var userCompanyRole in userCompanyRolesForUser)
                                    {
                                        if (userInfo.UserRoles == null)
                                            userInfo.UserRoles = new List<EmployeeInformationUserRole>();

                                        userInfo.UserRoles.Add(new EmployeeInformationUserRole()
                                        {
                                            Name = userCompanyRole.Role.Name,
                                            DateFrom = userCompanyRole.DateFrom,
                                            DateTo = userCompanyRole.DateTo,
                                            Default = userCompanyRole.Default
                                        });
                                    }
                                }

                                if (attestRoleUsersDict.TryGetValue(user.UserId, out List<AttestRoleUser> attestRoleUsersForUser))
                                {
                                    foreach (var attestRoleUser in attestRoleUsersForUser)
                                    {
                                        if (userInfo.UserAttestRoles == null)
                                            userInfo.UserAttestRoles = new List<EmployeeInformationUserAttestRole>();

                                        var account = attestRoleUser.AccountId.HasValue ? accountsDict.GetValue(attestRoleUser.AccountId.Value) : null;

                                        userInfo.UserAttestRoles.Add(new EmployeeInformationUserAttestRole()
                                        {
                                            Name = attestRoleUser.AttestRole.Name,
                                            DateFrom = attestRoleUser.DateFrom,
                                            DateTo = attestRoleUser.DateTo,
                                            AccountName = account?.Name ?? "",
                                            AccountNr = account?.AccountNr ?? "",
                                            DefinedManager = includeDefinedManager ? (bool?)attestRoleUser.IsNearestManager : null,
                                        });
                                    }
                                }
                            }

                            if (!employeeUserDict.ContainsKey(employee.EmployeeId))
                                employeeUserDict.Add(employee.EmployeeId, userInfo);

                        }
                    }
                }

                #endregion

                #region Load HierarchyAccounts

                List<EmployeeAccount> employeeAccounts = null;
                var hierarchyDict = new Dictionary<int, List<HierarchyAccount>>();

                if (loadHierarchy)
                {
                    hierarchyDict = LoadHierarchyAccounts(
                        actorCompanyId,
                        fetchEmployeeInformation,
                        addVirtualAccounts,
                        employeeIds,
                        out employeeAccounts,
                        accountsDict,
                        accountDimsDict);
                }

                #endregion

                #region Load EmploymentAccounts

                var employmentAccountDict = new Dictionary<int, List<EmployeeInformationEmploymentAccount>>();
                if (loadEmployment && loadEmploymentAccounts)
                {
                    var employments = employees.SelectMany(s => s.Employment).ToList();
                    var employmentIds = employments.Select(s => s.EmploymentId).ToList();
                    var employmentAccounts = EmployeeManager.GetEmploymentAccounts(entitiesReadOnly, employmentIds);

                    foreach (var employmentsOnEmployee in employments.GroupBy(g => g.EmployeeId))
                    {
                        foreach (var employment in employmentsOnEmployee)
                        {
                            var employmentAccountsInfoOnEmployment = new List<EmployeeInformationEmploymentAccount>();
                            foreach (var employmentAccount in employmentAccounts.Where(w => w.EmploymentId == employment.EmploymentId).OrderBy(o => o.Type))
                            {
                                var account = employmentAccount.AccountId.HasValue ? accountsDict.GetValue(employmentAccount.AccountId.Value) : null;
                                if (account != null)
                                {
                                    var accountDim = accountDimsDict.GetValue(account.AccountDimId);

                                    employmentAccountsInfoOnEmployment.Add(new EmployeeInformationEmploymentAccount()
                                    {
                                        AccountName = account.Name,
                                        AccountNr = account.AccountNr,
                                        DimNr = accountDim?.AccountDimNr ?? 0,
                                        SieDimNr = accountDim?.SysSieDimNr ?? 0,
                                        Percent = employmentAccount.Percent,
                                        Type = EnumUtility.GetName<EmploymentAccountType>((EmploymentAccountType)employmentAccount.Type)
                                    });
                                }

                                foreach (var ai in employmentAccount.AccountInternal)
                                {
                                    var accountInternal = accountsDict.GetValue(ai.AccountId);
                                    bool notActive = false;
                                    if (accountInternal == null)
                                    {
                                        accountInternal = accountsNotActiveDict.GetValue(ai.AccountId);
                                        notActive = true;
                                    }
                                    if (accountInternal == null)
                                        continue;

                                    var accountInternalDim = accountDimsDict.GetValue(accountInternal.AccountDimId);

                                    var employeeAccountInfo = new EmployeeInformationEmploymentAccount()
                                    {
                                        AccountName = (accountInternal?.Name ?? "?") + (notActive ? "*" : ""),
                                        AccountNr = (accountInternal?.AccountNr ?? "?") + (notActive ? "*" : ""),
                                        DimNr = accountInternalDim?.AccountDimNr ?? 0,
                                        SieDimNr = accountInternalDim?.SysSieDimNr ?? 0,
                                        Percent = employmentAccount.Percent,
                                        Type = EnumUtility.GetName<EmploymentAccountType>((EmploymentAccountType)employmentAccount.Type)
                                    };

                                    employmentAccountsInfoOnEmployment.Add(employeeAccountInfo);
                                }
                            }

                            if (!employmentAccountDict.ContainsKey(employment.EmploymentId))
                                employmentAccountDict.Add(employment.EmploymentId, employmentAccountsInfoOnEmployment);
                        }
                    }
                }

                #endregion

                #region Load AttestTransition

                var attestLogsDateFrom = DateTime.Today.AddDays(-30);
                var attestLogsDateTo = DateTime.Today;
                Dictionary<int, List<GetAttestTransitionLogsForEmployeeResult>> attestLogsDict = loadNearestExecutive ? AttestManager.GetLimitedAttestTransitionLogsForEmployees(entitiesReadOnly, employeeIds, attestLogsDateFrom, attestLogsDateTo) : new Dictionary<int, List<GetAttestTransitionLogsForEmployeeResult>>();

                #endregion
                Dictionary<int, List<EmploymentPriceTypeDTO>> employmentPriceTypesForCompanyDict = new Dictionary<int, List<EmploymentPriceTypeDTO>>();
                if (loadPayrollInformation)
                {
                    var employmentPriceTypes = EmployeeManager.GetEmploymentPriceTypesForCompany(entitiesReadOnly, actorCompanyId, employees.Select(s => s.EmployeeId).ToList());
                    employmentPriceTypesForCompanyDict = employmentPriceTypes.GroupBy(g => g.EmploymentId).ToDictionary(k => k.Key, v => v.ToDTOs(true, false).ToList());
                }
                #region Executives

                var executiveDict = new Dictionary<int, List<EmployeeInformationExecutive>>();
                if (loadExecutives)
                {
                    employeeAccounts = employeeAccounts ?? EmployeeManager.GetEmployeeAccounts(actorCompanyId, employeeIds, fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo);
                    var attestRoles = AttestManager.GetAttestRolesDict(actorCompanyId, SoeModule.Time, false);
                    Dictionary<int, List<EmployeeAccount>> employeeAccountsDict = null;
                    if (loadNearestExecutive)
                        employeeAccountsDict = employeeAccounts.GroupBy(e => e.EmployeeId).ToDictionary(k => k.Key, v => v.ToList());

                    foreach (var employee in employees)
                    {
                        var executives = UserManager.GetEmployeeExtendedNearestExecutivesBasedOnAttestRole(entitiesReadOnly, employee, fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo, actorCompanyId, employeeAccounts);
                        List<EmployeeInformationExecutive> employeeInformationExecutives = new List<EmployeeInformationExecutive>();

                        if (!executives.IsNullOrEmpty())
                        {
                            UserDTO nearestExecutive = null;
                            if (loadNearestExecutive)
                            {
                                if (!attestLogsDict.TryGetValue(employee.EmployeeId, out List<GetAttestTransitionLogsForEmployeeResult> attestLogs))
                                    attestLogs = new List<GetAttestTransitionLogsForEmployeeResult>();

                                if (!employeeAccountsDict.TryGetValue(employee.EmployeeId, out List<EmployeeAccount> currentEmployeeAccounts))
                                    currentEmployeeAccounts = new List<EmployeeAccount>();

                                nearestExecutive = UserManager.GetEmployeeNearestExecutive(entitiesReadOnly,
                                                                        employee,
                                                                        fetchEmployeeInformation.DateFrom,
                                                                        fetchEmployeeInformation.DateTo,
                                                                        actorCompanyId,
                                                                        currentEmployeeAccounts,
                                                                        attestLogs);
                            }

                            foreach (var executive in executives)
                            {
                                var employeeForExecutive = employees.FirstOrDefault(f => f.UserId == executive.User.UserId) ?? EmployeeManager.GetEmployeeByUser(actorCompanyId, executive.User.UserId, false, true);
                                string socialSecurity = null;
                                if (employeeForExecutive?.ContactPerson != null)
                                    socialSecurity = showSocialSec ? employeeForExecutive.SocialSec : StringUtility.SocialSecYYMMDD_Dash_Stars(employeeForExecutive.SocialSec);

                                var employeeInformationExecutive = new EmployeeInformationExecutive()
                                {
                                    Name = executive.User.Name,
                                    SocialSec = socialSecurity,
                                    Email = executive.User.Email,
                                };

                                if (loadNearestExecutive)
                                    employeeInformationExecutive.IsNearest = executive.User.UserId == nearestExecutive?.UserId;

                                foreach (var role in executive.UserAttestRoles)
                                {
                                    if (attestRoles.TryGetValue(role.AttestRoleId, out string attestRole))
                                    {
                                        employeeInformationExecutive.Intervals.Add(new EmployeeInformationExecutiveInterval()
                                        {
                                            DateFrom = role.DateFrom ?? CalendarUtility.DATETIME_DEFAULT,
                                            DateTo = role.DateTo,
                                            RoleName = attestRole
                                        });
                                    }
                                }

                                employeeInformationExecutives.Add(employeeInformationExecutive);
                            }
                        }

                        if (!executiveDict.ContainsKey(employee.EmployeeId))
                            executiveDict.Add(employee.EmployeeId, employeeInformationExecutives);
                    }
                }

                #endregion

                #region Load Skills

                var skillDict = new Dictionary<int, List<EmployeeInformationSkill>>();
                if (loadSkills)
                {
                    var skills = entitiesReadOnly.EmployeeSkill
            .Include(i => i.Skill)
            .Where(w => employeeIds.Contains(w.EmployeeId))
            .ToList();

                    foreach (var skillsByEmployee in skills.GroupBy(g => g.EmployeeId))
                    {
                        var employeeInformationSkills = new List<EmployeeInformationSkill>();

                        foreach (var skill in skillsByEmployee)
                        {
                            employeeInformationSkills.Add(new EmployeeInformationSkill()
                            {
                                SkillName = skill.Skill.Name,
                                SkillLevel = skill.SkillLevel,
                                DateTo = skill.DateTo
                            });
                        }

                        skillDict.Add(skillsByEmployee.Key, employeeInformationSkills);
                    }
                }

                #endregion

                #region Load CalendarInfos

                var calenderInfoDict = new Dictionary<int, List<CalenderInfo>>();
                if (loadCalenderDayInfo)
                {
                    var payrollPriceTypes = GetPayrollPriceTypesFromCache(actorCompanyId);
                    var timeBlockDatesByEmployee = TimeBlockManager.GetTimeBlockDates(entitiesReadOnly, actorCompanyId, employees.GetIds(), fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo).GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList());
                    var employmentCalendars = EmployeeManager.GetEmploymentCalenderDTOs(employees, fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo, employeeGroups, payrollGroups, payrollPriceTypes, vacationGroups, annualLeaveGroups: annualLeaveGroups);

                    foreach (var employmentCalendarsByEmployee in employmentCalendars.GroupBy(g => g.EmployeeId))
                    {
                        var employee = employees.FirstOrDefault(f => f.EmployeeId == employmentCalendarsByEmployee.Key);
                        if (employee != null)
                        {
                            var calendarInfos = new List<CalenderInfo>();
                            var timeBlockDatesDict = timeBlockDatesByEmployee.GetList(employee.EmployeeId)
                                .OrderBy(v => v.TimeBlockDateId).GroupBy(v => v.Date).Select(g => g.First()) // TimeBlockDate table may contain duplicates - pick the first one for each day
                                .ToDictionary(k => k.Date, v => v);

                            CalenderInfo previous = null;
                            foreach (var employmentCalendar in employmentCalendarsByEmployee.OrderBy(o => o.Date))
                            {
                                var info = new CalenderInfo()
                                {
                                    EmployeeNr = employee.EmployeeNr,
                                    Date = employmentCalendar.Date,
                                    EmploymentPercent = employmentCalendar.Percent,
                                    EmployeeGroupExternalCodes = (employmentCalendar.EmployeeGroupId.HasValue ? employeeGroupsDict.GetValue(employmentCalendar.EmployeeGroupId.Value)?.ExternalCodesString : null) ?? string.Empty,
                                    VacationGroupExternalCodes = (employmentCalendar.VacationGroupId.HasValue ? vacationGroupsDict.GetValue(employmentCalendar.VacationGroupId.Value)?.ExternalCodesString : null) ?? string.Empty,
                                    PayrollGroupExternalCodes = (employmentCalendar.PayrollGroupId.HasValue ? payrollGroupsDict.GetValue(employmentCalendar.PayrollGroupId.Value)?.ExternalCodesString : null) ?? string.Empty,
                                    DayExternalCode = timeBlockDatesDict.GetValue(employmentCalendar.Date)?.ExternalCode ?? string.Empty,
                                };

                                if (onePerChangeCalenderDayInfo &&
                                    previous != null && (
                                    previous.EmployeeNr != info.EmployeeNr ||
                                    previous.EmploymentPercent != info.EmploymentPercent ||
                                    previous.EmployeeGroupExternalCodes != info.EmployeeGroupExternalCodes ||
                                    previous.VacationGroupExternalCodes != info.VacationGroupExternalCodes ||
                                    previous.PayrollGroupExternalCodes != info.PayrollGroupExternalCodes ||
                                    previous.DayExternalCode != info.DayExternalCode))
                                {
                                    calendarInfos.Add(info);
                                    previous = info;
                                    continue;
                                }
                                else if (!onePerChangeCalenderDayInfo)
                                {
                                    calendarInfos.Add(info);
                                }
                                else if (onePerChangeCalenderDayInfo && previous == null)
                                {
                                    calendarInfos.Add(info);
                                    previous = info;
                                }
                            }
                            if (!calenderInfoDict.ContainsKey(employmentCalendarsByEmployee.Key))
                                calenderInfoDict.Add(employmentCalendarsByEmployee.Key, calendarInfos);
                        }
                    }
                }

                #endregion

                #region Build info

                var employeeVacationSEs = loadVacationInfo ? EmployeeManager.GetEmployeeVacationSEs(employeeIds, false).ToList() : new List<EmployeeVacationSE>();
                var employmentTypes = loadEmployment ? EmployeeManager.GetEmploymentTypes(entitiesReadOnly, actorCompanyId, (TermGroup_Languages)GetLangId()) : null;

                foreach (var employee in employees)
                {
                    var info = new EmployeeInformation()
                    {
                        EmployeeId = employee.EmployeeId,
                        EmployeeNr = employee.EmployeeNr,
                        FirstName = employee.FirstName,
                        LastName = employee.LastName,
                        EmployeeExternalCode = employee.ExternalCode,
                        ExcludeFromPayroll = employee.ExcludeFromPayroll,
                        SocialSecurityNumber = employee.ContactPerson != null && showSocialSec ? employee.SocialSec : StringUtility.SocialSecYYMMDD_Dash_Stars(employee.SocialSec),
                        Created = employee.Created,
                        Modified = employee.Modified,
                        Vacant = employee.Vacant,
                    };

                    if (loadHierarchy && hierarchyDict.ContainsKey(employee.EmployeeId))
                        info.HierarchyAccounts = hierarchyDict[employee.EmployeeId];
                    if (loadExtraFields && extraFieldDict.ContainsKey(employee.EmployeeId))
                        info.ExtraFields = extraFieldDict[employee.EmployeeId];
                    if (loadPositions && posistionDict.ContainsKey(employee.EmployeeId))
                        info.Positions = posistionDict[employee.EmployeeId];
                    if (loadReportSettings && reportSettingDict.ContainsKey(employee.EmployeeId))
                        info.ReportSettings = reportSettingDict[employee.EmployeeId];
                    if (loadUser && employeeUserDict.ContainsKey(employee.EmployeeId))
                        info.UserInformation = employeeUserDict[employee.EmployeeId];
                    if (loadSkills && skillDict.ContainsKey(employee.EmployeeId))
                        info.Skills = skillDict[employee.EmployeeId];
                    if (loadCalenderDayInfo && calenderInfoDict.ContainsKey(employee.EmployeeId))
                        info.CalenderInfos = calenderInfoDict[employee.EmployeeId];
                    if (loadExecutives && executiveDict.ContainsKey(employee.EmployeeId))
                        info.Executives = executiveDict[employee.EmployeeId];

                    #region EmployeeVacation

                    if (loadVacationInfo)
                    {
                        var employeeVacationForEmployee = employeeVacationSEs
                            .Where(f => f.EmployeeId == employee.EmployeeId)
                            .OrderBy(f => f.Created);

                        var employeeVacation = employeeVacationForEmployee.LastOrDefault();
                        if (employeeVacation != null)
                        {
                            var employeeInformationVacation = new EmployeeInformationVacation()
                            {
                                RemainingDaysAdvance = employeeVacation.RemainingDaysAdvance,
                                RemainingDaysOverdue = employeeVacation.RemainingDaysOverdue,
                                RemainingDaysPaid = employeeVacation.RemainingDaysPaid,
                                RemainingDaysUnpaid = employeeVacation.RemainingDaysUnpaid,
                                RemainingDaysYear1 = employeeVacation.RemainingDaysYear1,
                                RemainingDaysYear2 = employeeVacation.RemainingDaysYear2,
                                RemainingDaysYear3 = employeeVacation.RemainingDaysYear3,
                                RemainingDaysYear4 = employeeVacation.RemainingDaysYear4,
                                RemainingDaysYear5 = employeeVacation.RemainingDaysYear5,
                                AdjustmentDate = employeeVacation.AdjustmentDate,
                                LastUpdated = employeeVacation.Created
                            };

                            if (loadVacationInfoHistory)
                            {
                                if (employeeInformationVacation.EmployeeInformationVacationHistory == null)
                                    employeeInformationVacation.EmployeeInformationVacationHistory = new List<EmployeeInformationVacation>();

                                foreach (var employeeVacationHistory in employeeVacationForEmployee.Where(w => w.EmployeeVacationSEId != employeeVacation.EmployeeVacationSEId))
                                {
                                    employeeInformationVacation.EmployeeInformationVacationHistory.Add(new EmployeeInformationVacation()
                                    {
                                        RemainingDaysAdvance = employeeVacationHistory.RemainingDaysAdvance,
                                        RemainingDaysOverdue = employeeVacationHistory.RemainingDaysOverdue,
                                        RemainingDaysPaid = employeeVacationHistory.RemainingDaysPaid,
                                        RemainingDaysUnpaid = employeeVacationHistory.RemainingDaysUnpaid,
                                        RemainingDaysYear1 = employeeVacationHistory.RemainingDaysYear1,
                                        RemainingDaysYear2 = employeeVacationHistory.RemainingDaysYear2,
                                        RemainingDaysYear3 = employeeVacationHistory.RemainingDaysYear3,
                                        RemainingDaysYear4 = employeeVacationHistory.RemainingDaysYear4,
                                        RemainingDaysYear5 = employeeVacationHistory.RemainingDaysYear5,
                                        AdjustmentDate = employeeVacationHistory.AdjustmentDate,
                                        LastUpdated = employeeVacationHistory.Created
                                    });
                                }
                            }

                            info.InformationVacation = employeeInformationVacation;
                        }
                    }

                    #endregion

                    #region Contact

                    if (loadContact)
                    {
                        var contact = employee.ContactPerson.Actor.Contact.FirstOrDefault();
                        if (contact != null)
                        {
                            if (!contact.ContactECom.IsNullOrEmpty())
                            {
                                foreach (var ecom in contact.ContactECom.Where(w => w.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Email))
                                    info.ContactInformation.Emails.Add(new EmployeeInformationEmail()
                                    {
                                        Email = ecom.Text
                                    });

                                foreach (var item in contact.ContactECom.Where(w => w.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneHome))
                                    info.ContactInformation.Phones.Add(new EmployeeInformationPhone()
                                    {
                                        PhoneNumber = item.Text,
                                        Type = "PhoneHome"
                                    });

                                foreach (var item in contact.ContactECom.Where(w => w.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneMobile))
                                    info.ContactInformation.Phones.Add(new EmployeeInformationPhone()
                                    {
                                        PhoneNumber = item.Text,
                                        Type = "PhoneMobile"
                                    });

                                foreach (var item in contact.ContactECom.Where(w => w.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneJob))
                                    info.ContactInformation.Phones.Add(new EmployeeInformationPhone()
                                    {
                                        PhoneNumber = item.Text,
                                        Type = "PhoneJob"
                                    });
                            }

                            if (!contact.ContactAddress.IsNullOrEmpty())
                            {
                                foreach (var address in contact.ContactAddress)
                                {
                                    var employeeAddress = new EmployeeInformationAddress
                                    {
                                        Type = EnumUtility.GetName<TermGroup_SysContactAddressType>((TermGroup_SysContactAddressType)address.SysContactAddressTypeId)
                                    };

                                    if (!address.ContactAddressRow.IsNullOrEmpty())
                                    {
                                        foreach (var contactAddressRow in address.ContactAddressRow)
                                        {
                                            if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                                employeeAddress.Address = contactAddressRow.Text;
                                            else if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                                employeeAddress.AddressCO = contactAddressRow.Text;
                                            else if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                                employeeAddress.City = contactAddressRow.Text;
                                            else if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                                employeeAddress.Country = contactAddressRow.Text;
                                            else if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                                employeeAddress.PostalCode = contactAddressRow.Text;
                                        }

                                        info.ContactInformation.Addresses.Add(employeeAddress);
                                    }
                                }
                            }
                        }
                    }

                    #endregion

                    #region Employment

                    if (loadEmployment)
                    {
                        if (info.Employments == null)
                            info.Employments = new List<EmployeeInformationEmployment>();

                        foreach (var employment in employee.GetEmployments(fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo, includeSecondary: true))
                        {
                            #region Employment

                            var date = new List<DateTime>()
                            {
                                employment.GetEndDate() ?? DateTime.Now,
                                fetchEmployeeInformation.DateTo
                            }.Min();

                            if (fetchEmployeeInformation.SetInitialValuesOnEmployment && employment.DateFrom.HasValue)
                                date = employment.DateFrom.Value;

                            EmployeeInformationEmployment employmentInfo = new EmployeeInformationEmployment();
                            employmentInfo.DateFrom = employment.DateFrom ?? CalendarUtility.DATETIME_DEFAULT;
                            employmentInfo.DateTo = employment.GetEndDate();
                            employmentInfo.EmploymentTypeName = employment.GetEmploymentTypeName(employmentTypes);
                            employmentInfo.EmploymentType = employment.GetEmploymentType(date);
                            employmentInfo.EmployeeGroupName = employment.GetEmployeeGroup(date, employeeGroups)?.Name ?? string.Empty;
                            employmentInfo.PayrollGroupName = employment.GetPayrollGroup(date, payrollGroups)?.Name ?? string.Empty;
                            employmentInfo.VacationGroupName = employment.GetVacationGroup(date, vacationGroups)?.Name ?? string.Empty;
                            employmentInfo.ExternalCode = employment.GetExternalCode(date);
                            employmentInfo.BaseWorkTimeWeek = employment.GetBaseWorkTimeWeek(date);
                            employmentInfo.WorkTimeWeek = employment.GetWorkTimeWeek(date);
                            employmentInfo.WorkTasks = employment.GetWorkTasks(date);
                            employmentInfo.WorkPlace = employment.GetWorkPlace(date);
                            employmentInfo.Percent = employment.GetPercent(date);
                            employmentInfo.SubstituteFor = employment.GetSubstituteFor(date);
                            employmentInfo.SubstituteForDueTo = employment.GetSubstituteForDueTo(date);
                            employmentInfo.SpecialConditions = employment.GetSpecialConditions(date);
                            employmentInfo.IsSecondaryEmployment = employment.IsSecondaryEmployment;
                            employmentInfo.IsTemporaryPrimary = employment.IsTemporaryPrimary;
                            employmentInfo.EmploymentEndReason = employment.GetEndReason(date);
                            employmentInfo.EmploymentEndReasonName = employment.GetEndReasonName(date);
                            employmentInfo.Id = employment.EmploymentId;

                            if (loadEmploymentAccounts && employmentAccountDict.ContainsKey(employment.EmploymentId))
                                employmentInfo.EmploymentAccounts = employmentAccountDict[employment.EmploymentId];

                            #endregion

                            #region Employment payroll information
                            List<PayrollGroupPriceFormula> payrollGroupPriceFormulas = new List<PayrollGroupPriceFormula>();
                            if (loadPayrollInformation && employmentPriceTypesForCompanyDict.TryGetValue(employment.EmploymentId, out List<EmploymentPriceTypeDTO> employmentPriceTypes))
                            {
                                var payrollGroupId = loadPayrollFormulaResult ? employment.GetPayrollGroup(date, payrollGroups)?.PayrollGroupId : null;
                                payrollGroupPriceFormulas = payrollGroupId.HasValue && loadPayrollFormulaResult ? PayrollManager.GetPayrollGroupPriceFormulas(entitiesReadOnly, payrollGroupId ?? 0, true) : new List<PayrollGroupPriceFormula>();
                                #region EmploymentPriceType

                                foreach (var employmentPriceType in employmentPriceTypes)
                                {
                                    var amountTuple = employmentPriceType.GetAmountAndDateAndIsIsPayrollGroupPriceType(fetchEmployeeInformation.DateTo);

                                    var employeeInformationEmploymentPriceType = new EmployeeInformationEmploymentPriceType
                                    {
                                        Code = employmentPriceType.Code,
                                        Name = employmentPriceType.Name,
                                        Type = (int)employmentPriceType.PayrollPriceType,
                                        TypeName = GetText((int)employmentPriceType.PayrollPriceType, (int)TermGroup.EmploymentPriceTypes),
                                        Amount = amountTuple.Item1,
                                        DateFrom = amountTuple.Item2.ToValueOrDefault(),
                                        IsPayrollGroupPriceType = amountTuple.Item3.ToInt()
                                    };

                                    employmentInfo.EmploymentPriceTypes.Add(employeeInformationEmploymentPriceType);
                                }

                                #endregion

                                #region EmploymentPriceFormula 

                                foreach (PayrollGroupPriceFormula payrollGroupPriceFormula in payrollGroupPriceFormulas)
                                {
                                    var priceFormulaResult = PayrollManager.EvaluatePayrollPriceFormula(entitiesReadOnly, actorCompanyId, employee, employment, null, fetchEmployeeInformation.DateTo, payrollGroupPriceFormula.PayrollGroupPriceFormulaId, null, null);
                                    if (priceFormulaResult != null)
                                    {
                                        var formulaResult = new EmployeeInformationEmploymentPriceFormulaResult
                                        {
                                            FormulaExtracted = priceFormulaResult.FormulaExtracted,
                                            FormulaName = priceFormulaResult.FormulaNames,
                                            FormulaPlain = priceFormulaResult.FormulaPlain,
                                            FormulaAmount = priceFormulaResult.Amount
                                        };
                                        employmentInfo.EmploymentPriceFormulaResults.Add(formulaResult);
                                    }
                                }
                                #endregion
                            }

                            #endregion

                            #region EmploymentChanges

                            if (loadEmploymentChanges)
                            {
                                foreach (var employmentChange in employment.EmploymentChange)
                                {
                                    var employmentChangeInfo = new EmployeeInformationEmploymentChange();
                                    employmentChangeInfo.DateFrom = employmentChange.EmploymentChangeBatch.FromDate;
                                    employmentChangeInfo.DateTo = employmentChange.EmploymentChangeBatch.ToDate;
                                    employmentChangeInfo.FieldType = EnumUtility.GetName((TermGroup_EmploymentChangeFieldType)employmentChange.FieldType);
                                    employmentChangeInfo.FieldTypeName = employmentChange.FieldTypeName;
                                    employmentChangeInfo.FromValue = !string.IsNullOrEmpty(employmentChange.FromValue) ? employmentChange.FromValue : null;
                                    employmentChangeInfo.ToValue = !string.IsNullOrEmpty(employmentChange.ToValue) ? employmentChange.ToValue : null;
                                    employmentChangeInfo.FromValueName = !string.IsNullOrEmpty(employmentChange.FromValueName) ? employmentChange.FromValueName : null;
                                    employmentChangeInfo.ToValueName = !string.IsNullOrEmpty(employmentChange.ToValueName) ? employmentChange.ToValueName : null;

                                    if (employmentInfo.EmploymentChanges == null)
                                        employmentInfo.EmploymentChanges = new List<EmployeeInformationEmploymentChange>();

                                    employmentInfo.EmploymentChanges.Add(employmentChangeInfo);
                                }
                            }

                            #endregion

                            info.Employments.Add(employmentInfo);
                        }
                    }

                    #endregion

                    employeeInformations.Add(info);
                }

                #endregion

                return employeeInformations;
            }
            catch (Exception ex)
            {
                LogError(ex, log);
                throw new Exception("An error occurred while fetching employeeinformation", ex);
            }
        }

        public Dictionary<int, List<HierarchyAccount>> LoadHierarchyAccounts(
            int actorCompanyId,
            FetchEmployeeInformation fetchEmployeeInformation,
            bool addVirtualAccounts,
            List<int> employeeIds,
            out List<EmployeeAccount> employeeAccounts,
            Dictionary<int, AccountDTO> accountsDict = null,
            Dictionary<int, AccountDimDTO> accountDimsDict = null
            )
        {
            employeeAccounts = null;
            var hierarchyDict = new Dictionary<int, List<HierarchyAccount>>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            if (accountsDict == null)
                accountsDict = base.GetAccountInternalsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId))?.ToDictionary(k => k.AccountId, v => v) ?? new Dictionary<int, AccountDTO>();
            if (accountDimsDict == null)
                accountDimsDict = base.GetAccountDimsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId))?.ToDictionary(k => k.AccountDimId, v => v) ?? new Dictionary<int, AccountDimDTO>();

            employeeAccounts = EmployeeManager.GetEmployeeAccounts(actorCompanyId, employeeIds, fetchEmployeeInformation.DateFrom, fetchEmployeeInformation.DateTo);
            if (!employeeAccounts.IsNullOrEmpty())
            {
                List<AccountDTO> allAccounts = null;
                List<AccountDTO> GetAllAccounts() => allAccounts ?? (allAccounts = entitiesReadOnly.Account.Where(w => w.ActorCompanyId == actorCompanyId).ToDTOs().ToList());
                bool TryGetAccount(int? accountId, out AccountDTO account)
                {
                    account = null;
                    if (accountId.HasValue)
                        account = accountsDict.GetValue(accountId.Value) ?? GetAllAccounts().FirstOrDefault(f => f.AccountId == accountId.Value);
                    return account != null;
                }

                foreach (var employeeAccountsByEmployee in employeeAccounts.GroupBy(i => i.EmployeeId))
                {
                    var hierarchyAccounts = new List<HierarchyAccount>();

                    foreach (var parent in employeeAccountsByEmployee.Where(w => w.ParentEmployeeAccountId == null))
                    {
                        if (!TryGetAccount(parent?.AccountId, out var account))
                            continue;

                        HierarchyAccount hierarchyAccount = CreateHierarchyAccount(parent, account, isVirtual: false);
                        HierarchyAccount hierarchyAccountVirtualParent = null;
                        HierarchyAccount hierarchyAccountVirtualGrandParent = null;

                        if (addVirtualAccounts && TryGetAccount(account?.ParentAccountId, out var parentAccount))
                        {
                            hierarchyAccountVirtualParent = CreateHierarchyAccount(parent, parentAccount, isVirtual: true);

                            if (TryGetAccount(parentAccount?.ParentAccountId, out var grandParentAccount))
                            {
                                hierarchyAccountVirtualGrandParent = CreateHierarchyAccount(parent, grandParentAccount, isVirtual: true);
                                hierarchyAccountVirtualGrandParent.Children.Add(hierarchyAccountVirtualParent);
                            }
                            else
                            {
                                hierarchyAccountVirtualParent.Children.Add(hierarchyAccount);
                            }
                        }

                        foreach (var child in employeeAccountsByEmployee.Where(w => w.ParentEmployeeAccountId == parent.EmployeeAccountId))
                        {
                            if (TryGetAccount(child.AccountId, out var childAccount))
                            {
                                HierarchyAccount hierarchyAccountChild = CreateHierarchyAccount(child, childAccount, isVirtual: false);
                                hierarchyAccount.Children.Add(hierarchyAccountChild);

                                foreach (var grandChild in employeeAccountsByEmployee.Where(w => w.ParentEmployeeAccountId == child.EmployeeAccountId))
                                {
                                    if (TryGetAccount(grandChild.AccountId, out var grandChildAccount))
                                    {
                                        HierarchyAccount hierarchyAccountGrandChild = CreateHierarchyAccount(grandChild, grandChildAccount, isVirtual: false);
                                        hierarchyAccountChild.Children.Add(hierarchyAccountGrandChild);
                                    }
                                }
                            }
                        }

                        if (hierarchyAccountVirtualGrandParent != null)
                            hierarchyAccounts.Add(hierarchyAccountVirtualGrandParent);
                        else if (hierarchyAccountVirtualParent != null)
                            hierarchyAccounts.Add(hierarchyAccountVirtualParent);
                        else
                            hierarchyAccounts.Add(hierarchyAccount);
                    }

                    if (!hierarchyDict.ContainsKey(employeeAccountsByEmployee.Key))
                        hierarchyDict.Add(employeeAccountsByEmployee.Key, hierarchyAccounts);
                }
            }

            return hierarchyDict;

            HierarchyAccount CreateHierarchyAccount(EmployeeAccount employeeAccount, AccountDTO account, bool isVirtual = false)
            {
                AccountDimDTO accountDim = account != null ? accountDimsDict.GetValue(account.AccountDimId) : null;

                return new HierarchyAccount()
                {
                    AccountName = account?.Name ?? string.Empty,
                    AccountNr = account?.AccountNr ?? string.Empty,
                    SieDimNr = accountDim?.SysSieDimNr ?? 0,
                    DimNr = accountDim?.AccountDimNr ?? 0,
                    MainAllocation = employeeAccount.MainAllocation,
                    Default = employeeAccount.Default,
                    DateFrom = employeeAccount.DateFrom,
                    DateTo = employeeAccount.DateTo,
                    Virtual = isVirtual,
                    Children = new List<HierarchyAccount>(),
                };
            }
        }

        #endregion

        #region EmployeeIO

        #region Export

        public EmployeeIOItem ExportEmployee(TermGroup_IOSource source, TermGroup_IOType ioType, int actorCompanyId, string employeeNr)
        {
            Employee employee = EmployeeManager.GetEmployeeByNr(employeeNr, actorCompanyId);
            if (employee == null)
                return null;

            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, base.UserId, base.RoleId, employeeFilter: employee.EmployeeId.ObjToList(), loadUser: true);
            if (!employees.Any(a => a.EmployeeId == employee.EmployeeId))
                return null;

            return CreateEmployeeIO(source, ioType, TermGroup_IOImportHeadType.Employee, actorCompanyId, employee);
        }

        public EmployeeIOItem ExportEmployees(TermGroup_IOSource source, TermGroup_IOType ioType, DateTime? lastSynchDate, int actorCompanyId, bool includeInactive = false)
        {
            var active = includeInactive ? (bool?)null : true;

            List<Employee> employees;
            if (lastSynchDate.HasValue)
            {
                employees = EmployeeManager.GetAllEmployeesWithChanges(lastSynchDate.Value, actorCompanyId);
                employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, base.UserId, base.RoleId, active: active, getHidden: false, employeeFilter: employees.GetIds(), loadUser: true);
            }
            else
            {
                employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, base.UserId, base.RoleId, active: active, getHidden: false, loadUser: true);
            }

            return CreateEmployeeIO(source, ioType, TermGroup_IOImportHeadType.Employee, actorCompanyId, employees.ToArray());
        }

        public List<ExistingEmployeeIO> GetExistingEmployeeIOs(int actorCompanyId)
        {
            if (FeatureManager.HasRolePermission(Feature.Time_Employee_Employees_Edit, Permission.Modify, parameterObject.RoleId, actorCompanyId))
            {
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                List<Employee> employeesForUser = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, base.UserId, base.RoleId, getHidden: false, loadEmployeeAccounts: base.UseAccountHierarchyOnCompanyFromCache(entitiesReadOnly, actorCompanyId));
                return BridgeManager.GetExistingEmployeeIOs(actorCompanyId, employeesForUser);
            }
            return new List<ExistingEmployeeIO>();
        }

        #endregion

        #region Import

        public ActionResult ImportEmployees(List<EmployeeIODTO> ios, int actorCompanyId, bool discardLicenseCheckes = false, bool doNotModifyWithEmpty = false, bool doNotModifyRolesWithEmpty = false)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                if (ios == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11890, "Inget data skickades"));

                //Company
                this.company = CompanyManager.GetCompany(entities, actorCompanyId, true);
                if (this.company == null || this.company.License == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(actorCompanyId);
                List<EmployeeGroup> employeeGroups = GetEmployeeGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));

                bool isMathemFix = actorCompanyId == 701609 && DateTime.Today <= new DateTime(2016, 07, 01);
                bool isKullsFix = actorCompanyId == 711071 && DateTime.Today <= new DateTime(2016, 07, 01);
                if (isMathemFix || isKullsFix)
                    doNotModifyWithEmpty = true;

                this.rowNr = 0;

                #endregion

                #region Perform

                foreach (EmployeeIODTO io in ios.Where(i => i.Status == TermGroup_IOStatus.Unprocessed))
                {
                    #region EmployeeIO

                    try
                    {
                        io.Status = TermGroup_IOStatus.UnderProcessing;

                        #region Mathem fix

                        if (isMathemFix || isKullsFix)
                        {
                            //Use EmployeeId if passed, otherwise EmployeeNr
                            Employee employeeMathem = null;
                            if (io.EmployeeId.HasValue && io.EmployeeId.Value > 0)
                                employeeMathem = EmployeeManager.GetEmployee(entities, io.EmployeeId.Value, actorCompanyId, loadEmployment: true, loadContactPerson: true, loadUser: true, onlyActive: false);
                            else
                                employeeMathem = EmployeeManager.GetEmployeeByNr(entities, io.EmployeeNr, actorCompanyId, loadEmployment: true, loadContactPerson: true, loadUser: true, onlyActive: false);

                            if (employeeMathem == null)
                                continue;

                            UpdateAccountsOnEmployee(entities, employeeMathem, io, accountDimInternals, true, useAccountInternalNr: true);

                            #region Save

                            result = SaveChanges(entities);
                            if (result.Success)
                            {
                                io.EmployeeId = employeeMathem.EmployeeId;
                                io.Status = TermGroup_IOStatus.Processed;
                            }
                            else
                            {
                                base.TryDetachEntity(entities, employeeMathem);
                                io.Status = TermGroup_IOStatus.Error;

                                //Save IO
                                result = SaveChanges(entities);
                                if (!result.Success || io.Status == TermGroup_IOStatus.Error)
                                    continue;
                            }

                            itemsUpdated++;

                            #endregion

                            continue;
                        }

                        #endregion

                        #region Init

                        this.rowNr++;

                        #endregion

                        #region Validation

                        #region Mandatory

                        //Validate mandatory values
                        if (String.IsNullOrEmpty(io.EmployeeNr) && !io.EmployeeId.HasValue)
                        {
                            AddWarning(WarningMessageType.MandatoryFieldInvalid, "Anställningsnr");
                            io.Status = TermGroup_IOStatus.Error;
                        }

                        //Use EmployeeId if passed, otherwise EmployeeNr
                        Employee employee = null;
                        if (io.EmployeeId.HasValue && io.EmployeeId.Value > 0)
                            employee = EmployeeManager.GetEmployee(entities, io.EmployeeId.Value, actorCompanyId, loadEmployment: true, loadContactPerson: true, loadUser: true, onlyActive: false);
                        else
                            employee = EmployeeManager.GetEmployeeByNr(entities, io.EmployeeNr, actorCompanyId, loadEmployment: true, loadContactPerson: true, loadUser: true, onlyActive: false);

                        EmployeeGroup employeeGroup = null;
                        if (employee == null)
                        {
                            employeeGroup = GetEmployeeGroup(entities, io.EmployeeGroupName);
                            if (employeeGroup == null)
                            {
                                AddWarning(WarningMessageType.MandatoryFieldInvalid, GetText(4408, "Tidavtal") + ":" + io.EmployeeGroupName);
                                io.Status = TermGroup_IOStatus.Error;
                            }
                        }

                        if (employee == null)
                        {
                            if (String.IsNullOrEmpty(io.FirstName))
                            {
                                AddWarning(WarningMessageType.MandatoryFieldInvalid, "Förnamn");
                                io.Status = TermGroup_IOStatus.Error;
                            }
                            if (String.IsNullOrEmpty(io.LastName))
                            {
                                AddWarning(WarningMessageType.MandatoryFieldInvalid, "EFternamn");
                                io.Status = TermGroup_IOStatus.Error;
                            }
                            if (String.IsNullOrEmpty(io.EmployeeGroupName))
                            {
                                AddWarning(WarningMessageType.MandatoryFieldInvalid, GetText(4408, "Tidavtal"));
                                io.Status = TermGroup_IOStatus.Error;
                            }
                        }

                        //Fix for not overwriting existing Employee's state to default value Active. Temporary is set in io when value is null from import.
                        if (employee != null && io.State == SoeEntityState.Temporary)
                            io.State = (SoeEntityState)employee.State;

                        //Validate Employee
                        if (!discardLicenseCheckes && io.State != SoeEntityState.Inactive)
                        {
                            var employeeStateTransition = employee != null ? GetStateTransition((SoeEntityState)employee.State, io.State) : SoeEntityStateTransition.None;
                            result = LicenseManager.ValidateEmployee(entities, this.company.License, actorCompanyId, employee, io.EmployeeNr, employeeStateTransition: (int)employeeStateTransition);
                            if (!result.Success)
                                io.Status = TermGroup_IOStatus.Error;
                            else if (employee == null)
                                io.State = SoeEntityState.Active;
                        }

                        if (io.Status == TermGroup_IOStatus.Error)
                            continue;

                        #endregion

                        #region Optional

                        bool newEmployee = employee == null;
                        bool currentDoNotModifyWithEmpty = newEmployee ? false : doNotModifyWithEmpty; //Flag newEmployee overrides
                        bool currentDoNotModifyRolesWithEmpty = currentDoNotModifyWithEmpty ? true : doNotModifyRolesWithEmpty; //Flag doNotModifyWithEmpty overrides
                        bool validUserCredentials = !String.IsNullOrEmpty(io.LoginName);

                        //Validate User
                        if (!discardLicenseCheckes && validUserCredentials)
                        {
                            User user = employee?.User;
                            var userStateTransition = user != null ? GetStateTransition((SoeEntityState)user.State, io.State) : SoeEntityStateTransition.None;

                            //Check User (User can be added when Employee already exists)
                            result = LicenseManager.ValidateUser(entities, this.company.License, actorCompanyId, user, io.LoginName, userStateTransition: (int)userStateTransition);
                            if (!result.Success)
                            {
                                AddWarning(WarningMessageType.SaveUserFailedUserAlreadyExists, GetText(1020, "Användarnamn") + ":" + io.LoginName.ToString());
                                validUserCredentials = false;
                            }
                        }

                        //Only valid is: Active or Inactive
                        if (io.State != (int)SoeEntityState.Active && io.State != SoeEntityState.Inactive)
                        {
                            AddWarning(WarningMessageType.OptionalFieldInvalid, String.Format("{0}:{1}", "State", io.State.ToString()));
                            io.State = (int)SoeEntityState.Active;
                        }

                        #endregion

                        #endregion

                        #region Employee

                        if (employee == null)
                        {
                            #region Add

                            //Add Employee
                            employee = new Employee()
                            {
                                EmployeeNr = io.EmployeeNr,

                                //Set FK
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(employee);

                            //Add ContactPerson
                            employee.ContactPerson = new ContactPerson()
                            {
                            };
                            SetCreatedProperties(employee.ContactPerson);

                            //Add Actor
                            employee.ContactPerson.Actor = new Actor()
                            {
                                ActorType = (int)SoeActorType.ContactPerson,
                            };
                            SetCreatedProperties(employee.ContactPerson);

                            //Make sure Actor (Company) is loaded
                            if (!this.company.ActorReference.IsLoaded)
                                this.company.ActorReference.Load();

                            //Map ContactPerson to Company
                            if (employee.ContactPerson.Actors == null)
                                employee.ContactPerson.Actors = new EntityCollection<Actor>();
                            employee.ContactPerson.Actors.Add(this.company.Actor);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(employee);

                            //Make sure ContactPerson is loaded
                            if (!employee.ContactPersonReference.IsLoaded)
                                employee.ContactPersonReference.Load();

                            SetModifiedProperties(employee.ContactPerson);

                            //Make sure Actor (ContactPerson) is loaded
                            if (!employee.ContactPerson.ActorReference.IsLoaded)
                                employee.ContactPerson.ActorReference.Load();
                            SetModifiedProperties(employee.ContactPerson);

                            //Make sure User is loaded
                            if (!employee.UserReference.IsLoaded)
                                employee.UserReference.Load();

                            if (employee.User != null)
                                SetModifiedProperties(employee.User);

                            #endregion
                        }

                        //Optional
                        employee.State = (int)io.State;
                        employee.EmploymentDate = StringUtility.ModifyValue(employee.EmploymentDate, io.EmploymentDate, currentDoNotModifyWithEmpty);
                        employee.EndDate = StringUtility.ModifyValue(employee.EndDate, io.EndDate, currentDoNotModifyWithEmpty);
                        employee.DisbursementMethod = StringUtility.ModifyValue(employee.DisbursementMethod, io.DisbursementMethod, currentDoNotModifyWithEmpty);
                        employee.DisbursementClearingNr = StringUtility.ModifyValue(employee.DisbursementClearingNr, io.DisbursementClearingNr, currentDoNotModifyWithEmpty);
                        employee.DisbursementAccountNr = StringUtility.ModifyValue(employee.DisbursementAccountNr, io.DisbursementAccountNr, currentDoNotModifyWithEmpty);
                        employee.HighRiskProtection = StringUtility.ModifyValue(employee.HighRiskProtection, io.HighRiskProtection, currentDoNotModifyWithEmpty);
                        employee.HighRiskProtectionTo = StringUtility.ModifyValue(employee.HighRiskProtectionTo, io.HighRiskProtectionTo, currentDoNotModifyWithEmpty);
                        employee.MedicalCertificateReminder = StringUtility.ModifyValue(employee.MedicalCertificateReminder, io.MedicalCertificateReminder, currentDoNotModifyWithEmpty);
                        employee.MedicalCertificateDays = StringUtility.ModifyValue(employee.MedicalCertificateDays, io.MedicalCertificateDays, currentDoNotModifyWithEmpty);
                        employee.Absence105DaysExcluded = StringUtility.ModifyValue(employee.Absence105DaysExcluded, io.Absence105DaysExcluded, currentDoNotModifyWithEmpty);
                        employee.Absence105DaysExcludedDays = StringUtility.ModifyValue(employee.Absence105DaysExcludedDays, io.Absence105DaysExcludedDays, currentDoNotModifyWithEmpty);
                        employee.PayrollStatisticsPersonalCategory = StringUtility.ModifyValue(employee.PayrollStatisticsPersonalCategory, io.PayrollStatisticsPersonalCategory, currentDoNotModifyWithEmpty);
                        employee.PayrollStatisticsWorkTimeCategory = StringUtility.ModifyValue(employee.PayrollStatisticsWorkTimeCategory, io.PayrollStatisticsWorkTimeCategory, currentDoNotModifyWithEmpty);
                        employee.PayrollStatisticsSalaryType = StringUtility.ModifyValue(employee.PayrollStatisticsSalaryType, io.PayrollStatisticsSalaryType, currentDoNotModifyWithEmpty);
                        employee.PayrollStatisticsWorkPlaceNumber = StringUtility.ModifyValue(employee.PayrollStatisticsWorkPlaceNumber, io.PayrollStatisticsWorkPlaceNumber, currentDoNotModifyWithEmpty);
                        employee.PayrollStatisticsCFARNumber = StringUtility.ModifyValue(employee.PayrollStatisticsCFARNumber, io.PayrollStatisticsCFARNumber, currentDoNotModifyWithEmpty);
                        employee.WorkPlaceSCB = StringUtility.ModifyValue(employee.WorkPlaceSCB, io.WorkPlaceSCB, currentDoNotModifyWithEmpty);
                        employee.AFACategory = StringUtility.ModifyValue(employee.AFACategory, io.AFACategory, currentDoNotModifyWithEmpty);
                        employee.AFASpecialAgreement = StringUtility.ModifyValue(employee.AFASpecialAgreement, io.AFASpecialAgreement, currentDoNotModifyWithEmpty);
                        employee.AFAWorkplaceNr = StringUtility.ModifyValue(employee.AFAWorkplaceNr, io.AFAWorkplaceNr, currentDoNotModifyWithEmpty);
                        employee.CollectumITPPlan = StringUtility.ModifyValue(employee.CollectumITPPlan, io.CollectumITPPlan, currentDoNotModifyWithEmpty);
                        employee.CollectumCostPlace = StringUtility.ModifyValue(employee.CollectumCostPlace, io.CollectumCostPlace, currentDoNotModifyWithEmpty);
                        employee.CollectumAgreedOnProduct = StringUtility.ModifyValue(employee.CollectumAgreedOnProduct, io.CollectumAgreedOnProduct, currentDoNotModifyWithEmpty);

                        if (!string.IsNullOrEmpty(io.Note) && !employee.Note.NullToEmpty().Trim().ToLower().Contains(io.Note))
                        {
                            if (string.IsNullOrEmpty(employee.Note))
                                employee.Note = io.Note;
                            else
                                employee.Note = string.Concat(employee.Note, Environment.NewLine, Environment.NewLine, io.Note);
                        }

                        //Optional FK
                        employee.TimeDeviationCauseId = GetTimeDeviationCauseId(entities, io.DefaultTimeDeviationCauseName, employee.TimeDeviationCauseId, currentDoNotModifyWithEmpty);
                        employee.TimeCodeId = GetTimeCodeId(entities, io.DefaultTimeCodeName, employee.TimeCodeId, currentDoNotModifyWithEmpty);

                        #endregion

                        #region Employment

                        int? employmentType = io.EmploymentType ?? EmployeeManager.GetCompanyEmploymentTypeByCode(entities, actorCompanyId, io.EmploymentTypeCode)?.EmploymentTypeId;
                        PayrollGroup payrollGroup = GetPayrollGroup(entities, io.PayrollGroupName);
                        VacationGroup vacationGroup = GetVacationGroup(entities, io.VacationGroupName);

                        Employment employment = EmployeeManager.SaveEmployment(entities, employee, employeeGroup, payrollGroup: payrollGroup, vacationGroup: vacationGroup, dateFrom: employee.EmploymentDate, dateTo: employee.EndDate, employmentType: employmentType, workTimeWeek: io.WorkTimeWeek, experienceMonths: io.ExperienceMonths, experienceAgreedOrEstablished: io.ExperienceAgreedOrEstablished, workPlace: io.WorkPlace, doNotModifyWithEmpty: currentDoNotModifyWithEmpty, employeeGroups: employeeGroups);
                        if (employment != null)
                        {
                            if (!TrySaveEmploymentAccountStds(entities, employment, GetImportEmployeeAccounts(entities, io, false), accountDimInternals, doNotModifyWithEmpty))
                                AddWarning(WarningMessageType.SaveAccountsFailed);
                            if (!TryAddEmploymentPriceType(entities, employment, GetImportEmploymentPriceType(io)))
                                AddWarning(WarningMessageType.SaveEmploymentPriceTypeFailed);
                            if (!TryAddEmployeeFactors(entities, employee, GetImportEmployeeFactor(io)))
                                AddWarning(WarningMessageType.SaveEmployeeFactorsFailed);
                            if (!TryAddEmployeePosition(entities, employee, io.EmployeePositionCode))
                                AddWarning(WarningMessageType.SaveEmploymeePositionFailed);
                        }

                        #endregion

                        #region ContactPerson

                        //Mandatory
                        employee.ContactPerson.FirstName = StringUtility.ModifyValue(employee.ContactPerson.FirstName, io.FirstName, currentDoNotModifyWithEmpty);
                        employee.ContactPerson.LastName = StringUtility.ModifyValue(employee.ContactPerson.LastName, io.LastName, currentDoNotModifyWithEmpty);

                        //Optional
                        employee.ContactPerson.SocialSec = StringUtility.ModifyValue(employee.ContactPerson.SocialSec, io.SocialSec, currentDoNotModifyWithEmpty);
                        employee.ContactPerson.Sex = StringUtility.ModifyValue(employee.ContactPerson.Sex, io.Sex, currentDoNotModifyWithEmpty);

                        #endregion

                        #region User

                        if (validUserCredentials)
                        {
                            string name = StringUtility.GetName(io.FirstName, io.LastName, Constants.APPLICATION_NAMESTANDARD);
                            int langId = GetLangId(io.LangId);

                            if (employee.User == null)
                            {
                                var guid = Guid.NewGuid();
                                employee.User = new User()
                                {
                                    Name = name,
                                    LicenseId = this.company.LicenseId,
                                    LoginName = io.LoginName ?? employee?.EmployeeNr ?? name ?? guid.ToString().Substring(1, 11),
                                    idLoginGuid = guid,
                                    IsMobileUser = true,

                                    //Set references
                                    ContactPerson = employee.ContactPerson,
                                };
                                SetCreatedProperties(employee.User);
                            }

                            if (employee.User != null)
                            {
                                //Optional
                                employee.User.Name = string.IsNullOrEmpty(employee.User.Name) ? StringUtility.ModifyValue(employee.User.Name, name, currentDoNotModifyWithEmpty) : employee.User.Name;
                                employee.User.LangId = StringUtility.ModifyValue(employee.User.LangId, langId, currentDoNotModifyWithEmpty);
                                employee.User.Email = StringUtility.ModifyValue(employee.User.Email, io.Email, currentDoNotModifyWithEmpty);
                                if (employee.User.passwordhash == null)
                                    employee.User.passwordhash = LoginManager.GetPasswordHash(employee.User.Name, Path.GetRandomFileName().Replace(".", ""));

                                //Optional FK
                                employee.User.DefaultActorCompanyId = GetDefaultActorCompanyId(entities, io.DefaultCompanyName, this.company.LicenseId, employee.User.DefaultActorCompanyId, currentDoNotModifyWithEmpty);

                                if (!TryAddUserCompanyRoles(entities, employee.User, currentDoNotModifyRolesWithEmpty, io.RoleName1, io.RoleName2, io.RoleName3)) //Specific flag overrideWithEmpty for roles
                                    AddWarning(WarningMessageType.SaveUserCompanyRoleFailed);
                                if (!TryAddUserAttestRoles(entities, employee.User, GetImportAttestRoles(entities, io), currentDoNotModifyWithEmpty))
                                    AddWarning(WarningMessageType.SaveAttestRolesFailed);
                            }
                        }

                        #endregion

                        #region Save

                        result = SaveChanges(entities);
                        if (result.Success)
                        {
                            io.EmployeeId = employee.EmployeeId;
                            io.Status = TermGroup_IOStatus.Processed;
                        }
                        else
                        {
                            base.TryDetachEntity(entities, employee);
                            io.Status = TermGroup_IOStatus.Error;

                            //Save IO
                            result = SaveChanges(entities);
                            if (!result.Success || io.Status == TermGroup_IOStatus.Error)
                                continue;
                        }

                        #endregion

                        #region Save relations

                        Contact contact = null;
                        if (TrySaveContact(entities, employee.ContactPerson.ActorContactPersonId, TermGroup_SysContactType.Employee, ref contact))
                        {
                            if (!TrySaveContactEcom(entities, contact, GetImportEComs(io), currentDoNotModifyWithEmpty).Success)
                                AddWarning(WarningMessageType.SaveEmployeeEcomFailed);
                            if (!TrySaveClosestRelative(entities, contact, GetImportClosestRelatives(io), currentDoNotModifyWithEmpty).Success)
                                AddWarning(WarningMessageType.SaveEmployeeClosestRelativeFailed);
                            if (!TrySaveContactAddresses(entities, contact, GetImportAddresses(io), currentDoNotModifyWithEmpty).Success)
                                AddWarning(WarningMessageType.SaveEmployeeAddressesFailed);
                        }

                        TrySaveEmployeeVacationSE(entities, employee, io);
                        TrySaveCategories(entities, employee.EmployeeId, GetImportCategoryRecords(entities, io), SoeCategoryType.Employee, SoeCategoryRecordEntity.Employee, false);
                        TrySaveEmployeeAccounts(entities, employee.EmployeeId, GetEmployeeAccounts(entities, io), currentDoNotModifyRolesWithEmpty);

                        #endregion

                        //Update counters
                        if (newEmployee)
                            itemsAdded++;
                        else
                            itemsUpdated++;
                    }
                    catch (ArgumentException ax)
                    {
                        //Break import
                        AddTerminationError(TerminationMessageType.FieldMissing, exception: ax);
                        return new ActionResult(false, (int)ActionResultSave.NothingSaved, GetImportFailedMessage());
                    }
                    catch (Exception ex)
                    {
                        AddError(ErrorMessageType.UnkownError, exception: ex);
                        continue;
                    }

                    #endregion
                }

                if (result.Success)
                    result.ErrorMessage = GetImportSuccededMessage(ImportType.Employee);

                #endregion
            }

            return result;
        }

        #endregion

        #region Help-methods

        private EmployeeIOItem CreateEmployeeIO(TermGroup_IOSource source, TermGroup_IOType ioType, TermGroup_IOImportHeadType headType, int actorCompanyId, params Employee[] employees)
        {
            EmployeeIOItem employeeIO = new EmployeeIOItem(source, ioType, TermGroup_IOImportHeadType.Employee, actorCompanyId);

            if (!employees.IsNullOrEmpty())
            {
                DateTime date = DateTime.Today;

                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                var employeeGroups = GetEmployeeGroupsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId));
                var payrollGroups = GetPayrollGroupsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId));
                var employmentTypes = GetEmploymentTypesFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId), TermGroup_Languages.Swedish);
                var timeDeviationCausesDict = TimeDeviationCauseManager.GetTimeDeviationCausesDictDiscardState(actorCompanyId, timeDeviationCauseIds: employees.Where(e => e.TimeDeviationCauseId.HasValue).Select(t => t.TimeDeviationCauseId.Value));
                var timeCodesDict = TimeCodeManager.GetTimeCodesDictDiscardState(entitiesReadOnly, actorCompanyId, ids: employees.Where(e => e.TimeCodeId.HasValue).Select(t => t.TimeCodeId.Value));
                var companyDict = CompanyManager.GetCompaniesDict(entitiesReadOnly, employees.Where(e => e.User != null && e.User.DefaultActorCompanyId.HasValue).Select(e => e.User.DefaultActorCompanyId.Value));
                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                var userCompanyRolesForCompany = base.GetUserCompanyRolesForCompanyFromCache(entities, CacheConfig.Company(actorCompanyId));
                var attestRoleUsersForCompany = base.GetAttestRoleUsersFromCache(entities, CacheConfig.Company(actorCompanyId), module: SoeModule.Time);

                List<CompanyCategoryRecord> companyCategoryRecords = !UseAccountHierarchyOnCompanyFromCache(actorCompanyId) ? CategoryManager.GetCompanyCategoryRecords(entitiesReadOnly, SoeCategoryType.Employee, SoeCategoryRecordEntity.Employee, actorCompanyId) : null;

                foreach (Employee employee in employees)
                {
                    EmployeeIODTO io = new EmployeeIODTO(source, ioType, headType, actorCompanyId);

                    try
                    {
                        #region Employee

                        io.EmployeeId = employee.EmployeeId;
                        io.Created = employee.Created;
                        io.CreatedBy = employee.CreatedBy;
                        io.Modified = employee.Modified;
                        io.ModifiedBy = employee.ModifiedBy;
                        io.State = (SoeEntityState)employee.State;

                        io.EmployeeNr = employee.EmployeeNr;
                        io.EmploymentDate = employee.EmploymentDate ?? employee.GetFirstEmployment()?.DateFrom;
                        io.EndDate = employee.EndDate;
                        io.Note = employee.Note;
                        io.DisbursementMethod = employee.DisbursementMethod;
                        io.DisbursementClearingNr = employee.DisbursementClearingNr;
                        io.DisbursementAccountNr = employee.DisbursementAccountNr;
                        io.DontValidateDisbursementAccountNr = employee.DontValidateDisbursementAccountNr;
                        io.HighRiskProtection = employee.HighRiskProtection;
                        io.HighRiskProtectionTo = employee.HighRiskProtectionTo;
                        io.MedicalCertificateReminder = employee.MedicalCertificateReminder;
                        io.MedicalCertificateDays = employee.MedicalCertificateDays;
                        io.Absence105DaysExcluded = employee.Absence105DaysExcluded;
                        io.Absence105DaysExcludedDays = employee.Absence105DaysExcludedDays;
                        io.PayrollStatisticsPersonalCategory = employee.PayrollStatisticsPersonalCategory;
                        io.PayrollStatisticsWorkTimeCategory = employee.PayrollStatisticsWorkTimeCategory;
                        io.PayrollStatisticsSalaryType = employee.PayrollStatisticsSalaryType;
                        io.PayrollStatisticsWorkPlaceNumber = employee.PayrollStatisticsWorkPlaceNumber;
                        io.PayrollStatisticsCFARNumber = employee.PayrollStatisticsCFARNumber;
                        io.WorkPlaceSCB = employee.WorkPlaceSCB;
                        io.AFACategory = employee.AFACategory;
                        io.AFASpecialAgreement = employee.AFASpecialAgreement;
                        io.AFAWorkplaceNr = employee.AFAWorkplaceNr;
                        io.CollectumITPPlan = employee.CollectumITPPlan;
                        io.CollectumCostPlace = employee.CollectumCostPlace;
                        io.CollectumAgreedOnProduct = employee.CollectumAgreedOnProduct;

                        io.DefaultTimeDeviationCauseName = employee.TimeDeviationCauseId.HasValue ? timeDeviationCausesDict.GetValue(employee.TimeDeviationCauseId.Value) : null;
                        io.DefaultTimeCodeName = employee.TimeCodeId.HasValue ? timeCodesDict.GetValue(employee.TimeCodeId.Value) : null;

                        #endregion

                        #region Employment

                        Employment employment = employee.GetEmployment();
                        if (employment != null)
                        {
                            io.WorkTimeWeek = employment.GetWorkTimeWeek();
                            io.WorkPlace = employment.GetWorkPlace();
                            io.EmploymentType = employment.GetEmploymentType();
                            io.EmploymentTypeCode = employment.GetEmploymentTypeName(employmentTypes);
                            io.EmployeeGroupName = employment.GetEmployeeGroup(DateTime.Today, employeeGroups)?.Name;
                            io.PayrollGroupName = employment.GetPayrollGroup(DateTime.Today, payrollGroups)?.Name;
                            io.VacationGroupName = employment.GetVacationGroup()?.Name;

                            //Categories
                            List<CompanyCategoryRecord> categoryRecords = companyCategoryRecords.GetCategoryRecords(employee.EmployeeId, onlyDefaultCategories: true);
                            if (!categoryRecords.IsNullOrEmpty())
                            {
                                io.SetPrimaryCategories(categoryRecords
                                    .Where(c => c.Category != null && c.Default)
                                    .Select(c => c.Category.Name).Distinct()
                                    .ToList());
                                io.SetSecondaryCategories(categoryRecords
                                    .Where(c => c.Category != null && !c.Default)
                                    .Select(c => c.Category.Name).Distinct()
                                    .ToList());
                            }

                            //Accounting
                            var accounting = EmployeeManager.GetEmploymentAccountCostAndIncome(entitiesReadOnly, employment.EmploymentId, date);
                            if (accounting.Cost != null)
                                io.SetCostAccounting(EmployeeManager.GetAccountStdInfo(accounting.Cost));
                            if (accounting.Income != null)
                                io.SetIncomeAccounting(EmployeeManager.GetAccountStdInfo(accounting.Income));
                        }

                        #endregion

                        #region Contact

                        if (employee.ContactPerson != null)
                        {
                            io.FirstName = employee.ContactPerson.FirstName;
                            io.LastName = employee.ContactPerson.LastName;
                            io.SocialSec = employee.ContactPerson.SocialSec;
                            io.Sex = employee.ContactPerson.Sex;
                        }

                        Contact contact = ContactManager.GetContactFromActor(employee.ContactPersonId, loadAllContactInfo: true);
                        if (contact?.ContactECom != null)
                        {
                            io.Email = contact.ContactECom.GetEComText(TermGroup_SysContactEComType.Email);
                            io.PhoneHome = contact.ContactECom.GetEComText(TermGroup_SysContactEComType.PhoneHome);
                            io.PhoneMobile = contact.ContactECom.GetEComText(TermGroup_SysContactEComType.PhoneMobile);
                            io.PhoneJob = contact.ContactECom.GetEComText(TermGroup_SysContactEComType.PhoneJob);

                            contact.ContactECom.GetClosestRelative(out string closestRelativeNr, out string closestRelativeName, out string closestRelativeRelation);
                            io.ClosestRelativeNr = closestRelativeNr;
                            io.ClosestRelativeName = closestRelativeName;
                            io.ClosestRelativeRelation = closestRelativeRelation;
                        }
                        if (contact?.ContactAddress != null)
                        {
                            var contactAddress = contact?.ContactAddress.GetAddress(TermGroup_SysContactAddressType.Distribution);
                            io.DistributionAddress = contactAddress.GetRowText(TermGroup_SysContactAddressRowType.Address);
                            io.DistributionCoAddress = contactAddress.GetRowText(TermGroup_SysContactAddressRowType.AddressCO);
                            io.DistributionPostalCode = contactAddress.GetRowText(TermGroup_SysContactAddressRowType.PostalCode);
                            io.DistributionPostalAddress = contactAddress.GetRowText(TermGroup_SysContactAddressRowType.PostalAddress);
                            io.DistributionCountry = contactAddress.GetRowText(TermGroup_SysContactAddressRowType.Country);
                        }

                        #endregion

                        #region User

                        if (employee.User != null)
                        {
                            io.LoginName = employee.User.LoginName;
                            io.LangId = employee.User.LangId.HasValue ? GetText(employee.User.LangId.Value, (int)TermGroup.Language) : null;
                            io.DefaultCompanyName = employee.User.DefaultActorCompanyId.HasValue ? companyDict.GetValue(employee.User.DefaultActorCompanyId.Value) : null;
                        }

                        if (employee.UserId.HasValue)
                        {
                            //Roles
                            var userCompanyRoles = userCompanyRolesForCompany.GetByUser(employee.UserId.Value, date, date);
                            io.SetUserRoles(userCompanyRoles
                                .Where(a => a.Role != null)
                                .Select(a => a.Role.Name)
                                .Distinct()
                                .ToList());

                            //AttestRoles
                            var attestRoleUsers = attestRoleUsersForCompany.GetByUser(employee.UserId.Value, date, date);
                            io.SetAttestRoles(attestRoleUsers
                                .Where(a => a.AttestRole != null)
                                .Select(a => a.AttestRole.Name)
                                .Distinct()
                                .ToList());
                        }

                        #endregion
                    }
                    catch (Exception ex)
                    {
                        base.LogError(ex, this.log);
                        io.Status = TermGroup_IOStatus.Error;
                    }

                    employeeIO.EmployeeIOs.Add(io);
                }
            }

            return employeeIO;
        }

        private void UpdateAccountsOnEmployee(CompEntities entities, Employee employee, EmployeeIODTO dto, List<AccountDim> accountDimInternals, bool doNotModifyWithEmpty, bool useAccountInternalNr = false)
        {
            List<Employment> employments = employee.Employment.Where(i => i.State == (int)SoeEntityState.Active).ToList();
            foreach (Employment employment in employments)
            {
                //EmploymentAccountStd
                if (!TrySaveEmploymentAccountStds(entities, employment, GetImportEmployeeAccounts(entities, dto, useAccountInternalNr), accountDimInternals, doNotModifyWithEmpty))
                    AddWarning(WarningMessageType.SaveAccountsFailed);
            }
        }

        #endregion

        #endregion

        #region EmployeeVacation

        #region Import

        public ActionResult ImportEmployeeVacationSEIO(EmployeeVacationSEIOItem employeeVacationSEIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportEmployeeVacationSEFromIO(employeeVacationSEIOItem.employeeVacationSEIOs, actorCompanyId);
        }

        public ActionResult ImportEmployeeVacationSEFromIO(List<EmployeeVacationSEIODTO> employeeVacationSEIODTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            #region Vacation Entity

            using (CompEntities entities = new CompEntities())
            {
                List<PayrollGroup> payrollGroups = GetPayrollGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<VacationGroup> vactionGroups = GetVacationGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));

                foreach (EmployeeVacationSEIODTO employeeVacationSEIODTO in employeeVacationSEIODTOs)
                {
                    // Only update if changed
                    // Always create a new record (setting state to deleted on existing)
                    if (!string.IsNullOrEmpty(employeeVacationSEIODTO.EmployeeNr))
                    {
                        Employee employee = EmployeeManager.GetEmployeeByNr(entities, employeeVacationSEIODTO.EmployeeNr, actorCompanyId, onlyActive: false);
                        if (employee == null)
                            continue;

                        List<EmployeeVacationSE> vacations = EmployeeManager.GetEmployeeVacationSEs(entities, employee.EmployeeId);
                        if (vacations != null)
                        {
                            foreach (EmployeeVacationSE vacation in vacations)
                            {
                                SetModifiedProperties(vacation);
                                vacation.State = (int)SoeEntityState.Deleted;
                            }
                        }

                        int? vacationGroupId = vactionGroups.FirstOrDefault(v => v.Name.Equals(employeeVacationSEIODTO.VacationGroupCode))?.VacationGroupId;
                        if (!vacationGroupId.HasValue)
                        {
                            PayrollGroup payrollGroup = employee.GetPayrollGroup(null, payrollGroups);
                            if (payrollGroup != null)
                            {
                                var payrollgroup = PayrollManager.GetPayrollGroup(entities, payrollGroup.PayrollGroupId, includePayrollGroupVacationGroup: true);
                                if (payrollgroup != null && !payrollgroup.PayrollGroupVacationGroup.IsNullOrEmpty())
                                {
                                    if (payrollgroup.PayrollGroupVacationGroup.Any(p => p.Default))
                                        vacationGroupId = payrollgroup.PayrollGroupVacationGroup.FirstOrDefault(p => p.Default)?.VacationGroupId;
                                    else
                                        vacationGroupId = payrollgroup.PayrollGroupVacationGroup.FirstOrDefault()?.VacationGroupId;
                                }
                            }
                        }

                        EmployeeVacationSE newVacation = new EmployeeVacationSE()
                        {
                            Employee = employee,
                            EarnedDaysPaid = employeeVacationSEIODTO.EarnedDaysPaid,
                            EarnedDaysUnpaid = employeeVacationSEIODTO.EarnedDaysUnpaid,
                            EarnedDaysAdvance = employeeVacationSEIODTO.EarnedDaysAdvance,
                            SavedDaysYear1 = employeeVacationSEIODTO.SavedDaysYear1,
                            SavedDaysYear2 = employeeVacationSEIODTO.SavedDaysYear2,
                            SavedDaysYear3 = employeeVacationSEIODTO.SavedDaysYear3,
                            SavedDaysYear4 = employeeVacationSEIODTO.SavedDaysYear4,
                            SavedDaysYear5 = employeeVacationSEIODTO.SavedDaysYear5,
                            SavedDaysOverdue = employeeVacationSEIODTO.SavedDaysOverdue,

                            UsedDaysPaid = employeeVacationSEIODTO.UsedDaysPaid,
                            PaidVacationAllowance = employeeVacationSEIODTO.PaidVacationAllowance,
                            PaidVacationVariableAllowance = employeeVacationSEIODTO.PaidVacationVariableAllowance,
                            UsedDaysUnpaid = employeeVacationSEIODTO.UsedDaysUnpaid,
                            UsedDaysAdvance = employeeVacationSEIODTO.UsedDaysAdvance,
                            UsedDaysYear1 = employeeVacationSEIODTO.UsedDaysYear1,
                            UsedDaysYear2 = employeeVacationSEIODTO.UsedDaysYear2,
                            UsedDaysYear3 = employeeVacationSEIODTO.UsedDaysYear3,
                            UsedDaysYear4 = employeeVacationSEIODTO.UsedDaysYear4,
                            UsedDaysYear5 = employeeVacationSEIODTO.UsedDaysYear5,
                            UsedDaysOverdue = employeeVacationSEIODTO.UsedDaysOverdue,

                            RemainingDaysPaid = employeeVacationSEIODTO.RemainingDaysPaid,
                            RemainingDaysUnpaid = employeeVacationSEIODTO.RemainingDaysUnpaid,
                            RemainingDaysAdvance = employeeVacationSEIODTO.RemainingDaysAdvance,
                            RemainingDaysYear1 = employeeVacationSEIODTO.RemainingDaysYear1,
                            RemainingDaysYear2 = employeeVacationSEIODTO.RemainingDaysYear2,
                            RemainingDaysYear3 = employeeVacationSEIODTO.RemainingDaysYear3,
                            RemainingDaysYear4 = employeeVacationSEIODTO.RemainingDaysYear4,
                            RemainingDaysYear5 = employeeVacationSEIODTO.RemainingDaysYear5,
                            RemainingDaysOverdue = employeeVacationSEIODTO.RemainingDaysOverdue,

                            EarnedDaysRemainingHoursPaid = employeeVacationSEIODTO.EarnedDaysRemainingHoursPaid,
                            EarnedDaysRemainingHoursUnpaid = employeeVacationSEIODTO.EarnedDaysRemainingHoursUnpaid,
                            EarnedDaysRemainingHoursAdvance = employeeVacationSEIODTO.EarnedDaysRemainingHoursAdvance,
                            EarnedDaysRemainingHoursYear1 = employeeVacationSEIODTO.EarnedDaysRemainingHoursYear1,
                            EarnedDaysRemainingHoursYear2 = employeeVacationSEIODTO.EarnedDaysRemainingHoursYear2,
                            EarnedDaysRemainingHoursYear3 = employeeVacationSEIODTO.EarnedDaysRemainingHoursYear3,
                            EarnedDaysRemainingHoursYear4 = employeeVacationSEIODTO.EarnedDaysRemainingHoursYear4,
                            EarnedDaysRemainingHoursYear5 = employeeVacationSEIODTO.EarnedDaysRemainingHoursYear5,
                            EarnedDaysRemainingHoursOverdue = employeeVacationSEIODTO.EarnedDaysRemainingHoursOverdue,

                            EmploymentRatePaid = employeeVacationSEIODTO.EmploymentRatePaid,
                            EmploymentRateYear1 = employeeVacationSEIODTO.EmploymentRateYear1,
                            EmploymentRateYear2 = employeeVacationSEIODTO.EmploymentRateYear2,
                            EmploymentRateYear3 = employeeVacationSEIODTO.EmploymentRateYear3,
                            EmploymentRateYear4 = employeeVacationSEIODTO.EmploymentRateYear4,
                            EmploymentRateYear5 = employeeVacationSEIODTO.EmploymentRateYear5,
                            EmploymentRateOverdue = employeeVacationSEIODTO.EmploymentRateOverdue,

                            DebtInAdvanceAmount = employeeVacationSEIODTO.DebtInAdvanceAmount,
                            DebtInAdvanceDueDate = employeeVacationSEIODTO.DebtInAdvanceDueDate,
                            DebtInAdvanceDelete = employeeVacationSEIODTO.DebtInAdvanceDelete,

                        };

                        entities.EmployeeVacationSE.AddObject(newVacation);

                        if (vacationGroupId.HasValue && employeeVacationSEIODTO.TotalDaysVacation > 0)
                        {
                            EmployeeFactor totalDaysVacationfactor = new EmployeeFactor();
                            totalDaysVacationfactor.Type = (int)TermGroup_EmployeeFactorType.VacationDaysPaidByLaw;
                            totalDaysVacationfactor.EmployeeId = employee.EmployeeId;
                            totalDaysVacationfactor.FromDate = DateTime.Now.AddYears(-1);
                            totalDaysVacationfactor.VacationGroupId = vacationGroupId.Value;
                            totalDaysVacationfactor.Factor = employeeVacationSEIODTO.TotalDaysVacation;
                            totalDaysVacationfactor.State = (int)SoeEntityState.Active;
                            SetCreatedProperties(totalDaysVacationfactor);
                            entities.EmployeeFactor.AddObject(totalDaysVacationfactor);
                        }

                        if (!vacations.Any())
                        {
                            SetCreatedProperties(newVacation);
                        }
                        else
                        {
                            newVacation.Created = vacations.First().Created;
                            newVacation.CreatedBy = vacations.First().CreatedBy;
                            SetModifiedProperties(newVacation);
                        }
                    }
                }

                entities.SaveChanges();
            }

            #endregion

            return result;
        }

        #endregion

        #endregion

        #region Employment

        #region Import

        public ActionResult ImportEmploymentIO(EmploymentIOItem employmentIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportEmploymentFromIO(employmentIOItem.employmentIOs, actorCompanyId);
        }

        public ActionResult ImportEmploymentFromIO(List<EmploymentIODTO> employmentIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            #region Prereq

            List<EmployeeGroupDTO> employeeGroups = EmployeeManager.GetEmployeeGroups(actorCompanyId, loadExternalCode: true).ToDTOs().ToList();
            List<PayrollGroupDTO> payrollGroups = PayrollManager.GetPayrollGroups(actorCompanyId, loadExternalCode: true).ToDTOs().ToList();
            List<VacationGroup> vacationGroups = PayrollManager.GetVacationGroups(actorCompanyId, onlyActive: false, loadExternalCode: true);
            List<Employee> employees = EmployeeManager.GetAllEmployees(actorCompanyId, active: null);
            Dictionary<int, string> endReasons = EmployeeManager.GetSystemEndReasons(actorCompanyId, includeCompanyEndReasons: true, active: true);
            List<EmploymentTypeDTO> employmentTypes = EmployeeManager.GetEmploymentTypes(actorCompanyId, TermGroup_Languages.Swedish);

            #endregion

            #region Setup ConnectHistory

            ConnectUtil connectUtil = new ConnectUtil(parameterObject);
            ConnectHistoryDTO connectHistory = connectUtil.SetupConnectHistoryDTO(TermGroup_IOImportHeadType.Employment, employmentIOs.Count);

            #endregion

            #region Validate

            string errorMessage = string.Empty;

            foreach (var employmentIO in employmentIOs)
            {
                //Employee
                if (string.IsNullOrEmpty(employmentIO.EmployeeNr) || !employees.Any(c => c.EmployeeNr.ToLower() == employmentIO.EmployeeNr.ToLower()))
                    errorMessage += "Employee not found " + employmentIO.EmployeeNr.ToLower() + Environment.NewLine;

                //EmployeeGroup
                if (!string.IsNullOrEmpty(employmentIO.EmployeeGroupName) && !employeeGroups.Any(c => c.Name.ToLower().Trim() == employmentIO.EmployeeGroupName.ToLower().Trim()))
                    errorMessage += "EmployeeGroup not found " + employmentIO.EmployeeGroupName.ToLower() + Environment.NewLine;

                //EmploymentTypes
                try
                {
                    if (employmentIO.EmploymentType == 0 && !string.IsNullOrEmpty(employmentIO.EmploymentTypeName))
                    {
                        var employmentTypeMatch = employmentTypes.FirstOrDefault(f => f.Name.ToLower().Trim().Equals(employmentIO.EmploymentTypeName.ToLower().Trim())) ?? employmentTypes.FirstOrDefault(f => f.Code.ToLower().Trim().Equals(employmentIO.EmploymentTypeName.ToLower().Trim()));
                        if (employmentTypeMatch != null)
                            employmentIO.EmploymentType = employmentTypeMatch.Type;
                    }
                }
                catch
                {
                    errorMessage += "Invalid EmploymentType" + employmentIO.EmploymentType.ToString() + Environment.NewLine;
                }
            }

            if (string.IsNullOrEmpty(errorMessage))
            {
                foreach (var employmentIOsByEmployeeNr in employmentIOs.GroupBy(e => e.EmployeeNr))
                {
                    string employeeNr = employmentIOsByEmployeeNr.Key.ToLower();

                    int employeeId = 0;
                    if (!string.IsNullOrEmpty(employeeNr) && employees.Any(c => c.EmployeeNr.ToLower().Equals(employeeNr)))
                        employeeId = employees.FirstOrDefault(c => c.EmployeeNr.ToLower().Equals(employeeNr) && !string.IsNullOrEmpty(employeeNr))?.EmployeeId ?? 0;
                    Employee employee = EmployeeManager.GetEmployee(employeeId, actorCompanyId, loadEmployment: true, onlyActive: false);
                    if (employee == null)
                        continue;

                    List<Employment> existingEmployments = employee.GetEmployments(DateTime.Now.AddYears(-100), DateTime.Now.AddYears(100));

                    foreach (EmploymentIODTO employmentIO in employmentIOsByEmployeeNr)
                    {
                        if (employmentIO.IsSecondaryEmployment)
                            continue;

                        try
                        {
                            foreach (Employment existingEmployment in existingEmployments)
                            {
                                bool valid = true;

                                //Check if overlapping
                                if (CalendarUtility.IsDatesOverlappingNullable(employmentIO.DateFrom, employmentIO.DateTo, existingEmployment.DateFrom, existingEmployment.DateTo))
                                {
                                    valid = false;

                                    //If overlapping then dates need to be the same or DateTo be open i xe and closed in new employment
                                    if (employmentIO.DateFrom == existingEmployment.DateFrom && (employmentIO.DateTo == existingEmployment.DateTo || existingEmployment.DateTo == null))
                                        valid = true;

                                    if (!valid && employmentIO.DateFrom == existingEmployment.DateFrom && existingEmployment.DateTo.HasValue && !employmentIO.DateTo.HasValue)
                                    {
                                        employmentIO.DateTo = existingEmployment.DateTo;
                                        valid = true;
                                    }

                                    if (!valid)
                                    {
                                        errorMessage += string.Format("Employments are overlapping, importdates {0} - {1}, existing dates {2} - {3} on employee {4}",
                                                                         employmentIO.DateFrom.ToShortDateString(),
                                                                         employmentIO.DateTo.HasValue ? ((DateTime)employmentIO.DateTo).ToShortDateString() : "infinity",
                                                                         existingEmployment.DateFrom.HasValue ? ((DateTime)existingEmployment.DateFrom).ToShortDateString() : "Beginning of time",
                                                                         existingEmployment.DateTo.HasValue ? ((DateTime)existingEmployment.DateTo).ToShortDateString() : "infinity",
                                                                         employee.EmployeeNrAndName) + Environment.NewLine;
                                    }
                                }
                            }
                        }
                        catch (Exception ex)
                        {
                            errorMessage += $"Invalid data caused exception on validation for {employmentIOsByEmployeeNr.Key}";
                            LogError(ex, log);
                        }
                    }
                }
            }

            if (!string.IsNullOrEmpty(errorMessage))
            {
                result.Success = false;
                result.ErrorMessage = errorMessage;
                connectHistory.Success = false;
                connectHistory.Message = errorMessage;
                connectUtil.SaveConnectHistory(connectHistory);
                return result;
            }

            #endregion

            #region Convert to EmploymentDTO and save

            result.ErrorMessage = string.Empty;

            foreach (var employmentIO in employmentIOs)
            {
                string employmentInfo = $"{employmentIO.EmployeeNr} {employmentIO.DateFrom}";
                try
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                        {
                            List<EmploymentDTO> importedEmployments = new List<EmploymentDTO>();
                            EmploymentDTO employmentToImport = new EmploymentDTO();

                            #region Employee

                            if (!string.IsNullOrEmpty(employmentIO.EmployeeNr) && employees.Any(c => c.EmployeeNr.ToLower().Equals(employmentIO.EmployeeNr.ToLower())))
                            {
                                employmentToImport.EmployeeId = employees.FirstOrDefault(c => c.EmployeeNr.ToLower().Equals(employmentIO.EmployeeNr.ToLower()) && !string.IsNullOrEmpty(employmentIO.EmployeeNr))?.EmployeeId ?? 0;
                            }
                            else
                            {
                                string error = $"{employmentInfo} Error: Employee not found. Moved on to next";
                                result.Success = false;
                                result.ErrorMessage += error;
                                errorMessage += error + Environment.NewLine;
                                continue;
                            }

                            Employee employee = EmployeeManager.GetEmployee(entities, employmentToImport.EmployeeId, actorCompanyId, loadEmployment: true, loadVacationGroup: true, onlyActive: false);
                            if (employee == null)
                                continue;

                            #endregion

                            #region Employments

                            List<Employment> employments = employee.GetEmployments(DateTime.Now.AddYears(-100), DateTime.Now.AddYears(100));
                            if (employments != null && employments.Any(e => e.DateFrom == employmentIO.DateFrom) && !(employmentIO.IsSecondaryEmployment && !employments.FirstOrDefault(e => e.DateFrom == employmentIO.DateFrom).IsSecondaryEmployment))
                            {
                                employmentToImport = employments.FirstOrDefault(e => e.DateFrom == employmentIO.DateFrom).ToDTO();
                                employmentToImport.IsChangingEmployment = true;
                            }
                            else
                            {
                                employmentToImport.IsAddingEmployment = true;
                            }

                            employmentToImport.CurrentChangeDateFrom = employmentIO.DateFrom;

                            #endregion

                            #region EmployeeGroup
                            EmployeeGroupDTO employeeGroup = null;
                            if (!string.IsNullOrEmpty(employmentIO.EmployeeGroupName) && employeeGroups.Any(c => c.Name.ToLower() == employmentIO.EmployeeGroupName.ToLower()))
                            {
                                employeeGroup = !string.IsNullOrEmpty(employmentIO.EmployeeGroupName) ? employeeGroups.FirstOrDefault(c => c.Name.ToLower().Trim() == employmentIO.EmployeeGroupName.ToLower().Trim()) : null;

                                if (employeeGroup == null)
                                    employeeGroup = !string.IsNullOrEmpty(employmentIO.EmployeeGroupName) ? employeeGroups?.FirstOrDefault(f => f.ExternalCodes != null && f.ExternalCodes.Where(w => !string.IsNullOrEmpty(w)).Select(s => s.Trim().ToLower()).Contains(employmentIO.EmployeeGroupName.Trim().ToLower())) : null;


                                if (employeeGroup != null)
                                {
                                    employmentToImport.UpdateEmployeeGroup(employeeGroup.EmployeeGroupId, employeeGroups);
                                }
                                else if (!string.IsNullOrEmpty(employmentIO.EmployeeGroupName))
                                {
                                    string error = $"{employmentInfo} Error: EmployeeGroup not found {employmentIO.EmployeeGroupName}. Moved on to next row" + Environment.NewLine;
                                    if (employmentToImport.EmployeeGroupId != 0)
                                        error = $"{employmentInfo} Error: EmployeeGroup not found {employmentIO.EmployeeGroupName}. Moved on to next column" + Environment.NewLine;
                                    errorMessage += error;
                                    if (employmentToImport.EmployeeGroupId == 0)
                                        continue;
                                }
                            }

                            #endregion

                            #region PayrollGroup

                            if (!string.IsNullOrEmpty(employmentIO.PayrollGroupName) && payrollGroups.Any(c => c.Name.ToLower().ToLower() == employmentIO.PayrollGroupName.ToLower().ToLower()))
                            {
                                PayrollGroupDTO payrollGroup = payrollGroups.FirstOrDefault(c => c.Name.ToLower() == employmentIO.PayrollGroupName.ToLower() && !string.IsNullOrEmpty(employmentIO.PayrollGroupName)) ?? (!string.IsNullOrEmpty(employmentIO.PayrollGroupName) ? payrollGroups?.FirstOrDefault(f => f.ExternalCodes != null && f.ExternalCodes.Where(w => !string.IsNullOrEmpty(w)).Select(s => s.Trim().ToLower()).Contains(employmentIO.PayrollGroupName.Trim().ToLower())) : null);
                                if (payrollGroup != null)
                                    employmentToImport.UpdatePayrollGroup(payrollGroup.PayrollGroupId, payrollGroups);
                                else if (!string.IsNullOrEmpty(employmentIO.PayrollGroupName))
                                {
                                    string error = $"{employmentInfo} Error: PayrollGroup not found {employmentIO.PayrollGroupName}. Moved on to next column" + Environment.NewLine;
                                    errorMessage += error;
                                }
                            }

                            #endregion

                            #region VactionGroup

                            VacationGroup vacationGroup = null;

                            List<EmploymentVacationGroupDTO> employmentVacationGroupDTOs = new List<EmploymentVacationGroupDTO>();
                            if (!string.IsNullOrEmpty(employmentIO.VacationGroupName) && vacationGroups.Any(c => c.Name.ToLower() == employmentIO.VacationGroupName.ToLower()))
                                vacationGroup = vacationGroups.FirstOrDefault(c => c.Name.ToLower().Trim() == employmentIO.VacationGroupName.ToLower().ToLower() && !string.IsNullOrEmpty(employmentIO.VacationGroupName));

                            if (vacationGroup == null)
                                vacationGroup = !string.IsNullOrEmpty(employmentIO.VacationGroupName) ? vacationGroups?.FirstOrDefault(f => f.ExternalCodes != null && f.ExternalCodes.Where(w => !string.IsNullOrEmpty(w)).Select(s => s.Trim().ToLower()).Contains(employmentIO.VacationGroupName.Trim().ToLower())) : null;

                            if (vacationGroup == null && employmentToImport.PayrollGroupId != null)
                            {
                                PayrollGroup payrollgroup = PayrollManager.GetPayrollGroup(entities, (int)employmentToImport.PayrollGroupId, includePayrollGroupVacationGroup: true);
                                if (payrollgroup != null && !payrollgroup.PayrollGroupVacationGroup.IsNullOrEmpty())
                                {
                                    int? vacationGroupId = payrollgroup.PayrollGroupVacationGroup.FirstOrDefault(p => p.Default)?.VacationGroupId ?? payrollgroup.PayrollGroupVacationGroup.FirstOrDefault()?.VacationGroupId;
                                    if (vacationGroupId.HasValue)
                                        vacationGroup = PayrollManager.GetVacationGroup(entities, vacationGroupId.Value);
                                }
                            }

                            if (vacationGroup != null)
                            {
                                EmploymentVacationGroup employmentVacationGroup = null;
                                if (employments != null)
                                {
                                    foreach (Employment employment in employments)
                                    {
                                        employmentVacationGroup = employment.GetCurrentEmploymentVacationGroup(employmentIO.DateFrom);
                                        if (employmentVacationGroup != null)
                                            break;
                                    }
                                }

                                EmploymentVacationGroupDTO employmentVacationGroupDTO = new EmploymentVacationGroupDTO();
                                employmentVacationGroupDTO.VacationGroupId = vacationGroup.VacationGroupId;
                                employmentVacationGroupDTO.FromDate = employmentIO.DateFrom;
                                employmentVacationGroupDTO.Name = vacationGroup.Name;
                                employmentVacationGroupDTO.Type = vacationGroup.Type;
                                employmentVacationGroupDTO.State = SoeEntityState.Active;
                                employmentVacationGroupDTO.EmploymentVacationGroupId = employmentVacationGroup?.EmploymentVacationGroupId ?? 0;
                                employmentVacationGroupDTOs.Add(employmentVacationGroupDTO);
                            }
                            else if (!string.IsNullOrEmpty(employmentIO.VacationGroupName))
                            {
                                string error = $"{employmentInfo} Error: VacationGroup not found {employmentIO.VacationGroupName}. Moved on to next column" + Environment.NewLine;
                                errorMessage += error;
                            }

                            #endregion

                            #region Set values

                            employmentToImport.ActorCompanyId = actorCompanyId;
                            employmentToImport.Comment = employmentIO.Comment;
                            employmentToImport.UpdateDateFrom(employmentIO.DateFrom);
                            if (employmentIO.DateTo.HasValue)
                            {
                                if (employmentToImport.DateTo.HasValue && employmentToImport.DateTo == employmentIO.DateTo)
                                    employmentToImport.IsChangingEmploymentDates = true;

                                employmentToImport.UpdateDateTo(employmentIO.DateTo);
                            }
                            if (employmentIO.Percent != 0)
                                employmentToImport.UpdatePercent(employmentIO.Percent);
                            employmentToImport.UpdateSpecialConditions(employmentIO.SpecialConditions);
                            employmentToImport.UpdateWorkPlace(employmentIO.WorkPlace);
                            employmentToImport.UpdateBaseWorkTimeWeek(employmentIO.BaseWorkTimeWeek);
                            employmentToImport.UpdateEmploymentType(employmentIO.EmploymentType, employmentTypes);


                            if (!employmentVacationGroupDTOs.IsNullOrEmpty())
                            {
                                if (employmentToImport.EmploymentVacationGroup == null)
                                    employmentToImport.EmploymentVacationGroup = new List<EmploymentVacationGroupDTO>();

                                if (employmentToImport.EmploymentVacationGroup.Any(a => a.FromDate == employmentIO.DateFrom && a.VacationGroupId != vacationGroup.VacationGroupId))
                                    employmentToImport.EmploymentVacationGroup.Where(a => a.FromDate == employmentIO.DateFrom && a.VacationGroupId != vacationGroup.VacationGroupId).ToList().ForEach(f => f.State = SoeEntityState.Deleted);

                                employmentToImport.EmploymentVacationGroup.AddRange(employmentVacationGroupDTOs);
                            }

                            employmentToImport.Comment = employmentIO.Comment;

                            if (employmentIO.WorkTimeWeek != 0)
                                employmentToImport.UpdateWorkTimeWeek(employmentIO.WorkTimeWeek, employeeGroup, true);

                            if (employmentIO.ExperienceMonths != 0)
                                employmentToImport.UpdateExperienceMonths(employmentIO.ExperienceMonths);

                            if (employmentIO.ExperienceAgreedOrEstablished)
                                employmentToImport.UpdateExperienceAgreedOrEstablished(employmentIO.ExperienceAgreedOrEstablished, GetText(11707, "Överrenskommen"), GetText(11708, "Konstaterad"));

                            if (!employmentIO.WorkTasks.IsNullOrEmpty())
                                employmentToImport.UpdateWorkTasks(employmentIO.WorkTasks);

                            if (!employmentIO.SubstituteFor.IsNullOrEmpty())
                                employmentToImport.UpdateSubstituteFor(employmentIO.SubstituteFor);

                            if (!employmentIO.ExternalCode.IsNullOrEmpty())
                                employmentToImport.UpdateExternalCode(employmentIO.ExternalCode);

                            if (!employmentIO.IsSecondaryEmployment)
                                employmentToImport.UpdateIsSecondaryEmployment(employmentIO.IsSecondaryEmployment);

                            if (!employmentIO.SubstituteForDueTo.IsNullOrEmpty())
                                employmentToImport.UpdateSubstituteForDueTo(employmentIO.SubstituteForDueTo);

                            if (employmentIO.UpdateExperienceMonthsReminder)
                                employmentToImport.UpdateExperienceMonthsReminder = employmentIO.UpdateExperienceMonthsReminder;

                            if (!string.IsNullOrEmpty(employmentIO.EmploymentEndReasonName))
                            {
                                var endReason = endReasons.Where(c => c.Value.Trim().ToLower() == employmentIO.EmploymentEndReasonName.Trim().ToLower());
                                if (endReason.Any())
                                    employmentToImport.UpdateEmploymentEndReason(endReason.First().Key, endReasons);
                            }
                            else if (employmentIO.EmploymentEndReason != 0)
                            {
                                var endReason = endReasons.Where(c => c.Key == employmentIO.EmploymentEndReason);
                                if (!endReason.Any())
                                    employmentToImport.UpdateEmploymentEndReason(endReason.First().Key, endReasons);
                            }


                            #endregion

                            #region Adjust Employment

                            //Check if we need to adjust employment in order not to make them overlap
                            if (employments.Any(e => !e.DateTo.HasValue))
                            {
                                //Find first date of employments beeing imported
                                DateTime firstDate = employmentIOs.Where(e => e.EmployeeNr.ToLower() == employmentIO.EmployeeNr.ToLower()).OrderBy(e => e.DateFrom).FirstOrDefault().DateFrom;
                                if (firstDate > employments.FirstOrDefault(e => !e.DateTo.HasValue)?.DateFrom)
                                {
                                    //Add endDate to old employment with no DateTo
                                    Employment firstEmployment = employments.FirstOrDefault(e => !e.DateTo.HasValue);
                                    EmploymentDTO firstEmploymentDTO = ActorManager.GetEmployments(employee.EmployeeId, actorCompanyId).FirstOrDefault(e => e.EmploymentId == firstEmployment?.EmploymentId);
                                    if (firstEmploymentDTO != null)
                                    {
                                        firstEmploymentDTO.DateTo = firstDate.AddDays(-1);
                                        importedEmployments.Add(firstEmploymentDTO);
                                    }
                                }
                            }

                            #endregion

                            #region Save Employments

                            importedEmployments.Add(employmentToImport);

                            result = EmployeeManager.SaveEmployments(entities, transaction, employee, importedEmployments, doDeleteVacationGroups: false);
                            if (result.Success)
                                transaction.Complete();

                            #endregion

                            #region ConnectHistory

                            foreach (EmploymentDTO importedEmployment in importedEmployments)
                            {
                                Employment employment = employee.GetEmployment(importedEmployment.DateFrom);
                                if (employment != null)
                                    connectHistory.ConnectHistoryRowDTOs.Add(connectUtil.SetupConnectHistoryRowDTO(employment.Created, employment.Modified, employment.EmploymentId, employmentIO.EmployeeNr, employmentIO.DateFrom.ToString()));
                            }

                            #endregion
                        }
                    }
                }
                catch (Exception ex)
                {
                    string error = $"Invalid data caused exception on {employmentIO.EmployeeNr} {employmentIO.DateFrom}" + Environment.NewLine;
                    errorMessage += error;
                    LogError(ex, log);
                    result.Success = false;
                    result.ErrorMessage += error;
                }
            }

            #endregion

            if (!string.IsNullOrEmpty(errorMessage))
            {
                result.Success = false;
                result.ErrorMessage += errorMessage;
            }

            return result;
        }

        #endregion

        #endregion

        #region ChecklistIO

        public ActionResult ImportChecklistIO(ChecklistIOItem checklistIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromChecklistIO(checklistIOItem.checklistIOs, actorCompanyId);
        }

        public ActionResult ImportFromChecklistIO(List<ChecklistHeadIODTO> checklistIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            foreach (var head in checklistIOs)
            {
                ChecklistHeadDTO headDTO = new ChecklistHeadDTO();

                headDTO.ActorCompanyId = actorCompanyId;
                headDTO.Name = head.Name;
                headDTO.Description = head.Description;
                headDTO.Type = head.Type != 0 ? (TermGroup_ChecklistHeadType)head.Type : TermGroup_ChecklistHeadType.Order;
                headDTO.ChecklistRows = new List<ChecklistRowDTO>();

                int rowNr = 1;

                foreach (var row in head.ChecklistRows)
                {
                    ChecklistRowDTO rowDTO = new ChecklistRowDTO();
                    rowNr = row.RowNr != 0 ? row.RowNr : rowNr;

                    rowDTO.RowNr = rowNr;
                    rowDTO.Type = row.Type != 0 && row.Type < 5 ? (TermGroup_ChecklistRowType)head.Type : TermGroup_ChecklistRowType.String;
                    rowDTO.Text = row.Text;
                    rowDTO.Mandatory = row.Mandatory;
                    headDTO.ChecklistRows.Add(rowDTO);

                    rowNr++;
                }

                ActionResult saveResult = ChecklistManager.SaveChecklistHead(headDTO, actorCompanyId);

                if (saveResult.Success)
                    nbrOfSaved++;
            }

            result.IntegerValue = nbrOfSaved;

            return result;
        }

        #endregion

        #region CompanyInformationIO

        public ActionResult ImportCompanyInformationIO(CompanyInformationIOItem companyInformationIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, List<string> originalContent = null)
        {
            return ImportCompanyInformationFromIO(companyInformationIOItem.companyInformationIOs, actorCompanyId, originalContent);
        }

        public ActionResult ImportCompanyInformationFromIO(List<CompanyInformationIODTO> companyInformationIODTOs, int actorCompanyId, List<string> originalContent = null)
        {
            #region Prereq

            List<ContactAddress> deliveryAddresses = ContactManager.GetContactAddresses(actorCompanyId, TermGroup_SysContactAddressType.Delivery, false);
            List<ContactAddress> billingAddresses = ContactManager.GetContactAddresses(actorCompanyId, TermGroup_SysContactAddressType.Billing, false);
            List<ContactAddress> distributionAddresses = ContactManager.GetContactAddresses(actorCompanyId, TermGroup_SysContactAddressType.Distribution, false);
            List<ContactAddress> visitingAddresses = ContactManager.GetContactAddresses(actorCompanyId, TermGroup_SysContactAddressType.Visiting, false);

            //The format is for multiple companies but we will only import to FirstOrDefault
            CompanyInformationIODTO ioDTO = companyInformationIODTOs.FirstOrDefault();
            if (ioDTO == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CompanyInformation");

            //Save company details
            Company company = CompanyManager.GetCompany(actorCompanyId, false, true);
            company.ActorCompanyId = actorCompanyId;
            company.Name = company.Name ?? ioDTO.CompanyName;
            company.OrgNr = ioDTO.OrgNr;
            company.CompanyNr = company.CompanyNr == null ? Convert.ToInt32(ioDTO.CompanyNumber) : company.CompanyNr;
            company.ShortName = string.IsNullOrEmpty(company.ShortName) ? !string.IsNullOrEmpty(ioDTO.CompanyShortName) ? ioDTO.CompanyShortName : StringUtility.Left(ioDTO.CompanyName, 10) : company.ShortName;
            company.VatNr = string.IsNullOrEmpty(company.VatNr) ? ioDTO.VatNr : company.VatNr;
            company.SysCountryId = (int)TermGroup_Country.SE;

            ActionResult result = CompanyManager.UpdateCompany(company);
            if (!result.Success)
                return result;

            #endregion

            #region SOPSettings

            if (!originalContent.IsNullOrEmpty())
            {
                using (CompEntities entities = new CompEntities())
                {
                    SOPPP sOPPP = new SOPPP(parameterObject);
                    result = sOPPP.CreateSettingsFromSOP(entities, originalContent.FirstOrDefault(), actorCompanyId);
                    if (!result.Success)
                        return result;
                }

                using (CompEntities entities = new CompEntities())
                {
                    SOPPP sOPPP = new SOPPP(parameterObject);
                    result = sOPPP.CheckVatCodes(entities, originalContent.FirstOrDefault(), actorCompanyId);
                    if (!result.Success)
                        return result;
                }
            }

            #endregion

            try
            {
                #region PaymentInformation

                if (!string.IsNullOrEmpty(ioDTO.BgNumber))
                {
                    using (CompEntities entities = new CompEntities())
                        CreatePaymentInformation(entities, ioDTO.BgNumber, true, TermGroup_SysPaymentType.BG, SoeOriginType.None, actorCompanyId);
                }

                if (!string.IsNullOrEmpty(ioDTO.PgNumber))
                {
                    using (CompEntities entities = new CompEntities())
                        CreatePaymentInformation(entities, ioDTO.PgNumber, true, TermGroup_SysPaymentType.PG, SoeOriginType.None, actorCompanyId);
                }

                if (!string.IsNullOrEmpty(ioDTO.BankNumber))
                {
                    using (CompEntities entities = new CompEntities())
                        CreatePaymentInformation(entities, ioDTO.BankNumber, true, TermGroup_SysPaymentType.Bank, SoeOriginType.None, actorCompanyId);
                }

                if (!string.IsNullOrEmpty(ioDTO.IbanNumber))
                {
                    string number = ioDTO.IbanNumber;

                    if (!string.IsNullOrEmpty(ioDTO.BicNumber))
                        number = ioDTO.BicNumber + " / " + ioDTO.IbanNumber;

                    number = number.Replace(" ", "");

                    using (CompEntities entities = new CompEntities())
                        CreatePaymentInformation(entities, number, true, TermGroup_SysPaymentType.BIC, SoeOriginType.None, actorCompanyId);
                }

                #endregion

                #region Contact

                if (ContactManager.GetContactFromActor(actorCompanyId, false, false) == null)
                    ContactManager.SaveContact(actorCompanyId);

                //Save addresses
                if (!string.IsNullOrEmpty(ioDTO.BillingAddress))
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        // Check if it already exists
                        if (!billingAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, ioDTO.BillingAddress))
                            result = AddActorAddress(entities, TermGroup_SysContactAddressType.Billing, actorCompanyId, ioDTO.BillingAddress, ioDTO.BillingPostalAddress, ioDTO.BillingCoAddress, ioDTO.BillingPostalCode, ioDTO.BillingCountry, "");
                    }
                }


                if (!string.IsNullOrEmpty(ioDTO.DeliveryAddress))
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        // Check if it already exists
                        if (!deliveryAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, ioDTO.DeliveryAddress))
                            result = AddActorAddress(entities, TermGroup_SysContactAddressType.Delivery, actorCompanyId, ioDTO.DeliveryAddress, ioDTO.DeliveryPostalAddress, ioDTO.DeliveryCoAddress, ioDTO.DeliveryPostalCode, ioDTO.DeliveryCountry, "");
                    }

                }

                if (!string.IsNullOrEmpty(ioDTO.VisitingAddress))
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        // Check if it already exists
                        if (!visitingAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, ioDTO.VisitingAddress))
                            result = AddActorAddress(entities, TermGroup_SysContactAddressType.Visiting, actorCompanyId, ioDTO.VisitingAddress, ioDTO.VisitingPostalAddress, ioDTO.VisitingCoAddress, ioDTO.VisitingPostalCode, ioDTO.VisitingCountry, "");
                    }
                }


                if (!string.IsNullOrEmpty(ioDTO.DistributionAddress))
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        // Check if it already exists
                        if (!distributionAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, ioDTO.DistributionAddress))
                            result = AddActorAddress(entities, TermGroup_SysContactAddressType.Distribution, actorCompanyId, ioDTO.DistributionAddress, ioDTO.DistributionPostalAddress, ioDTO.DistributionCoAddress, ioDTO.DistributionPostalCode, ioDTO.DistributionCountry, "");
                    }
                }

                if (!string.IsNullOrEmpty(ioDTO.BoardHQAddress))
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        // Check if it already exists
                        if (!distributionAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, ioDTO.BoardHQAddress))
                            result = AddActorAddress(entities, TermGroup_SysContactAddressType.BoardHQ, actorCompanyId, "", ioDTO.BoardHQAddress, "", "", ioDTO.BoardHQCountry, "");
                    }
                }

                using (CompEntities entities = new CompEntities())
                {
                    var contact = ContactManager.GetContactFromActor(entities, actorCompanyId, false, false);

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {

                        //Email1
                        if (!string.IsNullOrEmpty(ioDTO.Email1))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.Email, ioDTO.Email1, transaction, true);
                        //Email2
                        if (!string.IsNullOrEmpty(ioDTO.Email2))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.Email, ioDTO.Email2, transaction, true);
                        //PhoneJob
                        if (!string.IsNullOrEmpty(ioDTO.PhoneJob))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.PhoneJob, ioDTO.PhoneJob, transaction, true);
                        //PhoneHome
                        if (!string.IsNullOrEmpty(ioDTO.PhoneHome))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.PhoneHome, ioDTO.PhoneHome, transaction, true);
                        //PhoneMobile
                        if (!string.IsNullOrEmpty(ioDTO.PhoneMobile))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.PhoneMobile, ioDTO.PhoneMobile, transaction, true);
                        //Fax
                        if (!string.IsNullOrEmpty(ioDTO.Fax))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.Fax, ioDTO.Fax, transaction, true);
                        //Webpage
                        if (!string.IsNullOrEmpty(ioDTO.Webpage))
                            ContactManager.AddContactECom(entities, contact, (int)TermGroup_SysContactEComType.Web, ioDTO.Webpage, transaction, true);

                        if (result.Success)
                            transaction.Complete();
                    }

                }

                #endregion
            }
            catch
            {
                result.Success = false;
                return result;
            }

            return result;
        }

        public ActionResult CreatePaymentInformation(CompEntities entities, string paymentNr, bool isDefault, TermGroup_SysPaymentType sysPaymentType, SoeOriginType originType, int actorCompanyId, PaymentInformation paymentInformation = null)
        {
            ActionResult result = new ActionResult();

            List<PaymentInformationRow> infoRows = PaymentManager.GetPaymentInformationRowsForActor(entities, actorCompanyId);
            PaymentInformationRow infoRow = new PaymentInformationRow();

            foreach (var row2 in infoRows)
            {
                if (row2.SysPaymentTypeId == (int)sysPaymentType && !string.IsNullOrEmpty(row2.PaymentNr))
                {
                    result.Success = false;
                    return result;
                }
            }

            infoRow.PaymentNr = paymentNr;
            infoRow.Default = isDefault;
            infoRow.SysPaymentTypeId = (int)sysPaymentType;
            SetCreatedProperties(infoRow, null);

            Actor actor = ActorManager.GetActor(entities, actorCompanyId, false);

            if (actor == null)
            {
                result.Success = false;
                return result;
            }
            else
            {
                PaymentInformation info = PaymentManager.GetPaymentInformationFromActor(entities, actor.ActorId, false, false);

                if (info == null)
                {
                    info = new PaymentInformation();
                    info.DefaultSysPaymentTypeId = (int)sysPaymentType;
                    info.Actor = actor;
                    info.State = (int)SoeEntityState.Active;

                    entities.PaymentInformation.AddObject(info);
                }

                info.PaymentInformationRow.Add(infoRow);
                SetCreatedProperties(info, null);
            }

            try
            {
                entities.SaveChanges();
            }
            catch (Exception ex)
            {
                LogError(ex.InnerException, this.log);
                result.Success = false;
            }

            return result;
        }

        #endregion

        #region ContactIO

        #region Import to ContactIO

        #endregion

        #endregion

        #region GeneralLedgerIO

        public GeneralLedgerIO ImportGeneralLedgerIO(GeneralLedgerParams filterParams)
        {
            var accountYears = AccountManager.GetAccountYears(this.ActorCompanyId, false, filterParams.FromDate, filterParams.ToDate);
            if (accountYears.Count == 0)
                throw new Exception("Financial year not found for selected date range.");
            if (accountYears.Count > 1)
                throw new Exception("Selected date range is in multiple financial years.");

            var generalLedgerResult = new GeneralLedgerIO();
            var accountYear = accountYears[0];

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<AccountStd> accountStdsForCompany = AccountManager.GetAccountStdsByCompany(entitiesReadOnly, base.ActorCompanyId, null, false, true);
            var vourcherRows = VoucherManager.GetVoucherRowsQuery(entitiesReadOnly, ActorCompanyId, accountYear.AccountYearId)
                                    .Include("VoucherHead.VoucherSeries.VoucherSeriesType")
                                    .Include("AccountInternal.Account.AccountDim")
                                    .Include("AccountStd.Account.AccountDim")
                                    .Where(vr => vr.VoucherHead.Template == false);

            var ingoingVourcherRows = vourcherRows.Where(vr => vr.VoucherHead.Date >= accountYear.From && vr.VoucherHead.Date < filterParams.FromDate);
            var transactionsVouchers = vourcherRows.Where(vr => vr.VoucherHead.Date >= filterParams.FromDate && vr.VoucherHead.Date <= filterParams.ToDate);

            //Load AccountYear Opening balances
            var accountYearOpeningBalances = AccountBalanceManager(ActorCompanyId).GetAccountYearBalanceHeads(accountYear.AccountYearId, base.ActorCompanyId);

            //Load Ingoing Balances
            var ingoingBalances = (from vr in ingoingVourcherRows
                                   select new AccountBalanceSumIO
                                   {
                                       AccountStd = new AccountStdIO
                                       {
                                           Id = vr.AccountStd.AccountId,
                                           Nr = vr.AccountStd.Account.AccountNr,
                                           DimId = vr.AccountStd.Account.AccountDim.AccountDimId,
                                           DimNr = vr.AccountStd.Account.AccountDim.AccountDimNr.ToString(),
                                           Unit = vr.AccountStd.Unit
                                       },
                                       SubSums = new List<AccountBalancePartIO>
                                        {
                                            new AccountBalancePartIO
                                            {
                                                InternalAccounts = vr.AccountInternal.Select(x => new AccountIO
                                                {
                                                    Id = x.Account.AccountId,
                                                    Nr = x.Account.AccountNr,
                                                    DimId = x.Account.AccountDim.AccountDimId,
                                                    DimNr = x.Account.AccountDim.AccountDimNr.ToString()
                                                }).ToList(),
                                                Amount = vr.Amount,
                                                Quantity = vr.Quantity ?? 0.0m
                                            }
                                        }
                                   }).ToList();

            generalLedgerResult.IngoingBalances = ingoingBalances.GroupBy(x => new { accountId = x.AccountStd.Id }).Select(y => new AccountBalanceSumIO
            {
                AccountStd = y.Select(x => x.AccountStd).First(),
                SubSums = y.SelectMany(z => z.SubSums).ToList(),
                Quantity = y.SelectMany(z => z.SubSums).Sum(a => a.Quantity),
                Amount = y.SelectMany(z => z.SubSums).Sum(a => a.Amount),
            }).ToList();

            var avaialbleAccountIds = generalLedgerResult.IngoingBalances.Select(x => x.AccountStd.Id).ToList();
            var accountStdsNotAval = accountStdsForCompany
                                        .Where(x => !avaialbleAccountIds.Contains(x.AccountId))
                                        .Select(x => new AccountBalanceSumIO
                                        {
                                            AccountStd = new AccountStdIO
                                            {
                                                Id = x.AccountId,
                                                Nr = x.Account.AccountNr,
                                                DimId = x.Account.AccountDim.AccountDimId,
                                                DimNr = x.Account.AccountDim.AccountDimNr.ToString(),
                                                Unit = x.Unit
                                            },
                                            SubSums = new List<AccountBalancePartIO>(),
                                            Amount = 0,
                                            Quantity = 0
                                        }).ToList();
            generalLedgerResult.IngoingBalances = generalLedgerResult.IngoingBalances.Concat(accountStdsNotAval).ToList();

            //Adding opening balances  to IngoingBalances
            var accountYearOpeningBalancesGrp = accountYearOpeningBalances
                                                .GroupBy(x => x.AccountStd.AccountId)
                                                .ToList();

            generalLedgerResult.IngoingBalances.ForEach(ib =>
            {
                var ob = accountYearOpeningBalancesGrp.FirstOrDefault(o => o.Key == ib.AccountStd.Id);
                if (ob != null)
                {
                    ib.Amount += ob.Sum(x => x.Balance);
                    ib.Quantity += ob.Sum(x => x.Quantity ?? 0.0m);

                    var internalAccountsGrp = ob.GroupBy(x => x.AccountYearBalanceHeadId);
                    if (!internalAccountsGrp.IsNullOrEmpty())
                    {
                        var accountBalancePart = internalAccountsGrp.Select(aig => new AccountBalancePartIO
                        {
                            InternalAccounts = aig.SelectMany(x => x.AccountInternal).Select(x => new AccountIO
                            {
                                Id = x.AccountId,
                                Nr = x.Account.AccountNr,
                                DimId = x.Account.AccountDimId,
                                DimNr = x.Account.AccountDim.AccountDimNr.ToString()
                            }).ToList(),
                            Amount = aig.Sum(x => x.Balance),
                            Quantity = aig.Sum(x => x.Quantity ?? 0.0m)
                        });
                        ib.SubSums.AddRange(accountBalancePart);
                    }
                }
            });

            //Load Transactions
            var transactions = transactionsVouchers
                                    .Select(x => new AccountTransactionsIO
                                    {
                                        AccountStd = new AccountStdIO
                                        {
                                            Id = x.AccountStd.AccountId,
                                            Nr = x.AccountStd.Account.AccountNr,
                                            DimId = x.AccountStd.Account.AccountDim.AccountDimId,
                                            DimNr = x.AccountStd.Account.AccountDim.AccountDimNr.ToString(),
                                            Unit = x.AccountStd.Unit
                                        },
                                        Transactions = new List<TransactionIO>
                                        {
                                            new TransactionIO()
                                            {
                                                VoucherId = x.VoucherHead.VoucherHeadId,
                                                VoucherNr = (int)x.VoucherHead.VoucherNr,
                                                VoucherRowId = x.VoucherRowId,
                                                Date = x.Date,
                                                VoucherSeriesType = new VoucherSeriesTypeIO
                                                {
                                                    Id = x.VoucherHead.VoucherSeries.VoucherSeriesType.VoucherSeriesTypeId,
                                                    Nr = x.VoucherHead.VoucherSeries.VoucherSeriesType.VoucherSeriesTypeNr.ToString(),
                                                    Name = x.VoucherHead.VoucherSeries.VoucherSeriesType.Name,
                                                },
                                                InternalAccounts = x.AccountInternal.Select(ai => new AccountIO
                                                {
                                                    Id = ai.Account.AccountId,
                                                    Nr = ai.Account.AccountNr,
                                                    DimId = ai.Account.AccountDim.AccountDimId,
                                                    DimNr = ai.Account.AccountDim.AccountDimNr.ToString()
                                                }).ToList(),
                                                Amount = x.Amount,
                                                Quantity = x.Quantity ?? 0.0m
                                            }
                                        }
                                    }).ToList();

            generalLedgerResult.AccountTransactions = transactions.GroupBy(x => new { accountId = x.AccountStd.Id }).Select(y => new AccountTransactionsIO
            {
                AccountStd = y.Select(x => x.AccountStd).First(),
                Transactions = y.SelectMany(z => z.Transactions).ToList(),
                Amount = y.SelectMany(z => z.Transactions).Sum(a => a.Amount),
                Quantity = y.SelectMany(z => z.Transactions).Sum(a => a.Quantity),
            }).ToList();

            //Load Outgoing Transactions
            var transactionSummary = generalLedgerResult.AccountTransactions.Select(x => new AccountBalanceSumIO
            {
                AccountStd = x.AccountStd,
                SubSums = x.Transactions.Select(y => new AccountBalancePartIO
                {
                    InternalAccounts = y.InternalAccounts,
                    Amount = y.Amount,
                    Quantity = y.Quantity
                }).ToList(),
                Amount = x.Amount,
                Quantity = x.Quantity
            }).ToList();

            transactionSummary = transactionSummary.Concat(generalLedgerResult.IngoingBalances).ToList();

            generalLedgerResult.OutgoingBalances = transactionSummary
                                                    .GroupBy(x => new { accountId = x.AccountStd.Id })
                                                    .Select(y =>
                                                    {
                                                        var subSums = y.SelectMany(z => z.SubSums)
                                                                        .GroupBy(x => new { Ids = x.InternalAccounts.Select(z => z.Id).JoinToString(",") })
                                                                        .Select(a => new AccountBalancePartIO
                                                                        {
                                                                            InternalAccounts = a.SelectMany(z => z.InternalAccounts)
                                                                                                    .GroupBy(a1 => a1.Nr)
                                                                                                    .Select(a2 => a2.First())
                                                                                                    .ToList(),
                                                                            Amount = a.Sum(b => b.Amount),
                                                                            Quantity = a.Sum(b => b.Quantity)
                                                                        }).ToList();
                                                        return new AccountBalanceSumIO
                                                        {
                                                            AccountStd = y.Select(x => x.AccountStd).First(),
                                                            SubSums = subSums,
                                                            Quantity = subSums.Sum(a => a.Quantity),
                                                            Amount = subSums.Sum(a => a.Amount),
                                                        };
                                                    }).ToList();

            if (!filterParams.IncludeTransactions)
                generalLedgerResult.AccountTransactions = Enumerable.Empty<AccountTransactionsIO>().ToList();

            return generalLedgerResult;
        }

        #endregion

        #region CustomerIO

        #region Import to CustomerIO

        public ActionResult ImportCustomerIO(CustomerIOItem customerIOItem, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, string specialFunctionalities, bool importToCustomer, bool isAutomasterImport = false)
        {
            var result = new ActionResult();
            var customerIOs = new List<CustomerIO>();

            #region Init

            string batchId = GenerateBatchId();

            #endregion

            using (var entities = new CompEntities())
            {
                try
                {
                    //Get AccountDims
                    var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(1, actorCompanyId);
                    var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(6, actorCompanyId);

                    foreach (var customer in customerIOItem.Customers)
                    {
                        CustomerIO customerIO = CreateCustomerIO(headType, source, type, customer, batchId, actorCompanyId, accountSiedim1, accountSiedim6);
                        if (customerIO != null)
                        {
                            //Api extra fields....
                            customerIO.GlnNbrs = customer.GLNNbrs;
                            customerIO.BillingAddresses = customer.BillingAddresses;
                            customerIO.InvoiceLabel = customer.InvoiceLabel;
                            customerIO.IsPrivatePerson = customer.IsPrivatePerson;

                            if (specialFunctionalities.Contains("Automaster"))
                            {
                                //remove leading zeros from customer number
                                customerIO.CustomerNr = customerIO.CustomerNr.TrimStart('0');
                                //remove extra spaces from customer name
                                while (customerIO.Name.Contains("  "))
                                    customerIO.Name = customerIO.Name.Replace("  ", " ");
                            }
                            if (specialFunctionalities.Contains("SOPP"))
                            {
                                //remove extra spaces from customer name
                                if (customerIO.InvoiceLabel.Contains("/"))
                                {
                                    var parts = customerIO.InvoiceLabel.Split('/');
                                    customerIO.InvoiceLabel = parts[1];
                                    customerIO.InvoiceReference = parts[0];
                                }
                                if (customerIO.ImportInvoiceDetailed == false)
                                {
                                    customerIO.ImportInvoiceDetailed = true;
                                }
                                else
                                {
                                    customerIO.ImportInvoiceDetailed = false;
                                }
                            }
                            customerIOs.Add(customerIO);
                        }
                    }

                    result = BulkInsert(entities, customerIOs);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportCustomerIO(CustomerIOItem customerIOItem): ");
                }
            }

            if (result.Success && importToCustomer)
                result = ImportFromCustomerIO(customerIOs, actorCompanyId, isAutomasterImport);

            result.StringValue = batchId;

            return result;
        }

        #endregion

        #region Import from CustomerIO

        public ActionResult ImportCustomerIO(List<int> iosIds, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            try
            {
                using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                List<CustomerIO> customerIOs = (from io in entitiesReadOnly.CustomerIO
                                                where iosIds.Contains(io.CustomerIOId)
                                                select io).ToList();

                foreach (CustomerIO customerIO in customerIOs)
                {
                    customerIO.Status = (int)TermGroup_IOStatus.UnderProcessing;
                }

                result = ImportFromCustomerIO(customerIOs, actorCompanyId);
            }
            catch (Exception e)
            {
                base.LogError(e, this.log);
            }

            return result;
        }

        public ActionResult ImportFromCustomerIO(List<CustomerIO> customerIOs, int actorCompanyId, bool isAutomasterImport = false)
        {
            if (customerIOs == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerIO");

            var result = new ActionResult
            {
                Success = true,
                Keys = new List<int>(),
                Strings = new List<string>()
            };


            #region Init

            int counter = customerIOs.Count;
            int counterTransferred = 0;
            int counterErrorOccurred = 0;
            #endregion

            #region Prereq

            // Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            //SysWholesellers
            List<SysWholeseller> sysWholesellers = SysPriceListManager.GetSysWholesellers();

            //SysCountries 
            List<SysCountry> sysCountries = CountryCurrencyManager.GetSysCountries(true);

            this.rowNr = 0;

            #endregion

            using (var entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    var customers = CustomerManager.GetCustomersByCompanySmall(entities, actorCompanyId, false);

                    var customerIOsToProcess = customerIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing);
                    foreach (var io in customerIOsToProcess)
                    {
                        CustomerIO customerIO = entities.CustomerIO.Where(i => i.CustomerIOId == io.CustomerIOId).FirstOrDefault();
                        if (customerIO == null)
                            continue;

                        //api extra fields...
                        customerIO.GlnNbrs = io.GlnNbrs;
                        if (!String.IsNullOrEmpty(io.GLN))
                        {
                            if (customerIO.GlnNbrs == null)
                                customerIO.GlnNbrs = new List<ContactEComIODTO>();

                            customerIO.GlnNbrs.Add(new ContactEComIODTO() { Name = "GLN", Text = io.GLN });
                        }

                        customerIO.BillingAddresses = io.BillingAddresses;
                        customerIO.InvoiceLabel = io.InvoiceLabel;
                        customerIO.IsPrivatePerson = io.IsPrivatePerson;

                        ActionResult transferedResult = ImportFromCustomerIO(entities, customerIO, actorCompanyId, sysWholesellers, customers, sysCountries, isAutomasterImport);
                        if (transferedResult.Success)
                        {
                            result.Keys.Add(transferedResult.IntegerValue);
                            if (!string.IsNullOrEmpty(transferedResult.StringValue))
                            {
                                result.Strings.Add(transferedResult.StringValue);
                            }
                            counterTransferred++;
                        }
                        else
                        {
                            customerIO.Status = (int)TermGroup_IOStatus.Error;
                            customerIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                            counterErrorOccurred++;
                        }

                        var resultDb = SaveChanges(entities);
                        if (!resultDb.Success)
                            return resultDb;

                        if (!transferedResult.Success && customerIOsToProcess.IsNullOrEmpty())
                            return transferedResult;
                    }

                    #endregion
                }
                catch (Exception ex)
                {
                    result.ErrorMessage = GetText(5886, "Överföringen misslyckades: ") + " " + ex.Message;
                    result.ErrorNumber = 5886;
                    base.LogError(ex, this.log);
                }
                finally
                {
                    entities.Connection.Close();
                }
            }

            result.InfoMessage = string.Format(GetText(7560, "{0} Kunder av {1} har skapats/uppdaterats."), counterTransferred, counter);
            result.SuccessNumber = counterTransferred;
            result.StringValue = string.Format("{0},{1}", counterTransferred, counterErrorOccurred);

            return result;
        }

        public ActionResult ImportFromCustomerIO(CompEntities entities, CustomerIO customerIO, int actorCompanyId, List<SysWholeseller> sysWholesellers, List<CustomerSmallDTO> customers, List<SysCountry> sysCountries, bool isAutomasterImport = false)
        {
            var result = new ActionResult();

            using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    #region Init

                    this.rowNr++;
                    int actorId = 0;
                    customerIO.ErrorMessage = string.Empty;
                    bool newCustomer = false;

                    #endregion

                    #region Validation

                    #region Customernr

                    if (string.IsNullOrEmpty(customerIO.CustomerNr))
                    {
                        if (customers != null)
                        {
                            customerIO.CustomerNr = CustomerManager.GenerateCustomerNumber(customers);
                        }
                        else
                        {
                            result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8405, "Kundnr ej angiven"));
                            return result;
                        }
                    }

                    #endregion

                    #region Name

                    if (string.IsNullOrEmpty(customerIO.Name))
                        customerIO.Name = GetText(8406, "Kundnamn ej angiven");

                    #endregion

                    #region Vat

                    //VatType
                    int vatType;
                    if (!customerIO.VatType.HasValue)
                    {
                        customerIO.VatType = (int)TermGroup_InvoiceVatType.None;
                        vatType = customerIO.VatType.Value;
                    }
                    else
                    {
                        if (!EnumUtility.GetValue(customerIO.VatType.Value, out vatType, typeof(TermGroup_InvoiceVatType)))
                        {
                            result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8408, "Angiven momstyp är felaktig"));
                            return result;
                        }
                    }

                    #endregion

                    #endregion

                    #region Create entities

                    #region Customer

                    Customer customer = null;
                    if (customerIO.ActorCustomerId.HasValue && customerIO.ActorCustomerId.Value > 0)
                        customer = CustomerManager.GetCustomer(entities, customerIO.ActorCustomerId.Value, true);
                    else
                        customer = CustomerManager.GetCustomerByNr(entities, actorCompanyId, customerIO.CustomerNr, null, false);

                    if (customer == null)
                    {
                        #region Add

                        newCustomer = true;

                        //Add Customer
                        customer = new Customer()
                        {
                            CustomerNr = customerIO.CustomerNr,
                            ActorCompanyId = actorCompanyId,
                        };
                        SetCreatedProperties(customer);

                        customers?.Add(new CustomerSmallDTO { CustomerName = customerIO.Name, CustomerNr = customer.CustomerNr });

                        #endregion
                    }
                    else
                    {
                        #region Update

                        SetModifiedProperties(customer);

                        if (!customer.ActorReference.IsLoaded)
                            customer.ActorReference.Load();

                        #endregion
                    }

                    #region Populate fields

                    if (isAutomasterImport && !newCustomer)
                    {
                        customer.CustomerNr = customerIO.CustomerNr;
                        customer.Name = customerIO.Name;
                        customer.OrgNr = customerIO.OrgNr;
                    }
                    else
                    {
                        //Mandatory
                        customer.Name = customerIO.Name;
                        customer.VatType = vatType;

                        //Optional
                        customer.OrgNr = customerIO.OrgNr;
                        customer.VatNr = customerIO.VatNr;
                        customer.SupplierNr = customerIO.SupplierNr.HasValue ? customerIO.SupplierNr.ToString() : String.Empty;
                        customer.GracePeriodDays = customerIO.GracePeriodDays ?? 0;
                        customer.InvoiceReference = customerIO.InvoiceReference;
                        customer.AgreementTemplate = GetBillingAgreementReportId(entities, customerIO.AgreementTemplate, customer.AgreementTemplate);
                        customer.DiscountMerchandise = customerIO.DiscountMerchandise ?? 0;
                        customer.DiscountService = customerIO.DiscountService ?? 0;
                        customer.State = customerIO.CustomerState ?? 0;
                        customer.ManualAccounting = customerIO.ManualAccounting ?? false;
                        customer.DisableInvoiceFee = customerIO.DisableInvoiceFee ?? false;
                        customer.Note = customerIO.Note;
                        customer.ShowNote = customerIO.ShowNote ?? false;
                        customer.FinvoiceAddress = customerIO.FinvoiceAddress;
                        customer.FinvoiceOperator = customerIO.FinvoiceOperator;
                        customer.IsFinvoiceCustomer = customerIO.IsFinvoiceCustomer ?? false;
                        customer.BlockNote = customerIO.BlockNote;
                        customer.BlockOrder = customerIO.BlockOrder ?? false;
                        customer.BlockInvoice = customerIO.BlockInvoice ?? false;
                        customer.CreditLimit = customerIO.CreditLimit;
                        customer.IsCashCustomer = customerIO.IsCashCustomer;
                        customer.SysLanguageId = customerIO.SysLanguageId;
                        customer.InvoiceDeliveryType = customerIO.InvoiceDeliveryType;
                        customer.InvoiceLabel = customerIO.InvoiceLabel;
                        customer.ImportInvoicesDetailed = customerIO.ImportInvoiceDetailed ?? false;
                        if (customerIO.IsPrivatePerson.HasValue)
                            customer.IsPrivatePerson = customerIO.IsPrivatePerson.Value;

                        //Optional FK
                        customer.BillingTemplate = GetBillingInvoiceReportId(entities, customerIO.BillingTemplate, customer.BillingTemplate);
                        customer.OfferTemplate = GetBillingOfferReportId(entities, customerIO.OfferTemplate, customer.OfferTemplate);
                        customer.OrderTemplate = GetBillingOrderReportId(entities, customerIO.OrderTemplate, customer.OrderTemplate);

                        if (!customer.SysCountryId.HasValue && !string.IsNullOrEmpty(customerIO.Country))
                        {
                            if (sysCountries.Any(c => c.Code.ToLower() == customerIO.Country.ToLower()))
                                customer.SysCountryId = sysCountries.FirstOrDefault(c => c.Code.ToLower() == customerIO.Country.ToLower()).SysCountryId;

                            if (!customer.SysCountryId.HasValue)
                            {
                                if (sysCountries.Any(c => c.Name.ToLower() == customerIO.Country.ToLower()))
                                    customer.SysCountryId = sysCountries.FirstOrDefault(c => c.Name.ToLower() == customerIO.Country.ToLower()).SysCountryId;

                                if (!customer.SysCountryId.HasValue)
                                {
                                    customer.SysCountryId = (int?)CountryCurrencyManager.GetSysCountry(customerIO.Country)?.SysCountryId;
                                }
                            }
                        }

                        customer.SysWholeSellerId = GetSysWholeSellerId(sysWholesellers, customerIO.DefaultWholeseller, customer.SysWholeSellerId);
                    }

                    //Optional relations
                    int currencyId = GetCurrencyId(entities, customerIO.Currency);

                    if (currencyId == 0)
                    {
                        customer = null;
                        return result;
                    }

                    int? deliveryTypeId = GetDeliveryTypeId(entities, customerIO.DeliveryMethod, customer.DeliveryTypeId);
                    int? deliveryConditionId = GetDeliveryConditionId(entities, customerIO.DeliveryCondition, customer.DeliveryConditionId);
                    int? paymentConditionId = GetPaymentConditionId(entities, customerIO.PaymentCondition, customer.PaymentConditionId);
                    int? defaultPriceListTypeId = GetPricelistTypeId(entities, customerIO.DefaultPriceListType, customer.PriceListTypeId);

                    #endregion

                    #endregion

                    #region Accounts

                    // Accounts
                    if (!TryAddCustomerAccountStds(entities, customer, GetCustomerImportAccounts(entities, customerIO)))
                    {
                        //Only log warning
                        customerIO.ErrorMessage = GetText(8409, "Konton kunde inte sparas") + ". ";
                    }

                    #endregion

                    #region Save

                    result = newCustomer
                            ? CustomerManager.AddCustomer(entities, customer, deliveryTypeId, deliveryConditionId, paymentConditionId, defaultPriceListTypeId, currencyId, this.company.ActorCompanyId)
                            : CustomerManager.UpdateCustomer(entities, customer, deliveryTypeId, deliveryConditionId, paymentConditionId, defaultPriceListTypeId, currencyId);

                    if (!result.Success)
                    {
                        string msg = GetText(8410, "Kund gick inte att spara");
                        if (!string.IsNullOrEmpty(result.ErrorMessage))
                            msg += " : " + result.ErrorMessage;

                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, msg);
                        return result;
                    }

                    // Update counters
                    if (newCustomer)
                        itemsAdded++;
                    else
                        itemsUpdated++;

                    //Set id's
                    actorId = customer.Actor.ActorId;
                    customerIO.ActorCustomerId = customer.ActorCustomerId;
                    customerIO.Status = (int)TermGroup_IOStatus.Processed;
                    #endregion

                    #region Save relations

                    Contact contact = null;
                    if (TrySaveContact(entities, actorId, TermGroup_SysContactType.Company, ref contact))
                    {
                        ActionResult resultEcom = TrySaveContactEcom(entities, contact, GetImportEComs(customerIO));
                        if (!resultEcom.Success)
                            customerIO.ErrorMessage += GetText(8411, "Tele/webb-uppgifter gick inte att spara") + ". ";

                        resultEcom = TrySaveContactEcom(entities, contact, customerIO.GlnNbrs, TermGroup_SysContactEComType.GlnNumber);
                        if (!resultEcom.Success)
                        {
                            customerIO.ErrorMessage += GetText(8411, "Kontaktuppgifter gick inte att spara") + ". ";
                        }
                        else
                        {
                            if (!String.IsNullOrEmpty(customerIO.GLN))
                            {
                                var glnNbrEcom = contact.ContactECom.FirstOrDefault(c => c.Text == customerIO.GLN);
                                if (glnNbrEcom != null)
                                {
                                    customer.ContactGLNId = glnNbrEcom.ContactEComId;
                                }
                            }
                        }

                        ActionResult resultAddresses = TrySaveContactAddresses(entities, contact, GetImportAddresses(customerIO));
                        if (!resultAddresses.Success)
                            customerIO.ErrorMessage += GetText(8412, "Adressuppgifter gick inte att spara") + ". ";

                        if (!customerIO.BillingAddresses.IsNullOrEmpty())
                        {
                            result = ContactManager.ImportContactAdresses(entities, contact, customerIO.BillingAddresses, TermGroup_SysContactAddressType.Billing);
                            if (!result.Success)
                            {
                                result = new ActionResult(8412, GetText(8412, "Adressuppgifter gick inte att spara"));
                                return result;
                            }
                        }

                        //InvoiceDeliveryEmail should have been saved by TrySaveContactEcom so try to fetch it
                        if (!customerIO.InvoiceDeliveryEmail.IsNullOrEmpty() && contact != null)
                        {
                            var ecom = ContactManager.GetContactECom(entities, contact.ContactId, (int)TermGroup_SysContactEComType.Email, false, customerIO.InvoiceDeliveryEmail);
                            if (ecom != null)
                            {
                                customer.ContactEComId = ecom.ContactEComId;
                            }
                            else
                            {
                                customerIO.ErrorMessage += GetText(11672, "Angiven e-post är inte korrekt");
                            }
                        }
                    }
                    else
                    {
                        customerIO.ErrorMessage += " " + GetText(8413, "Tele/webb-uppgifter/Adressuppgifter gick inte att spara") + ". ";
                    }

                    ActionResult resultCategories = TrySaveCategories(entities, customer.ActorCustomerId, GetImportCategoryRecords(entities, customerIO.CategoryCode1, customerIO.CategoryCode2, customerIO.CategoryCode3, customerIO.CategoryCode4, customerIO.CategoryCode5), SoeCategoryType.Customer, SoeCategoryRecordEntity.Customer, false);
                    if (!resultCategories.Success)
                        customerIO.ErrorMessage += GetText(8414, "Kategorier gick inte att spara") + ". ";

                    if (!string.IsNullOrEmpty(customerIO.ExternalId))
                    {
                        ActorManager.DeleteExternalNbrs(entities, TermGroup_CompanyExternalCodeEntity.Customer, customer.ActorCustomerId, actorCompanyId);
                        var nbrs = customerIO.ExternalId.Split('|').ToList();
                        foreach (var nbr in nbrs)
                        {
                            var matchingNbr = ActorManager.GetInternalIdsListFromExternalNr(entities, TermGroup_CompanyExternalCodeEntity.Customer, nbr, actorCompanyId).Where(x => x != customer.ActorCustomerId).ToList();
                            if (matchingNbr.Any())
                            {
                                result = new ActionResult(8413, $"ExternalNr {nbr} already exist on other customer");
                                return result;
                            }

                        }
                        ActorManager.InsertExternalNbrs(entities, TermGroup_CompanyExternalCodeEntity.Customer, customer.ActorCustomerId, nbrs, actorCompanyId);
                    }

                    if (!String.IsNullOrEmpty(customerIO.ContactFirstName) || !String.IsNullOrEmpty(customerIO.ContactLastName) || !String.IsNullOrEmpty(customerIO.ContactEmail))
                    {
                        var newContactPerson = new ContactPersonDTO();

                        var contactPersons = ContactManager.GetContactPersons(entities, actorId);
                        var contactPerson = contactPersons.FirstOrDefault(p => (p.FirstName.ToLower() == customerIO.ContactFirstName.ToLower() && p.LastName.ToLower() == customerIO.ContactLastName.ToLower()));

                        if (contactPerson != null)
                            newContactPerson.ActorContactPersonId = contactPerson.ActorContactPersonId;

                        newContactPerson.FirstName = customerIO.ContactFirstName;
                        newContactPerson.LastName = customerIO.ContactLastName;
                        newContactPerson.Email = customerIO.ContactEmail;

                        result = ContactManager.AddUpdateContactPerson(entities, transaction, newContactPerson, actorCompanyId);

                        if (!result.Success)
                            return result;

                        var rows = ContactManager.ValidateContactAddressItems(entities, newContactPerson.ActorContactPersonId, newContactPerson.Email, "");
                        result = ContactManager.SaveContactAddresses(entities, rows, newContactPerson.ActorContactPersonId, TermGroup_SysContactType.Company);

                        if (!result.Success)
                            return result;

                        var ids = contactPersons.Select(p => p.ActorContactPersonId).ToList();
                        if (!ids.Contains(newContactPerson.ActorContactPersonId))
                            ids.Add(newContactPerson.ActorContactPersonId);

                        result = ContactManager.SaveContactPersonMappings(entities, ids, actorId);
                    }

                    #endregion

                    #endregion

                    //Commit transaction
                    if (result.Success)
                    {
                        transaction.Complete();
                        result.StringValue = customer?.CustomerNr;
                    }

                }
                catch (Exception ex)
                {
                    result.Exception = ex;
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);
                }
            }

            return result;
        }

        #endregion

        #region Export from Customer

        public List<CustomerSearchResultIODTO> SearchCustomer(int actorCompanyId, CustomerSearchIODTO searchDTO, int maxNrRows, bool getAll)
        {
            if (maxNrRows > 1000 && !getAll)
            {
                maxNrRows = 1000;
            }

            var result = new List<CustomerSearchResultIODTO>();

            var searchResult = CustomerManager.GetCustomersBySearch(new CustomerSearchDTO
            {
                CustomerNr = searchDTO.Number,
                Name = searchDTO.Name,
                PhoneNumber = searchDTO.PhoneNumber,
                Email = searchDTO.Email,
                DeliveryAddress = searchDTO.Address,
                PostalCode = searchDTO.PostalCode,
                City = searchDTO.City
            }, actorCompanyId, maxNrRows * 20/*guestimate of 20 phone and addressrows per company*/).ToList();

            foreach (var customerResult in searchResult.GroupBy(c => c.ActorCustomerId))
            {
                var first = customerResult.First();
                var customer = new CustomerSearchResultIODTO
                {
                    CustomerId = first.ActorCustomerId,
                    CustomerName = first.Name,
                    CustomerNr = first.CustomerNr,
                    OrgNr = first.OrgNr,
                    PhoneNumber = customerResult.FirstOrDefault(c => ContactManager.PhoneEComTypes.Contains((TermGroup_SysContactEComType)c.SysContactEComTypeId) && !string.IsNullOrEmpty(c.EcomText))?.EcomText,
                    Email = customerResult.FirstOrDefault(c => c.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Email && !string.IsNullOrEmpty(c.EcomText))?.EcomText,
                };

                var deliveryAddressItem = customerResult.FirstOrDefault(c => c.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery && c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address && !string.IsNullOrEmpty(c.AddressText));
                if (deliveryAddressItem != null)
                {
                    customer.DeliveryAddress = deliveryAddressItem.AddressText;
                    customer.DeliveryPostalCode = customerResult.FirstOrDefault(c => c.ContactAddressId == deliveryAddressItem.ContactAddressId && c.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery && c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode && !string.IsNullOrEmpty(c.AddressText))?.AddressText;
                    customer.DeliveryCity = customerResult.FirstOrDefault(c => c.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery && c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress && !string.IsNullOrEmpty(c.AddressText))?.AddressText;
                }

                result.Add(customer);

                if (result.Count > maxNrRows)
                    break;
            }

            return result;
        }

        public List<CustomerIODTO> GetCustomerIODTOs(int actorCompanyId, string numberFrom, string numberTo, List<int> customerIds = null, string orgNr = null, DateTime? modifiedSince = null)
        {
            var customerIODTOs = new List<CustomerIODTO>();

            var customerNr = !string.IsNullOrEmpty(numberFrom) && !string.IsNullOrEmpty(numberTo) && numberFrom.ToLower() == numberTo.ToLower() ? numberFrom : null;

            var customers = CustomerManager.GetCustomers(actorCompanyId, loadActor: true, loadAccount: true, loadCustomerUser: true, loadContactAddresses: true, loadDeliveryAndPaymentCondition: true, loadCategories: false, customerIds: customerIds, orgNr: orgNr, modifiedSince: modifiedSince, customerNr: customerNr);

            if (!customers.Any())
            {
                return customerIODTOs;
            }

            var externaCompanyCodes = ActorManager.GetCompanyExternalCodes(TermGroup_CompanyExternalCodeEntity.Customer, actorCompanyId);
            List<Currency> currencies = CountryCurrencyManager.GetCurrencies(actorCompanyId);
            List<AccountDTO> accounts = AccountManager.GetAccounts(actorCompanyId).ToDTOs(false, false);
            List<AccountDimDTO> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId).ToDTOs(false, false);

            List<CompanyCategoryRecord> categoryRecords = customers.Count == 1
                ? CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Customer, SoeCategoryRecordEntity.Customer, customers[0].ActorCustomerId, actorCompanyId)
                : CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Customer, SoeCategoryRecordEntity.Customer, actorCompanyId);

            foreach (var customer in customers)
            {
                if (!string.IsNullOrEmpty(numberFrom) || !string.IsNullOrEmpty(numberTo))
                {
                    if (string.IsNullOrEmpty(numberFrom))
                        numberFrom = "-1";
                    if (string.IsNullOrEmpty(numberFrom))
                        numberTo = "999999999";

                    if (!StringUtility.IsInInterval(customer.CustomerNr, numberFrom, numberTo))
                        continue;
                }

                #region Accounts

                var debitInternalAccounts = customer.CustomerAccountStd.FirstOrDefault(p => p.Type == (int)CustomerAccountType.Debit)?.AccountInternal.ToDTOs() ?? new List<AccountInternalDTO>();
                var debitaccountAndInternalAccountComboDTO = debitInternalAccounts.GetInternalAccountDimNrs(accountDims, accounts);

                var creditInternalAccounts = customer.CustomerAccountStd.FirstOrDefault(p => p.Type == (int)CustomerAccountType.Credit)?.AccountInternal.ToDTOs() ?? new List<AccountInternalDTO>();
                var creditaccountAndInternalAccountComboDTO = creditInternalAccounts.GetInternalAccountDimNrs(accountDims, accounts);

                #endregion

                #region Categories

                var categories = CategoryManager.GetCategories(categoryRecords, customer.ActorCustomerId);
                CategoryComboDTO categoryComboDTO = categories.GetCategoryComboDTO();

                #endregion

                var contact = customer.Actor?.Contact?.FirstOrDefault();

                #region Addresses

                #region Billing

                string customerBillingAddressName = string.Empty;
                string customerBillingAddressAddress = string.Empty;
                string customerBillingAddressCo = string.Empty;
                string customerBillingAddressPostNr = string.Empty;
                string customerBillingAddressCity = string.Empty;
                string customerBillingAddressCountry = string.Empty;
                var billingAddressRows = new List<ContactAdressIODTO>();
                if (contact != null)
                {
                    var customerBillingAddresses = ContactManager.GetContactAddresses(contact.ContactId, TermGroup_SysContactAddressType.Billing, false, true);
                    ContactManager.ParseContactAddress(customerBillingAddresses.FirstOrDefault(), TermGroup_SysContactAddressType.Billing,
                        out customerBillingAddressName, out customerBillingAddressAddress, out customerBillingAddressCo, out customerBillingAddressPostNr,
                        out customerBillingAddressCity, out customerBillingAddressCountry);

                    billingAddressRows = ContactManager.ContactAddressesToIODTO(customerBillingAddresses);
                }

                #endregion

                #region Delivery

                string customerDeliveryAddressName = string.Empty;
                string customerDeliveryAddressAddress = string.Empty;
                string customerDeliveryAddressCo = string.Empty;
                string customerDeliveryAddressPostNr = string.Empty;
                string customerDeliveryAddressCity = string.Empty;
                string customerDeliveryAddressCountry = string.Empty;

                if (contact != null)
                {
                    var customerDeliveryAddresses = ContactManager.GetContactAddresses(contact.ContactId, TermGroup_SysContactAddressType.Delivery, false, true);
                    ContactManager.ParseContactAddress(customerDeliveryAddresses.FirstOrDefault(), TermGroup_SysContactAddressType.Delivery,
                        out customerDeliveryAddressName, out customerDeliveryAddressAddress, out customerDeliveryAddressCo, out customerDeliveryAddressPostNr,
                        out customerDeliveryAddressCity, out customerDeliveryAddressCountry);
                }

                #endregion

                #region Visiting

                string customerVisitingAddressName = string.Empty;
                string customerVisitingAddressAddress = string.Empty;
                string customerVisitingAddressCo = string.Empty;
                string customerVisitingAddressPostNr = string.Empty;
                string customerVisitingAddressCity = string.Empty;
                string customerVisitingAddressCountry = string.Empty;

                if (contact != null)
                {
                    var customerVisitingAddresses = ContactManager.GetContactAddresses(contact.ContactId, TermGroup_SysContactAddressType.Visiting, false, true);
                    ContactManager.ParseContactAddress(customerVisitingAddresses.FirstOrDefault(), TermGroup_SysContactAddressType.Visiting,
                        out customerVisitingAddressName, out customerVisitingAddressAddress, out customerVisitingAddressCo, out customerVisitingAddressPostNr,
                        out customerVisitingAddressCity, out customerVisitingAddressCountry);
                }

                #endregion

                #region Distribution

                string customerDistributionAddressName = string.Empty;
                string customerDistributionAddressAddress = string.Empty;
                string customerDistributionAddressCo = string.Empty;
                string customerDistributionAddressPostNr = string.Empty;
                string customerDistributionAddressCity = string.Empty;
                string customerDistributionAddressCountry = string.Empty;

                if (contact != null)
                {
                    var customerDistributionAddresses = ContactManager.GetContactAddresses(contact.ContactId, TermGroup_SysContactAddressType.Distribution, false, true);
                    ContactManager.ParseContactAddress(customerDistributionAddresses.FirstOrDefault(), TermGroup_SysContactAddressType.Distribution,
                        out customerDistributionAddressName, out customerDistributionAddressAddress, out customerDistributionAddressCo, out customerDistributionAddressPostNr,
                        out customerDistributionAddressCity, out customerDistributionAddressCountry);
                }

                #endregion

                #region HQ

                string customerHQAddress = string.Empty;
                string customerHQAddressCountry = string.Empty;

                if (contact != null)
                {
                    //ContactAddressRow HQ            
                    var customerHQ = ContactManager.GetContactAddresses(contact.ContactId, TermGroup_SysContactAddressType.BoardHQ, false, true);
                    ContactManager.ParseContactHQAddress(customerHQ.FirstOrDefault(), TermGroup_SysContactAddressType.BoardHQ,
                        out customerHQAddress, out customerHQAddressCountry);
                }

                #endregion

                #endregion

                #region Ecom

                string email1 = null;
                string email2 = null;
                string phoneHome = null;
                string phoneMobile = null;
                string phoneJob = null;
                string fax = null;
                string webpage = null;
                if (contact != null)
                {

                    email1 = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.Email).FirstOrDefault()?.Text;
                    email2 = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.Email).LastOrDefault()?.Text;
                    phoneHome = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.PhoneHome).FirstOrDefault()?.Text;
                    phoneMobile = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.PhoneMobile).FirstOrDefault()?.Text;
                    phoneJob = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.PhoneJob).FirstOrDefault()?.Text;
                    fax = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.Fax).FirstOrDefault()?.Text;
                    webpage = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.Web).FirstOrDefault()?.Text;
                }

                #endregion

                var sysWholeSellerDto = customer.SysWholeSellerId.HasValue ? WholeSellerManager.GetSysWholesellerDTO(customer.SysWholeSellerId.Value) : null; //is cached!

                var customerIODTO = new CustomerIODTO
                {
                    ActorCompanyId = customer.ActorCompanyId.Value,
                    CustomerNr = customer.CustomerNr,
                    CustomerId = customer.ActorCustomerId,
                    Name = customer.Name,
                    VatType = customer.VatType,
                    OrgNr = customer.OrgNr,
                    VatNr = customer.VatNr,
                    Country = customer.SysCountryId.GetValueOrDefault() != 0 ? (currencies.FirstOrDefault(c => c.CurrencyId == customer.CurrencyId)?.Code ?? string.Empty) : string.Empty,
                    Currency = currencies.FirstOrDefault(c => c.CurrencyId == customer.CurrencyId)?.Code ?? string.Empty,
                    PaymentCondition = customer.PaymentCondition?.Name ?? string.Empty,
                    GracePeriodDays = customer.GracePeriodDays,
                    InvoiceReference = customer.InvoiceReference,
                    DeliveryMethod = customer.DeliveryType?.Name ?? string.Empty,
                    DeliveryCondition = customer.DeliveryCondition?.Name ?? string.Empty,
                    DefaultPriceListType = customer.PriceListType?.Name ?? string.Empty,
                    DefaultPriceListTypeId = customer.PriceListTypeId.GetValueOrDefault(),
                    DefaultWholeseller = sysWholeSellerDto?.Name ?? string.Empty,
                    DiscountMerchandise = customer.DiscountMerchandise,
                    DiscountService = customer.DiscountService,
                    DisableInvoiceFee = customer.DisableInvoiceFee,
                    CustomerState = customer.State,
                    FinvoiceAddress = customer.FinvoiceAddress,
                    FinvoiceOperator = customer.FinvoiceOperator,
                    IsFinvoiceCustomer = customer.IsFinvoiceCustomer,
                    IsCashCustomer = customer.IsCashCustomer,
                    Note = customer.Note,
                    ShowNote = customer.ShowNote,
                    BlockNote = customer.BlockNote,
                    BlockOrder = customer.BlockOrder,
                    BlockInvoice = customer.BlockInvoice,
                    CreditLimit = customer.CreditLimit,
                    OfferTemplate = customer.OfferTemplate,
                    OrderTemplate = customer.OrderTemplate,
                    BillingTemplate = customer.BillingTemplate,
                    AgreementTemplate = customer.AgreementTemplate,
                    ManualAccounting = customer.ManualAccounting,
                    ImportInvoiceDetailed = customer.ImportInvoicesDetailed,

                    DistributionAddress = customerDistributionAddressAddress,
                    DistributionCoAddress = customerDistributionAddressCo,
                    DistributionPostalCode = customerDistributionAddressPostNr,
                    DistributionPostalAddress = customerDistributionAddressCity,
                    DistributionCountry = customerDistributionAddressCountry,

                    BillingAddress = customerBillingAddressAddress,
                    BillingCoAddress = customerBillingAddressCo,
                    BillingPostalCode = customerBillingAddressPostNr,
                    BillingPostalAddress = customerBillingAddressCity,
                    BillingCountry = customerBillingAddressCountry,
                    BillingAddresses = billingAddressRows,

                    BoardHQAddress = customerHQAddress,
                    BoardHQCountry = customerHQAddressCountry,

                    VisitingAddress = customerVisitingAddressAddress,
                    VisitingCoAddress = customerVisitingAddressCo,
                    VisitingPostalCode = customerVisitingAddressPostNr,
                    VisitingPostalAddress = customerVisitingAddressCity,
                    VisitingCountry = customerVisitingAddressCountry,

                    DeliveryAddress = customerDeliveryAddressAddress,
                    DeliveryCoAddress = customerDeliveryAddressCo,
                    DeliveryPostalCode = customerDeliveryAddressPostNr,
                    DeliveryPostalAddress = customerDeliveryAddressCity,
                    DeliveryCountry = customerDeliveryAddressCountry,

                    Email1 = email1 ?? "",
                    Email2 = email2 ?? "",
                    PhoneHome = phoneHome ?? "",
                    PhoneMobile = phoneMobile ?? "",
                    PhoneJob = phoneJob ?? "",
                    Fax = fax ?? "",
                    Webpage = webpage ?? "",

                    AccountsReceivableAccountNr = customer.CustomerAccountStd?.FirstOrDefault(a => a.Type == (int)CustomerAccountType.Debit)?.AccountStd?.Account.AccountNr ?? "",
                    AccountsReceivableAccountInternal1 = debitaccountAndInternalAccountComboDTO.Dim2Nr,
                    AccountsReceivableAccountInternal2 = debitaccountAndInternalAccountComboDTO.Dim3Nr,
                    AccountsReceivableAccountInternal3 = debitaccountAndInternalAccountComboDTO.Dim4Nr,
                    AccountsReceivableAccountInternal4 = debitaccountAndInternalAccountComboDTO.Dim5Nr,
                    AccountsReceivableAccountInternal5 = debitaccountAndInternalAccountComboDTO.Dim6Nr,
                    SalesAccountNr = customer.CustomerAccountStd.FirstOrDefault(a => a.Type == (int)CustomerAccountType.Credit)?.AccountStd?.Account.AccountNr ?? "",
                    SalesAccountInternal1 = creditaccountAndInternalAccountComboDTO.Dim2Nr,
                    SalesAccountInternal2 = creditaccountAndInternalAccountComboDTO.Dim3Nr,
                    SalesAccountInternal3 = creditaccountAndInternalAccountComboDTO.Dim4Nr,
                    SalesAccountInternal4 = creditaccountAndInternalAccountComboDTO.Dim5Nr,
                    SalesAccountInternal5 = creditaccountAndInternalAccountComboDTO.Dim6Nr,
                    VATAccountNr = customer.CustomerAccountStd.FirstOrDefault(a => a.Type == (int)CustomerAccountType.VAT)?.AccountStd?.Account.AccountNr ?? "",
                    VATCodeNr = customer.VatNr,
                    CategoryCode1 = categoryComboDTO.Category1Code,
                    CategoryCode2 = categoryComboDTO.Category2Code,
                    CategoryCode3 = categoryComboDTO.Category3Code,
                    CategoryCode4 = categoryComboDTO.Category4Code,
                    CategoryCode5 = categoryComboDTO.Category5Code,
                    CategoryIds = !categories.IsNullOrEmpty() ? categories.Select(c => c.CategoryId).ToList() : new List<int>(),
                    Created = customer.Created,
                    CreatedBy = customer.CreatedBy,
                    Modified = customer.Modified,
                    ModifiedBy = customer.ModifiedBy,
                    State = customer.State,
                    ErrorMessage = string.Empty,
                    ImportHeadType = TermGroup_IOImportHeadType.Customer,
                    SysLanguageId = customer.SysLanguageId,
                    ExternalNbrs = externaCompanyCodes.Any() ? externaCompanyCodes.Where(e => e.RecordId == customer.ActorCustomerId).Select(e2 => e2.ExternalCode).ToList() : new List<string>(),
                    IsPrivatePerson = customer.IsPrivatePerson.GetValueOrDefault(),
                    GLNNbrs = ContactManager.GetContactEcoms(contact, (int)TermGroup_SysContactEComType.GlnNumber).Select(g => new ContactEComIODTO { ContactEComId = g.ContactEComId, Name = g.Name, Text = g.Text }).ToList(),
                    InvoiceDeliveryType = customer.InvoiceDeliveryType.GetValueOrDefault(),
                    ProductPrices = customer.CustomerProduct?.Select(x => new CustomerProductPriceIODTO { Price = x.Price, ProductId = x.ProductId }).ToList(),
                    InvoiceLabel = customer.InvoiceLabel
                };

                if (Int32.TryParse(customer.SupplierNr, out int supplierNr))
                    customerIODTO.SupplierNr = supplierNr;

                customerIODTOs.Add(customerIODTO);
            }

            return customerIODTOs;
        }


        #endregion

        #region Help-methods

        private CustomerIO GetCustomerIO(CompEntities entities, int customerIOid)
        {
            return (from io in entities.CustomerIO
                    where io.CustomerIOId == customerIOid
                    select io).FirstOrDefault();
        }

        private CustomerIO CreateCustomerIO(TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, CustomerIODTO customerIODTO, string batchId, int actorCompanyId, AccountDim accountSiedim1, AccountDim accountSiedim6)
        {
            #region Prereq

            var io = new CustomerIO
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
            };
            SetCreatedProperties(io);

            #endregion

            #region Perform

            if (customerIODTO != null)
            {
                try
                {
                    #region Fill CustomerIO

                    io.VatType = customerIODTO.VatType;
                    io.DeliveryCondition = customerIODTO.DeliveryCondition;

                    io.PaymentCondition = customerIODTO.PaymentCondition;
                    io.DefaultPriceListType = customerIODTO.DefaultPriceListType;
                    io.Currency = customerIODTO.Currency;
                    io.Country = customerIODTO.Country;
                    io.CustomerNr = customerIODTO.CustomerNr;
                    io.Name = customerIODTO.Name;
                    io.OrgNr = customerIODTO.OrgNr;
                    io.GLN = customerIODTO.GLN;
                    io.VatNr = customerIODTO.VatNr;
                    io.InvoiceReference = customerIODTO.InvoiceReference;
                    io.SupplierNr = customerIODTO.SupplierNr;
                    io.ManualAccounting = customerIODTO.ManualAccounting;
                    io.DiscountMerchandise = customerIODTO.DiscountMerchandise;
                    io.DiscountService = customerIODTO.DiscountService;
                    io.DisableInvoiceFee = customerIODTO.DisableInvoiceFee;
                    io.Note = customerIODTO.Note;
                    io.ShowNote = customerIODTO.ShowNote;
                    io.FinvoiceAddress = customerIODTO.FinvoiceAddress;
                    io.FinvoiceOperator = customerIODTO.FinvoiceOperator;
                    io.IsFinvoiceCustomer = customerIODTO.IsFinvoiceCustomer;
                    io.BlockNote = customerIODTO.BlockNote;
                    io.BlockOrder = customerIODTO.BlockOrder;
                    io.BlockInvoice = customerIODTO.BlockInvoice;
                    io.CreditLimit = customerIODTO.CreditLimit;
                    io.IsCashCustomer = customerIODTO.IsCashCustomer;
                    io.InvoiceDeliveryType = customerIODTO.InvoiceDeliveryType;
                    io.ImportInvoiceDetailed = customerIODTO.ImportInvoiceDetailed;
                    io.InvoiceLabel = customerIODTO.InvoiceLabel;

                    io.GracePeriodDays = customerIODTO.GracePeriodDays;
                    io.DeliveryMethod = customerIODTO.DeliveryMethod;
                    io.DefaultWholeseller = customerIODTO.DefaultWholeseller;
                    io.CustomerState = customerIODTO.CustomerState;
                    io.OfferTemplate = customerIODTO.OfferTemplate;
                    io.OrderTemplate = customerIODTO.OrderTemplate;
                    io.BillingTemplate = customerIODTO.BillingTemplate;
                    io.AgreementTemplate = customerIODTO.AgreementTemplate;

                    io.AccountsReceivableAccountNr = customerIODTO.AccountsReceivableAccountNr;
                    io.AccountsReceivableAccountInternal1 = customerIODTO.AccountsReceivableAccountInternal1;
                    io.AccountsReceivableAccountInternal2 = customerIODTO.AccountsReceivableAccountInternal2;
                    io.AccountsReceivableAccountInternal3 = customerIODTO.AccountsReceivableAccountInternal3;
                    io.AccountsReceivableAccountInternal4 = customerIODTO.AccountsReceivableAccountInternal4;
                    io.AccountsReceivableAccountInternal5 = customerIODTO.AccountsReceivableAccountInternal5;
                    io.SalesAccountNr = customerIODTO.SalesAccountNr;
                    io.SalesAccountInternal1 = customerIODTO.SalesAccountInternal1;
                    io.SalesAccountInternal2 = customerIODTO.SalesAccountInternal2;
                    io.SalesAccountInternal3 = customerIODTO.SalesAccountInternal3;
                    io.SalesAccountInternal4 = customerIODTO.SalesAccountInternal4;
                    io.SalesAccountInternal5 = customerIODTO.SalesAccountInternal5;
                    io.VATAccountNr = customerIODTO.VATAccountNr;
                    io.VATCodeNr = customerIODTO.VATCodeNr;
                    io.CategoryCode1 = customerIODTO.CategoryCode1;
                    io.CategoryCode2 = customerIODTO.CategoryCode2;
                    io.CategoryCode3 = customerIODTO.CategoryCode3;
                    io.CategoryCode4 = customerIODTO.CategoryCode4;
                    io.CategoryCode5 = customerIODTO.CategoryCode5;
                    io.SysLanguageId = customerIODTO.SysLanguageId;
                    io.ExternalId = customerIODTO.ExternalNbrs != null && customerIODTO.ExternalNbrs.Any() ? string.Join("|", customerIODTO.ExternalNbrs) : null;

                    #region Adddresses and telecom

                    io.DistributionAddress = customerIODTO.DistributionAddress;
                    io.DistributionCoAddress = customerIODTO.DistributionCoAddress;
                    io.DistributionPostalCode = customerIODTO.DistributionPostalCode;
                    io.DistributionPostalAddress = customerIODTO.DistributionPostalAddress;
                    io.DistributionCountry = customerIODTO.DistributionCountry;

                    io.BillingAddress = customerIODTO.BillingAddress;
                    io.BillingCoAddress = customerIODTO.BillingCoAddress;
                    io.BillingPostalCode = customerIODTO.BillingPostalCode;
                    io.BillingPostalAddress = customerIODTO.BillingPostalAddress;
                    io.BillingCountry = customerIODTO.BillingCountry;

                    io.BoardHQAddress = customerIODTO.BoardHQAddress;
                    io.BoardHQCountry = customerIODTO.BoardHQCountry;

                    io.VisitingAddress = customerIODTO.VisitingAddress;
                    io.VisitingCoAddress = customerIODTO.VisitingCoAddress;
                    io.VisitingPostalCode = customerIODTO.VisitingPostalCode;
                    io.VisitingPostalAddress = customerIODTO.VisitingPostalAddress;
                    io.VisitingCountry = customerIODTO.VisitingCountry;

                    io.DeliveryAddress = customerIODTO.DeliveryAddress;
                    io.DeliveryCoAddress = customerIODTO.DeliveryCoAddress;
                    io.DeliveryPostalCode = customerIODTO.DeliveryPostalCode;
                    io.DeliveryPostalAddress = customerIODTO.DeliveryPostalAddress;
                    io.DeliveryCountry = customerIODTO.DeliveryCountry;

                    io.Email1 = customerIODTO.Email1;
                    io.Email2 = customerIODTO.Email2;
                    io.PhoneHome = customerIODTO.PhoneHome;
                    io.PhoneMobile = customerIODTO.PhoneMobile;
                    io.PhoneJob = customerIODTO.PhoneJob;
                    io.Fax = customerIODTO.Fax;
                    io.Webpage = customerIODTO.Webpage;

                    io.ContactEmail = customerIODTO.ContactEmail;
                    io.ContactFirstName = customerIODTO.ContactFirstName;
                    io.ContactLastName = customerIODTO.ContactLastName;

                    io.InvoiceDeliveryEmail = customerIODTO.InvoiceDeliveryEmail;

                    #endregion

                    if (accountSiedim1 != null && customerIODTO.AccountsReceivableAccountSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 2:
                                io.AccountsReceivableAccountInternal1 = customerIODTO.AccountsReceivableAccountSieDim1;
                                break;
                            case 3:
                                io.AccountsReceivableAccountInternal2 = customerIODTO.AccountsReceivableAccountSieDim1;
                                break;
                            case 4:
                                io.AccountsReceivableAccountInternal3 = customerIODTO.AccountsReceivableAccountSieDim1;
                                break;
                            case 5:
                                io.AccountsReceivableAccountInternal4 = customerIODTO.AccountsReceivableAccountSieDim1;
                                break;
                            case 6:
                                io.AccountsReceivableAccountInternal5 = customerIODTO.AccountsReceivableAccountSieDim1;
                                break;
                        }
                    }
                    if (accountSiedim1 != null && customerIODTO.SalesAccountSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 2:
                                io.SalesAccountInternal1 = customerIODTO.SalesAccountSieDim1;
                                break;
                            case 3:
                                io.SalesAccountInternal2 = customerIODTO.SalesAccountSieDim1;
                                break;
                            case 4:
                                io.SalesAccountInternal3 = customerIODTO.SalesAccountSieDim1;
                                break;
                            case 5:
                                io.SalesAccountInternal4 = customerIODTO.SalesAccountSieDim1;
                                break;
                            case 6:
                                io.SalesAccountInternal5 = customerIODTO.SalesAccountSieDim1;
                                break;
                        }
                    }
                    if (accountSiedim6 != null && customerIODTO.AccountsReceivableAccountSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 2:
                                io.AccountsReceivableAccountInternal1 = customerIODTO.AccountsReceivableAccountSieDim6;
                                break;
                            case 3:
                                io.AccountsReceivableAccountInternal2 = customerIODTO.AccountsReceivableAccountSieDim6;
                                break;
                            case 4:
                                io.AccountsReceivableAccountInternal3 = customerIODTO.AccountsReceivableAccountSieDim6;
                                break;
                            case 5:
                                io.AccountsReceivableAccountInternal4 = customerIODTO.AccountsReceivableAccountSieDim6;
                                break;
                            case 6:
                                io.AccountsReceivableAccountInternal5 = customerIODTO.AccountsReceivableAccountSieDim6;
                                break;
                        }
                    }
                    if (accountSiedim6 != null && customerIODTO.SalesAccountSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 2:
                                io.SalesAccountInternal1 = customerIODTO.SalesAccountSieDim6;
                                break;
                            case 3:
                                io.SalesAccountInternal2 = customerIODTO.SalesAccountSieDim6;
                                break;
                            case 4:
                                io.SalesAccountInternal3 = customerIODTO.SalesAccountSieDim6;
                                break;
                            case 5:
                                io.SalesAccountInternal4 = customerIODTO.SalesAccountSieDim6;
                                break;
                            case 6:

                                io.SalesAccountInternal5 = customerIODTO.SalesAccountSieDim6;
                                break;
                        }
                    }

                    io.Status = (int)TermGroup_IOStatus.UnderProcessing;

                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    io.Status = (int)TermGroup_IOStatus.Error;
                    io.ErrorMessage = GetText(8383, "Okänt fel, kunde inte spara all rådata");
                }
            }

            #endregion

            return io;
        }

        #endregion

        #endregion

        #region CustomerInvoiceRowIO

        #region Import to CustomerInvoiceIO

        public ActionResult ImportCustomerInvoiceRowIO(CustomerInvoiceRowIOItem customerInvoiceRowIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool importToCustomerInvoiceRow, string specialFunctionality = "")
        {
            ActionResult result = null;
            List<CustomerInvoiceRowIO> ios = new List<CustomerInvoiceRowIO>();

            string batchId = GenerateBatchId();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    foreach (var customerInvoiceRow in customerInvoiceRowIOItem.customerInvoiceRows)
                    {
                        CustomerInvoiceRowIO customerInvoiceRowIO = CreateCustomerInvoiceRowIO(headType, source, type, batchId, importId, actorCompanyId, customerInvoiceRow, null, specialFunctionality);
                        entities.CustomerInvoiceRowIO.AddObject(customerInvoiceRowIO);
                        ios.Add(customerInvoiceRowIO);
                    }

                    //Save
                    result = SaveChanges(entities);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportCustomerInvoiceRowIO(CustomerInvoiceRowIOItem customerInvoiceRowIOItem):");
                }
            }

            // Overriding auto import for specials
            var originType = SoeOriginType.CustomerInvoice;
            var invRegType = OrderInvoiceRegistrationType.Ledger;
            if (specialFunctionality.Contains("Hsb_orderrad"))
            {
                importToCustomerInvoiceRow = true;
                invRegType = OrderInvoiceRegistrationType.Order;
                originType = SoeOriginType.Order;
            }

            if (result.Success && importToCustomerInvoiceRow)
                result = ImportFromCustomerInvoiceRowIO(ios, importId, actorCompanyId, invRegType, originType);

            result.StringValue = batchId;

            return result;
        }

        #endregion

        #region Import from CustomerInvoiceRow

        public ActionResult ImportCustomerInvoiceRowIO(List<int> iosIds, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    List<CustomerInvoiceRowIO> ios = entities.CustomerInvoiceRowIO.Where(io => iosIds.Contains(io.CustomerInvoiceRowIOId)).ToList();
                    foreach (CustomerInvoiceRowIO io in ios)
                    {
                        io.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    }

                    int importId = ios.FirstOrDefault()?.ImportId ?? 0;
                    return ImportFromCustomerInvoiceRowIO(ios, importId, actorCompanyId);
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(ex);
                }
            }
        }

        public ActionResult ImportFromCustomerInvoiceRowIO(List<CustomerInvoiceRowIO> customerInvoiceRowIOs, int importId, int actorCompanyId, OrderInvoiceRegistrationType invRegType = OrderInvoiceRegistrationType.Ledger, SoeOriginType originType = SoeOriginType.CustomerInvoice)
        {
            if (customerInvoiceRowIOs == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoiceRowIO");

            ActionResult result = new ActionResult();
            #region Init

            int counter = customerInvoiceRowIOs.Count;
            int counterTransferred = 0;
            int counterErrorOccurred = 0;
            #endregion

            #region Prereq

            // Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            var invoiceImportCache = new ImportCustomerInvoiceCache(AccountManager, ProductManager);
            invoiceImportCache.FillCache(actorCompanyId, importId, this, SettingManager, WholeSellerManager, ProductPricelistManager);

            int accountDimStdId = AccountManager.GetAccountDimStd(actorCompanyId).AccountDimId;

            this.rowNr = 0;

            #endregion

            try
            {
                List<string> specialFunctionality = GetSpecialFunctionality(actorCompanyId, importId);
                customerInvoiceRowIOs = customerInvoiceRowIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing).ToList();

                #region Perform

                var customerInvoiceRowIOsInvoiceNrGrouping = customerInvoiceRowIOs.GroupBy(g => g.InvoiceNr).ToList();
                foreach (var customerInvoiceRowIOsInvoiceNrGroup in customerInvoiceRowIOsInvoiceNrGrouping)
                {
                    string invoiceNr = customerInvoiceRowIOsInvoiceNrGroup.Key;
                    List<CustomerInvoiceRowIO> customerInvoiceRowIOsByInvoiceNr = customerInvoiceRowIOsInvoiceNrGroup.ToList();

                    ActionResult transferedResult = ImportFromCustomerInvoiceRowIO(customerInvoiceRowIOsByInvoiceNr, specialFunctionality, actorCompanyId, invoiceNr, invoiceImportCache, accountDimStdId, invRegType, originType);

                    using (CompEntities entities = new CompEntities())
                    {
                        var rowIds = customerInvoiceRowIOsByInvoiceNr.Select(x => x.CustomerInvoiceRowIOId).ToList();
                        var ios = entities.CustomerInvoiceRowIO.Where(i => i.InvoiceNr == invoiceNr && rowIds.Contains(i.CustomerInvoiceRowIOId)).ToList();

                        foreach (var io in customerInvoiceRowIOsByInvoiceNr)
                        {
                            var customerInvoiceRowIO = ios.FirstOrDefault(x => x.CustomerInvoiceRowIOId == io.CustomerInvoiceRowIOId);
                            if (customerInvoiceRowIO == null)
                                continue;

                            if (!transferedResult.Success)
                            {
                                customerInvoiceRowIO.Status = (int)TermGroup_IOStatus.Error;
                                customerInvoiceRowIO.InvoiceId = transferedResult.IntegerValue;
                                string errorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                                if (transferedResult.StrDict != null && transferedResult.StrDict.ContainsKey(customerInvoiceRowIO.CustomerInvoiceRowIOId))
                                    errorMessage = transferedResult.StrDict[customerInvoiceRowIO.CustomerInvoiceRowIOId];
                                customerInvoiceRowIO.ErrorMessage = errorMessage;
                                counterErrorOccurred++;
                            }
                            else
                            {
                                counterTransferred++;
                                customerInvoiceRowIO.Status = (int)TermGroup_IOStatus.Processed;
                                customerInvoiceRowIO.InvoiceId = transferedResult.IntegerValue;
                                customerInvoiceRowIO.ErrorMessage = "";
                            }
                        }

                        result = SaveChanges(entities);
                        if (!result.Success)
                            return result;
                    }
                }

                #endregion
            }
            catch (Exception e)
            {
                result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                base.LogError(e, this.log);
            }
            result.InfoMessage = string.Format(GetText(8425, "{0} Fakturarader utav {1} har skapats/uppdaterats."), counterTransferred, counter);
            result.SuccessNumber = counterTransferred;
            result.StringValue = string.Format("{0},{1}", counterTransferred, counterErrorOccurred);


            return result;
        }

        public ActionResult ImportFromCustomerInvoiceRowIO(List<CustomerInvoiceRowIO> customerInvoiceRowIOsForInvoice, List<string> specialFunctionality, int actorCompanyId, string invoiceNr, ImportCustomerInvoiceCache invoiceImportCache, int accountDimStdId, OrderInvoiceRegistrationType invRegType = OrderInvoiceRegistrationType.Ledger, SoeOriginType originType = SoeOriginType.CustomerInvoice)
        {
            ActionResult result = new ActionResult();

            if (customerInvoiceRowIOsForInvoice.IsNullOrEmpty())
                return result;

            try
            {
                CustomerInvoiceRowIO firstIO = customerInvoiceRowIOsForInvoice.FirstOrDefault();
                if (firstIO == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoiceRowIO");

                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                List<Account> accounts = GetCompanyAccountsWithAccountDim(entitiesReadOnly, actorCompanyId);

                if (firstIO.CustomerRowType == (int)SoeInvoiceRowType.AccountingRow)
                {
                    CustomerInvoice invoice = InvoiceManager.GetCustomerInvoiceByNr(entitiesReadOnly, invoiceNr, originType, invRegType, actorCompanyId, false);
                    if (invoice == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, string.Format(GetText(8427, "Faktura med fakturanr {0} kunde inte hittas"), invoiceNr));

                    if (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Draft)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, string.Format(GetText(4866, "Faktura med fakturanr {0} har ogiltig status"), invoiceNr));

                    List<AccountingRowDTO> accountingRows = new List<AccountingRowDTO>();
                    CustomerLedgerSaveDTO invoiceSaveDTO = new CustomerLedgerSaveDTO();

                    bool useAccountDistribution = GetImport(actorCompanyId, (int)firstIO.ImportId).UseAccountDistribution;

                    if (specialFunctionality.Contains("Automaster"))
                        useAccountDistribution = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceUseAutomaticDistributionInImport, 0, actorCompanyId, 0);

                    result = InvoiceManager.ConvertToCustomerLedgerSaveDTO(invoice, ref invoiceSaveDTO);
                    if (!result.Success)
                        return result;

                    bool combineRows = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceCombineImportedAccountingRows, 0, actorCompanyId, 0);

                    if (specialFunctionality.Contains("Automaster") && combineRows)
                    {
                        //Combine accounting rows coming from Automaster
                        result = InvoiceManager.ConvertToCustomerLedgerCombinedAccountingRowDTO(customerInvoiceRowIOsForInvoice, accounts, accountingRows, invoiceSaveDTO.VoucherDate);
                        if (!result.Success)
                            return result;
                    }
                    else
                    {
                        result = InvoiceManager.ConvertToCustomerLedgerAccountingRowDTO(customerInvoiceRowIOsForInvoice, accounts, accountingRows, invoiceSaveDTO.VoucherDate);
                        if (!result.Success)
                            return result;
                    }

                    if (useAccountDistribution)
                    {
                        result = AddAccountDistributionRows(actorCompanyId, accountingRows);
                        if (!result.Success)
                            return result;

                        //renumber accountingRows
                        int rowNbr = 1;
                        foreach (var accRow in accountingRows)
                        {
                            accRow.RowNr = rowNbr;
                            rowNbr++;
                        }
                    }

                    result = InvoiceManager.SaveCustomerLedger(invoiceSaveDTO, accountingRows, actorCompanyId, specialFunctionality, true);
                    if (!result.Success)
                    {
                        string msg = GetText(8428, "Gick inte att spara konteringsrader");
                        if (!string.IsNullOrEmpty(result.ErrorMessage))
                            msg += ": " + result.ErrorMessage;

                        return new ActionResult((int)ActionResultSave.EntityNotFound, msg);
                    }

                    result.IntegerValue = invoice.InvoiceId;
                }
                else if (firstIO.CustomerRowType == (int)SoeInvoiceRowType.ProductRow)
                {
                    result = InvoiceManager.SaveCustomerInvoiceRowsFromIO(actorCompanyId, invoiceNr, customerInvoiceRowIOsForInvoice, invoiceImportCache, accountDimStdId, invRegType, originType);
                }
                else
                {
                    return new ActionResult((int)ActionResultSave.NothingSaved, GetText(8426, "Finns endast stöd för att importera konteringsrader för tillfället"));
                }

            }
            catch (Exception ex)
            {
                result.Exception = ex;
                base.LogError(ex, this.log);
            }

            return result;
        }

        private ActionResult AddAccountDistributionRows(int actorCompanyId, List<AccountingRowDTO> accountingRows)
        {
            ActionResult result = new ActionResult();

            var adm = AccountDistributionManager;
            List<AccountDistributionHeadSmallDTO> accountDistributions = adm.GetAccountDistributionHeadsUsedIn(actorCompanyId, useInImport: true).ToSmallDTOs(true).ToList();
            List<AccountDistributionHeadSmallDTO> matches = new List<AccountDistributionHeadSmallDTO>();

            if (accountDistributions.Count > 0)
            {
                List<AccountingRowDTO> tmpAccountingRows = new List<AccountingRowDTO>();
                foreach (var row in accountingRows)
                {
                    tmpAccountingRows.Add(row);
                }

                foreach (var accRow in tmpAccountingRows)
                {
                    matches.Clear();
                    matches.AddRange(accountDistributions);
                    GetAccountDistributionHeadId(matches, accRow, accountingRows);

                }
            }

            return result;
        }

        private void GetAccountDistributionHeadId(List<AccountDistributionHeadSmallDTO> matches, AccountingRowDTO accountingRow, List<AccountingRowDTO> accountingRows)
        {

            // Match on date
            if (accountingRow.Date.HasValue)
            {
                matches = matches.Where(a => (a.StartDate == null || a.StartDate.Value <= accountingRow.Date.Value.Date) &&
                                             (a.EndDate == null || a.EndDate.Value >= accountingRow.Date.Value.Date)).ToList();
                if (matches.Count == 0)
                    return;
            }

            // Match on accounts
            foreach (var match in matches.ToList())
            {
                // Dim 1
                if (!MatchAccount(match.Dim1Expression, accountingRow.Dim1Nr))
                {
                    matches.Remove(match);
                    continue;
                }
                // Dim 2
                if (match.Dim2Expression != null && !MatchAccount(match.Dim2Expression, accountingRow.Dim2Nr))
                {
                    matches.Remove(match);
                    continue;
                }
                // Dim 3
                if (match.Dim3Expression != null && !MatchAccount(match.Dim3Expression, accountingRow.Dim3Nr))
                {
                    matches.Remove(match);
                    continue;
                }
                // Dim 4
                if (match.Dim4Expression != null && !MatchAccount(match.Dim4Expression, accountingRow.Dim4Nr))
                {
                    matches.Remove(match);
                    continue;
                }
                // Dim 5
                if (match.Dim5Expression != null && !MatchAccount(match.Dim5Expression, accountingRow.Dim5Nr))
                {
                    matches.Remove(match);
                    continue;
                }
                // Dim 6
                if (match.Dim6Expression != null && !MatchAccount(match.Dim6Expression, accountingRow.Dim6Nr))
                {
                    matches.Remove(match);
                    continue;
                }
            }
            if (matches.Count == 0)
                return;

            // Match on Amount
            decimal amount = Math.Abs(accountingRow.DebitAmount - accountingRow.CreditAmount);
            // Loop through remaining matches where an amount condition is specified
            foreach (var match in matches.Where(a => a.Amount != 0).ToList())
            {
                switch ((WildCard)match.AmountOperator)
                {
                    case WildCard.LessThan:
                        if (amount >= match.Amount)
                            matches.Remove(match);
                        break;
                    case WildCard.LessThanOrEquals:
                        if (amount > match.Amount)
                            matches.Remove(match);
                        break;
                    case WildCard.Equals:
                        if (amount != match.Amount)
                            matches.Remove(match);
                        break;
                    case WildCard.GreaterThan:
                        if (amount <= match.Amount)
                            matches.Remove(match);
                        break;
                    case WildCard.GreaterThanOrEquals:
                        if (amount < match.Amount)
                            matches.Remove(match);
                        break;
                    case WildCard.NotEquals:
                        if (amount == match.Amount)
                            matches.Remove(match);
                        break;
                }
            }
            if (matches.Count == 0)
                return;

            AccountDistributionHeadSmallDTO selectedAccountDistribution = matches.FirstOrDefault(match => match.Type == (int)SoeAccountDistributionType.Auto);

            if (selectedAccountDistribution != null && selectedAccountDistribution.Type == (int)SoeAccountDistributionType.Auto)
            {
                accountingRows.Remove(accountingRow);

                if (selectedAccountDistribution.KeepRow)
                {
                    accountingRow.AccountDistributionHeadId = selectedAccountDistribution.AccountDistributionHeadId;
                    accountingRows.Add(accountingRow);
                }

                LoadAccountDistributionRows(selectedAccountDistribution, accountingRow, accountingRows, selectedAccountDistribution.KeepRow);
            }

        }

        private bool MatchAccount(string expression, string accountNr)
        {
            // If expression is empty, entered value must also be empty
            if (String.IsNullOrEmpty(expression) && !String.IsNullOrEmpty(accountNr))
                return false;

            if (string.IsNullOrEmpty(accountNr))
                return false;

            Regex regEx = new Regex(StringUtility.WildCardToRegEx(expression));
            return regEx.IsMatch(accountNr);
        }

        private void LoadAccountDistributionRows(AccountDistributionHeadSmallDTO selectedAccountDistribution, AccountingRowDTO sourceRowItem, List<AccountingRowDTO> accountingRows, bool mapParentRowId = false)
        {
            AccountDistributionManager abm = AccountDistributionManager;
            List<AccountDistributionRowDTO> distributionRows = abm.GetAccountDistributionRows(selectedAccountDistribution.AccountDistributionHeadId);

            decimal sourceAmount = Math.Abs(sourceRowItem.DebitAmount - sourceRowItem.CreditAmount);
            bool isDebitAmount = sourceRowItem.DebitAmount > 0;

            foreach (var row in distributionRows)
            {
                decimal targetAmount = 0, debitAmount = 0, creditAmount = 0;

                AccountingRowDTO rowItem = new AccountingRowDTO();
                rowItem.Type = AccountingRowType.AccountingRow;
                rowItem.Dim1Id = row.Dim1Id != null ? (int)row.Dim1Id : sourceRowItem.Dim1Id;
                rowItem.Dim2Id = row.Dim2KeepSourceRowAccount ? sourceRowItem.Dim2Id : row.Dim2Id;
                rowItem.Dim3Id = row.Dim3KeepSourceRowAccount ? sourceRowItem.Dim3Id : row.Dim3Id;
                rowItem.Dim4Id = row.Dim4KeepSourceRowAccount ? sourceRowItem.Dim4Id : row.Dim4Id;
                rowItem.Dim5Id = row.Dim5KeepSourceRowAccount ? sourceRowItem.Dim5Id : row.Dim5Id;
                rowItem.Dim6Id = row.Dim6KeepSourceRowAccount ? sourceRowItem.Dim6Id : row.Dim6Id;

                rowItem.AccountDistributionHeadId = row.AccountDistributionHeadId;

                // Set amount
                switch (selectedAccountDistribution.CalculationType)
                {
                    case TermGroup_AccountDistributionCalculationType.Percent:
                        targetAmount = sourceAmount * (row.SameBalance != 0 ? row.SameBalance : row.OppositeBalance) / 100;
                        break;
                    case TermGroup_AccountDistributionCalculationType.Amount:
                        targetAmount = row.SameBalance != 0 ? row.SameBalance : row.OppositeBalance;
                        break;
                    case TermGroup_AccountDistributionCalculationType.TotalAmount:
                        // TODO: Implement
                        break;
                }

                debitAmount = row.SameBalance != 0 ? (isDebitAmount ? targetAmount : 0) : (isDebitAmount ? 0 : targetAmount);
                rowItem.DebitAmount = decimal.Round(debitAmount, 2);

                creditAmount = row.SameBalance != 0 ? (isDebitAmount ? 0 : targetAmount) : (isDebitAmount ? targetAmount : 0);
                rowItem.CreditAmount = decimal.Round(creditAmount, 2);

                rowItem.Amount = rowItem.DebitAmount - rowItem.CreditAmount;

                // Set row type
                rowItem.IsDebitRow = rowItem.DebitAmount > 0;
                rowItem.IsCreditRow = rowItem.CreditAmount > 0;

                if (mapParentRowId)
                    rowItem.ParentRowId = sourceRowItem.TempRowId;

                accountingRows.Add(rowItem);
            }
        }

        #endregion

        #region Help methods

        public List<CustomerInvoiceRowIO> GetCustomerInvoiceRowIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceHeadIO.NoTracking();
            var query = (from io in entities.CustomerInvoiceRowIO
                         where io.ActorCompanyId == actorCompanyId &&
                         io.BatchId == batchId
                         orderby io.CustomerInvoiceRowIOId
                         select io);

            if (type != TermGroup_IOType.Unknown)
                query.Where(io => io.Type == (int)type);
            if (source != TermGroup_IOSource.Unknown)
                query.Where(io => io.Source == (int)source);

            List<CustomerInvoiceRowIO> ios = query.ToList();
            if (!ios.IsNullOrEmpty())
            {
                int langId = GetLangId();
                Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);

                foreach (var io in ios)
                {
                    io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : String.Empty;
                }
            }

            return ios;
        }

        public ActionResult UpdateCustomerInvoiceRowIO(List<CustomerInvoiceRowIODTO> dtos)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    foreach (CustomerInvoiceRowIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        CustomerInvoiceRowIO io = GetCustomerInvoiceRowIO(entities, dto.CustomerInvoiceRowIOId);
                        if (io != null)
                        {
                            #region Convert from dto

                            io.InvoiceId = dto.InvoiceId.ToNullable();
                            io.ActorCompanyId = dto.ActorCompanyId;
                            io.Import = dto.Import;
                            io.Type = (int)dto.Type;
                            io.Status = dto.Status;
                            io.Source = dto.Source;
                            io.BatchId = dto.BatchId;
                            io.CustomerRowType = (int)dto.CustomerRowType;
                            io.ProductNr = dto.ProductNr;
                            io.ProductName = dto.ProductName;
                            io.ProductName2 = dto.ProductName2;
                            io.Quantity = dto.Quantity;
                            io.UnitPrice = dto.UnitPrice;
                            io.Discount = dto.Discount;
                            io.AccountNr = dto.AccountNr;
                            io.AccountDim2Nr = dto.AccountDim2Nr;
                            io.AccountDim3Nr = dto.AccountDim3Nr;
                            io.AccountDim4Nr = dto.AccountDim4Nr;
                            io.AccountDim5Nr = dto.AccountDim5Nr;
                            io.AccountDim6Nr = dto.AccountDim6Nr;
                            io.PurchasePrice = dto.PurchasePrice;
                            io.PurchasePriceCurrency = dto.PurchasePriceCurrency;
                            io.Amount = dto.Amount;
                            io.AmountCurrency = dto.AmountCurrency;
                            io.VatAmount = dto.VatAmount;
                            io.VatAmountCurrency = dto.VatAmountCurrency;
                            io.VatCode = dto.VatCode;
                            io.DiscountAmount = dto.DiscountAmount;
                            io.DiscountAmountCurrency = dto.DiscountAmountCurrency;
                            io.MarginalIncome = dto.MarginalIncome;
                            io.MarginalIncomeCurrency = dto.MarginalIncomeCurrency;
                            io.SumAmount = dto.SumAmount;
                            io.SumAmountCurrency = dto.SumAmountCurrency;
                            io.Text = dto.Text;
                            io.ErrorMessage = dto.ErrorMessage;
                            io.ImportHeadType = dto.ImportHeadType;
                            io.RowNr = dto.RowNr;
                            io.Created = dto.Created;
                            io.CreatedBy = dto.CreatedBy;
                            io.Modified = dto.Modified;
                            io.ModifiedBy = dto.ModifiedBy;
                            io.State = dto.State;
                            io.StatusName = dto.StatusName;

                            #endregion

                            SetModifiedProperties(io);
                        }
                    }

                    return SaveChanges(entities);
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(ex);
                }
            }
        }

        private CustomerInvoiceRowIO GetCustomerInvoiceRowIO(CompEntities entities, int customerInvoiceRowIOId)
        {
            return (from io in entities.CustomerInvoiceRowIO
                    where io.CustomerInvoiceHeadIOId == customerInvoiceRowIOId
                    select io).FirstOrDefault();
        }

        private CustomerInvoiceRowIO CreateCustomerInvoiceRowIO(TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, string batchId, int importId, int actorCompanyId, CustomerInvoiceRowIODTO customerInvoiceRowIODTO, CustomerInvoiceHeadIO headio = null, string specialFunctionality = "")
        {
            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimDTOFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimDTOFromSieDimNr(sieDim6, actorCompanyId);

            var rowio = new CustomerInvoiceRowIO
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.UnderProcessing,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
                ImportId = importId,
            };

            headio?.CustomerInvoiceRowIO.Add(rowio);

            SetCreatedProperties(rowio);

            #region Validation
            // Amount is Decimal(10, 2) which means max 8 characters
            if (customerInvoiceRowIODTO.SumAmount > 100000000 ||
                customerInvoiceRowIODTO.SumAmountCurrency > 100000000 ||
                customerInvoiceRowIODTO.Amount > 100000000)
            {
                rowio.Status = (int)TermGroup_IOStatus.Error;
                return null;
            }
            #endregion

            #region Fill Invoicerow

            if (accountSiedim1 != null && customerInvoiceRowIODTO.AccountSieDim1 != null)
            {
                switch (accountSiedim1.AccountDimNr)
                {
                    case 2:
                        customerInvoiceRowIODTO.AccountDim2Nr = customerInvoiceRowIODTO.AccountSieDim1;
                        break;
                    case 3:
                        customerInvoiceRowIODTO.AccountDim3Nr = customerInvoiceRowIODTO.AccountSieDim1;
                        break;
                    case 4:
                        customerInvoiceRowIODTO.AccountDim4Nr = customerInvoiceRowIODTO.AccountSieDim1;
                        break;
                    case 5:
                        customerInvoiceRowIODTO.AccountDim5Nr = customerInvoiceRowIODTO.AccountSieDim1;
                        break;
                    case 6:
                        customerInvoiceRowIODTO.AccountDim6Nr = customerInvoiceRowIODTO.AccountSieDim1;
                        break;
                }
            }
            if (accountSiedim1 != null && customerInvoiceRowIODTO.ClaimAccountNrSieDim1 != null)
            {
                switch (accountSiedim1.AccountDimNr)
                {
                    case 2:
                        customerInvoiceRowIODTO.ClaimAccountNrDim2 = customerInvoiceRowIODTO.ClaimAccountNrSieDim1;
                        break;
                    case 3:
                        customerInvoiceRowIODTO.ClaimAccountNrDim3 = customerInvoiceRowIODTO.ClaimAccountNrSieDim1;
                        break;
                    case 4:
                        customerInvoiceRowIODTO.ClaimAccountNrDim4 = customerInvoiceRowIODTO.ClaimAccountNrSieDim1;
                        break;
                    case 5:
                        customerInvoiceRowIODTO.ClaimAccountNrDim5 = customerInvoiceRowIODTO.ClaimAccountNrSieDim1;
                        break;
                    case 6:
                        customerInvoiceRowIODTO.ClaimAccountNrDim6 = customerInvoiceRowIODTO.ClaimAccountNrSieDim1;
                        break;
                }
            }
            if (accountSiedim6 != null && customerInvoiceRowIODTO.AccountSieDim6 != null)
            {
                switch (accountSiedim6.AccountDimNr)
                {
                    case 2:
                        customerInvoiceRowIODTO.AccountDim2Nr = customerInvoiceRowIODTO.AccountSieDim6;
                        break;
                    case 3:
                        customerInvoiceRowIODTO.AccountDim3Nr = customerInvoiceRowIODTO.AccountSieDim6;
                        break;
                    case 4:
                        customerInvoiceRowIODTO.AccountDim4Nr = customerInvoiceRowIODTO.AccountSieDim6;
                        break;
                    case 5:
                        customerInvoiceRowIODTO.AccountDim5Nr = customerInvoiceRowIODTO.AccountSieDim6;
                        break;
                    case 6:
                        customerInvoiceRowIODTO.AccountDim6Nr = customerInvoiceRowIODTO.AccountSieDim6;
                        break;
                }
            }
            if (accountSiedim6 != null && customerInvoiceRowIODTO.ClaimAccountNrSieDim6 != null)
            {
                switch (accountSiedim6.AccountDimNr)
                {
                    case 2:
                        customerInvoiceRowIODTO.ClaimAccountNrDim2 = customerInvoiceRowIODTO.ClaimAccountNrSieDim6;
                        break;
                    case 3:
                        customerInvoiceRowIODTO.ClaimAccountNrDim3 = customerInvoiceRowIODTO.ClaimAccountNrSieDim6;
                        break;
                    case 4:
                        customerInvoiceRowIODTO.ClaimAccountNrDim4 = customerInvoiceRowIODTO.ClaimAccountNrSieDim6;
                        break;
                    case 5:
                        customerInvoiceRowIODTO.ClaimAccountNrDim5 = customerInvoiceRowIODTO.ClaimAccountNrSieDim6;
                        break;
                    case 6:
                        customerInvoiceRowIODTO.ClaimAccountNrDim6 = customerInvoiceRowIODTO.ClaimAccountNrSieDim6;
                        break;
                }
            }

            rowio.InvoiceId = customerInvoiceRowIODTO.InvoiceId == 0 ? (int?)null : customerInvoiceRowIODTO.InvoiceId;
            rowio.InvoiceNr = customerInvoiceRowIODTO.InvoiceNr;
            rowio.CustomerRowType = (int)customerInvoiceRowIODTO.CustomerRowType;
            rowio.ProductNr = customerInvoiceRowIODTO.ProductNr;
            rowio.ProductName = customerInvoiceRowIODTO.ProductName?.Left(100);
            rowio.ProductName2 = customerInvoiceRowIODTO.ProductName2?.Left(100);
            rowio.Quantity = customerInvoiceRowIODTO.Quantity;
            rowio.UnitPrice = customerInvoiceRowIODTO.UnitPrice;
            rowio.Discount = customerInvoiceRowIODTO.Discount;
            rowio.VatAccountnr = customerInvoiceRowIODTO.VatAccountnr;
            rowio.Stock = customerInvoiceRowIODTO.Stock;
            rowio.StockId = customerInvoiceRowIODTO.StockId;
            rowio.AccountNr = customerInvoiceRowIODTO.AccountNr;
            rowio.AccountDim2Nr = customerInvoiceRowIODTO.AccountDim2Nr;
            rowio.AccountDim3Nr = customerInvoiceRowIODTO.AccountDim3Nr;
            rowio.AccountDim4Nr = customerInvoiceRowIODTO.AccountDim4Nr;
            rowio.AccountDim5Nr = customerInvoiceRowIODTO.AccountDim5Nr;
            rowio.AccountDim6Nr = customerInvoiceRowIODTO.AccountDim6Nr;
            rowio.PurchasePrice = customerInvoiceRowIODTO.PurchasePrice;
            rowio.PurchasePriceCurrency = customerInvoiceRowIODTO.PurchasePriceCurrency;
            rowio.Amount = customerInvoiceRowIODTO.Amount;
            rowio.AmountCurrency = customerInvoiceRowIODTO.AmountCurrency;
            rowio.VatAmount = customerInvoiceRowIODTO.VatAmount;
            rowio.VatAmountCurrency = customerInvoiceRowIODTO.VatAmountCurrency;
            rowio.DiscountAmount = customerInvoiceRowIODTO.DiscountAmount;
            rowio.DiscountAmountCurrency = customerInvoiceRowIODTO.DiscountAmountCurrency;
            rowio.MarginalIncome = customerInvoiceRowIODTO.MarginalIncome;
            rowio.MarginalIncomeCurrency = customerInvoiceRowIODTO.MarginalIncomeCurrency;
            rowio.SumAmount = customerInvoiceRowIODTO.SumAmount;
            rowio.SumAmountCurrency = customerInvoiceRowIODTO.SumAmountCurrency;
            rowio.Text = customerInvoiceRowIODTO.Text;
            rowio.RowNr = customerInvoiceRowIODTO.RowNr;
            rowio.RowDate = (customerInvoiceRowIODTO.RowDate <= CalendarUtility.DATETIME_DEFAULT ? (DateTime?)null : customerInvoiceRowIODTO.RowDate);
            rowio.Unit = customerInvoiceRowIODTO.Unit;
            rowio.VatRate = customerInvoiceRowIODTO.VatRate;
            rowio.PurchasePrice = customerInvoiceRowIODTO.PurchasePrice;
            rowio.PurchasePriceCurrency = customerInvoiceRowIODTO.PurchasePriceCurrency;
            rowio.VatCode = customerInvoiceRowIODTO.VatCode;
            rowio.DeliveryDateText = customerInvoiceRowIODTO.DeliveryDateText;

            #region Try to fill empty amounts

            if (rowio.Quantity == 0 && rowio.UnitPrice != 0)
                rowio.Quantity = 1;

            if (!rowio.AmountCurrency.HasValue && rowio.Amount.HasValue)
                rowio.AmountCurrency = rowio.Amount;

            if (!rowio.DiscountAmountCurrency.HasValue && rowio.DiscountAmount.HasValue)
                rowio.DiscountAmountCurrency = rowio.DiscountAmount;

            if (!rowio.MarginalIncomeCurrency.HasValue && rowio.MarginalIncome.HasValue)
                rowio.MarginalIncomeCurrency = rowio.MarginalIncome;

            if (!rowio.SumAmountCurrency.HasValue && rowio.SumAmountCurrency.HasValue)
                rowio.SumAmountCurrency = rowio.SumAmount;

            if (!rowio.VatAmountCurrency.HasValue && rowio.VatAmount.HasValue)
                rowio.VatAmountCurrency = rowio.VatAmount;

            if (!rowio.PurchasePriceCurrency.HasValue && rowio.PurchasePrice.HasValue)
                rowio.PurchasePriceCurrency = rowio.PurchasePrice;

            #endregion

            #region special functions

            if (specialFunctionality.Contains("Automaster"))
            {
                //Sum needs to be reversed and leading zeros removed from invoice number
                rowio.Amount = rowio.Amount * -1;
                rowio.AmountCurrency = rowio.AmountCurrency * -1;
                rowio.InvoiceNr = rowio.InvoiceNr.TrimStart('0');

            }

            #endregion


            #endregion

            return rowio;
        }

        #endregion

        #endregion

        #region FixedPayrollRows

        #region Import

        public ActionResult ImportFixedPayrollRowIO(FixedPayrollRowIOItem fixedPayrollRowIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFixedPayrollRowsFromIO(fixedPayrollRowIOItem.fixedPayrollRowIOs, actorCompanyId);
        }

        public ActionResult ImportFixedPayrollRowsFromIO(List<FixedPayrollRowIODTO> fixedPayrollRowIODTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            TimeEngineManager timeEngineManager = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);
            List<PayrollProduct> payrollProducts = ProductManager.GetPayrollProducts(actorCompanyId, active: true, loadAccounts: false);
            List<PayrollPriceType> payrollPriceTypes = PayrollManager.GetPayrollPriceTypes(actorCompanyId, null, false);
            List<Employee> employees = EmployeeManager.GetAllEmployees(actorCompanyId, active: null);
            string vacationNr = "401";

            #region Setup ConnectHistory

            ConnectUtil connectUtil = new ConnectUtil(parameterObject);
            ConnectHistoryDTO connectHistory = connectUtil.SetupConnectHistoryDTO(TermGroup_IOImportHeadType.FixedPayrollRow, fixedPayrollRowIODTOs.Count);

            #endregion

            #region Control

            StringBuilder sb = new StringBuilder();

            foreach (var row in fixedPayrollRowIODTOs)
            {
                //Employee
                if (!employees.Any(c => c.EmployeeNr.ToLower() == row.EmployeeNr.ToLower() && !string.IsNullOrEmpty(row.EmployeeNr)))
                    sb.Append("Employee not found " + row.EmployeeNr.ToLower() + Environment.NewLine);

                //Products
                if (!payrollProducts.Any(p => p.Number == row.ProductNr) && !row.ProductNr.Equals(vacationNr) && payrollPriceTypes.Any(p => p.Code.ToLower().Equals(row.ProductNr.ToLower())))
                    sb.Append("ProductNr/PriceType not found " + row.ProductNr.ToLower() + Environment.NewLine);
            }

            if (sb.Length > 0)
            {
                foreach (var employeeRows in fixedPayrollRowIODTOs.GroupBy(f => f.EmployeeNr))
                {
                    if (!employeeRows.Any(e => e.ProductNr.Equals(vacationNr)))
                        continue;

                    string employeeNr = employeeRows.Key;
                    Employee employee = employees.FirstOrDefault(c => c.EmployeeNr.ToLower().Equals(employeeNr.ToLower()) && !string.IsNullOrEmpty(employeeNr));
                    if (employee != null)
                    {
                        foreach (var row in employeeRows)
                        {
                            VacationGroup vacationGroup = PayrollManager.GetVacationGroupForEmployee(actorCompanyId, employee.EmployeeId, row.FromDate);
                            if (vacationGroup == null)
                                sb.Append($"VacationGroup not found for employee {employeeNr} on date {(row.FromDate.HasValue ? row.FromDate.Value.ToShortDateString() : "Unknown")}{Environment.NewLine}");

                            Employment employment = employee.GetEmployment(row.FromDate);
                            if (employment == null)
                                sb.Append($"Employment not found for employee {employeeNr} on date {(row.FromDate.HasValue ? row.FromDate.Value.ToShortDateString() : "Unknown")}{Environment.NewLine}");
                        }
                    }
                }
            }

            if (sb.Length > 0)
            {
                result.Success = false;
                result.ErrorMessage = sb.ToString();
                connectHistory.Success = false;
                connectHistory.Message = result.ErrorMessage;
                connectUtil.SaveConnectHistory(connectHistory);
                return result;
            }

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                foreach (var rows in fixedPayrollRowIODTOs.GroupBy(o => o.EmployeeNr))
                {
                    Employee employee = EmployeeManager.GetEmployeeByNr(entities, rows.Key, actorCompanyId, onlyActive: false);
                    if (employee == null)
                        continue;

                    List<FixedPayrollRowDTO> inputItems = null;
                    foreach (var row in rows)
                    {
                        inputItems = new List<FixedPayrollRowDTO>();
                        bool isPayedVacationPayedAmount = false;

                        if (row.ProductNr.Equals(vacationNr))
                            isPayedVacationPayedAmount = true;

                        int payrollProductId = 0;
                        int priceTypeId = 0;

                        if (payrollProductId == 0 && payrollProducts.Any(p => p.Number == row.ProductNr))
                            payrollProductId = payrollProducts.FirstOrDefault(p => p.Number == row.ProductNr)?.ProductId ?? 0;

                        if (payrollProductId == 0 && priceTypeId == 0 && payrollPriceTypes.Any(p => p.Code.ToLower().Equals(row.ProductNr.ToLower())))
                            priceTypeId = payrollPriceTypes.FirstOrDefault(p => p.Code == row.ProductNr)?.PayrollPriceTypeId ?? 0;

                        if (payrollProductId == 0 && priceTypeId == 0 && !isPayedVacationPayedAmount)
                            continue;

                        if (employee != null)
                        {
                            if (isPayedVacationPayedAmount)
                            {
                                VacationGroup vacationGroup = PayrollManager.GetVacationGroupForEmployee(entities, actorCompanyId, employee.EmployeeId, row.FromDate);
                                if (vacationGroup != null)
                                {
                                    bool existed = true;

                                    EmployeeFactor vacationDayPercentfactor = EmployeeManager.GetEmployeeFactor(TermGroup_EmployeeFactorType.VacationDayPercent, employee.EmployeeId, row.FromDate);
                                    if (vacationDayPercentfactor == null)
                                    {
                                        vacationDayPercentfactor = new EmployeeFactor();
                                        existed = false;
                                    }

                                    vacationDayPercentfactor.Type = (int)TermGroup_EmployeeFactorType.VacationDayPercent;
                                    vacationDayPercentfactor.EmployeeId = employee.EmployeeId;
                                    vacationDayPercentfactor.FromDate = row.FromDate;
                                    vacationDayPercentfactor.VacationGroupId = vacationGroup.VacationGroupId;
                                    vacationDayPercentfactor.Factor = row.Amount;
                                    vacationDayPercentfactor.State = (int)SoeEntityState.Active;
                                    SetCreatedProperties(vacationDayPercentfactor);

                                    if (!existed)
                                        entities.EmployeeFactor.AddObject(vacationDayPercentfactor);

                                    entities.SaveChanges();

                                    EmployeeFactor savedEmployeeFactor = EmployeeManager.GetEmployeeFactor(TermGroup_EmployeeFactorType.VacationDayPercent, employee.EmployeeId, row.FromDate);
                                    connectHistory.ConnectHistoryRowDTOs.Add(connectUtil.SetupConnectHistoryRowDTO(savedEmployeeFactor.Created, savedEmployeeFactor.Modified, savedEmployeeFactor.EmployeeFactorId, row.EmployeeNr, "VacationDayPercent " + (row.FromDate.HasValue ? (row.FromDate.Value).ToShortDateString() + " " + row.Amount.ToString() : row.Amount.ToString())));

                                }
                            }
                            else
                            {
                                FixedPayrollRowDTO dto = new FixedPayrollRowDTO();
                                dto.EmployeeId = employee.EmployeeId;
                                dto.Amount = row.Amount;
                                dto.VatAmount = row.VatAmount;
                                dto.FromDate = row.FromDate;
                                dto.ToDate = row.ToDate;
                                dto.Quantity = row.Quantity;
                                dto.UnitPrice = row.UnitPrice;
                                dto.ActorCompanyId = actorCompanyId;
                                dto.Created = row.Created;
                                dto.CreatedBy = !string.IsNullOrEmpty(row.CreatedBy) ? row.CreatedBy : "Importerad";
                                dto.Modified = row.Modified;
                                dto.ModifiedBy = row.ModifiedBy;
                                dto.ProductNr = row.ProductNr;
                                if (payrollProductId != 0)
                                    dto.ProductId = payrollProductId;
                                dto.IsSpecifiedUnitPrice = row.IsSpecifiedUnitPrice;

                                inputItems.Add(dto);

                                if (priceTypeId != 0)
                                {
                                    var employment = employee.GetEmployment(dto.FromDate);
                                    if (employment != null)
                                    {
                                        EmploymentPriceType employmentPriceType = EmployeeManager.GetEmploymentPriceType(entities, employment.EmploymentId, priceTypeId);
                                        if (employmentPriceType == null)
                                        {
                                            employmentPriceType = new EmploymentPriceType();
                                            employmentPriceType.EmploymentId = employment.EmploymentId;
                                            employmentPriceType.EmploymentPriceTypeId = 0;
                                            employmentPriceType.PayrollPriceTypeId = priceTypeId;
                                            SetCreatedProperties(employmentPriceType);
                                            entities.EmploymentPriceType.AddObject(employmentPriceType);
                                        }

                                        EmploymentPriceTypePeriod employmentPriceTypePeriod = new EmploymentPriceTypePeriod();
                                        employmentPriceTypePeriod.Amount = row.Amount;
                                        employmentPriceTypePeriod.FromDate = row.FromDate;
                                        employmentPriceTypePeriod.EmploymentPriceType = employmentPriceType;
                                        entities.EmploymentPriceTypePeriod.AddObject(employmentPriceTypePeriod);
                                        result = SaveChanges(entities);
                                        if (!result.Success)
                                            continue;

                                        EmploymentPriceType savedEmploymentPriceType = EmployeeManager.GetEmploymentPriceType(entities, employment.EmploymentId, priceTypeId);
                                        connectHistory.ConnectHistoryRowDTOs.Add(connectUtil.SetupConnectHistoryRowDTO(savedEmploymentPriceType.Created, savedEmploymentPriceType.Modified, savedEmploymentPriceType.EmploymentPriceTypeId, row.EmployeeNr, "EmploymentPriceType " + (row.FromDate.HasValue ? (row.FromDate.Value).ToShortDateString() + " " + row.Amount.ToString() : row.Amount.ToString())));
                                    }
                                }
                            }
                        }

                        result = timeEngineManager.SaveFixedPayrollRows(inputItems, employee.EmployeeId);
                    }
                }
            }

            return result;
        }

        #endregion

        #endregion

        #region SupplierInvoice

        public List<SupplierInvoiceIODTO> GetSupplierInvoiceIODTOs(int actorCompanyId, SupplierInvoiceFilterIODTO filter)
        {
            if (filter.PageNrOfRecords <= 0)
            {
                filter.PageNrOfRecords = 5000;
            }

            using (var entities = new CompEntities())
            {
                entities.CommandTimeout = 120;
                IQueryable<SupplierInvoice> query = (from i in entities.Invoice.OfType<SupplierInvoice>()
                                                     where i.Origin.ActorCompanyId == actorCompanyId &&
                                                     i.State == (int)SoeEntityState.Active &&
                                                     i.Origin.Type == (int)SoeOriginType.SupplierInvoice
                                                     select i);


                if (filter.InvoiceDateFrom.HasValue)
                {
                    query = query.Where(i => i.InvoiceDate >= filter.InvoiceDateFrom.Value);
                }

                if (filter.InvoiceDateTo.HasValue)
                {
                    query = query.Where(i => i.InvoiceDate <= filter.InvoiceDateTo.Value);
                }

                if (!string.IsNullOrEmpty(filter.Number))
                {
                    query = query.Where(i => i.InvoiceNr == filter.Number);
                }

                if (filter.InvoiceId.HasValue)
                {
                    query = query.Where(i => i.InvoiceId == filter.InvoiceId.Value);
                }

                if (!string.IsNullOrEmpty(filter.SupplierNr))
                {
                    query = query.Where(i => i.Actor.Supplier.SupplierNr == filter.SupplierNr);
                }

                if (filter.PageNumber > 0)
                {
                    query = query.OrderBy(i => i.InvoiceId).Skip(filter.PageNrOfRecords * (filter.PageNumber - 1));
                }

                if (!filter.IncludePreliminary)
                {
                    query = query.Where(i => (i.Origin.Status != (int)SoeOriginStatus.Draft));
                }

                var invoicesIO = query.Take(filter.PageNrOfRecords).Select(i =>
                        new SupplierInvoiceIODTO
                        {
                            InvoiceNr = i.InvoiceNr,
                            InvoiceId = i.InvoiceId,
                            SeqNr = i.SeqNr,
                            SupplierName = i.Actor.Supplier.Name,
                            SupplierId = i.Actor.Supplier.ActorSupplierId,
                            SupplierNr = i.Actor.Supplier.SupplierNr,
                            SupplierOrgnr = i.Actor.Supplier.OrgNr,
                            DueDate = i.DueDate,
                            InvoiceDate = i.InvoiceDate,
                            CurrencyRate = i.CurrencyRate,
                            CurrencyDate = i.CurrencyDate,
                            Currency = i.Currency.SysCurrencyId.ToString(),
                            TotalAmount = i.TotalAmount,
                            TotalAmountCurrency = i.TotalAmountCurrency,
                            VATAmount = i.VATAmount,
                            VATAmountCurrency = i.VATAmountCurrency,
                            VatType = i.VatType,
                            VoucherDate = i.VoucherDate,
                            VoucherNr = i.VoucherHead.VoucherNr.ToString(),
                            Created = i.Created,
                            CreatedBy = i.CreatedBy,
                            Modified = i.Modified,
                            ModifiedBy = i.ModifiedBy,
                            ReferenceOur = i.ReferenceOur,
                            ReferenceYour = i.ReferenceYour,
                            BillingType = i.BillingType,
                            ExternalId = i.ExternalId,
                            OriginStatus = i.Origin.Status,
                            OriginStatusName = i.Origin.Description
                        }).ToList();

                foreach (var i in invoicesIO)
                {
                    if (!string.IsNullOrEmpty(i.Currency))
                    {
                        i.Currency = CountryCurrencyManager.GetCurrencyCode(int.Parse(i.Currency));
                    }
                }

                return invoicesIO;
            }
        }

        public SupplierInvoiceIODTO GetSupplierInvoiceIODTOs(int actorCompanyId, int? invoiceId)
        {
            var invoice = SupplierInvoiceManager.GetSupplierInvoice((int)invoiceId, true, true, false, false, false, true, false, false, false, false);

            if (invoice == null)
                return null;

            if (!invoice.CurrencyReference.IsLoaded)
                invoice.CurrencyReference.Load();

            var invoiceIO = new SupplierInvoiceIODTO
            {
                InvoiceNr = invoice.InvoiceNr,
                InvoiceId = invoice.InvoiceId,
                SeqNr = invoice.SeqNr,
                SupplierName = invoice.Actor?.Supplier?.Name,
                SupplierId = invoice.Actor?.Supplier?.ActorSupplierId,
                SupplierNr = invoice.Actor?.Supplier?.SupplierNr,
                SupplierOrgnr = invoice.Actor?.Supplier?.OrgNr,
                DueDate = invoice.DueDate,
                InvoiceDate = invoice.InvoiceDate,
                CurrencyRate = invoice.CurrencyRate,
                CurrencyDate = invoice.CurrencyDate,
                Currency = invoice.Currency.Code,
                TotalAmount = invoice.TotalAmount,
                TotalAmountCurrency = invoice.TotalAmountCurrency,
                VATAmount = invoice.VATAmount,
                VATAmountCurrency = invoice.VATAmountCurrency,
                VatType = invoice.VatType,
                VoucherDate = invoice.VoucherDate,
                Created = invoice.Created,
                CreatedBy = invoice.CreatedBy,
                Modified = invoice.Modified,
                ModifiedBy = invoice.ModifiedBy,
                ReferenceOur = invoice.ReferenceOur,
                ReferenceYour = invoice.ReferenceYour,
                BillingType = invoice.BillingType,
                ExternalId = invoice.ExternalId,
                OriginStatus = invoice.Origin.Status,
                OriginStatusName = invoice.Origin.Description
            };

            foreach (var row in invoice.ActiveSupplierInvoiceRows)
            {
                var rowDTOs = row.ToSupplierInvoiceRowDTO(invoice, true, null);

                foreach (var rowDTO in rowDTOs.AccountingRows)
                {

                    var rowIODTO = new SupplierInvoiceRowIODTO
                    {
                        AccountDim2Nr = rowDTO.Dim2Nr,
                        AccountDim3Nr = rowDTO.Dim3Nr,
                        AccountDim4Nr = rowDTO.Dim4Nr,
                        AccountDim5Nr = rowDTO.Dim5Nr,
                        AccountDim6Nr = rowDTO.Dim6Nr,
                        AccountNr = rowDTO.Dim1Nr,
                        Amount = rowDTO.Amount,
                        AmountCurrency = rowDTO.AmountCurrency,
                        Quantity = rowDTO.Quantity,
                        Text = rowDTO.Text
                    };

                    invoiceIO.InvoiceRows.Add(rowIODTO);
                }
            }

            return invoiceIO;
        }


        public SupplierInvoiceImageIODTO GetSupplierInvoiceImageIODTO(int actorCompanyId, int invoiceId)
        {
            var invoicePermission = FeatureManager.HasRolePermission(Feature.Economy_Supplier_Invoice, Permission.Modify, parameterObject.RoleId, actorCompanyId);
            if (!invoicePermission)
                return null;

            var image = SupplierInvoiceManager.GetSupplierInvoiceImage(actorCompanyId, invoiceId);

            if (image == null)
                return null;

            return new SupplierInvoiceImageIODTO()
            {
                InvoiceId = invoiceId,
                FileId = image.Id,
                Base64Data = Convert.ToBase64String(image.Image),
                Filename = image.Filename,
                MimeType = ImageUtil.GetMimeType(image.Format)
            };
        }
        #endregion

        #region CustomerInvoice

        public List<CustomerOrderSearchResultIODTO> SearchCustomerOrder(int actorCompanyId, CustomerOrderSearchIODTO searchDTO, int maxNrRows)
        {
            if (maxNrRows > 9999)
            {
                maxNrRows = 9999;
            }

            var searchResult = InvoiceManager.GetInvoicesBySearch(actorCompanyId, (int)SoeOriginType.Order,
                new CustomerInvoiceSearchParamsDTO
                {
                    CustomerNr = searchDTO.CustomerNr,
                    Number = searchDTO.Number,
                    IncludeClosed = searchDTO.IncludeClosed.GetValueOrDefault(),
                    InvoiceDateFrom = searchDTO.OrderDateFrom,
                    InvoiceDateTo = searchDTO.OrderDateTo
                }, maxNrRows);

            return searchResult.Select(p => new CustomerOrderSearchResultIODTO
            {
                CustomerName = p.CustomerName,
                CustomerNr = p.CustomerNr,
                CustomerId = p.CustomerId,
                CustomerInvoiceId = p.CustomerInvoiceId,
                Number = p.Number,
                OrderDate = p.InvoiceDate,
                TotalAmount = p.TotalAmount,
                VatAmount = p.VatAmount
            }).ToList();
        }

        public List<CustomerInvoiceSearchResultIODTO> SearchCustomerInvoice(int actorCompanyId, CustomerInvoiceSearchIODTO searchDTO, int maxNrRows)
        {
            if (maxNrRows > 9999)
            {
                maxNrRows = 9999;
            }

            var searchResult = InvoiceManager.GetInvoicesBySearch(actorCompanyId, (int)SoeOriginType.CustomerInvoice,
                new CustomerInvoiceSearchParamsDTO
                {
                    CustomerNr = searchDTO.CustomerNr,
                    Number = searchDTO.Number,
                    FullyPaid = searchDTO.FullyPaid,
                    IncludePreliminary = searchDTO.IncludePreliminary.GetValueOrDefault(),
                    InvoiceDateFrom = searchDTO.InvoiceDateFrom,
                    InvoiceDateTo = searchDTO.InvoiceDateTo,
                    IncludeVoucher = searchDTO.IncludeVoucherStatus.GetValueOrDefault()
                }, maxNrRows);

            return searchResult.Select(p => new CustomerInvoiceSearchResultIODTO
            {
                CustomerName = p.CustomerName,
                CustomerNr = p.CustomerNr,
                CustomerId = p.CustomerId,
                CustomerInvoiceId = p.CustomerInvoiceId,
                Number = p.Number,
                DueDate = p.DueDate,
                InvoiceDate = p.InvoiceDate,
                TotalAmount = p.TotalAmount,
                VatAmount = p.VatAmount,
                PaidAmount = p.PaidAmount,
                BillingType = p.BillingType
            }).ToList();
        }

        public List<int> GetCustomerInvoiceIdsFromExternalId(int actorCompanyId, SoeOriginType originType, string externalId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return InvoiceManager.GetCustomerInvoiceIdsByExternalId(entitiesReadOnly, actorCompanyId, externalId, originType);
        }

        public List<CustomerInvoiceSmallIODTO> GetCustomerInvoiceSmallIODTOs(int actorCompanyId, SoeOriginType originType, CustomerInvoiceFilterIODTO filter)
        {
#if DEBUG
            Stopwatch timer = new Stopwatch();
            timer.Start();
#endif

            var accountDimIds = AccountManager.GetAccountDimIds(actorCompanyId);
            List<Account> accounts = AccountManager.GetAccounts(actorCompanyId);

            if (filter.PageNrOfRecords <= 0)
            {
                filter.PageNrOfRecords = 5000;
            }

            using (var entities = new CompEntities())
            {
                entities.CommandTimeout = 120;
                IQueryable<CustomerInvoice> query = (from i in entities.Invoice.OfType<CustomerInvoice>()
                                                     where i.Origin.ActorCompanyId == actorCompanyId &&
                                                     i.State == (int)SoeEntityState.Active &&
                                                     i.Origin.Type == (int)originType
                                                     select i);

                switch (originType)
                {
                    /*
                    case (int)SoeOriginType.Order:
                        if (searchDTO.IncludeClosed)
                        {
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice || i.Origin.Status == (int)SoeOriginStatus.OrderFullyInvoice || i.Origin.Status == (int)SoeOriginStatus.OrderClosed));
                        }
                        else
                        {
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice));
                        }

                        break;
                        */
                    case SoeOriginType.CustomerInvoice:
                        if (filter.IncludePreliminary && filter.IncludeVoucher)
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.Voucher));
                        else if (filter.IncludePreliminary)
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin));
                        else if (filter.IncludeVoucher)
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Voucher || i.Origin.Status == (int)SoeOriginStatus.Origin));
                        else
                            query = query.Where(i => i.Origin.Status == (int)SoeOriginStatus.Origin);
                        break;
                }

                if (filter.InvoiceDateFrom.HasValue)
                {
                    query = query.Where(i => i.InvoiceDate >= filter.InvoiceDateFrom.Value);
                }

                if (filter.InvoiceDateTo.HasValue)
                {
                    query = query.Where(i => i.InvoiceDate <= filter.InvoiceDateTo.Value);
                }

                if (!string.IsNullOrEmpty(filter.Number))
                {
                    query = query.Where(i => i.InvoiceNr == filter.Number);
                }

                if (filter.InvoiceId.HasValue)
                {
                    query = query.Where(i => i.InvoiceId == filter.InvoiceId.Value);
                }

                if (filter.PageNumber > 0)
                {
                    query = query.OrderBy(i => i.InvoiceId).Skip(filter.PageNrOfRecords * (filter.PageNumber - 1));
                }

                var invoicesIO = query.Take(filter.PageNrOfRecords).Select(i =>
                        new CustomerInvoiceIODTO
                        {
                            InvoiceId = i.InvoiceId,
                            CustomerInvoiceNr = i.InvoiceNr,
                            DueDate = i.DueDate,
                            InvoiceDate = i.InvoiceDate,
                            BillingType = i.BillingType,
                            OriginStatus = i.Origin.Status,
                            CurrencyId = i.Currency.SysCurrencyId,
                            TotalAmount = i.TotalAmount,
                            TotalAmountCurrency = i.TotalAmountCurrency,
                            VATAmount = i.VATAmount,
                            VATAmountCurrency = i.VATAmountCurrency,
                            CustomerNr = i.Actor.Customer.CustomerNr,
                            CustomerName = i.Actor.Customer.Name,
                            CustomerOrgnr = i.Actor.Customer.OrgNr,
                            /*
                            InvoiceRows = i.CustomerInvoiceRow
                            .Where(r => r.State == (int)SoeEntityState.Active && r.Type != (int)SoeInvoiceRowType.AccountingRow)
                            .Select(r => new CustomerInvoiceRowIODTO
                            {
                                InvoiceRowId = r.CustomerInvoiceRowId,
                                ProductNr = r.Product.Number,
                                Text = r.Text,
                                Quantity = r.Quantity,
                                Amount = r.Amount,
                                AmountCurrency = r.AmountCurrency,
                                VatAmount = r.VatAmount,
                                VatAmountCurrency = r.VatAmountCurrency,
                                SumAmount = r.SumAmount,
                                SumAmountCurrency = r.SumAmountCurrency,
                                AttestState = r.AttestStateId ?? 0,
                                AttestStateName = r.AttestState.Name
                            }).ToList(),
                            */
                        }).ToList();


                var invoiceIds = invoicesIO.Select(x => x.InvoiceId).ToList();
                var accountRowsAll = entities.CustomerInvoiceAccountRow
                                            .Where(ar => invoiceIds.Contains(ar.CustomerInvoiceRow.InvoiceId) && ar.State == (int)SoeEntityState.Active)
                                            .Select(a => new CustomerInvoiceAccountRowTinyDTO
                                            {
                                                CustomerInvoiceRowId = a.CustomerInvoiceRowId,
                                                AccountId = a.AccountId,
                                                VatRow = a.VatRow,
                                                AccountInternal = a.AccountInternal.Select(ai => ai.AccountId).ToList()
                                            })
                                            .ToLookup(x => x.CustomerInvoiceRowId);

                var invoiceRowsAll = entities.CustomerInvoiceRow
                                            .Where(ir => invoiceIds.Contains(ir.InvoiceId) && ir.State == (int)SoeEntityState.Active && ir.Type != (int)SoeInvoiceRowType.AccountingRow)
                                             .Select(r => new CustomerInvoiceRowIODTO
                                             {
                                                 InvoiceId = r.InvoiceId,
                                                 InvoiceRowId = r.CustomerInvoiceRowId,
                                                 ProductNr = r.Product.Number,
                                                 Text = r.Text,
                                                 Quantity = r.Quantity,
                                                 Amount = r.Amount,
                                                 AmountCurrency = r.AmountCurrency,
                                                 VatAmount = r.VatAmount,
                                                 VatAmountCurrency = r.VatAmountCurrency,
                                                 SumAmount = r.SumAmount,
                                                 SumAmountCurrency = r.SumAmountCurrency,
                                                 AttestState = r.AttestStateId ?? 0,
                                                 AttestStateName = r.AttestState.Name
                                             })
                                            .ToLookup(x => x.InvoiceId);


                foreach (var i in invoicesIO)
                {
                    i.Currency = CountryCurrencyManager.GetCurrencyCode(i.CurrencyId);
                    i.InvoiceRows = invoiceRowsAll.Where(x => x.Key == i.InvoiceId).SelectMany(y => y).ToList();

                    if (filter.IncludeRowAccountInfo && i.InvoiceRows.Any())
                    {
                        foreach (var r in i.InvoiceRows.OrderBy(x => x.InvoiceRowId))
                        {
                            AddAccountsToCustomerInvoiceRowIODTO(accounts, accountDimIds, accountRowsAll.Where(x => x.Key == r.InvoiceRowId).SelectMany(y => y).ToList(), r);
                        }
                    }
                }

                var invoicesSmall = invoicesIO.Select(i =>
                        new CustomerInvoiceSmallIODTO
                        {
                            InvoiceId = i.InvoiceId.GetValueOrDefault(),
                            InvoiceNr = i.CustomerInvoiceNr,
                            DueDate = i.DueDate,
                            InvoiceDate = i.InvoiceDate,
                            BillingType = i.BillingType,
                            OriginStatus = i.OriginStatus,
                            Currency = i.Currency,
                            TotalAmount = i.TotalAmount.GetValueOrDefault(),
                            TotalAmountCurrency = i.TotalAmountCurrency.GetValueOrDefault(),
                            VATAmount = i.VATAmount.GetValueOrDefault(),
                            VATAmountCurrency = i.VATAmountCurrency.GetValueOrDefault(),
                            CustomerNr = i.CustomerNr,
                            CustomerName = i.CustomerName,
                            InvoiceRows = i.InvoiceRows
                            .Select(r => new CustomerInvoiceRowSmallIODTO
                            {
                                ProductNr = r.ProductNr,
                                Text = r.Text,
                                Quantity = r.Quantity.GetValueOrDefault(),
                                UnitPrice = r.Amount,
                                UnitPriceCurrency = r.AmountCurrency,
                                VatAmount = r.VatAmount,
                                VatAmountCurrency = r.VatAmountCurrency,
                                SumAmount = r.SumAmount,
                                SumAmountCurrency = r.SumAmountCurrency,
                                AttestState = r.AttestState,
                                AttestStateName = r.AttestStateName,
                                Accounts = GetAccountInfoList(r)
                            }).ToList()

                        }).ToList();

#if DEBUG
                timer.Stop();
                Debug.WriteLine("Time: " + timer.Elapsed.TotalSeconds.ToString("#,##0.00 'seconds'"));
#endif

                return invoicesSmall.OrderBy(x => x.InvoiceId).ToList();
            }
        }

        public List<CustomerInvoiceIODTO> GetCustomerInvoiceIODTOs(int actorCompanyId, SoeOriginType originType, EvaluatedSelection es, DateTime? dateFrom, DateTime? dateTo, string nrFrom, string nrTo, int? invoiceId = null, bool includeClosed = false)
        {
            List<CustomerInvoiceIODTO> customerInvoiceIODTOs = new List<CustomerInvoiceIODTO>();
            List<Account> accounts = AccountManager.GetAccounts(actorCompanyId);
            List<InvoiceProduct> invoiceProducts = ProductManager.GetInvoiceProducts(actorCompanyId, null, false, false, null);
            List<VatCode> vatCodes = AccountManager.GetVatCodes(actorCompanyId);
            var accountDimIds = AccountManager.GetAccountDimIds(actorCompanyId);

            if (es == null)
                es = new EvaluatedSelection();

            es.ActorCompanyId = actorCompanyId;

            if (invoiceId.HasValue)
            {
                es.SB_InvoiceIds = new List<int>() { invoiceId.Value };
                es.SB_HasInvoiceIds = true;
            }
            else
            {
                if (dateFrom.HasValue)
                {
                    es.DateFrom = (DateTime)dateFrom;
                    es.HasDateInterval = true;
                }

                if (dateTo.HasValue)
                {
                    es.DateTo = (DateTime)dateTo;
                    es.HasDateInterval = true;
                }

                if (!string.IsNullOrEmpty(nrFrom))
                    es.SB_InvoiceNrFrom = nrFrom;

                if (!string.IsNullOrEmpty(nrTo))
                    es.SB_InvoiceNrTo = nrTo;
            }

            es.SB_IncludeClosedOrder = includeClosed;

            using (CompEntities entities = new CompEntities())
            {

                InvoiceAttestStates invoiceAttestStates = null;
                if (originType == SoeOriginType.Order)
                {
                    invoiceAttestStates = new InvoiceAttestStates(entities, originType, SettingManager, AttestManager, actorCompanyId, UserId, false);
                }

                var invoices = InvoiceManager.GetCustomerInvoicesFromSelection(entities, es, true, ref originType, false);

                if (invoiceId.HasValue)
                {
                    var inv = invoices.FirstOrDefault();

                    if (inv != null)
                    {
                        if (inv.Origin.Type != (int)originType)
                            return new List<CustomerInvoiceIODTO>();

                        if (inv.Origin.ActorCompanyId != actorCompanyId)
                            return new List<CustomerInvoiceIODTO>();
                    }
                }

                var contacts = ContactManager.GetContactsFromActors(entities, invoices.Where(i => i.ActorId.HasValue).Select(i2 => i2.ActorId.Value).ToList(), false, true);
                List<ContactAddress> billingAddresses = ContactManager.GetContactAddresses(entities, invoices.Select(i => i.BillingAddressId).ToList(), true, true);
                List<ContactAddress> deliveryAddresses = ContactManager.GetContactAddresses(entities, invoices.Select(i => i.DeliveryAddressId).ToList(), true, true);

                foreach (var invoice in invoices)
                {
                    var ioDTO = new CustomerInvoiceIODTO();

                    Customer customer = invoice.Actor?.Customer;

                    if (customer == null)
                        continue;

                    List<ContactAddressRow> customerBillingAddress = new List<ContactAddressRow>();
                    List<ContactAddressRow> customerDeliveryAddress = new List<ContactAddressRow>();

                    #region Billing And Delivery Address

                    Contact customerContactPreferences = contacts.FirstOrDefault(c => c.Actor.ActorId == invoice.Actor.ActorId);
                    if (customerContactPreferences != null)
                    {
                        //ContactAddressRow Billing            
                        if (invoice.BillingAddressId > 0)
                        {
                            var billingAddress = billingAddresses.FirstOrDefault(a => a.ContactAddressId == invoice.BillingAddressId);
                            if (billingAddress != null && billingAddress.ContactAddressRow != null)
                                customerBillingAddress = billingAddress.ContactAddressRow.ToList();
                        }

                        //ContactAddressRow Delivery            
                        if (invoice.DeliveryAddressId > 0)
                        {
                            var deliveryAddress = deliveryAddresses.FirstOrDefault(a => a.ContactAddressId == invoice.DeliveryAddressId);
                            if (deliveryAddress != null && deliveryAddress.ContactAddressRow != null)
                                customerDeliveryAddress = deliveryAddress.ContactAddressRow.ToList();
                        }
                    }

                    ioDTO.BillingAddressName = customerBillingAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.Name);
                    ioDTO.BillingAddressAddress = customerBillingAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.Address);
                    ioDTO.BillingAddressCO = customerBillingAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.AddressCO);
                    ioDTO.BillingAddressPostNr = customerBillingAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.PostalCode);
                    ioDTO.BillingAddressCity = customerBillingAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.PostalAddress);
                    ioDTO.BillingAddressCountry = customerBillingAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.Country);

                    ioDTO.DeliveryAddressName = customerDeliveryAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.Name);
                    ioDTO.DeliveryAddressAddress = customerDeliveryAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.Address);
                    ioDTO.DeliveryAddressCO = customerDeliveryAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.AddressCO);
                    ioDTO.DeliveryAddressPostNr = customerDeliveryAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.PostalCode);
                    ioDTO.DeliveryAddressCity = customerDeliveryAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.PostalAddress);
                    ioDTO.DeliveryAddressCountry = customerDeliveryAddress.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.Country);


                    #endregion

                    #region Origin

                    if (!invoice.OriginReference.IsLoaded)
                        invoice.OriginReference.Load();

                    ioDTO.OriginType = invoice.Origin.Type;
                    ioDTO.OriginStatus = invoice.Origin.Status;
                    ioDTO.Note = invoice.Origin.Description;

                    #endregion

                    #region Project

                    ioDTO.ProjectId = invoice.ProjectId ?? 0;
                    ioDTO.ProjectNr = invoice.ProjectNr;

                    #endregion

                    #region Customer

                    ioDTO.CustomerId = customer.ActorCustomerId;
                    ioDTO.CustomerNr = customer.CustomerNr;
                    ioDTO.CustomerName = customer.Name;
                    ioDTO.CustomerOrgnr = customer.OrgNr;

                    #endregion

                    #region PaymentConditions

                    if (!invoice.PaymentConditionReference.IsLoaded)
                        invoice.PaymentConditionReference.Load();

                    if (invoice.PaymentCondition != null)
                    {
                        ioDTO.PaymentCondition = invoice.PaymentCondition.Name;
                        ioDTO.PaymentConditionCode = invoice.PaymentCondition.Code;
                    }



                    #endregion

                    #region Voucher

                    if (!invoice.VoucherHeadReference.IsLoaded)
                        invoice.VoucherHeadReference.Load();

                    if (invoice.VoucherHead != null)
                        ioDTO.VoucherNr = invoice.VoucherHead.VoucherNr.ToString();

                    #endregion

                    #region Currency

                    ioDTO.CurrencyRate = invoice.CurrencyRate;
                    ioDTO.CurrencyDate = invoice.CurrencyDate;
                    ioDTO.CurrencyId = invoice.CurrencyId;

                    var currency = CountryCurrencyManager.GetCurrencyWithCode(entities, invoice.CurrencyId);
                    ioDTO.Currency = currency?.Code;

                    #endregion

                    #region Accounting

                    ioDTO.SaleAccountNr = invoice.DefaultDim1AccountId != null && invoice.DefaultDim1AccountId != 0 ? (accounts.FirstOrDefault(a => a.AccountId == invoice.DefaultDim1AccountId)?.AccountNr ?? string.Empty) : string.Empty;
                    ioDTO.SaleAccountNrDim2 = invoice.DefaultDim2AccountId != null && invoice.DefaultDim2AccountId != 0 ? accounts.FirstOrDefault(a => a.AccountId == invoice.DefaultDim2AccountId).AccountNr : string.Empty;
                    ioDTO.SaleAccountNrDim3 = invoice.DefaultDim3AccountId != null && invoice.DefaultDim3AccountId != 0 ? accounts.FirstOrDefault(a => a.AccountId == invoice.DefaultDim3AccountId).AccountNr : string.Empty;
                    ioDTO.SaleAccountNrDim4 = invoice.DefaultDim4AccountId != null && invoice.DefaultDim4AccountId != 0 ? accounts.FirstOrDefault(a => a.AccountId == invoice.DefaultDim4AccountId).AccountNr : string.Empty;
                    ioDTO.SaleAccountNrDim5 = invoice.DefaultDim5AccountId != null && invoice.DefaultDim5AccountId != 0 ? accounts.FirstOrDefault(a => a.AccountId == invoice.DefaultDim5AccountId).AccountNr : string.Empty;
                    ioDTO.SaleAccountNrDim6 = invoice.DefaultDim6AccountId != null && invoice.DefaultDim6AccountId != 0 ? accounts.FirstOrDefault(a => a.AccountId == invoice.DefaultDim6AccountId).AccountNr : string.Empty;

                    #endregion

                    #region Tracking

                    if (invoice.Origin.OriginInvoiceMapping != null)
                    {
                        foreach (var mapping in invoice.Origin.OriginInvoiceMapping)
                        {
                            var inv = InvoiceManager.GetInvoice(mapping.InvoiceId, loadOrigin: true);

                            if (inv != null && inv.Origin.Type == (int)SoeOriginType.Order)
                                ioDTO.OrderNr = inv.InvoiceNr;

                            if (inv != null && inv.Origin.Type == (int)SoeOriginType.Offer)
                                ioDTO.OfferNr = inv.InvoiceNr;

                            if (inv != null && inv.Origin.Type == (int)SoeOriginType.Contract)
                                ioDTO.ContractNr = inv.InvoiceNr;
                        }
                    }

                    #endregion

                    #region Contract

                    if (!invoice.ContractGroupReference.IsLoaded)
                        invoice.ContractGroupReference.Load();

                    if (invoice.ContractGroup != null)
                    {
                        ioDTO.ContractGroupId = invoice.ContractGroupId;
                        ioDTO.ContractGroupInterval = invoice.ContractGroup.Interval;
                        ioDTO.ContractGroupName = invoice.ContractGroup.Name;
                        ioDTO.ContractGroupDayInMonth = invoice.ContractGroup.DayInMonth;
                        ioDTO.ContractGroupOrderTemplate = invoice.ContractGroup.OrderTemplate;
                        ioDTO.ContractGroupInvoiceTemplate = invoice.ContractGroup.InvoiceTemplate;
                        ioDTO.ContractGroupDecription = invoice.ContractGroup.Description;
                        ioDTO.ContractGroupPeriod = invoice.ContractGroup.Period.ToString();
                        ioDTO.ContractGroupPriceManagementName = invoice.ContractGroup.PriceManagement.ToString();
                        ioDTO.ContractGroupInvoiceText = invoice.ContractGroup.InvoiceText;
                        ioDTO.ContractGroupInvoiceRowText = invoice.ContractGroup.InvoiceTextRow;
                    }

                    #endregion

                    #region Amount and stuff

                    if (invoice.ContactEComId.GetValueOrDefault() > 0)
                    {
                        ioDTO.Email = ContactManager.GetContactEComText(entities, invoice.ContactEComId.Value);
                    }

                    if (invoice.ContactGLNId.GetValueOrDefault() > 0)
                    {
                        ioDTO.CustomerGlnNr = ContactManager.GetContactEComText(entities, invoice.ContactGLNId.Value);
                    }

                    ioDTO.RegistrationType = invoice.RegistrationType;
                    ioDTO.CustomerInvoiceNr = invoice.InvoiceNr;
                    ioDTO.SeqNr = invoice.SeqNr;
                    ioDTO.OCR = invoice.OCR;
                    ioDTO.PriceListTypeId = invoice.PriceListTypeId;
                    ioDTO.PaymentCondition = invoice.PaymentCondition != null ? invoice.PaymentCondition.Name : string.Empty;
                    ioDTO.PaymentConditionId = invoice.PaymentCondition != null ? invoice.PaymentCondition.PaymentConditionId : (int?)null;
                    ioDTO.PaymentConditionCode = invoice.PaymentCondition?.Code;
                    ioDTO.DeliveryCondition = invoice.DeliveryCondition != null ? invoice.DeliveryCondition.Name : string.Empty;
                    ioDTO.DeliveryConditionId = invoice.DeliveryCondition != null ? invoice.DeliveryCondition.DeliveryConditionId : (int?)null;
                    ioDTO.DeliveryType = invoice.DeliveryType != null ? invoice.DeliveryType.Name : string.Empty;
                    ioDTO.DeliveryTypeId = invoice.DeliveryType != null ? invoice.DeliveryType.DeliveryTypeId : (int?)null;
                    ioDTO.InvoiceDate = invoice.InvoiceDate;
                    ioDTO.DeliveryDate = invoice.DeliveryDate;
                    ioDTO.DueDate = invoice.DueDate;
                    ioDTO.OrderDate = invoice.OrderDate;
                    ioDTO.VoucherDate = invoice.VoucherDate;
                    ioDTO.ReferenceOur = invoice.ReferenceOur;
                    ioDTO.ReferenceYour = invoice.ReferenceYour;
                    ioDTO.CustomerContractNr = invoice.ContractNr;
                    ioDTO.TotalAmount = invoice.TotalAmount;
                    ioDTO.TotalAmountCurrency = invoice.TotalAmountCurrency;
                    ioDTO.SumAmount = invoice.SumAmount;
                    ioDTO.SumAmountCurrency = invoice.SumAmountCurrency;
                    ioDTO.VATAmount = invoice.VATAmount;
                    ioDTO.VATAmountCurrency = invoice.VATAmountCurrency;
                    ioDTO.PaidAmount = invoice.PaidAmount;
                    ioDTO.PaidAmountCurrency = invoice.PaidAmountCurrency;
                    ioDTO.RemainingAmount = invoice.RemainingAmount;
                    ioDTO.FreightAmount = invoice.FreightAmount;
                    ioDTO.FreightAmountCurrency = invoice.FreightAmountCurrency;
                    ioDTO.InvoiceFee = invoice.InvoiceFee;
                    ioDTO.InvoiceFeeCurrency = invoice.InvoiceFeeCurrency;
                    ioDTO.CentRounding = invoice.CentRounding;
                    ioDTO.FullyPayed = invoice.FullyPayed;
                    ioDTO.PaymentNr = invoice.PaymentNr;
                    ioDTO.BillingType = invoice.BillingType;

                    ioDTO.VatType = invoice.VatType;
                    ioDTO.WorkingDescription = invoice.WorkingDescription;
                    ioDTO.InternalDescription = invoice.InternalDescription;
                    ioDTO.ExternalDescription = invoice.ExternalDescription;
                    ioDTO.NextContractPeriodYear = invoice.NextContractPeriodYear;
                    ioDTO.NextContractPeriodValue = invoice.NextContractPeriodValue;
                    ioDTO.NextContractPeriodDate = invoice.NextContractPeriodDate;
                    ioDTO.InvoiceLabel = invoice.InvoiceLabel;
                    ioDTO.InvoiceHeadText = invoice.InvoiceHeadText;
                    ioDTO.ExternalId = invoice.ExternalId;
                    ioDTO.InvoiceDeliveryType = invoice.InvoiceDeliveryType;



                    #endregion

                    #region Other

                    ioDTO.Modified = invoice.Modified;
                    ioDTO.ModifiedBy = invoice.ModifiedBy;
                    ioDTO.Created = invoice.Created;
                    ioDTO.CreatedBy = invoice.CreatedBy;
                    ioDTO.ActorCompanyId = actorCompanyId;
                    ioDTO.ExternalId = invoice.ExternalId;
                    ioDTO.InvoiceId = invoice.InvoiceId;
                    ioDTO.OrderType = invoice.OrderType;

                    switch (ioDTO.OriginType)
                    {
                        case (int)SoeOriginType.CustomerInvoice:
                            {
                                ioDTO.IsClosed = ioDTO.OriginStatus != (int)SoeOriginStatus.Draft;
                                break;
                            }
                        case (int)SoeOriginType.Order:
                            {
                                ioDTO.IsClosed = ioDTO.OriginStatus == (int)SoeOriginStatus.OrderClosed || ioDTO.OriginStatus == (int)SoeOriginStatus.OrderFullyInvoice;
                                break;
                            }
                        default:
                            ioDTO.IsClosed = false;
                            break;
                    }

                    #endregion

                    #region rows

                    if (invoice.ActiveCustomerInvoiceRows != null)
                    {
                        foreach (var row in invoice.ActiveCustomerInvoiceRows.Where(r => r.Type != (int)SoeInvoiceRowType.AccountingRow && r.Type != (int)SoeInvoiceRowType.BaseProductRow))
                        {
                            CustomerInvoiceRowIODTO rowIoDTO = new CustomerInvoiceRowIODTO();

                            #region accounting

                            if (row.ActiveCustomerInvoiceAccountRows != null)
                            {
                                AddAccountsToCustomerInvoiceRowIODTO(accounts, accountDimIds, row.ActiveCustomerInvoiceAccountRows.Select(a => new CustomerInvoiceAccountRowTinyDTO
                                {
                                    CustomerInvoiceRowId = a.CustomerInvoiceRowId,
                                    AccountId = a.AccountId,
                                    VatRow = a.VatRow,
                                    AccountInternal = a.AccountInternal.Select(ai => ai.AccountId).ToList()
                                }).ToList(), rowIoDTO);
                            }

                            #endregion

                            #region Product

                            var product = invoiceProducts.FirstOrDefault(p => p.ProductId == row.ProductId);

                            if (product != null)
                            {
                                rowIoDTO.ProductNr = product.Number;
                                rowIoDTO.ProductName2 = product.Name;
                                rowIoDTO.ProductId = product.ProductId;
                                rowIoDTO.ProductGroupId = product.ProductGroupId;
                            }
                            else
                            {
                                rowIoDTO.ProductName2 = string.Empty;
                                rowIoDTO.ProductNr = string.Empty;
                            }

                            rowIoDTO.ProductName = row.Text;

                            #endregion

                            #region VatCode

                            var vatCode = vatCodes.FirstOrDefault(v => v.VatCodeId == row.VatCodeId);
                            if (vatCode != null)
                            {
                                rowIoDTO.VatCode = vatCode.Code;
                                rowIoDTO.VatCodeId = vatCode.VatCodeId;
                            }

                            #endregion

                            rowIoDTO.InvoiceId = row.InvoiceId;
                            rowIoDTO.InvoiceRowId = row.CustomerInvoiceRowId;
                            rowIoDTO.ActorCompanyId = actorCompanyId;
                            rowIoDTO.CustomerRowType = (SoeInvoiceRowType)row.Type;
                            if (!row.AttestStateReference.IsLoaded)
                            {
                                row.AttestStateReference.Load();
                            }

                            if (row.AttestState != null)
                            {
                                rowIoDTO.AttestStateName = row.AttestState.Name;
                                rowIoDTO.AttestState = row.AttestState.AttestStateId;
                            }

                            rowIoDTO.Quantity = row.Quantity;
                            rowIoDTO.InvoiceQuantity = row.InvoiceQuantity ?? 0;
                            rowIoDTO.StockId = row.StockId;
                            rowIoDTO.Stock = row.Stock?.Code;
                            rowIoDTO.VatRate = row.VatRate;

                            rowIoDTO.UnitPrice = row.Amount;
                            rowIoDTO.ProductUnitId = row.ProductUnitId ?? 0;
                            rowIoDTO.Discount = row.DiscountPercent;

                            rowIoDTO.PurchasePrice = row.PurchasePrice;
                            rowIoDTO.PurchasePriceCurrency = row.PurchasePriceCurrency;
                            rowIoDTO.Amount = row.Amount;
                            rowIoDTO.AmountCurrency = row.AmountCurrency;
                            rowIoDTO.VatAmount = row.VatAmount;
                            rowIoDTO.VatAmountCurrency = row.VatAmountCurrency;

                            rowIoDTO.DiscountAmount = row.DiscountAmount;
                            rowIoDTO.DiscountAmountCurrency = row.DiscountAmountCurrency;
                            rowIoDTO.MarginalIncome = row.MarginalIncome;
                            rowIoDTO.MarginalIncomeCurrency = row.MarginalIncomeCurrency;
                            rowIoDTO.SumAmount = row.SumAmount;
                            rowIoDTO.SumAmountCurrency = row.SumAmountCurrency;
                            rowIoDTO.Text = row.Text;
                            rowIoDTO.RowNr = row.RowNr;
                            rowIoDTO.Created = row.Created;
                            rowIoDTO.CreatedBy = row.CreatedBy;
                            rowIoDTO.Modified = row.Modified;
                            rowIoDTO.ModifiedBy = row.ModifiedBy;
                            rowIoDTO.State = row.State;
                            rowIoDTO.DeliveryDateText = row.DeliveryDateText;

                            if (invoice.Origin.Type == (int)SoeOriginType.Order && invoiceAttestStates != null)
                            {
                                rowIoDTO.IsReadonly = (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.OrderPartlyInvoice) || (row.AttestStateId != null && row.AttestStateId != invoiceAttestStates.OrderInitialId);
                            }
                            else
                            {
                                rowIoDTO.IsReadonly = invoice.Origin.Status != (int)SoeOriginStatus.Draft;
                            }

                            ioDTO.InvoiceRows.Add(rowIoDTO);
                        }
                    }

                    ioDTO.AttestStates = ioDTO.InvoiceRows.Select(x => x.AttestState).Distinct().ToList();
                    ioDTO.AttestStateNames = ioDTO.InvoiceRows.Select(x => x.AttestStateName).Distinct().ToList();

                    customerInvoiceIODTOs.Add(ioDTO);
                    #endregion
                }
            }

            return customerInvoiceIODTOs;
        }

        private static List<AccountInfoIODTO> GetAccountInfoList(CustomerInvoiceRowIODTO r)
        {
            var list = new List<AccountInfoIODTO>();

            if (!string.IsNullOrEmpty(r.AccountNr)) list.Add(new AccountInfoIODTO { DimNr = 1, AccountNr = r.AccountNr });
            if (!string.IsNullOrEmpty(r.AccountDim2Nr)) list.Add(new AccountInfoIODTO { DimNr = 2, AccountNr = r.AccountDim2Nr });
            if (!string.IsNullOrEmpty(r.AccountDim3Nr)) list.Add(new AccountInfoIODTO { DimNr = 3, AccountNr = r.AccountDim3Nr });
            if (!string.IsNullOrEmpty(r.AccountDim4Nr)) list.Add(new AccountInfoIODTO { DimNr = 4, AccountNr = r.AccountDim4Nr });
            if (!string.IsNullOrEmpty(r.AccountDim5Nr)) list.Add(new AccountInfoIODTO { DimNr = 5, AccountNr = r.AccountDim5Nr });
            if (!string.IsNullOrEmpty(r.AccountDim6Nr)) list.Add(new AccountInfoIODTO { DimNr = 6, AccountNr = r.AccountDim6Nr });

            return list;
        }
        private static void AddAccountsToCustomerInvoiceRowIODTO(List<Account> accounts, AccountDimIdsDTO dimIds, List<CustomerInvoiceAccountRowTinyDTO> accountRows, CustomerInvoiceRowIODTO rowIoDTO)
        {
            foreach (var accounting in accountRows)
            {
                if (accounting.VatRow)
                {
                    rowIoDTO.VatAccountnr = accounts.FirstOrDefault(a => a.AccountId == accounting.AccountId)?.AccountNr ?? string.Empty;
                }
                else
                {
                    rowIoDTO.AccountNr = accounts.FirstOrDefault(a => a.AccountId == accounting.AccountId)?.AccountNr ?? string.Empty;

                    if (accounting.AccountInternal != null)
                    {
                        foreach (var accountId in accounting.AccountInternal)
                        {
                            if (accounts.Any(a => a.AccountId == accountId && a.AccountDimId == dimIds.AccountDimId2))
                                rowIoDTO.AccountDim2Nr = accounts.FirstOrDefault(a => a.AccountId == accountId)?.AccountNr;
                            if (accounts.Any(a => a.AccountId == accountId && a.AccountDimId == dimIds.AccountDimId3))
                                rowIoDTO.AccountDim3Nr = accounts.FirstOrDefault(a => a.AccountId == accountId)?.AccountNr;
                            if (accounts.Any(a => a.AccountId == accountId && a.AccountDimId == dimIds.AccountDimId4))
                                rowIoDTO.AccountDim4Nr = accounts.FirstOrDefault(a => a.AccountId == accountId)?.AccountNr;
                            if (accounts.Any(a => a.AccountId == accountId && a.AccountDimId == dimIds.AccountDimId5))
                                rowIoDTO.AccountDim5Nr = accounts.FirstOrDefault(a => a.AccountId == accountId)?.AccountNr;
                            if (accounts.Any(a => a.AccountId == accountId && a.AccountDimId == dimIds.AccountDimId6))
                                rowIoDTO.AccountDim6Nr = accounts.FirstOrDefault(a => a.AccountId == accountId)?.AccountNr;
                        }
                    }
                }
            }
        }

        #region Import to CustomerInvoiceIO

        public ActionResult CreateInvoiceFromOrder(int orderNr, bool definitive, int actorCompanyId)
        {
            using (var entities = new CompEntities())
            {
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                var order = InvoiceManager.GetCustomerInvoiceByNr(entitiesReadOnly, orderNr.ToString(), SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId);

                if (order == null)
                {
                    return new ActionResult(5605, GetText(5605, "Ordern hittades inte"));
                }

                if (!(order.Origin.Status == (int)SoeOriginStatus.Origin || order.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice))
                {
                    return new ActionResult(9002, GetText(9002, "Status stängd order"));
                }

                var accountYearId = AccountManager.GetAccountYearId(order.VoucherDate ?? order.InvoiceDate ?? DateTime.Today, actorCompanyId);
                if (accountYearId == 0)
                {
                    return new ActionResult(1281, GetText(1281, "Redovisningsår hittades inte"));
                }

                var items = new List<CustomerInvoiceGridDTO> { new CustomerInvoiceGridDTO { CustomerInvoiceId = order.InvoiceId } };

                return InvoiceManager.TransferCustomerInvoices(items, SoeOriginStatusChange.Billing_OrderToInvoice, 0, false, 0, null, null, null, null, false, false, false, definitive);
            }
        }

        public ActionResult ImportUpdateCustomerInvoiceIO(CustomerInvoiceOrderUpdateIODTO updateItem, int actorCompanyId, SoeOriginType type)
        {
            var result = new ActionResult();
            var noDeleteRowPermission = FeatureManager.HasRolePermission(Feature.Billing_Order_Orders_Edit_ProductRows_NoDeletion, Permission.Modify, parameterObject.RoleId, actorCompanyId);

            using (var entities = new CompEntities())
            {
                using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                {
                    var invoiceAttestStates = new InvoiceAttestStates(entities, type, SettingManager, AttestManager, actorCompanyId, UserId, updateItem.Rows != null && updateItem.Rows.Any());
                    var invoice = InvoiceManager.GetCustomerInvoice(entities, updateItem.InvoiceId, loadInvoiceRow: updateItem.Rows != null && updateItem.Rows.Any());
                    InvoiceManager.SetPriceListTypeInclusiveVat(entities, invoice, actorCompanyId);

                    if (invoice == null)
                    {
                        if (type == SoeOriginType.Order)
                        {
                            return new ActionResult(5605, GetText(5605, "Ordern hittades inte"));
                        }
                        else
                        {
                            return new ActionResult(8371, GetText(8371, "Faktura saknas"));
                        }
                    }

                    if (invoice.Origin.Type != (int)type)
                    {
                        return new ActionResult(7107, GetText(7107, "Ogiltig typ"));
                    }

                    if (type == SoeOriginType.Order && !(invoice.Origin.Status == (int)SoeOriginStatus.Origin || invoice.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice))
                    {
                        return new ActionResult(9002, GetText(9002, "Status stängd order"));
                    }
                    if (type == SoeOriginType.CustomerInvoice && invoice.Origin.Status != (int)SoeOriginStatus.Draft)
                    {
                        return new ActionResult(4875, GetText(4875, "Fakturan har ogiltig status"));
                    }

                    if (!string.IsNullOrEmpty(updateItem.ReferenceYour))
                    {
                        invoice.ReferenceYour = updateItem.ReferenceYour;
                    }

                    if (!string.IsNullOrEmpty(updateItem.ReferenceOur))
                    {
                        invoice.ReferenceOur = updateItem.ReferenceOur;
                    }

                    if (updateItem.Date.HasValue)
                    {
                        invoice.InvoiceDate = updateItem.Date.Value.Date;
                    }

                    if (updateItem.DeliveryAddress != null && !string.IsNullOrEmpty(updateItem.DeliveryAddress.Address))
                    {
                        invoice.InvoiceHeadText = $"{updateItem.DeliveryAddress.Address}\n{updateItem.DeliveryAddress.PostalCode} {updateItem.DeliveryAddress.PostalAddress}\n{updateItem.DeliveryAddress.Country}";
                        invoice.DeliveryAddressId = 0;
                    }

                    SetModifiedProperties(invoice);

                    AttestStateDTO initialAttestState = null;
                    if (type == SoeOriginType.Order)
                    {
                        initialAttestState = invoiceAttestStates.GetInitialAttestStateOrder(entities, actorCompanyId);

                        if (initialAttestState == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, " Initial AttestState Order");
                    }

                    if (updateItem.Rows != null && updateItem.Rows.Any())
                    {
                        foreach (var updateRow in updateItem.Rows)
                        {
                            var invoiceRow = invoice.CustomerInvoiceRow.FirstOrDefault(r => r.CustomerInvoiceRowId == updateRow.InvoiceRowId && r.State == (int)SoeEntityState.Active);

                            if (invoiceRow == null && updateRow.InvoiceRowId != 0)
                            {
                                return new ActionResult(5608, GetText(5608, "Inga rader hittades"));
                            }

                            if (invoiceRow != null && invoiceAttestStates.IsAttestStateReadonly(invoiceRow.AttestStateId))
                            {
                                return new ActionResult(5361, GetText(5361, "Status"));
                            }

                            if (updateRow.Delete.GetValueOrDefault())
                            {
                                if (noDeleteRowPermission)
                                {
                                    return new ActionResult(7246, GetText(7246, "Behörighet att ta bort orderraden saknas"));
                                }
                                invoiceRow.State = (int)SoeEntityState.Deleted;
                                SetModifiedProperties(invoiceRow);
                                continue;
                            }

                            var productId = invoiceRow?.ProductId ?? 0;
                            var rowType = invoiceRow != null ? (SoeInvoiceRowType)invoiceRow.Type : SoeInvoiceRowType.ProductRow;

                            if (invoiceRow == null && string.IsNullOrEmpty(updateRow.ProductNr) && !string.IsNullOrEmpty(updateRow.Text))
                            {
                                rowType = SoeInvoiceRowType.TextRow;
                            }

                            if (rowType == SoeInvoiceRowType.ProductRow)
                            {
                                updateRow.Text = null;
                                if (!updateRow.Quantity.HasValue && invoiceRow != null)
                                {
                                    updateRow.Quantity = invoiceRow.Quantity;
                                }
                                else if (!updateRow.Quantity.HasValue)
                                {
                                    return new ActionResult(4803, GetText(4803, "Antal:"));
                                }

                                if (!updateRow.Price.HasValue && invoiceRow != null)
                                {
                                    updateRow.Price = invoiceRow.Amount;
                                }
                                else if (!updateRow.Price.HasValue)
                                {
                                    return new ActionResult(4632, GetText(4632, "Pris"));
                                }

                                if (!string.IsNullOrEmpty(updateRow.ProductNr))
                                {
                                    productId = ProductManager.GetProductId(entities, actorCompanyId, updateRow.ProductNr);
                                }

                                if (productId == 0)
                                {
                                    return new ActionResult(8331, GetText(8331, "Artikel kunde inte hittas"));
                                }
                            }
                            else
                            {
                                updateRow.Quantity = 0;
                                updateRow.Price = 0;
                            }
                            var rowSaveResult = InvoiceManager.SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, invoice, updateRow.InvoiceRowId, productId, updateRow.Quantity.Value, updateRow.Price.Value, updateRow.Text, rowType, calcVATfromPrice: true);
                            if (!rowSaveResult.Success)
                            {
                                return new ActionResult(12055, GetText(12055, "Sparning misslyckades") + ":" + rowSaveResult.ErrorMessage);
                            }

                            if (updateRow.IsReady.GetValueOrDefault())
                            {
                                result = invoiceAttestStates.SetRowReady(entities, invoiceRow);
                                if (!result.Success)
                                {
                                    return result;
                                }
                            }
                        }
                    }

                    var saveResult = SaveChanges(entities);

                    if (saveResult.Success)
                    {
                        transaction.Complete();
                    }

                    result.Success = saveResult.Success;
                    result.ErrorMessage = string.Format(GetText(8415, "{0} kundfakturor utav {1} har skapats/uppdaterats."), saveResult.Success ? 1 : 0, 1);
                }
            }

            return result;
        }

        public ActionResult ImportCustomerInvoiceIO(CustomerInvoiceIOItem customerInvoiceIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, string specialFunctionalities, bool importToCustomerInvoice)
        {
            var result = new ActionResult();
            var customerInvoiceHeadIOs = new List<CustomerInvoiceHeadIO>();

            #region Init

            string batchId = GenerateBatchId();
            var dictSpecialFunctionality = GetSpecialFunctionalityDict(actorCompanyId, importId);

            #endregion

            #region Contract
            using (CompEntities entities = new CompEntities())
            {
                foreach (var customerInvoiceIODTO in customerInvoiceIOItem.CustomerInvoices.Where(i => i.RegistrationType == (int)OrderInvoiceRegistrationType.Contract))
                {
                    List<ContractGroup> contractGroups = ContractManager.GetContractGroups(entities, actorCompanyId).ToList();

                    if (customerInvoiceIODTO.ContractGroupId.HasValue && customerInvoiceIODTO.ContractGroupId != 0 && contractGroups.Any(c => c.ContractGroupId == (int)customerInvoiceIODTO.ContractGroupId))
                        continue;

                    string contractGroupName = !string.IsNullOrEmpty(customerInvoiceIODTO.ContractGroupName) ? customerInvoiceIODTO.ContractGroupName : !string.IsNullOrEmpty(customerInvoiceIODTO.ContractGroupPeriod) ? customerInvoiceIODTO.ContractGroupPeriod : string.Empty;
                    contractGroupName = customerInvoiceIODTO.ContractGroupInterval.HasValue ? customerInvoiceIODTO.ContractGroupInterval.Value + contractGroupName : contractGroupName;


                    if (contractGroups.IsNullOrEmpty() || !contractGroups.Any(g => g.Name.ToLower() == contractGroupName.ToLower()))
                    {
                        if (contractGroups.Any(g => g.Name.ToLower().Equals(contractGroupName.ToLower())))
                            continue;

                        ContractGroupDTO groupDTO = new ContractGroupDTO();
                        groupDTO.Name = contractGroupName;
                        groupDTO.Description = !string.IsNullOrEmpty(customerInvoiceIODTO.ContractGroupDecription) ? customerInvoiceIODTO.ContractGroupDecription : string.Empty;
                        groupDTO.Interval = customerInvoiceIODTO.ContractGroupInterval.HasValue ? (int)customerInvoiceIODTO.ContractGroupInterval : 0;
                        groupDTO.InvoiceTemplate = customerInvoiceIODTO.ContractGroupInvoiceTemplate.HasValue ? customerInvoiceIODTO.ContractGroupInvoiceTemplate : 0;
                        groupDTO.OrderTemplate = customerInvoiceIODTO.ContractGroupOrderTemplate.HasValue ? customerInvoiceIODTO.ContractGroupOrderTemplate : 0;
                        groupDTO.InvoiceText = customerInvoiceIODTO.ContractGroupInvoiceText;
                        groupDTO.InvoiceTextRow = customerInvoiceIODTO.ContractGroupInvoiceRowText;
                        groupDTO.DayInMonth = customerInvoiceIODTO.ContractGroupDayInMonth.HasValue ? (int)customerInvoiceIODTO.ContractGroupDayInMonth : 1;
                        groupDTO.PriceManagement = TermGroup_ContractGroupPriceManagement.Fixed;

                        //Period
                        if (!String.IsNullOrEmpty(customerInvoiceIODTO.ContractGroupPeriod))
                        {
                            groupDTO.Period = TermGroup_ContractGroupPeriod.Year;

                            try
                            {
                                groupDTO.Period = (TermGroup_ContractGroupPeriod)(Convert.ToInt32(customerInvoiceIODTO.ContractGroupPeriod));
                            }
                            catch
                            {
                                if (customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "mån" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "p" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "m" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "Month")
                                    groupDTO.Period = TermGroup_ContractGroupPeriod.Month;

                                if (customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "vecka" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "v" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "week")
                                    groupDTO.Period = TermGroup_ContractGroupPeriod.Week;

                                if (customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "år" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "å" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "year")
                                    groupDTO.Period = TermGroup_ContractGroupPeriod.Year;

                                if (customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "kalenderår" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "kå" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "calenderyear")
                                    groupDTO.Period = TermGroup_ContractGroupPeriod.CalendarYear;

                                if (customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "kvartal" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "kv" || customerInvoiceIODTO.ContractGroupPeriod.ToLower() == "quarter")
                                    groupDTO.Period = TermGroup_ContractGroupPeriod.Quarter;
                            }

                            ContractManager.SaveContractGroup(entities, groupDTO, actorCompanyId);

                        }
                    }
                }
            }

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    IEnumerable<ContractGroup> contractGroups = ContractManager.GetContractGroups(entities, actorCompanyId);

                    //Update existing invoice?
                    bool updateExistingInvoice = (from i in entities.Import
                                                  where i.ImportId == importId &&
                                                  i.UpdateExistingInvoice
                                                  select i.ImportId).Any();

                    bool isAutoMasterImport = (!string.IsNullOrEmpty(specialFunctionalities)) && specialFunctionalities.Contains("Automaster");
                    bool isIcaOnline2 = (!string.IsNullOrEmpty(specialFunctionalities)) && specialFunctionalities.Contains("ICAOnline2");

                    List<Customer> customers = null;

                    //always update existing invoice in case of Automaster import
                    if (isAutoMasterImport)
                    {
                        updateExistingInvoice = true;
                        if (customerInvoiceIOItem.CustomerInvoices.Count > 5)
                        {
                            customers = CustomerManager.GetCustomersByCompany(actorCompanyId, true);
                        }
                    }

                    foreach (var customerInvoice in customerInvoiceIOItem.CustomerInvoices)
                    {
                        if (isAutoMasterImport)
                        {
                            customerInvoice.CustomerNr = customerInvoice.CustomerNr.TrimStart('0');
                            if (customerInvoice.CustomerNr == string.Empty)
                            {
                                customerInvoice.CustomerNr = CustomerManager.GetAutomasterCashCustomerNr(actorCompanyId);
                            }
                            customerInvoice.CustomerInvoiceNr = customerInvoice.CustomerInvoiceNr.TrimStart('0');
                            var customer = CustomerManager.GetCustomerByNr(actorCompanyId, customerInvoice.CustomerNr, customers);
                            if (customer != null)
                                customerInvoice.CustomerName = customer.Name;
                        }

                        CustomerInvoiceHeadIO customerInvoiceHeadIO = CreateCustomerInvoiceIO(entities, headType, source, type, customerInvoice, contractGroups, batchId, importId, actorCompanyId, dictSpecialFunctionality, updateExistingInvoice);
                        if (customerInvoiceHeadIO != null)
                        {
                            // Check customer
                            if (isIcaOnline2 && string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerName))
                            {
                                customerInvoiceHeadIO.Status = (int)TermGroup_IOStatus.Error;
                                customerInvoiceHeadIO.ErrorMessage = GetText(7613, "Det finns kundnr i filen som ännu inte lagts upp i GO. Du behöver importera Kundfilen innan du importerar detta Faktureringsunderlag. Eller registrera dessa kundnr manuellt.");
                            }
                            customerInvoiceHeadIO.DebetInvoiceNr = customerInvoice.DebetInvoiceNr;
                            customerInvoiceHeadIOs.Add(customerInvoiceHeadIO);
                        }
                    }

                    result = BulkInsert(entities, customerInvoiceHeadIOs);

                    if (!result.Success)
                    {
                        return result;
                    }

                    var ioCustomerInvoiceRows = new List<CustomerInvoiceRowIO>();
                    foreach (var head in customerInvoiceHeadIOs)
                    {
                        foreach (var row in head.CustomerInvoiceRowIO)
                        {
                            row.CustomerInvoiceHeadIOId = head.CustomerInvoiceHeadIOId;
                            ioCustomerInvoiceRows.Add(row);
                        }
                    }

                    result = BulkInsert(entities, ioCustomerInvoiceRows);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportCustomerInvoiceIO(CustomerInvoiceIOItem customerInvoiceIOItem): ");
                }
            }

            if (result.Success && importToCustomerInvoice)
                result = ImportFromCustomerInvoiceHeadIO(customerInvoiceHeadIOs, importId, actorCompanyId, type);

            result.StringValue = batchId;

            return result;
        }

        #endregion

        #region Import From CustomerInvoiceIO

        public ActionResult ImportCustomerInvoiceHeadIO(List<int> iosIds, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.CommandTimeout = 300;

                    List<CustomerInvoiceHeadIO> customerInvoiceHeadIOs = (from io in entities.CustomerInvoiceHeadIO
                                                                              .Include("CustomerInvoiceRowIO")
                                                                          where iosIds.Contains(io.CustomerInvoiceHeadIOId)
                                                                          select io).ToList();

                    foreach (CustomerInvoiceHeadIO customerInvoiceHeadIO in customerInvoiceHeadIOs)
                    {
                        customerInvoiceHeadIO.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    }

                    int importId = 0;
                    if (customerInvoiceHeadIOs.Any() && customerInvoiceHeadIOs.FirstOrDefault().ImportId.HasValue)
                        importId = customerInvoiceHeadIOs.FirstOrDefault().ImportId.Value;

                    result = ImportFromCustomerInvoiceHeadIO(customerInvoiceHeadIOs, importId, actorCompanyId, TermGroup_IOType.Unknown);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        public ActionResult ImportFromCustomerInvoiceHeadIO(List<CustomerInvoiceHeadIO> customerInvoiceHeadIOs, int importId, int actorCompanyId, TermGroup_IOType importType)
        {
            if (customerInvoiceHeadIOs == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoiceHeadIO");

            var result = new ActionResult();
            var savedInvoiceIds = new List<int>();
            var savedInvoiceNbrs = new List<string>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

#if DEBUG
            Stopwatch timer = new Stopwatch();
            timer.Start();
#endif

            #region Init

            int counter = customerInvoiceHeadIOs.Count;
            int counterTransferred = 0;
            int counterErrorOccurred = 0;
            int accountDimStdId = AccountManager.GetAccountDimStd(actorCompanyId).AccountDimId;

            #endregion

            #region Prereq

            //Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            //Customers
            //List<Customer> customers = CustomerManager.GetCustomersByCompany(actorCompanyId, true);

            //Update existing invoice?
            bool updateExistingInvoice = (from i in entitiesReadOnly.Import
                                          where i.ImportId == importId &&
                                          i.UpdateExistingInvoice
                                          select i.ImportId).ToList().Count > 0;

            this.rowNr = 0;

            #endregion

            try
            {
                #region Perform

                var invoiceImportCache = new ImportCustomerInvoiceCache(AccountManager, ProductManager);
                invoiceImportCache.FillCache(actorCompanyId, importId, this, SettingManager, WholeSellerManager, ProductPricelistManager);

                if (invoiceImportCache.SpecialFunctionality.Contains("Automaster"))
                {
                    //always update existing invoice in case of Automaster import
                    updateExistingInvoice = true;
                    //delete existing accounting rows when saving invoice head
                    invoiceImportCache.SpecialFunctionality.Add("deleteRows");
                }

                foreach (var io in customerInvoiceHeadIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing))
                {

                    ActionResult transferedResult = ImportFromCustomerInvoiceHeadIO(io, actorCompanyId, invoiceImportCache, accountDimStdId, updateExistingInvoice, importType);

                    #region Log transfere results

                    using (CompEntities entities = new CompEntities())
                    {
                        CustomerInvoiceHeadIO customerInvoiceHeadIO = entities.CustomerInvoiceHeadIO.Include("CustomerInvoiceRowIO").FirstOrDefault(i => i.CustomerInvoiceHeadIOId == io.CustomerInvoiceHeadIOId);
                        if (customerInvoiceHeadIO == null)
                            continue;

                        if (!transferedResult.Success)
                        {
                            customerInvoiceHeadIO.Status = (int)TermGroup_IOStatus.Error;
                            customerInvoiceHeadIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? (transferedResult.StrDict != null) ? transferedResult.StrDict.Values.FirstOrDefault() : string.Empty : transferedResult.ErrorMessage;

                            foreach (var customerInvoiceRowIO in customerInvoiceHeadIO.CustomerInvoiceRowIO)
                            {
                                string error = "";
                                if (transferedResult.StrDict != null)
                                    transferedResult.StrDict.TryGetValue(customerInvoiceRowIO.CustomerInvoiceRowIOId, out error);
                                customerInvoiceRowIO.Status = (int)TermGroup_IOStatus.Error;
                                customerInvoiceRowIO.ErrorMessage = string.IsNullOrEmpty(error) ? string.Empty : error;
                            }
                            counterErrorOccurred++;
                        }
                        else
                        {
                            if (io.InvoiceId.GetValueOrDefault() > 0)
                                savedInvoiceIds.Add(io.InvoiceId.Value);
                            if (!string.IsNullOrEmpty(transferedResult.StringValue))
                            {
                                savedInvoiceNbrs.Add(transferedResult.StringValue);
                            }
                            customerInvoiceHeadIO.InvoiceId = io.InvoiceId;
                            customerInvoiceHeadIO.CustomerId = io.CustomerId;
                            customerInvoiceHeadIO.Note = io.Note;
                            customerInvoiceHeadIO.Status = (int)TermGroup_IOStatus.Processed;
                            customerInvoiceHeadIO.ErrorMessage = "";
                            counterTransferred++;
                        }

                        result = SaveChanges(entities);
                        if (!result.Success)
                            return result;
                    }

                    if (!transferedResult.Success && io.Type == (int)TermGroup_IOType.WebAPI)
                    {
                        return transferedResult;
                    }

                    #endregion
                }


                #endregion
            }
            catch (Exception e)
            {
                result = new ActionResult(e);
                base.LogError(e, this.log);
            }

#if DEBUG
            timer.Stop();
            result.InfoMessage = "Time: " + timer.Elapsed.TotalSeconds.ToString("#,##0.00 'seconds'");
            Debug.WriteLine(result.InfoMessage);
#endif

            result.Success = (counterTransferred == counter);
            result.StringValue = string.Format("{0},{1}", counterTransferred, counterErrorOccurred);
            result.InfoMessage = result.ErrorMessage + "\\n" + string.Format(GetText(8415, "{0} kundfakturor utav {1} har skapats/uppdaterats."), counterTransferred, counter);
            result.Keys = savedInvoiceIds;
            result.Strings = savedInvoiceNbrs;
            return result;
        }

        public ActionResult ImportFromCustomerInvoiceHeadIO(CustomerInvoiceHeadIO customerInvoiceHeadIO, int actorCompanyId, ImportCustomerInvoiceCache invoiceImportCache, int accountDimStdId, bool updateExistingInvoice, TermGroup_IOType importType)
        {
            ActionResult result = new ActionResult();

            #region Init

            int currencyId = 0;
            bool newCustomerInvoice = false;
            bool priceListTypeInclVat = false;

            #endregion

            #region CustomerInvoiceIO

            try
            {
                #region Init

                customerInvoiceHeadIO.ErrorMessage = string.Empty;
                this.rowNr++;

                //Set currencyId                    
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                currencyId = GetCurrencyId(entitiesReadOnly, customerInvoiceHeadIO.Currency);

                //Set customerid
                if (!customerInvoiceHeadIO.CustomerId.HasValue)
                {
                    Customer customer = null;
                    if (!string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerNr))
                    {
                        customer = invoiceImportCache.GetCustomer(CustomerManager, customerInvoiceHeadIO.CustomerNr, actorCompanyId);  //CustomerManager.GetCustomerByNr(actorCompanyId, customerInvoiceHeadIO.CustomerNr, customers, true);
                    }
                    else if (!string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerExternalNr))
                    {
                        var externalIds = ActorManager.GetInternalIdsListFromExternalNr(TermGroup_CompanyExternalCodeEntity.Customer, customerInvoiceHeadIO.CustomerExternalNr, actorCompanyId);
                        if (externalIds.Count == 1)
                        {
                            customer = CustomerManager.GetCustomer(externalIds.First());
                        }
                        else if (externalIds.Count > 1)
                        {
                            throw new Exception($"More than 1 customer matching customerExternalNr {customerInvoiceHeadIO.CustomerExternalNr} was found");
                        }
                    }
                    else if (!string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerOrgNr))
                    {
                        var customerSearch = CustomerManager.GetCustomers(actorCompanyId, false, false, false, false, false, false, false, null, customerInvoiceHeadIO.CustomerOrgNr);
                        if (customerSearch.Count == 1)
                        {
                            customer = customerSearch.First();
                        }
                        else if (customerSearch.Count > 1)
                        {
                            throw new Exception($"More than 1 customer matching CustomerOrgNr {customerInvoiceHeadIO.CustomerOrgNr} was found");
                        }
                    }

                    if (customer == null && (customerInvoiceHeadIO.AutoCreateCustomer.HasValue && !(bool)customerInvoiceHeadIO.AutoCreateCustomer))
                    {
                        result = new ActionResult(false, (int)ActionResultSave.EntityNotCreated, GetText(8416, "Kund kunde inte mappas"));
                        return result;
                    }

                    //Try inactive before creating new customer
                    if (customer == null)
                        customer = CustomerManager.GetCustomerByNr(actorCompanyId, customerInvoiceHeadIO.CustomerNr, null, true);

                    if (customer != null)
                    {
                        customerInvoiceHeadIO.CustomerId = customer.ActorCustomerId;
                    }
                    else
                    {
                        //Create customer

                        #region Customer

                        var newCustomer = new CustomerDTO
                        {
                            CustomerNr = customerInvoiceHeadIO.CustomerNr,
                            OrgNr = customerInvoiceHeadIO.CustomerOrgNr,
                            Name = customerInvoiceHeadIO.CustomerName != null ? customerInvoiceHeadIO.CustomerName : customerInvoiceHeadIO.CustomerNr,
                            CustomerProducts = new List<CustomerProductPriceSmallDTO>(),
                        };

                        CompCurrency baseCurrency = CountryCurrencyManager.GetCompanyBaseCurrency(actorCompanyId);

                        if (baseCurrency != null)
                            newCustomer.CurrencyId = baseCurrency.CurrencyId;

                        #endregion

                        #region Billing Address

                        ContactAddressItem billingAddress = new ContactAddressItem()
                        {
                            ContactAddressItemType = ContactAddressItemType.AddressBilling,
                            SysContactAddressTypeId = (int)ContactAddressItemType.AddressBilling,
                            Address = customerInvoiceHeadIO.BillingAddressAddress,
                            AddressCO = customerInvoiceHeadIO.BillingAddressCO,
                            PostalAddress = customerInvoiceHeadIO.BillingAddressCity,
                            PostalCode = customerInvoiceHeadIO.BillingAddressPostNr,
                            Country = customerInvoiceHeadIO.BillingAddressCountry,
                            Name = customerInvoiceHeadIO.BillingAddressName,
                            IsAddress = true,
                        };

                        #endregion

                        #region Delivery Address

                        ContactAddressItem deliveryAddress = new ContactAddressItem()
                        {
                            ContactAddressItemType = ContactAddressItemType.AddressDelivery,
                            SysContactAddressTypeId = (int)ContactAddressItemType.AddressDelivery,
                            Address = customerInvoiceHeadIO.DeliveryAddressAddress,
                            AddressCO = customerInvoiceHeadIO.DeliveryAddressCO,
                            PostalAddress = customerInvoiceHeadIO.DeliveryAddressCity,
                            PostalCode = customerInvoiceHeadIO.DeliveryAddressPostNr,
                            Country = customerInvoiceHeadIO.DeliveryAddressCountry,
                            Name = customerInvoiceHeadIO.DeliveryAddressName,
                            IsAddress = true,
                        };

                        #endregion

                        List<ContactAddressItem> contactList = new List<ContactAddressItem>();
                        contactList.Add(billingAddress);
                        contactList.Add(deliveryAddress);

                        #region GlnNumber

                        if (!string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerGlnNr))
                        {
                            ContactAddressItem GlnNumber = new ContactAddressItem()
                            {
                                ContactAddressItemType = ContactAddressItemType.GlnNumber,
                                SysContactAddressTypeId = (int)ContactAddressItemType.GlnNumber,
                                Name = customerInvoiceHeadIO.CustomerGlnNr,
                                IsAddress = false,
                            };
                            contactList.Add(GlnNumber);
                        }
                        #endregion

                        #region Email

                        if (!string.IsNullOrEmpty(customerInvoiceHeadIO.Email))
                        {
                            ContactAddressItem Email = new ContactAddressItem()
                            {
                                ContactAddressItemType = ContactAddressItemType.EComEmail,
                                SysContactAddressTypeId = (int)ContactAddressItemType.EComEmail,
                                Name = customerInvoiceHeadIO.Email,
                                IsAddress = false,
                            };
                            contactList.Add(Email);
                        }
                        #endregion
                        newCustomer.ContactAddresses = contactList;

                        ActionResult res = CustomerManager.SaveCustomer(newCustomer, new List<CompanyCategoryRecordDTO>(), new List<int>(), null, actorCompanyId);

                        if (res.Success)
                            customerInvoiceHeadIO.CustomerId = res.IntegerValue;
                    }

                    int priceListTypeId = customerInvoiceHeadIO.PriceListTypeId.HasValue ? (int)customerInvoiceHeadIO.PriceListTypeId : 0;

                    if (priceListTypeId == 0 && !updateExistingInvoice)
                    {
                        int defaultPriceListTypeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, 0, actorCompanyId, 0);

                        if (defaultPriceListTypeId != 0)
                            priceListTypeId = InvoiceManager.GetPriceListTypeIdBasedOnPriority(customer, defaultPriceListTypeId);
                    }

                    if (priceListTypeId != 0)
                    {
                        var currentPriceListType = invoiceImportCache.PriceListTypes[priceListTypeId].FirstOrDefault();

                        if (currentPriceListType == null)
                        {
                            result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(1977, "Prislista borttagen"));
                            return result;
                        }

                        priceListTypeInclVat = currentPriceListType.InclusiveVat;
                    }
                }

                #endregion

                #region Validation

                #region Mandatory Values

                if (customerInvoiceHeadIO.OriginType == (int)SoeOriginType.None)
                {
                    result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8420, "Typ (offert/Order eller faktura) ej angiven"));
                    return result;
                }

                if (!customerInvoiceHeadIO.CustomerId.HasValue)
                {
                    result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8416, "Kund kunde inte mappas"));
                    return result;
                }

                if (currencyId == 0)
                {
                    Customer customer = CustomerManager.GetCustomerByNr(actorCompanyId, customerInvoiceHeadIO.CustomerNr);
                    if (customer != null)
                    {
                        currencyId = customer.CurrencyId;
                    }
                    else
                    {
                        CompCurrency baseCurrency = (from c in entitiesReadOnly.CompCurrency
                                                     where c.ActorCompanyId == actorCompanyId &&
                                                     c.BaseCurrency
                                                     select c).FirstOrDefault();
                        if (baseCurrency != null)
                            currencyId = baseCurrency.CurrencyId;
                    }

                    if (currencyId == 0)
                    {
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8417, "Valuta kunde inte mappas/hittas"));
                    }
                }

                if (!customerInvoiceHeadIO.BillingType.HasValue)
                {
                    //If value is negative, billingtype should be Credit, except when origin type is order
                    if (customerInvoiceHeadIO.TotalAmount.HasValue)
                    {
                        if (customerInvoiceHeadIO.TotalAmount < 0 && customerInvoiceHeadIO.OriginType != (int)SoeOriginType.Order)
                            customerInvoiceHeadIO.BillingType = (int)TermGroup_BillingType.Credit;
                        else
                            customerInvoiceHeadIO.BillingType = (int)TermGroup_BillingType.Debit;
                    }
                    else
                        customerInvoiceHeadIO.BillingType = (int)TermGroup_BillingType.Debit;
                }

                if (customerInvoiceHeadIO.OriginStatus == (int)SoeOriginStatus.None)
                {
                    customerInvoiceHeadIO.OriginStatus = (int)SoeOriginStatus.Draft;
                }

                if (customerInvoiceHeadIO.OriginType == (int)SoeOriginType.Order)
                {
                    if (!customerInvoiceHeadIO.InvoiceDate.HasValue)
                    {
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8418, "Orderdatum saknas"));
                    }
                    //  if (!string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerInvoiceNr))
                    if (!string.IsNullOrEmpty(customerInvoiceHeadIO.CustomerInvoiceNr) && customerInvoiceHeadIO.Type == (int)TermGroup_IOType.WebAPI)
                    {
                        return new ActionResult(7422, GetText(7422, "Ordernr ska inte anges"));
                    }
                }
                else if (customerInvoiceHeadIO.OriginType == (int)SoeOriginType.CustomerInvoice && !customerInvoiceHeadIO.InvoiceDate.HasValue)
                {
                    return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8419, "Fakturadatum saknas"));
                }

                if (currencyId > 0 && customerInvoiceHeadIO.CurrencyRate.HasValue && customerInvoiceHeadIO.CurrencyRate.Value != 0 && customerInvoiceHeadIO.CurrencyDate.HasValue)
                {
                    var baseCurrency = (from c in entitiesReadOnly.CompCurrency
                                        where c.ActorCompanyId == actorCompanyId &&
                                        c.BaseCurrency
                                        select c).FirstOrDefault();

                    if (currencyId != baseCurrency.CurrencyId && !CountryCurrencyManager.CurrencyRateExists(currencyId, actorCompanyId, customerInvoiceHeadIO.CurrencyDate.Value.Date))
                    {
                        CountryCurrencyManager.CreateCurrencyRate(currencyId, customerInvoiceHeadIO.CurrencyDate.Value.Date, (1 / customerInvoiceHeadIO.CurrencyRate.Value), customerInvoiceHeadIO.CurrencyRate.Value, TermGroup_CurrencySource.Manually, actorCompanyId);
                    }
                }

                #endregion

                #endregion
            }
            catch (Exception ex)
            {
                result.Exception = ex;
                base.LogError(ex, this.log);
            }

            #endregion

            #region Save

            if (result.Success)
            {
                if (customerInvoiceHeadIO.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger)
                {
                    #region Save CustomerLedger

                    #region Create SaveDTO

                    CustomerLedgerSaveDTO saveDTO = null;
                    var accountingRows = new List<AccountingRowDTO>();
                    using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                    result = InvoiceManager.ConvertToCustomerLedgerSaveDTO(entitiesReadOnly, customerInvoiceHeadIO, currencyId, actorCompanyId, ref saveDTO, invoiceImportCache.SpecialFunctionality);
                    if (!result.Success)
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, result.ErrorMessage);
                        return result;
                    }

                    if (invoiceImportCache.SpecialFunctionality.Any(f => f.ToLower().Equals("scanlog")))
                    {
                        var vatDict = new Dictionary<decimal, decimal>();
                        if (customerInvoiceHeadIO.VatAmount1 > 0 && customerInvoiceHeadIO.VatRate1 > 0)
                            vatDict.Add(customerInvoiceHeadIO.VatRate1.Value, customerInvoiceHeadIO.VatAmount1.Value);
                        if (customerInvoiceHeadIO.VatAmount2 > 0 && customerInvoiceHeadIO.VatRate2 > 0)
                            vatDict.Add(customerInvoiceHeadIO.VatRate2.Value, customerInvoiceHeadIO.VatAmount2.Value);
                        if (customerInvoiceHeadIO.VatAmount3 > 0 && customerInvoiceHeadIO.VatRate3 > 0)
                            vatDict.Add(customerInvoiceHeadIO.VatRate3.Value, customerInvoiceHeadIO.VatAmount3.Value);

                        accountingRows = InvoiceManager.GenerateAccountingRowsForCustomerInvoice(saveDTO, actorCompanyId, vatDict).ToList();
                    }
                    else
                    {
                        List<Account> accounts = GetCompanyAccountsWithAccountDim(entitiesReadOnly, actorCompanyId);

                        result = InvoiceManager.ConvertToCustomerLedgerAccountingRowDTO(customerInvoiceHeadIO.CustomerInvoiceRowIO.ToList(), accounts, accountingRows);
                        if (!result.Success)
                        {
                            return result;
                        }
                    }


                    #endregion

                    #region Save

                    result = InvoiceManager.SaveCustomerLedger(saveDTO, accountingRows, actorCompanyId, specialfunctionality: invoiceImportCache.SpecialFunctionality, isImport: true, updateExistingInvoice: updateExistingInvoice);

                    if (result.Success)
                    {
                        customerInvoiceHeadIO.InvoiceId = result.IntegerValue;

                        if (invoiceImportCache.SpecialFunctionality.Contains("Automaster") && !result.BooleanValue)
                            customerInvoiceHeadIO.Note = GetText(4879, "Fakturan har uppdaterats");
                    }

                    #endregion

                    #endregion
                }
                else
                {
                    #region Save CustomerInvoice

                    #region PreReq

                    if (SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceVoucherSeriesType, 0, actorCompanyId, 0) <= 0)
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(9145, "Finns ingen standardverifikatserie uppsatt"));

                    if (SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, 0, actorCompanyId, 0) <= 0)
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(9146, "Finns ingen standardprislista uppsatt"));

                    if (!Enum.IsDefined(typeof(TermGroup_BillingType), customerInvoiceHeadIO.BillingType) && customerInvoiceHeadIO.BillingType.HasValue)
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, string.Format("Fakturatypen {0} finns inte definerad", customerInvoiceHeadIO.BillingType));

                    if (!Enum.IsDefined(typeof(SoeOriginType), customerInvoiceHeadIO.OriginType) && customerInvoiceHeadIO.OriginType != (int)SoeOriginType.None)
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, string.Format("Origintype {0} finns inte definerad", customerInvoiceHeadIO.OriginType));

                    if (!Enum.IsDefined(typeof(OrderInvoiceRegistrationType), customerInvoiceHeadIO.RegistrationType) && customerInvoiceHeadIO.RegistrationType != (int)OrderInvoiceRegistrationType.Unknown)
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, string.Format("Registrationtype {0} finns inte definerad", customerInvoiceHeadIO.RegistrationType));

                    #endregion

                    #region Create SaveDTO

                    CustomerInvoiceSaveDTO saveDTO = null;
                    using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                    result = InvoiceManager.ConvertToCustomerInvoiceSaveDTO(entitiesReadOnly, customerInvoiceHeadIO, currencyId, actorCompanyId, ref saveDTO, invoiceImportCache.SpecialFunctionality);

                    if (!result.Success)
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, result.ErrorMessage);
                        return result;
                    }

                    #endregion

                    #region Save

                    int invoiceId = 0;
                    using (var entities = new CompEntities())
                    {
                        try
                        {
                            entities.Connection.Open();

                            InvoiceManager.InitializeAttestStateIds(entities, actorCompanyId);
                            invoiceImportCache.ClearCachePerConnection(customerInvoiceHeadIO);

                            using (TransactionScope transaction = CreateTransactionScope(new TimeSpan(0, 30, 0), System.Transactions.IsolationLevel.ReadCommitted))
                            {
                                result = InvoiceManager.SaveCustomerInvoice(entities, transaction, saveDTO, new List<CustomerInvoiceRowDTO>(), new List<AccountingRowDTO>(), actorCompanyId, ignoreTransfer: true, skipCreateVoucherCheck: importType == TermGroup_IOType.WebAPI, invoiceImportCache: invoiceImportCache);
                                if (result.Success)
                                {
                                    #region Product rows

                                    invoiceId = result.IntegerValue;

                                    // Save customer invoice rows
                                    customerInvoiceHeadIO.InvoiceId = invoiceId;

                                    if (customerInvoiceHeadIO.CustomerInvoiceRowIO != null)
                                    {
                                        Array.ForEach(customerInvoiceHeadIO.CustomerInvoiceRowIO.ToArray(), (r) =>
                                        {
                                            r.InvoiceId = invoiceId;
                                            r.InvoiceNr = customerInvoiceHeadIO.CustomerInvoiceNr;
                                        });
                                    }

                                    var invoiceNr = result.StringValue;
                                    result = ImportFromCustomerInvoiceRowIO(entities, transaction, customerInvoiceHeadIO, actorCompanyId, invoiceImportCache, accountDimStdId, invoiceImportCache.SpecialFunctionality.Contains("PIRATkundfakturor"));
                                    if (!result.Success || !string.IsNullOrEmpty(result.ErrorMessage))
                                        result.Success = false;
                                    else
                                    {
                                        result.StringValue = invoiceNr;
                                    }

                                    #endregion

                                    if (result.Success)
                                    {
                                        transaction.Complete();
                                    }
                                }
                            }
                        }
                        finally
                        {
                            entities.Connection.Close();
                        }
                    }

                    // Voucher - for now only pirat
                    if (result.Success &&
                        (invoiceImportCache.SpecialFunctionalityDict.ContainsKey("PIRATkundfakturor") || importType == TermGroup_IOType.WebAPI) &&
                        invoiceId > 0 &&
                        customerInvoiceHeadIO.RegistrationType != (int)OrderInvoiceRegistrationType.Ledger)
                    {
                        var saveVoucherResult = InvoiceManager.TryTransferCustomerInvoiceToVoucher(invoiceId, base.ActorCompanyId);
                        if (!saveVoucherResult.Success)
                        {
                            result.ErrorMessage = saveVoucherResult.ErrorMessage;
                        }
                    }

                    #endregion

                    #endregion
                }

                if (result.Success)
                {
                    customerInvoiceHeadIO.Status = (int)TermGroup_IOStatus.Processed;
                }
                else
                {
                    if (string.IsNullOrEmpty(result.ErrorMessage) && Enum.IsDefined(typeof(ActionResultSave), result.ErrorNumber))
                        result.ErrorMessage += string.Format(GetText(5654, "Felkod:") + " {0} ({1})", result.ErrorNumber, ((ActionResultSave)result.ErrorNumber).ToString()) + Environment.NewLine;

                    if (result.InfoMessage == "Add")
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8421, "Kundfaktura kunde inte skapas. ") + result.ErrorMessage);

                    if (Enum.IsDefined(typeof(ActionResultSave), result.ErrorNumber))
                        result.ErrorMessage += string.Format(" - " + GetText(5654, "Felkod:") + " {0} ({1})", result.ErrorNumber, ((ActionResultSave)result.ErrorNumber).ToString());

                    return result;
                }

                //Update counters
                if (newCustomerInvoice)
                    itemsAdded++;
                else
                    itemsUpdated++;
            }
            #endregion

            return result;
        }

        private ActionResult ImportFromCustomerInvoiceRowIO(CompEntities entities, TransactionScope transaction, CustomerInvoiceHeadIO customerInvoiceHeadIO, int actorCompanyId, ImportCustomerInvoiceCache importCustomerInvoiceCache, int accountDimStdId, bool addQuantityOnAccountingRow = false)
        {
            if (!customerInvoiceHeadIO.InvoiceId.HasValue)
                return new ActionResult(false);

            var result = new ActionResult();

            try
            {
                var miscProduct = importCustomerInvoiceCache.GetMiscProduct(entities, actorCompanyId);
                if (miscProduct == null)
                    result = new ActionResult(null, GetText(9144, "Ingen ströartikel hittad på företaget"));

                #region Prereq

                var invoice = InvoiceManager.GetCustomerInvoice(entities, customerInvoiceHeadIO.InvoiceId.Value, loadActor: true, loadInvoiceRow: true);
                invoice.PriceListTypeInclusiveVat = importCustomerInvoiceCache.PriceListTypes[invoice.PriceListTypeId.GetValueOrDefault()].FirstOrDefault()?.InclusiveVat ?? false;

                #endregion PreReq

                #region Special

                if (invoice.CustomerInvoiceRow.Count == 0)
                {
                    int mainFlatRateInvoiceRowId = 0;
                    if (customerInvoiceHeadIO.UseFixedPriceArticle == true && invoice.TotalAmount != 0 && customerInvoiceHeadIO.CustomerInvoiceRowIO.Count == 0)
                    {
                        var flatRateProduct = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductFlatPrice, actorCompanyId);
                        if (flatRateProduct == null)
                        {
                            result = new ActionResult(null, GetText(9144, "No flat rate product found on company"));
                            return result;
                        }

                        result = InvoiceManager.SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, invoice, 0, flatRateProduct.ProductId, 1, invoice.TotalAmountCurrency, miscProduct.Name, SoeInvoiceRowType.ProductRow, updateInvoice: false, vatAmountCurrency: invoice.VATAmountCurrency, addQuantityOnAccountingRow: addQuantityOnAccountingRow);
                        if (result.Success)
                            mainFlatRateInvoiceRowId = result.IntegerValue;
                    }

                    #region VatRateList (special for StoreOffice)

                    var hasVatRateList = new List<int>(3);
                    if (customerInvoiceHeadIO.VatRate1.HasValue && customerInvoiceHeadIO.VatAmount1.HasValue && customerInvoiceHeadIO.VatAmount1 > 0)
                        hasVatRateList.Add(1);
                    if (customerInvoiceHeadIO.VatRate2.HasValue && customerInvoiceHeadIO.VatAmount2.HasValue && customerInvoiceHeadIO.VatAmount2 > 0)
                        hasVatRateList.Add(2);
                    if (customerInvoiceHeadIO.VatRate3.HasValue && customerInvoiceHeadIO.VatAmount3.HasValue && customerInvoiceHeadIO.VatAmount3 > 0)
                        hasVatRateList.Add(3);

                    if (hasVatRateList.Count == 1 && mainFlatRateInvoiceRowId > 0)
                    {
                        // add to mainFlatRateProduct
                        int vatNr = hasVatRateList.First();
                        var rate = vatNr == 1 ? customerInvoiceHeadIO.VatRate1.Value : vatNr == 2 ? customerInvoiceHeadIO.VatRate2.Value : customerInvoiceHeadIO.VatRate3.Value;
                        var amount = vatNr == 1 ? customerInvoiceHeadIO.VatAmount1.Value : vatNr == 2 ? customerInvoiceHeadIO.VatAmount2.Value : customerInvoiceHeadIO.VatAmount3.Value;
                        var product = InvoiceManager.GetCustomerInvoiceRow(entities, mainFlatRateInvoiceRowId);
                        product.VatAmount = amount;
                        product.VatAmountCurrency = amount;
                        product.VatRate = rate;
                    }
                    else
                    {
                        var showVatRateAsText = importCustomerInvoiceCache.SpecialFunctionalityDict.ContainsKey("showVatRatesAsText");
                        decimal totalVatAmount = 0, totalVatRate = 0;

                        // Add the vat rows as flatraterows (with amount = 0)
                        foreach (var vatNr in hasVatRateList)
                        {
                            var flatRateProduct = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductFlatPrice, actorCompanyId);
                            decimal rate = vatNr == 1 ? customerInvoiceHeadIO.VatRate1.Value : vatNr == 2 ? customerInvoiceHeadIO.VatRate2.Value : customerInvoiceHeadIO.VatRate3.Value;
                            decimal amount = vatNr == 1 ? customerInvoiceHeadIO.VatAmount1.Value : vatNr == 2 ? customerInvoiceHeadIO.VatAmount2.Value : customerInvoiceHeadIO.VatAmount3.Value;
                            string rowText = "Moms: " + rate + "% = " + amount;
                            totalVatAmount += amount;
                            if (showVatRateAsText)
                                result = InvoiceManager.SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, invoice, 0, flatRateProduct.ProductId, 1, invoice.TotalAmountCurrency, rowText, SoeInvoiceRowType.TextRow, updateInvoice: false, vatAmountCurrency: amount, vatRate: rate, addQuantityOnAccountingRow: addQuantityOnAccountingRow);
                            else
                                result = InvoiceManager.SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, invoice, 0, flatRateProduct.ProductId, 1, invoice.TotalAmountCurrency, rowText, SoeInvoiceRowType.ProductRow, updateInvoice: false, vatAmountCurrency: amount, vatRate: rate, addQuantityOnAccountingRow: addQuantityOnAccountingRow);
                        }

                        if (showVatRateAsText && mainFlatRateInvoiceRowId > 0)
                        {
                            // Add vat amount to fixed price article when using text rows
                            totalVatRate = totalVatAmount / invoice.TotalAmountCurrency.ToNullable(0) ?? invoice.TotalAmount;
                            var productRow = InvoiceManager.GetCustomerInvoiceRow(entities, mainFlatRateInvoiceRowId);
                            productRow.VatAmount = totalVatAmount;
                            productRow.VatAmountCurrency = totalVatAmount;
                            productRow.VatRate = totalVatRate * 100;
                            invoice.VATAmountCurrency = invoice.VATAmount = totalVatAmount;
                            // Update fixed price article since it should be without VAT
                            if (productRow.AmountCurrency == invoice.TotalAmountCurrency && totalVatAmount > 0)
                            {
                                productRow.SumAmountCurrency = productRow.AmountCurrency = invoice.TotalAmountCurrency - totalVatAmount;
                                productRow.SumAmount = productRow.Amount = productRow.SumAmountCurrency;
                            }
                        }
                    }
                }

                if (result.Success)
                    SaveChanges(entities);

                #endregion

                #endregion

                if (invoice.TotalAmount != 0 && customerInvoiceHeadIO.CustomerInvoiceRowIO.Count == 0 && invoice.CustomerInvoiceRow.Count == 0)
                {
                    // If no rows are created but invoice has amount then use mics product
                    result = InvoiceManager.SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, invoice, 0, miscProduct.ProductId, 1, invoice.SumAmountCurrency, miscProduct.Name, SoeInvoiceRowType.ProductRow, updateInvoice: true, vatAmountCurrency: invoice.VATAmountCurrency, addQuantityOnAccountingRow: addQuantityOnAccountingRow);
                }
                else if (customerInvoiceHeadIO.CustomerInvoiceRowIO.Count > 0 && invoice != null && invoice.CustomerInvoiceRow.Count == 0)
                {
                    var ioRows = this.GetCustomerInvoiceRowIOs(entities, customerInvoiceHeadIO.CustomerInvoiceHeadIOId);
                    result = InvoiceManager.SaveCustomerInvoiceRowsFromIO(transaction, entities, actorCompanyId, invoice, ioRows, importCustomerInvoiceCache, accountDimStdId, true, pricelistTypeinclVat: invoice.PriceListTypeInclusiveVat, addQuantityOnAccountingRow, true);
                }
            }
            catch (Exception ex)
            {
                result.Success = false;
                result.ErrorMessage += ex.Message;
                LogError(result.ErrorMessage);
            }

            return result;
        }

        #endregion

        #endregion

        #region DistributionCodeIO

        public ActionResult ImportDistributionCodeIO(DistributionCodeIOItem distributionCodeIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromDistributionCodeIO(distributionCodeIOItem.distributionCodeIOs, actorCompanyId);
        }

        public ActionResult ImportFromDistributionCodeIO(List<DistributionCodeHeadIODTO> distributionCodeIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            foreach (var head in distributionCodeIOs)
            {
                DistributionCodeHeadDTO headDTO = new DistributionCodeHeadDTO();

                headDTO.ActorCompanyId = actorCompanyId;
                headDTO.NoOfPeriods = head.NoOfPeriods;
                headDTO.Name = head.Name;
                headDTO.Periods = new List<DistributionCodePeriodDTO>();

                foreach (var row in head.Periods)
                {
                    DistributionCodePeriodDTO periodDTO = new DistributionCodePeriodDTO();

                    periodDTO.Number = row.Number;
                    periodDTO.Percent = row.Percent;
                    periodDTO.Comment = row.Comment;

                    headDTO.Periods.Add(periodDTO);
                }

                ActionResult saveResult = BudgetManager.SaveDistributionCode(actorCompanyId, headDTO);

                if (saveResult.Success)
                    nbrOfSaved++;
            }

            result.IntegerValue = nbrOfSaved;

            return result;
        }

        #endregion

        #region EdiMessage

        public ActionResult ImportEdiMessage(Guid? companyApiKey, SysEdiMessageHeadDTO sysEdiMessageHeadDTO, bool TransferToOrder = false, bool TransferToSupplierInvoice = false)
        {
            return EdiManager.AddEdiEntryFromSysEdiMessageHeadDTO(companyApiKey, sysEdiMessageHeadDTO);
        }

        public ActionResult ImportEdiMessage(EdiMessageItem ediMessageItem, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromEdiMessage(ediMessageItem.sysEdiMessageHeadDTOs, actorCompanyId);
        }

        public ActionResult ImportFromEdiMessage(List<SysEdiMessageHeadDTO> SysEdiMessageHeadDTOs, int actorCompanyId)
        {
            var result = new ActionResult();

            int nbrOfSaved = 0;

            foreach (var head in SysEdiMessageHeadDTOs)
            {
                result = EdiManager.AddEdiEntryFromSysEdiMessageHeadDTO(actorCompanyId, head);
                nbrOfSaved++;
            }

            result.IntegerValue = nbrOfSaved;

            return result;
        }

        #endregion

        #region MassRegistration

        public byte[] ConvertMassRegistrationDTOsToExcel(List<MassRegistrationTemplateRowDTO> dtos)
        {
            #region Prereq

            List<AccountDim> dims = AccountManager.GetAccountDimsByCompany(base.ActorCompanyId, false, false, true);

            string yes = GetText(52, "Ja");
            string no = GetText(53, "Nej");

            #endregion

            #region Column headers

            List<string> headerNames = new List<string>();
            headerNames.Add(String.Format("{0} ({1})", GetText(3178, "Anställd"), GetText(1070, "Nummer")));
            headerNames.Add(String.Format("{0} ({1})", GetText(3178, "Anställd"), GetText(23, "Namn")));
            headerNames.Add(GetText(6810, 1004, "Utbetalningsdatum"));   // time.time.timeperiod.paymentdate
            headerNames.Add(String.Format("{0} ({1})", GetText(4601, 1004, "Löneart"), GetText(1070, "Nummer")));   // time.time.payrollproduct.payrollproduct
            headerNames.Add(String.Format("{0} ({1})", GetText(4601, 1004, "Löneart"), GetText(23, "Namn")));       // time.time.payrollproduct.payrollproduct
            headerNames.Add(GetText(78, 1002, "Från"));                  // common.from
            headerNames.Add(GetText(79, 1002, "Till"));                  // common.to
            headerNames.Add(GetText(52, 1002, "Antal"));                 // common.quantity
            headerNames.Add(GetText(11232, 1004, "Eget pris"));          // time.payroll.massregistration.row.isspecifiedunitprice
            headerNames.Add(GetText(21, 1002, "Pris"));                  // common.price
            foreach (AccountDim dim in dims)
            {
                headerNames.Add(String.Format("{0} ({1})", dim.Name, GetText(1070, "Nummer")));
                headerNames.Add(String.Format("{0} ({1})", dim.Name, GetText(23, "Namn")));
            }

            ExcelHelper helper = new ExcelHelper(GetText(11201, 1004, "Massregistrering"), headerNames);    // time.payroll.massregistration

            #endregion

            #region Data rows

            int rowNr = 2;
            foreach (MassRegistrationTemplateRowDTO dto in dtos)
            {
                List<object> row = new List<object>();
                row.Add(dto.EmployeeNr);
                row.Add(dto.EmployeeName);
                row.Add(dto.PaymentDate);
                row.Add(dto.ProductNr);
                row.Add(dto.ProductName);
                row.Add(dto.DateFrom);
                row.Add(dto.DateTo);
                row.Add(dto.Quantity);
                row.Add(dto.IsSpecifiedUnitPrice ? yes : no);
                row.Add(dto.UnitPrice);

                if (dims.Count > 0)
                {
                    row.Add(dto.Dim1Nr);
                    row.Add(dto.Dim1Name);

                    if (dims.Count > 1)
                    {
                        row.Add(dto.Dim2Nr);
                        row.Add(dto.Dim3Name);

                        if (dims.Count > 2)
                        {
                            row.Add(dto.Dim3Nr);
                            row.Add(dto.Dim3Name);

                            if (dims.Count > 3)
                            {
                                row.Add(dto.Dim4Nr);
                                row.Add(dto.Dim4Name);

                                if (dims.Count > 4)
                                {
                                    row.Add(dto.Dim5Nr);
                                    row.Add(dto.Dim5Name);

                                    if (dims.Count > 5)
                                    {
                                        row.Add(dto.Dim6Nr);
                                        row.Add(dto.Dim6Name);
                                    }
                                }
                            }
                        }
                    }
                }

                helper.AddDataRow(rowNr, row);
                rowNr++;
            }

            #endregion

            #region Formatting

            helper.FormatColumnsAsEditable(new List<string>() { "A", "D", "H", "I", "J" }, true);
            helper.FormatColumnsAsDate(new List<string>() { "C", "F", "G" }, true);
            helper.FormatColumnsAsNumber(new List<string>() { "H", "J" }, true);

            List<string> rightJustifyColumns = new List<string>() { "A", "D" };
            if (dims.Count > 0)
            {
                rightJustifyColumns.Add("K");
                if (dims.Count > 1)
                {
                    rightJustifyColumns.Add("M");
                    if (dims.Count > 2)
                    {
                        rightJustifyColumns.Add("O");
                        if (dims.Count > 3)
                        {
                            rightJustifyColumns.Add("Q");
                            if (dims.Count > 4)
                            {
                                rightJustifyColumns.Add("S");
                                if (dims.Count > 5)
                                {
                                    rightJustifyColumns.Add("U");
                                }
                            }
                        }
                    }
                }
            }
            helper.FormatColumnsHorizontalAlignment(rightJustifyColumns, ExcelHorizontalAlignment.Right, true);

            helper.FormatRowAsHeader(headerNames.Count);
            helper.AutoFitColumns();

            #endregion

            #region Validation

            helper.AddListValidationValues("I", new List<string>() { yes, no }, GetText(11926, "Ett felaktigt värde har angivits"), GetText(11927, "Välj ett värde ur listan"));

            #endregion

            return helper.GetData();
        }

        public List<MassRegistrationTemplateRowDTO> ConvertMassRegistrationExcelToDTOs(byte[] content, int actorCompanyId)
        {
            List<MassRegistrationTemplateRowDTO> dtos = new List<MassRegistrationTemplateRowDTO>();

            bool missingHeading = false;
            int rowCount = 0;

            #region Prereq

            List<AccountDim> dims = AccountManager.GetAccountDimsByCompany(base.ActorCompanyId, false, false, true, loadAccounts: true);

            #endregion

            #region Headers

            string yes = GetText(52, "Ja").ToLowerInvariant();
            string headingEmployeeNr = String.Format("{0} ({1})", GetText(3178, "Anställd"), GetText(1070, "Nummer"));
            string headingPaymentDate = GetText(6810, 1004, "Utbetalningsdatum");
            string headingPayrollProduct = String.Format("{0} ({1})", GetText(4601, 1004, "Löneart"), GetText(1070, "Nummer"));
            string headingDateFrom = GetText(78, 1002, "Från");
            string headingDateTo = GetText(79, 1002, "Till");
            string headingQuantity = GetText(52, 1002, "Antal");
            string headingSpecifiedPrice = GetText(11232, 1004, "Eget pris");
            string headingUnitPrice = GetText(21, 1002, "Pris");
            string headingDim1 = String.Empty;
            string headingDim2 = String.Empty;
            string headingDim3 = String.Empty;
            string headingDim4 = String.Empty;
            string headingDim5 = String.Empty;
            string headingDim6 = String.Empty;

            if (dims.Count > 0)
            {
                headingDim1 = String.Format("{0} ({1})", dims[0].Name, GetText(1070, "Nummer"));
                if (dims.Count > 1)
                {
                    headingDim2 = String.Format("{0} ({1})", dims[1].Name, GetText(1070, "Nummer"));
                    if (dims.Count > 2)
                    {
                        headingDim3 = String.Format("{0} ({1})", dims[2].Name, GetText(1070, "Nummer"));
                        if (dims.Count > 3)
                        {
                            headingDim4 = String.Format("{0} ({1})", dims[3].Name, GetText(1070, "Nummer"));
                            if (dims.Count > 4)
                            {
                                headingDim5 = String.Format("{0} ({1})", dims[4].Name, GetText(1070, "Nummer"));
                                if (dims.Count > 5)
                                    headingDim6 = String.Format("{0} ({1})", dims[5].Name, GetText(1070, "Nummer"));
                            }
                        }
                    }
                }
            }

            #endregion

            #region Data

            ExcelHelper helper = new ExcelHelper();
            DataSet ds = helper.GetDataSet(content, true);
            if (ds != null)
            {
                if (!ValidateColumnHeader(headingEmployeeNr, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingPaymentDate, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingPayrollProduct, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingDateFrom, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingDateTo, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingQuantity, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingSpecifiedPrice, ds.Tables[0].Columns, dtos))
                    missingHeading = true;
                if (!ValidateColumnHeader(headingUnitPrice, ds.Tables[0].Columns, dtos))
                    missingHeading = true;

                if (!missingHeading)
                {

                    foreach (DataRow row in ds.Tables[0].Rows)
                    {
                        StringBuilder warnings = new StringBuilder();
                        rowCount++;
                        MassRegistrationTemplateRowDTO dto = new MassRegistrationTemplateRowDTO();

                        string employeeNr = helper.GetStringValue(row, headingEmployeeNr, false);
                        if (!string.IsNullOrEmpty(employeeNr))
                        {
                            Employee employee = EmployeeManager.GetEmployeeByNr(employeeNr, actorCompanyId, loadContactPerson: true);
                            if (employee != null)
                            {
                                dto.EmployeeId = employee.EmployeeId;
                                dto.EmployeeNr = employee.EmployeeNr;
                                dto.EmployeeName = employee.Name;
                            }
                        }
                        else
                            warnings.Append(String.Format(GetText(12086, "Radnr: {0} Saknar anställningsnummer."), rowCount));

                        dto.PaymentDate = helper.GetDateValue(row, headingPaymentDate);

                        string payrollProductStr = helper.GetStringValue(row, headingPayrollProduct, false);
                        if (!string.IsNullOrEmpty(payrollProductStr))
                        {
                            PayrollProduct payrollProduct = ProductManager.GetPayrollProductByNumber(payrollProductStr, actorCompanyId);
                            if (payrollProduct != null)
                            {
                                dto.ProductId = payrollProduct.ProductId;
                                dto.ProductNr = payrollProduct.Number;
                                dto.ProductName = payrollProduct.Name;
                            }
                        }

                        dto.DateFrom = helper.GetDateValue(row, headingDateFrom);
                        dto.DateTo = helper.GetDateValue(row, headingDateTo);
                        dto.Quantity = helper.GetDecimalValue(row, headingQuantity, false).Value;

                        string isSpecifiedPriceStr = helper.GetStringValue(row, headingSpecifiedPrice, true);
                        if (isSpecifiedPriceStr.Equals(yes))
                            dto.IsSpecifiedUnitPrice = true;

                        dto.UnitPrice = helper.GetDecimalValue(row, headingUnitPrice, false).Value;

                        if (dims.Count > 0)
                        {
                            if (!ValidateColumnHeader(headingDim1, ds.Tables[0].Columns, dtos))
                                missingHeading = true;
                            else
                            {
                                Account acc1 = GetAccountFromDataRow(row, headingDim1, dims);
                                if (acc1 != null)
                                {
                                    dto.Dim1Id = acc1.AccountId;
                                    dto.Dim1Nr = acc1.AccountNr;
                                    dto.Dim1Name = acc1.Name;
                                }
                            }

                            if (dims.Count > 1)
                            {
                                if (!ValidateColumnHeader(headingDim2, ds.Tables[0].Columns, dtos))
                                    missingHeading = true;
                                else
                                {
                                    Account acc2 = GetAccountFromDataRow(row, headingDim2, dims);
                                    if (acc2 != null)
                                    {
                                        dto.Dim2Id = acc2.AccountId;
                                        dto.Dim2Nr = acc2.AccountNr;
                                        dto.Dim2Name = acc2.Name;
                                    }
                                }

                                if (dims.Count > 2)
                                {
                                    if (!ValidateColumnHeader(headingDim3, ds.Tables[0].Columns, dtos))
                                        missingHeading = true;
                                    else
                                    {
                                        Account acc3 = GetAccountFromDataRow(row, headingDim3, dims);
                                        if (acc3 != null)
                                        {
                                            dto.Dim3Id = acc3.AccountId;
                                            dto.Dim3Nr = acc3.AccountNr;
                                            dto.Dim3Name = acc3.Name;
                                        }
                                    }

                                    if (dims.Count > 3)
                                    {
                                        if (!ValidateColumnHeader(headingDim4, ds.Tables[0].Columns, dtos))
                                            missingHeading = true;
                                        else
                                        {
                                            Account acc4 = GetAccountFromDataRow(row, headingDim4, dims);
                                            if (acc4 != null)
                                            {
                                                dto.Dim4Id = acc4.AccountId;
                                                dto.Dim4Nr = acc4.AccountNr;
                                                dto.Dim4Name = acc4.Name;
                                            }
                                        }

                                        if (dims.Count > 4)
                                        {
                                            if (!ValidateColumnHeader(headingDim5, ds.Tables[0].Columns, dtos))
                                                missingHeading = true;
                                            else
                                            {
                                                Account acc5 = GetAccountFromDataRow(row, headingDim5, dims);
                                                if (acc5 != null)
                                                {
                                                    dto.Dim5Id = acc5.AccountId;
                                                    dto.Dim5Nr = acc5.AccountNr;
                                                    dto.Dim5Name = acc5.Name;
                                                }
                                            }

                                            if (dims.Count > 5)
                                            {
                                                if (!ValidateColumnHeader(headingDim6, ds.Tables[0].Columns, dtos))
                                                    missingHeading = true;
                                                else
                                                {
                                                    Account acc6 = GetAccountFromDataRow(row, headingDim6, dims);
                                                    if (acc6 != null)
                                                    {
                                                        dto.Dim6Id = acc6.AccountId;
                                                        dto.Dim6Nr = acc6.AccountNr;
                                                        dto.Dim6Name = acc6.Name;
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        if (missingHeading)
                            break;
                        if (!warnings.ToString().IsNullOrEmpty())
                            dto.Warnings = warnings.ToString();

                        dtos.Add(dto);
                    }
                }
            }

            #endregion

            return dtos;
        }

        private bool ValidateColumnHeader(string heading, DataColumnCollection columns, List<MassRegistrationTemplateRowDTO> dtos)
        {
            if (!columns.Contains(heading))
            {
                dtos.Add(new MassRegistrationTemplateRowDTO() { ErrorMessage = String.Format(GetText(12053, "Excelarket saknar kolumn med rubriken {0}"), heading) });
                return false;
            }

            return true;
        }

        private Account GetAccountFromDataRow(DataRow row, string heading, List<AccountDim> dims)
        {
            string accountNr = row[heading].ToString();
            if (string.IsNullOrEmpty(accountNr))
                return null;

            string dimHeading = heading.Left(heading.Length - GetText(1070, "Nummer").Length - 3);
            AccountDim dim = dims.FirstOrDefault(d => d.Name == dimHeading);
            if (dim == null)
                return null;

            return dim.Account.FirstOrDefault(a => a.AccountNr == accountNr);
        }

        public List<MassRegistrationTemplateRowDTO> ConvertMassRegistrationSoftOneClassicFileToDTOs(MemoryStream ms, DateTime? paymentDate, int actorCompanyId)
        {
            List<MassRegistrationTemplateRowDTO> dtos = new List<MassRegistrationTemplateRowDTO>();

            #region Prereq

            List<AccountDim> dims = AccountManager.GetAccountDimsByCompany(base.ActorCompanyId, false, false, true, loadAccounts: true);

            ms.Position = 0;
            StreamReader reader = new StreamReader(ms, Encoding.Default);

            #endregion

            bool sectionTransactions = false;
            string line = reader.ReadLine();
            while (line != null)
            {
                line = line.Trim();
                if (line != String.Empty)
                {
                    string[] row = line.Split(',');
                    // Each section in file starts with '//' (E.g: //Schema, //Transaktioner)
                    if (line.StartsWith("//"))
                    {
                        if (sectionTransactions)
                            break;

                        string type = line.Substring(2).Trim();
                        sectionTransactions = (!string.IsNullOrEmpty(type) && type.ToLowerInvariant() == "transaktioner");
                    }
                    else if (sectionTransactions || (row.Length > 2 && row[0] != "@" && row[2] != "@"))
                    {
                        // Inside transaction section

                        #region Extract data

                        // Read line data into strings
                        string employeeNr = row.Length > 0 ? row[0] : String.Empty;
                        //string department = row.Length > 1 ? row[1] : String.Empty;
                        string payrollProductNr = row.Length > 2 ? row[2] : String.Empty;
                        string quantityStr = row.Length > 3 ? row[3] : String.Empty;
                        string dateFromStr = row.Length > 4 ? row[4] : String.Empty;
                        string dateToStr = row.Length > 5 ? row[5] : String.Empty;
                        //string calendarDaysStr = row.Length > 6 ? row[6] : String.Empty;
                        //string workDaysStr = row.Length > 7 ? row[7] : String.Empty;
                        string unitPriceStr = row.Length > 8 ? row[8] : String.Empty;
                        string accountStr = row.Length > 9 ? row[9] : String.Empty;
                        //string processingRuleStr = row.Length > 10 ? row[10] : String.Empty;
                        //string scopeStr = row.Length > 11 ? row[11] : String.Empty;

                        // Accounts are semicolon separated inside its own placeholder
                        string[] accounts = !string.IsNullOrEmpty(accountStr) ? accountStr.Split(';') : new string[0];

                        #endregion

                        #region Data

                        // Create DTO and set data
                        MassRegistrationTemplateRowDTO dto = new MassRegistrationTemplateRowDTO();

                        if (!string.IsNullOrEmpty(employeeNr))
                        {
                            Employee employee = EmployeeManager.GetEmployeeByNr(employeeNr, actorCompanyId, loadContactPerson: true);
                            if (employee != null)
                            {
                                dto.EmployeeId = employee.EmployeeId;
                                dto.EmployeeNr = employee.EmployeeNr;
                                dto.EmployeeName = employee.Name;
                            }
                        }

                        dto.PaymentDate = paymentDate;

                        if (!string.IsNullOrEmpty(payrollProductNr))
                        {
                            PayrollProduct payrollProduct = ProductManager.GetPayrollProductByNumber(payrollProductNr, actorCompanyId);
                            if (payrollProduct != null)
                            {
                                dto.ProductId = payrollProduct.ProductId;
                                dto.ProductNr = payrollProduct.Number;
                                dto.ProductName = payrollProduct.Name;
                            }
                        }

                        if (!string.IsNullOrEmpty(quantityStr) && decimal.TryParse(quantityStr.Replace('.', ','), out decimal quantity))
                            dto.Quantity = quantity;
                        if (!string.IsNullOrEmpty(dateFromStr) && DateTime.TryParseExact(dateFromStr, "yyyyMMdd", new CultureInfo("sv-SE"), DateTimeStyles.None, out DateTime tmpDateFrom))
                            dto.DateFrom = tmpDateFrom;
                        if (!string.IsNullOrEmpty(dateToStr) && DateTime.TryParseExact(dateToStr, "yyyyMMdd", new CultureInfo("sv-SE"), DateTimeStyles.None, out DateTime tmpDateTo))
                            dto.DateTo = tmpDateTo;

                        if (!string.IsNullOrEmpty(unitPriceStr) && decimal.TryParse(unitPriceStr.Replace('.', ','), out decimal unitPrice))
                        {
                            dto.UnitPrice = unitPrice;
                            if (unitPrice != 0)
                                dto.IsSpecifiedUnitPrice = true;
                        }

                        if (accounts.Length > 0 && dims.Any())
                        {
                            Account acc1 = GetAccountFromAccountNr(0, accounts, dims);
                            if (acc1 != null)
                            {
                                dto.Dim1Id = acc1.AccountId;
                                dto.Dim1Nr = acc1.AccountNr;
                                dto.Dim1Name = acc1.Name;
                            }

                            if (dims.Count > 1)
                            {
                                Account acc2 = GetAccountFromAccountNr(1, accounts, dims);
                                if (acc2 != null)
                                {
                                    dto.Dim2Id = acc2.AccountId;
                                    dto.Dim2Nr = acc2.AccountNr;
                                    dto.Dim2Name = acc2.Name;
                                }

                                if (dims.Count > 2)
                                {
                                    Account acc3 = GetAccountFromAccountNr(2, accounts, dims);
                                    if (acc3 != null)
                                    {
                                        dto.Dim3Id = acc3.AccountId;
                                        dto.Dim3Nr = acc3.AccountNr;
                                        dto.Dim3Name = acc3.Name;
                                    }

                                    if (dims.Count > 3)
                                    {
                                        Account acc4 = GetAccountFromAccountNr(3, accounts, dims);
                                        if (acc4 != null)
                                        {
                                            dto.Dim4Id = acc4.AccountId;
                                            dto.Dim4Nr = acc4.AccountNr;
                                            dto.Dim4Name = acc4.Name;
                                        }

                                        if (dims.Count > 4)
                                        {
                                            Account acc5 = GetAccountFromAccountNr(4, accounts, dims);
                                            if (acc5 != null)
                                            {
                                                dto.Dim5Id = acc5.AccountId;
                                                dto.Dim5Nr = acc5.AccountNr;
                                                dto.Dim5Name = acc5.Name;
                                            }

                                            if (dims.Count > 5)
                                            {
                                                Account acc6 = GetAccountFromAccountNr(5, accounts, dims);
                                                if (acc6 != null)
                                                {
                                                    dto.Dim6Id = acc6.AccountId;
                                                    dto.Dim6Nr = acc6.AccountNr;
                                                    dto.Dim6Name = acc6.Name;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        dtos.Add(dto);

                        #endregion
                    }
                }

                line = reader.ReadLine();
            }

            return dtos;
        }
        public List<MassRegistrationTemplateRowDTO> ConvertMassRegistrationPaXmlFileToDTOs(byte[] file, DateTime? paymentDate, int actorCompanyId)
        {
            IPayrollImportable model = null;
            List<MassRegistrationTemplateRowDTO> dtos = new List<MassRegistrationTemplateRowDTO>();
            var entities = new CompEntities();
            PaXml2 paXml2 = new PaXml2(file);
            model = paXml2;

            if (model == null)
                return null;

            List<EmployeeGroup> employeeGroups = GetEmployeeGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<PayrollGroup> payrollGroups = GetPayrollGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<VacationGroup> vacationGroups = GetVacationGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<PayrollPriceType> payrollPriceTypes = GetPayrollPriceTypesFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<int> employeeIds = EmployeeManager.GetAllEmployeeIdsByEmployeeNr(this.ActorCompanyId, paXml2.GetEmployeeNrs());
            List<EmployeeDTO> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, this.ActorCompanyId, this.UserId, this.RoleId, employeeFilter: employeeIds, loadEmployeeVactionSE: true).ToDTOs(employeeGroups: employeeGroups, payrollGroups: payrollGroups, vacationGroups: vacationGroups, payrollPriceTypes: payrollPriceTypes).ToList();
            List<AccountDimDTO> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId, loadAccounts: true, loadInternalAccounts: true).ToDTOs(includeAccounts: true, loadInternalAccounts: true);
            List<PayrollProductGridDTO> payrollProducts = ProductManager.GetPayrollProducts(actorCompanyId, null).ToGridDTOs().ToList();
            List<TimeDeviationCauseDTO> timeDeviationCauses = TimeDeviationCauseManager.GetTimeDeviationCauses(actorCompanyId).ToDTOs().ToList();
            PayrollImportHeadDTO importHead = model.ParseToPayrollImportHead(actorCompanyId, file, paymentDate, employees, accountDims, payrollProducts, timeDeviationCauses);

            string employeeNr;
            string employeeName;

            foreach (var employee in importHead.Employees)
            {
                if (employee.Transactions.Count == 0)
                    continue;

                employeeNr = employees.FirstOrDefault(w => w.EmployeeId == employee.EmployeeId)?.EmployeeNr ?? string.Empty;
                employeeName = employees.FirstOrDefault(w => w.EmployeeId == employee.EmployeeId)?.Name ?? string.Empty;

                foreach (var transaction in employee.Transactions)
                {
                    MassRegistrationTemplateRowDTO dto = new MassRegistrationTemplateRowDTO
                    {
                        PaymentDate = importHead.PaymentDate,
                        EmployeeId = employee.EmployeeId,
                        EmployeeNr = employeeNr,
                        EmployeeName = employeeName,

                        ProductId = transaction.PayrollProductId ?? 0,
                        ProductNr = payrollProducts.FirstOrDefault(w => w.ProductId == transaction.PayrollProductId)?.Number ?? string.Empty,
                        ProductName = payrollProducts.FirstOrDefault(w => w.ProductId == transaction.PayrollProductId)?.Name ?? string.Empty,
                        Quantity = transaction.Quantity,
                        DateFrom = transaction.Date,
                        DateTo = transaction.Date,
                        UnitPrice = transaction.Amount,

                        IsSpecifiedUnitPrice = true,
                        Dim1Id = transaction.AccountStdId ?? 0,
                        Dim1Name = transaction.AccountStdName,
                        Dim1Nr = transaction.AccountStdNr,
                    };

                    if (transaction.AccountInternals.Count > 0 && accountDims.Any())
                    {

                        foreach (var accI in transaction.AccountInternals)
                        {
                            var acc2 = accountDims.FirstOrDefault(f => f.AccountDimNr == 2)?.Accounts.FirstOrDefault(w => w.AccountId == accI.AccountId);
                            var acc3 = accountDims.FirstOrDefault(f => f.AccountDimNr == 3)?.Accounts.FirstOrDefault(w => w.AccountId == accI.AccountId);
                            var acc4 = accountDims.FirstOrDefault(f => f.AccountDimNr == 4)?.Accounts.FirstOrDefault(w => w.AccountId == accI.AccountId);
                            var acc5 = accountDims.FirstOrDefault(f => f.AccountDimNr == 5)?.Accounts.FirstOrDefault(w => w.AccountId == accI.AccountId);
                            var acc6 = accountDims.FirstOrDefault(f => f.AccountDimNr == 6)?.Accounts.FirstOrDefault(w => w.AccountId == accI.AccountId);

                            if (acc6 != null)
                            {
                                dto.Dim6Id = acc6.AccountId;
                                dto.Dim6Nr = acc6.AccountNr;
                                dto.Dim6Name = acc6.Name;
                            }
                            if (acc5 != null)
                            {
                                dto.Dim5Id = acc5.AccountId;
                                dto.Dim5Nr = acc5.AccountNr;
                                dto.Dim5Name = acc5.Name;
                            }
                            if (acc4 != null)
                            {
                                dto.Dim4Id = acc4.AccountId;
                                dto.Dim4Nr = acc4.AccountNr;
                                dto.Dim4Name = acc4.Name;
                            }
                            if (acc3 != null)
                            {
                                dto.Dim3Id = acc3.AccountId;
                                dto.Dim3Nr = acc3.AccountNr;
                                dto.Dim3Name = acc3.Name;
                            }
                            if (acc2 != null)
                            {
                                dto.Dim2Id = acc2.AccountId;
                                dto.Dim2Nr = acc2.AccountNr;
                                dto.Dim2Name = acc2.Name;
                            }

                        }
                    }

                    dtos.Add(dto);
                }
            }


            return dtos;
        }
        private Account GetAccountFromAccountNr(int index, string[] accounts, List<AccountDim> dims)
        {
            if (accounts.Length <= index || dims.Count <= index)
                return null;

            string accountNr = accounts[index];
            if (string.IsNullOrEmpty(accountNr))
                return null;

            AccountDim dim = dims[index];
            if (dim == null)
                return null;

            return dim.Account.FirstOrDefault(a => a.AccountNr == accountNr);
        }

        #endregion

        #region PayrollReview

        private string payrollReviewEmployeeNrHeader { get { return GetText(3601, 1004, "Anställningsnummer"); } }
        private string payrollReviewEmployeeNameHeader { get { return GetText(23, 1004, "Namn"); } }
        private string payrollReviewPayrollGroupNameHeader { get { return GetText(9121, 1004, "Löneavtal"); } }
        private string payrollReviewPriceTypeHeader { get { return GetText(3145, 1004, "Lönetyp"); } }
        private string payrollReviewPayrollLevelHeader { get { return GetText(91942, 1004, "Lönenivå"); } }
        private string payrollReviewPayrollGroupAmountHeader { get { return GetText(10302, 1004, "Enligt löneavtal"); } }
        private string payrollReviewEmploymentAmountHeader { get { return GetText(3669, 1004, "Aktuellt belopp"); } }
        private string payrollReviewAdjustmentHeader { get { return GetText(3670, 1004, "Justering"); } }
        private string payrollReviewAmountHeader { get { return GetText(3661, 1004, "Nytt belopp"); } }

        public byte[] ConvertPayrollReviewDTOsToExcel(List<PayrollReviewRowDTO> dtos)
        {
            List<string> headerNames = new List<string>()
            {
                payrollReviewEmployeeNrHeader,
                payrollReviewEmployeeNameHeader,
                payrollReviewPayrollGroupNameHeader,
                payrollReviewPriceTypeHeader,
                payrollReviewPayrollLevelHeader,
                payrollReviewPayrollGroupAmountHeader,
                payrollReviewEmploymentAmountHeader,
                payrollReviewAdjustmentHeader,
                payrollReviewAmountHeader,
            };

            ExcelHelper helper = new ExcelHelper(GetText(11887, "Lönejustering"), headerNames);

            int rowNr = 2;
            foreach (PayrollReviewRowDTO dto in dtos)
            {
                List<object> row = new List<object>()
                {
                    dto.EmployeeNr,
                    dto.EmployeeName,
                    dto.PayrollGroupName,
                    dto.PayrollPriceTypeName,
                    dto.PayrollLevelName,
                    dto.PayrollGroupAmount,
                    dto.EmploymentAmount,
                    dto.Adjustment,
                    dto.Amount,
                };
                helper.AddDataRow(rowNr, row);
                rowNr++;
            }

            //Formatting
            helper.FormatColumnAsEditable("H", true);
            helper.FormatColumnsAsNumber(new List<string>() { "E", "F", "G", "H" }, true);
            helper.FormatColumnHorizontalAlignment("A", ExcelHorizontalAlignment.Right, true);
            helper.FormatRowAsHeader(headerNames.Count);
            helper.AutoFitColumns();

            return helper.GetData();
        }

        public List<PayrollReviewRowDTO> ConvertPayrollReviewExcelToDTOs(byte[] content, DateTime date, int actorCompanyId)
        {
            List<PayrollReviewRowDTO> dtos = new List<PayrollReviewRowDTO>();

            ExcelHelper helper = new ExcelHelper();
            DataSet ds = helper.GetDataSet(content, true);
            if (ds == null)
                return dtos;

            List<PayrollGroup> payrollGroups = PayrollManager.GetPayrollGroups(actorCompanyId, loadPriceTypes: true);
            List<PayrollLevel> payrollLevels = PayrollManager.GetPayrollLevels(actorCompanyId);

            foreach (DataRow row in ds.Tables[0].Rows)
            {
                PayrollReviewRowDTO dto = new PayrollReviewRowDTO();
                StringBuilder warningMessage = new StringBuilder();
                StringBuilder errorMessage = new StringBuilder();

                Employee employee = EmployeeManager.GetEmployeeByNr(helper.GetStringValue(row, this.payrollReviewEmployeeNrHeader, false), actorCompanyId, loadContactPerson: true, loadEmployment: true);
                if (employee != null)
                {
                    dto.EmployeeId = employee.EmployeeId;
                    dto.EmployeeNr = employee.EmployeeNr;
                    dto.EmployeeName = employee.Name;

                    Employment employment = employee.GetEmployment(date);
                    if (employment != null)
                    {
                        string payrollgroupName = helper.GetStringValue(row, this.payrollReviewPayrollGroupNameHeader, true);
                        if (!string.IsNullOrEmpty(payrollgroupName))
                        {
                            PayrollGroup payrollGroup = payrollGroups.FirstOrDefault(f => f.Name.ToLower().Trim() == payrollgroupName);
                            if (payrollGroup != null && payrollGroup.PayrollGroupId == employment.GetPayrollGroupId(date))
                            {
                                dto.PayrollGroupId = payrollGroup.PayrollGroupId;
                                dto.PayrollGroupName = payrollGroup.Name;

                                string payrollPriceTypeName = helper.GetStringValue(row, this.payrollReviewPriceTypeHeader, true);
                                if (!string.IsNullOrEmpty(payrollPriceTypeName))
                                {
                                    PayrollPriceType payrollPriceType = payrollGroup.PayrollGroupPriceType?.FirstOrDefault(p => p.PayrollPriceType.Name.ToLower().Trim() == payrollPriceTypeName)?.PayrollPriceType;
                                    if (payrollPriceType != null)
                                    {
                                        dto.PayrollPriceTypeName = payrollPriceType.Name;
                                        dto.PayrollPriceTypeId = payrollPriceType.PayrollPriceTypeId;
                                        dto.Amount = Decimal.Round(helper.GetDecimalValue(row, this.payrollReviewAmountHeader, false).Value, 2, MidpointRounding.AwayFromZero);
                                        dto.Adjustment = Decimal.Round(helper.GetDecimalValue(row, this.payrollReviewAdjustmentHeader, false).Value, 2, MidpointRounding.AwayFromZero);
                                        dto.EmploymentAmount = helper.GetDecimalValue(row, this.payrollReviewEmploymentAmountHeader, true);
                                        dto.PayrollGroupAmount = helper.GetDecimalValue(row, this.payrollReviewPayrollGroupAmountHeader, true);

                                        decimal currentAmount = dto.EmploymentAmount != 0 ? dto.EmploymentAmount ?? 0 : dto.PayrollGroupAmount ?? 0;
                                        if ((dto.Amount - dto.Adjustment - currentAmount) != 0)
                                            warningMessage.Append(GetText(11886, "Beloppen går inte ihop") + $" ({dto.Amount}-{dto.Adjustment}-{currentAmount}) <> 0").Append(Environment.NewLine);

                                        string payrollLevelName = helper.GetStringValue(row, this.payrollReviewPayrollLevelHeader, true);
                                        if (!payrollLevelName.IsNullOrEmpty())
                                        {
                                            PayrollLevel payrollLevel = payrollLevels?.FirstOrDefault(p => p.Name.ToLower().Trim() == payrollLevelName);
                                            if (payrollLevel != null)
                                            {
                                                dto.PayrollLevelId = payrollLevel.PayrollLevelId;
                                                dto.PayrollLevelName = payrollLevel.Name;
                                            }
                                            else
                                            {
                                                errorMessage.Append(GetText(91952, "Lönenivå hittades inte")).Append(Environment.NewLine);
                                            }
                                        }
                                    }
                                    else
                                    {
                                        errorMessage.Append(GetText(91951, "Lönetyp hittades inte")).Append(Environment.NewLine);
                                    }
                                }
                                else
                                {
                                    errorMessage.Append(GetText(11885, "Lönetyp saknas")).Append(Environment.NewLine);
                                }
                            }
                            else
                            {
                                errorMessage.Append(GetText(91950, "Löneavtal hittades inte")).Append(Environment.NewLine);
                            }
                        }
                        else
                        {
                            errorMessage.Append(GetText(11884, "Löneavtal saknas")).Append(Environment.NewLine);
                        }
                    }
                    else
                    {
                        errorMessage.Append(GetText(11883, "Anställning saknas")).Append(Environment.NewLine);
                    }

                    if (!string.IsNullOrEmpty(warningMessage.ToString()))
                        dto.WarningMessage = warningMessage.ToString();
                    if (!string.IsNullOrEmpty(errorMessage.ToString()))
                        dto.ErrorMessage = errorMessage.ToString();

                    dtos.Add(dto);
                }
            }

            return dtos;
        }

        #endregion

        #region PaymentIO

        public ActionResult ImportPaymentIO(PaymentIOItem paymentIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool fromSOP)
        {
            return ImportPaymentFromIO(paymentIOItem.PaymentIOs, actorCompanyId, type, fromSOP);
        }

        public ActionResult ImportPaymentFromIO(List<PaymentRowImportIODTO> paymentIODTOs, int actorCompanyId, TermGroup_IOType type, bool fromSOP)
        {
            #region Prereq

            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;
            List<Currency> currencies;
            List<PaymentMethod> paymentMethods;
            List<VoucherSeries> currentVoucherSeries;
            List<VoucherSeriesType> currentVoucherSeriesTypes;
            List<Supplier> suppliers = null;
            int baseCurrencyId = 0;

            using (var entities = new CompEntities())
            {
                currencies = CountryCurrencyManager.GetCurrencies(entities, actorCompanyId);
                paymentMethods = PaymentManager.GetPaymentMethods(entities, actorCompanyId);
                currentVoucherSeries = VoucherManager.GetVoucherSeries(entities, actorCompanyId, true);
                currentVoucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(entities, actorCompanyId, false);
                baseCurrencyId = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId) != null ? CountryCurrencyManager.GetCompanyBaseCurrency(actorCompanyId).CurrencyId : (int)TermGroup_Currency.SEK;
            }

            #endregion

            #region Add currencies if needed

            if (type != TermGroup_IOType.WebAPI)
            {
                using (var entities = new CompEntities())
                {
                    var syscurrencies = CountryCurrencyManager.GetSysCurrencies();
                    var currencyCodes = paymentIODTOs.Select(p => p.CurrencyCode).Distinct().ToList();

                    foreach (string currencyCode in currencyCodes)
                    {
                        if (string.IsNullOrEmpty(currencyCode))
                            continue;

                        SysCurrency sysCurrency = syscurrencies.FirstOrDefault(c => c.Code != null && c.Code.ToLower() == currencyCode.ToLower());
                        if (sysCurrency != null)
                        {
                            Currency currency = new Currency();
                            currency.ActorCompanyId = actorCompanyId;
                            currency.Code = sysCurrency.Code;
                            currency.Name = sysCurrency.Name;
                            currency.SysCurrencyId = sysCurrency.SysCurrencyId;

                            CountryCurrencyManager.AddCurrency(entities, currency, DateTime.Now.Date, actorCompanyId, null, null);
                        }
                    }

                    #region Add PaymentMethods if none exist

                    if (fromSOP && !paymentMethods.IsNullOrEmpty())
                    {
                        CreatePaymentMethodsSOP(entities, "", actorCompanyId);
                        paymentMethods = PaymentManager.GetPaymentMethods(entities, actorCompanyId);
                    }

                    #endregion
                }
            }
            #endregion


            using (var entities = new CompEntities())
            {

                foreach (var paymentGroup in paymentIODTOs.GroupBy(x => new { x.InvoiceNr, x.InvoiceSeqNr, x.PayDate, x.Type, x.SupplierNr }))
                {
                    try
                    {
                        #region Prereq

                        var dtos = new List<PaymentRowSaveDTO>();

                        List<Invoice> invoices = null;
                        Invoice invoice = null;

                        #endregion

                        #region Find Invoice
                        decimal? paymentAmount = paymentGroup.Count() == 1 ? paymentGroup.First().Amount : (decimal?)null;
                        decimal? paymentAmountCurrency = paymentGroup.Count() == 1 ? paymentGroup.First().AmountCurrency : (decimal?)null;

                        if (paymentGroup.Key.Type == (int)SoeOriginType.CustomerPayment)
                        {
                            //Check if invoice exist                    
                            invoices = InvoiceManager.GetInvoicesSearchInvoiceNr(entities, actorCompanyId, paymentGroup.Key.InvoiceNr, 3, SoeOriginType.CustomerInvoice);

                            if (invoices.Count == 0)
                            {
                                invoices = InvoiceManager.GetCustomerInvoiceByExternalId(entities, actorCompanyId, paymentGroup.Key.InvoiceNr, SoeOriginType.CustomerInvoice);
                            }

                            //Since there can be multiple invoices with same invoiceNr (debit/credit) we need an extra check.
                            if (invoices.Count > 1)
                            {
                                foreach (var inv in invoices)
                                {
                                    if (invoice != null)
                                        continue;

                                    DateTime firstValidDate = ((DateTime)inv.DueDate).AddDays(-30);
                                    DateTime lastValidDate = ((DateTime)inv.DueDate).AddDays(365);

                                    if (paymentAmount.HasValue && paymentAmountCurrency.HasValue)
                                    {
                                        if (inv.TotalAmount == paymentAmount.Value || (inv.TotalAmountCurrency == paymentAmountCurrency.Value && paymentAmountCurrency.Value != 0))
                                        {
                                            invoice = inv;
                                            continue; //If invoice amount is correct we assume this is the right one.
                                        }
                                    }
                                    if (firstValidDate > paymentGroup.Key.PayDate || paymentGroup.Key.PayDate > lastValidDate)
                                        continue;

                                    invoice = inv;
                                }
                            }
                            else if (invoices.Count == 1)
                            {
                                invoice = invoices.FirstOrDefault();
                            }

                            if (!invoices.Any() && paymentGroup.Key.InvoiceSeqNr.HasValue && invoice == null)
                            {
                                invoice = InvoiceManager.GetInvoiceBySeqNr(entities, actorCompanyId, (int)paymentGroup.Key.InvoiceSeqNr, SoeOriginType.CustomerInvoice);
                                if (invoice == null)
                                {
                                    int.TryParse(paymentGroup.Key.InvoiceNr, out int seqNr);
                                    if (seqNr != 0)
                                        invoice = InvoiceManager.GetInvoiceBySeqNr(entities, actorCompanyId, seqNr, SoeOriginType.CustomerInvoice);
                                }

                                if (invoice == null)
                                    continue;
                            }

                            if (!invoices.Any() && invoice == null)
                                continue;

                            if (invoices.Any() && invoice == null)
                                invoice = invoices.FirstOrDefault();

                        }
                        else if (paymentGroup.Key.Type == (int)SoeOriginType.SupplierPayment)
                        {
                            invoice = InvoiceManager.GetInvoiceBySeqNr(entities, actorCompanyId, (int)paymentGroup.Key.InvoiceSeqNr, SoeOriginType.SupplierInvoice);

                            //Since there can be multiple invoices with same invoiceNr (debit/credit) we need an extra check.
                            bool inValidDateInterval = true;
                            if (invoice != null)
                            {
                                if (invoice.DueDate.HasValue)
                                {
                                    DateTime firstValidDate = ((DateTime)invoice.DueDate).AddDays(-30);
                                    DateTime lastValidDate = ((DateTime)invoice.DueDate).AddDays(365);

                                    if (firstValidDate > paymentGroup.Key.PayDate || paymentGroup.Key.PayDate > lastValidDate)
                                        inValidDateInterval = false;

                                    if (!inValidDateInterval && invoice.TotalAmount == paymentAmount.GetValueOrDefault())
                                        inValidDateInterval = true; //If invoice amount is correct we assume this is the right one anyway.
                                }

                                if (invoice.TotalAmount != paymentAmount.GetValueOrDefault())
                                    inValidDateInterval = false;
                            }

                            if (!inValidDateInterval)
                            {
                                invoice = null;
                                invoices = InvoiceManager.GetInvoicesBySeqNr(entities, actorCompanyId, (int)paymentGroup.Key.InvoiceSeqNr, SoeOriginType.SupplierInvoice);

                                if (invoices.Any())
                                {
                                    foreach (var inv in invoices)
                                    {
                                        if (invoice != null)
                                            continue;

                                        DateTime firstValidDate = ((DateTime)inv.DueDate).AddDays(-30);
                                        DateTime lastValidDate = ((DateTime)inv.DueDate).AddDays(365);

                                        if (paymentAmount.HasValue && paymentAmountCurrency.HasValue)
                                        {
                                            if (inv.TotalAmount == paymentAmount.Value || (inv.TotalAmountCurrency == paymentAmountCurrency.Value && paymentAmountCurrency.Value != 0))
                                            {
                                                invoice = inv;
                                                continue; //If invoice amount is correct we asume this i the right one.
                                            }
                                        }
                                        if (firstValidDate > paymentGroup.Key.PayDate || paymentGroup.Key.PayDate > lastValidDate)
                                            continue;

                                        invoice = inv;
                                    }
                                }

                                if (invoice == null && invoices.Count == 1)
                                    invoice = invoices.FirstOrDefault();
                            }

                            if (invoice == null)
                            {
                                if (suppliers == null)
                                {
                                    suppliers = SupplierManager.GetSuppliersByCompany(entities, actorCompanyId, true);
                                }

                                Supplier supplier = suppliers.FirstOrDefault(c => c.SupplierNr.ToLower() == paymentGroup.Key.SupplierNr.ToLower());
                                if (supplier != null)
                                {
                                    int? supplierInvoiceId = SupplierInvoiceManager.GetSupplierInvoiceIdByNr(entities, paymentGroup.Key.InvoiceNr, supplier.ActorSupplierId, actorCompanyId);
                                    if (!supplierInvoiceId.HasValue && invoice == null)
                                        continue;

                                    if (supplierInvoiceId.HasValue)
                                        invoice = supplierInvoiceId.HasValue ? SupplierInvoiceManager.GetSupplierInvoice((int)supplierInvoiceId, false, false, false, false, false, false, false, false) : null;
                                }
                                else
                                {
                                    continue;
                                }
                            }
                        }
                        else
                        {
                            throw new Exception($"Unknown paymenttype {paymentGroup.Key.Type}");
                        }

                        if (invoice == null)
                            continue;

                        #endregion

                        #region Previous payments

                        decimal totalPaidAmountOnInvoice = 0;
                        decimal previousPaymentAmount = 0;
                        decimal restAmount = invoice.TotalAmount - invoice.PaidAmount;

                        List<PaymentRow> rows = PaymentManager.GetPaymentRowsByInvoice(entities, invoice.InvoiceId);

                        if (rows.Any())
                            totalPaidAmountOnInvoice = previousPaymentAmount = rows.Sum(r => r.Amount);

                        #endregion

                        var accountYearId = AccountManager.GetAccountYearId(entities, paymentGroup.Key.PayDate, actorCompanyId);

                        foreach (var payment in paymentGroup)
                        {
                            int? voucherHeadId = null;
                            int? voucherSeriesId = null;
                            int? voucherSeriesTypeId = null;
                            bool exist = false;

                            #region Check if payment exist

                            foreach (var row in rows)
                            {
                                if (payment.PayDate == row.PayDate && payment.Amount == row.Amount && restAmount == 0)
                                    exist = true;
                            }

                            if (exist && (string.IsNullOrEmpty(payment.VoucherNr) || payment.VoucherNr == "0"))
                            {
                                result.InfoMessage = "Payment already exists";
                                continue;
                            }

                            #endregion

                            #region Voucher

                            if (accountYearId > 0 && currentVoucherSeries.Any() && !string.IsNullOrEmpty(payment.VoucherSeriesNr) && !string.IsNullOrEmpty(payment.VoucherNr) && int.TryParse(payment.VoucherSeriesNr, out int voucherSeriesTypeNr) && voucherSeriesTypeNr != 0)
                            {
                                var voucherSerieType = currentVoucherSeriesTypes.FirstOrDefault(v => v.VoucherSeriesTypeNr == voucherSeriesTypeNr);
                                if (voucherSerieType != null)
                                {
                                    voucherSeriesTypeId = voucherSerieType.VoucherSeriesTypeId;
                                    var voucherSeries = VoucherManager.GetVoucherSerieByYear(entities, accountYearId, voucherSerieType.VoucherSeriesTypeId);
                                    if (voucherSeries != null)
                                        voucherSeriesId = voucherSeries.VoucherSeriesId;

                                    if (voucherSeriesId.HasValue && voucherSeriesId != 0 && int.TryParse(payment.VoucherNr, out int voucherNr) && voucherNr != 0)
                                    {
                                        VoucherHead voucherHead = VoucherManager.GetVoucherHeadByNr(entities, voucherNr, (int)voucherSeriesId, actorCompanyId, false, false, false, false);
                                        if (voucherHead != null)
                                            voucherHeadId = voucherHead.VoucherHeadId;
                                    }
                                }
                            }

                            if (!voucherSeriesId.HasValue)
                            {
                                var voucherSeriesType = paymentGroup.Key.Type == (int)SoeOriginType.SupplierPayment ? CompanySettingType.SupplierPaymentVoucherSeriesType : CompanySettingType.CustomerPaymentVoucherSeriesType;
                                voucherSeriesTypeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)voucherSeriesType, 0, actorCompanyId, 0);

                                VoucherSeries voucherSeries = null;
                                if (voucherSeriesTypeId.HasValue && voucherSeriesTypeId != null)
                                    voucherSeries = VoucherManager.GetVoucherSerieByYear(entities, accountYearId, (int)voucherSeriesTypeId);

                                if (voucherSeries != null)
                                    voucherSeriesId = voucherSeries.VoucherSeriesId;

                                if (voucherSeriesId.HasValue && voucherSeriesId != 0 && (!voucherHeadId.HasValue || voucherHeadId == 0))
                                {
                                    int.TryParse(payment.VoucherNr, out int voucherNr);
                                    if (voucherNr != 0)
                                    {
                                        var voucherHead = VoucherManager.GetVoucherHeadByNr(entities, voucherNr, (int)voucherSeriesId, actorCompanyId, false, false, false, false);
                                        if (voucherHead != null)
                                            voucherHeadId = voucherHead.VoucherHeadId;
                                    }
                                }
                            }

                            #endregion

                            #region Check if payment exist again

                            if (exist && voucherHeadId != null)
                            {
                                bool existAfterCheck2 = false;

                                foreach (var row in rows)
                                {
                                    if (payment.PayDate == row.PayDate && payment.Amount == row.Amount && row.VoucherHeadId == voucherHeadId && restAmount == 0)
                                        existAfterCheck2 = true;
                                }

                                if (existAfterCheck2)
                                    continue;
                            }
                            else if (exist && voucherHeadId == null)
                                continue;

                            #endregion

                            var dto = new PaymentRowSaveDTO();
                            dtos.Add(dto);

                            #region Currency

                            if (currencies.Any(c => !string.IsNullOrEmpty(c.Code) && c.Code.ToLower() == payment.CurrencyCode.ToLower()))
                                dto.CurrencyId = currencies.First(c => c.Code.ToLower() == payment.CurrencyCode.ToLower()).SysCurrencyId;
                            else
                                dto.CurrencyId = baseCurrencyId;

                            #endregion

                            #region PaymentMethod
                            if (!string.IsNullOrEmpty(payment.PaymentMethodCode))
                            {
                                var paymentMethod = paymentMethods.FirstOrDefault(p => p.Name == payment.PaymentMethodCode && p.PaymentType == payment.Type);
                                if (paymentMethod != null)
                                {
                                    if (paymentMethod.PaymentType != payment.Type)
                                    {
                                        throw new Exception($"Paymentmetod.PaymentType <> Payment.Type missmatch {paymentMethod.PaymentType} - {payment.Type}");
                                    }
                                    dto.PaymentMethodId = paymentMethod.PaymentMethodId;
                                }
                                else
                                {
                                    if (payment.Type == (int)SoeOriginType.CustomerPayment)
                                        dto.PaymentMethodId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerPaymentDefaultPaymentMethod, 0, actorCompanyId, 0);
                                    else if (payment.Type == (int)SoeOriginType.SupplierPayment)
                                        dto.PaymentMethodId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.SupplierPaymentDefaultPaymentMethod, 0, actorCompanyId, 0);
                                }

                                if (dto.PaymentMethodId == 0)
                                {
                                    if (payment.Type == (int)SoeOriginType.SupplierPayment && paymentMethods.Any(p => p.PaymentType == (int)SoeOriginType.SupplierPayment))
                                        dto.PaymentMethodId = paymentMethods.FirstOrDefault(p => p.PaymentType == (int)SoeOriginType.SupplierPayment).PaymentMethodId;

                                    if (payment.Type == (int)SoeOriginType.CustomerPayment && paymentMethods.Any(p => p.PaymentType == (int)SoeOriginType.CustomerPayment))
                                        dto.PaymentMethodId = paymentMethods.FirstOrDefault(p => p.PaymentType == (int)SoeOriginType.CustomerPayment).PaymentMethodId;

                                    if (dto.PaymentMethodId == 0)
                                        dto.PaymentMethodId = paymentMethods.FirstOrDefault().PaymentMethodId;

                                    if (dto.PaymentMethodId == 0)
                                        continue;
                                }
                            }
                            #endregion

                            #region PaymentType

                            if (payment.SysPaymentTypeId != -1)
                            {
                                dto.SysPaymentTypeId = payment.SysPaymentTypeId;
                            }
                            else
                            {
                                PaymentMethod method = paymentMethods.FirstOrDefault(p => p.PaymentMethodId == dto.PaymentMethodId);
                                if (method != null && method.SysPaymentTypeId.HasValue)
                                    dto.SysPaymentTypeId = (int)method.SysPaymentTypeId;
                            }


                            #endregion

                            #region create saveDTO

                            dto.AccountYearId = accountYearId;
                            dto.InvoiceId = invoice.InvoiceId;
                            dto.SeqNr = payment.SeqNr;
                            dto.InvoiceType = (SoeInvoiceType)invoice.Type;
                            dto.InvoiceDate = invoice.InvoiceDate;
                            dto.Amount = payment.Amount;
                            dto.TotalAmount = payment.Amount;
                            dto.AmountCurrency = payment.AmountCurrency != 0 ? payment.AmountCurrency : payment.Amount;
                            dto.TotalAmountCurrency = payment.AmountCurrency != 0 ? payment.AmountCurrency : payment.Amount;
                            dto.PaidAmount = payment.Amount;
                            dto.PaidAmountCurrency = payment.Amount;
                            dto.PaymentNr = payment.PaymentNr;
                            dto.FullyPayed = payment.FullyPaid;
                            dto.OriginType = (SoeOriginType)payment.Type;
                            dto.OriginStatus = SoeOriginStatus.Payment;
                            dto.CurrencyDate = payment.CurrencyDate.Year < 1900 ? payment.PayDate : payment.CurrencyDate;
                            dto.CurrencyRate = payment.CurrencyRate > 1 ? payment.CurrencyRate : 1;
                            dto.PaymentDate = payment.PayDate;
                            dto.VoucherDate = payment.VoucherDate;
                            dto.OriginStatus = SoeOriginStatus.Payment;
                            dto.PaymentStatus = SoePaymentStatus.ManualPayment;
                            dto.VoucherHeadId = voucherHeadId;

                            totalPaidAmountOnInvoice += payment.Amount;

                            if (payment.ChangeFullyPaid && invoice.IsDebit)
                            {
                                if (invoice.TotalAmount - 1 <= totalPaidAmountOnInvoice)
                                    dto.FullyPayed = true;
                                else
                                    dto.FullyPayed = false;
                            }

                            if (payment.ChangeFullyPaid && !invoice.IsDebit)
                            {
                                if (totalPaidAmountOnInvoice <= invoice.TotalAmount + 1)
                                    dto.FullyPayed = true;
                                else
                                    dto.FullyPayed = false;
                            }

                            if (payment.Status == 6)
                            {
                                if (payment.Type == (int)SoeOriginType.SupplierPayment)
                                    dto.PaymentStatus = SoePaymentStatus.Pending;
                                else if (payment.Type == (int)SoeOriginType.CustomerPayment)
                                    dto.PaymentStatus = SoePaymentStatus.ManualPayment;
                            }
                            else if (dto.VoucherHeadId.HasValue && dto.VoucherHeadId != 0)
                                dto.PaymentStatus = SoePaymentStatus.Checked;

                            if (voucherSeriesId.HasValue && voucherSeriesId != 0 && voucherSeriesTypeId != 0)
                            {
                                dto.VoucherSeriesId = (int)voucherSeriesId;
                                dto.VoucherSeriesTypeId = (int)voucherSeriesTypeId;
                            }
                            else
                                continue;

                            //Credit invoices
                            if (payment.ChangeFullyPaid && invoice.TotalAmount < 0)
                            {
                                if (invoice.TotalAmount + 1 >= payment.Amount + previousPaymentAmount)
                                    dto.FullyPayed = true;
                                else
                                    dto.FullyPayed = false;
                            }

                            //Set old payments to payed
                            if (payment.PayDate < DateTime.Now.AddYears(-3))
                            {
                                dto.Amount = invoice.TotalAmount;
                                dto.TotalAmount = invoice.TotalAmount;
                                dto.AmountCurrency = invoice.TotalAmount;
                                dto.TotalAmountCurrency = invoice.TotalAmountCurrency;
                                dto.PaidAmount = invoice.TotalAmount;
                                dto.PaidAmountCurrency = invoice.TotalAmountCurrency;
                                dto.FullyPayed = payment.ChangeFullyPaid || payment.FullyPaid;
                                dto.PaymentStatus = SoePaymentStatus.Checked;
                            }

                            // Fix for currency
                            if (type == TermGroup_IOType.XEConnect && dto.CurrencyId > 0 && dto.CurrencyId != baseCurrencyId && (payment.CurrencyRate == 0 || payment.CurrencyRate == 1))
                            {
                                var transactionCurrency = currencies.FirstOrDefault(c => c.CurrencyId == dto.CurrencyId);
                                var calculatedCurrencyRate = payment.AmountCurrency / payment.Amount;
                                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                                var existingCurrencyRate = CountryCurrencyManager.GetCurrencyRateFromCurrencyId(entitiesReadOnly, dto.CurrencyId, actorCompanyId, payment.CurrencyDate.Date);

                                if (existingCurrencyRate == 1 || existingCurrencyRate != calculatedCurrencyRate)
                                {
                                    dto.CurrencyRate = calculatedCurrencyRate;
                                    CountryCurrencyManager.CreateCurrencyRate(entities, transactionCurrency, dto.CurrencyDate.Date, (1 / calculatedCurrencyRate), calculatedCurrencyRate, TermGroup_CurrencySource.Manually, actorCompanyId);
                                }
                            }
                        }
                        #endregion

                        #region Save

                        if (dtos.Any())
                        {

                            using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                            {
                                ActionResult saveResult = PaymentManager.SavePaymentRow(entities, transaction, dtos, actorCompanyId, type == TermGroup_IOType.WebAPI, false, adjustInvoiceAmounts: true, autoAddVoucher: type == TermGroup_IOType.WebAPI);

                                if (saveResult.Success)
                                {
                                    transaction.Complete();
                                    result.Success = true;
                                    nbrOfSaved++;
                                }
                                else
                                    return saveResult;
                            }
                        }
                        #endregion

                    }
                    catch (Exception ex)
                    {
                        result.Success = false;
                        result.ErrorMessage = ex.Message;
                        LogError(result.ErrorMessage);
                    }
                }
            }


            if (nbrOfSaved == 0)
            {
                result.Success = false;
                result.ErrorMessage = GetText(7598, "Hittade inga betalningar att importera");
            }
            result.IntegerValue = nbrOfSaved;

            return result;
        }

        public List<PaymentRowImportIODTO> GetPaymentRowImportIODTOs(int actorCompanyId, SoeOriginType originType, PaymentSearchIODTO searchDTO)
        {
            List<PaymentRowImportIODTO> paymentRowImportIODTOs = new List<PaymentRowImportIODTO>();
            var paymentMethods = PaymentManager.GetPaymentMethods(actorCompanyId);

            #region Accounts

            List<Account> accounts = null;
            List<AccountDim> accountDims = null;

            int accountDimId2 = 0;
            int accountDimId3 = 0;
            int accountDimId4 = 0;
            int accountDimId5 = 0;
            int accountDimId6 = 0;

            if (searchDTO.IncludeAccountInformation)
            {
                accounts = AccountManager.GetAccounts(actorCompanyId);
                accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId, onlyInternal: true);
                int accountDimNr = 2;
                foreach (var dimId in accountDims.OrderBy(d => d.AccountDimNr).Select(s => s.AccountDimId))
                {
                    if (accountDimNr == 2)
                        accountDimId2 = dimId;

                    if (accountDimNr == 3)
                        accountDimId3 = dimId;

                    if (accountDimNr == 4)
                        accountDimId4 = dimId;

                    if (accountDimNr == 5)
                        accountDimId5 = dimId;

                    if (accountDimNr == 6)
                        accountDimId6 = dimId;

                    accountDimNr++;
                }
            }
            #endregion
            /*
            if (invoiceId.GetValueOrDefault() == 0)
            {
                /*
                if (!string.IsNullOrEmpty(externalId))
                {
                    invoiceId = GetCustomerInvoiceIdsFromExternalId(actorCompanyId, originType, externalId).FirstOrDefault();
                }

                if (!invoiceId.HasValue && !string.IsNullOrEmpty(invoiceNr))
                {
                    invoiceId = InvoiceManager.GetInvoiceId(invoiceNr, actorCompanyId, originType);
                }

            }
                */
            var paymentRows = PaymentManager.GetPaymentRows(originType, actorCompanyId, new PaymentSearchDTO
            {
                InvoiceId = searchDTO.InvoiceId,
                PayDateFrom = searchDTO.PayDateFrom,
                PayDateTo = searchDTO.PayDateTo,
                CreatedFrom = searchDTO.CreatedFrom,
                CreatedTo = searchDTO.CreatedTo
            });

            foreach (var row in paymentRows)
            {
                if (row.InvoiceId == 0)
                    continue;

                var ioDTO = new PaymentRowImportIODTO
                {
                    InvoiceNr = row.InvoiceNr,
                    InvoiceSeqNr = row.InvoiceSeqNr,
                    FullyPaid = row.FullyPayed,
                    CurrencyDate = row.CurrencyDate,
                    CurrencyRate = row.CurrencyRate,
                    PayDate = row.PayDate,
                    PaymentNr = row.PaymentNr,
                    SeqNr = row.SeqNr,
                    Type = row.SysPaymentTypeId,
                    SysPaymentTypeId = row.SysPaymentTypeId,
                    Amount = row.Amount,
                    AmountCurrency = row.AmountCurrency,
                    Comment = string.Empty,
                    PaymentMethodCode = paymentMethods.FirstOrDefault(m => m.PaymentMethodId == row.PaymentMethodId)?.Name
                };

                #region Accounting

                if (searchDTO.IncludeAccountInformation)
                {

                    var accountRows = PaymentManager.GetPaymentAccountRows(row.PaymentRowId);

                    if (!accountRows.IsNullOrEmpty())
                    {
                        foreach (var accounting in accountRows)
                        {
                            ioDTO.AccountNr = accounting.AccountId != 0 ? (accounts.FirstOrDefault(a => a.AccountId == accounting.AccountId)?.AccountNr ?? string.Empty) : string.Empty;

                            if (accounting.AccountInternal != null)
                            {
                                foreach (var internalAccouting in accounting.AccountInternal)
                                {
                                    if (accounts.Any(a => a.AccountId == internalAccouting.AccountId && a.AccountDimId == accountDimId2))
                                        ioDTO.AccountDim2Nr = accounts.FirstOrDefault(a => a.AccountId == internalAccouting.AccountId)?.AccountNr;
                                    if (accounts.Any(a => a.AccountId == internalAccouting.AccountId && a.AccountDimId == accountDimId3))
                                        ioDTO.AccountDim3Nr = accounts.FirstOrDefault(a => a.AccountId == internalAccouting.AccountId)?.AccountNr;
                                    if (accounts.Any(a => a.AccountId == internalAccouting.AccountId && a.AccountDimId == accountDimId4))
                                        ioDTO.AccountDim4Nr = accounts.FirstOrDefault(a => a.AccountId == internalAccouting.AccountId)?.AccountNr;
                                    if (accounts.Any(a => a.AccountId == internalAccouting.AccountId && a.AccountDimId == accountDimId5))
                                        ioDTO.AccountDim5Nr = accounts.FirstOrDefault(a => a.AccountId == internalAccouting.AccountId)?.AccountNr;
                                    if (accounts.Any(a => a.AccountId == internalAccouting.AccountId && a.AccountDimId == accountDimId6))
                                        ioDTO.AccountDim6Nr = accounts.FirstOrDefault(a => a.AccountId == internalAccouting.AccountId)?.AccountNr;
                                }
                            }
                        }
                    }
                }
                #endregion

                paymentRowImportIODTOs.Add(ioDTO);

            }

            return paymentRowImportIODTOs;
        }

        #endregion

        #region PaymentImportIO

        public List<PaymentImportIODTO> GetImportedIOInvoices(int actorCompanyId, int batchNr, ImportPaymentType importType, bool includeDueDate)
        {
            using (CompEntities entities = new CompEntities())
            {
                var paymentmentIOs = (from e in entities.PaymentImportIO
                                      where e.ActorCompanyId == actorCompanyId &&
                                            e.State != (int)ImportPaymentIOState.Deleted &&
                                            e.BatchNr == batchNr && e.ImportType == (int)importType
                                      select new PaymentImportIODTO
                                      {
                                          PaymentImportIOId = e.PaymentImportIOId,
                                          ActorCompanyId = e.ActorCompanyId,
                                          BatchNr = e.BatchNr,
                                          Type = (TermGroup_BillingType)e.Type,
                                          CustomerId = e.CustomerId,
                                          Customer = e.Customer,
                                          InvoiceId = e.InvoiceId,
                                          InvoiceNr = e.InvoiceNr,
                                          InvoiceSeqnr = e.InvoiceSeqnr,
                                          InvoiceAmount = e.ImportType == (int)ImportPaymentType.SupplierPayment && e.Type == (int)TermGroup_BillingType.Credit && e.RestAmount != 0 ? e.RestAmount + e.PaidAmount : e.InvoiceAmount,
                                          RestAmount = e.RestAmount,
                                          PaidAmount = e.PaidAmount,
                                          PaidAmountCurrency = e.PaidAmountCurrency,
                                          Currency = e.Currency,
                                          InvoiceDate = e.InvoiceDate,
                                          PaidDate = e.PaidDate,
                                          MatchCodeId = e.MatchCodeId,
                                          Status = (ImportPaymentIOStatus)e.Status,
                                          State = (ImportPaymentIOState)e.State,
                                          ImportType = (ImportPaymentType)e.ImportType,
                                          PaymentRowId = e.PaymentRowId,
                                          PaymentRowSeqNr = e.PaymentRow != null ? e.PaymentRow.SeqNr : (int?)null,
                                          OCR = e.OCR,
                                          Comment = e.Comment,
                                      }).ToList();

                if (includeDueDate)
                {
                    var invoiceIds = paymentmentIOs.Where(p => p.InvoiceId.HasValue).Select(i => i.InvoiceId ?? 0).Distinct().ToList();
                    if (invoiceIds.Any())
                    {
                        Dictionary<int, DateTime?> dueDates = (from i in entities.Invoice
                                                               where invoiceIds.Contains(i.InvoiceId) &&
                                                                     i.Origin.ActorCompanyId == actorCompanyId &&
                                                                     i.DueDate.HasValue
                                                               select new { i.InvoiceId, i.DueDate }
                                     )
                                    .AsEnumerable()
                                    .ToDictionary(kvp => kvp.InvoiceId, kvp => kvp.DueDate);
                        if (dueDates.Any())
                        {
                            paymentmentIOs.Where(p => invoiceIds.Contains(p.InvoiceId ?? 0)).ToList().ForEach(x =>
                            {
                                if (dueDates.TryGetValue(x.InvoiceId.GetValueOrDefault(), out DateTime? dueDate))
                                    x.DueDate = dueDate;
                            }
                            );
                        }
                    }
                }
                return paymentmentIOs;
            }
        }

        public ActionResult DeleteImportedIOInvoices(int actorCompanyId, int batchNr, ImportPaymentType importType)
        {
            using (CompEntities entities = new CompEntities())
            {
                var paymentIOs = (from e in entities.PaymentImportIO
                                  where e.ActorCompanyId == actorCompanyId &&
                                        e.BatchNr == batchNr && e.ImportType == (int)importType
                                  select e);

                foreach (var paymentIO in paymentIOs)
                {
                    paymentIO.Status = (int)ImportPaymentIOStatus.Deleted;
                    paymentIO.State = (int)ImportPaymentIOState.Closed;

                    SetModifiedProperties(paymentIO);
                }

                return SaveChanges(entities);
            }
        }

        public ActionResult DeletePaymentImportRow(int actorCompanyId, int paymentImportIOId)
        {
            using (CompEntities entities = new CompEntities())
            {
                var paymentIOs = (from e in entities.PaymentImportIO
                                  where e.ActorCompanyId == actorCompanyId &&
                                        e.PaymentImportIOId == paymentImportIOId
                                  select e);

                foreach (var paymentIO in paymentIOs)
                {
                    if (paymentIO.PaidAmount != 0 || paymentIO.Status != (int)ImportPaymentIOStatus.Unknown)
                    {
                        return new ActionResult(GetText(7741, "Betalningsraden går inte att ta bort på grund av felaktig status"));
                    }
                    paymentIO.Status = (int)ImportPaymentIOStatus.Deleted;
                    paymentIO.State = (int)ImportPaymentIOState.Deleted;

                    SetModifiedProperties(paymentIO);
                }

                return SaveChanges(entities);
            }
        }

        #endregion

        #region Pricelists

        public List<PriceListTypeIODTO> GetPriceLists(int actorCompanyId, bool onlyStandard)
        {
            var priceLists = new List<PriceListType>();

            if (onlyStandard)
            {
                var standadardPriceList = ProductPricelistManager.GetStandardPriceListType(actorCompanyId);
                if (standadardPriceList != null)
                {
                    priceLists.Add(standadardPriceList);
                }
            }
            else
            {
                priceLists = ProductPricelistManager.GetPriceListTypes(actorCompanyId).ToList();
            }
                
            return priceLists.Select(p => new PriceListTypeIODTO
            {
                Currency = CountryCurrencyManager.GetCurrencyCode(p.Currency.SysCurrencyId),
                Name = p.Name,
                PriceListTypeId = p.PriceListTypeId,
                InclusiveVat = p.InclusiveVat,
                DiscountPercent = p.DiscountPercent,
                Description = p.Description ?? ""
            }).ToList();
        }

        #endregion

        #region ProductIO

        public List<ProductStockBalanceIODTO> GetProductStockbalance(List<int> productIds, string stockCode, int actorCompanyId)
        {
            var result = new List<ProductStockBalanceIODTO>();
            if (productIds == null)
            {
                return result;
            }

            using (CompEntities entities = new CompEntities())
            {
                int? stockId = string.IsNullOrEmpty(stockCode) ? (int?)null : StockManager.GetStockByCode(entities, actorCompanyId, stockCode)?.StockId;

                foreach (var productId in productIds)
                {
                    var stockProductList = StockManager.GetStockProductsFromInvoiceProduct(entities, productId, stockId, actorCompanyId);

                    foreach (var stockProduct in stockProductList.GroupBy(x => x.InvoiceProductId))
                    {
                        var productIO = new ProductStockBalanceIODTO
                        {
                            ProductId = productId,
                            StockBalance = new List<StockBalanceIODTO>()
                        };

                        foreach (var stock in stockProduct)
                        {
                            productIO.StockBalance.Add(
                                new StockBalanceIODTO
                                {
                                    StockId = stock.StockId,
                                    StockCode = stock?.Stock.Code,
                                    OrderQuantity = stock.OrderedQuantity,
                                    Quantity = stock.Quantity,
                                    ReservedQuantity = stock.ReservedQuantity
                                });
                        }

                        result.Add(productIO);
                    }
                }
            }

            return result;
        }

        public List<InvoiceProductPriceResultIODTO> GetProductPrice(int customerId, List<InvoiceProductPriceSearchIODTO> items, int actorCompanyId)
        {
            var result = new List<InvoiceProductPriceResultIODTO>();
            foreach (var item in items)
            {
                var priceResult = ProductManager.GetProductPrice(actorCompanyId, new ProductPriceRequestDTO { ProductId = item.ProductId, CustomerId = customerId, Quantity = item.Quantity }, null, true, true);
                result.Add(new InvoiceProductPriceResultIODTO
                {
                    ErrorMessage = priceResult.ErrorMessage,
                    Price = priceResult.SalesPrice,
                    Unit = priceResult.ProductUnit,
                    ProductId = item.ProductId,
                    InclusiveVat = priceResult.InclusiveVat,
                    DiscountPercent = priceResult.CustomerDiscountPercent.GetValueOrDefault() + priceResult.DiscountPercent.GetValueOrDefault(),
                    Quantity = item.Quantity,
                }
                );
            }

            return result;
        }

        public List<ProductUnitIODTO> GetProductUnits(int actorCompanyId)
        {
            return ProductManager.GetProductUnits(actorCompanyId).Select(x => new ProductUnitIODTO { Code = x.Code, Name = x.Name, ProductUnitId = x.ProductUnitId }).ToList();
        }

        public List<InvoiceProductSearchResultIODTO> SearchInvoiceProduct(int actorCompanyId, InvoiceProductSearchIODTO searchDTO, int maxNrRows)
        {
            if (maxNrRows > 5000)
            {
                maxNrRows = 5000;
            }

            var searchResult = ProductManager.SearchProducts(actorCompanyId, new InvoiceProductSearchDTO
            {
                Name = searchDTO.Name,
                Number = searchDTO.Number,
                EAN = searchDTO.EAN,
                ModifiedSince = searchDTO.ModifiedSince,
                External = searchDTO.External
            }, maxNrRows);

            var result = searchResult.Select(p => new InvoiceProductSearchResultIODTO
            {
                ProductId = searchDTO.External ? 0 : p.ProductIds.FirstOrDefault(),
                Name = p.Name,
                Number = p.Number,
            }).ToList();

            return result;
        }

        public List<InvoiceProductIODTO> GetInvoiceProductIODTOs(int actorCompanyId, InvoiceProductFilterIODTO filter)
        {
            var result = new List<InvoiceProductIODTO>();
            if (filter == null)
            {
                return result;
            }

            using (var entities = new CompEntities())
            {
                var products = ProductManager.SearchInvoiceProducts(entities, actorCompanyId,
                new InvoiceProductSearchDTO
                {
                    Number = filter.Number,
                    Name = filter.Name,
                    ModifiedSince = filter.ModifiedSince,
                    IncludeInactive = filter.IncludeInactive,
                    ProductGroupIds = filter.ProductGroupIds
                }, filter.PageNrOfRecords, filter.PageNumber);

                List<PriceList> pricesLists = null;
                if (filter.IncludePriceList)
                {
                    var productIds = products.Select(p => p.ProductId).ToList();
                    pricesLists = ProductPricelistManager.GetPriceListsForProducts(entities, productIds, actorCompanyId);
                }

                foreach (var product in products)
                {
                    var ioProduct = new InvoiceProductIODTO
                    {
                        ProductId = product.ProductId,
                        Number = product.ProductNr,
                        Name = product.ProductName,
                        Description = product.Description,
                        EAN = product.EAN,
                        Unit = product.ProductUnitCode,
                        State = product.State,
                        VatCodeNr = product.VatCodeNr,
                        VatType = product.VatType,
                        ProductGroupCode = product.ProductGroupCode,
                        DontUseDiscountPercent = product.DontUseDiscountPercent,
                        IsStockProduct = product.IsStockProduct,
                        External = product.External
                    };

                    if (filter.IncludePriceList)
                    {
                        ioProduct.PriceDTOs = pricesLists.Where(p => p.ProductId == product.ProductId).Select(priceItem => new InvoiceProductPriceIODTO
                        {
                            PriceListTypeId = priceItem.PriceListTypeId,
                            Price = priceItem.Price,
                            PriceListCode = priceItem.PriceListType.Name,
                            StartDate = priceItem.StartDate,
                            StopDate = priceItem.StopDate,
                            InclusiveVat = priceItem.PriceListType?.InclusiveVat ?? false,
                            Quantity = priceItem.Quantity
                        }).ToList();
                    }

                    result.Add(ioProduct);
                }
            }
            return result;
        }
        public List<InvoiceProductIODTO> GetInvoiceProductIODTOs(int actorCompanyId, string numberFrom, string numberTo, int? productGroupId, DateTime? modifiedSince, bool includeInactive, List<int> productIds = null)
        {
            var ioDTOs = new List<InvoiceProductIODTO>();

            IEnumerable<Product> products;
            var allProducts = (string.IsNullOrEmpty(numberFrom) && string.IsNullOrEmpty(numberTo)) || (productIds != null && productIds.Count > 0);
            if (!allProducts)
            {
                if (string.IsNullOrEmpty(numberFrom))
                    numberFrom = "-1";
                if (string.IsNullOrEmpty(numberTo))
                    numberTo = "999999999";
            }

            if (numberFrom == numberTo && !allProducts)
            {
                products = new List<Product>();
                var product = ProductManager.GetProduct(actorCompanyId, numberFrom);
                if (product != null)
                {
                    products = new List<Product> { product };
                }
            }
            else
            {
                products = ProductManager.GetProducts(actorCompanyId, modifiedSince, includeInactive);
            }

            var categoryRecords = products.Any() ? CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Product, SoeCategoryRecordEntity.Product, actorCompanyId) : null;

            foreach (var product in products)
            {
                if (!allProducts && (!StringUtility.IsInInterval(product.Number, numberFrom, numberTo)))
                    continue;

                if (productIds != null && productIds.Count > 0 && !productIds.Contains(product.ProductId))
                    continue;

                var categories = CategoryManager.GetCategories(categoryRecords, product.ProductId);
                CategoryComboDTO categoryComboDTO = categories.GetCategoryComboDTO();

                var ioDTO = new InvoiceProductIODTO
                {
                    ProductId = product.ProductId,
                    Number = product.Number,
                    Name = product.Name,
                    ProductGroupId = product.ProductGroupId,
                    CategoryIds = !categories.IsNullOrEmpty() ? categories.Select(c => c.CategoryId).ToList() : new List<int>(),
                    CategoryCode1 = !string.IsNullOrEmpty(categoryComboDTO.Category1Code) ? categoryComboDTO.Category1Code + " " + categoryComboDTO.Category1Name : string.Empty,
                    CategoryCode2 = !string.IsNullOrEmpty(categoryComboDTO.Category2Code) ? categoryComboDTO.Category2Code + " " + categoryComboDTO.Category2Name : string.Empty,
                    CategoryCode3 = !string.IsNullOrEmpty(categoryComboDTO.Category3Code) ? categoryComboDTO.Category3Code + " " + categoryComboDTO.Category3Name : string.Empty,
                    CategoryCode4 = !string.IsNullOrEmpty(categoryComboDTO.Category4Code) ? categoryComboDTO.Category4Code + " " + categoryComboDTO.Category4Name : string.Empty,
                    CategoryCode5 = !string.IsNullOrEmpty(categoryComboDTO.Category5Code) ? categoryComboDTO.Category5Code + " " + categoryComboDTO.Category5Name : string.Empty,
                    Description = product.Description,
                    PriceDTOs = new List<InvoiceProductPriceIODTO>(),
                    State = product.State,
                    Type = product.Type,
                };

                var invoiceProduct = product.State == (int)SoeEntityState.Active ? ProductManager.GetInvoiceProduct(product.ProductId, true, true, false, false, true, true) : null;

                if (invoiceProduct != null)
                {
                    ioDTO.EAN = invoiceProduct.EAN;
                    ioDTO.SalesPrice = invoiceProduct.SalesPrice;
                    ioDTO.PurchasePrice = invoiceProduct.PurchasePrice;
                    ioDTO.Unit = invoiceProduct.ProductUnit?.Code;
                    ioDTO.Weight = invoiceProduct.Weight ?? 0;
                    ioDTO.VatCodeNr = invoiceProduct.VatCode?.Code;
                    ioDTO.DontUseDiscountPercent = invoiceProduct.DontUseDiscountPercent.GetValueOrDefault();
                    ioDTO.VatType = invoiceProduct.VatType;
                    ioDTO.ProductGroupCode = invoiceProduct.ProductGroup?.Code;
                    ioDTO.MaterialCode = invoiceProduct.TimeCode?.Code;
                    ioDTO.IsStockProduct = invoiceProduct.IsStockProduct;
                    ioDTO.External = invoiceProduct.ExternalProductId.HasValue;

                    if (invoiceProduct.PriceList.Any())
                    {
                        foreach (var priceItem in invoiceProduct.PriceList)
                        {
                            if (!priceItem.PriceListTypeReference.IsLoaded)
                            {
                                priceItem.PriceListTypeReference.Load();
                            }

                            if ((priceItem.PriceListType != null) && (priceItem.PriceListType.State == (int)SoeEntityState.Active))
                            {
                                var priceItemIO = new InvoiceProductPriceIODTO
                                {
                                    PriceListTypeId = priceItem.PriceListTypeId,
                                    Price = priceItem.Price,
                                    PriceListCode = priceItem.PriceListType.Name,
                                    StartDate = priceItem.StartDate,
                                    StopDate = priceItem.StopDate,
                                    InclusiveVat = priceItem.PriceListType?.InclusiveVat ?? false
                                };

                                ioDTO.PriceDTOs.Add(priceItemIO);
                            }
                        }
                    }
                }

                ioDTOs.Add(ioDTO);
            }

            return ioDTOs;
        }

        public ActionResult ImportInvoiceProductIO(InvoiceProductIOItem invoiceProductIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromInvoiceProductIO(invoiceProductIOItem.invoiceProductIOs, actorCompanyId, false);
        }

        public List<AccountingSettingDTO> CreateAccountingSettingDTO(int actorCompanyId, int type, List<AccountDim> accountDims, string accountNr = "", string accountDim2Nr = "", string accountDim3Nr = "", string accountDim4Nr = "", string accountDim5Nr = "", string accountDim6Nr = "")
        {
            List<AccountingSettingDTO> list = new List<AccountingSettingDTO>();

            Account account = null;
            int accountDimCounter = 0;
            foreach (var dimDTO in accountDims.OrderBy(a => a.AccountDimNr).ToList())
            {
                accountDimCounter++;
                AccountingSettingDTO settingDTO = new AccountingSettingDTO();
                settingDTO.Type = type;

                #region Dim 1

                if (accountDimCounter == 1)
                {
                    account = AccountManager.GetAccountByNr(accountNr, dimDTO.AccountDimId, actorCompanyId);
                    if (type == 1 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account1Id = account.AccountId;
                        settingDTO.Account1Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 2 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account2Id = account.AccountId;
                        settingDTO.Account2Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 3 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account3Id = account.AccountId;
                        settingDTO.Account3Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 4 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account4Id = account.AccountId;
                        settingDTO.Account4Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 5 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account5Id = account.AccountId;
                        settingDTO.Account5Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 6 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = account.AccountId;
                        settingDTO.Account6Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 7 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account7Id = account.AccountId;
                        settingDTO.Account7Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 8 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account8Id = account.AccountId;
                        settingDTO.Account8Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 9 && account != null)
                    {

                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account9Id = account.AccountId;
                        settingDTO.Account9Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }

                    if (type == 10 && account != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account10Id = account.AccountId;
                        settingDTO.Account10Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                }

                #endregion

                #region Dim 2

                if (accountDimCounter == 2)
                {
                    Account accountDim2 = AccountManager.GetAccountByNr(accountDim2Nr, dimDTO.AccountDimId, actorCompanyId);
                    if (type == 1 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account1Id = accountDim2.AccountId;
                        settingDTO.Account1Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 2 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account2Id = accountDim2.AccountId;
                        settingDTO.Account2Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 3 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account3Id = accountDim2.AccountId;
                        settingDTO.Account3Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 4 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account4Id = accountDim2.AccountId;
                        settingDTO.Account4Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 5 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account5Id = accountDim2.AccountId;
                        settingDTO.Account5Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }

                    if (type == 6 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = accountDim2.AccountId;
                        settingDTO.Account6Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 7 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account7Id = accountDim2.AccountId;
                        settingDTO.Account7Name = accountDim2.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 8 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account8Id = accountDim2.AccountId;
                        settingDTO.Account8Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 9 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account9Id = accountDim2.AccountId;
                        settingDTO.Account9Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 10 && accountDim2 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account10Id = accountDim2.AccountId;
                        settingDTO.Account10Name = account.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                }

                #endregion

                #region Dim 3

                if (accountDimCounter == 3)
                {
                    Account accountDim3 = AccountManager.GetAccountByNr(accountDim3Nr, dimDTO.AccountDimId, actorCompanyId);
                    if (type == 1 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account1Id = accountDim3.AccountId;
                        settingDTO.Account1Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 2 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account2Id = accountDim3.AccountId;
                        settingDTO.Account2Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 3 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account3Id = accountDim3.AccountId;
                        settingDTO.Account3Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 4 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account4Id = accountDim3.AccountId;
                        settingDTO.Account4Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 5 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account5Id = accountDim3.AccountId;
                        settingDTO.Account5Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 6 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = accountDim3.AccountId;
                        settingDTO.Account6Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 7 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account7Id = accountDim3.AccountId;
                        settingDTO.Account7Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 8 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account8Id = accountDim3.AccountId;
                        settingDTO.Account8Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                    if (type == 9 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account9Id = accountDim3.AccountId;
                        settingDTO.Account9Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }

                    if (type == 10 && accountDim3 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account10Id = accountDim3.AccountId;
                        settingDTO.Account10Name = accountDim3.Name;
                        list.Add(settingDTO);
                        continue;
                    }
                }

                #endregion

                #region Dim 4

                if (accountDimCounter == 4)
                {
                    Account accountDim4 = AccountManager.GetAccountByNr(accountDim4Nr, dimDTO.AccountDimId, actorCompanyId);
                    if (accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account1Id = accountDim4.AccountId;
                        settingDTO.Account1Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 2 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account2Id = accountDim4.AccountId;
                        settingDTO.Account2Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 3 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account3Id = accountDim4.AccountId;
                        settingDTO.Account3Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 4 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account4Id = accountDim4.AccountId;
                        settingDTO.Account4Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 5 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account5Id = accountDim4.AccountId;
                        settingDTO.Account5Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 6 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = accountDim4.AccountId;
                        settingDTO.Account6Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 7 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account7Id = accountDim4.AccountId;
                        settingDTO.Account7Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 8 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account8Id = accountDim4.AccountId;
                        settingDTO.Account8Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 9 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account9Id = accountDim4.AccountId;
                        settingDTO.Account9Name = accountDim4.Name;
                        continue;
                    }
                    if (type == 10 && accountDim4 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account10Id = accountDim4.AccountId;
                        settingDTO.Account10Name = accountDim4.Name;
                        continue;
                    }
                }

                #endregion

                #region Dim 5

                if (accountDimCounter == 5)
                {
                    Account accountDim5 = AccountManager.GetAccountByNr(accountDim5Nr, dimDTO.AccountDimId, actorCompanyId);
                    if (type == 1 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account1Id = accountDim5.AccountId;
                        settingDTO.Account1Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 2 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account2Id = accountDim5.AccountId;
                        settingDTO.Account2Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 3 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account3Id = accountDim5.AccountId;
                        settingDTO.Account3Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 4 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account4Id = accountDim5.AccountId;
                        settingDTO.Account4Name = accountDim5.Name;
                        continue;
                    }

                    if (type == 5 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account5Id = accountDim5.AccountId;
                        settingDTO.Account5Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 6 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = accountDim5.AccountId;
                        settingDTO.Account6Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 7 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account7Id = accountDim5.AccountId;
                        settingDTO.Account7Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 8 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account8Id = accountDim5.AccountId;
                        settingDTO.Account8Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 9 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account9Id = accountDim5.AccountId;
                        settingDTO.Account9Name = accountDim5.Name;
                        continue;
                    }
                    if (type == 10 && accountDim5 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account10Id = accountDim5.AccountId;
                        settingDTO.Account10Name = accountDim5.Name;
                        settingDTO.Type = type;
                    }
                }

                #endregion

                if (type == 1 && accountDimCounter == 6)
                {
                    Account accountDim6 = AccountManager.GetAccountByNr(accountDim6Nr, dimDTO.AccountDimId, actorCompanyId);
                    if (accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = accountDim6.AccountId;
                        settingDTO.Account6Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 2 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account2Id = accountDim6.AccountId;
                        settingDTO.Account2Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 3 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account3Id = accountDim6.AccountId;
                        settingDTO.Account3Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 4 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account4Id = accountDim6.AccountId;
                        settingDTO.Account4Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 5 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account5Id = accountDim6.AccountId;
                        settingDTO.Account5Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 6 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account6Id = accountDim6.AccountId;
                        settingDTO.Account6Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 7 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account7Id = accountDim6.AccountId;
                        settingDTO.Account7Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 8 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account8Id = accountDim6.AccountId;
                        settingDTO.Account8Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 9 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account9Id = accountDim6.AccountId;
                        settingDTO.Account9Name = accountDim6.Name;
                        continue;
                    }
                    if (type == 10 && accountDim6 != null)
                    {
                        settingDTO.DimNr = dimDTO.AccountDimNr;
                        settingDTO.Account10Id = accountDim6.AccountId;
                        settingDTO.Account10Name = accountDim6.Name;
                        continue;
                    }
                }

                if (account == null)
                    continue;
            }

            return list;
        }

        public AccountingSettingsRowDTO CreateAccountingSettingRowDTO(InvoiceProduct product, ProductAccountType type, List<AccountDim> accountDims, string accountNr = "", string accountDim2Nr = "", string accountDim3Nr = "", string accountDim4Nr = "", string accountDim5Nr = "", string accountDim6Nr = "", bool allowEmptyStandard = false)
        {
            AccountingSettingsRowDTO result = new AccountingSettingsRowDTO()
            {
                Type = (int)type,
                Percent = 0
            };

            Account account = null;
            ProductAccountStd accStd = null;
            if (product != null)
                accStd = product.ProductAccountStd.FirstOrDefault(c => c.Type == (int)type);
            if (accStd?.AccountStd != null)
                account = AccountManager.GetAccount(base.ActorCompanyId, accStd.AccountStd.AccountId);

            AccountDim accountDimStd = accountDims.GetStandard();
            if (accountDimStd == null)
                return result;

            Account newAccount = AccountManager.GetAccountByNr(accountNr, accountDimStd.AccountDimId, base.ActorCompanyId);
            if (account == null && newAccount == null && !allowEmptyStandard)
                return null;

            if (newAccount != null)
            {
                result.AccountDim1Nr = Constants.ACCOUNTDIM_STANDARD;
                result.Account1Id = newAccount.AccountId;
                result.Account1Nr = newAccount.AccountNr;
                result.Account1Name = newAccount.Name;
            }

            else
            {
                if (account != null)
                {
                    result.AccountDim1Nr = Constants.ACCOUNTDIM_STANDARD;
                    result.Account1Id = account.AccountId;
                    result.Account1Nr = account.AccountNr;
                    result.Account1Name = account.Name;
                }
            }

            if (newAccount != null || allowEmptyStandard)
            {
                int accountDimCounter = 0;
                foreach (var dimDTO in accountDims.OrderBy(a => a.AccountDimNr).ToList())
                {
                    accountDimCounter++;
                    if (accountDimCounter == 1)
                    {
                        continue;
                    }
                    else if (accountDimCounter == 2 && !string.IsNullOrEmpty(accountDim2Nr))
                    {
                        account = AccountManager.GetAccountByNr(accountDim2Nr, dimDTO.AccountDimId, base.ActorCompanyId, true, true, true);
                        if (account != null)
                        {
                            result.AccountDim2Nr = account.AccountDim.AccountDimNr;
                            result.Account2Id = account.AccountId;
                            result.Account2Nr = account.AccountNr;
                            result.Account2Name = account.Name;
                        }
                    }
                    else if (accountDimCounter == 3 && !string.IsNullOrEmpty(accountDim3Nr))
                    {
                        account = AccountManager.GetAccountByNr(accountDim3Nr, dimDTO.AccountDimId, base.ActorCompanyId, true, true, true);
                        if (account != null)
                        {
                            result.AccountDim3Nr = account.AccountDim.AccountDimNr;
                            result.Account3Id = account.AccountId;
                            result.Account3Nr = account.AccountNr;
                            result.Account3Name = account.Name;
                        }
                    }
                    else if (accountDimCounter == 4 && !string.IsNullOrEmpty(accountDim4Nr))
                    {
                        account = AccountManager.GetAccountByNr(accountDim4Nr, dimDTO.AccountDimId, base.ActorCompanyId, true, true, true);
                        if (account != null)
                        {
                            result.AccountDim4Nr = account.AccountDim.AccountDimNr;
                            result.Account4Id = account.AccountId;
                            result.Account4Nr = account.AccountNr;
                            result.Account4Name = account.Name;
                        }
                    }
                    else if (accountDimCounter == 5 && !string.IsNullOrEmpty(accountDim5Nr))
                    {
                        account = AccountManager.GetAccountByNr(accountDim5Nr, dimDTO.AccountDimId, base.ActorCompanyId, true, true, true);
                        if (account != null)
                        {
                            result.AccountDim5Nr = account.AccountDim.AccountDimNr;
                            result.Account5Id = account.AccountId;
                            result.Account5Nr = account.AccountNr;
                            result.Account5Name = account.Name;
                        }
                    }
                    else if (accountDimCounter == 6 && !string.IsNullOrEmpty(accountDim6Nr))
                    {
                        account = AccountManager.GetAccountByNr(accountDim6Nr, dimDTO.AccountDimId, base.ActorCompanyId, true, true, true);
                        if (account != null)
                        {
                            result.AccountDim6Nr = account.AccountDim.AccountDimNr;
                            result.Account6Id = account.AccountId;
                            result.Account6Nr = account.AccountNr;
                            result.Account6Name = account.Name;
                        }
                    }
                }
                return result;
            }

            if (accStd != null && accStd.AccountInternal != null)
            {
                int dimCounter = 2;
                foreach (var accInt in accStd.AccountInternal.Where(a => a.Account != null && a.Account.AccountDim != null && a.Account.AccountDim.AccountDimNr != Constants.ACCOUNTDIM_STANDARD).OrderBy(a => a.Account.AccountDim.AccountDimNr))
                {
                    account = accInt.Account;
                    // TODO: Does not support dim numbers over 6!!!
                    if (dimCounter == 2)
                    {
                        result.AccountDim2Nr = account.AccountDim.AccountDimNr;
                        result.Account2Id = account.AccountId;
                        result.Account2Nr = account.AccountNr;
                        result.Account2Name = account.Name;
                    }
                    else if (dimCounter == 3)
                    {
                        result.AccountDim3Nr = account.AccountDim.AccountDimNr;
                        result.Account3Id = account.AccountId;
                        result.Account3Nr = account.AccountNr;
                        result.Account3Name = account.Name;
                    }
                    else if (dimCounter == 4)
                    {
                        result.AccountDim4Nr = account.AccountDim.AccountDimNr;
                        result.Account4Id = account.AccountId;
                        result.Account4Nr = account.AccountNr;
                        result.Account4Name = account.Name;
                    }
                    else if (dimCounter == 5)
                    {
                        result.AccountDim5Nr = account.AccountDim.AccountDimNr;
                        result.Account5Id = account.AccountId;
                        result.Account5Nr = account.AccountNr;
                        result.Account5Name = account.Name;
                    }
                    else if (dimCounter == 6)
                    {
                        result.AccountDim6Nr = account.AccountDim.AccountDimNr;
                        result.Account6Id = account.AccountId;
                        result.Account6Nr = account.AccountNr;
                        result.Account6Name = account.Name;
                    }

                    dimCounter++;
                }
            }
            return result;
        }
        public AccountingSettingsRowDTO CreateAccountingSettingRowExistDTO(InvoiceProduct product, List<AccountDim> accountDims, ProductAccountStd productAccount)
        {
            AccountingSettingsRowDTO result = new AccountingSettingsRowDTO()
            {
                Type = productAccount.Type,
                Percent = 0
            };

            AccountDim accountDimStd = accountDims.GetStandard();
            if (accountDimStd == null)
                return result;

            Account accountStd = productAccount.AccountStd.Account;
            result.AccountDim1Nr = Constants.ACCOUNTDIM_STANDARD;
            result.Account1Id = accountStd.AccountId;
            result.Account1Nr = accountStd.AccountNr;
            result.Account1Name = accountStd.Name;

            if (productAccount.AccountInternal != null)
            {
                foreach (var accInt in productAccount.AccountInternal)
                {
                    Account account = accInt.Account;
                    // TODO: Does not support dim numbers over 6!!!
                    if (account.AccountDim.AccountDimNr == 2)
                    {
                        result.AccountDim2Nr = account.AccountDim.AccountDimNr;
                        result.Account2Id = account.AccountId;
                        result.Account2Nr = account.AccountNr;
                        result.Account2Name = account.Name;
                    }
                    else if (account.AccountDim.AccountDimNr == 3)
                    {
                        result.AccountDim3Nr = account.AccountDim.AccountDimNr;
                        result.Account3Id = account.AccountId;
                        result.Account3Nr = account.AccountNr;
                        result.Account3Name = account.Name;
                    }
                    else if (account.AccountDim.AccountDimNr == 4)
                    {
                        result.AccountDim4Nr = account.AccountDim.AccountDimNr;
                        result.Account4Id = account.AccountId;
                        result.Account4Nr = account.AccountNr;
                        result.Account4Name = account.Name;
                    }
                    else if (account.AccountDim.AccountDimNr == 5)
                    {
                        result.AccountDim5Nr = account.AccountDim.AccountDimNr;
                        result.Account5Id = account.AccountId;
                        result.Account5Nr = account.AccountNr;
                        result.Account5Name = account.Name;
                    }
                    else if (account.AccountDim.AccountDimNr == 6)
                    {
                        result.AccountDim6Nr = account.AccountDim.AccountDimNr;
                        result.Account6Id = account.AccountId;
                        result.Account6Nr = account.AccountNr;
                        result.Account6Name = account.Name;
                    }
                }
            }
            return result;
        }
        public ActionResult ImportFromInvoiceProductIO(List<InvoiceProductIODTO> invoiceProductIOs, int actorCompanyId, bool allowOnlyInserts)
        {
            ActionResult result = new ActionResult { Keys = new List<int>() };

            int nbrOfSaved = 0;

            #region Prereq

            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(actorCompanyId, (int)SoeTimeCodeType.Material);
            List<VatCode> vatCodes = AccountManager.GetVatCodes(actorCompanyId);
            List<PriceListType> pricelistTypes = ProductPricelistManager.GetPriceListTypes(actorCompanyId);
            List<AccountDim> dims = AccountManager.GetAccountDimsByCompany(actorCompanyId);
            List<Account> accounts = AccountManager.GetAccounts(actorCompanyId);
            List<ProductGroup> productGroups = ProductGroupManager.GetProductGroups(actorCompanyId);
            List<ProductUnit> productUnits = ProductManager.GetProductUnits(actorCompanyId);
            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

            //GetaccountsforStock
            var accountStdCode10out = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode10outch = accounts.FirstOrDefault(a => a.AccountNr == "4020");
            var accountStdCode10in = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode10inch = accounts.FirstOrDefault(a => a.AccountNr == "4020");
            var accountStdCode10inv = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode10invch = accounts.FirstOrDefault(a => a.AccountNr == "4020");
            var accountStdCode10loss = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode10lossch = accounts.FirstOrDefault(a => a.AccountNr == "4020");

            var accountStdCode20out = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode20outch = accounts.FirstOrDefault(a => a.AccountNr == "4025");
            var accountStdCode20in = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode20inch = accounts.FirstOrDefault(a => a.AccountNr == "4025");
            var accountStdCode20inv = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode20invch = accounts.FirstOrDefault(a => a.AccountNr == "4025");
            var accountStdCode20loss = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode20lossch = accounts.FirstOrDefault(a => a.AccountNr == "4025");

            var accountStdCode30out = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode30outch = accounts.FirstOrDefault(a => a.AccountNr == "4026");
            var accountStdCode30in = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode30inch = accounts.FirstOrDefault(a => a.AccountNr == "4026");
            var accountStdCode30inv = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode30invch = accounts.FirstOrDefault(a => a.AccountNr == "4026");
            var accountStdCode30loss = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode30lossch = accounts.FirstOrDefault(a => a.AccountNr == "4026");

            var accountStdCode40out = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode40outch = accounts.FirstOrDefault(a => a.AccountNr == "4020");
            var accountStdCode40in = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode40inch = accounts.FirstOrDefault(a => a.AccountNr == "4020");
            var accountStdCode40inv = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode40invch = accounts.FirstOrDefault(a => a.AccountNr == "4020");
            var accountStdCode40loss = accounts.FirstOrDefault(a => a.AccountNr == "6190");
            var accountStdCode40lossch = accounts.FirstOrDefault(a => a.AccountNr == "4020");

            var accountStdCode50out = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode50outch = accounts.FirstOrDefault(a => a.AccountNr == "4027");
            var accountStdCode50in = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode50inch = accounts.FirstOrDefault(a => a.AccountNr == "4027");
            var accountStdCode50inv = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode50invch = accounts.FirstOrDefault(a => a.AccountNr == "4027");
            var accountStdCode50loss = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode50lossch = accounts.FirstOrDefault(a => a.AccountNr == "4027");

            var accountStdCode60out = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode60outch = accounts.FirstOrDefault(a => a.AccountNr == "4025");
            var accountStdCode60in = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode60inch = accounts.FirstOrDefault(a => a.AccountNr == "4025");
            var accountStdCode60inv = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode60invch = accounts.FirstOrDefault(a => a.AccountNr == "4025");
            var accountStdCode60loss = accounts.FirstOrDefault(a => a.AccountNr == "6191");
            var accountStdCode60lossch = accounts.FirstOrDefault(a => a.AccountNr == "4025");

            var accountStdCode70out = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode70outch = accounts.FirstOrDefault(a => a.AccountNr == "4026");
            var accountStdCode70in = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode70inch = accounts.FirstOrDefault(a => a.AccountNr == "4026");
            var accountStdCode70inv = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode70invch = accounts.FirstOrDefault(a => a.AccountNr == "4026");
            var accountStdCode70loss = accounts.FirstOrDefault(a => a.AccountNr == "6192");
            var accountStdCode70lossch = accounts.FirstOrDefault(a => a.AccountNr == "4026");

            var accountStdCode80out = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode80outch = accounts.FirstOrDefault(a => a.AccountNr == "4027");
            var accountStdCode80in = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode80inch = accounts.FirstOrDefault(a => a.AccountNr == "4027");
            var accountStdCode80inv = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode80invch = accounts.FirstOrDefault(a => a.AccountNr == "4027");
            var accountStdCode80loss = accounts.FirstOrDefault(a => a.AccountNr == "6193");
            var accountStdCode80lossch = accounts.FirstOrDefault(a => a.AccountNr == "4027");


            List<SysWholeseller> sysWholesellers = null;
            int? defaultStockId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultStock, 0, actorCompanyId, 0);
            int? wholesellerId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultWholeseller, 0, actorCompanyId, 0);
            int? defaultPriceListTypeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, 0, actorCompanyId, 0);
            int? currency = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CoreBaseCurrency, 0, actorCompanyId, 0);


            if (wholesellerId == 0)
            {
                sysWholesellers = WholeSellerManager.GetSysWholesellersByCompany(actorCompanyId);
                if (sysWholesellers.FirstOrDefault() != null)
                    wholesellerId = sysWholesellers.FirstOrDefault().SysWholesellerId;
            }

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            PriceListType priceListType = ProductPricelistManager.GetPriceListTypes(entitiesReadOnly, actorCompanyId).FirstOrDefault();

            if ((!defaultPriceListTypeId.HasValue || defaultPriceListTypeId == 0) && priceListType != null)
            {
                defaultPriceListTypeId = priceListType.PriceListTypeId;
            }


            #endregion

            if (invoiceProductIOs.Count > 9000)
            {
                result.ErrorMessage = "Import of more than 9000 products are not allowed";
                result.Success = false;
                return result;

            }

            foreach (var product in invoiceProductIOs)
            {
                #region Prereq

                InvoiceProductDTO productDTO = new InvoiceProductDTO();

                //Alternative Codes
                string timeCodeAlternative = product.MaterialCode?.TrimStart('0');
                string vatCodeeAlternative = product.VatCodeNr?.TrimStart('0');

                int? timeCodeId = null;
                int? vatCodeId = null;
                int? intrastatCodeId = null;
                if (!string.IsNullOrEmpty(product.MaterialCode))
                {
                    var materialCode = timeCodes.FirstOrDefault(t => t.Code == product.MaterialCode);
                    timeCodeId = materialCode?.TimeCodeId;
                }
                if (!string.IsNullOrEmpty(product.VatCodeNr))
                {
                    var vatCode = vatCodes.FirstOrDefault(t => t.Code == product.VatCodeNr);
                    vatCodeId = vatCode?.VatCodeId;
                }
                if (!string.IsNullOrEmpty(product.IntrastatCode))
                {

                    intrastatCodeId = CommodityCodeManager.EnsureCustomerCommodityCode(actorCompanyId, product.IntrastatCode);
                }

                int? productGroupid = null;
                if (product.ProductGroupId.HasValue)
                    productGroupid = productGroups.FirstOrDefault(t => t.ProductGroupId == product.ProductGroupId)?.ProductGroupId;
                if (!productGroupid.HasValue)
                    productGroupid = productGroups.FirstOrDefault(t => t.Code == product.ProductGroupCode)?.ProductGroupId;

                int? productUnitId = null;
                if (!string.IsNullOrWhiteSpace(product.Unit))
                    productUnitId = productUnits.Where(t => !string.IsNullOrWhiteSpace(t.Code) && t.Code.Equals(product.Unit, StringComparison.InvariantCultureIgnoreCase)).Select(t => t.ProductUnitId).FirstOrDefault();

                if (!timeCodeId.HasValue)
                    timeCodeId = timeCodes.FirstOrDefault(t => t.Code == timeCodeAlternative)?.TimeCodeId;

                if (!vatCodeId.HasValue)
                    vatCodeId = vatCodes.FirstOrDefault(t => t.Code == vatCodeeAlternative)?.VatCodeId;

                if (!productGroupid.HasValue && !string.IsNullOrEmpty(product.ProductGroupCode))
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        var productGroup = new ProductGroup
                        {
                            Code = product.ProductGroupCode,
                            Name = product.ProductGroupCode,
                            Company = CompanyManager.GetCompany(entities, actorCompanyId),
                        };
                        entities.ProductGroup.AddObject(productGroup);

                        entities.SaveChanges();
                    }

                    productGroups = ProductGroupManager.GetProductGroups(actorCompanyId);
                    productGroupid = productGroups.FirstOrDefault(t => t.Code == product.ProductGroupCode)?.ProductGroupId;
                }

                #endregion

                InvoiceProduct productExist = ProductManager.GetInvoiceProductByProductNr(product.Number.Trim(), actorCompanyId, true);

                productDTO.ProductId = productExist?.ProductId ?? 0;
                productDTO.ProductUnitId = productUnitId;
                productDTO.Name = product.Name;
                productDTO.Number = product.Number.Trim();
                productDTO.PurchasePrice = product.PurchasePrice;
                productDTO.SalesPrice = product.SalesPrice;
                productDTO.TimeCodeId = timeCodeId;
                productDTO.VatCodeId = vatCodeId;
                productDTO.EAN = product.EAN;
                productDTO.Weight = product.Weight;
                productDTO.ProductGroupId = productExist?.ProductGroupId ?? productGroupid;
                productDTO.IntrastatCodeId = productExist?.IntrastatCodeId ?? intrastatCodeId;

                productDTO.VatType = product.VatType >= 0 && product.VatType <= 2 ? (TermGroup_InvoiceProductVatType)product.VatType : TermGroup_InvoiceProductVatType.None;
                productDTO.ShowDescriptionAsTextRow = product.ShowAsTextRow;
                productDTO.Description = product.Description;

                // Try to find external product and add to invoiceproduct

                try
                {
                    if (product.Number.Length > 5 && wholesellerId != 0 && wholesellerId != null && priceListType != null)
                    {
                        int sysWholeSellerId = (int)wholesellerId;

                        var sysproduct = ProductManager.GetExternalInvoiceProductByProductNumber(product.Number, actorCompanyId, ref sysWholeSellerId, tryAll: true, sysWholesellers: sysWholesellers);
                        if (sysproduct != null)
                        {
                            InvoiceProductPriceSearchViewDTO productPrice = ProductManager.SearchInvoiceProductPrice(actorCompanyId, defaultPriceListTypeId ?? 0, 0, currency ?? 0, sysproduct.ProductId, sysWholeSellerId, applyPriceRule: false);

                            if (sysproduct != null)
                            {
                                productDTO.SysProductId = sysproduct.ProductId;
                                productDTO.SysPriceListHeadId = productPrice?.SysPriceListHeadId;
                                productDTO.IsExternal = true;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    log.Error("ImportFromInvoiceProductIO", ex);
                }

                #region Account

                if (accountSiedim1 != null && product.SalesAccountSieDim1 != null)
                {
                    switch (accountSiedim1.AccountDimNr)
                    {
                        case 2:
                            product.SalesAccountDim2Nr = product.SalesAccountSieDim1;
                            break;
                        case 3:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim1;
                            break;
                        case 4:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim1;
                            break;
                        case 5:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim1;
                            break;
                        case 6:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim1;
                            break;
                    }
                }
                if (accountSiedim1 != null && product.ReversedVatSalesAccountSieDim1 != null)
                {
                    switch (accountSiedim1.AccountDimNr)
                    {
                        case 2:
                            product.ReversedVatSalesAccountDim2Nr = product.ReversedVatSalesAccountSieDim1;
                            break;
                        case 3:
                            product.ReversedVatSalesAccountDim3Nr = product.ReversedVatSalesAccountSieDim1;
                            break;
                        case 4:
                            product.ReversedVatSalesAccountDim4Nr = product.ReversedVatSalesAccountSieDim1;
                            break;
                        case 5:
                            product.ReversedVatSalesAccountDim5Nr = product.ReversedVatSalesAccountSieDim1;
                            break;
                        case 6:
                            product.ReversedVatSalesAccountDim6Nr = product.ReversedVatSalesAccountSieDim1;
                            break;
                    }
                }
                if (accountSiedim6 != null && product.SalesAccountSieDim6 != null)
                {
                    switch (accountSiedim6.AccountDimNr)
                    {
                        case 2:
                            product.SalesAccountDim2Nr = product.SalesAccountSieDim6;
                            break;
                        case 3:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim6;
                            break;
                        case 4:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim6;
                            break;
                        case 5:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim6;
                            break;
                        case 6:
                            product.SalesAccountDim3Nr = product.SalesAccountSieDim6;
                            break;
                    }
                }
                if (accountSiedim6 != null && product.ReversedVatSalesAccountSieDim6 != null)
                {
                    switch (accountSiedim6.AccountDimNr)
                    {
                        case 2:
                            product.ReversedVatSalesAccountDim2Nr = product.ReversedVatSalesAccountSieDim6;
                            break;
                        case 3:
                            product.ReversedVatSalesAccountDim3Nr = product.ReversedVatSalesAccountSieDim6;
                            break;
                        case 4:
                            product.ReversedVatSalesAccountDim4Nr = product.ReversedVatSalesAccountSieDim6;
                            break;
                        case 5:
                            product.ReversedVatSalesAccountDim5Nr = product.ReversedVatSalesAccountSieDim6;
                            break;
                        case 6:
                            product.ReversedVatSalesAccountDim6Nr = product.ReversedVatSalesAccountSieDim6;
                            break;
                    }
                }


                //Create Accounting

                // 1 = Purchase = Intäkt
                // 2 = Sales = Fordran
                // 3 = VAT = Moms
                // 4 = SalesNoVat = Intäkt, momsfri
                // 5 = SalesContractor, Intäkt, omvänd moms
                // StockIn = 6,  
                // StockInChange = 7,
                // StockOut = 8,
                // StockOutChange = 9,
                // StockInv = 10,
                // StockInvChange = 11,
                // StockLoss = 12,
                // StockLossChange = 13,
                //             List<AccountingSettingRowDTO> accountSettingsRow = new List<AccountingSettingRowDTO>();

                productDTO.AccountingSettings = new List<AccountingSettingsRowDTO>();

                var accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.Purchase, dims, product.ClaimAccountNr, product.ClaimAccountDim2Nr, product.ClaimAccountDim3Nr, product.ClaimAccountDim4Nr, product.ClaimAccountDim5Nr, product.ClaimAccountDim6Nr, true);
                ProductAccountStd productAccount = null;
                if (productExist != null)
                {
                    productAccount = productExist.ProductAccountStd.FirstOrDefault(x => x.Type == (int)ProductAccountType.Purchase);
                }
                if (accountSettingsRowDto != null)
                {
                    productDTO.AccountingSettings.Add(accountSettingsRowDto);
                }
                else
                {
                    if (productAccount != null)
                    {
                        accountSettingsRowDto = CreateAccountingSettingRowExistDTO(productExist, dims, productAccount);
                        productDTO.AccountingSettings.Add(accountSettingsRowDto);
                    }
                }
                accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.Sales, dims, product.SalesAccountNr, product.SalesAccountDim2Nr, product.SalesAccountDim3Nr, product.SalesAccountDim4Nr, product.SalesAccountDim5Nr, product.SalesAccountDim6Nr, true);
                if (productExist != null)
                {
                    productAccount = productExist.ProductAccountStd.FirstOrDefault(x => x.Type == (int)ProductAccountType.Sales);
                }
                if (accountSettingsRowDto != null)
                {
                    productDTO.AccountingSettings.Add(accountSettingsRowDto);
                }
                else
                {
                    if (productAccount != null)
                    {
                        accountSettingsRowDto = CreateAccountingSettingRowExistDTO(productExist, dims, productAccount);
                        productDTO.AccountingSettings.Add(accountSettingsRowDto);
                    }
                }

                accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.VAT, dims, product.VatAccountNr, allowEmptyStandard: true);
                if (productExist != null)
                {
                    productAccount = productExist.ProductAccountStd.FirstOrDefault(x => x.Type == (int)ProductAccountType.VAT);
                }
                if (accountSettingsRowDto != null)
                {
                    productDTO.AccountingSettings.Add(accountSettingsRowDto);
                }
                else
                {
                    if (productAccount != null)
                    {
                        accountSettingsRowDto = CreateAccountingSettingRowExistDTO(productExist, dims, productAccount);
                        productDTO.AccountingSettings.Add(accountSettingsRowDto);
                    }
                }

                accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.SalesNoVat, dims, product.VatFreeSalesAccountNr, allowEmptyStandard: true);
                if (productExist != null)
                {
                    productAccount = productExist.ProductAccountStd.FirstOrDefault(x => x.Type == (int)ProductAccountType.SalesNoVat);
                }
                if (accountSettingsRowDto != null)
                {
                    productDTO.AccountingSettings.Add(accountSettingsRowDto);
                }
                else
                {
                    if (productAccount != null)
                    {
                        accountSettingsRowDto = CreateAccountingSettingRowExistDTO(productExist, dims, productAccount);
                        productDTO.AccountingSettings.Add(accountSettingsRowDto);
                    }
                }

                accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.SalesContractor, dims, product.ReversedVatSalesAccountNr, product.ReversedVatSalesAccountDim2Nr, product.ReversedVatSalesAccountDim3Nr, product.ReversedVatSalesAccountDim4Nr, product.ReversedVatSalesAccountDim5Nr, product.ReversedVatSalesAccountDim6Nr, true);
                if (productExist != null)
                {
                    productAccount = productExist.ProductAccountStd.FirstOrDefault(x => x.Type == (int)ProductAccountType.SalesContractor);
                }
                if (accountSettingsRowDto != null)
                {
                    productDTO.AccountingSettings.Add(accountSettingsRowDto);
                }
                else
                {
                    if (productAccount != null)
                    {
                        accountSettingsRowDto = CreateAccountingSettingRowExistDTO(productExist, dims, productAccount);
                        productDTO.AccountingSettings.Add(accountSettingsRowDto);
                    }
                }

                //accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 1, dims, product.ClaimAccountNr, product.ClaimAccountDim2Nr, product.ClaimAccountDim3Nr, product.ClaimAccountDim4Nr, product.ClaimAccountDim4Nr, product.ClaimAccountDim6Nr));
                //accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 2, dims, product.SalesAccountNr, product.SalesAccountDim2Nr, product.SalesAccountDim3Nr, product.SalesAccountDim4Nr, product.SalesAccountDim5Nr, product.SalesAccountDim6Nr));
                //accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 3, dims, accountNr: product.VatAccountNr));
                //accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 4, dims, accountNr: product.VatFreeSalesAccountNr));
                //accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 5, dims, product.ReversedVatSalesAccountNr, product.ReversedVatSalesAccountDim2Nr, product.ReversedVatSalesAccountDim3Nr, product.ReversedVatSalesAccountDim4Nr, product.ReversedVatSalesAccountDim5Nr, product.ReversedVatSalesAccountDim6Nr));
                switch (product.ProductGroupCode)
                {
                    case "10":
                        if (accountStdCode10in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode10in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode10inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode10out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode10outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode10inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode10invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode10loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode10lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode10lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                    case "20":
                        if (accountStdCode20in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode20in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode20inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode20out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode20outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode20inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode20invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode20loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode20lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode20lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                    case "30":
                        if (accountStdCode30in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode30in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode30inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode30out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode30outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode30inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode30invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode30loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode30lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode30lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                    case "40":
                        if (accountStdCode40in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode40in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode40inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode40out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode40outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode40inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode40invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode40loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode40lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode40lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                    case "50":
                        if (accountStdCode50in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode50in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode50inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode50out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode50outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode50inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode50invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode50loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode50lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode50lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                    case "60":
                        if (accountStdCode60in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode60in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode60inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode60out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode60outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode60inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode60invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode60loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode60lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode60lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                    case "70":
                        if (accountStdCode70in != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockIn, dims, accountStdCode70in.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70inch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInChange, dims, accountStdCode70inch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70out != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOut, dims, accountStdCode70out.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70outch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockOutChange, dims, accountStdCode70outch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70inv != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInv, dims, accountStdCode70inv.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70invch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockInvChange, dims, accountStdCode70invch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70loss != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLoss, dims, accountStdCode70loss.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        if (accountStdCode70lossch != null)
                        {
                            accountSettingsRowDto = CreateAccountingSettingRowDTO(productExist, ProductAccountType.StockLossChange, dims, accountStdCode70lossch.AccountNr);
                            if (accountSettingsRowDto != null) productDTO.AccountingSettings.Add(accountSettingsRowDto);
                        }
                        break;
                }

                #endregion

                #region Prices

                List<PriceListDTO> priceLists = new List<PriceListDTO>();

                foreach (var pricelist in product.PriceDTOs)
                {
                    if (string.IsNullOrEmpty(pricelist.PriceListCode))
                    {
                        return new ActionResult(GetText(3272, "Ingen prislista funnen"));
                    }

                    int priceListTypeId = pricelistTypes.FirstOrDefault(p => p.Name.ToLower() == pricelist.PriceListCode.ToLower())?.PriceListTypeId ?? 0;
                    if (priceListTypeId != 0)
                    {
                        var plDTO = new PriceListDTO
                        {
                            Quantity = pricelist.Quantity,
                            Price = pricelist.Price,
                            PriceListTypeId = priceListTypeId,
                            StartDate = pricelist.StartDate,
                            StopDate = pricelist.StopDate,
                        };

                        priceLists.Add(plDTO);
                    }
                }

                #endregion

                // ExtraFields

                List<ExtraFieldRecordDTO> extraFieldRecords = new List<ExtraFieldRecordDTO>();

                var extraFields = ExtraFieldManager.GetExtraFields((int)SoeEntityType.InvoiceProduct, actorCompanyId);
                int extraFieldNumber = 1;

                foreach (var extraField in extraFields)
                {
                    if (extraFieldNumber == 1)
                    {
                        string extraField1 = product.ExtraField1;
                        bool extraFieldExist = string.IsNullOrEmpty(extraField1);
                        if (!extraFieldExist)
                        {
                            var extraFieldRecordTO = new ExtraFieldRecordDTO
                            {
                                ExtraFieldRecordId = productExist?.ProductId ?? 0,
                                ExtraFieldId = extraField.ExtraFieldId,
                                ExtraFieldText = extraField.Text,
                                ExtraFieldType = extraField.Type,
                                StrData = product.ExtraField1
                            };
                            extraFieldRecords.Add(extraFieldRecordTO);
                        }
                    }
                    if (extraFieldNumber == 2)
                    {
                        string extraField2 = product.ExtraField2;
                        bool extraFieldExist = string.IsNullOrEmpty(extraField2);
                        if (!extraFieldExist)
                        {
                            var extraFieldRecordTO = new ExtraFieldRecordDTO
                            {
                                ExtraFieldRecordId = productExist?.ProductId ?? 0,
                                ExtraFieldId = extraField.ExtraFieldId,
                                ExtraFieldText = extraField.Text,
                                ExtraFieldType = extraField.Type,
                                StrData = product.ExtraField2
                            };
                            extraFieldRecords.Add(extraFieldRecordTO);
                        }
                    }
                    if (extraFieldNumber == 3)
                    {
                        string extraField3 = product.ExtraField3;
                        bool extraFieldExist = string.IsNullOrEmpty(extraField3);
                        if (!extraFieldExist)
                        {
                            var extraFieldRecordTO = new ExtraFieldRecordDTO
                            {
                                ExtraFieldRecordId = productExist?.ProductId ?? 0,
                                ExtraFieldId = extraField.ExtraFieldId,
                                ExtraFieldText = extraField.Text,
                                ExtraFieldType = extraField.Type,
                                StrData = product.ExtraField3
                            };
                            extraFieldRecords.Add(extraFieldRecordTO);
                        }
                    }

                    extraFieldNumber++;
                }

                // Create stockProduct
                var stockDtos = new List<StockDTO>();
                if (defaultStockId.HasValue && product.IsStockProduct.GetValueOrDefault(false))
                {
                    StockProduct stockPr = StockManager.GetStockProductFromInvoiceProduct(productExist?.ProductId ?? 0, defaultStockId.Value, 0);
                    if (stockPr == null && defaultStockId != null)
                    {
                        var stockDto = new StockDTO
                        {
                            StockId = defaultStockId.Value,
                            AvgPrice = product.AvgPriceStockProduct
                        };
                        stockDtos.Add(stockDto);
                    }

                    if (product.IsStockProduct.GetValueOrDefault(false))
                    {
                        productDTO.IsStockProduct = true;
                    }
                }

                #region Save

                ActionResult saveResult = ProductManager.SaveInvoiceProduct(productDTO, priceLists, null, actorCompanyId, stockDtos, null, extraFieldRecords, allowOnlyInserts: allowOnlyInserts);
                nbrOfSaved += saveResult.ObjectsAffected;

                if (!saveResult.Success && saveResult.ErrorNumber != (int)ActionResultSave.ProductExists)
                {
                    return saveResult;
                }
                else if (saveResult.Success)
                {
                    result.Keys.Add(saveResult.IntegerValue);
                }

                #endregion

            }

            result.IntegerValue = nbrOfSaved;

            return result;

        }

        #region Help-methods

        private static void AddAccountingSettingsRowDTO(InvoiceProduct product, InvoiceProductDTO dto, ProductAccountType type)
        {
            AccountingSettingsRowDTO accDto = new AccountingSettingsRowDTO()
            {
                Type = (int)type,
                Percent = 0
            };
            dto.AccountingSettings.Add(accDto);

            ProductAccountStd accStd = product.ProductAccountStd.FirstOrDefault(c => c.Type == (int)type);
            Account account = accStd?.AccountStd?.Account;
            if (account != null)
            {
                accDto.AccountDim1Nr = Constants.ACCOUNTDIM_STANDARD;
                accDto.Account1Id = account.AccountId;
                accDto.Account1Nr = account.AccountNr;
                accDto.Account1Name = account.Name;
            }

            if (accStd != null && accStd.AccountInternal != null)
            {
                int dimCounter = 2;
                foreach (var accInt in accStd.AccountInternal.Where(a => a.Account != null && a.Account.AccountDim != null && a.Account.AccountDim.AccountDimNr != Constants.ACCOUNTDIM_STANDARD).OrderBy(a => a.Account.AccountDim.AccountDimNr))
                {
                    account = accInt.Account;

                    // TODO: Does not support dim numbers over 6!!!
                    if (dimCounter == 2)
                    {
                        accDto.AccountDim2Nr = account.AccountDim.AccountDimNr;
                        accDto.Account2Id = account.AccountId;
                        accDto.Account2Nr = account.AccountNr;
                        accDto.Account2Name = account.Name;
                    }
                    else if (dimCounter == 3)
                    {
                        accDto.AccountDim3Nr = account.AccountDim.AccountDimNr;
                        accDto.Account3Id = account.AccountId;
                        accDto.Account3Nr = account.AccountNr;
                        accDto.Account3Name = account.Name;
                    }
                    else if (dimCounter == 4)
                    {
                        accDto.AccountDim4Nr = account.AccountDim.AccountDimNr;
                        accDto.Account4Id = account.AccountId;
                        accDto.Account4Nr = account.AccountNr;
                        accDto.Account4Name = account.Name;
                    }
                    else if (dimCounter == 5)
                    {
                        accDto.AccountDim5Nr = account.AccountDim.AccountDimNr;
                        accDto.Account5Id = account.AccountId;
                        accDto.Account5Nr = account.AccountNr;
                        accDto.Account5Name = account.Name;
                    }
                    else if (dimCounter == 6)
                    {
                        accDto.AccountDim6Nr = account.AccountDim.AccountDimNr;
                        accDto.Account6Id = account.AccountId;
                        accDto.Account6Nr = account.AccountNr;
                        accDto.Account6Name = account.Name;
                    }

                    dimCounter++;
                }
            }
        }




        public List<CustomerInvoiceHeadIO> GetCustomerInvoiceHeadIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceHeadIO.NoTracking();
            var query = (from io in entities.CustomerInvoiceHeadIO.Include("CustomerInvoiceRowIO")
                         where io.ActorCompanyId == actorCompanyId &&
                         io.BatchId == batchId
                         orderby io.CustomerInvoiceHeadIOId
                         select io);

            if (type != TermGroup_IOType.Unknown)
                query.Where(io => io.Type == (int)type);
            if (source != TermGroup_IOSource.Unknown)
                query.Where(io => io.Source == (int)source);

            List<CustomerInvoiceHeadIO> ios = query.ToList();

            // Get terms
            int langId = GetLangId();
            Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);
            Dictionary<int, string> billingTypes = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);

            // Extensions
            foreach (var io in ios)
            {
                io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : String.Empty;
                io.BillingTypeName = io.BillingType.HasValue && billingTypes.ContainsKey(io.BillingType.Value) ? billingTypes[io.BillingType.Value] : String.Empty;
            }

            return ios;
        }

        public List<CustomerInvoiceHeadIO> GetCustomerInvoiceHeadIOResult(int actorCompanyId, List<int> customerInvoiceHeadIOIds)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceHeadIO.NoTracking();
            return (from io in entities.CustomerInvoiceHeadIO.Include("CustomerInvoiceRowIO")
                    where io.ActorCompanyId == actorCompanyId &&
                    customerInvoiceHeadIOIds.Contains(io.CustomerInvoiceHeadIOId)
                    select io).ToList();
        }

        public ActionResult UpdateCustomerInvoiceHeadIO(List<CustomerInvoiceIODTO> dtos)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (CustomerInvoiceIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        CustomerInvoiceHeadIO io = GetCustomerInvoiceHeadIO(entities, dto.CustomerInvoiceHeadIOId);
                        if (io != null)
                        {
                            io.CustomerInvoiceHeadIOId = dto.CustomerInvoiceHeadIOId;
                            io.InvoiceId = dto.InvoiceId;
                            io.CustomerInvoiceNr = dto.CustomerInvoiceNr;
                            io.SeqNr = dto.SeqNr;
                            io.OCR = dto.OCR;
                            io.ActorCompanyId = dto.ActorCompanyId;
                            io.Import = dto.Import;
                            io.Type = dto.Type;
                            io.Status = dto.Status;
                            io.Source = dto.Source;
                            io.OriginType = dto.OriginType;
                            io.OriginStatus = dto.OriginStatus;
                            io.BatchId = dto.BatchId;
                            io.CustomerId = dto.CustomerId;
                            io.CustomerNr = dto.CustomerNr;
                            io.RegistrationType = dto.RegistrationType;
                            io.InvoiceDate = dto.InvoiceDate;
                            io.DueDate = dto.DueDate;
                            io.VoucherDate = dto.VoucherDate;
                            io.ReferenceOur = dto.ReferenceOur;
                            io.ReferenceYour = dto.ReferenceYour;
                            io.CurrencyRate = dto.CurrencyRate;
                            io.CurrencyDate = dto.CurrencyDate;
                            io.TotalAmount = dto.TotalAmount;
                            io.TotalAmountCurrency = dto.TotalAmountCurrency;
                            io.VATAmount = dto.VATAmount;
                            io.VATAmountCurrency = dto.VATAmountCurrency;
                            io.PaidAmount = dto.PaidAmount;
                            io.PaidAmountCurrency = dto.PaidAmountCurrency;
                            io.RemainingAmount = dto.RemainingAmount;
                            io.FreightAmount = dto.FreightAmount;
                            io.FreightAmountCurrency = dto.FreightAmountCurrency;
                            io.InvoiceFee = dto.InvoiceFee;
                            io.InvoiceFeeCurrency = dto.InvoiceFeeCurrency;
                            io.CentRounding = dto.CentRounding;
                            io.FullyPayed = dto.FullyPayed;
                            io.OrderNr = dto.OrderNr;
                            io.OfferNr = dto.OfferNr;
                            io.ContractNr = dto.ContractNr;
                            io.PaymentNr = dto.PaymentNr;
                            io.VoucherNr = dto.VoucherNr;
                            io.CreateAccountingInXE = dto.CreateAccountingInXE;
                            io.Note = dto.Note;
                            io.BillingType = dto.BillingType;
                            io.Currency = dto.Currency;
                            io.TransferType = dto.TransferType;
                            io.ErrorMessage = dto.ErrorMessage;
                            io.ImportHeadType = dto.ImportHeadType;
                            io.Created = dto.Created;
                            io.CreatedBy = dto.CreatedBy;
                            io.Modified = dto.Modified;
                            io.ModifiedBy = dto.ModifiedBy;
                            io.StatusName = dto.StatusName;
                            io.BillingTypeName = dto.BillingTypeName;

                            SetModifiedProperties(io);
                        }
                    }

                    // Save
                    result = SaveChanges(entities);

                    #endregion
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        private CustomerInvoiceHeadIO GetCustomerInvoiceHeadIO(CompEntities entities, int customerInvoiceHeadIOId, bool loadRows = false)
        {
            IQueryable<CustomerInvoiceHeadIO> q = entities.CustomerInvoiceHeadIO;
            if (loadRows)
                q = q.Include("CustomerInvoiceRowIO");

            return (from io in q
                    where io.CustomerInvoiceHeadIOId == customerInvoiceHeadIOId
                    select io).FirstOrDefault();
        }

        private List<CustomerInvoiceRowIO> GetCustomerInvoiceRowIOs(CompEntities entities, int customerInvoiceHeadIOId)
        {
            return (from io in entities.CustomerInvoiceRowIO
                    where io.CustomerInvoiceHeadIOId == customerInvoiceHeadIOId
                    select io).ToList();
        }

        private CustomerInvoiceHeadIO CreateCustomerInvoiceIO(CompEntities entities, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, CustomerInvoiceIODTO customerInvoiceIODTO, IEnumerable<ContractGroup> contractGroups, string batchId, int importId, int actorCompanyId, Dictionary<string, string> dictSpecialFunctionality, bool updateExistingInvoice = false)
        {
            #region Prereq
            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimDTOFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimDTOFromSieDimNr(sieDim6, actorCompanyId);

            var headio = new CustomerInvoiceHeadIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.UnderProcessing,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
                ImportId = importId,
            };
            SetCreatedProperties(headio);

            #endregion

            #region Perform

            try
            {
                #region Fill CustomerInvoiceIO

                if (accountSiedim1 != null && customerInvoiceIODTO.ClaimAccountNrSieDim1 != null)
                {
                    switch (accountSiedim1.AccountDimNr)
                    {
                        case 2:
                            customerInvoiceIODTO.ClaimAccountNrDim2 = customerInvoiceIODTO.ClaimAccountNrSieDim1;
                            break;
                        case 3:
                            customerInvoiceIODTO.ClaimAccountNrDim3 = customerInvoiceIODTO.ClaimAccountNrSieDim1;
                            break;
                        case 4:
                            customerInvoiceIODTO.ClaimAccountNrDim4 = customerInvoiceIODTO.ClaimAccountNrSieDim1;
                            break;
                        case 5:
                            customerInvoiceIODTO.ClaimAccountNrDim5 = customerInvoiceIODTO.ClaimAccountNrSieDim1;
                            break;
                        case 6:
                            customerInvoiceIODTO.ClaimAccountNrDim6 = customerInvoiceIODTO.ClaimAccountNrSieDim1;
                            break;
                    }
                }
                if (accountSiedim1 != null && customerInvoiceIODTO.SaleAccountNrSieDim1 != null)
                {
                    switch (accountSiedim1.AccountDimNr)
                    {
                        case 2:
                            customerInvoiceIODTO.SaleAccountNrDim2 = customerInvoiceIODTO.SaleAccountNrSieDim1;
                            break;
                        case 3:
                            customerInvoiceIODTO.SaleAccountNrDim3 = customerInvoiceIODTO.SaleAccountNrSieDim1;
                            break;
                        case 4:
                            customerInvoiceIODTO.SaleAccountNrDim4 = customerInvoiceIODTO.SaleAccountNrSieDim1;
                            break;
                        case 5:
                            customerInvoiceIODTO.SaleAccountNrDim5 = customerInvoiceIODTO.SaleAccountNrSieDim1;
                            break;
                        case 6:
                            customerInvoiceIODTO.SaleAccountNrDim6 = customerInvoiceIODTO.SaleAccountNrSieDim1;
                            break;
                    }
                }
                if (accountSiedim6 != null && customerInvoiceIODTO.ClaimAccountNrSieDim6 != null)
                {
                    switch (accountSiedim6.AccountDimNr)
                    {
                        case 2:
                            customerInvoiceIODTO.ClaimAccountNrDim2 = customerInvoiceIODTO.ClaimAccountNrSieDim6;
                            break;
                        case 3:
                            customerInvoiceIODTO.ClaimAccountNrDim3 = customerInvoiceIODTO.ClaimAccountNrSieDim6;
                            break;
                        case 4:
                            customerInvoiceIODTO.ClaimAccountNrDim4 = customerInvoiceIODTO.ClaimAccountNrSieDim6;
                            break;
                        case 5:
                            customerInvoiceIODTO.ClaimAccountNrDim5 = customerInvoiceIODTO.ClaimAccountNrSieDim6;
                            break;
                        case 6:
                            customerInvoiceIODTO.ClaimAccountNrDim6 = customerInvoiceIODTO.ClaimAccountNrSieDim6;
                            break;
                    }
                }
                if (accountSiedim6 != null && customerInvoiceIODTO.SaleAccountNrSieDim6 != null)
                {
                    switch (accountSiedim6.AccountDimNr)
                    {
                        case 2:
                            customerInvoiceIODTO.SaleAccountNrDim2 = customerInvoiceIODTO.SaleAccountNrSieDim6;
                            break;
                        case 3:
                            customerInvoiceIODTO.SaleAccountNrDim3 = customerInvoiceIODTO.SaleAccountNrSieDim6;
                            break;
                        case 4:
                            customerInvoiceIODTO.SaleAccountNrDim4 = customerInvoiceIODTO.SaleAccountNrSieDim6;
                            break;
                        case 5:
                            customerInvoiceIODTO.SaleAccountNrDim5 = customerInvoiceIODTO.SaleAccountNrSieDim6;
                            break;
                        case 6:
                            customerInvoiceIODTO.SaleAccountNrDim6 = customerInvoiceIODTO.SaleAccountNrSieDim6;
                            break;
                    }
                }
                headio.InvoiceId = customerInvoiceIODTO.InvoiceId;
                headio.RegistrationType = customerInvoiceIODTO.RegistrationType;
                headio.CustomerInvoiceNr = string.IsNullOrEmpty(customerInvoiceIODTO.CustomerInvoiceNr) ? "" : customerInvoiceIODTO.CustomerInvoiceNr?.Trim();
                headio.SeqNr = customerInvoiceIODTO.SeqNr;
                headio.OCR = customerInvoiceIODTO.OCR;
                headio.OriginType = customerInvoiceIODTO.OriginType;
                headio.OriginStatus = customerInvoiceIODTO.OriginStatus;
                headio.PaymentCondition = customerInvoiceIODTO.PaymentCondition;
                headio.CustomerNr = customerInvoiceIODTO.CustomerNr?.Trim();
                headio.CustomerName = customerInvoiceIODTO.CustomerName?.Trim();
                headio.InvoiceDate = customerInvoiceIODTO.InvoiceDate;
                headio.DueDate = customerInvoiceIODTO.DueDate;
                headio.DeliveryDate = customerInvoiceIODTO.DeliveryDate;
                headio.VoucherDate = customerInvoiceIODTO.VoucherDate;
                headio.ReferenceOur = customerInvoiceIODTO.ReferenceOur;
                headio.ReferenceYour = customerInvoiceIODTO.ReferenceYour;
                headio.CurrencyRate = customerInvoiceIODTO.CurrencyRate;
                headio.CurrencyDate = customerInvoiceIODTO.CurrencyDate;
                headio.TotalAmount = customerInvoiceIODTO.TotalAmount;
                headio.TotalAmountCurrency = customerInvoiceIODTO.TotalAmountCurrency;
                headio.SumAmount = customerInvoiceIODTO.SumAmount;
                headio.SumAmountCurrency = customerInvoiceIODTO.SumAmountCurrency;
                headio.VATAmount = customerInvoiceIODTO.VATAmount;
                headio.VATAmountCurrency = customerInvoiceIODTO.VATAmountCurrency;
                headio.PaidAmount = customerInvoiceIODTO.PaidAmount;
                headio.PaidAmountCurrency = customerInvoiceIODTO.PaidAmountCurrency;
                headio.RemainingAmount = customerInvoiceIODTO.RemainingAmount;
                headio.FreightAmount = customerInvoiceIODTO.FreightAmount;
                headio.FreightAmountCurrency = customerInvoiceIODTO.FreightAmountCurrency;
                headio.InvoiceFee = customerInvoiceIODTO.InvoiceFee;
                headio.InvoiceFeeCurrency = customerInvoiceIODTO.InvoiceFeeCurrency;
                headio.CentRounding = customerInvoiceIODTO.CentRounding;
                headio.FullyPayed = customerInvoiceIODTO.FullyPayed;
                headio.PaymentNr = customerInvoiceIODTO.PaymentNr;
                headio.VoucherNr = customerInvoiceIODTO.VoucherNr;
                headio.CreateAccountingInXE = customerInvoiceIODTO.CreateAccountingInXE;
                headio.Note = customerInvoiceIODTO.Note;
                headio.BillingType = customerInvoiceIODTO.BillingType;
                headio.Currency = customerInvoiceIODTO.Currency;
                headio.TransferType = customerInvoiceIODTO.TransferType;
                headio.BillingAddressName = customerInvoiceIODTO.BillingAddressName;
                headio.BillingAddressAddress = customerInvoiceIODTO.BillingAddressAddress;
                headio.BillingAddressCity = customerInvoiceIODTO.BillingAddressCity;
                headio.BillingAddressCO = customerInvoiceIODTO.BillingAddressCO;
                headio.DeliveryAddressName = customerInvoiceIODTO.DeliveryAddressName;
                headio.BillingAddressPostNr = customerInvoiceIODTO.BillingAddressPostNr;
                headio.DeliveryAddressCountry = customerInvoiceIODTO.DeliveryAddressCountry;
                headio.DeliveryAddressAddress = customerInvoiceIODTO.DeliveryAddressAddress;
                headio.DeliveryAddressCity = customerInvoiceIODTO.DeliveryAddressCity;
                headio.DeliveryAddressPostNr = customerInvoiceIODTO.DeliveryAddressPostNr;
                headio.UseFixedPriceArticle = customerInvoiceIODTO.UseFixedPriceArticle;
                headio.VatRate1 = customerInvoiceIODTO.VatRate1;
                headio.VatRate2 = customerInvoiceIODTO.VatRate2;
                headio.VatRate3 = customerInvoiceIODTO.VatRate3;
                headio.VatAmount1 = customerInvoiceIODTO.VatAmount1;
                headio.VatAmount2 = customerInvoiceIODTO.VatAmount2;
                headio.VatAmount3 = customerInvoiceIODTO.VatAmount3;
                headio.VatType = customerInvoiceIODTO.VatType;
                headio.PaymentConditionCode = customerInvoiceIODTO.PaymentConditionCode;
                headio.InvoiceDeliveryType = customerInvoiceIODTO.InvoiceDeliveryType;
                headio.SalesAccountNr = customerInvoiceIODTO.SaleAccountNr;
                headio.SalesAccountNrDim2 = customerInvoiceIODTO.SaleAccountNrDim2;
                headio.SalesAccountNrDim3 = customerInvoiceIODTO.SaleAccountNrDim3;
                headio.SalesAccountNrDim4 = customerInvoiceIODTO.SaleAccountNrDim4;
                headio.SalesAccountNrDim5 = customerInvoiceIODTO.SaleAccountNrDim5;
                headio.SalesAccountNrDim6 = customerInvoiceIODTO.SaleAccountNrDim6;
                headio.ClaimAccountNr = customerInvoiceIODTO.ClaimAccountNr;
                headio.ClaimAccountNrDim2 = customerInvoiceIODTO.ClaimAccountNrDim2;
                headio.ClaimAccountNrDim3 = customerInvoiceIODTO.ClaimAccountNrDim3;
                headio.ClaimAccountNrDim4 = customerInvoiceIODTO.ClaimAccountNrDim4;
                headio.ClaimAccountNrDim5 = customerInvoiceIODTO.ClaimAccountNrDim5;
                headio.ClaimAccountNrDim6 = customerInvoiceIODTO.ClaimAccountNrDim6;
                headio.VatAccountnr = customerInvoiceIODTO.VatAccountNr;
                headio.OfferNr = customerInvoiceIODTO.OfferNr;
                headio.OrderNr = customerInvoiceIODTO.OrderNr;
                headio.ContractNr = customerInvoiceIODTO.ContractNr;
                headio.WorkingDescription = customerInvoiceIODTO.WorkingDescription;
                headio.InternalDescription = customerInvoiceIODTO.InternalDescription;
                headio.ExternalDescription = customerInvoiceIODTO.ExternalDescription;
                headio.ProjectNr = customerInvoiceIODTO.ProjectNr;
                headio.NextContractPeriodYear = customerInvoiceIODTO.NextContractPeriodYear;
                headio.NextContractPeriodValue = customerInvoiceIODTO.NextContractPeriodValue;
                headio.NextContractPeriodDate = customerInvoiceIODTO.NextContractPeriodDate;
                headio.ContractGroupId = customerInvoiceIODTO.ContractGroupId;
                headio.ContractGroupInterval = customerInvoiceIODTO.ContractGroupInterval;
                headio.ContractGroupName = customerInvoiceIODTO.ContractGroupName;
                headio.ContractGroupDayInMonth = customerInvoiceIODTO.ContractGroupDayInMonth;
                headio.ContractGroupOrderTemplate = customerInvoiceIODTO.ContractGroupOrderTemplate;
                headio.ContractGroupInvoiceTemplate = customerInvoiceIODTO.ContractGroupInvoiceTemplate;
                headio.ContractGroupDecription = customerInvoiceIODTO.ContractGroupDecription;
                headio.ContractGroupPeriod = customerInvoiceIODTO.ContractGroupPeriod;
                headio.ContractGroupPriceManagementName = customerInvoiceIODTO.ContractGroupPriceManagementName;
                headio.ContractGroupInvoiceText = customerInvoiceIODTO.ContractGroupInvoiceText;
                headio.ContractGroupInvoiceRowText = customerInvoiceIODTO.ContractGroupInvoiceRowText;
                headio.InvoiceLabel = customerInvoiceIODTO.InvoiceLabel;
                headio.InvoiceHeadText = customerInvoiceIODTO.InvoiceHeadText;
                headio.ExternalId = customerInvoiceIODTO.ExternalId;
                headio.Email = customerInvoiceIODTO.Email;
                headio.CreateDeliveryAddressAsTextOnly = customerInvoiceIODTO.CreateDeliveryAddressAsTextOnly;
                headio.PriceListTypeId = customerInvoiceIODTO.PriceListTypeId;
                headio.ProjectId = customerInvoiceIODTO.ProjectId == 0 ? null : customerInvoiceIODTO.ProjectId.ToNullable();
                headio.AutoCreateCustomer = customerInvoiceIODTO.AutoCreateCustomer;
                headio.CustomerExternalNr = customerInvoiceIODTO.CustomerExternalNr;
                headio.CustomerOrgNr = string.IsNullOrEmpty(customerInvoiceIODTO.CustomerOrgnr) ? null : customerInvoiceIODTO.CustomerOrgnr;
                headio.CustomerGlnNr = string.IsNullOrEmpty(customerInvoiceIODTO.CustomerGlnNr) ? null : customerInvoiceIODTO.CustomerGlnNr;
                headio.InvoiceDeliveryType = customerInvoiceIODTO.InvoiceDeliveryType;

                if (customerInvoiceIODTO.RegistrationType == (int)OrderInvoiceRegistrationType.Contract)
                {
                    string contractGroupName = !string.IsNullOrEmpty(customerInvoiceIODTO.ContractGroupName) ? customerInvoiceIODTO.ContractGroupName : !string.IsNullOrEmpty(customerInvoiceIODTO.ContractGroupPeriod) ? customerInvoiceIODTO.ContractGroupPeriod : string.Empty;
                    contractGroupName = customerInvoiceIODTO.ContractGroupInterval.HasValue ? customerInvoiceIODTO.ContractGroupInterval.Value + contractGroupName : contractGroupName;


                    if (customerInvoiceIODTO.ContractGroupId.HasValue && customerInvoiceIODTO.ContractGroupId != 0)
                    {
                        headio.ContractGroupId = customerInvoiceIODTO.ContractGroupId;
                    }
                    else
                    {
                        if (contractGroups.Any(g => g.Name.ToLower() == contractGroupName.ToLower()))
                            headio.ContractGroupId = contractGroups.FirstOrDefault(g => g.Name.ToLower() == contractGroupName.ToLower())?.ContractGroupId;

                        if (!headio.ContractGroupId.HasValue && customerInvoiceIODTO.ContractGroupInterval.HasValue && contractGroups.Any(g => g.Interval == customerInvoiceIODTO.ContractGroupInterval.Value))
                            headio.ContractGroupId = contractGroups.FirstOrDefault(g => g.Name.ToLower() == customerInvoiceIODTO.ContractGroupName.ToLower())?.ContractGroupId;
                    }
                }

                if (headio.RegistrationType == (int)OrderInvoiceRegistrationType.Unknown && customerInvoiceIODTO.OriginType == (int)SoeOriginType.CustomerInvoice && customerInvoiceIODTO.InvoiceRows.Any(r => r.CustomerRowType == SoeInvoiceRowType.ProductRow))
                    headio.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;

                // Special cases logic
                if (headio.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice && headio.OriginStatus == (int)SoeOriginStatus.Voucher && headio.TotalAmount == 0 && headio.PaidAmount > 0)
                {
                    headio.FullyPayed = true;
                    headio.TotalAmount = headio.PaidAmount.Value + headio.VATAmount ?? 0;
                    headio.TotalAmountCurrency = headio.PaidAmountCurrency ?? + +headio.VATAmountCurrency ?? 0;
                }

                // Partly payed - (set VAT to zero and totalamount to remainingamount, if specialfunctionality contains clearvatonremaining)
                if (dictSpecialFunctionality != null && dictSpecialFunctionality.Keys.Any(k => k.ToLower().Equals("clearvatonremaining")) &&
                    headio.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice &&
                    headio.RemainingAmount != null && headio.RemainingAmount != 0 && headio.TotalAmount != headio.RemainingAmount)
                {
                    headio.TotalAmount = headio.RemainingAmount;
                    headio.VATAmount = 0;
                    headio.VATAmountCurrency = 0;
                }

                #region Try to fill null amounts

                if (!headio.TotalAmountCurrency.HasValue && headio.TotalAmount.HasValue)
                    headio.TotalAmountCurrency = headio.TotalAmount;

                if (!headio.VATAmountCurrency.HasValue && headio.VATAmount.HasValue)
                    headio.VATAmountCurrency = headio.VATAmount;

                if (!headio.PaidAmountCurrency.HasValue && headio.PaidAmount.HasValue)
                    headio.PaidAmountCurrency = headio.PaidAmount;

                if (!headio.SumAmountCurrency.HasValue && headio.SumAmount.HasValue)
                    headio.SumAmountCurrency = headio.SumAmount;

                #endregion

                #endregion

                if (Enum.IsDefined(typeof(SoeOriginType), headio.OriginType) && headio.OriginType != (int)SoeOriginType.None &&
                    Enum.IsDefined(typeof(OrderInvoiceRegistrationType), headio.RegistrationType) && headio.RegistrationType != (int)OrderInvoiceRegistrationType.Unknown &&
                    (!headio.BillingType.HasValue || Enum.IsDefined(typeof(TermGroup_BillingType), headio.BillingType)))
                {
                    if (headio.CustomerInvoiceNr != string.Empty && !updateExistingInvoice)
                    {
                        var invoice = InvoiceManager.GetCustomerInvoiceByNr(entities, headio.CustomerInvoiceNr, (SoeOriginType)headio.OriginType, (OrderInvoiceRegistrationType)headio.RegistrationType, actorCompanyId, false);
                        if (invoice != null)
                        {
                            headio.InvoiceId = invoice.InvoiceId;
                            headio.Status = (int)TermGroup_IOStatus.Processed;
                            headio.ErrorMessage = GetText(8429, "Fakturanr finns redan");
                        }
                    }
                }
                else
                {
                    var billing = headio.BillingType.HasValue ? headio.BillingType.ToString() : "";
                    headio.ErrorMessage = $"Mandatory enum is not set. Origin:{headio.OriginType},RegistrationType:{headio.RegistrationType},BillingType:{billing}";
                }

                foreach (var customerInvoiceRowIODTO in customerInvoiceIODTO.InvoiceRows)
                {
                    CreateCustomerInvoiceRowIO(headType, source, type, batchId, importId, actorCompanyId, customerInvoiceRowIODTO, headio);
                }

            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                headio.Status = (int)TermGroup_IOStatus.Error;
                headio.ErrorMessage = GetText(8383, "Okänt fel, kunde inte spara all rådata");
            }

            #endregion

            return headio;
        }

        #endregion

        #endregion

        #region ProjectIO

        public ActionResult ImportProjectIO(ProjectIOItem projectIOItem, TermGroup_IOImportHeadType headType, TermGroup_IOSource termGroup_IOSource, TermGroup_IOType termGroup_IOType, int actorCompanyId, bool importToProject, int importId)
        {
            ActionResult result = new ActionResult();
            var customerIOs = new List<ProjectIO>();

            #region Init

            string batchId = GenerateBatchId();

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    foreach (var project in projectIOItem.Projects)
                    {
                        ProjectIO projectIO = CreateProjectIO(entities, headType, termGroup_IOSource, termGroup_IOType, project, batchId, importId, actorCompanyId);
                        if (projectIO != null)
                            customerIOs.Add(projectIO);
                    }

                    //Save
                    result = SaveChanges(entities);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportCustomerIO(CustomerIOItem customerIOItem): ");
                }
            }

            if (result.Success && importToProject)
            {
                List<ProjectIO> ios = new List<ProjectIO>();

                foreach (var io in customerIOs)
                {
                    io.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    ios.Add(io);
                }

                result = ImportFromProjectIO(ios, actorCompanyId);
            }

            result.StringValue = batchId;

            return result;
        }

        public List<ProjectIO> GetProjectIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceHeadIO.NoTracking();
            var query = (from io in entities.ProjectIO
                         where io.ActorCompanyId == actorCompanyId &&
                         io.BatchId == batchId
                         orderby io.ProjectIOId
                         select io);

            if (type != TermGroup_IOType.Unknown)
                query.Where(io => io.Type == (int)type);
            if (source != TermGroup_IOSource.Unknown)
                query.Where(io => io.Source == (int)source);

            List<ProjectIO> ios = query.ToList();
            if (!ios.IsNullOrEmpty())
            {
                int langId = GetLangId();
                Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);

                foreach (var io in ios)
                {
                    io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : string.Empty;
                }
            }

            return ios;
        }

        private ProjectIO CreateProjectIO(CompEntities entities, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, ProjectIODTO projectIODTO, string batchId, int importId, int actorCompanyId)
        {
            #region Prereq

            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

            ProjectIO headIO = new ProjectIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
                ImportId = importId,
            };
            SetCreatedProperties(headIO);
            entities.ProjectIO.AddObject(headIO);

            #endregion

            #region Perform

            if (projectIODTO != null)
            {
                try
                {
                    if (accountSiedim1 != null && projectIODTO.AccountNrSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 2:
                                projectIODTO.AccountDim2Nr = projectIODTO.AccountNrSieDim1;
                                break;
                            case 3:
                                projectIODTO.AccountDim2Nr = projectIODTO.AccountNrSieDim1;
                                break;
                            case 4:
                                projectIODTO.AccountDim3Nr = projectIODTO.AccountNrSieDim1;
                                break;
                            case 5:
                                projectIODTO.AccountDim5Nr = projectIODTO.AccountNrSieDim1;
                                break;
                            case 6:
                                projectIODTO.AccountDim6Nr = projectIODTO.AccountNrSieDim1;
                                break;
                        }
                    }
                    if (accountSiedim6 != null && projectIODTO.AccountNrSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 2:
                                projectIODTO.AccountDim2Nr = projectIODTO.AccountNrSieDim6;
                                break;
                            case 3:
                                projectIODTO.AccountDim2Nr = projectIODTO.AccountNrSieDim6;
                                break;
                            case 4:
                                projectIODTO.AccountDim3Nr = projectIODTO.AccountNrSieDim6;
                                break;
                            case 5:
                                projectIODTO.AccountDim5Nr = projectIODTO.AccountNrSieDim6;
                                break;
                            case 6:
                                projectIODTO.AccountDim6Nr = projectIODTO.AccountNrSieDim6;
                                break;
                        }
                    }
                    #region Fill ProjectIO

                    headIO.StatusName = projectIODTO.StatusName;
                    headIO.AccountNr = projectIODTO.AccountNr;
                    headIO.AccountDim2Nr = projectIODTO.AccountDim2Nr;
                    headIO.AccountDim3Nr = projectIODTO.AccountDim3Nr;
                    headIO.AccountDim4Nr = projectIODTO.AccountDim4Nr;
                    headIO.AccountDim5Nr = projectIODTO.AccountDim5Nr;
                    headIO.AccountDim6Nr = projectIODTO.AccountDim6Nr;
                    headIO.AllocationType = projectIODTO.AllocationType;
                    headIO.BookAccordingToThisProject = projectIODTO.BookAccordingToThisProject;
                    headIO.CategoryCode1 = projectIODTO.CategoryCode1;
                    headIO.CategoryCode2 = projectIODTO.CategoryCode2;
                    headIO.CategoryCode3 = projectIODTO.CategoryCode3;
                    headIO.CategoryCode4 = projectIODTO.CategoryCode4;
                    headIO.CategoryCode5 = projectIODTO.CategoryCode5;
                    headIO.CategoryCode6 = projectIODTO.CategoryCode6;
                    headIO.CategoryCode7 = projectIODTO.CategoryCode7;
                    headIO.CategoryCode8 = projectIODTO.CategoryCode8;
                    headIO.CategoryCode9 = projectIODTO.CategoryCode9;
                    headIO.Created = projectIODTO.Created;
                    headIO.CreatedBy = projectIODTO.CreatedBy;
                    headIO.CustomerNr = projectIODTO.CustomerNr;
                    headIO.Description = projectIODTO.Description;
                    headIO.Modified = projectIODTO.Modified;
                    headIO.ModifiedBy = projectIODTO.ModifiedBy;
                    headIO.Name = projectIODTO.Name;
                    headIO.Note = projectIODTO.Note;
                    headIO.ParentProjectNr = projectIODTO.ParentProjectNr;
                    headIO.ParticipantEmployeeNr1 = projectIODTO.ParticipantEmployeeNr1;
                    headIO.ParticipantEmployeeNr2 = projectIODTO.ParticipantEmployeeNr2;
                    headIO.ParticipantEmployeeNr3 = projectIODTO.ParticipantEmployeeNr3;
                    headIO.ParticipantEmployeeNr4 = projectIODTO.ParticipantEmployeeNr4;
                    headIO.ParticipantEmployeeNr5 = projectIODTO.ParticipantEmployeeNr5;
                    headIO.ParticipantEmployeeNr6 = projectIODTO.ParticipantEmployeeNr6;
                    headIO.ProjectIOId = projectIODTO.ProjectIOId;
                    headIO.ProjectNr = projectIODTO.ProjectNr;
                    headIO.StartDate = projectIODTO.StartDate;
                    headIO.State = projectIODTO.State;
                    headIO.StopDate = projectIODTO.StopDate;
                    headIO.ErrorMessage = projectIODTO.ErrorMessage;

                    #endregion


                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    headIO.Status = (int)TermGroup_IOStatus.Error;
                    headIO.ErrorMessage = GetText(8383, "Okänt fel, kunde inte spara all rådata");
                }
            }

            #endregion

            return headIO;
        }

        public ActionResult UpdateProjectIO(List<ProjectIODTO> dtos)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (ProjectIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        ProjectIO io = GetProjectIO(entities, dto.ProjectIOId);
                        if (io != null)
                        {
                            #region Convert from dto

                            io.AccountDim2Nr = dto.AccountDim2Nr;
                            io.AccountDim3Nr = dto.AccountDim3Nr;
                            io.AccountDim4Nr = dto.AccountDim4Nr;
                            io.AccountDim5Nr = dto.AccountDim5Nr;
                            io.AccountDim6Nr = dto.AccountDim6Nr;
                            io.AccountNr = dto.AccountNr;
                            io.ActorCompanyId = dto.ActorCompanyId;
                            io.AllocationType = dto.AllocationType;
                            io.BatchId = dto.BatchId;
                            io.BookAccordingToThisProject = dto.BookAccordingToThisProject;
                            io.CategoryCode1 = dto.CategoryCode1;
                            io.CategoryCode2 = dto.CategoryCode2;
                            io.CategoryCode3 = dto.CategoryCode3;
                            io.CategoryCode4 = dto.CategoryCode4;
                            io.CategoryCode5 = dto.CategoryCode5;
                            io.CategoryCode6 = dto.CategoryCode6;
                            io.CategoryCode7 = dto.CategoryCode7;
                            io.CategoryCode8 = dto.CategoryCode8;
                            io.CategoryCode9 = dto.CategoryCode9;
                            io.Created = dto.Created;
                            io.CreatedBy = dto.CreatedBy;
                            io.CustomerNr = dto.CustomerNr;
                            io.Description = dto.Description;
                            io.Import = dto.Import;
                            io.Modified = dto.Modified;
                            io.ModifiedBy = dto.ModifiedBy;
                            io.Name = dto.Name;
                            io.Note = dto.Note;
                            io.ParentProjectNr = dto.ParentProjectNr;
                            io.ParticipantEmployeeNr1 = dto.ParticipantEmployeeNr1;
                            io.ParticipantEmployeeNr2 = dto.ParticipantEmployeeNr2;
                            io.ParticipantEmployeeNr3 = dto.ParticipantEmployeeNr3;
                            io.ParticipantEmployeeNr4 = dto.ParticipantEmployeeNr4;
                            io.ParticipantEmployeeNr5 = dto.ParticipantEmployeeNr5;
                            io.ParticipantEmployeeNr6 = dto.ParticipantEmployeeNr6;
                            io.ProjectIOId = dto.ProjectIOId;
                            io.ProjectNr = dto.ProjectNr;
                            io.Source = dto.Source;
                            io.StartDate = dto.StartDate;
                            io.State = dto.State;
                            io.Status = dto.Status;
                            io.StopDate = dto.StopDate;
                            io.Type = dto.Type;
                            io.StatusName = dto.StatusName;

                            #endregion

                            SetModifiedProperties(io);
                        }
                    }

                    // Save
                    result = SaveChanges(entities);

                    #endregion
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        private ProjectIO GetProjectIO(CompEntities entities, int projectIOId)
        {
            return (from io in entities.ProjectIO
                    where io.ProjectIOId == projectIOId
                    select io).FirstOrDefault();
        }

        public List<ProjectIODTO> GetProjectIODTOs(int actorCompanyId, string search = "", string projectNumberFrom = "", string projectNumberTo = "", bool onlyActive = true)
        {
            List<ProjectIODTO> projectIODTOs = new List<ProjectIODTO>();

            List<Project> projects = ProjectManager.GetProjectsByNumberSearch(actorCompanyId, search, int.MaxValue);

            if (!string.IsNullOrEmpty(projectNumberFrom) || !string.IsNullOrEmpty(projectNumberTo))
                projects = projects.Where(p => StringUtility.IsInInterval(p.Number, projectNumberFrom, projectNumberTo)).ToList();

            List<AccountDTO> accounts = AccountManager.GetAccounts(actorCompanyId).ToDTOs(false, false);
            List<AccountDimDTO> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId).ToDTOs(false, false);
            var categoryRecords = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Project, SoeCategoryRecordEntity.Project, actorCompanyId);

            foreach (var project in projects)
            {
                var account = accounts?.FirstOrDefault(a => a.AccountNr.ToLower().Equals(project.ProjectAccountStd.FirstOrDefault(p => p.Type == (int)ProjectAccountType.Credit)));
                var accountInternals = project.ProjectAccountStd.FirstOrDefault(p => p.Type == (int)ProjectAccountType.Credit)?.AccountInternal.ToDTOs() ?? new List<AccountInternalDTO>();
                var AccountAndInternalAccountComboDTO = accountInternals.ToList().GetInternalAccountDimNrs(accountDims, accounts);
                var parentProject = project.ParentProjectId.HasValue ? ProjectManager.GetProjectSmall(actorCompanyId, project.ParentProjectId.Value) : null;

                var categories = CategoryManager.GetCategories(categoryRecords, project.ProjectId);
                CategoryComboDTO categoryComboDTO = categories.GetCategoryComboDTO();

                var projectIODTO = new ProjectIODTO()
                {
                    ProjectIOId = 0,
                    ProjectId = project.ProjectId,
                    ProjectNr = project.Number,
                    StatusName = project.StatusName,
                    AccountNr = account != null ? account.AccountNr : string.Empty,
                    AccountDim2Nr = AccountAndInternalAccountComboDTO.Dim2Nr,
                    AccountDim3Nr = AccountAndInternalAccountComboDTO.Dim3Nr,
                    AccountDim4Nr = AccountAndInternalAccountComboDTO.Dim4Nr,
                    AccountDim5Nr = AccountAndInternalAccountComboDTO.Dim5Nr,
                    AccountDim6Nr = AccountAndInternalAccountComboDTO.Dim6Nr,
                    ActorCompanyId = project.ActorCompanyId,
                    AllocationType = project.AllocationType,
                    BatchId = string.Empty,
                    BookAccordingToThisProject = project.UseAccounting,
                    CategoryCode1 = !string.IsNullOrEmpty(categoryComboDTO.Category1Code) ? categoryComboDTO.Category1Code + " " + categoryComboDTO.Category1Name : string.Empty,
                    CategoryCode2 = !string.IsNullOrEmpty(categoryComboDTO.Category2Code) ? categoryComboDTO.Category2Code + " " + categoryComboDTO.Category2Name : string.Empty,
                    CategoryCode3 = !string.IsNullOrEmpty(categoryComboDTO.Category3Code) ? categoryComboDTO.Category3Code + " " + categoryComboDTO.Category3Name : string.Empty,
                    CategoryCode4 = !string.IsNullOrEmpty(categoryComboDTO.Category4Code) ? categoryComboDTO.Category4Code + " " + categoryComboDTO.Category4Name : string.Empty,
                    CategoryCode5 = !string.IsNullOrEmpty(categoryComboDTO.Category5Code) ? categoryComboDTO.Category5Code + " " + categoryComboDTO.Category5Name : string.Empty,
                    CategoryCode6 = !string.IsNullOrEmpty(categoryComboDTO.Category6Code) ? categoryComboDTO.Category6Code + " " + categoryComboDTO.Category6Name : string.Empty,
                    CategoryCode7 = !string.IsNullOrEmpty(categoryComboDTO.Category7Code) ? categoryComboDTO.Category7Code + " " + categoryComboDTO.Category7Name : string.Empty,
                    CategoryCode8 = !string.IsNullOrEmpty(categoryComboDTO.Category8Code) ? categoryComboDTO.Category8Code + " " + categoryComboDTO.Category8Name : string.Empty,
                    CategoryCode9 = !string.IsNullOrEmpty(categoryComboDTO.Category9Code) ? categoryComboDTO.Category9Code + " " + categoryComboDTO.Category9Name : string.Empty,
                    CategoryIds = !categories.IsNullOrEmpty() ? categories.Select(c => c.CategoryId).ToList() : new List<int>(),
                    Created = project.Created,
                    CreatedBy = project.CreatedBy,
                    CustomerNr = project.Customer?.CustomerNr ?? string.Empty,
                    Description = project.Description,
                    Import = false,
                    Modified = project.Modified,
                    ModifiedBy = project.ModifiedBy,
                    Name = project.Name,
                    Note = project.Note,
                    ParentProjectNr = parentProject != null ? parentProject.Number : string.Empty,
                    ParticipantEmployeeNr1 = string.Empty,
                    ParticipantEmployeeNr2 = string.Empty,
                    ParticipantEmployeeNr3 = string.Empty,
                    ParticipantEmployeeNr4 = string.Empty,
                    ParticipantEmployeeNr5 = string.Empty,
                    ParticipantEmployeeNr6 = string.Empty,
                    Source = 0,
                    StartDate = project.StartDate,
                    State = project.State,
                    Status = project.Status,
                    StopDate = project.StopDate,
                    Type = project.Type,
                    ErrorMessage = string.Empty,
                };

                projectIODTOs.Add(projectIODTO);
            }

            return projectIODTOs;
        }


        public ActionResult ImportProjectIO(List<int> projectIOIds, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    List<ProjectIO> ios = (from io in entities.ProjectIO
                                           where projectIOIds.Contains(io.ProjectIOId)
                                           select io).ToList();

                    foreach (ProjectIO io in ios)
                    {
                        io.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    }

                    return ImportFromProjectIO(ios, actorCompanyId);
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(ex);
                }
            }
        }

        private ActionResult ImportFromProjectIO(List<ProjectIO> ios, int actorCompanyId)
        {
            if (ios == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ProjectIO");

            ActionResult result = new ActionResult();

            #region Init

            int counter = ios.Count;
            int counterTransferred = 0;
            int counterErrorOccurred = 0;

            #endregion

            #region Prereq

            // Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<Account> accounts = GetCompanyAccountsWithAccountDim(entitiesReadOnly, actorCompanyId);
            List<Category> categories = CategoryManager.GetCategories(SoeCategoryType.Project, actorCompanyId);

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            this.rowNr = 0;
            var projectIdList = new Dictionary<int, string>();
            #endregion

            try
            {
                ios = ios.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing).ToList();

                #region Perform

                var projectIOs = ios.OrderBy(g => g.ParentProjectNr).ToList();


                foreach (var io in projectIOs)
                {
                    ActionResult transferedResult = ImportFromProjectIO(io, actorCompanyId, accounts, categories);
                    using (CompEntities entities = new CompEntities())
                    {
                        var io2 = entities.ProjectIO.FirstOrDefault(i => i.ProjectNr == io.ProjectNr);
                        if (io2 == null)
                            continue;

                        if (!transferedResult.Success)
                        {
                            io2.Status = (int)TermGroup_IOStatus.Error;
                            io2.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                            counterErrorOccurred++;
                        }
                        else
                        {
                            counterTransferred++;
                            io2.Status = (int)TermGroup_IOStatus.Processed;
                            io2.ErrorMessage = "";
                            projectIdList.Add(transferedResult.IntegerValue, io.ProjectNr);
                        }

                        result = SaveChanges(entities);
                        if (!result.Success)
                            return result;
                    }
                }

                #endregion
            }
            catch (Exception e)
            {
                result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                base.LogError(e, this.log);
            }

            result.InfoMessage = string.Format(GetText(9149, "{0} Projekt utav {1} har skapats/uppdaterats."), counterTransferred, counter);
            result.SuccessNumber = counterTransferred;

            result.StrDict = projectIdList;
            result.StringValue = string.Format("{0},{1}", counterTransferred, counterErrorOccurred);
            return result;
        }

        private ActionResult ImportFromProjectIO(ProjectIO io, int actorCompanyId, List<Account> accounts, List<Category> categories)
        {
            if (io == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull);

            try
            {
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                ActionResult result = ProjectManager.ConvertToProjectDTO(entitiesReadOnly, io, accounts, actorCompanyId, out TimeProjectDTO dto);
                if (!result.Success)
                    return result;

                var accountingSettings = new List<AccountingSettingDTO>();

                Func<string, CompanyCategoryRecordDTO> getCatFromCode = (string code) =>
                {
                    return new CompanyCategoryRecordDTO()
                    {
                        ActorCompanyId = actorCompanyId,
                        CategoryId = categories.Where(c => c.Code.ToLower() == code.ToString()).Select(c => c.CategoryId).FirstOrDefault(),
                        Entity = SoeCategoryRecordEntity.Project,
                    };
                };

                var catDTOs = new List<CompanyCategoryRecordDTO>();
                if (io.CategoryCode1.HasValue())
                    catDTOs.Add(getCatFromCode(io.CategoryCode1));
                if (io.CategoryCode2.HasValue())
                    catDTOs.Add(getCatFromCode(io.CategoryCode2));
                if (io.CategoryCode3.HasValue())
                    catDTOs.Add(getCatFromCode(io.CategoryCode3));
                if (io.CategoryCode4.HasValue())
                    catDTOs.Add(getCatFromCode(io.CategoryCode4));
                if (io.CategoryCode5.HasValue())
                    catDTOs.Add(getCatFromCode(io.CategoryCode5));
                if (io.CategoryCode6.HasValue())
                    catDTOs.Add(getCatFromCode(io.CategoryCode6));

                if (io.AccountNr.HasValue())
                {
                    accountingSettings.Add(new AccountingSettingDTO()
                    {
                        DimNr = 1,
                        Account1Nr = io.AccountNr,
                    });
                }
                if (io.AccountDim2Nr.HasValue())
                {
                    accountingSettings.Add(new AccountingSettingDTO()
                    {
                        DimNr = 2,
                        Account2Nr = io.AccountDim2Nr,
                    });
                }
                if (io.AccountDim3Nr.HasValue())
                {
                    accountingSettings.Add(new AccountingSettingDTO()
                    {
                        DimNr = 3,
                        Account3Nr = io.AccountDim3Nr,
                    });
                }

                dto.PayrollProductAccountingPrio = "0,0,0,0,0";
                dto.InvoiceProductAccountingPrio = "0,0,0,0,0";

                // Error check non nullable columns
                if (dto.PayrollProductAccountingPrio == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "PayrollProductAccountingPrio is null");
                if (dto.InvoiceProductAccountingPrio == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "InvoiceProductAccountingPrio is null");

                result = ProjectManager.SaveTimeProject(dto, catDTOs, accountingSettings, actorCompanyId);
                if (!result.Success)
                    result.ErrorMessage = result.GetErrorMsg();

                return result;
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                return new ActionResult(ex);
            }
        }

        #endregion

        #region SupplierIO

        #region Import To SupplierIO

        public ActionResult ImportSupplierIO(SupplierIOItem supplierIOItem, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool importToSupplier)
        {
            ActionResult result = null;
            List<SupplierIO> supplierIOs = new List<SupplierIO>();

            #region Init

            string batchId = GenerateBatchId();

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    foreach (var supplier in supplierIOItem.Suppliers)
                    {
                        SupplierIO supplierIO = CreateSupplierIO(entities, headType, source, type, supplier, batchId, actorCompanyId);
                        if (supplierIO != null)
                            supplierIOs.Add(supplierIO);
                    }

                    //Save
                    result = SaveChanges(entities);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportSupplierIO(SupplierIOItem supplierIOItem): ");
                }
            }

            if (result.Success && importToSupplier)
                result = ImportFromSupplierIO(supplierIOs, actorCompanyId);

            result.StringValue = batchId;

            return result;
        }

        #endregion

        #region Import From SupplierIO

        public ActionResult ImportSupplierIO(List<int> iosIds, int actorCompanyId)
        {
            try
            {
                using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                List<SupplierIO> supplierIOs = (from io in entitiesReadOnly.SupplierIO
                                                where iosIds.Contains(io.SupplierIOId)
                                                select io).ToList();

                foreach (SupplierIO supplierIO in supplierIOs)
                {
                    supplierIO.Status = (int)TermGroup_IOStatus.UnderProcessing;
                }

                return ImportFromSupplierIO(supplierIOs, actorCompanyId);
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                return new ActionResult(ex);
            }
        }

        public ActionResult ImportFromSupplierIO(List<SupplierIO> supplierIOs, int actorCompanyId)
        {
            if (supplierIOs == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "SupplierIO");

            ActionResult result = new ActionResult();
            #region Init

            int counter = supplierIOs.Count;
            int counterTransferred = 0;
            int counterErrorOccurred = 0;
            #endregion

            #region Prereq

            // Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            this.rowNr = 0;

            List<SysCountry> sysCountries = CountryCurrencyManager.GetSysCountries(true);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (SupplierIO io in supplierIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing))
                    {
                        #region SupplierIO

                        SupplierIO supplierIO = entities.SupplierIO.FirstOrDefault(i => i.SupplierIOId == io.SupplierIOId);
                        if (supplierIO == null)
                            continue;

                        ActionResult transferedResult = ImportFromSupplierIO(entities, supplierIO, actorCompanyId, sysCountries);
                        if (!transferedResult.Success)
                        {
                            supplierIO.Status = (int)TermGroup_IOStatus.Error;
                            supplierIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                            counterErrorOccurred++;
                            return transferedResult;
                        }

                        counterTransferred++;

                        result = SaveChanges(entities);
                        if (!result.Success)
                            return result;

                        #endregion
                    }

                    #endregion
                }
                catch (Exception e)
                {
                    result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                    base.LogError(e, this.log);
                }
                finally
                {
                    entities.Connection.Close();
                }
            }

            result.InfoMessage = string.Format(GetText(8400, "{0} leverantörer utav {1} har skapats/uppdaterats."), counterTransferred, counter);
            result.SuccessNumber = counterTransferred;
            result.StringValue = string.Format("{0},{1}", counterTransferred, counterErrorOccurred);

            return result;
        }

        public ActionResult ImportFromSupplierIO(CompEntities entities, SupplierIO supplierIO, int actorCompanyId, List<SysCountry> sysCountries)
        {
            ActionResult result = null;

            using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    #region SupplierIO

                    #region Init

                    this.rowNr++;
                    supplierIO.ErrorMessage = string.Empty;
                    bool newSupplier = false;

                    #endregion

                    #region Validation

                    #region Validate mandatory values

                    if (String.IsNullOrEmpty(supplierIO.SupplierNr) || String.IsNullOrEmpty(supplierIO.Name))
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8384, "Leveratörsnr eller leverantörsnamn ej angiven"));
                        return result;
                    }

                    #endregion

                    #region Validate Vat

                    //Validate VatType
                    if (!EnumUtility.GetValue(supplierIO.VatType, out _, typeof(TermGroup_InvoiceVatType)))
                        supplierIO.VatType = (int)TermGroup_InvoiceVatType.None;

                    //VatCode
                    int? vatCodeid = null;
                    if (supplierIO.VATCodeNr.HasValue())
                    {
                        var vatCode = AccountManager.GetVatCodeByCode(entities, actorCompanyId, supplierIO.VATCodeNr) ?? AccountManager.GetVatCodeByCode(entities, actorCompanyId, supplierIO.VATCodeNr.TrimStart('0'));
                        if (vatCode != null)
                            vatCodeid = vatCode.VatCodeId;
                    }

                    #endregion

                    #endregion

                    #region Validate currency

                    int currencyId = GetCurrencyId(entities, supplierIO.Currency);
                    if (currencyId == 0)
                    {
                        CompCurrency baseCurrency = (from c in entities.CompCurrency
                                                     where c.ActorCompanyId == actorCompanyId &&
                                                     c.BaseCurrency
                                                     select c).FirstOrDefault();
                        if (baseCurrency != null)
                            currencyId = baseCurrency.CurrencyId;
                    }

                    if (currencyId == 0)
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8398, "Valuta kunde int bestämmas"));
                        return result;
                    }

                    #endregion

                    #region Validate state

                    if (EnumUtility.GetValue(supplierIO.State, out int state, typeof(SoeEntityState)))
                    {
                        // Only valid is: Active or Inactive
                        if (state != (int)SoeEntityState.Active && state != (int)SoeEntityState.Inactive)
                        {
                            AddWarning(WarningMessageType.OptionalFieldInvalid, "State:" + supplierIO.State.ToString());
                            state = (int)SoeEntityState.Active;
                        }
                    }
                    else
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8387, "Aktiv/ej aktiv kan inte bestämmas"));
                        return result;
                    }

                    #endregion

                    #region Supplier

                    // Use SupplierId if passed, otherwise SupplierNr
                    Supplier supplier = null;
                    if (supplierIO.SupplierId.HasValue && supplierIO.SupplierId.Value > 0)
                        supplier = SupplierManager.GetSupplier(entities, supplierIO.SupplierId.Value, actorCompanyId: actorCompanyId);
                    else
                        supplier = SupplierManager.GetSupplierBySupplierNr(entities, actorCompanyId, supplierIO.SupplierNr, true);

                    if (supplier == null)
                    {
                        #region Add

                        newSupplier = true;

                        // Add Supplier
                        supplier = new Supplier()
                        {
                            ActorCompanyId = actorCompanyId,
                            SupplierNr = supplierIO.SupplierNr,
                            Name = supplierIO.Name,

                            //FK
                            CurrencyId = currencyId,
                        };
                        SetCreatedProperties(supplier);


                        Actor actor1 = new Actor()
                        {
                            ActorType = (int)SoeActorType.Supplier,

                            //Set references
                            Supplier = supplier,
                        };

                        result = AddEntityItem(entities, actor1, "Actor");
                        if (!result.Success)
                            return result;

                        #region TrackChanges

                        supplierIO.SupplierId = supplier.ActorSupplierId;
                        result = SupplierManager.SaveTrackChangesFromIO(entities, transaction, supplierIO, null, TermGroup_TrackChangesAction.Insert, actorCompanyId);
                        if (!result.Success)
                            return result;

                        #endregion

                        #endregion
                    }
                    else
                    {
                        #region Update

                        SetModifiedProperties(supplier);

                        #region TrackChanges

                        result = SupplierManager.SaveTrackChangesFromIO(entities, transaction, supplierIO, supplier, TermGroup_TrackChangesAction.Update, actorCompanyId);
                        if (!result.Success)
                        {
                            return result;
                        }

                        #endregion
                        #endregion
                    }

                    #region Common

                    // Mandatory
                    supplier.Name = supplierIO.Name;
                    supplier.State = state;

                    // Mandatory FK
                    supplier.CurrencyId = currencyId;

                    // Optional
                    supplier.VatType = supplierIO.VatType ?? 0;
                    supplier.OrgNr = supplierIO.OrgNr;
                    supplier.VatNr = supplierIO.VatNr;
                    supplier.BIC = supplierIO.BIC;
                    supplier.OurCustomerNr = supplierIO.OurCustomerNr;
                    supplier.CopyInvoiceNrToOcr = StringUtility.GetBool(supplierIO.CopyInvoiceNrToOcr);
                    supplier.Interim = false;
                    supplier.ManualAccounting = StringUtility.GetBool(supplierIO.ManualAccounting);
                    supplier.BlockPayment = StringUtility.GetBool(supplierIO.BlockPayment);
                    supplier.IsEDISupplier = false;
                    supplier.RiksbanksCode = supplierIO.RiksbanksCode;
                    supplier.VatCodeId = vatCodeid;

                    // Optional FK
                    supplier.PaymentConditionId = GetPaymentConditionId(entities, supplierIO.PaymentConditionCode, supplier.PaymentConditionId);
                    supplier.DeliveryTypeId = GetDeliveryTypeId(entities, supplierIO.DeliveryTypeCode, supplier.DeliveryTypeId);
                    supplier.DeliveryConditionId = GetDeliveryConditionId(entities, supplierIO.DeliveryConditionCode, supplier.DeliveryConditionId);
                    supplier.FactoringSupplierId = GetFactoringSupplierId(entities, supplierIO.FactoringSupplierNr, supplier.FactoringSupplierId);

                    if (!supplier.SysCountryId.HasValue && !string.IsNullOrEmpty(supplierIO.SysCountry))
                    {
                        if (sysCountries.Any(c => c.Code.ToLower() == supplierIO.SysCountry.ToLower()))
                            supplier.SysCountryId = sysCountries.FirstOrDefault(c => c.Code.ToLower() == supplierIO.SysCountry.ToLower())?.SysCountryId;

                        if (!supplier.SysCountryId.HasValue && sysCountries.Any(c => c.Name.ToLower() == supplierIO.SysCountry.ToLower()))
                            supplier.SysCountryId = sysCountries.FirstOrDefault(c => c.Name.ToLower() == supplierIO.SysCountry.ToLower())?.SysCountryId;
                    }

                    if (!string.IsNullOrEmpty(supplierIO.IntrastatCode) && supplier.IntrastatCodeId == null)
                        supplier.IntrastatCodeId = CommodityCodeManager.EnsureCustomerCommodityCode(entities, actorCompanyId, supplierIO.IntrastatCode);

                    #endregion

                    #endregion

                    #region Add relations

                    // Accounts
                    if (!TryAddSupplierAccountStds(entities, supplier, GetSupplierImportAccounts(entities, supplierIO, actorCompanyId)))
                        AddWarning(WarningMessageType.SaveAccountsFailed);

                    #endregion

                    #region Save

                    result = SaveChanges(entities);
                    if (result.Success)
                    {
                        supplierIO.SupplierId = supplier.ActorSupplierId;
                        supplierIO.Status = (int)TermGroup_IOStatus.Processed;
                    }
                    else
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8388, "Leverantör kunde inte skapas") + "\n" + result.ErrorMessage);
                        return result;
                    }

                    // Update counters
                    if (newSupplier)
                        itemsAdded++;
                    else
                        itemsUpdated++;

                    // Make sure Actors (Mapping) are loaded
                    if (supplier.EntityState != System.Data.Entity.EntityState.Added && !supplier.Actors.IsLoaded)
                        supplier.Actors.Load();

                    // Get actor (Supplier)
                    Actor actor = ActorManager.GetActor(entities, supplier.ActorSupplierId, true);

                    #endregion

                    #region Save relations

                    Contact contact = null;
                    if (TrySaveContact(entities, actor.ActorId, TermGroup_SysContactType.Company, ref contact))
                    {
                        TrySaveContactEcom(entities, contact, GetImportEComs(supplierIO));
                        TrySaveContactAddresses(entities, contact, GetImportAddresses(supplierIO));
                        TrySavePaymentInformation(entities, supplierIO, actor);
                    }

                    if (!string.IsNullOrEmpty(supplierIO.ExternalId))
                    {
                        ActorManager.DeleteExternalNbrs(entities, TermGroup_CompanyExternalCodeEntity.Supplier, supplier.ActorSupplierId, actorCompanyId);
                        var nbrs = supplierIO.ExternalId.Split('|').ToList();
                        foreach (var nbr in nbrs)
                        {
                            var matchingNbr = ActorManager.GetInternalIdsListFromExternalNr(entities, TermGroup_CompanyExternalCodeEntity.Supplier, nbr, actorCompanyId).Where(x => x != supplier.ActorSupplierId).ToList();
                            if (matchingNbr.Any())
                            {
                                result = new ActionResult(8413, $"ExternalNr {nbr} already exist on other supplier");
                                return result;
                            }

                        }
                        ActorManager.InsertExternalNbrs(entities, TermGroup_CompanyExternalCodeEntity.Supplier, supplier.ActorSupplierId, nbrs, actorCompanyId);
                    }

                    #endregion

                    //Commit transaction
                    if (result.Success)
                        transaction.Complete();

                    #endregion
                }
                catch (Exception ex)
                {
                    result.Exception = ex;
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (!result.Success)
                        base.LogTransactionFailed(this.ToString(), this.log);
                }
            }

            return result;
        }

        #endregion

        #region Export from Supplier

        public List<SupplierIODTO> GetSupplierIODTOs(int actorCompanyId, string numberFrom, string numberTo, List<int> supplierIds = null, string orgNr = null)
        {
            List<SupplierIODTO> supplierIODTOs = new List<SupplierIODTO>();

            List<Currency> currencies = CountryCurrencyManager.GetCurrencies(actorCompanyId);
            List<AccountDTO> accounts = AccountManager.GetAccounts(actorCompanyId).ToDTOs(false, false);
            List<AccountDimDTO> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId).ToDTOs(false, false);
            List<CompanyCategoryRecord> categoryRecords = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Supplier, SoeCategoryRecordEntity.Supplier, actorCompanyId);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<Supplier> suppliers = SupplierManager.GetSuppliers(entitiesReadOnly, actorCompanyId, true, true, true, true, true, false, supplierIds, orgNr);

            foreach (var supplier in suppliers)
            {
                if (!string.IsNullOrEmpty(numberFrom) || !string.IsNullOrEmpty(numberTo))
                {
                    if (string.IsNullOrEmpty(numberFrom))
                        numberFrom = "-1";
                    if (string.IsNullOrEmpty(numberFrom))
                        numberTo = "999999999";

                    if (!StringUtility.IsInInterval(supplier.SupplierNr, numberFrom, numberTo))
                        continue;
                }

                #region Accounts

                var debitInternalAccounts = supplier.SupplierAccountStd.FirstOrDefault(p => p.Type == (int)SupplierAccountType.Debit)?.AccountInternal.ToDTOs() ?? new List<AccountInternalDTO>();
                var debitaccountAndInternalAccountComboDTO = debitInternalAccounts.GetInternalAccountDimNrs(accountDims, accounts);

                var creditInternalAccounts = supplier.SupplierAccountStd.FirstOrDefault(p => p.Type == (int)SupplierAccountType.Credit)?.AccountInternal.ToDTOs() ?? new List<AccountInternalDTO>();
                var creditaccountAndInternalAccountComboDTO = creditInternalAccounts.GetInternalAccountDimNrs(accountDims, accounts);

                #endregion

                #region Categories

                var categories = CategoryManager.GetCategories(categoryRecords, supplier.ActorSupplierId);

                #endregion

                #region Addresses

                var contact = supplier.Actor.Contact.FirstOrDefault();
                var contactAddress = contact?.ContactAddress.FirstOrDefault();

                #region Billing

                var supplierBillingAddresses = contactAddress != null ? ContactManager.GetContactAddressRows(contactAddress, (int)TermGroup_SysContactAddressType.Billing) : null;
                string supplierBillingAddressAddress = supplierBillingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)?.Text ?? string.Empty;
                string supplierBillingAddressCo = supplierBillingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)?.Text ?? string.Empty;
                string supplierBillingAddressPostNr = supplierBillingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)?.Text ?? string.Empty;
                string supplierBillingAddressCity = supplierBillingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)?.Text ?? string.Empty;
                string supplierBillingAddressCountry = supplierBillingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)?.Text ?? string.Empty;

                #endregion

                #region Delivery

                var supplierDeliveryAddresses = contactAddress != null ? ContactManager.GetContactAddressRows(contactAddress, (int)TermGroup_SysContactAddressType.Delivery) : null;
                string supplierDeliveryAddressAddress = supplierDeliveryAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)?.Text ?? string.Empty;
                string supplierDeliveryAddressCo = supplierDeliveryAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)?.Text ?? string.Empty;
                string supplierDeliveryAddressPostNr = supplierDeliveryAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)?.Text ?? string.Empty;
                string supplierDeliveryAddressCity = supplierDeliveryAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)?.Text ?? string.Empty;
                string supplierDeliveryAddressCountry = supplierDeliveryAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)?.Text ?? string.Empty;

                #endregion

                #region Visiting

                var supplierVisitingAddresses = contactAddress != null ? ContactManager.GetContactAddressRows(contactAddress, (int)TermGroup_SysContactAddressType.Visiting) : null;
                string supplierVisitingAddressAddress = supplierVisitingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)?.Text ?? string.Empty;
                string supplierVisitingAddressCo = supplierVisitingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)?.Text ?? string.Empty;
                string supplierVisitingAddressPostNr = supplierVisitingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)?.Text ?? string.Empty;
                string supplierVisitingAddressCity = supplierVisitingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)?.Text ?? string.Empty;
                string supplierVisitingAddressCountry = supplierVisitingAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)?.Text ?? string.Empty;

                #endregion

                #region Distribution

                var supplierDistributionAddresses = contactAddress != null ? ContactManager.GetContactAddressRows(contactAddress, (int)TermGroup_SysContactAddressType.Distribution) : null;
                string supplierDistributionAddressAddress = supplierDistributionAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)?.Text ?? string.Empty;
                string supplierDistributionAddressCo = supplierDistributionAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)?.Text ?? string.Empty;
                string supplierDistributionAddressPostNr = supplierDistributionAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)?.Text ?? string.Empty;
                string supplierDistributionAddressCity = supplierDistributionAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)?.Text ?? string.Empty;
                string supplierDistributionAddressCountry = supplierDistributionAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)?.Text ?? string.Empty;

                #endregion

                #region HQ

                var supplierHQAddresses = contactAddress != null ? ContactManager.GetContactAddressRows(contactAddress, (int)TermGroup_SysContactAddressType.BoardHQ) : null;
                string supplierHQAddress = supplierHQAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)?.Text ?? string.Empty;
                string supplierHQAddressCountry = supplierHQAddresses?.FirstOrDefault(c => c.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)?.Text ?? string.Empty;

                #endregion

                #endregion

                #region Ecom

                string email1 = string.Empty;
                string email2 = string.Empty;
                string phoneHome = string.Empty;
                string phoneMobile = string.Empty;
                string phoneJob = string.Empty;
                string fax = string.Empty;
                string webpage = string.Empty;

                if (supplier.Actor.Contact.Any())
                {
                    email1 = ContactManager.GetContactEcoms(supplier.Actor.Contact.FirstOrDefault(), (int)TermGroup_SysContactEComType.Email).FirstOrDefault()?.Text;
                    email2 = ContactManager.GetContactEcoms(supplier.Actor.Contact.LastOrDefault(), (int)TermGroup_SysContactEComType.Email).FirstOrDefault()?.Text;
                    phoneHome = ContactManager.GetContactEcoms(supplier.Actor.Contact.LastOrDefault(), (int)TermGroup_SysContactEComType.PhoneHome).FirstOrDefault()?.Text;
                    phoneMobile = ContactManager.GetContactEcoms(supplier.Actor.Contact.LastOrDefault(), (int)TermGroup_SysContactEComType.PhoneMobile).FirstOrDefault()?.Text;
                    phoneJob = ContactManager.GetContactEcoms(supplier.Actor.Contact.LastOrDefault(), (int)TermGroup_SysContactEComType.PhoneJob).FirstOrDefault()?.Text;
                    fax = ContactManager.GetContactEcoms(supplier.Actor.Contact.LastOrDefault(), (int)TermGroup_SysContactEComType.Fax).FirstOrDefault()?.Text;
                    webpage = ContactManager.GetContactEcoms(supplier.Actor.Contact.LastOrDefault(), (int)TermGroup_SysContactEComType.Web).FirstOrDefault()?.Text;
                    email1 = !string.IsNullOrEmpty(email1) ? email1 : string.Empty;
                    email2 = !string.IsNullOrEmpty(email2) ? email2 : string.Empty;
                    phoneHome = !string.IsNullOrEmpty(phoneHome) ? phoneHome : string.Empty;
                    phoneMobile = !string.IsNullOrEmpty(phoneMobile) ? phoneMobile : string.Empty;
                    phoneJob = !string.IsNullOrEmpty(phoneJob) ? phoneJob : string.Empty;
                    fax = !string.IsNullOrEmpty(fax) ? fax : string.Empty;
                    webpage = !string.IsNullOrEmpty(webpage) ? webpage : string.Empty;
                }

                #endregion

                var supplierIODTO = new SupplierIODTO
                {
                    ActorCompanyId = supplier.ActorCompanyId.Value,
                    SupplierNr = supplier.SupplierNr,
                    Name = supplier.Name,
                    VatType = supplier.VatType,
                    OrgNr = supplier.OrgNr,
                    VatNr = supplier.VatNr,
                    OurCustomerNr = supplier.OurCustomerNr,
                    SysCountry = supplier.SysCountryId.HasValue && supplier.SysCountryId != 0 ? (currencies?.FirstOrDefault(c => c.CurrencyId == supplier.CurrencyId)?.Code ?? string.Empty) : string.Empty,
                    Currency = currencies.FirstOrDefault(c => c.CurrencyId == supplier.CurrencyId)?.Code ?? string.Empty,
                    PaymentConditionCode = supplier.PaymentCondition != null ? supplier.PaymentCondition.Name : string.Empty,
                    BIC = supplier.BIC,
                    BankGiroNr = supplier.PaymentInformation != null && supplier.PaymentInformation.PaymentInformationRow != null ? supplier.PaymentInformation.PaymentInformationRow.FirstOrDefault(p => p.SysPaymentTypeId == (int)TermGroup_SysPaymentType.BG)?.SysPaymentTypeName : string.Empty,
                    RiksbanksCode = supplier.RiksbanksCode,
                    ManualAccounting = supplier.ManualAccounting,
                    DistributionAddress = supplierDistributionAddressAddress,
                    DistributionCoAddress = supplierDistributionAddressCo,
                    DistributionPostalCode = supplierDistributionAddressPostNr,
                    DistributionPostalAddress = supplierDistributionAddressCity,
                    DistributionCountry = supplierDistributionAddressCountry,
                    BillingAddress = supplierBillingAddressAddress,
                    BillingCoAddress = supplierBillingAddressCo,
                    BillingPostalCode = supplierBillingAddressPostNr,
                    BillingPostalAddress = supplierBillingAddressCity,
                    BillingCountry = supplierBillingAddressCountry,
                    BoardHQAddress = supplierHQAddress,
                    BoardHQCountry = supplierHQAddressCountry,
                    VisitingAddress = supplierVisitingAddressAddress,
                    VisitingCoAddress = supplierVisitingAddressCo,
                    VisitingPostalCode = supplierVisitingAddressPostNr,
                    VisitingPostalAddress = supplierVisitingAddressCity,
                    VisitingCountry = supplierVisitingAddressCountry,
                    DeliveryAddress = supplierDeliveryAddressAddress,
                    DeliveryCoAddress = supplierDeliveryAddressCo,
                    DeliveryPostalCode = supplierDeliveryAddressPostNr,
                    DeliveryPostalAddress = supplierDeliveryAddressCity,
                    DeliveryCountry = supplierDeliveryAddressCountry,
                    Email1 = email1,
                    Email2 = email2,
                    PhoneHome = phoneHome,
                    PhoneMobile = phoneMobile,
                    PhoneJob = phoneJob,
                    Fax = fax,
                    Webpage = webpage,
                    PurchaseAccountNr = supplier.SupplierAccountStd.FirstOrDefault(a => a.Type == (int)SupplierAccountType.Debit)?.AccountStd.Account.AccountNr,
                    PurchaseAccountInternal1 = debitaccountAndInternalAccountComboDTO.Dim2Nr,
                    PurchaseAccountInternal2 = debitaccountAndInternalAccountComboDTO.Dim3Nr,
                    PurchaseAccountInternal3 = debitaccountAndInternalAccountComboDTO.Dim4Nr,
                    PurchaseAccountInternal4 = debitaccountAndInternalAccountComboDTO.Dim5Nr,
                    PurchaseAccountInternal5 = debitaccountAndInternalAccountComboDTO.Dim6Nr,
                    AccountsPayableAccountNr = supplier.SupplierAccountStd.FirstOrDefault(a => a.Type == (int)SupplierAccountType.Credit)?.AccountStd.Account.AccountNr,
                    AccountsPayableAccountInternal1 = creditaccountAndInternalAccountComboDTO.Dim2Nr,
                    AccountsPayableAccountInternal2 = creditaccountAndInternalAccountComboDTO.Dim3Nr,
                    AccountsPayableAccountInternal3 = creditaccountAndInternalAccountComboDTO.Dim4Nr,
                    AccountsPayableAccountInternal4 = creditaccountAndInternalAccountComboDTO.Dim5Nr,
                    AccountsPayableAccountInternal5 = creditaccountAndInternalAccountComboDTO.Dim6Nr,
                    VATAccountNr = supplier.SupplierAccountStd.FirstOrDefault(a => a.Type == (int)SupplierAccountType.VAT)?.AccountStd.Account.AccountNr,
                    VATCodeNr = supplier.VatNr,
                    Created = supplier.Created,
                    CreatedBy = supplier.CreatedBy,
                    Modified = supplier.Modified,
                    ModifiedBy = supplier.ModifiedBy,
                    State = (SoeEntityState)supplier.State,
                    ErrorMessage = string.Empty,
                    ImportHeadType = TermGroup_IOImportHeadType.Supplier,
                    CategoryIds = !categories.IsNullOrEmpty() ? categories.Select(c => c.CategoryId).ToList() : new List<int>(),
                    ExternalNbrs = ActorManager.GetCompanyExternalCodeValues(TermGroup_CompanyExternalCodeEntity.Supplier, supplier.ActorSupplierId, actorCompanyId)
                };

                supplierIODTOs.Add(supplierIODTO);

            }

            return supplierIODTOs;

        }


        #endregion

        #region Help-methods

        private SupplierIO CreateSupplierIO(CompEntities entities, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, SupplierIODTO supplierIODTO, string batchId, int actorCompanyId)
        {
            #region Prereq

            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

            SupplierIO io = new SupplierIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
            };
            SetCreatedProperties(io);
            entities.SupplierIO.AddObject(io);

            #endregion

            #region Perform

            if (supplierIODTO != null)
            {
                try
                {
                    #region Fill SupplierIO

                    io.SupplierNr = supplierIODTO.SupplierNr;
                    io.Name = supplierIODTO.Name;
                    io.OrgNr = supplierIODTO.OrgNr;
                    io.VatNr = supplierIODTO.VatNr;
                    io.VatType = supplierIODTO.VatType;
                    io.RiksbanksCode = supplierIODTO.RiksbanksCode;
                    io.OurCustomerNr = supplierIODTO.OurCustomerNr;
                    io.FactoringSupplierNr = supplierIODTO.FactoringSupplierNr;
                    io.SysCountry = supplierIODTO.SysCountry;
                    io.Currency = supplierIODTO.Currency;
                    io.StandardPaymentType = supplierIODTO.StandardPaymentType;
                    io.BankGiroNr = supplierIODTO.BankGiroNr;
                    io.PlusGiroNr = supplierIODTO.PlusGiroNr;
                    io.BankNr = supplierIODTO.BankNr;
                    io.BIC = supplierIODTO.BIC;
                    io.IBAN = supplierIODTO.IBAN;
                    io.DistributionAddress = supplierIODTO.DistributionAddress;
                    io.DistributionCoAddress = supplierIODTO.DistributionCoAddress;
                    io.DistributionPostalCode = supplierIODTO.DistributionPostalCode;
                    io.DistributionPostalAddress = supplierIODTO.DistributionPostalAddress;
                    io.DistributionCountry = supplierIODTO.DistributionCountry;
                    io.BillingAddress = supplierIODTO.BillingAddress;
                    io.BillingCoAddress = supplierIODTO.BillingCoAddress;
                    io.BillingPostalCode = supplierIODTO.BillingPostalCode;
                    io.BillingPostalAddress = supplierIODTO.BillingPostalAddress;
                    io.BillingCountry = supplierIODTO.BillingCountry;
                    io.BoardHQAddress = supplierIODTO.BoardHQAddress;
                    io.BoardHQCountry = supplierIODTO.BoardHQCountry;
                    io.VisitingAddress = supplierIODTO.VisitingAddress;
                    io.VisitingCoAddress = supplierIODTO.VisitingCoAddress;
                    io.VisitingPostalCode = supplierIODTO.VisitingPostalCode;
                    io.VisitingPostalAddress = supplierIODTO.VisitingPostalAddress;
                    io.VisitingCountry = supplierIODTO.VisitingCountry;
                    io.DeliveryAddress = supplierIODTO.DeliveryAddress;
                    io.DeliveryCoAddress = supplierIODTO.DeliveryCoAddress;
                    io.DeliveryPostalCode = supplierIODTO.DeliveryPostalCode;
                    io.DeliveryPostalAddress = supplierIODTO.DeliveryPostalAddress;
                    io.DeliveryCountry = supplierIODTO.DeliveryCountry;
                    io.Email1 = supplierIODTO.Email1;
                    io.Email2 = supplierIODTO.Email2;
                    io.PhoneHome = supplierIODTO.PhoneHome;
                    io.PhoneMobile = supplierIODTO.PhoneMobile;
                    io.PhoneJob = supplierIODTO.PhoneJob;
                    io.Fax = supplierIODTO.Fax;
                    io.Webpage = supplierIODTO.Webpage;
                    io.PaymentConditionCode = supplierIODTO.PaymentConditionCode;
                    io.DeliveryConditionCode = supplierIODTO.DeliveryConditionCode;
                    io.DeliveryTypeCode = supplierIODTO.DeliveryTypeCode;
                    io.CopyInvoiceNrToOcr = supplierIODTO.CopyInvoiceNrToOcr;
                    io.BlockPayment = supplierIODTO.BlockPayment;
                    io.ManualAccounting = supplierIODTO.ManualAccounting;
                    io.AccountsPayableAccountNr = supplierIODTO.AccountsPayableAccountNr;
                    io.AccountsPayableAccountInternal1 = supplierIODTO.AccountsPayableAccountInternal1;
                    io.AccountsPayableAccountInternal2 = supplierIODTO.AccountsPayableAccountInternal2;
                    io.AccountsPayableAccountInternal3 = supplierIODTO.AccountsPayableAccountInternal3;
                    io.AccountsPayableAccountInternal4 = supplierIODTO.AccountsPayableAccountInternal4;
                    io.AccountsPayableAccountInternal5 = supplierIODTO.AccountsPayableAccountInternal5;
                    io.PurchaseAccountNr = supplierIODTO.PurchaseAccountNr;
                    io.PurchaseAccountInternal1 = supplierIODTO.PurchaseAccountInternal1;
                    io.PurchaseAccountInternal2 = supplierIODTO.PurchaseAccountInternal2;
                    io.PurchaseAccountInternal3 = supplierIODTO.PurchaseAccountInternal3;
                    io.PurchaseAccountInternal4 = supplierIODTO.PurchaseAccountInternal4;
                    io.PurchaseAccountInternal5 = supplierIODTO.PurchaseAccountInternal5;
                    io.VATAccountNr = supplierIODTO.VATAccountNr;
                    io.VATCodeNr = supplierIODTO.VATCodeNr;
                    io.ExternalId = supplierIODTO.ExternalNbrs != null && supplierIODTO.ExternalNbrs.Any() ? string.Join("|", supplierIODTO.ExternalNbrs) : null;
                    io.IntrastatCode = supplierIODTO.IntrastatCode;
                    if (accountSiedim1 != null && supplierIODTO.AccountsPayableAccountSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 1:
                                io.AccountsPayableAccountInternal1 = supplierIODTO.AccountsPayableAccountSieDim1;
                                break;
                            case 2:
                                io.AccountsPayableAccountInternal1 = supplierIODTO.AccountsPayableAccountSieDim1;
                                break;
                            case 3:
                                io.AccountsPayableAccountInternal2 = supplierIODTO.AccountsPayableAccountSieDim1;
                                break;
                            case 4:
                                io.AccountsPayableAccountInternal3 = supplierIODTO.AccountsPayableAccountSieDim1;
                                break;
                            case 5:
                                io.AccountsPayableAccountInternal4 = supplierIODTO.AccountsPayableAccountSieDim1;
                                break;
                            case 6:
                                io.AccountsPayableAccountInternal5 = supplierIODTO.AccountsPayableAccountSieDim1;
                                break;

                        }
                    }
                    if (accountSiedim1 != null && supplierIODTO.PurchaseAccountSieDim1 != null)
                    {
                        switch (accountSiedim1.AccountDimNr)
                        {
                            case 1:
                                io.PurchaseAccountInternal1 = supplierIODTO.PurchaseAccountSieDim1;
                                break;
                            case 2:
                                io.PurchaseAccountInternal1 = supplierIODTO.PurchaseAccountSieDim1;
                                break;
                            case 3:
                                io.PurchaseAccountInternal2 = supplierIODTO.PurchaseAccountSieDim1;
                                break;
                            case 4:
                                io.PurchaseAccountInternal3 = supplierIODTO.PurchaseAccountSieDim1;
                                break;
                            case 5:
                                io.PurchaseAccountInternal4 = supplierIODTO.PurchaseAccountSieDim1;
                                break;
                            case 6:
                                io.PurchaseAccountInternal5 = supplierIODTO.PurchaseAccountSieDim1;
                                break;

                        }
                    }
                    if (accountSiedim6 != null && supplierIODTO.AccountsPayableAccountSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 1:
                                io.AccountsPayableAccountInternal1 = supplierIODTO.AccountsPayableAccountSieDim6;
                                break;
                            case 2:
                                io.AccountsPayableAccountInternal1 = supplierIODTO.AccountsPayableAccountSieDim6;
                                break;
                            case 3:
                                io.AccountsPayableAccountInternal2 = supplierIODTO.AccountsPayableAccountSieDim6;
                                break;
                            case 4:
                                io.AccountsPayableAccountInternal3 = supplierIODTO.AccountsPayableAccountSieDim6;
                                break;
                            case 5:
                                io.AccountsPayableAccountInternal4 = supplierIODTO.AccountsPayableAccountSieDim6;
                                break;
                            case 6:
                                io.AccountsPayableAccountInternal5 = supplierIODTO.AccountsPayableAccountSieDim6;
                                break;

                        }
                    }
                    if (accountSiedim6 != null && supplierIODTO.PurchaseAccountSieDim6 != null)
                    {
                        switch (accountSiedim6.AccountDimNr)
                        {
                            case 1:
                                io.PurchaseAccountInternal1 = supplierIODTO.PurchaseAccountSieDim6;
                                break;
                            case 2:
                                io.PurchaseAccountInternal1 = supplierIODTO.PurchaseAccountSieDim6;
                                break;
                            case 3:
                                io.PurchaseAccountInternal2 = supplierIODTO.PurchaseAccountSieDim6;
                                break;
                            case 4:
                                io.PurchaseAccountInternal3 = supplierIODTO.PurchaseAccountSieDim6;
                                break;
                            case 5:
                                io.PurchaseAccountInternal4 = supplierIODTO.PurchaseAccountSieDim6;
                                break;
                            case 6:
                                io.PurchaseAccountInternal5 = supplierIODTO.PurchaseAccountSieDim6;
                                break;

                        }
                    }

                    io.Status = (int)TermGroup_IOStatus.UnderProcessing;

                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    io.Status = (int)TermGroup_IOStatus.Error;
                    io.ErrorMessage = GetText(8383, "Okänt fel, kunde inte spara all rådata");
                }
            }

            #endregion

            return io;
        }

        public List<SupplierIO> GetSupplierIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.SupplierIO.NoTracking();
            var query = (from io in entities.SupplierIO
                         where io.ActorCompanyId == actorCompanyId &&
                         io.BatchId == batchId
                         orderby io.SupplierIOId
                         select io);

            List<SupplierIO> ios = query.ToList();

            // Get terms
            int langId = GetLangId();
            Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);
            Dictionary<int, string> vatTypes = base.GetTermGroupDict(TermGroup.InvoiceVatType, langId);
            Dictionary<int, string> paymentTypes = base.GetTermGroupDict(TermGroup.SysPaymentType, langId);

            // Extensions
            foreach (var io in ios)
            {
                io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : String.Empty;
                io.VatTypeName = io.VatType.HasValue && vatTypes.ContainsKey(io.VatType.Value) ? vatTypes[io.VatType.Value] : String.Empty;
                io.StandardPaymentTypeName = io.StandardPaymentType.HasValue && paymentTypes.ContainsKey(io.StandardPaymentType.Value) ? paymentTypes[io.StandardPaymentType.Value] : String.Empty;
            }

            return ios;
        }

        private SupplierIO GetSupplierIO(CompEntities entities, int supplierIOId)
        {
            return (from io in entities.SupplierIO
                    where io.SupplierIOId == supplierIOId
                    select io).FirstOrDefault();
        }

        public ActionResult UpdateSupplierIO(List<SupplierIODTO> dtos)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (SupplierIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        SupplierIO io = GetSupplierIO(entities, dto.SupplierIOId);
                        if (io != null)
                        {
                            io.SupplierNr = dto.SupplierNr;
                            io.Name = dto.Name;
                            io.OrgNr = dto.OrgNr;
                            io.VatNr = dto.VatNr;
                            io.VatType = dto.VatType;
                            io.RiksbanksCode = dto.RiksbanksCode;
                            io.OurCustomerNr = dto.OurCustomerNr;
                            io.FactoringSupplierNr = dto.FactoringSupplierNr;
                            io.SysCountry = dto.SysCountry;
                            io.Currency = dto.Currency;
                            io.StandardPaymentType = dto.StandardPaymentType;
                            io.BankGiroNr = dto.BankGiroNr;
                            io.PlusGiroNr = dto.PlusGiroNr;
                            io.BankNr = dto.BankNr;
                            io.BIC = dto.BIC;
                            io.IBAN = dto.IBAN;
                            io.DistributionAddress = dto.DistributionAddress;
                            io.DistributionCoAddress = dto.DistributionCoAddress;
                            io.DistributionPostalCode = dto.DistributionPostalCode;
                            io.DistributionPostalAddress = dto.DistributionPostalAddress;
                            io.DistributionCountry = dto.DistributionCountry;
                            io.BillingAddress = dto.BillingAddress;
                            io.BillingCoAddress = dto.BillingCoAddress;
                            io.BillingPostalCode = dto.BillingPostalCode;
                            io.BillingPostalAddress = dto.BillingPostalAddress;
                            io.BillingCountry = dto.BillingCountry;
                            io.BoardHQAddress = dto.BoardHQAddress;
                            io.BoardHQCountry = dto.BoardHQCountry;
                            io.VisitingAddress = dto.VisitingAddress;
                            io.VisitingCoAddress = dto.VisitingCoAddress;
                            io.VisitingPostalCode = dto.VisitingPostalCode;
                            io.VisitingPostalAddress = dto.VisitingPostalAddress;
                            io.VisitingCountry = dto.VisitingCountry;
                            io.DeliveryAddress = dto.DeliveryAddress;
                            io.DeliveryCoAddress = dto.DeliveryCoAddress;
                            io.DeliveryPostalCode = dto.DeliveryPostalCode;
                            io.DistributionPostalAddress = dto.DistributionPostalAddress;
                            io.DeliveryCountry = dto.DeliveryCountry;
                            io.Email1 = dto.Email1;
                            io.Email2 = dto.Email2;
                            io.PhoneHome = dto.PhoneHome;
                            io.PhoneMobile = dto.PhoneMobile;
                            io.PhoneJob = dto.PhoneJob;
                            io.Fax = dto.Fax;
                            io.Webpage = dto.Webpage;
                            io.PaymentConditionCode = dto.PaymentConditionCode;
                            io.CopyInvoiceNrToOcr = dto.CopyInvoiceNrToOcr;
                            io.BlockPayment = dto.BlockPayment;
                            io.ManualAccounting = dto.ManualAccounting;
                            io.AccountsPayableAccountNr = dto.AccountsPayableAccountNr;
                            io.AccountsPayableAccountInternal1 = dto.AccountsPayableAccountInternal1;
                            io.AccountsPayableAccountInternal2 = dto.AccountsPayableAccountInternal2;
                            io.AccountsPayableAccountInternal3 = dto.AccountsPayableAccountInternal3;
                            io.AccountsPayableAccountInternal4 = dto.AccountsPayableAccountInternal4;
                            io.AccountsPayableAccountInternal5 = dto.AccountsPayableAccountInternal5;
                            io.PurchaseAccountNr = dto.PurchaseAccountNr;
                            io.PurchaseAccountInternal1 = dto.PurchaseAccountInternal1;
                            io.PurchaseAccountInternal2 = dto.PurchaseAccountInternal2;
                            io.PurchaseAccountInternal3 = dto.PurchaseAccountInternal3;
                            io.PurchaseAccountInternal4 = dto.PurchaseAccountInternal4;
                            io.PurchaseAccountInternal5 = dto.PurchaseAccountInternal5;
                            io.VATAccountNr = dto.VATAccountNr;
                            io.VATCodeNr = dto.VATCodeNr;

                            SetModifiedProperties(io);
                        }
                    }

                    return SaveChanges(entities);

                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(ex);
                }
            }
        }

        public List<CustomerIO> GetCustomerIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.SupplierIO.NoTracking();
            var query = (from io in entities.CustomerIO
                         where io.ActorCompanyId == actorCompanyId &&
                         io.BatchId == batchId
                         orderby io.CustomerIOId
                         select io);

            List<CustomerIO> ios = query.ToList();
            if (!ios.IsNullOrEmpty())
            {
                int langId = GetLangId();
                Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);

                foreach (var io in ios)
                {
                    io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : String.Empty;
                }
            }

            return ios;
        }

        public ActionResult UpdateCustomerIO(List<CustomerIODTO> dtos)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (CustomerIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        CustomerIO io = GetCustomerIO(entities, dto.CustomerIOId);

                        if (io != null)
                        {
                            io.CustomerIOId = dto.CustomerIOId;
                            io.ActorCompanyId = dto.ActorCompanyId;
                            io.Import = dto.Import;
                            io.Type = (int)dto.Type;
                            io.Status = (int)dto.Status;
                            io.Source = (int)dto.Source;
                            io.BatchId = dto.BatchId;
                            io.GracePeriodDays = dto.GracePeriodDays;
                            io.DeliveryMethod = dto.DeliveryMethod;
                            io.DefaultWholeseller = dto.DefaultWholeseller;
                            io.CustomerState = dto.CustomerState;
                            io.OfferTemplate = dto.OfferTemplate;
                            io.OrderTemplate = dto.OrderTemplate;
                            io.BillingTemplate = dto.BillingTemplate;
                            io.AgreementTemplate = dto.AgreementTemplate;

                            io.AccountsReceivableAccountNr = dto.AccountsReceivableAccountNr;
                            io.AccountsReceivableAccountInternal1 = dto.AccountsReceivableAccountInternal1;
                            io.AccountsReceivableAccountInternal2 = dto.AccountsReceivableAccountInternal2;
                            io.AccountsReceivableAccountInternal3 = dto.AccountsReceivableAccountInternal3;
                            io.AccountsReceivableAccountInternal4 = dto.AccountsReceivableAccountInternal4;
                            io.AccountsReceivableAccountInternal5 = dto.AccountsReceivableAccountInternal5;
                            io.SalesAccountNr = dto.SalesAccountNr;
                            io.SalesAccountInternal1 = dto.SalesAccountInternal1;
                            io.SalesAccountInternal2 = dto.SalesAccountInternal2;
                            io.SalesAccountInternal3 = dto.SalesAccountInternal3;
                            io.SalesAccountInternal4 = dto.SalesAccountInternal4;
                            io.SalesAccountInternal5 = dto.SalesAccountInternal5;
                            io.VATAccountNr = dto.VATAccountNr;
                            io.VATCodeNr = dto.VATCodeNr;
                            io.CategoryCode1 = dto.CategoryCode1;
                            io.CategoryCode2 = dto.CategoryCode2;
                            io.CategoryCode3 = dto.CategoryCode3;
                            io.CategoryCode4 = dto.CategoryCode4;
                            io.CategoryCode5 = dto.CategoryCode5;

                            io.VatType = dto.VatType;
                            io.DeliveryCondition = dto.DeliveryCondition;
                            io.PaymentCondition = dto.PaymentCondition;
                            io.DefaultPriceListType = dto.DefaultPriceListType;
                            io.Currency = dto.Currency;
                            io.Country = dto.Country;
                            io.CustomerNr = dto.CustomerNr;
                            io.Name = dto.Name;
                            io.OrgNr = dto.OrgNr;
                            io.VatNr = dto.VatNr;
                            io.InvoiceReference = dto.InvoiceReference;
                            io.SupplierNr = dto.SupplierNr;
                            io.ManualAccounting = dto.ManualAccounting;
                            io.DiscountMerchandise = dto.DiscountMerchandise;
                            io.DiscountService = dto.DiscountService;
                            io.DisableInvoiceFee = dto.DisableInvoiceFee;
                            io.Note = dto.Note;
                            io.ShowNote = dto.ShowNote;
                            io.FinvoiceAddress = dto.FinvoiceAddress;
                            io.FinvoiceOperator = dto.FinvoiceOperator;
                            io.IsFinvoiceCustomer = dto.IsFinvoiceCustomer;
                            io.BlockNote = dto.BlockNote;
                            io.BlockOrder = dto.BlockOrder;
                            io.BlockInvoice = dto.BlockInvoice;
                            io.CreditLimit = dto.CreditLimit;
                            io.IsCashCustomer = dto.IsCashCustomer;
                            io.InvoiceDeliveryType = dto.InvoiceDeliveryType;
                            io.ImportInvoiceDetailed = dto.ImportInvoiceDetailed;

                            io.DistributionAddress = dto.DistributionAddress;
                            io.DistributionCoAddress = dto.DistributionCoAddress;
                            io.DistributionPostalCode = dto.DistributionPostalCode;
                            io.DistributionPostalAddress = dto.DistributionPostalAddress;
                            io.DistributionCountry = dto.DistributionCountry;

                            io.BillingAddress = dto.BillingAddress;
                            io.BillingCoAddress = dto.BillingCoAddress;
                            io.BillingPostalCode = dto.BillingPostalCode;
                            io.BillingPostalAddress = dto.BillingPostalAddress;
                            io.BillingCountry = dto.BillingCountry;

                            io.BoardHQAddress = dto.BoardHQAddress;
                            io.BoardHQCountry = dto.BoardHQCountry;

                            io.VisitingAddress = dto.VisitingAddress;
                            io.VisitingCoAddress = dto.VisitingCoAddress;
                            io.VisitingPostalCode = dto.VisitingPostalCode;
                            io.VisitingPostalAddress = dto.VisitingPostalAddress;
                            io.VisitingCountry = dto.VisitingCountry;
                            io.DeliveryAddress = dto.DeliveryAddress;
                            io.DeliveryCoAddress = dto.DeliveryCoAddress;
                            io.DeliveryPostalCode = dto.DeliveryPostalCode;
                            io.DeliveryPostalAddress = dto.DeliveryPostalAddress;
                            io.DeliveryCountry = dto.DeliveryCountry;

                            io.Email1 = dto.Email1;
                            io.Email2 = dto.Email2;
                            io.PhoneHome = dto.PhoneHome;
                            io.PhoneMobile = dto.PhoneMobile;
                            io.PhoneJob = dto.PhoneJob;
                            io.Fax = dto.Fax;
                            io.Webpage = dto.Webpage;

                            io.Created = dto.Created;
                            io.CreatedBy = dto.CreatedBy;
                            io.Modified = dto.Modified;
                            io.ModifiedBy = dto.ModifiedBy;
                            io.State = dto.State;
                            io.ErrorMessage = dto.ErrorMessage;
                            io.ImportHeadType = (int)dto.ImportHeadType;

                            io.SysLanguageId = dto.SysLanguageId;

                            SetModifiedProperties(io);
                        }
                    }

                    return SaveChanges(entities);

                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(ex);
                }
            }
        }

        #endregion

        #endregion

        #region SupplierInvoiceIO

        #region Import to SupplierInvoiceIO

        public ActionResult ImportSupplierInvoiceIO(SupplierInvoiceIOItem supplierInvoiceIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool continueImportToSupplierInvoice)
        {
            ActionResult result = new ActionResult();
            List<SupplierInvoiceHeadIO> ios = new List<SupplierInvoiceHeadIO>();

            string batchId = GenerateBatchId();
            this.company = CompanyManager.GetCompany(actorCompanyId);
            if (company != null && company.SysCountryId.HasValue)
                this.langId = company.SysCountryId.Value;

            var dictSpecialFunctionality = GetSpecialFunctionalityDict(actorCompanyId, importId);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    this.company = CompanyManager.GetCompany(actorCompanyId, true);
                    foreach (var supplierInvoiceIORawData in supplierInvoiceIOItem.supplierInvoices)
                    {
                        SupplierInvoiceHeadIO supplierInvoiceIO = CreateSupplierInvoiceIO(entities, headType, source, type, supplierInvoiceIORawData, batchId, actorCompanyId, dictSpecialFunctionality);
                        supplierInvoiceIO.Attachements = supplierInvoiceIORawData.Attachements;
                        supplierInvoiceIO.PaymentNumbers = supplierInvoiceIORawData.PaymentNumbers;
                        if (supplierInvoiceIO.Status == (int)TermGroup_IOStatus.Error && (type == TermGroup_IOType.WebAPI || type == TermGroup_IOType.Inexchange))
                        {
                            throw new Exception(supplierInvoiceIO.ErrorMessage);
                        }

                        ios.Add(supplierInvoiceIO);
                    }

                    //Save
                    result = SaveChanges(entities);
                }
                catch (Exception ex)
                {
                    this.LogError(ex, this.log);
                    result = new ActionResult(ex, $"ImportSupplierInvoiceIO:CreateSupplierInvoiceIO error:");
                }
            }

            if (result.Success && ios.Count > 0 && continueImportToSupplierInvoice)
            {
                List<string> specialFunctionality = null;

                if (dictSpecialFunctionality != null)
                    specialFunctionality = dictSpecialFunctionality.Select(k => k.Key).ToList();

                result = ImportFromSupplierInvoiceHeadIO(ios, actorCompanyId, specialFunctionality);
            }

            result.StringValue = batchId;

            return result;
        }

        #endregion

        #region Import From SupplierInvoiceIO

        public void TestImport()
        {
            //List<CustomerInvoiceHeadIO> ios = CompEntities.CustomerInvoiceHeadIO.Where(x => x.CustomerInvoiceHeadIOId == 1).ToList();
            //ImportFromCustomerInvoiceHeadIO(ios, 17,3253);
        }

        public ActionResult ImportFromSupplierInvoiceHeadIO(List<SupplierInvoiceHeadIO> supplierInvoiceHeadIOs, int actorCompanyId, List<string> specialFunctionality = null)
        {
            ActionResult result = new ActionResult();

            #region Init

            int ioCount = supplierInvoiceHeadIOs.Count;
            int transferedCount = 0;
            int counterErrorOccurred = 0;
            #endregion

            #region Prereq

            //Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            this.rowNr = 0;

            int voucherSeriesTypeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.SupplierInvoiceVoucherSeriesType, 0, actorCompanyId, 0);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform



                    foreach (var io in supplierInvoiceHeadIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing))
                    {
                        SupplierInvoiceHeadIO supplierInvoiceHeadIO = entities.SupplierInvoiceHeadIO.Include("SupplierInvoiceAccountingRowIO").FirstOrDefault(i => i.SupplierInvoiceHeadIOId == io.SupplierInvoiceHeadIOId);
                        if (supplierInvoiceHeadIO == null)
                            continue;
                        supplierInvoiceHeadIO.Attachements = io.Attachements;
                        supplierInvoiceHeadIO.PaymentNumbers = io.PaymentNumbers;
                        supplierInvoiceHeadIO.ProductRows = io.ProductRows;

                        ActionResult transferedResult = ImportFromSupplierInvoiceHeadIO(entities, supplierInvoiceHeadIO, actorCompanyId, voucherSeriesTypeId, specialFunctionality);
                        if (!transferedResult.Success)
                        {
                            // Declare another entities in order to save the error (otherwize we might by accident save modified or added entities)
                            using (var entitiesForError = new CompEntities())
                            {
                                supplierInvoiceHeadIO = entitiesForError.SupplierInvoiceHeadIO.Include("SupplierInvoiceAccountingRowIO").FirstOrDefault(i => i.SupplierInvoiceHeadIOId == io.SupplierInvoiceHeadIOId);
                                supplierInvoiceHeadIO.Status = (int)TermGroup_IOStatus.Error;
                                supplierInvoiceHeadIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;

                                foreach (var supplierInvoiceAccountingRowIO in supplierInvoiceHeadIO.SupplierInvoiceAccountingRowIO)
                                {
                                    supplierInvoiceAccountingRowIO.Status = (int)TermGroup_IOStatus.Error;
                                    supplierInvoiceAccountingRowIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                                }

                                result = SaveChanges(entitiesForError);

                                // Clear old entities
                                Array.ForEach<ObjectStateEntry>(entities.ObjectStateManager.GetObjectStateEntries(System.Data.Entity.EntityState.Added | System.Data.Entity.EntityState.Deleted | System.Data.Entity.EntityState.Modified | System.Data.Entity.EntityState.Unchanged).ToArray(), (e) =>
                                {
                                    if (e.Entity != null)
                                        entities.Detach(e.Entity);
                                });

                                if (io.Type == (int)TermGroup_IOType.WebAPI || io.Type == (int)TermGroup_IOType.Inexchange)
                                {
                                    return transferedResult;
                                }
                            }
                            counterErrorOccurred++;
                        }
                        else
                        {
                            transferedCount++;
                            result = SaveChanges(entities);
                        }

                        if (!result.Success)
                            return result;
                    }

                    #endregion
                }
                catch (Exception e)
                {
                    result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                    base.LogError(e, this.log);
                }
                finally
                {
                    entities.Connection.Close();
                }
            }

            result.Success = (transferedCount == ioCount);
            result.SuccessNumber = transferedCount;
            result.StringValue = string.Format("{0},{1}", transferedCount, counterErrorOccurred);
            result.InfoMessage = string.Format(GetText(8399, "{0} leverantörsfakturor utav {1} har skapats/uppdaterats."), transferedCount, ioCount);
            return result;
        }

        public ActionResult ImportFromSupplierInvoiceHeadIO(CompEntities entities, SupplierInvoiceHeadIO supplierInvoiceHeadIO, int actorCompanyId, int voucherSeriesTypeId, List<string> specialFunctionality = null)
        {
            ActionResult result = new ActionResult();

            using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    #region SupplierInvoiceIO

                    #region Init

                    supplierInvoiceHeadIO.ErrorMessage = string.Empty;
                    this.rowNr++;

                    bool newSupplierInvoice = false;

                    //Get AccountYear
                    DateTime date = supplierInvoiceHeadIO.InvoiceDate ?? DateTime.Now.Date;
                    AccountYear accountYear = AccountManager.GetAccountYear(entities, date, actorCompanyId);
                    bool createdNewAccountYear = false;
                    if (accountYear == null)
                    {
                        if (specialFunctionality != null && specialFunctionality.Any(v => v.Equals("SOPPP")))
                        {
                            var newAccountYear = new AccountYear()
                            {
                                ActorCompanyId = actorCompanyId,
                                From = CalendarUtility.GetFirstDateOfYear(date),
                                To = CalendarUtility.GetLastDateOfYear(date),
                                Status = (int)TermGroup_AccountStatus.Open,
                            };
                            AccountManager.AddAccountYear(entities, newAccountYear, actorCompanyId);

                            createdNewAccountYear = true;
                        }

                        accountYear = AccountManager.GetAccountYear(entities, date, actorCompanyId);
                        if (accountYear == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(8404, "Redovisningsår saknas") + ": " + date.ToShortDateString());
                    }

                    //Get VoucherSeries
                    VoucherSeries voucherSerie = VoucherManager.GetVoucherSerieByYear(entities, accountYear.AccountYearId, voucherSeriesTypeId);
                    if (voucherSerie == null)
                    {
                        if (specialFunctionality != null && specialFunctionality.Any(v => v.Equals("SOPPP")) && createdNewAccountYear)
                        {
                            VoucherSeriesType seriesType = VoucherManager.GetVoucherSeriesTypes(actorCompanyId, false).FirstOrDefault();
                            if (seriesType != null)
                            {
                                VoucherSeries newVoucherSerie = new VoucherSeries()
                                {
                                    VoucherDateLatest = date,
                                    VoucherNrLatest = 1,
                                    VoucherSeriesTypeId = seriesType.VoucherSeriesTypeId,
                                };
                                VoucherManager.AddVoucherSeries(entities, newVoucherSerie, actorCompanyId, accountYear.AccountYearId, newVoucherSerie.VoucherSeriesTypeId);
                            }

                            voucherSerie = VoucherManager.GetVoucherSerieByYear(entities, accountYear.AccountYearId, voucherSeriesTypeId);
                            if (voucherSerie == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(8403, "Verifikatserie saknas"));
                        }
                        else
                        {
                            return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(8403, "Verifikatserie saknas"));
                        }
                    }

                    if (!supplierInvoiceHeadIO.CurrencyId.HasValue)
                        supplierInvoiceHeadIO.CurrencyId = GetCurrencyId(entities, supplierInvoiceHeadIO.Currency);

                    if (!supplierInvoiceHeadIO.SupplierId.HasValue)
                    {
                        Supplier supplier = GetSupplier(entities, actorCompanyId, supplierInvoiceHeadIO.SupplierNr);
                        if (supplier != null)
                            supplierInvoiceHeadIO.SupplierId = supplier.ActorSupplierId;
                    }

                    #endregion

                    #region Validation

                    #region Mandatory Values

                    if (!supplierInvoiceHeadIO.SupplierId.HasValue && (supplierInvoiceHeadIO.Type != (int)TermGroup_IOType.Inexchange))
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8389, "Leverantör kunde inte mappas"));
                        return result;
                    }

                    if (string.IsNullOrEmpty(supplierInvoiceHeadIO.SupplierInvoiceNr))
                        supplierInvoiceHeadIO.SupplierInvoiceNr = GetText(8391, "Fakturanr ej angivet");

                    if (!supplierInvoiceHeadIO.CurrencyId.HasValue || supplierInvoiceHeadIO.CurrencyId.Value == 0)
                    {
                        Supplier supplier = GetSupplier(entities, actorCompanyId, supplierInvoiceHeadIO.SupplierNr);
                        if (supplier != null)
                            supplierInvoiceHeadIO.CurrencyId = supplier.CurrencyId;
                        else
                        {
                            CompCurrency baseCurrency = (from c in entities.CompCurrency
                                                         where c.ActorCompanyId == actorCompanyId &&
                                                         c.BaseCurrency
                                                         select c).FirstOrDefault();
                            if (baseCurrency != null)
                                supplierInvoiceHeadIO.CurrencyId = baseCurrency.CurrencyId;
                        }

                        if (!supplierInvoiceHeadIO.CurrencyId.HasValue)
                        {
                            result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8392, "Valuta ej angiven"));
                            return result;
                        }
                    }

                    if (!supplierInvoiceHeadIO.BillingType.HasValue)
                    {
                        supplierInvoiceHeadIO.BillingType = (int)TermGroup_BillingType.Debit;
                    }

                    if (!supplierInvoiceHeadIO.InvoiceDate.HasValue && !supplierInvoiceHeadIO.DueDate.HasValue && !supplierInvoiceHeadIO.VoucherDate.HasValue)
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8397, "Fakturadatum, förfallodatum eller verifikatdatum ej angiven"));
                        return result;
                    }

                    #endregion

                    #endregion

                    #region Create entities

                    #region SupplierInvoice

                    //Use invoiceId if passed
                    SupplierInvoice supplierInvoice = null;
                    if (supplierInvoiceHeadIO.InvoiceId.HasValue && supplierInvoiceHeadIO.InvoiceId.Value > 0)
                    {
                        supplierInvoice = SupplierInvoiceManager.GetSupplierInvoice(entities, supplierInvoiceHeadIO.InvoiceId.Value, loadOrigin: true, loadVoucherSeries: true, loadPaymentMethod: true, loadInvoiceRow: true, loadInvoiceAccountRow: true);

                        foreach (var row in supplierInvoice.ActiveSupplierInvoiceRows)
                        {
                            row.State = (int)SoeEntityState.Deleted;
                            foreach (var accountRow in row.ActiveSupplierInvoiceAccountRows)
                            {
                                accountRow.State = (int)SoeEntityState.Deleted;
                            }
                        }

                        SaveChanges(entities);
                    }

                    if (supplierInvoice == null)
                    {
                        #region Add

                        newSupplierInvoice = true;

                        #region Origin

                        // Add Origin
                        var origin = new Origin()
                        {
                            Type = (int)SoeOriginType.SupplierInvoice,
                            Status = supplierInvoiceHeadIO.OriginStatus ?? (int)SoeOriginStatus.Draft,
                            Description = supplierInvoiceHeadIO.Note,

                            //Set FK
                            VoucherSeriesId = voucherSerie.VoucherSeriesId,
                            VoucherSeriesTypeId = voucherSerie.VoucherSeriesTypeId,
                            ActorCompanyId = actorCompanyId,
                        };
                        SetCreatedProperties(origin);

                        #endregion

                        #region SupplierInvoice

                        #region VoucherSeries

                        VoucherHead voucherHead = null;

                        if (supplierInvoiceHeadIO.VoucherDate.HasValue && !string.IsNullOrEmpty(supplierInvoiceHeadIO.VoucherNr) && accountYear != null)
                        {
                            List<VoucherSeries> voucherSeries = VoucherManager.GetVoucherSeriesByYear(entities, accountYear.AccountYearId, actorCompanyId, false, false);
                            if (!voucherSeries.IsNullOrEmpty())
                            {
                                bool foundVoucherHead = false;

                                foreach (var serie in voucherSeries)
                                {
                                    if (foundVoucherHead)
                                        continue;

                                    if (int.TryParse(supplierInvoiceHeadIO.VoucherNr, out int voucherNr) && voucherNr != 0)
                                    {
                                        voucherHead = VoucherManager.GetVoucherHeadByNr(entities, voucherNr, serie.VoucherSeriesId, actorCompanyId, false, false, false, false);
                                        if (voucherHead != null && voucherHead.Date == supplierInvoiceHeadIO.VoucherDate)
                                            foundVoucherHead = true;
                                    }
                                }
                            }
                        }

                        #endregion

                        supplierInvoice = new SupplierInvoice()
                        {
                            // Inherited from Invoice
                            Type = (int)SoeInvoiceType.SupplierInvoice,

                            InvoiceNr = supplierInvoiceHeadIO.SupplierInvoiceNr,
                            // Set references
                            Origin = origin
                        };

                        if (voucherHead != null)
                            supplierInvoice.VoucherHead = voucherHead;

                        if (specialFunctionality != null && specialFunctionality.Any(v => v.ToLower().Equals("icon")))
                        {
                            supplierInvoice.StatusIcon = (int)SoeStatusIcon.Imported;
                        }
                        else if (!string.IsNullOrEmpty(supplierInvoiceHeadIO.Note) && (supplierInvoiceHeadIO.Note.Equals("icon")))
                        {
                            supplierInvoiceHeadIO.Note = null;
                            supplierInvoice.StatusIcon = (int)SoeStatusIcon.Imported;
                        }

                        SetCreatedProperties(supplierInvoice);
                        #endregion

                        entities.Origin.AddObject(origin);

                        #endregion
                    }
                    else
                    {
                        #region Update

                        SetModifiedProperties(supplierInvoice);

                        if (!supplierInvoice.OriginReference.IsLoaded)
                            supplierInvoice.OriginReference.Load();

                        if (supplierInvoiceHeadIO.OriginStatus.HasValue)
                            supplierInvoice.Origin.Status = supplierInvoiceHeadIO.OriginStatus.Value;

                        SetModifiedProperties(supplierInvoice.Origin);

                        #endregion
                    }

                    #region Add/Update

                    if (supplierInvoiceHeadIO.VATAmount == 0)
                    {
                        var supplierVatType = SupplierManager.GetSupplierVatType(entities, supplierInvoiceHeadIO.SupplierId.GetValueOrDefault(), actorCompanyId);
                        supplierInvoice.VatType = supplierVatType == (int)TermGroup_InvoiceVatType.Contractor ? (int)TermGroup_InvoiceVatType.Contractor : (int)TermGroup_InvoiceVatType.NoVat;
                    }
                    else
                    {
                        supplierInvoice.VatType = (int)TermGroup_InvoiceVatType.Merchandise;
                    }

                    supplierInvoice.BillingType = supplierInvoiceHeadIO.BillingType.Value;
                    supplierInvoice.SeqNr = supplierInvoiceHeadIO.SeqNr;
                    supplierInvoice.InvoiceDate = supplierInvoiceHeadIO.InvoiceDate;
                    supplierInvoice.DueDate = supplierInvoiceHeadIO.DueDate;
                    supplierInvoice.VoucherDate = supplierInvoiceHeadIO.VoucherDate.HasValue ? supplierInvoiceHeadIO.VoucherDate : supplierInvoiceHeadIO.InvoiceDate;
                    supplierInvoice.ReferenceOur = string.IsNullOrEmpty(supplierInvoiceHeadIO.ReferenceOur) ? string.Empty : supplierInvoiceHeadIO.ReferenceOur;
                    supplierInvoice.ReferenceYour = string.IsNullOrEmpty(supplierInvoiceHeadIO.ReferenceYour) ? string.Empty : supplierInvoiceHeadIO.ReferenceYour;
                    supplierInvoice.OCR = string.IsNullOrEmpty(supplierInvoiceHeadIO.OCR) ? string.Empty : supplierInvoiceHeadIO.OCR;
                    supplierInvoice.ExternalId = supplierInvoiceHeadIO.ExternalId;

                    supplierInvoice.TotalAmount = (supplierInvoiceHeadIO.BillingType == (int)TermGroup_BillingType.Credit && supplierInvoiceHeadIO.TotalAmount.GetValueOrDefault() > 0) ? decimal.Negate(supplierInvoiceHeadIO.TotalAmount.Value) : supplierInvoiceHeadIO.TotalAmount.GetValueOrDefault();
                    supplierInvoice.TotalAmountCurrency = (supplierInvoiceHeadIO.BillingType == (int)TermGroup_BillingType.Credit && supplierInvoiceHeadIO.TotalAmountCurrency.GetValueOrDefault() > 0) ? decimal.Negate(supplierInvoiceHeadIO.TotalAmountCurrency.Value) : supplierInvoiceHeadIO.TotalAmountCurrency.GetValueOrDefault();


                    if (supplierInvoice.TotalAmountCurrency == 0 && supplierInvoice.TotalAmount != 0)
                        supplierInvoice.TotalAmountCurrency = supplierInvoice.TotalAmount;

                    supplierInvoice.VATAmount = (supplierInvoiceHeadIO.BillingType == (int)TermGroup_BillingType.Credit && supplierInvoiceHeadIO.VATAmount.GetValueOrDefault() > 0) ? decimal.Negate(supplierInvoiceHeadIO.VATAmount.Value) : supplierInvoiceHeadIO.VATAmount.GetValueOrDefault();
                    supplierInvoice.VATAmountCurrency = (supplierInvoiceHeadIO.BillingType == (int)TermGroup_BillingType.Credit && supplierInvoiceHeadIO.VATAmountCurrency.GetValueOrDefault() > 0) ? decimal.Negate(supplierInvoiceHeadIO.VATAmountCurrency.Value) : supplierInvoiceHeadIO.VATAmountCurrency.GetValueOrDefault();

                    if (supplierInvoice.VATAmountCurrency == 0 && supplierInvoice.VATAmount != 0)
                        supplierInvoice.VATAmountCurrency = supplierInvoice.VATAmount;

                    if (supplierInvoiceHeadIO.VatPercent.HasValue)
                    {
                        var vatCode = AccountManager.GetVatCodeByVateRate(entities, actorCompanyId, supplierInvoiceHeadIO.VatPercent.Value);
                        supplierInvoice.VatCodeId = vatCode != null ? vatCode.VatCodeId : (int?)null;
                    }

                    if (!string.IsNullOrEmpty(supplierInvoiceHeadIO.OrderNr))
                        SupplierInvoiceManager.SetSupplierOrderNr(entities, supplierInvoice, supplierInvoiceHeadIO.OrderNr, actorCompanyId, false, out int customerInvoiceId);

                    #region Fix Currency

                    if (supplierInvoiceHeadIO.CurrencyId.HasValue && supplierInvoiceHeadIO.CurrencyRate.HasValue && supplierInvoiceHeadIO.CurrencyRate != 0 && supplierInvoice.TotalAmountCurrency == supplierInvoice.TotalAmount && supplierInvoiceHeadIO.CurrencyDate.HasValue)
                    {
                        //When importing we asume that a single amount value equals the amount in the foreign currency. We therefore need to adjust the amounts.
                        supplierInvoice.TotalAmount = supplierInvoice.TotalAmountCurrency * supplierInvoiceHeadIO.CurrencyRate.Value;

                        if (supplierInvoice.VATAmountCurrency == supplierInvoice.VATAmount)
                            supplierInvoice.VATAmount = supplierInvoice.VATAmountCurrency * supplierInvoiceHeadIO.CurrencyRate.Value;

                        var existingCurrencyRate = CountryCurrencyManager.GetCurrencyRateFromCurrencyId(entities, supplierInvoiceHeadIO.CurrencyId.Value, actorCompanyId, supplierInvoiceHeadIO.CurrencyDate.Value.Date);
                        if (supplierInvoiceHeadIO.CurrencyId.Value != baseCurrencyId && supplierInvoiceHeadIO.CurrencyRate.Value != existingCurrencyRate)
                        {
                            var transactionCurrency = CountryCurrencyManager.GetCurrency(entities, supplierInvoiceHeadIO.CurrencyId.Value);
                            CountryCurrencyManager.CreateCurrencyRate(entities, transactionCurrency, supplierInvoiceHeadIO.CurrencyDate.Value.Date, (1 / supplierInvoiceHeadIO.CurrencyRate.Value), supplierInvoiceHeadIO.CurrencyRate.Value, TermGroup_CurrencySource.Manually, actorCompanyId);
                        }

                    }

                    #endregion

                    supplierInvoice.PaidAmount = supplierInvoiceHeadIO.PaidAmount ?? 0;
                    supplierInvoice.PaidAmountCurrency = supplierInvoiceHeadIO.PaidAmountCurrency ?? 0;

                    if (supplierInvoice.PaidAmountCurrency == 0 && supplierInvoice.PaidAmount != 0)
                        supplierInvoice.PaidAmountCurrency = supplierInvoice.PaidAmount;

                    supplierInvoice.FullyPayed = supplierInvoiceHeadIO.FullyPayed ?? false;
                    supplierInvoice.CurrencyRate = supplierInvoiceHeadIO.CurrencyRate ?? 1;
                    supplierInvoice.CurrencyDate = supplierInvoiceHeadIO.CurrencyDate ?? DateTime.Now.Date;
                    supplierInvoice.OnlyPayment = false;


                    supplierInvoice.InterimInvoice = false;
                    supplierInvoice.MultipleDebtRows = false;
                    supplierInvoice.BlockPayment = false;

                    if (supplierInvoiceHeadIO.Attachements != null && supplierInvoiceHeadIO.Attachements.Any(x => !x.Key.StartsWith("InvoiceImage.")))
                    {
                        supplierInvoice.StatusIcon = supplierInvoice.StatusIcon |= (int)SoeStatusIcon.Attachment;
                    }

                    #region Payments

                    PaymentInformationRow paymentInformationRow = null;

                    if (!string.IsNullOrEmpty(supplierInvoiceHeadIO.PaymentNr) && supplierInvoiceHeadIO.SupplierId.HasValue)
                    {
                        if (supplierInvoiceHeadIO.PaymentNumbers != null && supplierInvoiceHeadIO.PaymentNumbers.Count > 1)
                        {
                            var defaultPaymentInformation = GetDefaultPaymentInformationRow(entities, supplierInvoiceHeadIO.SupplierId.Value);
                            if (defaultPaymentInformation != null)
                            {
                                var defaultSysPaymentTypeId = defaultPaymentInformation.SysPaymentTypeId;
                                if (supplierInvoiceHeadIO.PaymentNumbers.TryGetValue(defaultPaymentInformation.SysPaymentTypeId, out string paymentNumber) && defaultPaymentInformation.PaymentNr == paymentNumber)
                                {
                                    paymentInformationRow = defaultPaymentInformation;
                                }
                            }
                        }

                        if (paymentInformationRow == null)
                        {
                            paymentInformationRow = PaymentManager.GetPaymentInformationRowForActor(entities, supplierInvoiceHeadIO.SupplierId.Value, supplierInvoiceHeadIO.PaymentNr);
                            if (paymentInformationRow == null)
                            {
                                var paymentInformation = PaymentManager.GetPaymentInformationFromActor(entities, supplierInvoiceHeadIO.SupplierId.Value, false, false);
                                if (paymentInformation == null && supplierInvoiceHeadIO.SysPaymentType.HasValue)
                                {
                                    var rowDto = new PaymentInformationRowDTO { PaymentNr = supplierInvoiceHeadIO.PaymentNr, SysPaymentTypeId = supplierInvoiceHeadIO.SysPaymentType.Value };
                                    PaymentManager.SavePaymentInformation(entities, transaction, new List<PaymentInformationRowDTO> { rowDto }, supplierInvoiceHeadIO.SupplierId.Value, supplierInvoiceHeadIO.SysPaymentType.Value, actorCompanyId, false, false, SoeEntityType.Supplier);
                                }
                                else if (paymentInformation != null && supplierInvoiceHeadIO.SysPaymentType.HasValue)
                                {
                                    paymentInformationRow = PaymentManager.AddPaymentInformationRowToPaymentInformation(paymentInformation, (TermGroup_SysPaymentType)supplierInvoiceHeadIO.SysPaymentType.Value, supplierInvoiceHeadIO.PaymentNr, false);
                                }
                            }
                        }
                    }

                    if (paymentInformationRow == null && supplierInvoiceHeadIO.SupplierId.HasValue)
                        paymentInformationRow = GetDefaultPaymentInformationRow(entities, supplierInvoiceHeadIO.SupplierId.Value);

                    supplierInvoice.SysPaymentTypeId = paymentInformationRow != null ? paymentInformationRow.SysPaymentTypeId : (int?)null;
                    supplierInvoice.PaymentNr = paymentInformationRow != null ? paymentInformationRow.PaymentNr : "";

                    #endregion

                    //Set FK
                    supplierInvoice.ActorId = supplierInvoiceHeadIO.SupplierId;
                    supplierInvoice.CurrencyId = supplierInvoiceHeadIO.CurrencyId.Value;

                    #endregion

                    #endregion

                    #region Save

                    result = SaveChanges(entities);
                    if (result.Success)
                    {
                        supplierInvoiceHeadIO.InvoiceId = supplierInvoice.InvoiceId;
                        supplierInvoiceHeadIO.Status = (int)TermGroup_IOStatus.Processed;
                    }
                    else
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8394, "Leverantörsfaktura kunde inte skapas") + "\n" + result.ErrorMessage);
                        return result;
                    }

                    //Update counters
                    if (newSupplierInvoice)
                        itemsAdded++;
                    else
                        itemsUpdated++;

                    #endregion

                    #region Create SupplierInvoiceRows

                    if (supplierInvoiceHeadIO.SupplierInvoiceAccountingRowIO.Count > 0)
                        result = AddSupplierInvoiceRows(entities, supplierInvoice, supplierInvoiceHeadIO.SupplierInvoiceAccountingRowIO.Where(x => x.Amount != 0 && x.Status == (int)TermGroup_IOStatus.UnderProcessing).ToList(), actorCompanyId);
                    else
                        result = SupplierInvoiceManager.AddSupplierInvoiceRows(entities, supplierInvoice, supplierInvoiceHeadIO.ProductRows, actorCompanyId);

                    if (result.Success)
                        result = SaveChanges(entities);

                    if (!result.Success)
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8395, "Konteringsrader kunde inte skapas") + "\n" + result.ErrorMessage);
                        return result;
                    }

                    #endregion

                    #endregion

                    #region Calculate currency

                    //Calculate currency amounts
                    CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, supplierInvoice);

                    result = SaveChanges(entities);
                    if (!result.Success)
                    {
                        result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8396, "Valutauträkningar kunde inte genomföras") + "\n" + result.ErrorMessage);
                        return result;
                    }

                    #endregion

                    #region Add attachments
                    if (supplierInvoiceHeadIO.Attachements != null)
                    {
                        foreach (var attachement in supplierInvoiceHeadIO.Attachements)
                        {
                            var dataStorage = new DataStorageRecordExtendedDTO
                            {
                                Data = attachement.Value,
                                Entity = attachement.Key.StartsWith("InvoiceImage.") ? SoeEntityType.SupplierInvoice : SoeEntityType.None,
                                RecordId = (int)supplierInvoiceHeadIO.InvoiceId,
                                Description = attachement.Key,
                                Type = SoeDataStorageRecordType.OrderInvoiceFileAttachment,
                                RecordNumber = attachement.Key,
                                FileName = attachement.Key
                            };

                            if (attachement.Key == "InvoiceImage.pdf")
                            {
                                dataStorage.Type = SoeDataStorageRecordType.InvoicePdf;
                            }
                            else if (attachement.Key.StartsWith("InvoiceImage.")) //We assume then its an image files of some sort...
                            {
                                dataStorage.Type = SoeDataStorageRecordType.InvoiceBitmap;
                            }

                            result = GeneralManager.SaveDataStorageRecord(entities, actorCompanyId, dataStorage, false);
                            if (result.Success) {
                                supplierInvoice.ImageStorageType = (int)SoeInvoiceImageStorageType.StoredInInvoiceDataStorage;
                            }
                        }
                    }
                    #endregion

                    #region Save product rows
                    if (supplierInvoiceHeadIO.ProductRows != null && SettingManager.GetCompanyBoolSetting(CompanySettingType.SupplierInvoiceProductRowsImport))
                    {
                        foreach (var productRow in supplierInvoiceHeadIO.ProductRows)
                        {
                            productRow.SupplierInvoiceId = (int)supplierInvoiceHeadIO.InvoiceId;
                        }
                        result = SupplierInvoiceManager.SaveSupplierInvoiceProductRows(entities, actorCompanyId, supplierInvoice, supplierInvoiceHeadIO.ProductRows);
                    }

                    #endregion

                    //Commit transaction
                    if (result.Success)
                        transaction.Complete();
                    #endregion
                }
                catch (Exception ex)
                {
                    result.Exception = ex;
                    result.ErrorMessage = ex.Message;
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);
                }
            }

            return result;
        }

        #region Rows

        private ActionResult AddSupplierInvoiceRows(CompEntities entities, SupplierInvoice supplierInvoice, List<SupplierInvoiceAccountingRowIO> ios, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            List<Account> accounts = AccountManager.GetAccountsByCompany(entities, actorCompanyId, loadAccountDim: true);

            //Dont cache
            List<AccountInternal> accountInternals = AccountManager.GetAccountInternals(entities, actorCompanyId, true, true);

            int accountingRowNr = 1;

            //Hardcode dimnr (2-6) according to ricardo
            foreach (var io in ios)
            {
                #region Decide accountids

                Account accountStd = null;
                List<Account> parentAccounts = new List<Account>();

                if (!string.IsNullOrEmpty(io.AccountNr) && accounts.Any(a => a.AccountNr == io.AccountNr && a.AccountDim != null && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD))
                    accountStd = accounts.FirstOrDefault(a => a.AccountNr == io.AccountNr && a.AccountDim != null && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD);
                else if (accounts.Any(a => a.AccountNr == "FEL" && a.AccountDim != null && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD))
                    accountStd = accounts.FirstOrDefault(a => a.AccountNr == "FEL" && a.AccountDim != null && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD);
                else
                    continue;

                if (accountStd != null)
                    io.Dim1Id = accountStd.AccountId;

                if (!string.IsNullOrEmpty(io.AccountDim2Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim2Nr && a.AccountDim.AccountDimNr == 2);
                    if (account != null)
                        io.Dim2Id = account.AccountId;
                }

                if (!string.IsNullOrEmpty(io.AccountDim3Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim3Nr && a.AccountDim.AccountDimNr == 3);
                    if (account != null)
                    {
                        io.Dim3Id = account.AccountId;

                        if (account.ParentAccountId != null)
                        {
                            var parentAccount = accounts.FirstOrDefault(a => a.AccountId == account.ParentAccountId);
                            if (parentAccount != null)
                                parentAccounts.Add(parentAccount);
                        }
                    }
                }
                if (!string.IsNullOrEmpty(io.AccountDim4Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim4Nr && a.AccountDim.AccountDimNr == 4);
                    if (account != null)
                        io.Dim4Id = account.AccountId;
                }
                if (!string.IsNullOrEmpty(io.AccountDim5Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim5Nr && a.AccountDim.AccountDimNr == 5);
                    if (account != null)
                        io.Dim5Id = account.AccountId;
                }
                if (!string.IsNullOrEmpty(io.AccountDim6Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim6Nr && a.AccountDim.AccountDimNr == 6);
                    if (account != null)
                        io.Dim6Id = account.AccountId;
                }

                foreach (var account in parentAccounts)
                {
                    switch (account.AccountDim.AccountDimNr)
                    {
                        case 2:
                            if (io.Dim2Id == 0)
                                io.Dim2Id = account.AccountId;
                            break;
                        case 3:
                            if (io.Dim3Id == 0)
                                io.Dim3Id = account.AccountId;
                            break;
                        case 4:
                            if (io.Dim4Id == 0)
                                io.Dim4Id = account.AccountId;
                            break;
                        case 5:
                            if (io.Dim5Id == 0)
                                io.Dim5Id = account.AccountId;
                            break;
                        case 6:
                            if (io.Dim6Id == 0)
                                io.Dim6Id = account.AccountId;
                            break;
                    }
                }

                #endregion

                result = AddSupplierInvoiceRow(entities, supplierInvoice, io, actorCompanyId, accountInternals, ref accountingRowNr);
                if (result.Success)
                {
                    io.Status = (int)TermGroup_IOStatus.Processed;
                }
                else
                    break;
            }

            return result;
        }

        private ActionResult AddSupplierInvoiceRow(CompEntities entities, SupplierInvoice supplierInvoice, SupplierInvoiceAccountingRowIO io, int actorCompanyId, List<AccountInternal> accountInternals, ref int rowNr)
        {
            if (supplierInvoice == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "SupplierInvoice");

            var row = SupplierInvoiceManager.ConvertToSupplierInvoiceRow(entities, io, actorCompanyId, accountInternals, rowNr, out ActionResult result);
            if (row != null)
                supplierInvoice.SupplierInvoiceRow.Add(row);

            return result;
        }

        #endregion

        public ActionResult ImportInboundMessageToScanningEntry(CompEntities entities, int actorCompanyId, CommunicatorMessage communicatorMessage)
        {
            ActionResult result = new ActionResult();

            string supplierNr = communicatorMessage.Subject.Split('#').Last();
            Supplier supplier = SupplierManager.GetSupplierBySupplierNr(actorCompanyId, supplierNr, false);
            string batchId = Guid.NewGuid().ToString();

            if (supplier == null)
            {
                result.Success = false;
                result.ErrorMessage = "Supplier Not Found";
                return result;
            }

            if (communicatorMessage.MessageAttachments.IsNullOrEmpty())
            {
                result.Success = false;
                result.ErrorMessage = "Attachment Not Found";
                return result;
            }

            Company company = CompanyManager.GetCompany(entities, actorCompanyId);
            int currencyId = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId).CurrencyId;

            foreach (var attachment in communicatorMessage.MessageAttachments)
            {
                ScanningEntry scanningEntry = new ScanningEntry()
                {
                    Type = (int)TermGroup_EDISourceType.Scanning,
                    MessageType = (int)TermGroup_ScanningMessageType.SupplierInvoice,
                    Status = (int)TermGroup_ScanningStatus.Unprocessed,
                    XML = new XDocument().ToString(),
                    Image = attachment.DataBase64,
                    BatchId = batchId,
                    DocumentId = batchId,
                    ReceiveTime = DateTime.Now,
                    OperatorMessage = String.Empty,
                    CompanyId = batchId, //Set below
                    SupplierId = batchId, //Set below   
                    LearningLogLevel = (int)ScanningLogLevel.NotSent,

                    //Set FK
                    ActorCompanyId = company.ActorCompanyId,
                };
                SetCreatedProperties(scanningEntry);
                entities.ScanningEntry.AddObject(scanningEntry);

                EdiEntry ediEntry = new EdiEntry()
                {
                    Type = (int)TermGroup_EDISourceType.Scanning,
                    MessageType = (int)TermGroup_EdiMessageType.SupplierInvoice,
                    Status = (int)TermGroup_EDIStatus.Unprocessed,
                    BillingType = (int)TermGroup_BillingType.Debit,
                    PDF = attachment.DataBase64,
                    XML = new XDocument().ToString(),
                    FileName = attachment.Name,
                    Date = DateTime.Now,
                    SeqNr = 0,
                    InvoiceId = null,
                    SysWholesellerId = 1,
                    ErrorCode = 0,
                    CurrencyId = currencyId,
                    CurrencyDate = DateTime.Now,
                    OrderStatus = (int)TermGroup_EDIOrderStatus.Unprocessed,
                    InvoiceStatus = (int)TermGroup_EDIInvoiceStatus.Processed,
                    ActorSupplierId = supplier.ActorSupplierId,

                    ImageStorageType = (attachment.DataBase64 != null) ? (int)SoeInvoiceImageStorageType.StoredInScanningEntry : (int)SoeInvoiceImageStorageType.NoImage,
                    //Set FK
                    ActorCompanyId = company.ActorCompanyId,

                    //Set references
                    ScanningEntryInvoice = scanningEntry,
                };
                SetCreatedProperties(ediEntry);
                entities.EdiEntry.AddObject(ediEntry);

                SaveChanges(entities);
            }

            return result;
        }

        public ActionResult ImportSupplierInvoiceImage(int actorCompanyId, string supplierInvoiceNr, string supplierNr, byte[] image, int? seqNumber = null)
        {
            ActionResult result = new ActionResult();

            Supplier supplier = SupplierManager.GetSupplierBySupplierNr(actorCompanyId, supplierNr, false);
            string batchId = Guid.NewGuid().ToString();

            if (supplier == null)
            {
                result.Success = false;
                result.ErrorMessage = "Supplier Not Found";
                return result;
            }

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            int supplierInvoiceId = SupplierInvoiceManager.GetSupplierInvoiceIdByNr(entitiesReadOnly, supplierInvoiceNr, supplier.ActorSupplierId, actorCompanyId, seqNr: seqNumber);
            if (supplierInvoiceId == 0)
            {
                result.Success = false;
                result.ErrorMessage = "SupplierInvoice Not Found";
                return result;
            }

            //Check pages in file
            byte[] tiffImage = image;
            MemoryStream tiffMemStream = new MemoryStream(tiffImage);
            tiffMemStream.Position = 0;

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                int currencyId = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId).CurrencyId;

                ScanningEntry scanningEntry = new ScanningEntry()
                {
                    Type = (int)TermGroup_EDISourceType.Scanning,
                    MessageType = (int)TermGroup_ScanningMessageType.SupplierInvoice,
                    Status = (int)TermGroup_ScanningStatus.Unprocessed,
                    XML = new XDocument().ToString(),
                    Image = tiffImage,
                    BatchId = batchId,
                    DocumentId = batchId,
                    ReceiveTime = DateTime.Now,
                    OperatorMessage = String.Empty,
                    CompanyId = batchId, //Set below
                    SupplierId = batchId, //Set below   
                    LearningLogLevel = (int)ScanningLogLevel.NotSent,

                    //Set FK
                    ActorCompanyId = company.ActorCompanyId,
                };
                SetCreatedProperties(scanningEntry);
                entities.ScanningEntry.AddObject(scanningEntry);

                EdiEntry ediEntry = new EdiEntry()
                {
                    Type = (int)TermGroup_EDISourceType.Scanning,
                    MessageType = (int)TermGroup_EdiMessageType.SupplierInvoice,
                    Status = (int)TermGroup_EDIStatus.Unprocessed,
                    BillingType = (int)TermGroup_BillingType.Debit,
                    PDF = null,
                    XML = new XDocument().ToString(),
                    FileName = supplierInvoiceNr + ".tif",
                    Date = DateTime.Now,
                    SeqNr = 0,
                    InvoiceId = supplierInvoiceId,
                    SysWholesellerId = 1,
                    ErrorCode = 0,
                    CurrencyId = currencyId,
                    CurrencyDate = DateTime.Now,
                    OrderStatus = (int)TermGroup_EDIOrderStatus.Unprocessed,
                    InvoiceStatus = (int)TermGroup_EDIInvoiceStatus.Processed,
                    ImageStorageType = tiffImage.Length > 0 ? (int)SoeInvoiceImageStorageType.StoredInScanningEntry : (int)SoeInvoiceImageStorageType.NoImage,
                    //Set FK
                    ActorCompanyId = company.ActorCompanyId,

                    //Set references
                    ScanningEntryInvoice = scanningEntry,
                };
                SetCreatedProperties(ediEntry);
                entities.EdiEntry.AddObject(ediEntry);

                SaveChanges(entities);
            }

            return result;
        }

        #endregion

        #region Help-methods

        private SupplierInvoiceHeadIO CreateSupplierInvoiceIO(CompEntities entities, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, SupplierInvoiceIORawData supplierInvoiceIORawData, string batchId, int actorCompanyId, Dictionary<string, string> dictSpecialFunctionality)
        {
            #region Prereq
            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);


            var headio = new SupplierInvoiceHeadIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
            };
            SetCreatedProperties(headio);
            entities.SupplierInvoiceHeadIO.AddObject(headio);

            #endregion

            #region Perform

            if (supplierInvoiceIORawData != null)
            {
                try
                {
                    #region Prereq

                    TermGroup_BillingType billingType = supplierInvoiceIORawData.BillingType.HasValue ? (TermGroup_BillingType)supplierInvoiceIORawData.BillingType.Value : TermGroup_BillingType.None;

                    //Set supplierid
                    Supplier supplier = null;
                    if (!string.IsNullOrEmpty(supplierInvoiceIORawData.SupplierNr))
                    {
                        supplier = GetSupplier(entities, actorCompanyId, supplierInvoiceIORawData.SupplierNr);
                    }

                    if ((supplier == null) && !string.IsNullOrEmpty(supplierInvoiceIORawData.SupplierOrgNr))
                    {
                        supplier = SupplierManager.GetSupplierByOrgNr(entities, actorCompanyId, supplierInvoiceIORawData.SupplierOrgNr);
                    }

                    if ((supplier == null) && !string.IsNullOrEmpty(supplierInvoiceIORawData.SupplierVatNr))
                    {
                        supplier = SupplierManager.GetSupplierByVatNr(entities, actorCompanyId, supplierInvoiceIORawData.SupplierVatNr);
                    }

                    if ((supplier == null) && !string.IsNullOrEmpty(supplierInvoiceIORawData.SupplierExternalNr))
                    {
                        var externalNbrs = ActorManager.GetInternalIdsListFromExternalNr(entities, TermGroup_CompanyExternalCodeEntity.Supplier, supplierInvoiceIORawData.SupplierExternalNr, actorCompanyId);
                        if (externalNbrs.Any())
                        {
                            supplier = SupplierManager.GetSupplier(entities, externalNbrs.First(), true, true, false, false);
                        }
                    }

                    if (supplier == null && type == TermGroup_IOType.WebAPI)
                    {
                        throw new Exception(GetText(8389, "Leverantör kunde inte mappas"));
                    }

                    int supplierInvoiceId = 0;

                    if (supplier != null)
                        supplierInvoiceId = SupplierInvoiceManager.GetSupplierInvoiceIdByNr(entities, supplierInvoiceIORawData.SupplierInvoiceNr, supplier.ActorSupplierId, actorCompanyId, billingType, supplierInvoiceIORawData.SeqNr);

                    #endregion

                    #region Fill SupplierInvoiceHeadIO

                    if (supplierInvoiceId != 0 && supplierInvoiceIORawData.SeqNr != null)
                        headio.InvoiceId = supplierInvoiceId;

                    if (supplier != null)
                        headio.SupplierId = supplier.ActorSupplierId;

                    headio.SupplierNr = supplierInvoiceIORawData.SupplierNr;
                    headio.SupplierInvoiceNr = supplierInvoiceIORawData.SupplierInvoiceNr;
                    headio.ExternalId = supplierInvoiceIORawData.ExternalId;
                    headio.SeqNr = supplierInvoiceIORawData.SeqNr;
                    headio.InvoiceDate = supplierInvoiceIORawData.InvoiceDate;
                    headio.DueDate = supplierInvoiceIORawData.DueDate;
                    headio.VoucherDate = supplierInvoiceIORawData.VoucherDate;
                    headio.ReferenceOur = supplierInvoiceIORawData.ReferenceOur;
                    headio.ReferenceYour = supplierInvoiceIORawData.ReferenceYour;
                    headio.OCR = supplierInvoiceIORawData.OCR;
                    headio.CurrencyRate = supplierInvoiceIORawData.CurrencyRate;
                    headio.CurrencyDate = supplierInvoiceIORawData.CurrencyDate;
                    headio.TotalAmount = supplierInvoiceIORawData.TotalAmount;
                    headio.TotalAmountCurrency = supplierInvoiceIORawData.TotalAmountCurrency;
                    headio.VATAmount = supplierInvoiceIORawData.VATAmount;
                    headio.VATAmountCurrency = supplierInvoiceIORawData.VATAmountCurrency;
                    headio.VatPercent = supplierInvoiceIORawData.VatPercent;
                    headio.PaidAmount = supplierInvoiceIORawData.PaidAmount;
                    headio.PaidAmountCurrency = supplierInvoiceIORawData.PaidAmountCurrency;
                    headio.RemainingAmount = supplierInvoiceIORawData.RemainingAmount;
                    headio.FullyPayed = supplierInvoiceIORawData.FullyPayed;
                    headio.PaymentNr = supplierInvoiceIORawData.PaymentNr;
                    headio.VoucherNr = supplierInvoiceIORawData.VoucherNr;
                    headio.CreateAccountingInXE = supplierInvoiceIORawData.CreateAccountingInXE;
                    headio.Note = supplierInvoiceIORawData.Note;
                    headio.Currency = supplierInvoiceIORawData.Currency;
                    headio.BillingType = supplierInvoiceIORawData.BillingType;
                    headio.OriginStatus = supplierInvoiceIORawData.OriginStatus;
                    headio.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    headio.SysPaymentType = (int)supplierInvoiceIORawData.SysPaymentType;
                    headio.OrderNr = supplierInvoiceIORawData.OrderNr?.Left(40);

                    //Set currencyId
                    headio.CurrencyId = GetCurrencyId(entities, headio.Currency, doNotFallBackOnBaseCurrency: true);
                    if (headio.CurrencyId == 0)
                    {
                        if (string.IsNullOrEmpty(headio.Currency))
                            headio.CurrencyId = GetBaseCurrencyId(entities);
                        else
                            headio.CurrencyId = GetBaseCurrencyId(entities);
                    }

                    // Partly payed - (set VAT to zero and totalamount to remainingamount, if specialfunctionality contains clearvatonremaining)
                    if (dictSpecialFunctionality != null && dictSpecialFunctionality.Keys.Any(k => k.ToLower().Equals("clearvatonremaining")) &&
                        headio.RemainingAmount != null && headio.RemainingAmount != 0 && headio.TotalAmount != headio.RemainingAmount)
                    {
                        headio.TotalAmount = headio.RemainingAmount;
                        headio.VATAmount = 0;
                        headio.VATAmountCurrency = 0;
                    }

                    #endregion

                    foreach (var supplierInvoiceAccountingRowIO in supplierInvoiceIORawData.Accountingrows)
                    {

                        SupplierInvoiceAccountingRowIO rowio = new SupplierInvoiceAccountingRowIO()
                        {
                            ActorCompanyId = actorCompanyId,
                            Source = (int)source,
                            Type = (int)type,
                            Status = (int)TermGroup_IOStatus.Unprocessed,
                            Import = true,
                            BatchId = batchId,
                            ImportHeadType = (int)headType,
                        };

                        headio.SupplierInvoiceAccountingRowIO.Add(rowio);
                        SetCreatedProperties(rowio);
                        entities.SupplierInvoiceAccountingRowIO.AddObject(rowio);

                        #region Fill SupplierInvoiceAccountingRowIO
                        if (accountSiedim1 != null && supplierInvoiceAccountingRowIO.AccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    supplierInvoiceAccountingRowIO.AccountDim2Nr = supplierInvoiceAccountingRowIO.AccountSieDim1;
                                    break;
                                case 3:
                                    supplierInvoiceAccountingRowIO.AccountDim3Nr = supplierInvoiceAccountingRowIO.AccountSieDim1;
                                    break;
                                case 4:
                                    supplierInvoiceAccountingRowIO.AccountDim4Nr = supplierInvoiceAccountingRowIO.AccountSieDim1;
                                    break;
                                case 5:
                                    supplierInvoiceAccountingRowIO.AccountDim5Nr = supplierInvoiceAccountingRowIO.AccountSieDim1;
                                    break;
                                case 6:
                                    supplierInvoiceAccountingRowIO.AccountDim6Nr = supplierInvoiceAccountingRowIO.AccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && supplierInvoiceAccountingRowIO.AccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    supplierInvoiceAccountingRowIO.AccountDim2Nr = supplierInvoiceAccountingRowIO.AccountSieDim6;
                                    break;
                                case 3:
                                    supplierInvoiceAccountingRowIO.AccountDim3Nr = supplierInvoiceAccountingRowIO.AccountSieDim6;
                                    break;
                                case 4:
                                    supplierInvoiceAccountingRowIO.AccountDim4Nr = supplierInvoiceAccountingRowIO.AccountSieDim6;
                                    break;
                                case 5:
                                    supplierInvoiceAccountingRowIO.AccountDim5Nr = supplierInvoiceAccountingRowIO.AccountSieDim6;
                                    break;
                                case 6:
                                    supplierInvoiceAccountingRowIO.AccountDim6Nr = supplierInvoiceAccountingRowIO.AccountSieDim6;
                                    break;
                            }
                        }
                        rowio.SupplierNr = supplierInvoiceAccountingRowIO.SupplierNr;
                        rowio.SupplierInvoiceNr = supplierInvoiceAccountingRowIO.SupplierInvoiceNr;
                        rowio.Amount = supplierInvoiceAccountingRowIO.Amount;
                        rowio.AmountCurrency = supplierInvoiceAccountingRowIO.AmountCurrency;
                        rowio.Quantity = supplierInvoiceAccountingRowIO.Quantity;
                        rowio.AccountNr = supplierInvoiceAccountingRowIO.AccountNr;
                        rowio.AccountDim2Nr = supplierInvoiceAccountingRowIO.AccountDim2Nr;
                        rowio.AccountDim3Nr = supplierInvoiceAccountingRowIO.AccountDim3Nr;
                        rowio.AccountDim4Nr = supplierInvoiceAccountingRowIO.AccountDim4Nr;
                        rowio.AccountDim5Nr = supplierInvoiceAccountingRowIO.AccountDim5Nr;
                        rowio.AccountDim6Nr = supplierInvoiceAccountingRowIO.AccountDim6Nr;
                        rowio.Text = supplierInvoiceAccountingRowIO.Text;
                        rowio.InterimRow = supplierInvoiceAccountingRowIO.InterimRow;
                        rowio.VatRow = supplierInvoiceAccountingRowIO.VatRow;
                        rowio.ContractorVatRow = supplierInvoiceAccountingRowIO.ContractorVatRow;
                        if (supplierInvoiceAccountingRowIO.CreditRow.HasValue)
                            rowio.CreditRow = supplierInvoiceAccountingRowIO.CreditRow.Value;
                        if (supplierInvoiceAccountingRowIO.DebitRow.HasValue)
                            rowio.DebitRow = supplierInvoiceAccountingRowIO.DebitRow.Value;

                        if (!supplierInvoiceAccountingRowIO.DebitRow.HasValue && !supplierInvoiceAccountingRowIO.CreditRow.HasValue)
                        {
                            if (!supplierInvoiceIORawData.BillingType.HasValue)
                            {
                                rowio.ErrorMessage = "CreditRow and DebitRow is not set and supplierinvoice has no BillingType";
                                headio.Status = (int)TermGroup_IOStatus.Error;
                                return headio;
                            }

                            // Use amount to determine debit or credit
                            if (rowio.Amount > 0 || rowio.AmountCurrency > 0)
                            {
                                rowio.DebitRow = true;
                            }
                            else if (rowio.Amount < 0 || rowio.AmountCurrency < 0)
                            {
                                rowio.DebitRow = false;
                            }

                            // Set credit as opposite to debit
                            rowio.CreditRow = !rowio.DebitRow;
                        }

                        rowio.Status = (int)TermGroup_IOStatus.UnderProcessing;
                        #endregion
                    }

                    #region ProductRows
                    if (supplierInvoiceIORawData.ProductRows != null && SettingManager.GetCompanyBoolSetting(CompanySettingType.SupplierInvoiceProductRowsImport))
                    {
                        headio.ProductRows = new List<SupplierInvoiceProductRowDTO>();
                        foreach (var productRowRaw in supplierInvoiceIORawData.ProductRows)
                        {
                            var productRow = new SupplierInvoiceProductRowDTO()
                            {
                                SellerProductNumber = productRowRaw.SellerProductNumber,
                                Text = productRowRaw.Text,
                                UnitCode = productRowRaw.UnitCode,
                                Quantity = productRowRaw.Quantity,
                                PriceCurrency = productRowRaw.PriceCurrency,
                                AmountCurrency = productRowRaw.AmountCurrency,
                                VatAmountCurrency = productRowRaw.VatAmountCurrency,
                                VatRate = productRowRaw.VatRate,
                                State = SoeEntityState.Active,
                                RowType = productRowRaw.SupplierInvoiceRowType,
                            };
                            headio.ProductRows.Add(productRow);
                        }
                    }
                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    headio.ErrorMessage = ex.Message;
                    headio.Status = (int)TermGroup_IOStatus.Error;
                }
            }

            #endregion

            return headio;
        }

        public List<SupplierInvoiceHeadIO> GetSupplierInvoiceHeadIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.SupplierInvoiceHeadIO.NoTracking();
            var query = (from io in entities.SupplierInvoiceHeadIO
                         where io.ActorCompanyId == actorCompanyId &&
                         io.BatchId == batchId
                         orderby io.SupplierInvoiceHeadIOId
                         select io);

            if (type != TermGroup_IOType.Unknown)
                query.Where(io => io.Type == (int)type);
            if (source != TermGroup_IOSource.Unknown)
                query.Where(io => io.Source == (int)source);

            List<SupplierInvoiceHeadIO> ios = query.ToList();
            if (!ios.IsNullOrEmpty())
            {
                int langId = GetLangId();
                Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);
                Dictionary<int, string> billingTypes = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);

                foreach (var io in ios)
                {
                    io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : string.Empty;
                    io.BillingTypeName = io.BillingType.HasValue && billingTypes.ContainsKey(io.BillingType.Value) ? billingTypes[io.BillingType.Value] : string.Empty;
                }
            }

            return ios;
        }

        private SupplierInvoiceHeadIO GetSupplierInvoiceHeadIO(CompEntities entities, int supplierInvoiceHeadIOId)
        {
            return (from io in entities.SupplierInvoiceHeadIO
                    where io.SupplierInvoiceHeadIOId == supplierInvoiceHeadIOId
                    select io).FirstOrDefault();
        }

        public ActionResult UpdateSupplierInvoiceHeadIO(List<SupplierInvoiceHeadIODTO> dtos)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (SupplierInvoiceHeadIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        SupplierInvoiceHeadIO io = GetSupplierInvoiceHeadIO(entities, dto.SupplierInvoiceHeadIOId);
                        if (io != null)
                        {
                            io.SupplierId = dto.SupplierId;
                            io.SupplierNr = dto.SupplierNr;
                            io.InvoiceId = dto.InvoiceId;
                            io.SupplierInvoiceNr = dto.SupplierInvoiceNr;
                            io.SeqNr = dto.SeqNr;
                            io.BillingType = dto.BillingType;
                            io.InvoiceDate = dto.InvoiceDate;
                            io.DueDate = dto.DueDate;
                            io.VoucherDate = dto.VoucherDate;
                            io.ReferenceOur = dto.ReferenceOur;
                            io.ReferenceYour = dto.ReferenceYour;
                            io.OCR = dto.OCR;
                            io.CurrencyId = dto.CurrencyId;
                            io.Currency = dto.Currency;
                            io.CurrencyRate = dto.CurrencyRate;
                            io.CurrencyDate = dto.CurrencyDate;
                            io.TotalAmount = dto.TotalAmount;
                            io.TotalAmountCurrency = dto.TotalAmountCurrency;
                            io.VATAmount = dto.VATAmount;
                            io.VATAmountCurrency = dto.VATAmountCurrency;
                            io.PaidAmount = dto.PaidAmount;
                            io.PaidAmountCurrency = dto.PaidAmountCurrency;
                            io.RemainingAmount = dto.RemainingAmount;
                            io.FullyPayed = dto.FullyPayed;
                            io.PaymentNr = dto.PaymentNr;
                            io.VoucherNr = dto.VoucherNr;
                            io.CreateAccountingInXE = dto.CreateAccountingInXE;
                            io.Note = dto.Note;

                            SetModifiedProperties(io);
                        }
                    }

                    // Save
                    result = SaveChanges(entities);

                    #endregion
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        public ActionResult ImportSupplierInvoiceHeadIO(List<int> supplierInvoiceHeadIOIds, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    List<SupplierInvoiceHeadIO> ios = (from io in entities.SupplierInvoiceHeadIO
                                                       where supplierInvoiceHeadIOIds.Contains(io.SupplierInvoiceHeadIOId)
                                                       select io).ToList();
                    foreach (SupplierInvoiceHeadIO io in ios)
                    {
                        io.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    }

                    result = ImportFromSupplierInvoiceHeadIO(ios, actorCompanyId);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        #endregion

        #endregion

        #region Stock

        public List<StockIODTO> GetStocks(int actorCompanyId)
        {
            return StockManager.GetStocks(actorCompanyId).Select(p => new StockIODTO
            {
                StockId = p.StockId,
                Code = p.Code,
                Name = p.Name ?? "",
            }).ToList();
        }

        #endregion
        #region TimeBalanceIO

        public List<TimeBalanceIODTO> GetTimeBalance(int actorCompanyId, DateTime date, List<string> employeeNumbers, List<TimeBalanceIODTO> ios, string code = "", List<Employee> employees = null, int decimalRound = 2)
        {
            List<TimeBalanceIODTO> timeBalances = new List<TimeBalanceIODTO>();

            List<TimeAccumulator> timeAccumulators = TimeAccumulatorManager.GetTimeAccumulators(actorCompanyId, loadEmployeeGroupRule: true);
            if (!string.IsNullOrEmpty(code))
                timeAccumulators = timeAccumulators.Where(w => w.Name.Equals(code, StringComparison.OrdinalIgnoreCase)).ToList();
            if (timeAccumulators.IsNullOrEmpty())
                return timeBalances;

            if (employees == null)
                employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, active: null);

            if (!employees.IsNullOrEmpty())
            {
                List<EmployeeGroup> employeeGroups = EmployeeManager.GetEmployeeGroups(actorCompanyId);

                foreach (Employee employee in employees)
                {
                    Employment employment = employee.GetEmployment(date);
                    if (employment != null)
                    {
                        List<TimeAccumulator> employeeTimeAccumulators = new List<TimeAccumulator>();

                        var employeeIos = ios != null ? ios.Where(w => w.EmployeeNr == employee.EmployeeNr).ToList() : new List<TimeBalanceIODTO>();
                        foreach (var io in employeeIos)
                        {
                            TimeAccumulator timeAccumulator = timeAccumulators.FirstOrDefault(f => f.Name.Equals(io.Code, StringComparison.OrdinalIgnoreCase));
                            if (timeAccumulator != null)
                                employeeTimeAccumulators.Add(timeAccumulator);
                        }

                        if (employeeTimeAccumulators.IsNullOrEmpty())
                            employeeTimeAccumulators = timeAccumulators;

                        GetTimeAccumulatorItemsInput timeAccInput = GetTimeAccumulatorItemsInput.CreateInput(actorCompanyId, parameterObject.UserId, employee.EmployeeId, date, date, calculateDay: true, calculatePeriod: true, calculatePlanningPeriod: true, calculateYear: true, calculateAccToday: true, calculateAccTodayValue: true);
                        using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                        List<TimeAccumulatorItem> items = TimeAccumulatorManager.GetTimeAccumulatorItems(entitiesReadOnly, timeAccInput, employeeTimeAccumulators, employee, employeeGroups: employeeGroups);
                        if (!items.IsNullOrEmpty())
                        {
                            foreach (var item in items)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.TimeAccumulator,
                                    Code = item.Name,
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(decimal.Divide(item.SumAccToday, 60), decimalRound)
                                });
                            }
                        }

                        List<EmployeeVacationSE> vacations = EmployeeManager.GetEmployeeVacationSEs(entitiesReadOnly, employee.EmployeeId);
                        var last = vacations.LastOrDefault();

                        if (last != null)
                        {
                            if (last.RemainingDaysPaid.HasValue && last.RemainingDaysPaid.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysPaid,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysPaid),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysPaid.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysUnpaid.HasValue && last.RemainingDaysUnpaid.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysUnPaid,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysUnPaid),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysUnpaid.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysOverdue.HasValue && last.RemainingDaysOverdue.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysOverdue,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysOverdue),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysOverdue.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysYear1.HasValue && last.RemainingDaysYear1.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysYear1,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysYear1),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysYear1.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysYear2.HasValue && last.RemainingDaysYear2.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysYear2,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysYear2),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysYear2.Value, decimalRound)
                                });
                            }


                            if (last.RemainingDaysYear3.HasValue && last.RemainingDaysYear3.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    AdjustmentDate = last.AdjustmentDate,
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysYear3,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysYear3),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysYear3.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysYear4.HasValue && last.RemainingDaysYear4.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysYear4,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysYear4),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysYear4.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysYear5.HasValue && last.RemainingDaysYear5.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysYear5,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysYear5),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysYear5.Value, decimalRound)
                                });
                            }

                            if (last.RemainingDaysAdvance.HasValue && last.RemainingDaysAdvance.Value != 0)
                            {
                                timeBalances.Add(new TimeBalanceIODTO()
                                {
                                    TimeBalanceIOType = TimeBalanceIOType.RemainingDaysAdvance,
                                    Code = EnumUtility.GetName<TimeBalanceIOType>(TimeBalanceIOType.RemainingDaysAdvance),
                                    Date = date,
                                    EmployeeNr = employee.EmployeeNr,
                                    Quantity = decimal.Round(last.RemainingDaysAdvance.Value, decimalRound)
                                });
                            }
                        }
                    }
                }
            }

            return timeBalances;
        }

        public ActionResult ImportTimeBalanceIO(TimeBalanceIOItem timeBalanceIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromTimeBalanceIO(timeBalanceIOItem.timeBalanceIOs, actorCompanyId);
        }

        public ActionResult ImportFromTimeBalanceIO(List<TimeBalanceIODTO> timeBalanceIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            List<TimeAccumulator> timeAccumulators = TimeAccumulatorManager.GetTimeAccumulators(actorCompanyId, loadEmployeeGroupRule: true);
            List<TimeBalanceIODTO> timeAccBalanceIOs = timeBalanceIOs.Where(w => w.TimeBalanceIOType == TimeBalanceIOType.TimeAccumulator).ToList();
            List<TimeBalanceIODTO> vacationBalanceIOs = timeBalanceIOs.Where(w =>
                                                                                    w.TimeBalanceIOType != TimeBalanceIOType.TimeAccumulator &&
                                                                                    w.TimeBalanceIOType != TimeBalanceIOType.Unknown &&
                                                                                    w.TimeBalanceIOType != TimeBalanceIOType.CurrentLASDays &&
                                                                                    w.TimeBalanceIOType != TimeBalanceIOType.BalanceLASDays).ToList();
            List<TimeBalanceIODTO> employeeFactorBalanceIOs = timeBalanceIOs.Where(w =>
                                                                                        w.TimeBalanceIOType == TimeBalanceIOType.CurrentLASDays ||
                                                                                        w.TimeBalanceIOType == TimeBalanceIOType.BalanceLASDays).ToList();
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, active: null);
            List<Employee> employeesByNumber = employees.Where(e => timeBalanceIOs.Select(s => s.EmployeeNr).Contains(e.EmployeeNr)).ToList();
            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(actorCompanyId);
            int created = 0;
            int updated = 0;
            List<TimeCodeTransactionDTO> dtos = new List<TimeCodeTransactionDTO>();

            if (!timeAccBalanceIOs.IsNullOrEmpty())
            {
                foreach (var onDate in timeAccBalanceIOs.GroupBy(g => g.Date))
                {
                    var existing = GetTimeBalance(actorCompanyId, onDate.Key, onDate.Select(s => s.EmployeeNr).ToList(), onDate.ToList(), employees: employeesByNumber, decimalRound: 4);

                    foreach (var onEmployee in onDate.GroupBy(g => g.EmployeeNr))
                    {
                        foreach (var item in onEmployee)
                        {
                            var existingOnEmployee = existing.FirstOrDefault(w => w.EmployeeNr == item.EmployeeNr && w.Code == item.Code);
                            if (existingOnEmployee != null)
                                item.Quantity = item.Quantity - existingOnEmployee.Quantity;
                        }
                    }
                }

                foreach (var item in timeAccBalanceIOs)
                {

                    TimeAccumulator timeAccumulator = timeAccumulators.FirstOrDefault(f => f.Name.Equals(item.Code, StringComparison.OrdinalIgnoreCase));
                    if (timeAccumulator == null)
                        continue;

                    if (!timeAccumulator.TimeAccumulatorTimeCode.IsLoaded)
                        timeAccumulator.TimeAccumulatorTimeCode.Load();

                    TimeCode timeCode = null;
                    TimeAccumulatorTimeCode timeAccumulatorTimeCode = timeAccumulator.TimeAccumulatorTimeCode.FirstOrDefault(s => s.ImportDefault) ?? timeAccumulator.TimeAccumulatorTimeCode.FirstOrDefault();
                    if (timeAccumulatorTimeCode != null)
                        timeCode = timeCodes.FirstOrDefault(f => f.TimeCodeId == timeAccumulatorTimeCode.TimeCodeId);

                    if (timeCode != null)
                    {
                        Employee employee = employeesByNumber.FirstOrDefault(f => f.EmployeeNr == item.EmployeeNr);
                        if (employee != null && employee.State == (int)SoeEntityState.Active)
                        {
                            var dto = new TimeCodeTransactionDTO();
                            dto.EmployeeId = employee.EmployeeId;
                            dto.TimeCodeId = timeCode.TimeCodeId;
                            dto.Quantity = decimal.Round(decimal.Multiply(item.Quantity, 60), 0);
                            dto.IsAddition = true;
                            dto.Start = item.Date;
                            dto.Stop = item.Date;
                            dto.IsRegistrationTypeQuantity = false;
                            dto.IsRegistrationTypeTime = true;
                            dto.TimePayrollTransactionItems = new List<TimePayrollTransactionDTO>();
                            dto.TimeInvoiceTransactionItems = new List<TimeInvoiceTransactionDTO>();
                            dto.Type = (SoeTimeCodeType)timeCode.Type;
                            dtos.Add(dto);
                        }
                        created++;
                    }
                }

                TimeEngineManager tim = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);
                result = tim.SaveTimeCodeTransactions(dtos);
            }

            if (result.Success && !employeeFactorBalanceIOs.IsNullOrEmpty())
            {
                using (CompEntities entities = new CompEntities())
                {
                    var existingEmployeeFactors = base.GetEmployeeFactorsFromCache(entities, CacheConfig.Company(actorCompanyId));

                    foreach (var employeeFactorBalance in employeeFactorBalanceIOs)
                    {
                        var employee = employeesByNumber.FirstOrDefault(f => f.EmployeeNr == employeeFactorBalance.EmployeeNr);

                        if (employee != null && employee.State == (int)SoeEntityState.Active)
                        {
                            TermGroup_EmployeeFactorType employeeFactorType = employeeFactorBalance.TimeBalanceIOType == TimeBalanceIOType.BalanceLASDays ? TermGroup_EmployeeFactorType.BalanceLasDays : TermGroup_EmployeeFactorType.CurrentLasDays;
                            var existing = existingEmployeeFactors.FirstOrDefault(f => f.EmployeeId == employee.EmployeeId && f.Type == (int)employeeFactorType && f.FromDate == employeeFactorBalance.Date);

                            if (existing == null && employeeFactorType == TermGroup_EmployeeFactorType.CurrentLasDays)
                            {
                                existing = existingEmployeeFactors.FirstOrDefault(f => f.EmployeeId == employee.EmployeeId && f.Type == (int)employeeFactorType);

                                if (existing != null)
                                {
                                    var allexisting = existingEmployeeFactors.Where(f => f.EmployeeId == employee.EmployeeId && f.Type == (int)employeeFactorType).ToList();

                                    // We only want one of these to exist on an employee.
                                    if (allexisting.Count > 1)
                                    {
                                        foreach (var item in allexisting.Where(w => w.EmployeeFactorId != existing.EmployeeFactorId))
                                        {
                                            var employeeFactorExisting = entities.EmployeeFactor.FirstOrDefault(f => f.EmployeeFactorId == existing.EmployeeFactorId);

                                            if (employeeFactorExisting != null)
                                            {
                                                employeeFactorExisting.State = (int)SoeEntityState.Deleted;
                                                SetModifiedProperties(employeeFactorExisting);
                                            }
                                        }
                                    }
                                }
                            }

                            EmployeeFactor employeeFactor;
                            if (existing == null)
                            {
                                employeeFactor = new EmployeeFactor();
                                employeeFactor.FromDate = employeeFactorBalance.Date;
                                employeeFactor.Factor = employeeFactorBalance.Quantity;
                                employeeFactor.Type = (int)employeeFactorType;
                                employeeFactor.EmployeeId = employee.EmployeeId;
                                entities.EmployeeFactor.AddObject(employeeFactor);
                                SetCreatedProperties(employeeFactor);
                                created++;
                            }
                            else
                            {
                                if (existing.Factor == employeeFactorBalance.Quantity)
                                    continue;

                                employeeFactor = entities.EmployeeFactor.FirstOrDefault(f => f.EmployeeFactorId == existing.EmployeeFactorId);

                                if (employeeFactorType == TermGroup_EmployeeFactorType.CurrentLasDays)
                                    employeeFactor.FromDate = employeeFactorBalance.Date;

                                employeeFactor.Factor = employeeFactorBalance.Quantity;
                                SetModifiedProperties(employeeFactor);
                            }
                        }
                    }

                    result = SaveChanges(entities);

                }
            }

            if (result.Success && !vacationBalanceIOs.IsNullOrEmpty())
            {
                using (CompEntities entities = new CompEntities())
                {
                    foreach (var employeeTimeBalances in vacationBalanceIOs.GroupBy(g => g.EmployeeNr))
                    {
                        var first = employeeTimeBalances.First();
                        var employee = employeesByNumber.FirstOrDefault(f => f.EmployeeNr == first.EmployeeNr);

                        if (employee != null && employee.State == (int)SoeEntityState.Active)
                        {
                            var emp = entities.Employee.First(f => f.EmployeeId == employee.EmployeeId);

                            int prevVacationSEId = 0;
                            List<EmployeeVacationSE> vacations = EmployeeManager.GetEmployeeVacationSEs(entities, employee.EmployeeId);
                            var last = vacations.LastOrDefault();

                            bool changes = false;

                            bool changesRemainingPaidDays = false;
                            bool changesVacationSavedDaysYear1 = false;
                            bool changesVacationSavedDaysYear2 = false;
                            bool changesVacationSavedDaysYear3 = false;
                            bool changesVacationSavedDaysYear4 = false;
                            bool changesVacationSavedDaysYear5 = false;
                            bool changesVacationRemainingDaysAdvance = false;
                            bool changesVacationSavedDaysYearOverdue = false;
                            bool changesVacationSavedDaysUnPaid = false;
                            bool changesAdjustmentDate = false;
                            var remainingpaidDays = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysPaid)?.Quantity.ToNullable();
                            var vacationSavedDaysYear1 = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysYear1)?.Quantity.ToNullable();
                            var vacationSavedDaysYear2 = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysYear2)?.Quantity.ToNullable();
                            var vacationSavedDaysYear3 = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysYear3)?.Quantity.ToNullable();
                            var vacationSavedDaysYear4 = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysYear4)?.Quantity.ToNullable();
                            var vacationSavedDaysYear5 = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysYear5)?.Quantity.ToNullable();
                            var vacationRemainingDaysAdvance = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysAdvance)?.Quantity.ToNullable();
                            var vacationSavedDaysYearOverdue = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysOverdue)?.Quantity.ToNullable();
                            var remainingUnPaidDays = employeeTimeBalances.FirstOrDefault(a => a.TimeBalanceIOType == TimeBalanceIOType.RemainingDaysUnPaid)?.Quantity.ToNullable();
                            var adjustmentDate = employeeTimeBalances.FirstOrDefault(f => f.AdjustmentDate.HasValue)?.AdjustmentDate;

                            if (last != null)
                            {
                                if (remainingpaidDays.HasValue && remainingpaidDays.Value != last.RemainingDaysPaid)
                                    changesRemainingPaidDays = true;
                                if (vacationSavedDaysYear1.HasValue && vacationSavedDaysYear1.Value != last.RemainingDaysYear1)
                                    changesVacationSavedDaysYear1 = true;
                                if (vacationSavedDaysYear2.HasValue && vacationSavedDaysYear2.Value != last.RemainingDaysYear2)
                                    changesVacationSavedDaysYear2 = true;
                                if (vacationSavedDaysYear3.HasValue && vacationSavedDaysYear3.Value != last.RemainingDaysYear3)
                                    changesVacationSavedDaysYear3 = true;
                                if (vacationSavedDaysYear4.HasValue && vacationSavedDaysYear4.Value != last.RemainingDaysYear4)
                                    changesVacationSavedDaysYear4 = true;
                                if (vacationSavedDaysYear5.HasValue && vacationSavedDaysYear5.Value != last.RemainingDaysYear5)
                                    changesVacationSavedDaysYear5 = true;
                                if (vacationRemainingDaysAdvance.HasValue && vacationRemainingDaysAdvance.Value != last.RemainingDaysAdvance)
                                    changesVacationRemainingDaysAdvance = true;
                                if (vacationSavedDaysYearOverdue.HasValue && vacationSavedDaysYearOverdue.Value != last.RemainingDaysOverdue)
                                    changesVacationSavedDaysYearOverdue = true;
                                if (remainingUnPaidDays.HasValue && remainingUnPaidDays.Value != last.RemainingDaysUnpaid)
                                    changesVacationSavedDaysUnPaid = true;
                                if (adjustmentDate != last.AdjustmentDate)
                                    changesAdjustmentDate = true;

                                changes = changesRemainingPaidDays || changesVacationSavedDaysYear1 || changesVacationSavedDaysYear2 || changesVacationSavedDaysYear3 || changesVacationSavedDaysYear4 || changesVacationSavedDaysYear5 || changesVacationSavedDaysYearOverdue || changesVacationSavedDaysUnPaid || changesVacationRemainingDaysAdvance || changesAdjustmentDate;
                            }
                            else
                            {
                                if (remainingpaidDays.HasValue)
                                    changesRemainingPaidDays = true;
                                if (vacationSavedDaysYear1.HasValue)
                                    changesVacationSavedDaysYear1 = true;
                                if (vacationSavedDaysYear2.HasValue)
                                    changesVacationSavedDaysYear2 = true;
                                if (vacationSavedDaysYear3.HasValue)
                                    changesVacationSavedDaysYear3 = true;
                                if (vacationSavedDaysYear4.HasValue)
                                    changesVacationSavedDaysYear4 = true;
                                if (vacationSavedDaysYear5.HasValue)
                                    changesVacationSavedDaysYear5 = true;
                                if (vacationSavedDaysYearOverdue.HasValue)
                                    changesVacationSavedDaysYearOverdue = true;
                                if (vacationRemainingDaysAdvance.HasValue)
                                    changesVacationRemainingDaysAdvance = true;
                                if (remainingUnPaidDays.HasValue)
                                    changesVacationSavedDaysUnPaid = true;
                                changes = true;
                            }

                            if (!changes)
                                continue;

                            foreach (EmployeeVacationSE vacation in vacations)
                            {
                                ChangeEntityState(vacation, SoeEntityState.Deleted);
                                prevVacationSEId = vacation.EmployeeVacationSEId;
                            }
                            EmployeeVacationSE newVacation = null;

                            if (prevVacationSEId != 0)
                            {
                                newVacation = last.Clone(emp, prevVacationSEId);

                                if (changesRemainingPaidDays)
                                    newVacation.RemainingDaysPaid = remainingpaidDays.Value;

                                if (changesVacationSavedDaysYear1)
                                    newVacation.RemainingDaysYear1 = vacationSavedDaysYear1.Value;

                                if (changesVacationSavedDaysYear2)
                                    newVacation.RemainingDaysYear2 = vacationSavedDaysYear2.Value;

                                if (changesVacationSavedDaysYear3)
                                    newVacation.RemainingDaysYear3 = vacationSavedDaysYear3.Value;

                                if (changesVacationSavedDaysYear4)
                                    newVacation.RemainingDaysYear4 = vacationSavedDaysYear4.Value;

                                if (changesVacationSavedDaysYear5)
                                    newVacation.RemainingDaysYear5 = vacationSavedDaysYear5.Value;

                                if (changesVacationRemainingDaysAdvance)
                                    newVacation.RemainingDaysAdvance = vacationRemainingDaysAdvance.Value;

                                if (changesVacationSavedDaysYearOverdue)
                                    newVacation.RemainingDaysOverdue = vacationSavedDaysYearOverdue.Value;

                                if (changesVacationSavedDaysUnPaid)
                                    newVacation.RemainingDaysUnpaid = remainingUnPaidDays.Value;
                            }
                            else
                            {
                                newVacation = new EmployeeVacationSE();
                                newVacation.Employee = emp;
                                newVacation.RemainingDaysPaid = remainingpaidDays ?? 0;
                                newVacation.RemainingDaysYear1 = vacationSavedDaysYear1 ?? 0;
                                newVacation.RemainingDaysYear2 = vacationSavedDaysYear2 ?? 0;
                                newVacation.RemainingDaysYear3 = vacationSavedDaysYear3 ?? 0;
                                newVacation.RemainingDaysYear4 = vacationSavedDaysYear4 ?? 0;
                                newVacation.RemainingDaysYear5 = vacationSavedDaysYear5 ?? 0;
                                newVacation.RemainingDaysOverdue = vacationSavedDaysYearOverdue ?? 0;
                                newVacation.RemainingDaysUnpaid = remainingUnPaidDays ?? 0;
                                newVacation.RemainingDaysAdvance = vacationRemainingDaysAdvance ?? 0;
                                entities.EmployeeVacationSE.AddObject(newVacation);
                            }

                            if (!vacations.Any())
                            {
                                SetCreatedProperties(newVacation);
                                created++;
                            }
                            else
                            {
                                newVacation.Created = vacations.First().Created;
                                newVacation.CreatedBy = vacations.First().CreatedBy;
                                SetModifiedProperties(newVacation);
                                updated++;
                            }

                            newVacation.AdjustmentDate = adjustmentDate;
                        }
                    }
                    result = SaveChanges(entities);
                }
            }

            if (result.ErrorMessage == null)
                result.ErrorMessage = string.Empty;

            result.ErrorMessage = $"Created:{created} Updated:{updated} out of {timeBalanceIOs.Count} {result.ErrorMessage}";


            return result;
        }

        #endregion

        #region TimeScheduleBlockIO

        public List<TimeScheduleBlockIODTO> GetTimeScheduleBlockIODTOs(int actorCompanyId, EvaluatedSelection es, DateTime? dateFrom, DateTime? dateTo, List<String> employeeNumbers)
        {
            List<TimeScheduleBlockIODTO> timeScheduleBlockIODTOs = new List<TimeScheduleBlockIODTO>();
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, active: null);
            List<Employee> employeesByNumber = employees.Where(e => employeeNumbers.Contains(e.EmployeeNr)).ToList();

            #region AccountDims

            List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId, onlyInternal: true);

            int accountDimId2 = 0;
            int accountDimId3 = 0;
            int accountDimId4 = 0;
            int accountDimId5 = 0;
            int accountDimId6 = 0;

            int accountDimNr = 2;
            foreach (var dim in accountDims.OrderBy(d => d.AccountDimNr))
            {
                if (accountDimNr == 2)
                    accountDimId2 = dim.AccountDimId;

                if (accountDimNr == 3)
                    accountDimId3 = dim.AccountDimId;

                if (accountDimNr == 4)
                    accountDimId4 = dim.AccountDimId;

                if (accountDimNr == 5)
                    accountDimId5 = dim.AccountDimId;

                if (accountDimNr == 6)
                    accountDimId6 = dim.AccountDimId;

                accountDimNr++;
            }

            #endregion

            #region ES

            if (es == null)
                es = new EvaluatedSelection();

            es.ActorCompanyId = actorCompanyId;

            if (dateFrom != null)
            {
                es.HasDateInterval = true;
                es.DateFrom = (DateTime)dateFrom;
            }


            if (dateTo != null)
            {
                es.HasDateInterval = true;
                es.DateTo = (DateTime)dateTo;
            }

            es.GetDetailedInformation = true;

            #endregion

            #region Get EmployeeIds

            #endregion

            #region Fill DTOs

            foreach (var employee in employeesByNumber)
            {
                if (es.GetDetailedInformation)
                {
                    var shifts = TimeScheduleManager.GetTimeSchedulePlanningShifts_ByProcedure(es.ActorCompanyId, es.UserId, employee.EmployeeId, es.RoleId, es.DateFrom, es.DateTo, new List<int> { employee.EmployeeId }, TimeSchedulePlanningMode.SchedulePlanning,
                                     TimeSchedulePlanningDisplayMode.Admin, false, false, false, includeShiftRequest: false);

                    foreach (var shift in shifts)
                    {
                        var timeScheduleBlockIODTO = new TimeScheduleBlockIODTO();
                        timeScheduleBlockIODTO.TimeScheduleTemplateBlockId = shift.TimeScheduleTemplateBlockId;
                        timeScheduleBlockIODTO.TimeScheduleTemplatePeriodId = shift.TimeScheduleTemplatePeriodId;
                        timeScheduleBlockIODTO.TimeScheduleEmployeePeriodId = shift.TimeScheduleEmployeePeriodId;
                        timeScheduleBlockIODTO.EmployeeNr = employee.EmployeeNr;
                        timeScheduleBlockIODTO.TimeScheduleTypeId = (int)shift.Type;
                        timeScheduleBlockIODTO.DayNumber = shift.DayNumber;
                        timeScheduleBlockIODTO.Description = shift.Description;

                        timeScheduleBlockIODTO.StartTime = shift.StartTime;
                        timeScheduleBlockIODTO.StopTime = shift.StopTime;
                        timeScheduleBlockIODTO.LengthMinutes = Convert.ToInt32(shift.NetTime);
                        timeScheduleBlockIODTO.Date = shift.StartTime.Date;

                        timeScheduleBlockIODTO.Break1Id = shift.Break1Id;
                        timeScheduleBlockIODTO.Break1StartTime = shift.Break1StartTime;
                        timeScheduleBlockIODTO.Break1Minutes = shift.Break1Minutes;
                        timeScheduleBlockIODTO.Break1Link = shift.Break1Link != null ? shift.Break1Link.ToString() : string.Empty;
                        timeScheduleBlockIODTO.Break1IsPreliminary = shift.Break1IsPreliminary;
                        timeScheduleBlockIODTO.Break2Id = shift.Break2Id;
                        timeScheduleBlockIODTO.Break2StartTime = shift.Break2StartTime;
                        timeScheduleBlockIODTO.Break2Minutes = shift.Break2Minutes;
                        timeScheduleBlockIODTO.Break2Link = shift.Break2Link != null ? shift.Break2Link.ToString() : string.Empty;
                        timeScheduleBlockIODTO.Break2IsPreliminary = shift.Break2IsPreliminary;
                        timeScheduleBlockIODTO.Break3Id = shift.Break3Id;
                        timeScheduleBlockIODTO.Break3StartTime = shift.Break3StartTime;
                        timeScheduleBlockIODTO.Break3Minutes = shift.Break3Minutes;
                        timeScheduleBlockIODTO.Break3Link = shift.Break3Link != null ? shift.Break3Link.ToString() : string.Empty;
                        timeScheduleBlockIODTO.Break3IsPreliminary = shift.Break3IsPreliminary;
                        timeScheduleBlockIODTO.Break4Id = shift.Break4Id;
                        timeScheduleBlockIODTO.Break4StartTime = shift.Break4StartTime;
                        timeScheduleBlockIODTO.Break4Minutes = shift.Break4Minutes;
                        timeScheduleBlockIODTO.Break4Link = shift.Break4Link != null ? shift.Break4Link.ToString() : string.Empty;
                        timeScheduleBlockIODTO.Break4IsPreliminary = shift.Break4IsPreliminary;
                        timeScheduleBlockIODTO.HasBreakTimes = false;
                        timeScheduleBlockIODTO.IsBreak = false;

                        timeScheduleBlockIODTO.ShiftTypeId = shift.ShiftTypeId;
                        timeScheduleBlockIODTO.ShiftTypeName = shift.ShiftTypeName;
                        timeScheduleBlockIODTO.ShiftTypeDescription = shift.ShiftTypeDesc;
                        timeScheduleBlockIODTO.ShiftTypeTimeScheduleTypeId = shift.TimeScheduleTypeId;
                        timeScheduleBlockIODTO.Link = shift.Link.HasValue ? shift.Link.ToString() : string.Empty;

                        timeScheduleBlockIODTO.AccountNr = string.Empty;
                        timeScheduleBlockIODTO.AccountDim2Nr = string.Empty;
                        timeScheduleBlockIODTO.AccountDim3Nr = string.Empty;
                        timeScheduleBlockIODTO.AccountDim4Nr = string.Empty;
                        timeScheduleBlockIODTO.AccountDim5Nr = string.Empty;
                        timeScheduleBlockIODTO.AccountDim6Nr = string.Empty;

                        timeScheduleBlockIODTOs.Add(timeScheduleBlockIODTO);
                    }

                }
            }

            #endregion

            return timeScheduleBlockIODTOs;
        }

        public ActionResult ImportTimeScheduleBlockIO(TimeScheduleBlockIOItem timeScheduleBlockIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportTimeScheduleBlockFromIO(timeScheduleBlockIOItem.TimeScheduleBlockIODTOs, actorCompanyId);
        }

        public ActionResult ImportTimeScheduleBlockFromIO(List<TimeScheduleBlockIODTO> timeScheduleBlockIODTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            List<Employee> employees = new List<Employee>();
            List<string> employeeNrs = timeScheduleBlockIODTOs.Select(s => s.EmployeeNr).Distinct().ToList();
            List<Tuple<int, DateTime, DateTime>> employeeScheduleTimePeriodTuples = new List<Tuple<int, DateTime, DateTime>>();
            int timeCodeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeDefaultTimeCode, 0, actorCompanyId, 0);
            List<EmployeeSchedule> companyEmployeeSchedules = TimeScheduleManager.GetEmployeeSchedules(actorCompanyId);
            List<TimeCodeBreak> timeCodeBreaks = TimeCodeManager.GetTimeCodes(actorCompanyId, SoeTimeCodeType.Break, loadPayrollProducts: false).OfType<TimeCodeBreak>().ToList();
            List<TimeCodeBreakGroup> timeCodeBreakGroups = TimeCodeManager.GetTimeCodeBreakGroups(actorCompanyId);
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);


            if (timeCodeId == 0)
            {
                var timeCodes = TimeCodeManager.GetTimeCodes(ActorCompanyId, SoeTimeCodeType.Work);
                if (!timeCodes.IsNullOrEmpty())
                {
                    timeCodeId = timeCodes.FirstOrDefault()?.TimeCodeId ?? 0;
                }
                else
                {
                    result.Success = false;
                    return result;
                }
            }

            using (CompEntities entities = new CompEntities())
            {
                entities.CommandTimeout = 5000;
                List<ShiftType> shiftTypes = TimeScheduleManager.GetShiftTypes(entities, actorCompanyId, loadAccounts: true);
                List<Account> accounts = AccountManager.GetAccountsByCompany(entities, actorCompanyId, loadAccount: true, loadAccountDim: true, loadAccountMapping: true);
                List<EmployeeAccount> employeeAccounts = GetEmployeeAccountsFromCache(entities, CacheConfig.Company(actorCompanyId));

                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Check breaks

                        List<string> invalidBreakTypes = new List<string>();

                        foreach (var block in timeScheduleBlockIODTOs.Where(b => b.Break1Minutes > 0))
                        {
                            TimeCodeBreak timeCode = timeCodeBreaks.FirstOrDefault(b => b.DefaultMinutes == block.Break1Minutes);

                            if (timeCode == null && !invalidBreakTypes.Any(a => a == block.Break1Minutes.ToString()))
                                invalidBreakTypes.Add(block.Break1Minutes.ToString());
                        }

                        if (invalidBreakTypes.Any())
                        {
                            string errorMessage = "Invalid breaktype lengths: " + invalidBreakTypes.JoinToString(",");
                            return new ActionResult(errorMessage);
                        }

                        #endregion

                        foreach (var employeeNr in employeeNrs)
                        {
                            Employee employee = EmployeeManager.GetEmployeeByNr(entities, employeeNr, actorCompanyId, onlyActive: false, loadAccount: useAccountHierarchy);
                            if (employee != null)
                                employees.Add(employee);
                        }

                        #region Split to new EmployeeSchedules

                        foreach (var employee in employees)
                        {
                            List<Tuple<int, DateTime, DateTime>> employeeTuples = new List<Tuple<int, DateTime, DateTime>>();

                            if (companyEmployeeSchedules.Any(e => e.EmployeeId == employee.EmployeeId))
                            {
                                #region Schedule

                                if (!timeScheduleBlockIODTOs.Any(s => s.EmployeeNr.Equals(employee.EmployeeNr)))
                                    continue;

                                DateTime startDate = timeScheduleBlockIODTOs.Any(s => s.EmployeeNr.Equals(employee.EmployeeNr)) && timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(s => s.Date).FirstOrDefault() != null ? timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(s => s.Date).FirstOrDefault().Date : CalendarUtility.DATETIME_DEFAULT;
                                DateTime stopDate = timeScheduleBlockIODTOs.Any(s => s.EmployeeNr.Equals(employee.EmployeeNr)) && timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderByDescending(s => s.Date).FirstOrDefault() != null ? timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderByDescending(s => s.Date).FirstOrDefault().Date : CalendarUtility.DATETIME_DEFAULT;

                                List<EmployeeSchedule> eSchedules = companyEmployeeSchedules.Where(e => e.EmployeeId == employee.EmployeeId && employee.State == (int)SoeEntityState.Active).ToList();

                                //Find dates missing in employeeschedule intervals
                                List<DateTime> missingDates = new List<DateTime>();
                                DateTime checkingDate = startDate;
                                while (checkingDate <= stopDate)
                                {
                                    if (!eSchedules.Any(e => CalendarUtility.IsDateInRange(checkingDate, e.StartDate, e.StopDate)))
                                        missingDates.Add(checkingDate);

                                    checkingDate = checkingDate.AddDays(1);
                                }

                                // if there are no missing dates we will add nothing
                                if (missingDates.IsNullOrEmpty())
                                    continue;

                                //Find consecutive dates
                                missingDates = missingDates.OrderBy(m => m).ToList();

                                DateTime firstDate = missingDates.FirstOrDefault();
                                DateTime lastDate = missingDates.LastOrDefault();
                                DateTime previousDate = firstDate.AddDays(-1);

                                foreach (var checkingDate2 in missingDates)
                                {
                                    if (checkingDate2 != previousDate.AddDays(1))
                                    {
                                        employeeTuples.Add(Tuple.Create(employee.EmployeeId, firstDate, previousDate));
                                        firstDate = checkingDate2;
                                    }

                                    previousDate = checkingDate2;
                                }

                                if (employeeTuples.IsNullOrEmpty())
                                    employeeTuples.Add(Tuple.Create(employee.EmployeeId, firstDate, lastDate));
                            }
                            else
                            {
                                if (!timeScheduleBlockIODTOs.Any(s => s.EmployeeNr.Equals(employee.EmployeeNr)))
                                    continue;

                                DateTime startDate = timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(s => s.Date).FirstOrDefault()?.Date ?? CalendarUtility.DATETIME_DEFAULT;
                                DateTime stopDate = timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderByDescending(s => s.Date).FirstOrDefault()?.Date ?? CalendarUtility.DATETIME_DEFAULT;

                                employeeTuples.Add(Tuple.Create(employee.EmployeeId, startDate, stopDate));
                            }

                            if (employeeTuples.Any())
                                employeeScheduleTimePeriodTuples.AddRange(employeeTuples);

                            #endregion
                        }


                        #endregion

                        #region Create TemplateSchedules from Employees

                        foreach (var employee in employees)
                        {
                            DateTime startDate = DateTime.Now;

                            if (!timeScheduleBlockIODTOs.Any(s => s.EmployeeNr.Equals(employee.EmployeeNr)))
                                continue;

                            if (!timeScheduleBlockIODTOs.Any(w => w.IsTemplate))
                            {
                                #region Simple oneday Template

                                startDate = timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(s => s.Date).Any() && timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(s => s.Date).FirstOrDefault() != null ? timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(s => s.Date).FirstOrDefault().Date : CalendarUtility.DATETIME_DEFAULT;

                                TimeScheduleTemplateHead timeScheduleTemplateHead = new TimeScheduleTemplateHead();
                                timeScheduleTemplateHead.Name = "Imported";
                                timeScheduleTemplateHead.NoOfDays = 1;
                                timeScheduleTemplateHead.ActorCompanyId = actorCompanyId;
                                timeScheduleTemplateHead.StartDate = timeScheduleTemplateHead.FirstMondayOfCycle = CalendarUtility.GetBeginningOfDay(startDate);
                                timeScheduleTemplateHead.EmployeeId = employee.EmployeeId;
                                timeScheduleTemplateHead.StartOnFirstDayOfWeek = false;
                                timeScheduleTemplateHead.SimpleSchedule = false;
                                timeScheduleTemplateHead.FlexForceSchedule = false;
                                timeScheduleTemplateHead.State = (int)SoeEntityState.Active;
                                timeScheduleTemplateHead.Locked = false;

                                entities.TimeScheduleTemplateHead.AddObject(timeScheduleTemplateHead);

                                TimeScheduleTemplatePeriod timeScheduleTemplatePeriod = new TimeScheduleTemplatePeriod();
                                timeScheduleTemplatePeriod.DayNumber = 1;
                                timeScheduleTemplatePeriod.TimeScheduleTemplateHead = timeScheduleTemplateHead;

                                entities.TimeScheduleTemplatePeriod.AddObject(timeScheduleTemplatePeriod);

                                TimeScheduleTemplateBlock timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                timeScheduleTemplateBlock.Employee = employee;
                                timeScheduleTemplateBlock.TimeScheduleTemplatePeriod = timeScheduleTemplatePeriod;
                                timeScheduleTemplateBlock.TimeCodeId = timeCodeId;
                                timeScheduleTemplateBlock.AccountId = null;
                                timeScheduleTemplateBlock.StartTime = CalendarUtility.DATETIME_DEFAULT;
                                timeScheduleTemplateBlock.StopTime = CalendarUtility.DATETIME_DEFAULT;
                                timeScheduleTemplateBlock.Type = (int)TermGroup_TimeScheduleTemplateBlockType.Schedule;
                                timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.None;
                                timeScheduleTemplateBlock.BreakNumber = 0;
                                timeScheduleTemplateBlock.ShiftStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                                timeScheduleTemplateBlock.NbrOfSuggestionsInQueue = 0;
                                timeScheduleTemplateBlock.NbrOfWantedInQueue = 0;
                                timeScheduleTemplateBlock.State = (int)SoeEntityState.Active;
                                timeScheduleTemplateBlock.TimeDeviationCauseStatus = (int)SoeTimeScheduleDeviationCauseStatus.None;

                                entities.TimeScheduleTemplateBlock.AddObject(timeScheduleTemplateBlock);

                                result = SaveChanges(entities);

                                #endregion
                            }

                            #region Actual template

                            if (timeScheduleBlockIODTOs.Any(w => w.IsTemplate))
                            {
                                var employeeScheduleBlocks = timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr)).ToList();

                                startDate = employeeScheduleBlocks.Any() && employeeScheduleBlocks.OrderBy(s => s.Date).FirstOrDefault() != null ? employeeScheduleBlocks.OrderBy(s => s.Date).FirstOrDefault().Date : CalendarUtility.DATETIME_DEFAULT;
                                startDate = CalendarUtility.ClearSeconds(CalendarUtility.AdjustDateToBeginningOfWeek(startDate)).Date;

                                DateTime endDate = employeeScheduleBlocks.Any() && employeeScheduleBlocks.FirstOrDefault() != null ? employeeScheduleBlocks.OrderBy(s => s.Date).LastOrDefault().Date : CalendarUtility.DATETIME_DEFAULT;
                                endDate = CalendarUtility.ClearSeconds(CalendarUtility.AdjustDateToEndOfWeek(endDate)).Date;

                                TimeScheduleTemplateHead timeScheduleTemplateHead = new TimeScheduleTemplateHead();
                                timeScheduleTemplateHead.Name = "Import from schedule";
                                timeScheduleTemplateHead.NoOfDays = Convert.ToInt32((endDate - startDate).TotalDays + 1);
                                timeScheduleTemplateHead.ActorCompanyId = actorCompanyId;
                                timeScheduleTemplateHead.StartDate = timeScheduleTemplateHead.FirstMondayOfCycle = CalendarUtility.GetBeginningOfDay(startDate);
                                timeScheduleTemplateHead.EmployeeId = employee.EmployeeId;
                                timeScheduleTemplateHead.StartOnFirstDayOfWeek = true;
                                timeScheduleTemplateHead.SimpleSchedule = false;
                                timeScheduleTemplateHead.FlexForceSchedule = false;
                                timeScheduleTemplateHead.State = (int)SoeEntityState.Active;
                                timeScheduleTemplateHead.Locked = false;

                                DateTime currentDate = startDate;
                                int dayNumber = 0;

                                while (currentDate <= endDate)
                                {
                                    dayNumber++;

                                    var employeeGroupid = employee.GetEmployeeGroupId(currentDate);
                                    if (employeeGroupid == 0)
                                        continue;

                                    TimeScheduleTemplatePeriod timeScheduleTemplatePeriod = new TimeScheduleTemplatePeriod();
                                    timeScheduleTemplatePeriod.DayNumber = dayNumber;
                                    timeScheduleTemplatePeriod.TimeScheduleTemplateHead = timeScheduleTemplateHead;

                                    //Find the right Schedules for that Day

                                    List<TimeScheduleBlockIODTO> employeeDayTimeScheduleBlockIODTOs = employeeScheduleBlocks.Where(s => s.Date == currentDate).ToList();

                                    if (employeeDayTimeScheduleBlockIODTOs.IsNullOrEmpty())
                                    {
                                        // Zero Schedule
                                        TimeScheduleTemplateBlock timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                        timeScheduleTemplateBlock.Employee = employee;
                                        timeScheduleTemplateBlock.TimeScheduleTemplatePeriod = timeScheduleTemplatePeriod;
                                        timeScheduleTemplateBlock.TimeCodeId = timeCodeId;
                                        timeScheduleTemplateBlock.AccountId = null;
                                        timeScheduleTemplateBlock.Date = null;
                                        timeScheduleTemplateBlock.StartTime = CalendarUtility.DATETIME_DEFAULT;
                                        timeScheduleTemplateBlock.StopTime = CalendarUtility.DATETIME_DEFAULT;
                                        timeScheduleTemplateBlock.Type = (int)TermGroup_TimeScheduleTemplateBlockType.Schedule;
                                        timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.None;
                                        timeScheduleTemplateBlock.BreakNumber = 0;

                                        timeScheduleTemplateBlock.ShiftStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                                        timeScheduleTemplateBlock.NbrOfSuggestionsInQueue = 0;
                                        timeScheduleTemplateBlock.NbrOfWantedInQueue = 0;
                                        timeScheduleTemplateBlock.State = (int)SoeEntityState.Active;
                                        timeScheduleTemplateBlock.TimeDeviationCauseStatus = (int)SoeTimeScheduleDeviationCauseStatus.None;

                                    }
                                    else
                                    {
                                        string link = Guid.NewGuid().ToString();
                                        int breakNumber = 0;
                                        foreach (var block in employeeDayTimeScheduleBlockIODTOs.OrderBy(o => o.StartTime))
                                        {
                                            TimeScheduleTemplateBlock timeScheduleTemplateBlock = null;

                                            if (block.Break1Minutes > 0)
                                            {
                                                breakNumber++;
                                                TimeCodeBreak timeCode = TimeCodeManager.GetTimeCodeBreakForLength(actorCompanyId, employeeGroupid, block.Break1Minutes, timeCodeBreaks, timeCodeBreakGroups);

                                                if (timeCode == null)
                                                    continue;

                                                timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                                timeScheduleTemplateBlock.TimeCodeId = timeCode.TimeCodeId;
                                                timeScheduleTemplateBlock.BreakNumber = breakNumber;
                                                timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.NormalBreak;
                                            }
                                            else if (block.Break1Minutes == 0)
                                            {
                                                timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                                timeScheduleTemplateBlock.TimeCodeId = timeCodeId;
                                                timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.None;
                                                timeScheduleTemplateBlock.BreakNumber = 0;

                                                if (block.ShiftTypeId != 0)
                                                    timeScheduleTemplateBlock.ShiftTypeId = block.ShiftTypeId;
                                            }

                                            timeScheduleTemplateBlock.Employee = employee;
                                            timeScheduleTemplateBlock.AccountId = block.HierachyAccountId;
                                            timeScheduleTemplateBlock.Date = null;
                                            timeScheduleTemplateBlock.StartTime = CalendarUtility.ClearSeconds(CalendarUtility.GetScheduleTime(block.StartTime));
                                            timeScheduleTemplateBlock.StopTime = CalendarUtility.ClearSeconds(CalendarUtility.GetScheduleTime(block.StopTime));
                                            timeScheduleTemplateBlock.ShiftStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                                            timeScheduleTemplateBlock.NbrOfSuggestionsInQueue = 0;
                                            timeScheduleTemplateBlock.NbrOfWantedInQueue = 0;
                                            timeScheduleTemplateBlock.State = (int)SoeEntityState.Active;
                                            timeScheduleTemplateBlock.TimeDeviationCauseStatus = (int)SoeTimeScheduleDeviationCauseStatus.None;
                                            timeScheduleTemplateBlock.Type = (int)TermGroup_TimeScheduleTemplateBlockType.Schedule;
                                            timeScheduleTemplateBlock.TimeScheduleTemplatePeriod = timeScheduleTemplatePeriod;
                                            timeScheduleTemplateBlock.Link = link;

                                            if (block.HierachyAccountId.HasValue)
                                            {
                                                var acc = accounts.FirstOrDefault(w => w.AccountId == block.HierachyAccountId.Value && w.AccountInternal != null);
                                                if (acc != null)
                                                    timeScheduleTemplateBlock.AccountInternal.Add(acc.AccountInternal);
                                            }

                                            if (!string.IsNullOrEmpty(block.AccountDim2Nr))
                                            {
                                                var acc = accounts.FirstOrDefault(w => w.AccountDim.AccountDimNr != 1 && w.AccountNr == block.AccountDim2Nr && w.AccountInternal != null);
                                                if (acc != null)
                                                    timeScheduleTemplateBlock.AccountInternal.Add(acc.AccountInternal);
                                            }

                                        }
                                    }

                                    currentDate = currentDate.AddDays(1);
                                }

                                var oldTemplateHeadsOnSameDate = TimeScheduleManager.GetTimeScheduleTemplateHeadsForEmployee(entities, actorCompanyId, employee.EmployeeId, CalendarUtility.GetBeginningOfDay(startDate));

                                foreach (var old in oldTemplateHeadsOnSameDate)
                                {
                                    if (old != null && old.StartDate == startDate)
                                    {
                                        old.State = (int)SoeEntityState.Deleted;

                                        if (!old.TimeScheduleTemplatePeriod.IsLoaded)
                                            old.TimeScheduleTemplatePeriod.Load();

                                        foreach (var period in old.TimeScheduleTemplatePeriod)
                                        {
                                            if (!period.TimeScheduleTemplateBlock.IsLoaded)
                                                period.TimeScheduleTemplateBlock.Load();

                                            foreach (var block in period.TimeScheduleTemplateBlock)
                                            {
                                                block.State = (int)SoeEntityState.Deleted;
                                            }
                                        }

                                    }
                                }

                                entities.TimeScheduleTemplateHead.AddObject(timeScheduleTemplateHead);
                                entities.BulkSaveChanges();
                            }

                            #endregion
                        }

                        #endregion

                        #region create TimeScheduleTemplateBlocks and EmployeeSchedule

                        foreach (var employee in employees)
                        {
                            if (timeScheduleBlockIODTOs.Any(w => w.EmployeeNr.Equals(employee.EmployeeNr) && w.IsTemplate))
                                continue;

                            var employeeAccountsOnEmployee = employeeAccounts.Where(w => w.EmployeeId == employee.EmployeeId).ToList();

                            var tuple = employeeScheduleTimePeriodTuples.FirstOrDefault(f => f.Item1 == employee.EmployeeId);

                            if (tuple == null)
                            {
                                var dtos = timeScheduleBlockIODTOs.Where(w => w.EmployeeNr.Equals(employee.EmployeeNr)).OrderBy(o => o.Date).ToList();

                                if (dtos.Any())
                                    employeeScheduleTimePeriodTuples.Add(Tuple.Create(employee.EmployeeId, dtos.First().Date, dtos.Last().Date));
                                else
                                    continue;
                            }


                            foreach (var employeeTuple in employeeScheduleTimePeriodTuples.Where(i => i.Item1 == employee.EmployeeId))
                            {
                                DateTime startDate = employeeTuple.Item2;
                                DateTime stopDate = employeeTuple.Item3;
                                int employeeId = employeeTuple.Item1;

                                if (entities.TimeScheduleTemplateBlock.Any(a => a.EmployeeId == employeeId && a.State == (int)SoeEntityState.Active && a.Date.HasValue && a.Date.Value >= startDate && a.Date.Value <= stopDate))
                                    continue;

                                var employeeTimeScheduleBlockIODTOs = timeScheduleBlockIODTOs.Where(s => s.EmployeeNr.Equals(employee.EmployeeNr));
                                employeeTimeScheduleBlockIODTOs = employeeTimeScheduleBlockIODTOs.Where(s => s.Date >= startDate && s.Date <= stopDate && !s.IsTemplate).ToList();

                                if (employeeTimeScheduleBlockIODTOs.IsNullOrEmpty())
                                    continue;

                                TimeScheduleTemplateHead timeScheduleTemplateHead = null;

                                List<TimeScheduleTemplateHead> timeScheduleTemplateHeads = TimeScheduleManager.GetTimeScheduleTemplateHeadsForEmployee(entities, actorCompanyId, employeeId, null, null, loadBlocks: true);
                                if (timeScheduleTemplateHeads.IsNullOrEmpty() || !timeScheduleTemplateHeads.Any(s => s.StartDate == startDate))
                                {
                                    timeScheduleTemplateHead = new TimeScheduleTemplateHead();
                                    timeScheduleTemplateHead.Name = "_" + employee.EmployeeNr + "__";
                                    timeScheduleTemplateHead.NoOfDays = 1;
                                    timeScheduleTemplateHead.ActorCompanyId = actorCompanyId;
                                    timeScheduleTemplateHead.StartDate = timeScheduleTemplateHead.FirstMondayOfCycle = startDate.Date;
                                    timeScheduleTemplateHead.EmployeeId = employee.EmployeeId;
                                    timeScheduleTemplateHead.StartOnFirstDayOfWeek = true;
                                    timeScheduleTemplateHead.SimpleSchedule = false;
                                    timeScheduleTemplateHead.FlexForceSchedule = false;
                                    timeScheduleTemplateHead.State = (int)SoeEntityState.Active;
                                    timeScheduleTemplateHead.Locked = false;
                                    entities.TimeScheduleTemplateHead.AddObject(timeScheduleTemplateHead);
                                }
                                else
                                    timeScheduleTemplateHead = timeScheduleTemplateHeads.LastOrDefault(s => s.StartDate.HasValue && s.StartDate.Value.Date == startDate);

                                EmployeeSchedule employeeSchedule = new EmployeeSchedule();
                                employeeSchedule.EmployeeId = employeeId;
                                employeeSchedule.StartDate = startDate;
                                employeeSchedule.StopDate = stopDate;
                                employeeSchedule.StartDayNumber = 1;
                                employeeSchedule.TimeScheduleTemplateHeadId = timeScheduleTemplateHead.TimeScheduleTemplateHeadId;
                                entities.EmployeeSchedule.AddObject(employeeSchedule);

                                DateTime currentDate = CalendarUtility.GetBeginningOfDay(startDate);

                                while (currentDate <= stopDate)
                                {
                                    int employeeGroupid = employee.GetEmployeeGroupId(currentDate);

                                    TimeScheduleTemplatePeriod timeScheduleTemplatePeriod = new TimeScheduleTemplatePeriod();
                                    timeScheduleTemplatePeriod.DayNumber = 1;
                                    timeScheduleTemplatePeriod.TimeScheduleTemplateHead = timeScheduleTemplateHead;
                                    entities.TimeScheduleTemplatePeriod.AddObject(timeScheduleTemplatePeriod);

                                    TimeScheduleEmployeePeriod timeScheduleEmployeePeriod = new TimeScheduleEmployeePeriod()
                                    {
                                        EmployeeId = employee.EmployeeId,
                                        ActorCompanyId = actorCompanyId,
                                        Date = currentDate,
                                    };
                                    SetCreatedProperties(timeScheduleEmployeePeriod);
                                    entities.TimeScheduleEmployeePeriod.AddObject(timeScheduleEmployeePeriod);

                                    //Find the right Schedules for that Day

                                    List<TimeScheduleBlockIODTO> employeeDayTimeScheduleBlockIODTOs = employeeTimeScheduleBlockIODTOs.Where(s => s.Date == currentDate).ToList();

                                    if (employeeDayTimeScheduleBlockIODTOs.IsNullOrEmpty())
                                    {
                                        // Zero Schedule
                                        TimeScheduleTemplateBlock timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                        timeScheduleTemplateBlock.Employee = employee;
                                        timeScheduleTemplateBlock.TimeScheduleTemplatePeriod = timeScheduleTemplatePeriod;
                                        timeScheduleTemplateBlock.TimeScheduleEmployeePeriod = timeScheduleEmployeePeriod;
                                        timeScheduleTemplateBlock.TimeCodeId = timeCodeId;
                                        timeScheduleTemplateBlock.AccountId = null;
                                        timeScheduleTemplateBlock.Date = currentDate;
                                        timeScheduleTemplateBlock.StartTime = CalendarUtility.DATETIME_DEFAULT;
                                        timeScheduleTemplateBlock.StopTime = CalendarUtility.DATETIME_DEFAULT;
                                        timeScheduleTemplateBlock.Type = (int)TermGroup_TimeScheduleTemplateBlockType.Schedule;
                                        timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.None;
                                        timeScheduleTemplateBlock.BreakNumber = 0;
                                        timeScheduleTemplateBlock.ShiftStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                                        timeScheduleTemplateBlock.NbrOfSuggestionsInQueue = 0;
                                        timeScheduleTemplateBlock.NbrOfWantedInQueue = 0;
                                        timeScheduleTemplateBlock.TimeDeviationCauseStatus = (int)SoeTimeScheduleDeviationCauseStatus.None;
                                        timeScheduleTemplateBlock.State = (int)SoeEntityState.Active;
                                        SetCreatedProperties(timeScheduleTemplateBlock);
                                        entities.TimeScheduleTemplateBlock.AddObject(timeScheduleTemplateBlock);

                                        currentDate = currentDate.AddDays(1);
                                        continue;
                                    }
                                    else
                                    {
                                        string link = Guid.NewGuid().ToString();
                                        int breakNumber = 0;
                                        foreach (var block in employeeDayTimeScheduleBlockIODTOs.OrderBy(o => o.StartTime))
                                        {
                                            TimeScheduleTemplateBlock timeScheduleTemplateBlock = null;

                                            if (block.Break1Minutes > 0)
                                            {
                                                breakNumber++;
                                                TimeCodeBreak timeCode = TimeCodeManager.GetTimeCodeBreakForLength(actorCompanyId, employeeGroupid, block.Break1Minutes, timeCodeBreaks, timeCodeBreakGroups);

                                                if (timeCode == null)
                                                    continue;

                                                timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                                timeScheduleTemplateBlock.BreakNumber = breakNumber;
                                                timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.NormalBreak;
                                                timeScheduleTemplateBlock.TimeCodeId = timeCode.TimeCodeId;
                                            }
                                            else if (block.Break1Minutes == 0)
                                            {
                                                timeScheduleTemplateBlock = new TimeScheduleTemplateBlock();
                                                timeScheduleTemplateBlock.BreakType = (int)SoeTimeScheduleTemplateBlockBreakType.None;
                                                timeScheduleTemplateBlock.BreakNumber = 0;
                                                timeScheduleTemplateBlock.TimeCodeId = timeCodeId;
                                            }
                                            else
                                                continue;

                                            timeScheduleTemplateBlock.Employee = employee;
                                            timeScheduleTemplateBlock.TimeScheduleTemplatePeriod = timeScheduleTemplatePeriod;
                                            timeScheduleTemplateBlock.TimeScheduleEmployeePeriod = timeScheduleEmployeePeriod;
                                            timeScheduleTemplateBlock.Date = currentDate;
                                            timeScheduleTemplateBlock.StartTime = CalendarUtility.ClearSeconds(CalendarUtility.GetScheduleTime(block.StartTime));
                                            timeScheduleTemplateBlock.StopTime = CalendarUtility.ClearSeconds(CalendarUtility.GetScheduleTime(block.StopTime));
                                            timeScheduleTemplateBlock.ShiftStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                                            timeScheduleTemplateBlock.NbrOfSuggestionsInQueue = 0;
                                            timeScheduleTemplateBlock.NbrOfWantedInQueue = 0;
                                            timeScheduleTemplateBlock.State = (int)SoeEntityState.Active;
                                            timeScheduleTemplateBlock.TimeDeviationCauseStatus = (int)SoeTimeScheduleDeviationCauseStatus.None;
                                            timeScheduleTemplateBlock.Type = (int)TermGroup_TimeScheduleTemplateBlockType.Schedule;
                                            timeScheduleTemplateBlock.TimeScheduleTemplatePeriod = timeScheduleTemplatePeriod;
                                            timeScheduleTemplateBlock.TimeScheduleEmployeePeriod = timeScheduleEmployeePeriod;
                                            timeScheduleTemplateBlock.Link = link;
                                            timeScheduleTemplateBlock.AccountId = block.HierachyAccountId;
                                            timeScheduleTemplateBlock.ShiftTypeId = block.ShiftTypeId;

                                            if (block.ShiftTypeId.HasValue && !timeScheduleTemplateBlock.AccountId.HasValue && base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId) && shiftTypes.Any(a => a.ShiftTypeId == block.ShiftTypeId.Value))
                                            {
                                                var shiftType = shiftTypes.First(s => s.ShiftTypeId == block.ShiftTypeId.Value);
                                                if (shiftType?.AccountId != null)
                                                    timeScheduleTemplateBlock.AccountId = shiftType.AccountId;
                                            }

                                            if (!timeScheduleTemplateBlock.AccountId.HasValue && base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId) && !employeeAccounts.IsNullOrEmpty() && employeeAccounts.Count(w => w.Default) == 1)
                                                timeScheduleTemplateBlock.AccountId = employeeAccounts.FirstOrDefault(w => w.Default)?.AccountId;

                                            if (block.HierachyAccountId.HasValue)
                                            {
                                                var acc = accounts.FirstOrDefault(w => w.AccountId == block.HierachyAccountId.Value && w.AccountInternal != null);
                                                if (acc != null)
                                                    timeScheduleTemplateBlock.AccountInternal.Add(acc.AccountInternal);
                                            }

                                            if (!string.IsNullOrEmpty(block.AccountDim2Nr))
                                            {
                                                var acc = accounts.FirstOrDefault(w => w.AccountDim.AccountDimNr != 1 && w.AccountNr == block.AccountDim2Nr && w.AccountInternal != null);
                                                if (acc != null)
                                                    timeScheduleTemplateBlock.AccountInternal.Add(acc.AccountInternal);
                                            }

                                            SetAccountingOnScheduleBlock(timeScheduleTemplateBlock, shiftTypes, employeeAccountsOnEmployee);
                                            entities.TimeScheduleTemplateBlock.AddObject(timeScheduleTemplateBlock);
                                            SetCreatedProperties(timeScheduleTemplateBlock);

                                        }
                                    }

                                    currentDate = currentDate.AddDays(1);
                                }

                                result = SaveChanges(entities, transaction, true, true);

                                if (!result.Success)
                                    return result;
                            }
                        }

                        result = SaveChanges(entities);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (!result.Success)
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            #endregion

            return result;
        }

        private void SetAccountingOnScheduleBlock(TimeScheduleTemplateBlock timeScheduleTemplateBlock, List<ShiftType> shiftTypes, List<EmployeeAccount> employeeAccounts)
        {
            var shiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == timeScheduleTemplateBlock.ShiftTypeId);

            if (employeeAccounts.IsNullOrEmpty())
            {
                if (shiftType != null && !shiftType.AccountInternal.IsNullOrEmpty())
                {
                    foreach (var ai in shiftType.AccountInternal.Where(w => w.AccountId != 0))
                    {
                        if (!timeScheduleTemplateBlock.AccountInternal.Any(a => a.AccountId == ai.AccountId))
                            timeScheduleTemplateBlock.AccountInternal.Add(ai);
                    }
                }
            }
            else
            {
                foreach (var ea in employeeAccounts)
                {
                    if (shiftType != null && !shiftType.AccountInternal.IsNullOrEmpty())
                    {
                        foreach (var ai in shiftType.AccountInternal.Where(w => w.AccountId != 0))
                        {
                            if (!timeScheduleTemplateBlock.AccountInternal.Any(a => a.AccountId == ai.AccountId))
                                timeScheduleTemplateBlock.AccountInternal.Add(ai);
                        }
                    }
                    else
                    {
                        if (!timeScheduleTemplateBlock.AccountInternal.Any(a => a.AccountId == ea.AccountId))
                            timeScheduleTemplateBlock.AccountInternal.Add(ea.Account.AccountInternal);
                    }
                }

                foreach (var ea in employeeAccounts)
                {
                    if (!timeScheduleTemplateBlock.AccountInternal.Any(a => a.AccountId == ea.AccountId) && !timeScheduleTemplateBlock.AccountInternal.Any(e => e.Account.AccountDimId == ea.AccountId))
                        timeScheduleTemplateBlock.AccountInternal.Add(ea.Account.AccountInternal);
                }
            }
        }

        public ActionResult CreateFakeTimeScheduleBlocks(int actorCompanyId, List<int> employeeIds, DateTime startDate, DateTime minStart, DateTime maxStop, int numberOfWeeks, int accountDimIdForAccounting)
        {
            List<int> validWorkIntervals = new List<int>() { 30, 60, 90, 120, 180, 180, 180, 195, 210, 225, 240 };
            List<int> validBreakIntervals = new List<int>() { 15, 30, 60 };
            List<ShiftType> shiftTypes = TimeScheduleManager.GetShiftTypes(actorCompanyId, loadAccountInternals: true, loadAccounts: true);
            List<EmployeeGroup> employeeGroups = EmployeeManager.GetEmployeeGroups(actorCompanyId);
            List<int> shiftTypeCodes = shiftTypes.Select(s => s.ShiftTypeId).ToList();

            if (shiftTypes.Any(a => a.Name.ToLower().Contains("kassa")))
            {
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
                shiftTypeCodes.Add(shiftTypes.First(a => a.Name.ToLower().Contains("kassa")).ShiftTypeId);
            }

            Random random = new Random();

            List<Account> accounts = AccountManager.GetAccounts(actorCompanyId);
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, active: null);

            List<Employee> filteredemployees = new List<Employee>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<TimeScheduleTemplateHead> heads = entitiesReadOnly.TimeScheduleTemplateHead.Where(w => w.ActorCompanyId == actorCompanyId).ToList();

            foreach (var emp in employees)
            {
                if (heads.Any(a => a.EmployeeId == emp.EmployeeId && a.State == 0))
                    continue;

                if (!emp.EmployeeAccount.IsLoaded)
                    emp.EmployeeAccount.Load();

                filteredemployees.Add(emp);
            }

            foreach (var onEmploymentGroup in filteredemployees.Where(w => w.GetEmployment() != null).GroupBy(g => $"{g.LastName.First()}#{g.GetEmployment().GetEmployeeGroupId()}#{decimal.Multiply(decimal.Round((int)(decimal.Divide(g.GetEmployment().GetPercent(), 10)), 2), 10)}"))
            {
                List<TimeScheduleBlockIODTO> timeScheduleBlockIODTOs = new List<TimeScheduleBlockIODTO>();
                DateTime date = startDate;
                int numberOfDays = (int)decimal.Multiply(7, numberOfWeeks);
                int currentDay = 1;
                int workTimeWeek = onEmploymentGroup.First().GetEmployment().GetWorkTimeWeek();
                int workTimeWeekOnGroup = onEmploymentGroup.First().GetEmployeeGroup(null, employeeGroups).RuleWorkTimeWeek;
                int workDaysPerweek = (int)decimal.Multiply(decimal.Divide(workTimeWeek, workTimeWeekOnGroup), 5);

                if (workDaysPerweek == 0)
                    workDaysPerweek = 1;

                int workTimePerDay = (int)decimal.Divide(workTimeWeek, workDaysPerweek);
                int workDaysInPeriod = (int)decimal.Divide(workDaysPerweek, decimal.Divide(7, 14));
                int weekNr = 0;
                int currentWorkDaysWeek = 0;
                int remainingWorkingDays = workDaysInPeriod;

                while (currentDay <= numberOfDays)
                {
                    if (date.DayOfWeek == DayOfWeek.Monday)
                    {
                        currentWorkDaysWeek = 0;
                        weekNr++;
                    }

                    bool skipDay = false;

                    int addedWorkTime = 0;
                    bool isBreak = false;
                    List<TimeScheduleBlockIODTO> blocksOnDateOnEmployee = new List<TimeScheduleBlockIODTO>();
                    List<Tuple<DateTime, DateTime, int?, bool>> blocks = new List<Tuple<DateTime, DateTime, int?, bool>>();
                    int randomLengthtWork = validWorkIntervals[random.Next(0, validWorkIntervals.ToArray().Length - 1)];
                    DateTime start = minStart.AddMinutes((int)decimal.Multiply(randomLengthtWork, random.Next(2)));


                    if (remainingWorkingDays + 2 > (int)((startDate.AddDays(14) - date).TotalDays) + 1)
                    {
                        if (random.Next(1, 20) > 10)
                            skipDay = true;
                    }

                    if (currentWorkDaysWeek > workDaysPerweek)
                        skipDay = true;

                    if (numberOfWeeks == weekNr && remainingWorkingDays <= 0)
                        skipDay = true;

                    if (workDaysPerweek <= 2 && date.DayOfWeek != DayOfWeek.Sunday && date.DayOfWeek != DayOfWeek.Saturday && random.Next(1, 30) < 3)
                        skipDay = true;

                    if (!skipDay && weekNr == 1 && random.Next(1, 30) < 10)
                        skipDay = true;

                    if (weekNr == 1 && (date.DayOfWeek == DayOfWeek.Monday || date.DayOfWeek == DayOfWeek.Tuesday || date.DayOfWeek == DayOfWeek.Wednesday || date.DayOfWeek == DayOfWeek.Thursday) && random.Next(1, 20) < 10)
                        skipDay = true;

                    int? shiftTypeId = null;
                    int breakMinutes = 0;

                    if (!skipDay)
                    {
                        while (addedWorkTime < workTimePerDay && start.AddMinutes(60) < maxStop)
                        {
                            randomLengthtWork = validWorkIntervals[random.Next(0, validWorkIntervals.ToArray().Length - 1)];

                            if (blocks.Any() && blocks.First().Item1.AddMinutes(150) < start && !blocks.Any(a => a.Item4))
                                randomLengthtWork = 75;

                            if (randomLengthtWork + addedWorkTime > workTimePerDay + 60 && randomLengthtWork > 60)
                                randomLengthtWork = randomLengthtWork - 60;

                            if (!isBreak)
                                shiftTypeId = shiftTypeCodes[random.Next(0, validWorkIntervals.ToArray().Length - 1)];

                            blocks.Add(Tuple.Create(start, start.AddMinutes(randomLengthtWork), shiftTypeId, isBreak));
                            addedWorkTime = addedWorkTime + randomLengthtWork;
                            start = start.AddMinutes(randomLengthtWork);

                            if (addedWorkTime < workTimePerDay && !isBreak && randomLengthtWork > 60)
                            {
                                isBreak = true;
                                randomLengthtWork = validBreakIntervals[random.Next(0, validBreakIntervals.ToArray().Length - 1)];

                                if (blocks.First().Item1.AddMinutes(150) > start)
                                    randomLengthtWork = 15;

                                if (randomLengthtWork > 15 && blocks.Any(a => a.Item4 && (a.Item2 - a.Item1).TotalMinutes >= 30))
                                    randomLengthtWork = 15;
                                else if (randomLengthtWork < 60 && !blocks.Any(a => a.Item4 && (a.Item2 - a.Item1).TotalMinutes >= 30))
                                    randomLengthtWork = 60;

                                blocks.Add(Tuple.Create(start, start.AddMinutes(randomLengthtWork), (int?)null, isBreak));
                                breakMinutes = breakMinutes + randomLengthtWork;
                                isBreak = false;
                                start = start.AddMinutes(randomLengthtWork);
                            }
                        }
                    }

                    if (!skipDay && blocks.Any())
                    {
                        if (blocks.Last().Item4)
                            blocks.Remove(blocks.Last(l => l.Item4));

                        currentWorkDaysWeek++;
                        remainingWorkingDays--;
                        int numberOfFrags = blocks.Count;
                        Guid link = Guid.NewGuid();

                        for (int i = 0; i < numberOfFrags; i++)
                        {
                            var scheduleblock = blocks[i];
                            var nextBlock = i + 1 < numberOfFrags ? blocks[i + 1] : null;

                            TimeScheduleBlockIODTO timeScheduleBlockIODTO = new TimeScheduleBlockIODTO();

                            DateTime startTime = scheduleblock.Item1;
                            DateTime stopTime = !scheduleblock.Item4 && nextBlock != null && nextBlock.Item4 ? nextBlock.Item2 : scheduleblock.Item2;

                            timeScheduleBlockIODTO.TimeScheduleTemplatePeriodId = 0;
                            timeScheduleBlockIODTO.TimeScheduleEmployeePeriodId = 0;
                            timeScheduleBlockIODTO.EmployeeNr = "";
                            timeScheduleBlockIODTO.TimeScheduleTypeId = 0;
                            timeScheduleBlockIODTO.DayNumber = 0;
                            timeScheduleBlockIODTO.Description = string.Empty;
                            timeScheduleBlockIODTO.IsTemplate = true;

                            timeScheduleBlockIODTO.StartTime = startTime;
                            timeScheduleBlockIODTO.StopTime = stopTime;
                            timeScheduleBlockIODTO.LengthMinutes = Convert.ToInt32((stopTime - startTime).TotalMinutes);
                            timeScheduleBlockIODTO.Date = date;

                            int break1Minutes = 0;
                            int break2Minutes = 0;
                            int break3Minutes = 0;
                            int break4Minutes = 0;
                            DateTime? break1StartTime = scheduleblock.Item4 ? blocks.FirstOrDefault(f => f.Item4)?.Item1 : null;
                            DateTime? break2StartTime = scheduleblock.Item4 && break1StartTime.HasValue ? blocks.FirstOrDefault(f => f.Item4 && f.Item1 > break1StartTime)?.Item1 : null;
                            DateTime? break3StartTime = scheduleblock.Item4 && break2StartTime.HasValue ? blocks.FirstOrDefault(f => f.Item4 && f.Item1 > break2StartTime)?.Item1 : null;
                            DateTime? break4StartTime = scheduleblock.Item4 && break3StartTime.HasValue ? blocks.FirstOrDefault(f => f.Item4 && f.Item1 > break3StartTime)?.Item1 : null;

                            if (break1StartTime.HasValue)
                                break1Minutes = (int)(blocks.First(f => f.Item1 == break1StartTime.Value).Item2 - blocks.First(f => f.Item1 == break1StartTime.Value).Item1).TotalMinutes;
                            else
                                break1StartTime = CalendarUtility.DATETIME_DEFAULT;

                            if (break2StartTime.HasValue)
                                break2Minutes = (int)(blocks.First(f => f.Item1 == break2StartTime.Value).Item2 - blocks.First(f => f.Item1 == break2StartTime.Value).Item1).TotalMinutes;
                            else
                                break2StartTime = CalendarUtility.DATETIME_DEFAULT;

                            if (break3StartTime.HasValue)
                                break3Minutes = (int)(blocks.First(f => f.Item1 == break3StartTime.Value).Item2 - blocks.First(f => f.Item1 == break3StartTime.Value).Item1).TotalMinutes;
                            else
                                break3StartTime = CalendarUtility.DATETIME_DEFAULT;

                            if (break4StartTime.HasValue)
                                break4Minutes = (int)(blocks.First(f => f.Item1 == break4StartTime.Value).Item2 - blocks.First(f => f.Item1 == break4StartTime.Value).Item1).TotalMinutes;
                            else
                                break4StartTime = CalendarUtility.DATETIME_DEFAULT;

                            if (break2StartTime.Value != CalendarUtility.DATETIME_DEFAULT && break2StartTime.Value < timeScheduleBlockIODTO.StopTime)
                            {
                                break1StartTime = break2StartTime;
                                break1Minutes = break2Minutes;
                            }

                            if (break3StartTime.Value != CalendarUtility.DATETIME_DEFAULT && break3StartTime.Value < timeScheduleBlockIODTO.StopTime)
                            {
                                break1StartTime = break3StartTime;
                                break1Minutes = break3Minutes;
                            }

                            if (break4StartTime.Value != CalendarUtility.DATETIME_DEFAULT && break4StartTime.Value < timeScheduleBlockIODTO.StopTime)
                            {
                                break1StartTime = break4StartTime;
                                break1Minutes = break4Minutes;
                            }

                            timeScheduleBlockIODTO.Break1Id = 0;
                            timeScheduleBlockIODTO.Break1StartTime = break1StartTime.Value;
                            timeScheduleBlockIODTO.Break1Minutes = break1Minutes;
                            timeScheduleBlockIODTO.Break1Link = string.Empty;
                            timeScheduleBlockIODTO.Break2Id = 0;
                            timeScheduleBlockIODTO.Break2StartTime = break2StartTime.Value;
                            timeScheduleBlockIODTO.Break2Minutes = break2Minutes;
                            timeScheduleBlockIODTO.Break2Link = string.Empty;
                            timeScheduleBlockIODTO.Break3Id = 0;
                            timeScheduleBlockIODTO.Break3StartTime = break3StartTime.Value;
                            timeScheduleBlockIODTO.Break3Minutes = break3Minutes;
                            timeScheduleBlockIODTO.Break3Link = string.Empty;
                            timeScheduleBlockIODTO.Break4Id = 0;
                            timeScheduleBlockIODTO.Break4StartTime = break4StartTime.Value;
                            timeScheduleBlockIODTO.Break4Minutes = break4Minutes;
                            timeScheduleBlockIODTO.Break4Link = string.Empty;

                            ShiftType shiftType = !scheduleblock.Item4 ? shiftTypes.First(f => f.ShiftTypeId == scheduleblock.Item3.Value) : null;

                            timeScheduleBlockIODTO.ShiftTypeId = shiftType != null ? shiftType.ShiftTypeId : 0;
                            timeScheduleBlockIODTO.ShiftTypeName = string.Empty;
                            timeScheduleBlockIODTO.ShiftTypeDescription = string.Empty;
                            timeScheduleBlockIODTO.ShiftTypeTimeScheduleTypeId = 0;
                            timeScheduleBlockIODTO.Link = link.ToString();

                            var accOnShiftType = shiftType?.AccountInternal.FirstOrDefault(f => f.Account.AccountDimId == accountDimIdForAccounting);

                            AccountInternal account = accOnShiftType != null ? accounts.FirstOrDefault(f => f.AccountId == accOnShiftType.AccountId).AccountInternal : null;

                            timeScheduleBlockIODTO.AccountNr = string.Empty;
                            timeScheduleBlockIODTO.AccountDim2Nr = account != null ? account.Account.AccountNr : string.Empty;
                            timeScheduleBlockIODTO.AccountDim3Nr = string.Empty;
                            timeScheduleBlockIODTO.AccountDim4Nr = string.Empty;
                            timeScheduleBlockIODTO.AccountDim5Nr = string.Empty;
                            timeScheduleBlockIODTO.AccountDim6Nr = string.Empty;

                            blocksOnDateOnEmployee.Add(timeScheduleBlockIODTO);
                        }
                    }

                    currentDay++;
                    date = date.AddDays(1);

                    List<TimeScheduleBlockIODTO> clones = new List<TimeScheduleBlockIODTO>();
                    foreach (var employee in onEmploymentGroup)
                    {
                        if (!employee.EmployeeAccount.IsLoaded)
                            employee.EmployeeAccount.Load();

                        List<TimeScheduleBlockIODTO> employeeClones = new List<TimeScheduleBlockIODTO>();
                        int totalLength = blocksOnDateOnEmployee.Sum(s => s.LengthMinutes);
                        var diff = (int)(decimal.Subtract(decimal.Multiply(numberOfWeeks, employee.GetEmployment().GetWorkTimeWeek()), totalLength));

                        foreach (var shift in blocksOnDateOnEmployee)
                        {
                            var clone = new TimeScheduleBlockIODTO();
                            clone.TimeScheduleTemplateBlockId = shift.TimeScheduleTemplateBlockId;
                            clone.TimeScheduleTemplatePeriodId = shift.TimeScheduleTemplatePeriodId;
                            clone.TimeScheduleEmployeePeriodId = shift.TimeScheduleEmployeePeriodId;
                            clone.EmployeeNr = employee.EmployeeNr;
                            clone.TimeScheduleTypeId = shift.TimeScheduleTypeId;
                            clone.DayNumber = shift.DayNumber;
                            clone.Description = shift.Description;
                            clone.HierachyAccountId = shift.HierachyAccountId;
                            clone.Link = shift.Link;
                            clone.StartTime = shift.StartTime;
                            clone.StopTime = shift.StopTime;
                            clone.LengthMinutes = shift.LengthMinutes;
                            clone.Date = shift.Date;
                            clone.ShiftTypeId = shift.ShiftTypeId;
                            clone.IsTemplate = shift.IsTemplate;
                            clone.Break1Id = shift.Break1Id;
                            clone.Break1StartTime = shift.Break1StartTime;
                            clone.Break1Minutes = shift.Break1Minutes;
                            clone.Break1Link = shift.Break1Link != null ? shift.Break1Link.ToString() : string.Empty;
                            clone.Break1IsPreliminary = shift.Break1IsPreliminary;
                            clone.Break2Id = shift.Break2Id;
                            clone.Break2StartTime = shift.Break2StartTime;
                            clone.Break2Minutes = shift.Break2Minutes;
                            clone.Break2Link = shift.Break2Link != null ? shift.Break2Link.ToString() : string.Empty;
                            clone.Break2IsPreliminary = shift.Break2IsPreliminary;
                            clone.Break3Id = shift.Break3Id;
                            clone.Break3StartTime = shift.Break3StartTime;
                            clone.Break3Minutes = shift.Break3Minutes;
                            clone.Break3Link = shift.Break3Link != null ? shift.Break3Link.ToString() : string.Empty;
                            clone.Break3IsPreliminary = shift.Break3IsPreliminary;
                            clone.Break4Id = shift.Break4Id;
                            clone.Break4StartTime = shift.Break4StartTime;
                            clone.Break4Minutes = shift.Break4Minutes;
                            clone.Break4Link = shift.Break4Link != null ? shift.Break4Link.ToString() : string.Empty;
                            clone.Break4IsPreliminary = shift.Break4IsPreliminary;
                            clone.HasBreakTimes = false;
                            clone.IsBreak = false;
                            clone.TimeDeviationCauseId = shift.TimeDeviationCauseId;
                            clone.ShiftTypeId = shift.ShiftTypeId;
                            clone.ShiftTypeName = shift.ShiftTypeName;
                            clone.ShiftTypeDescription = shift.ShiftTypeDescription;
                            clone.ShiftTypeTimeScheduleTypeId = shift.TimeScheduleTypeId;
                            clone.AccountNr = shift.AccountNr;
                            clone.AccountDim2Nr = shift.AccountDim2Nr;
                            clone.AccountDim3Nr = shift.AccountDim3Nr;
                            clone.AccountDim4Nr = shift.AccountDim4Nr;
                            clone.AccountDim5Nr = shift.AccountDim5Nr;
                            clone.AccountDim6Nr = shift.AccountDim6Nr;
                            clone.HierachyAccountId = employee.EmployeeAccount?.FirstOrDefault()?.AccountId;
                            clone.EmployeeNr = employee.EmployeeNr;
                            employeeClones.Add(clone);
                        }

                        clones.AddRange(MergeTimeScheduleBlockIODTOs(employeeClones));
                    }

                    blocksOnDateOnEmployee.AddRange(clones);
                    blocksOnDateOnEmployee = blocksOnDateOnEmployee.Where(w => w.EmployeeNr != "").ToList();
                    timeScheduleBlockIODTOs.AddRange(blocksOnDateOnEmployee);
                }

                foreach (var employee in onEmploymentGroup.ToList())
                {
                    var blocksOnEmployee = timeScheduleBlockIODTOs.Where(w => w.EmployeeNr == employee.EmployeeNr);
                    int totalLength = blocksOnEmployee.Where(w => w.Break1Minutes == 0).Sum(s => s.LengthMinutes) - blocksOnEmployee.Where(w => w.Break1Minutes > 0).Sum(s => s.Break1Minutes);
                    var diff = (int)(decimal.Subtract(totalLength, decimal.Multiply(numberOfWeeks, employee.GetEmployment().GetWorkTimeWeek())));

                    foreach (var item in blocksOnEmployee.GroupBy(g => g.Date))
                    {
                        var first = item.OrderBy(o => o.StartTime).First();
                        var last = item.OrderBy(o => o.StartTime).Last();
                        int adjustMinutes = 15;

                        if (diff > 300 || diff < -300)
                            adjustMinutes = 30;

                        if (diff > 0 && first.StopTime > first.StartTime.AddMinutes(adjustMinutes))
                        {
                            first.StartTime = first.StartTime.AddMinutes(adjustMinutes);
                            diff = diff - adjustMinutes;
                        }
                        else
                        {
                            first.StartTime = first.StartTime.AddMinutes(-adjustMinutes);
                            diff = diff + adjustMinutes;
                        }

                        if (diff > 0 && last.StartTime < last.StopTime.AddMinutes(-adjustMinutes))
                        {
                            last.StopTime = last.StopTime.AddMinutes(-adjustMinutes);
                            diff = diff - adjustMinutes;
                        }
                        else
                        {
                            last.StopTime = last.StopTime.AddMinutes(15);
                            diff = diff + adjustMinutes;
                        }

                        if (diff < 15 && diff > -15)
                            break;
                    }
                }

                ImportTimeScheduleBlockFromIO(timeScheduleBlockIODTOs, actorCompanyId);
            }

            return new ActionResult();
        }

        protected List<TimeScheduleBlockIODTO> MergeTimeScheduleBlockIODTOs(List<TimeScheduleBlockIODTO> timeScheduleBlockIODTOs)
        {
            TimeScheduleBlockIODTO previous = null;

            foreach (var item in timeScheduleBlockIODTOs.Where(t => t.Break1Minutes == 0).OrderBy(o => o.StartTime))
            {
                if (previous == null || item.ShiftTypeId != previous.ShiftTypeId || previous.StopTime != item.StartTime)
                {
                    previous = item;
                    continue;
                }

                if (previous.StopTime == item.StartTime)
                {
                    previous.StopTime = item.StopTime;
                    item.State = SoeEntityState.Deleted;
                    previous.LengthMinutes += item.LengthMinutes;
                    continue;
                }

                previous = item;
            }

            return timeScheduleBlockIODTOs.Where(t => t.State != SoeEntityState.Deleted).ToList();
        }

        public ActionResult ImportInventoryIO(InventoryIOItem inventoryIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportInventoryFromIO(inventoryIOItem.inventoryIOs, actorCompanyId);
        }

        public ActionResult ImportInventoryFromIO(List<InventoryIODTO> inventoryIODTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            #region Prereq

            //Get AccountDims
            var sieDim1 = 1;
            var sieDim6 = 6;
            var accountSiedim1 = AccountManager.GetAccountDimFromSieDimNr(sieDim1, actorCompanyId);
            var accountSiedim6 = AccountManager.GetAccountDimFromSieDimNr(sieDim6, actorCompanyId);

            List<VoucherSeriesType> currentVoucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(actorCompanyId, false);
            List<InventoryWriteOffMethod> currentInventoryWriteOffMethods = InventoryManager.GetInventoryWriteOffMethods(actorCompanyId);
            List<Inventory> currentInventories = InventoryManager.GetInventories(actorCompanyId);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                List<AccountDim> dims = AccountManager.GetAccountDimsByCompany(actorCompanyId);
                int inventoryWriteOffMethodCounter = currentInventoryWriteOffMethods.Count;
                int defaultVoucherSeriesTypeid = 0;

                //try to find default voucherseriesType
                if (currentVoucherSeriesTypes.Any(c => c.Name.ToLower().Contains("inven")))
                    defaultVoucherSeriesTypeid = currentVoucherSeriesTypes.FirstOrDefault(c => c.Name.ToLower().Contains("inven"))?.VoucherSeriesTypeId ?? 0;

                if (defaultVoucherSeriesTypeid == 0 && currentVoucherSeriesTypes.Any(c => c.Name.ToLower().Contains("avskriv")))
                    defaultVoucherSeriesTypeid = currentVoucherSeriesTypes.FirstOrDefault(c => c.Name.ToLower().Contains("avskriv"))?.VoucherSeriesTypeId ?? 0;

                if (defaultVoucherSeriesTypeid == 0 && currentVoucherSeriesTypes.Any(c => c.Name.ToLower().Contains("anlägg")))
                    defaultVoucherSeriesTypeid = currentVoucherSeriesTypes.FirstOrDefault(c => c.Name.ToLower().Contains("anlägg"))?.VoucherSeriesTypeId ?? 0;

                #endregion

                #region Create InventoryWriteOffMethod if not exist

                foreach (var inventoryIO in inventoryIODTOs.OrderBy(i => i.InventoryWriteOffMethodName))
                {
                    if (inventoryWriteOffMethodCounter == 0 || !currentInventoryWriteOffMethods.Any(v => v.Name.ToLower() == inventoryIO.InventoryWriteOffMethodName.ToLower()))
                    {
                        InventoryWriteOffMethodDTO inventoryWriteOffMethod = new InventoryWriteOffMethodDTO();
                        inventoryWriteOffMethod.ActorCompanyId = actorCompanyId;
                        inventoryWriteOffMethod.Description = inventoryIO.InventoryWriteOffMethodDescription;
                        inventoryWriteOffMethod.Name = inventoryIO.InventoryWriteOffMethodName;
                        inventoryWriteOffMethod.PeriodType = inventoryIO.InventoryWriteOffMethodPeriodType == 1 || inventoryIO.InventoryWriteOffMethodPeriodType == 2 ? (TermGroup_InventoryWriteOffMethodPeriodType)inventoryIO.InventoryWriteOffMethodPeriodType : TermGroup_InventoryWriteOffMethodPeriodType.Year;
                        inventoryWriteOffMethod.PeriodValue = inventoryIO.InventoryWriteOffMethodPeriodValue;
                        inventoryWriteOffMethod.Type = inventoryIO.InventoryWriteOffMethodType >= 1 && inventoryIO.InventoryWriteOffMethodType <= 4 ? (TermGroup_InventoryWriteOffMethodType)inventoryIO.InventoryWriteOffMethodType : TermGroup_InventoryWriteOffMethodType.AccordingToTheBooks_ComplementaryRule;

                        InventoryManager.SaveInventoryWriteOffMethod(inventoryWriteOffMethod, actorCompanyId);

                        inventoryWriteOffMethodCounter++;
                        currentInventoryWriteOffMethods = InventoryManager.GetInventoryWriteOffMethods(actorCompanyId);
                    }
                }

                #endregion

                #region create DTO

                if (inventoryWriteOffMethodCounter != 0)
                {
                    foreach (var inventoryIO in inventoryIODTOs)
                    {

                        #region prereq

                        int voucherSeriesTypeId = 0;
                        int inventoryWriteOffMethodId = 0;

                        if (currentInventories.Any(i => i.InventoryNr == inventoryIO.InventoryNr))
                            continue;

                        if (currentVoucherSeriesTypes.Any(v => v.VoucherSeriesTypeNr.ToString() == inventoryIO.VoucherSeriesTypeNr))
                        {
                            voucherSeriesTypeId = currentVoucherSeriesTypes.FirstOrDefault(v => v.VoucherSeriesTypeNr.ToString() == inventoryIO.VoucherSeriesTypeNr)?.VoucherSeriesTypeId ?? 0;
                        }
                        else
                        {
                            if (defaultVoucherSeriesTypeid != 0)
                                voucherSeriesTypeId = defaultVoucherSeriesTypeid;

                            if (voucherSeriesTypeId == 0 && currentVoucherSeriesTypes.Any())
                                voucherSeriesTypeId = currentVoucherSeriesTypes.FirstOrDefault()?.VoucherSeriesTypeId ?? 0;
                        }

                        if (voucherSeriesTypeId == 0)
                            continue;

                        if (currentInventoryWriteOffMethods.Any(i => i.Name.ToLower() == inventoryIO.InventoryWriteOffMethodName.ToLower()))
                            inventoryWriteOffMethodId = currentInventoryWriteOffMethods.FirstOrDefault(i => i.Name.ToLower() == inventoryIO.InventoryWriteOffMethodName.ToLower())?.InventoryWriteOffMethodId ?? 0;
                        else
                            continue;

                        CustomerInvoice invoice = null;
                        if (!string.IsNullOrEmpty(inventoryIO.CustomerInvoiceNr))
                            invoice = InvoiceManager.GetCustomerInvoiceByNr(entities, inventoryIO.CustomerInvoiceNr, SoeOriginType.CustomerInvoice, OrderInvoiceRegistrationType.Invoice, actorCompanyId, false);

                        #endregion

                        var dto = new InventoryDTO
                        {
                            Name = inventoryIO.Name,
                            Description = inventoryIO.Description,
                            Notes = inventoryIO.Notes,
                            InventoryNr = inventoryIO.InventoryNr,
                            VoucherSeriesTypeId = voucherSeriesTypeId,
                            State = (SoeEntityState)inventoryIO.State,
                            ParentName = inventoryIO.ParentName,
                            InventoryWriteOffMethodId = inventoryWriteOffMethodId,
                            Status = (TermGroup_InventoryStatus)inventoryIO.Status
                        };

                        dto.SupplierInvoiceId = !string.IsNullOrEmpty(inventoryIO.SupplierInvoiceNr) ? (int?)SupplierInvoiceManager.GetSupplierInvoiceIdByNr(entities, inventoryIO.SupplierInvoiceNr, actorCompanyId, null) : null;
                        dto.CustomerInvoiceId = invoice != null ? (int?)invoice.InvoiceId : null;
                        dto.PurchaseDate = inventoryIO.PurchaseDate != CalendarUtility.DATETIME_DEFAULT ? inventoryIO.PurchaseDate : DateTime.Today.Date;
                        dto.WriteOffDate = inventoryIO.WriteOffDate != CalendarUtility.DATETIME_DEFAULT ? inventoryIO.PurchaseDate : CalendarUtility.GetLastDateOfYear(dto.PurchaseDate);
                        dto.PurchaseAmount = inventoryIO.PurchaseAmount;
                        dto.WriteOffAmount = inventoryIO.WriteOffAmount;
                        dto.WriteOffSum = inventoryIO.WriteOffSum;
                        dto.WriteOffRemainingAmount = inventoryIO.WriteOffRemainingAmount;
                        dto.EndAmount = inventoryIO.EndAmount;
                        dto.PeriodType = (TermGroup_InventoryWriteOffMethodPeriodType)inventoryIO.PeriodType;
                        dto.PeriodValue = inventoryIO.PeriodValue;
                        dto.WriteOffPeriods = inventoryIO.WriteOffPeriods;

                        if (dto.Status == TermGroup_InventoryStatus.None)
                        {
                            if (dto.WriteOffRemainingAmount == 0)
                            {
                                dto.Status = TermGroup_InventoryStatus.WrittenOff;
                            }
                            else
                            {
                                dto.Status = TermGroup_InventoryStatus.Active;
                            }
                        }


                        #region fixes

                        if (inventoryIO.PeriodType == 0)
                            dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Year;

                        if (dto.PeriodValue == 0)
                            dto.PeriodValue = 5;
                        switch (inventoryIO.InventoryWriteOffMethodName)
                        {
                            case "1":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 12;
                                break;
                            case "3":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 36;
                                break;
                            case "5":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 60;
                                break;
                            case "7":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                if (inventoryIO.InventoryWriteOffMethodPeriodType == 15)
                                    dto.PeriodValue = 80;
                                else
                                    dto.PeriodValue = 84;
                                break;
                            case "10":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 120;
                                break;
                            case "18":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 216;
                                break;
                            case "20":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 240;
                                break;
                            case "30":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 360;
                                break;
                            case "40":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 480;
                                break;
                            case "50":
                                dto.PeriodType = TermGroup_InventoryWriteOffMethodPeriodType.Period;
                                dto.PeriodValue = 600;
                                break;
                        }

                        if (dto.WriteOffPeriods == 0)
                        {
                            decimal writeOffAmount = inventoryIO.WriteOffAmount / dto.PeriodValue;
                            if (writeOffAmount != 0)
                            {
                                // Caused division by zero error
                                dto.WriteOffPeriods = Convert.ToInt32(Math.Round(inventoryIO.WriteOffSum / writeOffAmount));
                            }
                        }

                        #endregion

                        // Types
                        // 1 = Inventory
                        // 2 = AccWriteOff
                        // 3 = WriteOff
                        // 4 = AccOverWriteOff
                        // 5 = OverWriteOff
                        // 6 = AccWriteDown
                        // 7 = WriteDown
                        // 8 = AccWriteUp
                        // 9 = WriteUp
                        if (accountSiedim1 != null && inventoryIO.InventoryAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.InventoryAccountDim2Nr = inventoryIO.InventoryAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.InventoryAccountDim3Nr = inventoryIO.InventoryAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.InventoryAccountDim4Nr = inventoryIO.InventoryAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.InventoryAccountDim5Nr = inventoryIO.InventoryAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.InventoryAccountDim6Nr = inventoryIO.InventoryAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.InventoryAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.InventoryAccountDim2Nr = inventoryIO.InventoryAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.InventoryAccountDim3Nr = inventoryIO.InventoryAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.InventoryAccountDim4Nr = inventoryIO.InventoryAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.InventoryAccountDim5Nr = inventoryIO.InventoryAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.InventoryAccountDim6Nr = inventoryIO.InventoryAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.AccWriteOffAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccWriteOffAccountDim2Nr = inventoryIO.AccWriteOffAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.AccWriteOffAccountDim3Nr = inventoryIO.AccWriteOffAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.AccWriteOffAccountDim4Nr = inventoryIO.AccWriteOffAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.AccWriteOffAccountDim5Nr = inventoryIO.AccWriteOffAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.AccWriteOffAccountDim6Nr = inventoryIO.AccWriteOffAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.AccWriteOffAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccWriteOffAccountDim2Nr = inventoryIO.AccWriteOffAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.AccWriteOffAccountDim3Nr = inventoryIO.AccWriteOffAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.AccWriteOffAccountDim4Nr = inventoryIO.AccWriteOffAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.AccWriteOffAccountDim5Nr = inventoryIO.AccWriteOffAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.AccWriteOffAccountDim6Nr = inventoryIO.AccWriteOffAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.WriteOffAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.WriteOffAccountDim2Nr = inventoryIO.WriteOffAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.WriteOffAccountDim3Nr = inventoryIO.WriteOffAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.WriteOffAccountDim4Nr = inventoryIO.WriteOffAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.WriteOffAccountDim5Nr = inventoryIO.WriteOffAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.WriteOffAccountDim6Nr = inventoryIO.WriteOffAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.WriteOffAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.WriteOffAccountDim2Nr = inventoryIO.WriteOffAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.WriteOffAccountDim3Nr = inventoryIO.WriteOffAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.WriteOffAccountDim4Nr = inventoryIO.WriteOffAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.WriteOffAccountDim5Nr = inventoryIO.WriteOffAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.WriteOffAccountDim6Nr = inventoryIO.WriteOffAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.AccOverWriteOffAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccOverWriteOffAccountDim2Nr = inventoryIO.AccOverWriteOffAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.AccOverWriteOffAccountDim3Nr = inventoryIO.AccOverWriteOffAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.AccOverWriteOffAccountDim4Nr = inventoryIO.AccOverWriteOffAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.AccOverWriteOffAccountDim5Nr = inventoryIO.AccOverWriteOffAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.AccOverWriteOffAccountDim6Nr = inventoryIO.AccOverWriteOffAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.AccOverWriteOffAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccOverWriteOffAccountDim2Nr = inventoryIO.AccOverWriteOffAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.AccOverWriteOffAccountDim3Nr = inventoryIO.AccOverWriteOffAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.AccOverWriteOffAccountDim4Nr = inventoryIO.AccOverWriteOffAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.AccOverWriteOffAccountDim5Nr = inventoryIO.AccOverWriteOffAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.AccOverWriteOffAccountDim6Nr = inventoryIO.AccOverWriteOffAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.OverWriteOffAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.OverWriteOffAccountDim2Nr = inventoryIO.OverWriteOffAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.OverWriteOffAccountDim3Nr = inventoryIO.OverWriteOffAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.OverWriteOffAccountDim4Nr = inventoryIO.OverWriteOffAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.OverWriteOffAccountDim5Nr = inventoryIO.OverWriteOffAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.OverWriteOffAccountDim6Nr = inventoryIO.OverWriteOffAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.OverWriteOffAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.OverWriteOffAccountDim2Nr = inventoryIO.OverWriteOffAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.OverWriteOffAccountDim3Nr = inventoryIO.OverWriteOffAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.OverWriteOffAccountDim4Nr = inventoryIO.OverWriteOffAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.OverWriteOffAccountDim5Nr = inventoryIO.OverWriteOffAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.OverWriteOffAccountDim6Nr = inventoryIO.OverWriteOffAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.AccWriteDownAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccWriteDownAccountDim2Nr = inventoryIO.AccWriteDownAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.AccWriteDownAccountDim3Nr = inventoryIO.AccWriteDownAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.AccWriteDownAccountDim4Nr = inventoryIO.AccWriteDownAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.AccWriteDownAccountDim5Nr = inventoryIO.AccWriteDownAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.AccWriteDownAccountDim6Nr = inventoryIO.AccWriteDownAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.AccWriteDownAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccWriteDownAccountDim2Nr = inventoryIO.AccWriteDownAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.AccWriteDownAccountDim3Nr = inventoryIO.AccWriteDownAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.AccWriteDownAccountDim4Nr = inventoryIO.AccWriteDownAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.AccWriteDownAccountDim5Nr = inventoryIO.AccWriteDownAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.AccWriteDownAccountDim6Nr = inventoryIO.AccWriteDownAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.WriteDownAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.WriteDownAccountDim2Nr = inventoryIO.WriteDownAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.WriteDownAccountDim3Nr = inventoryIO.WriteDownAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.WriteDownAccountDim4Nr = inventoryIO.WriteDownAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.WriteDownAccountDim5Nr = inventoryIO.WriteDownAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.WriteDownAccountDim6Nr = inventoryIO.WriteDownAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.WriteDownAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.WriteDownAccountDim2Nr = inventoryIO.WriteDownAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.WriteDownAccountDim3Nr = inventoryIO.WriteDownAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.WriteDownAccountDim4Nr = inventoryIO.WriteDownAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.WriteDownAccountDim5Nr = inventoryIO.WriteDownAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.WriteDownAccountDim6Nr = inventoryIO.WriteDownAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.AccWriteUpAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccWriteUpAccountDim2Nr = inventoryIO.AccWriteUpAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.AccWriteUpAccountDim3Nr = inventoryIO.AccWriteUpAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.AccWriteUpAccountDim4Nr = inventoryIO.AccWriteUpAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.AccWriteUpAccountDim5Nr = inventoryIO.AccWriteUpAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.AccWriteUpAccountDim6Nr = inventoryIO.AccWriteUpAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.AccWriteUpAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.AccWriteUpAccountDim2Nr = inventoryIO.AccWriteUpAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.AccWriteUpAccountDim3Nr = inventoryIO.AccWriteUpAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.AccWriteUpAccountDim4Nr = inventoryIO.AccWriteUpAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.AccWriteUpAccountDim5Nr = inventoryIO.AccWriteUpAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.AccWriteUpAccountDim6Nr = inventoryIO.AccWriteUpAccountSieDim6;
                                    break;
                            }
                        }
                        if (accountSiedim1 != null && inventoryIO.WriteUpAccountSieDim1 != null)
                        {
                            switch (accountSiedim1.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.WriteUpAccountDim2Nr = inventoryIO.WriteUpAccountSieDim1;
                                    break;
                                case 3:
                                    inventoryIO.WriteUpAccountDim3Nr = inventoryIO.WriteUpAccountSieDim1;
                                    break;
                                case 4:
                                    inventoryIO.WriteUpAccountDim4Nr = inventoryIO.WriteUpAccountSieDim1;
                                    break;
                                case 5:
                                    inventoryIO.WriteUpAccountDim5Nr = inventoryIO.WriteUpAccountSieDim1;
                                    break;
                                case 6:
                                    inventoryIO.WriteUpAccountDim6Nr = inventoryIO.WriteUpAccountSieDim1;
                                    break;
                            }
                        }
                        if (accountSiedim6 != null && inventoryIO.WriteUpAccountSieDim6 != null)
                        {
                            switch (accountSiedim6.AccountDimNr)
                            {
                                case 2:
                                    inventoryIO.WriteUpAccountDim2Nr = inventoryIO.WriteUpAccountSieDim6;
                                    break;
                                case 3:
                                    inventoryIO.WriteUpAccountDim3Nr = inventoryIO.WriteUpAccountSieDim6;
                                    break;
                                case 4:
                                    inventoryIO.WriteUpAccountDim4Nr = inventoryIO.WriteUpAccountSieDim6;
                                    break;
                                case 5:
                                    inventoryIO.WriteUpAccountDim5Nr = inventoryIO.WriteUpAccountSieDim6;
                                    break;
                                case 6:
                                    inventoryIO.WriteUpAccountDim6Nr = inventoryIO.WriteUpAccountSieDim6;
                                    break;
                            }
                        }

                        var accountSettings = new List<AccountingSettingDTO>();

                        if (!string.IsNullOrEmpty(inventoryIO.InventoryAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 1, dims, inventoryIO.InventoryAccountNr, inventoryIO.InventoryAccountDim2Nr, inventoryIO.InventoryAccountDim3Nr, inventoryIO.InventoryAccountDim4Nr, inventoryIO.InventoryAccountDim5Nr, inventoryIO.InventoryAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.AccWriteOffAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 2, dims, inventoryIO.AccWriteOffAccountNr, inventoryIO.AccWriteOffAccountDim2Nr, inventoryIO.AccWriteOffAccountDim3Nr, inventoryIO.AccWriteOffAccountDim4Nr, inventoryIO.AccWriteOffAccountDim5Nr, inventoryIO.AccWriteOffAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.WriteOffAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 3, dims, inventoryIO.WriteOffAccountNr, inventoryIO.WriteOffAccountDim2Nr, inventoryIO.WriteOffAccountDim3Nr, inventoryIO.WriteOffAccountDim4Nr, inventoryIO.WriteOffAccountDim5Nr, inventoryIO.WriteOffAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.AccOverWriteOffAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 4, dims, inventoryIO.AccOverWriteOffAccountNr, inventoryIO.AccOverWriteOffAccountDim2Nr, inventoryIO.AccOverWriteOffAccountDim3Nr, inventoryIO.AccOverWriteOffAccountDim4Nr, inventoryIO.AccOverWriteOffAccountDim5Nr, inventoryIO.AccOverWriteOffAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.OverWriteOffAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 5, dims, inventoryIO.OverWriteOffAccountNr, inventoryIO.OverWriteOffAccountDim2Nr, inventoryIO.OverWriteOffAccountDim3Nr, inventoryIO.OverWriteOffAccountDim4Nr, inventoryIO.OverWriteOffAccountDim5Nr, inventoryIO.OverWriteOffAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.AccWriteDownAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 6, dims, inventoryIO.AccWriteDownAccountNr, inventoryIO.AccWriteDownAccountDim2Nr, inventoryIO.AccWriteDownAccountDim3Nr, inventoryIO.AccWriteDownAccountDim4Nr, inventoryIO.AccWriteDownAccountDim5Nr, inventoryIO.AccWriteDownAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.WriteDownAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 7, dims, inventoryIO.WriteDownAccountNr, inventoryIO.WriteDownAccountDim2Nr, inventoryIO.WriteDownAccountDim3Nr, inventoryIO.WriteDownAccountDim4Nr, inventoryIO.WriteDownAccountDim5Nr, inventoryIO.WriteDownAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.AccWriteUpAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 8, dims, inventoryIO.AccWriteUpAccountNr, inventoryIO.AccWriteUpAccountDim2Nr, inventoryIO.AccWriteUpAccountDim3Nr, inventoryIO.AccWriteUpAccountDim4Nr, inventoryIO.AccWriteUpAccountDim5Nr, inventoryIO.AccWriteUpAccountDim6Nr));
                        if (!string.IsNullOrEmpty(inventoryIO.WriteUpAccountNr))
                            accountSettings.AddRange(CreateAccountingSettingDTO(actorCompanyId, 9, dims, inventoryIO.WriteUpAccountNr, inventoryIO.WriteUpAccountDim2Nr, inventoryIO.WriteUpAccountDim3Nr, inventoryIO.WriteUpAccountDim4Nr, inventoryIO.WriteUpAccountDim5Nr, inventoryIO.WriteUpAccountDim6Nr));


                        if (accountSettings == new List<AccountingSettingDTO>())
                            accountSettings = null;

                        var saveResult = InventoryManager.SaveInventory(dto, null, accountSettings, 0, actorCompanyId);

                        if (saveResult.Success)
                        {
                            result.Success = true;
                            nbrOfSaved++;

                        }
                        else
                        {
                            result.IntegerValue = nbrOfSaved;
                            return result;
                        }
                    }
                }

                #endregion
            }

            return result;
        }

        #endregion

        #region TimeCodeTransactionSimpleIO

        public List<TimeCodeTransactionSimpleIODTO> GetTimeCodeTransactionSimples(int actorCompanyId, DateTime? dateFrom, DateTime? dateTo, List<string> employeeNumbers)
        {

            return new List<TimeCodeTransactionSimpleIODTO>(); //TODO maybe? DTO mostly for import?
        }

        public ActionResult ImportTimeCodeTransactionSimpleIO(TimeCodeTransactionSimpleIOItem timeCodeTransactionSimpleIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromTimeCodeTransactionSimpleIO(timeCodeTransactionSimpleIOItem.timeCodeTransactionSimpleIOs, actorCompanyId);
        }

        public ActionResult ImportFromTimeCodeTransactionSimpleIO(List<TimeCodeTransactionSimpleIODTO> timeCodeTransactionSimpleIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(actorCompanyId);
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, active: null);
            List<Project> projects = ProjectManager.GetProjects(actorCompanyId, TermGroup_ProjectType.TimeProject, null, true, false, false, false);
            List<TimeCodeTransactionDTO> dtos = new List<TimeCodeTransactionDTO>();

            using (CompEntities entities = new CompEntities())
            {
                foreach (var timeCodeTransactionSimple in timeCodeTransactionSimpleIOs.GroupBy(g => g.EmployeeNr))
                {
                    foreach (var transactionItem in timeCodeTransactionSimple)
                    {
                        #region TransactionItem

                        TimeCodeTransactionDTO dto = new TimeCodeTransactionDTO();

                        //Employee
                        dto.EmployeeId = employees.FirstOrDefault(e => e.EmployeeNr == transactionItem.EmployeeNr)?.EmployeeId;
                        if (!dto.EmployeeId.HasValue)
                            continue;

                        //TimeCode
                        var timeCode = timeCodes.FirstOrDefault(t => t.Code.ToLower() == transactionItem.TimeCodeCode.ToLower());
                        dto.TimeCodeId = timeCode?.TimeCodeId ?? 0;
                        if (dto.TimeCodeId == 0)
                        {
                            result.ErrorMessage = "TimeCode not found " + transactionItem.TimeCodeCode;
                            return result;
                        }

                        dto.ProjectId = projects?.FirstOrDefault(s => s.Number.ToLower() == transactionItem.ProjectNr.ToLower())?.ProjectId;
                        dto.Amount = transactionItem.Amount;
                        dto.AmountCurrency = transactionItem.AmountCurrency;
                        dto.AmountEntCurrency = transactionItem.AmountEntCurrency;
                        dto.AmountLedgerCurrency = transactionItem.AmountLedgerCurrency;
                        dto.Vat = transactionItem.Vat;
                        dto.VatCurrency = transactionItem.VatCurrency;
                        dto.VatEntCurrency = transactionItem.VatEntCurrency;
                        dto.VatLedgerCurrency = transactionItem.VatLedgerCurrency;
                        dto.Quantity = transactionItem.Quantity;
                        dto.InvoiceQuantity = transactionItem.InvoiceQuantity;
                        dto.IsAddition = timeCode.IsAdditionAndDeduction();
                        dto.Start = transactionItem.Start;
                        dto.Stop = transactionItem.Stop;
                        dto.Comment = transactionItem.Comment;
                        dto.IsRegistrationTypeQuantity = false;
                        dto.IsRegistrationTypeTime = true;
                        dto.TimePayrollTransactionItems = new List<TimePayrollTransactionDTO>();
                        dto.TimeInvoiceTransactionItems = new List<TimeInvoiceTransactionDTO>();

                        dtos.Add(dto);
                        #endregion
                    }
                }
            }

            TimeEngineManager tim = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);
            return tim.SaveTimeCodeTransactions(dtos);
        }

        #endregion

        #region TimeCodeTransactionIO

        public ActionResult ImportTimeCodeTransactonIO(TimeCodeTransactionIOItem transactionItems, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportTimeCodeTransactionFromIO(transactionItems.timeCodeTransactionIOs, actorCompanyId);
        }

        public ActionResult ImportTimeCodeTransactionFromIO(List<TimeCodeTransactionIODTO> transactionItems, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            List<PayrollProduct> payrollProducts = ProductManager.GetPayrollProducts(actorCompanyId, active: true, loadAccounts: false);
            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(actorCompanyId, SoeTimeCodeType.None, loadPayrollProducts: true).ToList();
            List<Supplier> suppliers = SupplierManager.GetSuppliersByCompany(actorCompanyId, true);
            List<Project> projects = ProjectManager.GetProjects(actorCompanyId, TermGroup_ProjectType.TimeProject, true, false, false, false, false, -1);
            List<Employee> employees = EmployeeManager.GetAllEmployees(actorCompanyId, active: true);
            List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(actorCompanyId, true, false, false);
            List<TimeSheetWeek> timesheetWeeks = ProjectManager.GetAllTimeSheetsForCompany(actorCompanyId);
            List<AccountDimDTO> accountDimDTOs = AccountManager.GetAccountDimsByCompany(actorCompanyId, false, true, true).ToDTOs();
            List<AccountInternalDTO> accountDTOs = AccountManager.GetAccountInternals(actorCompanyId, true).ToDTOs();

            List<TimeCodeTransactionDTO> dtos = new List<TimeCodeTransactionDTO>();
            List<KeyValuePair<string, string>> timeCodeTimePayrollProductMatch = new List<KeyValuePair<string, string>>();

            #region Find matching timecode to payrollNumber

            if (transactionItems.Any(t => string.IsNullOrEmpty(t.TimeCodeCode) && !string.IsNullOrEmpty(t.PayrollProductNr)))
            {
                foreach (var transactionItem in transactionItems)
                {
                    foreach (TimeCode timeCode in timeCodes)
                    {
                        if (string.IsNullOrEmpty(transactionItem.TimeCodeCode) && string.IsNullOrEmpty(transactionItem.TimeCodeName))
                        {
                            var payroll = timeCode.TimeCodePayrollProduct?.FirstOrDefault();
                            if (payroll != null && payroll.PayrollProduct != null)
                                timeCodeTimePayrollProductMatch.Add(new KeyValuePair<string, string>(timeCode.Code, payroll.PayrollProduct.Number));
                        }
                    }
                }

                timeCodeTimePayrollProductMatch = timeCodeTimePayrollProductMatch.Distinct().ToList();
            }


            #endregion

            #region Create TimeSheetWeek

            bool createTimeSheetWeeks = true;

            //Get all EmployeeIds
            List<int> employeeIds = new List<int>();

            foreach (var transactionItem in transactionItems)
            {
                Employee employee = employees.FirstOrDefault(e => e.EmployeeNr == transactionItem.EmployeeNr);
                if (employee != null && !employeeIds.Contains(employee.EmployeeId))
                    employeeIds.Add(employee.EmployeeId);

                if (createTimeSheetWeeks && transactionItem.IsAddition)
                    createTimeSheetWeeks = false;
            }

            //Get all Weeks
            DateTime firstDate = CalendarUtility.DATETIME_DEFAULT;
            DateTime lastDate = CalendarUtility.DATETIME_DEFAULT;

            if (createTimeSheetWeeks)
            {
                foreach (var transactionItem in transactionItems)
                {
                    if (firstDate == CalendarUtility.DATETIME_DEFAULT)
                    {
                        firstDate = transactionItem.Start;
                        lastDate = transactionItem.Start;
                    }
                    else
                    {
                        if (firstDate > transactionItem.Start)
                            firstDate = transactionItem.Start;

                        if (lastDate < transactionItem.Start)
                            lastDate = transactionItem.Start;
                    }
                }
            }

            DateTime firstMonday = CalendarUtility.GetFirstDateOfWeek(firstDate);
            List<DateTime> mondays = new List<DateTime>();

            if (createTimeSheetWeeks)
            {
                while (firstMonday <= lastDate)
                {
                    mondays.Add(firstMonday);

                    firstMonday = firstMonday.AddDays(7);
                }

                foreach (var monday in mondays)
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        foreach (var employeeId in employeeIds)
                        {
                            if (timesheetWeeks.Any(i => i.EmployeeId == employeeId && i.Date == monday))
                                continue;

                            TimeSheetWeek week = new TimeSheetWeek();
                            week.Date = monday;
                            week.EmployeeId = employeeId;
                            week.RowNr = 1;
                            week.Comment = "Imported";
                            entities.TimeSheetWeek.AddObject(week);
                        }

                        entities.SaveChanges();
                    }
                }
            }

            #endregion

            foreach (var transactionItem in transactionItems)
            {
                #region TransactionItem

                using (CompEntities entities = new CompEntities())
                {
                    TimeCodeTransactionDTO dto = new TimeCodeTransactionDTO();

                    //Employee
                    dto.EmployeeId = employees.FirstOrDefault(e => e.EmployeeNr == transactionItem.EmployeeNr)?.EmployeeId;
                    if (!dto.EmployeeId.HasValue)
                        continue;

                    //TimeCode
                    dto.TimeCodeId = timeCodes.FirstOrDefault(t => t.Code.ToLower() == transactionItem.TimeCodeCode.ToLower())?.TimeCodeId ?? 0;
                    if (dto.TimeCodeId == 0 && timeCodeTimePayrollProductMatch.Any(t => t.Value.ToLower().Equals(transactionItem.PayrollProductNr.ToLower())))
                        dto.TimeCodeId = timeCodes.FirstOrDefault(t => t.Code.ToLower() == transactionItem.TimeCodeCode.ToLower())?.TimeCodeId ?? 0;

                    if (dto.TimeCodeId == 0)
                    {
                        result.ErrorMessage = "TimeCode not found " + transactionItem.TimeCodeCode;
                        return result;
                    }

                    dto.ProjectId = projects?.FirstOrDefault(s => s.Number.ToLower() == transactionItem.ProjectNr.ToLower())?.ProjectId;
                    dto.Amount = transactionItem.Amount;
                    dto.AmountCurrency = transactionItem.AmountCurrency;
                    dto.AmountEntCurrency = transactionItem.AmountEntCurrency;
                    dto.AmountLedgerCurrency = transactionItem.AmountLedgerCurrency;
                    dto.Vat = transactionItem.Vat;
                    dto.VatCurrency = transactionItem.VatCurrency;
                    dto.VatEntCurrency = transactionItem.VatEntCurrency;
                    dto.VatLedgerCurrency = transactionItem.VatLedgerCurrency;
                    dto.Quantity = transactionItem.Quantity;
                    dto.InvoiceQuantity = transactionItem.InvoiceQuantity;
                    dto.IsAddition = transactionItem.IsAddition;
                    dto.Start = transactionItem.Start;
                    dto.Stop = transactionItem.Stop;
                    dto.Comment = transactionItem.Comment;
                    dto.IsRegistrationTypeQuantity = transactionItem.IsRegistrationTypeQuantity;
                    dto.IsRegistrationTypeTime = transactionItem.IsRegistrationTypeTime;
                    dto.IsReadOnly = transactionItem.IsReadOnly;
                    dto.TimePayrollTransactionItems = new List<TimePayrollTransactionDTO>();
                    dto.TimeInvoiceTransactionItems = new List<TimeInvoiceTransactionDTO>();

                    ProjectInvoiceDay day = new ProjectInvoiceDay();
                    ProjectInvoiceWeek week = new ProjectInvoiceWeek();
                    CustomerInvoice invoice = null;
                    int payrollProductId = 0;

                    //PayrollProductId
                    if (transactionItem.IsAddition || payrollProductId == 0)
                    {
                        TimeCode timeCode = TimeCodeManager.GetTimeCode(entities, dto.TimeCodeId, actorCompanyId, true, loadInvoiceProducts: true, loadPayrollProducts: true);
                        if (timeCode?.TimeCodePayrollProduct != null)
                        {
                            foreach (TimeCodePayrollProduct timeCodePayrollProduct in timeCode.TimeCodePayrollProduct)
                            {
                                if (!timeCodePayrollProduct.PayrollProductReference.IsLoaded)
                                    timeCodePayrollProduct.PayrollProductReference.Load();

                                payrollProductId = timeCodePayrollProduct.PayrollProduct?.ProductId ?? 0;
                            }
                        }
                    }

                    //SupplierInvoice
                    int? supplierId = suppliers?.FirstOrDefault(s => s.SupplierNr.ToLower() == transactionItem.SupplierNr.ToLower())?.ActorSupplierId ?? 0;
                    dto.SupplierInvoiceId = supplierId.HasValue ? SupplierInvoiceManager.GetSupplierInvoiceIdByNr(entities, transactionItem.SupplierInvoiceNr, supplierId.Value, actorCompanyId, null) : 0;

                    //CustomerInvoice
                    if (!string.IsNullOrEmpty(transactionItem.CustomerInvoiceNr))
                    {
                        invoice =
                            InvoiceManager.GetCustomerInvoiceByNr(entities, transactionItem.CustomerInvoiceNr, SoeOriginType.CustomerInvoice, OrderInvoiceRegistrationType.Invoice, actorCompanyId, false) ??
                            InvoiceManager.GetCustomerInvoiceByNr(entities, transactionItem.CustomerInvoiceNr, SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId, false);

                        if (invoice != null)
                        {
                            invoice.CustomerInvoiceRow.Load();
                            if (invoice.CustomerInvoiceRow.Any())
                                dto.CustomerInvoiceRowId = (int?)invoice.CustomerInvoiceRow.FirstOrDefault().CustomerInvoiceRowId;
                        }
                    }

                    //AccountInternals
                    List<AccountInternalDTO> accountInternals = AccountManager.ConvertToAccountInternalDTOs(accountDimDTOs, accountDTOs, transactionItem.AccountDim2Nr, transactionItem.AccountDim3Nr, transactionItem.AccountDim4Nr, transactionItem.AccountDim5Nr, transactionItem.AccountDim6Nr);

                    //TimePayrollTransactionDTO
                    if (!string.IsNullOrEmpty(transactionItem.PayrollProductNr) || payrollProductId != 0)
                    {
                        if (transactionItem.Start == CalendarUtility.DATETIME_DEFAULT)
                            continue;

                        TimeBlockDate timeBlockDate = TimeBlockManager.GetTimeBlockDate(actorCompanyId, dto.EmployeeId.Value, transactionItem.Start);

                        entities.Connection.Close();

                        if (timeBlockDate == null)
                        {
                            using (CompEntities innerEntities = new CompEntities())
                            {
                                timeBlockDate = TimeBlockManager.CreateTimeBlockDate(innerEntities, transactionItem.Start, dto.EmployeeId.Value, actorCompanyId);
                            }
                        }

                        payrollProductId = payrollProducts.FirstOrDefault(p => p.Number == transactionItem.PayrollProductNr)?.ProductId ?? 0;
                        if (payrollProductId == 0)
                            continue;

                        TimePayrollTransactionDTO timePayrollTransactionItem = new TimePayrollTransactionDTO();
                        timePayrollTransactionItem.TimeBlockDateId = timeBlockDate.TimeBlockDateId;
                        timePayrollTransactionItem.EmployeeId = dto.EmployeeId.Value;
                        timePayrollTransactionItem.Amount = transactionItem.Amount;
                        timePayrollTransactionItem.VatAmount = transactionItem.Vat;
                        timePayrollTransactionItem.PayrollProductId = payrollProductId;
                        timePayrollTransactionItem.Quantity = transactionItem.Quantity;
                        if (!accountInternals.IsNullOrEmpty())
                        {
                            timePayrollTransactionItem.AccountInternals = new List<AccountInternalDTO>();
                            timePayrollTransactionItem.AccountInternals.AddRange(accountInternals);
                        }

                        dto.TimePayrollTransactionItems.Add(timePayrollTransactionItem);
                    }

                    //ProductNr
                    if (!string.IsNullOrEmpty(transactionItem.ProductNr))
                    {
                        TimeInvoiceTransactionDTO timeInvoiceTransactionItem = new TimeInvoiceTransactionDTO();

                        if (transactionItem.Start == CalendarUtility.DATETIME_DEFAULT)
                            continue;

                        TimeBlockDate timeBlockDate = TimeBlockManager.GetTimeBlockDate(actorCompanyId, dto.EmployeeId.Value, transactionItem.Start);
                        if (timeBlockDate == null)
                            continue;

                        int invoiceProductId = payrollProducts.FirstOrDefault(p => p.Number == transactionItem.PayrollProductNr)?.ProductId ?? 0;
                        if (invoiceProductId == 0)
                            continue;

                        timeInvoiceTransactionItem.AccountId = accountStds.FirstOrDefault(a => a.Account.AccountNr == transactionItem.AccountNr)?.AccountId ?? 0;
                        timeInvoiceTransactionItem.TimeBlockDateId = timeBlockDate.TimeBlockDateId;
                        timeInvoiceTransactionItem.EmployeeId = dto.EmployeeId.Value;
                        timeInvoiceTransactionItem.Amount = transactionItem.Amount;
                        timeInvoiceTransactionItem.VatAmount = transactionItem.Vat;
                        timeInvoiceTransactionItem.InvoiceProductId = invoiceProductId;
                        timeInvoiceTransactionItem.Quantity = transactionItem.Quantity;
                        if (!accountInternals.IsNullOrEmpty())
                        {
                            timeInvoiceTransactionItem.AccountInternals = new List<AccountInternalDTO>();
                            timeInvoiceTransactionItem.AccountInternals.AddRange(accountInternals);
                        }

                        dto.TimeInvoiceTransactionItems.Add(timeInvoiceTransactionItem);
                    }

                    //Create TimeCodeTransaction
                    using (CompEntities innerEntities = new CompEntities())
                    {
                        TimeTransactionManager.CreateTimeCodeTransaction(innerEntities, actorCompanyId, day, week);
                    }

                    dtos.Add(dto);
                }

                #endregion
            }

            timesheetWeeks = ProjectManager.GetAllTimeSheetsForCompany(actorCompanyId);

            foreach (var dto in dtos)
            {
                #region TimeCodeTransaction

                DateTime monday = CalendarUtility.GetFirstDateOfWeek(dto.Start);

                if (timesheetWeeks.Any(t => t.Date == monday && t.EmployeeId == (int)dto.EmployeeId) && (dto.ProjectId == 0 || dto.ProjectId == null) && !dto.IsAddition)
                    continue;

                if (dto.EmployeeId == null)
                    continue;

                int? timeSheetWeekId = timesheetWeeks.FirstOrDefault(t => t.Date == monday && t.EmployeeId == dto.EmployeeId.Value).TimeSheetWeekId;

                using (CompEntities entities = new CompEntities())
                {
                    TimeCodeTransaction timeCodeTransaction = TimeTransactionManager.CreateTimeCodeTransaction(entities, actorCompanyId, dto, timeSheetWeekId);
                    entities.TimeCodeTransaction.AddObject(timeCodeTransaction);
                    entities.SaveChanges();
                }

                #endregion
            }

            return result;
        }

        public List<TimeCodeTransactionIODTO> GetTimeCodeTransactions(int actorCompanyId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds = null, bool includeInActive = false)
        {
            List<TimeCodeTransactionIODTO> timeCodeTransactionIODTOs = new List<TimeCodeTransactionIODTO>();

            bool? active = includeInActive ? null : (bool?)true;

            List<Employee> allPossibleEmployees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, dateFrom: dateFrom.AddMonths(-1), dateTo: dateTo.AddMonths(1), active: active);

            List<Employee> employees = null;
            if (!employeeIds.IsNullOrEmpty())
            {
                employeeIds = employeeIds.Where(w => allPossibleEmployees.Select(s => s.EmployeeId).Contains(w)).ToList();
                employees = EmployeeManager.GetAllEmployeesByIds(actorCompanyId, employeeIds);
            }
            else
            {
                employeeIds = allPossibleEmployees.Select(s => s.EmployeeId).ToList();
                employees = allPossibleEmployees;
            }

            Dictionary<int, Employee> employeeDict = employees.ToDictionary(x => x.EmployeeId, y => y);

            using (var entities = new CompEntities())
            {
                entities.CommandTimeout = 300;

                List<TimeCodeTransaction> timeCodeTransactions = TimeTransactionManager.GetTimeCodeTransactions(entities, actorCompanyId, employeeIds, dateFrom, dateTo);
                List<Project> projects = ProjectManager.GetProjects(entities, actorCompanyId, TermGroup_ProjectType.TimeProject, null, true, false, false, false, -1).ToList();
                List<AccountDTO> accounts = AccountManager.GetAccounts(actorCompanyId).ToDTOs(false, false);
                List<AccountDimDTO> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId).ToDTOs(false, false);
                Invoice invoice = null;

                foreach (var timeCodeTransaction in timeCodeTransactions)
                {
                    if (timeCodeTransaction == null)
                        continue;

                    if (timeCodeTransaction.State != (int)SoeEntityState.Active)
                        continue;

                    var invoiceDay = timeCodeTransaction.ProjectInvoiceDayId.HasValue ? TimeTransactionManager.GetProjectInvoiceDay(entities, (int)timeCodeTransaction.ProjectInvoiceDayId) : null;
                    if (invoiceDay != null && invoiceDay.ProjectInvoiceWeek.RecordId > 0 && invoiceDay.ProjectInvoiceWeek.RecordType == 2)
                    {
                        //try too reuse previous fetched invoice
                        if ((invoice == null) || (invoice.InvoiceId != invoiceDay.ProjectInvoiceWeek.RecordId))
                            invoice = InvoiceManager.GetInvoice(entities, invoiceDay.ProjectInvoiceWeek.RecordId);
                    }
                    else
                    {
                        invoice = null;
                    }

                    Employee employee = null;
                    if (timeCodeTransaction.TimePayrollTransaction.FirstOrDefault() != null)
                        employeeDict.TryGetValue(timeCodeTransaction.TimePayrollTransaction.FirstOrDefault().EmployeeId, out employee);
                    if (employee == null && timeCodeTransaction.TimeInvoiceTransaction.FirstOrDefault() != null && timeCodeTransaction.TimeInvoiceTransaction.FirstOrDefault(f => f.EmployeeId.HasValue) != null)
                        employeeDict.TryGetValue(timeCodeTransaction.TimeInvoiceTransaction.FirstOrDefault(f => f.EmployeeId.HasValue).EmployeeId.Value, out employee);
                    if (employee == null)
                        continue;

                    var supplierInvoice = timeCodeTransaction.SupplierInvoiceId != null ? SupplierInvoiceManager.GetSupplierInvoice(timeCodeTransaction.SupplierInvoiceId.Value, false, false, false, false, false, false, false, false, false, false) : null;
                    var supplier = supplierInvoice != null && supplierInvoice.ActorId.HasValue ? SupplierManager.GetSupplier(supplierInvoice.ActorId.Value, false, false, false, false) : null;
                    var timeCodeTransactionDTO = timeCodeTransaction.ToDTO();

                    var timeCodeTransactionIODTO = new TimeCodeTransactionIODTO();
                    timeCodeTransactionIODTO.TimeInvoiceTransactionIOItems = new List<TimeInvoiceTransactionIODTO>();
                    timeCodeTransactionIODTO.TimePayrollTransactionIOItems = new List<TimePayrollTransactionIODTO>();
                    timeCodeTransactionIODTO.TimeCodeCode = timeCodeTransaction.TimeCode?.Code ?? string.Empty;
                    timeCodeTransactionIODTO.ProductNr = timeCodeTransaction.TimeInvoiceTransaction != null && timeCodeTransaction.TimeInvoiceTransaction.GroupBy(g => g.ProductId).Count() == 1 ? timeCodeTransaction.TimeInvoiceTransaction.FirstOrDefault().InvoiceProduct.Number : "Multiple";
                    timeCodeTransactionIODTO.PayrollProductNr = timeCodeTransaction.TimePayrollTransaction != null && timeCodeTransaction.TimePayrollTransaction.GroupBy(g => g.ProductId).Count() == 1 ? timeCodeTransaction.TimePayrollTransaction.FirstOrDefault().PayrollProduct.Number : "Multiple";
                    timeCodeTransactionIODTO.ProductName = timeCodeTransaction.TimeInvoiceTransaction != null && timeCodeTransaction.TimeInvoiceTransaction.GroupBy(g => g.ProductId).Count() == 1 ? timeCodeTransaction.TimeInvoiceTransaction.FirstOrDefault().InvoiceProduct.Name : "Multiple";
                    timeCodeTransactionIODTO.PayrollProductName = timeCodeTransaction.TimePayrollTransaction != null && timeCodeTransaction.TimePayrollTransaction.GroupBy(g => g.ProductId).Count() == 1 ? timeCodeTransaction.TimePayrollTransaction.FirstOrDefault().PayrollProduct.Name : "Multiple";
                    timeCodeTransactionIODTO.CustomerInvoiceNr = invoice?.InvoiceNr ?? string.Empty;
                    timeCodeTransactionIODTO.ProjectNr = projects.FirstOrDefault(p => p.ProjectId == timeCodeTransaction.ProjectId)?.Number ?? string.Empty;
                    timeCodeTransactionIODTO.EmployeeNr = employee?.EmployeeNr ?? string.Empty;
                    timeCodeTransactionIODTO.SupplierNr = supplier?.SupplierNr ?? string.Empty;
                    timeCodeTransactionIODTO.SupplierInvoiceNr = supplierInvoice?.InvoiceNr ?? string.Empty;
                    timeCodeTransactionIODTO.Amount = timeCodeTransactionDTO.Amount;
                    timeCodeTransactionIODTO.AmountCurrency = timeCodeTransactionDTO.AmountCurrency;
                    timeCodeTransactionIODTO.AmountEntCurrency = timeCodeTransactionDTO.AmountEntCurrency;
                    timeCodeTransactionIODTO.AmountLedgerCurrency = timeCodeTransactionDTO.AmountLedgerCurrency;
                    timeCodeTransactionIODTO.Vat = timeCodeTransactionDTO.Vat;
                    timeCodeTransactionIODTO.VatCurrency = timeCodeTransactionDTO.VatCurrency;
                    timeCodeTransactionIODTO.VatEntCurrency = timeCodeTransactionDTO.VatEntCurrency;
                    timeCodeTransactionIODTO.VatLedgerCurrency = timeCodeTransactionDTO.VatLedgerCurrency;
                    timeCodeTransactionIODTO.Quantity = timeCodeTransactionDTO.Quantity;
                    timeCodeTransactionIODTO.InvoiceQuantity = timeCodeTransactionDTO.InvoiceQuantity;
                    timeCodeTransactionIODTO.Start = timeCodeTransactionDTO.Start;
                    timeCodeTransactionIODTO.Stop = timeCodeTransactionDTO.Stop;
                    timeCodeTransactionIODTO.Comment = timeCodeTransactionDTO.Comment;
                    timeCodeTransactionIODTO.ExternalComment = timeCodeTransaction.ExternalComment;
                    timeCodeTransactionIODTO.AccountNr = string.Empty;
                    timeCodeTransactionIODTO.AccountDim2Nr = string.Empty;
                    timeCodeTransactionIODTO.AccountDim3Nr = string.Empty;
                    timeCodeTransactionIODTO.AccountDim4Nr = string.Empty;
                    timeCodeTransactionIODTO.AccountDim5Nr = string.Empty;
                    timeCodeTransactionIODTO.AccountDim6Nr = string.Empty;
                    timeCodeTransactionIODTO.TimeCodeName = timeCodeTransactionDTO.TimeCodeName;
                    timeCodeTransactionIODTO.TimeCodeTypeName = timeCodeTransactionDTO.TimeCodeTypeName;
                    timeCodeTransactionIODTO.QuantityText = timeCodeTransactionDTO.QuantityText;
                    timeCodeTransactionIODTO.PayrollAttestStateName = timeCodeTransactionDTO.AttestStateName;
                    timeCodeTransactionIODTO.IsRegistrationTypeQuantity = timeCodeTransactionDTO.IsRegistrationTypeQuantity;
                    timeCodeTransactionIODTO.IsRegistrationTypeTime = timeCodeTransactionDTO.IsRegistrationTypeTime;
                    timeCodeTransactionIODTO.IsReadOnly = timeCodeTransactionDTO.IsReadOnly;
                    timeCodeTransactionIODTO.IsAddition = timeCodeTransactionDTO.IsAddition;
                    timeCodeTransactionIODTO.TimeCodeTransactionId = timeCodeTransactionDTO.TimeCodeTransactionId;

                    foreach (var timeInvoiceTransaction in timeCodeTransaction.TimeInvoiceTransaction)
                    {
                        if (timeInvoiceTransaction.State != (int)SoeEntityState.Active)
                            continue;

                        var dto = timeInvoiceTransaction.ToDTO();
                        var date = timeInvoiceTransaction.TimeBlockDate != null ? timeInvoiceTransaction.TimeBlockDate.Date : timeCodeTransaction.CustomerInvoice != null && timeCodeTransaction.CustomerInvoice.InvoiceDate.HasValue ? timeCodeTransaction.CustomerInvoice.InvoiceDate.Value : CalendarUtility.DATETIME_DEFAULT;

                        List<AccountInternalDTO> accountInternals = timeInvoiceTransaction.AccountInternal.ToDTOs();
                        AccountAndInternalAccountComboDTO accountAndInternalAccountComboDTO = accountInternals.GetInternalAccountDimNrs(accountDims, accounts);

                        var timeInvoiceTransactionIODTO = new TimeInvoiceTransactionIODTO
                        {
                            EmployeeNr = employee != null ? employee.EmployeeNr : string.Empty,
                            Date = date,
                            ProductNr = timeInvoiceTransaction.InvoiceProduct?.Number,
                            AttestStateName = dto.AttestState?.Name,
                            Amount = timeInvoiceTransaction.Amount ?? 0,
                            AmountCurrency = timeInvoiceTransaction.AmountCurrency ?? 0,
                            AmountEntCurrency = timeInvoiceTransaction.AmountEntCurrency ?? 0,
                            AmountLedgerCurrency = timeInvoiceTransaction.AmountLedgerCurrency ?? 0,
                            VatAmount = timeInvoiceTransaction.VatAmount ?? 0,
                            VatAmountCurrency = timeInvoiceTransaction.VatAmountCurrency ?? 0,
                            VatAmountEntCurrency = timeInvoiceTransaction.VatAmountEntCurrency ?? 0,
                            VatAmountLedgerCurrency = timeInvoiceTransaction.VatAmountLedgerCurrency ?? 0,
                            Quantity = timeInvoiceTransaction.Quantity,
                            InvoiceQuantity = timeInvoiceTransaction.InvoiceQuantity,
                            Invoice = timeInvoiceTransaction.Invoice,
                            ManuallyAdded = timeInvoiceTransaction.ManuallyAdded,
                            Exported = timeInvoiceTransaction.Exported,
                            AccountDim2Nr = accountAndInternalAccountComboDTO.Dim2Nr,
                            AccountDim3Nr = accountAndInternalAccountComboDTO.Dim3Nr,
                            AccountDim4Nr = accountAndInternalAccountComboDTO.Dim4Nr,
                            AccountDim5Nr = accountAndInternalAccountComboDTO.Dim5Nr,
                            AccountDim6Nr = accountAndInternalAccountComboDTO.Dim6Nr,
                            AccountNr = accounts.FirstOrDefault(a => a.AccountId == timeInvoiceTransaction.AccountStdId)?.AccountNr ?? string.Empty,
                            TimeInvoiceTransactionId = timeInvoiceTransaction.TimeInvoiceTransactionId
                        };

                        timeCodeTransactionIODTO.TimeInvoiceTransactionIOItems.Add(timeInvoiceTransactionIODTO);
                    }

                    foreach (var timePayrollTransaction in timeCodeTransaction.TimePayrollTransaction)
                    {

                        if (timePayrollTransaction.State != (int)SoeEntityState.Active)
                            continue;

                        List<AccountInternalDTO> accountInternals = timePayrollTransaction.AccountInternal.ToDTOs();
                        AccountAndInternalAccountComboDTO accountAndInternalAccountComboDTO = accountInternals.GetInternalAccountDimNrs(accountDims, accounts);

                        var timePayrollTransactionIODTO = new TimePayrollTransactionIODTO
                        {
                            EmployeeNr = employee != null ? employee.EmployeeNr : string.Empty,
                            Date = timePayrollTransaction.TimeBlockDate != null ? timePayrollTransaction.TimeBlockDate.Date : CalendarUtility.DATETIME_DEFAULT,
                            PayrollProductNr = timePayrollTransaction.PayrollProduct.Number,
                            AttestStateName = timePayrollTransaction.AttestState.Name,
                            Amount = timePayrollTransaction.Amount ?? 0,
                            AmountCurrency = timePayrollTransaction.AmountCurrency ?? 0,
                            AmountEntCurrency = timePayrollTransaction.AmountEntCurrency ?? 0,
                            AmountLedgerCurrency = timePayrollTransaction.AmountLedgerCurrency ?? 0,
                            VatAmount = timePayrollTransaction.VatAmount ?? 0,
                            VatAmountCurrency = timePayrollTransaction.VatAmountCurrency ?? 0,
                            VatAmountEntCurrency = timePayrollTransaction.VatAmountEntCurrency ?? 0,
                            VatAmountLedgerCurrency = timePayrollTransaction.VatAmountLedgerCurrency ?? 0,
                            Quantity = timePayrollTransaction.Quantity,
                            ManuallyAdded = timePayrollTransaction.ManuallyAdded,
                            Exported = timePayrollTransaction.Exported,
                            AccountDim2Nr = accountAndInternalAccountComboDTO.Dim2Nr,
                            AccountDim3Nr = accountAndInternalAccountComboDTO.Dim3Nr,
                            AccountDim4Nr = accountAndInternalAccountComboDTO.Dim4Nr,
                            AccountDim5Nr = accountAndInternalAccountComboDTO.Dim5Nr,
                            AccountDim6Nr = accountAndInternalAccountComboDTO.Dim6Nr,
                            AccountNr = accounts.FirstOrDefault(a => a.AccountId == timePayrollTransaction.AccountStdId)?.AccountNr ?? string.Empty,
                            TimePayrollTransactionId = timePayrollTransaction.TimePayrollTransactionId
                        };

                        timeCodeTransactionIODTO.TimePayrollTransactionIOItems.Add(timePayrollTransactionIODTO);
                    }

                    timeCodeTransactionIODTOs.Add(timeCodeTransactionIODTO);

                    List<TimePayrollTransactionIODTO> timePayrollTransactionIODTOs = new List<TimePayrollTransactionIODTO>();

                    foreach (var dto in timeCodeTransactionIODTOs)
                        timePayrollTransactionIODTOs.AddRange(dto.TimePayrollTransactionIOItems);
                }
            }

            return timeCodeTransactionIODTOs;
        }

        #endregion

        #region TextBlockIO

        public ActionResult ImportTextBlockIO(TextBlockIOItem textBlockIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromTextBlockIO(textBlockIOItem.textBlockIOs, actorCompanyId);
        }

        public ActionResult ImportFromTextBlockIO(List<TextBlockIODTO> textBlockIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            int nbrOfSaved = 0;

            foreach (var textBlock in textBlockIOs)
            {
                TextblockDTO dto = new TextblockDTO();
                int entity = textBlock.Entity != 0 ? textBlock.Entity : (int)SoeEntityType.None;

                dto.ActorCompanyId = actorCompanyId;
                dto.Text = textBlock.Text;

                ActionResult saveResult = GeneralManager.SaveTextblock(dto, entity);

                if (saveResult.Success)
                    nbrOfSaved++;
            }

            result.IntegerValue = nbrOfSaved;

            return result;
        }

        #endregion

        #region SideDictionaryIO

        public ActionResult ImportSideDictionaryIO(SideDictionaryIOItem sideDictionaryIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromSideDictionaryIO(sideDictionaryIOItem.SideDictionaryIOs, actorCompanyId);
        }

        public ActionResult ImportFromSideDictionaryIO(List<SideDictionaryIODTO> sideDictionaryIOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            List<VatCode> currentVatCodes = AccountManager.GetVatCodes(actorCompanyId);
            List<PaymentCondition> currentPaymentConditions = PaymentManager.GetPaymentConditions(actorCompanyId);
            List<DeliveryCondition> currentDeliveryConditions = InvoiceManager.GetDeliveryConditions(actorCompanyId);
            List<PriceListType> currentPriceListTypes = ProductPricelistManager.GetPriceListTypes(actorCompanyId);
            List<DeliveryType> currentDeliveryTypes = InvoiceManager.GetDeliveryTypes(actorCompanyId);
            List<Currency> currentCurrencies = CountryCurrencyManager.GetCurrencies(actorCompanyId);
            List<ProductGroup> currentProductGroups = ProductGroupManager.GetProductGroups(actorCompanyId);
            List<Stock> currentStocks = StockManager.GetStocks(actorCompanyId);
            List<ProductUnit> currentProductUnits = ProductManager.GetProductUnits(actorCompanyId);
            List<PayrollProduct> currentPayrollProducts = ProductManager.GetPayrollProducts(actorCompanyId, active: true, loadAccounts: false);
            List<InvoiceProduct> invoiceProducts = ProductManager.GetInvoiceProducts(actorCompanyId, true, false, false);
            List<TimeCode> currentTimeCodes = TimeCodeManager.GetTimeCodes(actorCompanyId);
            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);
            Dictionary<int, string> currentEndReasons = EmployeeManager.GetSystemEndReasons(actorCompanyId, includeCompanyEndReasons: true, active: true);
            List<CategoryGroup> currentCategoryGroups = CategoryManager.GetCategoryGroups(actorCompanyId, SoeCategoryType.AttestRole, loadAll: true);
            int nbrOfSaved = 0;

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                Company company = CompanyManager.GetCompany(entities, actorCompanyId, false, false);
                Currency baseCurrency = new Currency();
                CompCurrency compCurrency = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId);
                if (baseCurrency != null)
                    baseCurrency = CountryCurrencyManager.GetCurrency(entities, compCurrency.CurrencyId);
                List<VatCode> vatCodes = new List<VatCode>();
                List<PaymentCondition> paymentConditions = new List<PaymentCondition>();
                List<DeliveryCondition> deliveryConditions = new List<DeliveryCondition>();
                List<DeliveryType> deliveryTypes = new List<DeliveryType>();
                List<PriceListType> priceListTypes = new List<PriceListType>();
                List<Currency> currencies = new List<Currency>();
                List<Category> categories = new List<Category>();
                List<ProductGroup> productGroups = new List<ProductGroup>();
                List<Stock> Stocks = new List<Stock>();
                List<PayrollProduct> payrollProducts = new List<PayrollProduct>();
                List<TimeCode> timecodes = new List<TimeCode>();
                List<EndReason> endReasons = new List<EndReason>();
                List<ProductUnit> productUnits = new List<ProductUnit>();
                List<CategoryGroup> categoryGroups = new List<CategoryGroup>();


                #endregion

                foreach (var row in sideDictionaryIOs)
                {
                    #region VatCode

                    if (row.Type == (int)IOImportSideDictionaryType.VatCodes)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentVatCodes.Any(c => c.Code == row.Code) && !currentVatCodes.Any(c => c.Code == alternativeCode))
                        {
                            AccountStd Account1Nr = AccountManager.GetAccountStdByNr(entities, row.Account1Nr, actorCompanyId);
                            AccountStd Account2Nr = AccountManager.GetAccountStdByNr(entities, row.Account2Nr, actorCompanyId);

                            entities.AccountStd.NoTracking();

                            int? account1Id = Account1Nr?.Account.AccountId;
                            int? account2Id = Account2Nr?.Account.AccountId;

                            VatCode code = new VatCode();
                            code.Code = row.Code;
                            code.Name = row.Name;
                            code.State = (int)SoeEntityState.Active;
                            code.ActorCompanyId = actorCompanyId;
                            code.Percent = row.Percent;
                            code.AccountId = account1Id ?? 0;
                            code.PurchaseVATAccountId = account2Id;
                            vatCodes.Add(code);

                            entities.VatCode.AddObject(code);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region PaymentCondition

                    if (row.Type == (int)IOImportSideDictionaryType.PaymentConditions)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentPaymentConditions.Any(c => c.Code == row.Code) && !currentPaymentConditions.Any(c => c.Code == alternativeCode) && !currentPaymentConditions.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            PaymentCondition condition = new PaymentCondition();
                            condition.Code = row.Code;
                            condition.Name = row.Name;
                            condition.Company = company;
                            condition.Days = Convert.ToInt32(row.Quantity);
                            condition.DiscountDays = Convert.ToInt32(row.Quantity2);
                            condition.DiscountPercent = row.Percent;
                            SetCreatedProperties(condition, null);
                            paymentConditions.Add(condition);

                            entities.PaymentCondition.AddObject(condition);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region DeliveryCondition

                    if (row.Type == (int)IOImportSideDictionaryType.DeliveryConditions)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentDeliveryConditions.Any(c => c.Code == row.Code) && !currentDeliveryConditions.Any(c => c.Code == alternativeCode) && !currentDeliveryConditions.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            DeliveryCondition deliveryCondition = new DeliveryCondition();
                            deliveryCondition.Code = row.Code;
                            deliveryCondition.Name = row.Name;
                            deliveryCondition.Company = company;
                            SetCreatedProperties(deliveryCondition, null);

                            deliveryConditions.Add(deliveryCondition);
                            entities.DeliveryCondition.AddObject(deliveryCondition);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region DeliveryType

                    if (row.Type == (int)IOImportSideDictionaryType.DeliveryTypes)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentDeliveryTypes.Any(c => c.Code == row.Code) && !currentDeliveryTypes.Any(c => c.Code == alternativeCode) && !currentDeliveryTypes.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            DeliveryType deliveryType = new DeliveryType();
                            deliveryType.Code = row.Code;
                            deliveryType.Name = row.Name;
                            deliveryType.Company = company;
                            SetCreatedProperties(deliveryType, null);

                            deliveryTypes.Add(deliveryType);
                            entities.DeliveryType.AddObject(deliveryType);
                            nbrOfSaved++;

                            continue;
                        }
                    }

                    #endregion

                    #region Currency

                    if (row.Type == (int)IOImportSideDictionaryType.Currency)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (currentCurrencies.IsNullOrEmpty() || (!currentCurrencies.Any(c => c.Code == row.Code) && !currentCurrencies.Any(c => c.Code == alternativeCode)))
                        {
                            int? sysCurrencyId = null;
                            if (sysCurrencies.Any(c => c.Code == row.Code) || sysCurrencies.Any(c => c.Code == alternativeCode) || sysCurrencies.Any(c => c.Code.TrimStart('0') == row.Code))
                                sysCurrencyId = sysCurrencies.FirstOrDefault(c => c.Code == row.Code)?.SysCurrencyId;
                            if (sysCurrencyId == null)
                                continue;

                            Currency currency = new Currency();
                            currency.Code = row.Code;
                            currency.Name = row.Name;
                            currency.ActorCompanyId = actorCompanyId;
                            currency.SysCurrencyId = (int)sysCurrencyId;
                            SetCreatedProperties(currency, null);
                            currencies.Add(currency);
                            entities.Currency.AddObject(currency);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region PricelistTypes

                    if (row.Type == (int)IOImportSideDictionaryType.PricelistTypes)
                    {
                        if (!currentPriceListTypes.Any(c => c.Name == row.Name))
                        {
                            entities.Currency.NoTracking();

                            PriceListType pricelistType = new PriceListType();
                            pricelistType.Name = row.Name;
                            pricelistType.InclusiveVat = row.VatIncluded;
                            pricelistType.Description = row.Description;
                            pricelistType.State = (int)SoeEntityState.Active;
                            pricelistType.Company = company;
                            pricelistType.Currency = baseCurrency;
                            SetCreatedProperties(pricelistType, null);

                            priceListTypes.Add(pricelistType);
                            entities.PriceListType.AddObject(pricelistType);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region ProductGroups

                    if (row.Type == (int)IOImportSideDictionaryType.ProductGroup)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentProductGroups.Any(c => c.Code == row.Code) && !currentProductGroups.Any(c => c.Code == alternativeCode) && !currentProductGroups.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            ProductGroup productGroup = new ProductGroup();
                            productGroup.Code = row.Code;
                            productGroup.Name = row.Name;
                            productGroup.Company = company;
                            SetCreatedProperties(productGroup, null);

                            productGroups.Add(productGroup);
                            entities.ProductGroup.AddObject(productGroup);
                            nbrOfSaved++;
                        }
                    }

                    #endregion

                    #region Stockplaces

                    if (row.Type == (int)IOImportSideDictionaryType.Stocks)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentStocks.Any(c => c.Code == row.Code) && !currentStocks.Any(c => c.Code == alternativeCode) && !currentStocks.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            Stock stock = new Stock();
                            stock.Code = row.Code;
                            stock.Name = row.Name;
                            stock.State = (int)SoeEntityState.Active;
                            stock.Company = company;

                            SetCreatedProperties(stock, null);
                            Stocks.Add(stock);
                            entities.Stock.AddObject(stock);

                            nbrOfSaved++;
                        }
                    }

                    #endregion

                    #region PayrollProducts

                    if (row.Type == (int)IOImportSideDictionaryType.PayrollProduct)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentPayrollProducts.Any(c => c.Number == row.Code) && !currentPayrollProducts.Any(c => c.Number == alternativeCode) && !currentPayrollProducts.Any(c => c.Number.TrimStart('0') == row.Code))
                        {
                            PayrollProduct product = new PayrollProduct();
                            product.Number = row.Code;
                            product.Name = row.Name;
                            product.ShortName = row.Name.Truncate(5);
                            product.AccountingPrio = "1=0,2=0,3=0,4=0,5=0,6=0";
                            product.Description = row.Description;
                            product.Company.Add(company);
                            product.Type = (int)SoeProductType.PayrollProduct;
                            product.State = (int)SoeEntityState.Active;
                            SetCreatedProperties(product, null);

                            payrollProducts.Add(product);
                            entities.Product.AddObject(product);
                            nbrOfSaved++;
                        }
                    }

                    #endregion

                    #region TimeCodes

                    if (row.Type == (int)IOImportSideDictionaryType.TimeCode)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentTimeCodes.Any(c => c.Code == row.Code) && !currentTimeCodes.Any(c => c.Code == alternativeCode) && !currentTimeCodes.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            TimeCodeInvoiceProduct tcip = new TimeCodeInvoiceProduct();
                            TimeCodePayrollProduct tcpp = new TimeCodePayrollProduct();

                            //AccountNr1 = InvoiceProduct
                            if (invoiceProducts.Any(c => c.Number.ToLower() == row.Account1Nr.ToLower()))
                            {
                                tcip.Factor = 1;
                                tcip.ProductId = invoiceProducts.FirstOrDefault(c => c.Number.ToLower() == row.Account1Nr.ToLower()).ProductId;
                            }

                            //AccountNr2 = PayrollProduct
                            if (payrollProducts.Any(c => c.Number.ToLower() == row.Account1Nr.ToLower()))
                            {
                                tcpp.Factor = 1;
                                tcpp.ProductId = payrollProducts.FirstOrDefault(c => c.Number.ToLower() == row.Account1Nr.ToLower()).ProductId;
                            }

                            int type = row.DictionaryType != 0 ? row.DictionaryType : (int)SoeTimeCodeType.Work;

                            if (type == (int)SoeTimeCodeType.Work)
                            {
                                TimeCodeWork timeCodeWork = new TimeCodeWork
                                {
                                    Name = row.Name,
                                    Description = String.Format(row.Description),
                                    Type = (int)SoeTimeCodeType.Work,
                                    Code = StringUtility.Left(row.Code, 20),
                                    RoundingType = (int)TermGroup_TimeCodeRoundingType.None,
                                    RoundingValue = 0,
                                    IsWorkOutsideSchedule = false,

                                    //Set references
                                    Company = company,
                                };

                                if (tcip.ProductId != 0)
                                    timeCodeWork.TimeCodeInvoiceProduct.Add(tcip);

                                if (tcpp.ProductId != 0)
                                    timeCodeWork.TimeCodePayrollProduct.Add(tcpp);

                                SetCreatedProperties(timeCodeWork, null);
                                timecodes.Add(timeCodeWork);

                                entities.TimeCode.AddObject(timeCodeWork);
                            }
                            else
                            {
                                TimeCode timeCode = new TimeCode();
                                timeCode.Code = row.Code;
                                timeCode.Name = row.Name;
                                timeCode.Description = row.Description;
                                timeCode.Company = company;
                                timeCode.State = (int)SoeEntityState.Active;
                                timeCode.Type = type;

                                if (tcip.ProductId != 0)
                                    timeCode.TimeCodeInvoiceProduct.Add(tcip);

                                if (tcpp.ProductId != 0)
                                    timeCode.TimeCodePayrollProduct.Add(tcpp);

                                SetCreatedProperties(timeCode, null);
                                timecodes.Add(timeCode);

                                entities.TimeCode.AddObject(timeCode);
                                nbrOfSaved++;
                            }
                        }
                    }

                    #endregion

                    #region PaymentMethod

                    if (row.Type == (int)IOImportSideDictionaryType.PaymentMethod)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentTimeCodes.Any(c => c.Code == row.Code) && !currentTimeCodes.Any(c => c.Code == alternativeCode) && !currentTimeCodes.Any(c => c.Code.TrimStart('0') == row.Code))
                        {
                            PaymentMethod method = new PaymentMethod();
                            int sysPaymentType = 0;

                            List<PaymentInformationRow> infoRows = PaymentManager.GetPaymentInformationRowsForActor(entities, actorCompanyId);

                            PaymentInformationRow infoRow = new PaymentInformationRow();

                            AccountStd account1Nr = AccountManager.GetAccountStdByNr(entities, row.Account1Nr, actorCompanyId);

                            //CustomerNr
                            if (row.DictionaryType == 0)
                            {
                                if (row.Name.ToLower().Contains("pg") || row.Name.ToLower().Contains("post") || row.Name.ToLower().Contains("plus"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.PG;
                                else if (row.Name.ToLower().Contains("bg") || row.Name.ToLower().Contains("giro") || row.Name.ToLower().Contains("bankg"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.BG;
                                else if (row.Name.ToLower().Contains("bank") || row.Name.ToLower().Contains("konto"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.Bank;
                                else if (row.Name.ToLower().Contains("cfp"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.Cfp;
                                else if (row.Name.ToLower().Contains("auto"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.Autogiro;
                                else if (row.Name.ToLower().Contains("bic"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.BIC;
                                else if (row.Name.ToLower().Contains("net"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.Nets;
                                else if (row.Name.ToLower().Contains("sep"))
                                    sysPaymentType = (int)TermGroup_SysPaymentType.SEPA;
                                //else if (row.Name.ToLower().Contains("SOP"))
                                //    sysPaymentType = (int)TermGroup_SysPaymentType.SOP;
                                else
                                    sysPaymentType = (int)TermGroup_SysPaymentType.Unknown;
                            }

                            foreach (var row2 in infoRows)
                            {
                                if (row2.SysPaymentTypeId == sysPaymentType || (string.IsNullOrEmpty(row.Description) && row.Account2Nr == row2.PaymentNr))
                                    infoRow = row2;
                                else
                                {
                                    infoRow.PaymentNr = row.Account2Nr;
                                    infoRow.Default = false;
                                    infoRow.SysPaymentTypeId = sysPaymentType;
                                    SetCreatedProperties(infoRow, null);

                                    Actor actor = ActorManager.GetActor(entities, actorCompanyId, false);

                                    PaymentInformation info = PaymentManager.GetPaymentInformationFromActor(actor.ActorId, false, false);

                                    if (actor == null)
                                    {
                                        info.DefaultSysPaymentTypeId = sysPaymentType;
                                        info.Actor = actor;
                                        info.State = (int)SoeEntityState.Active;
                                        SetCreatedProperties(info, null);

                                        entities.PaymentInformation.AddObject(info);
                                    }

                                    infoRow.PaymentInformation = info;
                                    entities.PaymentInformationRow.AddObject(infoRow);
                                }

                            }

                            int soeOriginType = row.DictionaryType != 0 ? row.DictionaryType : (int)SoeOriginType.SupplierPayment;

                            method.Name = row.Name;
                            method.Company = company;
                            method.State = (int)SoeEntityState.Active;
                            method.CustomerNr = row.Description;
                            method.PaymentType = soeOriginType;
                            method.AccountStd = account1Nr;
                            method.PaymentInformationRow = infoRow;

                            SetCreatedProperties(method, null);

                            entities.PaymentMethod.AddObject(method);
                            nbrOfSaved++;
                        }
                    }

                    #endregion

                    #region Categories

                    if (row.Type == (int)IOImportSideDictionaryType.Categories)
                    {
                        string alternativeCode = row.Code.TrimStart('0');
                        int? parentId = null;

                        if (row.Type < 1 || row.DictionaryType > (int)SoeCategoryType.PayrollProduct)
                            continue;

                        List<Category> currentCategories = CategoryManager.GetCategories(entities, (SoeCategoryType)row.DictionaryType, actorCompanyId);

                        if (!currentCategories.Any(c => c.Code == row.Code) && !currentCategories.Any(c => c.Code == alternativeCode) && row.DictionaryType != 0 && !currentCategories.Any(c => c.Code.TrimStart('0') == row.Code) && row.GroupName != string.Empty)
                        {
                            if (!currentCategories.Any(c => c.Name == row.GroupName))
                                parentId = currentCategories.FirstOrDefault(c => c.Name == row.GroupName).CategoryId;

                            Category category = new Category();
                            category.Code = row.Code;
                            category.Name = row.Name;
                            category.Type = row.DictionaryType;
                            category.ActorCompanyId = actorCompanyId;
                            category.State = (int)SoeEntityState.Active;
                            category.ParentId = parentId;
                            SetCreatedProperties(category, null);
                            categories.Add(category);

                            entities.Category.AddObject(category);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region Endreason

                    if (row.Type == (int)IOImportSideDictionaryType.Endreason)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentEndReasons.Any(c => c.Value.ToLower() == row.Name.ToLower()) && !currentEndReasons.Any(c => c.Value.ToLower() == alternativeCode.ToLower()) && !currentEndReasons.Any(c => c.Value.TrimStart('0').ToLower() == row.Code.ToLower()))
                        {
                            EndReason endReason = new EndReason();
                            endReason.Name = row.Name;
                            endReason.State = (int)SoeEntityState.Active;
                            endReason.Company = company;
                            SetCreatedProperties(endReason, null);

                            endReasons.Add(endReason);
                            entities.EndReason.AddObject(endReason);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion

                    #region ProductUnit

                    if (row.Type == (int)IOImportSideDictionaryType.ProductUnit)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentProductUnits.Any(c => c.Code.ToLower() == row.Code.ToLower()) && !currentProductUnits.Any(c => c.Code.ToLower() == alternativeCode.ToLower()) && !currentProductUnits.Any(c => c.Code.TrimStart('0').ToLower() == row.Code.ToLower()))
                        {
                            ProductUnit productUnit = new ProductUnit();
                            productUnit.Code = row.Code;
                            productUnit.Name = row.Name;
                            productUnit.Company = company;
                            SetCreatedProperties(productUnit, null);

                            productUnits.Add(productUnit);
                            entities.ProductUnit.AddObject(productUnit);
                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion


                    #region CategoryGroups

                    if (row.Type == (int)IOImportSideDictionaryType.CategoryGroups)
                    {
                        string alternativeCode = row.Code.TrimStart('0');

                        if (!currentCategoryGroups.Any(c => c.Name == row.Name) && !currentCategoryGroups.Any(c => c.Name == alternativeCode) && !currentCategoryGroups.Any(c => c.Name.TrimStart('0') == row.Code))
                        {
                            CategoryGroup categoryGroup = new CategoryGroup();
                            categoryGroup.Code = row.Code;
                            categoryGroup.Type = row.DictionaryType;
                            categoryGroup.Name = row.Name;
                            categoryGroup.State = (int)SoeEntityState.Active;
                            categoryGroup.Company = company;

                            SetCreatedProperties(categoryGroup, null);
                            categoryGroups.Add(categoryGroup);
                            entities.CategoryGroup.AddObject(categoryGroup);

                            nbrOfSaved++;
                        }

                        continue;
                    }

                    #endregion
                }

                #region Save

                result.IntegerValue = nbrOfSaved;
                result = SaveChanges(entities);

                #endregion
            }

            return result;
        }


        public List<SideDictionaryIODTO> GetSideDictionaryIODTOs(int actorCompanyId, List<IOImportSideDictionaryType> sideDictionayTypes)
        {
            var sideDictionaryIODTOs = new List<SideDictionaryIODTO>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            foreach (var sideDictionayType in sideDictionayTypes)
            {
                switch (sideDictionayType)
                {
                    case IOImportSideDictionaryType.VatCodes:
                        List<VatCode> currentVatCodes = AccountManager.GetVatCodes(actorCompanyId);
                        foreach (var vatcode in currentVatCodes)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(vatcode.VatCodeId, 0, (int)IOImportSideDictionaryType.VatCodes, vatcode.Code, vatcode.Name, "", vatcode.Account != null ? vatcode.Account.AccountNr : "", vatcode.PurchaseVATAccount != null ? vatcode.PurchaseVATAccount.AccountNr : "", "", vatcode.Percent, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.PaymentConditions:
                        List<PaymentCondition> currentPaymentConditions = PaymentManager.GetPaymentConditions(actorCompanyId);
                        foreach (var pc in currentPaymentConditions)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(pc.PaymentConditionId, 0, (int)IOImportSideDictionaryType.PaymentConditions, pc.Code, pc.Name, "", "", "", "", 0, false, pc.Days, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.DeliveryConditions:
                        List<DeliveryCondition> currentDeliveryConditions = InvoiceManager.GetDeliveryConditions(actorCompanyId);
                        foreach (var dc in currentDeliveryConditions)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(dc.DeliveryConditionId, 0, (int)IOImportSideDictionaryType.DeliveryConditions, dc.Code, dc.Name, "", "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.PricelistTypes:
                        List<PriceListType> currentPriceListTypes = ProductPricelistManager.GetPriceListTypes(actorCompanyId);
                        foreach (var plt in currentPriceListTypes)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(plt.PriceListTypeId, 0, (int)IOImportSideDictionaryType.PricelistTypes, plt.Name, plt.Name, plt.Description, "", "", "", 0, false, 0, 0, plt.DiscountPercent, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.DeliveryTypes:
                        List<DeliveryType> currentDeliveryTypes = InvoiceManager.GetDeliveryTypes(actorCompanyId);
                        foreach (var dt in currentDeliveryTypes)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(dt.DeliveryTypeId, 0, (int)IOImportSideDictionaryType.DeliveryTypes, dt.Code, dt.Name, "", "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.Currency:
                        List<Currency> currentCurrencies = CountryCurrencyManager.GetCurrenciesWithSysCurrency(actorCompanyId);
                        foreach (var curr in currentCurrencies)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(curr.CurrencyId, curr.SysCurrencyId, (int)IOImportSideDictionaryType.Currency, curr.Code, curr.Name, "", "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.Stocks:
                        List<Stock> currentStocks = StockManager.GetStocks(actorCompanyId);
                        foreach (var st in currentStocks)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(st.StockId, 0, (int)IOImportSideDictionaryType.ProductGroup, st.Code, st.Name, "", "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.PayrollProduct:
                        List<PayrollProduct> currentPayrollProducts = ProductManager.GetPayrollProducts(actorCompanyId, active: true, loadAccounts: false);
                        foreach (var st in currentPayrollProducts)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(st.ProductId, st.ProductGroupId ?? 0, (int)IOImportSideDictionaryType.PayrollProduct, st.Number, st.Name, st.Description, "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.TimeCode:
                        List<TimeCode> currentTimeCodes = TimeCodeManager.GetTimeCodes(actorCompanyId);
                        foreach (var tc in currentTimeCodes)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(tc.TimeCodeId, 0, (int)IOImportSideDictionaryType.TimeCode, tc.Code, tc.Name, tc.Description, "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.Endreason:
                        Dictionary<int, string> currentEndReasons = EmployeeManager.GetSystemEndReasons(actorCompanyId, includeCompanyEndReasons: true, active: true);
                        foreach (var tc in currentEndReasons)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(tc.Key, 0, (int)IOImportSideDictionaryType.Endreason, tc.Key.ToString(), tc.Value, "", "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.ProductGroup:
                        List<ProductGroup> currentProductGroups = ProductGroupManager.GetProductGroups(actorCompanyId);
                        foreach (var tg in currentProductGroups)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(tg.ProductGroupId, 0, (int)IOImportSideDictionaryType.ProductGroup, tg.Code, tg.Name, "", "", "", "", 0, false, 0, 0, 0, 0);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                    case IOImportSideDictionaryType.Categories:
                        List<Category> categories = entitiesReadOnly.Category.Where(c => c.ActorCompanyId == actorCompanyId && c.State == (int)SoeEntityState.Active).ToList();
                        foreach (var tg in categories)
                        {
                            SideDictionaryIODTO SideDictionaryIODTO = CreateSideDictionaryIODTO(tg.CategoryId, tg.CategoryGroupId ?? 0, (int)IOImportSideDictionaryType.Categories, tg.Code, tg.Name, "", "", "", "", 0, false, 0, 0, 0, tg.Type);
                            sideDictionaryIODTOs.Add(SideDictionaryIODTO);
                        }
                        break;
                }
            }

            return sideDictionaryIODTOs;
        }

        public SideDictionaryIODTO CreateSideDictionaryIODTO(int Id, int parentId, int type, string code, string name, string description, string Account1Nr, string Account2Nr, string groupName, decimal percent, bool vatIncluded, decimal quantity, decimal quantity2, decimal discount, int dictionaryType)
        {
            return new SideDictionaryIODTO()
            {
                Id = Id,
                ParentId = parentId,
                Type = type,
                Code = code,
                Name = name,
                Description = description,
                Account1Nr = Account1Nr,
                Account2Nr = Account2Nr,
                GroupName = groupName,
                Percent = percent,
                VatIncluded = vatIncluded,
                Quantity = quantity,
                Quantity2 = quantity2,
                Discount = discount,
                DictionaryType = dictionaryType
            };
        }

        #endregion

        #region UserCompanySettingIO

        public ActionResult ImportUserCompanySettingIO(UserCompanySettingIOItem userCompanySettingIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId)
        {
            return ImportFromUserCompanySettingIO(userCompanySettingIOItem.userCompanySettingIOs, actorCompanyId);
        }

        public ActionResult ImportFromUserCompanySettingIO(List<UserCompanySettingIODTO> userCompanySettingIODTOs, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {

                foreach (var setting in userCompanySettingIODTOs)
                {
                    UserCompanySetting userCompanySetting = new UserCompanySetting();

                    int dataTypeId = setting.DataTypeId != 0 ? setting.DataTypeId : 0;

                    User user = null;
                    int? userId = setting.UserId;
                    if (user == null && !setting.UserId.HasValue)
                        user = UserManager.GetUsersBySearch(actorCompanyId, setting.UserName)?.FirstOrDefault();
                    if (user == null && !setting.UserId.HasValue)
                        user = UserManager.GetUsersBySearch(actorCompanyId, setting.EmployeeNr)?.FirstOrDefault();
                    if (user != null && !userId.HasValue)
                        userId = user.UserId;

                    if (dataTypeId == 0)
                    {
                        if (setting.BoolData != null)
                            dataTypeId = (int)SettingDataType.Boolean;
                        else if (setting.IntData != null)
                            dataTypeId = (int)SettingDataType.Integer;
                        else if (setting.DecimalData != null)
                            dataTypeId = (int)SettingDataType.Decimal;
                        else if (setting.StringData != null)
                            dataTypeId = (int)SettingDataType.String;
                        else if (setting.DateData != null)
                            dataTypeId = (int)SettingDataType.Date;
                    }

                    userCompanySetting.ActorCompanyId = userId.HasValue ? null : (int?)actorCompanyId;
                    userCompanySetting.UserId = userId;
                    userCompanySetting.BoolData = setting.BoolData;
                    userCompanySetting.IntData = setting.IntData;
                    userCompanySetting.DecimalData = setting.DecimalData;
                    userCompanySetting.DateData = setting.DateData;
                    userCompanySetting.StrData = setting.StringData;
                    userCompanySetting.SettingTypeId = setting.SettingTypeId;
                    userCompanySetting.DataTypeId = dataTypeId;
                    userCompanySetting.BoolData = setting.BoolData;

                    //Check if exist
                    if (!SettingManager.GetAllCompanySettings(setting.SettingTypeId).Any())
                    {
                        entities.UserCompanySetting.AddObject(userCompanySetting);

                        entities.SaveChanges();
                    }
                }
            }

            return result;
        }

        #endregion

        #region VoucherIO

        #region VoucherHead

        #region Import to VoucherIO

        public ActionResult ImportVoucherIO(VoucherHeadIOItem voucherIOItem, TermGroup_IOImportHeadType headType, int importId, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool importToVoucher, int accountYearId, int voucherSeriesId)
        {
            ActionResult result = new ActionResult();
            List<VoucherHeadIO> voucherHeadIOs = new List<VoucherHeadIO>();

            #region Init

            string batchId = GenerateBatchId();

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    foreach (var voucher in voucherIOItem.Vouchers.OrderBy(v => v.Date))
                    {
                        VoucherHeadIO voucherHeadIO = CreateVoucherIO(entities, headType, source, type, voucher, batchId, importId, actorCompanyId, accountYearId, voucherSeriesId);
                        if (voucherHeadIO != null)
                            voucherHeadIOs.Add(voucherHeadIO);
                    }

                    //Save
                    result = BulkInsert(entities, voucherHeadIOs);

                    var ioVoucherRows = new List<VoucherRowIO>();
                    foreach (var item in voucherHeadIOs)
                    {
                        foreach (var row in item.VoucherRowIO)
                        {
                            row.VoucherHeadIOId = item.VoucherHeadIOId;
                            ioVoucherRows.Add(row);
                        }
                    }

                    result = BulkInsert(entities, ioVoucherRows);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportVoucherIO(VoucherHeadIOItem voucherIOItem): ");
                }
            }

            if (result.Success && importToVoucher)
                result = ImportFromVoucherHeadIO(voucherHeadIOs, importId, actorCompanyId, type == TermGroup_IOType.WebAPI);

            result.StringValue = batchId;

            return result;
        }

        public ActionResult ImportPayrollAccountingToVouchers(PayrollVoucherHeadDTO payrollVoucherHeadDTO, int actorCompanyId, int voucherSeriesTypeId, DateTime voucherDate, VoucherRowMergeType voucherRowMergeType, TermGroup_VoucherHeadSourceType voucherType)
        {
            if (!FeatureManager.HasRolePermission(Feature.Economy_Accounting_Vouchers_Edit, Permission.Modify, parameterObject.RoleId, actorCompanyId))
                return new ActionResult("Perssion to create voucher missing");

            var year = AccountManager.GetAccountYear(voucherDate, actorCompanyId);

            if (year == null)
                return new ActionResult("Year missing");

            var series = VoucherManager.GetVoucherSerieByType(voucherSeriesTypeId, year.AccountYearId);

            if (series == null)
                return new ActionResult("Series missing");

            var period = AccountManager.GetAccountPeriod(payrollVoucherHeadDTO.Date, actorCompanyId);

            if (period == null)
                return new ActionResult("Period missing");

            var accounts = AccountManager.GetAccounts(actorCompanyId);
            var dims = AccountManager.GetAccountDimsByCompany(actorCompanyId);
            var validDimIds = dims.Where(w => !w.ExcludeinAccountingExport).Select(s => s.AccountDimId).ToList();

            VoucherHeadDTO voucherHead = new VoucherHeadDTO()
            {
                Date = payrollVoucherHeadDTO.Date,
                Note = payrollVoucherHeadDTO.Note,
                Text = payrollVoucherHeadDTO.Text,
                ActorCompanyId = actorCompanyId,
                VoucherSeriesId = series.VoucherSeriesId,
                Status = TermGroup_AccountStatus.Open,
                VoucherSeriesTypeId = voucherSeriesTypeId,
                AccountYearId = year.AccountYearId,
                AccountPeriodId = period.AccountPeriodId,
                SourceType = voucherType,
            };

            List<AccountingRowDTO> voucherRows = new List<AccountingRowDTO>();
            int rowNr = 1;
            foreach (var row in payrollVoucherHeadDTO.Rows)
            {
                AccountingRowDTO vrow = new AccountingRowDTO()
                {
                    RowNr = rowNr,
                    Text = row.Text,
                    Date = row.Date,
                    Quantity = row.Quantity,
                    Amount = row.Amount,
                    AmountEntCurrency = row.Amount,
                    Dim1Id = row.Dim1Id,
                    Dim2Id = row.Dim2Id != 0 && validDimIds.Contains(accounts.First(f => f.AccountId == row.Dim2Id).AccountDimId) ? row.Dim2Id : 0,
                    Dim3Id = row.Dim3Id != 0 && validDimIds.Contains(accounts.First(f => f.AccountId == row.Dim3Id).AccountDimId) ? row.Dim3Id : 0,
                    Dim4Id = row.Dim4Id != 0 && validDimIds.Contains(accounts.First(f => f.AccountId == row.Dim4Id).AccountDimId) ? row.Dim4Id : 0,
                    Dim5Id = row.Dim5Id != 0 && validDimIds.Contains(accounts.First(f => f.AccountId == row.Dim5Id).AccountDimId) ? row.Dim5Id : 0,
                    Dim6Id = row.Dim6Id != 0 && validDimIds.Contains(accounts.First(f => f.AccountId == row.Dim6Id).AccountDimId) ? row.Dim6Id : 0
                };
                vrow.DebitAmount = vrow.Amount > 0 ? vrow.Amount : 0;
                vrow.CreditAmount = vrow.Amount < 0 ? -vrow.Amount : 0;
                vrow.DebitAmountEntCurrency = vrow.DebitAmount;
                vrow.CreditAmountEntCurrency = vrow.CreditAmount;
                rowNr++;
                voucherRows.Add(vrow);
            }

            List<AccountingRowDTO> mergedVoucherRows = new List<AccountingRowDTO>();

            if (voucherRowMergeType == VoucherRowMergeType.MergeDebitCredit || voucherRowMergeType == VoucherRowMergeType.Merge)
            {
                voucherRows.ForEach(f => f.VoucherRowMergeType = voucherRowMergeType);
                rowNr = 1;
                foreach (var group in voucherRows.GroupBy(g => $"{g.Text}#{g.Dim1Id}#{g.Dim2Id}#{g.Dim3Id}#{g.Dim4Id}#{g.Dim5Id}#{g.Dim6Id}#{g.MergeSign}"))
                {
                    var row = group.First();

                    AccountingRowDTO vrow = new AccountingRowDTO()
                    {
                        RowNr = rowNr,
                        Text = row.Text,
                        Date = row.Date,
                        Quantity = group.Sum(s => s.Quantity),
                        Amount = group.Sum(s => s.Amount),
                        AmountEntCurrency = group.Sum(s => s.Amount),
                        Dim1Id = row.Dim1Id,
                        Dim2Id = row.Dim2Id,
                        Dim3Id = row.Dim3Id,
                        Dim4Id = row.Dim4Id,
                        Dim5Id = row.Dim5Id,
                        Dim6Id = row.Dim6Id
                    };

                    vrow.DebitAmount = vrow.Amount > 0 ? vrow.Amount : 0;
                    vrow.CreditAmount = vrow.Amount < 0 ? -vrow.Amount : 0;
                    vrow.DebitAmountEntCurrency = vrow.DebitAmount;
                    vrow.CreditAmountEntCurrency = vrow.CreditAmount;
                    rowNr++;
                    mergedVoucherRows.Add(vrow);
                }
            }
            else
                mergedVoucherRows = voucherRows;

            return VoucherManager.SaveVoucher(voucherHead, mergedVoucherRows, null, null, actorCompanyId, true);
        }


        public ActionResult ImportPayrollAccountingToIO(CompEntities entities, PayrollVoucherHeadDTO payrollVoucherHeadDTO, int actorCompanyId)
        {
            VoucherHeadIOItem voucherIOItem = new VoucherHeadIOItem();
            voucherIOItem.Vouchers = new List<VoucherHeadIODTO>();
            string batchId = GenerateBatchId();

            VoucherHeadIO voucherHeadIO = new VoucherHeadIO()
            {
                Date = payrollVoucherHeadDTO.Date,
                Note = payrollVoucherHeadDTO.Note,
                Text = payrollVoucherHeadDTO.Text,
                AccountYearId = 0,
                Type = (int)TermGroup_IOType.XEConnect,
                ActorCompanyId = actorCompanyId,
                BatchId = batchId,
                Status = (int)TermGroup_IOStatus.Unprocessed,
            };

            foreach (var row in payrollVoucherHeadDTO.Rows)
            {
                var rowio = new VoucherRowIO()
                {
                    ActorCompanyId = actorCompanyId,
                    Source = (int)TermGroup_IOSource.Connect,
                    Type = (int)TermGroup_IOType.XEConnect,
                    Status = (int)TermGroup_IOStatus.Unprocessed,
                    Import = true,
                    BatchId = batchId,
                    ImportHeadType = (int)TermGroup_IOImportHeadType.Voucher,
                    Amount = row.Amount,
                    DebetAmount = row.Amount > 0 ? row.Amount : 0,
                    CreditAmount = row.Amount < 0 ? row.Amount : 0,
                    Quantity = row.Quantity,
                    AccountNr = row.Dim1Nr,
                    AccountDim2Nr = row.Dim2Nr,
                    AccountDim3Nr = row.Dim3Nr,
                    AccountDim4Nr = row.Dim4Nr,
                    AccountDim5Nr = row.Dim5Nr,
                    AccountDim6Nr = row.Dim6Nr,
                    Text = row.Text
                };

                SetCreatedProperties(rowio);
                voucherHeadIO.VoucherRowIO.Add(rowio);
            }

            entities.VoucherHeadIO.AddObject(voucherHeadIO);
            return SaveChanges(entities);
        }

        #endregion

        #region Import From VoucherIO

        public ActionResult ImportVoucherHeadIO(List<int> iosIds, int actorCompanyId, bool useAccountDistribution, bool useAccountDims, int defaultDim1AccountId, int defaultDim2AccountId, int defaultDim3AccountId, int defaultDim4AccountId, int defaultDim5AccountId, int defaultDim6AccountId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    List<VoucherHeadIO> voucherHeadIOs = new List<VoucherHeadIO>();

                    foreach (var voucherHeadIOId in iosIds)
                    {
                        VoucherHeadIO voucherHeadIO = (from io in entities.VoucherHeadIO
                                                        .Include("VoucherRowIO")
                                                       where voucherHeadIOId == io.VoucherHeadIOId
                                                       select io).FirstOrDefault();

                        if (voucherHeadIO != null)
                            voucherHeadIOs.Add(voucherHeadIO);
                    }


                    foreach (VoucherHeadIO voucherHeadIO in voucherHeadIOs)
                    {
                        voucherHeadIO.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    }

                    int importId = 0;
                    if (voucherHeadIOs.Any())
                        importId = voucherHeadIOs.FirstOrDefault().ImportId;

                    result = ImportFromVoucherHeadIO(voucherHeadIOs, importId, actorCompanyId, useAccountDistribution, useAccountDims, defaultDim1AccountId, defaultDim2AccountId, defaultDim3AccountId, defaultDim4AccountId, defaultDim5AccountId, defaultDim6AccountId);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        public ActionResult ImportFromVoucherHeadIO(List<VoucherHeadIO> voucherHeadIOs, int importId, int actorCompanyId, bool useAccountDistribution = false, bool useAccountDims = false, int defaultDim1AccountId = 0, int defaultDim2AccountId = 0, int defaultDim3AccountId = 0, int defaultDim4AccountId = 0, int defaultDim5AccountId = 0, int defaultDim6AccountId = 0)
        {
            if (voucherHeadIOs == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "VoucherHeadIO");

            var result = new ActionResult();
            result.Strings = new List<string>();

            #region Init

            int counter = voucherHeadIOs.Count;
            int counterTransferred = 0;
            int counterErrorOccurred = 0;

            #endregion

            #region Prereq

            //Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            this.rowNr = 0;

            //Get settings
            int defaultAccountId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountingVoucherImportStandardAccount, 0, actorCompanyId, 0);

            #endregion

            try
            {
                #region Accounts

                List<AccountInternal> dim2Accounts = new List<AccountInternal>();
                List<AccountInternal> dim3Accounts = new List<AccountInternal>();
                List<AccountInternal> dim4Accounts = new List<AccountInternal>();
                List<AccountInternal> dim5Accounts = new List<AccountInternal>();
                List<AccountInternal> dim6Accounts = new List<AccountInternal>();

                List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId);
                List<Account> accounts = AccountManager.GetAccounts(actorCompanyId, accountDims[0].AccountDimId, 0);

                int pos = 2;
                foreach (var dim in accountDims.Where(a => a.IsInternal))
                {
                    switch (pos)
                    {
                        case 2:
                            dim2Accounts = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, loadDims: true);
                            break;
                        case 3:
                            dim3Accounts = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, loadDims: true);
                            break;
                        case 4:
                            dim4Accounts = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, loadDims: true);
                            break;
                        case 5:
                            dim5Accounts = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, loadDims: true);
                            break;
                        case 6:
                            dim6Accounts = AccountManager.GetAccountInternalsByDim(dim.AccountDimId, actorCompanyId, loadDims: true);
                            break;
                    }
                    pos++;
                }

                #endregion

                #region Perform

                List<Account> accountForBalance = new List<Account>();
                List<int> accountYearIds = voucherHeadIOs.Select(h => h.AccountYearId).Distinct().ToList();
                List<string> specialFunctionality = GetSpecialFunctionality(actorCompanyId, importId);

                foreach (VoucherHeadIO io in voucherHeadIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing))
                {
                    ActionResult transferedResult = ImportFromVoucherHeadIO(io, specialFunctionality, accounts, dim2Accounts, dim3Accounts, dim4Accounts, dim5Accounts, dim6Accounts, actorCompanyId, defaultAccountId, useAccountDistribution, useAccountDims, defaultDim1AccountId, defaultDim2AccountId, defaultDim3AccountId, defaultDim4AccountId, defaultDim5AccountId, defaultDim6AccountId);

                    #region Log transfer results

                    using (CompEntities entities = new CompEntities())
                    {
                        VoucherHeadIO voucherHeadIO = entities.VoucherHeadIO.Include("VoucherRowIO").FirstOrDefault(i => i.VoucherHeadIOId == io.VoucherHeadIOId);
                        if (voucherHeadIO == null)
                            continue;

                        if (!transferedResult.Success)
                        {
                            voucherHeadIO.Status = (int)TermGroup_IOStatus.Error;
                            voucherHeadIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;

                            foreach (var voucherRowIO in voucherHeadIO.VoucherRowIO)
                            {
                                voucherRowIO.Status = (int)TermGroup_IOStatus.Error;
                                voucherRowIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                            }
                            counterErrorOccurred++;
                        }
                        else
                        {
                            voucherHeadIO.VoucherHeadId = io.VoucherHeadId;
                            voucherHeadIO.Status = (int)TermGroup_IOStatus.Processed;
                            voucherHeadIO.ErrorMessage = "";
                            counterTransferred++;

                            // Handle accounts for balance calculation
                            foreach (var id in transferedResult.Keys)
                            {
                                var account = accounts.FirstOrDefault(a => a.AccountId == id);
                                if (!accountForBalance.Contains(account))
                                    accountForBalance.Add(account);
                            }
                        }

                        var saveResult = SaveChanges(entities);
                        if (!saveResult.Success)
                            return saveResult;
                        else if (transferedResult.Value != null)
                            result.Strings.Add(transferedResult.Value.ToString());
                    }

                    #endregion
                }

                #endregion

                #region Calculate account balance

                foreach (var accountYearId in accountYearIds)
                {
                    AccountBalanceManager(actorCompanyId).CalculateAccountBalanceForAccountsFromAccountYear(actorCompanyId, accountYearId, accountForBalance);
                }

                #endregion
            }
            catch (Exception e)
            {
                result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                base.LogError(e, this.log);
            }
            result.InfoMessage = string.Format(GetText(7205, "{0} verifikat utav {1} har skapats/uppdaterats."), counterTransferred, counter);
            result.SuccessNumber = counterTransferred;
            result.StringValue = string.Format("{0},{1}", counterTransferred, counterErrorOccurred);
            return result;
        }

        public ActionResult ImportFromVoucherHeadIO(VoucherHeadIO voucherHeadIO, List<string> specialFunctionalities, List<Account> accounts, List<AccountInternal> dim2Accounts, List<AccountInternal> dim3Accounts, List<AccountInternal> dim4Accounts, List<AccountInternal> dim5Accounts, List<AccountInternal> dim6Accounts,
            int actorCompanyId, int defaultAccountId, bool useAccountDistribution = false, bool useAccountDims = false, int defaultDim1AccountId = 0, int defaultDim2AccountId = 0, int defaultDim3AccountId = 0, int defaultDim4AccountId = 0, int defaultDim5AccountId = 0, int defaultDim6AccountId = 0)
        {
            ActionResult result = new ActionResult();

            #region Init

            bool newVoucher = false;
            AccountPeriod period = null;
            int accountDimStdId = accounts.FirstOrDefault().AccountDimId;
            int? sysVatAccountId = accounts.FirstOrDefault(a => a.AccountStd.SysVatAccountId != null)?.AccountStd.SysVatAccountId;
            List<int> accountIds = new List<int>();

            #endregion

            #region VoucherHeadIO

            try
            {
                #region Mandatory Values

                if (voucherHeadIO.Date == null)
                {
                    result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7206, "Verifikat saknar datum"));
                    return result;
                }

                #endregion

                #region Init

                voucherHeadIO.ErrorMessage = string.Empty;
                this.rowNr++;

                period = AccountManager.GetAccountPeriod(voucherHeadIO.AccountYearId, voucherHeadIO.Date, actorCompanyId);
                if (period == null)
                {
                    voucherHeadIO.ErrorMessage = GetText(7206, "Kontrollera redovisningsår och filens datum");
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(7206, "Kontrollera redovisningsår och filens datum"));
                }
                if (period.Status != (int)TermGroup_AccountStatus.Open)
                {
                    voucherHeadIO.ErrorMessage = GetText(11969, "Angiven period är ej öppen, måste öppnas först");
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11969, "Angiven period är ej öppen, måste öppnas först"));
                }

                #endregion

                #region Validation

                #endregion
            }
            catch (Exception ex)
            {
                result.Exception = ex;
                base.LogError(ex, this.log);
            }

            #endregion

            #region Check existing

            int voucherNr = 0;

            if (!string.IsNullOrEmpty(voucherHeadIO.VoucherNr))
                int.TryParse(voucherHeadIO.VoucherNr, out voucherNr);

            if (voucherNr != 0 && !string.IsNullOrEmpty(voucherHeadIO.VoucherNr))
            {
                if (VoucherManager.GetVoucherHeadByNr(voucherNr, voucherHeadIO.VoucherSeriesId, actorCompanyId) != null)
                {
                    result.ErrorMessage = "Voucher Exists";
                    return result;
                }
            }

            #endregion

            #region Save

            if (result.Success)
            {
                #region Save Voucher

                #region Create SaveDTO

                var head = new VoucherHeadDTO()
                {
                    VoucherSeriesId = voucherHeadIO.VoucherSeriesId,
                    AccountPeriodId = period.AccountPeriodId,
                    Date = voucherHeadIO.Date,
                    Text = voucherHeadIO.Text,
                    Template = false,
                    TypeBalance = false,
                    VatVoucher = voucherHeadIO.IsVatVoucher,
                    VoucherNr = (voucherNr != 0) ? voucherNr : 0
                };

                #endregion

                #region VoucherRows

                List<AccountingRowDTO> accountingRowDTOsInput = new List<AccountingRowDTO>();
                if (voucherHeadIO.VoucherRowIO.Count > 0)
                {
                    int rowNr = 1;

                    foreach (VoucherRowIO rowIO in voucherHeadIO.VoucherRowIO)
                    {
                        AccountingRowDTO rowDto = new AccountingRowDTO()
                        {
                            RowNr = rowNr,
                            Type = AccountingRowType.AccountingRow,
                            Quantity = rowIO.Quantity,
                            Amount = rowIO.Amount != null ? (decimal)rowIO.Amount : rowIO.DebetAmount != null ? (decimal)rowIO.DebetAmount : (decimal)rowIO.CreditAmount,
                            DebitAmount = rowIO.DebetAmount != null ? (decimal)rowIO.DebetAmount : 0m,
                            CreditAmount = rowIO.CreditAmount != null ? (decimal)rowIO.CreditAmount : 0m,
                            Text = rowIO.Text,
                        };

                        rowNr++;

                        Account rowAccount = accounts.FirstOrDefault(a => a.AccountNr == rowIO.AccountNr);
                        if (rowAccount != null)
                        {

                            rowDto.Dim1Id = rowAccount.AccountId;
                            rowDto.Dim1Nr = rowAccount.AccountNr;
                            rowDto.Dim1Name = rowAccount.Name;
                        }
                        else
                        {
                            Account account = new Account();
                            account.AccountNr = rowIO.AccountNr;
                            account.Name = rowIO.AccountNr;
                            account.Created = DateTime.Now;
                            account.CreatedBy = "Import";
                            account.ActorCompanyId = actorCompanyId;

                            account.AccountStd = new AccountStd();
                            account.AccountStd.Account = account;
                            account.AccountStd.Unit = "";
                            account.AccountStd.UnitStop = true;
                            account.AccountStd.SysVatAccountId = sysVatAccountId;
                            account.AccountStd.SieKpTyp = "";
                            account.AccountStd.AmountStop = 1;
                            account.AccountStd.AccountTypeSysTermId = (int)TermGroup_AccountType.Asset;

                            result = AccountManager.AddAccount(account, accountDimStdId, actorCompanyId, base.UserId);

                            if (!result.Success)
                            {
                                return result;
                            }

                            rowAccount = AccountManager.GetAccountByNr(rowIO.AccountNr, accountDimStdId, actorCompanyId);

                            rowDto.Dim1Id = rowAccount.AccountId;
                            rowDto.Dim1Nr = rowAccount.AccountNr;
                            rowDto.Dim1Name = rowAccount.Name;

                        }

                        #region Map internal accounts

                        List<int> parentAccounts = new List<int>();
                        if ((rowIO.AccountDim2Nr != null && !string.IsNullOrEmpty(rowIO.AccountDim2Nr.Trim())) || (useAccountDims && defaultDim2AccountId != 0))
                        {
                            AccountInternal accInt = null;
                            if (useAccountDims && defaultDim2AccountId != 0)
                            {
                                if (defaultDim2AccountId > 0)
                                    accInt = dim2Accounts.FirstOrDefault(a => a.AccountId == defaultDim2AccountId);
                            }
                            else
                            {
                                accInt = dim2Accounts.FirstOrDefault(a => a.Account.AccountNr == rowIO.AccountDim2Nr);
                            }

                            if (accInt != null)
                            {
                                rowDto.Dim2Id = accInt.Account.AccountId;
                                rowDto.Dim2Name = accInt.Account.Name;
                                rowDto.Dim2Nr = accInt.Account.AccountNr;

                                if (accInt.Account.ParentAccountId.HasValue)
                                    parentAccounts.Add(accInt.Account.ParentAccountId.Value);
                            }
                            else
                            {
                                //No account found to match - set status error
                                //rowIO.Status = (int)TermGroup_IOStatus.Error;
                                //rowIO.ErrorMessage = GetText(7209, "Inget matchande internkonto hittades");

                                //result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7209, "Inget matchande internkonto hittades"));
                                //return result;
                            }
                        }

                        if ((rowIO.AccountDim3Nr != null && !string.IsNullOrEmpty(rowIO.AccountDim3Nr.Trim())) || (useAccountDims && defaultDim3AccountId != 0))
                        {
                            AccountInternal accInt = null;
                            if (useAccountDims && defaultDim3AccountId != 0)
                            {
                                if (defaultDim3AccountId > 0)
                                    accInt = dim3Accounts.FirstOrDefault(a => a.AccountId == defaultDim3AccountId);
                            }
                            else
                            {
                                accInt = dim3Accounts.FirstOrDefault(a => a.Account.AccountNr == rowIO.AccountDim3Nr);
                            }


                            if (accInt != null)
                            {
                                rowDto.Dim3Id = accInt.Account.AccountId;
                                rowDto.Dim3Name = accInt.Account.Name;
                                rowDto.Dim3Nr = accInt.Account.AccountNr;

                                if (accInt.Account.ParentAccountId.HasValue)
                                    parentAccounts.Add(accInt.Account.ParentAccountId.Value);
                            }
                            else
                            {
                                ////No account found to match - set status error
                                //rowIO.Status = (int)TermGroup_IOStatus.Error;
                                //rowIO.ErrorMessage = GetText(7209, "Inget matchande internkonto hittades");

                                //result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7209, "Inget matchande internkonto hittades"));
                                //return result;
                            }
                        }

                        if ((rowIO.AccountDim4Nr != null && !string.IsNullOrEmpty(rowIO.AccountDim4Nr.Trim())) || (useAccountDims && defaultDim4AccountId != 0))
                        {
                            AccountInternal accInt = null;
                            if (useAccountDims && defaultDim4AccountId != 0)
                            {
                                if (defaultDim4AccountId > 0)
                                    accInt = dim4Accounts.FirstOrDefault(a => a.AccountId == defaultDim4AccountId);
                            }
                            else
                            {
                                accInt = dim4Accounts.FirstOrDefault(a => a.Account.AccountNr == rowIO.AccountDim4Nr);
                            }

                            if (accInt != null)
                            {
                                rowDto.Dim4Id = accInt.Account.AccountId;
                                rowDto.Dim4Name = accInt.Account.Name;
                                rowDto.Dim4Nr = accInt.Account.AccountNr;

                                if (accInt.Account.ParentAccountId.HasValue)
                                    parentAccounts.Add(accInt.Account.ParentAccountId.Value);
                            }
                            else
                            {
                                ////No account found to match - set status error
                                //rowIO.Status = (int)TermGroup_IOStatus.Error;
                                //rowIO.ErrorMessage = GetText(7209, "Inget matchande internkonto hittades");

                                //result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7209, "Inget matchande internkonto hittades"));
                                //return result;
                            }
                        }

                        if ((rowIO.AccountDim5Nr != null && !string.IsNullOrEmpty(rowIO.AccountDim5Nr.Trim())) || (useAccountDims && defaultDim5AccountId != 0))
                        {
                            AccountInternal accInt = null;
                            if (useAccountDims && defaultDim5AccountId != 0)
                            {
                                if (defaultDim5AccountId > 0)
                                    accInt = dim5Accounts.FirstOrDefault(a => a.AccountId == defaultDim5AccountId);
                            }
                            else
                            {
                                accInt = dim5Accounts.FirstOrDefault(a => a.Account.AccountNr == rowIO.AccountDim5Nr);
                            }

                            if (accInt != null)
                            {
                                rowDto.Dim5Id = accInt.Account.AccountId;
                                rowDto.Dim5Name = accInt.Account.Name;
                                rowDto.Dim5Nr = accInt.Account.AccountNr;

                                if (accInt.Account.ParentAccountId.HasValue)
                                    parentAccounts.Add(accInt.Account.ParentAccountId.Value);
                            }
                            else
                            {
                                ////No account found to match - set status error
                                //rowIO.Status = (int)TermGroup_IOStatus.Error;
                                //rowIO.ErrorMessage = GetText(7209, "Inget matchande internkonto hittades");

                                //result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7209, "Inget matchande internkonto hittades"));
                                //return result;
                            }
                        }

                        if ((rowIO.AccountDim6Nr != null && !string.IsNullOrEmpty(rowIO.AccountDim6Nr.Trim())) || (useAccountDims && defaultDim6AccountId != 0))
                        {
                            AccountInternal accInt = null;
                            if (useAccountDims && defaultDim6AccountId != 0)
                            {
                                if (defaultDim6AccountId > 0)
                                    accInt = dim6Accounts.FirstOrDefault(a => a.AccountId == defaultDim6AccountId);
                            }
                            else
                            {
                                accInt = dim6Accounts.FirstOrDefault(a => a.Account.AccountNr == rowIO.AccountDim6Nr);
                            }

                            if (accInt != null)
                            {
                                rowDto.Dim6Id = accInt.Account.AccountId;
                                rowDto.Dim6Name = accInt.Account.Name;
                                rowDto.Dim6Nr = accInt.Account.AccountNr;

                                if (accInt.Account.ParentAccountId.HasValue)
                                    parentAccounts.Add(accInt.Account.ParentAccountId.Value);
                            }
                            else
                            {
                                ////No account found to match - set status error
                                //rowIO.Status = (int)TermGroup_IOStatus.Error;
                                //rowIO.ErrorMessage = GetText(7209, "Inget matchande internkonto hittades");

                                //result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7209, "Inget matchande internkonto hittades"));
                                //return result;
                            }
                        }

                        foreach (var accountId in parentAccounts)
                        {
                            AccountInternal accInt = dim2Accounts.FirstOrDefault(a => a.AccountId == accountId);
                            if (accInt != null)
                            {
                                if (rowDto.Dim2Id == 0)
                                {
                                    rowDto.Dim2Id = accInt.Account.AccountId;
                                    rowDto.Dim2Name = accInt.Account.Name;
                                    rowDto.Dim2Nr = accInt.Account.AccountNr;
                                }
                                continue;
                            }

                            accInt = dim3Accounts.FirstOrDefault(a => a.AccountId == accountId);
                            if (accInt != null)
                            {
                                if (rowDto.Dim3Id == 0)
                                {
                                    rowDto.Dim3Id = accInt.Account.AccountId;
                                    rowDto.Dim3Name = accInt.Account.Name;
                                    rowDto.Dim3Nr = accInt.Account.AccountNr;
                                }
                                continue;
                            }

                            accInt = dim4Accounts.FirstOrDefault(a => a.AccountId == accountId);
                            if (accInt != null)
                            {
                                if (rowDto.Dim4Id == 0)
                                {
                                    rowDto.Dim4Id = accInt.Account.AccountId;
                                    rowDto.Dim4Name = accInt.Account.Name;
                                    rowDto.Dim4Nr = accInt.Account.AccountNr;
                                }
                                continue;
                            }

                            accInt = dim5Accounts.FirstOrDefault(a => a.AccountId == accountId);
                            if (accInt != null)
                            {
                                if (rowDto.Dim5Id == 0)
                                {
                                    rowDto.Dim5Id = accInt.Account.AccountId;
                                    rowDto.Dim5Name = accInt.Account.Name;
                                    rowDto.Dim5Nr = accInt.Account.AccountNr;
                                }
                                continue;
                            }

                            accInt = dim6Accounts.FirstOrDefault(a => a.AccountId == accountId);
                            if (accInt != null)
                            {
                                if (rowDto.Dim6Id == 0)
                                {
                                    rowDto.Dim6Id = accInt.Account.AccountId;
                                    rowDto.Dim6Name = accInt.Account.Name;
                                    rowDto.Dim6Nr = accInt.Account.AccountNr;
                                }
                                continue;
                            }
                        }

                        #endregion

                        accountingRowDTOsInput.Add(rowDto);

                        if (!accountIds.Contains(rowAccount.AccountId))
                            accountIds.Add(rowAccount.AccountId);
                    }
                }

                #endregion

                #region Check diff

                decimal diffAmount = accountingRowDTOsInput.Sum(r => r.DebitAmount) - accountingRowDTOsInput.Sum(r => r.CreditAmount);
                decimal diffAmountAbs = Math.Abs(diffAmount);
                if (diffAmount != 0)
                {
                    //diffAmount = ((diffAmount / 2)* -1);
                    //diffAmount = (diffAmount * -1);
                    //Cent rounding
                    AccountStd accountStdCent = AccountManager.GetAccountStdFromCompanySetting(CompanySettingType.AccountCommonCentRounding, actorCompanyId);

                    if (accountStdCent != null && diffAmount < 0)
                    {
                        AccountingRowDTO rowDto = new AccountingRowDTO()
                        {
                            Type = AccountingRowType.AccountingRow,
                            Quantity = null,
                            Amount = diffAmount,
                            DebitAmount = diffAmountAbs,
                            CreditAmount = 0m,
                            Dim1Id = accountStdCent.AccountId,
                            Dim1Nr = accountStdCent.Account.AccountNr,
                            Dim1Name = accountStdCent.Account.Name,
                        };

                        accountingRowDTOsInput.Add(rowDto);
                    }
                    if (accountStdCent != null && diffAmount > 0)
                    {
                        AccountingRowDTO rowDto = new AccountingRowDTO()
                        {
                            Type = AccountingRowType.AccountingRow,
                            Quantity = null,
                            Amount = diffAmount,
                            DebitAmount = 0m,
                            CreditAmount = diffAmountAbs,
                            Dim1Id = accountStdCent.AccountId,
                            Dim1Nr = accountStdCent.Account.AccountNr,
                            Dim1Name = accountStdCent.Account.Name,
                        };

                        accountingRowDTOsInput.Add(rowDto);
                    }

                    if (accountStdCent != null && !accountIds.Contains(accountStdCent.AccountId))
                        accountIds.Add(accountStdCent.AccountId);
                }

                #endregion

                #region Save

                result = VoucherManager.SaveVoucher(head, accountingRowDTOsInput, new List<int>(), null, actorCompanyId, true, useAccountDistribution);

                #endregion

                #endregion

                if (result.Success)
                {
                    voucherHeadIO.VoucherHeadId = result.IntegerValue;
                    voucherHeadIO.Status = (int)TermGroup_IOStatus.Processed;

                    result.Keys = accountIds;
                }
                else
                {
                    result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(7207, "Verifikat kunde inte skapas") + "\n" + result.ErrorMessage);
                    if (Enum.IsDefined(typeof(ActionResultSave), result.ErrorNumber))
                        result.ErrorMessage += string.Format(GetText(5654, "Felkod:") + " {0} ({1})", result.ErrorNumber, ((ActionResultSave)result.ErrorNumber).ToString());

                    return result;
                }

                //Update counters
                if (newVoucher)
                    itemsAdded++;
                else
                    itemsUpdated++;
            }
            #endregion

            return result;
        }

        #endregion

        #region Export VoucherIO

        public List<VoucherHeadIODTO> GetVoucherHeadIODTOs(int actorCompanyId, DateTime dateFrom, DateTime dateTo, int? voucherSeriesId = null, int? voucherHeadId = null, int? accountYearId = null, int? voucherNrFrom = null, int? voucherNrTo = null)
        {
            List<VoucherHeadIODTO> voucherHeadIODTOs = new List<VoucherHeadIODTO>();

            try
            {
                List<VoucherHeadDTO> voucherHeadDTOs = VoucherManager.GetVoucherHeadDTOs(actorCompanyId, dateFrom, dateTo, new VoucherHeadFilter { VoucherSeriesId = voucherSeriesId, VoucherHeadId = voucherHeadId, AccountYearId = accountYearId, VoucherNrFrom = voucherNrFrom, VoucherNrTo = voucherNrTo });

                foreach (var voucherHeadDTO in voucherHeadDTOs)
                {
                    var dto = new VoucherHeadIODTO
                    {
                        ActorCompanyId = voucherHeadDTO.ActorCompanyId,
                        VoucherHeadId = voucherHeadDTO.VoucherHeadId,
                        VoucherNr = voucherHeadDTO.VoucherNr.ToString(),
                        VoucherSeriesTypeNr = voucherHeadDTO.VoucherSeriesTypeNr,
                        VoucherSeriesName = voucherHeadDTO.VoucherSeriesTypeName,
                        Text = voucherHeadDTO.Text,
                        StatusName = voucherHeadDTO.Status.ToString(),
                        Date = voucherHeadDTO.Date,
                        Rows = new List<VoucherRowIODTO>(),
                        Modified = voucherHeadDTO.Modified,
                        Created = voucherHeadDTO.Created,
                        AccountYearId = voucherHeadDTO.AccountYearId,
                        AccountPeriodId = voucherHeadDTO.AccountPeriodId
                    };

                    foreach (var row in voucherHeadDTO.Rows)
                    {
                        VoucherRowIODTO voucherRowIODTO = new VoucherRowIODTO();

                        voucherRowIODTO.VoucherRowId = row.VoucherRowId;
                        voucherRowIODTO.AccountId = row.Dim1Id;
                        voucherRowIODTO.AccountDim2Id = row.Dim2Id;
                        voucherRowIODTO.AccountDim3Id = row.Dim3Id;
                        voucherRowIODTO.AccountDim4Id = row.Dim4Id;
                        voucherRowIODTO.AccountDim5Id = row.Dim5Id;
                        voucherRowIODTO.AccountDim6Id = row.Dim6Id;
                        voucherRowIODTO.AccountNr = row.Dim1Nr;
                        voucherRowIODTO.AccountDim2Nr = row.Dim2Nr;
                        voucherRowIODTO.AccountDim3Nr = row.Dim3Nr;
                        voucherRowIODTO.AccountDim4Nr = row.Dim4Nr;
                        voucherRowIODTO.AccountDim5Nr = row.Dim5Nr;
                        voucherRowIODTO.AccountDim6Nr = row.Dim6Nr;
                        voucherRowIODTO.AccountName = row.Dim1Name;
                        voucherRowIODTO.AccountDim2Name = row.Dim2Name;
                        voucherRowIODTO.AccountDim3Name = row.Dim3Name;
                        voucherRowIODTO.AccountDim4Name = row.Dim4Name;
                        voucherRowIODTO.AccountDim5Name = row.Dim5Name;
                        voucherRowIODTO.AccountDim6Name = row.Dim6Name;
                        voucherRowIODTO.CreditAmount = row.Amount < 0 ? row.Amount : 0;
                        voucherRowIODTO.DebetAmount = row.Amount > 0 ? row.Amount : 0;
                        voucherRowIODTO.Amount = row.Amount;
                        voucherRowIODTO.Quantity = row.Quantity;
                        voucherRowIODTO.Text = row.Text;

                        dto.Rows.Add(voucherRowIODTO);
                    }

                    voucherHeadIODTOs.Add(dto);
                }

                return voucherHeadIODTOs;
            }
            catch (Exception ex)
            {
                LogError(ex, this.log);
                return voucherHeadIODTOs;
            }
        }

        #endregion

        #region Help Methods

        public List<VoucherHeadIO> GetVoucherHeadIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            int langId = GetLangId();
            Dictionary<int, string> statuses = base.GetTermGroupDict(TermGroup.IOStatus, langId);

            using (CompEntities entities = new CompEntities())
            {
                entities.VoucherHeadIO.NoTracking();
                entities.VoucherRowIO.NoTracking();
                entities.CommandTimeout = 60;
                var ios = (from io in entities.VoucherHeadIO.Include("VoucherRowIO")
                           where io.ActorCompanyId == actorCompanyId &&
                           io.BatchId == batchId
                           orderby io.VoucherHeadIOId
                           select io).ToList();

                var voucherSeriesCache = new Dictionary<int, VoucherSeries>();

                // Extensions
                foreach (var io in ios)
                {
                    if (io.VoucherSeriesId != 0)
                    {
                        if (!voucherSeriesCache.TryGetValue(io.VoucherSeriesId, out VoucherSeries voucherSeries))
                        {
                            voucherSeries = VoucherManager.GetVoucherSerie(entities, io.VoucherSeriesId, actorCompanyId, true);
                            voucherSeriesCache.Add(voucherSeries.VoucherSeriesId, voucherSeries);
                        }

                        if (voucherSeries != null && voucherSeries.VoucherSeriesType != null)
                            io.VoucherSeriesName = voucherSeries.VoucherSeriesType.Name;
                    }

                    io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : string.Empty;
                }

                return ios;
            }
        }

        public List<VoucherHeadIO> GetVoucherHeadIOResult(int actorCompanyId, List<int> voucherHeadIOIds)
        {
            if (voucherHeadIOIds.IsNullOrEmpty())
                return new List<VoucherHeadIO>();

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.VoucherHeadIO.NoTracking();
            return (from io in entities.VoucherHeadIO.Include("VoucherRowIO")
                    where io.ActorCompanyId == actorCompanyId &&
                    voucherHeadIOIds.Contains(io.VoucherHeadIOId)
                    select io).ToList();
        }

        public ActionResult UpdateVoucherHeadIO(List<VoucherHeadIODTO> dtos)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (VoucherHeadIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        VoucherHeadIO io = GetVoucherHeadIO(entities, dto.VoucherHeadIOId);
                        if (io != null)
                        {
                            io.ActorCompanyId = dto.ActorCompanyId;
                            io.Import = dto.Import;
                            io.Type = (int)dto.Type;
                            io.Status = (int)dto.Status;
                            io.Source = (int)dto.Source;
                            io.BatchId = dto.BatchId;
                            io.Date = dto.Date;
                            io.VoucherNr = dto.VoucherNr;
                            io.Text = dto.Text;
                            io.IsVatVoucher = dto.IsVatVoucher ?? false;
                            io.Note = dto.Note;
                            io.ErrorMessage = dto.ErrorMessage;
                            io.ImportHeadType = (int)dto.ImportHeadType;
                            io.StatusName = dto.StatusName;

                            SetModifiedProperties(io);
                        }
                    }

                    // Save
                    result = SaveChanges(entities);

                    #endregion
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                }
            }

            return result;
        }

        private VoucherHeadIO GetVoucherHeadIO(CompEntities entities, int voucherHeadIOId)
        {
            return (from io in entities.VoucherHeadIO
                    where io.VoucherHeadIOId == voucherHeadIOId
                    select io).FirstOrDefault();
        }

        private VoucherHeadIO CreateVoucherIO(CompEntities entities, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, VoucherHeadIODTO voucherHeadIODTO, string batchId, int importId, int actorCompanyId, int accountYearId, int voucherSeriesId)
        {
            if (voucherHeadIODTO == null)
                return null;
            if (voucherHeadIODTO.Rows.Count == 0)
                return null;


            #region Prereq

            //Get AccountDims
            int? accountSiedim1Pos = null;
            int? accountSiedim3Pos = null;
            int? accountSiedim6Pos = null;
            AccountDim accountSiedim1 = null;
            AccountDim accountSiedim3 = null;
            AccountDim accountSiedim6 = null;
            var accountDimensions = AccountManager.GetAccountDimsByCompany(false, true, true);

            int pos = 2;
            foreach (var dim in accountDimensions)
            {
                switch (dim.SysSieDimNr)
                {
                    case 1:
                        accountSiedim1 = dim;
                        accountSiedim1Pos = pos;
                        break;
                    case 3:
                        accountSiedim3 = dim;
                        accountSiedim3Pos = pos;
                        break;
                    case 6:
                        accountSiedim6 = dim;
                        accountSiedim6Pos = pos;
                        break;
                }
                pos++;
            }

            if (voucherHeadIODTO.VoucherSeriesTypeNr != null && voucherHeadIODTO.VoucherSeriesTypeNr != -1 && voucherSeriesId == 0)
            {
                AccountYear accountYear = AccountManager.GetAccountYear(entities, voucherHeadIODTO.Date, actorCompanyId, false);
                if (accountYear != null)
                {
                    VoucherSeries vourcherSerie = VoucherManager.GetVoucherSerieByTypeNr(entities, (int)voucherHeadIODTO.VoucherSeriesTypeNr, accountYear.AccountYearId);
                    voucherSeriesId = vourcherSerie != null ? vourcherSerie.VoucherSeriesId : 0;
                    accountYearId = accountYear.AccountYearId;
                }
            }

            var headio = new VoucherHeadIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportId = importId,
                ImportHeadType = (int)headType,
                AccountYearId = accountYearId,
                VoucherSeriesId = voucherSeriesId,
                VoucherSeriesTypeNr = voucherHeadIODTO.VoucherSeriesTypeNr,

            };
            SetCreatedProperties(headio);

            #endregion

            #region Perform

            try
            {
                headio.Date = voucherHeadIODTO.Date;
                headio.VoucherNr = voucherHeadIODTO.VoucherNr;
                headio.Text = voucherHeadIODTO.Text;
                headio.IsVatVoucher = voucherHeadIODTO.IsVatVoucher ?? false;
                headio.Note = voucherHeadIODTO.Note;
                headio.ErrorMessage = voucherHeadIODTO.ErrorMessage;
                headio.StatusName = voucherHeadIODTO.StatusName;
                headio.VoucherSeriesTypeNr = voucherHeadIODTO.VoucherSeriesTypeNr;
                headio.Status = (int)TermGroup_IOStatus.UnderProcessing;

                foreach (var voucherRowIODTO in voucherHeadIODTO.Rows)
                {
                    CreateVoucherRowIO(headType, source, type, batchId, actorCompanyId, voucherRowIODTO, headio, accountSiedim1, accountSiedim3, accountSiedim6, accountSiedim1Pos, accountSiedim3Pos, accountSiedim6Pos);
                }

            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                headio.Status = (int)TermGroup_IOStatus.Error;
                headio.ErrorMessage = GetText(8383, "Okänt fel, kunde inte spara all rådata");
            }

            #endregion

            return headio;
        }

        #endregion

        #endregion

        #region VoucherRow

        #region Import to VoucherRowIO



        #endregion

        #region Import VoucherRowIO

        public ActionResult ImportVoucherRowIO(List<int> iosIds, int actorCompanyId, int userId)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    List<VoucherRowIO> ios = (from io in entities.VoucherRowIO
                                              where iosIds.Contains(io.VoucherRowIOId)
                                              select io).ToList();
                    foreach (VoucherRowIO io in ios)
                    {
                        io.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    }

                    int importId = 0;

                    return ImportFromVoucherRowIO(ios, importId, actorCompanyId, userId);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    return new ActionResult(e);
                }
            }
        }

        public ActionResult ImportFromVoucherRowIO(List<VoucherRowIO> voucherRowIOs, int importId, int actorCompanyId, int userId)
        {
            if (voucherRowIOs == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "VoucherRowIO");

            ActionResult result = new ActionResult();

            #region Init

            int counter = voucherRowIOs.Count;
            int counterTransferred = 0;

            #endregion

            #region Prereq

            // Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();

            this.rowNr = 0;

            #endregion

            try
            {
                voucherRowIOs = voucherRowIOs.Where(i => i.Status == (int)TermGroup_IOStatus.UnderProcessing).ToList();

                #region Perform

                foreach (var voucherRowIO in voucherRowIOs)
                {
                    /*string invoiceNr = customerInvoiceRowIOsInvoiceNrGroup.Key;
                    List<CustomerInvoiceRowIO> customerInvoiceRowIOsByInvoiceNr = customerInvoiceRowIOsInvoiceNrGroup.ToList();

                    ActionResult transferedResult = ImportFromCustomerInvoiceRowIO(customerInvoiceRowIOsByInvoiceNr, specialFunctionality, actorCompanyId, userId, invoiceNr);

                    using (CompEntities entities = new CompEntities())
                    {
                        var rowIds = customerInvoiceRowIOsByInvoiceNr.Select(x => x.CustomerInvoiceRowIOId).ToList();
                        var ios = entities.CustomerInvoiceRowIO.Where(i => i.InvoiceNr == invoiceNr && rowIds.Contains(i.CustomerInvoiceRowIOId)).ToList();

                        foreach (var io in customerInvoiceRowIOsByInvoiceNr)
                        {
                            var customerInvoiceRowIO = ios.Where(x => x.CustomerInvoiceRowIOId == io.CustomerInvoiceRowIOId).FirstOrDefault();
                            if (customerInvoiceRowIO == null)
                                continue;

                            if (!transferedResult.Success)
                            {
                                customerInvoiceRowIO.Status = (int)TermGroup_IOStatus.Error;
                                customerInvoiceRowIO.ErrorMessage = string.IsNullOrEmpty(transferedResult.ErrorMessage) ? string.Empty : transferedResult.ErrorMessage;
                        }
                            else
                            {
                                counterTransferred++;
                                customerInvoiceRowIO.Status = (int)TermGroup_IOStatus.Processed;
                                customerInvoiceRowIO.InvoiceId = transferedResult.IntegerValue;
                                customerInvoiceRowIO.ErrorMessage = "";
                            }
                        }

                        result = SaveChanges(entities);
                        if (!result.Success)
                            return result;
                    }*/
                }

                #endregion
            }
            catch (Exception e)
            {
                result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                base.LogError(e, this.log);
            }

            result.ErrorMessage = string.Format(GetText(8425, "{0} Fakturarader utav {1} har skapats/uppdaterats."), counterTransferred, counter);
            return result;
        }

        public ActionResult ImportFromVoucherRowIO(List<VoucherRowIO> voucherRowIOs, List<string> specialFunctionality, int actorCompanyId, int userId, string invoiceNr)
        {
            ActionResult result = new ActionResult();

            if (voucherRowIOs.IsNullOrEmpty())
                return result;

            try
            {
                User user = UserManager.GetUser(userId);
                if (user == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "User");

                /*CustomerInvoice invoice = InvoiceManager.GetCustomerInvoiceByNr(CompEntities, invoiceNr, SoeOriginType.CustomerInvoice, OrderInvoiceRegistrationType.Ledger, actorCompanyId);
                if (invoice == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, string.Format(GetText(8427, "Faktura med fakturanr {0} kunde inte hittas"), invoiceNr));

                List<Account> accounts = GetCompanyAccountsWithAccountDim(CompEntities, actorCompanyId);

                if (firstIO.CustomerRowType == (int)SoeInvoiceRowType.AccountingRow)
                {
                    List<AccountingRowDTO> accountingRows = new List<AccountingRowDTO>();
                    CustomerLedgerSaveDTO invoiceSaveDTO = new CustomerLedgerSaveDTO();

                    result = InvoiceManager.ConvertToCustomerLedgerSaveDTO(CompEntities, invoice, ref invoiceSaveDTO);
                    if (!result.Success)
                        return result;

                    result = InvoiceManager.ConvertToCustomerLedgerAccountingRowDTO(CompEntities, customerInvoiceRowIOsForInvoice, accounts, actorCompanyId, user, accountingRows);
                    if (!result.Success)
                        return result;

                    result = InvoiceManager.SaveCustomerLedger(invoiceSaveDTO, accountingRows, actorCompanyId, user.UserId);
                    if (!result.Success)
                    {
                        string msg = GetText(8428, "Gick inte att spara konteringsrader");
                        if (!string.IsNullOrEmpty(result.ErrorMessage))
                            msg += ": " + result.ErrorMessage;

                        return new ActionResult((int)ActionResultSave.EntityNotFound, msg);
                    }

                    result.IntegerValue = invoice.InvoiceId;
                }
                else if (firstIO.CustomerRowType == (int)SoeInvoiceRowType.ProductRow)
                {
                    if (!invoice.CustomerInvoiceRow.IsLoaded)
                        invoice.CustomerInvoiceRow.Load();

                    var productRows = new List<CustomerInvoiceRowDTO>();
                    result = InvoiceManager.ConvertToCustomerInvoiceRowDTO(CompEntities, customerInvoiceRowIOsForInvoice, accounts, productRows, invoice.InvoiceId);
                }
                else
                {
                    return new ActionResult((int)ActionResultSave.NothingSaved, GetText(8426, "Finns endast stöd för att importera konteringsrader för tillfället"));
                }*/

            }
            catch (Exception ex)
            {
                result.Exception = ex;
                base.LogError(ex, this.log);
            }

            return result;
        }

        #endregion

        #region Help methods

        public IEnumerable<VoucherRowIO> GetVoucherRowIOResult(int actorCompanyId, TermGroup_IOType type, TermGroup_IOSource source, string batchId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.VoucherRowIO.NoTracking();
            var ios = (from io in entities.VoucherRowIO
                       where io.ActorCompanyId == actorCompanyId &&
                       io.BatchId == batchId
                       orderby io.VoucherHeadIOId
                       select io);

            if (type != TermGroup_IOType.Unknown)
                ios.Where(io => io.Type == (int)type);

            if (source != TermGroup_IOSource.Unknown)
                ios.Where(io => io.Source == (int)source);

            // Get terms
            var statuses = base.GetTermGroupDict(TermGroup.IOStatus);

            // Extensions
            foreach (var io in ios)
            {
                io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : String.Empty;
            }

            return ios;
        }

        public IEnumerable<VoucherRowIO> GetVoucherRowIOResult(int actorCompanyId, int voucherHeadId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.VoucherRowIO.NoTracking();
            var ios = (from io in entities.VoucherRowIO
                       where io.ActorCompanyId == actorCompanyId &&
                       io.VoucherHeadId == voucherHeadId
                       select io);

            // Get terms
            var statuses = base.GetTermGroupDict(TermGroup.IOStatus);

            // Extensions
            foreach (var io in ios)
            {
                io.StatusName = statuses.ContainsKey(io.Status) ? statuses[io.Status] : String.Empty;
            }

            return ios;
        }

        public ActionResult UpdateVoucherRowIO(List<VoucherRowIODTO> dtos)
        {
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Perform

                    foreach (VoucherRowIODTO dto in dtos)
                    {
                        // Get existing SupplierIO
                        VoucherRowIO io = GetVoucherRowIO(entities, dto.VoucherRowIOId);
                        if (io != null)
                        {
                            #region Convert from dto

                            io.ActorCompanyId = dto.ActorCompanyId;
                            io.Import = dto.Import;
                            io.Type = (int)dto.Type;
                            io.Status = (int)dto.Status;
                            io.Source = (int)dto.Source;
                            io.BatchId = dto.BatchId;
                            io.Amount = dto.Amount;
                            io.DebetAmount = dto.DebetAmount;
                            io.CreditAmount = dto.CreditAmount;
                            io.Quantity = dto.Quantity;
                            io.AccountNr = dto.AccountNr;
                            io.AccountDim2Nr = dto.AccountDim2Nr;
                            io.AccountDim3Nr = dto.AccountDim3Nr;
                            io.AccountDim4Nr = dto.AccountDim4Nr;
                            io.AccountDim5Nr = dto.AccountDim5Nr;
                            io.AccountDim6Nr = dto.AccountDim6Nr;
                            io.Text = dto.Text;
                            io.ErrorMessage = dto.ErrorMessage;
                            io.ImportHeadType = (int)dto.ImportHeadType;
                            io.StatusName = dto.StatusName;

                            #endregion

                            SetModifiedProperties(io);
                        }
                    }

                    // Save
                    return SaveChanges(entities);

                    #endregion
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    return new ActionResult(e);
                }
            }
        }

        private VoucherRowIO GetVoucherRowIO(CompEntities entities, int voucherRowIOId)
        {
            return (from io in entities.VoucherRowIO
                    where io.VoucherRowIOId == voucherRowIOId
                    select io).FirstOrDefault();
        }

        private void CreateVoucherRowIO(TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, string batchId, int actorCompanyId, VoucherRowIODTO voucherRowIODTO, VoucherHeadIO headio, AccountDim accountSiedim1, AccountDim accountSiedim3, AccountDim accountSiedim6, int? accountSiedim1Pos, int? accountSiedim3Pos, int? accountSiedim6Pos)
        {
            if (accountSiedim1 != null && voucherRowIODTO.AccountSieDim1 != null)
            {
                switch (accountSiedim1Pos)
                {
                    case 2:
                        voucherRowIODTO.AccountDim2Nr = voucherRowIODTO.AccountSieDim1;
                        break;
                    case 3:
                        voucherRowIODTO.AccountDim3Nr = voucherRowIODTO.AccountSieDim1;
                        break;
                    case 4:
                        voucherRowIODTO.AccountDim4Nr = voucherRowIODTO.AccountSieDim1;
                        break;
                    case 5:
                        voucherRowIODTO.AccountDim5Nr = voucherRowIODTO.AccountSieDim1;
                        break;
                    case 6:
                        voucherRowIODTO.AccountDim6Nr = voucherRowIODTO.AccountSieDim1;
                        break;
                }
            }
            if (accountSiedim3 != null && voucherRowIODTO.AccountSieDim3 != null)
            {
                switch (accountSiedim3Pos)
                {
                    case 2:
                        voucherRowIODTO.AccountDim2Nr = voucherRowIODTO.AccountSieDim3;
                        break;
                    case 3:
                        voucherRowIODTO.AccountDim3Nr = voucherRowIODTO.AccountSieDim3;
                        break;
                    case 4:
                        voucherRowIODTO.AccountDim4Nr = voucherRowIODTO.AccountSieDim3;
                        break;
                    case 5:
                        voucherRowIODTO.AccountDim5Nr = voucherRowIODTO.AccountSieDim3;
                        break;
                    case 6:
                        voucherRowIODTO.AccountDim6Nr = voucherRowIODTO.AccountSieDim3;
                        break;
                }
            }
            if (accountSiedim6 != null && voucherRowIODTO.AccountSieDim6 != null)
            {
                switch (accountSiedim6Pos)
                {
                    case 2:
                        voucherRowIODTO.AccountDim2Nr = voucherRowIODTO.AccountSieDim6;
                        break;
                    case 3:
                        voucherRowIODTO.AccountDim3Nr = voucherRowIODTO.AccountSieDim6;
                        break;
                    case 4:
                        voucherRowIODTO.AccountDim4Nr = voucherRowIODTO.AccountSieDim6;
                        break;
                    case 5:
                        voucherRowIODTO.AccountDim5Nr = voucherRowIODTO.AccountSieDim6;
                        break;
                    case 6:
                        voucherRowIODTO.AccountDim6Nr = voucherRowIODTO.AccountSieDim6;
                        break;
                }
            }


            var rowio = new VoucherRowIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,
                Amount = voucherRowIODTO.Amount,
                DebetAmount = voucherRowIODTO.DebetAmount,
                CreditAmount = voucherRowIODTO.CreditAmount,
                Quantity = voucherRowIODTO.Quantity,
                AccountNr = voucherRowIODTO.AccountNr,
                AccountDim2Nr = voucherRowIODTO.AccountDim2Nr,
                AccountDim3Nr = voucherRowIODTO.AccountDim3Nr,
                AccountDim4Nr = voucherRowIODTO.AccountDim4Nr,
                AccountDim5Nr = voucherRowIODTO.AccountDim5Nr,
                AccountDim6Nr = voucherRowIODTO.AccountDim6Nr,
                Text = voucherRowIODTO.Text
            };
            SetCreatedProperties(rowio);
            headio.VoucherRowIO.Add(rowio);
        }

        #endregion

        #endregion

        #endregion

        #region Help-methods

        private event EventHandler<string> BatchIdGenerated;
        private string GenerateBatchId()
        {
            string batchid = Guid.NewGuid().ToString();
            if (BatchIdGenerated != null)
                BatchIdGenerated(this, batchid);

            return batchid;
        }

        private ActionResult AddActorAddress(CompEntities entities, TermGroup_SysContactAddressType addressType, int customerId, string streetAddress, string city, string coAddress, string postalNr, string country, string Name)
        {
            using (entities)
            {
                var contact = ContactManager.GetContactFromActor(entities, customerId, false, false);
                var ca = new ContactAddress()
                {
                    Contact = contact,
                    SysContactAddressTypeId = (int)addressType,
                };

                if (ca.ContactAddressRow == null)
                    ca.ContactAddressRow = new EntityCollection<ContactAddressRow>();

                if (!string.IsNullOrEmpty(streetAddress))
                {
                    ca.ContactAddressRow.Add(
                            new ContactAddressRow()
                            {
                                SysContactAddressRowTypeId = (int)TermGroup_SysContactAddressRowType.Address,
                                Text = streetAddress,
                            });
                }
                if (!string.IsNullOrEmpty(postalNr))
                {
                    ca.ContactAddressRow.Add(
                        new ContactAddressRow()
                        {
                            SysContactAddressRowTypeId = (int)TermGroup_SysContactAddressRowType.PostalCode,
                            Text = postalNr,
                        });
                }
                if (!string.IsNullOrEmpty(coAddress))
                {
                    ca.ContactAddressRow.Add(
                            new ContactAddressRow()
                            {
                                SysContactAddressRowTypeId = (int)TermGroup_SysContactAddressRowType.AddressCO,
                                Text = coAddress,
                            });
                }
                if (!string.IsNullOrEmpty(city))
                {
                    ca.ContactAddressRow.Add(
                            new ContactAddressRow()
                            {
                                SysContactAddressRowTypeId = (int)TermGroup_SysContactAddressRowType.PostalAddress,
                                Text = city,
                            });
                }

                if (!string.IsNullOrEmpty(country))
                {
                    ca.ContactAddressRow.Add(
                            new ContactAddressRow()
                            {
                                SysContactAddressRowTypeId = (int)TermGroup_SysContactAddressRowType.Country,
                                Text = country,
                            });
                }

                if (!string.IsNullOrEmpty(Name))
                {
                    ca.ContactAddressRow.Add(
                            new ContactAddressRow()
                            {
                                SysContactAddressRowTypeId = (int)TermGroup_SysContactAddressRowType.Name,
                                Text = Name,
                            });
                }

                entities.ContactAddress.AddObject(ca);

                var result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = ca.ContactAddressId;

                return result;
            }
        }

        #endregion

        #endregion

        #region Files

        public string ValidatePostedFile(string postedFileName, bool insertGuid)
        {
            string fileName = postedFileName;

            //Validate \
            if (fileName.Contains(@"\"))
            {
                fileName = postedFileName.Substring(postedFileName.LastIndexOf(@"\"));
                fileName = fileName.Replace("\\", "");
            }

            //Validate  /
            if (fileName.Contains(@"/"))
            {
                fileName = postedFileName.Substring(postedFileName.LastIndexOf(@"/"));
                fileName = fileName.Replace(@"/", "");
            }

            //Insert Guid
            if (insertGuid)
                fileName = fileName.Insert(fileName.LastIndexOf("."), Guid.NewGuid().ToString());

            return fileName;
        }

        public string SaveTempFileToServer(byte[] result, string fileName)
        {
            string pathOnServer = ConfigSettings.SOE_SERVER_DIR_TEMP_EXCEL_PHYSICAL + fileName;
            RemoveFileFromServer(pathOnServer);

            FileStream fileStream = new FileStream(pathOnServer, FileMode.CreateNew, FileAccess.ReadWrite, FileShare.Read);


            try
            {
                fileStream.Write(result, 0, result.Length);
            }
            finally
            {
                fileStream.Close();
            }

            return pathOnServer;
        }


        public string SaveTempFileToServer(Stream stream, string fileName)
        {
            string pathOnServer = ConfigSettings.SOE_SERVER_DIR_TEMP_EXCEL_PHYSICAL + fileName;
            RemoveFileFromServer(pathOnServer);

            FileStream fileStream = new FileStream(pathOnServer, FileMode.CreateNew, FileAccess.ReadWrite, FileShare.Read);
            MemoryStream memoryStream = null;

            try
            {
                //stream not seekable convert to memory stream
                memoryStream = new MemoryStream();

                byte[] buffer = new byte[2048];
                int bytesRead = 0;

                do
                {
                    bytesRead = stream.Read(buffer, 0, buffer.Length);
                    memoryStream.Write(buffer, 0, bytesRead);
                }
                while (bytesRead != 0);
                stream.Close();

                //reset stream position
                memoryStream.Position = 0;

                //convert to byte[]
                byte[] result = new byte[(int)memoryStream.Length];
                memoryStream.Read(result, 0, (int)memoryStream.Length);
                fileStream.Write(result, 0, result.Length);
            }
            finally
            {
                memoryStream.Close();
                memoryStream.Dispose();
                fileStream.Close();
            }

            if (DefenderUtil.IsVirus(pathOnServer))
            {
                LogCollector.LogError($"SaveTempFileToServer Virus detected {pathOnServer} {Environment.StackTrace}");

                if (File.Exists(pathOnServer))
                    File.Delete(pathOnServer);
            }

            return pathOnServer;
        }

        public void RemoveFileFromServer(string pathOnServer)
        {
            if (System.IO.File.Exists(pathOnServer))
                System.IO.File.Delete(pathOnServer);
        }

        #endregion

        #region Report transfer

        public byte[] createReportTransferFile(List<int> reportIds, int actorCompanyId)
        {
            XDocument xmlDoc = ReportDataManager.CreateReportTransferXML(reportIds, actorCompanyId);
            if (xmlDoc == null)
                return null;

            MemoryStream stream = new MemoryStream();
            xmlDoc.Save(stream);
            return stream.ToArray();
        }

        public ActionResult importReportsFromTransferFile(int dataStorageId, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            var dataStorageRecord = GeneralManager.GetDataStorageRecord(actorCompanyId, dataStorageId);
            XmlDocument xml = new XmlDocument();
            MemoryStream stream = new MemoryStream(dataStorageRecord.DataStorage.Data);
            xml.Load(stream);
            XDocument xdoc = XDocument.Parse(xml.OuterXml);

            XElement root = xdoc.Root;

            List<ReportGroup> existingReportGroups = ReportManager.GetReportGroupsByCompany(actorCompanyId);
            List<ReportHeader> existingReportHeaders = ReportManager.GetReportHeadersByCompany(actorCompanyId);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        if (entities.Connection.State != ConnectionState.Open)
                            entities.Connection.Open();

                        foreach (XElement reportElement in root.Elements("Report"))
                        {
                            int reportId = 0;

                            Report report = new Report()
                            {
                                ActorCompanyId = actorCompanyId,
                                ReportTemplateId = Int32.Parse(reportElement.Element("ReportTemplateId").Value),
                                ReportNr = Int32.Parse(reportElement.Element("ReportNr").Value),
                                Name = reportElement.Element("Name").Value,
                                Description = reportElement.Element("Description").Value,
                                Standard = StringUtility.GetBool(reportElement.Element("Standard").Value),
                                Original = StringUtility.GetBool(reportElement.Element("Original").Value),
                                ExportType = Int32.Parse(reportElement.Element("ExportType").Value),
                                IncludeAllHistoricalData = StringUtility.GetBool(reportElement.Element("IncludeAllHistoricalData").Value),
                                IncludeBudget = StringUtility.GetBool(reportElement.Element("IncludeBudget").Value),
                                NoOfYearsBackinPreviousYear = Int32.Parse(reportElement.Element("NoOfYearsBackinPreviousYear").Value),
                                GetDetailedInformation = StringUtility.GetBool(reportElement.Element("GetDetailedInformation").Value),
                                ShowInAccountingReports = StringUtility.GetBool(reportElement.Element("ShowInAccountingReports").Value),
                                Module = Int32.Parse(reportElement.Element("Module").Value),
                            };

                            //check that reportnr is not used and add leading 999 if necessary
                            if (ReportManager.GetReportByNr(entities, actorCompanyId, report.ReportNr) != null)
                                report.ReportNr = Int32.Parse("999" + reportElement.Element("ReportNr").Value);

                            //save report
                            SetCreatedProperties(report);
                            entities.Report.AddObject(report);

                            result = SaveChanges(entities, transaction);
                            if (result.Success)
                                reportId = report.ReportId;
                            else
                                continue;

                            #region ReportGroup

                            int reportGroupOrder = 0;
                            XElement reportGroups = reportElement.Element("ReportGroups");
                            foreach (XElement reportGroupElement in reportGroups.Elements("ReportGroup"))
                            {
                                //check if reportgroup already exists
                                int reportGroupId = existingReportGroups.Where(i =>
                                    i.TemplateTypeId == Int32.Parse(reportGroupElement.Element("TemplateTypeId").Value) &&
                                    i.Name == reportGroupElement.Element("Name").Value &&
                                    i.Description == reportGroupElement.Element("Description").Value)
                                    .Select(i => i.ReportGroupId).FirstOrDefault();

                                //create reportgroup
                                if (reportGroupId == 0)
                                {
                                    ReportGroup reportGroup = new ReportGroup()
                                    {
                                        Company = CompanyManager.GetCompany(entities, actorCompanyId),
                                        TemplateTypeId = Int32.Parse(reportGroupElement.Element("TemplateTypeId").Value),
                                        Name = reportGroupElement.Element("Name").Value,
                                        Description = reportGroupElement.Element("Description").Value,
                                        ShowLabel = StringUtility.GetBool(reportGroupElement.Element("ShowLabel").Value),
                                        ShowSum = StringUtility.GetBool(reportGroupElement.Element("ShowSum").Value),
                                        InvertRow = StringUtility.GetBool(reportGroupElement.Element("InvertRow").Value),
                                        Module = Int32.Parse(reportGroupElement.Element("Module").Value),
                                    };

                                    SetCreatedProperties(reportGroup);
                                    entities.ReportGroup.AddObject(reportGroup);

                                    result = SaveChanges(entities, transaction);
                                    if (result.Success)
                                        reportGroupId = reportGroup.ReportGroupId;
                                    else
                                        continue;
                                }

                                #region ReportGroupMapping

                                ReportGroupMapping reportGroupMapping = new ReportGroupMapping()
                                {
                                    ReportGroupId = reportGroupId,
                                    ReportId = reportId,
                                    Order = reportGroupOrder + 1,
                                };

                                entities.ReportGroupMapping.AddObject(reportGroupMapping);

                                result = SaveChanges(entities, transaction);
                                if (result.Success)
                                    reportGroupOrder++;
                                else
                                    continue;

                                #endregion

                                #region ReportHeader

                                int reportHeaderOrder = 0;
                                foreach (XElement reportHeaderElement in reportGroupElement.Elements("ReportHeader"))
                                {
                                    //check if reportheader already exists
                                    int reportHeaderId = existingReportHeaders.Where(i =>
                                        i.TemplateTypeId == Int32.Parse(reportHeaderElement.Element("TemplateTypeId").Value) &&
                                        i.Name == reportHeaderElement.Element("Name").Value &&
                                        i.Description == reportHeaderElement.Element("Description").Value)
                                        .Select(i => i.ReportHeaderId).FirstOrDefault();

                                    //create reportheader
                                    if (reportHeaderId == 0)
                                    {
                                        ReportHeader reportHeader = new ReportHeader()
                                        {
                                            Company = CompanyManager.GetCompany(entities, actorCompanyId),
                                            TemplateTypeId = Int32.Parse(reportHeaderElement.Element("TemplateTypeId").Value),
                                            Name = reportHeaderElement.Element("Name").Value,
                                            Description = reportHeaderElement.Element("Description").Value,
                                            ShowRow = StringUtility.GetBool(reportHeaderElement.Element("ShowRow").Value),
                                            ShowSum = StringUtility.GetBool(reportHeaderElement.Element("ShowSum").Value),
                                            ShowLabel = StringUtility.GetBool(reportHeaderElement.Element("ShowLabel").Value),
                                            ShowZeroRow = StringUtility.GetBool(reportHeaderElement.Element("ShowZeroRow").Value),
                                            Module = Int32.Parse(reportHeaderElement.Element("Module").Value),
                                            DoNotSummarizeOnGroup = StringUtility.GetBool(reportHeaderElement.Element("DoNotSummarizeOnGroup").Value),
                                            InvertRow = StringUtility.GetBool(reportHeaderElement.Element("InvertRow").Value),
                                        };

                                        SetCreatedProperties(reportHeader);
                                        entities.ReportHeader.AddObject(reportHeader);

                                        result = SaveChanges(entities, transaction);
                                        if (result.Success)
                                            reportHeaderId = reportHeader.ReportHeaderId;
                                        else
                                            continue;


                                        #region ReportHeaderMapping

                                        ReportGroupHeaderMapping reportHeaderMapping = new ReportGroupHeaderMapping()
                                        {
                                            ReportGroupId = reportGroupId,
                                            ReportHeaderId = reportHeaderId,
                                            Order = reportHeaderOrder + 1,
                                        };

                                        entities.ReportGroupHeaderMapping.AddObject(reportHeaderMapping);

                                        result = SaveChanges(entities, transaction);
                                        if (result.Success)
                                            reportHeaderOrder++;
                                        else
                                            continue;

                                        #endregion

                                        #region reportHeaderInterval

                                        XElement reportHeaderIntervals = reportHeaderElement.Element("ReportHeaderIntervals");
                                        foreach (XElement reportHeaderIntervalElement in reportHeaderIntervals.Elements("ReportHeaderInterval"))
                                        {
                                            int selectValue = 0;
                                            if (!reportHeaderIntervalElement.Element("SelectValue").IsEmpty)
                                                Int32.TryParse(reportHeaderIntervalElement.Element("SelectValue").Value, out selectValue);

                                            ReportHeaderInterval reportHeaderInterval = new ReportHeaderInterval()
                                            {
                                                ReportHeader = reportHeader,
                                                IntervalFrom = reportHeaderIntervalElement.Element("IntervalFrom").Value,
                                                IntervalTo = reportHeaderIntervalElement.Element("IntervalTo").Value,
                                                SelectValue = selectValue == 0 ? null : (int?)selectValue,
                                            };
                                        }

                                        #endregion
                                    }
                                }
                                #endregion
                            }
                            #endregion
                        }

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (!result.Success)
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

            }

            return result;

        }

        #endregion

        #region TimeScheduleInfo

        public TimeScheduleInfoIODTO GetTimeScheduleInfo(int actorCompanyId, DateTime fromDate, DateTime toDate, List<string> employeeNumbers, bool addAmounts, bool loadSchedule, bool loadPayroll, bool includeEmployeeName = true, bool includeEmployeeNr = true, bool includeEmployeeExternalCode = true)
        {
            TimeScheduleInfoIODTO result = new TimeScheduleInfoIODTO();

            #region Prereq

            if (addAmounts)
                addAmounts = FeatureManager.HasRolePermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Employments_Payroll_Salary, Permission.Modify, parameterObject.RoleId, actorCompanyId);

            bool forceSkipAccount = base.IsTele2(actorCompanyId);
            bool limitLinkedStuff = true;
            this.company = CompanyManager.GetCompany(actorCompanyId);

            var employeeGroups = base.GetEmployeeGroupsFromCache(actorCompanyId, loadExternalCode: true);
            var payrollGroups = base.GetPayrollGroupsFromCache(actorCompanyId, loadExternalCode: true);
            var vacationGroups = base.GetVacationGroupsFromCache(actorCompanyId, loadExternalCode: true);
            var payrollProducts = base.GetPayrollProductsFromCache(actorCompanyId);
            var payrollPriceTypes = PayrollManager.GetPayrollPriceTypes(actorCompanyId, null, false);
            var shiftTypes = base.GetShiftTypesFromCache(actorCompanyId);
            var accounts = AccountManager.GetAccountsByCompany(actorCompanyId, loadAccount: true, loadAccountDim: true, loadAccountMapping: true);
            var attestStates = GetAttestStatesForTimeFromCache(actorCompanyId);
            var timeDeviationCausesDict = TimeDeviationCauseManager.GetTimeDeviationCauses(actorCompanyId).GroupBy(g => g.TimeDeviationCauseId).ToDictionary(a => a.Key, c => c.First());
            var annualLeaveGroups = GetAnnualLeaveGroupsFromCache(actorCompanyId);

            employeeNumbers = employeeNumbers?
                .Select(f => f?.Trim())
                .Where(w => !string.IsNullOrEmpty(w))
                .ToList();
            var employees = EmployeeManager
                .GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, fromDate, toDate, active: null, doValidateEmployment: true, loadEmploymentVacactionGroup: true, loadEmployment: true)
                .FilterOnEmployeeNumbers(employeeNumbers);
            var employmentDTOs = EmployeeManager.GetEmploymentCalenderDTOs(employees, fromDate, toDate, employeeGroups, payrollGroups, payrollPriceTypes, vacationGroups, annualLeaveGroups: annualLeaveGroups);

            var timeScheduleTransactionsByEmployee = loadSchedule ? TimeScheduleManager.GetTimeEmployeeScheduleSmallDTODictForReport(fromDate, toDate, employees, company.ActorCompanyId, RoleId, addAmounts: addAmounts, forceSkipAccount: forceSkipAccount) : new Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>>();
            var timePayrollTransactionsByEmployee = loadPayroll ? TimeTransactionManager.GetTimePayrollTransactionDTOForReport(fromDate, toDate, employees.GetIds(), company.ActorCompanyId) : new Dictionary<int, List<TimePayrollTransactionDTO>>();
            if (addAmounts)
                timePayrollTransactionsByEmployee = TimeTransactionManager.AddAmounts(actorCompanyId, timePayrollTransactionsByEmployee, employees, payrollGroups);

            List<TimeBlockDate> timeBlockDates;
            using (CompEntities entities = new CompEntities())
                timeBlockDates = TimeBlockManager.GetTimeBlockDates(entities, actorCompanyId, employees.Select(s => s.EmployeeId).ToList(), fromDate, toDate);

            #endregion

            #region Generate CalenderInfo

            var calenderInfoDict = new Dictionary<int, List<CalenderInfo>>();
            foreach (var employeeEmploymentDTOs in employmentDTOs.GroupBy(g => g.EmployeeId))
            {
                var employee = employees.FirstOrDefault(f => f.EmployeeId == employeeEmploymentDTOs.Key);
                if (employee != null)
                {
                    var calendarInfos = new List<CalenderInfo>();

                    foreach (var calender in employeeEmploymentDTOs.OrderBy(o => o.Date))
                    {
                        calendarInfos.Add(new CalenderInfo()
                        {
                            EmployeeNr = includeEmployeeNr ? employee.EmployeeNr : null,
                            Date = calender.Date,
                            EmploymentPercent = calender.Percent,
                            EmployeeGroupExternalCodes = employeeGroups?.FirstOrDefault(f => f.EmployeeGroupId == calender.EmployeeGroupId)?.ExternalCodesString ?? string.Empty,
                            VacationGroupExternalCodes = vacationGroups?.FirstOrDefault(f => f.VacationGroupId == calender.VacationGroupId)?.ExternalCodesString ?? string.Empty,
                            PayrollGroupExternalCodes = payrollGroups?.FirstOrDefault(f => f.PayrollGroupId == calender.PayrollGroupId)?.ExternalCodesString ?? string.Empty,
                            DayExternalCode = timeBlockDates.FirstOrDefault(f => f.EmployeeId == employee.EmployeeId && f.Date == calender.Date)?.ExternalCode ?? null
                        });
                    }

                    calenderInfoDict.Add(employeeEmploymentDTOs.Key, calendarInfos);
                }
            }

            #endregion

            #region AttestStateInfo

            foreach (var attestState in attestStates)
            {
                result.AttestStateInfos.Add(new AttestStateInfo()
                {
                    AttestStateId = attestState.AttestStateId,
                    Name = attestState.Name,
                    Sort = attestState.Sort,
                    IsInitial = attestState.Initial,
                });
            }

            #endregion

            #region ProductInfo

            var productIds = limitLinkedStuff && timePayrollTransactionsByEmployee.Any(a => a.Value != null) ?
                timePayrollTransactionsByEmployee
                    .SelectMany(sm => sm.Value)
                    .Select(s => s.PayrollProductId)
                    .Distinct()
                    .ToList() :
                payrollProducts
                    .Select(s => s.ProductId)
                    .ToList();

            foreach (var product in payrollProducts.Where(w => productIds.Contains(w.ProductId)))
            {
                result.ProductInfos.Add(new ProductInfo()
                {
                    ExternalCode = product.ExternalNumber,
                    ProductId = product.ProductId,
                    ProductName = product.Name,
                    ProductNr = product.Number,
                    IsAbsence = product.IsAbsence()
                });
            }

            #endregion

            #region ShiftTypeInfo

            var shiftTypeIds = limitLinkedStuff && timeScheduleTransactionsByEmployee.Any(a => a.Value != null) ?
                timeScheduleTransactionsByEmployee
                    .SelectMany(sm => sm.Value)
                    .Where(s => s.ShiftTypeId.HasValue)
                    .Select(s => s.ShiftTypeId.Value)
                    .Distinct()
                    .ToList() :
                shiftTypes
                    .Select(s => s.ShiftTypeId)
                    .ToList();

            foreach (var shiftType in shiftTypes.Where(s => shiftTypeIds.Contains(s.ShiftTypeId)))
            {
                result.ShiftTypeInfos.Add(new ShiftTypeInfo()
                {
                    ShiftTypeId = shiftType.ShiftTypeId,
                    Name = shiftType.Name,
                    Color = shiftType.Color
                });
            }

            #endregion

            #region AccountInfo

            var accountIds = new HashSet<int>();
            if (limitLinkedStuff)
            {
                //TimePayrollTransaction AccountStdId
                if (timePayrollTransactionsByEmployee.Any(a => a.Value != null))
                    accountIds.UnionWith(timePayrollTransactionsByEmployee
                        .SelectMany(sm => sm.Value)
                        .Select(s => s.AccountId)
                        .Distinct());

                //TimePayrollTransaction AccountInternals
                if (timePayrollTransactionsByEmployee.Any(a => a.Value != null))
                {
                    foreach (var va in timePayrollTransactionsByEmployee.Values)
                    {
                        foreach (var tr in va.Where(w => !w.AccountInternals.IsNullOrEmpty()))
                        {
                            accountIds.AddRange(tr.AccountInternals.Select(s => s.AccountId));
                        }
                    }
                }

                //TimePayrollScheduleTransaction AccountStdId
                if (timeScheduleTransactionsByEmployee.Any(a => a.Value != null))
                    accountIds.UnionWith(timeScheduleTransactionsByEmployee
                        .SelectMany(sm => sm.Value)
                        .Where(w => w.AccountId.HasValue)
                        .Select(s => s.AccountId.Value)
                        .Distinct());

                //TimePayrollScheduleTransaction AccountInternals
                if (timeScheduleTransactionsByEmployee.Any(a => a.Value != null))
                {
                    foreach (var va in timeScheduleTransactionsByEmployee.Values)
                    {
                        foreach (var tr in va.Where(w => !w.AccountInternals.IsNullOrEmpty()))
                        {
                            accountIds.UnionWith(tr.AccountInternals.Select(s => s.AccountId));
                        }
                    }
                }
            }
            else
            {
                //All
                accountIds.UnionWith(accounts.Select(s => s.AccountId));
            }

            foreach (var account in accounts.Where(w => accountIds.Contains(w.AccountId)))
            {
                result.Accounts.Add(new AccountInfo()
                {
                    AccountId = account.AccountId,
                    Nr = account.AccountNr,
                    Name = account.Name,
                    DimNr = account.AccountDim.AccountDimNr,
                    SieNr = account.AccountDim.SysSieDimNr ?? 0,
                    ParentId = account.ParentAccountId
                });
            }

            #endregion

            foreach (var employee in employees)
            {
                TimeScheduleEmployeeIO employeeResult = new TimeScheduleEmployeeIO(includeEmployeeNr ? employee.EmployeeNr : null,
                                                                                    includeEmployeeName ? employee.Name : null,
                                                                                    includeEmployeeExternalCode ? employee.ExternalCode : null);

                var timePayrollScheduleTransactionsForEmployee = timeScheduleTransactionsByEmployee.GetList(employee.EmployeeId);
                var timePayrollTransactionsForEmployee = timePayrollTransactionsByEmployee.GetList(employee.EmployeeId);
                var calenderInfoForEmployee = calenderInfoDict.GetList(employee.EmployeeId);

                DateTime currentDate = fromDate;
                while (currentDate <= toDate)
                {
                    #region ScheduleInfo for employee/date

                    var timePayrollScheduleTransactionsForEmployeeAndDate = timePayrollScheduleTransactionsForEmployee.Where(w => w.Date == currentDate).ToList();
                    if (timePayrollScheduleTransactionsForEmployeeAndDate.Any())
                    {
                        foreach (var transaction in timePayrollScheduleTransactionsForEmployeeAndDate.Where(t => t.StartTime != t.StopTime))
                        {
                            timeDeviationCausesDict.TryGetValue(transaction.TimeDeviationCauseId ?? 0, out TimeDeviationCause timeDeviationCause);

                            employeeResult.ScheduleInfos.Add(new ScheduleInfo()
                            {
                                EmployeeNr = includeEmployeeNr ? employee.EmployeeNr : null,
                                Date = transaction.Date,
                                StartTime = CalendarUtility.MergeDateAndDefaultTime(transaction.Date, transaction.StartTime),
                                StopTime = CalendarUtility.MergeDateAndDefaultTime(transaction.Date, transaction.StopTime),
                                IsBreak = transaction.IsBreak,
                                ShiftTypeId = transaction.ShiftTypeId ?? 0,
                                Quantity = transaction.Quantity,
                                CalculatedCost = transaction.GrossAmount,
                                PlannedAbsence = transaction.TimeDeviationCauseId.HasValue,
                                TimeScheduleBlockType = (TimeScheduleBlockType)((int)transaction.Type),
                                TimeDeviationCause = timeDeviationCause?.Name,
                                AccountInfoLinks = transaction.AccountInternals.Select(a => new AccountInfoLink() { AccountId = a.AccountId }).ToList(),
                                IsPreliminary = transaction.IsPreliminary ? true : (bool?)null
                            });
                        }
                    }

                    #endregion

                    #region PayrollInfo for employee/date

                    var timePayrollTransactionsForEmployeeAndDate = timePayrollTransactionsForEmployee.Where(w => w.Date == currentDate).OrderBy(t => t.StartTime).ThenBy(t => t.StopTime).ThenBy(t => t.PayrollProductId).ToList();
                    if (timePayrollTransactionsForEmployeeAndDate.Any())
                    {
                        foreach (var transaction in timePayrollTransactionsForEmployeeAndDate)
                        {
                            employeeResult.PayrollInfos.Add(new PayrollInfo()
                            {
                                EmployeeNr = includeEmployeeNr ? employee.EmployeeNr : null,
                                Date = transaction.Date.Value,
                                StartTime = CalendarUtility.MergeDateAndDefaultTime(transaction.Date.Value, transaction.TimeCodeTransactionStartTime ?? transaction.StartTime),
                                StopTime = CalendarUtility.MergeDateAndDefaultTime(transaction.Date.Value, transaction.TimeCodeTransactionStopTime ?? transaction.StopTime),
                                Quantity = transaction.Quantity,
                                Amount = transaction.Amount,
                                Productid = transaction.PayrollProductId,
                                AttestStateId = transaction.AttestStateId,
                                AccountInfoLinks = transaction.AccountInternals.Select(a => new AccountInfoLink() { AccountId = a.AccountId }).ToList()
                            });
                        }
                    }

                    #endregion

                    #region CalendarInfo for employee/date

                    var calenderInfoForEmployeeAndDate = calenderInfoForEmployee.FirstOrDefault(w => w.Date == currentDate);
                    if (calenderInfoForEmployeeAndDate != null)
                        employeeResult.CalenderInfos.Add(calenderInfoForEmployeeAndDate);

                    #endregion

                    currentDate = currentDate.AddDays(1);
                }

                result.TimeScheduleEmployees.Add(employeeResult);
            }

            result.StartDate = fromDate;
            result.StopDate = toDate;

            return result;
        }

        #endregion

        #region EmployeeActiveSchedule

        public ActionResult SaveEmployeeActiveScheduleIOs(int actorCompanyId, List<EmployeeActiveScheduleIO> employeeActiveSchedules)
        {
            TimeEngineManager timeEngineManager = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);

            return ApiManager.ExecuteWithApiLogging(
                actorCompanyId,
                SoeEntityType.Employee,
                TermGroup_ApiMessageType.ActiveSchedule,
                TermGroup_ApiMessageSourceType.API,
                () => timeEngineManager.EmployeeActiveScheduleImport(employeeActiveSchedules),
                employeeActiveSchedules,
                employeeActiveSchedules.Count
            );
        }

        #endregion

        #region AccountHierarchyTree

        public AccountHierarchyTreeDTO GetAccountHierarchyTree(int actorCompanyId, bool loadEmployees = true)
        {
            AccountHierarchyTreeDTO accountHierarchyTreeDTO = new AccountHierarchyTreeDTO();
            if (!FeatureManager.HasRolePermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_Categories, Permission.Modify, parameterObject.RoleId, actorCompanyId))
                return accountHierarchyTreeDTO;


            List<AttestRoleUser> attestRoleUsers = AttestManager.GetAttestRoleUsersByCompany(actorCompanyId, DateTime.Today, true, true);
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, active: null);
            List<Account> accounts = AccountManager.GetAccountsByCompany(actorCompanyId, onlyInternal: true, loadAccountDim: true, loadAccountMapping: true);
            Dictionary<int, List<AttestRoleUser>> attestRoleUsersDict = attestRoleUsers.GroupBy(g => g.UserId).ToDictionary(a => a.Key, c => c.ToList());
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<EmployeeAccount> employeeAccounts = EmployeeManager.GetEmployeeAccounts(entitiesReadOnly, actorCompanyId);
            Dictionary<int, List<EmployeeAccount>> employeeAccountsDict = employeeAccounts.GroupBy(g => g.EmployeeId).ToDictionary(a => a.Key, c => c.ToList());



            foreach (var account in accounts)
            {
                AccountHierarchyInfo accountHierarchy = new AccountHierarchyInfo()
                {
                    AccountId = account.AccountId,
                    Nr = account.AccountNr,
                    Name = account.Name,
                    DimNr = account.AccountDim.AccountDimNr,
                    SieNr = account.AccountDim.SysSieDimNr ?? 0,
                    ParentId = account.ParentAccountId
                };

                if (loadEmployees)
                {
                    foreach (var employee in employees)
                    {

                        var connectedToAccounts = EmployeeManager.GetHighestEmployeeAccountOnAccount(employeeAccountsDict.FirstOrDefault(w => w.Key == employee.EmployeeId).Value, account.AccountId, DateTime.Today);

                        if (!connectedToAccounts.IsNullOrEmpty())
                        {
                            foreach (var connectedToAccount in connectedToAccounts)
                            {
                                accountHierarchy.EmployeeAccountHierarchyLinks.Add(new EmployeeAccountHierarchyLink()
                                {
                                    EmployeeNr = employee.EmployeeNr,
                                    Name = employee.Name,
                                    SocialSec = employee.SocialSec,
                                    AffiliationInfoLinkType = AffiliationInfoLinkType.Employee
                                });
                            }
                        }

                        if (employee.UserId != null)
                        {
                            var attestRoleUsersOnUser = attestRoleUsersDict.FirstOrDefault(w => w.Key == employee.UserId.Value).Value?.Where(w => w.AccountId == account.AccountId).ToList();

                            if (!attestRoleUsersOnUser.IsNullOrEmpty())
                            {
                                foreach (var item in attestRoleUsersOnUser.Take(1))
                                {
                                    accountHierarchy.EmployeeAccountHierarchyLinks.Add(new EmployeeAccountHierarchyLink()
                                    {
                                        EmployeeNr = employee.EmployeeNr,
                                        Name = employee.Name,
                                        SocialSec = employee.SocialSec,
                                        AffiliationInfoLinkType = AffiliationInfoLinkType.Executive
                                    });
                                }
                            }
                        }
                    }
                }
                if (!loadEmployees || !accountHierarchy.EmployeeAccountHierarchyLinks.IsNullOrEmpty())
                    accountHierarchyTreeDTO.AccountHierarchyInfos.Add(accountHierarchy);

            }

            return accountHierarchyTreeDTO;
        }

        #endregion

        #region StaffingNeedsFrequency

        #region Import To StaffingNeedsFrequencyIO

        public ActionResult ImportStaffingNeedsFrequencyIO(StaffingNeedsFrequencyIOItem staffingNeedsFrequencyIOItem, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool importToStaffingNeedsFrequency, string additionalBatchInfo = "")
        {
            ActionResult result = null;
            List<StaffingNeedsFrequencyIO> ios = new List<StaffingNeedsFrequencyIO>();

            string batchId = additionalBatchInfo + GenerateBatchId();
            using (CompEntities entities = new CompEntities())
            {
                entities.CommandTimeout = (60 * 10);

                try
                {
                    foreach (var staffingNeedsFrequency in staffingNeedsFrequencyIOItem.frequencies)
                    {
                        StaffingNeedsFrequencyIO staffingNeedsFrequencyIO = CreateStaffingNeedsFrequencyIO(entities, headType, source, type, staffingNeedsFrequency, batchId, actorCompanyId);
                        ios.Add(staffingNeedsFrequencyIO);
                    }

                    //Save
                    result = BulkInsert(entities, ios);
                }
                catch (Exception e)
                {
                    base.LogError(e, this.log);
                    result = new ActionResult(e, "ImportStaffingNeedsFrequencyIO(StaffingNeedsFrequencyIOItem staffingNeedsFrequencyIOItem): ");
                }
            }

            if (result.Success && importToStaffingNeedsFrequency)
                result = ImportFromStaffingNeedsFrequencyIO(ios, actorCompanyId);

            result.StringValue = batchId;

            return result;
        }

        #endregion

        #region Import from StaffingNeedsFrequencyIO

        private ActionResult ImportFromStaffingNeedsFrequencyIO(List<StaffingNeedsFrequencyIO> ios, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            int ioCount = ios.Count;
            int transferedCount = 0;
            List<AccountDTO> accounts = AccountManager.GetAccountsInternalsByCompany(actorCompanyId, true, true, false).ToDTOs();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<AccountDimDTO> accountDimDTOs = base.GetAccountDimsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId));
            List<ShiftTypeDTO> shiftTypes = TimeScheduleManager.GetShiftTypes(actorCompanyId, loadAccountInternals: true, loadAccounts: true).ToDTOs(includeAccounts: true, setAccountInternalIds: true).ToList();
            List<StaffingNeedsLocationGroupDTO> staffingNeedsLocationGroups = TimeScheduleManager.GetStaffingNeedsLocationGroups(actorCompanyId, includeShiftTypes: true).ToDTOs(true).ToList();
            List<TimeScheduleTaskDTO> timeScheduleTasks = TimeScheduleManager.GetTimeScheduleTasks(actorCompanyId).ToDTOs(true).ToList();
            AccountDim dim = AccountManager.GetAccountDimBySieNr((int)TermGroup_SieAccountDim.CostCentre, actorCompanyId);
            int? staffingNeedsFrequencyAccountDim = SettingManager.GetNullableIntSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedsFrequencyAccountDim, 0, actorCompanyId, 0);
            int? staffingNeedsFrequencyParentAccountDim = SettingManager.GetNullableIntSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedsFrequencyParentAccountDim, 0, actorCompanyId, 0);

            if (staffingNeedsFrequencyAccountDim == 0)
                staffingNeedsFrequencyAccountDim = null;

            if (staffingNeedsFrequencyParentAccountDim == 0)
                staffingNeedsFrequencyParentAccountDim = null;

            if (staffingNeedsLocationGroups.Any() && dim != null)
            {
                foreach (var item in staffingNeedsLocationGroups)
                {
                    var codes = item.GetExternalCodes();

                    foreach (var externalCode in codes)
                    {
                        if (!string.IsNullOrEmpty(externalCode))
                        {
                            int? accountId = item.GetAccountId(shiftTypes, timeScheduleTasks, dim.AccountDimNr);
                            if (accountId.HasValue)
                            {
                                var account = accounts.FirstOrDefault(w => w.AccountId == accountId);
                                if (account != null)
                                {
                                    var clone = account.CloneDTO();
                                    clone.ExternalCode = externalCode;
                                    accounts.Add(clone);
                                }
                            }
                        }
                    }
                }
            }

            foreach (var account in accounts)
                account.ExternalCode = !string.IsNullOrEmpty(account.ExternalCode) ? account.ExternalCode.ToLower() : string.Empty;

            #region Prereq

            if (ios == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "StaffingNeedsFrequencyIO");

            // Company
            this.company = CompanyManager.GetCompany(actorCompanyId, true);
            if (this.company == null || this.company.License == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

            // Make sure Actor (Company) is loaded
            if (!this.company.ActorReference.IsLoaded)
                this.company.ActorReference.Load();


            this.rowNr = 0;

            #endregion

            #region Validate

            foreach (var item in ios)
            {
                ActionResult validate = ValidateStaffingNeedsFrequencyIO(item, ios);
                if (!validate.Success)
                {
                    return result;
                }
            }

            #endregion

            #region Existing


            Dictionary<string, List<StaffingNeedsFrequency>> existingInDateRange = new Dictionary<string, List<StaffingNeedsFrequency>>();

            try
            {
                ios = ios.OrderBy(o => CalendarUtility.GetDateTime(o.DateFrom)).ToList();
                var from = CalendarUtility.GetDateTime(ios.First().DateFrom);
                var to = CalendarUtility.GetEndOfDay(CalendarUtility.GetDateTime(ios.Last().DateTo));
                using (CompEntities entities = new CompEntities())
                {
                    entities.CommandTimeout = (60 * 10);
                    var existingFreqInDateRange = TimeScheduleManager.GetStaffingNeedsFrequencys(entities, actorCompanyId, from, to);

                    foreach (var item in existingFreqInDateRange.GroupBy(g => g.CompareKeyWithValues))
                        existingInDateRange.Add(item.Key, null);
                }
            }
            catch (Exception ex)
            {
                LogError(ex, this.log);
            }

            #endregion

            bool updateStaffingNeedsFrequencyId = ios.Count < 100000;

            #region GetInterval

            int interval = 0;

            if (ios.FirstOrDefault() != null && !string.IsNullOrEmpty(ios.FirstOrDefault().TimeFrom) && !string.IsNullOrEmpty(ios.FirstOrDefault().TimeTo))
            {
                DateTime from = CalendarUtility.GetDateTime(ios.FirstOrDefault().TimeFrom);
                DateTime to = CalendarUtility.GetDateTime(ios.FirstOrDefault().TimeTo);
                DateTime dateto = CalendarUtility.GetDateTime(ios.FirstOrDefault().DateTo);

                if (from != to && dateto > DateTime.Now.AddYears(-10))
                {
                    var totalMinutes = Math.Abs((to - from).TotalMinutes);

                    if (totalMinutes > 0 && totalMinutes < 120)
                        interval = Convert.ToInt32(totalMinutes);
                }
            }

            if (interval == 0)
            {
                DateTime? previousTime = null;
                List<double> minutes = new List<double>();

                foreach (var item in ios.OrderBy(i => i.DateFrom + i.TimeFrom).Take(100))
                {
                    var time = GetTimeFromDateTime(item.DateFrom, item.TimeFrom);

                    if (previousTime.HasValue)
                        minutes.Add(Math.Abs((time - previousTime.Value).TotalMinutes));

                    previousTime = time;
                }

                interval = minutes.Count > 1 ? Convert.ToInt32(minutes[Convert.ToInt32(minutes.Count / 2)]) : 15;
            }

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                entities.CommandTimeout = (60 * 30);

                List<StaffingNeedsFrequency> frequencies = new List<StaffingNeedsFrequency>();

                foreach (StaffingNeedsFrequencyIO io in ios)
                {
                    ActionResult validate = ValidateStaffingNeedsFrequencyIO(io);

                    if (!validate.Success)
                    {
                        return validate;
                    }

                    var freq = CreateFromStaffingNeedsFrequencyIO(entities, io, actorCompanyId, interval, accounts, accountDimDTOs, staffingNeedsFrequencyAccountDim, staffingNeedsFrequencyParentAccountDim);
                    if (freq != null && !existingInDateRange.ContainsKey(freq.CompareKeyWithValues))
                        frequencies.Add(freq);
                }

                using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    try
                    {
                        #region Perform

                        result = BulkInsert(entities, frequencies);
                        if (!result.Success)
                            return result;
                        else if (updateStaffingNeedsFrequencyId)
                        {
                            #region Set id on io

                            foreach (var freq in frequencies)
                            {
                                if (freq.TempStaffingNeedsFrequencyIO != null)
                                {
                                    freq.TempStaffingNeedsFrequencyIO.StaffingNeedsFrequencyId = freq.StaffingNeedsFrequencyId;
                                    transferedCount++;
                                }
                            }

                            BulkUpdate(entities, ios);

                            #endregion
                        }

                        #endregion
                    }
                    catch (Exception e)
                    {
                        result = new ActionResult(e, GetText(5886, "Överföringen misslyckades: "));
                        base.LogError(e, this.log);
                    }
                    finally
                    {
                        entities.Connection.Close();
                        transaction.Complete();
                    }
                }
            }

            result.ErrorMessage = string.Format(GetText(8435, "{0} frekvensposter utav {1} har skapats/uppdaterats eller var redan uppdaterade."), ioCount, ioCount);
            result.ObjectsAffected = transferedCount;
            return result;
        }

        private StaffingNeedsFrequency CreateFromStaffingNeedsFrequencyIO(CompEntities entities, StaffingNeedsFrequencyIO io, int actorCompanyId, int interval, List<AccountDTO> accounts, List<AccountDimDTO> accountDimDTOs, int? staffingNeedsFrequencyAccountDim, int? staffingNeedsFrequencyParentAccountDim)
        {
            try
            {
                StaffingNeedsFrequency staffingNeedsFrequency = null;

                #region Init

                this.rowNr++;
                io.ErrorMessage = string.Empty;

                DateTime? timeFrom = null;
                DateTime? timeTo = null;

                #endregion

                #region Validation

                if (!ValidateStaffingNeedsFrequencyIO(io).Success)
                    return null;

                if (!string.IsNullOrEmpty(io.DateFrom))
                    timeFrom = GetTimeFromDateTime(io.DateFrom, io.TimeFrom);

                if (!string.IsNullOrEmpty(io.DateTo))
                    timeTo = GetTimeFromDateTime(io.DateTo, io.TimeTo);

                if (timeFrom.HasValue && !timeTo.HasValue && interval > 0)
                    timeTo = timeFrom.Value.AddMinutes(interval);

                if (!timeFrom.HasValue || !timeTo.HasValue)
                    return null;

                #endregion

                if (io.StaffingNeedsFrequencyId.HasValue && io.StaffingNeedsFrequencyId.Value > 0)
                    staffingNeedsFrequency = TimeScheduleManager.GetStaffingNeedsFrequency(entities, actorCompanyId, io.StaffingNeedsFrequencyId.Value);

                if (staffingNeedsFrequency == null)
                {
                    staffingNeedsFrequency = new StaffingNeedsFrequency();
                    staffingNeedsFrequency.ActorCompanyId = actorCompanyId;
                    staffingNeedsFrequency.Created = DateTime.Now;

                    entities.StaffingNeedsFrequency.AddObject(staffingNeedsFrequency);
                }
                else
                {
                    staffingNeedsFrequency.Modified = DateTime.Now;
                }

                #region Populate fields

                staffingNeedsFrequency.TimeFrom = timeFrom.Value;
                staffingNeedsFrequency.TimeTo = timeTo.Value;
                staffingNeedsFrequency.NbrOfCustomers = decimal.Round(io.NbrOfCustomers, 2);
                staffingNeedsFrequency.NbrOfItems = decimal.Round(io.NbrOfItems, 2);
                staffingNeedsFrequency.Amount = decimal.Round(io.Amount, 2);
                staffingNeedsFrequency.ExternalCode = io.ExternalCode;
                staffingNeedsFrequency.TempStaffingNeedsFrequencyIO = io;
                staffingNeedsFrequency.FrequencyType = io.FrequencyType;
                staffingNeedsFrequency.NbrOfMinutes = io.NbrOfMinutes;
                staffingNeedsFrequency.Cost = decimal.Round(io.Cost, 2);

                #endregion

                #region Set ParentAccountId

                AccountDTO parentAccount = null;

                if (!string.IsNullOrEmpty(io.ParentExternalCode) && staffingNeedsFrequencyParentAccountDim != int.MaxValue)
                {
                    staffingNeedsFrequency.ParentExternalCode = io.ParentExternalCode;
                    parentAccount = accounts.FirstOrDefault(w => (!staffingNeedsFrequencyParentAccountDim.HasValue || w.AccountDimId == staffingNeedsFrequencyParentAccountDim.Value) && w.ExternalCode.Equals(io.ParentExternalCode, StringComparison.OrdinalIgnoreCase));

                    if (parentAccount != null)
                        staffingNeedsFrequency.ParentAccountId = parentAccount.AccountId;
                    else
                    {
                        parentAccount = accounts.FirstOrDefault(w => (!staffingNeedsFrequencyParentAccountDim.HasValue || w.AccountDimId == staffingNeedsFrequencyParentAccountDim.Value) && w.AccountNr.Equals(io.ParentExternalCode, StringComparison.OrdinalIgnoreCase));

                        if (parentAccount != null)
                            staffingNeedsFrequency.ParentAccountId = parentAccount.AccountId;
                    }
                }

                #endregion

                #region Set AccountId

                if (!string.IsNullOrEmpty(io.ExternalCode) && staffingNeedsFrequencyAccountDim != int.MaxValue)
                {
                    AccountDTO account = null;

                    var accountsMatching = accounts.Where(w => (!staffingNeedsFrequencyAccountDim.HasValue || w.AccountDimId == staffingNeedsFrequencyAccountDim.Value) && w.ExternalCode.Equals(io.ExternalCode.ToLower(), StringComparison.OrdinalIgnoreCase)).ToList();

                    if (!accountsMatching.IsNullOrEmpty() && accountsMatching.Count == 1)
                        account = accountsMatching.First();
                    else if (parentAccount != null && accountsMatching.Any(a => a.AccountId == parentAccount.AccountId))
                        account = parentAccount;

                    if (account == null)
                        account = accounts.FirstOrDefault(w => (!staffingNeedsFrequencyAccountDim.HasValue || w.AccountDimId == staffingNeedsFrequencyAccountDim.Value) && w.AccountNr.Equals(io.ExternalCode, StringComparison.OrdinalIgnoreCase));

                    if (account == null)
                        account = accounts.FirstOrDefault(w => (!staffingNeedsFrequencyAccountDim.HasValue || w.AccountDimId == staffingNeedsFrequencyAccountDim.Value) && w.Name.Equals(io.ExternalCode, StringComparison.OrdinalIgnoreCase));

                    if (account != null)
                        staffingNeedsFrequency.AccountId = account.AccountId;

                }

                #endregion



                return staffingNeedsFrequency;
            }
            catch
            {
                return null;
            }

        }

        ActionResult ValidateStaffingNeedsFrequencyIO(StaffingNeedsFrequencyIO io, List<StaffingNeedsFrequencyIO> ios = null)
        {
            ActionResult result = new ActionResult();
            DateTime? timeFrom = null;
            DateTime? timeTo = null;
            int interval = 1;

            #region GetInterval

            DateTime? previousTime = null;
            List<double> minutes = new List<double>();

            if (ios != null)
            {
                var take = ios.Take(5);

                foreach (var item in take)
                {
                    var time = GetTimeFromDateTime(item.DateFrom, item.TimeFrom);

                    if (previousTime.HasValue)
                        minutes.Add(Math.Abs((time - previousTime.Value).TotalMinutes));

                    previousTime = time;
                }

                interval = minutes.Count > 1 ? Convert.ToInt32(minutes[Convert.ToInt32(minutes.Count / 2)]) : 15;
            }


            #endregion

            if (!string.IsNullOrEmpty(io.DateFrom))
                timeFrom = GetTimeFromDateTime(io.DateFrom, io.TimeFrom);

            if (!string.IsNullOrEmpty(io.DateTo))
                timeTo = GetTimeFromDateTime(io.DateTo, io.TimeTo);

            if (timeFrom.HasValue && !timeTo.HasValue && interval > 0)
                timeTo = timeFrom.Value.AddMinutes(interval);

            if (!timeFrom.HasValue || !timeTo.HasValue)
            {
                result = new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8437, "Tid kunde inte skapas"));
                return result;
            }

            return result;
        }

        private DateTime GetTimeFromDateTime(string dateString, string timeString)
        {
            if (string.IsNullOrEmpty(dateString))
                return CalendarUtility.DATETIME_DEFAULT;

            DateTime? date = CalendarUtility.GetNullableDateTime(dateString);
            if (!date.HasValue)
                return CalendarUtility.DATETIME_DEFAULT;

            var time = CalendarUtility.GetNullableDateTime(date);

            if (time.HasValue && time.Value.Date != time.Value)
            {
                return CalendarUtility.ApplyTimeOnDateTime(date.Value, time.Value.Hour.ToString() + ":" + time.Value.Minute.ToString());
            }
            else if (!string.IsNullOrEmpty(timeString) && timeString.Count() == 4)
            {
                string hours = timeString.Substring(0, 2);
                string minutes = timeString.Substring(2, 2);
                return CalendarUtility.ApplyTimeOnDateTime(date.Value, hours + ":" + minutes);
            }
            else
            {
                var timeFromString = CalendarUtility.GetNullableDateTime(timeString);
                if (timeFromString.HasValue)
                    return CalendarUtility.MergeDateAndTime(date.Value, timeFromString);
            }

            return date.Value;
        }

        #endregion

        #region Help Methods

        private StaffingNeedsFrequencyIO CreateStaffingNeedsFrequencyIO(CompEntities entities, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, StaffingNeedsFrequencyIODTO staffingNeedsFrequencyIODTO, string batchId, int actorCompanyId)
        {
            #region Prereq

            StaffingNeedsFrequencyIO io = new StaffingNeedsFrequencyIO()
            {
                ActorCompanyId = actorCompanyId,
                Source = (int)source,
                Type = (int)type,
                Status = (int)TermGroup_IOStatus.Unprocessed,
                Import = true,
                BatchId = batchId,
                ImportHeadType = (int)headType,

            };
            SetCreatedProperties(io);
            entities.StaffingNeedsFrequencyIO.AddObject(io);

            #endregion

            #region Perform

            if (staffingNeedsFrequencyIODTO != null)
            {
                try
                {
                    #region Fill SstaffingNeedsFrequencyIO

                    io.DateFrom = staffingNeedsFrequencyIODTO.DateFrom;
                    io.TimeFrom = staffingNeedsFrequencyIODTO.TimeFrom;
                    io.DateTo = staffingNeedsFrequencyIODTO.DateTo;
                    io.TimeTo = staffingNeedsFrequencyIODTO.TimeTo;
                    io.NbrOfItems = staffingNeedsFrequencyIODTO.NbrOfItems;
                    io.NbrOfCustomers = staffingNeedsFrequencyIODTO.NbrOfCustomers;
                    io.Amount = staffingNeedsFrequencyIODTO.Amount;
                    io.ExternalCode = staffingNeedsFrequencyIODTO.ExternalCode;
                    io.ParentExternalCode = staffingNeedsFrequencyIODTO.ParentExternalCode;
                    io.FrequencyType = (int)staffingNeedsFrequencyIODTO.FrequencyType;
                    io.Status = (int)TermGroup_IOStatus.UnderProcessing;
                    io.NbrOfMinutes = Convert.ToInt32(Decimal.Round(staffingNeedsFrequencyIODTO.NbrOfMinutes, 0));
                    io.Cost = staffingNeedsFrequencyIODTO.Cost;
                    io.Created = DateTime.Now;

                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    io.Status = (int)TermGroup_IOStatus.Error;
                    io.ErrorMessage = GetText(8383, "Okänt fel, kunde inte spara all rådata");
                }
            }

            #endregion

            return io;
        }

        public ActionResult TryToSetAccountidOnStaffingneedsFrequency(List<int> actorCompanyIds)
        {
            try
            {
                using (CompEntities entities = new CompEntities())
                {
                    List<StaffingNeedsFrequency> updated = new List<StaffingNeedsFrequency>();



                    foreach (var actorCompanyId in actorCompanyIds)
                    {
                        entities.CommandTimeout = 400;

                        var accounts = AccountManager.GetAccountInternals(entities, actorCompanyId, true);
                        accounts = accounts.Where(w => !string.IsNullOrEmpty(w.Account.ExternalCode)).ToList();

                        if (accounts.IsNullOrEmpty())
                            continue;

                        var staffingNeedsFrequencyAccountDim = SettingManager.GetNullableIntSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedsFrequencyAccountDim, 0, actorCompanyId, 0);
                        var staffingNeedsFrequencyParentAccountDim = SettingManager.GetNullableIntSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedsFrequencyParentAccountDim, 0, actorCompanyId, 0);

                        if (staffingNeedsFrequencyAccountDim == 0)
                            staffingNeedsFrequencyAccountDim = null;

                        if (staffingNeedsFrequencyParentAccountDim == 0)
                            staffingNeedsFrequencyParentAccountDim = null;

                        List<string> externalCodesOnAccounts = accounts.Select(s => s.Account.ExternalCode.ToLower()).Distinct().ToList();
                        var freqMissingAccountIds = entities.StaffingNeedsFrequency.Where(w => !string.IsNullOrEmpty(w.ExternalCode) && w.ExternalCode.Length > 0 && !w.AccountId.HasValue && w.ActorCompanyId == actorCompanyId && externalCodesOnAccounts.Contains(w.ExternalCode.ToLower())).Select(s => s.StaffingNeedsFrequencyId).ToList();

                        if (freqMissingAccountIds.IsNullOrEmpty())
                            continue;

                        var filteredAccounts = accounts.Where(w => !staffingNeedsFrequencyAccountDim.HasValue || w.Account.AccountDimId == staffingNeedsFrequencyAccountDim.Value).ToList();

                        while (freqMissingAccountIds.Any())
                        {
                            var batch = freqMissingAccountIds.Take(20000);
                            freqMissingAccountIds = freqMissingAccountIds.Skip(20000).ToList();
                            var freqMissingAccountId = entities.StaffingNeedsFrequency.Where(w => batch.Contains(w.StaffingNeedsFrequencyId)).ToList();

                            var groupedByCode = freqMissingAccountId.GroupBy(g => g.ExternalCode);

                            foreach (var group in groupedByCode)
                            {
                                var externalCode = group.Key;

                                if (!string.IsNullOrEmpty(externalCode))
                                {
                                    var account = filteredAccounts.FirstOrDefault(w => w.Account.ExternalCode.Equals(externalCode, StringComparison.OrdinalIgnoreCase));
                                    if (account != null)
                                    {
                                        foreach (var item in group)
                                        {
                                            item.AccountId = account.AccountId;
                                            item.Modified = DateTime.Now;
                                            updated.Add(item);
                                        }
                                    }
                                }
                            }
                        }

                    }

                    foreach (var actorCompanyId in actorCompanyIds)
                    {
                        entities.CommandTimeout = 400;

                        var accounts = AccountManager.GetAccountInternals(entities, actorCompanyId, true);
                        accounts = accounts.Where(w => !string.IsNullOrEmpty(w.Account.ExternalCode)).ToList();

                        if (accounts.IsNullOrEmpty())
                            continue;

                        var staffingNeedsFrequencyAccountDim = SettingManager.GetNullableIntSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedsFrequencyAccountDim, 0, actorCompanyId, 0);
                        var staffingNeedsFrequencyParentAccountDim = SettingManager.GetNullableIntSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedsFrequencyParentAccountDim, 0, actorCompanyId, 0);

                        if (staffingNeedsFrequencyAccountDim == 0)
                            staffingNeedsFrequencyAccountDim = null;

                        if (staffingNeedsFrequencyParentAccountDim == 0)
                            staffingNeedsFrequencyParentAccountDim = null;

                        List<string> externalCodesOnAccounts = accounts.Select(s => s.Account.ExternalCode.ToLower()).Distinct().ToList();
                        List<string> numberOnAccounts = accounts.Select(s => s.Account.AccountNr.ToLower()).Distinct().ToList();

                        var freqMissingParentAccountIds = entities.StaffingNeedsFrequency.Where(w => !string.IsNullOrEmpty(w.ParentExternalCode) && w.ParentExternalCode.Length > 0 && !w.ParentAccountId.HasValue && w.ActorCompanyId == actorCompanyId && (externalCodesOnAccounts.Contains(w.ExternalCode.ToLower()) || numberOnAccounts.Contains(w.ExternalCode.ToLower()))).Select(s => s.StaffingNeedsFrequencyId).ToList();
                        if (freqMissingParentAccountIds.IsNullOrEmpty())
                            continue;

                        var filteredAccounts = accounts.Where(w => !staffingNeedsFrequencyParentAccountDim.HasValue || w.Account.AccountDimId == staffingNeedsFrequencyParentAccountDim.Value).ToList();


                        while (freqMissingParentAccountIds.Any())
                        {
                            var batch = freqMissingParentAccountIds.Take(20000);
                            freqMissingParentAccountIds = freqMissingParentAccountIds.Skip(20000).ToList();
                            var freqMissingAccountId = entities.StaffingNeedsFrequency.Where(w => batch.Contains(w.StaffingNeedsFrequencyId)).ToList();

                            var groupedByCode = freqMissingAccountId.GroupBy(g => g.ExternalCode);

                            foreach (var group in groupedByCode)
                            {
                                var externalCode = group.Key;

                                if (!string.IsNullOrEmpty(externalCode))
                                {
                                    var account = filteredAccounts.FirstOrDefault(w => w.Account.ExternalCode.Equals(externalCode, StringComparison.OrdinalIgnoreCase));
                                    if (account != null)
                                    {
                                        foreach (var item in group)
                                        {
                                            item.ParentAccountId = account.AccountId;
                                            item.Modified = DateTime.Now;
                                            updated.Add(item);
                                        }
                                    }
                                }
                            }
                        }

                    }

                    return BulkUpdate(entities, updated);
                }
            }
            catch (Exception ex)
            {
                LogError(ex, this.log);
                return new ActionResult(ex);
            }

        }

        #region ICA

        public ActionResult ImportStoreDataFromFromAPI(List<int> actorCompanyIds, out List<int> fetched)
        {
            fetched = new List<int>();
            try
            {
                ActionResult result = new ActionResult();
                StringBuilder sb = new StringBuilder();
                var user = SoftOne.Common.KeyVault.KeyVaultSecretsFetcher.GetSecret("ICAStoreDataUser");
                var password = SoftOne.Common.KeyVault.KeyVaultSecretsFetcher.GetSecret("ICAStoreDataPassword");
                var endpoint = SoftOne.Common.KeyVault.KeyVaultSecretsFetcher.GetSecret("ICAStoreDataEndpoint");
                var tokenEndpoint = SoftOne.Common.KeyVault.KeyVaultSecretsFetcher.GetSecret("ICAStoreDataTokenEndpoint");
                var dict = GetStoreDataFromApi(actorCompanyIds, user, password, endpoint, tokenEndpoint);

                foreach (var keyvaluepair in dict)
                {
                    try
                    {
                        var company = CompanyManager.GetCompany(keyvaluepair.Key);
                        if (company == null)
                        {
                            sb.AppendLine($"Company not found {keyvaluepair.Key}");
                            continue;
                        }

                        fetched.Add(keyvaluepair.Key);
                        sb.AppendLine($"ApiImport {DateTime.Now} " + keyvaluepair.Key + " " + company.Name + " " + company.OrgNr);
                        StaffingNeedsFrequencyIOItem staffingNeedsFrequencyIOItem = new StaffingNeedsFrequencyIOItem();
                        staffingNeedsFrequencyIOItem.frequencies = keyvaluepair.Value;
                        ActionResult importResult = ImportStaffingNeedsFrequencyIO(staffingNeedsFrequencyIOItem, TermGroup_IOImportHeadType.StaffingNeedsFrequency, TermGroup_IOSource.Connect, TermGroup_IOType.WebAPI, keyvaluepair.Key, true, "Api-");

                        if (!result.Success)
                        {
                            if (string.IsNullOrEmpty(result.ErrorMessage))
                                result.ErrorMessage = string.Empty;
                            result.ErrorMessage = result.ErrorMessage + sb.ToString();
                            LogError($"ImportStoreDataFromApi failed actorcompanyId {keyvaluepair.Key} {company.Name} file {result.ErrorMessage}");
                            sb.AppendLine($"ImportStoreDataFromApi failed actorcompanyId {keyvaluepair.Key} {company.Name} file {result.ErrorMessage}");
                            continue;
                        }

                        LogInfo("ImportStoreDataFromApi " + sb.ToString());
                    }
                    catch (Exception ex)
                    {
                        sb.Append(ex.ToString());
                        LogError(ex.ToString() + sb.ToString());
                    }
                }

                result.ErrorMessage = sb.ToString();
                return result;
            }
            catch (Exception ex)
            {
                LogError(ex, this.log);
                return new ActionResult(ex);
            }
        }

        public ActionResult ImportStoreDataFromSftp(List<int> actorCompanyIds)
        {
            ActionResult result = new ActionResult();
            StringBuilder sb = new StringBuilder();

            var data = GetStoreDataFromSftp(actorCompanyIds);

            foreach (var item in data)
            {
                try
                {
                    sb.Append($"XEConnectImport {DateTime.Now} " + item.Item1 + " " + $"{item.Item2}");
                    result = XEConnectImport(item.Item1, 0, 0, 0, new List<byte[]>() { item.Item3 }, false, 9, 7, true);

                    if (!result.Success)
                    {
                        if (string.IsNullOrEmpty(result.ErrorMessage))
                            result.ErrorMessage = string.Empty;
                        result.ErrorMessage = result.ErrorMessage + sb.ToString();
                        LogError($"ImportStoreDataFromSftp failed actorcompanyId {item.Item1} file {item.Item2} {result.ErrorMessage}");
                        sb.Append($"ImportStaffingNeedsFrequencyIO failed {item.Item1} {item.Item2}" + Environment.NewLine);
                        continue;
                    }
                    else
                    {
                        SshUtil sshUtil = new SshUtil(true);
                        sb.Append(Environment.NewLine);
                        sb.Append($"Upload {DateTime.Now} " + item.Item1 + " " + $"ICA_Transferred /{item.Item2}");
                        if (sshUtil.Upload(item.Item3, $@"ICA_Transferred/{item.Item2}").Success)
                        {
                            sb.Append(Environment.NewLine);
                            sb.Append($"Delete {DateTime.Now} " + item.Item1 + " " + $"ICA/StoreData/{item.Item2}");
                            var path = $@"ICA/StoreData/{item.Item2}";
                            sshUtil.Delete(path);
                        }
                    }

                    LogInfo("ImportStoreDataFromSftp " + sb.ToString());
                }
                catch (Exception ex)
                {
                    sb.Append(ex.ToString());
                    LogError(ex.ToString() + sb.ToString());
                }

            }

            result.ErrorMessage = sb.ToString();
            return result;
        }

        /// <summary>
        /// WFM_ICA_SalesData_BI_'||RTRIM(BU_CODE)||'_'||TO_CHAR(SESSSTARTTIME,'YYYYMMDD_HH24MISS')||'.txt.
        /// Där '||RTRIM(BU_CODE)||' = STORE_ID och '||TO_CHAR(SESSSTARTTIME,'YYYYMMDD_HH24MISS')||' innehåller en tidsstämpel ex 20170101_130101.
        /// Så en fil för butik 12345 skulle heta:
        /// WFM_ICA_SalesData_BI_12345_20170101_130101.txt
        /// </summary>
        /// <param name="actorCompanyIds"></param>
        /// <returns></returns>
        private List<Tuple<int, string, byte[]>> GetStoreDataFromSftp(List<int> actorCompanyIds)
        {
            var tuple = new List<Tuple<int, string, byte[]>>();

            try
            {
                string path = @"ICA/StoreData/";

                SshUtil sshUtil = new SshUtil(true);
                var list = sshUtil.ListFiles(path);

                foreach (var actorCompanyId in actorCompanyIds)
                {
                    Company company = CompanyManager.GetCompany(actorCompanyId);
                    if (company == null)
                        continue;
                    if (company.CompanyNr.ToString().Length < 3)
                        continue;

                    // Try to get the right files 
                    var companylist = list.Where(l => l.Name.Contains(company.CompanyNr.ToString() + "_2"));
                    foreach (var post in companylist)
                    {
                        var data = sshUtil.DownLoad(post.FullName, false);
                        if (data != null)
                            tuple.Add(Tuple.Create(actorCompanyId, post.Name, data));
                    }
                }
            }
            catch (Exception ex)
            {
                LogError(ex, this.log);
            }

            return tuple;
        }

        private Dictionary<int, List<StaffingNeedsFrequencyIODTO>> GetStoreDataFromApi(List<int> actorCompanyIds, string user, string password, string endpoint, string tokenEndpoint)
        {
            var dict = new Dictionary<int, List<StaffingNeedsFrequencyIODTO>>();
            foreach (var actorCompanyId in actorCompanyIds)
            {
                try
                {
                    Company company = CompanyManager.GetCompany(actorCompanyId);
                    if (company?.CompanyNr == null)
                        continue;
                    if (company.CompanyNr.ToString().Length < 3)
                        continue;

                    LogInfo($"GetStoreDataFromApi {DateTime.Now} {actorCompanyId} {company?.Name} {company?.LicenseId}");

                    using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                    var last = entitiesReadOnly.StaffingNeedsFrequency.OrderByDescending(f => f.TimeFrom).FirstOrDefault(f => f.FrequencyType == (int)FrequencyType.Actual && f.ActorCompanyId == actorCompanyId);

                    DateTime from = last?.TimeFrom.Date.AddDays(-3) ?? DateTime.Today.AddDays(-3);

                    if (from < DateTime.Today.AddDays(-10))
                        from = DateTime.Today.AddDays(-10);

                    var settings = new List<ScheduledJobSettingDTO>();
                    settings.Add(new ScheduledJobSettingDTO() { Type = TermGroup_ScheduledJobSettingType.BridgeSetupAddress, DataType = SettingDataType.String, StrData = endpoint });
                    settings.Add(new ScheduledJobSettingDTO() { Type = TermGroup_ScheduledJobSettingType.BridgeCredentialUser, DataType = SettingDataType.String, StrData = user });
                    settings.Add(new ScheduledJobSettingDTO() { Type = TermGroup_ScheduledJobSettingType.BridgeCredentialSecret, DataType = SettingDataType.String, StrData = password });
                    settings.Add(new ScheduledJobSettingDTO() { Type = TermGroup_ScheduledJobSettingType.BridgeCredentialTenent, DataType = SettingDataType.String, StrData = company.CompanyNr.ToString() });
                    settings.Add(new ScheduledJobSettingDTO() { Type = TermGroup_ScheduledJobSettingType.BridgeCredentialTokenEndPoint, DataType = SettingDataType.String, StrData = tokenEndpoint });
                    var frequencies = BridgeManager.GetICAStoreDataFrequencies(actorCompanyId, settings, from, DateTime.Today);

                    if (frequencies.IsNullOrEmpty())
                    {
                        var nrSetting = settings.FirstOrDefault(f => f.Equals(TermGroup_ScheduledJobSettingType.BridgeCredentialTenent));
                        if (nrSetting != null)
                        {
                            try
                            {
                                nrSetting.StrData = StringUtility.FillWithZerosBeginning(4, company.CompanyNr.ToString(), true);
                                frequencies = BridgeManager.GetICAStoreDataFrequencies(actorCompanyId, settings, from, DateTime.Today);
                            }
                            catch (Exception ex)
                            {
                                LogError(new Exception($"GetStoreDataFromApi retry failed on company {DateTime.Now} {actorCompanyId} {company?.Name} {company?.LicenseId}", ex), this.log);
                            }
                        }
                    }

                    if (!frequencies.IsNullOrEmpty())
                        dict.Add(actorCompanyId, frequencies);
                    else
                        LogWarning($"GetStoreDataFromApi {DateTime.Now} {actorCompanyId} {company?.Name} {company?.LicenseId} No data fetched, frequences is null or empty");
                }

                catch (Exception ex)
                {
                    LogError(ex, this.log);
                }
            }

            return dict;
        }

        #endregion

        public ActionResult RemoveDuplicatesFromStaffingNeedFrequencyTables()
        {
            string message = string.Empty;
            try
            {
                using (CompEntities entities = new CompEntities())
                {
                    entities.CommandTimeout = (60 * 30);
                    int rowsAffected = FrownedUponSQLClient.ExecuteSql(entities, @"with cte (actorcompanyid, TimeFrom, TimeTo, ExternalCode, ParentExternalCode, NbrOfItems, FrequencyType, NbrOfCustomers, Amount, Cost, NBrOfMinutes,  rn) as ( 
                                                                    select actorcompanyid, TimeFrom, TimeTo, ExternalCode, ParentExternalCode, NbrOfItems, FrequencyType, NbrOfCustomers, Amount, Cost, NBrOfMinutes,  
                                                                    row_number() over (partition by actorcompanyid, TimeFrom, TimeTo, ExternalCode, ParentExternalCode, NbrOfItems, FrequencyType, NbrOfCustomers, Amount, Cost, NBrOfMinutes
                                                                    order by StaffingNeedsFrequencyIOId desc) as [rn] 
                                                                    from StaffingNeedsFrequencyIO)
                                                                        delete from cte where rn>1", 600);
                    message = $"{DateTime.Now} Removed duplicate IOs {rowsAffected} rows affected ";

                    rowsAffected = FrownedUponSQLClient.ExecuteSql(entities, @"with cte (actorcompanyid, TimeFrom, TimeTo, accountid, ExternalCode, ParentExternalCode, NbrOfItems, FrequencyType, NbrOfCustomers,Amount, Cost, NBrOfMinutes,  rn) as ( 
                                                                      select actorcompanyid, TimeFrom, TimeTo, accountid, ExternalCode, ParentExternalCode, NbrOfItems, FrequencyType, NbrOfCustomers, Amount, Cost, NBrOfMinutes,  
                                                                      row_number() over (partition by actorcompanyid, TimeFrom, TimeTo, accountid, ExternalCode, ParentExternalCode, NbrOfItems, FrequencyType, NbrOfCustomers, Amount, Cost, NBrOfMinutes 
                                                                      order by TimeFrom, TimeTo) as [rn] 
                                                                      from StaffingNeedsFrequency)
                                                                        delete from cte where rn>1", 600);

                    message += Environment.NewLine + $"{DateTime.Now} Removed duplicate freqs {rowsAffected} rows affected ";
                    return new ActionResult(message);
                }
            }
            catch (Exception ex)
            {
                return new ActionResult(ex);
            }
        }

        #region CompanyInformation

        public Company GetCompany(CompanyTimeInformationRequestKey requestKey, out CompanyTimeInformationDTO companyTimeInformation)
        {
            companyTimeInformation = new CompanyTimeInformationDTO();
            var key = requestKey.MainKey;

            if (string.IsNullOrEmpty(key) || key.Length < 3)
            {
                companyTimeInformation.Message = "Key not valid string " + key;
                return null;
            }

            if (!int.TryParse(key, out int value))
            {
                companyTimeInformation.Message = "Key not valid integer " + key;
                return null;
            }

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var companies = entitiesReadOnly.Company.Where(w => w.CompanyNr.HasValue && w.CompanyNr.Value == value).ToList();

            if (companies.Count > 1)
            {
                companyTimeInformation.Message = "Key not unique enough " + key;
                return null;
            }

            if (!companies.Any())
            {
                companyTimeInformation.Message = "Company not found " + key;
                return null;
            }

            var company = CompanyManager.GetCompany(companies.First().ActorCompanyId);

            if (company != null)
            {
                var controlKey = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.ExternalLink3, 0, company.ActorCompanyId, 0);

                if (string.IsNullOrEmpty(controlKey))
                {
                    companyTimeInformation.Message = "controlKey not found " + key;
                    return null;
                }
                else
                {
                    if (!controlKey.Trim().ToLower().Equals(requestKey.ControlKey.Trim().ToLower(), StringComparison.OrdinalIgnoreCase))
                    {
                        companyTimeInformation.Message = "controlKey not found " + key;
                        return null;
                    }
                    return company;
                }
            }

            return null;
        }

        public CompanyTimeInformationDTO GetCompanyTimeInformation(CompanyTimeInformationRequest request)
        {
            Company company = GetCompany(request.Keys.First(), out CompanyTimeInformationDTO dto);
            if (company == null)
                return dto;

            DateTime fromDate = DateTime.Now.AddDays(-request.DaysOfHistory).Date;
            DateTime toDate = DateTime.Now.Date.AddDays(-1);

            try
            {
                Directory.CreateDirectory(ConfigSettings.SOE_SERVER_DIR_TEMP_REPORT_PHYSICAL + Guid.NewGuid().ToString());
                List<Employee> employees = EmployeeManager.GetAllEmployees(company.ActorCompanyId, null, loadEmployment: true);
                List<PayrollProduct> payrollProducts = ProductManager.GetPayrollProducts(company.ActorCompanyId, null);

                var timePayrollTransactionDTOs = TimeTransactionManager.GetTimePayrollTransactionDTOForReport(fromDate, toDate, employees.Select(s => s.EmployeeId).ToList(), company.ActorCompanyId);
                if (request.CalculateCost)
                {
                    List<PayrollGroup> payrollGroups = PayrollManager.GetPayrollGroups(company.ActorCompanyId, loadExternalCode: true);
                    timePayrollTransactionDTOs = TimeTransactionManager.AddAmounts(company.ActorCompanyId, timePayrollTransactionDTOs, employees, payrollGroups);
                }
                DateTime currentDate = fromDate;
                var allTransactions = timePayrollTransactionDTOs.SelectMany(s => s.Value);

                while (currentDate < toDate)
                {
                    List<TimePayrollTransactionDTO> transactions = allTransactions.Where(t => t.Date == currentDate).ToList();
                    int netMinutes = transactions.Where(w => w.IsWorkTime()).Sum(s => Convert.ToInt32(s.Quantity));
                    int grossMinutes = 0;

                    foreach (var transactionsByProductId in transactions.Where(w => w.IsOBAddition()).GroupBy(g => g.PayrollProductId))
                    {
                        TimePayrollTransactionDTO transaction = transactionsByProductId.First();
                        PayrollProduct product = payrollProducts.FirstOrDefault(p => p.ProductId == transactionsByProductId.Key);

                        if (transaction.IsOBAddition100() || product?.Factor == 2)
                            grossMinutes += Convert.ToInt32(transactionsByProductId.Sum(s => s.Quantity));
                        else if (transaction.IsOBAddition113() || product?.Factor == new decimal(2.13))
                            grossMinutes += Convert.ToInt32(decimal.Multiply(transactionsByProductId.Sum(s => s.Quantity), new decimal(1.13)));
                        else if (transaction.IsOBAddition79() || product?.Factor == new decimal(1.79))
                            grossMinutes += Convert.ToInt32(decimal.Multiply(transactionsByProductId.Sum(s => s.Quantity), new decimal(0.79)));
                        else if (transaction.IsOBAddition70() || product?.Factor == new decimal(1.7))
                            grossMinutes += Convert.ToInt32(decimal.Multiply(transactionsByProductId.Sum(s => s.Quantity), new decimal(0.7)));
                        else if (transaction.IsOBAddition57() || product?.Factor == new decimal(1.57))
                            grossMinutes += Convert.ToInt32(decimal.Multiply(transactionsByProductId.Sum(s => s.Quantity), new decimal(0.57)));
                        else if (transaction.IsOBAddition50() || product?.Factor == new decimal(1.5))
                            grossMinutes += Convert.ToInt32(decimal.Multiply(transactionsByProductId.Sum(s => s.Quantity), new decimal(0.5)));
                        else if (transaction.IsOBAddition40() || product?.Factor == new decimal(1.4))
                            grossMinutes += Convert.ToInt32(decimal.Multiply(transactionsByProductId.Sum(s => s.Quantity), new decimal(0.4)));
                    }

                    dto.CompanyTimeInformationRows.Add(new CompanyTimeInformationRowDTO()
                    {
                        MainKey = request.Keys.First().MainKey,
                        Cost = request.CalculateCost ? transactions.Sum(s => s.Amount) : 0,
                        NetMinutes = netMinutes,
                        GrossMinutes = netMinutes + grossMinutes,
                        Date = currentDate,
                        Name = company.Name
                    });

                    currentDate = currentDate.AddDays(1);
                }

            }
            catch (Exception ex)
            {
                LogError(ex, log);
            }

            return dto;
        }

        #endregion

        #region MultiCompanyRequest

        public CompanyBatchResponse GetValidCompanies(CompanyBatchValidationRequest request)
        {
            CompanyBatchResponse response = new CompanyBatchResponse();
            var allSettings = SettingManager.GetAllCompanySettings((int)CompanySettingType.ExternalLink2);

            foreach (var company in allSettings)
            {
                var strDataArr = company.StrData.Split('|');
                var apiKey = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CompanyAPIKey, 0, company.ActorCompanyId.Value, 0);

                foreach (var key in request.RequestKeys)
                {
                    foreach (var value in strDataArr)
                    {
                        if (request.EndpointType == BatchRequestEndpointType.AccountAggregatedTime && value.Contains("AccountAggregatedTime"))
                        {
                            var valueArr = value.Split('#');

                            if (value.Length != 2)
                                continue;

                            if (valueArr[1].Equals(key.Key, StringComparison.OrdinalIgnoreCase))
                            {
                                response.CompanyConnections.Add(new CompanyBatchConnection()
                                {
                                    CompanyApiKey = Guid.Parse(apiKey),
                                    CompanyToken = apiKey,
                                    RequestKey = key,
                                });
                            }
                        }
                    }
                }
            }
            return response;
        }

        #endregion

        #region Axfood



        public string HandleAxfoodExport(DateTime? from = null, DateTime? to = null, bool split800 = false, int numberOfDays = 35)
        {
            StringBuilder sb = new StringBuilder();
            DateTime fromDate = DateTime.Now.AddDays(-numberOfDays).Date;
            DateTime toDate = DateTime.Now.Date;

            if (DateTime.Now.Hour >= 23)
            {
                fromDate = fromDate.AddDays(1);
                toDate = toDate.AddDays(1);
            }

            if (from.HasValue)
                fromDate = from.Value.Date;

            if (to.HasValue)
                toDate = to.Value.Date;

            if (fromDate > toDate)
                fromDate = toDate;

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            foreach (License license in entitiesReadOnly.License.Include("Company").Where(w => w.LicenseId > 8 && w.LicenseNr.StartsWith("8")))
            {
                var companies = license.Company.Where(w => w.State == (int)SoeEntityState.Active && !w.Demo).ToList();

                foreach (var company in companies)
                {
                    int batchNr = 0;
                    var dateLimit = DateTime.Today.AddDays(-30);
                    var lastLog = entitiesReadOnly.ScheduledJobLog.OrderByDescending(o => o.Time).FirstOrDefault(f => f.Time > dateLimit && f.ScheduledJobHead.ActorCompanyId == company.ActorCompanyId);
                    if (lastLog != null)
                        batchNr = lastLog.BatchNr + 1;
                    else
                        batchNr = new Random().Next(2, 20);

                    sb.AppendLine(RunAxfoodExport(company, fromDate, toDate, split800, isSystemScheduledJob: true, batchNr: batchNr));
                }
            }

            return sb.ToString();
        }

        public string RunAxfoodExport(Company company, DateTime fromDate, DateTime toDate, bool split800 = false, bool isSystemScheduledJob = false, int batchNr = 0, int? jobHeadId = null, bool allowSplittingEDW = false)
        {
            StringBuilder sb = new StringBuilder();
            var initMessage = $"{DateTime.Now} company started: {company.Name}";
            sb.Append(initMessage);
            sb.Append(Environment.NewLine);
            LogCollector.LogInfo("HandleAxfoodExport " + initMessage);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            string externalExportId = TimeSalaryManager.GetExternalExportId(entitiesReadOnly, company.ActorCompanyId);
            var jobs = ScheduledJobManager.GetScheduledJobHeads(company.ActorCompanyId);
            var isTest = CompDbCache.Instance.SiteType == TermGroup_SysPageStatusSiteType.Test;
            if (!isTest && SysServiceManager.GetSysCompDBId() != 8)
                return "Incorrect database";
            bool runEdw = false;
            bool runAdato = false;
            bool runLas = false;
            bool runPEO2 = false;
            int? runLasJobId = null;
            int? runPEO2JobId = null;
            int? jobId = null;
            string PEO2KodVik = "33";
            string PEO2KodExtra = "30";
            bool PEO2Init = false;
            DateTime Peo2LimitDateFrom = DateTime.MinValue;
            List<int> currentLogIds = new List<int>();

            if (jobHeadId.HasValue)
                LogToScheduleJobLogForAxfood(jobHeadId, $"Started, Jobs on company {jobs.Count}", batchNr, currentLogIds);

            if (jobs.Any())
            {
                var allSettings = entitiesReadOnly.ScheduledJobSetting.Include("ScheduledJobHead").Where(w => w.ScheduledJobHead.State == (int)SoeEntityState.Active && w.ScheduledJobHead.ActorCompanyId == company.ActorCompanyId && w.State == (int)SoeEntityState.Active).ToList();

                var axfoodJob = allSettings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportCustomJob && a.StrData == "Axfood")?.ScheduledJobHead;
                var axfoodJobPeo2 = allSettings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportCustomJob && a.StrData == "AxfoodPEO2")?.ScheduledJobHead;
                var hasAxfoodCustomJob = axfoodJob != null;
                var hasAxfoodPeo2CustomerJob = axfoodJobPeo2 != null;

                if (isSystemScheduledJob && hasAxfoodCustomJob && hasAxfoodPeo2CustomerJob)
                {
                    sb.AppendLine("Skipped because of company scheduled job will be run on company schedule");
                    return sb.ToString();
                }

                foreach (var job in jobs)
                {
                    if (jobHeadId.HasValidValue() && job.ScheduledJobHeadId != jobHeadId)
                        continue;

                    var settings = allSettings.Where(w => w.ScheduledJobHeadId == job.ScheduledJobHeadId && w.State == (int)SoeEntityState.Active).ToList();
                    if ((hasAxfoodCustomJob && job.ScheduledJobHeadId == axfoodJob.ScheduledJobHeadId) || (isSystemScheduledJob && !hasAxfoodCustomJob))
                    {
                        if (settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "RunEdw"))
                            runEdw = true;

                        if (settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "RunAdato"))
                            runAdato = true;

                        if (settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "RunLas"))
                        {
                            runLasJobId = job.ScheduledJobHeadId;
                            runLas = true;
                        }
                    }
                    else
                    {
                        sb.AppendLine("Skipped edw/adato job because of company scheduled job will be run on company schedule");
                    }

                    if (isSystemScheduledJob && !hasAxfoodPeo2CustomerJob && settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "RunPEO2"))
                    {
                        runPEO2 = true;
                        runPEO2JobId = job.ScheduledJobHeadId;
                        if (settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "PEO2Init"))
                            PEO2Init = true;

                        var Peo2LimitDateFromSetting = settings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData != null && a.StrData.ToLower().StartsWith("peo2initdatefrom:"));
                        if (Peo2LimitDateFromSetting != null)
                            if (!DateTime.TryParse(Peo2LimitDateFromSetting.StrData.Split(':')[1], out Peo2LimitDateFrom))
                                Peo2LimitDateFrom = DateTime.MinValue;

                        var Peo2KodVikSetting = settings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData != null && a.StrData.ToLower().StartsWith("peo2kodvik:"));
                        if (Peo2KodVikSetting != null)
                            PEO2KodVik = Peo2KodVikSetting.StrData.Split(':')[1];

                        var Peo2KodExtraSetting = settings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData != null && a.StrData.ToLower().StartsWith("peo2kodextra:"));
                        if (Peo2KodExtraSetting != null)
                            PEO2KodExtra = Peo2KodExtraSetting.StrData.Split(':')[1];
                    }
                    else if (isSystemScheduledJob && hasAxfoodPeo2CustomerJob)
                    {
                        sb.AppendLine("Skipped peo2 because of company scheduled job will be run on company schedule");
                    }

                    jobId = jobHeadId ?? runLasJobId ?? runPEO2JobId;

                    if (jobId.HasValue)
                        LogToScheduleJobLogForAxfood(jobId.Value, $"Started {company.Name} runEdw:{runEdw} runAdata:{runAdato} runLas:{runLas} runPEO2:{runPEO2}", batchNr, currentLogIds);

                    LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} runEdw:{runEdw} runAdata:{runAdato} runLas:{runLas} runPEO2:{runPEO2} jobId:{jobId} {DateTime.Now}");
                }
            }
            else
            {
                sb.Append($"{DateTime.Now} company {company.Name} has no jobs");
            }

            if (runEdw || runAdato)
            {
                try
                {
                    LogToScheduleJobLogForAxfood(jobId, $"Started {company.Name} runEdw:{runEdw} runAdata:{runAdato}", batchNr, currentLogIds);
                    DirectoryInfo directory = Directory.CreateDirectory(ConfigSettings.SOE_SERVER_DIR_TEMP_REPORT_PHYSICAL + Guid.NewGuid().ToString());
                    List<Employee> employees = EmployeeManager.GetAllEmployees(company.ActorCompanyId, null, loadEmployment: true, getHidden: true);
                    var extensiveLogging = employees.Count > 500;
                    if (extensiveLogging)
                        LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} employeesFetched count:{employees.Count} {DateTime.Now}");

                    LogToScheduleJobLogForAxfood(jobId, $"Fetched {employees.Count} on {company.Name}", batchNr, currentLogIds);

                    // Check with axfood if this okey, if not we need to remove this
                    //
                    //if (extensiveLogging)
                    //{
                    //    List<Employee> activeEmployees = new List<Employee>();
                    //    List<int> purgedEmployeeIds = new List<int>();
                    //    DateTime limit = DateTime.Now.AddYears(-1);
                    //    foreach (var employee in employees)
                    //    {
                    //        if (employee.Hidden || employee.Vacant)
                    //        {
                    //            activeEmployees.Add(employee);
                    //            continue;
                    //        }

                    //        var employment = employee.GetNearestEmployment(DateTime.Today);

                    //        if (employment != null && (!employment.GetEndDate().HasValue || employment.GetEndDate() > limit))
                    //            activeEmployees.Add(employee);
                    //        else
                    //            purgedEmployeeIds.Add(employee.EmployeeId);
                    //    }

                    //    var purgedEmployeeIdsStr = string.Join(",", purgedEmployeeIds);

                    //    LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} employeesActive {activeEmployees.Count} purged {purgedEmployeeIds.Count} purgedIds {purgedEmployeeIdsStr} {DateTime.Now}");

                    //    employees = activeEmployees;
                    //}

                    List<Account> accounts = AccountManager.GetAccountsByCompany(company.ActorCompanyId);
                    List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(company.ActorCompanyId);
                    List<PayrollProduct> payrollProducts = ProductManager.GetPayrollProducts(company.ActorCompanyId, null);
                    List<TimeDeviationCause> timeDeviationCauses = TimeDeviationCauseManager.GetTimeDeviationCauses(company.ActorCompanyId, loadTimeCode: true, loadEmployeeGroups: true);
                    List<EmployeeAccount> employeeAccounts = entitiesReadOnly.EmployeeAccount.Include("Account.AccountInternal").Where(w => w.ActorCompanyId == company.ActorCompanyId && !w.ParentEmployeeAccountId.HasValue && w.Account.AccountDim.SysSieDimNr == (int?)TermGroup_SieAccountDim.CostCentre).ToList();
                    List<PayrollPriceType> payrollPriceTypes = PayrollManager.GetPayrollPriceTypes(company.ActorCompanyId, null, false);
                    List<EmployeeGroup> employeeGroups = EmployeeManager.GetEmployeeGroups(company.ActorCompanyId, true, true, true, true);
                    List<PayrollGroup> payrollGroups = PayrollManager.GetPayrollGroups(company.ActorCompanyId, true, true, true, true, true, false);
                    List<AnnualLeaveGroup> annualLeaveGroups = AnnualLeaveManager.GetAnnualLeaveGroups(company.ActorCompanyId);
                    List<int> approvedAttestStates = new List<int>();
                    approvedAttestStates.Add(SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.SalaryExportPayrollMinimumAttestStatus, 0, company.ActorCompanyId, 0));
                    approvedAttestStates.Add(SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.SalaryExportPayrollResultingAttestStatus, 0, company.ActorCompanyId, 0));

                    sb.Append($"{DateTime.Now} employees count: {employees.Count} accounts count: {accounts.Count} accountDims count: {accountDims.Count} payrollProducts count: {payrollProducts.Count} timeDeviationCauses count: {employeeAccounts.Count} employeeAccounts count: {employeeAccounts.Count}");
                    sb.Append(Environment.NewLine);

                    int batch = 1;
                    Dictionary<int, List<TimePayrollTransactionDTO>> timePayrollTransactionDTOs = new Dictionary<int, List<TimePayrollTransactionDTO>>();
                    BatchHelper batchHelper = BatchHelper.Create(employees.Select(s => s.EmployeeId).ToList(), 999);
                    while (batchHelper.HasMoreBatches())
                    {
                        var employeesInBatch = employees.Where(w => batchHelper.GetCurrentBatchIds().Contains(w.EmployeeId)).ToList();
                        var timePayrollTransactionDTOsInBatch = TimeTransactionManager.GetTimePayrollTransactionDTOForReport(fromDate, toDate, employeesInBatch.Where(w => !w.Hidden).Select(s => s.EmployeeId).ToList(), company.ActorCompanyId);
                        sb.Append($"{DateTime.Now} batchNr: {batch}  timePayrollTransactionDTOsInBatch, employeesInBatch {employeesInBatch.Count()}");
                        sb.Append(Environment.NewLine);
                        LogToScheduleJobLogForAxfood(jobId, $"Fetched transactions for {timePayrollTransactionDTOsInBatch.Count} employees on {company.Name}", batchNr, currentLogIds);
                        batch++;
                        foreach (var employeeBatch in timePayrollTransactionDTOsInBatch)
                        {
                            if (!timePayrollTransactionDTOs.ContainsKey(employeeBatch.Key))
                                timePayrollTransactionDTOs.Add(employeeBatch.Key, employeeBatch.Value);
                        }
                        batchHelper.MoveToNextBatch();
                    }

                    LogToScheduleJobLogForAxfood(jobId, $"Fetched transactions for a total of {timePayrollTransactionDTOs.Count} employees on {company.Name}", batchNr, currentLogIds);
                    sb.Append($"{DateTime.Now} timePayrollTransactionDTOs fetched count: {timePayrollTransactionDTOs.Count}");
                    sb.Append(Environment.NewLine);

                    if (extensiveLogging)
                        LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} timePayrollTransactionDTOs fetched count: {timePayrollTransactionDTOs.Count} {DateTime.Now}");

                    var validTo = DateTime.UtcNow.AddSeconds(employees.Count / 4);
                    ExtensionCache.Instance.AddToEmployeePayrollGroupExtensionCaches(company.ActorCompanyId, employeeGroups, payrollGroups, payrollPriceTypes, annualLeaveGroups, validTo);

                    Parallel.ForEach(employees, GetDefaultParallelOptions(), employee =>
                    {
                        var items = EmployeeManager.GetEmploymentCalenderDTOs(employee, fromDate, toDate, employeeGroups, payrollGroups, payrollPriceTypes, null, annualLeaveGroups: annualLeaveGroups);
                        ExtensionCache.Instance.AddToEmploymentCalendarExtensionCaches(items, validTo);
                    });

                    if (runEdw)
                    {
                        timePayrollTransactionDTOs = TimeTransactionManager.AddAmounts(company.ActorCompanyId, timePayrollTransactionDTOs, employees.Where(w => !w.Hidden).ToList(), payrollGroups);
                        LogToScheduleJobLogForAxfood(jobId, $"Added amounts to transactions for a total of {timePayrollTransactionDTOs.Count} employees on {company.Name}", batchNr, currentLogIds);
                    }
                    if (extensiveLogging)
                        LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} timePayrollTransactionDTOs amounts added count: {timePayrollTransactionDTOs.Count} {DateTime.Now}");

                    sb.Append($"{DateTime.Now} timePayrollTransactionDTOs amounts added count: {timePayrollTransactionDTOs.Count}");
                    sb.Append(Environment.NewLine);

                    var timeScheduleTransactionDTOs = new Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>>();
                    batch = 1;
                    if (runEdw)
                    {
                        // If todate is old, that means that this is a rerun and that the newer runs will take care of the future schedules
                        var adjustedToDate = toDate > DateTime.Today.AddMonths(-1) ? toDate.AddDays(180) : toDate;

                        if (adjustedToDate == toDate)
                        {
                            sb.Append($"{DateTime.Now} schedule todate is adjusted to not include feature days: {adjustedToDate}");
                            sb.Append(Environment.NewLine);
                            LogToScheduleJobLogForAxfood(jobId, $"Adjusted toDate for schedules to {adjustedToDate} (so not including future schedules) on {company.Name}", batchNr, currentLogIds);
                        }

                        batchHelper = BatchHelper.Create(employees.Select(s => s.EmployeeId).ToList(), 1000);
                        while (batchHelper.HasMoreBatches())
                        {
                            var employeesInBatch = employees.Where(w => batchHelper.GetCurrentBatchIds().Contains(w.EmployeeId)).ToList();
                            var timeScheduleTransactionDTOsInBatch = TimeScheduleManager.GetTimeEmployeeScheduleSmallDTODictForReport(fromDate, adjustedToDate, employeesInBatch, company.ActorCompanyId, RoleId, addAmounts: true, forceSkipAccount: true, addGrossTimeAndAmount: true, removeBreaks: true);
                            sb.Append($"{DateTime.Now} batchNr: {batch}  timeScheduleTransactionDTOsInBatch, employeesInBatch {employeesInBatch.Count()}");
                            sb.Append(Environment.NewLine);
                            LogToScheduleJobLogForAxfood(jobId, $"Fetched schedules for {timeScheduleTransactionDTOsInBatch.Count} employees on {company.Name}", batchNr, currentLogIds);
                            batch++;
                            foreach (var employeeBatch in timeScheduleTransactionDTOsInBatch)
                            {
                                if (!timeScheduleTransactionDTOs.ContainsKey(employeeBatch.Key))
                                    timeScheduleTransactionDTOs.Add(employeeBatch.Key, employeeBatch.Value);
                            }

                            batchHelper.MoveToNextBatch();
                        }

                        LogToScheduleJobLogForAxfood(jobId, $"Fetched schedules for a total of {timeScheduleTransactionDTOs.Count} employees on {company.Name}", batchNr, currentLogIds);
                    }

                    if (extensiveLogging)
                        LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} timeScheduelTransactionDTOs fetched count: {timeScheduleTransactionDTOs.Count} {DateTime.Now}");

                    sb.Append($"{DateTime.Now} timeScheduelTransactionDTOs fetched count: {timeScheduleTransactionDTOs.Count}");
                    sb.Append(Environment.NewLine);

                    sb.Append($"{DateTime.Now} timeScheduelTransactionDTOs amounts added count: {timeScheduleTransactionDTOs.Count}");
                    sb.Append(Environment.NewLine);

                    var docs = AxfoodExportItem.CreateDocuments(timePayrollTransactionDTOs, timeScheduleTransactionDTOs, employees, employeeAccounts, payrollProducts, accounts, accountDims, timeDeviationCauses, approvedAttestStates, split800, allowSplittingEDW);

                    var schedule = string.Empty;
                    var peo2 = string.Empty;

                    if (runLas)
                    {

                        schedule = AxfoodExportItem.GetSchedule(timeScheduleTransactionDTOs, employees, externalExportId);

                        if (runLasJobId.HasValue)
                        {
                            try
                            {
                                var lastRun = entitiesReadOnly.ScheduledJobLog.Where(w => w.ScheduledJobHeadId == runLasJobId).OrderByDescending(o => o.Time).FirstOrDefault();
                                using (CompEntities entities = new CompEntities())
                                {
                                    var jobFromDb = entities.ScheduledJobHead.Include("ScheduledJobRow").FirstOrDefault(f => f.ScheduledJobHeadId == runLasJobId);

                                    if (jobFromDb != null)
                                    {
                                        if (!jobFromDb.ScheduledJobRow.Any())
                                        {
                                            jobFromDb.ScheduledJobRow.Add(new ScheduledJobRow()
                                            {
                                                ScheduledJobHeadId = jobFromDb.ScheduledJobHeadId,
                                                RecurrenceInterval = "0 0 * 1 *",
                                                NextExecutionTime = DateTime.Now.AddYears(20)
                                            });
                                        }

                                        batchNr = batchNr == 0 ? lastRun?.BatchNr ?? 0 + 1 : batchNr;
                                        jobFromDb.ScheduledJobLog.Add(new ScheduledJobLog()
                                        {
                                            LogLevel = (int)SystemInfoLogLevel.Information,
                                            Message = $"RunLas created for {company.Name} {DateTime.Now}",
                                            Status = (int)TermGroup_ScheduledJobLogStatus.Running,
                                            Time = DateTime.Now,
                                            BatchNr = batchNr,
                                            ScheduledJobRow = jobFromDb.ScheduledJobRow.FirstOrDefault()
                                        });

                                        SaveChanges(entities);
                                        currentLogIds.AddRange(jobFromDb.ScheduledJobLog.Select(l => l.ScheduledJobLogId));
                                    }
                                }
                            }
                            catch (Exception ex)
                            {
                                LogCollector.LogError(ex, "runLasJob log failed");
                                sb.Append($"LasJob failed to save to log");
                            }
                        }
                    }

                    if (runPEO2)
                    {
                        using (CompEntities entities = new CompEntities())
                        {
                            var initPEO2Message = "PEO2 initiated";
                            LogToScheduleJobLogForAxfood(runPEO2JobId, initPEO2Message, batchNr, currentLogIds);
                            DateTime dateLimit = DateTime.Today.AddDays(-30);
                            var hasPeosInitMessage = entities.ScheduledJobLog.Any(w => w.Time > dateLimit && w.ScheduledJobHeadId == runPEO2JobId && w.Message == initPEO2Message);
                            ScheduledJobLog lastRun = null;
                            if (hasPeosInitMessage)
                            {
                                lastRun = runPEO2JobId.HasValue ? entities.ScheduledJobLog.Where(w => w.ScheduledJobHeadId == runPEO2JobId && w.Message == initPEO2Message && !currentLogIds.Contains(w.ScheduledJobLogId) && w.BatchNr != batchNr).OrderByDescending(o => o.Time).FirstOrDefault() : null;

                                if (lastRun != null)
                                    LogToScheduleJobLogForAxfood(runPEO2JobId, $"PEO2 last time initiated {lastRun.Time}", batchNr, currentLogIds);
                            }
                            else
                            {
                                lastRun = runPEO2JobId.HasValue ? entities.ScheduledJobLog.Where(w => w.ScheduledJobHeadId == runPEO2JobId && !currentLogIds.Contains(w.ScheduledJobLogId) && w.BatchNr != batchNr).OrderByDescending(o => o.Time).FirstOrDefault() : null;
                            }

                            var dateFromBasedOnLastRun = PEO2Init ? CalendarUtility.GetDateTime(DateTime.Today.AddDays(-1), 0, 0, 0).Date : CalendarUtility.GetDateTime(lastRun?.Time.AddDays(-4) ?? DateTime.Today.AddDays(-4), 0, 0, 0).Date;
                            batchNr = batchNr == 0 ? (lastRun?.BatchNr ?? 0) + 1 : batchNr;
                            var jobFromDb = runPEO2JobId.HasValue ? entities.ScheduledJobHead.Include("ScheduledJobRow").FirstOrDefault(f => f.ScheduledJobHeadId == runPEO2JobId) : null;

                            // if any limit back in time
                            if (dateFromBasedOnLastRun < Peo2LimitDateFrom && Peo2LimitDateFrom < CalendarUtility.GetEndOfDay(DateTime.Today.AddDays(-1)))
                                dateFromBasedOnLastRun = Peo2LimitDateFrom;

                            // Filter for schedules modified after the last run
                            var filteredSchedules = timeScheduleTransactionDTOs
                                .SelectMany(d => d.Value)
                                .Where(dto => dto.Date >= dateFromBasedOnLastRun.AddDays(-2) && dto.Date <= DateTime.Today)
                                .ToList();

                            var scheduleDict = filteredSchedules.GroupBy(dto => dto.EmployeeId).ToDictionary(g => g.Key, g => g.ToList());
                            var employeeIds = scheduleDict.Select(s => s.Key).ToList();
                            var substituteShifts = TimeScheduleManager.GetSubstituteShifts(entitiesReadOnly, company.ActorCompanyId, employeeIds, CalendarUtility.GetDates(dateFromBasedOnLastRun.AddDays(-2), DateTime.Today), true);

                            var substituteShiftsDict = substituteShifts.GroupBy(g => g.EmployeeId).ToDictionary(g => g.Key, g => g.ToList());

                            peo2 = AxfoodExportItem.GetLasForOneEmploymentPercent(scheduleDict, substituteShiftsDict, dateFromBasedOnLastRun, CalendarUtility.GetEndOfDay(DateTime.Today.AddDays(-1)), employees.ToDTOs(includeEmployments: true), externalExportId, false, PEO2Init, PEO2KodExtra, PEO2KodVik);

                            jobFromDb?.ScheduledJobLog.Add(new ScheduledJobLog()
                            {
                                LogLevel = (int)SystemInfoLogLevel.Information,
                                Message = $"RunPeo2 created for {company.Name} {DateTime.Now}",
                                Status = (int)TermGroup_ScheduledJobLogStatus.Running,
                                Time = DateTime.Now,
                                BatchNr = batchNr,
                                ScheduledJobRowId = jobFromDb.ScheduledJobRow.FirstOrDefault().ScheduledJobRowId
                            });

                            entities.SaveChanges();
                            currentLogIds.AddRange(jobFromDb.ScheduledJobLog.Where(l => !currentLogIds.Contains(l.ScheduledJobLogId)).Select(l => l.ScheduledJobLogId));
                        }

                    }

                    sb.Append($"{DateTime.Now} docs count: {docs.Count}");
                    sb.Append(Environment.NewLine);
                    int docCount = 1;
                    foreach (var doc in docs)
                    {
                        if (doc?.Item2 == null)
                            continue;

                        try
                        {
                            if (extensiveLogging)
                                LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} doc number:{docCount} {DateTime.Now}");

                            var tempPath = directory.FullName + @"\" + Guid.NewGuid().ToString();
                            var type = XmlUtil.GetRootElement(doc.Item2).Name;
                            doc.Item2.Save(tempPath);
                            string tempExt = ".temp";
                            string xmlExt = ".xml";
                            var now = DateTime.Now;
                            var fileName = company.Name + "_" + type.LocalName + "_" + externalExportId + "_" + CalendarUtility.ToFileFriendlyDateTime(now) + "_" + docCount.ToString() + tempExt;
                            fileName = fileName.RemoveWhiteSpace();
                            fileName = fileName.RemoveÅÄÖ();
                            SshUtil sshUtil = new SshUtil(isAzureFTPserver: true);

                            if (runEdw && doc.Item1 == "EDW")
                            {
                                if (extensiveLogging)
                                    LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} EDW doc number:{docCount} {DateTime.Now}");

                                string path = (!isTest ? Constants.AXFOODPRODUCTIONXMLDROP : Constants.AXFOODTESTXMLDROP) + fileName;
                                sb.Append($"{DateTime.Now} Ready for transfer {fileName}");
                                sb.Append(Environment.NewLine);
                                var data = ZipUtility.Compress(tempPath, tempPath + Guid.NewGuid().ToString());
                                var result = sshUtil.Upload(data, path);

                                if (result.Success)
                                    LogToScheduleJobLogForAxfood(jobId, $"Transfered {fileName} to {path} for {company.Name}", batchNr, currentLogIds);
                                else
                                    LogToScheduleJobLogForAxfood(jobId, $"Failed to transfer {fileName} to {path} for {company.Name} with error {result.ErrorMessage}", batchNr, currentLogIds);

                                sshUtil.Rename(path, path.Replace(tempExt, xmlExt + ".gz"));
                            }
                            else if (runAdato && doc.Item1 == "Adato") // => To Adato (only axfoods 8000 license)
                            {
                                if (extensiveLogging)
                                    LogCollector.LogInfo("HandleAxfoodExport " + $"{company.Name} Adato doc number:{docCount} {DateTime.Now}");

                                string path = (!isTest ? Constants.AXFOODPRODUCTIONADATODROP : Constants.AXFOODTESTADATODROP) + fileName;
                                var data = ZipUtility.Compress(tempPath, tempPath + Guid.NewGuid().ToString());
                                var result = sshUtil.Upload(data, path);

                                if (result.Success)
                                    LogToScheduleJobLogForAxfood(jobId, $"Transfered {fileName} to {path} for {company.Name}", batchNr, currentLogIds);
                                else
                                    LogToScheduleJobLogForAxfood(jobId, $"Failed to transfer {fileName} to {path} for {company.Name} with error {result.ErrorMessage}", batchNr, currentLogIds);

                                sshUtil.Rename(path, path.Replace(tempExt, xmlExt + ".gz"));
                            }
                            docCount++;
                        }
                        catch (Exception ex)
                        {
                            sb.Append($"{DateTime.Now} doc failed ex: {ex.Message}");
                            sb.Append(Environment.NewLine);
                            LogError(ex, log);
                            if (extensiveLogging)
                                LogCollector.LogInfo("HandleAxfoodExport failed" + $"{company.Name} doc number:{docCount} {DateTime.Now} {ex.InnerException}");
                        }
                    }

                    if (runLas)
                    {
                        if (!string.IsNullOrEmpty(schedule))
                        {
                            try
                            {

                                SshUtil sshUtil = new SshUtil(isAzureFTPserver: true);

                                if (extensiveLogging)
                                    LogCollector.LogInfo("Handle ExportSchedule " + $"{company.Name} length{schedule.Length}");

                                string tempExt = ".temp";
                                string txt = ".txt";
                                var now = DateTime.Now;
                                var fileName = "LAS_PSJ_S1_" + externalExportId + "_" + CalendarUtility.ToFileFriendlyDateTime(now) + tempExt;
                                fileName = fileName.RemoveWhiteSpace();
                                fileName = fileName.RemoveÅÄÖ();

                                string path = (isTest ? Constants.AXFOODTESTSCHEDULEDROP : Constants.AXFOODPRODUCTIONSCHEDULEDROP) + fileName;
                                sb.Append($"{DateTime.Now} Ready for transfer {fileName}");
                                sb.Append(Environment.NewLine);
                                var result = sshUtil.Upload(Encoding.UTF8.GetBytes(schedule), path);
                                if (result.Success)
                                    LogToScheduleJobLogForAxfood(jobId, $"Transfered {fileName} to {path} for {company.Name}", batchNr, currentLogIds);
                                else
                                    LogToScheduleJobLogForAxfood(jobId, $"Failed to transfer {fileName} to {path} for {company.Name} with error {result.ErrorMessage}", batchNr, currentLogIds);

                                sshUtil.Rename(path, path.Replace(tempExt, txt));

                            }
                            catch (Exception ex)
                            {
                                LogCollector.LogError(ex, $"AxfoodScheduleFailed {company.Name}");
                            }
                        }
                        if (!string.IsNullOrEmpty(peo2))
                        {
                            try
                            {
                                SshUtil sshUtil = new SshUtil(isAzureFTPserver: true);

                                if (extensiveLogging)
                                    LogCollector.LogInfo("Handle ExportLas " + $"{company.Name} length{peo2.Length}");

                                string tempExt = ".temp";
                                string txt = ".txt";
                                var now = DateTime.Now;
                                var fileName = "LAS_person_aform_S1_" + externalExportId + "_" + CalendarUtility.ToFileFriendlyDateTime(now) + tempExt;
                                fileName = fileName.RemoveWhiteSpace();
                                fileName = fileName.RemoveÅÄÖ();

                                string path = (isTest ? Constants.AXFOODTESTAFROM : Constants.AXFOODPRODUCTIONAFROM) + fileName;
                                sb.Append($"{DateTime.Now} Ready for transfer {fileName}");
                                sb.Append(Environment.NewLine);
                                var result = sshUtil.Upload(Encoding.UTF8.GetBytes(peo2), path);
                                if (result.Success)
                                    LogToScheduleJobLogForAxfood(jobId, $"Transfered {fileName} to {path} for {company.Name}", batchNr, currentLogIds);
                                else
                                    LogToScheduleJobLogForAxfood(jobId, $"Failed to transfer {fileName} to {path} for {company.Name} with error {result.ErrorMessage}", batchNr, currentLogIds);

                                sshUtil.Rename(path, path.Replace(tempExt, txt));
                            }
                            catch (Exception ex)
                            {
                                LogCollector.LogError(ex, $"AxfoodLasFailed {company.Name}");
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    sb.Append($"{DateTime.Now} something failed ex: {ex.Message}");
                    sb.Append(Environment.NewLine);
                    LogError(ex, log);
                }
            }

            LogInfo(sb.ToString());
            return sb.ToString();
        }

        public string RunAxfoodPeo2Export(int actorCompanyId, int scheduledJobHeadId, int batchNr)
        {

            try
            {
                List<int> currentLogIds = new List<int>();
                Company company = CompanyManager.GetCompany(actorCompanyId);
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                string externalExportId = TimeSalaryManager.GetExternalExportId(entitiesReadOnly, company.ActorCompanyId);
                List<Employee> employees = EmployeeManager.GetAllEmployees(company.ActorCompanyId, null, loadEmployment: true, getHidden: true);
                var settings = entitiesReadOnly.ScheduledJobSetting.Where(w => w.ScheduledJobHeadId == scheduledJobHeadId && w.State == (int)SoeEntityState.Active).ToList();
                bool PEO2Init = false;
                string PEO2KodVik = "33";
                string PEO2KodExtra = "30";
                DateTime Peo2LimitDateFrom = DateTime.MinValue;

                if (settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "RunPEO2"))
                {
                    if (settings.Any(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData == "PEO2Init"))
                        PEO2Init = true;

                    var Peo2LimitDateFromSetting = settings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData != null && a.StrData.ToLower().StartsWith("peo2initdatefrom:"));
                    if (Peo2LimitDateFromSetting != null)
                        if (!DateTime.TryParse(Peo2LimitDateFromSetting.StrData.Split(':')[1], out Peo2LimitDateFrom))
                            Peo2LimitDateFrom = DateTime.MinValue;

                    var Peo2KodVikSetting = settings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData != null && a.StrData.ToLower().StartsWith("peo2kodvik:"));
                    if (Peo2KodVikSetting != null)
                        PEO2KodVik = Peo2KodVikSetting.StrData.Split(':')[1];

                    var Peo2KodExtraSetting = settings.FirstOrDefault(a => a.Type == (int)TermGroup_ScheduledJobSettingType.ExportKey && a.StrData != null && a.StrData.ToLower().StartsWith("peo2kodextra:"));
                    if (Peo2KodExtraSetting != null)
                        PEO2KodExtra = Peo2KodExtraSetting.StrData.Split(':')[1];
                }

                LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"RunPeo2 settings {company.Name} PEO2Init:{PEO2Init} PEO2KodVik:{PEO2KodVik} PEO2KodExtra:{PEO2KodExtra} Peo2LimitDateFrom:{Peo2LimitDateFrom}", batchNr, currentLogIds);

                var peo2 = string.Empty;
                using (CompEntities entities = new CompEntities())
                {
                    var initPEO2Message = "PEO2 initiated";
                    LogToScheduleJobLogForAxfood(scheduledJobHeadId, initPEO2Message, batchNr, currentLogIds);
                    DateTime dateLimit = DateTime.Today.AddDays(-30);
                    var hasPeosInitMessage = entities.ScheduledJobLog.Any(w => w.Time > dateLimit && w.ScheduledJobHeadId == scheduledJobHeadId && w.Message == initPEO2Message);
                    ScheduledJobLog lastRun = null;
                    if (hasPeosInitMessage)
                    {
                        lastRun = entities.ScheduledJobLog.Where(w => w.ScheduledJobHeadId == scheduledJobHeadId && w.Message == initPEO2Message && !currentLogIds.Contains(w.ScheduledJobLogId) && w.BatchNr != batchNr).OrderByDescending(o => o.Time).FirstOrDefault();

                        if (lastRun != null)
                            LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"PEO2 last time initiated {lastRun.Time}", batchNr, currentLogIds);
                    }
                    else
                    {
                        lastRun = entities.ScheduledJobLog.Where(w => w.ScheduledJobHeadId == scheduledJobHeadId && !currentLogIds.Contains(w.ScheduledJobLogId) && w.BatchNr != batchNr).OrderByDescending(o => o.Time).FirstOrDefault();
                    }

                    var dateFromBasedOnLastRun = PEO2Init ? CalendarUtility.GetDateTime(DateTime.Today.AddDays(-1), 0, 0, 0).Date : CalendarUtility.GetDateTime(lastRun?.Time.AddDays(-4) ?? DateTime.Today.AddDays(-4), 0, 0, 0).Date;
                    batchNr = batchNr == 0 ? (lastRun?.BatchNr ?? 0) + 1 : batchNr;
                    var jobFromDb = entities.ScheduledJobHead.Include("ScheduledJobRow").FirstOrDefault(f => f.ScheduledJobHeadId == scheduledJobHeadId);

                    // if any limit back in time
                    if (dateFromBasedOnLastRun < Peo2LimitDateFrom && Peo2LimitDateFrom < CalendarUtility.GetEndOfDay(DateTime.Today.AddDays(-1)))
                        dateFromBasedOnLastRun = Peo2LimitDateFrom;

                    var batch = 1;
                    Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> timeScheduleTransactionDTOs = new Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>>();

                    var batchHelper = BatchHelper.Create(employees.Select(s => s.EmployeeId).ToList(), 2000);
                    while (batchHelper.HasMoreBatches())
                    {
                        var employeesInBatch = employees.Where(w => batchHelper.GetCurrentBatchIds().Contains(w.EmployeeId)).ToList();
                        var timeScheduleTransactionDTOsInBatch = TimeScheduleManager.GetTimeEmployeeScheduleSmallDTODictForReport(dateFromBasedOnLastRun.AddDays(-2), DateTime.Today, employeesInBatch, company.ActorCompanyId, RoleId, addAmounts: false, forceSkipAccount: true, addGrossTimeAndAmount: false, removeBreaks: true);
                        LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"Fetched schedules for {timeScheduleTransactionDTOsInBatch.Count} employees on {company.Name} for dates {dateFromBasedOnLastRun.AddDays(-2).ToShortDateString()}- {DateTime.Today.ToShortDateString()}", batchNr, currentLogIds);
                        batch++;
                        foreach (var employeeBatch in timeScheduleTransactionDTOsInBatch)
                        {
                            if (!timeScheduleTransactionDTOs.ContainsKey(employeeBatch.Key))
                                timeScheduleTransactionDTOs.Add(employeeBatch.Key, employeeBatch.Value);
                        }

                        batchHelper.MoveToNextBatch();
                    }

                    LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"Fetched schedules for a total of {timeScheduleTransactionDTOs.Count} employees on {company.Name} for dates {dateFromBasedOnLastRun.AddDays(-2).ToShortDateString()}- {DateTime.Today.ToShortDateString()}", batchNr, currentLogIds);

                    // Filter for schedules modified after the last run
                    var filteredSchedules = timeScheduleTransactionDTOs
                        .SelectMany(d => d.Value)
                        .Where(dto => dto.Date >= dateFromBasedOnLastRun.AddDays(-2) && dto.Date <= DateTime.Today)
                        .ToList();

                    LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"Total of {filteredSchedules.Count} schedule blocks on employees on {company.Name} for dates {dateFromBasedOnLastRun.AddDays(-2).ToShortDateString()}- {DateTime.Today.ToShortDateString()}", batchNr, currentLogIds);
                    var filteredEmployees = employees.Where(w => filteredSchedules.Select(s => s.EmployeeId).Contains(w.EmployeeId)).ToList();
                    LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"Total of {filteredEmployees.Count} employees with schedules on {company.Name} for dates {dateFromBasedOnLastRun.AddDays(-2).ToShortDateString()}- {DateTime.Today.ToShortDateString()}", batchNr, currentLogIds);
                    var scheduleDict = filteredSchedules.GroupBy(dto => dto.EmployeeId).ToDictionary(g => g.Key, g => g.ToList());
                    var employeeIds = scheduleDict.Select(s => s.Key).ToList();
                    var substituteShifts = TimeScheduleManager.GetSubstituteShifts(entitiesReadOnly, company.ActorCompanyId, employeeIds, CalendarUtility.GetDates(dateFromBasedOnLastRun.AddDays(-2), DateTime.Today), true);
                    var substituteShiftsDict = substituteShifts.GroupBy(g => g.EmployeeId).ToDictionary(g => g.Key, g => g.ToList());

                    peo2 = AxfoodExportItem.GetLasForOneEmploymentPercent(scheduleDict, substituteShiftsDict, dateFromBasedOnLastRun, CalendarUtility.GetEndOfDay(DateTime.Today.AddDays(-1)), filteredEmployees.ToDTOs(includeEmployments: true), externalExportId, false, PEO2Init, PEO2KodExtra, PEO2KodVik);

                    jobFromDb?.ScheduledJobLog.Add(new ScheduledJobLog()
                    {
                        LogLevel = (int)SystemInfoLogLevel.Information,
                        Message = $"RunPeo2 created for {company.Name} {DateTime.Now}",
                        Status = (int)TermGroup_ScheduledJobLogStatus.Running,
                        Time = DateTime.Now,
                        BatchNr = batchNr,
                        ScheduledJobRowId = jobFromDb.ScheduledJobRow.FirstOrDefault().ScheduledJobRowId
                    });

                    entities.SaveChanges();
                    currentLogIds.AddRange(jobFromDb.ScheduledJobLog.Where(l => !currentLogIds.Contains(l.ScheduledJobLogId)).Select(l => l.ScheduledJobLogId));

                    if (!string.IsNullOrEmpty(peo2))
                    {
                        try
                        {
                            SshUtil sshUtil = new SshUtil(isAzureFTPserver: true);
                            string tempExt = ".temp";
                            string txt = ".txt";
                            var now = DateTime.Now;
                            var fileName = "LAS_person_aform_S1_" + externalExportId + "_" + CalendarUtility.ToFileFriendlyDateTime(now) + tempExt;
                            fileName = fileName.RemoveWhiteSpace();
                            fileName = fileName.RemoveÅÄÖ();

                            string path = (ConfigurationSetupUtil.IsTestBasedOnMachine() ? Constants.AXFOODTESTAFROM : Constants.AXFOODPRODUCTIONAFROM) + fileName;
                            var result = sshUtil.Upload(Encoding.UTF8.GetBytes(peo2), path);
                            if (result.Success)
                                LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"Transfered {fileName} to {path} for {company.Name}", batchNr, currentLogIds);
                            else
                                LogToScheduleJobLogForAxfood(scheduledJobHeadId, $"Failed to transfer {fileName} to {path} for {company.Name} with error {result.ErrorMessage}", batchNr, currentLogIds);

                            sshUtil.Rename(path, path.Replace(tempExt, txt));
                        }
                        catch (Exception ex)
                        {
                            LogCollector.LogError(ex, $"RunAxfoodPeo2Export transer not successful {company.Name}");
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                LogCollector.LogError(ex, $"RunAxfoodPeo2Export failed");
                return "Failed";
            }

            return "Success";
        }

        private void LogToScheduleJobLogForAxfood(int? jobId, string message, int batchNr, List<int> currentLogIds)
        {
            if (jobId.HasValue)
            {
                try
                {
                    using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

                    var lastRun = entitiesReadOnly.ScheduledJobLog.Where(w => w.ScheduledJobHeadId == jobId).OrderByDescending(o => o.Time).FirstOrDefault();
                    using (CompEntities entities = new CompEntities())
                    {
                        var jobFromDb = entities.ScheduledJobHead.Include("ScheduledJobRow").FirstOrDefault(f => f.ScheduledJobHeadId == jobId);

                        if (jobFromDb != null)
                        {
                            if (!jobFromDb.ScheduledJobRow.Any())
                            {
                                jobFromDb.ScheduledJobRow.Add(new ScheduledJobRow()
                                {
                                    ScheduledJobHeadId = jobFromDb.ScheduledJobHeadId,
                                    RecurrenceInterval = "0 0 * 1 *",
                                    NextExecutionTime = DateTime.Now.AddYears(20)
                                });
                            }

                            batchNr = batchNr == 0 ? lastRun?.BatchNr ?? 0 + 1 : batchNr;
                            jobFromDb.ScheduledJobLog.Add(new ScheduledJobLog()
                            {
                                LogLevel = (int)SystemInfoLogLevel.Information,
                                Message = message,
                                Status = (int)TermGroup_ScheduledJobLogStatus.Running,
                                Time = DateTime.Now,
                                BatchNr = batchNr,
                                ScheduledJobRow = jobFromDb.ScheduledJobRow.FirstOrDefault()
                            });

                            SaveChanges(entities);
                            currentLogIds.AddRange(jobFromDb.ScheduledJobLog.Select(l => l.ScheduledJobLogId));
                        }
                    }
                }
                catch (Exception ex)
                {
                    LogCollector.LogError(ex, $"Log failed {message}");
                }
            }
        }

        public ActionResult ImportEDWDataFromSftp()
        {
            ActionResult result = new ActionResult();
            StringBuilder sb = new StringBuilder();
            var isTest = CompDbCache.Instance.SiteType == TermGroup_SysPageStatusSiteType.Test;

            sb.Append($"ImportEDWDataFromSftp Started: isTest: {isTest}");

            List<int> actorCompanyIds = new List<int>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            if ((!isTest && SysServiceManager.GetSysCompDBId() != 8) || (isTest && !entitiesReadOnly.License.Any(a => a.LicenseNr == "8000")))
            {
                actorCompanyIds = TimeSalaryManager.GetAxfoodsNotInAxfoodDatabase(entitiesReadOnly);
                if (actorCompanyIds.IsNullOrEmpty())
                    return new ActionResult(false);
            }
            else
            {
                using (CompEntities entities = new CompEntities())
                {
                    foreach (var license in entities.License.Include("Company").Where(w => w.LicenseId > 8 && (w.LicenseNr.StartsWith("8") || w.LicenseNr.StartsWith("9"))))
                        foreach (var company in license.Company)
                            actorCompanyIds.Add(company.ActorCompanyId);
                }
            }
            sb.Append($"actorCompanyIds: {actorCompanyIds.Count}");

            var data = GetEDWDataFromSftp(actorCompanyIds);

            sb.Append($"data: {actorCompanyIds.Count}");

            foreach (var item in data)
            {
                try
                {
                    sb.Append($"XEConnectImport {DateTime.Now} " + item.Item1 + " " + $"{item.Item2}");
                    var unzipped = ZipUtility.DecompressGZip(item.Item3);
                    var content = System.Text.Encoding.UTF8.GetString(unzipped);
                    content = content.Replace(":,", ":0,");
                    List<StaffingNeedsFrequencyIODTO> iODTOs = JsonConvert.DeserializeObject<List<StaffingNeedsFrequencyIODTO>>(content);

                    if (iODTOs == null)
                    {
                        sb.Append(" iODTOs == null continue");
                        continue;
                    }

                    #region Fix

                    #region remove this
                    bool isActual = true;

                    #endregion

                    List<StaffingNeedsFrequencyIODTO> mergedAndFixed = new List<StaffingNeedsFrequencyIODTO>();
                    if (isActual)
                    {
                        foreach (var group in iODTOs.GroupBy(g => $"{g.ParentExternalCode}#{g.TimeFrom}#{g.TimeTo}#{g.FrequencyType}"))
                        {
                            var newItem = group.First();
                            newItem.NbrOfCustomers = group.Sum(s => s.NbrOfCustomers);
                            newItem.NbrOfItems = group.Sum(s => s.NbrOfItems);
                            newItem.Amount = group.Sum(s => s.Amount);
                            newItem.Cost = group.Sum(s => s.Cost);
                            newItem.NbrOfMinutes = Convert.ToInt32(group.Sum(s => s.NbrOfMinutes));

                            if (!string.IsNullOrEmpty(newItem.ParentExternalCode))
                            {
                                newItem.ExternalCode = group.First().ParentExternalCode; // Just nu sätter vi denna eftersom upphämtningen kollar på externalcode(accountid). TODO fixa skiten
                                newItem.ParentExternalCode = "";
                            }

                            if (newItem.TimeTo == newItem.TimeFrom)
                                newItem.TimeTo = newItem.TimeTo.Replace("00:00:00", "23:59:59");

                            mergedAndFixed.Add(newItem);
                        }
                    }
                    else
                    {
                        mergedAndFixed = iODTOs;
                    }

                    #endregion


                    var staffingNeedsFrequencyIOItem = new StaffingNeedsFrequencyIOItem();
                    staffingNeedsFrequencyIOItem.frequencies = mergedAndFixed;
                    result = ImportStaffingNeedsFrequencyIO(staffingNeedsFrequencyIOItem, TermGroup_IOImportHeadType.StaffingNeedsFrequency, TermGroup_IOSource.Connect, TermGroup_IOType.XEConnect, item.Item1, true);

                    if (!result.Success)
                    {
                        if (string.IsNullOrEmpty(result.ErrorMessage))
                            result.ErrorMessage = string.Empty;

                        result.ErrorMessage = result.ErrorMessage + sb.ToString();
                        LogError($"ImportEDWDataFromSftp failed actorcompanyId {item.Item1} file {item.Item2} {result.ErrorMessage}");
                        sb.Append($"ImportStaffingNeedsFrequencyIO failed {item.Item1} {item.Item2}" + Environment.NewLine);
                        continue;
                    }
                    else
                    {
                        SshUtil sshUtil = new SshUtil(true);
                        sb.Append(Environment.NewLine);
                        string path = !isTest ? Constants.AXFOODPRODUCTIONEDWDATATRANSFERRED : Constants.AXFOODTESTEDWDATATRANSFERRED;
                        sb.Append($"Upload {DateTime.Now} " + item.Item1 + " " + $"{path} {item.Item2}");
                        if (sshUtil.Upload(item.Item3, $@"{path}/{item.Item2}").Success)
                        {
                            sb.Append(Environment.NewLine);
                            sb.Append($"Delete {DateTime.Now} " + item.Item1 + " " + $"{path}/{item.Item2}");
                            var deletePath = !isTest ? Constants.AXFOODPRODUCTIONEDWDATADROP : Constants.AXFOODTESTEDWDATADROP;
                            sshUtil.Delete($@"{deletePath}/{item.Item2}");
                        }
                    }

                    LogInfo("ImportEDWDataFromSftp " + sb.ToString());
                }
                catch (Exception ex)
                {
                    sb.Append(ex.ToString());
                    LogError(ex.ToString() + sb.ToString());
                }
            }

            result.ErrorMessage = sb.ToString();
            return result;
        }

        private List<Tuple<int, string, byte[]>> GetEDWDataFromSftp(List<int> actorCompanyIds)
        {
            var tuple = new List<Tuple<int, string, byte[]>>();
            try
            {
                var isTest = CompDbCache.Instance.SiteType == TermGroup_SysPageStatusSiteType.Test;
                string path = !isTest ? Constants.AXFOODPRODUCTIONEDWDATADROP : Constants.AXFOODTESTEDWDATADROP;

                SshUtil sshUtil = new SshUtil(true);
                var list = sshUtil.ListFiles(path);

                foreach (var actorCompanyId in actorCompanyIds)
                {
                    Company company = CompanyManager.GetCompany(actorCompanyId);
                    if (company == null)
                        continue;

                    var exportId = TimeSalaryManager.GetExternalExportId(actorCompanyId);

                    if (!string.IsNullOrEmpty(exportId))
                    {
                        var fileList = list.Where(l => l.Name.ToLower().Contains($"_{exportId.ToLower()}_") && l.Name.ToLower().Contains(".json.gz")); // Try to get the right files                                                                                                        

                        foreach (var post in fileList)
                        {
                            var data = sshUtil.DownLoad(post.FullName, false);
                            if (data != null)
                                tuple.Add(Tuple.Create(actorCompanyId, post.Name, data));
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                LogError("GetEDWDataFromSftp " + ex.ToString());
            }

            return tuple;
        }

        #endregion

        #endregion

        #endregion

        #region StaffingNeedsHead

        #region Import from StaffingNeedsFrequencyIO

        public ActionResult ImportStaffingNeedHeadFromFrequencyIO(StaffingNeedsFrequencyIOItem staffingNeedsFrequencyIOItem, TermGroup_IOImportHeadType headType, TermGroup_IOSource source, TermGroup_IOType type, int actorCompanyId, bool importToStaffingNeedsFrequency)
        {
            return ImportStaffingNeedHeadFromFrequencyIO(staffingNeedsFrequencyIOItem.frequencies.Where(w => w.FrequencyType == FrequencyType.StaffingNeedsRow).ToList(), actorCompanyId);
        }

        private ActionResult ImportStaffingNeedHeadFromFrequencyIO(List<StaffingNeedsFrequencyIODTO> staffingNeedsFrequencyIOs, int actorCompanyId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var shiftTypes = GetShiftTypesFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId));
            var timeScheduleTasks = TimeScheduleManager.GetTimeScheduleTasks(actorCompanyId, loadAccountHierarchyAccount: true);
            var accounts = AccountManager.GetAccounts(actorCompanyId);

            foreach (var group in staffingNeedsFrequencyIOs.GroupBy(g => $"{g.ExternalCode}#{g.ParentExternalCode}#{g.DateFrom}"))
            {
                var first = group.First();
                var externalCode = first.ExternalCode;
                var parentExternalCode = first.ParentExternalCode;
                var dateFromString = first.DateFrom;

                if (string.IsNullOrEmpty(dateFromString))
                    continue;

                var dateFrom = CalendarUtility.GetDateTime(dateFromString);
                var isWeekDay = dateFrom.Year == 1900;
                var dayOfWeek = isWeekDay ? dateFrom.DayOfWeek : (DayOfWeek?)null;
                var existing = entitiesReadOnly.StaffingNeedsHead.FirstOrDefault(f => f.ActorCompanyId == actorCompanyId && f.Name == group.Key && f.State == (int)SoeEntityState.Active);

                StaffingNeedsHeadDTO staffingNeedsHeadDTO = new StaffingNeedsHeadDTO()
                {
                    Date = isWeekDay ? (DateTime?)null : dateFrom,
                    DayTypeId = null,
                    Weekday = dayOfWeek,
                    Name = group.Key,
                    Interval = 15,
                    AccountId = accounts.FirstOrDefault(w => !string.IsNullOrEmpty(w.ExternalCode) && w.ExternalCode.Trim().ToLower() == externalCode.Trim().ToLower())?.AccountId
                };

                if (existing != null)
                    staffingNeedsHeadDTO.StaffingNeedsHeadId = existing.StaffingNeedsHeadId;

                foreach (var rowGroup in group.GroupBy(g => g.RowKey))
                {
                    var rowFirst = rowGroup.First();
                    var rowExternalCode = rowFirst.ExternalCode;
                    var task = timeScheduleTasks.FirstOrDefault(w => w.Name.Trim().ToLower() == parentExternalCode.Trim().ToLower());

                    if (task?.ShiftTypeId == null)
                        continue;

                    if (!staffingNeedsHeadDTO.AccountId.HasValue && task.AccountId.HasValue)
                        staffingNeedsHeadDTO.AccountId = task.AccountId;

                    var shiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == task.ShiftTypeId);
                    bool valid = false;

                    if (shiftType != null)
                    {
                        StaffingNeedsRowDTO staffingNeedsRowDTO = new StaffingNeedsRowDTO()
                        {
                            ShiftTypeId = shiftType.ShiftTypeId,
                            Date = !isWeekDay ? dateFrom : (DateTime?)null,
                            Weekday = isWeekDay ? dateFrom.DayOfWeek : (DayOfWeek?)null,
                            Type = StaffingNeedsRowType.Normal,
                        };

                        foreach (var period in rowGroup)
                        {
                            StaffingNeedsRowPeriodDTO staffingNeedsRowPeriodDTO = new StaffingNeedsRowPeriodDTO()
                            {
                                ShiftTypeId = shiftType.ShiftTypeId,
                                TimeScheduleTaskId = task.TimeScheduleTaskId,
                                IncomingDeliveryRowId = null,
                                PeriodGuid = Guid.NewGuid(),
                                Interval = 0,
                                Date = null,
                                StartTime = CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, CalendarUtility.GetDateTime(period.TimeFrom)),
                                Value = 1.00m,
                                Length = Convert.ToInt32((CalendarUtility.GetDateTime(period.TimeTo) - CalendarUtility.GetDateTime(period.TimeFrom)).TotalMinutes),
                                IsBreak = false,
                                TimeSlot = null,
                                ParentId = null,
                                IsSpecificNeed = false,
                                IsRemovedNeed = false,
                                Created = DateTime.Now,
                                CreatedBy = "TestRD",
                                Modified = null,
                                ModifiedBy = rowGroup.Key,
                                State = SoeEntityState.Active,
                            };

                            valid = true;
                            staffingNeedsRowDTO.Periods.Add(staffingNeedsRowPeriodDTO);
                        }

                        if (valid)
                            staffingNeedsHeadDTO.Rows.Add(staffingNeedsRowDTO);
                    }
                }

                TimeScheduleManager.SaveStaffingNeedsHead(staffingNeedsHeadDTO, actorCompanyId, null);
            }

            return new ActionResult();
        }

        #endregion

        #endregion

        #region ShiftType

        public List<ShiftTypeIODTO> GetShiftTypeIODTOs(int actorCompanyId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var shiftTypes = TimeScheduleManager.GetShiftTypes(entitiesReadOnly, actorCompanyId, loadAccountInternals: true, loadAccounts: true).ToDTOs(true);
            var scheduleTypes = TimeScheduleManager.GetTimeScheduleTypes(entitiesReadOnly, actorCompanyId);
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var accounts = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<ShiftTypeIODTO> shiftTypeIODTOs = new List<ShiftTypeIODTO>();

            foreach (var shiftType in shiftTypes)
            {
                ShiftTypeIODTO shiftTypeIODTO = new ShiftTypeIODTO()
                {
                    ShiftTypeId = shiftType.ShiftTypeId,
                    TimeScheduleTypeCode = shiftType.TimeScheduleTypeId.HasValue ? scheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == shiftType.TimeScheduleTypeId)?.Code ?? "*" : "",
                    TimeScheduleTemplateBlockType = shiftType.TimeScheduleTemplateBlockType,
                    Name = shiftType.Name,
                    Description = shiftType.Description,
                    Color = shiftType.Color,
                    NeedsCode = shiftType.NeedsCode,
                    ExternalId = shiftType.ExternalId,
                    ExternalCode = shiftType.ExternalCode,
                    DefaultLength = shiftType.DefaultLength,
                    StartTime = shiftType.StartTime,
                    StopTime = shiftType.StopTime,
                    HandlingMoney = shiftType.HandlingMoney,
                    AccountNr = shiftType.AccountId.HasValue ? accounts.FirstOrDefault(f => f.AccountId == shiftType.AccountId)?.AccountNr ?? "*" : ""
                };

                shiftTypeIODTOs.Add(shiftTypeIODTO);
            }

            return shiftTypeIODTOs;
        }

        public ActionResult SaveShiftTypeIODTOs(int actorCompanyId, List<ShiftTypeIODTO> shiftTypeIODTOs)
        {
            List<ShiftTypeDTO> shiftTypeDTOs = new List<ShiftTypeDTO>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var scheduleTypes = TimeScheduleManager.GetTimeScheduleTypes(entitiesReadOnly, actorCompanyId);
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var accounts = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId));
            ActionResult result = new ActionResult();

            foreach (var shiftType in shiftTypeIODTOs)
            {
                ShiftTypeDTO shiftTypeDTO = new ShiftTypeDTO()
                {
                    ShiftTypeId = shiftType.ShiftTypeId,
                    TimeScheduleTemplateBlockType = shiftType.TimeScheduleTemplateBlockType,
                    Name = shiftType.Name,
                    Description = shiftType.Description,
                    Color = shiftType.Color,
                    NeedsCode = shiftType.NeedsCode,
                    ExternalId = shiftType.ExternalId,
                    ExternalCode = shiftType.ExternalCode,
                    DefaultLength = shiftType.DefaultLength,
                    StartTime = shiftType.StartTime,
                    StopTime = shiftType.StopTime,
                    HandlingMoney = shiftType.HandlingMoney,

                };

                if (!string.IsNullOrEmpty(shiftType.TimeScheduleTypeCode))
                    shiftTypeDTO.TimeScheduleTypeId = scheduleTypes.FirstOrDefault(f => f.Code == shiftType.TimeScheduleTypeCode)?.TimeScheduleTypeId;

                if (!string.IsNullOrEmpty(shiftType.AccountNr))
                    shiftTypeDTO.AccountId = accounts.FirstOrDefault(f => f.AccountNr == shiftType.AccountNr)?.AccountId;

                result = TimeScheduleManager.SaveShiftType(shiftTypeDTO, null, null, null, null, actorCompanyId);

                if (!result.Success)
                    return result;
            }

            return result;
        }

        #endregion

        #region LongTermAbsence


        public LongTermAbsenceOutput GetLongTermAbsence(LongTermAbsenceInput input, int actorCompanyId)
        {
            LongTermAbsenceOutput longTermAbsenceOutput = new LongTermAbsenceOutput
            {
                DateFrom = new DateTime(input.DateFrom.Date.Ticks, DateTimeKind.Unspecified),
                DateTo = new DateTime(input.DateTo.Date.Ticks, DateTimeKind.Unspecified)
            };
            var reports = ReportManager.GetReportsByTemplateType(actorCompanyId, base.RoleId, SoeReportTemplateType.LongtermAbsenceAnalysis);
            if (reports.IsNullOrEmpty())
            {
                longTermAbsenceOutput.ErrorMessage = "Report not found";
                return longTermAbsenceOutput;
            }

            int reportId = reports.FirstOrDefault().ReportId;

            #region Load Employees

            var employeeNumbers = input.EmployeeNrs ?? new List<string>();
            if (!employeeNumbers.IsNullOrEmpty())
            {
                employeeNumbers = employeeNumbers.Trim();
                employeeNumbers = employeeNumbers.Where(w => !string.IsNullOrEmpty(w)).ToList();
            }

            var employeeIds = !employeeNumbers.IsNullOrEmpty() ? EmployeeManager.GetAllEmployeeIdsByEmployeeNr(actorCompanyId, employeeNumbers) : null;

            #endregion

            var apiSelection = new ApiMatrixDataSelection()
            {
                ReportId = reportId,
                ApiMatrixEmployeeSelections = new ApiMatrixEmployeeSelection() { EmployeeIds = employeeIds, EmployeeNumbers = input.EmployeeNrs },
                ApiMatrixDataSelectionDateRanges = (new ApiMatrixDataSelectionDateRange() { SelectFrom = input.DateFrom, SelectTo = input.DateTo }).ObjToList(),
                ApiMatrixPayrollProductRowSelections = input.PayrollProductInputs?.Select(s => new ApiMatrixPayrollProductRowSelection()
                {
                    SysPayrollTypeLevel1 = s.SysPayrollTypeLevel1,
                    SysPayrollTypeLevel2 = s.SysPayrollTypeLevel2,
                    SysPayrollTypeLevel3 = s.SysPayrollTypeLevel3,
                    SysPayrollTypeLevel4 = s.SysPayrollTypeLevel4
                })?.ToList()
            };

            apiSelection.ApiMatrixDataSelectionTexts = (new ApiMatrixDataSelectionText()
            {
                StringValue = "1",
                Key = "numberOfDays",
                TypeName = "string"
            }).ObjToList();

            var apiMatrixColumnSelection = new List<ApiMatrixColumnSelection>()
            {
                new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.EmployeeNr).FirstCharToLowerCase()},
                new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.FirstName).FirstCharToLowerCase()},
                new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.LastName).FirstCharToLowerCase()},
                new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.SocialSec).FirstCharToLowerCase()},
                new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.StartDate).FirstCharToLowerCase()},
                new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.StopDateInInterval).FirstCharToLowerCase()},
            };

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var accountDims = base.GetAccountDimsFromCache(entities, CacheConfig.Company(actorCompanyId));

            foreach (var accountDim in accountDims)
            {
                apiMatrixColumnSelection.Add(new ApiMatrixColumnSelection()
                {
                    Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.AccountInternalNrs).FirstCharToLowerCase(),
                    ItemId = accountDim.AccountDimId,

                });
                apiMatrixColumnSelection.Add(new ApiMatrixColumnSelection()
                {
                    Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.AccountInternalNames).FirstCharToLowerCase(),
                    ItemId = accountDim.AccountDimId,
                });
                apiMatrixColumnSelection.Add(new ApiMatrixColumnSelection()
                {
                    Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.EmployeeAccountInternalNrs).FirstCharToLowerCase(),
                    ItemId = accountDim.AccountDimId,

                });
                apiMatrixColumnSelection.Add(new ApiMatrixColumnSelection()
                {
                    Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.EmployeeAccountInternalNames).FirstCharToLowerCase(),
                    ItemId = accountDim.AccountDimId,
                });
            }

            apiSelection.ApiMatrixColumnsSelection = new ApiMatrixColumnsSelection()
            {
                TypeName = "string",
                Key = "string",
                ApiMatrixColumnSelections = apiMatrixColumnSelection,
            };

            if (input.CalculateRatio)
                apiSelection.ApiMatrixColumnsSelection.ApiMatrixColumnSelections.Add(new ApiMatrixColumnSelection() { Field = EnumUtility.GetName<TermGroup_LongtermAbsenceMatrixColumns>(TermGroup_LongtermAbsenceMatrixColumns.Ratio).FirstCharToLowerCase() });

            var selection = apiSelection.ToReportSelectionDefinitionDTO();
            MatrixColumnsSelectionDTO matrixColumnsSelection = apiSelection.ApiMatrixColumnsSelection.ToMatrixColumnsSelectionDTO();
            ReportJobDefinitionDTO job = new ReportJobDefinitionDTO();
            job.ReportId = selection.ReportId;
            job.Selections = selection.Selections;

            if (selection.ReportId != 0)
            {
                CreateReportResult reportResult = ReportDataManager.InitReportResult(job, actorCompanyId, base.UserId, base.RoleId);
                List<LongtermAbsenceReportDataField> fields = new List<LongtermAbsenceReportDataField>();
                if (matrixColumnsSelection?.Columns != null)
                    fields = matrixColumnsSelection.Columns.Select(s => new LongtermAbsenceReportDataField(s)).ToList();

                LongtermAbsenceReportData annualProgressReportData = new LongtermAbsenceReportData(parameterObject, new LongtermAbsenceReportDataInput(reportResult, fields));
                LongtermAbsenceReportDataOutput output = annualProgressReportData.CreateOutput(reportResult);

                if (!output.Result.Success)
                {
                    var trackId = Guid.NewGuid();
                    LogError($"AnnualProgressReportData.CreateOutput(reportResult) failed. TrackId:{trackId}");
                    longTermAbsenceOutput.ErrorMessage += $"AnnualProgressReportData.CreateOutput(reportResult) failed. TrackId:{trackId}";
                    return longTermAbsenceOutput;
                }

                var outputRows = output.LongtermAbsenceItems.Select(s => s.ToLongTermAbsenceOutput());
                longTermAbsenceOutput.Rows = outputRows.ToList();
            }

            return longTermAbsenceOutput;
        }

        #endregion

        #region TimeStamps

        public ActionResult SaveTimeStampEntries(int actorCompanyId, List<TimeStampEntryIODTO> timeStampEntries)
        {
            var employeeNrs = timeStampEntries.Select(s => s.EmployeeNr).Distinct().ToList();
            var employeeIds = EmployeeManager.GetAllEmployeeIdsByEmployeeNr(actorCompanyId, employeeNrs);
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, employeeFilter: employeeIds, active: true);
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var accountInternals = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId)).ToDictionary(k => k.AccountNr.ToString(), v => v);
            var timeTerminalIds = timeStampEntries.Select(s => s.TimeTerminalId).Distinct().ToList();

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var timeTerminals = entitiesReadOnly.TimeTerminal.Where(f => timeTerminalIds.Contains(f.TimeTerminalId) && f.ActorCompanyId == actorCompanyId);

            if (timeTerminalIds.Count > 1 && timeTerminalIds.Count != timeTerminals.Count())
                return new ActionResult(false, 2123123, "No terminal found");

            foreach (var timestampEmployee in timeStampEntries.GroupBy(g => g.EmployeeNr))
            {
                var employee = employees.FirstOrDefault(w => w.EmployeeNr == timestampEmployee.Key);

                if (employee != null)
                {
                    foreach (var timeStampEntryPerDate in timestampEmployee.ToList().GroupBy(g => g.TimeStamp.Date))
                    {
                        List<TimeStampEntryDTO> timeStampEntryDTOs = new List<TimeStampEntryDTO>();

                        foreach (var timeStampEntry in timeStampEntryPerDate)
                        {
                            TimeStampEntryDTO entry = new TimeStampEntryDTO()
                            {
                                EmployeeId = employee.EmployeeId,
                                Time = timeStampEntry.TimeStamp,
                                Type = timeStampEntry.TimeStampEntryType,
                                ActorCompanyId = actorCompanyId,
                                TimeTerminalId = timeStampEntry.TimeTerminalId,
                                IsBreak = timeStampEntry.IsBreak,
                            };

                            if (accountInternals.TryGetValue(timeStampEntry.AccountNr ?? "0", out AccountDTO account))
                            {
                                entry.AccountId = account.AccountId;
                            }

                            timeStampEntryDTOs.Add(entry);
                        }

                        var result = TimeStampManager.SaveTimeStampEntries(timeStampEntryDTOs, timeStampEntryPerDate.Key, employee.EmployeeId, actorCompanyId);

                        if (!result.Success)
                            return new ActionResult(false, 234234, "TimeStampEntry on " + employee.EmployeeNr + " failed");
                    }
                }
            }

            return new ActionResult();
        }

        public List<TimeStampEntryIODTO> GetTimeStampEntryIODTOs(int actorCompanyId, DateTime dateFrom, DateTime dateTo, List<string> employeeNumbers)
        {
            employeeNumbers = employeeNumbers?
                .Select(f => f?.Trim())
                .Where(w => !string.IsNullOrEmpty(w))
                .ToList();

            var employeeIds = !employeeNumbers.IsNullOrEmpty() ? EmployeeManager.GetAllEmployeeIdsByEmployeeNr(actorCompanyId, employeeNumbers) : null;
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, parameterObject.UserId, parameterObject.RoleId, employeeFilter: employeeIds, active: true);

            employees = employeeNumbers != null && employeeNumbers.Any() ? employees.Where(e => employeeNumbers.Contains(e.EmployeeNr)).ToList() : employees;

            var timeStampEntries = TimeStampManager.GetTimeStampEntriesDTO(dateFrom, dateTo, employees, actorCompanyId);
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var accountInternals = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId)).ToDictionary(k => k.AccountId, v => v);
            var accountDims = base.GetAccountDimsFromCache(entities, CacheConfig.Company(actorCompanyId));

            List<TimeStampEntryIODTO> timeStampEntryIODTOs = new List<TimeStampEntryIODTO>();

            foreach (var timeStampEntryEmployee in timeStampEntries.GroupBy(g => g.EmployeeId))
            {
                var employee = employees.FirstOrDefault(f => f.EmployeeId == timeStampEntryEmployee.Key);

                if (employee == null)
                    continue;

                foreach (var timeStampEntry in timeStampEntryEmployee)
                {
                    TimeStampEntryIODTO timeStampEntryIODTO = new TimeStampEntryIODTO()
                    {
                        TimeStamp = timeStampEntry.Time,
                        EmployeeNr = employee.EmployeeNr,
                        EmployeeExternalCode = employee.ExternalCode,
                        TimeTerminalId = timeStampEntry.TimeTerminalId,
                        IsBreak = timeStampEntry.IsBreak,
                    };

                    if (accountInternals.TryGetValue(timeStampEntry.AccountId ?? 0, out AccountDTO account))
                    {
                        timeStampEntryIODTO.AccountNr = account.AccountNr;
                        timeStampEntryIODTO.SieAccountDim = accountDims.FirstOrDefault(f => f.AccountDimId == account.AccountDimId).SysSieDimNr;

                        TimeStampEntryIOAccountDTO extendedAccount = new TimeStampEntryIOAccountDTO()
                        {
                            AccountNr = account.AccountNr,
                            SieAccountDim = accountDims.FirstOrDefault(f => f.AccountDimId == account.AccountDimId).SysSieDimNr,
                        };
                        timeStampEntryIODTO.Accounts.Add(extendedAccount);
                    }

                    if (!timeStampEntry.Extended.IsNullOrEmpty())
                    {
                        foreach (var extended in timeStampEntry.Extended)
                        {
                            if (accountInternals.TryGetValue(extended.AccountId ?? 0, out AccountDTO extendedAccount))
                            {
                                TimeStampEntryIOAccountDTO extendedAccountDTO = new TimeStampEntryIOAccountDTO()
                                {
                                    AccountNr = extendedAccount.AccountNr,
                                    SieAccountDim = accountDims.FirstOrDefault(f => f.AccountDimId == extendedAccount.AccountDimId).SysSieDimNr,
                                };
                                timeStampEntryIODTO.Accounts.Add(extendedAccountDTO);
                            }
                        }
                    }

                    timeStampEntryIODTOs.Add(timeStampEntryIODTO);
                }
            }

            return timeStampEntryIODTOs;
        }

        #endregion

        #region TimeMigration

        public ActionResult ExecuteMigration(TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);

            if (useAccountHierarchy)
                return new ActionResult("Migration already completed");

            string validationErrors = timeMigrationItem.ValidationErrors().Trim();

            if (!string.IsNullOrEmpty(validationErrors))
            {
                LogCollector.LogError("Migration validation failed " + validationErrors);
                return new ActionResult("Validation failed " + Environment.NewLine + validationErrors);
            }
            ActionResult result;
            using (CompEntities entities = new CompEntities())
            {
                result = ExecuteMigrationEmployee(entities, timeMigrationItem, actorCompanyId);
                if (!result.Success)
                    return result;

                LogCollector.LogInfo($"ExecuteMigrationEmployee done {actorCompanyId}");

                result = ExecuteMigrationAttestRole(entities, timeMigrationItem, actorCompanyId);
                if (!result.Success)
                    return result;

                LogCollector.LogInfo($"ExecuteMigrationAttestRole done {actorCompanyId}");

                if (timeMigrationItem.SetAllAccountLevelsOnShiftTypes)
                    ExecuteAccountingOnShiftType(entities, timeMigrationItem, actorCompanyId);

                LogCollector.LogInfo($"ExecuteAccountingOnShiftType done {actorCompanyId}");

                ExecuteMigrationTimeTerminal(entities, timeMigrationItem, actorCompanyId);
                LogCollector.LogInfo($"ExecuteMigrationTimeTerminal done {actorCompanyId}");
                ExecuteMigrationMessagegroup(entities, timeMigrationItem, actorCompanyId);
                LogCollector.LogInfo($"ExecuteMigrationMessagegroup done {actorCompanyId}");

                if (result.Success)
                {
                    int? accountDimId = timeMigrationItem.GetAccountDim();
                    SettingManager.UpdateInsertBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseAccountHierarchy, true, 0, actorCompanyId, 0);

                    if (accountDimId.HasValue)
                    {
                        SettingManager.UpdateInsertIntSetting(SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimEmployee, accountDimId.Value, 0, actorCompanyId, 0);
                        SettingManager.UpdateInsertIntSetting(SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimSelector, accountDimId.Value, 0, actorCompanyId, 0);
                    }
                }

                result = ExecuteMigrationSetAccountOnScheduleBlocks(entities, timeMigrationItem, actorCompanyId);
                if (!result.Success)
                    return result;

                result = ExecuteMigrationAdjustAccountingOnBlocksAccordingToShifts(entities, timeMigrationItem, actorCompanyId);
                if (!result.Success)
                    return result;


            }

            return result;
        }

        private ActionResult ExecuteMigrationEmployee(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            List<int> employeeIds = EmployeeManager.GetAllEmployeeIds(entities, actorCompanyId, getVacant: true);
            List<EmployeeAccount> employeeAccounts = new List<EmployeeAccount>();
            List<EmployeeAccount> existing = entities.EmployeeAccount.Where(w => w.ActorCompanyId == actorCompanyId).ToList();
            DateTime now = DateTime.Now;

            foreach (var employeeId in employeeIds)
            {
                var categories = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Employee, SoeCategoryRecordEntity.Employee, employeeId, actorCompanyId);

                if (!existing.Any(a => a.EmployeeId == employeeId && a.State == (int)SoeEntityState.Active))
                {
                    foreach (var categoryRecord in categories)
                    {
                        var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.FromCategory.CategoryId == categoryRecord.CategoryId);

                        if (employeeCategoryMigration != null)
                        {
                            EmployeeAccount employeeAccount = new EmployeeAccount()
                            {
                                EmployeeId = employeeId,
                                AccountId = employeeCategoryMigration.ToAccount.AccountId,
                                ActorCompanyId = actorCompanyId,
                                Default = categoryRecord.Default,
                                Created = now,
                                CreatedBy = "TimeMigration"
                            };

                            if (categoryRecord.DateFrom.HasValue)
                                employeeAccount.DateFrom = categoryRecord.DateFrom.Value;
                            else
                                employeeAccount.DateFrom = CalendarUtility.DATETIME_DEFAULT;

                            if (categoryRecord.DateTo.HasValue)
                                employeeAccount.DateTo = categoryRecord.DateTo;

                            if (!employeeAccounts.Any(a => a.EmployeeId == employeeAccount.EmployeeId && a.AccountId == employeeAccount.AccountId && a.DateFrom == employeeAccount.DateFrom && a.DateTo == employeeAccount.DateTo))
                                employeeAccounts.Add(employeeAccount);
                        }
                    }
                }
            }

            return BulkInsert(entities, employeeAccounts);
        }

        private ActionResult ExecuteMigrationAttestRole(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            List<AttestRoleUser> attestRoleUsers = new List<AttestRoleUser>();
            List<AttestRoleUser> updatedAttestRoleUsers = new List<AttestRoleUser>();
            List<AttestRoleUser> existing = entities.AttestRoleUser.Include("AttestRole").Where(a => a.AttestRole.ActorCompanyId == actorCompanyId && a.State == (int)SoeEntityState.Active).ToList();
            DateTime now = DateTime.Now;
            foreach (var attestRole in timeMigrationItem.AttestRoleCategoryMigrations)
            {
                if (attestRole.FromAttestRole.ShowAllCategories)
                    continue;

                var userIds = AttestManager.GetAttestUserIds(entities, attestRole.FromAttestRole.AttestRoleId, SoeModule.Time);
                var categories = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Employee, SoeCategoryRecordEntity.AttestRole, attestRole.FromAttestRole.AttestRoleId, actorCompanyId);
                var secondaryCategories = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Employee, SoeCategoryRecordEntity.AttestRoleSecondary, attestRole.FromAttestRole.AttestRoleId, actorCompanyId);

                foreach (var categoryRecord in categories)
                {
                    var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.FromCategory.CategoryId == categoryRecord.CategoryId);

                    if (employeeCategoryMigration != null)
                    {
                        foreach (var userid in userIds)
                        {

                            if (!existing.Any(a => a.UserId == userid && a.AttestRoleId == attestRole.ToAttestRole.AttestRoleId && a.AccountId == employeeCategoryMigration.ToAccount.AccountId))
                            {
                                AttestRoleUser attestRoleUser = new AttestRoleUser()
                                {
                                    UserId = userid,
                                    AccountId = employeeCategoryMigration.ToAccount.AccountId,
                                    IsExecutive = categoryRecord.IsExecutive,
                                    AttestRoleId = attestRole.ToAttestRole.AttestRoleId,
                                    Created = now,
                                    CreatedBy = "TimeMigration",
                                };

                                if (categoryRecord.DateFrom.HasValue)
                                    attestRoleUser.DateFrom = categoryRecord.DateFrom.Value;
                                else
                                    attestRoleUser.DateFrom = null;

                                if (categoryRecord.DateTo.HasValue)
                                    attestRoleUser.DateTo = categoryRecord.DateTo;

                                if (!attestRoleUsers.Any(a => a.UserId == userid && a.AttestRoleId == attestRoleUser.AttestRoleId && a.AccountId == attestRoleUser.AccountId && a.DateFrom == attestRoleUser.DateFrom && a.DateTo == attestRoleUser.DateTo))
                                    attestRoleUsers.Add(attestRoleUser);
                                else
                                {
                                    var role = attestRoleUsers.FirstOrDefault(a => a.UserId == userid && a.AttestRoleId == attestRoleUser.AttestRoleId && a.AccountId == attestRoleUser.AccountId);

                                    if (role != null && role.AccountPermissionType == (int)TermGroup_AttestRoleUserAccountPermissionType.Secondary)
                                    {
                                        role.DateFrom = attestRoleUser.DateFrom;
                                        role.DateTo = attestRoleUser.DateFrom;
                                        role.AccountPermissionType = (int)TermGroup_AttestRoleUserAccountPermissionType.Complete;
                                    }
                                }

                                var oldAttestRoleUser = existing.FirstOrDefault(w => w.State == (int)SoeEntityState.Active && w.AttestRoleId == attestRole.FromAttestRole.AttestRoleId && w.UserId == userid);

                                if (oldAttestRoleUser != null && !updatedAttestRoleUsers.Any(a => a.AttestRoleUserId == oldAttestRoleUser.AttestRoleUserId))
                                {
                                    oldAttestRoleUser.State = (int)SoeEntityState.Deleted;
                                    oldAttestRoleUser.Modified = now;
                                    oldAttestRoleUser.ModifiedBy = "TimeMigration";
                                    updatedAttestRoleUsers.Add(oldAttestRoleUser);
                                }
                            }
                        }
                    }
                }

                foreach (var categoryRecord in secondaryCategories)
                {
                    var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.FromCategory.CategoryId == categoryRecord.CategoryId);

                    if (employeeCategoryMigration != null)
                    {
                        foreach (var userid in userIds)
                        {

                            if (!existing.Any(a => a.UserId == userid && a.AttestRoleId == attestRole.ToAttestRole.AttestRoleId && a.AccountId == employeeCategoryMigration.ToAccount.AccountId))
                            {
                                AttestRoleUser attestRoleUser = new AttestRoleUser()
                                {
                                    UserId = userid,
                                    AccountId = employeeCategoryMigration.ToAccount.AccountId,
                                    IsExecutive = categoryRecord.IsExecutive,
                                    AttestRoleId = attestRole.ToAttestRole.AttestRoleId,
                                    AccountPermissionType = (int)TermGroup_AttestRoleUserAccountPermissionType.Secondary,
                                    Created = now,
                                    CreatedBy = "TimeMigration"
                                };

                                if (categoryRecord.DateFrom.HasValue)
                                    attestRoleUser.DateFrom = categoryRecord.DateFrom.Value;
                                else
                                    attestRoleUser.DateFrom = null;

                                if (categoryRecord.DateTo.HasValue)
                                    attestRoleUser.DateTo = categoryRecord.DateTo;

                                if (!attestRoleUsers.Any(a => a.UserId == userid && a.AttestRoleId == attestRoleUser.AttestRoleId && a.AccountId == attestRoleUser.AccountId && a.DateFrom == attestRoleUser.DateFrom && a.DateTo == attestRoleUser.DateTo))
                                    attestRoleUsers.Add(attestRoleUser);

                                var oldAttestRoleUser = existing.FirstOrDefault(w => w.State == (int)SoeEntityState.Active && w.AttestRoleId == attestRole.FromAttestRole.AttestRoleId && w.UserId == userid);

                                if (oldAttestRoleUser != null && !updatedAttestRoleUsers.Any(a => a.AttestRoleUserId == oldAttestRoleUser.AttestRoleUserId))
                                {
                                    oldAttestRoleUser.State = (int)SoeEntityState.Deleted;
                                    oldAttestRoleUser.Modified = now;
                                    oldAttestRoleUser.ModifiedBy = "TimeMigration";
                                    updatedAttestRoleUsers.Add(oldAttestRoleUser);
                                }

                            }
                        }
                    }
                }
            }

            BulkInsert(entities, attestRoleUsers);
            BulkUpdate(entities, updatedAttestRoleUsers);
            return new ActionResult();
        }

        private void ExecuteAccountingOnShiftType(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            try
            {
                List<ShiftType> shiftTypes = TimeScheduleManager.GetShiftTypes(entities, actorCompanyId, loadAccountInternals: true, loadAccounts: true);
                if (shiftTypes.IsNullOrEmpty())
                    return;

                List<AccountInternal> accountInternals = AccountManager.GetAccountInternals(entities, actorCompanyId, null);

                foreach (ShiftType shiftType in shiftTypes)
                {
                    ShiftTypeDTO match = timeMigrationItem.ShiftTypes.FirstOrDefault(f => f.ShiftTypeId == shiftType.ShiftTypeId); //already with new AccountInternals
                    if (match != null && !match.AccountInternals.IsNullOrEmpty())
                    {
                        shiftType.AccountInternal.Clear();

                        foreach (var ai in match.AccountInternals)
                        {
                            AccountInternal accountInternal = accountInternals.FirstOrDefault(f => f.AccountId == ai.Value.AccountId);
                            if (accountInternal != null)
                                shiftType.AccountInternal.Add(accountInternal);
                        }
                    }
                }

                SaveChanges(entities);
            }
            catch (Exception ex)
            {
                LogCollector.LogError(ex.ToString());
            }

        }

        private ActionResult ExecuteMigrationSetAccountOnScheduleBlocks(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            List<int> employeeIds = EmployeeManager.GetAllEmployeeIds(entities, actorCompanyId, getHidden: true, getVacant: true);
            List<TimeScheduleTemplateBlock> updatedTimeScheduleTemplateBlocks = new List<TimeScheduleTemplateBlock>();
            Dictionary<int, List<CompanyCategoryRecord>> categoryDict = new Dictionary<int, List<CompanyCategoryRecord>>();
            var allRecords = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Employee, actorCompanyId);
            bool hasShiftTypeMigrations = !timeMigrationItem.ShiftTypeMigrations.Where(w => w.ValidationError == "").IsNullOrEmpty();
            Dictionary<int, int> dict = timeMigrationItem.ShiftTypeMigrations.Where(w => w.ValidationError == "" && w.FromShiftType != null && w.ToShiftType != null).ToDictionary(a => a.FromShiftType.ShiftTypeId, b => b.ToShiftType.ShiftTypeId);
            timeMigrationItem.EmployeeCategoryMigrations = timeMigrationItem.EmployeeCategoryMigrations.Where(w => w.ValidationError == "").ToList();
            var hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
            foreach (var item in allRecords.GroupBy(g => g.RecordId))
                categoryDict.Add(item.Key, item.ToList());

            int updated = 0;
            int savings = 1;

            foreach (var employeeId in employeeIds)
            {
                Employee employee = null;
                var blocks = entities.TimeScheduleTemplateBlock.Include("AccountInternal").Where(w => w.EmployeeId == employeeId && w.State == (int)SoeEntityState.Active && !w.AccountId.HasValue).ToList();
                blocks = blocks.Where(w => !w.IsBreak).ToList();
                var ishidden = employeeId == hiddenEmployeeId;

                if (!blocks.IsNullOrEmpty())
                {
                    bool employeeHasShiftTypeMigration = (hasShiftTypeMigrations && blocks.Any(a => a.ShiftTypeId.HasValue && dict.Any(f => f.Key == a.ShiftTypeId.Value)));

                    foreach (var block in blocks)
                    {
                        int? accountId = null;

                        if (block.ShiftTypeId.HasValue)
                        {
                            var shiftType = timeMigrationItem.ShiftTypes.FirstOrDefault(f => f.ShiftTypeId == block.ShiftTypeId.Value);

                            if (shiftType != null)
                            {
                                var employeeCategoryMigration = shiftType?.ShiftTypeId != null ? timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.ToAccount.AccountId == shiftType.AccountId) : null;

                                if (employeeCategoryMigration != null)
                                {
                                    accountId = employeeCategoryMigration.ToAccount.AccountId;
                                }
                                else
                                {
                                    foreach (var ai in shiftType.AccountInternals.Where(w => w.Value != null))
                                    {
                                        employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.ToAccount.AccountId == ai.Value.AccountId);

                                        if (employeeCategoryMigration != null)
                                        {
                                            accountId = employeeCategoryMigration.ToAccount.AccountId;
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        if (!accountId.HasValue)
                        {
                            foreach (var ai in block.AccountInternal)
                            {
                                var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.ToAccount.AccountId == ai.AccountId);

                                if (employeeCategoryMigration != null)
                                {
                                    accountId = employeeCategoryMigration.ToAccount.AccountId;
                                    break;
                                }
                            }
                        }

                        if (!ishidden && !accountId.HasValue)
                        {
                            if (employee == null)
                                employee = EmployeeManager.GetEmployee(entities, employeeId, actorCompanyId, onlyActive: false, loadEmployment: true);

                            if (employee != null)
                            {
                                var employment = employee.GetEmployment(block.Date);

                                if (employment != null)
                                {
                                    if (!employment.EmploymentAccountStd.IsLoaded)
                                        employment.EmploymentAccountStd.Load();

                                    if (!employment.EmploymentAccountStd.IsNullOrEmpty())
                                    {
                                        foreach (var a in employment.EmploymentAccountStd)
                                        {
                                            if (!a.AccountInternal.IsLoaded)
                                                a.AccountInternal.Load();
                                        }

                                        foreach (var item in employment.EmploymentAccountStd)
                                        {
                                            foreach (var ai in item.AccountInternal)
                                            {
                                                var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.ToAccount.AccountId == ai.AccountId);

                                                if (employeeCategoryMigration != null)
                                                {
                                                    accountId = employeeCategoryMigration.ToAccount.AccountId;
                                                    break;
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }

                        if (!accountId.HasValue && employee != null)
                        {
                            var pair = categoryDict.FirstOrDefault(f => f.Key == employeeId);
                            CompanyCategoryRecord record = null;
                            foreach (var item in pair.Value)
                            {
                                bool isValidOnDate = true;
                                if (block.Date.HasValue)
                                    isValidOnDate = item.IsDateValid(block.Date.Value);
                                else
                                    isValidOnDate = item.IsDateValid(DateTime.Today);

                                if (isValidOnDate)
                                {
                                    record = item;
                                    break;
                                }
                            }

                            if (record != null)
                            {
                                var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.FromCategory.CategoryId == record.CategoryId);
                                if (employeeCategoryMigration != null)
                                    accountId = employeeCategoryMigration.ToAccount.AccountId;
                            }
                        }
                        bool shiftTypeChanged = false;
                        if (employeeHasShiftTypeMigration && block.ShiftTypeId.HasValue && dict.ContainsKey(block.ShiftTypeId.Value))
                        {
                            block.ShiftTypeId = dict.GetValue(block.ShiftTypeId.Value);
                            shiftTypeChanged = true;
                        }

                        if (accountId.HasValue || shiftTypeChanged)
                        {
                            if (accountId.HasValue)
                                block.AccountId = accountId;

                            updatedTimeScheduleTemplateBlocks.Add(block);
                            updated++;
                        }

                        if (updated > 5000)
                        {
                            LogCollector.LogInfo("Saving 5000 ExecuteMigrationSetAccountOnScheduleBlocks " + savings.ToString());
                            BulkUpdate(entities, updatedTimeScheduleTemplateBlocks);
                            updated = 0;
                            updatedTimeScheduleTemplateBlocks = new List<TimeScheduleTemplateBlock>();
                            savings++;
                        }
                    }
                }
            }

            return BulkUpdate(entities, updatedTimeScheduleTemplateBlocks);
        }

        private ActionResult ExecuteMigrationAdjustAccountingOnBlocksAccordingToShifts(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            List<Account> accounts = entities.Account.Include("AccountInternal").Where(w => w.ActorCompanyId == actorCompanyId).ToList();
            List<ShiftType> shiftTypes = entities.ShiftType.Include("AccountInternal.Account").Where(w => w.ActorCompanyId == actorCompanyId).ToList();
            List<AccountDim> accountDims = entities.AccountDim.Where(w => w.ActorCompanyId == actorCompanyId).ToList();

            int savings = 0;
            foreach (var item in timeMigrationItem.ShiftTypeMigrations.Where(w => w.ValidationError == "" && w.StartDateRecalculateAccountingOnShifts > DateTime.Now.AddYears(-100)))
            {
                var blocks = entities.TimeScheduleTemplateBlock.Where(w => w.EmployeeId.HasValue && w.ShiftTypeId == item.ToShiftType.ShiftTypeId && w.State == (int)SoeEntityState.Active && w.Date.HasValue && w.Date.Value >= item.StartDateRecalculateAccountingOnShifts).Select(s => new { s.EmployeeId, s.TimeScheduleTemplateBlockId }).ToList();
                if (!blocks.IsNullOrEmpty())
                {
                    List<int> blockIds = blocks.Select(s => s.TimeScheduleTemplateBlockId).ToList();
                    while (blockIds.Any())
                    {
                        var currentIds = blockIds.Take(2000).ToList();
                        var employeeIds = blocks.Select(s => s.EmployeeId.Value).Distinct().ToList();
                        TimeScheduleManager.ResetAccountingAccordingToShiftType(entities, actorCompanyId, item.StartDateRecalculateAccountingOnShifts, DateTime.Now.AddYears(100), employeeIds, currentIds, accounts, shiftTypes, accountDims);
                        savings++;

                        blockIds = blockIds.Where(w => !currentIds.Contains(w)).ToList();
                        if (savings % 100 == 0)
                            LogCollector.LogInfo("Saving ExecuteMigrationAdjustAccountingOnBlocksAccordingToShifts " + (savings * 2000).ToString());
                    }
                }
            }

            return new ActionResult();
        }

        private ActionResult ExecuteMigrationTimeTerminal(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            try
            {
                var timeTerminals = TimeStampManager.GetAllTimeTerminals(entities).Where(w => w.ActorCompanyId == actorCompanyId).ToList();
                DateTime now = DateTime.Now;

                foreach (var timeTerminal in timeTerminals)
                {
                    var categories = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Employee, SoeCategoryRecordEntity.TimeTerminal, timeTerminal.TimeTerminalId, actorCompanyId);
                    List<int> accountIds = new List<int>();

                    foreach (var categoryRecord in categories)
                    {
                        var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.FromCategory.CategoryId == categoryRecord.CategoryId);

                        if (employeeCategoryMigration != null)
                            accountIds.Add(employeeCategoryMigration.ToAccount.AccountId);
                    }

                    if (accountIds.Any())
                    {
                        int count = 1;
                        TimeTerminalSetting parent = null;

                        var existingSetting =
                            timeTerminal.TimeTerminalSetting.FirstOrDefault(f => f.Type == (int)TimeTerminalSettingType.LimitTimeTerminalToAccount) ??
                            timeTerminal.TimeTerminalSetting.FirstOrDefault(f => f.Type == (int)TimeTerminalSettingType.LimitTimeTerminalToCategories);
                        if (existingSetting == null)
                        {
                            existingSetting = new TimeTerminalSetting()
                            {
                                Type = (int)TimeTerminalSettingType.LimitTimeTerminalToAccount,
                                DataType = (int)TimeTerminalSettingDataType.Boolean,
                                BoolData = true,
                                Name = Enum.GetName(typeof(TimeTerminalSettingType), TimeTerminalSettingType.LimitTimeTerminalToAccount),
                                TimeTerminal = timeTerminal,
                                State = (int)SoeEntityState.Active,
                                Created = now
                            };

                            entities.TimeTerminalSetting.AddObject(existingSetting);
                        }
                        else
                        {
                            existingSetting.Type = (int)TimeTerminalSettingType.LimitTimeTerminalToAccount;
                            existingSetting.Name = Enum.GetName(typeof(TimeTerminalSettingType), TimeTerminalSettingType.LimitTimeTerminalToAccount);
                            existingSetting.BoolData = true;
                            existingSetting.Modified = now;
                        }

                        var existingSettingLimitAccount = timeTerminal.TimeTerminalSetting.FirstOrDefault(f => f.Type == (int)TimeTerminalSettingType.LimitAccount);

                        if (existingSettingLimitAccount != null)
                        {
                            existingSettingLimitAccount.State = (int)SoeEntityState.Deleted;
                            existingSettingLimitAccount.Modified = now;
                        }

                        foreach (var id in accountIds)
                        {
                            var timeTerminalSetting = new TimeTerminalSetting()
                            {
                                Type = (int)TimeTerminalSettingType.LimitAccount,
                                DataType = (int)TimeTerminalSettingDataType.Integer,
                                IntData = id,
                                Name = Enum.GetName(typeof(TimeTerminalSettingType), TimeTerminalSettingType.LimitAccount),
                                TimeTerminal = timeTerminal,
                                State = (int)SoeEntityState.Active,
                                Created = now
                            };

                            if (count == 1)
                            {
                                parent = timeTerminalSetting;
                            }
                            else
                            {
                                timeTerminalSetting.Parent = parent;
                            }

                            entities.TimeTerminalSetting.AddObject(timeTerminalSetting);

                            count++;
                        }
                    }
                }
                return SaveChanges(entities);
            }
            catch (Exception ex)
            {
                LogCollector.LogError(ex.ToString());
                return new ActionResult(ex);
            }
        }

        private ActionResult ExecuteMigrationMessagegroup(CompEntities entities, TimeMigrationItem timeMigrationItem, int actorCompanyId)
        {
            try
            {
                var messageGroups = CommunicationManager.GetMessageGroups(entities, actorCompanyId);
                List<MessageGroupMapping> newMappings = new List<MessageGroupMapping>();

                foreach (var messageGroup in messageGroups)
                {
                    var mapping = messageGroup.MessageGroupMapping;

                    if (mapping.IsNullOrEmpty())
                        continue;

                    foreach (var map in mapping.Where(w => w.Entity == (int)SoeEntityType.Category))
                    {
                        var employeeCategoryMigration = timeMigrationItem.EmployeeCategoryMigrations.FirstOrDefault(f => f.FromCategory.CategoryId == map.RecordId);

                        if (employeeCategoryMigration != null)
                        {
                            var messageGroupMapping = new MessageGroupMapping()
                            {
                                RecordId = employeeCategoryMigration.ToAccount.AccountId,
                                MessageGroupId = messageGroup.MessageGroupId
                            };

                            SetCreatedProperties(messageGroupMapping);
                            newMappings.Add(messageGroupMapping);
                        }
                    }
                }

                foreach (var map in newMappings)
                    entities.MessageGroupMapping.AddObject(map);

                return SaveChanges(entities);
            }
            catch (Exception ex)
            {
                LogCollector.LogError(ex.ToString());
                return new ActionResult(ex);
            }
        }

        #endregion

        #region FileImportHead

        public List<FileImportHead> GetFileImports(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.FileImportHead.NoTracking();
            return GetFileImports(entities, actorCompanyId);
        }

        public List<FileImportHead> GetFileImports(CompEntities compEntities, int actorCompanyId)
        {
            return (from f in compEntities.FileImportHead
                    where f.ActorCompanyId == actorCompanyId
                    orderby f.Created descending
                    select f).ToList();
        }

        public List<FileImportHeadGridDTO> GetFileImportGrid(int actorCompanyId)
        {
            var statusTerms = GetTermGroupDict(TermGroup.FileImportStatus);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.FileImportHead.NoTracking();
            return GetFileImports(entitiesReadOnly, actorCompanyId)
                            .ToGridDTOs(statusTerms.ToSmallGenericTypes())
                            .ToList();
        }

        public FileImportHeadDTO GetFileImportHeadDTO(int actorCompanyId, int fileImportHeadId)
        {
            return GetFileImportHead(actorCompanyId, fileImportHeadId).ToDTO();
        }

        public FileImportHead GetFileImportHead(int actorCompanyId, int fileImportHeadId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.FileImportHead.NoTracking();
            return GetFileImportHead(entities, actorCompanyId, fileImportHeadId);
        }

        public FileImportHead GetFileImportHead(CompEntities compEntities, int actorCompanyId, int fileImportHeadId)
        {
            if (fileImportHeadId == 0)
                return null;

            return compEntities
                        .FileImportHead
                        .FirstOrDefault(f =>
                            f.ActorCompanyId == actorCompanyId &&
                            f.FileImportHeadId == fileImportHeadId
                        );
        }

        public ActionResult SaveFileImportHead(FileImportHeadDTO fileImportHeadDto)
        {
            using (CompEntities compEntities = new CompEntities())
            {
                return SaveFileImportHead(compEntities, fileImportHeadDto);
            }
        }

        public ActionResult SaveFileImportHead(CompEntities compEntities, FileImportHeadDTO fileImportHeadDto)
        {
            if (fileImportHeadDto == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "FileImportHead");

            ActionResult result = new ActionResult();

            try
            {
                var fileImport = GetFileImportHead(compEntities, fileImportHeadDto.ActorCompanyId, fileImportHeadDto.FileImportHeadId);
                if (fileImport is null)
                {
                    fileImport = new FileImportHead
                    {
                        ActorCompanyId = fileImportHeadDto.ActorCompanyId,
                        EntityType = fileImportHeadDto.EntityType,
                        BatchId = Guid.NewGuid(),
                        FileName = fileImportHeadDto.FileName,
                        Status = fileImportHeadDto.Status
                    };
                    SetCreatedProperties(fileImport);
                    compEntities.FileImportHead.AddObject(fileImport);

                    result = SaveChanges(compEntities);

                    if (result.Success)
                        result.IntegerValue = fileImport.FileImportHeadId;
                }
                else
                {
                    fileImport.Status = fileImportHeadDto.Status;
                    fileImport.SystemMessage = fileImportHeadDto.SystemMessage;
                    fileImport.Comment = !string.IsNullOrWhiteSpace(fileImport.Comment) && !string.IsNullOrWhiteSpace(fileImportHeadDto.Comment)
                                            ? fileImportHeadDto.Comment
                                            : fileImport.Comment;

                    SetModifiedProperties(fileImport);
                    result = SaveChanges(compEntities);
                }
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
            }

            return result;
        }

        #endregion

        #region LeaveRequests

        public List<LeaveRequest> GetLeaveRequests(int actorCompanyId,
                                                DateTime dateFrom,
                                                DateTime dateTo,
                                                List<string> employeeNumbers,
                                                List<int> employeeRequestIds,
                                                DateTime? createdOrModifiedAfter,
                                                DateTime? createdAfter,
                                                DateTime? modifiedAfter,
                                                bool includeAffectedShifts = false,
                                                bool includeAffectedPeriods = false)
        {

            #region check permissions

            if (!FeatureManager.HasRolePermission(Feature.Time_Schedule_AbsenceRequests, Permission.Readonly, parameterObject.RoleId, actorCompanyId))
                return new List<LeaveRequest>();

            #endregion

            #region employeeIds

            if (!employeeNumbers.IsNullOrEmpty())
            {
                employeeNumbers = employeeNumbers.Trim();
                employeeNumbers = employeeNumbers.Where(w => !string.IsNullOrEmpty(w)).ToList();
            }

            List<int> employeeIds = null;

            if (!employeeNumbers.IsNullOrEmpty())
            {
                employeeIds = EmployeeManager.GetAllEmployeeIdsByEmployeeNr(actorCompanyId, employeeNumbers);
                if (employeeIds.IsNullOrEmpty())
                {
                    return new List<LeaveRequest>();
                }
            }

            #endregion

            #region get requests

            TimeEngineManager timeEngineManager = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);

            int employeeId = employeeIds?.Count == 1 ? employeeIds[0] : 0;
            int? employeeRequestId = employeeRequestIds?.Count == 1 ? employeeRequestIds[0] : null;

            List<EmployeeRequest> employeeRequests = timeEngineManager.GetEmployeeRequests(employeeId,
                employeeRequestId,
                new List<TermGroup_EmployeeRequestType>() { TermGroup_EmployeeRequestType.AbsenceRequest },
                dateFrom,
                dateTo,
                ignoreState: true
                );

            employeeRequests = employeeRequests
                .Where(r =>
                    (employeeIds.IsNullOrEmpty() || employeeIds.Contains(r.EmployeeId)) &&
                    (employeeRequestIds.IsNullOrEmpty() || employeeRequestIds.Contains(r.EmployeeRequestId)) &&
                    (createdOrModifiedAfter == null || r.Created >= createdOrModifiedAfter || r.Modified >= createdOrModifiedAfter) &&
                    (createdAfter == null || r.Created >= createdAfter) &&
                    (modifiedAfter == null || r.Modified >= modifiedAfter)
                )
                .ToList();

            #endregion

            #region functions

            static string ChildName(EmployeeChild child)
            {
                if (child == null)
                    return null;

                string fullName = $"{child.FirstName} {child.LastName}".Trim();

                if (!string.IsNullOrEmpty(fullName))
                    return fullName;
                else if (child.BirthDate.HasValue)
                    return child.BirthDate.Value.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
                else
                    return string.Empty; // no name or birthdate, but the child exists
            }

            #endregion

            #region create result

            TimeScheduleManager timeScheduleManager = includeAffectedShifts || includeAffectedPeriods ? new TimeScheduleManager(parameterObject) : null;
            List<LeaveRequest> leaveRequests = new List<LeaveRequest>();

            foreach (var request in employeeRequests)
            {
                EmployeeRequest currentRequest = request;
                if (request.ExtendedAbsenceSettingId.HasValue)
                    currentRequest = timeEngineManager.LoadEmployeeRequest(request.EmployeeRequestId);

                List<LeaveRequestAffectedShift> affectedShifts = null;
                if (includeAffectedShifts)
                    affectedShifts = GetLeaveRequestAffectedShifts(timeScheduleManager, currentRequest);

                List<LeaveRequestAffectedPeriod> affectedPeriods = null;
                if (includeAffectedPeriods)
                    affectedPeriods = GetLeaveRequestAffectedPeriods(timeScheduleManager, currentRequest);

                leaveRequests.Add(new LeaveRequest
                {
                    EmployeeRequestId = currentRequest.EmployeeRequestId,
                    EmployeeId = currentRequest.EmployeeId,
                    EmployeeName = currentRequest.EmployeeName,
                    EmployeeNumber = currentRequest.Employee.EmployeeNr,
                    EmployeeExternalCode = currentRequest.Employee.ExternalCode,
                    TimeDeviationCauseId = currentRequest.TimeDeviationCauseId,
                    TimeDeviationCauseName = currentRequest.TimeDeviationCauseName,
                    TimeDeviationCauseExternalCode = currentRequest.TimeDeviationCause.ExternalCodesString,
                    EmployeeChildName = ChildName(currentRequest.EmployeeChild),
                    Start = currentRequest.Start,
                    Stop = currentRequest.Stop,
                    Comment = currentRequest.Comment,
                    Created = currentRequest.Created,
                    CreatedBy = currentRequest.CreatedBy,
                    Modified = currentRequest.Modified,
                    ModifiedBy = currentRequest.ModifiedBy,
                    Status = (TermGroup_EmployeeRequestStatus)currentRequest.Status,
                    State = (SoeEntityState)currentRequest.State,
                    ResultStatus = (TermGroup_EmployeeRequestResultStatus)currentRequest.ResultStatus,
                    ExtendedAbsenceSettings = GetLeaveRequestExtendedAbsenceSettings(currentRequest.ExtendedAbsenceSetting),
                    AffectedShifts = affectedShifts,
                    AffectedPeriods = affectedPeriods
                });
            }

            #endregion

            return leaveRequests;
        }

        private LeaveRequestExtendedAbsenceSettings GetLeaveRequestExtendedAbsenceSettings(ExtendedAbsenceSetting setting)
        {
            if (setting == null)
                return null;

            var result = new LeaveRequestExtendedAbsenceSettings
            {
                AbsenceFirstAndLastDay = setting.AbsenceFirstAndLastDay,
                PercentalAbsence = setting.PercentalAbsence,
                AdjustAbsencePerWeekDay = setting.AdjustAbsencePerWeekDay,
            };

            if (result.AbsenceFirstAndLastDay)
            {
                result.AbsenceWholeFirstDay = setting.AbsenceWholeFirstDay;
                if (!setting.AbsenceWholeFirstDay)
                    result.AbsenceFirstDayStart = setting.AbsenceFirstDayStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AbsenceWholeLastDay = setting.AbsenceWholeLastDay;
                if (!setting.AbsenceWholeLastDay)
                    result.AbsenceLastDayStop = setting.AbsenceLastDayStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
            }

            if (setting.PercentalAbsence)
            {
                result.PercentalValue = setting.PercentalValue;
                result.PercentalAbsenceOccursStartOfDay = setting.PercentalAbsenceOccursStartOfDay;
                result.PercentalAbsenceOccursEndOfDay = setting.PercentalAbsenceOccursEndOfDay;
            }

            if (setting.AdjustAbsencePerWeekDay)
            {
                result.AdjustAbsenceAllDaysStart = setting.AdjustAbsenceAllDaysStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceAllDaysStop = setting.AdjustAbsenceAllDaysStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceMonStart = setting.AdjustAbsenceMonStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceMonStop = setting.AdjustAbsenceMonStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceTueStart = setting.AdjustAbsenceTueStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceTueStop = setting.AdjustAbsenceTueStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceWedStart = setting.AdjustAbsenceWedStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceWedStop = setting.AdjustAbsenceWedStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceThuStart = setting.AdjustAbsenceThuStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceThuStop = setting.AdjustAbsenceThuStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceFriStart = setting.AdjustAbsenceFriStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceFriStop = setting.AdjustAbsenceFriStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceSatStart = setting.AdjustAbsenceSatStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceSatStop = setting.AdjustAbsenceSatStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceSunStart = setting.AdjustAbsenceSunStart?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
                result.AdjustAbsenceSunStop = setting.AdjustAbsenceSunStop?.ToString("HH:mm:ss", CultureInfo.InvariantCulture);
            }

            return result;
        }

        private List<LeaveRequestAffectedShift> GetLeaveRequestAffectedShifts(TimeScheduleManager timeScheduleManager, EmployeeRequest employeeRequest)
        {
            bool includeAlreadyAbsence = true;

            var result = timeScheduleManager.GetAbsenceAffectedShifts(parameterObject.ActorCompanyId,
                parameterObject.UserId,
                employeeRequest.EmployeeId,
                null,
                employeeRequest.Start,
                employeeRequest.Stop,
                employeeRequest.TimeDeviationCauseId ?? 0,
                employeeRequest.ExtendedAbsenceSetting,
                includeAlreadyAbsence
            );

            var affectedShifts = new List<LeaveRequestAffectedShift>();
            var shiftIndices = new Dictionary<string, int>();

            foreach (var shift in result)
            {
                string actualDate = shift.ActualDate.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture);
                shiftIndices.TryGetValue(actualDate, out int shiftIndex);
                shiftIndices[actualDate] = ++shiftIndex;

                affectedShifts.Add(new LeaveRequestAffectedShift
                {
                    PeriodReferenceId = GetLeaveRequestPeriodReferenceId(employeeRequest.EmployeeRequestId, shift.ActualDate, shiftIndex, "S"),
                    ActualDate = actualDate,
                    StartTime = shift.StartTime,
                    StopTime = shift.StopTime,
                    AbsenceStartTime = shift.AbsenceStartTime,
                    AbsenceStopTime = shift.AbsenceStopTime
                });
            }

            return affectedShifts;
        }

        private List<LeaveRequestAffectedPeriod> GetLeaveRequestAffectedPeriods(TimeScheduleManager timeScheduleManager, EmployeeRequest employeeRequest)
        {
            var shifts = new List<TimeSchedulePlanningDayDTO>();

            for (var date = employeeRequest.Start.Date; date <= employeeRequest.Stop.Date; date = date.AddDays(1))
            {
                var shift = TimeSchedulePlanningDayDTO.CreateZeroShift(0, date, null);
                shift.TimeScheduleTemplateBlockId = (int)shift.StartTime.Date.ToOADate(); // fake id - needs to be unique
                shift.StopTime = CalendarUtility.GetEndOfDay(shift.StopTime);
                shifts.Add(shift);
            }

            shifts = timeScheduleManager.ApplyExtendedAbsenceSettingsForLeaveRequestEndpoint(employeeRequest.Start, employeeRequest.Stop, shifts, employeeRequest.ExtendedAbsenceSetting);

            var result = new List<LeaveRequestAffectedPeriod>();
            foreach (var shift in shifts)
            {
                result.Add(new LeaveRequestAffectedPeriod
                {
                    PeriodReferenceId = GetLeaveRequestPeriodReferenceId(employeeRequest.EmployeeRequestId, shift.ActualDate, 1, "P"),
                    ActualDate = shift.ActualDate.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture),
                    StartTime = shift.AbsenceStartTime,
                    StopTime = shift.AbsenceStopTime
                });
            }

            return result;
        }

        private string GetLeaveRequestPeriodReferenceId(int employeeRequestId, DateTime actualDate, int shiftIndex, string suffix)
        {
            var referenceIdParts = new string[] {
                employeeRequestId.ToString(),
                actualDate.ToString("yyyyMMdd", CultureInfo.InvariantCulture),
                shiftIndex.ToString(),
                suffix
            };
            return string.Join("-", referenceIdParts);
        }

        #endregion
    }
}
