using SoftOne.Soe.Business.Core.Reporting;
using SoftOne.Soe.Business.Util;
using SoftOne.Soe.Business.Util.Config;
using SoftOne.Soe.Common.DTO;
using SoftOne.Soe.Common.Util;
using SoftOne.Soe.Data;
using SoftOne.Soe.Util;
using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Data.Entity.Core.Objects.DataClasses;
using System.Dynamic;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Transactions;

namespace SoftOne.Soe.Business.Core
{
    public class InvoiceManager : ManagerBase
    {
        #region Variables

        // Create a logger for use in this class
        private readonly log4net.ILog log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);
        static private readonly List<string> allowChangeWhenDefinitiv = new List<string> { "orderreference", "referenceour", "invoicedeliverytype", "workingdescription", "addattachementstoeinvoice", "invoicepaymentservice", "deliveryaddressid", "invoiceheadtext", "duedate", "includeoninvoice", "contactecomid", "billingaddressid", "referenceyour", "invoicelabel", "contactglnid" };
        static private readonly List<string> internalAccountFields = new List<string> { "defaultdim2accountid", "defaultdim3accountid", "defaultdim4accountid", "defaultdim5accountid", "defaultdim6accountid" };
        static private readonly string[] invoiceTreat0asNullHead = { "deliverytypeid", "deliveryconditionid" };
        static private readonly string[] invoiceTreat0asNullRow = { "stockid", "vatcodeid", "productunitid", "vataccountid", "productid", "parentrowid" };

        #endregion

        #region Ctor

        public InvoiceManager(ParameterObject parameterObject) : base(parameterObject) { }

        #endregion

        #region InvoiceTemplates

        public Dictionary<int, string> GetInvoiceTemplatesDict(int actorCompanyId, SoeOriginType originType, SoeInvoiceType invoiceType, bool addEmpty = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return GetInvoiceTemplatesDict(entities, actorCompanyId, originType, invoiceType, addEmpty);
        }

        public Dictionary<int, string> GetInvoiceTemplatesDict(CompEntities entities, int actorCompanyId, SoeOriginType originType, SoeInvoiceType invoiceType, bool addEmpty = false)
        {
            var templates = new Dictionary<int, string>();

            if (addEmpty)
                templates.Add(0, " ");

            if (invoiceType == SoeInvoiceType.CustomerInvoice)
            {
                var invoices = (from i in entities.Invoice
                                where i.Origin.ActorCompanyId == actorCompanyId &&
                                   i.Origin.Type == (int)originType &&
                                   i.Origin.Status != (int)SoeOriginStatus.Cancel &&
                                   i.State == (int)SoeEntityState.Active &&
                                   i.IsTemplate
                                orderby i.Origin.Description
                                select new InvoiceTemplateDTO
                                {
                                    InvoiceId = i.InvoiceId,
                                    Name = i.Origin.Description
                                }).ToList();


                foreach (var inv in invoices)
                {
                    int i = 0;
                    string nbr = string.Empty;
                    if (!string.IsNullOrEmpty(inv.Name))
                    {
                        while (inv.Name.ToCharArray().Count() > i && Char.IsDigit(inv.Name[i]))
                        {
                            nbr += inv.Name[i];
                            i++;
                        }
                    }

                    inv.SortingNbr = nbr != string.Empty ? Convert.ToInt32(nbr) : (int?)null;
                    inv.Name = inv.Name.SafeSubstring(0, 170);
                }

                templates.AddRange(invoices.Where(i => i.SortingNbr != null).OrderBy(i => i.SortingNbr).ToDictionary(i => i.InvoiceId, i => i.Name));
                templates.AddRange(invoices.Where(i => i.SortingNbr == null).OrderBy(i => i.Name).ToDictionary(i => i.InvoiceId, i => i.Name));

                return templates;
            }
            else
            {
                return templates;
            }
        }

        public List<InvoiceTemplateDTO> GetInvoiceTemplates(int actorCompanyId, SoeInvoiceType invoiceType)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return GetInvoiceTemplates(entities, actorCompanyId, invoiceType);
        }

        public List<InvoiceTemplateDTO> GetInvoiceTemplates(CompEntities entities, int actorCompanyId, SoeInvoiceType invoiceType)
        {
            var templates = new List<InvoiceTemplateDTO>();

            if (invoiceType == SoeInvoiceType.CustomerInvoice)
            {
                var invoices = (from i in entities.Invoice
                                where i.Origin.ActorCompanyId == actorCompanyId &&
                                    (i.Origin.Type == (int)SoeOriginType.Offer ||
                                    i.Origin.Type == (int)SoeOriginType.Order ||
                                    i.Origin.Type == (int)SoeOriginType.CustomerInvoice) &&
                                    i.Origin.Status != (int)SoeOriginStatus.Cancel &&
                                    i.State == (int)SoeEntityState.Active &&
                                    i.IsTemplate
                                select new InvoiceTemplateDTO
                                {
                                    InvoiceId = i.InvoiceId,
                                    Name = i.Origin.Description,
                                    ActorId = i.ActorId,
                                    ActorName = i.Actor.Customer.Name,
                                    OriginType = (SoeOriginType)i.Origin.Type,
                                }).ToList();

                foreach (var inv in invoices)
                {
                    string nbr = string.Empty;
                    if (!string.IsNullOrEmpty(inv.Name))
                    {
                        foreach (var s in inv.Name.ToCharArray())
                        {
                            if (Char.IsDigit(s))
                                nbr += s;
                            else
                                break;
                        }
                    }

                    inv.SortingNbr = nbr != string.Empty ? Convert.ToInt32(nbr) : (int?)null;
                }

                templates.AddRange(invoices.Where(i => i.SortingNbr != null).OrderBy(i => i.SortingNbr));
                templates.AddRange(invoices.Where(i => i.SortingNbr == null).OrderBy(i => i.Name));

                return templates;
            }
            else
            {
                return templates;
            }
        }

        #endregion

        #region Invoice

        public List<Invoice> GetInvoices(int actorCompanyId, SoeOriginType soeOriginType)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.NoTracking();
            entitiesReadOnly.Origin.NoTracking();
            entitiesReadOnly.PaymentRow.NoTracking();

            List<Invoice> invoices = (from i in entitiesReadOnly.Invoice
                                      .Include("Origin")
                                      .Include("PaymentRow")
                                      where i.Origin.ActorCompanyId == actorCompanyId &&
                                      (soeOriginType != SoeOriginType.None ? i.Origin.Type == (int)soeOriginType : true)
                                      orderby i.InvoiceNr ascending
                                      select i).ToList();

            foreach (Invoice invoice in invoices)
            {
                // Set StatusName
                invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);
            }

            return invoices;

        }

        public List<int> GetInvoiceIds(int actorCompanyId, SoeOriginType soeOriginType)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<int> invoices = (from i in entitiesReadOnly.Invoice
                                  where i.Origin.ActorCompanyId == actorCompanyId &&
                                  i.Origin.Type == (int)soeOriginType
                                  orderby i.InvoiceNr ascending
                                  select i.InvoiceId).ToList();

            return invoices;

        }
        public List<CustomerInvoiceSearchDTO> GetOrdersBySearch(int actorCompanyId, string orderNumber, string customer, int projectId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Origin.NoTracking();
            entitiesReadOnly.Actor.NoTracking();
            entitiesReadOnly.Customer.NoTracking();
            entitiesReadOnly.Project.NoTracking();

            IQueryable<Invoice> query = (from i in entitiesReadOnly.Invoice
                                      .Include("Origin")
                                      .Include("Actor.Customer")
                                      .Include("Project")
                                         where i.Origin.ActorCompanyId == actorCompanyId &&
                                                 i.Origin.Type == (int)SoeOriginType.Order &&
                                                 (i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice || i.Origin.Status == (int)SoeOriginStatus.Origin) &&
                                                 i.IsTemplate == false &&
                                                 i.State == (int)SoeEntityState.Active
                                         orderby i.InvoiceNr ascending
                                         select i);
            if (projectId > 0)
            {
                query = query.Where(i => i.ProjectId == projectId);
            }
            if (!string.IsNullOrEmpty(orderNumber))
            {
                query = query.Where(i => i.InvoiceNr.ToLower().Contains(orderNumber.ToLower()));
            }
            if (!string.IsNullOrEmpty(customer))
            {
                query = query.Where(i => i.Actor.Customer.Name.ToLower().Contains(customer.ToLower()) || i.Actor.Customer.CustomerNr.ToLower().Contains(customer.ToLower()));
            }

            return query.Select(i => new CustomerInvoiceSearchDTO
            {
                CustomerInvoiceId = i.InvoiceId,
                Number = i.InvoiceNr,
                CustomerName = i.Actor.Customer.Name,
                CustomerNr = i.Actor.Customer.CustomerNr,
                ProjectId = i.Project.ProjectId,
                ProjectName = i.Project.Name,
                ProjectNr = i.Project.Number,
            }).ToList();
        }
        public List<Invoice> GetInvoicesBySearch(int actorCompanyId, string search, int no, SoeOriginType soeOriginType)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<Invoice> invoices = (from i in entitiesReadOnly.Invoice.Include("Origin")
                                      where i.Origin.ActorCompanyId == actorCompanyId &&
                                      (soeOriginType != SoeOriginType.None ? i.Origin.Type == (int)soeOriginType : true) &&
                                      (i.InvoiceNr.ToLower() == search.ToLower() || i.Origin.Description.ToLower().Contains(search.ToLower()))
                                      orderby i.InvoiceNr ascending
                                      select i).Take(no).ToList();

            foreach (Invoice invoice in invoices)
            {
                // Set StatusName
                invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);
            }

            return invoices;
        }

        public List<CustomerInvoiceSearchDTO> GetInvoicesBySearch(int actorCompanyId, int originType, CustomerInvoiceSearchParamsDTO searchDTO, int maxNrRows)
        {
            using (var entities = new CompEntities())
            {
                entities.CommandTimeout = 60;

                IQueryable<CustomerInvoice> query = entities.Invoice.OfType<CustomerInvoice>();

                if (!string.IsNullOrEmpty(searchDTO.Number))
                {
                    query = query.Where(i => i.InvoiceNr.ToLower().Contains(searchDTO.Number.ToLower()));
                }

                if (!string.IsNullOrEmpty(searchDTO.ExternalNr))
                {
                    query = query.Where(i => i.ExternalId.ToLower().Contains(searchDTO.ExternalNr.ToLower()));
                }

                if (!string.IsNullOrEmpty(searchDTO.CustomerNr))
                {
                    query = query.Where(i => i.Actor.Customer.CustomerNr.ToLower().Contains(searchDTO.CustomerNr.ToLower()));
                }

                if (!string.IsNullOrEmpty(searchDTO.CustomerName))
                {
                    query = query.Where(i => i.Actor.Customer.Name.ToLower().Contains(searchDTO.CustomerName.ToLower()));
                }

                if (!string.IsNullOrEmpty(searchDTO.ProjectNr))
                {
                    query = query.Where(i => i.Project.Number.ToLower().Contains(searchDTO.ProjectNr.ToLower()));
                }

                if (!string.IsNullOrEmpty(searchDTO.ProjectName))
                {
                    query = query.Where(i => i.Project.Name.ToLower().Contains(searchDTO.ProjectName.ToLower()));
                }

                if (!string.IsNullOrEmpty(searchDTO.InternalText))
                {
                    query = query.Where(i => i.Origin.Description.ToLower().Contains(searchDTO.InternalText.ToLower()));
                }

                if (searchDTO.ProjectId.HasValue && searchDTO.ProjectId.Value > 0)
                {
                    query = query.Where(i => i.ProjectId == searchDTO.ProjectId);
                }

                if (searchDTO.CustomerId.HasValue)
                {
                    query = query.Where(i => i.ActorId == searchDTO.CustomerId);
                }

                if (searchDTO.IgnoreChildren)
                {
                    query = query.Where(i => i.InvoiceMapping1.Count == 0);
                }

                if (searchDTO.IgnoreInvoiceId.HasValue)
                {
                    query = query.Where(i => i.InvoiceId != searchDTO.IgnoreInvoiceId.Value);
                }

                if (searchDTO.FullyPaid.HasValue)
                {
                    query = query.Where(i => i.FullyPayed == searchDTO.FullyPaid);
                }

                if (searchDTO.InvoiceDateFrom.HasValue)
                {
                    query = query.Where(i => i.InvoiceDate >= searchDTO.InvoiceDateFrom);
                }

                if (searchDTO.InvoiceDateTo.HasValue)
                {
                    query = query.Where(i => i.InvoiceDate <= searchDTO.InvoiceDateTo);
                }

                if (searchDTO.UserId.HasValue)
                {
                    query = query.Where(i => i.Origin.OriginUser.Any(u => u.State == (int)SoeEntityState.Active && u.UserId == searchDTO.UserId.Value));
                }

                switch (originType)
                {
                    case (int)SoeOriginType.Order:
                        if (searchDTO.IncludeClosed)
                        {
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice || i.Origin.Status == (int)SoeOriginStatus.OrderFullyInvoice || i.Origin.Status == (int)SoeOriginStatus.OrderClosed));
                        }
                        else
                        {
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice));
                        }

                        break;
                    case (int)SoeOriginType.CustomerInvoice:
                        if (searchDTO.IncludePreliminary && searchDTO.IncludeVoucher)
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.Voucher));
                        else if (searchDTO.IncludePreliminary)
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin));
                        else if (searchDTO.IncludeVoucher)
                            query = query.Where(i => (i.Origin.Status == (int)SoeOriginStatus.Voucher || i.Origin.Status == (int)SoeOriginStatus.Origin));
                        else
                            query = query.Where(i => i.Origin.Status == (int)SoeOriginStatus.Origin);
                        break;
                }

                if (maxNrRows > 0)
                {
                    query = query.Take(maxNrRows);
                }

                var list = (from i in query
                            where i.Origin.ActorCompanyId == actorCompanyId &&
                                                     i.Origin.Type == originType &&
                                                     !i.IsTemplate &&
                                                     i.State == (int)SoeEntityState.Active
                            orderby i.InvoiceNr ascending
                            select new CustomerInvoiceSearchDTO()
                            {
                                CustomerInvoiceId = i.InvoiceId,
                                Number = i.InvoiceNr,
                                InternalText = i.Origin.Description,
                                CustomerId = i.ActorId,
                                CustomerName = i.Actor.Customer.Name,
                                CustomerNr = i.Actor.Customer.CustomerNr,
                                ProjectId = i.ProjectId,
                                ProjectName = i.Project != null ? i.Project.Name : String.Empty,
                                ProjectNr = i.Project != null ? i.Project.Number : String.Empty,
                                TotalAmount = i.TotalAmountCurrency,
                                VatAmount = i.VATAmountCurrency,
                                PaidAmount = i.PaidAmountCurrency,
                                InvoiceDate = i.InvoiceDate,
                                DueDate = i.DueDate,
                                BillingType = i.BillingType,
                                SysCurrencyId = i.Currency != null ? i.Currency.SysCurrencyId : (int?)null,
                                DeliveryAddressId = i.DeliveryAddressId,
                                InvoiceHeadText = i.InvoiceHeadText,
                                ExternalNr = i.ExternalId,
                            }).ToList();

                if (originType == (int)SoeOriginType.CustomerInvoice)
                {
                    foreach (var dto in list)
                    {
                        if (dto.SysCurrencyId.HasValue)
                            dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.SysCurrencyId.Value);
                    }
                }

                return list;
            }
        }

        public List<Invoice> GetInvoicesSearchInvoiceNr(CompEntities entities, int actorCompanyId, string search, int no, SoeOriginType soeOriginType, bool fillInvoiceStatusDescr = true)
        {
            List<Invoice> invoices = (from i in entities.Invoice.Include("Origin")
                                      where i.Origin.ActorCompanyId == actorCompanyId &&
                                      i.State != (int)SoeEntityState.Deleted &&
                                      (soeOriginType != SoeOriginType.None ? i.Origin.Type == (int)soeOriginType : true) &&
                                      i.InvoiceNr.ToLower() == search.ToLower()
                                      orderby i.InvoiceNr ascending
                                      select i).Take(no).ToList();

            if (fillInvoiceStatusDescr)
            {
                foreach (Invoice invoice in invoices)
                {
                    // Set StatusName
                    invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);
                }
            }
            return invoices;
        }

        public Invoice GetInvoiceBySeqNr(CompEntities entities, int actorCompanyId, int seqNr, SoeOriginType soeOriginType)
        {
            Invoice invoice = (from i in entities.Invoice.Include("Origin")
                               where i.Origin.ActorCompanyId == actorCompanyId &&
                               i.Origin.Type == (int)soeOriginType &&
                               i.SeqNr == seqNr &&
                               i.State == (int)SoeEntityState.Active
                               select i).FirstOrDefault();

            if (invoice != null)
                invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);

            return invoice;
        }

        public List<Invoice> GetInvoicesBySeqNr(CompEntities entities, int actorCompanyId, int seqNr, SoeOriginType soeOriginType)
        {
            List<Invoice> invoices = (from i in entities.Invoice.Include("Origin")
                                      where i.Origin.ActorCompanyId == actorCompanyId &&
                                      i.Origin.Type == (int)soeOriginType &&
                                      i.SeqNr == seqNr &&
                                      i.State == (int)SoeEntityState.Active
                                      select i).ToList();

            return invoices;
        }

        public List<AgreementDetaílsOrderDTO> GetServiceOrdersForAgreementDetails(int actorCompanyId, int customerInvoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return GetServiceOrdersForAgreementDetails(entities, actorCompanyId, customerInvoiceId);
        }

        public List<AgreementDetaílsOrderDTO> GetServiceOrdersForAgreementDetails(CompEntities entities, int actorCompanyId, int customerInvoiceId)
        {
            List<AgreementDetaílsOrderDTO> orders = (from o in entities.OriginInvoiceMapping
                                                     join i in entities.Invoice.OfType<CustomerInvoice>()
                                                         on o.InvoiceId equals i.InvoiceId
                                                     where o.OriginId == customerInvoiceId &&
                                                     o.Invoice.Origin.ActorCompanyId == actorCompanyId &&
                                                     o.Invoice.Origin.Type == (int)SoeOriginType.Order &&
                                                     i.OrderType == (int)TermGroup_OrderType.Service &&
                                                     o.Invoice.State == (int)SoeEntityState.Active
                                                     select new AgreementDetaílsOrderDTO()
                                                     {
                                                         CustomerInvoiceId = o.InvoiceId,
                                                         InvoiceNr = o.Invoice.InvoiceNr,
                                                         InternalText = o.Invoice.Origin.Description,
                                                         InvoiceDate = o.Invoice.InvoiceDate,
                                                         TotalAmount = o.Invoice.TotalAmountCurrency,
                                                         TotalAmountExVat = o.Invoice.TotalAmountCurrency - o.Invoice.VATAmountCurrency,
                                                         Status = o.Origin.Status,

                                                     }).ToList();

            foreach (AgreementDetaílsOrderDTO order in orders)
            {
                // Set StatusName
                order.StatusName = GetText(order.Status, (int)TermGroup.OriginStatus);
            }

            return orders;
        }

        public List<HandleBillingRowDTO> SearchCustomerInvoiceRows(int actorCompanyId, List<int> projects, List<int> orders, List<int> customers, List<int> orderTypes, List<int> orderContractTypes, DateTime fromDate, DateTime toDate, bool onlyValid, bool onlyMine, int? customerInvoiceRowId = null)
        {
            var dtos = new List<HandleBillingRowDTO>();

            using (CompEntities entities = new CompEntities())
            {
                entities.Connection.Open();

                // Add day to toDate
                toDate = toDate.AddDays(1);

                var marginalIncomeLimit = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingProductRowMarginalLimit, base.UserId, actorCompanyId, 0);
                var attestStateToId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, base.UserId, actorCompanyId, 0);
                var transitions = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, base.UserId, actorCompanyId, SoeModule.Billing, TermGroup_AttestEntity.Order);
                var validAttestStateIds = transitions.Where(t => t.AttestStateToId == attestStateToId).Select(t => t.AttestStateFromId);

                var rows = (from r in entities.HandleBillingCustomerInvoiceRowView
                            where r.ActorCompanyId == actorCompanyId &&
                            (r.Date != null ? (r.Date.Value >= fromDate && r.Date.Value < toDate) : (r.Created != null ? (r.Created.Value >= fromDate && r.Created.Value < toDate) : true))
                            select r);

                if (customerInvoiceRowId.HasValue)
                {
                    rows = rows.Where(r => r.CustomerInvoiceRowId == customerInvoiceRowId.Value);
                }
                else
                {
                    if (projects.Count > 0)
                        rows = rows.Where(r => projects.Contains(r.ProjectId));

                    if (orders.Count > 0)
                        rows = rows.Where(r => orders.Contains(r.InvoiceId));

                    if (customers.Count > 0)
                        rows = rows.Where(r => customers.Contains(r.ActorCustomerId));

                    if (orderTypes.Count > 0)
                        rows = rows.Where(r => orderTypes.Contains(r.OrderType));

                    if (orderContractTypes.Count > 0)
                    {
                        if (orderContractTypes.Contains((int)OrderContractType.Fixed) && !orderContractTypes.Contains((int)OrderContractType.Continuous))
                            rows = rows.Where(r => r.IsFixedPrice);
                        else if (!orderContractTypes.Contains((int)OrderContractType.Fixed) && orderContractTypes.Contains((int)OrderContractType.Continuous))
                            rows = rows.Where(r => !r.IsFixedPrice);
                    }

                    if (onlyValid)
                        rows = rows.Where(r => validAttestStateIds.Contains(r.AttestStateId));
                    else
                        rows = rows.Where(r => r.AttestStateId != attestStateToId);

                    if (onlyMine)
                    {
                        var userId = base.UserId;
                        var originUserIds = (from view in entities.OriginUserView
                                             where view.ActorCompanyId == actorCompanyId &&
                                             view.UserId == userId
                                             select view.OriginId);

                        rows = rows.Where(r => originUserIds.Contains(r.InvoiceId));
                    }
                }

                foreach (var row in rows.OrderBy(r => r.InvoiceNr).ThenBy(r => r.RowNr))
                {
                    var dto = row.ToHandleBillingRowDTO(marginalIncomeLimit);
                    dto.ValidForInvoice = validAttestStateIds.Contains(row.AttestStateId);
                    dto.MarginalIncomeLimit = dto.PurchasePriceCurrency == 0 ? 0 : dto.MarginalIncomeRatio - marginalIncomeLimit;
                    dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.CurrencyId);
                    dtos.Add(dto);
                }
            }
            return dtos;
        }

        public List<CustomerStatisticsDTO> GetProductStatistics(int originType, DateTime fromDate, DateTime toDate)
        {
            int actorCompanyId = base.ActorCompanyId;
            string streetAddress = "";
            string addressCo = "";
            string addressName = "";
            string customerCity = "";
            string customerCountry = "";

            string postalCode = "";
            string customerCategory = "";
            string orderCategory = "";
            string contractCategory = "";
            string costCentre = "";

            var customerStatisticsDtoList = new List<CustomerStatisticsDTO>();

            //Get order types
            List<GenericType> orderTypes = base.GetTermGroupContent(TermGroup.OrderType);

            using (CompEntities entities = new CompEntities())
            {
                entities.Connection.Open();

                int currentInvoiceId = 0;
                string orderTypeName = string.Empty;

                //Get categories for orders
                List<CompanyCategoryRecord> orderCategoryRecordsForCompany = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Order, actorCompanyId);

                //Get categories for contracts
                List<CompanyCategoryRecord> contractCategoryRecordsForCompany = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Contract, actorCompanyId);

                //Get categories for customers
                List<CompanyCategoryRecord> customerCategoryRecordsForCompany = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Customer, actorCompanyId);

                //Get the customers 
                List<Customer> customers = CustomerManager.GetCustomers(entities, actorCompanyId, true, false, false, false, true, false, true);

                var items = entities.GetProductStatistics(actorCompanyId, originType, fromDate.AddSeconds(-1), toDate).ToList();


                if (originType == (int)SoeOriginType.CustomerInvoice)
                {
                    // Get mappings
                    var idsForMapping = items.Select(i => i.InvoiceId).Distinct();
                    var mappings = (from m in entities.OriginInvoiceMapping
                                    .Include("Origin.Invoice")
                                    where m.Origin.Type == (int)SoeOriginType.Order &&
                                    idsForMapping.Contains(m.InvoiceId)
                                    select m)
                                    .Select(map => new OriginInvoiceMappingDTO()
                                    {
                                        OriginInvoiceMappingId = map.OriginInvoiceMappingId,
                                        OriginId = map.OriginId,
                                        InvoiceId = map.InvoiceId,
                                        InvoiceNr = "",
                                        OriginNr = map.Origin.Invoice.InvoiceNr
                                    }).ToList();

                    foreach (var invoiceRow in items)
                    {
                        if (invoiceRow.InvoiceId != currentInvoiceId)
                        {
                            currentInvoiceId = invoiceRow.InvoiceId;

                            streetAddress = "";
                            customerCity = "";
                            postalCode = "";
                            customerCountry = "";
                            costCentre = "";

                            Customer customer = customers.FirstOrDefault(c => c.ActorCustomerId == invoiceRow.ActorId);
                            if (customer != null)
                            {
                                customerCategory = string.Join(", ", customerCategoryRecordsForCompany.GetCategoryRecords(SoeCategoryRecordEntity.Customer, customer.ActorCustomerId, date: null, discardDateIfEmpty: true).Select(i => i.Category.Name));

                                Contact contact = customer.Actor.Contact.FirstOrDefault();
                                if (contact != null)
                                {
                                    var contactAddress = contact.ContactAddress.FirstOrDefault(c => c.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery);
                                    if (contactAddress != null)
                                        ContactManager.ParseContactAddress(contactAddress, TermGroup_SysContactAddressType.Delivery, out addressName, out streetAddress, out addressCo, out postalCode, out customerCity, out customerCountry);
                                }

                                if (customer.SysCountryId.GetValueOrDefault() > 0)
                                {
                                    var sysCountry = CountryCurrencyManager.GetSysCountry(customer.SysCountryId.Value);
                                    customerCountry = sysCountry?.Name;
                                }
                                else
                                {
                                    customerCountry = "";
                                }
                            }

                            if (invoiceRow.DefaultDim2AccountId.HasValue)
                                costCentre = AccountManager.GetAccountNr(actorCompanyId, invoiceRow.DefaultDim2AccountId.Value, true);

                            GenericType orderT = orderTypes.First(o => o.Id == invoiceRow.OrderType);
                            orderTypeName = orderT != null ? orderT.Name : "";
                        }

                        var custStatisticsDTO = new CustomerStatisticsDTO
                        {
                            OriginType = (SoeOriginType)invoiceRow.OriginType,
                            OrderType = invoiceRow.OrderType,
                            InvoiceNr = invoiceRow.InvoiceNr,
                            Date = invoiceRow.Date,
                            CustomerName = invoiceRow.CustomerNr + " " + invoiceRow.CustomerName,
                            PayingCustomerName = invoiceRow.PayingCustomerName,

                            CustomerStreetAddress = streetAddress,
                            CustomerPostalCode = postalCode,
                            CustomerPostalAddress = customerCity,
                            CustomerCountry = customerCountry,

                            CustomerCategory = customerCategory,
                            OrderCategory = orderCategory,
                            CostCentre = costCentre,
                            ProjectNr = invoiceRow.ProjectNr + " " + invoiceRow.ProjectName,
                            ProductCategory = invoiceRow.ProductCategories,

                            ProductMarginalIncome = invoiceRow.ProductMarginalIncome,
                            ProductMarginalRatio = invoiceRow.ProductMarginalRatio,
                            ProductName = invoiceRow.ProductName,
                            ProductPurchasePrice = invoiceRow.ProductPurchasePrice,
                            ProductPurchasePriceCurrency = invoiceRow.ProductPurchasePriceCurrency,
                            ProductQuantity = invoiceRow.ProductQuantity,
                            CurrencyCode = CountryCurrencyManager.GetCurrencyCode(invoiceRow.SysCurrencyId),

                            WholeSellerName = invoiceRow.WholesellerName,
                            ReferenceOur = invoiceRow.ReferenceOur,

                            OrderTypeName = orderTypeName,
                            OriginUsers = invoiceRow.OriginUsers,
                            MainUserName = invoiceRow.MainUserName,
                            AttestStateId = invoiceRow.AttestStateId,
                            AttestStateName = invoiceRow.AttestStateName,
                            AttestStateColor = invoiceRow.AttestStateColor,

                            ProductGroupId = invoiceRow.ProductGroupId,
                            ProductGroupName = invoiceRow.ProductGroupName,

                            TimeCodeId = invoiceRow.TimeCodeId,
                            TimeCodeName = invoiceRow.TimeCodeId > 0 ? invoiceRow.TimeCode + " - " + invoiceRow.TimeCodeName : "",

                            ParentProductCategories = invoiceRow.ParentProductCategories
                        };

                        if (invoiceRow.PriceListInclusiveVat)
                        {
                            custStatisticsDTO.ProductSumAmount = invoiceRow.ProductSumAmount - invoiceRow.ProductVatAmount;
                            custStatisticsDTO.ProductSumAmountCurrency = invoiceRow.ProductSumAmountCurrency - invoiceRow.ProductVatAmountCurrency;
                            custStatisticsDTO.ProductPrice = invoiceRow.ProductQuantity != 0 ? custStatisticsDTO.ProductSumAmount / invoiceRow.ProductQuantity : 0;
                        }
                        else
                        {
                            custStatisticsDTO.ProductSumAmount = invoiceRow.ProductSumAmount;
                            custStatisticsDTO.ProductSumAmountCurrency = invoiceRow.ProductSumAmountCurrency;
                            custStatisticsDTO.ProductPrice = invoiceRow.ProductPrice;
                        }

                        var mapping = mappings.FirstOrDefault(m => m.InvoiceId == currentInvoiceId);
                        if (mapping != null)
                            custStatisticsDTO.OrderNr = mapping.OriginNr;

                        customerStatisticsDtoList.Add(custStatisticsDTO);
                    }
                }
                else
                {
                    foreach (var invoiceRow in items)
                    {
                        if (invoiceRow.InvoiceId != currentInvoiceId)
                        {
                            currentInvoiceId = invoiceRow.InvoiceId;

                            streetAddress = "";
                            customerCity = "";
                            postalCode = "";
                            customerCountry = "";
                            costCentre = "";

                            Customer customer = customers.FirstOrDefault(c => c.ActorCustomerId == invoiceRow.ActorId);
                            if (customer != null)
                            {
                                customerCategory = string.Join(", ", customerCategoryRecordsForCompany.GetCategoryRecords(SoeCategoryRecordEntity.Customer, customer.ActorCustomerId, date: null, discardDateIfEmpty: true).Select(i => i.Category.Name));

                                Contact contact = customer.Actor.Contact.FirstOrDefault();
                                if (contact != null)
                                {
                                    var contactAddress = contact.ContactAddress.FirstOrDefault(c => c.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery);
                                    if (contactAddress != null)
                                        ContactManager.ParseContactAddress(contactAddress, TermGroup_SysContactAddressType.Delivery, out addressName, out streetAddress, out addressCo, out postalCode, out customerCity, out customerCountry);
                                }

                                if (customer.SysCountryId.GetValueOrDefault() > 0)
                                {
                                    var sysCountry = CountryCurrencyManager.GetSysCountry(customer.SysCountryId.Value);
                                    customerCountry = sysCountry?.Name;
                                }
                                else
                                {
                                    customerCountry = "";
                                }
                            }

                            if (invoiceRow.DefaultDim2AccountId.HasValue)
                                costCentre = AccountManager.GetAccountNr(actorCompanyId, invoiceRow.DefaultDim2AccountId.Value, true);

                            if (invoiceRow.OriginType == (int)SoeOriginType.Contract)
                            {
                                contractCategory = string.Join(", ", contractCategoryRecordsForCompany.GetCategoryRecords(SoeCategoryRecordEntity.Contract, invoiceRow.InvoiceId, date: null, discardDateIfEmpty: true).Select(i => i.Category.Name));
                            }

                            if (invoiceRow.OriginType == (int)SoeOriginType.Order)
                            {
                                orderCategory = string.Join(", ", orderCategoryRecordsForCompany.GetCategoryRecords(SoeCategoryRecordEntity.Order, invoiceRow.InvoiceId, date: null, discardDateIfEmpty: true).Select(i => i.Category.Name));
                            }

                            GenericType orderT = orderTypes.First(o => o.Id == invoiceRow.OrderType);
                            orderTypeName = orderT != null ? orderT.Name : "";
                        }

                        var custStatisticsDTO = new CustomerStatisticsDTO
                        {
                            OriginType = (SoeOriginType)invoiceRow.OriginType,
                            OrderType = invoiceRow.OrderType,
                            InvoiceNr = invoiceRow.InvoiceNr,
                            Date = invoiceRow.Date,
                            CustomerName = invoiceRow.CustomerNr + " " + invoiceRow.CustomerName,
                            PayingCustomerName = invoiceRow.PayingCustomerName,

                            CustomerStreetAddress = streetAddress,
                            CustomerPostalCode = postalCode,
                            CustomerPostalAddress = customerCity,
                            CustomerCountry = customerCountry,

                            CustomerCategory = customerCategory,
                            OrderCategory = orderCategory,
                            CostCentre = costCentre,
                            ProjectNr = invoiceRow.ProjectNr + " " + invoiceRow.ProjectName,
                            ProductCategory = invoiceRow.ProductCategories,

                            ProductMarginalIncome = invoiceRow.ProductMarginalIncome,
                            ProductMarginalRatio = invoiceRow.ProductMarginalRatio,
                            ProductName = invoiceRow.ProductName,
                            ProductPurchasePrice = invoiceRow.ProductPurchasePrice,
                            ProductPurchasePriceCurrency = invoiceRow.ProductPurchasePriceCurrency,
                            ProductQuantity = invoiceRow.ProductQuantity,
                            CurrencyCode = CountryCurrencyManager.GetCurrencyCode(invoiceRow.SysCurrencyId),

                            WholeSellerName = invoiceRow.WholesellerName,
                            ReferenceOur = invoiceRow.ReferenceOur,

                            OrderTypeName = orderTypeName,
                            OriginUsers = invoiceRow.OriginUsers,
                            MainUserName = invoiceRow.MainUserName,
                            AttestStateId = invoiceRow.AttestStateId,
                            AttestStateName = invoiceRow.AttestStateName,
                            AttestStateColor = invoiceRow.AttestStateColor,

                            ContractCategory = contractCategory,

                            ProductGroupId = invoiceRow.ProductGroupId,
                            ProductGroupName = invoiceRow.ProductGroupName,

                            TimeCodeId = invoiceRow.TimeCodeId,
                            TimeCodeName = invoiceRow.TimeCodeId > 0 ? invoiceRow.TimeCode + " - " + invoiceRow.TimeCodeName : "",

                            ParentProductCategories = invoiceRow.ParentProductCategories
                        };

                        if (invoiceRow.PriceListInclusiveVat)
                        {
                            custStatisticsDTO.ProductSumAmount = invoiceRow.ProductSumAmount - invoiceRow.ProductVatAmount;
                            custStatisticsDTO.ProductSumAmountCurrency = invoiceRow.ProductSumAmountCurrency - invoiceRow.ProductVatAmountCurrency;
                            custStatisticsDTO.ProductPrice = invoiceRow.ProductQuantity != 0 ? custStatisticsDTO.ProductSumAmount / invoiceRow.ProductQuantity : 0;
                        }
                        else
                        {
                            custStatisticsDTO.ProductSumAmount = invoiceRow.ProductSumAmount;
                            custStatisticsDTO.ProductSumAmountCurrency = invoiceRow.ProductSumAmountCurrency;
                            custStatisticsDTO.ProductPrice = invoiceRow.ProductPrice;
                        }

                        customerStatisticsDtoList.Add(custStatisticsDTO);
                    }
                }
            }

            return customerStatisticsDtoList.OrderBy(r => r.InvoiceNr).ToList();
        }

        public List<CustomerStatisticsDTO> GetProductStatisticsPerCustomer(int actorCompanyId, int customerId, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection = null)
        {
            List<CustomerStatisticsDTO> customerStatisticsDtoList = new List<CustomerStatisticsDTO>();

            DateTime? selectionDate = null;
            if (allItemsSelection.HasValue)
            {
                selectionDate = GetAllItemsSelectionDate(allItemsSelection, selectionDate);
            }

            using (CompEntities entities = new CompEntities())
            {
                IEnumerable<CustomerInvoiceRow> items = (from i in entities.CustomerInvoiceRow
                                            .Include("CustomerInvoice")
                                            .Include("CustomerInvoice.Origin")
                                                         where i.CustomerInvoice.Origin.ActorCompanyId == actorCompanyId &&
                                                             (i.CustomerInvoice.Origin.Type == (int)SoeOriginType.Offer || i.CustomerInvoice.Origin.Type == (int)SoeOriginType.Order || i.CustomerInvoice.Origin.Type == (int)SoeOriginType.CustomerInvoice || i.CustomerInvoice.Origin.Type == (int)SoeOriginType.Contract) &&
                                                             i.CustomerInvoice.Origin.Status != (int)SoeOriginStatus.Draft &&
                                                             i.CustomerInvoice.ActorId == customerId &&
                                                             i.Type == (int)SoeInvoiceRowType.ProductRow &&
                                                             i.State != (int)SoeEntityState.Deleted &&
                                                             i.CustomerInvoice.State != (int)SoeEntityState.Deleted &&
                                                             (selectionDate.HasValue == false || i.Created >= selectionDate.Value)
                                                         orderby i.CustomerInvoice.InvoiceNr
                                                         select i);

                foreach (CustomerInvoiceRow invoiceRow in items)
                {
                    if (!invoiceRow.ProductReference.IsLoaded)
                        invoiceRow.ProductReference.Load();

                    CustomerStatisticsDTO custStatisticsDTO = new CustomerStatisticsDTO()
                    {
                        //CustomerId = customerId, 
                        Date = invoiceRow.Created,
                        OriginType = (SoeOriginType)invoiceRow.CustomerInvoice.Origin.Type,
                        InvoiceNr = invoiceRow.CustomerInvoice.InvoiceNr,

                        ProductSumAmount = invoiceRow.SumAmount,
                        ProductMarginalIncome = invoiceRow.MarginalIncome,
                        ProductMarginalRatio = invoiceRow.MarginalIncomeRatio.HasValue ? invoiceRow.MarginalIncomeRatio.Value : 0,
                        ProductName = invoiceRow.Product.Name,
                        ProductNr = invoiceRow.Product.Number,
                        ProductPrice = invoiceRow.Amount,
                        ProductPurchasePrice = invoiceRow.PurchasePrice,
                        ProductQuantity = invoiceRow.Quantity.HasValue ? invoiceRow.Quantity.Value : 0,
                        WholeSellerName = invoiceRow.SysWholesellerName,

                    };

                    customerStatisticsDtoList.Add(custStatisticsDTO);
                }
            }

            return customerStatisticsDtoList;
        }

        public static DateTime? GetAllItemsSelectionDate(TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection, DateTime? selectionDate)
        {
            switch (allItemsSelection)
            {
                case TermGroup_ChangeStatusGridAllItemsSelection.One_Month:
                    selectionDate = DateTime.Today.AddMonths(-1);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.Tree_Months:
                    selectionDate = DateTime.Today.AddMonths(-3);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.Six_Months:
                    selectionDate = DateTime.Today.AddMonths(-6);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.Twelve_Months:
                    selectionDate = DateTime.Today.AddYears(-1);
                    break;
                case TermGroup_ChangeStatusGridAllItemsSelection.TwentyFour_Months:
                    selectionDate = DateTime.Today.AddYears(-2);
                    break;
            }

            return selectionDate;
        }

        public List<CustomerStatisticsDTO> GetCustomerInvoiceRowsByProductForAngular(int actorCompanyId, int productId, int originType, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection = null)
        {
            List<CustomerStatisticsDTO> customerStatisticsDtoList = new List<CustomerStatisticsDTO>();

            DateTime? selectionDate = null;
            if (allItemsSelection.HasValue)
            {
                switch (allItemsSelection)
                {
                    case TermGroup_ChangeStatusGridAllItemsSelection.One_Month:
                        selectionDate = DateTime.Today.AddMonths(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Tree_Months:
                        selectionDate = DateTime.Today.AddMonths(-3);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Six_Months:
                        selectionDate = DateTime.Today.AddMonths(-6);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Twelve_Months:
                        selectionDate = DateTime.Today.AddYears(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.TwentyFour_Months:
                        selectionDate = DateTime.Today.AddYears(-2);
                        break;
                }
            }

            using (CompEntities entities = new CompEntities())
            {
                IEnumerable<CustomerInvoiceRow> items = (from i in entities.CustomerInvoiceRow
                                            .Include("CustomerInvoice")
                                            .Include("CustomerInvoice.Origin")
                                                         where i.CustomerInvoice.Origin.ActorCompanyId == actorCompanyId &&
                                                             (i.CustomerInvoice.Origin.Type == originType) &&
                                                             i.CustomerInvoice.Origin.Status != (int)SoeOriginStatus.Draft &&
                                                             i.ProductId == productId &&
                                                             i.Type == (int)SoeInvoiceRowType.ProductRow &&
                                                             i.State != (int)SoeEntityState.Deleted &&
                                                             i.CustomerInvoice.State != (int)SoeEntityState.Deleted &&
                                                             (selectionDate.HasValue == false || i.Created >= selectionDate.Value)
                                                         orderby i.CustomerInvoice.InvoiceNr
                                                         select i);

                foreach (CustomerInvoiceRow invoiceRow in items)
                {
                    var custStatisticsDTO = new CustomerStatisticsDTO
                    {
                        //CustomerId = customerId, 
                        Date = invoiceRow.Created,
                        OriginType = (SoeOriginType)invoiceRow.CustomerInvoice.Origin.Type,
                        InvoiceNr = invoiceRow.CustomerInvoice.InvoiceNr,

                        /*CustomerName = customerName,
                        CustomerNr = customerNr,
                        CustomerStreetAddress = streetAddress,
                        CustomerPostalAddress = postalAddress,
                        CustomerPostalCode = postalCode,

                        CustomerCategory = customerCategory,
                        OrderCategory = orderCategory,
                        CostCentre = costCentre,
                        ProjectNr = projectNr,
                        ProductCategory = productCategory,*/

                        ProductSumAmount = invoiceRow.SumAmount,
                        ProductMarginalIncome = invoiceRow.MarginalIncome,
                        ProductMarginalRatio = invoiceRow.MarginalIncomeRatio.HasValue ? invoiceRow.MarginalIncomeRatio.Value : 0,
                        //ProductName = invoiceRow.ProductName,
                        //ProductNr = invoiceRow.ProductNr,
                        ProductPrice = invoiceRow.Amount,
                        ProductPurchasePrice = invoiceRow.PurchasePrice,
                        ProductQuantity = invoiceRow.Quantity.HasValue ? invoiceRow.Quantity.Value : 0,
                        WholeSellerName = invoiceRow.SysWholesellerName,

                    };

                    customerStatisticsDtoList.Add(custStatisticsDTO);
                }
            }

            return customerStatisticsDtoList;
        }

        public List<CustomerInvoiceRowDetailDTO> GetCustomerInvoiceDetailsRowsForInvoice(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceRow.NoTracking();
            var rows = (from r in entities.CustomerInvoiceRow
                        where r.InvoiceId == invoiceId &&
                        r.State == (int)SoeEntityState.Active
                        select r).OrderBy(x => x.RowNr).ToList();

            var customerInvoiceRows = new List<CustomerInvoiceRowDetailDTO>();
            foreach (var row in rows)
            {
                customerInvoiceRows.Add(row.ToCustomerInvoiceRowDetailDTO());
            }

            return customerInvoiceRows;
        }

        public Dictionary<int, string> GetUnpaidInvoices(SoeOriginType originType, int actorId, int actorCompanyId, bool addEmpty)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            var invoices = (from i in entities.Invoice
                            where i.Origin.ActorCompanyId == actorCompanyId &&
                            i.Origin.Type == (int)originType &&
                            i.Origin.Status != (int)SoeOriginStatus.Cancel &&
                            i.FullyPayed == false &&
                            ((i.PaidAmount < i.TotalAmount && i.TotalAmount > 0) ||
                            (i.PaidAmount > i.TotalAmount && i.TotalAmount < 0)) &&
                            i.State == (int)SoeEntityState.Active
                            orderby i.InvoiceNr
                            select new { i.InvoiceId, i.InvoiceNr, i.OCR, i.ActorId, i.DueDate });

            if (actorId > 0)
                invoices = invoices.Where(i => i.ActorId == actorId);

            if (originType == SoeOriginType.CustomerInvoice)
            {
                List<Customer> customers = CustomerManager.GetCustomersByCompany(actorCompanyId, onlyActive: true);

                if (addEmpty)
                    dict.Add(0, " ");

                foreach (var invoice in invoices)
                {
                    string value = invoice.InvoiceNr;
                    if (!String.IsNullOrEmpty(invoice.OCR))
                        value += " / " + invoice.OCR;

                    if (customers != null && invoice.InvoiceNr != string.Empty)
                    {
                        var customer = customers.FirstOrDefault(p => p.ActorCustomerId == invoice.ActorId);
                        if (customer != null)
                        {
                            value = string.Format("{0} {1}", value, customer.CustomerNr + " - " + customer.Name);
                        }
                    }

                    dict.Add(invoice.InvoiceId, value);
                }
            }
            else
            {
                if (addEmpty)
                    dict.Add(0, " ");

                foreach (var invoice in invoices)
                {
                    string value = invoice.InvoiceNr;
                    if (!String.IsNullOrEmpty(invoice.OCR))
                        value += " / " + invoice.OCR;

                    value = string.Format("{0} - {1}", value, invoice.DueDate);

                    dict.Add(invoice.InvoiceId, value);
                }
            }

            return dict;
        }

        private IQueryable<Invoice> GetInvoiceQuery(CompEntities entities, bool loadOrigin = false, bool loadActor = false, bool loadVoucher = false, bool loadVoucherSeries = false)
        {
            // Always load Origin and Currency. Flag loadOrigin determines if entities related to Origin should be loaded
            IQueryable<Invoice> query = entities.Invoice;
            query = query.Include("Origin").Include("Currency");

            if (loadOrigin)
            {
                query = query.Include("Origin.VoucherSeries");
                query = query.Include("Origin.Company");
                query = query.Include("Origin.OriginInvoiceMapping");
            }
            if (loadActor)
            {
                query = query.Include("Actor.Supplier");
                query = query.Include("Actor.Customer");
                query = query.Include("Actor.Contact");
            }
            if (loadVoucher)
            {
                query = query.Include("VoucherHead.VoucherRow");
                if (loadVoucherSeries)
                    query = query.Include("VoucherHead.VoucherSeries.VoucherSeriesType");
            }

            return query;
        }

        public Invoice GetInvoice(int invoiceId, bool loadOrigin = false, bool loadActor = false, bool loadVoucher = false, bool loadVoucherSeries = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return GetInvoice(entities, invoiceId, loadOrigin, loadActor, loadVoucher, loadVoucherSeries);
        }

        public Invoice GetInvoice(CompEntities entities, int invoiceId, bool loadOrigin = false, bool loadActor = false, bool loadVoucher = false, bool loadVoucherSeries = false)
        {
            if (invoiceId == 0)
                return null;

            IQueryable<Invoice> query = GetInvoiceQuery(entities, loadOrigin, loadActor, loadVoucher, loadVoucherSeries);

            Invoice invoice = (from i in query
                               where i.InvoiceId == invoiceId &&
                               i.State == (int)SoeEntityState.Active
                               select i).FirstOrDefault();

            if (invoice == null || invoice.Origin.ActorCompanyId != ActorCompanyId)
                return null;

            //Set StatusName
            if (invoice.Origin != null)
                invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);

            return invoice;
        }

        public CustomerInvoice GetInvoiceForPayment(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return (from i in entities.Invoice.OfType<CustomerInvoice>()
                    .Include("Currency")
                    .Include("Actor.Customer")
                    .Include("Origin.OriginUser")
                    where i.InvoiceId == invoiceId
                    select i).FirstOrDefault();
        }

        public string GetInvoiceNr(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetInvoiceNr(entities, invoiceId);
        }

        public string GetInvoiceNr(CompEntities entities, int invoiceId)
        {
            return (from i in entities.Invoice
                    where i.InvoiceId == invoiceId
                    select i.InvoiceNr).FirstOrDefault();
        }

        public CustomerInvoiceSmallDTO GetCustomerInvoiceSmall(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetCustomerInvoiceSmall(entities, invoiceId);
        }

        public CustomerInvoiceSmallDTO GetCustomerInvoiceSmall(CompEntities entities, int invoiceId)
        {
            return (from i in entities.Invoice.OfType<CustomerInvoice>()
                    where i.InvoiceId == invoiceId && i.Origin.ActorCompanyId == ActorCompanyId
                    select i)
                    .Select(EntityExtensions.GetCustomerInvoiceSmallDTO)
                    .FirstOrDefault();
        }

        public CustomerInvoiceSmallExDTO GetCustomerInvoiceSmallEx(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetCustomerInvoiceSmallEx(entities, invoiceId);
        }

        public CustomerInvoiceSmallExDTO GetCustomerInvoiceSmallEx(CompEntities entities, int invoiceId)
        {
            return (from i in entities.Invoice.OfType<CustomerInvoice>()
                    where i.InvoiceId == invoiceId && i.Origin.ActorCompanyId == ActorCompanyId
                    select i)
                    .Select(EntityExtensions.GetCustomerInvoiceSmallExDTO)
                    .FirstOrDefault();
        }

        public CustomerInvoiceSmallDialogDTO GetCustomerInvoiceSmallDialogDTO(CompEntities entities, int invoiceId)
        {
            return (from i in entities.Invoice.OfType<CustomerInvoice>()
                    where i.InvoiceId == invoiceId &&
                    i.Origin.ActorCompanyId == ActorCompanyId &&
                    i.State == (int)SoeEntityState.Active
                    select new CustomerInvoiceSmallDialogDTO
                    {
                        CustomerInvoiceId = i.InvoiceId,
                        SeqNr = i.SeqNr ?? 0,
                        InvoiceNr = i.InvoiceNr,
                        ActorCustomerId = i.ActorId ?? 0,
                        ActorCustomerName = i.Actor != null && i.Actor.Customer != null ? i.Actor.Customer.Name : "",
                        TotalAmountCurrency = i.TotalAmountCurrency,
                        RemainingAmount = i.RemainingAmount ?? 0,
                        SysCurrencyId = i.Currency.SysCurrencyId,
                    }).FirstOrDefault();
        }

        public CustomerInvoiceAmountDTO GetCustomerInvoiceAmountExtractNumerics(CompEntities entities, string invoiceNr)
        {
            /**
             *  Used for Safilo's invoices... They have the format `L12345`, while the BBS file only contains numerical chars.
             *  So we need to match against invoices that might start with an alphabetical char.
             * 
             *  | `InvoiceNr` | Invoice in DB | Match? |
             *  | ----------- | ------------- | ------ |
             *  | `12`        | `L12`         | ✅ Yes |
             *  | `123`       | `L123`        | ✅ Yes |
             *  | `23`        | `L123`        | ❌ No  |
             *  | `1234`      | `L12345`      | ❌ No  |
             *  | `L123456`   | `L123456`     | ✅ Yes |
             */

            if (string.IsNullOrEmpty(invoiceNr))
                return null;

            var candidates = GetSimpleCustomerInvoiceQuery(entities, SoeOriginType.CustomerInvoice)
                .Where(i => i.InvoiceNr.EndsWith(invoiceNr))
                .Select(EntityExtensions.GetCustomerInvoiceAmountDTO)
                .ToList();


            return candidates
                .Where(i => Regex.Replace(i.InvoiceNr, "[A-Za-z]", "") == invoiceNr)
                .FirstOrDefault();
        }

        public CustomerInvoiceAmountDTO GetCustomerInvoiceAmount(CompEntities entities, string invoiceNr = null, string OCR = null, string externalId = null, int? invoiceId = null)
        {
            if (string.IsNullOrEmpty(invoiceNr) && string.IsNullOrEmpty(OCR) && string.IsNullOrEmpty(externalId) && invoiceId.GetValueOrDefault() == 0)
                return null;

            var query = GetSimpleCustomerInvoiceQuery(entities, SoeOriginType.CustomerInvoice);

            if (!string.IsNullOrEmpty(invoiceNr))
                query = query.Where(i => i.InvoiceNr == invoiceNr);

            if (!string.IsNullOrEmpty(OCR))
                query = query.Where(i => i.OCR == OCR);

            if (!string.IsNullOrEmpty(externalId))
                query = query.Where(i => i.ExternalId == externalId);

            if (invoiceId.HasValue)
                query = query.Where(i => i.InvoiceId == invoiceId.Value);

            var invoice = query
                .Select(EntityExtensions.GetCustomerInvoiceAmountDTO)
                .FirstOrDefault();

            return invoice;
        }

        public CustomerInvoiceAmountDTO GetInvoiceAmount(CompEntities entities, SoeOriginType originType, string invoiceNr, string OCR, int? invoiceId = null)
        {
            if (string.IsNullOrEmpty(invoiceNr) && string.IsNullOrEmpty(OCR) && invoiceId.GetValueOrDefault() == 0)
                return null;

            IQueryable<Invoice> query = (from i in entities.Invoice
                                         where
                                             i.State == (int)SoeEntityState.Active &&
                                             i.Origin.ActorCompanyId == ActorCompanyId &&
                                             i.Origin.Type == (int)originType
                                         select i
                    );

            if (!string.IsNullOrEmpty(invoiceNr))
            {
                query = query.Where(i => i.InvoiceNr == invoiceNr);
            }

            if (!string.IsNullOrEmpty(OCR))
            {
                query = query.Where(i => i.OCR == OCR);
            }

            if (invoiceId.HasValue)
            {
                query = query.Where(i => i.InvoiceId == invoiceId.Value);
            }

            if (originType == SoeOriginType.SupplierInvoice)
            {
                return query.Select(EntityExtensions.GetSupplierInvoiceAmountDTO).FirstOrDefault();
            }
            else
            {
                return query.Select(EntityExtensions.GetCustomerInvoiceAmountDTO).FirstOrDefault();
            }
        }


        public CustomerInvoiceDistributionDTO GetCustomerInvoiceDistribution(CompEntities entities, SoeOriginType originType, int invoiceId, int actorCompanyId)
        {
            if (invoiceId == 0)
                return null;

            IQueryable<CustomerInvoice> query = (from i in entities.Invoice.OfType<CustomerInvoice>()
                                                 where
                                                     i.State == (int)SoeEntityState.Active &&
                                                     i.Origin.ActorCompanyId == actorCompanyId &&
                                                     i.Origin.Type == (int)originType &&
                                                     i.InvoiceId == invoiceId
                                                 select i
            );

            var invoice = query
                .Select(EntityExtensions.GetCustomerInvoiceDistributionDTO)
                .FirstOrDefault();

            if (invoice != null)
            {
                invoice.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(invoice.SysCurrencyId);
            }

            return invoice;
        }

        public int? GetInvoiceId(string invoiceNr, int actorCompanyId, SoeOriginType originType)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetInvoiceId(entities, invoiceNr, actorCompanyId, originType);
        }
        public int? GetInvoiceId(CompEntities entities, string invoiceNr, int actorCompanyId, SoeOriginType originType)
        {
            return (from i in entities.Invoice
                    where i.InvoiceNr == invoiceNr &&
                         i.Origin.Type == (int)originType &&
                         i.Origin.ActorCompanyId == actorCompanyId
                    select (i != null ? i.InvoiceId : 0)).FirstOrDefault();
        }

        public ActionResult UpdatePaymentImport(PaymentImportIODTO paymentImportDTO)
        {
            using (CompEntities entities = new CompEntities())
            {
                return UpdatePaymentImport(entities, paymentImportDTO);
            }
        }

        public ActionResult UpdatePaymentImport(CompEntities entities, PaymentImportIODTO paymentImportDTO, bool addNew = false)
        {
            ActionResult result;

            paymentImportDTO.ActorCompanyId = base.ActorCompanyId;

            PaymentImportIO paymentImportIO = null;
            if (paymentImportDTO.PaymentImportIOId == 0)
            {
                paymentImportIO = new PaymentImportIO()
                {
                    ImportType = (int)paymentImportDTO.ImportType,
                    PaidDate = DateTime.Today,
                    BatchNr = paymentImportDTO.BatchNr,
                    ActorCompanyId = this.ActorCompanyId
                };
            }
            else
            {
                paymentImportIO = PaymentManager.GetPaymentImportIO(entities, paymentImportDTO.PaymentImportIOId, paymentImportDTO.ActorCompanyId);
            }

            var invoice = GetInvoiceAmount(entities, paymentImportDTO.ImportType == ImportPaymentType.CustomerPayment ? SoeOriginType.CustomerInvoice : SoeOriginType.SupplierInvoice, paymentImportDTO.InvoiceNr, null);

            /*
            if (paymentImportDTO.ImportType == ImportPaymentType.CustomerPayment)
            {
                invoice = (from i in entities.Invoice
                                .Include("Origin")
                                .Include("Currency")
                                .Include("Actor.Customer")
                           where i.InvoiceNr == paymentImportDTO.InvoiceNr &&
                                   i.State == (int)SoeEntityState.Active &&
                                   i.Type == (int)SoeInvoiceType.CustomerInvoice &&
                                   i.Origin.Type == (int)SoeOriginType.CustomerInvoice &&
                                   i.Origin.ActorCompanyId == paymentImportDTO.ActorCompanyId
                           select (i != null ? i : null)).FirstOrDefault();

            }
            else
            {
                invoice = (from i in entities.Invoice
                              .Include("Origin")
                              .Include("Currency")
                              .Include("Actor.Supplier")
                           where i.InvoiceNr == paymentImportDTO.InvoiceNr &&
                                   i.State == (int)SoeEntityState.Active &&
                                   i.Type == (int)SoeInvoiceType.SupplierInvoice &&
                                   i.Origin.ActorCompanyId == paymentImportDTO.ActorCompanyId
                           select (i != null ? i : null)).FirstOrDefault();

            }
            */

            if (invoice != null && paymentImportIO != null)
            {
                if (paymentImportDTO.PaymentImportIOId == 0 && ((invoice.TotalAmount - invoice.PaidAmount == 0) || invoice.FullyPayed))
                {
                    return new ActionResult(7562, GetText(7562, "Faktura med angivet nummer är redan betald"));
                }
                else
                {
                    /* update values */
                    /*
                    if (paymentImportIO.ImportType == (int)ImportPaymentType.CustomerPayment)
                    {
                        CustomerInvoice customerInvoice = GetCustomerInvoice(entities, invoice.InvoiceId, true, true);
                        paymentImportIO.CustomerId = customerInvoice != null ? customerInvoice.Actor.Customer.ActorCustomerId : 0;
                        paymentImportIO.Customer = customerInvoice != null ? customerInvoice.Actor.Customer.Name?.Left(50) : null;
                    }
                    else
                    {
                        SupplierInvoice supplierInvoice = SupplierInvoiceManager.GetSupplierInvoice(entities, invoice.InvoiceId, true, true, false, false, false, false);
                        paymentImportIO.CustomerId = supplierInvoice != null ? supplierInvoice.Actor.Supplier.ActorSupplierId : 0;
                        paymentImportIO.Customer = supplierInvoice != null ? supplierInvoice.Actor.Supplier.Name?.Left(50) : null;
                    }
                    */

                    paymentImportIO.CustomerId = invoice.ActorId;
                    paymentImportIO.Customer = invoice.ActorName?.Left(50);

                    paymentImportIO.PaidAmount = paymentImportDTO.PaidAmount == null && paymentImportDTO.PaymentImportIOId == 0 ? invoice.TotalAmount - invoice.PaidAmount : paymentImportDTO.PaidAmount;
                    paymentImportIO.RestAmount = invoice.TotalAmount - invoice.PaidAmount - paymentImportIO.PaidAmount;
                    paymentImportIO.InvoiceNr = invoice.InvoiceNr;
                    paymentImportIO.InvoiceId = invoice.InvoiceId;
                    paymentImportIO.InvoiceDate = invoice.DueDate;
                    paymentImportIO.InvoiceAmount = invoice.TotalAmount;
                    paymentImportIO.PaidDate = paymentImportDTO.PaidDate;
                    paymentImportIO.DueDate = invoice.DueDate;
                    paymentImportIO.MatchCodeId = paymentImportDTO.MatchCodeId;
                    paymentImportIO.Type = invoice.TotalAmount >= 0 ? (int)TermGroup_BillingType.Debit : (int)TermGroup_BillingType.Credit;
                    paymentImportIO.PaidAmountCurrency = paymentImportDTO.PaidAmountCurrency != null ? invoice.TotalAmountCurrency - invoice.PaidAmountCurrency - paymentImportDTO.PaidAmountCurrency : invoice.TotalAmountCurrency - invoice.PaidAmountCurrency;
                    paymentImportIO.Currency = CountryCurrencyManager.GetCurrencyCode(invoice.CurrencyId);

                    // Remove comment
                    paymentImportDTO.Comment = String.Empty;

                    ImportPaymentIOStatus status;
                    if (invoice.FullyPayed && paymentImportIO.PaidAmount == 0)
                        status = ImportPaymentIOStatus.FullyPaid;
                    else if (paymentImportIO.PaidAmount < invoice.TotalAmount)
                        status = ImportPaymentIOStatus.PartlyPaid;
                    else if (paymentImportIO.PaidAmount > invoice.TotalAmount - invoice.PaidAmount)
                        status = ImportPaymentIOStatus.Rest;
                    else
                        status = ImportPaymentIOStatus.Match;
                    paymentImportIO.Status = (int)status;
                    paymentImportIO.State = (int)ImportPaymentIOState.Open;
                }

                if (paymentImportDTO.PaymentImportIOId == 0)
                {
                    // Reset status 
                    paymentImportIO.Status = (int)ImportPaymentIOStatus.Manual;

                    if (addNew)
                    {
                        entities.PaymentImportIO.AddObject(paymentImportIO);
                    }

                    result = new ActionResult(true);
                }
                else
                {
                    result = PaymentManager.UpdatePaymentImportIO(entities, paymentImportIO, paymentImportIO.PaymentImportIOId, paymentImportIO.ActorCompanyId);
                }

                if (result.Success)
                {
                    result.IntegerValue = paymentImportIO.PaymentImportIOId;
                    result.Value = paymentImportIO.ToDTO();
                }
            }
            else
            {
                return new ActionResult(7561, GetText(7561, "Kunde ej matcha faktura mot angivet nummer"));
            }

            return result;
        }

        public ActionResult UpdatePaymentImportIO(CompEntities entities, PaymentImportIODTO paymentImportDTO)
        {
            ActionResult result = new ActionResult();

            PaymentImportIO paymentImportIO = PaymentManager.GetPaymentImportIO(entities, paymentImportDTO.PaymentImportIOId, paymentImportDTO.ActorCompanyId);

            if (paymentImportIO != null)
            {
                /* update values */
                paymentImportIO.ActorCompanyId = paymentImportDTO.ActorCompanyId;
                paymentImportIO.CustomerId = paymentImportDTO.CustomerId;
                paymentImportIO.Customer = paymentImportDTO.Customer;
                paymentImportIO.PaidAmount = paymentImportDTO.PaidAmount;
                paymentImportIO.RestAmount = paymentImportDTO.RestAmount;
                paymentImportIO.InvoiceNr = paymentImportDTO.InvoiceNr;
                paymentImportIO.InvoiceId = paymentImportDTO.InvoiceId;
                paymentImportIO.InvoiceDate = paymentImportDTO.InvoiceDate;
                paymentImportIO.InvoiceAmount = paymentImportDTO.InvoiceAmount;
                paymentImportIO.Status = (int)paymentImportDTO.Status;
                paymentImportIO.State = (int)paymentImportDTO.State;

                if (paymentImportDTO.PaymentRowId.HasValue && paymentImportDTO.PaymentRowId.Value > 0)
                    paymentImportIO.PaymentRowId = paymentImportDTO.PaymentRowId.Value;

                result = PaymentManager.UpdatePaymentImportIO(entities, paymentImportIO, paymentImportIO.PaymentImportIOId, paymentImportIO.ActorCompanyId);
            }
            else if (paymentImportDTO.PaymentImportIOId == 0 && paymentImportDTO.Status == ImportPaymentIOStatus.Manual && paymentImportDTO.CustomerId != 0 && paymentImportDTO.InvoiceId != 0)
            {
                int actorCompanyId = base.ActorCompanyId;

                paymentImportIO = new PaymentImportIO
                {
                    ActorCompanyId = actorCompanyId,
                    BatchNr = paymentImportDTO.BatchNr,
                    Type = (int)paymentImportDTO.Type,
                    CustomerId = paymentImportDTO.InvoiceId,
                    Customer = paymentImportDTO.Customer,
                    InvoiceId = paymentImportDTO.InvoiceId,
                    InvoiceNr = paymentImportDTO.InvoiceNr,
                    InvoiceAmount = paymentImportDTO.InvoiceAmount,
                    RestAmount = paymentImportDTO.RestAmount,
                    PaidAmount = paymentImportDTO.PaidAmount,
                    Currency = "SEK",
                    InvoiceDate = paymentImportDTO.InvoiceDate,
                    PaidDate = paymentImportDTO.PaidDate,
                    MatchCodeId = 0,
                    Status = (int)paymentImportDTO.Status,
                    State = (int)paymentImportDTO.State,
                    ImportType = (int)paymentImportDTO.ImportType,
                };

                if (paymentImportDTO.PaymentRowId.HasValue && paymentImportDTO.PaymentRowId.Value > 0)
                    paymentImportIO.PaymentRowId = paymentImportDTO.PaymentRowId.Value;

                entities.PaymentImportIO.AddObject(paymentImportIO);

                SetCreatedProperties(paymentImportIO);

                return SaveChanges(entities);
            }
            else
            {
                result.Success = false;
                return result;
            }

            return result;
        }

        public bool InvoiceHasVouchers(CompEntities entities, int invoiceId)
        {
            return (from i in entities.Invoice
                    where i.InvoiceId == invoiceId &&
                    i.VoucherHeadId != null
                    select i).Any();
        }


        public bool InvoiceHasPayments(CompEntities entities, int invoiceId)
        {
            return GetNoOfInvoicePayments(entities, invoiceId) > 0;
        }

        public bool IsInvoiceForeign(int invoiceId, int baseSysCurrencyId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            int counter = (from i in entitiesReadOnly.Invoice
                           where i.InvoiceId == invoiceId &&
                           i.Currency.SysCurrencyId != baseSysCurrencyId
                           select i).Count();

            return counter > 0;
        }

        public int GetNoOfInvoicePayments(CompEntities entities, int invoiceId)
        {
            return (from p in entities.PaymentRow
                    where p.Invoice.InvoiceId == invoiceId &&
                    p.Status != (int)SoeOriginStatus.Cancel
                    select p.Invoice).Count();
        }

        public void SetVoucherDateIfMissing(Invoice invoice, DateTime? voucherDate = null)
        {
            if (invoice == null)
                return;

            //VoucherDate
            if (!invoice.VoucherDate.HasValue)
            {
                if (voucherDate.HasValue)
                    invoice.VoucherDate = voucherDate.Value;
                else if (invoice.InvoiceDate.HasValue)
                    invoice.VoucherDate = invoice.InvoiceDate.Value;
                else
                    invoice.VoucherDate = DateTime.Now.Date;
            }
            else if (voucherDate.HasValue)
            {
                invoice.VoucherDate = voucherDate;
            }
        }

        public void SetInvoiceFullyPayed(CompEntities entites, Invoice invoice, bool fullyPayed = true)
        {
            if (invoice == null)
                return;

            bool changed = invoice.FullyPayed != fullyPayed;
            if (changed)
            {
                invoice.FullyPayed = fullyPayed;
                SetModifiedProperties(invoice);
            }
        }

        public void ResetInvoicePaidAmount(Invoice invoice, decimal additionalAmount)
        {
            if (invoice == null)
                return;

            invoice.PaidAmount += additionalAmount;
            SetModifiedProperties(invoice);
        }

        public ActionResult InvoiceNumberExist(CompEntities entites, SoeInvoiceType type, int actorCompanyId, int exceptInvoiceId, string invoiceNr, int actorId)
        {
            //i.Origin.ActorCompanyId == actorCompanyId &&
            IQueryable<Invoice> query = (from i in entites.Invoice
                                         where
                                             i.Type == (int)type &&
                                             i.InvoiceId != exceptInvoiceId &&
                                             i.Origin.ActorCompanyId == actorCompanyId &&
                                             i.InvoiceNr == invoiceNr &&
                                             i.State == (int)SoeEntityState.Active
                                         select i
                                          );
            if (actorId > 0)
            {
                query = query.Where(i => i.ActorId == actorId);
            }

            var invoiceInfo = (from i in query select new { i.InvoiceId, i.SeqNr }).FirstOrDefault();

            // Default result: Invoice number does not exist
            var result = new ActionResult(false);

            if (invoiceInfo != null)
            {
                result.Success = true;
                result.IntegerValue = invoiceInfo.SeqNr.GetValueOrDefault();
                result.IntegerValue2 = invoiceInfo.InvoiceId;
            }

            return result;
        }

        public ActionResult DeleteInvoices(List<int> invoiceIds, int actorCompanyId, bool deleteProject, bool resetRowStatus = false)
        {
            ActionResult result = new ActionResult();

            int deletedCount = 0;
            int errorCount = 0;

            foreach (int invoiceId in invoiceIds)
            {
                result = DeleteInvoice(invoiceId, actorCompanyId, deleteProject, resetRowStatus);

                if (result.Success)
                    deletedCount++;
                else
                    errorCount++;
            }

            result.IntegerValue = deletedCount;
            result.IntegerValue2 = errorCount;

            return result;
        }

        public ActionResult DeleteInvoice(int invoiceId, int actorCompanyId, bool deleteProject, bool restoreRowStatus = true, bool isContract = false)
        {
            var result = new ActionResult();
            bool usePartialInvoicingOnOrderRow = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingUsePartialInvoicingOnOrderRow, base.UserId, base.ActorCompanyId, 0);

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    InitializeAttestStateIds(entities, actorCompanyId);

                    int guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, base.ActorCompanyId, 0);

                    //Ids of orders that should get its status updated
                    List<CustomerInvoice> ordersToUpdate = new List<CustomerInvoice>();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        // Get Invoice
                        Invoice invoice = GetInvoice(entities, invoiceId);
                        if (invoice == null)
                            return new ActionResult((int)ActionResultDelete.EntityNotFound, "Invoice");

                        if (invoice.Origin == null)
                            return new ActionResult((int)ActionResultDelete.EntityIsNull, "Origin");
                        if (InvoiceHasPayments(entities, invoiceId))
                            return new ActionResult((int)ActionResultDelete.InvoiceHasPayments, GetText(7631, "Fakturan har betalningar och kan ej makuleras"));
                        if (InvoiceHasVouchers(entities, invoiceId))
                            return new ActionResult((int)ActionResultDelete.InvoiceHasVouchers);
                        if (invoice.Origin.Type == (int)SoeOriginType.Offer && (invoice.Origin.Status == (int)SoeOriginStatus.OfferPartlyOrder || invoice.Origin.Status == (int)SoeOriginStatus.OfferFullyOrder))
                            return new ActionResult((int)ActionResultDelete.OfferIsTransferredToOrder);
                        if (invoice.Origin.Type == (int)SoeOriginType.Offer && (invoice.Origin.Status == (int)SoeOriginStatus.OfferPartlyInvoice || invoice.Origin.Status == (int)SoeOriginStatus.OfferFullyInvoice))
                            return new ActionResult((int)ActionResultDelete.OfferIsTransferredToInvoice);
                        if (invoice.Origin.Type == (int)SoeOriginType.Order)
                        {
                            if (!FeatureManager.HasRolePermission(Feature.Billing_Order_Orders_Edit, Permission.Modify, base.RoleId, actorCompanyId, entities: entities))
                                return new ActionResult((int)ActionResultDelete.NothingDeleted, GetText(8652, "Otillåten ändring, behörighet saknas"));

                            if ((invoice.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice || invoice.Origin.Status == (int)SoeOriginStatus.OrderFullyInvoice))
                                return new ActionResult((int)ActionResultDelete.OrderIsTransferredToInvoice);
                        }

                        if (invoice.Origin.Type == (int)SoeOriginType.Order && invoice.ProjectId.HasValue)
                        {
                            if (ProjectManager.HasProjectTimeBlocks(entities, invoice.InvoiceId, invoice.ProjectId.Value, actorCompanyId))
                            {
                                return new ActionResult(7520, GetText(7520, "Ordern innehåller registrerade tidrader. Dessa måste flyttas till en annan order eller tas bort innan borttagning av ordern kan utföras"));
                            }
                        }

                        #endregion

                        if (invoice is CustomerInvoice)
                        {
                            #region CustomerInvoice

                            bool checkState = false;
                            CustomerInvoice customerInvoice = invoice as CustomerInvoice;

                            int stateType;
                            if (customerInvoice.Origin.Status == (int)SoeOriginStatus.Origin)
                            {
                                stateType = (int)SoeEntityState.Active;
                                invoice.Origin.Status = (int)SoeOriginStatus.Cancel;
                            }
                            else
                            {
                                checkState = restoreRowStatus;
                                stateType = (int)SoeEntityState.Deleted;
                            }

                            //Invoice
                            invoice.State = stateType;

                            //Get order transitions
                            List<AttestTransition> attestTransitions = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, base.UserId, base.ActorCompanyId, entity: TermGroup_AttestEntity.Order);
                            List<AttestTransition> attestTransitionsOffer = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, base.UserId, base.ActorCompanyId, entity: TermGroup_AttestEntity.Offer);

                            //CustomerInvoiceRow
                            foreach (CustomerInvoiceRow invoiceRow in customerInvoice.ActiveCustomerInvoiceRows)
                            {
                                CustomerInvoiceRow originalInvoiceRow = GetCustomerInvoiceRow(entities, invoiceRow.CustomerInvoiceRowId);
                                if (originalInvoiceRow == null)
                                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "CustomerInvoiceRow");

                                if (originalInvoiceRow.State != (int)SoeEntityState.Active)
                                    continue;

                                if (checkState)
                                {
                                    var parentRow = GetCustomerInvoiceRowFromTargetRow(entities, invoiceRow.CustomerInvoiceRowId);

                                    if (parentRow != null)
                                    {
                                        var parent = GetCustomerInvoice(entities, parentRow.InvoiceId, loadOrigin: true, loadInvoiceRow: true);

                                        if (parent.Origin.Type == (int)SoeOriginType.Order || parent.Origin.Type == (int)SoeOriginType.Offer)
                                        {
                                            if (!parentRow.ProductReference.IsLoaded)
                                                parentRow.ProductReference.Load();

                                            invoiceRow.LoadHouseholdTaxDeductionRowReference();

                                            if (
                                                (invoiceRow.Product == null ||
                                                    ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift ||
                                                    (((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift &&
                                                    ((parent.BillingType == (int)TermGroup_BillingType.Credit && invoiceRow.SumAmountCurrency < 0) || (parent.BillingType == (int)TermGroup_BillingType.Debit && invoiceRow.SumAmountCurrency > 0)))
                                                ) &&
                                                (
                                                    invoiceRow.Type != (int)SoeInvoiceRowType.ProductRow ||
                                                    (invoice.BillingType == (int)TermGroup_BillingType.Debit && ((invoiceRow.SumAmount != 0 || invoiceRow.Quantity != 0) || (parentRow.SupplierInvoiceId.HasValue && parentRow.SupplierInvoiceId.Value > 0))) ||
                                                    (invoice.BillingType == (int)TermGroup_BillingType.Credit && ((invoiceRow.SumAmount != 0 || invoiceRow.Quantity != 0) || (parentRow.SupplierInvoiceId.HasValue && parentRow.SupplierInvoiceId.Value > 0))) ||
                                                    (invoiceRow.HouseholdTaxDeductionRow != null && invoiceRow.HouseholdTaxDeductionRow.State == (int)SoeEntityState.Active && invoiceRow.HouseholdTaxDeductionRow.AmountCurrency != 0)
                                                )
                                               )
                                            {
                                                var transition = parent.Origin.Type == (int)SoeOriginType.Order ? attestTransitions.FirstOrDefault(a => a.AttestStateToId == parentRow.AttestStateId) : attestTransitionsOffer.FirstOrDefault(a => a.AttestStateToId == parentRow.AttestStateId);
                                                if (transition != null)
                                                {
                                                    parentRow.AttestStateId = transition.AttestStateFromId;
                                                    parentRow.TargetRowId = null;

                                                    SetModifiedProperties(parentRow);
                                                    if (!ordersToUpdate.Select(i => i.InvoiceId).Contains(parentRow.InvoiceId))
                                                        ordersToUpdate.Add(parent);

                                                    // Check for guarantee
                                                    var invoiceRowProduct = invoiceRow.Product as InvoiceProduct;
                                                    if (invoiceRow.Type == (int)SoeInvoiceRowType.ProductRow && invoiceRowProduct != null && invoiceRowProduct.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift && invoiceRowProduct.GuaranteePercentage.GetValueOrDefault() != 0 && invoiceRow.SumAmount != 0)
                                                    {
                                                        var guaranteeRow = parent.ActiveCustomerInvoiceRows.FirstOrDefault(r => r.ProductId == guaranteeProductId && r.SumAmountCurrency != 0);
                                                        if (guaranteeRow != null)
                                                        {
                                                            guaranteeRow.Amount -= ((invoiceRowProduct.GuaranteePercentage.Value * invoiceRow.Amount) / 100);
                                                            guaranteeRow.AmountCurrency -= ((invoiceRowProduct.GuaranteePercentage.Value * invoiceRow.AmountCurrency) / 100);
                                                            guaranteeRow.AmountEntCurrency -= ((invoiceRowProduct.GuaranteePercentage.Value * invoiceRow.AmountEntCurrency) / 100);
                                                            guaranteeRow.AmountLedgerCurrency -= ((invoiceRowProduct.GuaranteePercentage.Value * invoiceRow.AmountLedgerCurrency) / 100);

                                                            CalculateRowSum(guaranteeRow, parent.CurrencyRate, 0);
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                }

                                //CustomerInvoiceReminder
                                if (originalInvoiceRow.IsReminderRow)
                                    DecreaseNoOfReminders(entities, originalInvoiceRow);

                                //CustomerInvoiceInterest
                                if (originalInvoiceRow.IsInterestRow)
                                {
                                    //Make sure CustomerInvoiceInterestReference is loaded
                                    if (!originalInvoiceRow.CustomerInvoiceInterestReference.IsLoaded)
                                        originalInvoiceRow.CustomerInvoiceInterestReference.Load();

                                    originalInvoiceRow.CustomerInvoiceInterest = null;
                                }

                                if (originalInvoiceRow.SupplierInvoiceId.HasValue)
                                {
                                    originalInvoiceRow.SupplierInvoiceId = null;
                                }
                                // Stock
                                // delete draft invoice and restoreRowStatus, no difference i reserved since klar on order is also Reserved..but if not restoreRowStatus, reserved should be calculated down...
                                if ((invoice.Origin.Type == (int)SoeOriginType.Order && invoiceRow.IsStockRow != null && (bool)invoiceRow.IsStockRow) ||
                                       (invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice && invoice.Origin.Status == (int)SoeOriginStatus.Draft && !restoreRowStatus && invoiceRow.StockId.GetValueOrDefault() > 0))
                                {

                                    HandleStockOnInvoiceRowDelete(entities, transaction, customerInvoice, originalInvoiceRow, usePartialInvoicingOnOrderRow);
                                    //CreateStockTransaction(entities, transaction, actorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                    //    (int)invoiceRow.ProductId, (int)invoiceRow.StockId, -Convert.ToDecimal(GetQuantity(invoice.BillingType, invoiceRow.Quantity)), -Convert.ToDecimal(GetQuantity(invoice.BillingType, invoiceRow.InvoiceQuantity)), invoiceRow.PurchasePrice, invoiceRow.CustomerInvoiceRowId);
                                }

                                originalInvoiceRow.State = stateType;
                                SetModifiedProperties(originalInvoiceRow);

                                //CustomerInvoiceAccountRow
                                foreach (CustomerInvoiceAccountRow accountRow in invoiceRow.CustomerInvoiceAccountRow)
                                {
                                    CustomerInvoiceAccountRow originalAccountRow = GetCustomerInvoiceAccountRow(entities, accountRow.CustomerInvoiceAccountRowId);
                                    if (originalAccountRow == null)
                                        return new ActionResult((int)ActionResultDelete.EntityNotFound, "CustomerInvoiceAccountRow");

                                    if (originalAccountRow.State != (int)SoeEntityState.Active)
                                        continue;

                                    originalAccountRow.State = stateType;
                                    SetModifiedProperties(originalAccountRow);
                                }
                            }

                            if (invoice.Origin.Type == (int)SoeOriginType.Order)
                            {
                                var orderPlanningBlocks = TimeScheduleManager.GetTimeScheduleTemplateBlocksForOrder(entities, invoice.InvoiceId);
                                if (orderPlanningBlocks.Any())
                                {
                                    foreach (var orderPlanningBlock in orderPlanningBlocks)
                                    {
                                        orderPlanningBlock.State = (int)SoeEntityState.Deleted;
                                        SetModifiedProperties(orderPlanningBlock);
                                    }
                                }
                            }

                            //Delete project transactions
                            if (invoice.ProjectId != null)
                                result = ProjectManager.DeleteProjectInvoiceWeeks(entities, transaction, (int)invoice.ProjectId, invoice.InvoiceId, (int)SoeProjectRecordType.Order);

                            #endregion
                        }
                        else if (invoice is SupplierInvoice)
                        {
                            #region SupplierInvoice

                            SupplierInvoice supplierInvoice = invoice as SupplierInvoice;

                            int stateType;

                            // We can delete unless it's already a Voucher or payment. Task 10999
                            if (supplierInvoice.Origin.Status == (int)SoeOriginStatus.Origin)
                            {
                                stateType = (int)SoeEntityState.Active;
                                invoice.Origin.Status = (int)SoeOriginStatus.Cancel;
                            }
                            else
                            {
                                stateType = (int)SoeEntityState.Deleted;
                            }

                            //Invoice
                            invoice.State = stateType;

                            // Attest
                            var attestWorkflowHead = AttestManager.GetAttestWorkFlowHeadFromInvoiceId(entities, invoice.InvoiceId, false, false, true);
                            if (attestWorkflowHead != null)
                            {
                                result = AttestManager.DeleteAttestWorkFlowHead(entities, transaction, supplierInvoice, attestWorkflowHead);
                                if (!result.Success)
                                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "AttestWorkflowHead");
                            }

                            //SupplierInvoiceRow
                            foreach (SupplierInvoiceRow invoiceRow in supplierInvoice.SupplierInvoiceRow)
                            {
                                SupplierInvoiceRow originalInvoiceRow = SupplierInvoiceManager.GetSupplierInvoiceRow(entities, invoiceRow.SupplierInvoiceRowId);
                                if (originalInvoiceRow == null)
                                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "SupplierInvoiceRow");

                                if (originalInvoiceRow.State != (int)SoeEntityState.Active)
                                    continue;

                                ChangeEntityState(originalInvoiceRow, SoeEntityState.Deleted);

                                //SupplierInvoiceAccountRow
                                foreach (SupplierInvoiceAccountRow accountRow in invoiceRow.SupplierInvoiceAccountRow)
                                {
                                    SupplierInvoiceAccountRow originalAccountRow = SupplierInvoiceManager.GetSupplierInvoiceAccountRow(entities, accountRow.SupplierInvoiceAccountRowId, false);
                                    if (originalAccountRow == null)
                                        return new ActionResult((int)ActionResultDelete.EntityNotFound, "SupplierInvoiceAccountRow");

                                    if (originalAccountRow.State != (int)SoeEntityState.Active)
                                        continue;

                                    ChangeEntityState(originalAccountRow, SoeEntityState.Deleted);
                                }
                            }

                            //SupplierInvoiceOrderRow
                            List<SupplierInvoiceOrderRowDTO> orderRows = SupplierInvoiceManager.GetSupplierInvoiceOrderRows(entities, actorCompanyId, invoice.InvoiceId).ToList();

                            foreach (SupplierInvoiceOrderRowDTO orderRow in orderRows)
                            {
                                result = DeleteCustomerInvoiceRow(transaction, entities, actorCompanyId, orderRow.CustomerInvoiceId, orderRow.CustomerInvoiceRowId);

                                if (result.Success)
                                {
                                    OriginInvoiceMapping oimap = (from a in entities.OriginInvoiceMapping
                                                                  where a.InvoiceId == orderRow.SupplierInvoiceId &&
                                                                  a.OriginId == orderRow.CustomerInvoiceId &&
                                                                  a.Type == (int)SoeOriginType.SupplierInvoice
                                                                  select a).FirstOrDefault();

                                    if (oimap != null)
                                    {
                                        entities.Attach(oimap);
                                        entities.DeleteObject(oimap);
                                    }
                                }
                            }


                            // Time code transaction
                            if (!supplierInvoice.TimeCodeTransaction.IsLoaded)
                                supplierInvoice.TimeCodeTransaction.Load();

                            foreach (var projectRow in supplierInvoice.TimeCodeTransaction)
                            {
                                if (projectRow.State == (int)SoeEntityState.Active)
                                {
                                    projectRow.State = (int)SoeEntityState.Deleted;
                                    SetModifiedProperties(projectRow);
                                }
                            }

                            #endregion
                        }

                        SetModifiedProperties(invoice);
                        result = SaveChanges(entities, transaction);

                        if (deleteProject && invoice.ProjectId != null && ProjectManager.ProjectInvoicesCount(entities, (int)invoice.ProjectId) < 2)
                        {
                            result = ProjectManager.DeleteProject(entities, transaction, (int)invoice.ProjectId, actorCompanyId, invoice.InvoiceId);
                        }


                        if (ordersToUpdate.Any())
                        {
                            foreach (var order in ordersToUpdate)
                            {
                                int noOfTransferredRows = 0;
                                int noOfClosedRows = 0;
                                int noOfNotTransferredRows = 0;
                                SoeOriginType transferredTo = SoeOriginType.None;

                                foreach (var row in order.CustomerInvoiceRow)
                                {
                                    //Check if row is transferred
                                    GetTransferState(order, row, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                }


                                //Settings
                                bool useCentRounding = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseCentRounding, 0, actorCompanyId, 0);

                                //Calculate amounts
                                CalculateAmountsByCurrency(entities, order, useCentRounding, base.ActorCompanyId, true);

                                //Update order Status
                                UpdateInvoiceStatus(order, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OrderClosed, SoeOriginStatus.OrderFullyInvoice, SoeOriginStatus.OrderPartlyInvoice);
                                ProjectManager.ChangeStopDateForHiddenProject(entities, order);
                                SetModifiedProperties(order);
                            }

                            result = SaveChanges(entities, transaction);
                        }
                        else if (isContract && restoreRowStatus)
                        {
                            var mappedContract = GetMappedInvoices(entities, invoiceId, new List<SoeOriginInvoiceMappingType> { SoeOriginInvoiceMappingType.Contract }, false).FirstOrDefault();
                            if (mappedContract != null)
                            {
                                var contract = GetCustomerInvoice(entities, mappedContract.OriginId, loadContractGroup: true);
                                if (contract != null && contract.ContractGroup != null)
                                {
                                    Tuple<int, int> nextPeriod = CalendarUtility.CalculatePreviousPeriod((TermGroup_ContractGroupPeriod)contract.ContractGroup.Period, contract.ContractGroup.Interval, contract.NextContractPeriodYear, contract.NextContractPeriodValue);
                                    contract.NextContractPeriodYear = nextPeriod.Item1;
                                    contract.NextContractPeriodValue = nextPeriod.Item2;

                                    if (invoice.InvoiceDate.HasValue)
                                        contract.NextContractPeriodDate = invoice.InvoiceDate.Value;
                                    else
                                        contract.NextContractPeriodDate = CalendarUtility.ConvertContractPeriodToDate((TermGroup_ContractGroupPeriod)contract.ContractGroup.Period, contract.InvoiceDate.Value, nextPeriod.Item1, nextPeriod.Item2, contract.ContractGroup.DayInMonth);

                                    SetModifiedProperties(contract);
                                    result = SaveChanges(entities, transaction);
                                }
                            }
                        }

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    log.Error(ex.Message, ex);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult ChangeInvoiceSequenceNumber(int invoiceId, int sequenceNumber)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    #region Prereq

                    // Get Invoice
                    Invoice invoice = GetInvoice(entities, invoiceId);
                    if (invoice == null)
                        return new ActionResult((int)ActionResultDelete.EntityNotFound, "Invoice");
                    if (invoice.Origin == null)
                        return new ActionResult((int)ActionResultDelete.EntityIsNull, "Origin");

                    #endregion

                    if (sequenceNumber == 0)
                        sequenceNumber = GetNextSequenceNumber(entities, (SoeOriginType)invoice.Origin.Type, (SoeOriginStatus)invoice.Origin.Status, (TermGroup_BillingType)invoice.BillingType, ActorCompanyId, false);

                    invoice.SeqNr = sequenceNumber;
                    SetModifiedProperties(invoice);

                    result = SaveChanges(entities);

                    if (result.Success)
                        result.Value = sequenceNumber;
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    log.Error(ex.Message, ex);
                }
            }

            return result;
        }

        #endregion

        #region Matching

        public List<InvoiceMatchingDTO> GetInvoicePaymentMatches(int actorCompanyId, int actorId, SoeOriginType originType)
        {
            List<InvoiceMatchingDTO> dtos = new List<InvoiceMatchingDTO>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<InvoicePaymentUnionView> itemsForActor = null;

            if (originType == SoeOriginType.SupplierInvoice)
            {
                #region SupplierInvoice

                entitiesReadOnly.InvoicePaymentUnionView.NoTracking();
                itemsForActor = (from i in entitiesReadOnly.InvoicePaymentUnionView
                                 where i.ActorCompanyId == actorCompanyId &&
                                 i.ActorId == actorId &&
                                 (i.OriginType == (int)SoeOriginType.SupplierInvoice || i.OriginType == (int)SoeOriginType.SupplierPayment)
                                 select i).ToList();

                var itemsSI = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierInvoice && (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher)).ToList();
                foreach (var itemSI in itemsSI)
                {
                    if (itemSI.Status == (int)SoeOriginStatus.Origin || itemSI.Status == (int)SoeOriginStatus.Voucher)
                    {
                        if (!itemSI.BlockPayment)
                        {
                            decimal invoiceTotalAmount = itemSI.InvoiceTotalAmountCurrency != 0 ? itemSI.InvoiceTotalAmountCurrency : itemSI.InvoiceTotalAmount;
                            decimal invoicePaidAmount = itemSI.InvoicePaidAmountCurrency != 0 ? itemSI.InvoicePaidAmountCurrency : itemSI.InvoicePaidAmount;

                            #region Suggestion check

                            string paymentNrs = "";
                            bool isSuggestion = false;

                            var payments = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierPayment && i.InvoiceId == itemSI.InvoiceId && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                            foreach (var payment in payments)
                            {
                                if (paymentNrs != string.Empty)
                                    paymentNrs += ", ";

                                paymentNrs += payment.PaymentSeqNr;

                                if (!isSuggestion && payment.PaymentIsSuggestion)
                                    isSuggestion = true;
                            }

                            #endregion

                            if (itemSI.FullyPayed || itemSI.InvoiceTotalAmountCurrency == itemSI.InvoicePaidAmountCurrency)
                            {
                                if (isSuggestion)
                                {
                                    dtos.Add(new InvoiceMatchingDTO()
                                    {
                                        IsSelected = false,
                                        IsEditable = !isSuggestion,
                                        InvoiceId = itemSI.InvoiceId,
                                        InvoiceNr = itemSI.InvoiceNr,
                                        InvoiceTotalAmount = invoiceTotalAmount,
                                        InvoicePayedAmount = invoicePaidAmount,
                                        PaymentNr = paymentNrs,
                                        Type = (int)originType,
                                        BillingType = (TermGroup_BillingType)itemSI.BillingTypeId,
                                        InvoiceMatchAmount = itemSI.RemainingAmount != 0 ? decimal.Negate(itemSI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount),
                                    });
                                }
                            }
                            else
                            {
                                dtos.Add(new InvoiceMatchingDTO()
                                {
                                    IsSelected = false,
                                    IsEditable = !isSuggestion,
                                    InvoiceId = itemSI.InvoiceId,
                                    InvoiceNr = itemSI.InvoiceNr,
                                    InvoiceTotalAmount = invoiceTotalAmount,
                                    InvoicePayedAmount = invoicePaidAmount,
                                    PaymentNr = paymentNrs,
                                    Type = (int)originType,
                                    BillingType = (TermGroup_BillingType)itemSI.BillingTypeId,
                                    InvoiceMatchAmount = itemSI.RemainingAmount != 0 ? decimal.Negate(itemSI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount),
                                });
                            }
                        }
                    }
                }

                #endregion

                #region SupplierPayment

                var itemsSP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierPayment && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                foreach (var itemSP in itemsSP)
                {
                    decimal paymentTotalAmount = itemSP.InvoiceTotalAmountCurrency != 0 ? itemSP.InvoiceTotalAmountCurrency : itemSP.InvoiceTotalAmount;
                    decimal paymentPaidAmount = itemSP.PaymentAmountCurrency != 0 ? itemSP.PaymentAmountCurrency : itemSP.PaymentAmount;

                    using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                    entities.InvoicePaymentMatchingRecord.NoTracking();
                    var record = (from im in entities.InvoicePaymentMatchingRecord
                                  where im.Entity == itemSP.OriginType &&
                                  im.RecordId == itemSP.PaymentRowId &&
                                  im.State == (int)SoeEntityState.Active
                                  select im).FirstOrDefault();

                    if (record == null)
                    {
                        if (itemSP.InvoiceTotalAmount < itemSP.PaymentAmount || itemSP.InvoiceSeqNr == null)
                        {
                            dtos.Add(new InvoiceMatchingDTO()
                            {
                                IsSelected = false,
                                IsEditable = true,
                                InvoiceId = itemSP.InvoiceId,
                                InvoiceNr = itemSP.InvoiceNr,
                                PaymentRowId = itemSP.PaymentRowId,
                                InvoiceTotalAmount = paymentPaidAmount, //Switch paid and total for grid
                                InvoicePayedAmount = paymentTotalAmount,
                                PaymentNr = itemSP.PaymentSeqNr.ToString(),
                                Type = (int)SoeOriginType.SupplierPayment,
                                InvoiceMatchAmount = itemSP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount,
                            });
                        }
                    }
                    else
                    {
                        if (record.Amount != null)
                        {
                            decimal usedAmount = paymentPaidAmount + (decimal)record.Amount;

                            if (usedAmount < (itemSP.PaymentAmountCurrency != 0 ? itemSP.PaymentAmountCurrency : itemSP.PaymentAmount))
                            {
                                dtos.Add(new InvoiceMatchingDTO()
                                {
                                    IsSelected = false,
                                    IsEditable = true,
                                    InvoiceId = itemSP.InvoiceId,
                                    InvoiceNr = itemSP.InvoiceNr,
                                    PaymentRowId = itemSP.PaymentRowId,
                                    InvoiceTotalAmount = paymentPaidAmount, //Switch paid and total for grid
                                    InvoicePayedAmount = paymentTotalAmount,
                                    PaymentNr = itemSP.PaymentSeqNr.ToString(),
                                    Type = (int)SoeOriginType.SupplierPayment,
                                    InvoiceMatchAmount = itemSP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount,
                                });
                            }
                        }
                    }
                }

                #endregion
            }
            else if (originType == SoeOriginType.CustomerInvoice)
            {
                #region CustomerInvoice
                entitiesReadOnly.Invoice.NoTracking();
                itemsForActor = (from i in entitiesReadOnly.InvoicePaymentUnionView
                                 where i.ActorCompanyId == actorCompanyId &&
                                 i.ActorId == actorId &&
                                 (i.OriginType == (int)SoeOriginType.CustomerInvoice || i.OriginType == (int)SoeOriginType.CustomerPayment)
                                 select i).ToList();

                var itemsCI = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerInvoice && (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher)).ToList();
                foreach (var itemCI in itemsCI)
                {
                    if (itemCI.Status == (int)SoeOriginStatus.Origin || itemCI.Status == (int)SoeOriginStatus.Voucher)
                    {
                        decimal invoiceTotalAmount = itemCI.InvoiceTotalAmountCurrency != 0 ? itemCI.InvoiceTotalAmountCurrency : itemCI.InvoiceTotalAmount;
                        decimal invoicePaidAmount = itemCI.InvoicePaidAmountCurrency != 0 ? itemCI.InvoicePaidAmountCurrency : itemCI.InvoicePaidAmount;

                        if (!itemCI.FullyPayed)
                        {
                            dtos.Add(new InvoiceMatchingDTO
                            {
                                IsSelected = false,
                                IsEditable = true,
                                InvoiceId = itemCI.InvoiceId,
                                InvoiceNr = itemCI.InvoiceNr,
                                InvoiceTotalAmount = invoiceTotalAmount,
                                InvoicePayedAmount = invoicePaidAmount,
                                PaymentNr = itemCI.PaymentNr,
                                Type = (int)originType,
                                BillingType = (TermGroup_BillingType)itemCI.BillingTypeId,
                                InvoiceMatchAmount = itemCI.RemainingAmount != 0 ? decimal.Negate(itemCI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount),
                                registrationType = (OrderInvoiceRegistrationType)itemCI.RegistrationType,
                            });
                        }
                    }
                }

                #endregion

                #region CustomerPayment

                var itemsCP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerPayment && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                foreach (var itemCP in itemsCP)
                {
                    decimal paymentTotalAmount = itemCP.InvoiceTotalAmountCurrency != 0 ? itemCP.InvoiceTotalAmountCurrency : itemCP.InvoiceTotalAmount;
                    decimal paymentPaidAmount = itemCP.PaymentAmountCurrency != 0 ? itemCP.PaymentAmountCurrency : itemCP.PaymentAmount;


                    entitiesReadOnly.InvoicePaymentMatchingRecord.NoTracking();
                    var record = (from im in entitiesReadOnly.InvoicePaymentMatchingRecord
                                  where im.Entity == itemCP.OriginType &&
                                  im.RecordId == itemCP.PaymentRowId &&
                                  im.State == (int)SoeEntityState.Active
                                  select im).FirstOrDefault();

                    if (record == null)
                    {
                        if ((itemCP.InvoiceTotalAmount < itemCP.PaymentAmount || itemCP.InvoiceSeqNr == null) && !itemCP.FullyPayed)
                        {
                            dtos.Add(new InvoiceMatchingDTO()
                            {
                                IsSelected = false,
                                IsEditable = true,
                                InvoiceId = itemCP.InvoiceId,
                                InvoiceNr = itemCP.InvoiceNr,
                                PaymentRowId = itemCP.PaymentRowId,
                                InvoiceTotalAmount = paymentPaidAmount, //Switch paid and total for grid
                                InvoicePayedAmount = paymentTotalAmount,
                                PaymentNr = itemCP.PaymentSeqNr.ToString(),
                                Type = (int)SoeOriginType.CustomerPayment,
                                InvoiceMatchAmount = itemCP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount,
                            });
                        }
                    }
                    else
                    {
                        if (record.Amount != null)
                        {
                            decimal usedAmount = paymentPaidAmount + (decimal)record.Amount;

                            if ((usedAmount < (itemCP.PaymentAmountCurrency != 0 ? itemCP.PaymentAmountCurrency : itemCP.PaymentAmount)) && !itemCP.FullyPayed)
                            {
                                dtos.Add(new InvoiceMatchingDTO()
                                {
                                    IsSelected = false,
                                    IsEditable = true,
                                    InvoiceId = itemCP.InvoiceId,
                                    InvoiceNr = itemCP.InvoiceNr,
                                    PaymentRowId = itemCP.PaymentRowId,
                                    InvoiceTotalAmount = paymentPaidAmount, //Switch paid and total for grid
                                    InvoicePayedAmount = paymentTotalAmount,
                                    PaymentNr = itemCP.PaymentSeqNr.ToString(),
                                    Type = (int)SoeOriginType.CustomerPayment,
                                    InvoiceMatchAmount = itemCP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - usedAmount,
                                });
                            }
                        }
                    }
                }

                #endregion
            }

            return dtos;
        }

        public List<InvoiceMatchingDTO> GetInvoicesPaymentsAndMatches(int actorCompanyId, int actorId, int type, decimal aFrom, decimal aTo, DateTime? dtFrom, DateTime? dtTo, SoeOriginType originType)
        {
            List<InvoiceMatchingDTO> dtos = new List<InvoiceMatchingDTO>();

            Actor actor = ActorManager.GetActor(actorId, true);

            if (originType == SoeOriginType.SupplierInvoice)
            {
                #region SupplierInvoice

                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                entities.Invoice.NoTracking();
                var itemsForActor = (from i in entities.InvoicePaymentUnionView
                                     where i.ActorCompanyId == actorCompanyId &&
                                     i.ActorId == actorId &&
                                     (i.OriginType == (int)SoeOriginType.SupplierInvoice || i.OriginType == (int)SoeOriginType.SupplierPayment)
                                     select i);

                if (aFrom != 0)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceTotalAmountCurrency >= aFrom);
                if (aTo != 0)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceTotalAmountCurrency <= aTo);
                if (dtFrom != null)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceDate >= (DateTime)dtFrom);
                if (dtTo != null)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceDate <= (DateTime)dtTo);

                if (type != 5)
                {
                    #region SupplierInvoice

                    var itemsSI = (type == 0) ? itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierInvoice).ToList() :
                                                itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierInvoice && i.BillingTypeId == type).ToList();

                    foreach (var itemSI in itemsSI)
                    {
                        decimal invoiceTotalAmount = itemSI.InvoiceTotalAmountCurrency != 0 ? itemSI.InvoiceTotalAmountCurrency : itemSI.InvoiceTotalAmount;
                        decimal invoicePaidAmount = itemSI.InvoicePaidAmountCurrency != 0 ? itemSI.InvoicePaidAmountCurrency : itemSI.InvoicePaidAmount;

                        #region Suggestion check

                        string paymentNrs = "";
                        bool isSuggestion = false;

                        var itemsSP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierPayment && i.InvoiceId == itemSI.InvoiceId && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                        foreach (var itemSP in itemsSP)
                        {
                            if (paymentNrs != string.Empty)
                                paymentNrs += ", ";

                            paymentNrs += itemSP.PaymentSeqNr;

                            if (!isSuggestion && itemSP.PaymentIsSuggestion)
                                isSuggestion = true;
                        }

                        #endregion

                        entities.InvoicePaymentMatchingRecord.NoTracking();
                        bool hasMatch = (from i in entities.InvoicePaymentMatchingRecord
                                         where i.RecordId == itemSI.InvoiceId &&
                                         i.Entity == (int)SoeEntityType.SupplierInvoice
                                         select i).Any();

                        dtos.Add(new Common.DTO.InvoiceMatchingDTO()
                        {
                            IsSelected = false,
                            IsEditable = !isSuggestion,
                            InvoiceId = itemSI.InvoiceId,
                            InvoiceNr = itemSI.InvoiceNr,
                            ActorId = actorId,
                            HasMatches = hasMatch,
                            InvoiceTotalAmount = invoiceTotalAmount,
                            InvoicePayedAmount = invoicePaidAmount,
                            PaymentNr = paymentNrs,
                            Type = (int)originType,
                            BillingType = (TermGroup_BillingType)itemSI.BillingTypeId,
                            OriginStatus = itemSI.Status,
                            ActorName = actor.Supplier != null ? actor.Supplier.SupplierNr + " " + actor.Supplier.Name : "",
                            InvoiceMatchAmount = itemSI.RemainingAmount != 0 ? decimal.Negate(itemSI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount),
                            Date = itemSI.InvoiceDate
                        });
                    }

                    #endregion
                }

                if (type == 0 || type == 5)
                {
                    #region SupplierPayment

                    var itemsSP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierPayment && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                    foreach (var itemSP in itemsSP)
                    {
                        decimal paymentTotalAmount = itemSP.InvoiceTotalAmountCurrency != 0 ? itemSP.InvoiceTotalAmountCurrency : itemSP.InvoiceTotalAmount;
                        decimal paymentPaidAmount = itemSP.PaymentAmountCurrency != 0 ? itemSP.PaymentAmountCurrency : itemSP.PaymentAmount;

                        //Temporary we´ll only get the first match
                        entities.InvoicePaymentMatchingRecord.NoTracking();
                        InvoicePaymentMatchingRecord record = (from i in entities.InvoicePaymentMatchingRecord.Include("InvoicePaymentMatching")
                                                               where i.RecordId == itemSP.InvoiceId &&
                                                               i.Entity == (int)SoeEntityType.SupplierPayment
                                                               select i).FirstOrDefault();

                        dtos.Add(new InvoiceMatchingDTO
                        {
                            IsSelected = false,
                            IsEditable = false,
                            InvoiceId = itemSP.InvoiceId,
                            InvoiceNr = itemSP.InvoiceNr,
                            PaymentRowId = itemSP.PaymentRowId,
                            ActorId = actorId,
                            VoucherHeadId = record != null && record.VoucherId != null ? (int)record.VoucherId : 0,
                            HasMatches = record != null,
                            InvoiceMatchingId = record != null ? record.InvoicePaymentMatchingId : 0,
                            InvoiceTotalAmount = paymentTotalAmount,
                            InvoicePayedAmount = paymentPaidAmount,
                            PaymentNr = itemSP.PaymentSeqNr.ToString(),
                            Type = (int)SoeOriginType.SupplierPayment,
                            BillingType = (TermGroup_BillingType)itemSP.BillingTypeId,
                            OriginStatus = itemSP.Status,
                            ActorName = actor.Supplier != null ? actor.Supplier.SupplierNr + " " + actor.Supplier.Name : "",
                            InvoiceMatchAmount = itemSP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount,
                            Date = itemSP.InvoiceDate
                        });
                    }

                    #endregion
                }

                #endregion
            }
            else if (originType == SoeOriginType.CustomerInvoice)
            {
                #region CustomerInvoice

                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                entities.Invoice.NoTracking();
                var itemsForActor = (from i in entities.InvoicePaymentUnionView
                                     where i.ActorCompanyId == actorCompanyId &&
                                     i.ActorId == actorId &&
                                     (i.OriginType == (int)SoeOriginType.CustomerInvoice || i.OriginType == (int)SoeOriginType.CustomerPayment)
                                     select i);

                if (aFrom != 0)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceTotalAmountCurrency >= aFrom);
                if (aTo != 0)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceTotalAmountCurrency <= aTo);
                if (dtFrom != null)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceDate >= (DateTime)dtFrom);
                if (dtTo != null)
                    itemsForActor = itemsForActor.Where(i => i.InvoiceDate <= (DateTime)dtTo);

                if (type != 5)
                {
                    #region CustomerInvoice

                    var itemsCI = (type == 0) ? itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerInvoice).ToList() :
                                             itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerInvoice && i.BillingTypeId == type).ToList();

                    foreach (var itemCI in itemsCI)
                    {
                        decimal invoiceTotalAmount = itemCI.InvoiceTotalAmountCurrency != 0 ? itemCI.InvoiceTotalAmountCurrency : itemCI.InvoiceTotalAmount;
                        decimal invoicePaidAmount = itemCI.InvoicePaidAmountCurrency != 0 ? itemCI.InvoicePaidAmountCurrency : itemCI.InvoicePaidAmount;

                        //Temporary we´ll only get the first match
                        entities.InvoicePaymentMatchingRecord.NoTracking();
                        InvoicePaymentMatchingRecord record = (from i in entities.InvoicePaymentMatchingRecord
                                                                .Include("InvoicePaymentMatching")
                                                               where i.RecordId == itemCI.InvoiceId &&
                                                               i.Entity == (int)SoeEntityType.CustomerInvoice
                                                               select i).FirstOrDefault();

                        dtos.Add(new InvoiceMatchingDTO
                        {
                            IsSelected = false,
                            IsEditable = true,
                            InvoiceId = itemCI.InvoiceId,
                            InvoiceNr = itemCI.InvoiceNr,
                            ActorId = actorId,
                            VoucherHeadId = record != null && record.VoucherId != null ? (int)record.VoucherId : 0,
                            HasMatches = record != null,
                            InvoiceMatchingId = record != null ? record.InvoicePaymentMatchingId : 0,
                            InvoiceTotalAmount = invoiceTotalAmount,
                            InvoicePayedAmount = invoicePaidAmount,
                            PaymentNr = itemCI.PaymentNr,
                            Type = (int)SoeEntityType.CustomerInvoice,
                            BillingType = (TermGroup_BillingType)itemCI.BillingTypeId,
                            OriginStatus = itemCI.Status,
                            registrationType = (OrderInvoiceRegistrationType)itemCI.RegistrationType,
                            ActorName = actor.Customer != null ? actor.Customer.CustomerNr + " " + actor.Customer.Name : "",
                            InvoiceMatchAmount = itemCI.RemainingAmount != 0 ? decimal.Negate(itemCI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount),
                            Date = itemCI.InvoiceDate
                        });
                    }

                    #endregion
                }

                if (type == 0 || type == 5)
                {
                    #region SupplierPayment

                    var itemsSP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerPayment && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                    foreach (var itemSP in itemsSP)
                    {
                        decimal paymentTotalAmount = itemSP.InvoiceTotalAmountCurrency != 0 ? itemSP.InvoiceTotalAmountCurrency : itemSP.InvoiceTotalAmount;
                        decimal paymentPaidAmount = itemSP.PaymentAmountCurrency != 0 ? itemSP.PaymentAmountCurrency : itemSP.PaymentAmount;

                        //Temporary we´ll only get the first match
                        entities.InvoicePaymentMatchingRecord.NoTracking();
                        InvoicePaymentMatchingRecord record = (from i in entities.InvoicePaymentMatchingRecord
                                                                   .Include("InvoicePaymentMatching")
                                                               where i.RecordId == itemSP.InvoiceId &&
                                                               i.Entity == (int)SoeEntityType.CustomerPayment
                                                               select i).FirstOrDefault();

                        dtos.Add(new InvoiceMatchingDTO()
                        {
                            IsSelected = false,
                            IsEditable = false,
                            InvoiceId = itemSP.InvoiceId,
                            InvoiceNr = itemSP.InvoiceNr,
                            PaymentRowId = itemSP.PaymentRowId,
                            ActorId = actorId,
                            VoucherHeadId = record != null && record.VoucherId.HasValue ? record.VoucherId.Value : 0,
                            HasMatches = record != null,
                            InvoiceMatchingId = record != null ? record.InvoicePaymentMatchingId : 0,
                            InvoiceTotalAmount = paymentTotalAmount,
                            InvoicePayedAmount = paymentPaidAmount,
                            PaymentNr = itemSP.PaymentSeqNr.ToString(),
                            Type = (int)SoeOriginType.CustomerPayment,
                            BillingType = (TermGroup_BillingType)itemSP.BillingTypeId,
                            OriginStatus = itemSP.Status,
                            ActorName = actor.Customer != null ? actor.Customer.CustomerNr + " " + actor.Customer.Name : "",
                            InvoiceMatchAmount = itemSP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount,
                            Date = itemSP.PayDate
                        });
                    }

                    #endregion
                }

                #endregion
            }

            dtos = dtos
            .Select(
                (d) => new
                {
                    Dto = d,
                    MaxPaymentNumber = GetMaxNumber(d.PaymentNr)
                }
            )
            .OrderByDescending(d => d.Dto.Date)
            .ThenByDescending(d => d.MaxPaymentNumber)
            .Select(d => d.Dto)
            .ToList();

            return dtos;
        }

        public List<InvoiceMatchingDTO> GetMatches(int actorCompanyId, int actorId, int recordId, int entityType)
        {
            List<InvoiceMatchingDTO> dtos = new List<InvoiceMatchingDTO>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.InvoicePaymentMatchingRecord.NoTracking();
            var records = (from i in entitiesReadOnly.InvoicePaymentMatchingRecord
                            .Include("InvoicePaymentMatching")
                           where i.RecordId == recordId &&
                           i.Entity == entityType
                           select i).ToList();

            foreach (var record in records)
            {
                var m = (from i in entitiesReadOnly.InvoicePaymentMatchingRecord
                         where i.InvoicePaymentMatchingId == record.InvoicePaymentMatchingId
                         select i).ToList();

                dtos.Add(new InvoiceMatchingDTO()
                {
                    ActorId = actorId,
                    InvoiceMatchingId = record.InvoicePaymentMatchingId,
                    VoucherHeadId = record.VoucherId != null ? (int)record.VoucherId : 0,
                    CreatedDate = (DateTime)record.Created,
                    InvoiceMatchAmount = (decimal)record.Amount,
                    Count = m.Count,
                });
            }

            return dtos;
        }

        public List<InvoicePaymentMatchingRecord> GetMatchingRecords(int actorCompanyId, SoeOriginType originType)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.InvoicePaymentMatchingRecord.NoTracking();
            return (from r in entities.InvoicePaymentMatchingRecord
                    where r.InvoicePaymentMatching.ActorCompanyId == actorCompanyId &&
                    r.Entity == (int)originType &&
                    r.State == (int)SoeEntityState.Active
                    select r).ToList();
        }

        public List<MatchingCustomerSupplierDTO> GetSuppliersCustomersFromUnpaidInvoices(SoeOriginType originType, int actorCompanyId)
        {
            //FullyPayed == true --> paid and closed
            //FullyPayed == false && PaidAmount == TotalAmount --> paid but open in overdued (only CustomerInvoice)

            List<MatchingCustomerSupplierDTO> matchingDTOs = new List<MatchingCustomerSupplierDTO>();

            switch (originType)
            {
                case SoeOriginType.SupplierInvoice:
                    #region SupplierInvoice

                    var supplierInvoiceItems = GetChangeStatusGridViewsByTypes(actorCompanyId, SoeOriginType.SupplierInvoice, SoeOriginType.SupplierPayment);
                    List<InvoicePaymentMatchingRecord> supplierPaymentRecords = GetMatchingRecords(actorCompanyId, SoeOriginType.SupplierPayment);
                    List<Supplier> suppliers = SupplierManager.GetSuppliersByCompany(actorCompanyId, true);
                    foreach (Supplier supplier in suppliers)
                    {
                        if (supplier.BlockPayment)
                            continue;

                        KeyValuePair<int, decimal> pair = GetInvoicePaymentMatchCountAndSum(supplierInvoiceItems, supplierPaymentRecords, originType, supplier.ActorSupplierId);
                        if (pair.Key != 0)
                            matchingDTOs.Add(new MatchingCustomerSupplierDTO(supplier.ActorSupplierId, supplier.SupplierNr, supplier.Name, pair.Key, pair.Value));
                    }

                    #endregion
                    break;
                case SoeOriginType.CustomerInvoice:
                    #region CustomerInvoice

                    var customerInvoiceItems = GetChangeStatusGridViewsByTypes(actorCompanyId, SoeOriginType.CustomerInvoice, SoeOriginType.CustomerPayment);
                    List<InvoicePaymentMatchingRecord> customerPaymentRecords = GetMatchingRecords(actorCompanyId, SoeOriginType.CustomerPayment);
                    List<Customer> customers = CustomerManager.GetCustomersByCompany(actorCompanyId, onlyActive: true);
                    foreach (Customer customer in customers)
                    {
                        KeyValuePair<int, decimal> pair = GetInvoicePaymentMatchCountAndSum(customerInvoiceItems, customerPaymentRecords, originType, customer.ActorCustomerId);
                        if (pair.Key != 0)
                            matchingDTOs.Add(new MatchingCustomerSupplierDTO(customer.ActorCustomerId, customer.CustomerNr, customer.Name, pair.Key, pair.Value));
                    }

                    #endregion
                    break;
            }

            return matchingDTOs;
        }

        public List<InvoicePaymentMatchingView> GetInvoicePaymentMatches(CompEntities entities, int actorCompanyId, DateTime? dateFrom = null, DateTime? dateTo = null)
        {
            //matching records are filtered by date later
            return (from ip in entities.InvoicePaymentMatchingView
                    where ip.ActorCompanyId == actorCompanyId
                    select ip).ToList();
        }

        private KeyValuePair<int, decimal> GetInvoicePaymentMatchCountAndSum(List<InvoicePaymentUnionView> items, List<InvoicePaymentMatchingRecord> paymentRecords, SoeOriginType originType, int actorId)
        {
            int count = 0;
            decimal sum = 0;
            var itemsForActor = items.Where(i => i.ActorId == actorId).ToList();

            if (originType == SoeOriginType.SupplierInvoice)
            {
                #region SupplierInvoice

                var itemsSI = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierInvoice && (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher)).ToList();
                foreach (var itemSI in itemsSI)
                {
                    if (itemSI.Status == (int)SoeOriginStatus.Origin || itemSI.Status == (int)SoeOriginStatus.Voucher)
                    {
                        if (!itemSI.BlockPayment)
                        {
                            decimal invoiceTotalAmount = itemSI.InvoiceTotalAmountCurrency != 0 ? itemSI.InvoiceTotalAmountCurrency : itemSI.InvoiceTotalAmount;
                            decimal invoicePaidAmount = itemSI.InvoicePaidAmountCurrency != 0 ? itemSI.InvoicePaidAmountCurrency : itemSI.InvoicePaidAmount;

                            #region Suggestion check

                            string paymentNrs = "";
                            bool isSuggestion = false;

                            var itemsSPforSI = (from i in itemsForActor
                                                where i.InvoiceId == itemSI.InvoiceId &&
                                                i.OriginType == (int)SoeOriginType.SupplierPayment &&
                                                (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)
                                                select i).ToList();

                            foreach (var itemSP in itemsSPforSI)
                            {
                                if (paymentNrs != String.Empty)
                                    paymentNrs += ", ";

                                paymentNrs += itemSP.PaymentSeqNr;

                                if (!isSuggestion && itemSP.PaymentIsSuggestion)
                                    isSuggestion = true;
                            }

                            #endregion

                            if (itemSI.FullyPayed || itemSI.InvoiceTotalAmountCurrency == itemSI.InvoicePaidAmountCurrency)
                            {
                                if (isSuggestion)
                                {
                                    count++;
                                    sum += itemSI.RemainingAmount != 0 ? Decimal.Negate(itemSI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount);
                                }
                            }
                            else
                            {
                                count++;
                                sum += itemSI.RemainingAmount != 0 ? Decimal.Negate(itemSI.RemainingAmount) : decimal.Negate(invoiceTotalAmount - invoicePaidAmount);
                            }
                        }
                    }
                }

                #endregion

                #region SupplierPayment

                var itemsSP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.SupplierPayment && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                foreach (var itemSP in itemsSP)
                {
                    decimal paymentTotalAmount = itemSP.InvoiceTotalAmountCurrency != 0 ? itemSP.InvoiceTotalAmountCurrency : itemSP.InvoiceTotalAmount;
                    decimal paymentPaidAmount = itemSP.PaymentAmountCurrency != 0 ? itemSP.PaymentAmountCurrency : itemSP.PaymentAmount;

                    var paymentRecord = paymentRecords.FirstOrDefault(i => i.RecordId == itemSP.PaymentRowId);
                    if (paymentRecord == null)
                    {
                        if (itemSP.PaymentAmountDiff != 0 || itemSP.InvoiceSeqNr == null)
                        {
                            count++;
                            sum += itemSP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount;
                        }
                    }
                    else
                    {
                        if (paymentRecord.Amount != null)
                        {
                            decimal usedAmount = paymentPaidAmount + (decimal)paymentRecord.Amount;
                            if (usedAmount < (itemSP.PaymentAmountCurrency != 0 ? itemSP.PaymentAmountCurrency : itemSP.PaymentAmount))
                            {
                                count++;
                                sum += itemSP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - usedAmount;
                            }
                        }
                    }
                }

                #endregion
            }
            else if (originType == SoeOriginType.CustomerInvoice)
            {
                #region CustomerInvoice

                var itemsCI = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerInvoice && (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher)).ToList();
                foreach (var itemCI in itemsCI)
                {
                    decimal invoiceTotalAmount = itemCI.InvoiceTotalAmountCurrency != 0 ? itemCI.InvoiceTotalAmountCurrency : itemCI.InvoiceTotalAmount;
                    decimal invoicePaidAmount = itemCI.InvoicePaidAmountCurrency != 0 ? itemCI.InvoicePaidAmountCurrency : itemCI.InvoicePaidAmount;

                    if (!itemCI.FullyPayed)
                    {
                        count++;
                        sum += itemCI.RemainingAmount != 0 ? Decimal.Negate(itemCI.RemainingAmount) : Decimal.Negate(invoiceTotalAmount - invoicePaidAmount);
                    }
                }

                #endregion

                #region CustomerPayment

                var itemsCP = itemsForActor.Where(i => i.OriginType == (int)SoeOriginType.CustomerPayment && (i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Pending)).ToList();
                foreach (var itemCP in itemsCP)
                {
                    decimal paymentTotalAmount = itemCP.InvoiceTotalAmountCurrency != 0 ? itemCP.InvoiceTotalAmountCurrency : itemCP.InvoiceTotalAmount;
                    decimal paymentPaidAmount = itemCP.PaymentAmountCurrency != 0 ? itemCP.PaymentAmountCurrency : itemCP.PaymentAmount;

                    var paymentRecord = paymentRecords.FirstOrDefault(i => i.RecordId == itemCP.PaymentRowId);
                    if (paymentRecord == null)
                    {
                        if (itemCP.InvoiceTotalAmount < itemCP.PaymentAmount || itemCP.InvoiceSeqNr == null)
                        {
                            count++;
                            sum += itemCP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - paymentPaidAmount;
                        }
                    }
                    else
                    {
                        if (paymentRecord.Amount != null)
                        {
                            decimal usedAmount = paymentPaidAmount + (decimal)paymentRecord.Amount;

                            if (usedAmount < (itemCP.PaymentAmountCurrency != 0 ? itemCP.PaymentAmountCurrency : itemCP.PaymentAmount))
                            {
                                count++;
                                sum += itemCP.InvoiceId != 0 ? paymentPaidAmount : paymentTotalAmount - usedAmount;
                            }
                        }
                    }
                }

                #endregion
            }

            return new KeyValuePair<int, decimal>(count, sum);
        }

        public ActionResult AddInvoicePaymentMatchAndVoucher(VoucherHeadDTO voucherInput, List<AccountingRowDTO> accountingRowDTOsInput, List<InvoiceMatchingDTO> items, int actorCompanyId, int matchCodeId = 0)
        {
            ActionResult result = new ActionResult();
            long seqNr = 0;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        result = VoucherManager.SaveVoucher(entities, transaction, voucherInput, accountingRowDTOsInput, new List<int>(), null, actorCompanyId, false);
                        if (result.Success)
                        {
                            seqNr = (long)result.Value;
                            result = AddInvoicePaymentMatch(entities, transaction, items, actorCompanyId, matchCodeId, result.IntegerValue);
                        }

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.Value = seqNr;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult AddInvoicePaymentMatch(CompEntities entities, TransactionScope transaction, List<InvoiceMatchingDTO> dtos, int actorCompanyId, int matchCodeId = 0, int voucherId = 0)
        {
            InvoicePaymentMatching matching = new InvoicePaymentMatching()
            {
                //Set FK
                ActorCompanyId = actorCompanyId,
            };

            ActionResult result = AddEntityItem(entities, matching, "InvoicePaymentMatching", transaction);
            if (result.Success)
            {
                //get credit invoice's invoiceid when only one credit invoice is selected
                int creditInvoiceId = 0;
                if (dtos.Where(i => i.BillingType == TermGroup_BillingType.Credit).Select(i => i.InvoiceId).Count() == 1)
                {
                    creditInvoiceId = dtos.Where(i => i.BillingType == TermGroup_BillingType.Credit).Select(i => i.InvoiceId).FirstOrDefault();
                }

                var accountYearId = AccountManager.GetAccountYearId(entities, DateTime.Today, actorCompanyId);
                var voucherSeries = VoucherManager.GetDefaultVoucherSeries(entities, accountYearId, CompanySettingType.SupplierInvoiceVoucherSeriesType, actorCompanyId);
                if (voucherSeries == null)
                    return new ActionResult(null, GetText(8403, "Verifikatserie saknas"));

                var paymentMethodId = 0;

                if (dtos.Exists(x => x.Type == (int)SoeOriginType.SupplierInvoice))
                {
                    paymentMethodId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.SupplierPaymentSettlePaymentMethod, base.UserId, base.ActorCompanyId, 0);
                    if (paymentMethodId == 0)
                        return new ActionResult(false, 0, GetText(9300, "Inställning för betalningsmetod vid utjämning är inte satt"));
                }

                foreach (InvoiceMatchingDTO dto in dtos)
                {
                    if (dto.Type == (int)SoeOriginType.CustomerInvoice || dto.Type == (int)SoeOriginType.SupplierInvoice)
                    {
                        #region Invoice

                        Invoice invoice = GetInvoice(entities, dto.InvoiceId);
                        if (invoice == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "SupplierInvoice");

                        //create payments for supplier invoices....
                        if (dto.Type == (int)SoeOriginType.SupplierInvoice)
                        {
                            var paymentSave = new PaymentRowSaveDTO
                            {
                                InvoiceId = invoice.InvoiceId,
                                ActorId = (int)invoice.ActorId,
                                OnlyPayment = true,
                                PaymentDate = DateTime.Today,
                                PaymentStatus = SoePaymentStatus.Pending,
                                CurrencyId = invoice.CurrencyId,
                                PaymentMethodId = paymentMethodId,
                                OriginType = SoeOriginType.SupplierPayment,
                                OriginStatus = SoeOriginStatus.Matched,
                                CurrencyDate = invoice.CurrencyDate,
                                CurrencyRate = invoice.CurrencyRate,
                                AccountYearId = accountYearId,
                                InvoiceType = SoeInvoiceType.SupplierInvoice,
                                VoucherSeriesId = voucherSeries.VoucherSeriesId,
                                VoucherSeriesTypeId = voucherSeries.VoucherSeriesTypeId
                            };

                            paymentSave.Amount = paymentSave.TotalAmount = decimal.Negate(dto.InvoiceMatchAmount);
                            paymentSave.AmountCurrency = paymentSave.TotalAmountCurrency = decimal.Negate(dto.InvoiceMatchAmount);
                            paymentSave.FullyPayed = (invoice.TotalAmount == paymentSave.Amount);

                            result = PaymentManager.SavePaymentRow(entities, transaction, paymentSave, null, actorCompanyId, true, false, true, true, true);
                            if (!result.Success)
                                return result;
                        }
                        else
                        {
                            //FullyPayed
                            if (decimal.Negate(dto.InvoiceMatchAmount) < (invoice.TotalAmount - invoice.PaidAmount)) //Ordna me currency sen
                                ResetInvoicePaidAmount(invoice, decimal.Negate(dto.InvoiceMatchAmount));
                            else
                                SetInvoiceFullyPayed(entities, invoice);
                        }

                        var record = new InvoicePaymentMatchingRecord()
                        {
                            Entity = dto.Type == (int)SoeOriginType.CustomerInvoice ? (int)SoeEntityType.CustomerInvoice : (int)SoeEntityType.SupplierInvoice,
                            RecordId = dto.InvoiceId,
                            Amount = dto.InvoiceMatchAmount,

                            //Set FK
                            InvoicePaymentMatchingId = matching.InvoicePaymentMatchingId,
                            MatchCodeId = matchCodeId.ToNullable(),
                            VoucherId = voucherId.ToNullable(),
                        };

                        result = AddEntityItem(entities, record, "InvoicePaymentMatchingRecord", transaction);
                        if (!result.Success)
                            return result;

                        //Add origininvoicemapping for getting tracing item to invoice
                        if (creditInvoiceId != 0 && invoice.InvoiceId != creditInvoiceId)
                        {
                            OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                            {
                                Origin = invoice.Origin,
                                Type = (int)GetOriginInvoiceMappingType(invoice),
                                InvoiceId = creditInvoiceId
                            };
                            entities.OriginInvoiceMapping.AddObject(oimap);
                        }

                        #endregion
                    }
                    else
                    {
                        #region Payment

                        var record = new InvoicePaymentMatchingRecord()
                        {
                            Entity = dto.Type == (int)SoeOriginType.CustomerPayment ? (int)SoeEntityType.CustomerPayment : (int)SoeEntityType.SupplierPayment,
                            RecordId = dto.PaymentRowId,
                            Amount = dto.InvoiceMatchAmount,

                            //Set FK
                            InvoicePaymentMatchingId = matching.InvoicePaymentMatchingId,
                            MatchCodeId = matchCodeId.ToNullable(),
                            VoucherId = voucherId.ToNullable(),
                        };

                        result = AddEntityItem(entities, record, "InvoicePaymentMatchingRecord", transaction);
                        if (!result.Success)
                            return result;

                        #endregion
                    }
                }
            }

            return result;
        }

        #endregion

        #region Age distribution

        public IEnumerable<AgeDistributionDTO> GetAgeDistribution(int actorCompanyId, SoeInvoiceType invoiceType, DateTime compareDate, bool? insecureDebts, int currencyType, string actorNrFrom, string actorNrTo, int? seqNrFrom, int? seqNrTo, string invNrFrom, string invNrTo, DateTime? invDateFrom, DateTime? invDateTo, DateTime? expDateFrom, DateTime? expDateTo)
        {
            // Get interval company settings
            // Number of intervals can be between 3 and 6
            // We check this interval setting before fetching all the intervals
            int nbrOfIntervals = SettingManager.GetIntSetting(SettingMainType.Company, (int)(invoiceType == SoeInvoiceType.CustomerInvoice ? CompanySettingType.CustomerInvoiceAgeDistributionNbrOfIntervals : CompanySettingType.SupplierInvoiceAgeDistributionNbrOfIntervals), 0, actorCompanyId, 0);
            int interval1 = SettingManager.GetIntSetting(SettingMainType.Company, (int)(invoiceType == SoeInvoiceType.CustomerInvoice ? CompanySettingType.CustomerInvoiceAgeDistributionInterval1 : CompanySettingType.SupplierInvoiceAgeDistributionInterval1), 0, actorCompanyId, 0);
            int interval2 = SettingManager.GetIntSetting(SettingMainType.Company, (int)(invoiceType == SoeInvoiceType.CustomerInvoice ? CompanySettingType.CustomerInvoiceAgeDistributionInterval2 : CompanySettingType.SupplierInvoiceAgeDistributionInterval2), 0, actorCompanyId, 0);
            int interval3 = 0;
            if (nbrOfIntervals > 3)
                interval3 = SettingManager.GetIntSetting(SettingMainType.Company, (int)(invoiceType == SoeInvoiceType.CustomerInvoice ? CompanySettingType.CustomerInvoiceAgeDistributionInterval3 : CompanySettingType.SupplierInvoiceAgeDistributionInterval3), 0, actorCompanyId, 0);
            int interval4 = 0;
            if (nbrOfIntervals > 4)
                interval4 = SettingManager.GetIntSetting(SettingMainType.Company, (int)(invoiceType == SoeInvoiceType.CustomerInvoice ? CompanySettingType.CustomerInvoiceAgeDistributionInterval4 : CompanySettingType.SupplierInvoiceAgeDistributionInterval4), 0, actorCompanyId, 0);
            int interval5 = 0;
            if (nbrOfIntervals > 5)
                interval5 = SettingManager.GetIntSetting(SettingMainType.Company, (int)(invoiceType == SoeInvoiceType.CustomerInvoice ? CompanySettingType.CustomerInvoiceAgeDistributionInterval5 : CompanySettingType.SupplierInvoiceAgeDistributionInterval5), 0, actorCompanyId, 0);

            List<AgeDistributionDTO> dtos = new List<AgeDistributionDTO>();
            int highestInterval = interval2;
            int highestIntervalColumn = 3;

            DateTime? startDate = null;
            DateTime? stopDate = null;
            List<Invoice> invoices;

            // First column (less than first interval)
            startDate = compareDate.AddDays(-interval1);
            stopDate = null;
            invoices = GetAgeDistributionInvoices(actorCompanyId, invoiceType, startDate, stopDate, actorNrFrom, actorNrTo, seqNrFrom, seqNrTo, invNrFrom, invNrTo, invDateFrom, invDateTo, expDateFrom, expDateTo, insecureDebts);
            CreateAgeDistributionDTO(invoiceType, invoices, 1, ref dtos, (TermGroup_CurrencyType)currencyType);

            // Second column (between first and second interval)
            startDate = compareDate.AddDays(-interval2);
            stopDate = compareDate.AddDays(-interval1);
            invoices = GetAgeDistributionInvoices(actorCompanyId, invoiceType, startDate, stopDate, actorNrFrom, actorNrTo, seqNrFrom, seqNrTo, invNrFrom, invNrTo, invDateFrom, invDateTo, expDateFrom, expDateTo, insecureDebts);
            CreateAgeDistributionDTO(invoiceType, invoices, 2, ref dtos, (TermGroup_CurrencyType)currencyType);

            if (nbrOfIntervals > 3)
            {
                // Third column (between second and third interval)
                startDate = compareDate.AddDays(-interval3);
                stopDate = compareDate.AddDays(-interval2);
                invoices = GetAgeDistributionInvoices(actorCompanyId, invoiceType, startDate, stopDate, actorNrFrom, actorNrTo, seqNrFrom, seqNrTo, invNrFrom, invNrTo, invDateFrom, invDateTo, expDateFrom, expDateTo, insecureDebts);
                CreateAgeDistributionDTO(invoiceType, invoices, 3, ref dtos, (TermGroup_CurrencyType)currencyType);
                highestInterval = interval3;
                highestIntervalColumn = 4;

                if (nbrOfIntervals > 4)
                {
                    // Fourth column (between third and fourth interval)
                    startDate = compareDate.AddDays(-interval4);
                    stopDate = compareDate.AddDays(-interval3);
                    invoices = GetAgeDistributionInvoices(actorCompanyId, invoiceType, startDate, stopDate, actorNrFrom, actorNrTo, seqNrFrom, seqNrTo, invNrFrom, invNrTo, invDateFrom, invDateTo, expDateFrom, expDateTo, insecureDebts);
                    CreateAgeDistributionDTO(invoiceType, invoices, 4, ref dtos, (TermGroup_CurrencyType)currencyType);
                    highestInterval = interval4;
                    highestIntervalColumn = 5;

                    if (nbrOfIntervals > 5)
                    {
                        // Fifth column (between fourth and fifth interval)
                        startDate = compareDate.AddDays(-interval5);
                        stopDate = compareDate.AddDays(-interval4);
                        invoices = GetAgeDistributionInvoices(actorCompanyId, invoiceType, startDate, stopDate, actorNrFrom, actorNrTo, seqNrFrom, seqNrTo, invNrFrom, invNrTo, invDateFrom, invDateTo, expDateFrom, expDateTo, insecureDebts);
                        CreateAgeDistributionDTO(invoiceType, invoices, 5, ref dtos, (TermGroup_CurrencyType)currencyType);
                        highestInterval = interval5;
                        highestIntervalColumn = 6;
                    }
                }
            }

            // Last column (greater than last interval)
            startDate = null;
            stopDate = compareDate.AddDays(-highestInterval);
            invoices = GetAgeDistributionInvoices(actorCompanyId, invoiceType, startDate, stopDate, actorNrFrom, actorNrTo, seqNrFrom, seqNrTo, invNrFrom, invNrTo, invDateFrom, invDateTo, expDateFrom, expDateTo, insecureDebts);
            CreateAgeDistributionDTO(invoiceType, invoices, highestIntervalColumn, ref dtos, (TermGroup_CurrencyType)currencyType);

            return dtos.OrderBy(d => d.ActorName).ThenBy(d => d.ExpiryDate);
        }

        private List<Invoice> GetAgeDistributionInvoices(int actorCompanyId, SoeInvoiceType invoiceType, DateTime? startDate, DateTime? stopDate, string actorNrFrom, string actorNrTo, int? seqNrFrom, int? seqNrTo, string invNrFrom, string invNrTo, DateTime? invDateFrom, DateTime? invDateTo, DateTime? expDateFrom, DateTime? expDateTo, bool? insecureDebts)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            var query = (from i in entities.Invoice.Include("Actor.Customer").Include("Actor.Supplier")
                         where i.Origin.ActorCompanyId == actorCompanyId &&
                         (i.Origin.Type == (int)SoeOriginType.CustomerInvoice || i.Origin.Type == (int)SoeOriginType.SupplierInvoice) &&
                         i.Origin.Status != (int)SoeOriginStatus.Cancel &&
                         i.Type == (int)invoiceType &&
                         i.Actor != null &&
                         i.SeqNr != null &&
                         i.TotalAmountCurrency != 0 &&
                         i.InvoiceDate != null &&
                         i.DueDate != null &&
                         i.FullyPayed == false &&
                         i.State == (int)SoeEntityState.Active
                         select i);

            #region Intervals

            if (startDate.HasValue)
                query = query.Where(i => i.DueDate >= startDate);

            if (stopDate.HasValue)
                query = query.Where(i => i.DueDate < stopDate);

            #endregion

            #region Search conditions

            #region Sequence number

            if (seqNrFrom.HasValue)
                query = query.Where(i => i.SeqNr >= seqNrFrom.Value);

            if (seqNrTo.HasValue)
                query = query.Where(i => i.SeqNr <= seqNrTo.Value);

            #endregion

            #region Invoice date

            if (invDateFrom.HasValue)
                query = query.Where(i => i.InvoiceDate >= invDateFrom.Value);

            if (invDateTo.HasValue)
                query = query.Where(i => i.InvoiceDate <= invDateTo.Value);

            #endregion

            #region Expiry date

            if (expDateFrom.HasValue)
                query = query.Where(i => i.DueDate >= expDateFrom.Value);

            if (expDateTo.HasValue)
                query = query.Where(i => i.DueDate <= expDateTo.Value);

            #endregion

            #region Insecure debts

            if (insecureDebts.HasValue)
                query = query.Where(i => (i as CustomerInvoice).InsecureDebt == insecureDebts.Value);

            #endregion

            #endregion

            List<Invoice> invoices = query.ToList();

            #region Search conditions after query execution

            #region Actor number

            if (!String.IsNullOrEmpty(actorNrFrom))
            {
                if (invoiceType == SoeInvoiceType.CustomerInvoice)
                    invoices = invoices.Where(i => i.Actor.Customer.CustomerNrSort.CompareTo(actorNrFrom.PadLeft(20, '0')) >= 0).ToList();
                else
                    invoices = invoices.Where(i => i.Actor.Supplier.SupplierNrSort.CompareTo(actorNrFrom.PadLeft(20, '0')) >= 0).ToList();
            }

            if (!String.IsNullOrEmpty(actorNrTo))
            {
                if (invoiceType == SoeInvoiceType.CustomerInvoice)
                    invoices = invoices.Where(i => i.Actor.Customer.CustomerNrSort.CompareTo(actorNrTo.PadLeft(20, '0')) <= 0).ToList();
                else
                    invoices = invoices.Where(i => i.Actor.Supplier.SupplierNrSort.CompareTo(actorNrTo.PadLeft(20, '0')) <= 0).ToList();
            }

            #endregion

            #region Invoice number

            if (!String.IsNullOrEmpty(invNrFrom))
            {
                invNrFrom += "-0000";
                invoices = invoices.Where(i => i.InvoiceNrSort.CompareTo(invNrFrom.PadLeft(15, '0')) >= 0).ToList();
            }

            if (!String.IsNullOrEmpty(invNrTo))
            {
                invNrTo += "-0000";
                invoices = invoices.Where(i => i.InvoiceNrSort.CompareTo(invNrTo.PadLeft(15, '0')) <= 0).ToList();
            }

            #endregion

            #endregion

            return invoices;
        }

        private void CreateAgeDistributionDTO(SoeInvoiceType invoiceType, List<Invoice> invoices, int column, ref List<AgeDistributionDTO> dtos, TermGroup_CurrencyType currencyType)
        {
            foreach (Invoice invoice in invoices)
            {
                var dto = new AgeDistributionDTO
                {
                    InvoiceId = invoice.InvoiceId,
                    ActorId = invoice.ActorId.Value,
                    ActorNr = invoiceType == SoeInvoiceType.CustomerInvoice ? invoice.Actor.Customer.CustomerNr : invoice.Actor.Supplier.SupplierNr,
                    ActorNrSort = invoiceType == SoeInvoiceType.CustomerInvoice ? invoice.Actor.Customer.CustomerNrSort : invoice.Actor.Supplier.SupplierNrSort,
                    ActorName = invoiceType == SoeInvoiceType.CustomerInvoice ? invoice.Actor.Customer.Name : invoice.Actor.Supplier.Name,
                    SeqNr = invoice.SeqNr.Value,
                    InvoiceNr = invoice.InvoiceNr,
                    InvoiceDate = invoice.InvoiceDate.Value,
                    ExpiryDate = invoice.DueDate.Value,
                    RegistrationType = invoiceType == SoeInvoiceType.CustomerInvoice ? (invoice as CustomerInvoice).RegistrationType : 0
                };

                decimal amount = 0;
                switch (currencyType)
                {
                    case TermGroup_CurrencyType.BaseCurrency:
                        amount = invoice.TotalAmount - invoice.PaidAmount;
                        break;
                    case TermGroup_CurrencyType.TransactionCurrency:
                        amount = invoice.TotalAmountCurrency - invoice.PaidAmountCurrency;
                        break;
                    case TermGroup_CurrencyType.EnterpriseCurrency:
                        amount = invoice.TotalAmountEntCurrency - invoice.PaidAmountEntCurrency;
                        break;
                    case TermGroup_CurrencyType.LedgerCurrency:
                        amount = invoice.TotalAmountLedgerCurrency - invoice.PaidAmountLedgerCurrency;
                        break;
                }

                dto.Amount1 = column == 1 ? amount : 0;
                dto.Amount2 = column == 2 ? amount : 0;
                dto.Amount3 = column == 3 ? amount : 0;
                dto.Amount4 = column == 4 ? amount : 0;
                dto.Amount5 = column == 5 ? amount : 0;
                dto.Amount6 = column == 6 ? amount : 0;
                dto.SumAmount = amount;

                dtos.Add(dto);
            }
        }

        #endregion

        #region CustomerInvoice

        #region AttestStates (Transfer)

        private InvoiceAttestStates InvoiceAttestStatesIds;

        public void InitializeAttestStateIds(CompEntities entities, int actorCompanyId)
        {
            if (InvoiceAttestStatesIds == null)
            {
                InvoiceAttestStatesIds = new InvoiceAttestStates(entities, SoeOriginType.None, SettingManager, AttestManager, actorCompanyId, base.UserId, false);
            }
        }

        private bool GetTransferState(CustomerInvoice invoice, CustomerInvoiceRow customerInvoiceRow, ref int noOfTransferredRows, ref int noOfClosedRows, ref int noOfNotTransferredRows, ref SoeOriginType transferredTo)
        {
            bool isRowTransferred = false;

            // Only relevant for offer and order
            if (invoice.Origin.Type == (int)SoeOriginType.Offer || invoice.Origin.Type == (int)SoeOriginType.Order)
            {
                bool isRowClosed = false;
                InvoiceAttestStatesIds.DetermineTransferredState(invoice, customerInvoiceRow, ref isRowTransferred, ref isRowClosed, ref transferredTo);
                if (IsRowTypeTransferrable(customerInvoiceRow))
                    UpdateTransferRowCount(isRowTransferred, isRowClosed, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows);
            }

            return isRowTransferred;
        }

        private bool GetTransferStateOfOrderRow(int? attestStateId, int rowType, ref int noOfTransferredRows, ref int noOfClosedRows, ref int noOfNotTransferredRows, ref SoeOriginType transferredTo)
        {
            bool isRowTransferred = false;
            bool isRowClosed = false;

            if (attestStateId.HasValue)
            {
                if (attestStateId.Value == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                {
                    isRowTransferred = true;
                    if (transferredTo == SoeOriginType.None)
                        transferredTo = SoeOriginType.CustomerInvoice;
                }
                else if (InvoiceAttestStatesIds.OrderClosedIds.Contains(attestStateId.Value))
                {
                    isRowClosed = true;
                }
            }

            if (rowType == (int)SoeInvoiceRowType.ProductRow || rowType == (int)SoeInvoiceRowType.TextRow || rowType == (int)SoeInvoiceRowType.PageBreakRow || rowType == (int)SoeInvoiceRowType.SubTotalRow)
                UpdateTransferRowCount(isRowTransferred, isRowClosed, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows);

            return isRowTransferred;
        }

        private bool GetTransferStateOfOfferRow(int? attestStateId, int rowType, ref int noOfTransferredRows, ref int noOfClosedRows, ref int noOfNotTransferredRows, ref SoeOriginType transferredTo)
        {
            bool isRowTransferred = false;
            bool isRowClosed = false;

            if (attestStateId.HasValue)
            {
                if (attestStateId.Value == InvoiceAttestStatesIds.TransferredOfferToInvoiceId)
                {
                    isRowTransferred = true;
                    if (transferredTo == SoeOriginType.None)
                        transferredTo = SoeOriginType.CustomerInvoice;
                }
                else if (InvoiceAttestStatesIds.OfferClosedIds.Contains(attestStateId.Value))
                {
                    isRowClosed = true;
                }
            }

            if (rowType == (int)SoeInvoiceRowType.ProductRow || rowType == (int)SoeInvoiceRowType.TextRow || rowType == (int)SoeInvoiceRowType.PageBreakRow || rowType == (int)SoeInvoiceRowType.SubTotalRow)
                UpdateTransferRowCount(isRowTransferred, isRowClosed, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows);

            return isRowTransferred;
        }

        private bool IsRowTypeTransferrable(CustomerInvoiceRow customerInvoiceRow)
        {
            return customerInvoiceRow.Type == (int)SoeInvoiceRowType.ProductRow ||
                   customerInvoiceRow.Type == (int)SoeInvoiceRowType.TextRow ||
                   customerInvoiceRow.Type == (int)SoeInvoiceRowType.PageBreakRow ||
                   customerInvoiceRow.Type == (int)SoeInvoiceRowType.SubTotalRow;
        }

        #endregion

        private void SetCustomerInvoiceAddresses(CompEntities entities, IReadOnlyList<CustomerInvoiceAnalysDTO> dtos)
        {
            try
            {
                foreach (var i in dtos.Where(x => x.ContactId.GetValueOrDefault() > 0))
                {
                    var addresses = ContactManager.GetContactAddressFirst(entities, i.ContactId.Value, new List<int>() { i.DeliveryAddressId, i.BillingAddressId });

                    string outadress;
                    if (string.IsNullOrEmpty(i.DeliveryAddress))
                    {
                        if (addresses.TryGetValue(i.DeliveryAddressId, out outadress))
                        {
                            i.DeliveryAddress = outadress;
                        }
                    }
                    if (addresses.TryGetValue(i.BillingAddressId, out outadress))
                    {
                        i.BillingAddress = outadress;
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error(ex.Message, ex);
            }
        }

        private void SetCustomerInvoiceTexts(IReadOnlyList<CustomerInvoiceGridDTO> dtos, bool hasCurrencyPermission)
        {

            try
            {
                var langId = base.GetLangId();
                var statusTexts = base.GetTermGroupDict(TermGroup.OriginStatus, langId);
                var invoicePaymentServiceTexts = base.GetTermGroupDict(TermGroup.InvoicePaymentService, langId);
                var invoiceDeliveryProviders = base.GetTermGroupDict(TermGroup.InvoiceDeliveryProvider, langId);
                var billingTypeTexts = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);
                var activeRunningText = GetText(98, "Aktivt");
                var yesText = GetText(52, "Ja");
                var noText = GetText(53, "Nej");

                foreach (var i in dtos)
                {
                    i.StatusName = i.Status != 0 ? statusTexts[i.Status] : "";
                    i.InvoicePaymentServiceName = (i.InvoicePaymentServiceId > 0) ? invoicePaymentServiceTexts[i.InvoicePaymentServiceId] : "";
                    i.BillingTypeName = i.BillingTypeId != 0 ? billingTypeTexts[i.BillingTypeId] : "";
                    i.InvoiceDeliveryProviderName = i.InvoiceDeliveryProvider != 0 ? invoiceDeliveryProviders[i.InvoiceDeliveryProvider] : "";

                    if (i.OriginType == (int)SoeOriginType.Contract && (i.Status == (int)SoeOriginStatus.Origin))
                    {
                        i.StatusName = activeRunningText;
                    }

                    if (hasCurrencyPermission)
                    {
                        i.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(i.SysCurrencyId);
                    }

                    i.isCashSalesText = i.isCashSales ? yesText : noText;
                }
                ;
            }
            catch (Exception ex)
            {
                log.Error(ex.Message, ex);
            }
        }

        private void SetOrderTexts(IReadOnlyList<CustomerInvoiceGridDTO> dtos, bool hasCurrencyPermission)
        {

            try
            {
                var langId = base.GetLangId();
                var statusTexts = base.GetTermGroupDict(TermGroup.OriginStatus, langId);
                var orderContractTypes = base.GetTermGroupDict(TermGroup.OrderContractType, langId);
                var invoicePaymentServiceTexts = base.GetTermGroupDict(TermGroup.InvoicePaymentService, langId);
                var orderTypeTexts = base.GetTermGroupDict(TermGroup.OrderType, langId);

                foreach (var i in dtos)
                {
                    i.StatusName = i.Status != 0 ? statusTexts[i.Status] : "";
                    i.FixedPriceOrderName = orderContractTypes[i.FixedPriceOrder ? 1 : 0];
                    i.InvoicePaymentServiceName = (i.InvoicePaymentServiceId > 0) ? invoicePaymentServiceTexts[i.InvoicePaymentServiceId] : "";
                    i.OrderTypeName = i.OrderType > 0 ? orderTypeTexts[i.OrderType] : "";

                    if (hasCurrencyPermission)
                    {
                        i.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(i.SysCurrencyId);
                    }
                }
                ;

            }
            catch (Exception ex)
            {
                log.Error(ex.Message, ex);
            }
        }

        private void SetContractTexts(IReadOnlyList<CustomerInvoiceGridDTO> dtos, bool hasCurrencyPermission)
        {

            try
            {
                var langId = base.GetLangId();
                var statusTexts = base.GetTermGroupDict(TermGroup.OriginStatus, langId);
                var invoicePaymentServiceTexts = base.GetTermGroupDict(TermGroup.InvoicePaymentService, langId);

                foreach (var i in dtos)
                {
                    i.StatusName = i.Status != 0 ? statusTexts[i.Status] : "";
                    i.InvoicePaymentServiceName = (i.InvoicePaymentServiceId > 0) ? invoicePaymentServiceTexts[i.InvoicePaymentServiceId] : "";
                    if (hasCurrencyPermission)
                    {
                        i.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(i.SysCurrencyId);
                    }
                }
            }
            catch (Exception ex)
            {
                log.Error(ex.Message, ex);
            }
        }

        private static List<int> GetOrderStatusList(bool open, bool closed)
        {
            var statusList = new List<int>();

            if (open)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.Draft, (int)SoeOriginStatus.Origin, (int)SoeOriginStatus.OrderPartlyInvoice });
            if (closed)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.OrderFullyInvoice, (int)SoeOriginStatus.OrderClosed, (int)SoeOriginStatus.Cancel });

            return statusList;
        }

        private static List<int> GetContractStatusList(bool open, bool closed)
        {
            var statusList = new List<int>();

            if (open || closed)
                statusList.Add((int)SoeOriginStatus.Origin);
            if (closed)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.Cancel, (int)SoeOriginStatus.ContractClosed });

            return statusList;
        }

        private static List<int> GetCustomerInvoiceStatusList(bool closeInvoicesWhenTransferredToVoucher, bool open, bool closed)
        {
            var statusList = new List<int>();

            if (open && closeInvoicesWhenTransferredToVoucher)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.Draft, (int)SoeOriginStatus.Origin });
            else if (open)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.Draft, (int)SoeOriginStatus.Origin, (int)SoeOriginStatus.Voucher });

            if (closed && closeInvoicesWhenTransferredToVoucher)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.Voucher });
            else if (closed)
                statusList.AddRange(new List<int> { (int)SoeOriginStatus.Origin, (int)SoeOriginStatus.Voucher });

            return statusList;
        }

        public List<CustomerInvoiceGridDTO> GetOrdersForGrid(CompEntities entities, SoeOriginStatusClassification classification, int actorCompanyId, int userId, bool loadOpen, bool loadClosed, bool onlyMine, bool hideVatWarnings, int? actorCustomerId, int? projectId, bool includeChildProjects, DateTime? selectionDate, bool filterOnBaseCurrency, List<int> invoiceIds = null, List<decimal> vatRatesToValidate = null, DateTime? fromDate = null, DateTime? toDate = null)
        {
            var dtos = new List<CustomerInvoiceGridDTO>();

            string statusList = "";
            string orderList = "";

            switch (classification)
            {
                case SoeOriginStatusClassification.OrdersOpenUser:
                case SoeOriginStatusClassification.OrdersOpen:
                    statusList = string.Join(",", GetOrderStatusList(true, false).Select(x => x.ToString()));
                    break;
                case SoeOriginStatusClassification.OrdersAll:
                    statusList = string.Join(",", GetOrderStatusList(loadOpen, loadClosed).Select(x => x.ToString()));
                    break;
            }

            if (string.IsNullOrEmpty(statusList))
            {
                statusList = $"{(int)SoeOriginStatus.Draft},{(int)SoeOriginStatus.Origin},{(int)SoeOriginStatus.OrderPartlyInvoice},{(int)SoeOriginStatus.OrderFullyInvoice},{(int)SoeOriginStatus.OrderClosed},{(int)SoeOriginStatus.Cancel}";
            }

            if (invoiceIds != null && invoiceIds.Count > 1)
                orderList = string.Join(",", invoiceIds.Select(x => x.ToString()));

            var invoices = entities.GetCustomerOrders(actorCompanyId, invoiceIds != null && invoiceIds.Count == 1 ? invoiceIds[0] : (int?)null, userId, onlyMine, statusList, orderList, selectionDate).ToList();

            if (actorCustomerId.GetValueOrDefault() > 0)
            {
                invoices = invoices.Where(i => i.ActorId == actorCustomerId).ToList();
            }
            else if (projectId.GetValueOrDefault() > 0)
            {
                if (includeChildProjects)
                {
                    List<int> ids = ProjectManager.GetChildProjectsIds(entities, actorCompanyId, projectId.Value);
                    invoices = invoices.Where(i => ids.Contains(i.ProjectId)).ToList();
                }
                else
                {
                    invoices = invoices.Where(i => i.ProjectId == projectId.Value).ToList();
                }
            }

            if (fromDate.HasValue)
                invoices = invoices.Where(i => i.InvoiceDate == null || i.InvoiceDate >= fromDate.Value).ToList();

            if (toDate.HasValue)
                invoices = invoices.Where(i => i.InvoiceDate == null || i.InvoiceDate <= toDate.Value).ToList();

            var invoice = (from i in invoices
                           orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                           select i);

            dtos.AddRange(invoices.ToGridDTOs(hideVatWarnings, true, 0, vatRatesToValidate));

            return dtos;
        }

        public List<CustomerInvoiceGridDTO> GetContractsForGrid(CompEntities entities, SoeOriginStatusClassification classification, int actorCompanyId, int userId, bool loadOpen, bool loadClosed, bool onlyMine, bool hideVatWarnings, int? actorCustomerId, int? projectId, bool includeChildProjects, DateTime? selectionDate, bool filterOnBaseCurrency, List<int> invoiceIds = null)
        {
            var dtos = new List<CustomerInvoiceGridDTO>();

            string statusList = "";
            string contractList = "";

            switch (classification)
            {
                case SoeOriginStatusClassification.ContractsOpen:
                case SoeOriginStatusClassification.ContractsRunning:
                    statusList = string.Join(",", GetContractStatusList(true, false).Select(x => x.ToString()));
                    break;
                case SoeOriginStatusClassification.ContractsAll:
                    statusList = string.Join(",", GetContractStatusList(loadOpen, loadClosed).Select(x => x.ToString()));
                    break;
            }

            /*
            if (string.IsNullOrEmpty(statusList))
            {
                statusList = $"{(int)SoeOriginStatus.Origin}";
            }
            */

            if (invoiceIds != null && invoiceIds.Count > 1)
                contractList = string.Join(",", invoiceIds.Select(x => x.ToString()));

            var invoices = entities.GetCustomerContracts(actorCompanyId, invoiceIds != null && invoiceIds.Count == 1 ? invoiceIds[0] : (int?)null, userId, onlyMine, statusList, contractList).ToList();

            if (actorCustomerId.GetValueOrDefault() > 0)
            {
                invoices = invoices.Where(i => i.ActorId == actorCustomerId).ToList();
            }
            switch (classification)
            {
                case SoeOriginStatusClassification.ContractsAll:
                case SoeOriginStatusClassification.ContractsOpen:
                    #region Contracts all

                    if (loadOpen && loadClosed)
                    {
                        invoices = (from i in invoices
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i).ToList();
                    }
                    else if (loadClosed)
                    {
                        invoices = (from i in invoices
                                    where i.Status == (int)SoeOriginStatus.Cancel || i.Status == (int)SoeOriginStatus.ContractClosed || (i.Status == (int)SoeOriginStatus.Origin &&
                                    (i.DueDate.HasValue && i.DueDate.Value.Date <= DateTime.Today))
                                    orderby i.NextContractPeriodYear, i.NextContractPeriodValue
                                    select i).ToList();
                    }
                    else if (loadOpen)
                    {
                        invoices = (from i in invoices
                                    where
                                    (!i.DueDate.HasValue || (i.DueDate.HasValue && i.DueDate.Value.Date >= DateTime.Today))
                                    orderby i.NextContractPeriodYear, i.NextContractPeriodValue
                                    select i).ToList();
                    }
                    else
                    {
                        return dtos;
                    }

                    #endregion
                    break;
                case SoeOriginStatusClassification.ContractsRunning:
                    #region Contracts running

                    invoices = (from i in invoices
                                where
                                ((!i.NextContractPeriodDate.HasValue || (i.NextContractPeriodDate.HasValue && i.NextContractPeriodDate.Value.Date <= DateTime.Today)) &&
                                (!i.DueDate.HasValue || (i.DueDate.HasValue && i.DueDate.Value.Date >= DateTime.Today)))
                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                select i).ToList();

                    #endregion
                    break;
            }

            dtos.AddRange(invoices.ToGridDTOs(hideVatWarnings, true, 0));
            return dtos;
        }

        public CustomerInvoiceGridDTO GetCustomerInvoiceForGrid(CompEntities entities, int invoiceId, int actorCompanyId)
        {
            var baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, actorCompanyId);
            bool hasCurrencyPermission = FeatureManager.HasRolePermission(Feature.Economy_Customer_Invoice_Status_Foreign, Permission.Readonly, base.RoleId, actorCompanyId, entities: entities);

            var invoices = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), (int)SoeOriginType.CustomerInvoice, null, invoiceId, null, false, "");

            var dtos = invoices.ToGridDTOs(true, false, false, baseSysCurrencyId, null).ToList();
            SetCustomerInvoiceTexts(dtos, hasCurrencyPermission);
            return dtos.FirstOrDefault();
        }
        public List<CustomerInvoiceGridDTO> GetChangedCustomerInvoices(SoeOriginStatusClassification classification, int originType, int actorCompanyId, int userId, bool loadOpen, bool loadClosed, bool onlyMine, bool loadActiveContracts, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection, bool billing, int? daysBack, int? projectId = null, bool includeChildProjects = false, List<int> invoiceIds = null, int? actorCustomerId = null, bool skipForeign = false, List<GetCustomerInvoices_Result> inputInvoices = null, bool? addCustomerInvoiceAttestStates = null, bool forceHasPermissions = false)
        {
            using (var entities = new CompEntities())
            {
                if (daysBack != null && daysBack != 0)
                {
                    var breakpoint = DateTime.Today;
                    var days = -(double)daysBack;
                    breakpoint.AddDays(days);

                    var originIds = (from o in entities.Origin
                                     where o.ActorCompanyId == actorCompanyId &&
                                     o.Type == originType &&
                                     (o.Created >= breakpoint || o.Modified >= breakpoint)
                                     select o.OriginId).ToList();
                    invoiceIds = originIds;
                }
                return GetCustomerInvoicesForGrid(entities, classification, originType, actorCompanyId, userId, loadOpen, loadClosed, onlyMine, loadActiveContracts, allItemsSelection, billing, projectId, includeChildProjects, invoiceIds, actorCustomerId, skipForeign, inputInvoices, addCustomerInvoiceAttestStates, forceHasPermissions: forceHasPermissions);
            }
        }
        public List<CustomerInvoiceGridDTO> GetCustomerInvoicesForGrid(SoeOriginStatusClassification classification, int originType, int actorCompanyId, int userId, bool loadOpen, bool loadClosed, bool onlyMine, bool loadActiveContracts, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection, bool billing, int? projectId = null, bool includeChildProjects = false, List<int> invoiceIds = null, int? actorCustomerId = null, bool skipForeign = false, List<GetCustomerInvoices_Result> inputInvoices = null, bool? addCustomerInvoiceAttestStates = null, DateTime? fromDate = null, DateTime? toDate = null)
        {
            using (var entities = new CompEntities())
            {
                entities.CommandTimeout = 180;
                return GetCustomerInvoicesForGrid(entities, classification, originType, actorCompanyId, userId, loadOpen, loadClosed, onlyMine, loadActiveContracts, allItemsSelection, billing, projectId, includeChildProjects, invoiceIds, actorCustomerId, skipForeign, inputInvoices, addCustomerInvoiceAttestStates, fromDate, toDate);
            }
        }
        public List<CustomerInvoiceGridDTO> GetCustomerInvoicesForGrid(CompEntities entities, SoeOriginStatusClassification classification, int originType, int actorCompanyId, int userId, bool loadOpen, bool loadClosed, bool onlyMine, bool loadActiveContracts, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection, bool billing, int? projectId = null, bool includeChildProjects = false, List<int> invoiceIds = null, int? actorCustomerId = null, bool skipForeign = false, List<GetCustomerInvoices_Result> inputInvoices = null, bool? addCustomerInvoiceAttestStates = null, DateTime? fromDate = null, DateTime? toDate = null, bool forceHasPermissions = false)
        {
            var dtos = new List<CustomerInvoiceGridDTO>();

            #region prereq

            //Variables
            bool addInternalAccounts = false;
            bool filterForReminders = false;
            bool filterForInterest = false;
            var baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, actorCompanyId);

            //TL: forcehaspermission is used when fetching for the SuperOffice sync, since it's not a real user making the calls.
            bool hideVatWarning = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingHideVatWarnings, 0, actorCompanyId, 0);
            bool closeInvoicesWhenTransferredToVoucher = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenTransferredToVoucher, 0, actorCompanyId, 0);
            bool hasCurrencyPermission = FeatureManager.HasRolePermission(Feature.Economy_Customer_Invoice_Status_Foreign, Permission.Readonly, base.RoleId, actorCompanyId) || forceHasPermissions;

            DateTime? selectionDate = null;
            if (allItemsSelection.HasValue)
            {
                switch (allItemsSelection)
                {
                    case TermGroup_ChangeStatusGridAllItemsSelection.One_Month:
                        selectionDate = DateTime.Today.AddMonths(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Tree_Months:
                        selectionDate = DateTime.Today.AddMonths(-3);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Six_Months:
                        selectionDate = DateTime.Today.AddMonths(-6);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Twelve_Months:
                        selectionDate = DateTime.Today.AddYears(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.TwentyFour_Months:
                        selectionDate = DateTime.Today.AddYears(-2);
                        break;
                }
            }

            var vatRates = GetValidVatRates(actorCompanyId);

            #endregion

            if (classification == SoeOriginStatusClassification.CustomerPaymentsPayed || classification == SoeOriginStatusClassification.CustomerPaymentsVoucher)
            {
                var langId = base.GetLangId();
                var paymentStatuses = base.GetTermGroupDict(TermGroup.PaymentStatus, langId);
                var billingTypes = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);

                var payments = entities.GetCustomerPayments(base.ActorCompanyId, base.GetLangId(), originType, null, null, null).Where(i => i.IsInvoiceTemplate == false);

                switch (classification)
                {
                    case SoeOriginStatusClassification.CustomerPaymentsPayed:
                        payments = (from i in payments
                                    where i.OriginType == (int)SoeOriginType.CustomerPayment &&
                                    (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                    (i.Status == (int)SoePaymentStatus.ManualPayment || i.Status == (int)SoePaymentStatus.Verified || i.Status == (int)SoePaymentStatus.Error) &&
                                    i.HasVoucher == false
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                        break;
                    case SoeOriginStatusClassification.CustomerPaymentsVoucher:
                        payments = (from i in payments
                                    where (i.OriginType == (int)SoeOriginType.CustomerPayment) &&
                                    (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                    (i.Status == (int)SoePaymentStatus.Checked || i.Status == (int)SoePaymentStatus.Exported) &&
                                    (i.HasVoucher == true)
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                        break;
                }

                //Filter on date
                if (selectionDate != null)
                    payments = payments.Where(i => i.InvoiceDate == null || i.InvoiceDate >= selectionDate).ToList();

                //Filter currency
                if (!hasCurrencyPermission && baseSysCurrencyId != 0)
                    payments = payments.Where(i => i.SysCurrencyId == baseSysCurrencyId);

                foreach (var payment in payments)
                {
                    var dto = payment.ToCustomerInvoiceGridDTO(hideVatWarning, true, closeInvoicesWhenTransferredToVoucher, baseSysCurrencyId != 0 && payment.SysCurrencyId != baseSysCurrencyId);

                    dto.BillingTypeName = dto.BillingTypeId != 0 ? billingTypes[dto.BillingTypeId] : "";
                    dto.StatusName = dto.Status != 0 ? paymentStatuses[dto.Status] : "";
                    dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.SysCurrencyId);

                    dtos.Add(dto);
                }
            }
            else
            {
                string orderList = "";
                if (invoiceIds != null && invoiceIds.Count > 1)
                    orderList = string.Join(",", invoiceIds.Select(x => x.ToString()));

                if (originType == (int)SoeOriginType.Order)
                {
                    dtos = GetOrdersForGrid(entities, classification, actorCompanyId, userId, loadOpen, loadClosed, onlyMine, hideVatWarning, actorCustomerId, projectId, includeChildProjects, selectionDate, (!hasCurrencyPermission || skipForeign) && baseSysCurrencyId != 0, invoiceIds, vatRates, fromDate, toDate);
                    SetOrderTexts(dtos, hasCurrencyPermission);
                    addInternalAccounts = true;
                    if (!addCustomerInvoiceAttestStates.HasValue)
                        addCustomerInvoiceAttestStates = true;
                }
                else if (originType == (int)SoeOriginType.Contract)
                {
                    dtos = GetContractsForGrid(entities, classification, actorCompanyId, userId, loadOpen, loadClosed, onlyMine, hideVatWarning, actorCustomerId, projectId, includeChildProjects, selectionDate, (!hasCurrencyPermission || skipForeign) && baseSysCurrencyId != 0, invoiceIds);
                    SetContractTexts(dtos, hasCurrencyPermission);

                    addInternalAccounts = true;
                    if (!addCustomerInvoiceAttestStates.HasValue)
                        addCustomerInvoiceAttestStates = true;
                }
                else
                {
                    IEnumerable<GetCustomerInvoices_Result> invoices = inputInvoices;
                    if (
                            (classification == SoeOriginStatusClassification.CustomerInvoicesAll ||
                            classification == SoeOriginStatusClassification.CustomerInvoicesOpen
                        ) &&
                            loadOpen && !loadClosed
                        )
                    {
                        var statusList = closeInvoicesWhenTransferredToVoucher ? $"{(int)SoeOriginStatus.Voucher}" : $"{(int)SoeOriginStatus.Voucher},{(int)SoeOriginStatus.Origin}";
                        invoices = entities.GetCustomerInvoicesOpen(actorCompanyId, null, invoiceIds != null && invoiceIds.Count == 1 ? invoiceIds[0] : (int?)null, userId, onlyMine, statusList, orderList);
                    }
                    else if (classification == SoeOriginStatusClassification.CustomerPaymentsUnpayed && (loadOpen && !loadClosed))
                    {
                        invoices = entities.GetCustomerInvoicesUnpaidOpen(actorCompanyId, originType, invoiceIds != null && invoiceIds.Count == 1 ? invoiceIds[0] : (int?)null, userId, orderList);
                    }
                    else if (inputInvoices == null)
                    {
                        invoices = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), originType, null, invoiceIds != null && invoiceIds.Count == 1 ? invoiceIds[0] : (int?)null, userId, onlyMine, orderList).Where(i => i.IsInvoiceTemplate == false);
                    }

                    IEnumerable<GetCustomerInvoices_Result> prepayments = null;

                    if (invoiceIds != null && invoiceIds.Count > 1)
                        invoices = invoices.Where(i => invoiceIds.Contains(i.InvoiceId));

                    switch (classification)
                    {
                        case SoeOriginStatusClassification.CustomerInvoicesAll:
                        case SoeOriginStatusClassification.CustomerInvoicesOpen:
                            #region Customer invoice

                            if (billing)
                                invoices = (from i in invoices
                                            where i.RegistrationType != (int)OrderInvoiceRegistrationType.Ledger
                                            select i);

                            if (loadOpen && loadClosed)
                            {
                                //Load all invoices
                                invoices = (from i in invoices
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else if (loadClosed)
                            {
                                //Load only closed invoices
                                if (closeInvoicesWhenTransferredToVoucher)
                                {
                                    invoices = (from i in invoices
                                                where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                                (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                                select i);
                                }
                                else
                                {
                                    invoices = (from i in invoices
                                                where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                             (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                                select i);
                                }
                            }
                            else if (loadOpen)
                            {
                                //Load only open invoices
                                //Handled by the procedure GetCustomerInvoicesOpen above
                            }
                            else
                            {
                                return dtos;
                            }
                            addInternalAccounts = true;

                            #endregion
                            break;
                        case SoeOriginStatusClassification.CustomerInvoicesInterest:
                            #region Customer invoice interest

                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                        (i.BillingTypeId != (int)TermGroup_BillingType.Credit) && i.FullyPayed == true
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);

                            filterForInterest = true;

                            #endregion
                            break;
                        case SoeOriginStatusClassification.CustomerInvoicesReminder:
                            #region Customer invoice interest

                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                         i.FullyPayed == false &&
                                         (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                         (i.InsecureDebt == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);

                            filterForReminders = true;

                            #endregion
                            break;
                        case SoeOriginStatusClassification.CustomerPaymentsUnpayed:
                            #region Customer invoice unpaid

                            //collect prepayments
                            prepayments = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), (int)SoeOriginType.CustomerPayment, null, null, userId, onlyMine, "").Where(i => i.IsInvoiceTemplate == false);

                            prepayments = (from i in prepayments
                                           where (i.Status != (int)SoeOriginStatus.Cancel && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed &&
                                           i.Status == (int)SoeOriginStatus.Origin && i.FullyPayed == false)
                                           orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                           select i);

                            if (loadOpen && !loadClosed)
                            {
                                invoices = (from i in invoices
                                            where (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                            (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                            (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else if (!loadOpen && loadClosed)
                            {
                                if (closeInvoicesWhenTransferredToVoucher)
                                {
                                    invoices = (from i in invoices
                                                where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                                (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                                select i);
                                }
                                else
                                {
                                    invoices = (from i in invoices
                                                where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                             (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                                select i);
                                }
                            }
                            else if (loadOpen && loadClosed)
                            {
                                if (closeInvoicesWhenTransferredToVoucher)
                                {
                                    invoices = (from i in invoices
                                                where ((i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                                (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                                (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)) ||
                                                (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                                (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                                select i);
                                }
                                else
                                {
                                    invoices = (from i in invoices
                                                where ((i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                                (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                                (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)) ||
                                                (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                                (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                                select i);
                                }
                            }
                            else
                            {
                                return dtos;
                            }


                            #endregion
                            break;
                        case SoeOriginStatusClassification.OffersAll:
                        case SoeOriginStatusClassification.OffersOpen:
                            #region Offers all

                            if (loadOpen && loadClosed)
                            {
                                invoices = (from i in invoices
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else if (loadClosed)
                            {
                                invoices = (from i in invoices
                                            where (i.Status == (int)SoeOriginStatus.OfferFullyOrder || i.Status == (int)SoeOriginStatus.OfferFullyInvoice || i.Status == (int)SoeOriginStatus.OfferClosed || i.Status == (int)SoeOriginStatus.Cancel)
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else if (loadOpen)
                            {
                                invoices = (from i in invoices
                                            where (i.Status == (int)SoeOriginStatus.Draft || i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.OfferPartlyOrder || i.Status == (int)SoeOriginStatus.OfferPartlyInvoice)
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else
                            {
                                return dtos;
                            }

                            if (!addCustomerInvoiceAttestStates.HasValue)
                                addCustomerInvoiceAttestStates = true;

                            #endregion
                            break;
                    }

                    if (actorCustomerId.GetValueOrDefault() > 0)
                    {
                        invoices = invoices.Where(i => i.ActorId == actorCustomerId);
                    }
                    else if (projectId.GetValueOrDefault() > 0)
                    {
                        if (includeChildProjects)
                        {
                            List<int> ids = ProjectManager.GetChildProjectsIds(entities, actorCompanyId, projectId.Value);
                            invoices = invoices.Where(i => ids.Contains(i.ProjectId));
                        }
                        else
                        {
                            invoices = invoices.Where(i => i.ProjectId == projectId.Value).ToList();
                        }
                    }

                    //Filter on date
                    if (selectionDate != null)
                        invoices = invoices.Where(i => i.InvoiceDate == null || i.InvoiceDate >= selectionDate).ToList();

                    if (fromDate.HasValue)
                        invoices = invoices.Where(i => i.InvoiceDate == null || i.InvoiceDate >= fromDate.Value).ToList();

                    if (toDate.HasValue)
                        invoices = invoices.Where(i => i.InvoiceDate == null || i.InvoiceDate <= toDate.Value).ToList();

                    //Filter currency
                    if (!hasCurrencyPermission && baseSysCurrencyId != 0)
                        invoices = invoices.Where(i => i.SysCurrencyId == baseSysCurrencyId);

                    dtos.AddRange(invoices.ToGridDTOs(hideVatWarning, true, closeInvoicesWhenTransferredToVoucher, baseSysCurrencyId, vatRates));
                    SetCustomerInvoiceTexts(dtos, hasCurrencyPermission);

                    if (prepayments != null && invoiceIds.IsNullOrEmpty())
                        dtos.AddRange(prepayments.ToGridDTOs(hideVatWarning, true, closeInvoicesWhenTransferredToVoucher, baseSysCurrencyId, vatRates));
                }
            }

            if (filterForReminders)
            {
                foreach (var invoice in dtos)
                {
                    bool totalAmountPaid = false;
                    if (invoice.BillingTypeId == (int)TermGroup_BillingType.Credit)
                        totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount >= 0);
                    else
                        totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount <= 0);

                    invoice.IsOverdued = IsCustomerInvoiceOverdued(entities, 0, invoice.CustomerGracePeriodDays, invoice.DueDate, invoice.CustomerInvoiceId, totalAmountPaid);

                    if (!invoice.ReminderContactEComId.HasValue && invoice.ContactEComId.HasValue)
                    {
                        invoice.ReminderContactEComId = invoice.ContactEComId;
                        invoice.ReminderContactEComText = invoice.ContactEComText;
                    }
                }

                dtos = dtos.Where(i => i.IsOverdued == true && i.HasInterest == false).ToList();
            }
            else if (filterForInterest)
            {
                var interests = (from cir in entities.CustomerInvoiceInterestView
                                 where cir.ActorCompanyId == actorCompanyId
                                 select cir).ToList();

                int defaultGracePeriodDays = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerGracePeriodDays, 0, actorCompanyId, 0);

                foreach (var invoice in dtos)
                {
                    bool totalAmountPaid = false;
                    if (invoice.BillingTypeId == (int)TermGroup_BillingType.Credit)
                        totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount >= 0);
                    else
                        totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount <= 0);

                    invoice.IsOverdued = IsCustomerInvoiceOverdued(entities, defaultGracePeriodDays, invoice.CustomerGracePeriodDays, invoice.DueDate, invoice.CustomerInvoiceId, totalAmountPaid);
                    invoice.HasInterest = HasCustomerInvoiceInterest(interests, invoice.CustomerInvoiceId);
                }

                dtos = dtos.Where(i => i.IsOverdued == true && i.HasInterest == false).ToList();

                /* InterestAccumulatedBeforeInvoice */
                int defaultInterestAccumulatedBeforeInvoice = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInterestAccumulatedBeforeInvoice, 0, actorCompanyId, 0);
                decimal interestPercent = SettingManager.GetDecimalSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, actorCompanyId, 0);

                if (defaultInterestAccumulatedBeforeInvoice > 0)
                {
                    List<CustomerInvoiceGridDTO> filteredInvoices = new List<CustomerInvoiceGridDTO>();
                    foreach (var invoice in dtos)
                    {
                        decimal interestAmount = CalculateInterestAmount(entities, invoice.CustomerInvoiceId, interestPercent, invoice.TotalAmount, invoice.DueDate, false);
                        if (interestAmount < defaultInterestAccumulatedBeforeInvoice)
                        {
                            filteredInvoices.Add(invoice);
                        }
                    }

                    dtos.RemoveRange(filteredInvoices);
                }
            }

            if (addInternalAccounts)
                AddInternalAccounts(dtos, actorCompanyId);

            if (addCustomerInvoiceAttestStates.GetValueOrDefault())
                dtos = AddCustomerInvoiceAttestStatesConverted(entities, dtos, originType, actorCompanyId, userId);

            return classification == SoeOriginStatusClassification.OrdersAll ||
                classification == SoeOriginStatusClassification.OrdersOpen ||
                classification == SoeOriginStatusClassification.OrdersOpenUser ? dtos.OrderByDescending(o => o.SeqNr).ToList() : dtos;

        }

        public List<CustomerInvoiceGridDTO> GetFilteredCustomerInvoicesForGrid(ExpandoObject filterModels) //SoeOriginStatusClassification classification, int originType, bool loadOpen, bool loadClosed, bool onlyMine, bool loadActiveContracts, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection, bool billing, int? projectId = null, bool includeChildProjects = false, List<int> invoiceIds = null, int? actorCustomerId = null)
        {
            List<CustomerInvoiceGridDTO> dtos = new List<CustomerInvoiceGridDTO>();
            using (CompEntities entities = new CompEntities())
            {
                #region prereq

                var values = (IDictionary<string, object>)filterModels;
                if (!values.ContainsKey("classification") || !values.ContainsKey("origintype") || !values.ContainsKey("billing"))
                    return dtos;

                // Basic values
                SoeOriginStatusClassification classification = (SoeOriginStatusClassification)Convert.ToInt32(values["classification"]);
                int originType = Convert.ToInt32(values["origintype"]);
                bool billing = (bool)values["billing"];

                // Selection values
                bool loadOpen = values.ContainsKey("loadopen") ? (bool)values["loadopen"] : true;
                bool loadClosed = values.ContainsKey("loadclosed") ? (bool)values["loadclosed"] : false;
                bool onlyMine = values.ContainsKey("onlymine") ? (bool)values["onlymine"] : false;

                //Variables
                bool addInternalAccounts = false;
                bool filterForReminders = false;
                bool filterForInterest = false;
                bool addCustomerInvoiceAttestStates = false;
                int? baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                if (!baseSysCurrencyId.HasValue)
                    baseSysCurrencyId = 0;
                bool hideVatWarning = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingHideVatWarnings, 0, base.ActorCompanyId, 0);
                bool closeInvoicesWhenTransferredToVoucher = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenTransferredToVoucher, 0, base.ActorCompanyId, 0);
                bool hasCurrencyPermission = FeatureManager.HasRolePermission(Feature.Economy_Customer_Invoice_Status_Foreign, Permission.Readonly, base.RoleId, base.ActorCompanyId);

                var vatRates = GetValidVatRates(base.ActorCompanyId);

                #endregion

                var invoices = entities.GetCustomerInvoices(base.ActorCompanyId, base.GetLangId(), originType, null, null, base.UserId, onlyMine, "").Where(i => i.IsInvoiceTemplate == false);

                IEnumerable<GetCustomerInvoices_Result> prepayments = null;

                switch (classification)
                {
                    case SoeOriginStatusClassification.CustomerInvoicesAll:
                        #region Customer invoice

                        if (billing)
                            invoices = (from i in invoices
                                        where i.RegistrationType != (int)OrderInvoiceRegistrationType.Ledger
                                        select i);

                        if (loadOpen && loadClosed)
                        {
                            //Load all invoices
                            invoices = (from i in invoices
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (loadClosed)
                        {
                            //Load only closed invoices
                            if (closeInvoicesWhenTransferredToVoucher)
                            {
                                invoices = (from i in invoices
                                            where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                            (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else
                            {
                                invoices = (from i in invoices
                                            where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                            (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                        }
                        else if (loadOpen)
                        {
                            //Load only open invoices
                            if (closeInvoicesWhenTransferredToVoucher)
                            {
                                invoices = (from i in invoices
                                            where (i.Status != (int)SoeOriginStatus.Cancel && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed &&
                                            !(i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else
                            {
                                invoices = (from i in invoices
                                            where (i.Status != (int)SoeOriginStatus.Cancel && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed &&
                                            !(i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                        }
                        else
                        {
                            return dtos;
                        }
                        addInternalAccounts = true;

                        #endregion
                        break;
                    case SoeOriginStatusClassification.CustomerInvoicesInterest:
                        #region Customer invoice interest

                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                    (i.BillingTypeId != (int)TermGroup_BillingType.Credit) && i.FullyPayed == true
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);

                        filterForInterest = true;

                        #endregion
                        break;
                    case SoeOriginStatusClassification.CustomerInvoicesReminder:
                        #region Customer invoice interest

                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                        i.FullyPayed == false &&
                                        (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                        (i.InsecureDebt == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);

                        filterForReminders = true;

                        #endregion
                        break;
                    case SoeOriginStatusClassification.CustomerPaymentsUnpayed:
                        #region Customer invoice unpaid

                        //collect prepayments
                        prepayments = entities.GetCustomerInvoices(base.ActorCompanyId, base.GetLangId(), (int)SoeOriginType.CustomerPayment, null, null, base.UserId, onlyMine, "").Where(i => i.IsInvoiceTemplate == false);

                        prepayments = (from i in prepayments
                                       where (i.Status != (int)SoeOriginStatus.Cancel && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed &&
                                       i.Status == (int)SoeOriginStatus.Origin && i.FullyPayed == false)
                                       orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                       select i);

                        if (loadOpen && !loadClosed)
                        {
                            invoices = (from i in invoices
                                        where (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                        (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                        (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (!loadOpen && loadClosed)
                        {
                            if (closeInvoicesWhenTransferredToVoucher)
                            {
                                invoices = (from i in invoices
                                            where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                            (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else
                            {
                                invoices = (from i in invoices
                                            where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                            (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                        }
                        else if (loadOpen && loadClosed)
                        {
                            if (closeInvoicesWhenTransferredToVoucher)
                            {
                                invoices = (from i in invoices
                                            where ((i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                            (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                            (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)) ||
                                            (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                            (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                            else
                            {
                                invoices = (from i in invoices
                                            where ((i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                            (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                            (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)) ||
                                            (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                            (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                            orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                            select i);
                            }
                        }
                        else
                        {
                            return dtos;
                        }


                        #endregion
                        break;
                    case SoeOriginStatusClassification.OffersAll:
                        #region Offers all

                        if (loadOpen && loadClosed)
                        {
                            invoices = (from i in invoices
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (loadClosed)
                        {
                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.OfferFullyOrder || i.Status == (int)SoeOriginStatus.OfferFullyInvoice || i.Status == (int)SoeOriginStatus.OfferClosed || i.Status == (int)SoeOriginStatus.Cancel)
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (loadOpen)
                        {
                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.Draft || i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.OfferPartlyOrder || i.Status == (int)SoeOriginStatus.OfferPartlyInvoice)
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else
                        {
                            return dtos;
                        }

                        addCustomerInvoiceAttestStates = true;

                        #endregion
                        break;
                    case SoeOriginStatusClassification.OrdersAll:
                        #region Orders all

                        if (loadOpen && loadClosed)
                        {
                            invoices = (from i in invoices
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (loadClosed)
                        {
                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.OrderFullyInvoice || i.Status == (int)SoeOriginStatus.OrderClosed || i.Status == (int)SoeOriginStatus.Cancel)
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (loadOpen)
                        {
                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.Draft || i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.OrderPartlyInvoice)
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else
                        {
                            return dtos;
                        }

                        addInternalAccounts = true;
                        addCustomerInvoiceAttestStates = true;

                        #endregion
                        break;
                    case SoeOriginStatusClassification.ContractsAll:
                        #region Contracts all

                        if (loadOpen && loadClosed)
                        {
                            invoices = (from i in invoices
                                        where i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Cancel || i.Status == (int)SoeOriginStatus.ContractClosed
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else if (loadClosed)
                        {
                            invoices = (from i in invoices
                                        where i.Status == (int)SoeOriginStatus.Cancel || i.Status == (int)SoeOriginStatus.ContractClosed || (i.Status == (int)SoeOriginStatus.Origin &&
                                        (i.DueDate.HasValue && i.DueDate.Value.Date <= DateTime.Today))
                                        select i);
                        }
                        else if (loadOpen)
                        {
                            invoices = (from i in invoices
                                        where i.Status == (int)SoeOriginStatus.Origin &&
                                        (!i.DueDate.HasValue || (i.DueDate.HasValue && i.DueDate.Value.Date >= DateTime.Today))
                                        select i);
                        }
                        else
                        {
                            return dtos;
                        }

                        addInternalAccounts = true;
                        addCustomerInvoiceAttestStates = true;

                        #endregion
                        break;
                    case SoeOriginStatusClassification.ContractsRunning:
                        #region Contracts running
                        /*
                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.Origin) &&
                                    ((!i.NextContractPeriodDate.HasValue || (i.NextContractPeriodDate.HasValue && i.NextContractPeriodDate.Value.Date <= DateTime.Today)) &&
                                    (!i.DueDate.HasValue || (i.DueDate.HasValue && i.DueDate.Value.Date >= DateTime.Today)))
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);

                        addInternalAccounts = true;
                        addCustomerInvoiceAttestStates = true;
                        */
                        #endregion
                        break;
                }

                // Filter - currency
                if (!hasCurrencyPermission && baseSysCurrencyId != 0)
                    invoices = invoices.Where(i => i.SysCurrencyId == baseSysCurrencyId);

                // Filter - custom
                if (values.ContainsKey("billingType"))
                {
                    var billingType = Convert.ToInt32(values["billingType"]);
                    invoices = invoices.Where(i => i.BillingTypeId == billingType);
                }

                // Filter - text
                if (values.ContainsKey("seqNr"))
                {
                    var filterObject = values["seqNr"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.InvoiceSeqNr.HasValue && i.InvoiceSeqNr.ToString().StartsWith(filterObject["filter"].ToString().ToLower()));
                }
                if (values.ContainsKey("invoiceNr"))
                {
                    var filterObject = values["invoiceNr"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.InvoiceNr.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                if (values.ContainsKey("projectNr"))
                {
                    var filterObject = values["projectNr"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.ProjectNumber != null && i.ProjectNumber.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                if (values.ContainsKey("orderNumbers"))
                {
                    var filterObject = values["orderNumbers"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.OrderNumbers != null && i.OrderNumbers.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                if (values.ContainsKey("actorCustomerName"))
                {
                    var filterObject = values["actorCustomerName"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.ActorName != null && i.ActorName.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                if (values.ContainsKey("users"))
                {
                    var filterObject = values["users"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.OriginUsers != null && i.OriginUsers.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }

                if (values.ContainsKey("internalText"))
                {
                    var filterObject = values["internalText"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.InternalText != null && i.InternalText.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                if (values.ContainsKey("deliveryAddress"))
                {
                    var filterObject = values["deliveryAddress"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.DeliveryAddress != null && i.DeliveryAddress.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }

                if (values.ContainsKey("categories"))
                {
                    var filterObject = values["categories"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.Categories != null && i.Categories.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                /*
                if (values.ContainsKey("contractGroupName"))
                {
                    var filterObject = values["contractGroupName"] as IDictionary<string, object>;
                    invoices = invoices.Where(i => i.ContractGroupName != null && i.ContractGroupName.ToLower().Contains(filterObject["filter"].ToString().ToLower()));
                }
                */
                // Filter - numbers
                if (values.ContainsKey("totalAmount"))
                {
                    var item = (IDictionary<string, object>)values["totalAmount"];
                    var type = item["type"].ToString();
                    invoices = invoices.Where(i => FilterOnAmount((i.InvoiceTotalAmount), type, Convert.ToDecimal(item["filter"])));
                }
                if (values.ContainsKey("totalAmountExVat"))
                {
                    var item = (IDictionary<string, object>)values["totalAmountExVat"];
                    var type = item["type"].ToString();
                    invoices = invoices.Where(i => FilterOnAmount((i.InvoiceTotalAmount - i.VATAmount), type, Convert.ToDecimal(item["filter"])));
                }
                if (values.ContainsKey("totalAmountCurrency"))
                {
                    var item = (IDictionary<string, object>)values["totalAmountCurrency"];
                    var type = item["type"].ToString();
                    invoices = invoices.Where(i => FilterOnAmount(i.InvoiceTotalAmountCurrency, type, Convert.ToDecimal(item["filter"])));
                }
                if (values.ContainsKey("remainingAmount"))
                {
                    var item = (IDictionary<string, object>)values["remainingAmount"];
                    var type = item["type"].ToString();
                    invoices = invoices.Where(i => FilterOnAmount(i.RemainingAmount, type, Convert.ToDecimal(item["filter"])));
                }
                if (values.ContainsKey("remainingAmountExVat"))
                {
                    var item = (IDictionary<string, object>)values["remainingAmountExVat"];
                    var type = item["type"].ToString();
                    invoices = invoices.Where(i => FilterOnAmount(i.RemainingAmountExVat, type, Convert.ToDecimal(item["filter"])));
                }

                // Filter - dates
                if (values.ContainsKey("invoiceDate"))
                {
                    var item = (IDictionary<string, object>)values["invoiceDate"];
                    var type = item["type"].ToString();
                    var fromDate = item["dateFrom"] != null ? Convert.ToDateTime(item["dateFrom"]) : (DateTime?)null;
                    var toDate = item["dateTo"] != null ? Convert.ToDateTime(item["dateTo"]) : (DateTime?)null;
                    invoices = invoices.Where(i => i.InvoiceDate != null && FilterOnDate(i.InvoiceDate.Value, type, fromDate, toDate));
                }
                if (values.ContainsKey("dueDate"))
                {
                    var item = (IDictionary<string, object>)values["dueDate"];
                    var type = item["type"].ToString();
                    var fromDate = item["dateFrom"] != null ? Convert.ToDateTime(item["dateFrom"]) : (DateTime?)null;
                    var toDate = item["dateTo"] != null ? Convert.ToDateTime(item["dateTo"]) : (DateTime?)null;
                    invoices = invoices.Where(i => i.DueDate != null && FilterOnDate(i.DueDate.Value, type, fromDate, toDate));
                }
                if (values.ContainsKey("payDate"))
                {
                    var item = (IDictionary<string, object>)values["payDate"];
                    var type = item["type"].ToString();
                    var fromDate = item["dateFrom"] != null ? Convert.ToDateTime(item["dateFrom"]) : (DateTime?)null;
                    var toDate = item["dateTo"] != null ? Convert.ToDateTime(item["dateTo"]) : (DateTime?)null;
                    invoices = invoices.Where(i => i.PayDate != null && FilterOnDate(i.PayDate.Value, type, fromDate, toDate));
                }
                if (values.ContainsKey("deliveryDate"))
                {
                    var item = (IDictionary<string, object>)values["deliveryDate"];
                    var type = item["type"].ToString();
                    var fromDate = item["dateFrom"] != null ? Convert.ToDateTime(item["dateFrom"]) : (DateTime?)null;
                    var toDate = item["dateTo"] != null ? Convert.ToDateTime(item["dateTo"]) : (DateTime?)null;
                    invoices = invoices.Where(i => i.DeliveryDate != null && FilterOnDate(i.DeliveryDate.Value, type, fromDate, toDate));
                }

                // Filter - collections
                if (values.ContainsKey("orderTypeName"))
                {
                    List<int> orderTypes = new List<int>();
                    foreach (object id in values["orderTypeName"] as List<object>)
                    {
                        orderTypes.Add(Convert.ToInt32(id));
                    }
                    invoices = invoices.Where(i => orderTypes.Contains(i.OrderType));
                }
                /*
                if (values.ContainsKey("shiftTypeName"))
                {
                    List<string> shiftTypes = new List<string>();
                    foreach (object name in values["shiftTypeName"] as List<object>)
                    {
                        shiftTypes.Add(name.ToString());
                    }

                    invoices = invoices.Where(i => shiftTypes.Contains(i.ShiftTypeName));
                }
                */
                if (originType == (int)SoeOriginType.Contract)
                {
                    //Fix for statusname
                    var activeRunning = GetText(98, "Aktivt");
                    foreach (var invoice in invoices)
                    {
                        var dto = invoice.ToGridDTO(hideVatWarning, true, closeInvoicesWhenTransferredToVoucher, baseSysCurrencyId != 0 && invoice.SysCurrencyId != baseSysCurrencyId);
                        if (dto.Status == (int)SoeOriginStatus.Origin)
                            dto.StatusName = activeRunning;
                        dtos.Add(dto);
                    }
                }
                else
                {
                    dtos.AddRange(invoices.ToGridDTOs(hideVatWarning, true, closeInvoicesWhenTransferredToVoucher, baseSysCurrencyId, vatRates));
                }

                // Filter after parse
                if (values.ContainsKey("statusName"))
                {
                    List<int> statuses = new List<int>();
                    foreach (object id in values["statusName"] as List<object>)
                    {
                        statuses.Add(Convert.ToInt32(id));
                    }
                    invoices = invoices.Where(i => statuses.Contains(i.Status));
                }
                if (values.ContainsKey("deliveryTypeName"))
                {
                    var filterObject = values["deliveryTypeName"] as IDictionary<string, object>;
                    dtos = dtos.Where(i => i.DeliveryTypeName.ToLower().Contains(filterObject["filter"].ToString().ToLower())).ToList();
                }
                if (values.ContainsKey("exportStatusName"))
                {
                    var filterObject = values["exportStatusName"] as IDictionary<string, object>;
                    dtos = dtos.Where(i => i.ExportStatusName.ToLower().Contains(filterObject["filter"].ToString().ToLower())).ToList();
                }
                if (values.ContainsKey("nextContractPeriod"))
                {
                    var filterObject = values["nextContractPeriod"] as IDictionary<string, object>;
                    dtos = dtos.Where(i => i.NextContractPeriod.ToLower().Contains(filterObject["filter"].ToString().ToLower())).ToList();
                }
                if (values.ContainsKey("contractYearlyValueExVat"))
                {
                    var item = (IDictionary<string, object>)values["contractYearlyValueExVat"];
                    var type = item["type"].ToString();
                    dtos = dtos.Where(i => FilterOnAmount(i.ContractYearlyValueExVat, type, Convert.ToDecimal(item["filter"]))).ToList();
                }
                if (values.ContainsKey("contractYearlyValue"))
                {
                    var item = (IDictionary<string, object>)values["contractYearlyValue"];
                    var type = item["type"].ToString();
                    dtos = dtos.Where(i => FilterOnAmount(i.ContractYearlyValue, type, Convert.ToDecimal(item["filter"]))).ToList();
                }


                if (prepayments != null)
                    dtos.AddRange(prepayments.ToGridDTOs(hideVatWarning, true, closeInvoicesWhenTransferredToVoucher, baseSysCurrencyId, vatRates));

                if (filterForReminders)
                {
                    foreach (var invoice in dtos)
                    {
                        bool totalAmountPaid = false;
                        if (invoice.BillingTypeId == (int)TermGroup_BillingType.Credit)
                            totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount >= 0);
                        else
                            totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount <= 0);

                        invoice.IsOverdued = IsCustomerInvoiceOverdued(entities, 0, invoice.CustomerGracePeriodDays, invoice.DueDate, invoice.CustomerInvoiceId, totalAmountPaid);
                    }

                    dtos = dtos.Where(i => i.IsOverdued == true && i.HasInterest == false).ToList();
                }
                else if (filterForInterest)
                {
                    int actorCompanyId = base.ActorCompanyId;
                    var interests = (from cir in entities.CustomerInvoiceInterestView
                                     where cir.ActorCompanyId == actorCompanyId
                                     select cir).ToList();

                    int defaultGracePeriodDays = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerGracePeriodDays, 0, actorCompanyId, 0);

                    foreach (var invoice in dtos)
                    {
                        bool totalAmountPaid = false;
                        if (invoice.BillingTypeId == (int)TermGroup_BillingType.Credit)
                            totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount >= 0);
                        else
                            totalAmountPaid = invoice.PaidAmount != 0 && (invoice.TotalAmount - invoice.PaidAmount <= 0);

                        invoice.IsOverdued = IsCustomerInvoiceOverdued(entities, defaultGracePeriodDays, invoice.CustomerGracePeriodDays, invoice.DueDate, invoice.CustomerInvoiceId, totalAmountPaid);
                        invoice.HasInterest = HasCustomerInvoiceInterest(interests, invoice.CustomerInvoiceId);
                    }

                    dtos = dtos.Where(i => i.IsOverdued == true && i.HasInterest == false).ToList();

                    /* InterestAccumulatedBeforeInvoice */
                    int defaultInterestAccumulatedBeforeInvoice = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInterestAccumulatedBeforeInvoice, 0, actorCompanyId, 0);
                    decimal interestPercent = SettingManager.GetDecimalSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, actorCompanyId, 0);

                    if (defaultInterestAccumulatedBeforeInvoice > 0)
                    {
                        List<CustomerInvoiceGridDTO> filteredInvoices = new List<CustomerInvoiceGridDTO>();
                        foreach (var invoice in dtos)
                        {
                            decimal interestAmount = CalculateInterestAmount(entities, invoice.CustomerInvoiceId, interestPercent, invoice.TotalAmount, invoice.DueDate, false);
                            if (interestAmount < defaultInterestAccumulatedBeforeInvoice)
                            {
                                filteredInvoices.Add(invoice);
                            }
                        }

                        dtos.RemoveRange(filteredInvoices);
                    }
                }

                if (addInternalAccounts)
                    AddInternalAccounts(dtos, base.ActorCompanyId);

                if (addCustomerInvoiceAttestStates)
                    dtos = AddCustomerInvoiceAttestStatesConverted(entities, dtos, originType, base.ActorCompanyId, base.UserId);

                //Filter internal accounts
                if (values.ContainsKey("defaultDimAccountNames"))
                {
                    var filterObject = values["defaultDimAccountNames"] as IDictionary<string, object>;
                    dtos = dtos.Where(i => i.DefaultDimAccountNames.ToLower().Contains(filterObject["filter"].ToString().ToLower())).ToList();
                }

                return classification == SoeOriginStatusClassification.OrdersAll ? dtos.OrderByDescending(o => o.SeqNr).ToList() : dtos;
            }
        }

        /// <summary>
        /// Private method to get a fixed list of Vat rates in percent, based on company's country.
        /// </summary>
        /// <param name="actorCompanyId">PK of company table</param>
        /// <returns>List of decimals representing allowed Vat rates in percent, 25 = 25%.</returns>
        private List<decimal> GetValidVatRates(int actorCompanyId)
        {
            var companySysCountryId = CompanyManager.GetCompanySysCountryId(actorCompanyId);
            switch (companySysCountryId)
            {
                case (int)TermGroup_Country.FI:
                    return new List<decimal>() { 25.5M, 24M, 14M, 10M };
                default:
                    return new List<decimal>() { 25M };
            }
        }

        public List<CustomerInvoiceAnalysDTO> GetCustomerInvoicesForAnalys(CompEntities entities, SoeOriginType originType, int actorCompanyId, IDictionary<string, object> filterModel, bool addInternalAccountNames, bool setAddresses)
        {

            bool closeInvoicesWhenTransferredToVoucher = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenTransferredToVoucher, 0, base.ActorCompanyId, 0);
            bool hasCurrencyPermission = FeatureManager.HasRolePermission(Feature.Economy_Customer_Invoice_Status_Foreign, Permission.Readonly, base.RoleId, actorCompanyId);

            var query = (from i in entities.Invoice
                         where i.Origin.ActorCompanyId == actorCompanyId &&
                               i.Origin.Type == (int)originType &&
                               i.State == (int)SoeEntityState.Active &&
                               !i.IsTemplate
                         select i).OfType<CustomerInvoice>();

            if (filterModel.ContainsKey("deliveryDateFrom"))
            {
                var deliveryDateFrom = Convert.ToDateTime(filterModel["deliveryDateFrom"]);
                query = query.Where(i => i.DeliveryDate >= deliveryDateFrom);
            }

            if (filterModel.ContainsKey("deliveryDateTo"))
            {
                var deliveryDateTo = Convert.ToDateTime(filterModel["deliveryDateTo"]);
                query = query.Where(i => i.DeliveryDate <= deliveryDateTo);
            }

            if (filterModel.ContainsKey("invoiceDateFrom"))
            {
                var invoiceDateFrom = Convert.ToDateTime(filterModel["invoiceDateFrom"]);
                query = query.Where(i => i.InvoiceDate >= invoiceDateFrom);
            }

            if (filterModel.ContainsKey("invoiceDateTo"))
            {
                var invoiceDateTo = Convert.ToDateTime(filterModel["invoiceDateTo"]);
                query = query.Where(i => i.InvoiceDate <= invoiceDateTo);
            }

            if (filterModel.ContainsKey("dueDateFrom"))
            {
                var dueDateFrom = Convert.ToDateTime(filterModel["dueDateFrom"]);
                query = query.Where(i => i.DueDate >= dueDateFrom);
            }

            if (filterModel.ContainsKey("dueDateTo"))
            {
                var dueDateTo = Convert.ToDateTime(filterModel["dueDateTo"]);
                query = query.Where(i => i.DueDate <= dueDateTo);
            }

            var showOpen = false;
            if (filterModel.ContainsKey("showOpen"))
            {
                showOpen = Convert.ToBoolean(filterModel["showOpen"]);
            }

            var showClosed = false;
            if (filterModel.ContainsKey("showClosed"))
            {
                showClosed = Convert.ToBoolean(filterModel["showClosed"]);
            }

            if (filterModel.ContainsKey("onlyMine") && Convert.ToBoolean(filterModel["onlyMine"]))
            {
                query = query.Where(x => x.Origin.OriginUser.Any(u => u.State == (int)SoeEntityState.Active && u.UserId == this.UserId));
            }

            var includePreliminaryInvoices = false;
            if (filterModel.ContainsKey("includePreliminaryInvoices"))
            {
                includePreliminaryInvoices = Convert.ToBoolean(filterModel["includePreliminaryInvoices"]);
            }

            if (!(showOpen && showClosed))
            {
                if (originType == SoeOriginType.Order)
                {
                    var statusList = InvoiceManager.GetOrderStatusList(showOpen, showClosed);
                    query = query.Where(x => statusList.Contains(x.Origin.Status));
                }
                else if (originType == SoeOriginType.CustomerInvoice)
                {
                    query = query.Where(x => x.RegistrationType != (int)OrderInvoiceRegistrationType.Ledger);
                    var statusList = InvoiceManager.GetCustomerInvoiceStatusList(closeInvoicesWhenTransferredToVoucher, showOpen, showClosed);
                    if (!includePreliminaryInvoices)
                    {
                        query = query.Where(x => x.InvoiceDate.HasValue);
                        statusList = statusList.Where(w => w != (int)SoeOriginStatus.Draft).ToList();
                    }
                    if (!showOpen && !showClosed)
                    {
                        return new List<CustomerInvoiceAnalysDTO>();
                    }
                    if (showOpen)
                    {
                        query = query.Where(x => x.ExportStatus != 1);
                        query = query.Where(x => !(x.FullyPayed && statusList.Contains(x.Origin.Status)));
                    }
                    else
                    {
                        query = query.Where(x => ((x.FullyPayed && statusList.Contains(x.Origin.Status)) || x.Origin.Status == (int)SoeOriginStatus.Cancel || x.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed));
                    }
                }
            }

            var dtos = query.OrderBy(i => i.SeqNr).Select(i => new CustomerInvoiceAnalysDTO
            {
                InvoiceNr = i.InvoiceNr,
                ActorCustomerName = i.Actor.Customer.Name,
                ActorCustomerNr = i.Actor.Customer.CustomerNr,
                ContactId = i.Actor.Contact.FirstOrDefault().ContactId,
                ProjectNr = i.Project.Number,
                ProjectName = i.Project.Name,
                DeliveryDate = i.DeliveryDate,
                InvoiceDate = i.InvoiceDate,
                DueDate = i.DueDate,
                OrderDate = i.OrderDate,
                InvoiceLabel = i.InvoiceLabel,
                DeliveryAddressId = i.DeliveryAddressId,
                BillingAddressId = i.BillingAddressId,
                DeliveryAddress = i.InvoiceHeadText,
                PriceListName = i.PriceListType.Name,
                TotalAmountExVat = (i.TotalAmount - i.CentRounding) - i.VATAmount,
                OriginUserCount = i.Origin.OriginUser.Count(x => x.State == (int)SoeEntityState.Active),
                OriginReadyUserCount = i.Origin.OriginUser.Count(x => x.State == (int)SoeEntityState.Active && x.ReadyDate.HasValue),
                RemainingAmountExVat = i.RemainingAmountExVat ?? 0,
                BillingTypeId = i.BillingType,
                ReferenceOur = i.ReferenceOur,
                ReferenceYour = i.ReferenceYour,
                DefaultDim2AccountId = i.DefaultDim2AccountId,
                DefaultDim3AccountId = i.DefaultDim3AccountId,
                DefaultDim4AccountId = i.DefaultDim4AccountId,
                DefaultDim5AccountId = i.DefaultDim5AccountId,
                DefaultDim6AccountId = i.DefaultDim6AccountId,
                OrderType = i.OrderType,
                VATTypeId = i.VatType,
                SysCurrencyId = i.Currency.SysCurrencyId,
                Status = i.Origin.Status,
                InternalText = i.Origin.Description,
                ModifiedBy = i.ModifiedBy,
                CreatedBy = i.CreatedBy,
                Modified = i.Modified,
                Created = i.Created,
            }).ToList();

            if (addInternalAccountNames)
                AddInternalAccounts(dtos, base.ActorCompanyId);

            if (originType == SoeOriginType.Order)
            {
                SetOrderTexts(dtos, true);
            }
            else if (originType == SoeOriginType.CustomerInvoice)
            {
                SetCustomerInvoiceTexts(dtos, true);
            }

            //Fix values and texts......
            var langId = base.GetLangId();
            var vatTypes = base.GetTermGroupDict(TermGroup.InvoiceVatType, langId);
            foreach (var dto in dtos)
            {
                dto.VATType = dto.VATTypeId != 0 ? vatTypes[dto.VATTypeId] : "";


                if (dto.OriginReadyUserCount == dto.OriginUserCount)
                {
                    dto.OrderReadyStatePercent = 100;
                }
                else if (dto.OriginReadyUserCount > 0 && dto.OriginUserCount > 0)
                {
                    dto.OrderReadyStatePercent = Convert.ToInt32(decimal.Divide(dto.OriginReadyUserCount, dto.OriginUserCount) * 100);
                }
            }

            if (setAddresses)
            {
                this.SetCustomerInvoiceAddresses(entities, dtos);
            }

            return dtos;
        }

        public List<SmallGenericType> GetOpenOrders()
        {
            List<SmallGenericType> orders = new List<SmallGenericType>();
            var statusList = string.Join(",", GetOrderStatusList(true, false).Select(x => x.ToString()));
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var items = entitiesReadOnly.GetCustomerOrders(base.ActorCompanyId, (int?)null, base.UserId, false, statusList, "", null).ToList();
            foreach (var item in items)
            {
                orders.Add(new SmallGenericType() { Id = item.InvoiceId, Name = item.InvoiceNr + " - " + item.ActorName });
            }
            return orders;
        }

        public IEnumerable<GetCustomerInvoices_Result> GetCustomerInvoices(SoeOriginStatusClassification classification, int originType, int customerId, bool loadOpen, bool loadClosed, bool onlyMine, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            entitiesReadOnly.Invoice.NoTracking();
            return this.GetCustomerInvoices(entitiesReadOnly, classification, originType, customerId, loadOpen, loadClosed, onlyMine, allItemsSelection);
        }

        public IEnumerable<GetCustomerInvoices_Result> GetCustomerInvoices(CompEntities entities, SoeOriginStatusClassification classification, int originType, int customerId, bool loadOpen, bool loadClosed, bool onlyMine, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection)
        {
            #region Prereq

            int? baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
            if (!baseSysCurrencyId.HasValue)
                baseSysCurrencyId = 0;
            bool hideVatWarning = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingHideVatWarnings, 0, base.ActorCompanyId, 0);
            bool closeInvoicesWhenTransferredToVoucher = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerCloseInvoicesWhenTransferredToVoucher, 0, base.ActorCompanyId, 0);
            bool hasCurrencyPermission = FeatureManager.HasRolePermission(Feature.Economy_Customer_Invoice_Status_Foreign, Permission.Readonly, base.RoleId, base.ActorCompanyId);

            DateTime? selectionDate = null;
            if (allItemsSelection.HasValue)
            {
                switch (allItemsSelection)
                {
                    case TermGroup_ChangeStatusGridAllItemsSelection.One_Month:
                        selectionDate = DateTime.Today.AddMonths(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Tree_Months:
                        selectionDate = DateTime.Today.AddMonths(-3);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Six_Months:
                        selectionDate = DateTime.Today.AddMonths(-6);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Twelve_Months:
                        selectionDate = DateTime.Today.AddYears(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.TwentyFour_Months:
                        selectionDate = DateTime.Today.AddYears(-2);
                        break;
                }
            }

            #endregion

            var invoices = entities.GetCustomerInvoices(base.ActorCompanyId, base.GetLangId(), originType, null, null, base.UserId, onlyMine, "").Where(i => i.IsInvoiceTemplate == false);

            switch (classification)
            {
                case SoeOriginStatusClassification.CustomerInvoicesAll:
                    #region Customer invoice

                    if (loadOpen && loadClosed)
                    {
                        //Load all invoices
                        invoices = (from i in invoices
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }
                    else if (loadClosed)
                    {
                        //Load only closed invoices
                        if (closeInvoicesWhenTransferredToVoucher)
                        {
                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                        (i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else
                        {
                            invoices = (from i in invoices
                                        where (i.Status == (int)SoeOriginStatus.Cancel || i.ExportStatus == (int)SoeInvoiceExportStatusType.ExportedAndClosed ||
                                     (i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                    }
                    else if (loadOpen)
                    {
                        //Load only open invoices
                        if (closeInvoicesWhenTransferredToVoucher)
                        {
                            invoices = (from i in invoices
                                        where (i.Status != (int)SoeOriginStatus.Cancel && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed &&
                                        !(i.FullyPayed == true && i.Status == (int)SoeOriginStatus.Voucher))
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                        else
                        {
                            invoices = (from i in invoices
                                        where (i.Status != (int)SoeOriginStatus.Cancel && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed &&
                                        !(i.FullyPayed == true && (i.Status == (int)SoeOriginStatus.Voucher || i.Status == (int)SoeOriginStatus.Origin)))
                                        orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                        select i);
                        }
                    }

                    #endregion
                    break;
                case SoeOriginStatusClassification.CustomerInvoicesInterest:
                    #region Customer invoice interest

                    invoices = (from i in invoices
                                where (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                (i.BillingTypeId != (int)TermGroup_BillingType.Credit) && i.FullyPayed == true
                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                select i);

                    #endregion
                    break;
                case SoeOriginStatusClassification.CustomerInvoicesReminder:
                    #region Customer invoice interest

                    invoices = (from i in invoices
                                where (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                 (i.BillingTypeId != (int)TermGroup_BillingType.Credit) && i.FullyPayed == false &&
                                 (i.InsecureDebt == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)
                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                select i);

                    #endregion
                    break;
                case SoeOriginStatusClassification.CustomerPaymentsUnpayed:
                    #region Customer invoice unpaid

                    invoices = (from i in invoices
                                where (i.RegistrationType == (int)OrderInvoiceRegistrationType.Ledger || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice) &&
                                (i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.Voucher) &&
                                (i.FullyPayed == false && i.ExportStatus != (int)SoeInvoiceExportStatusType.ExportedAndClosed)
                                orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                select i);

                    #endregion
                    break;
                case SoeOriginStatusClassification.OffersAll:
                    #region Offers all

                    if (loadOpen && loadClosed)
                    {
                        invoices = (from i in invoices
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }
                    else if (loadClosed)
                    {
                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.OfferFullyOrder || i.Status == (int)SoeOriginStatus.OfferFullyInvoice || i.Status == (int)SoeOriginStatus.OfferClosed || i.Status == (int)SoeOriginStatus.Cancel)
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }
                    else if (loadOpen)
                    {
                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.Draft || i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.OfferPartlyOrder || i.Status == (int)SoeOriginStatus.OfferPartlyInvoice)
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }

                    #endregion
                    break;
                case SoeOriginStatusClassification.OrdersAll:
                    #region Orders all

                    if (loadOpen && loadClosed)
                    {
                        invoices = (from i in invoices
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }
                    else if (loadClosed)
                    {
                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.OrderFullyInvoice || i.Status == (int)SoeOriginStatus.OrderClosed || i.Status == (int)SoeOriginStatus.Cancel)
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }
                    else if (loadOpen)
                    {
                        invoices = (from i in invoices
                                    where (i.Status == (int)SoeOriginStatus.Draft || i.Status == (int)SoeOriginStatus.Origin || i.Status == (int)SoeOriginStatus.OrderPartlyInvoice)
                                    orderby i.InvoiceSeqNr.HasValue, i.InvoiceSeqNr.HasValue ? i.InvoiceSeqNr.Value : 0
                                    select i);
                    }

                    #endregion
                    break;
                    //Add Contracts
            }

            //Filter on date
            if (selectionDate != null)
                invoices = invoices.Where(i => i.InvoiceDate == null || i.InvoiceDate >= selectionDate).ToList();

            //Filter currency
            if (!hasCurrencyPermission && baseSysCurrencyId != 0)
                invoices = invoices.Where(i => i.SysCurrencyId == baseSysCurrencyId);

            if (customerId != 0)
                invoices = invoices.Where(i => i.ActorId == customerId);
            return invoices;
        }

        public List<CustomerInvoice> GetCustomerInvoicesFromSelection(CompEntities entities, EvaluatedSelection es, bool includeDrafts, ref SoeOriginType originType, bool includeCancels)
        {
            var customerInvoices = new List<CustomerInvoice>();

            bool getOfferOrderAndInvoice = false;

            if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice, SoeReportTemplateType.BillingInvoiceInterest, SoeReportTemplateType.BillingInvoiceReminder) && !es.SB_ShowNotPrinted && !es.SB_ShowCopy)
            {
                //Show none
                return customerInvoices;
            }

            if (originType == SoeOriginType.None)
            {
                switch (es.ReportTemplateType)
                {
                    case SoeReportTemplateType.BillingOffer:
                        originType = SoeOriginType.Offer;
                        break;
                    case SoeReportTemplateType.BillingOrder:
                    case SoeReportTemplateType.ExpenseReport:
                    case SoeReportTemplateType.BillingOrderOverview:
                        originType = SoeOriginType.Order;
                        break;
                    case SoeReportTemplateType.BillingContract:
                        originType = SoeOriginType.Contract;
                        break;
                    case SoeReportTemplateType.BillingInvoice:
                    case SoeReportTemplateType.BillingInvoiceInterest:
                    case SoeReportTemplateType.BillingInvoiceReminder:
                        originType = SoeOriginType.CustomerInvoice;
                        break;
                    case SoeReportTemplateType.OriginStatisticsReport:
                        getOfferOrderAndInvoice = true;
                        break;
                }
            }

            if (originType == SoeOriginType.None && !getOfferOrderAndInvoice)
                return customerInvoices;

            int type = (int)originType;

            IQueryable<CustomerInvoice> query = (from i in entities.Invoice
                                           .Include("Origin")
                                           .Include("Actor.Customer")
                                                 where i.Origin.ActorCompanyId == es.ActorCompanyId
                                                 select i).OfType<CustomerInvoice>();

            if (!getOfferOrderAndInvoice)
            {
                //OriginType
                query = query.Where(i => i.Origin.Type == type);
                //InvoiceNr
                query = query.Where(i => (es.SB_HasInvoiceNrInterval == false || es.SB_InvoiceNrFrom.Length != es.SB_InvoiceNrTo.Length || (i.InvoiceNr.CompareTo(es.SB_InvoiceNrFrom) >= 0 && i.InvoiceNr.CompareTo(es.SB_InvoiceNrTo) <= 0)));
            }


            //InvoiceIds
            if (es.SB_HasInvoiceIds && es.SB_InvoiceIds.Count > 0 && es.SB_InvoiceIds.Count < 10)
            {
                query = query.Where(i => es.SB_InvoiceIds.Contains(i.InvoiceId));
            }
            else
            {
                if (es.SB_HasCustomerNrInterval || (!String.IsNullOrEmpty(es.SB_CustomerNrFrom) && !String.IsNullOrEmpty(es.SB_CustomerNrTo)))
                    query = query.Where(i => (i.Actor.Customer.CustomerNr.CompareTo(es.SB_CustomerNrFrom) >= 0 && i.Actor.Customer.CustomerNr.CompareTo(es.SB_CustomerNrTo) <= 0));

                if (es.SB_HasPaymentDateInterval)
                    query = query.Where(i => i.PaymentRow.Any(p => p.PayDate >= es.SB_PaymentDateFrom && p.PayDate <= es.SB_PaymentDateTo));
            }

            //Drafts
            if (!includeDrafts)
                query = query.Where(i => i.Origin.Status != (int)SoeOriginStatus.Draft);
            //Cancels
            if (!includeCancels)
                query = query.Where(i => i.Origin.Status != (int)SoeOriginStatus.Cancel);
            // IncludeClosedOrder
            if (!es.SB_IncludeClosedOrder)
                query = query.Where(i => i.Origin.Type != (int)SoeOriginType.Order || (i.Origin.Type == (int)SoeOriginType.Order && (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice)));

            //InvoiceDate
            if (es.HasDateInterval)
                query = query.Where(i => i.Origin.Invoice.InvoiceDate >= es.DateFrom && i.Origin.Invoice.InvoiceDate <= es.DateTo);

            if (!string.IsNullOrEmpty(es.SB_InvoiceNrFrom) && !string.IsNullOrEmpty(es.SB_InvoiceNrTo) && es.SB_InvoiceNrTo == es.SB_InvoiceNrFrom)
            {
                query = query.Where(i => i.InvoiceNr == es.SB_InvoiceNrFrom);
            }

            // Execute query
            entities.CommandTimeout = 600;
            customerInvoices = query.ToList();

            //InvoiceNr
            if (!String.IsNullOrEmpty(es.SB_InvoiceNrFrom) && !String.IsNullOrEmpty(es.SB_InvoiceNrTo))
                customerInvoices = customerInvoices.Where(i => Validator.ValidateStringInterval(i.InvoiceNr, es.SB_InvoiceNrFrom, es.SB_InvoiceNrTo)).ToList();
            //CustomerNr
            if (!String.IsNullOrEmpty(es.SB_CustomerNrFrom) && !String.IsNullOrEmpty(es.SB_CustomerNrTo))
                customerInvoices = customerInvoices.Where(i => Validator.ValidateStringInterval(i.Actor.Customer.CustomerNr, es.SB_CustomerNrFrom, es.SB_CustomerNrTo)).ToList();

            //InternalAccounts            
            if (es.SA_AccountIntervals != null)
            {
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
                bool validAccountInternalSelection = false;
                IEnumerable<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);
                int x = 0;
                foreach (var aDI in accountDimInternals)
                {
                    List<AccountIntervalDTO> dimSelection = (from ai in es.SA_AccountIntervals where ai.AccountDimId == aDI.AccountDimId select ai).ToList();
                    List<AccountInternal> accountInternals = AccountManager.GetAccountInternalsInInterval(entities, dimSelection, accountDimStd, es.ActorCompanyId, true, false, out validAccountInternalSelection);
                    List<int?> internalAccountIds = new List<int?>();
                    foreach (var ai in accountInternals) { internalAccountIds.Add(ai.AccountId); }
                    if (x == 0 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim2AccountId)).ToList(); }
                    if (x == 1 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim3AccountId)).ToList(); }
                    if (x == 2 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim4AccountId)).ToList(); }
                    if (x == 3 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim5AccountId)).ToList(); }
                    if (x == 4 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim6AccountId)).ToList(); }
                    x++;
                }

            }

            #region Copy/Printed

            if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice, SoeReportTemplateType.BillingInvoiceInterest, SoeReportTemplateType.BillingInvoiceReminder, SoeReportTemplateType.OriginStatisticsReport))
            {
                if ((es.SB_ShowNotPrinted && es.SB_ShowCopy) || getOfferOrderAndInvoice)
                {
                    //Show all
                }
                else if (es.SB_ShowNotPrinted)
                {
                    //Show only not printed
                    customerInvoices = customerInvoices.Where(i => i.BillingInvoicePrinted == false).ToList();
                }
                else if (es.SB_ShowCopy)
                {
                    //Show only printed
                    customerInvoices = customerInvoices.Where(i => i.BillingInvoicePrinted == true).ToList();
                }
            }

            #endregion

            #region SortOrder

            if (es.SB_SortOrder == (int)TermGroup_ReportBillingInvoiceSortOrder.CustomerNr || getOfferOrderAndInvoice)
                customerInvoices = customerInvoices.OrderBy(i => i.Actor == null ? String.Empty : i.Actor.Customer.CustomerNr).ToList();
            else if (es.SB_SortOrder == (int)TermGroup_ReportBillingInvoiceSortOrder.InvoiceNr)
                customerInvoices = customerInvoices.OrderBy(i => i.InvoiceNr).ToList();

            #endregion

            var evaluatedItems = new List<CustomerInvoice>();

            foreach (var customerInvoice in customerInvoices)
            {
                bool valid = false;

                #region InvoiceIdList

                if (es.SB_HasInvoiceIds)
                {
                    //Validate each item against the list of InvoiceId
                    valid = es.SB_InvoiceIds.Any(invoiceId => invoiceId == customerInvoice.InvoiceId);
                }
                else
                {
                    valid = true;
                }

                if (!valid)
                    continue;

                #endregion

                #region CustomerGroup

                if (!String.IsNullOrEmpty(es.SB_CustomerGroupId.ToString()) && es.SB_CustomerGroupId > 0)
                {
                    List<CompanyCategoryRecord> categoryRecords = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Customer, SoeCategoryRecordEntity.Customer, customerInvoice.Actor.Customer.ActorCustomerId, es.ActorCompanyId);
                    if (!categoryRecords.Any(i => i.CategoryId == es.SB_CustomerGroupId))
                        continue;
                }

                #endregion

                #region Load Invoice

                var invoice = customerInvoice as Invoice;

                if (!invoice.OriginReference.IsLoaded)
                    invoice.OriginReference.Load();
                if (!invoice.CurrencyReference.IsLoaded)
                    invoice.CurrencyReference.Load();
                if (!invoice.ActorReference.IsLoaded)
                    invoice.ActorReference.Load();
                if (invoice.Actor != null)
                {
                    if (!invoice.Actor.CustomerReference.IsLoaded)
                        invoice.Actor.CustomerReference.Load();
                    if (!invoice.Actor.Contact.IsLoaded)
                        invoice.Actor.Contact.Load();
                }

                #endregion

                #region  Load Project

                if (!invoice.ProjectReference.IsLoaded)
                    invoice.ProjectReference.Load();

                #endregion

                #region Load CustomerInvoice

                //DeliveryCondition
                if (!customerInvoice.DeliveryConditionReference.IsLoaded)
                    customerInvoice.DeliveryConditionReference.Load();

                //DeliveryType
                if (!customerInvoice.DeliveryTypeReference.IsLoaded)
                    customerInvoice.DeliveryTypeReference.Load();

                //PaymentCondition
                if (!customerInvoice.PaymentConditionReference.IsLoaded)
                    customerInvoice.PaymentConditionReference.Load();

                //CustomerInvoiceInterestOrigin
                if (!customerInvoice.CustomerInvoiceInterestOrigin.IsLoaded)
                    customerInvoice.CustomerInvoiceInterestOrigin.Load();

                //CustomerInvoiceReminderOrigin
                if (!customerInvoice.CustomerInvoiceReminderOrigin.IsLoaded)
                    customerInvoice.CustomerInvoiceReminderOrigin.Load();

                LoadCustomerInvoiceRows(customerInvoice, true, true, false);

                #endregion

                evaluatedItems.Add(customerInvoice);
            }

            return evaluatedItems;
        }

        public List<CustomerInvoice> GetCustomerInvoicesFromSelection(CompEntities entities, CreateReportResult reportResult, BillingReportParamsDTO reportParams, bool includeDrafts, ref SoeOriginType originType, bool includeCancels, bool loadInvoiceRows = true, bool loadInvoiceAccountRow = true)
        {
            var customerInvoices = new List<CustomerInvoice>();

            bool getOfferOrderAndInvoice = false;

            if (reportResult.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice, SoeReportTemplateType.BillingInvoiceInterest, SoeReportTemplateType.BillingInvoiceReminder) && !reportParams.SB_ShowNotPrinted && !reportParams.SB_ShowCopy)
            {
                //Show none
                return customerInvoices;
            }

            if (originType == SoeOriginType.None)
            {
                switch (reportResult.ReportTemplateType)
                {
                    case SoeReportTemplateType.BillingOffer:
                        originType = SoeOriginType.Offer;
                        break;
                    case SoeReportTemplateType.BillingOrder:
                    case SoeReportTemplateType.ExpenseReport:
                    case SoeReportTemplateType.BillingOrderOverview:
                        originType = SoeOriginType.Order;
                        break;
                    case SoeReportTemplateType.BillingContract:
                        originType = SoeOriginType.Contract;
                        break;
                    case SoeReportTemplateType.BillingInvoice:
                    case SoeReportTemplateType.BillingInvoiceInterest:
                    case SoeReportTemplateType.BillingInvoiceReminder:
                        originType = SoeOriginType.CustomerInvoice;
                        break;
                    case SoeReportTemplateType.OriginStatisticsReport:
                        getOfferOrderAndInvoice = true;
                        break;
                }
            }

            if (originType == SoeOriginType.None && !getOfferOrderAndInvoice)
                return customerInvoices;

            int type = (int)originType;

            IQueryable<CustomerInvoice> query = (from i in entities.Invoice
                                                    .Include("Origin")
                                                    .Include("Actor.Customer")
                                                    .Include("Currency")
                                                 where i.Origin.ActorCompanyId == reportResult.ActorCompanyId
                                                 select i).OfType<CustomerInvoice>();

            if (reportParams.SB_SortOrder == (int)TermGroup_ReportBillingInvoiceSortOrder.ProjectNr || loadInvoiceRows)
                query = query.Include("Project");

            if (!getOfferOrderAndInvoice)
            {
                //OriginType
                query = query.Where(i => i.Origin.Type == type);
                //InvoiceNr
                query = query.Where(i => (reportParams.SB_HasInvoiceNrInterval == false || reportParams.SB_InvoiceNrFrom.Length != reportParams.SB_InvoiceNrTo.Length || (i.InvoiceNr.CompareTo(reportParams.SB_InvoiceNrFrom) >= 0 && i.InvoiceNr.CompareTo(reportParams.SB_InvoiceNrTo) <= 0)));
            }

            //InvoiceIds
            if (reportParams.SB_HasInvoiceIds && reportParams.SB_InvoiceIds.Count > 0 && reportParams.SB_InvoiceIds.Count < 10)
            {
                query = query.Where(i => reportParams.SB_InvoiceIds.Contains(i.InvoiceId));
            }
            else
            {
                if (reportParams.SB_HasCustomerNrInterval || (!String.IsNullOrEmpty(reportParams.SB_CustomerNrFrom) && !String.IsNullOrEmpty(reportParams.SB_CustomerNrTo)))
                    query = query.Where(i => (i.Actor.Customer.CustomerNr.CompareTo(reportParams.SB_CustomerNrFrom) >= 0 && i.Actor.Customer.CustomerNr.CompareTo(reportParams.SB_CustomerNrTo) <= 0));

                if (reportParams.SB_HasPaymentDateInterval)
                    query = query.Where(i => i.PaymentRow.Any(p => p.PayDate >= reportParams.SB_PaymentDateFrom && p.PayDate <= reportParams.SB_PaymentDateTo));
            }

            //ProjectIds
            if (!reportParams.SP_ProjectIds.IsNullOrEmpty())
            {
                query = query.Where(i => reportParams.SP_ProjectIds.Contains(i.ProjectId ?? 0));
            }

            //Drafts
            if (!includeDrafts)
                query = query.Where(i => i.Origin.Status != (int)SoeOriginStatus.Draft);
            //Cancels
            if (!includeCancels)
                query = query.Where(i => i.Origin.Status != (int)SoeOriginStatus.Cancel);

            // IncludeClosedOrder
            if (!reportParams.SB_IncludeClosedOrder && !reportParams.SB_IncludeInvoicedOrders)
                query = query.Where(i => i.Origin.Type != (int)SoeOriginType.Order || (i.Origin.Type == (int)SoeOriginType.Order && (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice)));

            // IncludeInvoicedOrder
            if (reportParams.SB_IncludeInvoicedOrders)
            {
                query = query.Where(i => i.Origin.Type != (int)SoeOriginType.Order || (i.Origin.Type == (int)SoeOriginType.Order && (i.Origin.Status == (int)SoeOriginStatus.Draft || i.Origin.Status == (int)SoeOriginStatus.Origin || i.Origin.Status == (int)SoeOriginStatus.OrderFullyInvoice || i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice)));
            }

            //InvoiceDate
            if (reportParams.HasDateInterval)
            {
                switch (reportParams.SB_DateRegard)
                {
                    case (int)TermGroup_ReportBillingDateRegard.OrderDate:
                        query = query.Where(i => i.Origin.Invoice.InvoiceDate >= reportParams.DateFrom && i.Origin.Invoice.InvoiceDate <= reportParams.DateTo);
                        break;
                    case (int)TermGroup_ReportBillingDateRegard.DeliveryDate:
                        query = query.Where(i => i.DeliveryDate.HasValue && i.DeliveryDate >= reportParams.DateFrom && i.DeliveryDate <= reportParams.DateTo);
                        break;
                    default:
                        query = query.Where(i => i.Origin.Invoice.InvoiceDate >= reportParams.DateFrom && i.Origin.Invoice.InvoiceDate <= reportParams.DateTo);
                        break;
                }
            }

            //CreateDate
            if (reportParams.HasCreateDateInterval)
            {
                reportParams.SB_CreateDateTo = CalendarUtility.GetEndOfDay(reportParams.SB_CreateDateTo);
                query = query.Where(i => (i.Origin.Created.Value >= reportParams.SB_CreateDateFrom) && (i.Origin.Created.Value <= reportParams.SB_CreateDateTo));
            }

            if (!string.IsNullOrEmpty(reportParams.SB_InvoiceNrFrom) && !string.IsNullOrEmpty(reportParams.SB_InvoiceNrTo) && reportParams.SB_InvoiceNrTo == reportParams.SB_InvoiceNrFrom)
            {
                query = query.Where(i => i.InvoiceNr == reportParams.SB_InvoiceNrFrom);
            }

            // Execute query
            entities.CommandTimeout = 600;
            customerInvoices = query.ToList();

            //InvoiceNr
            if (!String.IsNullOrEmpty(reportParams.SB_InvoiceNrFrom) && !String.IsNullOrEmpty(reportParams.SB_InvoiceNrTo))
                customerInvoices = customerInvoices.Where(i => Validator.ValidateStringInterval(i.InvoiceNr, reportParams.SB_InvoiceNrFrom, reportParams.SB_InvoiceNrTo)).ToList();

            //CustomerNr
            if (!String.IsNullOrEmpty(reportParams.SB_CustomerNrFrom) && !String.IsNullOrEmpty(reportParams.SB_CustomerNrTo))
                customerInvoices = customerInvoices.Where(i => Validator.ValidateStringInterval(i.Actor.Customer.CustomerNr, reportParams.SB_CustomerNrFrom, reportParams.SB_CustomerNrTo)).ToList();

            //InternalAccounts            
            if (reportParams.SA_HasAccountInterval)
            {
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
                bool validAccountInternalSelection = false;
                IEnumerable<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);
                int x = 0;
                foreach (var aDI in accountDimInternals)
                {
                    List<AccountIntervalDTO> dimSelection = (from ai in reportParams.SA_AccountIntervals where ai.AccountDimId == aDI.AccountDimId select ai).ToList();
                    List<AccountInternal> accountInternals = AccountManager.GetAccountInternalsInInterval(entities, dimSelection, accountDimStd, reportResult.ActorCompanyId, true, false, out validAccountInternalSelection);
                    List<int?> internalAccountIds = new List<int?>();
                    foreach (var ai in accountInternals) { internalAccountIds.Add(ai.AccountId); }
                    if (x == 0 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim2AccountId)).ToList(); }
                    if (x == 1 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim3AccountId)).ToList(); }
                    if (x == 2 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim4AccountId)).ToList(); }
                    if (x == 3 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim5AccountId)).ToList(); }
                    if (x == 4 && internalAccountIds.Count > 0) { customerInvoices = customerInvoices.Where(i => internalAccountIds.Contains(i.Origin.Invoice.DefaultDim6AccountId)).ToList(); }
                    x++;
                }

            }

            #region Copy/Printed

            if (reportResult.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice, SoeReportTemplateType.BillingInvoiceInterest, SoeReportTemplateType.BillingInvoiceReminder, SoeReportTemplateType.OriginStatisticsReport))
            {
                if ((reportParams.SB_ShowNotPrinted && reportParams.SB_ShowCopy) || getOfferOrderAndInvoice)
                {
                    //Show all
                }
                else if (reportParams.SB_ShowNotPrinted)
                {
                    //Show only not printed
                    customerInvoices = customerInvoices.Where(i => i.BillingInvoicePrinted == false).ToList();
                }
                else if (reportParams.SB_ShowCopy)
                {
                    //Show only printed
                    customerInvoices = customerInvoices.Where(i => i.BillingInvoicePrinted == true).ToList();
                }
            }

            #endregion

            #region SortOrder

            if (reportParams.SB_SortOrder == (int)TermGroup_ReportBillingInvoiceSortOrder.CustomerNr || getOfferOrderAndInvoice)
                customerInvoices = customerInvoices.OrderBy(i => i.Actor == null ? string.Empty : i.Actor.Customer.CustomerNr).ToList();
            else if (reportParams.SB_SortOrder == (int)TermGroup_ReportBillingInvoiceSortOrder.InvoiceNr)
                customerInvoices = customerInvoices.OrderBy(i => i.InvoiceNr).ToList();
            else if (reportParams.SB_SortOrder == (int)TermGroup_ReportBillingInvoiceSortOrder.ProjectNr)
                customerInvoices = customerInvoices.OrderBy(i => i.Project == null ? string.Empty : i.Project.Number).ToList();
            else // Defaulting to sort by invoicenr
                customerInvoices = customerInvoices.OrderBy(i => i.InvoiceNr).ToList();

            #endregion

            var evaluatedItems = new List<CustomerInvoice>();

            if (loadInvoiceRows)
            {
                foreach (var customerInvoice in customerInvoices)
                {
                    bool valid = false;

                    #region InvoiceIdList

                    if (reportParams.SB_HasInvoiceIds)
                    {
                        //Validate each item against the list of InvoiceId
                        valid = reportParams.SB_InvoiceIds.Any(invoiceId => invoiceId == customerInvoice.InvoiceId);
                    }
                    else
                    {
                        valid = true;
                    }

                    if (!valid)
                        continue;

                    #endregion

                    #region CustomerGroup

                    if (!string.IsNullOrEmpty(reportParams.SB_CustomerGroupId.ToString()) && reportParams.SB_CustomerGroupId > 0)
                    {
                        List<CompanyCategoryRecord> categoryRecords = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Customer, SoeCategoryRecordEntity.Customer, customerInvoice.Actor.Customer.ActorCustomerId, reportResult.ActorCompanyId);
                        if (!categoryRecords.Any(i => i.CategoryId == reportParams.SB_CustomerGroupId))
                            continue;
                    }

                    #endregion

                    #region Load Invoice

                    var invoice = customerInvoice as Invoice;

                    if (!invoice.OriginReference.IsLoaded)
                        invoice.OriginReference.Load();

                    if (!invoice.CurrencyReference.IsLoaded)
                        invoice.CurrencyReference.Load();

                    if (!invoice.ActorReference.IsLoaded)
                        invoice.ActorReference.Load();

                    if (invoice.Actor != null)
                    {
                        if (!invoice.Actor.CustomerReference.IsLoaded)
                            invoice.Actor.CustomerReference.Load();
                        if (!invoice.Actor.Contact.IsLoaded)
                            invoice.Actor.Contact.Load();
                    }

                    #endregion

                    #region Load CustomerInvoice

                    //DeliveryCondition
                    if (!customerInvoice.DeliveryConditionReference.IsLoaded)
                        customerInvoice.DeliveryConditionReference.Load();

                    //DeliveryType
                    if (!customerInvoice.DeliveryTypeReference.IsLoaded)
                        customerInvoice.DeliveryTypeReference.Load();

                    //PaymentCondition
                    if (!customerInvoice.PaymentConditionReference.IsLoaded)
                        customerInvoice.PaymentConditionReference.Load();

                    //CustomerInvoiceInterestOrigin
                    if (!customerInvoice.CustomerInvoiceInterestOrigin.IsLoaded)
                        customerInvoice.CustomerInvoiceInterestOrigin.Load();

                    //CustomerInvoiceReminderOrigin
                    if (!customerInvoice.CustomerInvoiceReminderOrigin.IsLoaded)
                        customerInvoice.CustomerInvoiceReminderOrigin.Load();

                    LoadCustomerInvoiceRows(customerInvoice, true, loadInvoiceAccountRow, false);

                    #endregion

                    evaluatedItems.Add(customerInvoice);
                }
            }
            else
            {
                evaluatedItems = customerInvoices;
            }

            return evaluatedItems;
        }

        public List<CustomerInvoice> GetCustomerInvoicesWithRemainingTime(int actorCompanyId, DateTime startDate)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return (from i in entities.Invoice.OfType<CustomerInvoice>()
                    where (i.PlannedStartDate != null && i.PlannedStartDate < startDate) &&
                    (i.RemainingTime > 0) &&
                    i.State == (int)SoeEntityState.Active
                    select i).ToList();
        }

        public static Dictionary<int, string> GetCustomerInvoicesDict(List<CustomerInvoice> customerInvoices)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();

            if (customerInvoices == null)
                return dict;

            foreach (CustomerInvoice customerInvoice in customerInvoices)
            {
                if (!dict.ContainsKey(customerInvoice.InvoiceId))
                    dict.Add(customerInvoice.InvoiceId, customerInvoice.InvoiceNr);
            }

            return dict;
        }

        public IQueryable<CustomerInvoice> GetSimpleCustomerInvoiceQuery(CompEntities entities, SoeOriginType originType)
        {
            return (from i in entities.Invoice.OfType<CustomerInvoice>()
                    where
                        i.State == (int)SoeEntityState.Active &&
                        i.Origin.ActorCompanyId == ActorCompanyId &&
                        i.Origin.Type == (int)originType
                    select i);
        }


        private IQueryable<CustomerInvoice> GetCustomerInvoiceQuery(
            CompEntities entities,
            bool loadOrigin = false,
            bool loadActor = false,
            bool loadVoucher = false,
            bool loadVoucherSeries = false,
            bool loadDeliveryTypeAndCondition = false,
            bool loadPaymentCondition = false,
            bool loadInterestAndReminder = false,
            bool loadProject = false,
            bool loadInvoiceAccountRow = false,
            bool loadOriginInvoiceMapping = false,
            bool loadInvoiceMapping = false,
            bool loadContractGroup = false)
        {
            // Always load Origin and Currency. Flag loadOrigin determines if entities related to Origin should be loaded
            IQueryable<CustomerInvoice> query = entities.Invoice.OfType<CustomerInvoice>();

            query = query.Include("Origin.OriginUser.User").Include("Currency");

            if (loadOrigin)
            {
                query = query.Include("Origin.VoucherSeries");
                query = query.Include("Origin.Company");
            }
            if (loadActor)
            {
                query = query.Include("Actor.Supplier");
                query = query.Include("Actor.Customer");
                query = query.Include("Actor.Contact");
            }
            if (loadVoucher)
            {
                query = query.Include("VoucherHead.VoucherRow");
                if (loadVoucherSeries)
                    query = query.Include("VoucherHead.VoucherSeries.VoucherSeriesType");
            }
            if (loadDeliveryTypeAndCondition)
            {
                query = query.Include("DeliveryType");
                query = query.Include("DeliveryCondition");
            }
            if (loadPaymentCondition)
            {
                query = query.Include("PaymentCondition");
            }
            if (loadInterestAndReminder)
            {
                query = query.Include("CustomerInvoiceInterestOrigin");
                query = query.Include("CustomerInvoiceReminderOrigin");
            }
            if (loadProject)
            {
                query = query.Include("Project");
            }
            if (loadInvoiceAccountRow)
            {
                query.Include("CustomerInvoiceRow.CustomerInvoiceAccountRow");
            }
            if (loadOriginInvoiceMapping)
            {
                query = query.Include("OriginInvoiceMapping");
            }
            if (loadInvoiceMapping)
            {
                query = query.Include("InvoiceMapping");
                query = query.Include("InvoiceMapping1");
            }
            if (loadInvoiceMapping)
            {
                query = query.Include("InvoiceAttachment");
            }
            if (loadContractGroup)
            {
                query = query.Include("ContractGroup");
            }

            return query;
        }

        public CustomerInvoice GetCustomerInvoice(int invoiceId, bool loadOrigin = false, bool loadActor = false, bool loadVoucher = false, bool loadVoucherSeries = false, bool loadDeliveryTypeAndCondition = false, bool loadPaymentCondition = false, bool loadInterestAndReminder = false, bool loadInvoiceRow = false, bool loadInvoiceAccountRow = false, bool loadCustomerIsBlocked = false, bool loadTimeCodeTransaction = false, bool loadProject = false, bool loadOriginInvoiceMapping = false, bool loadInvoiceAttachments = false, bool loadIntrastatTransaction = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Invoice.NoTracking();
            return GetCustomerInvoice(entities, invoiceId, loadOrigin, loadActor, loadVoucher, loadVoucherSeries, loadDeliveryTypeAndCondition, loadPaymentCondition, loadInterestAndReminder, loadInvoiceRow, loadInvoiceAccountRow, loadCustomerIsBlocked, loadTimeCodeTransaction, loadProject, loadOriginInvoiceMapping, loadInvoiceAttachments, loadIntrastatTransaction);
        }

        public CustomerInvoice GetCustomerInvoice(CompEntities entities, int invoiceId, bool loadOrigin = false, bool loadActor = false, bool loadVoucher = false, bool loadVoucherSeries = false, bool loadDeliveryTypeAndCondition = false, bool loadPaymentCondition = false, bool loadInterestAndReminder = false, bool loadInvoiceRow = false, bool loadInvoiceAccountRow = false, bool loadCustomerIsBlocked = false, bool loadTimeCodeTransaction = false, bool loadProject = false, bool loadOriginInvoiceMapping = false, bool loadInvoiceMapping = false, bool loadInvoiceAttachments = false, bool loadIntrastatTransaction = false, bool loadContractGroup = false)
        {
            if (invoiceId == 0)
                return null;

            IQueryable<CustomerInvoice> query = GetCustomerInvoiceQuery(entities, loadOrigin, loadActor, loadVoucher, loadVoucherSeries, loadDeliveryTypeAndCondition, loadPaymentCondition, loadInterestAndReminder, loadProject, false, loadOriginInvoiceMapping, loadInvoiceMapping, loadContractGroup);

            //if (loadInvoiceRow)
            //    LoadCustomerInvoiceRowsToQuery(query, loadInterestAndReminder, loadInvoiceAccountRow, loadTimeCodeTransaction, loadIntrastatTransaction);

            CustomerInvoice invoice = (from i in query
                                       where i.InvoiceId == invoiceId &&
                                       i.State == (int)SoeEntityState.Active
                                       select i).FirstOrDefault();

            if (invoice == null || invoice.Origin.ActorCompanyId != ActorCompanyId)
                return null;

            // Set StatusName
            if (invoice.Origin != null)
                invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);

            if (loadInvoiceRow)
                LoadCustomerInvoiceRows(invoice, loadInterestAndReminder, loadInvoiceAccountRow, loadTimeCodeTransaction, loadIntrastatTransaction);

            #region Blocked

            if (loadCustomerIsBlocked)
                CreateCustomerBlockNote(entities, invoice, invoiceId, loadActor);

            #endregion

            return invoice;
        }

        public List<CustomerInvoice> GetCustomerInvoices(CompEntities entities, List<int> invoiceIds, bool loadOrigin = false, bool loadActor = false, bool loadVoucher = false, bool loadVoucherSeries = false, bool loadDeliveryTypeAndCondition = false, bool loadPaymentCondition = false, bool loadInterestAndReminder = false, bool loadInvoiceRow = false, bool loadInvoiceAccountRow = false, bool loadTimeCodeTransaction = false, bool loadProject = false, bool loadOriginInvoiceMapping = false, bool loadInvoiceMapping = false, bool loadInvoiceAttachments = false, bool loadIntrastatTransaction = false)
        {
            if (!invoiceIds.Any())
                return new List<CustomerInvoice>();

            IQueryable<CustomerInvoice> query = GetCustomerInvoiceQuery(entities, loadOrigin, loadActor, loadVoucher, loadVoucherSeries, loadDeliveryTypeAndCondition, loadPaymentCondition, loadInterestAndReminder, loadProject, false, loadOriginInvoiceMapping, loadInvoiceMapping);

            List<CustomerInvoice> invoices = (from i in query
                                              where invoiceIds.Contains(i.InvoiceId) &&
                                              i.Origin.ActorCompanyId == ActorCompanyId &&
                                              i.State == (int)SoeEntityState.Active
                                              select i).ToList();

            var originStatuses = GetTermGroupDict(TermGroup.OriginStatus);
            invoices.ForEach(i =>
            {
                if (originStatuses.ContainsKey(i.Origin.Status))
                    i.StatusName = originStatuses[i.Origin.Status];
            });


            return invoices;
        }

        private void CreateCustomerBlockNote(CompEntities entities, CustomerInvoice customerInvoice, int invoiceId, bool loadActor)
        {
            bool isBlocked = false;

            if (!loadActor)
            {
                isBlocked = (from i in entities.Invoice.OfType<CustomerInvoice>()
                             where i.InvoiceId == invoiceId &&
                             (i.Actor.Customer.BlockInvoice || i.Actor.Customer.BlockOrder) &&
                             (i.RegistrationType == (int)OrderInvoiceRegistrationType.Order || i.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice || i.RegistrationType == (int)OrderInvoiceRegistrationType.Offer)
                             select i).Any();
            }
            else if (customerInvoice != null && customerInvoice.Actor != null && customerInvoice.Actor.Customer != null)
            {
                isBlocked = ((customerInvoice.Actor.Customer.BlockInvoice || customerInvoice.Actor.Customer.BlockOrder) && (customerInvoice.RegistrationType == (int)OrderInvoiceRegistrationType.Order || customerInvoice.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice || customerInvoice.RegistrationType == (int)OrderInvoiceRegistrationType.Offer));
            }

            if (isBlocked)
            {
                Customer customer = null;
                if (customerInvoice.Actor != null)
                    customer = customerInvoice.Actor.Customer;
                if (customer == null)
                {
                    customer = (from i in entities.Invoice.OfType<CustomerInvoice>()
                                where i.InvoiceId == invoiceId
                                select i.Actor.Customer).FirstOrDefault();
                }

                string blockNote = string.Empty;
                if (customer != null)
                {
                    if (customer.BlockInvoice && customerInvoice.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice)
                        blockNote = GetText(8309, "Kunden är spärrad för fakturering.") + Environment.NewLine;
                    else if (customer.BlockOrder && customerInvoice.RegistrationType != (int)OrderInvoiceRegistrationType.Invoice)
                        blockNote = GetText(8310, "Kunden är spärrad.") + Environment.NewLine;
                }

                if (!String.IsNullOrEmpty(blockNote))
                {
                    if (customer != null && !String.IsNullOrEmpty(customer.BlockNote))
                        blockNote += GetText(8311, "Kommentar:") + customer.BlockNote;

                    customerInvoice.CustomerBlockNote = blockNote;
                }
            }
        }

        public CustomerInvoice GetCustomerInvoiceByType(
            CompEntities entities,
            int invoiceId,
            SoeOriginType originType,
            OrderInvoiceRegistrationType registrationType,
            int actorCompanyId,
            bool loadDeliveryTypeAndCondition = false,
            bool loadPaymentCondition = false,
            bool loadInterestAndReminder = false,
            bool loadInvoiceRow = false,
            bool loadInvoiceAccountRow = false,
            bool loadTimeCodeTransaction = false,
            bool loadProject = false)
        {
            IQueryable<CustomerInvoice> query = GetCustomerInvoiceQuery(
                entities,
                false,
                true,
                false,
                false,
                loadDeliveryTypeAndCondition,
                loadPaymentCondition,
                loadInterestAndReminder,
                loadProject);

            CustomerInvoice invoice = (from i in query
                                       where i.InvoiceId == invoiceId &&
                                       i.Origin.ActorCompanyId == actorCompanyId &&
                                       i.Origin.Type == (int)originType &&
                                       i.RegistrationType == (int)registrationType
                                       select i).OfType<CustomerInvoice>().FirstOrDefault();

            if (invoice != null)
            {
                // Set StatusName
                if (invoice.Origin != null)
                    invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);

                if (loadInvoiceRow)
                    LoadCustomerInvoiceRows(invoice, loadInterestAndReminder, loadInvoiceAccountRow, loadTimeCodeTransaction);
            }

            return invoice;
        }

        public CustomerInvoice GetCustomerInvoiceByNr(CompEntities entities, string invoiceNr, SoeOriginType originType, OrderInvoiceRegistrationType registrationType, int actorCompanyId, bool skipClosed = false)
        {
            IQueryable<CustomerInvoice> query = entities.Invoice.OfType<CustomerInvoice>().Include("Origin");

            if (originType == SoeOriginType.Order)
            {
                query.Include("CustomerInvoiceRow.CustomerInvoiceAccountRow");
            }

            query = from i in query
                    where i.InvoiceNr == invoiceNr &&
                    i.Origin.ActorCompanyId == actorCompanyId &&
                    i.Origin.Type == (int)originType &&
                    i.RegistrationType == (int)registrationType &&
                    i.State == (int)SoeEntityState.Active
                    select i;

            if (skipClosed)
                query = query.Where(a => a.Origin.Status != (int)SoeOriginStatus.OrderClosed && a.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice);

            return query.FirstOrDefault();
        }

        public List<CustomerInvoice> GetCustomerInvoicesByNr(CompEntities entities, string invoiceNr, SoeOriginType originType, OrderInvoiceRegistrationType registrationType, int actorCompanyId, bool skipClosed = false)
        {
            IQueryable<CustomerInvoice> query = entities.Invoice.OfType<CustomerInvoice>().Include("Origin");

            if (originType == SoeOriginType.Order)
            {
                query.Include("CustomerInvoiceRow.CustomerInvoiceAccountRow");
            }

            query = from i in query
                    where i.InvoiceNr == invoiceNr &&
                    i.Origin.ActorCompanyId == actorCompanyId &&
                    i.Origin.Type == (int)originType &&
                    i.RegistrationType == (int)registrationType &&
                    i.State == (int)SoeEntityState.Active
                    select i;

            if (skipClosed)
                query = query.Where(a => a.Origin.Status != (int)SoeOriginStatus.OrderClosed && a.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice);

            return query.ToList();
        }

        public List<int> GetCustomerInvoiceIdsByExternalId(CompEntities entities, int actorCompanyId, string externalId, SoeOriginType originType)
        {
            return (from i in entities.Invoice.OfType<CustomerInvoice>().Include("Origin")
                    where i.ExternalId == externalId &&
                    i.Origin.ActorCompanyId == actorCompanyId &&
                    i.Origin.Type == (int)originType &&
                    i.State == (int)SoeEntityState.Active
                    select i.InvoiceId).ToList();
        }

        public List<Invoice> GetCustomerInvoiceByExternalId(CompEntities entities, int actorCompanyId, string externalId, SoeOriginType originType)
        {
            return (from i in entities.Invoice.Include("Origin")
                    where i.ExternalId == externalId &&
                    i.Origin.ActorCompanyId == actorCompanyId &&
                    i.Origin.Type == (int)originType &&
                    i.State == (int)SoeEntityState.Active
                    select i).ToList();
        }

        public CustomerInvoice GetCustomerInvoiceAndProject(CompEntities entities, int invoiceId, bool loadCustomer = false)
        {
            IQueryable<CustomerInvoice> query = entities.Invoice.OfType<CustomerInvoice>().Include("Project");
            if (loadCustomer)
                query = query.Include("Actor.Customer");

            return (from i in query
                    where i.InvoiceId == invoiceId &&
                    i.State == (int)SoeEntityState.Active
                    select i).FirstOrDefault();
        }

        public CustomerInvoice GetCustomerInvoiceAndRows(CompEntities entities, int invoiceId, bool loadAccountRows = false, bool loadAccounts = false)
        {
            CustomerInvoice customerInvoice = (from i in entities.Invoice.Include("CustomerInvoiceRow")
                                               where i.InvoiceId == invoiceId &&
                                               i.State == (int)SoeEntityState.Active
                                               select i).OfType<CustomerInvoice>().FirstOrDefault();

            if (customerInvoice != null && loadAccountRows)
            {
                //Include of 2 n-relations causing performance issues, load second relation one at the time instead
                foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoice.CustomerInvoiceRow)
                {
                    if (!customerInvoiceRow.CustomerInvoiceAccountRowIsLoaded)
                        customerInvoiceRow.LoadCustomerInvoiceAccountRow();

                    if (loadAccounts)
                    {
                        foreach (CustomerInvoiceAccountRow customerInvoiceAccountRow in customerInvoiceRow.CustomerInvoiceAccountRow)
                        {
                            // AccountStd
                            if (!customerInvoiceAccountRow.AccountStdReference.IsLoaded)
                                customerInvoiceAccountRow.AccountStdReference.Load();
                            if (customerInvoiceAccountRow.AccountStd != null)
                            {
                                if (!customerInvoiceAccountRow.AccountStd.AccountReference.IsLoaded)
                                    customerInvoiceAccountRow.AccountStd.AccountReference.Load();
                                if (!customerInvoiceAccountRow.AccountStd.AccountBalance.IsLoaded)
                                    customerInvoiceAccountRow.AccountStd.AccountBalance.Load();
                            }

                            // AccountInternal
                            if (!customerInvoiceAccountRow.AccountInternal.IsLoaded)
                                customerInvoiceAccountRow.AccountInternal.Load();

                            foreach (AccountInternal accountInternal in customerInvoiceAccountRow.AccountInternal)
                            {
                                if (!accountInternal.AccountReference.IsLoaded)
                                    accountInternal.AccountReference.Load();
                                if (!accountInternal.Account.AccountDimReference.IsLoaded)
                                    accountInternal.Account.AccountDimReference.Load();
                            }
                        }
                    }
                }
            }

            return customerInvoice;
        }

        public OrderDTO GetOrder(int invoiceId, bool loadCategories, bool loadRows, int actorCompanyId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            IQueryable<CustomerInvoice> query = entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                .Include("Origin")
                .Include("Origin.OriginUser.User")
                .Include("Project")
                .Include("InvoiceMapping1.Invoice.Origin")
                .Include("InvoiceMapping1.invoice.Actor.Customer")
                .Include("InvoiceMapping");

            if (loadRows)
                query = query.Include("CustomerInvoiceRow.HouseholdTaxDeductionRow").Include("CustomerInvoiceRow.Stock").Include("CustomerInvoiceRow.Product");

            CustomerInvoice invoice = (from i in query
                                       where i.InvoiceId == invoiceId &&
                                       i.State == (int)SoeEntityState.Active
                                       select i).FirstOrDefault();

            if (invoice == null || invoice.Origin.ActorCompanyId != actorCompanyId)
                return null;


            // Set StatusName
            var originType = SoeOriginType.None;
            if (invoice.Origin != null)
            {
                originType = (SoeOriginType)invoice.Origin.Type;
                if (invoice.Origin.Type == (int)SoeOriginType.Contract && invoice.Origin.Status == (int)SoeOriginStatus.Origin)
                    invoice.StatusName = GetText(98, "Aktivt");
                else
                    invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);
            }

            if (loadCategories)
            {
                switch (invoice.Origin.Type)
                {
                    case (int)SoeOriginType.Order:
                        invoice.CategoryIds = (from c in entitiesReadOnly.CompanyCategoryRecord
                                               where c.RecordId == invoiceId &&
                                               c.Entity == (int)SoeCategoryRecordEntity.Order &&
                                               c.Category.Type == (int)SoeCategoryType.Order &&
                                               c.Category.ActorCompanyId == ActorCompanyId &&
                                               c.Category.State == (int)SoeEntityState.Active
                                               select c.CategoryId).ToList();
                        break;
                    case (int)SoeOriginType.Contract:
                        invoice.CategoryIds = (from c in entitiesReadOnly.CompanyCategoryRecord
                                               where c.RecordId == invoiceId &&
                                               c.Entity == (int)SoeCategoryRecordEntity.Contract &&
                                               c.Category.Type == (int)SoeCategoryType.Contract &&
                                               c.Category.ActorCompanyId == ActorCompanyId &&
                                               c.Category.State == (int)SoeEntityState.Active
                                               select c.CategoryId).ToList();
                        break;
                }
            }

            invoice.NbrOfChecklists = ChecklistManager.GetNrOfChecklistHeadRecords(entitiesReadOnly, SoeEntityType.Order, invoice.InvoiceId, ActorCompanyId);

            #region Blocked

            CreateCustomerBlockNote(entitiesReadOnly, invoice, invoiceId, loadActor: false);

            #endregion

            var dto = invoice.ToOrderDTO(loadRows);

            #region Note

            if (originType == SoeOriginType.Order)
            {
                var mappedInvoices = GetMappedInvoices(entitiesReadOnly, invoiceId, new List<SoeOriginInvoiceMappingType> { SoeOriginInvoiceMappingType.Contract }, false);
                if (mappedInvoices.Any(x => x.Type == SoeOriginInvoiceMappingType.Contract))
                {
                    var mappedContract = mappedInvoices.FirstOrDefault(x => x.Type == SoeOriginInvoiceMappingType.Contract);
                    var noteValues = entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                        .Where(i => i.InvoiceId == mappedContract.OriginId)
                        .Select(i => new { i.ShowNote, i.Note })
                        .FirstOrDefault();

                    if (noteValues.ShowNote)
                        dto.Note = noteValues.Note;
                }
            }
            else if (originType == SoeOriginType.Contract)
            {
                dto.Note = invoice.Note;
            }

            #endregion

            return dto;
        }

        public CustomerInvoiceSearchDTO GetOrder(int actorCompanyId, string orderNr)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            return entitiesReadOnly.Invoice
                .Where(
                        i => i.InvoiceNr == orderNr &&
                        i.Origin.ActorCompanyId == actorCompanyId &&
                        i.Origin.Type == (int)SoeOriginType.Order &&
                        (i.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice || i.Origin.Status == (int)SoeOriginStatus.Origin) &&
                        i.IsTemplate == false &&
                        i.State == (int)SoeEntityState.Active
                    )
                .Select(i => new CustomerInvoiceSearchDTO
                {
                    Number = i.InvoiceNr,
                    CustomerInvoiceId = i.InvoiceId,
                    CustomerName = i.Actor.Customer.Name,
                    CustomerNr = i.Actor.Customer.CustomerNr,
                    ProjectId = i.ProjectId,
                    ProjectName = i.Project.Name,
                    ProjectNr = i.Project.Number,
                })
                .FirstOrDefault();
        }
        public IEnumerable<InvoiceMapping> GetChildInvoices(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.InvoiceMapping.NoTracking();
            return GetChildInvoices(entities, invoiceId);
        }

        public IEnumerable<InvoiceMapping> GetChildInvoices(CompEntities entities, int invoiceId)
        {
            IQueryable<InvoiceMapping> query = entities.InvoiceMapping;

            return (from i in query
                    where
                    i.MainInvoiceId == invoiceId
                    select i);
        }

        public List<CustomerInvoiceSmallGridDTO> GetOrdersForSupplierInvoiceEdit()
        {
            List<CustomerInvoiceSmallGridDTO> dtos = new List<CustomerInvoiceSmallGridDTO>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var items = entitiesReadOnly.GetOrdersForSupplierInvoice(base.ActorCompanyId);

            foreach (var order in items)
            {
                dtos.Add(new CustomerInvoiceSmallGridDTO()
                {
                    Customer = order.CustomerName,
                    InvoiceId = order.InvoiceId,
                    InvoiceNr = order.InvoiceNr,
                    ProjectId = order.ProjectId.Value,
                    CustomerInvoiceNumberName = order.OriginDescription != null && order.OriginDescription.Trim() != String.Empty ? order.InvoiceNr + " - " + Regex.Replace(order.CustomerName, @"\t|\n|\r", " ") + " - " + Regex.Replace(order.OriginDescription, @"\t|\n|\r", " ") : order.InvoiceNr + " - " + order.CustomerName,
                    CustomerInvoiceNumberNameWithoutDescription = order.InvoiceNr + " - " + order.CustomerName,
                    PriceListTypeId = order.PriceListTypeId.GetValueOrDefault(0)
                });
            }

            return dtos;
        }

        public BillingInvoiceDTO GetBillingInvoice(int invoiceId, bool loadCategories, bool loadRows)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            IQueryable<CustomerInvoice> query = entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                .Include("Origin.OriginUser.User")
                .Include("Project")
                .Include("OriginInvoiceMapping");

            if (loadRows)
            {
                query = query.Include("CustomerInvoiceRow")
                             .Include("CustomerInvoiceRow.HouseholdTaxDeductionRow")
                             .Include("CustomerInvoiceRow.Product")
                             .Include("CustomerInvoiceRow.Stock");
            }

            CustomerInvoice invoice = (from i in query
                                       where i.InvoiceId == invoiceId &&
                                       i.State == (int)SoeEntityState.Active
                                       select i).FirstOrDefault();

            if (invoice != null)
            {
                // Set StatusName
                if (invoice.Origin != null)
                    invoice.StatusName = GetText(invoice.Origin.Status, (int)TermGroup.OriginStatus);

                if (loadCategories)
                {
                    invoice.CategoryIds = (from c in entitiesReadOnly.CompanyCategoryRecord
                                           where c.RecordId == invoiceId &&
                                           c.Entity == (int)SoeCategoryRecordEntity.Order &&
                                           c.Category.Type == (int)SoeCategoryType.Order &&
                                           c.Category.ActorCompanyId == ActorCompanyId &&
                                           c.Category.State == (int)SoeEntityState.Active
                                           select c.CategoryId).ToList();
                }

                invoice.NbrOfChecklists = ChecklistManager.GetNrOfChecklistHeadRecords(entitiesReadOnly, SoeEntityType.Order, invoice.InvoiceId, base.ActorCompanyId);

                #region Blocked

                CreateCustomerBlockNote(entitiesReadOnly, invoice, invoiceId, loadActor: false);

                #endregion


                var dto = invoice.ToBillingInvoiceDTO(loadRows);

                //Check if transfered from order
                var mappedInvoices = GetMappedInvoices(entitiesReadOnly, invoiceId, new List<SoeOriginInvoiceMappingType> { SoeOriginInvoiceMappingType.Offer, SoeOriginInvoiceMappingType.Order, SoeOriginInvoiceMappingType.Contract }, false);
                dto.TransferedFromOrder = mappedInvoices.Any(x => x.Type == SoeOriginInvoiceMappingType.Order);
                dto.TransferedFromOffer = mappedInvoices.Any(x => x.Type == SoeOriginInvoiceMappingType.Offer);

                if (mappedInvoices.Any(x => x.Type == SoeOriginInvoiceMappingType.Order))
                    dto.TransferedFromOriginType = SoeOriginType.Order;
                else if (mappedInvoices.Any(x => x.Type == SoeOriginInvoiceMappingType.Offer))
                    dto.TransferedFromOriginType = SoeOriginType.Offer;
                else if (mappedInvoices.Any(x => x.Type == SoeOriginInvoiceMappingType.Contract))
                {
                    dto.TransferedFromOriginType = SoeOriginType.Contract;

                    var mappedContract = mappedInvoices.FirstOrDefault(x => x.Type == SoeOriginInvoiceMappingType.Contract);
                    var noteValues = entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                        .Where(i => i.InvoiceId == mappedContract.OriginId)
                        .Select(i => new { i.ShowNote, i.Note })
                        .FirstOrDefault();

                    if (noteValues.ShowNote)
                        dto.Note = noteValues.Note;
                }

                return dto;
            }

            return null;
        }

        public void RegenerateProductAccountRows(CompEntities entities, CustomerInvoice invoice)
        {
            int nextRowNr = 2;  // Claim row will get number 1
            foreach (var invoiceRow in invoice.ActiveCustomerInvoiceRows.Where(x => x.Type == (int)SoeInvoiceRowType.ProductRow))
            {
                // Delete existing CustomerInvoiceAccountRows
                foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                {
                    ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                }
                CreateCustomerInvoiceAccountRow(entities, invoice, invoiceRow, (TermGroup_InvoiceVatType)invoice.VatType, ref nextRowNr, invoice.ActorId.HasValue ? invoice.ActorId.Value : 0, 0, invoice.ProjectId.HasValue ? invoice.ProjectId.Value : 0, ActorCompanyId);
            }
        }

        public List<CustomerInvoiceAccountRow> GetCustomerInvoiceAccountRows(int invoiceId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            IQueryable<CustomerInvoiceAccountRow> query = entitiesReadOnly.CustomerInvoiceAccountRow
                .Include("CustomerInvoiceRow")
                .Include("AccountStd.Account")
                .Include("AccountInternal.Account.AccountDim");

            List<CustomerInvoiceAccountRow> rows = (from ar in query
                                                    where ar.CustomerInvoiceRow.InvoiceId == invoiceId &&
                                                    ar.State == (int)SoeEntityState.Active &&
                                                    ar.CustomerInvoiceRow.State == (int)SoeEntityState.Active
                                                    select ar).ToList();

            return rows;
        }

        public List<CustomerInvoiceAccountRow> GetCustomerInvoiceAccountRowsForCustomerInvoiceRow(int customerInvoiceRowId, bool excludeVatRows)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            IQueryable<CustomerInvoiceAccountRow> query = entitiesReadOnly.CustomerInvoiceAccountRow
                .Include("AccountStd.Account")
                .Include("AccountInternal.Account.AccountDim");

            List<CustomerInvoiceAccountRow> rows = (from ar in query
                                                    where ar.CustomerInvoiceRowId == customerInvoiceRowId &&
                                                    ar.State == (int)SoeEntityState.Active &&
                                                    (excludeVatRows == false || (ar.VatRow == false && ar.ContractorVatRow == false))
                                                    select ar).ToList();

            return rows;
        }

        public bool IsCustomerInvoiceOverdued(CompEntities entities, int defaultGracePeriodDays, int customerGracePeriodDays, DateTime? invoiceDueDate, int invoiceId, bool isTotalAmountPayed)
        {
            bool isOverdued = false;
            if (!invoiceDueDate.HasValue)
                return isOverdued;

            int gracePeriodDays = GetCustomerInvoiceGracePeriodDays(defaultGracePeriodDays, customerGracePeriodDays);
            DateTime dueDate = invoiceDueDate.Value.AddDays(gracePeriodDays);
            DateTime overdueDate = DateTime.Now;

            //For fully payed invoices, use last payment date as overdue date. For not payed or party payed, use today as overdue date
            if (isTotalAmountPayed)
            {
                DateTime? lastPaymentDate = PaymentManager.GetLastPaymentDateForInvoice(entities, invoiceId);
                if (lastPaymentDate.HasValue)
                    overdueDate = lastPaymentDate.Value;
            }

            isOverdued = dueDate < overdueDate;

            return isOverdued;
        }

        public bool IsCustomerInvoiceValidForVoucher(CompEntities entities, int originStatus, int registrationType, bool manuallyAdjustedAccounting)
        {
            return originStatus == (int)SoeOriginStatus.Origin && (registrationType == (int)OrderInvoiceRegistrationType.Invoice || registrationType == (int)OrderInvoiceRegistrationType.Ledger) && !manuallyAdjustedAccounting;
        }

        public bool IsCustomerInvoiceValidForPayment(CompEntities entities, int originStatus, int registrationType)
        {
            return originStatus == (int)SoeOriginStatus.Origin && (registrationType == (int)OrderInvoiceRegistrationType.Invoice || registrationType == (int)OrderInvoiceRegistrationType.Ledger);
        }

        private DateTime? GetLastClaimDateForCustomer(CompEntities entities, int actorId)
        {
            CustomerInvoice customerInvoice = (from i in entities.Invoice.OfType<CustomerInvoice>()
                                               where i.BillingType == (int)TermGroup_BillingType.Reminder &&
                                               i.ActorId.HasValue &&
                                               i.ActorId.Value == actorId &&
                                               i.State == (int)SoeEntityState.Active
                                               orderby i.InvoiceDate descending
                                               select i).FirstOrDefault();

            return customerInvoice != null ? customerInvoice.InvoiceDate : null;
        }

        private CustomerInvoice CreateCustomerInvoiceForReminder(CompEntities entities, CustomerInvoice prototype, PaymentCondition paymentCondition, DeliveryType deliveryType, DeliveryCondition deliveryCondition, Currency currency, int deliveryAddressId, int billingAddressId, int actorCompanyId)
        {
            if (prototype == null || prototype.Origin == null)
                return null;

            return CreateCustomerInvoiceForInterestAndReminder(entities, prototype, paymentCondition, deliveryType, deliveryCondition, currency, deliveryAddressId, billingAddressId, TermGroup_BillingType.Reminder, actorCompanyId);
        }

        private CustomerInvoice CreateCustomerInvoiceForInterest(CompEntities entities, CustomerInvoice prototype, PaymentCondition paymentCondition, DeliveryType deliveryType, DeliveryCondition deliveryCondition, Currency currency, int deliveryAddressId, int billingAddressId, int actorCompanyId)
        {
            if (prototype == null || prototype.Origin == null)
                return null;

            return CreateCustomerInvoiceForInterestAndReminder(entities, prototype, paymentCondition, deliveryType, deliveryCondition, currency, deliveryAddressId, billingAddressId, TermGroup_BillingType.Interest, actorCompanyId);
        }

        private CustomerInvoice CreateCustomerInvoiceForInterestAndReminder(CompEntities entities, CustomerInvoice prototype, PaymentCondition paymentCondition, DeliveryType deliveryType, DeliveryCondition deliveryCondition, Currency currency, int deliveryAddressId, int billingAddressId, TermGroup_BillingType billingType, int actorCompanyId)
        {
            if (prototype == null)
                return null;

            #region Prereq

            CompCurrency compCurrency = null;
            if (currency != null)
                compCurrency = CountryCurrencyManager.GetCompCurrency(entities, prototype.Currency.SysCurrencyId, actorCompanyId);

            #endregion

            CustomerInvoice clone = CopyCustomerInvoice(entities, prototype, SoeOriginType.CustomerInvoice, false);

            #region Origin

            //Default values
            clone.Origin.Status = (int)SoeOriginStatus.Draft;

            #endregion

            #region Invoice

            //Parameters
            clone.BillingType = (int)billingType;

            //Default values
            clone.VatType = billingType == TermGroup_BillingType.Interest ? (int)TermGroup_InvoiceVatType.NoVat : (int)TermGroup_InvoiceVatType.Merchandise;
            clone.CurrencyRate = compCurrency != null ? compCurrency.RateToBase : prototype.CurrencyRate;
            clone.CurrencyDate = compCurrency != null ? compCurrency.Date : prototype.CurrencyDate;
            clone.InvoiceDate = null;
            clone.DueDate = null;
            clone.VoucherDate = null;
            SetCustomerInvoiceDateAndDueDateIfMissing(entities, clone, actorCompanyId, paymentCondition);
            SetVoucherDateIfMissing(clone);

            //Reset
            clone.InvoiceNr = "";
            clone.SeqNr = null;
            clone.ReferenceOur = "";
            clone.ReferenceYour = "";
            clone.OCR = "";
            clone.TotalAmount = 0;
            clone.TotalAmountCurrency = 0;
            clone.VATAmount = 0;
            clone.VATAmountCurrency = 0;
            clone.PaidAmount = 0;
            clone.PaidAmountCurrency = 0;
            clone.RemainingAmount = 0;
            clone.OnlyPayment = false;
            clone.FullyPayed = false;
            clone.ManuallyAdjustedAccounting = false;

            //Set references
            clone.Currency = currency;
            clone.VoucherHead = null;
            clone.VoucherHeadId = null;
            clone.Project = null;

            #endregion

            #region CustomerInvoice

            //Parameters
            clone.DeliveryAddressId = deliveryAddressId;
            clone.BillingAddressId = billingAddressId;

            //Default values
            clone.DeliveryDate = clone.InvoiceDate;

            //Reset
            clone.MultipleAssetRows = false;
            clone.BillingInvoicePrinted = false;
            clone.NoOfReminders = 0;
            clone.InvoiceText = "";
            clone.InvoiceHeadText = "";
            clone.BillingAdressText = "";
            clone.DeliveryDateText = "";
            clone.InvoiceLabel = "";
            clone.OrderDate = null;
            clone.DeliveryDate = null;
            clone.FreightAmount = 0;
            clone.FreightAmountCurrency = 0;
            clone.InvoiceFee = 0;
            clone.InvoiceFeeCurrency = 0;
            clone.CentRounding = 0;
            clone.SumAmount = 0;
            clone.SumAmountCurrency = 0;
            clone.MarginalIncome = 0;
            clone.MarginalIncomeCurrency = 0;
            clone.MarginalIncomeRatio = 0;
            clone.NoOfReminders = 0;
            clone.StatusIcon = 0;
            clone.HasHouseholdTaxDeduction = false;
            clone.PrintTimeReport = false;
            clone.FixedPriceOrder = false;
            clone.MultipleAssetRows = false;
            clone.InsecureDebt = false;
            clone.NextContractPeriodYear = 0;
            clone.NextContractPeriodValue = 0;
            clone.NextContractPeriodDate = null;

            //Set FK
            clone.SysWholeSellerId = null;
            //clone.PriceListTypeId = null;
            clone.ContractGroupId = null;

            //Set references
            clone.PaymentCondition = paymentCondition;
            clone.DeliveryCondition = deliveryCondition;
            clone.DeliveryType = deliveryType;

            #endregion

            return clone;
        }

        public CustomerInvoice CopyCustomerInvoice(CompEntities entities, CustomerInvoice prototype, SoeOriginType newOriginType, bool merge)
        {
            #region Properties

            var clone = new CustomerInvoice();
            EntityUtil.Copy<CustomerInvoice>(clone, prototype);
            SetCreatedProperties(clone);

            #endregion

            #region Origin

            clone.Origin = new Origin();
            SetCreatedProperties(clone.Origin);
            clone.Origin.Modified = null;
            clone.Origin.ModifiedBy = null;
            clone.Origin.Type = (int)newOriginType;
            clone.Origin.Status = (int)SoeOriginStatus.Draft;
            clone.Origin.Description = prototype.Origin.Description;

            //Set FK
            clone.Origin.ActorCompanyId = prototype.Origin.ActorCompanyId;
            clone.Origin.VoucherSeriesId = prototype.Origin.VoucherSeriesId;
            clone.Origin.VoucherSeriesTypeId = prototype.Origin.VoucherSeriesTypeId;

            #endregion

            #region Invoice

            SetCreatedProperties(clone);
            clone.Modified = null;
            clone.ModifiedBy = null;
            entities.Invoice.AddObject(clone);

            //Set FK
            clone.ActorId = prototype.ActorId;
            clone.CurrencyId = prototype.CurrencyId;
            clone.ProjectId = prototype.ProjectId;

            //Set references
            clone.VoucherHead = null;

            if (merge)
            {
                clone.DefaultDim1AccountId = (int?)null;
                clone.DefaultDim2AccountId = (int?)null;
                clone.DefaultDim3AccountId = (int?)null;
                clone.DefaultDim4AccountId = (int?)null;
                clone.DefaultDim5AccountId = (int?)null;
                clone.DefaultDim6AccountId = (int?)null;
            }

            #endregion

            #region CustomerInvoice

            //Set FK
            clone.PaymentConditionId = prototype.PaymentConditionId;
            clone.DeliveryConditionId = prototype.DeliveryConditionId;
            clone.DeliveryTypeId = prototype.DeliveryTypeId;

            //Set references
            clone.CustomerInvoiceRow = null;

            clone.PriceListTypeInclusiveVat = prototype.PriceListTypeInclusiveVat;

            clone.ContractNr = prototype.ContractNr;

            #endregion

            return clone;
        }

        public ActionResult CustomerInvoiceNumberExist(CompEntities entities, int actorCompanyId, int exceptInvoiceId, string invoiceNr)
        {
            return InvoiceNumberExist(entities, SoeInvoiceType.CustomerInvoice, actorCompanyId, exceptInvoiceId, invoiceNr, 0);
        }

        public ActionResult SetCustomerInvoiceAsPrinted(CompEntities entities, IEnumerable<CustomerInvoice> customerInvoices)
        {
            if (customerInvoices == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

            foreach (var customerInvoice in customerInvoices)
            {
                if (customerInvoice.Origin.Status != (int)SoeOriginStatus.Draft)
                    customerInvoice.BillingInvoicePrinted = true;
            }

            return SaveChanges(entities);
        }

        public ActionResult SaveCustomerInvoice(CustomerInvoiceSaveDTO invoiceInput, List<CustomerInvoiceRowDTO> invoiceRowsDTOInput, List<AccountingRowDTO> accountingRowsInput, int actorCompanyId, ImportCustomerInvoiceCache invoiceImportCache, bool cashPayment = false, bool discardConcurrencyCheck = false, bool isMobileOrder = false, bool ignoreTransfer = false, bool skipCreateVoucherCheck = false)
        {
            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    InitializeAttestStateIds(entities, actorCompanyId);

                    using (var transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        var result = SaveCustomerInvoice(entities, transaction, invoiceInput, invoiceRowsDTOInput, accountingRowsInput, actorCompanyId, invoiceImportCache, cashPayment, discardConcurrencyCheck, isMobileOrder, ignoreTransfer, skipCreateVoucherCheck);

                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();
                        }
                        return result;
                    }
                }
                finally
                {
                    entities.Connection.Close();
                }
            }
        }
        public ActionResult SaveCustomerInvoice(CompEntities entities, TransactionScope transaction, CustomerInvoiceSaveDTO invoiceInput, List<CustomerInvoiceRowDTO> invoiceRowsDTOInput, List<AccountingRowDTO> accountingRowsInput, int actorCompanyId, ImportCustomerInvoiceCache invoiceImportCache, bool cashPayment = false, bool discardConcurrencyCheck = false, bool isMobileOrder = false, bool ignoreTransfer = false, bool skipCreateVoucherCheck = false)
        {
            if (invoiceInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoice");

            // Default result is successful
            var result = new ActionResult(true);

            #region Init

            int invoiceId = invoiceInput.InvoiceId;
            int seqNbr = 0;
            decimal remainingCurrencyAmount = 0;
            decimal remainingCurrencyAmountVat = 0;
            decimal remainingCurrencyAmountExVat = 0;
            string invoiceNbr = string.Empty;
            DateTime? modified = null;
            string modifiedBy = null;
            bool reloadAfterSave = false;
            Dictionary<int, CustomerInvoiceRow> modifiedRows = new Dictionary<int, CustomerInvoiceRow>();
            Dictionary<int, CustomerInvoiceAccountRow> modifiedAccRows = new Dictionary<int, CustomerInvoiceAccountRow>();
            Dictionary<int, int> modifiedRowIds = new Dictionary<int, int>();
            Dictionary<int, int> modifiedAccRowIds = new Dictionary<int, int>();
            Dictionary<int, int> voucherHeadsDict = null;
            TimeProjectDTO returnProject = null;
            bool setPrintTimeProjectAsChecked = false;
            bool usePartialInvoicingOnOrderRow = false;
            bool draftToOrigin = false;

            #endregion

            #region Prereq

            #region Types

            // Set SoeOriginType based on OrderInvoiceRegistrationType
            SoeOriginType originType = GetOriginType(invoiceInput.RegistrationType);
            int originTypeId = (int)originType;

            if (originType == SoeOriginType.CustomerInvoice && invoiceInput.OriginStatus != SoeOriginStatus.Voucher)
            {
                if (invoiceInput.VoucherHeadId.HasValue && invoiceInput.VoucherHeadId != 0)
                    invoiceInput.OriginStatus = SoeOriginStatus.Voucher;
            }

            // Set SoeEntityType based on SoeOriginType
            SoeEntityType entityType = GetEntityType(originType);

            #endregion

            #region Set DueDate

            if (invoiceInput.RegistrationType == OrderInvoiceRegistrationType.Invoice && invoiceInput.OriginStatus != SoeOriginStatus.Draft && invoiceInput.DueDate == null && !invoiceInput.IsTemplate)
                invoiceInput.DueDate = DateTime.Today.AddDays(PaymentManager.GetPaymentConditionDays(entities, invoiceInput.PaymentConditionId, actorCompanyId));

            #endregion

            #region Settings

            //if (originType == SoeOriginType.Order)
            //    SettingManager.UpdateInsertBoolSetting(SettingMainType.User, (int)UserSettingType.BillingCheckConflictsOnSave, invoiceInput.CheckConflictsOnSave, base.UserId, actorCompanyId, 0);
            if (invoiceInput.RegistrationType == OrderInvoiceRegistrationType.Order)
            {
                usePartialInvoicingOnOrderRow = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUsePartialInvoicingOnOrderRow, base.UserId, base.ActorCompanyId, 0);
            }

            #endregion

            if (invoiceInput.DeliveryAddressId > 0)
            {
                invoiceInput.InvoiceHeadText = null;
            }

            #endregion


            try
            {
                #region Prereq

                //Check if invoice was modified after current invoice was fetched
                if (!discardConcurrencyCheck)
                {
                    if (base.IsEntityModified(entities, invoiceInput.InvoiceId, entityType, invoiceInput.Modified, out modified, out modifiedBy))
                        return new ActionResult((int)ActionResultSave.EntityIsModifiedByOtherUser, string.Format(GetText(5643, "{0} av {1}"), modified, modifiedBy));
                }

                int standardMaterialCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStandardMaterialCode, 0, actorCompanyId, 0);
                int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);

                //Fixed price keep prices
                int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);

                int accountYearId = SettingManager.GetIntSetting(entities, SettingMainType.UserAndCompany, (int)UserSettingType.AccountingAccountYear, base.UserId, actorCompanyId, 0);

                #endregion


                #region Prereq

                // Get existing CustomerInvoice
                CustomerInvoice invoice = invoiceInput.InvoiceId == 0 ? null : GetCustomerInvoice(entities, invoiceInput.InvoiceId, true, true, true, false, true, false, false, true, true, false, true, true);

                // Check if customer is blocked
                if (invoice != null && invoice.Actor != null && invoice.Origin != null && !invoiceInput.IsTemplate)
                {
                    if (!invoice.Actor.CustomerReference.IsLoaded)
                        invoice.Actor.CustomerReference.Load();
                    if (invoice.Actor.Customer != null && invoice.Actor.Customer.BlockInvoice && invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice)
                        return new ActionResult((int)ActionResultSave.InvalidStateTransition);
                }

                #region Transition check

                if (invoice != null)
                {
                    bool okToModify = false;
                    switch (invoice.Origin.Type)
                    {
                        case (int)SoeOriginType.CustomerInvoice:
                            okToModify = (invoiceInput.ForceSave ? true : !invoice.FullyPayed) || invoiceInput.ManuallyAdjustedAccounting || invoice.ManuallyAdjustedAccounting;
                            break;
                        case (int)SoeOriginType.Offer:
                            okToModify = invoiceInput.ForceSave ? true : ((invoice.Origin.Status == (int)SoeOriginStatus.Draft) || (invoice.Origin.Status == (int)SoeOriginStatus.Origin) || (invoice.Origin.Status == (int)SoeOriginStatus.OfferPartlyOrder) || (invoice.Origin.Status == (int)SoeOriginStatus.OfferPartlyInvoice));
                            break;
                        case (int)SoeOriginType.Order:
                            okToModify = invoiceInput.ForceSave ? true : (invoice.Origin.Status == (int)SoeOriginStatus.Draft || (invoice.Origin.Status == (int)SoeOriginStatus.Origin) || (invoice.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice));
                            break;
                        case (int)SoeOriginType.Contract:
                            okToModify = invoiceInput.ForceSave ? true : ((invoice.Origin.Status == (int)SoeOriginStatus.Draft) || (invoice.Origin.Status == (int)SoeOriginStatus.Origin));
                            break;
                        default:
                            break;
                    }
                    if (!okToModify)
                    {
                        return new ActionResult((int)ActionResultSave.InvalidStateTransition);
                    }

                    // Cannot change to Draft from Origin
                    if (invoice.Origin.Status == (int)SoeOriginStatus.Origin && invoiceInput.OriginStatus == SoeOriginStatus.Draft)
                        return new ActionResult((int)ActionResultSave.InvalidStateTransition);
                }

                #endregion

                #endregion

                #region Add
                var addInvoice = invoice == null;
                if (invoice == null)
                {
                    #region Origin

                    // Create new Origin, fields will be set in update below
                    var origin = new Origin
                    {
                        VoucherSeriesId = invoiceInput.VoucherSeriesId,
                        VoucherSeriesTypeId = invoiceInput.VoucherSeriesTypeId,
                        Type = originTypeId,
                        Status = (int)invoiceInput.OriginStatus,
                        ActorCompanyId = actorCompanyId,
                    };
                    SetCreatedProperties(origin);
                    entities.Origin.AddObject(origin);

                    #endregion

                    #region OriginUser

                    // Add current user to origin
                    var originUser = new OriginUser
                    {
                        Main = true,
                        UserId = base.UserId,
                        Origin = origin,
                    };
                    origin.OriginUser.Add(originUser);
                    SetCreatedProperties(originUser);

                    #endregion

                    #region CustomerInvoice

                    // Create new CustomerInvoice, fields will be set in update below
                    invoice = new CustomerInvoice
                    {
                        // Inherited from Invoice
                        Origin = origin,
                        Type = (int)SoeInvoiceType.CustomerInvoice,
                        OnlyPayment = false,
                        PaidAmountCurrency = 0,
                        FullyPayed = false,
                        SysPaymentTypeId = 0,
                        PaymentNr = string.Empty,
                        MultipleAssetRows = false, // Will be calculated
                        OrderType = (int)invoiceInput.OrderType,
                        RegistrationType = (int)invoiceInput.RegistrationType, //Added here for OriginInvoiceMapping to work correctly
                        BillingType = (int)invoiceInput.BillingType //Added here for OriginInvoiceMapping to work correctly
                    };

                    SetCreatedProperties(invoice);
                    entities.Invoice.AddObject(invoice);

                    //When invoice is copied the OCR field was not set at all
                    invoiceInput.OCR = string.Empty;

                    #endregion

                    #region Sequence numbers

                    // Offers and orders will get a sequence number as draft. Invoices will get a sequence when saved as origin.
                    if ((invoiceInput.OriginStatus != SoeOriginStatus.Draft || originType == SoeOriginType.Offer || originType == SoeOriginType.Order) && !invoiceInput.IsTemplate)
                    {
                        // Get next sequence number
                        string entityName = string.Empty;
                        int startNbr = 0;
                        int invoiceNumberLength = 0;
                        InvoiceManager.GetNextSequenceNumber(entities, originType, invoiceInput.OriginStatus, invoiceInput.BillingType, actorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, false, invoiceInput.CashSale, (TermGroup_OrderType)invoiceInput.OrderType);

                        invoice.SeqNr = seqNbr;

                        // Set invoice number to same as sequence number (padded to a specified number of digits)
                        invoice.InvoiceNr = invoiceInput.InvoiceNr = invoiceNbr = seqNbr.ToString().PadLeft(invoiceNumberLength, '0');

                        // Set dates
                        if (invoiceInput.InvoiceDate == null)
                            invoiceInput.InvoiceDate = DateTime.Today;

                        if (invoiceInput.VoucherDate == null)
                            invoiceInput.VoucherDate = DateTime.Today;
                    }
                    else
                    {
                        invoice.InvoiceNr = invoiceNbr = invoiceInput.InvoiceNr;
                    }

                    #endregion
                    reloadAfterSave = true;

                    if (invoiceInput.PrevInvoiceId != 0)
                    {
                        // Add mapping from originating invoice (used when credit)
                        var oimap = new OriginInvoiceMapping
                        {
                            Origin = invoice.Origin,
                            Type = (int)GetOriginInvoiceMappingType(invoice),
                            InvoiceId = invoiceInput.PrevInvoiceId
                        };
                        entities.OriginInvoiceMapping.AddObject(oimap);
                        // Add mapping from originating invoice's originating order
                    }
                }

                #endregion

                #region Update

                #region Origin

                // Update Origin
                if (!invoiceInput.ManuallyAdjustedAccounting)
                {
                    draftToOrigin = (invoice.Origin.Status == (int)SoeOriginStatus.Draft) && (invoiceInput.OriginStatus == SoeOriginStatus.Origin);

                    invoice.Origin.VoucherSeriesId = invoiceInput.VoucherSeriesId;
                    invoice.Origin.VoucherSeriesTypeId = invoiceInput.VoucherSeriesTypeId;
                    invoice.Origin.Description = invoiceInput.OriginDescription;
                    if (invoice.Origin.Status == (int)SoeOriginStatus.Draft || invoice.Origin.Status == (int)SoeOriginStatus.Origin)
                        invoice.Origin.Status = (int)invoiceInput.OriginStatus;

                    if (invoice.Origin.Status != (int)invoiceInput.OriginStatus)
                        reloadAfterSave = true;

                    SetModifiedProperties(invoice.Origin);
                }

                #endregion

                #region OrderNumbers

                if (invoiceInput.OrderNumbers.HasValue())
                    invoice.OrderNumbers = invoiceInput.OrderNumbers;

                #endregion

                #region ContractNumber

                if (!String.IsNullOrEmpty(invoiceInput.ContractNr))
                    invoice.ContractNr = invoiceInput.ContractNr;

                #endregion

                #region CustomerInvoice

                if (!invoiceInput.ManuallyAdjustedAccounting && !invoice.ManuallyAdjustedAccounting)
                {
                    invoice.BillingType = (int)invoiceInput.BillingType;
                    invoice.VatType = (int)invoiceInput.VatType;
                    invoice.InvoiceDate = invoiceInput.InvoiceDate;
                    invoice.DueDate = invoiceInput.DueDate;
                    invoice.VoucherDate = invoiceInput.VoucherDate;
                    invoice.ReferenceOur = invoiceInput.ReferenceOur;
                    invoice.ReferenceYour = invoiceInput.ReferenceYour;
                    invoice.ContactEComId = invoiceInput.ContactEComId;
                    invoice.ContactGLNId = invoiceInput.ContactGLNId;
                    invoice.OrderType = (int)invoiceInput.OrderType;

                    invoice.TotalAmount = invoiceInput.TotalAmount;
                    invoice.TotalAmountCurrency = invoiceInput.TotalAmountCurrency;
                    invoice.VATAmount = invoiceInput.VatAmount;
                    invoice.VATAmountCurrency = invoiceInput.VatAmountCurrency;
                    invoice.RemainingAmount = invoiceInput.RemainingAmount;
                    invoice.CurrencyId = invoiceInput.CurrencyId;
                    invoice.CurrencyRate = invoiceInput.CurrencyRate;
                    invoice.CurrencyDate = invoiceInput.CurrencyDate;
                    invoice.PrintTimeReport = invoiceInput.PrintTimeReport;
                    invoice.StatusIcon = (int)invoiceInput.StatusIcon;
                    invoice.IsTemplate = invoiceInput.IsTemplate;
                    invoice.IncludeOnlyInvoicedTime = invoiceInput.IncludeOnlyInvoicedTime;
                    if (invoiceInput.FullyPayed.HasValue)
                        invoice.FullyPayed = invoiceInput.FullyPayed.Value;

                    // CustomerInvoice
                    invoice.RegistrationType = (int)invoiceInput.RegistrationType;
                    invoice.OrderDate = invoiceInput.OrderDate;
                    invoice.DeliveryDate = invoiceInput.DeliveryDate;
                    invoice.DeliveryAddressId = invoiceInput.DeliveryAddressId;
                    invoice.BillingAddressId = invoiceInput.BillingAddressId;
                    invoice.SumAmount = invoiceInput.SumAmount;
                    invoice.SumAmountCurrency = invoiceInput.SumAmountCurrency;
                    invoice.FreightAmount = invoiceInput.FreightAmount;
                    invoice.FreightAmountCurrency = invoiceInput.FreightAmountCurrency;
                    invoice.InvoiceFee = invoiceInput.InvoiceFee;
                    invoice.InvoiceFeeCurrency = invoiceInput.InvoiceFeeCurrency;
                    invoice.CentRounding = invoiceInput.CentRounding;
                    invoice.InvoiceText = invoiceInput.InvoiceText;
                    invoice.InvoiceHeadText = invoiceInput.InvoiceHeadText;
                    invoice.BillingAdressText = invoiceInput.BillingAdressText;
                    invoice.InvoiceLabel = invoiceInput.InvoiceLabel;
                    invoice.MarginalIncome = invoiceInput.MarginalIncome;
                    invoice.MarginalIncomeCurrency = invoiceInput.MarginalIncomeCurrency;
                    invoice.MarginalIncomeRatio = invoiceInput.MarginalIncomeRatio;
                    invoice.FixedPriceOrder = invoiceInput.FixedPriceOrder;
                    invoice.SysWholeSellerId = invoiceInput.SysWholeSellerId;
                    invoice.PriceListTypeId = invoiceInput.PriceListTypeId;
                    invoice.CashSale = invoiceInput.CashSale;
                    invoice.InvoiceDeliveryType = invoiceInput.InvoiceDeliveryType;
                    invoice.InvoiceDeliveryProvider = invoiceInput.InvoiceDeliveryProvider;
                    invoice.InvoicePaymentService = invoiceInput.InvoicePaymentService;
                    invoice.DeliveryDateText = invoiceInput.DeliveryDateText;
                    if (invoiceInput.ProjectId != 0)
                        invoice.ProjectId = invoiceInput.ProjectId;
                    invoice.AddAttachementsToEInvoice = invoiceInput.AddAttachementsToEInvoice;
                    invoice.AddSupplierInvoicesToEInvoices = invoiceInput.AddSupplierInvoicesToEInvoices;

                    invoice.ExternalId = !string.IsNullOrEmpty(invoiceInput.ExternalId) ? invoiceInput.ExternalId : string.Empty;

                    // OrderPlanning
                    invoice.ShiftTypeId = invoiceInput.ShiftTypeId;
                    invoice.EstimatedTime = invoiceInput.EstimatedTime;
                    invoice.RemainingTime = invoiceInput.RemainingTime;
                    invoice.KeepAsPlanned = invoiceInput.KeepAsPlanned;
                    invoice.Priority = invoiceInput.Priority;
                    invoice.PlannedStartDate = invoiceInput.PlannedStartDate;
                    invoice.PlannedStopDate = invoiceInput.PlannedStopDate;

                    // Contract
                    if (invoiceInput.NextContractPeriodDate.HasValue && invoiceInput.NextContractPeriodDate != CalendarUtility.DATETIME_DEFAULT)
                    {
                        if (invoiceInput.NextContractPeriodYear != 0 && invoiceInput.NextContractPeriodValue != 0)
                        {
                            invoice.NextContractPeriodYear = invoiceInput.NextContractPeriodYear;
                            invoice.NextContractPeriodValue = invoiceInput.NextContractPeriodValue;
                            invoice.NextContractPeriodDate = (DateTime)invoiceInput.NextContractPeriodDate;
                        }
                        else
                        {
                            invoice.NextContractPeriodYear = ((DateTime)invoiceInput.NextContractPeriodDate).Year;
                            invoice.NextContractPeriodValue = ((DateTime)invoiceInput.NextContractPeriodDate).Month;
                            invoice.NextContractPeriodDate = (DateTime)invoiceInput.NextContractPeriodDate;
                        }

                    }
                    else
                    {
                        DateTime nextContractPeriodDate = CalendarUtility.DATETIME_DEFAULT;

                        if (invoiceInput.NextContractPeriodYear != 0 && invoiceInput.NextContractPeriodValue != 0)
                        {
                            int year = 2015;
                            int month = 1;

                            if (invoiceInput.NextContractPeriodYear < 40)
                                invoiceInput.NextContractPeriodYear = invoiceInput.NextContractPeriodYear + 2000;

                            if (invoiceInput.NextContractPeriodValue <= 12)
                                month = invoiceInput.NextContractPeriodValue;

                            try
                            {
                                nextContractPeriodDate = new DateTime(year, month, 1);
                            }
                            catch
                            {
                                nextContractPeriodDate = DateTime.Today;
                            }
                        }

                        invoice.NextContractPeriodYear = nextContractPeriodDate.Year;
                        invoice.NextContractPeriodValue = nextContractPeriodDate.Month;
                        invoice.NextContractPeriodDate = nextContractPeriodDate;
                    }

                    // Update foreign keys
                    invoice.ActorId = invoiceInput.ActorId.ToNullable();
                    invoice.DeliveryTypeId = invoiceInput.DeliveryTypeId.ToNullable();
                    invoice.DeliveryConditionId = invoiceInput.DeliveryConditionId.ToNullable();
                    invoice.PaymentConditionId = invoiceInput.PaymentConditionId.ToNullable();
                    invoice.ContractGroupId = invoiceInput.ContractGroupId.ToNullable();
                    invoice.DeliveryCustomerId = invoiceInput.DeliveryCustomerId.ToNullable();

                    invoice.WorkingDescription = invoiceInput.WorkingDescription;
                    invoice.IncludeOnInvoice = invoiceInput.IncludeOnInvoice;

                    // Dim settings
                    invoice.DefaultDim1AccountId = invoiceInput.Dim1AccountId;
                    invoice.DefaultDim2AccountId = invoiceInput.Dim2AccountId;
                    invoice.DefaultDim3AccountId = invoiceInput.Dim3AccountId;
                    invoice.DefaultDim4AccountId = invoiceInput.Dim4AccountId;
                    invoice.DefaultDim5AccountId = invoiceInput.Dim5AccountId;
                    invoice.DefaultDim6AccountId = invoiceInput.Dim6AccountId;

                    if (invoiceInput.VoucherHeadId.HasValue && invoiceInput.VoucherHeadId != 0)
                    {
                        VoucherHead voucherHead = VoucherManager.GetVoucherHead(entities, (int)invoiceInput.VoucherHeadId, false, false, false, false);

                        if (voucherHead != null)
                        {
                            invoice.VoucherHead = voucherHead;

                            if (!invoice.OriginReference.IsLoaded)
                                invoice.OriginReference.Load();

                            invoice.Origin.VoucherSeriesId = voucherHead.VoucherSeriesId;
                        }
                    }

                    if (invoiceInput.InternalDescription != null && invoiceInput.InternalDescription.Trim() != String.Empty)
                        invoice.InternalDescription = invoiceInput.InternalDescription;

                    if (invoiceInput.ExternalDescription != null && invoiceInput.ExternalDescription.Trim() != String.Empty)
                        invoice.ExternalDescription = invoiceInput.ExternalDescription;

                    if (!string.IsNullOrEmpty(invoiceInput.ExternalId))
                        invoice.ExternalId = invoiceInput.ExternalId;
                }
                else
                    reloadAfterSave = true;

                invoice.ManuallyAdjustedAccounting = invoiceInput.ManuallyAdjustedAccounting;

                if (invoice.InvoiceId > 0)
                {
                    SetModifiedProperties(invoice);
                    modified = invoice.Modified;
                    modifiedBy = invoice.ModifiedBy;
                }

                #endregion

                #endregion

                #region Project

                if (!invoiceInput.ManuallyAdjustedAccounting && invoice.Project == null && !String.IsNullOrEmpty(invoiceInput.ProjectNr) && !invoiceInput.IsTemplate)
                {
                    bool autoGenerateProject = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProjectAutoGenerateOnNewInvoice, 0, actorCompanyId, 0);
                    bool useCustomerNameAsProjectName = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProjectUseCustomerNameAsProjectName, 0, actorCompanyId, 0, true);
                    if (autoGenerateProject)
                    {
                        if (invoiceInput.ProjectNr == "USEORDERNBR")
                        {
                            var numbers = ProjectManager.GetAllProjectNumbers(entities, actorCompanyId);
                            invoiceInput.ProjectNr = ProjectManager.GetProjectNumberCheckExisting(numbers, invoice.InvoiceNr, actorCompanyId);
                        }

                        string customerName = (from c in entities.Customer
                                               where c.ActorCustomerId == invoiceInput.ActorId
                                               select c.Name).FirstOrDefault();

                        TimeProject project = new TimeProject()
                        {
                            Number = invoiceInput.ProjectNr,
                            Name = !useCustomerNameAsProjectName || String.IsNullOrEmpty(customerName) ? DateTime.Now.ToString("yyyyMMddhhmm") : customerName.Replace("\n", "").Replace("\r", ""),
                            Type = (int)TermGroup_ProjectType.TimeProject,
                            InvoiceProductAccountingPrio = "0,0,0,0,0",
                            PayrollProductAccountingPrio = "0,0,0,0,0",
                            Description = string.Empty,
                            Status = (int)TermGroup_ProjectStatus.Hidden, //Auto created projects gets status Hidden
                            UseAccounting = true,
                            AllocationType = (int)TermGroup_ProjectAllocationType.External,
                            //Set FK
                            ActorCompanyId = actorCompanyId,
                            CustomerId = invoiceInput.ActorId,
                        };

                        SetCreatedProperties(project);

                        invoice.Project = project;

                        bool includeTimeReport = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProjectIncludeTimeProjectReport, 0, actorCompanyId, 0);
                        if (includeTimeReport)
                            invoice.PrintTimeReport = true;

                        returnProject = project.ToTimeProjectDTO(false, false);
                    }
                }
                else if (invoiceInput.ProjectId > 0 && !invoiceInput.IsTemplate)
                {
                    //Fetch project
                    var project = ProjectManager.GetTimeProject(entities, invoiceInput.ProjectId, false);

                    //Bind to invoice
                    invoice.Project = project;
                }

                if (invoice.Project != null && standardMaterialCodeId <= 0)
                    return new ActionResult((int)ActionResultSave.TimeCodeMaterialStandardMissing, GetText(8423, "Inställning för standard materialkod saknas"));

                #endregion

                #region CustomerInvoiceRows

                // Convert collection of InvoiceProductRowItems and AccountingRowDTOs to collection of CustomerInvoiceRow with CustomerInvoiceAccountRows
                string message = String.Empty;
                List<CustomerInvoiceRow> invoiceRowsInput = ConvertToCustomerInvoiceRows(entities, invoiceInput.ManuallyAdjustedAccounting, invoiceRowsDTOInput, accountingRowsInput, actorCompanyId, ref modifiedRows, ref modifiedAccRows, ref message, invoiceImportCache);
                if (invoiceRowsInput == null)
                    return new ActionResult((int)ActionResultSave.RowsHasInsufficientInformation, message);

                #endregion

                #region CustomerInvoiceReminder

                // Increase number of reminders, if invoice has any reminder rows
                if (invoiceInput.RegistrationType == OrderInvoiceRegistrationType.Invoice && !invoiceInput.IsTemplate)
                {
                    foreach (CustomerInvoiceRow customerInvoiceRow in invoiceRowsInput.Where(r => r.IsReminderRow))
                    {
                        //Make sure CustomerInvoiceReminder is loaded
                        if (!customerInvoiceRow.CustomerInvoiceReminderReference.IsLoaded)
                            customerInvoiceRow.CustomerInvoiceReminderReference.Load();

                        //Only not handled reminders
                        if (customerInvoiceRow.CustomerInvoiceReminder != null && customerInvoiceRow.CustomerInvoiceReminder.NoOfReminder == 0)
                        {
                            //Make sure CustomerInvoiceOrigin is loaded
                            if (!customerInvoiceRow.CustomerInvoiceReminder.CustomerInvoiceOriginReference.IsLoaded)
                                customerInvoiceRow.CustomerInvoiceReminder.CustomerInvoiceOriginReference.Load();

                            //Increase reminder
                            IncreaseCustomerInvoiceReminder(entities, customerInvoiceRow.CustomerInvoiceReminder.CustomerInvoiceOrigin, customerInvoiceRow.CustomerInvoiceReminder, actorCompanyId, false);
                        }
                    }
                }

                #endregion

                #region Household tax deduction

                if (!invoiceInput.ManuallyAdjustedAccounting && invoiceRowsInput.Any(r => r.HouseholdTaxDeductionRow != null))
                {
                    if (invoiceRowsInput.Any(r => r.HouseholdTaxDeductionRow != null && r.State == (int)SoeEntityState.Active))
                        invoice.HasHouseholdTaxDeduction = true;
                    else if (invoiceRowsInput.Any(r => r.HouseholdTaxDeductionRow != null && r.State == (int)SoeEntityState.Deleted))
                        invoice.HasHouseholdTaxDeduction = false;
                }

                #endregion

                #region CustomerInvoiceRow Update/Delete/Add

                //Counters used to decide if an offer or order is fully or partly transferred, or not transferred at all.
                int noOfTransferredRows = 0;
                int noOfClosedRows = 0;
                int noOfNotTransferredRows = 0;

                //Assign transferredTo only once, presuppose that a offer only can be transferred to a order or a invoice, not both
                SoeOriginType transferredTo = SoeOriginType.None;

                //Counter used do decide if invoice has multiple asset rows
                int noOfAssetRows = 0;

                List<CustomerInvoiceRow> processedInputInvoiceRows = new List<CustomerInvoiceRow>();
                List<CustomerInvoiceAccountRow> processedInputInvoiceAccountRows = new List<CustomerInvoiceAccountRow>();

                // Stock

                var stockDict = new Dictionary<int, Tuple<Decimal, Decimal, bool, int, int, int>>();

                // Update or Delete existing CustomerInvoiceRows
                foreach (var invoiceRow in invoice.ActiveCustomerInvoiceRows)
                {
                    #region CustomerInvoiceRow Update/Delete

                    // Try get CustomerInvoiceRow from input
                    CustomerInvoiceRow invoiceRowInput = (from r in invoiceRowsInput
                                                          where r.CustomerInvoiceRowId == invoiceRow.CustomerInvoiceRowId
                                                          select r).FirstOrDefault();

                    if (invoiceRowInput != null)
                    {
                        //Inherit AttestState from parent
                        if (invoiceRowInput.ParentRow != null && (invoiceRowInput.PreviouslyInvoicedQuantity == null || invoiceRowInput.PreviouslyInvoicedQuantity == 0))
                            invoiceRowInput.AttestStateId = invoiceRowInput.ParentRow.AttestStateId;

                        bool isRowTransferred = GetTransferState(invoice, invoiceRowInput, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                        if (isRowTransferred && !invoiceInput.ForceSave)
                        {
                            #region CustomerInvoiceRow transferred (can not update or delete, only update row number)

                            if (invoiceRow.RowNr != invoiceRowInput.RowNr)
                            {
                                invoiceRow.RowNr = invoiceRowInput.RowNr;
                                SetModifiedProperties(invoiceRow);
                            }

                            // Delete existing CustomerInvoiceAccountRows
                            foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                            {
                                CustomerInvoiceAccountRow invoiceAccountRowInput = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                    where r.CustomerInvoiceAccountRowId == invoiceAccountRow.CustomerInvoiceAccountRowId
                                                                                    select r).FirstOrDefault();

                                if (invoiceAccountRowInput != null && invoiceAccountRowInput.State == (int)SoeEntityState.Deleted)
                                    ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);

                                if (invoiceAccountRowInput != null)
                                    processedInputInvoiceAccountRows.Add(invoiceAccountRowInput);
                            }

                            // Get new CustomerInvoiceAccountRows
                            List<CustomerInvoiceAccountRow> invoiceAccountRowsToAdd = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                       where r.CustomerInvoiceAccountRowId == 0
                                                                                       select r).ToList();

                            foreach (CustomerInvoiceAccountRow invoiceAccountRowToAdd in invoiceAccountRowsToAdd)
                            {
                                // Count asset rows
                                if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRow, invoiceAccountRowToAdd))
                                    noOfAssetRows++;

                                // Add CustomerInvoiceAccountRow to CustomerInvoiceRow
                                invoiceRow.CustomerInvoiceAccountRow.Add(invoiceAccountRowToAdd);
                            }

                            processedInputInvoiceRows.Add(invoiceRowInput);

                            #endregion
                        }
                        else
                        {
                            if (invoiceRowInput.State == (int)SoeEntityState.Deleted)
                            {
                                #region CustomerInvoiceRow Delete

                                //CustomerInvoiceReminder
                                if (invoiceRow.IsReminderRow)
                                    DecreaseNoOfReminders(entities, invoiceRow);

                                if (invoiceRow.IsTimeProjectRow)
                                {
                                    invoiceRow.TimeManuallyChanged = invoiceRowInput.TimeManuallyChanged;
                                    SetModifiedProperties(invoiceRow);
                                }
                                // Delete existing CustomerInvoiceRow
                                ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                                // Delete existing CustomerInvoiceAccountRows
                                foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                {
                                    ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);

                                    CustomerInvoiceAccountRow invoiceAccountRowInput = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                        where r.CustomerInvoiceAccountRowId == invoiceAccountRow.CustomerInvoiceAccountRowId
                                                                                        select r).FirstOrDefault();
                                    if (invoiceAccountRowInput != null)
                                        processedInputInvoiceAccountRows.Add(invoiceAccountRowInput);
                                }

                                // Delete existing household tax deduction row
                                if (invoiceRow.HouseholdTaxDeductionRow != null)
                                    ChangeEntityState(invoiceRow.HouseholdTaxDeductionRow, SoeEntityState.Deleted);

                                if (invoice.Project != null)
                                    TimeTransactionManager.DeleteTimeCodeTransactions(invoiceRow);

                                #endregion
                            }
                            else
                            {
                                #region CustomerInvoiceRow Update

                                #region Update properties and references
                                bool isStockRowOld = invoiceRow.IsStockRow == true;
                                bool isStockRowNew = invoiceRowInput.IsStockRow == true;
                                int stockId = invoiceRow.StockId ?? 0;
                                int productId = invoiceRow.ProductId ?? 0;
                                int attestStateId = invoiceRow.AttestStateId ?? 0;
                                decimal quantity = invoiceRow.Quantity ?? Decimal.Zero;
                                decimal invoiceQuantity = invoiceRow.InvoiceQuantity ?? Decimal.Zero;

                                if (isStockRowOld || isStockRowNew)
                                    stockDict.Add(invoiceRow.CustomerInvoiceRowId, new Tuple<decimal, decimal, bool, int, int, int>(quantity, invoiceQuantity, isStockRowOld, stockId, productId, attestStateId));

                                // Update existing CustomerInvoiceRow
                                invoiceRow.AttestStateId = invoiceRowInput.AttestStateId;
                                invoiceRow.RowNr = invoiceRowInput.RowNr;
                                invoiceRow.Type = invoiceRowInput.Type;
                                invoiceRow.VatRate = invoiceRowInput.VatRate;
                                invoiceRow.VatAmount = invoiceRowInput.VatAmount;
                                invoiceRow.VatAmountCurrency = invoiceRowInput.VatAmountCurrency;
                                invoiceRow.Quantity = invoiceRowInput.Quantity;
                                invoiceRow.InvoiceQuantity = invoiceRowInput.InvoiceQuantity;
                                invoiceRow.Amount = invoiceRowInput.Amount;
                                invoiceRow.AmountCurrency = invoiceRowInput.AmountCurrency;
                                invoiceRow.DiscountType = invoiceRowInput.DiscountType;
                                invoiceRow.DiscountPercent = invoiceRowInput.DiscountPercent;
                                invoiceRow.DiscountAmount = invoiceRowInput.DiscountAmount;
                                invoiceRow.SumAmount = invoiceRowInput.SumAmount;
                                invoiceRow.SumAmountCurrency = invoiceRowInput.SumAmountCurrency;
                                invoiceRow.Text = invoiceRowInput.Text;
                                invoiceRow.IsFreightAmountRow = invoiceRowInput.IsFreightAmountRow;
                                invoiceRow.IsInvoiceFeeRow = invoiceRowInput.IsInvoiceFeeRow;
                                invoiceRow.IsCentRoundingRow = invoiceRowInput.IsCentRoundingRow;
                                invoiceRow.IsInterestRow = invoiceRowInput.IsInterestRow;
                                invoiceRow.IsReminderRow = invoiceRowInput.IsReminderRow;
                                invoiceRow.IsStockRow = invoiceRowInput.IsStockRow;
                                invoiceRow.PurchasePrice = invoiceRowInput.PurchasePrice;
                                invoiceRow.PurchasePriceCurrency = invoiceRowInput.PurchasePriceCurrency;
                                invoiceRow.SysWholesellerName = invoiceRowInput.SysWholesellerName;
                                invoiceRow.MarginalIncome = invoiceRowInput.MarginalIncome;
                                invoiceRow.MarginalIncomeCurrency = invoiceRowInput.MarginalIncomeCurrency;
                                invoiceRow.MarginalIncomeRatio = invoiceRowInput.MarginalIncomeRatio;
                                invoiceRow.Status = invoiceRowInput.Status;
                                invoiceRow.State = invoiceRowInput.State;
                                invoiceRow.TimeManuallyChanged = invoiceRowInput.TimeManuallyChanged;
                                invoiceRow.DeliveryDateText = invoiceRowInput.DeliveryDateText;
                                //Set FK
                                invoiceRow.ProductId = invoiceRowInput.ProductId;
                                invoiceRow.ProductUnitId = invoiceRowInput.ProductUnitId;
                                invoiceRow.VatCodeId = invoiceRowInput.VatCodeId;
                                invoiceRow.VatAccountId = invoiceRowInput.VatAccountId;
                                invoiceRow.ParentRowId = invoiceRowInput.ParentRowId;
                                if (invoiceRowInput.StockId > 0)
                                    invoiceRow.StockId = invoiceRowInput.StockId;

                                //Set references
                                invoiceRow.HouseholdTaxDeductionRow = invoiceRowInput.HouseholdTaxDeductionRow;
                                invoiceRow.CustomerInvoiceInterest = invoiceRowInput.CustomerInvoiceInterest;
                                invoiceRow.CustomerInvoiceReminder = invoiceRowInput.CustomerInvoiceReminder;
                                invoiceRow.Date = invoiceRowInput.Date;
                                invoiceRow.DateTo = invoiceRowInput.DateTo;

                                SetModifiedProperties(invoiceRow);

                                #endregion

                                #region CustomerInvoiceAccountRow Update/Delete/Add

                                foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                {
                                    #region CustomerInvoiceAccountRow Update/Delete

                                    // Count asset rows
                                    if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRow, invoiceAccountRow))
                                        noOfAssetRows++;

                                    // Try get CustomerInvoiceAccountRow from input
                                    CustomerInvoiceAccountRow invoiceAccountRowInput = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                        where r.CustomerInvoiceAccountRowId == invoiceAccountRow.CustomerInvoiceAccountRowId
                                                                                        select r).FirstOrDefault();

                                    if (invoiceAccountRowInput != null)
                                    {
                                        if (invoiceAccountRowInput.State == (int)SoeEntityState.Deleted)
                                        {
                                            #region CustomerInvoiceAccountRow Delete

                                            // Delete existing CustomerInvoiceRow
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);

                                            #endregion
                                        }
                                        else
                                        {
                                            #region CustomerInvoiceAccountRow Update

                                            #region Update properties and references

                                            // Update existing CustomerInvoiceAccountRow
                                            invoiceAccountRow.RowNr = invoiceAccountRowInput.RowNr;
                                            invoiceAccountRow.SplitType = invoiceAccountRowInput.SplitType;
                                            invoiceAccountRow.SplitPercent = invoiceAccountRowInput.SplitPercent;
                                            invoiceAccountRow.Amount = invoiceAccountRowInput.Amount;
                                            invoiceAccountRow.AmountCurrency = invoiceAccountRowInput.AmountCurrency;
                                            invoiceAccountRow.AmountEntCurrency = invoiceAccountRowInput.AmountEntCurrency;
                                            invoiceAccountRow.AmountLedgerCurrency = invoiceAccountRowInput.AmountLedgerCurrency;
                                            invoiceAccountRow.Quantity = invoiceAccountRowInput.Quantity;
                                            invoiceAccountRow.Text = invoiceAccountRowInput.Text;
                                            invoiceAccountRow.VatRow = invoiceAccountRowInput.VatRow;
                                            invoiceAccountRow.ContractorVatRow = invoiceAccountRowInput.ContractorVatRow;
                                            invoiceAccountRow.CreditRow = invoiceAccountRowInput.CreditRow;
                                            invoiceAccountRow.DebitRow = invoiceAccountRowInput.DebitRow;
                                            invoiceAccountRow.State = invoiceAccountRowInput.State;
                                            invoiceAccountRow.AccountStd = invoiceAccountRowInput.AccountStd;

                                            // Set AccountInternal
                                            if (invoiceAccountRowInput.AccountInternal != null)
                                            {
                                                // Clear all
                                                invoiceAccountRow.AccountInternal.Clear();

                                                foreach (AccountInternal accountInternalInput in invoiceAccountRowInput.AccountInternal)
                                                {
                                                    // Add AccountInternal
                                                    AccountInternal accountInternal = invoiceImportCache.GetAccountInternal(entities, actorCompanyId, accountInternalInput.AccountId);
                                                    if (accountInternal != null)
                                                        invoiceAccountRow.AccountInternal.Add(accountInternal);
                                                }
                                            }

                                            #endregion

                                            #endregion
                                        }

                                        if (!processedInputInvoiceAccountRows.Contains(invoiceAccountRowInput))
                                            processedInputInvoiceAccountRows.Add(invoiceAccountRowInput);
                                    }

                                    #endregion
                                }

                                #region CustomerInvoiceAccountRow Add

                                // Get new CustomerInvoiceAccountRows
                                List<CustomerInvoiceAccountRow> invoiceAccountRowsToAdd = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                           where r.CustomerInvoiceAccountRowId == 0
                                                                                           select r).ToList();

                                foreach (CustomerInvoiceAccountRow invoiceAccountRowToAdd in invoiceAccountRowsToAdd)
                                {
                                    // Count asset rows
                                    if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRow, invoiceAccountRowToAdd))
                                        noOfAssetRows++;

                                    // Add CustomerInvoiceAccountRow to CustomerInvoiceRow
                                    invoiceRow.CustomerInvoiceAccountRow.Add(invoiceAccountRowToAdd);
                                }

                                #endregion

                                #endregion

                                #region TimeCodeTransaction

                                if (invoice.Project != null)
                                {
                                    result = TimeTransactionManager.UpdateTimeCodeTransactions(entities, actorCompanyId, invoiceRow, invoice.Project, standardMaterialCodeId);
                                    if (!result.Success)
                                        return result;
                                }

                                #endregion

                                #endregion
                            }

                            processedInputInvoiceRows.Add(invoiceRowInput);
                        }
                    }
                    else
                    {
                        if (invoice.InvoiceFee == 0 && invoiceRow.IsInvoiceFeeRow)
                        {
                            // Delete existing CustomerInvoiceRow
                            ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                            // Delete existing CustomerInvoiceAccountRows
                            foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                            {
                                ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);

                                CustomerInvoiceAccountRow invoiceAccountRowInput = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                    where r.CustomerInvoiceAccountRowId == invoiceAccountRow.CustomerInvoiceAccountRowId
                                                                                    select r).FirstOrDefault();
                                if (invoiceAccountRowInput != null)
                                    processedInputInvoiceAccountRows.Add(invoiceAccountRowInput);
                            }
                        }

                        // Only used for calculating the numbers
                        GetTransferState(invoice, invoiceRow, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                    }

                    #endregion
                }

                #region Detach input CustomerInvoiceAccountRow to prevent adding new (must be detached AFTER all rows are processed)

                foreach (CustomerInvoiceAccountRow invoiceAccountRowInput in processedInputInvoiceAccountRows)
                {
                    base.TryDetachEntity(entities, invoiceAccountRowInput);
                }

                #endregion

                #region Detach input CustomerInvoiceRow to prevent adding new (must be detached AFTER all rows are processed)

                foreach (CustomerInvoiceRow invoiceRowInput in processedInputInvoiceRows)
                {
                    base.TryDetachEntity(entities, invoiceRowInput.HouseholdTaxDeductionRow);
                    base.TryDetachEntity(entities, invoiceRowInput);
                }

                #endregion

                #region CustomerInvoiceRow Add

                // Get new CustomerInvoiceRows
                List<CustomerInvoiceRow> invoiceRowsToAdd = (from r in invoiceRowsInput
                                                             where r.CustomerInvoiceRowId == 0 &&
                                                             r.State == (int)SoeEntityState.Active
                                                             select r).ToList();

                foreach (CustomerInvoiceRow invoiceRowToAdd in invoiceRowsToAdd)
                {
                    this.GetTransferState(invoice, invoiceRowToAdd, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);

                    foreach (CustomerInvoiceAccountRow invoiceAccountRowToAdd in invoiceRowToAdd.CustomerInvoiceAccountRow)
                    {
                        // Count asset rows
                        if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRowToAdd, invoiceAccountRowToAdd))
                            noOfAssetRows++;
                    }

                    // Add CustomerInvoiceRow to CustomerInvoice
                    invoice.CustomerInvoiceRow.Add(invoiceRowToAdd);

                    if (invoice.Project != null)
                    {
                        result = TimeTransactionManager.CreateTimeCodeTransaction(entities, actorCompanyId, invoiceRowToAdd, invoice.Project, standardMaterialCodeId);
                        if (!result.Success)
                            return result;
                    }
                }

                #endregion

                #endregion

                #region Set remaining amount

                if (!invoiceInput.ManuallyAdjustedAccounting)
                {
                    bool hasTransferedRows = false;
                    decimal cents = 0;

                    if (invoice.ActiveCustomerInvoiceRows.Any())
                    {
                        PriceListType priceListType = ProductPricelistManager.GetPriceListType(entities, invoice.PriceListTypeId != null ? (int)invoice.PriceListTypeId : 0, actorCompanyId);

                        //Hidden attest states 
                        var excludedAttestStates = InvoiceAttestStatesIds.GetClosedAndHiddenIds(originType);

                        foreach (var invoiceRow in invoice.ActiveCustomerInvoiceRows)
                        {
                            if (invoiceRow.AttestStateId.HasValue && excludedAttestStates.Contains(invoiceRow.AttestStateId.Value) && (!invoiceRow.ProductId.HasValue || (invoiceRow.ProductId != fixedPriceProductId && invoiceRow.ProductId != fixedPriceKeepPricesProductId)))
                                continue;

                            if (invoice.Origin.Type == (int)SoeOriginType.Order && ((invoiceRow.Type == (int)SoeInvoiceRowType.ProductRow || invoiceRow.Type == (int)SoeInvoiceRowType.BaseProductRow) ||
                                (invoiceRow.IsFreightAmountRow || invoiceRow.IsInterestRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsReminderRow)) &&
                                invoiceRow.AttestStateId != InvoiceAttestStatesIds.TransferredOrderToInvoiceId && invoiceRow.State != (int)SoeEntityState.Deleted)
                            {
                                if (invoiceRow.AttestStateId.HasValue && excludedAttestStates.Contains(invoiceRow.AttestStateId.Value) && (!invoiceRow.ProductId.HasValue || (invoiceRow.ProductId != fixedPriceProductId && invoiceRow.ProductId != fixedPriceKeepPricesProductId)))
                                    continue;

                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product == null || (((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    if (invoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && (priceListType == null || !priceListType.InclusiveVat))
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency;
                                    }
                                    else
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency;
                                    }

                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                    remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                }

                            }
                            else if (invoiceRow.IsCentRoundingRow)
                            {
                                if (invoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && (priceListType == null || !priceListType.InclusiveVat))
                                {
                                    cents = (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                }
                                else
                                {
                                    cents = invoiceRow.SumAmountCurrency;
                                }

                            }
                            else if (invoiceRow.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                            {
                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product != null && (((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    remainingCurrencyAmount += (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                    remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                }

                                hasTransferedRows = true;
                            }
                        }
                    }

                    int tryAmount = 0;
                    if (!Int32.TryParse(remainingCurrencyAmount.ToString(), out tryAmount))
                    {
                        if (hasTransferedRows)
                        {
                            remainingCurrencyAmount = Math.Round(remainingCurrencyAmount, 0, MidpointRounding.ToEven);
                        }
                        else
                        {
                            remainingCurrencyAmount += cents;
                        }
                    }

                    int tryAmountExVat = 0;
                    if (!int.TryParse(remainingCurrencyAmountExVat.ToString(), out tryAmountExVat))
                    {
                        if (hasTransferedRows)
                        {
                            remainingCurrencyAmountExVat = Math.Round(remainingCurrencyAmountExVat, 0, MidpointRounding.ToEven);
                        }
                        else
                        {
                            remainingCurrencyAmountExVat += cents;
                        }
                    }

                    int tryAmountVat = 0;
                    if (!Int32.TryParse(remainingCurrencyAmountVat.ToString(), out tryAmountVat))
                    {
                        if (hasTransferedRows)
                        {
                            remainingCurrencyAmountVat = Math.Round(remainingCurrencyAmountVat, 0, MidpointRounding.ToEven);
                        }
                        else
                        {
                            remainingCurrencyAmountVat += cents;
                        }
                    }

                    //Set remaining amount
                    invoice.RemainingAmount = remainingCurrencyAmount;
                    invoice.RemainingAmountVat = remainingCurrencyAmountVat;
                    invoice.RemainingAmountExVat = remainingCurrencyAmountExVat;

                    // Check for multiple asset rows
                    if (noOfAssetRows > 1)
                        invoice.MultipleAssetRows = true;
                }

                #region Update status

                //Synch Origin.Status with the current status of all CustomerInvoiceRow's
                if (!ignoreTransfer)
                {
                    switch (invoice.Origin.Type)
                    {
                        case (int)SoeOriginType.Offer:
                            if (transferredTo == SoeOriginType.Order)
                            {
                                UpdateInvoiceStatus(invoice, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.OfferFullyOrder, SoeOriginStatus.OfferPartlyOrder);
                            }
                            else if (transferredTo == SoeOriginType.CustomerInvoice)
                            {
                                UpdateInvoiceStatus(invoice, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.OfferFullyInvoice, SoeOriginStatus.OfferPartlyInvoice);
                            }
                            else if (transferredTo == SoeOriginType.None)
                            {
                                UpdateInvoiceStatus(invoice, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.Origin, SoeOriginStatus.Origin);
                            }
                            break;
                        case (int)SoeOriginType.Order:
                            if (transferredTo == SoeOriginType.CustomerInvoice)
                            {
                                UpdateInvoiceStatus(invoice, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OrderClosed, SoeOriginStatus.OrderFullyInvoice, SoeOriginStatus.OrderPartlyInvoice);
                            }
                            else if (transferredTo == SoeOriginType.None)
                            {
                                UpdateInvoiceStatus(invoice, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OrderClosed, SoeOriginStatus.Origin, SoeOriginStatus.Origin);
                            }
                            break;
                    }
                }

                #endregion

                #endregion

                #region Calculate currency amounts

                //Calculate currency amounts
                CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, invoice);

                #endregion

                #region Validate invoice accounting rows

                if (ValidateCustomerInvoiceAccountingRowsDiff(invoice))
                {
                    int accountRowNr = 1;
                    foreach (CustomerInvoiceRow invoiceRow in invoice.ActiveCustomerInvoiceRows)
                    {
                        invoiceRow.CustomerInvoiceAccountRow.ToList().ForEach(x => entities.DeleteObject(x));
                        CreateCustomerInvoiceAccountRow(entities, invoiceRow, (TermGroup_InvoiceVatType)invoice.VatType, ref accountRowNr, invoice.ActorId.Value, 0, invoice.ProjectId != null ? (int)invoice.ProjectId : 0, actorCompanyId, null, invoice.DefaultDim2AccountId, invoice.DefaultDim3AccountId, invoice.DefaultDim4AccountId, invoice.DefaultDim5AccountId, invoice.DefaultDim6AccountId, tripartiteTrade: invoice.TriangulationSales);
                    }

                    if (ValidateCustomerInvoiceAccountingRowsDiff(invoice))
                        return new ActionResult((int)ActionResultSave.HasUnbalancedAccountingRows, GetText(7406, 1, "Debet och kredit balanserar inte. Kontrollera konteringsrader och spara igen."));
                }

                #endregion

                #region Save

                if (result.Success)
                    result = SaveChanges(entities, transaction);

                #region Mobile Specific

                if (isMobileOrder)
                {
                    #region InvoiceFee

                    if (result.Success && addInvoice)
                        result = CreateInvoiceFee(transaction, entities, actorCompanyId, invoice);

                    #endregion
                }

                #endregion

                #region Voucher

                // Check if Payment should be saved at once
                if (result.Success && cashPayment && !invoiceInput.IsTemplate)
                    result = TryTransferCustomerInvoiceToPayment(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, invoice, DateTime.Today, TermGroup_SysPaymentMethod.Cash, actorCompanyId);

                // Check if Voucher should be saved at once
                if (result.Success && !invoiceInput.IsTemplate && !skipCreateVoucherCheck)
                {
                    result = TryTransferCustomerInvoiceToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, invoice, accountYearId, actorCompanyId);
                    if (result.Success)
                        voucherHeadsDict = NumberUtility.MergeDictictionary(voucherHeadsDict, result.IdDict);
                }

                #endregion

                if (result.Success)
                {
                    invoiceId = invoice.Origin.OriginId;

                    #region stock
                    if (invoice.Origin.Type == (int)SoeOriginType.Order && invoiceRowsDTOInput.Count > 0)
                    {
                        IEnumerable<CustomerInvoiceRow> deletedStockRows = processedInputInvoiceRows.Where<CustomerInvoiceRow>(d => (bool)d.IsStockRow && d.State == (int)SoeEntityState.Deleted);
                        foreach (var row in deletedStockRows)
                        {
                            if ((int)row.AttestStateId != 23 && row.StockId > 0)
                            {
                                CreateStockTransaction(entities, transaction, actorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                                        (int)row.ProductId, (int)row.StockId, -Convert.ToDecimal(GetQuantity(invoice.BillingType, row.Quantity)), -Convert.ToDecimal(GetQuantity(invoice.BillingType, row.InvoiceQuantity)), row.PurchasePrice, row.CustomerInvoiceRowId);
                            }
                        }
                    }

                    HandleStockOnInvoice(invoice, entities, transaction, actorCompanyId, stockDict, usePartialInvoicingOnOrderRow, draftToOrigin);

                    #endregion

                    #region Reference_Unique

                    // In Finland next step after this valid invoice is to focus on incoming payments.
                    // There we need to have only unique references within company. 
                    if (!invoiceInput.ManuallyAdjustedAccounting && seqNbr != 0 && String.IsNullOrEmpty(invoiceInput.OCR) && SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormReferenceNumberToOCR, 0, actorCompanyId, 0))
                    {
                        Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                        if (company == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                        if (company.SysCountryId != null)
                        {
                            switch ((int)company.SysCountryId)
                            {
                                case 2: //US
                                    break;
                                case 3: //Finland
                                    if (invoice.InvoiceNr != null && invoice.Actor.Customer.CustomerNr != null)
                                    {
                                        string tmpReference = invoice.Actor.Customer.CustomerNr.ToString() + "0000" + invoice.InvoiceNr.ToString();
                                        if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, actorCompanyId, 0))
                                        {
                                            invoice.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                        }
                                        else
                                        {
                                            invoice.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                        }
                                    }
                                    else
                                    {
                                        string errorCheck = "";
                                        if (invoice.InvoiceNr == null) errorCheck += "A=null";
                                        if (invoice.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                        invoice.OCR = "Virhe(1):" + errorCheck;
                                    }

                                    break;
                                case 4: //Norge
                                    if (invoice.InvoiceNr != null && invoice.Actor.Customer.CustomerNr != null)
                                    {
                                        invoice.OCR = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), invoice.Actor.Customer.CustomerNr.ToString(), (DateTime)invoice.InvoiceDate, 0);
                                    }
                                    break;
                                default:
                                    //Sverige...Case 1
                                    invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                                    break;
                            }
                        }
                        else
                        {
                            //Svenskt
                            invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                        }

                        SetModifiedProperties(invoice);
                        SaveChanges(entities);
                    }

                    #endregion

                    #region EntityHistory

                    GeneralManager.SaveEntityHistory(entities, entityType, invoiceId, DateTime.Now, true, true, false, actorCompanyId);

                    #endregion

                    //Modified rows
                    modifiedRowIds.Clear();
                    foreach (int tempRowId in modifiedRows.Keys)
                    {
                        modifiedRowIds.Add(tempRowId, modifiedRows[tempRowId].CustomerInvoiceRowId);
                    }

                    //Modified account rows
                    modifiedAccRowIds.Clear();
                    foreach (int tempRowId in modifiedAccRows.Keys)
                    {
                        modifiedAccRowIds.Add(tempRowId, modifiedAccRows[tempRowId].CustomerInvoiceAccountRowId);
                    }
                    setPrintTimeProjectAsChecked = invoice.PrintTimeReport;

                }

                #endregion
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
                result.IntegerValue = 0;
                seqNbr = 0;
            }
            finally
            {
                if (result.Success)
                {
                    //Set success properties
                    result.IntegerValue = invoiceId;
                    result.StringValue = invoiceNbr;
                    result.Value = seqNbr;
                    result.BooleanValue = invoiceInput.IsTemplate ? true : reloadAfterSave;
                    result.IntDict = modifiedRowIds;
                    result.IntDict2 = modifiedAccRowIds;
                    result.Value2 = returnProject;
                    result.BooleanValue2 = setPrintTimeProjectAsChecked;

                    if (invoiceInput.IsTemplate)
                        result.SuccessNumber = (int)ActionResultSave.CustomerInvoiceIsTemplate;

                    if (modified.HasValue)
                    {
                        result.Modified = modified.Value;
                        result.ModifiedBy = modifiedBy;
                    }
                    if (voucherHeadsDict != null)
                    {
                        result.IdDict = voucherHeadsDict;
                    }
                }
                else
                    base.LogTransactionFailed(this.ToString(), this.log);
            }

            return result;
        }

        public ActionResult SaveCustomerInvoiceInsecureStatus(int actorCompanyId, bool markAsInsecure, List<int> customerInvoiceIds)
        {
            ActionResult result;

            using (var entities = new CompEntities())
            {
                var query = (from entry in entities.Invoice.OfType<CustomerInvoice>()
                             where (entry.Origin.ActorCompanyId == actorCompanyId) &&
                             customerInvoiceIds.Contains(entry.InvoiceId) &&
                             entry.State == (int)SoeEntityState.Active
                             select entry).ToList();

                foreach (var item in query)
                {
                    if (item.InsecureDebt == markAsInsecure)
                        continue;

                    item.InsecureDebt = markAsInsecure;
                    SetModifiedProperties(item);
                }

                result = SaveChanges(entities);
            }

            return result;
        }

        public ActionResult TransferCustomerInvoicesToVoucher(List<CustomerInvoiceGridDTO> items, int actorCompanyId)
        {
            ActionResult result = new ActionResult();
            using (CompEntities entities = new CompEntities())
            {
                List<CustomerInvoice> customerInvoices = new List<CustomerInvoice>();

                foreach (var item in items)
                {
                    CustomerInvoice customerInvoice = InvoiceManager.GetCustomerInvoice(entities, item.CustomerInvoiceId, true, true, true, false, false, false, false, true, true, false, false, false);
                    if (customerInvoice == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(8082, "Underlaget kunde inte hittas"));
                    if (customerInvoice.VoucherHeadId != null)
                        return new ActionResult((int)ActionResultSave.VoucherExists, $"{GetText(176, "Felaktig statusförändring")}: {GetText(1910, "Fakturanr")} {customerInvoice.InvoiceNr}");

                    if (customerInvoice.ActorReference.IsLoaded && customerInvoice.Actor.CustomerReference.IsLoaded)
                    {
                        if (customerInvoice.Actor.Customer.BlockInvoice)
                            return new ActionResult((int)ActionResultSave.CustomerIsBlocked, GetText(8309) + ": " + customerInvoice.Actor.Customer.CustomerNr + " - " + customerInvoice.Actor.Customer.Name);
                    }
                    else
                    {
                        if ((from customer in entities.Customer
                             where customer.State == (int)SoeEntityState.Active && customer.ActorCustomerId == customerInvoice.ActorId
                             select customer.BlockInvoice).FirstOrDefault())
                            return new ActionResult((int)ActionResultSave.CustomerIsBlocked, GetText(8309));
                    }

                    customerInvoices.Add(customerInvoice);
                }

                var voucherResult = VoucherManager.SaveVoucherFromCustomerInvoices(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, customerInvoices, actorCompanyId);

                // Temp 
                result = voucherResult;
            }
            return result;
        }
        public ActionResult TryTransferCustomerInvoiceToVoucher(int invoiceId, int actorCompanyId)
        {
            ActionResult result;
            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    var customerInvoice = GetCustomerInvoice(entities, invoiceId, true);
                    var accountYearId = AccountManager.GetAccountYearId(entities, customerInvoice.VoucherDate ?? DateTime.Today, actorCompanyId);

                    result = TryTransferCustomerInvoiceToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, customerInvoice, accountYearId, actorCompanyId);
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new ActionResult(false) { Exception = ex };
                }
            }
            return result;
        }

        public ActionResult TryTransferCustomerInvoiceToVoucher(CompEntities entities, TransactionScopeOption transactionScopeOption, CustomerInvoice customerInvoice, int accountYearId, int actorCompanyId)
        {
            if (customerInvoice == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

            var customerInvoices = new List<CustomerInvoice>() { customerInvoice };

            return TryTransferCustomerInvoicesToVoucher(entities, transactionScopeOption, customerInvoices, actorCompanyId);
        }

        public ActionResult TryTransferCustomerInvoicesToVoucher(CompEntities entities, TransactionScopeOption transactionScopeOption, List<CustomerInvoice> customerInvoices, int actorCompanyId)
        {
            ActionResult result = new ActionResult(true);

            bool transferToVoucher = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceTransferToVoucher, 0, actorCompanyId, 0);
            if (!transferToVoucher)
                return result;

            List<CustomerInvoice> customerInvoicesToTransfer = new List<CustomerInvoice>();

            foreach (CustomerInvoice customerInvoice in customerInvoices)
            {
                //Check if valid to be transferred
                bool isValid = IsCustomerInvoiceValidForVoucher(entities, customerInvoice.Origin.Status, customerInvoice.RegistrationType, customerInvoice.ManuallyAdjustedAccounting);
                if (!isValid)
                    continue;

                //Make sure Origin and VoucherHead is loaded
                if (!customerInvoice.IsAdded())
                {
                    if (!customerInvoice.OriginReference.IsLoaded)
                        customerInvoice.OriginReference.Load();
                    if (!customerInvoice.VoucherHeadReference.IsLoaded)
                        customerInvoice.VoucherHeadReference.Load();
                }

                //Check if already transferred
                if (customerInvoice.VoucherHead != null)
                    continue;

                LoadCustomerInvoiceRows(customerInvoice, loadInvoiceAccountRow: true);

                customerInvoicesToTransfer.Add(customerInvoice);
            }

            if (customerInvoicesToTransfer.Count > 0)
                result = VoucherManager.SaveVoucherFromCustomerInvoices(entities, transactionScopeOption, customerInvoicesToTransfer, actorCompanyId);

            return result;
        }

        public ActionResult TryTransferCustomerInvoiceToPayment(CompEntities entities, TransactionScopeOption transactionScopeOption, CustomerInvoice customerInvoice, DateTime? bulkPayDate, TermGroup_SysPaymentMethod sysPaymentMethod, int actorCompanyId)
        {
            if (customerInvoice == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoice");

            var customerInvoices = new List<CustomerInvoice>();
            customerInvoices.Add(customerInvoice);

            return TryTransferCustomerInvoicesToPayment(entities, transactionScopeOption, customerInvoices, bulkPayDate, sysPaymentMethod, actorCompanyId);
        }

        private ActionResult TryTransferCustomerInvoicesToPayment(CompEntities entities, TransactionScopeOption transactionScopeOption, List<CustomerInvoice> customerInvoices, DateTime? bulkPayDate, TermGroup_SysPaymentMethod sysPaymentMethod, int actorCompanyId)
        {
            ActionResult result = new ActionResult(true);

            PaymentMethod paymentMethod = PaymentManager.GetPaymentMethodBySysId(entities, (int)sysPaymentMethod, actorCompanyId);
            if (paymentMethod == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "PaymentMethod");

            var itemsToTransfer = new List<CustomerInvoiceGridDTO>();

            foreach (CustomerInvoice customerInvoice in customerInvoices)
            {
                //Check if valid to be transferred
                bool isValid = IsCustomerInvoiceValidForPayment(entities, customerInvoice.Origin.Status, customerInvoice.RegistrationType);
                if (!isValid)
                    continue;

                CustomerInvoiceGridDTO item = GetCustomerInvoiceForGrid(entities, customerInvoice.InvoiceId, actorCompanyId);
                if (item == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "ChangeStatusGridView");

                //Check if already payed
                if (item.FullyPaid)
                    continue;

                itemsToTransfer.Add(item);
            }

            int baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(actorCompanyId);
            bool foreign = itemsToTransfer.Any(i => i.SysCurrencyId != baseSysCurrencyId);

            if (itemsToTransfer.Count > 0)
                result = PaymentManager.SavePaymentFromCustomerInvoice(entities, transactionScopeOption, itemsToTransfer, bulkPayDate, paymentMethod.PaymentMethodId, actorCompanyId, foreign);

            return result;
        }

        public ActionResult TryTransferAttachments(CompEntities entities, TransactionScopeOption transactionScopeOption, List<CustomerInvoice> customerInvoices)
        {
            ActionResult result = new ActionResult(true);

            try
            {
                if (entities.Connection.State != ConnectionState.Open)
                    entities.Connection.Open();

                // Possible to include this method in a running Transaction
                using (TransactionScope transaction = new TransactionScope(transactionScopeOption, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                {

                    foreach (CustomerInvoice customerInvoice in customerInvoices)
                    {

                        if (customerInvoice.TempImagesToCopy != null && customerInvoice.TempImagesToCopy.Count > 0)
                        {
                            foreach (var images in customerInvoice.TempImagesToCopy)
                            {
                                var attachedImages = images;

                                //Update with newly created InvoiceId
                                attachedImages.RecordId = customerInvoice.InvoiceId;

                                entities.Images.AddObject(attachedImages);
                            }

                            customerInvoice.StatusIcon = GetStatusIcon(customerInvoice.StatusIcon, true, SoeStatusIcon.Image);
                        }


                        if (customerInvoice.TempAttachmentsToCopy != null && customerInvoice.TempAttachmentsToCopy.Count > 0)
                        {
                            foreach (var attachment in customerInvoice.TempAttachmentsToCopy)
                            {
                                attachment.RecordId = customerInvoice.InvoiceId;
                            }

                            customerInvoice.StatusIcon = GetStatusIcon(customerInvoice.StatusIcon, true, SoeStatusIcon.Attachment);
                        }

                    }

                    if (result.Success)
                        result = SaveChanges(entities, transaction);

                    //Commit transaction
                    if (result.Success)
                        transaction.Complete();
                }
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
            }
            finally
            {
                if (result.Success)
                {
                    //Set success properties

                }
                else
                    base.LogTransactionFailed(this.ToString(), this.log);

                if (transactionScopeOption != ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH)
                    entities.Connection.Close();
            }

            return result;
        }

        private void SetInvoiceProperties(CustomerInvoice invoice, IDictionary<string, object> values, bool useAllowChangeWhenDefinitiv, ref bool defaultInternalAccountChanged, ref bool vatTypeChanged, ref bool priceListChanged, ref bool customerChanged)
        {
            string[] excludes = { "categoryids", "projectnr", "created", "modified", "createdby", "modifiedby" };

            defaultInternalAccountChanged = false;

            var props = invoice.GetType().GetProperties();
            foreach (var prop in props)
            {
                string lcName = prop.Name.ToLower();

                if ((useAllowChangeWhenDefinitiv) && !allowChangeWhenDefinitiv.Contains(lcName))
                {
                    continue;
                }

                if (values.ContainsKey(lcName) && !excludes.Contains(lcName))
                {
                    var value = values[lcName];

                    if (internalAccountFields.Contains(lcName))
                    {
                        //Compare if value changed
                        if (prop.GetValue(invoice) != value)
                            defaultInternalAccountChanged = true;
                    }

                    if (lcName == "vattype")
                    {
                        if (prop.GetValue(invoice) != value)
                            vatTypeChanged = true;
                    }
                    else if (lcName == "pricelisttypeid")
                    {
                        if (prop.GetValue(invoice) != value)
                            priceListChanged = true;
                    }
                    else if (lcName == "actorid")
                    {
                        if (prop.GetValue(invoice) != value)
                            customerChanged = true;
                    }

                    if (lcName == "marginalincomeratio")
                    {
                        var ratio = Convert.ToDecimal(value);
                        ratio = ratio >= 0 ? Math.Min(ratio, 99999) : Math.Max(ratio, -99999);
                        prop.SetValue(invoice, ratio);
                    }
                    else if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                        prop.SetValue(invoice, Convert.ToDecimal(value));
                    else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                    {
                        if (invoiceTreat0asNullHead.Contains(lcName) && value != null && Convert.ToInt32(value) == 0)
                        {
                            value = null;
                        }
                        prop.SetValue(invoice, value == null ? (int?)null : Convert.ToInt32(value));
                    }
                    else if ((prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?)) && value != null)
                    {
                        DateTime dt = (DateTime)value;
                        if (dt.Year < 1900)
                            prop.SetValue(invoice, new DateTime(1900, dt.Month, dt.Day));
                        else
                            prop.SetValue(invoice, value);
                    }
                    else
                        prop.SetValue(invoice, value);
                }
            }
        }

        private bool RowContainsHouseDeduction(IDictionary<string, object> invoiceRowInput)
        {
            object householdproperty;
            object householdcooperativeorgnbr;
            object householdtypeisrut;

            invoiceRowInput.TryGetValue("householdproperty", out householdproperty);
            invoiceRowInput.TryGetValue("householdcooperativeorgnbr", out householdcooperativeorgnbr);
            invoiceRowInput.TryGetValue("householdcooperativeorgnbr", out householdtypeisrut);

            if (
                    householdproperty != null ||
                    householdcooperativeorgnbr != null ||
                    (householdtypeisrut != null && (bool)householdtypeisrut)
               )
            {
                return true;
            }

            return false;
        }

        #region Import File To Object
        public ActionResult ImportProductRows(byte[] bytes, int wholesellerId, int invoiceId, TermGroup_InvoiceRowImportType fileTypeId, int actorCustomerId, int actorCompanyId)
        {
            ActionResult result = new ActionResult(true);

            try
            {
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                result = CustomerInvoiceRowImportUtility.ProductImport(entitiesReadOnly, bytes, fileTypeId, actorCustomerId, actorCompanyId, wholesellerId, invoiceId, CountryCurrencyManager, AttestManager, parameterObject);
                if (result.Value == null) return new ActionResult { Success = false, ErrorMessage = "Failed finding product" };
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
                result.IntegerValue = 0;
                return new ActionResult(ex);
            }
            return result;
        }
        #endregion

        public ActionResult SaveInvoice(dynamic modifiedFields, List<ProductRowDTO> newRows, List<ExpandoObject> modifiedRows, List<ChecklistHeadRecordCompactDTO> checklistHeads, List<ChecklistExtendedRowDTO> checklistRows, List<OriginUserDTO> originUsers, List<FileUploadDTO> invoiceAttachments, bool discardConcurrencyCheck, bool regenerateAccounting, bool sendXEMail, bool crediting)
        {
            var result = new ActionResult();

            #region Prereq

            var values = (IDictionary<string, object>)modifiedFields;
            bool invoiceIsTemplate = false;
            bool setPrintTimeProjectAsChecked = false;
            DateTime? modified = null;
            string modifiedBy = null;
            string invoiceNbr = string.Empty;
            int seqNbr = 0;
            decimal remainingCurrencyAmount = 0;
            decimal remainingCurrencyAmountVat = 0;
            decimal remainingCurrencyAmountExVat = 0;
            TimeProjectDTO returnProject = null;
            Dictionary<int, int> voucherHeadsDict = null;
            Dictionary<int, int> modifiedRowIds = new Dictionary<int, int>();
            Dictionary<int, CustomerInvoiceRow> modifiedOrderRows = new Dictionary<int, CustomerInvoiceRow>();

            int invoiceId = values.ContainsKey("id") ? Convert.ToInt32(values["id"]) : 0;
            SoeEntityType entityType = SoeEntityType.CustomerInvoice;
            var draftToOrigin = false;

            #region Settings

            bool? conflictSetting = values.ContainsKey("checkconflictsonsave") ? (bool?)values["checkconflictsonsave"] : null;
            if (conflictSetting != null)
                SettingManager.UpdateInsertBoolSetting(SettingMainType.User, (int)UserSettingType.BillingCheckConflictsOnSave, conflictSetting.Value, base.UserId, base.ActorCompanyId, 0);

            #endregion

            #endregion

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    #region Prereq

                    // Check if order was modified after current order was fetched
                    if (!discardConcurrencyCheck && values.ContainsKey("modified"))
                    {
                        DateTime? currentModified = null;
                        var field = values["modified"];
                        if (field != null)
                        {
                            currentModified = (DateTime)field;
                            values.Remove("modified");
                        }

                        if (base.IsEntityModified(entities, invoiceId, entityType, currentModified, out modified, out modifiedBy))
                            return new ActionResult((int)ActionResultSave.EntityIsModifiedByOtherUser, String.Format(GetText(5643, "{0} av {1}"), modified, modifiedBy));
                    }

                    List<CustomerInvoiceRow> parentInvoiceRows = null;
                    if (crediting && values.ContainsKey("previnvoiceid") && values["previnvoiceid"] != null)
                    {
                        var prevInvoiceId = Convert.ToInt32(values["previnvoiceid"]);
                        parentInvoiceRows = prevInvoiceId > 0 ? GetCustomerInvoiceRowsForOrderInvoiceEdit(entities, prevInvoiceId, true, false, false) : new List<CustomerInvoiceRow>();
                    }

                    #endregion


                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        //Load invoice
                        //Always load rows since they and its sub table can be needed 
                        CustomerInvoice invoice = invoiceId != 0 ? GetCustomerInvoice(entities, invoiceId, true, true, true, false, true, false, false, true, regenerateAccounting, false, false, false) : null;

                        // Validate account period
                        if (values.ContainsKey("voucherdate") && values["voucherdate"] != null && (invoice == null || (invoice.Origin.Status == (int)SoeOriginStatus.Draft || invoice.Origin.Status == (int)SoeOriginStatus.Origin)))
                        {
                            var voucherDate = (DateTime)values["voucherdate"];
                            AccountPeriod accountPeriod = AccountManager.GetAccountPeriod(entities, voucherDate, ActorCompanyId);
                            if (accountPeriod.Status != (int)TermGroup_AccountStatus.Open)
                                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(4787, "Angiven redovisningsperiod är inte öppen"));
                        }

                        //Standard materialcode
                        int standardMaterialCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStandardMaterialCode, 0, base.ActorCompanyId, 0);

                        //AccountYear
                        int accountYearId = SettingManager.GetIntSetting(entities, SettingMainType.UserAndCompany, (int)UserSettingType.AccountingAccountYear, base.UserId, base.ActorCompanyId, 0);

                        bool vatTypeChanged = false;
                        bool defaultInternalAccountChanged = false;
                        bool priceListChanged = false;
                        bool customerChanged = false;

                        //Some fields are allow to change even if invoice is definitiv....
                        if (invoice != null && invoice.Origin.Status == (int)SoeOriginStatus.Voucher)
                        {
                            if (values.ContainsKey("origindescription"))
                            {
                                invoice.Origin.Description = (string)values["origindescription"];
                                values.Remove("origindescription");
                            }

                            if (values.ContainsKey("customeremail"))
                            {
                                invoice.CustomerEmail = (string)values["customeremail"];
                                values.Remove("customeremail");
                            }

                            SetInvoiceProperties(invoice, values, true, ref defaultInternalAccountChanged, ref vatTypeChanged, ref priceListChanged, ref customerChanged);

                            //only a one/few properties on rows can be changed when definitiv
                            if (!modifiedRows.IsNullOrEmpty())
                            {
                                var allowChangePurchasePrice = FeatureManager.HasRolePermission(Feature.Billing_Invoice_Invoices_Edit_ProductRows_AllowUpdatePurchasePrice, Permission.Modify, this.RoleId, this.ActorCompanyId, 0, entities);
                                foreach (IDictionary<string, object> modifedRow in modifiedRows)
                                {
                                    var customerInvoiceRowId = (Int64)modifedRow["customerinvoicerowid"];
                                    var row = invoice.CustomerInvoiceRow.FirstOrDefault(x => x.CustomerInvoiceRowId == customerInvoiceRowId);

                                    if (row != null)
                                    {
                                        if (modifedRow.ContainsKey("householddeductiontype"))
                                        {
                                            var housholdDeductionType = (Int64)modifedRow["householddeductiontype"];
                                            if (row.HouseholdDeductionType != housholdDeductionType)
                                            {
                                                row.HouseholdDeductionType = (int)housholdDeductionType;
                                            }
                                        }
                                        else if (allowChangePurchasePrice && modifedRow.ContainsKey("purchasepricecurrency"))
                                        {
                                            UpdateInvoiceRowProperties(row, modifedRow, new List<string> { "purchaseprice", "purchasepricecurrency", "marginalincome", "marginalincomecurrency", "marginalincomeratio" });
                                        }
                                    }
                                }
                            }


                            result = SaveChanges(entities, transaction);

                            if (invoiceAttachments != null && invoiceAttachments.Any())
                            {
                                var newStatusIcon = SaveOrderInvoiceAttachments(entities, invoice.InvoiceId, invoice.StatusIcon, invoiceAttachments, invoice.InvoiceNr);
                                if (newStatusIcon != invoice.StatusIcon)
                                {
                                    invoice.StatusIcon = newStatusIcon;
                                    SaveChanges(entities);
                                }
                            }

                            transaction.Complete();
                            return result;
                        }

                        bool addInvoice = invoice == null;

                        if (invoiceId == 0)
                        {
                            #region Add

                            if (addInvoice)
                            {
                                #region Origin

                                int? voucherSeriesTypeId = null;

                                if (values.ContainsKey("voucherseriestypeid"))
                                    voucherSeriesTypeId = Convert.ToInt32(values["voucherseriestypeid"]);

                                if (voucherSeriesTypeId == 0)
                                    voucherSeriesTypeId = null;

                                // Create new Origin, fields will be set in update below
                                var origin = new Origin()
                                {
                                    VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]),
                                    VoucherSeriesTypeId = voucherSeriesTypeId,
                                    Type = Convert.ToInt32(SoeOriginType.CustomerInvoice),
                                    Status = Convert.ToInt32(values["originstatus"]),

                                    //Set FK
                                    ActorCompanyId = base.ActorCompanyId,
                                };
                                if (values.ContainsKey("origindescription"))
                                {
                                    origin.Description = (string)values["origindescription"];
                                    values.Remove("origindescription");
                                }
                                SetCreatedProperties(origin);
                                entities.Origin.AddObject(origin);

                                #endregion

                                #region OriginUser

                                // Add current user to origin
                                var originUser = new OriginUser()
                                {
                                    Main = true,

                                    //Set FK
                                    UserId = base.UserId,

                                    //Set references
                                    Origin = origin,
                                };
                                origin.OriginUser.Add(originUser);
                                SetCreatedProperties(originUser);

                                #endregion

                                #region CustomerInvoice

                                // Create new CustomerInvoice, fields will be set in update below
                                invoice = new CustomerInvoice()
                                {
                                    // Inherited from Invoice
                                    Origin = origin,
                                    Type = (int)SoeInvoiceType.CustomerInvoice,
                                    OnlyPayment = false,
                                    PaidAmountCurrency = 0,
                                    FullyPayed = false,
                                    SysPaymentTypeId = 0,
                                    PaymentNr = string.Empty,
                                    MultipleAssetRows = false, // Will be calculated'
                                    RegistrationType = (int)OrderInvoiceRegistrationType.Invoice,
                                    InvoiceNr = string.Empty,
                                    SeqNr = 0,
                                };

                                if (values.ContainsKey("OrderNumbers"))
                                    invoice.OrderNumbers = (string)values["OrderNumbers"];

                                entities.Invoice.AddObject(invoice);
                                SetCreatedProperties(invoice);

                                #endregion
                            }

                            #endregion

                        }
                        else
                        {
                            #region Update

                            // Update Origin
                            if (values.ContainsKey("voucherseriesid"))
                            {
                                invoice.Origin.VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]);
                                values.Remove("voucherseriesid");
                            }
                            if (values.ContainsKey("voucherseriestypeid"))
                            {
                                invoice.Origin.VoucherSeriesTypeId = Convert.ToInt32(values["voucherseriestypeid"]);
                                values.Remove("voucherseriestypeid");
                            }
                            if (values.ContainsKey("origindescription"))
                            {
                                invoice.Origin.Description = (string)values["origindescription"];
                                values.Remove("origindescription");
                            }
                            if (values.ContainsKey("originstatus"))
                            {
                                int origStatus = Convert.ToInt32(values["originstatus"]);
                                if (invoice.Origin.Status != origStatus)
                                {
                                    draftToOrigin = IsFirstDraft(invoice) && (origStatus == (int)SoeOriginStatus.Origin);

                                    invoice.Origin.Status = origStatus;
                                }
                                values.Remove("originstatus");
                            }

                            SetModifiedProperties(invoice.Origin);
                            SetModifiedProperties(invoice);

                            #endregion
                        }

                        SetInvoiceProperties(invoice, values, false, ref defaultInternalAccountChanged, ref vatTypeChanged, ref priceListChanged, ref customerChanged);
                        SetPriceListTypeInclusiveVat(entities, invoice, ActorCompanyId);

                        #region Previous invoice

                        if (addInvoice && values.ContainsKey("previnvoiceid") && Convert.ToInt32(values["previnvoiceid"]) > 0)
                        {
                            // Add mapping from originating invoice (used when credit)
                            var oimap = new OriginInvoiceMapping()
                            {
                                Origin = invoice.Origin,
                                Type = (int)GetOriginInvoiceMappingType(invoice),
                                InvoiceId = Convert.ToInt32(values["previnvoiceid"])
                            };
                            entities.OriginInvoiceMapping.AddObject(oimap);

                            // Add mapping(s) from originating order(s) of previous debit invoice
                            int prevInvoiceId = Convert.ToInt32(values["previnvoiceid"]);
                            var oimaps = (from i in entities.OriginInvoiceMapping
                                          where i.InvoiceId == prevInvoiceId &&
                                          i.Type == (int)SoeOriginInvoiceMappingType.Order
                                          select i).ToList();

                            foreach (var oimap2 in oimaps)
                            {
                                oimap = new OriginInvoiceMapping()
                                {
                                    OriginId = oimap2.OriginId,
                                    Type = oimap2.Type,
                                    InvoiceId = invoice.Origin.OriginId
                                };
                                entities.OriginInvoiceMapping.AddObject(oimap);
                            }
                        }

                        #endregion

                        invoiceIsTemplate = invoice.IsTemplate;

                        if (invoice.InvoicePaymentService == 0)
                            invoice.InvoicePaymentService = null;

                        //fix up if not set  correctly
                        if (invoice.CurrencyRate == 0)
                            invoice.CurrencyRate = 1;

                        #region Project

                        result = HandleProjectOnSaveInvoice(entities, invoice, ActorCompanyId, values, standardMaterialCodeId, ref returnProject);

                        if (!result.Success)
                            return result;

                        #endregion

                        #region SeqNr
                        seqNbr = invoice.SeqNr.HasValue ? (int)invoice.SeqNr : 0;
                        // Offers and orders will get a sequence number as draft. Invoices will get a sequence when saved as origin.
                        if (seqNbr == 0 && (invoice.Origin.Status == (int)SoeOriginStatus.Origin)) // && !invoiceInput.IsTemplate)
                        {
                            // Get next sequence number
                            var seqDTO = InvoiceManager.GetNextSequenceNumber(entities, invoice, false);

                            invoice.SeqNr = seqNbr = seqDTO.SeqNr;

                            // Set invoice number to same as sequence number (padded to a specified number of digits)
                            if (String.IsNullOrEmpty(invoice.InvoiceNr))
                                invoice.InvoiceNr = seqNbr.ToString().PadLeft(seqDTO.NumberLength, '0');

                            // Set dates
                            if (invoice.InvoiceDate == null)
                                invoice.InvoiceDate = DateTime.Today;
                            if (invoice.VoucherDate == null)
                                invoice.VoucherDate = DateTime.Today;
                        }
                        #endregion SeqNr

                        #region Rows - Remember to set hashouseholdtax on invoice

                        //Counters used to decide if an offer or order is fully or partly transferred, or not transferred at all.
                        int noOfTransferredRows = 0;
                        int noOfClosedRows = 0;
                        int noOfNotTransferredRows = 0;

                        //Assign transferredTo only once, presuppose that a offer only can be transferred to a order or a invoice, not both
                        SoeOriginType transferredTo = SoeOriginType.None;

                        //Counter used do decide if invoice has multiple asset rows
                        int noOfAssetRows = 0;

                        var processedInputInvoiceRows = new List<CustomerInvoiceRow>();
                        var processedInputInvoiceAccountRows = new List<CustomerInvoiceAccountRow>();

                        // Stock

                        Dictionary<int, Tuple<Decimal, Decimal, bool, int, int, int>> stockDict = new Dictionary<int, Tuple<Decimal, Decimal, bool, int, int, int>>();

                        int nextRowNr = 2;  // Claim row will get number 1
                                            // Update or Delete existing CustomerInvoiceRows
                        foreach (var invoiceRow in invoice.ActiveCustomerInvoiceRows)
                        {
                            #region CustomerInvoiceRow Update/Delete

                            var updateAccountingRows = false;
                            // Try get CustomerInvoiceRow from input
                            var invoiceRowInput = (from r in modifiedRows
                                                   where (Int64)((IDictionary<string, object>)r)["customerinvoicerowid"] == invoiceRow.CustomerInvoiceRowId
                                                   select r).FirstOrDefault() as IDictionary<string, object>;

                            if (invoiceRowInput == null)
                            {
                                updateAccountingRows = defaultInternalAccountChanged || vatTypeChanged || priceListChanged;
                            }
                            else
                            {
                                invoiceRow.LoadHouseholdTaxDeductionRowReference();

                                //Inherit AttestState from parent
                                if (invoiceRowInput.ContainsKey("parentrow") && (!invoiceRowInput.ContainsKey("previouslyinvoicedquantity") || Convert.ToInt32(invoiceRowInput["previouslyinvoicedquantity"]) == 0))
                                {
                                    // Hur ser detta ut...
                                }

                                // Household tax deduction
                                if (invoiceRow.HouseholdTaxDeductionRow == null && RowContainsHouseDeduction(invoiceRowInput))
                                {
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(invoice, invoiceRow, invoiceRowInput);
                                    if (!result.Success)
                                    { return result; }
                                }
                                else if (invoiceRow.HouseholdTaxDeductionRow != null)
                                {
                                    HouseholdTaxDeductionManager.UpdateHouseholdTaxDeductionRow(invoiceRow, invoiceRowInput);
                                }

                                bool isRowTransferred = GetTransferStateOfOrderRow(invoiceRowInput.ContainsKey("atteststateid") ? Convert.ToInt32(invoiceRowInput["atteststateid"]).ToNullable() : null, Convert.ToInt32(invoiceRowInput["type"]), ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                if (isRowTransferred)
                                {
                                    #region CustomerInvoiceRow transferred (can not update or delete, only update row number)

                                    int rowNr = Convert.ToInt32(invoiceRowInput["rownr"]);
                                    if (invoiceRow.RowNr != rowNr)
                                    {
                                        invoiceRow.RowNr = rowNr;
                                        SetModifiedProperties(invoiceRow);
                                    }

                                    // Delete existing CustomerInvoiceAccountRows
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    CreateCustomerInvoiceAccountRow(entities, invoice, invoiceRow, (TermGroup_InvoiceVatType)invoice.VatType, ref nextRowNr, invoice.ActorId.HasValue ? invoice.ActorId.Value : 0, 0, invoice.ProjectId.HasValue ? invoice.ProjectId.Value : 0, base.ActorCompanyId, (invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null));

                                    #endregion
                                }
                                else
                                {
                                    if (Convert.ToInt32(invoiceRowInput["state"]) == (int)SoeEntityState.Deleted)
                                    {
                                        #region CustomerInvoiceRow Delete

                                        //CustomerInvoiceReminder
                                        if (invoiceRow.IsReminderRow)
                                            DecreaseNoOfReminders(entities, invoiceRow);

                                        if (invoiceRow.IsTimeProjectRow && invoiceRowInput.ContainsKey("timemanuallychanged"))
                                        {
                                            invoiceRow.TimeManuallyChanged = (bool)invoiceRowInput["timemanuallychanged"];
                                            SetModifiedProperties(invoiceRow);
                                        }
                                        // Delete existing CustomerInvoiceRow
                                        ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                                        // Delete existing CustomerInvoiceAccountRows
                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        // Delete existing household tax deduction row
                                        if (invoiceRow.HouseholdTaxDeductionRow != null)
                                            ChangeEntityState(invoiceRow.HouseholdTaxDeductionRow, SoeEntityState.Deleted);

                                        if (invoice.Project != null)
                                            TimeTransactionManager.DeleteTimeCodeTransactions(invoiceRow);

                                        HandleStockOnInvoiceRowDelete(entities, transaction, invoice, invoiceRow, false);

                                        #endregion
                                    }
                                    else
                                    {
                                        #region CustomerInvoiceRow Update

                                        #region Update properties and references

                                        bool isStockRowOld = invoiceRow.IsStockRow != null ? invoiceRow.IsStockRow.Value : false;
                                        object dictValue = null;
                                        invoiceRowInput.TryGetValue("isstockrow", out dictValue);
                                        var isStockRowNew = dictValue == null ? false : (bool)dictValue;

                                        int stockId = invoiceRow.StockId != null ? invoiceRow.StockId.Value : 0;
                                        int productId = invoiceRow.ProductId != null ? invoiceRow.ProductId.Value : 0;
                                        int attestStateId = invoiceRow.AttestStateId != null ? invoiceRow.AttestStateId.Value : 0;

                                        decimal quantity = Decimal.Zero;
                                        if (invoiceRow.Quantity != null)
                                        {
                                            quantity = invoice.BillingType == (int)TermGroup_BillingType.Debit ? invoiceRow.Quantity.Value : Decimal.Negate(invoiceRow.Quantity.Value);
                                        }

                                        decimal invoiceQuantity = Decimal.Zero;
                                        if (invoiceRow.InvoiceQuantity != null)
                                        {
                                            invoiceQuantity = invoice.BillingType == (int)TermGroup_BillingType.Debit ? invoiceRow.InvoiceQuantity.Value : Decimal.Negate(invoiceRow.InvoiceQuantity.Value);
                                        }

                                        if (isStockRowOld || isStockRowNew)
                                            stockDict.Add(invoiceRow.CustomerInvoiceRowId, new Tuple<decimal, decimal, bool, int, int, int>(quantity, invoiceQuantity, isStockRowOld, stockId, productId, attestStateId));

                                        UpdateInvoiceRowProperties(invoiceRow, invoiceRowInput);

                                        SetModifiedProperties(invoiceRow);

                                        #endregion

                                        updateAccountingRows = true;

                                        #region TimeCodeTransaction

                                        if (invoice.Project != null)
                                        {
                                            result = TimeTransactionManager.UpdateTimeCodeTransactions(entities, base.ActorCompanyId, invoiceRow, invoice.Project, standardMaterialCodeId);
                                            if (!result.Success)
                                                return result;
                                        }

                                        #endregion

                                        #endregion
                                    }
                                }
                            }

                            if (updateAccountingRows && invoiceRow.State == (int)SoeEntityState.Active && (invoiceRow.Type != (int)SoeInvoiceRowType.AccountingRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsFreightAmountRow))
                            {
                                if (invoiceRowInput != null && (!invoiceRowInput.Keys.Contains("splitaccountingrows") || invoiceRowInput["splitaccountingrows"] == null || ((List<object>)invoiceRowInput["splitaccountingrows"]).Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any(r => r.SplitPercent > 0 && r.SplitType > 0))
                                {
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows.Where(r => r.VatRow))
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null)
                                    {
                                        CreateCustomerInvoiceAccountRow(entities, invoice, invoiceRow, (TermGroup_InvoiceVatType)invoice.VatType, ref nextRowNr, invoice.ActorId.HasValue ? invoice.ActorId.Value : 0, 0, invoice.ProjectId.HasValue ? invoice.ProjectId.Value : 0, base.ActorCompanyId, null, true);
                                    }
                                }
                                else
                                {
                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null)
                                    {
                                        var splitAccountingRows = (invoiceRowInput != null && invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null);

                                        List<AccountInternal> internals = null;
                                        if ((splitAccountingRows == null || splitAccountingRows.Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any())
                                        {
                                            var first = invoiceRow.ActiveCustomerInvoiceAccountRows.FirstOrDefault(r => !r.VatRow);
                                            if (first != null)
                                            {
                                                if (!first.AccountInternal.IsLoaded)
                                                    first.AccountInternal.Load();

                                                internals = first.AccountInternal.ToList();
                                            }
                                        }

                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        CreateCustomerInvoiceAccountRow(entities, invoice, invoiceRow, (TermGroup_InvoiceVatType)invoice.VatType, ref nextRowNr, invoice.ActorId.HasValue ? invoice.ActorId.Value : 0, 0, invoice.ProjectId.HasValue ? invoice.ProjectId.Value : 0, base.ActorCompanyId, splitAccountingRows, internals: internals);
                                    }
                                }
                                processedInputInvoiceRows.Add(invoiceRow);
                            }
                            #endregion
                        }

                        if (newRows.Count > 0)
                        {
                            var discountAccountId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCustomerDiscount, 0, base.ActorCompanyId, 0);
                            var discountOffsetAccountId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCustomerDiscountOffset, 0, base.ActorCompanyId, 0);

                            //Order rows
                            newRows = newRows.OrderBy(r => r.TempRowId).ToList();

                            foreach (ProductRowDTO dto in newRows)
                            {
                                #region Prereq

                                // Do not include new inactive rows
                                if (dto.CustomerInvoiceRowId == 0 && dto.State != (int)SoeEntityState.Active)
                                    continue;

                                // If crediting, find prev row to do a copy of the accounting rows
                                CustomerInvoiceRow prevRow = null;
                                if (crediting && dto.prevCustomerInvoiceRowId.HasValue && dto.prevCustomerInvoiceRowId > 0)
                                    prevRow = parentInvoiceRows.FirstOrDefault(r => r.CustomerInvoiceRowId == dto.prevCustomerInvoiceRowId.Value);

                                if (dto.VatAmountCurrency != 0 && dto.AmountCurrency == 0)
                                {
                                    base.LogError($"{dto.RowNr} - {dto.Text}: {GetText(7470, "Momsbeloppet kan inte vara större än totalbeloppet")}");
                                    result = new ActionResult((int)ActionResultSave.EntityNotCreated, $"{dto.RowNr} - {dto.Text}: {GetText(7470, "Momsbeloppet kan inte vara större än totalbeloppet")}");
                                    return result;
                                }

                                #endregion

                                #region CustomerInvoiceRow

                                // Create one CustomerInvoiceRow for each product row
                                var row = new CustomerInvoiceRow
                                {
                                    //CustomerInvoiceRowId = dto.CustomerInvoiceRowId,
                                    TempRowId = dto.TempRowId,
                                    AttestStateId = dto.AttestStateId,
                                    RowNr = dto.RowNr,
                                    Type = (int)dto.Type,
                                    VatRate = dto.VatRate,
                                    VatAmount = dto.VatAmount,
                                    VatAmountCurrency = dto.VatAmountCurrency,
                                    Quantity = dto.Quantity,
                                    InvoiceQuantity = dto.InvoiceQuantity,
                                    PreviouslyInvoicedQuantity = dto.PreviouslyInvoicedQuantity,
                                    Amount = dto.Amount,
                                    AmountCurrency = dto.AmountCurrency,
                                    DiscountType = dto.DiscountType,
                                    DiscountPercent = dto.DiscountPercent,
                                    DiscountAmount = dto.DiscountAmount,
                                    DiscountAmountCurrency = dto.DiscountAmountCurrency,
                                    Discount2Type = dto.Discount2Type,
                                    Discount2Percent = dto.Discount2Percent,
                                    Discount2Amount = dto.Discount2Amount,
                                    Discount2AmountCurrency = dto.Discount2AmountCurrency,
                                    SumAmount = dto.SumAmount,
                                    SumAmountCurrency = dto.SumAmountCurrency,
                                    Text = dto.Text,
                                    IsFreightAmountRow = dto.IsFreightAmountRow,
                                    IsInvoiceFeeRow = dto.IsInvoiceFeeRow,
                                    IsCentRoundingRow = dto.IsCentRoundingRow,
                                    IsInterestRow = dto.IsInterestRow,
                                    IsReminderRow = dto.IsReminderRow,
                                    PurchasePrice = dto.PurchasePrice,
                                    PurchasePriceCurrency = dto.PurchasePriceCurrency,
                                    SysWholesellerName = dto.SysWholesellerName,
                                    MarginalIncome = dto.MarginalIncome,
                                    MarginalIncomeCurrency = dto.MarginalIncomeCurrency,
                                    MarginalIncomeRatio = dto.MarginalIncomeRatio.GetValueOrDefault() >= 0 ? Math.Min(dto.MarginalIncomeRatio.GetValueOrDefault(), 99999) : Math.Max(dto.MarginalIncomeRatio.GetValueOrDefault(), -99999),
                                    State = (int)dto.State,
                                    IsTimeProjectRow = dto.IsTimeProjectRow,
                                    IsStockRow = dto.IsStockRow,
                                    //Set FK
                                    ProductId = dto.ProductId.ToNullable(),
                                    ProductUnitId = dto.ProductUnitId.ToNullable(),
                                    VatAccountId = dto.VatAccountId.ToNullable(),
                                    Date = dto.Date,
                                    TimeManuallyChanged = dto.TimeManuallyChanged,
                                    StockId = dto.StockId.ToNullable(),
                                    HouseholdDeductionType = dto.HouseholdDeductionType,
                                    DateTo = dto.DateTo,
                                    DeliveryDateText = dto.DeliveryDateText,
                                    CustomerInvoiceReminderId = dto.CustomerInvoiceReminderId,
                                    CustomerInvoiceInterestId = dto.CustomerInvoiceInterestId,
                                };
                                SetCreatedProperties(row);

                                // Set parent row
                                if (dto.ParentRowId.HasValue)
                                {
                                    var parentRow = invoice.CustomerInvoiceRow.FirstOrDefault(r => r.CustomerInvoiceRowId == dto.ParentRowId.Value);
                                    if (parentRow != null)
                                    {
                                        row.ParentRow = parentRow;

                                        if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                            row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                    }
                                    else
                                    {
                                        parentRow = invoice.CustomerInvoiceRow.FirstOrDefault(r => r.TempRowId == dto.ParentRowId.Value);
                                        if (parentRow != null)
                                        {
                                            row.ParentRow = parentRow;

                                            if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                                row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                        }
                                    }
                                }

                                // Household tax deduction
                                if (!string.IsNullOrEmpty(dto.HouseholdSocialSecNbr) || !string.IsNullOrEmpty(dto.HouseholdProperty) || (!string.IsNullOrEmpty(dto.HouseholdApartmentNbr) && !string.IsNullOrEmpty(dto.HouseholdCooperativeOrgNbr)))
                                {
                                    // Validate
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(invoice, row, dto);
                                    if (!result.Success)
                                    {
                                        return result;
                                    }
                                }

                                // Add account rows connected to current product row
                                #region CustomerInvoiceAccountRow Add

                                List<object> splitRows = new List<object>();
                                if (dto.SplitAccountingRows != null)
                                {
                                    foreach (SplitAccountingRowDTO splitRow in dto.SplitAccountingRows)
                                    {
                                        splitRows.Add((object)splitRow);
                                    }
                                }

                                if (crediting && prevRow != null)
                                {
                                    foreach (var accRow in prevRow.ActiveCustomerInvoiceAccountRows)
                                    {
                                        var copy = new CustomerInvoiceAccountRow();
                                        EntityUtil.Copy<CustomerInvoiceAccountRow>(copy, accRow);

                                        copy.CustomerInvoiceRowId = 0;
                                        copy.CustomerInvoiceAccountRowId = 0;

                                        if (copy.VatRow)
                                        {
                                            if (copy.CreditRow)
                                            {
                                                copy.CreditRow = false;
                                                copy.DebitRow = true;

                                                copy.Amount = Math.Abs(row.VatAmount);
                                                copy.AmountCurrency = Math.Abs(row.VatAmountCurrency);
                                                copy.AmountEntCurrency = Math.Abs(row.VatAmountEntCurrency);
                                                copy.AmountLedgerCurrency = Math.Abs(row.VatAmountLedgerCurrency);
                                            }
                                            else
                                            {
                                                copy.CreditRow = true;
                                                copy.DebitRow = false;

                                                copy.Amount = decimal.Negate(row.VatAmount);
                                                copy.AmountCurrency = decimal.Negate(row.VatAmountCurrency);
                                                copy.AmountEntCurrency = Math.Abs(row.VatAmountEntCurrency);
                                                copy.AmountLedgerCurrency = Math.Abs(row.VatAmountLedgerCurrency);
                                            }
                                        }
                                        else
                                        {
                                            if (copy.CreditRow)
                                            {
                                                copy.CreditRow = false;
                                                copy.DebitRow = true;

                                                if (copy.SplitPercent > 0)
                                                {
                                                    copy.Amount = Math.Abs(row.SumAmount * (copy.SplitPercent / 100));
                                                    copy.AmountCurrency = Math.Abs(row.SumAmountCurrency * (copy.SplitPercent / 100));
                                                    copy.AmountEntCurrency = Math.Abs(row.SumAmountEntCurrency * (copy.SplitPercent / 100));
                                                    copy.AmountLedgerCurrency = Math.Abs(row.SumAmountLedgerCurrency * (copy.SplitPercent / 100));
                                                }
                                                else if (row.DiscountAmount != 0 && (copy.AccountId == discountAccountId || copy.AccountId == discountOffsetAccountId))
                                                {
                                                    copy.Amount = (row.DiscountAmount > 0 ? row.DiscountAmount : -row.DiscountAmount) + row.Discount2Amount;
                                                    copy.AmountCurrency = (row.DiscountAmountCurrency > 0 ? row.DiscountAmountCurrency : -row.DiscountAmountCurrency) + row.Discount2AmountCurrency;
                                                }
                                                else
                                                {
                                                    if (row.DiscountAmount != 0 && discountAccountId > 0 && discountOffsetAccountId == 0)
                                                    {
                                                        copy.Amount = (invoice.PriceListTypeInclusiveVat ? Math.Abs(row.Amount - row.VatAmount) : Math.Abs(row.Amount)) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                        copy.AmountCurrency = (invoice.PriceListTypeInclusiveVat ? Math.Abs(row.AmountCurrency - row.VatAmountCurrency) : Math.Abs(row.AmountCurrency)) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                        copy.AmountEntCurrency = (invoice.PriceListTypeInclusiveVat ? Math.Abs(row.AmountEntCurrency - row.VatAmountEntCurrency) : Math.Abs(row.AmountEntCurrency)) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                        copy.AmountLedgerCurrency = (invoice.PriceListTypeInclusiveVat ? Math.Abs(row.AmountLedgerCurrency - row.VatAmountLedgerCurrency) : Math.Abs(row.AmountLedgerCurrency)) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                    }
                                                    else
                                                    {
                                                        copy.Amount = invoice.PriceListTypeInclusiveVat ? Math.Abs(row.SumAmount - row.VatAmount) : Math.Abs(row.SumAmount);
                                                        copy.AmountCurrency = invoice.PriceListTypeInclusiveVat ? Math.Abs(row.SumAmountCurrency - row.VatAmountCurrency) : Math.Abs(row.SumAmountCurrency);
                                                        copy.AmountEntCurrency = invoice.PriceListTypeInclusiveVat ? Math.Abs(row.SumAmountEntCurrency - row.VatAmountEntCurrency) : Math.Abs(row.SumAmountEntCurrency);
                                                        copy.AmountLedgerCurrency = invoice.PriceListTypeInclusiveVat ? Math.Abs(row.SumAmountLedgerCurrency - row.VatAmountLedgerCurrency) : Math.Abs(row.SumAmountLedgerCurrency);
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                copy.CreditRow = true;
                                                copy.DebitRow = false;

                                                if (copy.SplitPercent > 0)
                                                {
                                                    copy.Amount = decimal.Negate(row.SumAmount * (copy.SplitPercent / 100));
                                                    copy.AmountCurrency = decimal.Negate(row.SumAmountCurrency * (copy.SplitPercent / 100));
                                                    copy.AmountEntCurrency = decimal.Negate(row.SumAmountEntCurrency * (copy.SplitPercent / 100));
                                                    copy.AmountLedgerCurrency = decimal.Negate(row.SumAmountLedgerCurrency * (copy.SplitPercent / 100));
                                                }
                                                else if (row.DiscountAmount != 0 && (copy.AccountId == discountAccountId || copy.AccountId == discountOffsetAccountId))
                                                {
                                                    copy.Amount = (row.DiscountAmount > 0 ? -row.DiscountAmount : row.DiscountAmount) + row.Discount2Amount;
                                                    copy.AmountCurrency = (row.DiscountAmountCurrency > 0 ? -row.DiscountAmountCurrency : row.DiscountAmountCurrency) + row.Discount2AmountCurrency;
                                                }
                                                else
                                                {
                                                    if (row.DiscountAmount != 0 && discountAccountId > 0 && discountOffsetAccountId == 0)
                                                    {
                                                        copy.Amount = decimal.Negate(row.Amount) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                        copy.AmountCurrency = decimal.Negate(row.AmountCurrency) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                        copy.AmountEntCurrency = decimal.Negate(row.AmountEntCurrency) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                        copy.AmountLedgerCurrency = decimal.Negate(row.AmountLedgerCurrency) * (row.Quantity.HasValue ? row.Quantity.Value : 1);
                                                    }
                                                    else
                                                    {
                                                        copy.Amount = decimal.Negate(row.SumAmount);
                                                        copy.AmountCurrency = decimal.Negate(row.SumAmountCurrency);
                                                        copy.AmountEntCurrency = decimal.Negate(row.SumAmountEntCurrency);
                                                        copy.AmountLedgerCurrency = decimal.Negate(row.SumAmountLedgerCurrency);
                                                    }
                                                }
                                            }
                                        }

                                        foreach (var accInternal in accRow.AccountInternal)
                                        {
                                            copy.AccountInternal.Add(accInternal);
                                        }

                                        row.CustomerInvoiceAccountRow.Add(copy);
                                    }
                                }
                                else
                                {
                                    CreateCustomerInvoiceAccountRow(entities, invoice, row, (TermGroup_InvoiceVatType)invoice.VatType, ref nextRowNr, invoice.ActorId.HasValue ? invoice.ActorId.Value : 0, 0, invoice.ProjectId.HasValue ? invoice.ProjectId.Value : 0, base.ActorCompanyId, splitRows.Count > 0 ? splitRows : null);
                                }

                                #endregion

                                #region TimeCodeTransaction

                                if (invoice.Project != null)
                                {
                                    result = TimeTransactionManager.UpdateTimeCodeTransactions(entities, base.ActorCompanyId, row, invoice.Project, standardMaterialCodeId);
                                    if (!result.Success)
                                        return result;
                                }

                                #endregion

                                // Add product row with connected account rows to the collection of CustomerInvoiceRows
                                invoice.CustomerInvoiceRow.Add(row);
                                processedInputInvoiceRows.Add(row);

                                #endregion
                            }
                        }
                        ConvertProductRowsTextUppercase(entities, processedInputInvoiceRows, base.ActorCompanyId);

                        #endregion

                        #region Set remaining amount

                        decimal cents = 0;

                        foreach (var invoiceRow in invoice.ActiveCustomerInvoiceRows)
                        {

                            if (invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice && ((invoiceRow.Type == (int)SoeInvoiceRowType.ProductRow || invoiceRow.Type == (int)SoeInvoiceRowType.BaseProductRow) ||
                                (invoiceRow.IsFreightAmountRow || invoiceRow.IsInterestRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsReminderRow)) &&
                                invoiceRow.State != (int)SoeEntityState.Deleted)
                            {

                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product == null || (((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    if (invoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !invoice.PriceListTypeInclusiveVat)
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency;
                                    }
                                    else
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency;
                                    }

                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                    remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                }

                            }
                            else if (invoiceRow.IsCentRoundingRow)
                            {
                                if (invoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !invoice.PriceListTypeInclusiveVat)
                                {
                                    cents = (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                }
                                else
                                {
                                    cents = invoiceRow.SumAmountCurrency;
                                }

                            }
                        }

                        int tryAmount = 0;
                        if (!Int32.TryParse(remainingCurrencyAmount.ToString(), out tryAmount))
                        {
                            //if (hasTransferedRows)
                            //{
                            //    remainingCurrencyAmount = Math.Round(remainingCurrencyAmount, 0, MidpointRounding.ToEven);
                            //}
                            //else
                            //{
                            remainingCurrencyAmount += cents;
                            //}
                        }

                        int tryAmountExVat = 0;
                        if (!Int32.TryParse(remainingCurrencyAmountExVat.ToString(), out tryAmountExVat))
                        {
                            //if (hasTransferedRows)
                            //{
                            //    remainingCurrencyAmountExVat = Math.Round(remainingCurrencyAmountExVat, 0, MidpointRounding.ToEven);
                            //}
                            //else
                            //{
                            remainingCurrencyAmountExVat += cents;
                            //}
                        }

                        int tryAmountVat = 0;
                        if (!Int32.TryParse(remainingCurrencyAmountVat.ToString(), out tryAmountVat))
                        {
                            //if (hasTransferedRows)
                            //{
                            //remainingCurrencyAmountVat = Math.Round(remainingCurrencyAmountVat, 0, MidpointRounding.ToEven);
                            //}
                            //else
                            //{
                            remainingCurrencyAmountVat += cents;
                            //}
                        }

                        //Set remaining amount
                        invoice.RemainingAmount = remainingCurrencyAmount;
                        invoice.RemainingAmountVat = remainingCurrencyAmountVat;
                        invoice.RemainingAmountExVat = remainingCurrencyAmountExVat;

                        if (invoice.ActiveCustomerInvoiceRows.Any())
                        {
                            int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, invoice.CurrencyId);
                            int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                            UpdateInvoiceAfterRowModification(entities, invoice, nextRowNr, ActorCompanyId, false, sysCurrencyIdInvoice != sysCurrencyIdBase, check4NewClaimAccount: customerChanged);
                        }

                        // Check for multiple asset rows
                        if (noOfAssetRows > 1)
                            invoice.MultipleAssetRows = true;

                        #endregion

                        #region Calculate currency amounts

                        //Calculate currency amounts
                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, base.ActorCompanyId, invoice, true);

                        #endregion

                        #region Save

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        #region Voucher

                        if (result.Success && !invoice.IsTemplate)
                        {
                            result = TryTransferCustomerInvoiceToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, invoice, accountYearId, base.ActorCompanyId);
                            if (result.Success)
                                voucherHeadsDict = NumberUtility.MergeDictictionary(voucherHeadsDict, result.IdDict);
                        }

                        #endregion

                        if (result.Success)
                        {
                            bool isNew = (invoiceId == 0);

                            //Set id
                            invoiceId = invoice.InvoiceId;

                            if (invoiceAttachments != null && invoiceAttachments.Any())
                            {
                                var newStatusIcon = SaveOrderInvoiceAttachments(entities, invoice.InvoiceId, invoice.StatusIcon, invoiceAttachments, invoice.InvoiceNr);
                                if (newStatusIcon != invoice.StatusIcon)
                                {
                                    invoice.StatusIcon = newStatusIcon;
                                    SaveChanges(entities);
                                }
                            }

                            #region Categories
                            //do not remove last check!!
                            if (values.ContainsKey("categoryids") && values["categoryids"] != null)
                            {
                                List<int> categoryIds = new List<int>();
                                foreach (var val in (List<object>)values["categoryids"])
                                {
                                    categoryIds.Add(Convert.ToInt32(val));
                                }

                                CategoryManager.SaveCompanyCategoryRecords(entities, transaction, categoryIds, base.ActorCompanyId, SoeCategoryType.Order, SoeCategoryRecordEntity.Order, invoiceId);
                            }

                            #endregion

                            #region Checklists

                            //Delete
                            if (checklistHeads != null)
                            {
                                List<int> deletedIds = checklistHeads.Where(h => h.State == SoeEntityState.Deleted).Select(h => h.ChecklistHeadRecordId).ToList();
                                if (deletedIds.Count > 0)
                                {
                                    result = ChecklistManager.DeleteChecklistHeadRecords(entities, transaction, base.ActorCompanyId, deletedIds, base.UserId);

                                    if (!result.Success)
                                        return result;
                                }

                                //Add
                                List<ChecklistHeadRecordCompactDTO> heads = checklistHeads.Where(h => h.ChecklistHeadRecordId == 0).ToList();
                                if (heads.Count > 0)
                                {
                                    result = ChecklistManager.AddChecklistRecords(entities, transaction, heads, SoeEntityType.Order, invoiceId, base.ActorCompanyId);

                                    if (!result.Success)
                                        return result;
                                }
                            }
                            //Update
                            if (checklistRows != null && checklistRows.Any())
                            {
                                result = ChecklistManager.SaveChecklistRecords(entities, transaction, checklistRows, SoeEntityType.Order, invoiceId, base.ActorCompanyId);

                                if (!result.Success)
                                    return result;
                            }

                            #endregion

                            #region OriginUsers

                            if (originUsers != null)
                            {
                                string subject = String.Empty;
                                string text = String.Empty;
                                if (sendXEMail)
                                {
                                    subject = GetText(7715, "Tilldelad order");
                                    text = GetText(7716, "Du har blivit tilldelad order med nummer") + ": " + invoice.InvoiceNr;
                                }

                                result = SaveOriginUsers(transaction, entities, invoiceId, originUsers, base.ActorCompanyId, base.LicenseId, sendXEMail, subject, text, true, messageType: TermGroup_MessageType.OrderAssigned);
                                if (!result.Success)
                                    return result;
                            }

                            #endregion

                            #region stock
                            HandleStockOnInvoice(invoice, entities, transaction, base.ActorCompanyId, stockDict, false, draftToOrigin, isNew);
                            #endregion

                            #region OCR

                            // In Finland next step after this valid invoice is to focus on incoming payments.
                            // There we need to have only unique references within company. 
                            var ocr = values.ContainsKey("ocr") ? (string)values["ocr"] : String.Empty;
                            if (seqNbr != 0 && String.IsNullOrEmpty(ocr) && SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormReferenceNumberToOCR, 0, base.ActorCompanyId, 0))
                            {
                                Company company = CompanyManager.GetCompany(entities, base.ActorCompanyId);
                                if (company.SysCountryId != null)
                                {
                                    if (!invoice.ActorReference.IsLoaded)
                                        invoice.ActorReference.Load();

                                    if (invoice.Actor != null)
                                    {
                                        if (!invoice.Actor.CustomerReference.IsLoaded)
                                            invoice.Actor.CustomerReference.Load();

                                        switch ((int)company.SysCountryId)
                                        {
                                            case 2: //US
                                                break;
                                            case 3: //Finland
                                                    //long tmpLongInt = ((actorCompanyId * 1000000) + (seqNbr + invoiceId));
                                                if (invoice.InvoiceNr != null && invoice.Actor.Customer.CustomerNr != null)
                                                {
                                                    string tmpReference = invoice.Actor.Customer.CustomerNr.ToString() + "0000" + invoice.InvoiceNr.ToString();
                                                    //invoice.OCR = GetISO11649(GetCheckedBankPaymentReference(tmpReference));
                                                    if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, base.ActorCompanyId, 0))
                                                    {
                                                        invoice.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                                    }
                                                    else
                                                    {
                                                        invoice.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                                    }
                                                }
                                                else
                                                {
                                                    string errorCheck = "";
                                                    if (invoice.InvoiceNr == null) errorCheck += "A=null";
                                                    if (invoice.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                                    invoice.OCR = "Virhe(1):" + errorCheck;
                                                }

                                                break;
                                            case 4: //Norge
                                                if (invoice.InvoiceNr != null && invoice.Actor.Customer.CustomerNr != null)
                                                {
                                                    invoice.OCR = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), invoice.Actor.Customer.CustomerNr.ToString(), (DateTime)invoice.InvoiceDate, 0);
                                                }
                                                break;
                                            default:
                                                //Sverige case 1
                                                invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                                                break;
                                        }
                                    }
                                }
                                else
                                {
                                    //Svenskt
                                    invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                                }

                                SetModifiedProperties(invoice);
                                SaveChanges(entities);
                            }

                            #endregion

                            #region EntityHistory

                            GeneralManager.SaveEntityHistory(entities, entityType, invoiceId, DateTime.Now, true, true, false, base.ActorCompanyId);

                            #endregion

                            //Commit transaction
                            transaction.Complete();

                            //Modified rows
                            modifiedRowIds.Clear();
                            foreach (int tempRowId in modifiedOrderRows.Keys)
                            {
                                modifiedRowIds.Add(tempRowId, modifiedOrderRows[tempRowId].CustomerInvoiceRowId);
                            }

                            setPrintTimeProjectAsChecked = invoice.PrintTimeReport;

                        }

                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                    seqNbr = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = invoiceId;
                        result.StringValue = invoiceNbr;
                        result.Value = seqNbr;
                        //result.BooleanValue = invoiceInput.IsTemplate ? true : reloadAfterSave;
                        result.IntDict = modifiedRowIds;
                        //result.IntDict2 = modifiedAccRowIds;
                        result.Value2 = returnProject;
                        result.BooleanValue2 = setPrintTimeProjectAsChecked;

                        if (invoiceIsTemplate)
                            result.SuccessNumber = (int)ActionResultSave.CustomerInvoiceIsTemplate;

                        if (modified.HasValue)
                        {
                            result.Modified = modified.Value;
                            result.ModifiedBy = modifiedBy;
                        }
                        if (voucherHeadsDict != null)
                            result.IdDict = voucherHeadsDict;
                    }
                    else
                    {
                        //Set error message
                        if (result.ErrorMessage == null || result.ErrorMessage == String.Empty)
                            result.ErrorMessage = GetErrorMessage(result.ErrorNumber, result.StringValue);

                        base.LogTransactionFailed(this.ToString(), this.log);
                    }

                    entities.Connection.Close();
                }
            }

            return result;
        }

        private static void UpdateInvoiceRowProperties(CustomerInvoiceRow invoiceRow, IDictionary<string, object> invoiceRowInput, List<string> allowedProps = null)
        {
            var rowProps = invoiceRow.GetType().GetProperties();
            foreach (var prop in rowProps)
            {
                string lcName = prop.Name.ToLower();

                if (allowedProps != null && !allowedProps.Contains(lcName))
                    continue;

                if (invoiceRowInput.ContainsKey(lcName))
                {
                    var value = invoiceRowInput[lcName];
                    if (lcName == "marginalincomeratio")
                    {
                        var ratio = Convert.ToDecimal(value);
                        ratio = ratio >= 0 ? Math.Min(ratio, 99999) : Math.Max(ratio, -99999);
                        prop.SetValue(invoiceRow, ratio);
                    }
                    else if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                    {
                        prop.SetValue(invoiceRow, Convert.ToDecimal(invoiceRowInput[lcName]));
                    }
                    else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                    {
                        if (invoiceTreat0asNullRow.Contains(lcName) && value != null && Convert.ToInt32(value) == 0)
                        {
                            value = null;
                        }
                        prop.SetValue(invoiceRow, value == null ? (int?)null : Convert.ToInt32(value));
                    }
                    else
                        prop.SetValue(invoiceRow, value);
                }
            }
        }

        public ActionResult SetPriceListTypeInclusiveVat(CustomerInvoice invoice, int actorCompanyId, bool lazyLoad = false)
        {
            using (CompEntities entities = new CompEntities())
            {
                return SetPriceListTypeInclusiveVat(entities, invoice, actorCompanyId, lazyLoad);
            }
        }

        public bool IsFirstDraft(CustomerInvoice invoice)
        {
            return (invoice.Origin.Status == (int)SoeOriginStatus.Draft && invoice.SeqNr.GetValueOrDefault() == 0);
        }

        public ActionResult SetPriceListTypeInclusiveVat(CompEntities entities, CustomerInvoice invoice, int actorCompanyId, bool lazyLoad = false)
        {
            if (lazyLoad && invoice.PriceListTypeId.HasValue && !invoice.PriceListTypeReference.IsLoaded)
                invoice.PriceListTypeReference.Load();

            PriceListType priceListType = invoice.PriceListType ?? ProductPricelistManager.GetPriceListType(entities, invoice.PriceListTypeId.GetValueOrDefault(), actorCompanyId);
            invoice.PriceListTypeInclusiveVat = (priceListType != null && priceListType.InclusiveVat);
            if (invoice.PriceListTypeId.HasValue && priceListType == null)
                return new ActionResult(GetText(1977, "Prislista borttagen"));
            else
                return new ActionResult();
        }

        public ActionResult SaveCustomerInvoiceAttachment(int invoiceId, DataStorageRecordExtendedDTO fileDto, int actorCompanyId)
        {
            using (var entities = new CompEntities())
            {
                return SaveCustomerInvoiceAttachment(entities, invoiceId, fileDto, actorCompanyId);
            }
        }

        public ActionResult SaveCustomerInvoiceAttachment(CompEntities entities, int invoiceId, DataStorageRecordExtendedDTO fileDto, int actorCompanyId)
        {
            var result = GeneralManager.SaveDataStorageRecord(entities, actorCompanyId, fileDto, false);
            if (result.Success && fileDto.Type == SoeDataStorageRecordType.OrderInvoiceFileAttachment)
            {
                var dataStorageRecordId = result.IntegerValue;

                var customerInvoice = GetCustomerInvoice(entities, invoiceId);
                customerInvoice.StatusIcon = GetStatusIcon(customerInvoice.StatusIcon, true, SoeStatusIcon.Attachment);
                result = SaveChanges(entities);

                if (result.Success)
                {
                    var fileUploadDTO = new FileUploadDTO
                    {
                        Id = dataStorageRecordId,
                        IsSupplierInvoice = false,
                        FileName = fileDto.FileName,
                        Description = fileDto.Description,
                        IsDeleted = false,
                        IncludeWhenDistributed = customerInvoice.AddAttachementsToEInvoice,
                        IncludeWhenTransfered = true,
                    };

                    result = GeneralManager.UpdateInvoiceAttachments(entities, new List<FileUploadDTO> { fileUploadDTO }, invoiceId, SoeEntityType.None, customerInvoice.InvoiceNr);
                }
            }

            return result;
        }

        public ActionResult SaveOrderInvoiceAttachment(int invoiceId, DataStorageRecordExtendedDTO fileDto, int actorCompanyId)
        {
            using (var entities = new CompEntities())
            {
                return SaveOrderInvoiceAttachment(entities, invoiceId, fileDto, actorCompanyId);
            }
        }

        public ActionResult SaveOrderInvoiceAttachment(CompEntities entities, int invoiceId, DataStorageRecordExtendedDTO fileDto, int actorCompanyId)
        {
            var result = GeneralManager.SaveDataStorageRecord(entities, actorCompanyId, fileDto, false);
            if (result.Success && fileDto.Type == SoeDataStorageRecordType.OrderInvoiceFileAttachment)
            {
                var invoice = GetInvoice(entities, invoiceId);
                invoice.StatusIcon = GetStatusIcon(invoice.StatusIcon, true, SoeStatusIcon.Attachment);
                result = SaveChanges(entities);
            }

            return result;
        }

        public int SaveOrderInvoiceAttachments(CompEntities entities, int invoiceId, int statusIcon, List<FileUploadDTO> invoiceFiles, string recordNr = "")
        {
            if (invoiceFiles != null)
            {
                // Not used anymore - images are saved to datastorage
                var images = invoiceFiles.Where(f => f.ImageId.HasValue);
                //GraphicsManager.UpdateImages(entities, images, invoiceId);
                GeneralManager.UpdateInvoiceAttachments(entities, images, invoiceId, SoeEntityType.None, recordNr); // Appereantly we use none on entity type today
                statusIcon = GetStatusIcon(statusIcon, images, SoeStatusIcon.Image);

                var files = invoiceFiles.Where(f => f.Id.HasValue);
                GeneralManager.UpdateInvoiceAttachments(entities, files, invoiceId, SoeEntityType.None, recordNr); // Appereantly we use none on entity type today

                // Check remaining existing
                List<int> excludedFiles = new List<int>();
                excludedFiles.AddRange(invoiceFiles.Where(i => i.ImageId.HasValue && i.IsDeleted).Select(i => i.ImageId.Value));
                excludedFiles.AddRange(invoiceFiles.Where(i => i.Id.HasValue && i.IsDeleted).Select(i => i.Id.Value));

                if (invoiceFiles.Count > excludedFiles.Count || !GeneralManager.HasDataStorageRecords(entities, base.ActorCompanyId, invoiceId, SoeDataStorageRecordType.OrderInvoiceFileAttachment, SoeEntityType.None, excludedFiles))
                    statusIcon = GetStatusIcon(statusIcon, files, SoeStatusIcon.Attachment);

                entities.SaveChanges();
            }

            return statusIcon;
        }

        public ActionResult AddUpdateChecklists(CompEntities entities, TransactionScope transaction, int invoiceId, List<ChecklistHeadRecordCompactDTO> checklistHeads, List<ChecklistExtendedRowDTO> checklistRows, int statusIcon)
        {
            var hasChecklists = false;

            //Delete
            var result = new ActionResult(true);
            List<int> deletedIds = checklistHeads.Where(h => h.State == SoeEntityState.Deleted).Select(h => h.ChecklistHeadRecordId).ToList();
            if (deletedIds.Count > 0)
            {
                result = ChecklistManager.DeleteChecklistHeadRecords(entities, transaction, base.ActorCompanyId, deletedIds, base.UserId);

                if (!result.Success)
                    return result;
            }

            //Add
            List<ChecklistHeadRecordCompactDTO> heads = checklistHeads.Where(h => h.ChecklistHeadRecordId == 0).ToList();
            if (heads.Count > 0)
            {
                result = ChecklistManager.AddChecklistRecords(entities, transaction, heads, SoeEntityType.Order, invoiceId, base.ActorCompanyId);

                if (!result.Success)
                    return result;

                hasChecklists = true;
            }

            //Update
            heads = checklistHeads.Where(h => h.ChecklistHeadRecordId != 0 && h.State == SoeEntityState.Active).ToList();
            if (heads.Any())
            {
                ChecklistManager.UpdateChecklistHeadRecords(entities, transaction, heads);

                hasChecklists = true;
            }

            if ((checklistRows != null) && (checklistRows.Any()))
            {
                result = ChecklistManager.SaveChecklistRecords(entities, transaction, checklistRows, SoeEntityType.Order, invoiceId, base.ActorCompanyId);

                if (!result.Success)
                    return result;
            }

            statusIcon &= ~(int)SoeStatusIcon.Checklist;
            if (hasChecklists)
            {
                statusIcon |= (int)SoeStatusIcon.Checklist;
            }
            result.IntegerValue = statusIcon;

            return result;
        }

        public ActionResult SaveOrder(dynamic modifiedFields, List<ProductRowDTO> newRows, List<ExpandoObject> modifiedRows, List<ChecklistHeadRecordCompactDTO> checklistHeads, List<ChecklistExtendedRowDTO> checklistRows, List<OriginUserDTO> originUsers, List<FileUploadDTO> orderAttachments, bool discardConcurrencyCheck, bool regenerateAccounting, bool sendXEMail, bool autoSave)
        {
            var result = new ActionResult();

            #region Prereq

            bool orderRowsAdded = false;
            int seqNbr = 0;
            var values = (IDictionary<string, object>)modifiedFields;
            bool invoiceIsTemplate = false;
            bool setPrintTimeProjectAsChecked = false;
            DateTime? modified = null;
            string modifiedBy = null;
            DateTime? created = null;
            string createdBy = null;
            string invoiceNbr = string.Empty;
            /*decimal remainingCurrencyAmount = 0;
            decimal remainingCurrencyAmountVat = 0;
            decimal remainingCurrencyAmountExVat = 0;*/
            TimeProjectDTO returnProject = null;
            Dictionary<int, int> voucherHeadsDict = null;
            Dictionary<int, int> modifiedRowIds = new Dictionary<int, int>();
            Dictionary<int, CustomerInvoiceRow> modifiedOrderRows = new Dictionary<int, CustomerInvoiceRow>();
            int? messageToSendId = null;

            int invoiceId = values.ContainsKey("id") ? Convert.ToInt32(values["id"]) : 0;
            bool isNew = invoiceId == 0;

            #region Types

            //SoeOriginType originType = SoeOriginType.Order;
            SoeEntityType entityType = SoeEntityType.Order;

            #endregion

            #region Settings

            bool? conflictSetting = values.ContainsKey("checkconflictsonsave") ? (bool?)values["checkconflictsonsave"] : null;
            if (conflictSetting != null)
                SettingManager.UpdateInsertBoolSetting(SettingMainType.User, (int)UserSettingType.BillingCheckConflictsOnSave, (bool)conflictSetting.Value, base.UserId, base.ActorCompanyId, 0);

            bool usePartialInvoicingOnOrderRow = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingUsePartialInvoicingOnOrderRow, base.UserId, base.ActorCompanyId, 0);
            bool autoCreateDateOnProductRows = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingAutoCreateDateOnProductRows, base.UserId, base.ActorCompanyId, 0);

            #endregion

            #endregion

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    #region Prereq

                    // Check if order was modified after current order was fetched
                    if (!discardConcurrencyCheck && values.ContainsKey("modified"))
                    {
                        DateTime? currentModified = null;
                        var field = values["modified"];
                        if (field != null)
                        {
                            currentModified = (DateTime)field; //DateTime.ParseExact((string)field, "yyyy-MM-dd HH:mm:ss", CultureInfo.InvariantCulture);
                            values.Remove("modified");
                        }

                        bool isModified = base.IsEntityModified(entities, invoiceId, entityType, currentModified, out modified, out modifiedBy);
                        if (isModified && (modified.HasValue || modifiedBy.HasValue()))
                            return new ActionResult((int)ActionResultSave.EntityIsModifiedByOtherUser, String.Format(GetText(2112, (int)TermGroup.AngularBilling, "Ordern är uppdaterad {0} av {1}. Om du sparar kommer den användarens ändringar att skrivas över.\nVill du fortsätta?"), modified, modifiedBy));
                    }

                    #endregion

                    //Standard materialcode
                    int standardMaterialCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStandardMaterialCode, 0, base.ActorCompanyId, 0);

                    int guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, base.ActorCompanyId, 0);

                    //AccountYear
                    int accountYearId = SettingManager.GetIntSetting(entities, SettingMainType.UserAndCompany, (int)UserSettingType.AccountingAccountYear, base.UserId, base.ActorCompanyId, 0);

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        //Load invoice
                        bool loadProductRows = newRows.Count > 0 || modifiedRows.Count > 0;
                        CustomerInvoice order = invoiceId != 0 ? GetCustomerInvoice(entities, invoiceId, true, true, true, false, true, false, false, loadProductRows, regenerateAccounting, false, false, false, false, true) : null;

                        //Force saving
                        bool forceSave = values.ContainsKey("forcesave") ? (bool)values["forcesave"] : false;

                        //we are only allowed to change checklistHeads when order is closed...
                        if (
                            (order != null) &&
                            (order?.Origin.Status == (int)SoeOriginStatus.OrderClosed || order?.Origin.Status == (int)SoeOriginStatus.OrderFullyInvoice)
                           && ((checklistHeads != null) && checklistHeads.Any())
                           && ((checklistRows == null) || !checklistRows.Any())
                           && values.Count() < 8
                           )
                        {
                            result = AddUpdateChecklists(entities, transaction, order.InvoiceId, checklistHeads, null, order.StatusIcon);
                            if (result.Success)
                            {
                                order.StatusIcon = result.IntegerValue;
                                SetModifiedProperties(order);

                                result.BooleanValue = true; //reload from angular
                                entities.SaveChanges();
                                transaction.Complete();
                            }
                            return result;
                        }

                        //Ok to save
                        if (!(forceSave || order == null ? true : (order.Origin.Status == (int)SoeOriginStatus.Draft || (order.Origin.Status == (int)SoeOriginStatus.Origin) || (order.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice))))
                        {
                            string text = GetText(176, "Felaktig statusförändring") + ": " + GetText(order.Origin.Status, (int)TermGroup.OriginStatus);
                            return new ActionResult((int)ActionResultSave.InvalidStateTransition, text);
                        }

                        if (invoiceId == 0)
                        {
                            #region Add

                            bool addInvoice = order == null;
                            if (addInvoice)
                            {
                                #region Origin

                                int? voucherSeriesTypeId = null;

                                if (values.ContainsKey("voucherSeriesTypeId"))
                                    voucherSeriesTypeId = Convert.ToInt32(values["voucherSeriesTypeId"]);

                                if (voucherSeriesTypeId == 0)
                                    voucherSeriesTypeId = null;

                                // Create new Origin, fields will be set in update below
                                var origin = new Origin
                                {
                                    VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]),
                                    VoucherSeriesTypeId = voucherSeriesTypeId,
                                    Type = Convert.ToInt32(SoeOriginType.Order),
                                    Status = Convert.ToInt32(values["originstatus"]),

                                    //Set FK
                                    ActorCompanyId = base.ActorCompanyId,
                                };

                                if (values.ContainsKey("origindescription"))
                                {
                                    origin.Description = (string)values["origindescription"];
                                    values.Remove("origindescription");
                                }

                                SetCreatedProperties(origin);
                                entities.Origin.AddObject(origin);

                                #endregion

                                #region OriginUser

                                // Add current user to origin
                                OriginUser originUser = new OriginUser()
                                {
                                    Main = true,

                                    //Set FK
                                    UserId = base.UserId,

                                    //Set references
                                    Origin = origin,
                                };
                                origin.OriginUser.Add(originUser);
                                SetCreatedProperties(originUser);

                                #endregion

                                #region CustomerInvoice

                                // Create new CustomerInvoice, fields will be set in update below
                                order = new CustomerInvoice
                                {
                                    // Inherited from Invoice
                                    Origin = origin,
                                    Type = (int)SoeInvoiceType.CustomerInvoice,
                                    OnlyPayment = false,
                                    PaidAmountCurrency = 0,
                                    FullyPayed = false,
                                    SysPaymentTypeId = 0,
                                    PaymentNr = string.Empty,
                                    MultipleAssetRows = false, // Will be calculated'
                                    RegistrationType = (int)OrderInvoiceRegistrationType.Order,
                                };

                                entities.Invoice.AddObject(order);
                                SetCreatedProperties(order);

                                if (!(bool)values["istemplate"])
                                {
                                    // Set dates
                                    if (!values.ContainsKey("invoicedate") || values["invoicedate"] == null)
                                        order.InvoiceDate = DateTime.Today;
                                    if (!values.ContainsKey("voucherdate") || values["voucherdate"] == null)
                                        order.VoucherDate = DateTime.Today;
                                }

                                #endregion
                            }

                            #endregion
                        }
                        else
                        {
                            #region Update

                            // Update Origin
                            if (values.ContainsKey("voucherseriesid"))
                            {
                                order.Origin.VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]);
                                values.Remove("voucherseriesid");
                            }
                            if (values.ContainsKey("origindescription"))
                            {
                                order.Origin.Description = (string)values["origindescription"];
                                values.Remove("origindescription");
                            }
                            if (order.Origin.Status == (int)SoeOriginStatus.Draft || order.Origin.Status == (int)SoeOriginStatus.Origin && values.ContainsKey("originstatus"))
                            {
                                int origStatus = Convert.ToInt32(values["originstatus"]);
                                if (order.Origin.Status != origStatus)
                                {
                                    order.Origin.Status = origStatus;
                                }
                                values.Remove("originstatus");
                            }

                            SetModifiedProperties(order.Origin);

                            #endregion
                        }

                        string[] excludes = { "categoryids", "seqnr", "invoicenr", "projectnr", "created", "modified", "createdby", "modifiedby", "mainInvoiceId" };

                        bool defaultInternalAccountChanged = false;
                        bool priceListTypeChanged = false;
                        bool customerChanged = false;

                        var props = order.GetType().GetProperties();
                        foreach (var prop in props)
                        {
                            string lcName = prop.Name.ToLower();

                            if (values.ContainsKey(lcName) && !excludes.Contains(lcName))
                            {
                                var value = values[lcName];

                                if (internalAccountFields.Contains(lcName))
                                {
                                    defaultInternalAccountChanged = true;
                                }

                                if (lcName == "actorid")
                                {
                                    customerChanged = (prop.GetValue(order) != value);
                                }

                                if (lcName == "pricelisttypeid")
                                {
                                    priceListTypeChanged = (prop.GetValue(order) != value);
                                }

                                if (lcName == "marginalincomeratio")
                                {
                                    var ratio = Convert.ToDecimal(value);
                                    ratio = ratio >= 0 ? Math.Min(ratio, 99999) : Math.Max(ratio, -99999);
                                    prop.SetValue(order, ratio);
                                }
                                else if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                                    prop.SetValue(order, Convert.ToDecimal(value));
                                else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                                {
                                    if (invoiceTreat0asNullHead.Contains(lcName) && value != null && Convert.ToInt32(value) == 0)
                                    {
                                        value = null;
                                    }
                                    prop.SetValue(order, value == null ? (int?)null : Convert.ToInt32(value));
                                }
                                else if ((prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?)) && value != null)
                                {
                                    DateTime? dt = value as DateTime?;
                                    if (dt.HasValue)
                                    {
                                        if (dt.Value.Year < 1900)
                                            prop.SetValue(order, new DateTime(1900, dt.Value.Month, dt.Value.Day));
                                        else
                                            prop.SetValue(order, value);
                                    }
                                }
                                else
                                    prop.SetValue(order, value);
                            }
                        }

                        //Fix for bad naming
                        if (values.ContainsKey("addsupplierinvoicestoeinvoice"))
                            order.AddSupplierInvoicesToEInvoices = (bool)values["addsupplierinvoicestoeinvoice"];

                        // Fix for bad currencydate
                        if (order.CurrencyDate == DateTime.MinValue)
                            order.CurrencyDate = DateTime.Today;

                        invoiceIsTemplate = order.IsTemplate;

                        if (order.InvoicePaymentService == 0)
                            order.InvoicePaymentService = null;

                        SetPriceListTypeInclusiveVat(entities, order, base.ActorCompanyId);

                        #region Previous invoice

                        if (invoiceId != 0)
                        {
                            SetModifiedProperties(order);

                            if (values.ContainsKey("previnvoiceid"))
                            {
                                // Add mapping from originating invoice (used when credit)
                                OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                                {
                                    Origin = order.Origin,
                                    Type = (int)GetOriginInvoiceMappingType(order),
                                    InvoiceId = Convert.ToInt32(values["previnvoiceid"])
                                };
                                entities.OriginInvoiceMapping.AddObject(oimap);
                            }
                        }

                        #endregion

                        #region Main Invoice

                        var mainInvoiceMapping = order.InvoiceMapping1.FirstOrDefault();
                        if (values.ContainsKey("maininvoiceid"))
                        {
                            var mainInvoiceId = Convert.ToInt32(values["maininvoiceid"]);
                            if (mainInvoiceMapping == null)
                            {
                                InvoiceMapping imap = new InvoiceMapping()
                                {
                                    MainInvoiceId = mainInvoiceId,
                                    Invoice1 = order,
                                };

                                entities.InvoiceMapping.AddObject(imap);
                            }
                            else
                            {
                                if (mainInvoiceMapping.MainInvoiceId != mainInvoiceId)
                                {
                                    entities.DeleteObject(mainInvoiceMapping);

                                    InvoiceMapping imap = new InvoiceMapping()
                                    {
                                        MainInvoiceId = mainInvoiceId,
                                        Invoice1 = order,
                                    };

                                    entities.InvoiceMapping.AddObject(imap);
                                }
                            }
                        }
                        else if (mainInvoiceMapping != null)
                        {
                            entities.DeleteObject(mainInvoiceMapping);
                        }

                        #endregion

                        #region AttestState
                        // Transferred status. Only relevant for offer and order
                        if (order.Origin.Type == (int)SoeOriginType.Offer || order.Origin.Type == (int)SoeOriginType.Order)
                            InitializeAttestStateIds(entities, base.ActorCompanyId);

                        #endregion

                        #region SeqNr

                        if (order.InvoiceId == 0)
                        {
                            if (!(bool)values["istemplate"])
                            {
                                // Get next sequence number
                                var seqDTO = InvoiceManager.GetNextSequenceNumber(entities, order, false);

                                order.SeqNr = seqNbr = seqDTO.SeqNr;

                                // Set invoice number to same as sequence number (padded to a specified number of digits)
                                order.InvoiceNr = seqNbr.ToString().PadLeft(seqDTO.NumberLength, '0');

                                invoiceNbr = order.InvoiceNr;
                            }
                            else
                            { order.InvoiceNr = invoiceNbr = string.Empty; }
                        }

                        #endregion

                        #region Project

                        result = HandleProjectOnSaveInvoice(entities, order, ActorCompanyId, values, standardMaterialCodeId, ref returnProject);

                        if (!result.Success)
                            return result;

                        #endregion

                        #region Rows

                        //Counters used to decide if an offer or order is fully or partly transferred, or not transferred at all.
                        int noOfTransferredRows = 0;
                        int noOfClosedRows = 0;
                        int noOfNotTransferredRows = 0;

                        //Assign transferredTo only once, presuppose that a offer only can be transferred to a order or a invoice, not both
                        SoeOriginType transferredTo = SoeOriginType.None;

                        //Counter used do decide if invoice has multiple asset rows
                        int noOfAssetRows = 0;

                        List<CustomerInvoiceRow> processedInputInvoiceRows = new List<CustomerInvoiceRow>();

                        // Stock
                        var stockDict = new Dictionary<int, Tuple<decimal, decimal, bool, int, int, int>>();

                        //fix up if not set  correctly
                        if (order.CurrencyRate == 0)
                            order.CurrencyRate = 1;

                        // Update or Delete existing CustomerInvoiceRows
                        int nextRowNr = 2;  // Claim row will get number 1
                        foreach (var invoiceRow in order.ActiveCustomerInvoiceRows)
                        {
                            #region CustomerInvoiceRow Update/Delete

                            invoiceRow.LoadHouseholdTaxDeductionRowReference();

                            var updateAccountingRows = false;

                            // Try get CustomerInvoiceRow from input
                            var invoiceRowInput = (from r in modifiedRows
                                                   where (Int64)((IDictionary<string, object>)r)["customerinvoicerowid"] == invoiceRow.CustomerInvoiceRowId
                                                   select r).FirstOrDefault() as IDictionary<string, object>;

                            if (invoiceRowInput == null)
                            {
                                if (invoiceRow.IsStockRow.HasValue && invoiceRow.IsStockRow.Value)
                                {
                                    int stockId = invoiceRow.StockId != null ? invoiceRow.StockId.Value : 0;
                                    int productId = invoiceRow.ProductId != null ? invoiceRow.ProductId.Value : 0;
                                    int attestStateId = invoiceRow.AttestStateId != null ? invoiceRow.AttestStateId.Value : 0;
                                    decimal quantity = invoiceRow.Quantity != null ? invoiceRow.Quantity.Value : decimal.Zero;
                                    decimal invoiceQuantity = invoiceRow.InvoiceQuantity != null ? invoiceRow.InvoiceQuantity.Value : decimal.Zero;
                                    stockDict.Add(invoiceRow.CustomerInvoiceRowId, new Tuple<decimal, decimal, bool, int, int, int>(quantity, invoiceQuantity, true, stockId, productId, attestStateId));
                                }

                                // Only used for calculating the numbers
                                bool isRowTransferred = GetTransferState(order, invoiceRow, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                updateAccountingRows = ((defaultInternalAccountChanged || priceListTypeChanged) && !isRowTransferred);

                                //Should not be like this so needs removal of accountingrows
                                if (invoiceRow.Product != null && ((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift && invoiceRow.ActiveCustomerInvoiceAccountRows.Any())
                                {
                                    updateAccountingRows = true;
                                }
                            }
                            else //(invoiceRowInput != null)
                            {
                                //Inherit AttestState from parent
                                if (invoiceRowInput.ContainsKey("parentrow") && (!invoiceRowInput.ContainsKey("previouslyinvoicedquantity") || Convert.ToInt32(invoiceRowInput["previouslyinvoicedquantity"]) == 0))
                                {
                                    // Hur ser detta ut...
                                    //invoiceRowInput["atteststateid"] = invoiceRowInput.ParentRow.AttestStateId;
                                }

                                // Household tax deduction
                                if (invoiceRow.HouseholdTaxDeductionRow == null && (
                                        (invoiceRowInput.ContainsKey("householdproperty") && invoiceRowInput["householdproperty"] != null) ||
                                        (invoiceRowInput.ContainsKey("householdcooperativeorgnbr") && invoiceRowInput["householdcooperativeorgnbr"] != null) ||
                                        (invoiceRowInput.ContainsKey("householdtypeisrut") && invoiceRowInput["householdtypeisrut"] != null && (bool)invoiceRowInput["householdtypeisrut"])
                                     )
                                   )
                                {
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(order, invoiceRow, invoiceRowInput);
                                    // Validate
                                    if (!result.Success)
                                        return result;
                                }
                                else if (invoiceRow.HouseholdTaxDeductionRow != null)
                                {
                                    HouseholdTaxDeductionManager.UpdateHouseholdTaxDeductionRow(invoiceRow, invoiceRowInput);
                                }

                                var newAttestStateId = invoiceRowInput.ContainsKey("atteststateid") ? Convert.ToInt32(invoiceRowInput["atteststateid"]).ToNullable() : null;
                                bool isRowTransferred = GetTransferStateOfOrderRow(newAttestStateId, Convert.ToInt32(invoiceRowInput["type"]), ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                if (isRowTransferred && !forceSave)
                                {
                                    #region CustomerInvoiceRow transferred (can not update or delete, only update row number)

                                    int rowNr = Convert.ToInt32(invoiceRowInput["rownr"]);
                                    if (invoiceRow.RowNr != rowNr)
                                    {
                                        invoiceRow.RowNr = rowNr;
                                        SetModifiedProperties(invoiceRow);
                                    }

                                    // Delete existing CustomerInvoiceAccountRows
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    if (((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                        CreateCustomerInvoiceAccountRow(entities, order, invoiceRow, (TermGroup_InvoiceVatType)order.VatType, ref nextRowNr, order.ActorId.HasValue ? order.ActorId.Value : 0, 0, order.ProjectId.HasValue ? order.ProjectId.Value : 0, base.ActorCompanyId, (invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null));

                                    #endregion
                                }
                                else
                                {
                                    if (Convert.ToInt32(invoiceRowInput["state"]) == (int)SoeEntityState.Deleted)
                                    {
                                        #region CustomerInvoiceRow Delete

                                        //CustomerInvoiceReminder
                                        if (invoiceRow.IsReminderRow)
                                            DecreaseNoOfReminders(entities, invoiceRow);

                                        if (invoiceRow.IsTimeProjectRow && invoiceRowInput.ContainsKey("timemanuallychanged"))
                                        {
                                            invoiceRow.TimeManuallyChanged = (bool)invoiceRowInput["timemanuallychanged"];
                                            SetModifiedProperties(invoiceRow);
                                        }

                                        //Check merge
                                        Int64? targetRowId = invoiceRowInput.ContainsKey("mergetoid") ? (Int64?)invoiceRowInput["mergetoid"] : null;
                                        if (targetRowId != null && targetRowId != 0)
                                        {
                                            List<TimeInvoiceTransaction> transactions = TimeTransactionManager.GetTimeInvoiceTransactionsForInvoiceRow(entities, invoiceRow.CustomerInvoiceRowId);
                                            foreach (var timeInvoiceTransaction in transactions)
                                            {
                                                timeInvoiceTransaction.CustomerInvoiceRow = null;
                                                timeInvoiceTransaction.CustomerInvoiceRowId = (int)targetRowId;

                                                SetModifiedProperties(timeInvoiceTransaction);
                                            }
                                        }

                                        // Delete existing CustomerInvoiceRow
                                        ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                                        // Delete existing CustomerInvoiceAccountRows
                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        // Delete existing household tax deduction row
                                        if (invoiceRow.HouseholdTaxDeductionRow != null)
                                            ChangeEntityState(invoiceRow.HouseholdTaxDeductionRow, SoeEntityState.Deleted);

                                        if (order.Project != null)
                                            TimeTransactionManager.DeleteTimeCodeTransactions(invoiceRow);

                                        HandleStockOnInvoiceRowDelete(entities, transaction, order, invoiceRow, usePartialInvoicingOnOrderRow);

                                        #endregion
                                    }
                                    else
                                    {
                                        #region CustomerInvoiceRow Update

                                        #region Update properties and references

                                        bool isStockRowOld = invoiceRow.IsStockRow != null ? invoiceRow.IsStockRow.Value : false;
                                        bool isStockRowNew = invoiceRowInput.ContainsKey("isstockrow") && invoiceRowInput["isstockrow"] != null ? (bool)invoiceRowInput["isstockrow"] : false;

                                        if (isStockRowOld || isStockRowNew)
                                        {
                                            //keep old values for compare....
                                            stockDict.Add(invoiceRow.CustomerInvoiceRowId, CreateInvoiceRowStockInfo(invoiceRow));

                                            if (invoiceRowInput.ContainsKey("stockid"))
                                                invoiceRow.StockId = Convert.ToInt32(invoiceRowInput["stockid"]);
                                        }

                                        if ((newAttestStateId == InvoiceAttestStatesIds.DeliverOrderToStockId) && (invoiceRow.AttestStateId != InvoiceAttestStatesIds.DeliverOrderToStockId) && (invoiceRow.Quantity != invoiceRow.InvoiceQuantity) && (invoiceRow.InvoiceQuantity > 0))
                                        {
                                            HandlePartialInvoicing(entities, transaction, order, invoiceRow, true);
                                            //because of new row add above...
                                            noOfNotTransferredRows++;
                                            orderRowsAdded = true;
                                        }

                                        var rowProps = invoiceRow.GetType().GetProperties();
                                        foreach (var prop in rowProps)
                                        {
                                            string lcName = prop.Name.ToLower();
                                            if (invoiceRowInput.ContainsKey(lcName))
                                            {
                                                if (lcName == "marginalincomeratio")
                                                {
                                                    var ratio = Convert.ToDecimal(invoiceRowInput[lcName]);
                                                    ratio = ratio >= 0 ? Math.Min(ratio, 99999) : Math.Max(ratio, -99999);
                                                    prop.SetValue(invoiceRow, ratio);
                                                }
                                                else if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                                                    prop.SetValue(invoiceRow, Convert.ToDecimal(invoiceRowInput[lcName]));
                                                else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                                                {
                                                    if (invoiceTreat0asNullRow.Contains(lcName) && (invoiceRowInput[lcName] == null || Convert.ToInt32(invoiceRowInput[lcName]) == 0))
                                                    {
                                                        invoiceRowInput[lcName] = null;
                                                        prop.SetValue(invoiceRow, invoiceRowInput[lcName]);
                                                    }
                                                    else
                                                        prop.SetValue(invoiceRow, Convert.ToInt32(invoiceRowInput[lcName]));
                                                }
                                                else
                                                    prop.SetValue(invoiceRow, invoiceRowInput[lcName]);
                                            }
                                        }

                                        SetModifiedProperties(invoiceRow);
                                        if (autoSave)
                                        {
                                            invoiceRow.ModifiedBy += " (auto)";
                                        }

                                        #endregion

                                        updateAccountingRows = true;


                                        #region TimeCodeTransaction

                                        if (order.Project != null)
                                        {
                                            result = TimeTransactionManager.UpdateTimeCodeTransactions(entities, base.ActorCompanyId, invoiceRow, order.Project, standardMaterialCodeId);
                                            if (!result.Success)
                                                return result;
                                        }

                                        #endregion

                                        #endregion
                                    }
                                }
                            }

                            if (updateAccountingRows && invoiceRow.State == (int)SoeEntityState.Active && (invoiceRow.Type != (int)SoeInvoiceRowType.AccountingRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsFreightAmountRow))
                            {
                                if (invoiceRowInput != null && (!invoiceRowInput.Keys.Contains("splitaccountingrows") || invoiceRowInput["splitaccountingrows"] == null || ((List<object>)invoiceRowInput["splitaccountingrows"]).Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any(r => r.SplitPercent > 0 && r.SplitType > 0))
                                {
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows.Where(r => r.VatRow))
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null && invoiceRow.ProductId != guaranteeProductId && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                    {
                                        CreateCustomerInvoiceAccountRow(entities, order, invoiceRow, (TermGroup_InvoiceVatType)order.VatType, ref nextRowNr, order.ActorId.HasValue ? order.ActorId.Value : 0, 0, order.ProjectId.HasValue ? order.ProjectId.Value : 0, base.ActorCompanyId, null, true);
                                    }
                                }
                                else
                                {
                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null && invoiceRow.ProductId != guaranteeProductId && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                    {
                                        var splitAccountingRows = (invoiceRowInput != null && invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null);

                                        List<AccountInternal> internals = null;
                                        if ((splitAccountingRows == null || splitAccountingRows.Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any())
                                        {
                                            var first = invoiceRow.ActiveCustomerInvoiceAccountRows.FirstOrDefault(r => !r.VatRow);
                                            if (first != null)
                                            {
                                                if (!first.AccountInternal.IsLoaded)
                                                    first.AccountInternal.Load();

                                                internals = first.AccountInternal.ToList();
                                            }
                                        }

                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        CreateCustomerInvoiceAccountRow(entities, order, invoiceRow, (TermGroup_InvoiceVatType)order.VatType, ref nextRowNr, order.ActorId.HasValue ? order.ActorId.Value : 0, 0, order.ProjectId.HasValue ? order.ProjectId.Value : 0, base.ActorCompanyId, splitAccountingRows, internals: internals);
                                    }
                                }
                                processedInputInvoiceRows.Add(invoiceRow);

                            }

                            #endregion
                        }


                        if (newRows.Count > 0)
                        {
                            //Order rows
                            newRows = newRows.OrderBy(r => r.TempRowId).ToList();

                            foreach (ProductRowDTO dto in newRows)
                            {
                                #region Prereq

                                // Do not include new inactive rows
                                if (dto.CustomerInvoiceRowId == 0 && dto.State != (int)SoeEntityState.Active)
                                    continue;

                                if (dto.VatAmountCurrency != 0 && dto.AmountCurrency == 0)
                                {
                                    base.LogError($"{dto.RowNr} - {dto.Text}: {GetText(7470, "Momsbeloppet kan inte vara större än totalbeloppet")}");
                                    result = new ActionResult((int)ActionResultSave.EntityNotCreated, $"{dto.RowNr} - {dto.Text}: {GetText(7470, "Momsbeloppet kan inte vara större än totalbeloppet")}");
                                    return result;
                                }

                                #endregion

                                #region CustomerInvoiceRow

                                // Create one CustomerInvoiceRow for each product row
                                var row = new CustomerInvoiceRow
                                {
                                    //CustomerInvoiceRowId = dto.CustomerInvoiceRowId,
                                    TempRowId = dto.TempRowId,
                                    AttestStateId = dto.AttestStateId,
                                    RowNr = dto.RowNr,
                                    Type = (int)dto.Type,
                                    VatRate = dto.VatRate,
                                    VatAmount = dto.VatAmount,
                                    VatAmountCurrency = dto.VatAmountCurrency,
                                    Quantity = dto.Quantity,
                                    InvoiceQuantity = dto.InvoiceQuantity,
                                    PreviouslyInvoicedQuantity = dto.PreviouslyInvoicedQuantity,
                                    Amount = dto.Amount,
                                    AmountCurrency = dto.AmountCurrency,
                                    DiscountType = dto.DiscountType,
                                    DiscountPercent = dto.DiscountPercent,
                                    DiscountAmount = dto.DiscountAmount,
                                    DiscountAmountCurrency = dto.DiscountAmountCurrency,
                                    Discount2Type = dto.Discount2Type,
                                    Discount2Percent = dto.Discount2Percent,
                                    Discount2Amount = dto.Discount2Amount,
                                    Discount2AmountCurrency = dto.Discount2AmountCurrency,
                                    SumAmount = dto.SumAmount,
                                    SumAmountCurrency = dto.SumAmountCurrency,
                                    Text = dto.Text,
                                    IsFreightAmountRow = dto.IsFreightAmountRow,
                                    IsInvoiceFeeRow = dto.IsInvoiceFeeRow,
                                    IsCentRoundingRow = dto.IsCentRoundingRow,
                                    IsInterestRow = dto.IsInterestRow,
                                    IsReminderRow = dto.IsReminderRow,
                                    PurchasePrice = dto.PurchasePrice,
                                    PurchasePriceCurrency = dto.PurchasePriceCurrency,
                                    SysWholesellerName = dto.SysWholesellerName,
                                    MarginalIncome = dto.MarginalIncome,
                                    MarginalIncomeCurrency = dto.MarginalIncomeCurrency,
                                    MarginalIncomeRatio = dto.MarginalIncomeRatio.GetValueOrDefault() >= 0 ? Math.Min(dto.MarginalIncomeRatio.GetValueOrDefault(), 99999) : Math.Max(dto.MarginalIncomeRatio.GetValueOrDefault(), -99999),
                                    State = (int)dto.State,
                                    IsTimeProjectRow = dto.IsTimeProjectRow,
                                    IsStockRow = dto.IsStockRow,
                                    //Set FK
                                    ProductId = dto.ProductId.ToNullable(),
                                    ProductUnitId = dto.ProductUnitId.ToNullable(),
                                    VatAccountId = dto.VatAccountId.ToNullable(),
                                    Date = dto.Date,
                                    TimeManuallyChanged = dto.TimeManuallyChanged,
                                    StockId = dto.StockId.ToNullable(),
                                    HouseholdDeductionType = dto.HouseholdDeductionType,
                                    DateTo = dto.DateTo,
                                    DeliveryDateText = dto.DeliveryDateText,
                                };

                                SetCreatedProperties(row);

                                if (autoCreateDateOnProductRows && !row.Date.HasValue && !dto.IsTimeProjectRow && !dto.IsFreightAmountRow && !dto.IsInvoiceFeeRow && !dto.IsCentRoundingRow)
                                    row.Date = row.Created.HasValue ? row.Created.Value.Date : DateTime.Today;

                                if (autoSave)
                                {
                                    row.CreatedBy += " (auto)";
                                }
                                // Set parent row
                                if (dto.ParentRowId.HasValue)
                                {
                                    var parentRow = order.CustomerInvoiceRow.FirstOrDefault(r => r.CustomerInvoiceRowId == dto.ParentRowId.Value);
                                    if (parentRow != null)
                                    {
                                        row.ParentRow = parentRow;

                                        if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                            row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                    }
                                    else
                                    {
                                        parentRow = order.CustomerInvoiceRow.FirstOrDefault(r => r.TempRowId == dto.ParentRowId.Value);
                                        if (parentRow != null)
                                        {
                                            row.ParentRow = parentRow;

                                            if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                                row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                        }
                                    }
                                }

                                // Household tax deduction
                                if (!string.IsNullOrEmpty(dto.HouseholdSocialSecNbr) || !string.IsNullOrEmpty(dto.HouseholdProperty) || (!string.IsNullOrEmpty(dto.HouseholdApartmentNbr) && !string.IsNullOrEmpty(dto.HouseholdCooperativeOrgNbr)))
                                {
                                    // Validate
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(order, row, dto);

                                    if (!result.Success)
                                        return result;
                                }

                                // Add account rows connected to current product row
                                #region CustomerInvoiceAccountRow Add

                                List<object> splitRows = new List<object>();
                                if (dto.SplitAccountingRows != null)
                                {
                                    foreach (SplitAccountingRowDTO splitRow in dto.SplitAccountingRows)
                                    {
                                        splitRows.Add((object)splitRow);
                                    }
                                }

                                if (!dto.IsLiftProduct && !dto.IsClearingProduct && dto.ProductId != guaranteeProductId)
                                    CreateCustomerInvoiceAccountRow(entities, order, row, (TermGroup_InvoiceVatType)order.VatType, ref nextRowNr, order.ActorId.HasValue ? order.ActorId.Value : 0, 0, order.ProjectId.HasValue ? order.ProjectId.Value : 0, ActorCompanyId, splitRows.Count > 0 ? splitRows : null);

                                #endregion

                                #region TimeCodeTransaction

                                if (order.Project != null)
                                {
                                    result = TimeTransactionManager.UpdateTimeCodeTransactions(entities, base.ActorCompanyId, row, order.Project, standardMaterialCodeId);
                                    if (!result.Success)
                                        return result;
                                }

                                #endregion

                                // Add product row with connected account rows to the collection of CustomerInvoiceRows
                                order.CustomerInvoiceRow.Add(row);

                                processedInputInvoiceRows.Add(row);

                                GetTransferState(order, row, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                // Add to modified to get id
                                modifiedOrderRows.Add(dto.TempRowId, row);

                                #endregion
                            }

                        }

                        // Check household
                        order.HasHouseholdTaxDeduction = order.ActiveCustomerInvoiceRows.Any(r => r.HouseholdTaxDeductionRow != null);

                        if (ConvertProductRowsTextUppercase(entities, processedInputInvoiceRows, base.ActorCompanyId))
                            orderRowsAdded = true;
                        #endregion

                        #region Set remaining amount

                        //Check if attestates are loaded
                        InitializeAttestStateIds(entities, base.ActorCompanyId);

                        /*int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, base.ActorCompanyId, 0);
                        bool showCentRoundingAsRow = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductCentRoundingRowOnInvoice, 0, base.ActorCompanyId, 0);

                        bool hasTransferedRows = false;
                        decimal cents = 0;

                        bool hasFixedPriceKeepPricesRows = order.ActiveCustomerInvoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceKeepPricesProductId);

                        //Hidden attest states 
                        List<int> excludedAttestStates = attestStates != null ? attestStates.Where(a => a.Hidden || a.Closed ).Select(a => a.AttestStateId).ToList() : new List<int>();

                        foreach (var invoiceRow in order.ActiveCustomerInvoiceRows)
                        {
                            if (invoiceRow.AttestStateId.HasValue && excludedAttestStates.Contains(invoiceRow.AttestStateId.Value) && (!invoiceRow.ProductId.HasValue || (invoiceRow.ProductId != fixedPriceProductId && invoiceRow.ProductId != fixedPriceKeepPricesProductId)))
                                continue;

                            if (order.Origin.Type == (int)SoeOriginType.Order && ((invoiceRow.Type == (int)SoeInvoiceRowType.ProductRow || invoiceRow.Type == (int)SoeInvoiceRowType.BaseProductRow) ||
                                (invoiceRow.IsFreightAmountRow || invoiceRow.IsInterestRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsReminderRow)) &&
                                invoiceRow.AttestStateId != InvoiceAttestStatesIds.TransferredOrderToInvoiceId && invoiceRow.State != (int)SoeEntityState.Deleted)
                            {
                                if (invoiceRow.AttestStateId.HasValue && excludedAttestStates.Contains(invoiceRow.AttestStateId.Value) && (!invoiceRow.ProductId.HasValue || (invoiceRow.ProductId != fixedPriceProductId && invoiceRow.ProductId != fixedPriceKeepPricesProductId)))
                                    continue;

                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product == null || (((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    if (order.VatType == (int)TermGroup_InvoiceVatType.Merchandise && (priceListType == null || !priceListType.InclusiveVat))
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency;
                                        remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                    }
                                    else
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency;
                                        remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency - invoiceRow.VatAmountCurrency;
                                    }

                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                }

                            }
                            else if (invoiceRow.IsCentRoundingRow)
                            {
                                if (order.VatType == (int)TermGroup_InvoiceVatType.Merchandise && (priceListType == null || !priceListType.InclusiveVat))
                                {
                                    cents = (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                }
                                else
                                {
                                    cents = invoiceRow.SumAmountCurrency;
                                }

                            }
                            else if (invoiceRow.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                            {
                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product != null && (((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    remainingCurrencyAmount += (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                    remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                }

                                hasTransferedRows = true;
                            }
                        }

                        int tryAmount = 0;
                        if (!Int32.TryParse(remainingCurrencyAmount.ToString(), out tryAmount))
                        {
                            if (hasTransferedRows)
                            {
                                remainingCurrencyAmount = Math.Round(remainingCurrencyAmount, 0, MidpointRounding.ToEven);
                            }
                        }

                        int tryAmountExVat = 0;
                        if (!Int32.TryParse(remainingCurrencyAmountExVat.ToString(), out tryAmountExVat))
                        {
                            if (hasTransferedRows)
                            {
                                remainingCurrencyAmountExVat = Math.Round(remainingCurrencyAmountExVat, 0, MidpointRounding.ToEven);
                            }
                            else
                            {
                                remainingCurrencyAmountExVat += cents;
                            }
                        }

                        int tryAmountVat = 0;
                        if (!Int32.TryParse(remainingCurrencyAmountVat.ToString(), out tryAmountVat))
                        {
                            if (hasTransferedRows)
                            {
                                remainingCurrencyAmountVat = Math.Round(remainingCurrencyAmountVat, 0, MidpointRounding.ToEven);
                            }
                            else
                            {
                                remainingCurrencyAmountVat += cents;
                            }
                        }

                        //Set remaining amount
                        order.RemainingAmount = showCentRoundingAsRow ? remainingCurrencyAmount : remainingCurrencyAmount + cents;
                        order.RemainingAmountVat = remainingCurrencyAmountVat;
                        order.RemainingAmountExVat = remainingCurrencyAmountExVat;*/

                        if (order.ActiveCustomerInvoiceRows.Any())
                        {
                            int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, order.CurrencyId);
                            int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                            UpdateInvoiceAfterRowModification(entities, order, nextRowNr, ActorCompanyId, true, sysCurrencyIdInvoice != sysCurrencyIdBase, check4NewClaimAccount: customerChanged);
                        }

                        // Check for multiple asset rows
                        if (noOfAssetRows > 1)
                            order.MultipleAssetRows = true;

                        #region Update status

                        //Synch Origin.Status with the current status of all CustomerInvoiceRow's
                        switch (order.Origin.Type)
                        {
                            case (int)SoeOriginType.Offer:
                                if (transferredTo == SoeOriginType.Order)
                                {
                                    UpdateInvoiceStatus(order, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.OfferFullyOrder, SoeOriginStatus.OfferPartlyOrder);
                                }
                                else if (transferredTo == SoeOriginType.CustomerInvoice)
                                {
                                    UpdateInvoiceStatus(order, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.OfferFullyInvoice, SoeOriginStatus.OfferPartlyInvoice);
                                }
                                else if (transferredTo == SoeOriginType.None)
                                {
                                    UpdateInvoiceStatus(order, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.Origin, SoeOriginStatus.Origin);
                                }
                                break;
                            case (int)SoeOriginType.Order:
                                if (transferredTo == SoeOriginType.CustomerInvoice)
                                {
                                    UpdateInvoiceStatus(order, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OrderClosed, SoeOriginStatus.OrderFullyInvoice, SoeOriginStatus.OrderPartlyInvoice);
                                }
                                else if (transferredTo == SoeOriginType.None)
                                {
                                    UpdateInvoiceStatus(order, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OrderClosed, SoeOriginStatus.Origin, SoeOriginStatus.Origin);
                                }
                                break;
                        }

                        #endregion

                        #endregion

                        #region Calculate currency amounts

                        //Calculate currency amounts
                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, base.ActorCompanyId, order, true);

                        #endregion

                        #region Save

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        #region stock

                        if (!order.IsTemplate)
                            this.HandleStockOnInvoice(order, entities, transaction, base.ActorCompanyId, stockDict, usePartialInvoicingOnOrderRow, false);

                        #endregion

                        #region Voucher

                        if (result.Success && !order.IsTemplate)
                        {
                            result = TryTransferCustomerInvoiceToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, order, accountYearId, base.ActorCompanyId);
                            if (result.Success)
                                voucherHeadsDict = NumberUtility.MergeDictictionary(voucherHeadsDict, result.IdDict);
                        }

                        #endregion

                        if (result.Success)
                        {
                            //Set id
                            invoiceId = order.InvoiceId;

                            if (orderAttachments != null && orderAttachments.Any())
                            {
                                var newStatusIcon = SaveOrderInvoiceAttachments(entities, order.InvoiceId, order.StatusIcon, orderAttachments, order.InvoiceNr);
                                if (newStatusIcon != order.StatusIcon)
                                {
                                    order.StatusIcon = newStatusIcon;
                                    SaveChanges(entities);
                                }
                            }

                            #region Categories

                            if (values.ContainsKey("categoryids"))
                            {
                                List<int> categoryIds = new List<int>();
                                foreach (var val in (List<object>)values["categoryids"])
                                {
                                    categoryIds.Add(Convert.ToInt32(val));
                                }

                                CategoryManager.SaveCompanyCategoryRecords(entities, transaction, categoryIds, base.ActorCompanyId, SoeCategoryType.Order, SoeCategoryRecordEntity.Order, invoiceId);
                            }

                            #endregion

                            #region Checklists

                            result = AddUpdateChecklists(entities, transaction, order.InvoiceId, checklistHeads, checklistRows, order.StatusIcon);
                            if (result.Success)
                                order.StatusIcon = result.IntegerValue;
                            else
                                return result;

                            #endregion

                            #region OriginUsers

                            string subject = sendXEMail ? GetText(7715, "Tilldelad order") : string.Empty;
                            string text = sendXEMail ? GetText(7716, "Du har blivit tilldelad order med nummer") + ": " + order.InvoiceNr : string.Empty;

                            ActionResult originUserResult = SaveOriginUsers(transaction, entities, invoiceId, originUsers, base.ActorCompanyId, base.LicenseId, sendXEMail, subject, text, true, messageType: TermGroup_MessageType.OrderAssigned);
                            if (!originUserResult.Success)
                                return originUserResult;
                            else if (originUserResult.IntegerValue > 0)
                                messageToSendId = originUserResult.IntegerValue;

                            #endregion

                            #region OCR

                            // In Finland next step after this valid invoice is to focus on incoming payments.
                            // There we need to have only unique references within company. 
                            var ocr = values.ContainsKey("ocr") ? (string)values["ocr"] : string.Empty;
                            if (seqNbr != 0 && string.IsNullOrEmpty(ocr) && SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormReferenceNumberToOCR, 0, base.ActorCompanyId, 0))
                            {
                                Company company = CompanyManager.GetCompany(entities, base.ActorCompanyId);
                                if (company.SysCountryId != null)
                                {
                                    if (!order.ActorReference.IsLoaded)
                                        order.ActorReference.Load();

                                    if (order.Actor != null)
                                    {
                                        if (!order.Actor.CustomerReference.IsLoaded)
                                            order.Actor.CustomerReference.Load();

                                        switch ((int)company.SysCountryId)
                                        {
                                            case 2: //US
                                                break;
                                            case 3: //Finland
                                                if (order.InvoiceNr != null && order.Actor.Customer.CustomerNr != null)
                                                {
                                                    string tmpReference = order.Actor.Customer.CustomerNr.ToString() + "0000" + order.InvoiceNr.ToString();
                                                    if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, base.ActorCompanyId, 0))
                                                    {
                                                        order.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                                    }
                                                    else
                                                    {
                                                        order.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                                    }
                                                }
                                                else
                                                {
                                                    string errorCheck = "";
                                                    if (order.InvoiceNr == null) errorCheck += "A=null";
                                                    if (order.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                                    order.OCR = "Virhe(1):" + errorCheck;
                                                }

                                                break;
                                            case 4: //Norge
                                                if (order.InvoiceNr != null && order.Actor.Customer.CustomerNr != null)
                                                {
                                                    order.OCR = InvoiceUtility.GetNorwegianKIDNumber(order.InvoiceNr.ToString(), order.Actor.Customer.CustomerNr.ToString(), (DateTime)order.InvoiceDate, 0);
                                                }
                                                break;
                                            default:
                                                //Sverige case 1
                                                order.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                                                break;
                                        }
                                    }
                                }
                                else
                                {
                                    //Svenskt
                                    order.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                                }

                                SetModifiedProperties(order);
                                SaveChanges(entities);
                            }

                            #endregion

                            #region EntityHistory

                            GeneralManager.SaveEntityHistory(entities, entityType, invoiceId, DateTime.Now, true, true, false, base.ActorCompanyId);

                            #endregion

                            //Commit transaction
                            transaction.Complete();

                            //modified order
                            modified = order.Modified;
                            modifiedBy = order.ModifiedBy;

                            created = order.Created;
                            createdBy = order.CreatedBy;

                            //Modified rows
                            modifiedRowIds.Clear();
                            foreach (int tempRowId in modifiedOrderRows.Keys)
                            {
                                modifiedRowIds.Add(tempRowId, modifiedOrderRows[tempRowId].CustomerInvoiceRowId);
                            }

                            setPrintTimeProjectAsChecked = order.PrintTimeReport;

                        }

                        #endregion
                    }

                    #region Push notification
                    if (result.Success)
                    {
                        try
                        {
                            //Try to send push notifications - seperate try/catch to make sure values are returned even if push fails
                            if (messageToSendId.HasValue && messageToSendId.Value > 0)
                                CommunicationManager.SendMessagePushNotification(messageToSendId.Value);
                        }
                        catch (Exception ex)
                        {
                            base.LogError(ex, this.log);
                        }
                    }

                    #endregion
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                    seqNbr = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = invoiceId;
                        result.StringValue = invoiceNbr;
                        result.Value = seqNbr;
                        //result.BooleanValue = invoiceInput.IsTemplate ? true : reloadAfterSave;
                        result.IntDict = modifiedRowIds;
                        //result.IntDict2 = modifiedAccRowIds;
                        result.Value2 = returnProject;
                        result.BooleanValue = orderRowsAdded;
                        result.BooleanValue2 = setPrintTimeProjectAsChecked;

                        if (invoiceIsTemplate)
                            result.SuccessNumber = (int)ActionResultSave.CustomerInvoiceIsTemplate;

                        if (isNew && created.HasValue)
                        {
                            result.Modified = created.Value;
                            result.ModifiedBy = createdBy;
                        }
                        else if (modified.HasValue)
                        {
                            result.Modified = modified.Value;
                            result.ModifiedBy = modifiedBy;
                        }

                        if (voucherHeadsDict != null)
                            result.IdDict = voucherHeadsDict;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult SaveOffer(dynamic modifiedFields, List<ProductRowDTO> newRows, List<ExpandoObject> modifiedRows, List<OriginUserDTO> originUsers, List<FileUploadDTO> offerAttachments, bool discardConcurrencyCheck, bool regenerateAccounting)
        {
            var result = new ActionResult();

            #region Prereq

            bool rowsAdded = false;
            int seqNbr = 0;
            var values = (IDictionary<string, object>)modifiedFields;
            bool invoiceIsTemplate = false;
            DateTime? modified = null;
            string modifiedBy = null;
            DateTime? created = null;
            string createdBy = null;
            string invoiceNbr = String.Empty;
            decimal remainingCurrencyAmount = 0;
            decimal remainingCurrencyAmountVat = 0;
            decimal remainingCurrencyAmountExVat = 0;
            Dictionary<int, int> voucherHeadsDict = null;
            Dictionary<int, int> modifiedRowIds = new Dictionary<int, int>();
            Dictionary<int, CustomerInvoiceRow> modifiedOrderRows = new Dictionary<int, CustomerInvoiceRow>();

            int invoiceId = values.ContainsKey("id") ? Convert.ToInt32(values["id"]) : 0;
            bool isNew = invoiceId == 0;

            #region Types

            SoeEntityType entityType = SoeEntityType.Offer;

            #endregion

            #region Attest states

            List<AttestState> attestStates = AttestManager.GetAttestStates(base.ActorCompanyId, TermGroup_AttestEntity.Offer, SoeModule.Billing);

            #endregion

            #region Settings

            bool? conflictSetting = values.ContainsKey("checkconflictsonsave") ? (bool?)values["checkconflictsonsave"] : null;
            if (conflictSetting != null)
                SettingManager.UpdateInsertBoolSetting(SettingMainType.User, (int)UserSettingType.BillingCheckConflictsOnSave, conflictSetting.Value, base.UserId, base.ActorCompanyId, 0);

            #endregion

            #endregion

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    #region Prereq

                    // Check if order was modified after current order was fetched
                    if (!discardConcurrencyCheck && values.ContainsKey("modified"))
                    {
                        DateTime? currentModified = null;
                        var field = values["modified"];
                        if (field != null)
                        {
                            currentModified = (DateTime)field;
                            values.Remove("modified");
                        }

                        bool isModified = base.IsEntityModified(entities, invoiceId, entityType, currentModified, out modified, out modifiedBy);
                        if (isModified && (modified.HasValue || modifiedBy.HasValue()))
                            return new ActionResult((int)ActionResultSave.EntityIsModifiedByOtherUser, String.Format(GetText(4004, 1005, "Offerten är uppdaterad {0} av {1}. Om du sparar kommer den användarens ändringar att skrivas över.\nVill du fortsätta?"), modified, modifiedBy));
                    }

                    #endregion


                    InitializeAttestStateIds(entities, base.ActorCompanyId);

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        //Load invoice
                        bool loadProductRows = newRows.Count > 0 || modifiedRows.Count > 0;
                        CustomerInvoice offer = invoiceId != 0 ? GetCustomerInvoice(entities, invoiceId, true, true, true, false, true, false, false, loadProductRows, regenerateAccounting, false, false, false) : null;

                        //Fixed price keep prices
                        int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, base.ActorCompanyId, 0);

                        //Force saving
                        bool forceSave = values.ContainsKey("forcesave") ? (bool)values["forcesave"] : false;

                        //Ok to save
                        if (!(forceSave || offer == null ? true : (offer.Origin.Status == (int)SoeOriginStatus.Draft || offer.Origin.Status == (int)SoeOriginStatus.Origin || offer.Origin.Status == (int)SoeOriginStatus.OfferPartlyInvoice || offer.Origin.Status == (int)SoeOriginStatus.OfferPartlyOrder)))
                        {
                            string text = GetText(176, "Felaktig statusförändring") + ": " + GetText(offer.Origin.Status, (int)TermGroup.OriginStatus);
                            return new ActionResult((int)ActionResultSave.InvalidStateTransition, text);
                        }

                        if (invoiceId == 0)
                        {
                            #region Add

                            bool addInvoice = offer == null;
                            if (addInvoice)
                            {
                                #region Origin

                                int? voucherSeriesTypeId = null;

                                if (values.ContainsKey("voucherSeriesTypeId"))
                                    voucherSeriesTypeId = Convert.ToInt32(values["voucherSeriesTypeId"]);

                                if (voucherSeriesTypeId == 0)
                                    voucherSeriesTypeId = null;

                                // Create new Origin, fields will be set in update below
                                Origin origin = new Origin()
                                {
                                    VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]),
                                    VoucherSeriesTypeId = voucherSeriesTypeId,
                                    Type = (int)SoeOriginType.Offer,
                                    Status = Convert.ToInt32(values["originstatus"]),

                                    //Set FK
                                    ActorCompanyId = base.ActorCompanyId,
                                };

                                if (values.ContainsKey("origindescription"))
                                {
                                    origin.Description = (string)values["origindescription"];
                                    values.Remove("origindescription");
                                }

                                SetCreatedProperties(origin);
                                entities.Origin.AddObject(origin);

                                #endregion

                                #region OriginUser

                                // Add current user to origin
                                OriginUser originUser = new OriginUser()
                                {
                                    Main = true,

                                    //Set FK
                                    UserId = base.UserId,

                                    //Set references
                                    Origin = origin,
                                };
                                origin.OriginUser.Add(originUser);
                                SetCreatedProperties(originUser);

                                #endregion

                                #region CustomerInvoice

                                // Create new CustomerInvoice, fields will be set in update below
                                offer = new CustomerInvoice()
                                {
                                    // Inherited from Invoice
                                    Origin = origin,
                                    Type = (int)SoeInvoiceType.CustomerInvoice,
                                    OnlyPayment = false,
                                    PaidAmountCurrency = 0,
                                    FullyPayed = false,
                                    SysPaymentTypeId = 0,
                                    PaymentNr = String.Empty,
                                    MultipleAssetRows = false, // Will be calculated'
                                    RegistrationType = (int)OrderInvoiceRegistrationType.Offer,
                                };

                                if (!(bool)values["istemplate"])
                                {
                                    // Get next sequence number
                                    string entityName = String.Empty;
                                    int startNbr = 0;
                                    int invoiceNumberLength = 0;
                                    InvoiceManager.GetNextSequenceNumber(entities, SoeOriginType.Offer, (SoeOriginStatus)origin.Status, TermGroup_BillingType.Debit, base.ActorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, false, false);

                                    offer.SeqNr = seqNbr;

                                    // Set invoice number to same as sequence number (padded to a specified number of digits)
                                    offer.InvoiceNr = seqNbr.ToString().PadLeft(invoiceNumberLength, '0');

                                    // Set dates
                                    if (!values.ContainsKey("invoicedate") || values["invoicedate"] == null)
                                        offer.InvoiceDate = DateTime.Today;
                                    if (!values.ContainsKey("voucherdate") || values["voucherdate"] == null)
                                        offer.VoucherDate = DateTime.Today;

                                    invoiceNbr = offer.InvoiceNr;
                                }
                                else
                                { offer.InvoiceNr = invoiceNbr = string.Empty; }

                                entities.Invoice.AddObject(offer);
                                SetCreatedProperties(offer);

                                #endregion

                            }

                            #endregion
                        }
                        else
                        {
                            #region Update

                            // Update Origin
                            if (values.ContainsKey("voucherseriesid"))
                            {
                                offer.Origin.VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]);
                                values.Remove("voucherseriesid");
                            }
                            if (values.ContainsKey("origindescription"))
                            {
                                offer.Origin.Description = (string)values["origindescription"];
                                values.Remove("origindescription");
                            }
                            if (offer.Origin.Status == (int)SoeOriginStatus.Draft || offer.Origin.Status == (int)SoeOriginStatus.Origin && values.ContainsKey("originstatus"))
                            {
                                int origStatus = Convert.ToInt32(values["originstatus"]);
                                if (offer.Origin.Status != origStatus)
                                {
                                    offer.Origin.Status = origStatus;
                                }
                                values.Remove("originstatus");
                            }

                            SetModifiedProperties(offer.Origin);

                            #endregion
                        }

                        string[] excludes = { "categoryids", "seqnr", "invoicenr", "projectnr", "created", "modified", "createdby", "modifiedby" };

                        bool defaultInternalAccountChanged = false;

                        var props = offer.GetType().GetProperties();
                        foreach (var prop in props)
                        {
                            string lcName = prop.Name.ToLower();

                            if (values.ContainsKey(lcName) && !excludes.Contains(lcName))
                            {
                                var value = values[lcName];

                                if (internalAccountFields.Contains(lcName))
                                {
                                    defaultInternalAccountChanged = true;
                                }

                                if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                                    prop.SetValue(offer, Convert.ToDecimal(value));
                                else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                                {
                                    if (invoiceTreat0asNullHead.Contains(lcName) && value != null && Convert.ToInt32(value) == 0)
                                    {
                                        value = null;
                                    }
                                    prop.SetValue(offer, value == null ? (int?)null : Convert.ToInt32(value));
                                }
                                else if ((prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?)) && value != null)
                                {
                                    DateTime dt = (DateTime)value;
                                    if (dt.Year < 1900)
                                        prop.SetValue(offer, new DateTime(1900, dt.Month, dt.Day));
                                    else
                                        prop.SetValue(offer, value);
                                }
                                else
                                    prop.SetValue(offer, value);
                            }
                        }

                        invoiceIsTemplate = offer.IsTemplate;

                        if (offer.InvoicePaymentService == 0)
                            offer.InvoicePaymentService = null;

                        //fix up if not set  correctly
                        if (offer.CurrencyRate == 0)
                            offer.CurrencyRate = 1;

                        PriceListType priceListType = ProductPricelistManager.GetPriceListType(entities, offer.PriceListTypeId != null ? (int)offer.PriceListTypeId : 0, base.ActorCompanyId);
                        offer.PriceListTypeInclusiveVat = priceListType == null ? false : priceListType.InclusiveVat;

                        #region Previous invoice

                        if (invoiceId != 0)
                        {
                            SetModifiedProperties(offer);

                            if (values.ContainsKey("previnvoiceid"))
                            {
                                // Add mapping from originating invoice (used when credit)
                                OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                                {
                                    Origin = offer.Origin,
                                    Type = (int)GetOriginInvoiceMappingType(offer),
                                    InvoiceId = Convert.ToInt32(values["previnvoiceid"])
                                };
                                entities.OriginInvoiceMapping.AddObject(oimap);
                            }
                        }

                        #endregion

                        #region Rows

                        //Counters used to decide if an offer or order is fully or partly transferred, or not transferred at all.
                        int noOfTransferredRows = 0;
                        int noOfClosedRows = 0;
                        int noOfNotTransferredRows = 0;

                        //Assign transferredTo only once, presuppose that a offer only can be transferred to a order or a invoice, not both
                        SoeOriginType transferredTo = SoeOriginType.None;

                        //Counter used do decide if invoice has multiple asset rows
                        int noOfAssetRows = 0;

                        List<CustomerInvoiceRow> processedInputInvoiceRows = new List<CustomerInvoiceRow>();
                        List<CustomerInvoiceAccountRow> processedInputInvoiceAccountRows = new List<CustomerInvoiceAccountRow>();

                        // Stock
                        var stockDict = new Dictionary<int, Tuple<decimal, decimal, bool, int, int, int>>();

                        // Update or Delete existing CustomerInvoiceRows
                        int nextRowNr = 2;  // Claim row will get number 1
                        foreach (var invoiceRow in offer.ActiveCustomerInvoiceRows)
                        {
                            #region CustomerInvoiceRow Update/Delete

                            var updateAccountingRows = false;

                            // Try get CustomerInvoiceRow from input
                            var invoiceRowInput = (from r in modifiedRows
                                                   where (Int64)((IDictionary<string, object>)r)["customerinvoicerowid"] == invoiceRow.CustomerInvoiceRowId
                                                   select r).FirstOrDefault() as IDictionary<string, object>;

                            if (invoiceRowInput == null)
                            {
                                // Only used for calculating the numbers
                                bool isRowTransferred = GetTransferState(offer, invoiceRow, ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                updateAccountingRows = (defaultInternalAccountChanged && !isRowTransferred);
                            }
                            else
                            {
                                invoiceRow.LoadHouseholdTaxDeductionRowReference();

                                //Inherit AttestState from parent
                                if (invoiceRowInput.ContainsKey("parentrow") && (!invoiceRowInput.ContainsKey("previouslyinvoicedquantity") || Convert.ToInt32(invoiceRowInput["previouslyinvoicedquantity"]) == 0))
                                {
                                    // Hur ser detta ut...
                                    //invoiceRowInput["atteststateid"] = invoiceRowInput.ParentRow.AttestStateId;
                                }

                                // Household tax deduction
                                if (invoiceRow.HouseholdTaxDeductionRow == null && (
                                        (invoiceRowInput.ContainsKey("householdproperty") && invoiceRowInput["householdproperty"] != null) ||
                                        (invoiceRowInput.ContainsKey("householdcooperativeorgnbr") && invoiceRowInput["householdcooperativeorgnbr"] != null) ||
                                        (invoiceRowInput.ContainsKey("householdtypeisrut") && invoiceRowInput["householdtypeisrut"] != null && (bool)invoiceRowInput["householdtypeisrut"])
                                     )
                                   )
                                {
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(offer, invoiceRow, invoiceRowInput);
                                    if (!result.Success)
                                        return result;
                                }
                                else if (invoiceRow.HouseholdTaxDeductionRow != null)
                                {
                                    HouseholdTaxDeductionManager.UpdateHouseholdTaxDeductionRow(invoiceRow, invoiceRowInput);
                                }

                                var newAttestStateId = invoiceRowInput.ContainsKey("atteststateid") ? Convert.ToInt32(invoiceRowInput["atteststateid"]).ToNullable() : null;
                                bool isRowTransferred = GetTransferStateOfOfferRow(newAttestStateId, Convert.ToInt32(invoiceRowInput["type"]), ref noOfTransferredRows, ref noOfClosedRows, ref noOfNotTransferredRows, ref transferredTo);
                                if (isRowTransferred && !forceSave)
                                {
                                    #region CustomerInvoiceRow transferred (can not update or delete, only update row number)

                                    int rowNr = Convert.ToInt32(invoiceRowInput["rownr"]);
                                    if (invoiceRow.RowNr != rowNr)
                                    {
                                        invoiceRow.RowNr = rowNr;
                                        SetModifiedProperties(invoiceRow);
                                    }

                                    // Delete existing CustomerInvoiceAccountRows
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    if (((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                        CreateCustomerInvoiceAccountRow(entities, offer, invoiceRow, (TermGroup_InvoiceVatType)offer.VatType, ref nextRowNr, offer.ActorId.HasValue ? offer.ActorId.Value : 0, 0, offer.ProjectId.HasValue ? offer.ProjectId.Value : 0, base.ActorCompanyId, (invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null));

                                    #endregion
                                }
                                else
                                {
                                    if (Convert.ToInt32(invoiceRowInput["state"]) == (int)SoeEntityState.Deleted)
                                    {
                                        #region CustomerInvoiceRow Delete
                                        // Delete existing CustomerInvoiceRow
                                        ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                                        // Delete existing CustomerInvoiceAccountRows
                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        // Delete existing household tax deduction row
                                        if (invoiceRow.HouseholdTaxDeductionRow != null)
                                            ChangeEntityState(invoiceRow.HouseholdTaxDeductionRow, SoeEntityState.Deleted);

                                        #endregion
                                    }
                                    else
                                    {
                                        #region CustomerInvoiceRow Update

                                        #region Update properties and references

                                        var rowProps = invoiceRow.GetType().GetProperties();
                                        foreach (var prop in rowProps)
                                        {
                                            string lcName = prop.Name.ToLower();
                                            if (invoiceRowInput.ContainsKey(lcName))
                                            {
                                                if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                                                    prop.SetValue(invoiceRow, Convert.ToDecimal(invoiceRowInput[lcName]));
                                                else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                                                {
                                                    if (invoiceTreat0asNullRow.Contains(lcName) && (invoiceRowInput[lcName] == null || Convert.ToInt32(invoiceRowInput[lcName]) == 0))
                                                    {
                                                        invoiceRowInput[lcName] = null;
                                                        prop.SetValue(invoiceRow, invoiceRowInput[lcName]);
                                                    }
                                                    else
                                                        prop.SetValue(invoiceRow, Convert.ToInt32(invoiceRowInput[lcName]));
                                                }
                                                else
                                                    prop.SetValue(invoiceRow, invoiceRowInput[lcName]);
                                            }
                                        }

                                        SetModifiedProperties(invoiceRow);

                                        #endregion

                                        updateAccountingRows = true;

                                        #endregion
                                    }
                                }
                            }

                            if (updateAccountingRows && invoiceRow.State == (int)SoeEntityState.Active && (invoiceRow.Type != (int)SoeInvoiceRowType.AccountingRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsFreightAmountRow))
                            {
                                if (invoiceRowInput != null && (!invoiceRowInput.Keys.Contains("splitaccountingrows") || invoiceRowInput["splitaccountingrows"] == null || ((List<object>)invoiceRowInput["splitaccountingrows"]).Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any(r => r.SplitPercent > 0 && r.SplitType > 0))
                                {
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows.Where(r => r.VatRow))
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                    {
                                        CreateCustomerInvoiceAccountRow(entities, offer, invoiceRow, (TermGroup_InvoiceVatType)offer.VatType, ref nextRowNr, offer.ActorId.HasValue ? offer.ActorId.Value : 0, 0, offer.ProjectId.HasValue ? offer.ProjectId.Value : 0, base.ActorCompanyId, null, true);
                                    }
                                }
                                else
                                {
                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                    {
                                        var splitAccountingRows = (invoiceRowInput != null && invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null);

                                        if ((splitAccountingRows == null || splitAccountingRows.Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any())
                                        {
                                            var first = invoiceRow.ActiveCustomerInvoiceAccountRows.FirstOrDefault(r => !r.VatRow);
                                            if (first != null && !first.AccountInternal.IsLoaded)
                                            {
                                                first.AccountInternal.Load();
                                            }
                                        }

                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        CreateCustomerInvoiceAccountRow(entities, offer, invoiceRow, (TermGroup_InvoiceVatType)offer.VatType, ref nextRowNr, offer.ActorId.HasValue ? offer.ActorId.Value : 0, 0, offer.ProjectId.HasValue ? offer.ProjectId.Value : 0, base.ActorCompanyId, splitAccountingRows);
                                    }
                                }
                            }
                            processedInputInvoiceRows.Add(invoiceRow);

                            #endregion
                        }

                        if (newRows.Count > 0)
                        {
                            //Offer rows
                            newRows = newRows.OrderBy(r => r.TempRowId).ToList();

                            foreach (ProductRowDTO dto in newRows)
                            {
                                #region Prereq

                                // Do not include new inactive rows
                                if (dto.CustomerInvoiceRowId == 0 && dto.State != (int)SoeEntityState.Active)
                                    continue;

                                #endregion

                                #region CustomerInvoiceRow

                                // Create one CustomerInvoiceRow for each product row
                                CustomerInvoiceRow row = new CustomerInvoiceRow()
                                {
                                    //CustomerInvoiceRowId = dto.CustomerInvoiceRowId,
                                    TempRowId = dto.TempRowId,
                                    AttestStateId = dto.AttestStateId,
                                    RowNr = dto.RowNr,
                                    Type = (int)dto.Type,
                                    VatRate = dto.VatRate,
                                    VatAmount = dto.VatAmount,
                                    VatAmountCurrency = dto.VatAmountCurrency,
                                    Quantity = dto.Quantity,
                                    InvoiceQuantity = dto.InvoiceQuantity,
                                    PreviouslyInvoicedQuantity = dto.PreviouslyInvoicedQuantity,
                                    Amount = dto.Amount,
                                    AmountCurrency = dto.AmountCurrency,
                                    DiscountType = dto.DiscountType,
                                    DiscountPercent = dto.DiscountPercent,
                                    DiscountAmount = dto.DiscountAmount,
                                    DiscountAmountCurrency = dto.DiscountAmountCurrency,
                                    Discount2Type = dto.Discount2Type,
                                    Discount2Percent = dto.Discount2Percent,
                                    Discount2Amount = dto.Discount2Amount,
                                    Discount2AmountCurrency = dto.Discount2AmountCurrency,
                                    SumAmount = dto.SumAmount,
                                    SumAmountCurrency = dto.SumAmountCurrency,
                                    Text = dto.Text,
                                    IsFreightAmountRow = dto.IsFreightAmountRow,
                                    IsInvoiceFeeRow = dto.IsInvoiceFeeRow,
                                    IsCentRoundingRow = dto.IsCentRoundingRow,
                                    IsInterestRow = dto.IsInterestRow,
                                    IsReminderRow = dto.IsReminderRow,
                                    PurchasePrice = dto.PurchasePrice,
                                    PurchasePriceCurrency = dto.PurchasePriceCurrency,
                                    SysWholesellerName = dto.SysWholesellerName,
                                    MarginalIncome = dto.MarginalIncome,
                                    MarginalIncomeCurrency = dto.MarginalIncomeCurrency,
                                    MarginalIncomeRatio = dto.MarginalIncomeRatio,
                                    State = (int)dto.State,
                                    IsTimeProjectRow = dto.IsTimeProjectRow,
                                    IsStockRow = dto.IsStockRow,
                                    //Set FK
                                    ProductId = dto.ProductId.ToNullable(),
                                    ProductUnitId = dto.ProductUnitId.ToNullable(),
                                    VatAccountId = dto.VatAccountId.ToNullable(),
                                    Date = dto.Date,
                                    TimeManuallyChanged = dto.TimeManuallyChanged,
                                    StockId = dto.StockId.ToNullable(),
                                    HouseholdDeductionType = dto.HouseholdDeductionType,
                                    DateTo = dto.DateTo,
                                    DeliveryDateText = dto.DeliveryDateText,
                                };
                                SetCreatedProperties(row);

                                // Set parent row
                                if (dto.ParentRowId.HasValue)
                                {
                                    var parentRow = offer.CustomerInvoiceRow.FirstOrDefault(r => r.CustomerInvoiceRowId == dto.ParentRowId.Value);
                                    if (parentRow != null)
                                    {
                                        row.ParentRow = parentRow;

                                        if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                            row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                    }
                                    else
                                    {
                                        parentRow = offer.CustomerInvoiceRow.FirstOrDefault(r => r.TempRowId == dto.ParentRowId.Value);
                                        if (parentRow != null)
                                        {
                                            row.ParentRow = parentRow;

                                            if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                                row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                        }
                                    }
                                }

                                // Household tax deduction
                                if (!string.IsNullOrEmpty(dto.HouseholdSocialSecNbr) || !string.IsNullOrEmpty(dto.HouseholdProperty) || (!string.IsNullOrEmpty(dto.HouseholdApartmentNbr) && !string.IsNullOrEmpty(dto.HouseholdCooperativeOrgNbr)))
                                {
                                    // Validate
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(offer, row, dto);
                                    if (!result.Success)
                                        return result;
                                }

                                // Add account rows connected to current product row
                                #region CustomerInvoiceAccountRow Add

                                List<object> splitRows = new List<object>();
                                if (dto.SplitAccountingRows != null)
                                {
                                    foreach (SplitAccountingRowDTO splitRow in dto.SplitAccountingRows)
                                    {
                                        splitRows.Add((object)splitRow);
                                    }
                                }

                                if (!dto.IsLiftProduct && !dto.IsClearingProduct)
                                    CreateCustomerInvoiceAccountRow(entities, offer, row, (TermGroup_InvoiceVatType)offer.VatType, ref nextRowNr, offer.ActorId.HasValue ? offer.ActorId.Value : 0, 0, offer.ProjectId.HasValue ? offer.ProjectId.Value : 0, ActorCompanyId, splitRows.Count > 0 ? splitRows : null);

                                #endregion

                                // Add product row with connected account rows to the collection of CustomerInvoiceRows
                                offer.CustomerInvoiceRow.Add(row);
                                processedInputInvoiceRows.Add(row);

                                // Add to modified to get id
                                modifiedOrderRows.Add(dto.TempRowId, row);

                                #endregion
                            }
                        }
                        if (ConvertProductRowsTextUppercase(entities, processedInputInvoiceRows, base.ActorCompanyId))
                            rowsAdded = true;

                        #endregion

                        #region Set remaining amount

                        int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, base.ActorCompanyId, 0);

                        bool hasTransferedRows = false;
                        decimal cents = 0;

                        //Hidden attest states 
                        List<int> excludedAttestStates = attestStates != null ? attestStates.Where(a => a.Hidden || a.Closed).Select(a => a.AttestStateId).ToList() : new List<int>();

                        foreach (var invoiceRow in offer.ActiveCustomerInvoiceRows)
                        {
                            if (invoiceRow.AttestStateId.HasValue && excludedAttestStates.Contains(invoiceRow.AttestStateId.Value) && (!invoiceRow.ProductId.HasValue || (invoiceRow.ProductId != fixedPriceProductId && invoiceRow.ProductId != fixedPriceKeepPricesProductId)))
                                continue;

                            if (offer.Origin.Type == (int)SoeOriginType.Offer && ((invoiceRow.Type == (int)SoeInvoiceRowType.ProductRow || invoiceRow.Type == (int)SoeInvoiceRowType.BaseProductRow) ||
                                (invoiceRow.IsFreightAmountRow || invoiceRow.IsInterestRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsReminderRow)) &&
                                invoiceRow.AttestStateId != InvoiceAttestStatesIds.TransferredOrderToInvoiceId && invoiceRow.State != (int)SoeEntityState.Deleted)
                            {
                                if (invoiceRow.AttestStateId.HasValue && excludedAttestStates.Contains(invoiceRow.AttestStateId.Value) && (!invoiceRow.ProductId.HasValue || (invoiceRow.ProductId != fixedPriceProductId && invoiceRow.ProductId != fixedPriceKeepPricesProductId)))
                                    continue;

                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product == null || (((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    if (offer.VatType == (int)TermGroup_InvoiceVatType.Merchandise && (priceListType == null || !priceListType.InclusiveVat))
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency;
                                    }
                                    else
                                    {
                                        remainingCurrencyAmount += invoiceRow.SumAmountCurrency;
                                    }

                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                    remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                }

                            }
                            else if (invoiceRow.IsCentRoundingRow)
                            {
                                if (offer.VatType == (int)TermGroup_InvoiceVatType.Merchandise && (priceListType == null || !priceListType.InclusiveVat))
                                {
                                    cents = (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                }
                                else
                                {
                                    cents = invoiceRow.SumAmountCurrency;
                                }

                            }
                            else if (invoiceRow.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                            {
                                if (!invoiceRow.ProductReference.IsLoaded)
                                    invoiceRow.ProductReference.Load();

                                if (invoiceRow.Product != null && (((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing))
                                {
                                    remainingCurrencyAmount += (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                                    remainingCurrencyAmountVat += invoiceRow.VatAmountCurrency;
                                    remainingCurrencyAmountExVat += invoiceRow.SumAmountCurrency;
                                }

                                hasTransferedRows = true;
                            }
                        }

                        int tryAmount = 0;
                        if (!Int32.TryParse(remainingCurrencyAmount.ToString(), out tryAmount))
                        {
                            if (hasTransferedRows)
                            {
                                remainingCurrencyAmount = Math.Round(remainingCurrencyAmount, 0, MidpointRounding.ToEven);
                            }
                            else
                            {
                                remainingCurrencyAmount += cents;
                            }
                        }

                        int tryAmountExVat = 0;
                        if (!Int32.TryParse(remainingCurrencyAmountExVat.ToString(), out tryAmountExVat))
                        {
                            if (hasTransferedRows)
                            {
                                remainingCurrencyAmountExVat = Math.Round(remainingCurrencyAmountExVat, 0, MidpointRounding.ToEven);
                            }
                            else
                            {
                                remainingCurrencyAmountExVat += cents;
                            }
                        }

                        int tryAmountVat = 0;
                        if (!Int32.TryParse(remainingCurrencyAmountVat.ToString(), out tryAmountVat))
                        {
                            if (hasTransferedRows)
                            {
                                remainingCurrencyAmountVat = Math.Round(remainingCurrencyAmountVat, 0, MidpointRounding.ToEven);
                            }
                            else
                            {
                                remainingCurrencyAmountVat += cents;
                            }
                        }

                        //Set remaining amount
                        offer.RemainingAmount = remainingCurrencyAmount;
                        offer.RemainingAmountVat = remainingCurrencyAmountVat;
                        offer.RemainingAmountExVat = remainingCurrencyAmountExVat;

                        if (offer.ActiveCustomerInvoiceRows.Any())
                        {
                            int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, offer.CurrencyId);
                            int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                            UpdateInvoiceAfterRowModification(entities, offer, nextRowNr, ActorCompanyId, true, sysCurrencyIdInvoice != sysCurrencyIdBase);
                        }

                        // Check for multiple asset rows
                        if (noOfAssetRows > 1)
                            offer.MultipleAssetRows = true;

                        #region Update status

                        //Synch Origin.Status with the current status of all CustomerInvoiceRow's+
                        if (transferredTo == SoeOriginType.Order)
                        {
                            UpdateInvoiceStatus(offer, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.OfferFullyOrder, SoeOriginStatus.OfferPartlyOrder);
                        }
                        else if (transferredTo == SoeOriginType.CustomerInvoice)
                        {
                            UpdateInvoiceStatus(offer, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.OfferFullyInvoice, SoeOriginStatus.OfferPartlyInvoice);
                        }
                        else if (transferredTo == SoeOriginType.None)
                        {
                            UpdateInvoiceStatus(offer, noOfTransferredRows, noOfClosedRows, noOfNotTransferredRows, SoeOriginStatus.OfferClosed, SoeOriginStatus.Origin, SoeOriginStatus.Origin);
                        }

                        #endregion

                        #endregion

                        #region Calculate currency amounts

                        //Calculate currency amounts
                        //CountryCurrencyManager.CalculateCurrencyAmounts(entities, base.ActorCompanyId, offer, true);

                        #endregion

                        #region Save

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        if (result.Success)
                        {
                            //Set id
                            invoiceId = offer.InvoiceId;

                            if (offerAttachments != null && offerAttachments.Any())
                            {
                                var newStatusIcon = SaveOrderInvoiceAttachments(entities, offer.InvoiceId, offer.StatusIcon, offerAttachments, offer.InvoiceNr);
                                if (newStatusIcon != offer.StatusIcon)
                                {
                                    offer.StatusIcon = newStatusIcon;
                                    SaveChanges(entities);
                                }
                            }

                            #region OriginUsers

                            if (originUsers != null)
                            {
                                ActionResult originUserResult = SaveOriginUsers(transaction, entities, invoiceId, originUsers, base.ActorCompanyId, base.LicenseId);
                                if (!originUserResult.Success)
                                    return originUserResult;
                            }

                            #endregion

                            #region EntityHistory

                            GeneralManager.SaveEntityHistory(entities, entityType, invoiceId, DateTime.Now, true, true, false, base.ActorCompanyId);

                            #endregion

                            //Commit transaction
                            transaction.Complete();

                            //modified order
                            modified = offer.Modified;
                            modifiedBy = offer.ModifiedBy;

                            created = offer.Created;
                            createdBy = offer.CreatedBy;

                            //Modified rows
                            modifiedRowIds.Clear();
                            foreach (int tempRowId in modifiedOrderRows.Keys)
                            {
                                modifiedRowIds.Add(tempRowId, modifiedOrderRows[tempRowId].CustomerInvoiceRowId);
                            }


                        }

                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                    seqNbr = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = invoiceId;
                        result.StringValue = invoiceNbr;
                        result.Value = seqNbr;
                        result.IntDict = modifiedRowIds;
                        result.BooleanValue = rowsAdded;

                        if (invoiceIsTemplate)
                            result.SuccessNumber = (int)ActionResultSave.CustomerInvoiceIsTemplate;
                        if (isNew)
                        {
                            result.Modified = created.Value;
                            result.ModifiedBy = createdBy;
                        }
                        else if (modified.HasValue)
                        {
                            result.Modified = modified.Value;
                            result.ModifiedBy = modifiedBy;
                        }
                        if (voucherHeadsDict != null)
                            result.IdDict = voucherHeadsDict;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult SaveContract(dynamic modifiedFields, List<ProductRowDTO> newRows, List<ExpandoObject> modifiedRows, List<OriginUserDTO> originUsers, List<FileUploadDTO> contractAttachments, bool discardConcurrencyCheck, bool regenerateAccounting)
        {
            var result = new ActionResult();

            #region Prereq

            bool rowsAdded = false;
            bool newStatus = false;
            int seqNbr = 0;
            var values = (IDictionary<string, object>)modifiedFields;
            bool invoiceIsTemplate = false;
            DateTime? modified = null;
            string modifiedBy = null;
            DateTime? created = null;
            string createdBy = null;
            string invoiceNbr = String.Empty;
            Dictionary<int, int> voucherHeadsDict = null;
            Dictionary<int, int> modifiedRowIds = new Dictionary<int, int>();
            Dictionary<int, CustomerInvoiceRow> modifiedContractRows = new Dictionary<int, CustomerInvoiceRow>();

            int invoiceId = values.ContainsKey("id") ? Convert.ToInt32(values["id"]) : 0;
            bool isNew = invoiceId == 0;

            #region Types

            SoeEntityType entityType = SoeEntityType.Contract;

            #endregion

            #region Settings

            bool? conflictSetting = values.ContainsKey("checkconflictsonsave") ? (bool?)values["checkconflictsonsave"] : null;
            if (conflictSetting != null)
                SettingManager.UpdateInsertBoolSetting(SettingMainType.User, (int)UserSettingType.BillingCheckConflictsOnSave, conflictSetting.Value, base.UserId, base.ActorCompanyId, 0);

            #endregion

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    #region Prereq

                    // Check if order was modified after current order was fetched
                    if (!discardConcurrencyCheck && values.ContainsKey("modified"))
                    {
                        DateTime? currentModified = null;
                        var field = values["modified"];
                        if (field != null)
                        {
                            currentModified = (DateTime)field; //DateTime.ParseExact((string)field, "yyyy-MM-dd HH:mm:ss", CultureInfo.InvariantCulture);
                            values.Remove("modified");
                        }

                        bool isModified = base.IsEntityModified(entities, invoiceId, entityType, currentModified, out modified, out modifiedBy);
                        if (isModified && (modified.HasValue || modifiedBy.HasValue()))
                            return new ActionResult((int)ActionResultSave.EntityIsModifiedByOtherUser, String.Format(GetText(7064, 1005, "Avtalet är uppdaterat {0} av {1}. Om du sparar kommer den användarens ändringar att skrivas över.\nVill du fortsätta?"), modified, modifiedBy));
                    }

                    #endregion

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        //Load invoice
                        bool loadProductRows = newRows.Count > 0 || modifiedRows.Count > 0;
                        CustomerInvoice contract = invoiceId != 0 ? GetCustomerInvoice(entities, invoiceId, true, true, true, false, true, false, false, loadProductRows, regenerateAccounting, false, false, false) : null;

                        //Force saving
                        bool forceSave = values.ContainsKey("forcesave") ? (bool)values["forcesave"] : false;

                        //Ok to save
                        if (!(forceSave || contract == null ? true : (contract.Origin.Status == (int)SoeOriginStatus.Draft || contract.Origin.Status == (int)SoeOriginStatus.Origin)))
                        {
                            string text = GetText(176, "Felaktig statusförändring") + ": " + GetText(contract.Origin.Status, (int)TermGroup.OriginStatus);
                            return new ActionResult((int)ActionResultSave.InvalidStateTransition, text);
                        }

                        if (invoiceId == 0)
                        {
                            #region Add

                            bool addInvoice = contract == null;
                            if (addInvoice)
                            {
                                #region Origin

                                int? voucherSeriesTypeId = null;

                                if (values.ContainsKey("voucherSeriesTypeId"))
                                    voucherSeriesTypeId = Convert.ToInt32(values["voucherSeriesTypeId"]);

                                if (voucherSeriesTypeId == 0)
                                    voucherSeriesTypeId = null;

                                // Create new Origin, fields will be set in update below
                                Origin origin = new Origin()
                                {
                                    VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]),
                                    VoucherSeriesTypeId = voucherSeriesTypeId,
                                    Type = (int)SoeOriginType.Contract,
                                    Status = Convert.ToInt32(values["originstatus"]),

                                    //Set FK
                                    ActorCompanyId = base.ActorCompanyId,
                                };

                                if (values.ContainsKey("origindescription"))
                                {
                                    origin.Description = (string)values["origindescription"];
                                    values.Remove("origindescription");
                                }

                                SetCreatedProperties(origin);
                                entities.Origin.AddObject(origin);

                                #endregion

                                #region OriginUser

                                // Add current user to origin
                                OriginUser originUser = new OriginUser()
                                {
                                    Main = true,

                                    //Set FK
                                    UserId = base.UserId,

                                    //Set references
                                    Origin = origin,
                                };
                                origin.OriginUser.Add(originUser);
                                SetCreatedProperties(originUser);

                                #endregion

                                #region CustomerInvoice

                                // Create new CustomerInvoice, fields will be set in update below
                                contract = new CustomerInvoice()
                                {
                                    // Inherited from Invoice
                                    Origin = origin,
                                    Type = (int)SoeInvoiceType.CustomerInvoice,
                                    OnlyPayment = false,
                                    PaidAmountCurrency = 0,
                                    FullyPayed = false,
                                    SysPaymentTypeId = 0,
                                    PaymentNr = String.Empty,
                                    MultipleAssetRows = false, // Will be calculated'
                                    RegistrationType = (int)OrderInvoiceRegistrationType.Contract,
                                };

                                if (!(bool)values["istemplate"])
                                {
                                    // Get next sequence number
                                    string entityName = String.Empty;
                                    int startNbr = 0;
                                    int invoiceNumberLength = 0;

                                    var billingType = 1;
                                    if (values.ContainsKey("billingtype"))
                                        billingType = Convert.ToInt32(values["billingtype"]);

                                    InvoiceManager.GetNextSequenceNumber(entities, SoeOriginType.Contract, (SoeOriginStatus)origin.Status, (TermGroup_BillingType)billingType, base.ActorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, false, false);

                                    contract.SeqNr = seqNbr;

                                    // Set invoice number to same as sequence number (padded to a specified number of digits)
                                    contract.InvoiceNr = seqNbr.ToString().PadLeft(invoiceNumberLength, '0');

                                    // Set dates
                                    if (!values.ContainsKey("invoicedate") || values["invoicedate"] == null)
                                        contract.InvoiceDate = DateTime.Today;
                                    if (!values.ContainsKey("voucherdate") || values["voucherdate"] == null)
                                        contract.VoucherDate = DateTime.Today;

                                    invoiceNbr = contract.InvoiceNr;
                                }
                                else
                                { contract.InvoiceNr = invoiceNbr = string.Empty; }

                                entities.Invoice.AddObject(contract);
                                SetCreatedProperties(contract);

                                newStatus = true;

                                #endregion

                            }

                            #endregion
                        }
                        else
                        {
                            #region Update

                            // Update Origin
                            if (values.ContainsKey("voucherseriesid"))
                            {
                                contract.Origin.VoucherSeriesId = Convert.ToInt32(values["voucherseriesid"]);
                                values.Remove("voucherseriesid");
                            }
                            if (values.ContainsKey("origindescription"))
                            {
                                contract.Origin.Description = (string)values["origindescription"];
                                values.Remove("origindescription");
                            }
                            if (contract.Origin.Status == (int)SoeOriginStatus.Draft || contract.Origin.Status == (int)SoeOriginStatus.Origin && values.ContainsKey("originstatus"))
                            {
                                int origStatus = Convert.ToInt32(values["originstatus"]);
                                if (contract.Origin.Status != origStatus)
                                {
                                    newStatus = true;
                                    contract.Origin.Status = origStatus;
                                }
                                values.Remove("originstatus");
                            }

                            SetModifiedProperties(contract.Origin);

                            #endregion
                        }

                        bool defaultInternalAccountChanged = false;

                        string[] excludes = { "categoryids", "seqnr", "invoicenr", "created", "modified", "createdby", "modifiedby" };

                        var props = contract.GetType().GetProperties();
                        foreach (var prop in props)
                        {
                            string lcName = prop.Name.ToLower();

                            if (values.ContainsKey(lcName) && !excludes.Contains(lcName))
                            {
                                var value = values[lcName];

                                if (internalAccountFields.Contains(lcName))
                                {
                                    defaultInternalAccountChanged = true;
                                }

                                if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                                    prop.SetValue(contract, Convert.ToDecimal(value));
                                else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                                {
                                    if (invoiceTreat0asNullHead.Contains(lcName) && value != null && Convert.ToInt32(value) == 0)
                                    {
                                        value = null;
                                    }
                                    prop.SetValue(contract, value == null ? (int?)null : Convert.ToInt32(value));
                                }
                                else if ((prop.PropertyType == typeof(DateTime) || prop.PropertyType == typeof(DateTime?)) && value != null)
                                {
                                    DateTime dt = (DateTime)value;
                                    if (dt.Year < 1900)
                                        prop.SetValue(contract, new DateTime(1900, dt.Month, dt.Day));
                                    else
                                        prop.SetValue(contract, value);
                                }
                                else
                                    prop.SetValue(contract, value);
                            }
                        }

                        invoiceIsTemplate = contract.IsTemplate;

                        if (contract.InvoicePaymentService == 0)
                            contract.InvoicePaymentService = null;

                        //fix up if not set  correctly
                        if (contract.CurrencyRate == 0)
                            contract.CurrencyRate = 1;

                        PriceListType priceListType = ProductPricelistManager.GetPriceListType(entities, contract.PriceListTypeId != null ? (int)contract.PriceListTypeId : 0, base.ActorCompanyId);
                        contract.PriceListTypeInclusiveVat = priceListType == null ? false : priceListType.InclusiveVat;

                        #region Previous invoice

                        if (invoiceId != 0)
                        {
                            SetModifiedProperties(contract);

                            if (values.ContainsKey("previnvoiceid"))
                            {
                                // Add mapping from originating invoice (used when credit)
                                OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                                {
                                    Origin = contract.Origin,
                                    Type = (int)GetOriginInvoiceMappingType(contract),
                                    InvoiceId = Convert.ToInt32(values["previnvoiceid"])
                                };
                                entities.OriginInvoiceMapping.AddObject(oimap);
                            }
                        }

                        #endregion

                        #region Rows

                        //Counter used do decide if invoice has multiple asset rows
                        int noOfAssetRows = 0;

                        List<CustomerInvoiceRow> processedInputInvoiceRows = new List<CustomerInvoiceRow>();

                        // Update or Delete existing CustomerInvoiceRows
                        int nextRowNr = 2;  // Claim row will get number 1
                        foreach (var invoiceRow in contract.ActiveCustomerInvoiceRows)
                        {
                            #region CustomerInvoiceRow Update/Delete

                            var updateAccountingRows = false;

                            // Try get CustomerInvoiceRow from input
                            var invoiceRowInput = (from r in modifiedRows
                                                   where (Int64)((IDictionary<string, object>)r)["customerinvoicerowid"] == invoiceRow.CustomerInvoiceRowId
                                                   select r).FirstOrDefault() as IDictionary<string, object>;
                            if (invoiceRowInput == null)
                            {
                                updateAccountingRows = defaultInternalAccountChanged;
                            }
                            else
                            {
                                invoiceRow.LoadHouseholdTaxDeductionRowReference();

                                // Household tax deduction
                                if (invoiceRow.HouseholdTaxDeductionRow == null && (
                                        (invoiceRowInput.ContainsKey("householdproperty") && invoiceRowInput["householdproperty"] != null) ||
                                        (invoiceRowInput.ContainsKey("householdcooperativeorgnbr") && invoiceRowInput["householdcooperativeorgnbr"] != null) ||
                                        (invoiceRowInput.ContainsKey("householdtypeisrut") && invoiceRowInput["householdtypeisrut"] != null && (bool)invoiceRowInput["householdtypeisrut"])
                                     )
                                   )
                                {
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(contract, invoiceRow, invoiceRowInput);
                                    if (!result.Success)
                                        return result;
                                }
                                else if (invoiceRow.HouseholdTaxDeductionRow != null)
                                {
                                    HouseholdTaxDeductionManager.UpdateHouseholdTaxDeductionRow(invoiceRow, invoiceRowInput);
                                }

                                if (Convert.ToInt32(invoiceRowInput["state"]) == (int)SoeEntityState.Deleted)
                                {
                                    #region CustomerInvoiceRow Delete
                                    // Delete existing CustomerInvoiceRow
                                    ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                                    // Delete existing CustomerInvoiceAccountRows
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    // Delete existing household tax deduction row
                                    if (invoiceRow.HouseholdTaxDeductionRow != null)
                                        ChangeEntityState(invoiceRow.HouseholdTaxDeductionRow, SoeEntityState.Deleted);

                                    #endregion
                                }
                                else
                                {
                                    #region CustomerInvoiceRow Update

                                    #region Update properties and references

                                    var rowProps = invoiceRow.GetType().GetProperties();
                                    foreach (var prop in rowProps)
                                    {
                                        string lcName = prop.Name.ToLower();
                                        if (invoiceRowInput.ContainsKey(lcName))
                                        {
                                            if (prop.PropertyType == typeof(Decimal) || prop.PropertyType == typeof(Decimal?))
                                                prop.SetValue(invoiceRow, Convert.ToDecimal(invoiceRowInput[lcName]));
                                            else if (prop.PropertyType == typeof(Int32) || prop.PropertyType == typeof(Int32?))
                                            {
                                                if (invoiceTreat0asNullRow.Contains(lcName) && (invoiceRowInput[lcName] == null || Convert.ToInt32(invoiceRowInput[lcName]) == 0))
                                                {
                                                    invoiceRowInput[lcName] = null;
                                                    prop.SetValue(invoiceRow, invoiceRowInput[lcName]);
                                                }
                                                else
                                                    prop.SetValue(invoiceRow, Convert.ToInt32(invoiceRowInput[lcName]));
                                            }
                                            else
                                                prop.SetValue(invoiceRow, invoiceRowInput[lcName]);
                                        }
                                    }

                                    SetModifiedProperties(invoiceRow);

                                    #endregion

                                    updateAccountingRows = true;

                                    #endregion
                                }
                            }

                            if (updateAccountingRows && invoiceRow.State == (int)SoeEntityState.Active && (invoiceRow.Type != (int)SoeInvoiceRowType.AccountingRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsFreightAmountRow))
                            {
                                if (invoiceRowInput != null && (!invoiceRowInput.Keys.Contains("splitaccountingrows") || invoiceRowInput["splitaccountingrows"] == null || ((List<object>)invoiceRowInput["splitaccountingrows"]).Count == 0) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any(r => r.SplitPercent > 0 && r.SplitType > 0))
                                {
                                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows.Where(r => r.VatRow))
                                    {
                                        ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }

                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                    {
                                        CreateCustomerInvoiceAccountRow(entities, contract, invoiceRow, (TermGroup_InvoiceVatType)contract.VatType, ref nextRowNr, contract.ActorId.HasValue ? contract.ActorId.Value : 0, 0, 0, base.ActorCompanyId, null, true);
                                    }
                                }
                                else
                                {
                                    if (!invoiceRow.ProductReference.IsLoaded)
                                        invoiceRow.ProductReference.Load();

                                    if (invoiceRow.Type != (int)SoeInvoiceRowType.PageBreakRow && invoiceRow.Type != (int)SoeInvoiceRowType.SubTotalRow && invoiceRow.Type != (int)SoeInvoiceRowType.TextRow && invoiceRow.Product != null && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)invoiceRow.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                    {
                                        var splitAccountingRows = (invoiceRowInput != null && invoiceRowInput.Keys.Contains("splitaccountingrows") && invoiceRowInput["splitaccountingrows"] != null ? (List<object>)invoiceRowInput["splitaccountingrows"] : null);

                                        if ((splitAccountingRows == null || !splitAccountingRows.Any()) && invoiceRow.ActiveCustomerInvoiceAccountRows.Any())
                                        {
                                            var first = invoiceRow.ActiveCustomerInvoiceAccountRows.FirstOrDefault(r => !r.VatRow);
                                            if (first != null && !first.AccountInternal.IsLoaded)
                                            {
                                                first.AccountInternal.Load();
                                            }
                                        }

                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }

                                        CreateCustomerInvoiceAccountRow(entities, contract, invoiceRow, (TermGroup_InvoiceVatType)contract.VatType, ref nextRowNr, contract.ActorId.HasValue ? contract.ActorId.Value : 0, 0, 0, base.ActorCompanyId, splitAccountingRows);
                                    }
                                    processedInputInvoiceRows.Add(invoiceRow);
                                }
                            }

                            #endregion
                        }

                        if (newRows.Count > 0)
                        {
                            //Offer rows
                            newRows = newRows.OrderBy(r => r.TempRowId).ToList();

                            foreach (ProductRowDTO dto in newRows)
                            {
                                #region Prereq

                                // Do not include new inactive rows
                                if (dto.CustomerInvoiceRowId == 0 && dto.State != (int)SoeEntityState.Active)
                                    continue;

                                #endregion

                                #region CustomerInvoiceRow

                                // Create one CustomerInvoiceRow for each product row
                                var row = new CustomerInvoiceRow
                                {
                                    //CustomerInvoiceRowId = dto.CustomerInvoiceRowId,
                                    TempRowId = dto.TempRowId,
                                    AttestStateId = dto.AttestStateId,
                                    RowNr = dto.RowNr,
                                    Type = (int)dto.Type,
                                    VatRate = dto.VatRate,
                                    VatAmount = dto.VatAmount,
                                    VatAmountCurrency = dto.VatAmountCurrency,
                                    Quantity = dto.Quantity,
                                    InvoiceQuantity = dto.InvoiceQuantity,
                                    PreviouslyInvoicedQuantity = dto.PreviouslyInvoicedQuantity,
                                    Amount = dto.Amount,
                                    AmountCurrency = dto.AmountCurrency,
                                    DiscountType = dto.DiscountType,
                                    DiscountPercent = dto.DiscountPercent,
                                    DiscountAmount = dto.DiscountAmount,
                                    DiscountAmountCurrency = dto.DiscountAmountCurrency,
                                    Discount2Type = dto.Discount2Type,
                                    Discount2Percent = dto.Discount2Percent,
                                    Discount2Amount = dto.Discount2Amount,
                                    Discount2AmountCurrency = dto.Discount2AmountCurrency,
                                    SumAmount = dto.SumAmount,
                                    SumAmountCurrency = dto.SumAmountCurrency,
                                    Text = dto.Text,
                                    IsFreightAmountRow = dto.IsFreightAmountRow,
                                    IsInvoiceFeeRow = dto.IsInvoiceFeeRow,
                                    IsCentRoundingRow = dto.IsCentRoundingRow,
                                    IsInterestRow = dto.IsInterestRow,
                                    IsReminderRow = dto.IsReminderRow,
                                    PurchasePrice = dto.PurchasePrice,
                                    PurchasePriceCurrency = dto.PurchasePriceCurrency,
                                    SysWholesellerName = dto.SysWholesellerName,
                                    MarginalIncome = dto.MarginalIncome,
                                    MarginalIncomeCurrency = dto.MarginalIncomeCurrency,
                                    MarginalIncomeRatio = dto.MarginalIncomeRatio,
                                    State = (int)dto.State,
                                    IsTimeProjectRow = dto.IsTimeProjectRow,
                                    IsStockRow = dto.IsStockRow,
                                    //Set FK
                                    ProductId = dto.ProductId.ToNullable(),
                                    ProductUnitId = dto.ProductUnitId.ToNullable(),
                                    VatAccountId = dto.VatAccountId.ToNullable(),
                                    Date = dto.Date,
                                    TimeManuallyChanged = dto.TimeManuallyChanged,
                                    StockId = dto.StockId.ToNullable(),
                                    HouseholdDeductionType = dto.HouseholdDeductionType,
                                    DateTo = dto.DateTo,
                                    DeliveryDateText = dto.DeliveryDateText,
                                };
                                SetCreatedProperties(row);

                                // Set parent row
                                if (dto.ParentRowId.HasValue)
                                {
                                    var parentRow = contract.CustomerInvoiceRow.FirstOrDefault(r => r.CustomerInvoiceRowId == dto.ParentRowId.Value);
                                    if (parentRow != null)
                                    {
                                        row.ParentRow = parentRow;

                                        if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                            row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                    }
                                    else
                                    {
                                        parentRow = contract.CustomerInvoiceRow.FirstOrDefault(r => r.TempRowId == dto.ParentRowId.Value);
                                        if (parentRow != null)
                                        {
                                            row.ParentRow = parentRow;

                                            if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                                                row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                                        }
                                    }
                                }

                                // Household tax deduction
                                if (!string.IsNullOrEmpty(dto.HouseholdProperty) || (!string.IsNullOrEmpty(dto.HouseholdApartmentNbr) && !string.IsNullOrEmpty(dto.HouseholdCooperativeOrgNbr)))
                                {
                                    // Validate
                                    result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(contract, row, dto);
                                    if (!result.Success)
                                        return result;
                                }

                                // Add account rows connected to current product row
                                #region CustomerInvoiceAccountRow Add

                                List<object> splitRows = new List<object>();
                                if (dto.SplitAccountingRows != null)
                                {
                                    foreach (SplitAccountingRowDTO splitRow in dto.SplitAccountingRows)
                                    {
                                        splitRows.Add((object)splitRow);
                                    }
                                }

                                if (!dto.IsLiftProduct && !dto.IsClearingProduct)
                                    CreateCustomerInvoiceAccountRow(entities, contract, row, (TermGroup_InvoiceVatType)contract.VatType, ref nextRowNr, contract.ActorId.HasValue ? contract.ActorId.Value : 0, 0, 0, ActorCompanyId, splitRows.Count > 0 ? splitRows : null);

                                #endregion

                                // Add product row with connected account rows to the collection of CustomerInvoiceRows
                                contract.CustomerInvoiceRow.Add(row);
                                processedInputInvoiceRows.Add(row);

                                // Add to modified to get id
                                modifiedContractRows.Add(dto.TempRowId, row);

                                #endregion
                            }
                        }
                        if (ConvertProductRowsTextUppercase(entities, processedInputInvoiceRows, base.ActorCompanyId))
                            rowsAdded = true;

                        #endregion

                        #region Set remaining amount

                        if (contract.ActiveCustomerInvoiceRows.Any())
                        {
                            int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, contract.CurrencyId);
                            int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                            UpdateInvoiceAfterRowModification(entities, contract, nextRowNr, ActorCompanyId, true, sysCurrencyIdInvoice != sysCurrencyIdBase);
                        }

                        // Check for multiple asset rows
                        if (noOfAssetRows > 1)
                            contract.MultipleAssetRows = true;

                        #endregion

                        #region Calculate currency amounts

                        //Calculate currency amounts
                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, base.ActorCompanyId, contract, true);

                        #endregion

                        #region Save

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        if (result.Success)
                        {
                            //Set id
                            invoiceId = contract.InvoiceId;

                            if (contractAttachments != null && contractAttachments.Any())
                            {
                                var newStatusIcon = SaveOrderInvoiceAttachments(entities, contract.InvoiceId, contract.StatusIcon, contractAttachments, contract.InvoiceNr);
                                if (newStatusIcon != contract.StatusIcon)
                                {
                                    contract.StatusIcon = newStatusIcon;
                                    SaveChanges(entities);
                                }
                            }

                            #region OriginUsers

                            if (originUsers != null)
                            {
                                ActionResult originUserResult = SaveOriginUsers(transaction, entities, invoiceId, originUsers, base.ActorCompanyId, base.LicenseId);
                                if (!originUserResult.Success)
                                    return originUserResult;
                            }

                            #endregion

                            #region Categories

                            if (values.ContainsKey("categoryids") && values["categoryids"] != null)
                            {
                                List<int> categoryIds = new List<int>();
                                foreach (var val in (List<object>)values["categoryids"])
                                {
                                    categoryIds.Add(Convert.ToInt32(val));
                                }

                                CategoryManager.SaveCompanyCategoryRecords(entities, transaction, categoryIds, base.ActorCompanyId, SoeCategoryType.Contract, SoeCategoryRecordEntity.Contract, invoiceId);
                            }

                            #endregion

                            #region EntityHistory

                            GeneralManager.SaveEntityHistory(entities, entityType, invoiceId, DateTime.Now, true, true, false, base.ActorCompanyId);

                            #endregion

                            //Commit transaction
                            transaction.Complete();

                            //modified order
                            modified = contract.Modified;
                            modifiedBy = contract.ModifiedBy;

                            created = contract.Created;
                            createdBy = contract.CreatedBy;

                            //Modified rows
                            modifiedRowIds.Clear();
                            foreach (int tempRowId in modifiedContractRows.Keys)
                            {
                                modifiedRowIds.Add(tempRowId, modifiedContractRows[tempRowId].CustomerInvoiceRowId);
                            }


                        }

                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                    seqNbr = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = invoiceId;
                        result.StringValue = invoiceNbr;
                        result.Value = seqNbr;
                        result.IntDict = modifiedRowIds;
                        result.BooleanValue = rowsAdded;
                        result.BooleanValue2 = newStatus;

                        if (invoiceIsTemplate)
                            result.SuccessNumber = (int)ActionResultSave.CustomerInvoiceIsTemplate;
                        if (isNew)
                        {
                            result.Modified = created.Value;
                            result.ModifiedBy = createdBy;
                        }
                        else if (modified.HasValue)
                        {
                            result.Modified = modified.Value;
                            result.ModifiedBy = modifiedBy;
                        }
                        if (voucherHeadsDict != null)
                            result.IdDict = voucherHeadsDict;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        private ActionResult HandleProjectOnSaveInvoice(CompEntities entities, CustomerInvoice customerinvoice, int actorCompanyId, IDictionary<string, object> values, int standardMaterialCodeId, ref TimeProjectDTO returnProject)
        {
            TimeProject project = null;

            if ((customerinvoice.ProjectId == null || customerinvoice.ProjectId == 0) && customerinvoice.RegistrationType == (int)OrderInvoiceRegistrationType.Order && !customerinvoice.IsTemplate)
            {
                bool autoGenerateProject = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProjectAutoGenerateOnNewInvoice, 0, base.ActorCompanyId, 0);
                bool useCustomerNameAsProjectName = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProjectUseCustomerNameAsProjectName, 0, base.ActorCompanyId, 0, true);
                if (autoGenerateProject)
                {
                    string projectNr = customerinvoice.InvoiceNr;

                    if (values.ContainsKey("projectnr"))
                    {
                        var projectNrFromValues = (string)values["projectnr"];
                        if (!string.IsNullOrEmpty(projectNrFromValues) && projectNrFromValues == "USEORDERNBR")
                        {
                            var numbers = ProjectManager.GetAllProjectNumbers(entities, base.ActorCompanyId);
                            projectNr = ProjectManager.GetProjectNumberCheckExisting(numbers, customerinvoice.InvoiceNr, base.ActorCompanyId);
                        }
                        else if (!string.IsNullOrEmpty(projectNrFromValues))
                        {
                            projectNr = projectNrFromValues;
                        }

                    }

                    string customerName = (from c in entities.Customer
                                           where c.ActorCustomerId == customerinvoice.ActorId
                                           select c.Name).FirstOrDefault();

                    project = new TimeProject()
                    {
                        Number = projectNr,
                        Name = !useCustomerNameAsProjectName || String.IsNullOrEmpty(customerName) ? DateTime.Now.ToString("yyyyMMddhhmm") : customerName.Replace("\n", " ").Replace("\r", ""),
                        Type = (int)TermGroup_ProjectType.TimeProject,
                        InvoiceProductAccountingPrio = "0,0,0,0,0",
                        PayrollProductAccountingPrio = "0,0,0,0,0",
                        Description = String.Empty,
                        Status = (int)TermGroup_ProjectStatus.Hidden, //Auto created projects gets status Hidden
                        UseAccounting = false,
                        AllocationType = (int)TermGroup_ProjectAllocationType.External,
                        //Set FK
                        ActorCompanyId = base.ActorCompanyId,
                        CustomerId = customerinvoice.ActorId,
                    };

                    SetCreatedProperties(project);

                    customerinvoice.Project = project;

                    bool includeTimeReport = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProjectIncludeTimeProjectReport, 0, base.ActorCompanyId, 0);
                    if (includeTimeReport)
                        customerinvoice.PrintTimeReport = true;
                }
            }
            else if (customerinvoice.InvoiceId > 0 && customerinvoice.ProjectId.HasValue && customerinvoice.ProjectId.Value > 0 && values.ContainsKey("actorid") && customerinvoice.ActorId.HasValue && customerinvoice.RegistrationType == (int)OrderInvoiceRegistrationType.Order && !customerinvoice.IsTemplate)
            {
                project = ProjectManager.GetTimeProject(entities, customerinvoice.ProjectId.Value, false);
                if (project.Status == (int)TermGroup_ProjectStatus.Hidden && project.CustomerId != customerinvoice.ActorId)
                {
                    ProjectManager.UpdateProjectCustomer(entities, actorCompanyId, project.ProjectId, customerinvoice.InvoiceId, customerinvoice.ActorId.Value, false);
                }
            }
            else if (values.ContainsKey("projectid"))
            {
                int projId = Convert.ToInt32(values["projectid"]);
                if (projId > 0)
                {
                    //Fetch project
                    project = ProjectManager.GetTimeProject(entities, projId, false);

                    //Bind to invoice
                    customerinvoice.Project = project;
                }
            }

            if (customerinvoice.Project != null && standardMaterialCodeId <= 0)
            {
                return new ActionResult((int)ActionResultSave.TimeCodeMaterialStandardMissing, GetText(8423, "Inställning för standard materialkod saknas"));
            }
            else
            {
                var result = SaveChanges(entities);
                if (result.Success && project != null)
                    returnProject = project.ToTimeProjectDTO(false, false);
                return result;
            }
        }
        public ActionResult SaveMobileOrder(int userId, int actorCompanyId, int roleId, int orderId, int customerId, string descriptionText, string label, string headText, string ourReference, TermGroup_InvoiceVatType vatType, int priceListId, int currencyId, int deliveryAddressId, int billingAddressId, int wholseSellerId, string yourReference, int projectId, DateTime? deliveryDate, int orderTypeId, string workDescription, bool discardConcurrencyCheck, int templateId)
        {
            var result = new ActionResult();

            try
            {
                CustomerInvoice invoice = null;
                if (orderId > 0)
                {
                    invoice = GetCustomerInvoice(orderId, true, true, true, true, true, false, false, false, false, false, false, true);
                    if (invoice == null)
                    {
                        return new ActionResult(GetText(5610, "Ordern kunde inte sparas"));
                    }
                }

                //For now, dont allow change of pricelist íf order already has orderrows
                if (invoice != null && priceListId > 0 && invoice.PriceListTypeId.HasValue && invoice.PriceListTypeId.Value != priceListId)
                {
                    bool rowsExist = GetNrOfCustomerInvoiceRowsByInvoice(orderId) > 0;
                    if (rowsExist)
                    {
                        var msg = GetText(8342, "Ej tillåtet att ändra prislista från mobilen på en order med orderrader.") + "\n";
                        msg += GetText(8343, "Ändring av prislista kan endast ske från webbklienten.");
                        return new ActionResult((int)ActionResultSave.MobileOrderIllegalSave, msg);
                    }
                }

                if (invoice != null && invoice.ActorId.GetValueOrDefault() > 0 && invoice.ActorId.Value != customerId)
                {
                    if (!FeatureManager.HasRolePermission(Feature.Billing_Order_Orders_Edit_Customer, Permission.Modify, roleId, actorCompanyId) || invoice.Status == (int)SoeOriginStatus.OrderFullyInvoice || invoice.Status == (int)SoeOriginStatus.OrderPartlyInvoice || invoice.Status == (int)SoeOriginStatus.OrderClosed)
                    {
                        return new ActionResult((int)ActionResultSave.MobileOrderIllegalSave, GetText(10268, "Ej tillåtet att ändra kund på ordern"));
                    }
                }

                if (invoice != null && invoice.OrderType != (int)TermGroup_OrderType.Sales && orderTypeId == (int)TermGroup_OrderType.Sales)
                {
                    if (ChecklistManager.GetChecklistHeadRecords(SoeEntityType.Order, invoice.InvoiceId, base.ActorCompanyId, true).Any())
                    {
                        return new ActionResult(GetText(7604, "Ordertyp kan inte ändras eftersom checklista finns"));
                    }
                }

                Customer customer = CustomerManager.GetCustomer(customerId);
                if (customer != null && customer.BlockOrder)
                {
                    var msg = GetText(8938, "Kunden är spärrad") + "\n";
                    msg += GetText(1436, "Kommentar") + ": " + customer.BlockNote;
                    return new ActionResult((int)ActionResultSave.MobileOrderCustomerBlocked, msg);
                }

                if (customer != null && orderId == 0 && String.IsNullOrEmpty(label))
                {
                    label = customer.InvoiceLabel;
                }

                CustomerInvoiceSaveDTO invoiceDto = CreateMobileCustomerInvoiceSaveDTO(invoice, customer, descriptionText, label, headText, ourReference, vatType, priceListId, currencyId, deliveryAddressId, billingAddressId, wholseSellerId, yourReference, projectId, deliveryDate, orderTypeId, workDescription, userId, roleId, actorCompanyId);
                if (invoiceDto == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                // Change customer on project
                if (projectId > 0 && invoice != null && invoice.ActorId != customerId && invoice.Project != null && invoice.Project.ProjectId == projectId && invoice.Project.CustomerId.HasValue && invoice.Project.CustomerId != customerId)
                {
                    result = ProjectManager.UpdateProjectCustomer(actorCompanyId, projectId, invoice.InvoiceId, customerId);
                    if (!result.Success)
                    {
                        if (result.ErrorNumber == (int)ActionResultSave.OneToOneRelationshipRequiredToUpdateProjectCustomer)
                            return new ActionResult((int)ActionResultSave.MobileOrderIllegalSave, GetText(9602, "Byte av kund misslyckades. Projektet är kopplat mot flera fakturor eller ordrar, det går då inte att byta kund"));
                        else
                            return new ActionResult(GetText(5610, "Ordern kunde inte sparas"));
                    }
                }

                result = SaveCustomerInvoice(invoiceDto, new List<CustomerInvoiceRowDTO>(), new List<AccountingRowDTO>(), actorCompanyId, new ImportCustomerInvoiceCache(AccountManager, ProductManager), false, discardConcurrencyCheck, true);
                if (!result.Success)
                    return result;
                if (result.Value == null)
                    return new ActionResult(GetText(5610, "Ordern kunde inte sparas"));

                #region Add Default checklists only if new invoice

                if (result.Success && orderId == 0 && orderTypeId != (int)TermGroup_OrderType.Sales && result.IntegerValue != 0)
                {
                    var ids = new List<int>();

                    if (templateId != 0)
                    {
                        var templateChecklistIds = ChecklistManager.GetChecklistHeadIdsFromRecord(SoeEntityType.Order, templateId, actorCompanyId);
                        if (templateChecklistIds.Any())
                        {
                            ids.AddRange(templateChecklistIds);
                        }
                    }

                    if (!ids.Any())
                    {
                        ids.AddRange(ChecklistManager.GetChecklistHeadIds(actorCompanyId, false, true));
                    }

                    if (ids.Any())
                    {
                        ChecklistManager.AddChecklistHeadRecords(SoeEntityType.Order, result.IntegerValue, actorCompanyId, ids, true);
                    }
                }
                #endregion
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
                result.IntegerValue = 0;
            }
            finally
            {
                if (result.Success)
                {
                    //Set success properties
                }
                else
                    base.LogTransactionFailed(this.ToString(), this.log);
            }

            return result;
        }

        public ActionResult MergeMobileOrderWithTemplate(int actorCompanyId, int orderId, CustomerInvoice templateInvoice)
        {

            ActionResult result = new ActionResult();

            if (templateInvoice == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "TemplateInvoice");

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {

                        // Load order
                        CustomerInvoice order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: true);
                        if (order == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                        // Load Attest
                        AttestStateDTO initialAttestState = AttestManager.GetInitialAttestState(entities, actorCompanyId, TermGroup_AttestEntity.Order).ToDTO();
                        if (initialAttestState == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "AttestState");

                        // Merge
                        #region Id
                        order.ActorId = templateInvoice.ActorId.HasValue ? templateInvoice.ActorId.Value : order.ActorId.Value;
                        order.BillingAddressId = templateInvoice.BillingAddressId != 0 ? templateInvoice.BillingAddressId : order.BillingAddressId;
                        order.CurrencyId = templateInvoice.CurrencyId != 0 ? templateInvoice.CurrencyId : order.CurrencyId;
                        order.ContactEComId = templateInvoice.ContactEComId.HasValue ? templateInvoice.ContactEComId : order.ContactEComId;
                        order.ContractGroupId = templateInvoice.ContractGroupId.HasValue ? templateInvoice.ContractGroupId : order.ContractGroupId;
                        order.DeliveryTypeId = templateInvoice.DeliveryTypeId;
                        order.DeliveryConditionId = templateInvoice.DeliveryConditionId;
                        order.DeliveryAddressId = templateInvoice.DeliveryAddressId != 0 ? templateInvoice.DeliveryAddressId : order.DeliveryAddressId;
                        order.PriceListTypeId = templateInvoice.PriceListTypeId.HasValue ? templateInvoice.PriceListTypeId : order.PriceListTypeId;
                        order.PaymentConditionId = templateInvoice.PaymentConditionId;
                        order.SysWholeSellerId = templateInvoice.SysWholeSellerId.HasValue ? templateInvoice.SysWholeSellerId : order.SysWholeSellerId;
                        order.ShiftTypeId = templateInvoice.ShiftTypeId.HasValue ? templateInvoice.ShiftTypeId : order.ShiftTypeId;
                        order.PaymentConditionId = templateInvoice.PaymentConditionId.HasValue ? templateInvoice.PaymentConditionId : order.PaymentConditionId;
                        order.VatCodeId = templateInvoice.VatCodeId.HasValue ? templateInvoice.VatCodeId : order.VatCodeId;
                        order.Origin.ActorCompanyId = templateInvoice.Origin.ActorCompanyId;
                        #endregion

                        #region Text
                        order.InvoiceText = String.IsNullOrEmpty(order.InvoiceText) ? templateInvoice.InvoiceText : order.InvoiceText;
                        order.InvoiceHeadText = String.IsNullOrEmpty(order.InvoiceHeadText) ? templateInvoice.InvoiceHeadText : order.InvoiceHeadText;
                        order.WorkingDescription = String.IsNullOrEmpty(order.WorkingDescription) ? templateInvoice.WorkingDescription : order.WorkingDescription;
                        order.ReferenceYour = String.IsNullOrEmpty(order.ReferenceYour) ? templateInvoice.ReferenceYour : order.ReferenceYour;
                        order.ReferenceOur = String.IsNullOrEmpty(templateInvoice.ReferenceOur) ? order.ReferenceOur : templateInvoice.ReferenceOur;
                        order.CustomerBlockNote = String.IsNullOrEmpty(order.CustomerBlockNote) ? templateInvoice.CustomerBlockNote : order.CustomerBlockNote;
                        order.InvoiceLabel = String.IsNullOrEmpty(order.InvoiceLabel) ? templateInvoice.InvoiceLabel : order.InvoiceLabel;
                        order.Origin.Description = String.IsNullOrEmpty(order.Origin.Description) ? templateInvoice.Origin.Description : order.Origin.Description;
                        #endregion

                        #region InvoiceFields

                        // Invoice  Header
                        order.BillingType = templateInvoice.BillingType != 0 ? templateInvoice.BillingType : order.BillingType;
                        order.InvoiceDate = templateInvoice.InvoiceDate.HasValue ? templateInvoice.InvoiceDate : order.InvoiceDate;
                        order.VatType = templateInvoice.VatType != 0 ? templateInvoice.VatType : order.VatType;

                        // InvoiceBody
                        order.SeqNr = templateInvoice.SeqNr.HasValue ? templateInvoice.SeqNr : order.SeqNr;
                        order.InvoiceNr = templateInvoice.InvoiceNr != string.Empty ? templateInvoice.SeqNr.ToString() : order.SeqNr.ToString();
                        order.CurrencyRate = templateInvoice.CurrencyRate != 0 ? templateInvoice.CurrencyRate : order.CurrencyRate;
                        order.CurrencyDate = templateInvoice.CurrencyDate != null ? templateInvoice.CurrencyDate : order.CurrencyDate;
                        order.DueDate = templateInvoice.DueDate != null ? templateInvoice.DueDate : order.DueDate;
                        order.VoucherDate = templateInvoice.VoucherDate != null ? templateInvoice.VoucherDate : order.VoucherDate;

                        #endregion

                        #region Liber
                        order.InternalDescription = string.IsNullOrEmpty(order.InternalDescription) ? templateInvoice.InternalDescription : order.InternalDescription;
                        order.ExternalDescription = string.IsNullOrEmpty(order.ExternalDescription) ? templateInvoice.ExternalDescription : order.ExternalDescription;
                        #endregion

                        order.DefaultDim1AccountId = templateInvoice.DefaultDim1AccountId;
                        order.DefaultDim2AccountId = templateInvoice.DefaultDim2AccountId;
                        order.DefaultDim3AccountId = templateInvoice.DefaultDim3AccountId;
                        order.DefaultDim4AccountId = templateInvoice.DefaultDim4AccountId;
                        order.DefaultDim5AccountId = templateInvoice.DefaultDim5AccountId;
                        order.DefaultDim6AccountId = templateInvoice.DefaultDim6AccountId;

                        #region CustomerInvoiceRows

                        foreach (var item in templateInvoice.ActiveCustomerInvoiceRows)
                        {
                            if ((item.ProductId > 0 && (item.Type == (int)SoeInvoiceRowType.BaseProductRow || item.Type == (int)SoeInvoiceRowType.ProductRow)) || item.Type == (int)SoeInvoiceRowType.TextRow)
                            {
                                SoeInvoiceRowType rowtype;
                                if (item.ProductId > 0 && item.Type == (int)SoeInvoiceRowType.ProductRow)
                                    rowtype = SoeInvoiceRowType.ProductRow;
                                else if (item.ProductId > 0 && item.Type == (int)SoeInvoiceRowType.BaseProductRow)
                                    rowtype = SoeInvoiceRowType.BaseProductRow;
                                else
                                    rowtype = SoeInvoiceRowType.TextRow;

                                SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, item.ProductId.HasValue ? item.ProductId.Value : 0, item.Quantity.HasValue ? item.Quantity.Value : 0, item.AmountCurrency, item.Text, rowtype, quantityToInvoice: item.InvoiceQuantity.HasValue ? item.InvoiceQuantity : 0);
                            }

                        }

                        #endregion

                        result = SaveChanges(entities);
                        if (result.Success)
                            transaction.Complete();
                    }
                }

                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);
                }
            }


            return result;
        }

        private CustomerInvoiceSaveDTO CreateMobileCustomerInvoiceSaveDTO(CustomerInvoice invoice, Customer customer, string descriptionText, string label, string headText, string referenceOur, TermGroup_InvoiceVatType vatType, int priceListId, int currencyId, int deliveryAddressId, int billingAddressId, int wholeSellerId, string referenceYour, int projectId, DateTime? deliveryDate, int orderTypeId, string workDescription, int userId, int roleId, int actorCompanyId)
        {
            #region Prereq

            if (customer == null)
                return null;

            //Settings
            int defaultPriceListTypeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, 0, actorCompanyId, 0);
            int defaultPaymentConditionId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerPaymentDefaultPaymentCondition, 0, actorCompanyId, 0);
            int defaultDeliveryTypeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultDeliveryType, 0, actorCompanyId, 0);
            int defaultDeliveryConditionId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultDeliveryCondition, 0, actorCompanyId, 0);
            int defaultWholeSellerId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultWholeseller, 0, actorCompanyId, 0);
            int defaultOrderType = SettingManager.GetIntSetting(SettingMainType.User, (int)UserSettingType.BillingDefaultOrderType, userId, actorCompanyId, 0);

            CompCurrency currency = (currencyId == 0) ? CountryCurrencyManager.GetCompanyBaseCurrency(actorCompanyId) : CountryCurrencyManager.GetCompanyCurrency(currencyId, actorCompanyId);

            if (currency == null)
                return null;

            #endregion

            #region FieldSettings

            bool showAllFields = false;


            #endregion

            #region CustomerInvoiceSaveDTO

            var invoiceDto = new CustomerInvoiceSaveDTO()
            {
                InvoiceId = invoice == null ? 0 : invoice.InvoiceId,
            };

            List<FieldSetting> fieldSettings = FieldSettingManager.GetFieldSettingsForMobileForm(TermGroup_MobileForms.OrderEdit, roleId, actorCompanyId);

            //Will always create an order with default settings from customer/company
            if (invoice == null)
            {
                #region Add Invoice


                #region Origin

                invoiceDto.OriginStatus = SoeOriginStatus.Draft;
                invoiceDto.InvoiceText = GetDefaultInvoiceText(actorCompanyId);
                invoiceDto.OriginDescription = descriptionText;

                //Set FK
                var defaultVoucherSeries = GetDefaultVoucherSeries(actorCompanyId);
                invoiceDto.VoucherSeriesId = defaultVoucherSeries.VoucherSeriesId;
                invoiceDto.VoucherSeriesTypeId = defaultVoucherSeries.VoucherSeriesTypeId;

                #endregion

                #region Invoice

                invoiceDto.ActorId = customer.ActorCustomerId;
                invoiceDto.BillingType = TermGroup_BillingType.Debit;
                invoiceDto.TotalAmountCurrency = 0;
                invoiceDto.VatAmount = 0;
                invoiceDto.InvoiceDate = DateTime.Now.Date;
                invoiceDto.VatType = GetDefaultVatType(customer, actorCompanyId);
                invoiceDto.ReferenceOur = GetDefaultOurReference(actorCompanyId);
                invoiceDto.CurrencyDate = currency.Date;
                invoiceDto.CurrencyRate = currency.RateToBase;
                invoiceDto.OrderType = orderTypeId >= 0 ? (TermGroup_OrderType)orderTypeId : (defaultOrderType > 0 ? (TermGroup_OrderType)defaultOrderType : TermGroup_OrderType.Project);

                //Set FK
                invoiceDto.CurrencyId = currency.CurrencyId;

                #endregion

                #region CustomerInvoice

                invoiceDto.RegistrationType = OrderInvoiceRegistrationType.Order;
                invoiceDto.SumAmount = 0;
                invoiceDto.FreightAmount = 0;
                invoiceDto.InvoiceFee = 0;
                invoiceDto.CentRounding = 0;
                invoiceDto.MarginalIncome = 0;
                invoiceDto.FixedPriceOrder = false;
                invoiceDto.PrintTimeReport = false;
                invoiceDto.IncludeOnInvoice = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingIncludeWorkDescriptionOnInvoice, 0, actorCompanyId, 0);
                invoiceDto.IncludeOnlyInvoicedTime = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ProjectIncludeOnlyInvoicedTimeInTimeProjectReport, 0, actorCompanyId, 0);

                if (projectId != 0)
                    invoiceDto.ProjectId = projectId;
                else if (FeatureManager.HasRolePermission(Feature.Time_Project_Invoice_Edit, Permission.Modify, roleId, actorCompanyId) && SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ProjectAutoGenerateOnNewInvoice, 0, actorCompanyId, 0))
                    invoiceDto.ProjectNr = "USEORDERNBR";

                #endregion

                #endregion

                #region Set customer settings on invoice

                var firstDeliveryAddress = CustomerManager.GetCustomerDeliveryAddresses(customer.ActorCustomerId, false).FirstOrDefault();
                var firstBillingAddress = CustomerManager.GetCustomerBillingAddresses(customer.ActorCustomerId, false).FirstOrDefault();
                var customerEmailsDict = CustomerManager.GetCustomerEmailAddresses(customer.ActorCustomerId);
                var customerGlnNumbersDict = CustomerManager.GetCustomerGlnNumbers(customer.ActorCustomerId);

                invoiceDto.ReferenceYour = customer.InvoiceReference;
                invoiceDto.PriceListTypeId = GetPriceListTypeIdBasedOnPriority(customer, defaultPriceListTypeId).ToNullable();
                invoiceDto.PaymentConditionId = GetPaymentConditionIdBasedOnPriority(customer, defaultPaymentConditionId);
                invoiceDto.DeliveryTypeId = GetDeliveryTypeIdBasedOnPriority(customer, defaultDeliveryTypeId);
                invoiceDto.DeliveryConditionId = GetDeliveryConditionIdBasedOnPriority(customer, defaultDeliveryConditionId);
                invoiceDto.SysWholeSellerId = GetWholeSellerBasedOnPriority(customer, defaultWholeSellerId);

                invoiceDto.ContactEComId = (customerEmailsDict != null && customerEmailsDict.Any()) ? customerEmailsDict.FirstOrDefault().Key : (int?)null;
                invoiceDto.DeliveryAddressId = (firstDeliveryAddress != null) ? firstDeliveryAddress.ContactAddressId : 0;
                invoiceDto.BillingAddressId = (firstBillingAddress != null) ? firstBillingAddress.ContactAddressId : 0;
                invoiceDto.AddAttachementsToEInvoice = customer.AddAttachementsToEInvoice;
                invoiceDto.AddSupplierInvoicesToEInvoices = customer.AddSupplierInvoicesToEInvoices.GetValueOrDefault();

                invoiceDto.ContactGLNId = (customerGlnNumbersDict != null && customerGlnNumbersDict.Any()) ? customerGlnNumbersDict.FirstOrDefault().Key : (int?)null;

                invoiceDto.InvoiceLabel = label;
                invoiceDto.WorkingDescription = workDescription ?? "";

                #endregion
            }
            else
            {
                #region Update invoice

                #region Origin

                invoiceDto.OriginStatus = (SoeOriginStatus)invoice.Origin.Status;
                invoiceDto.InvoiceText = invoice.InvoiceText;

                //Set FK
                invoiceDto.VoucherSeriesId = invoice.Origin.VoucherSeriesId;
                invoiceDto.VoucherSeriesTypeId = invoice.Origin.VoucherSeriesTypeId;

                #endregion

                #region Invoice

                invoiceDto.BillingType = (TermGroup_BillingType)invoice.BillingType;
                invoiceDto.VatType = (TermGroup_InvoiceVatType)invoice.VatType;
                invoiceDto.ActorId = invoice.ActorId.HasValue ? invoice.ActorId.Value : 0;
                invoiceDto.InvoiceDate = invoice.InvoiceDate;
                invoiceDto.CurrencyId = invoice.CurrencyId;
                invoiceDto.CurrencyDate = invoice.CurrencyDate;
                invoiceDto.CurrencyRate = invoice.CurrencyRate;
                invoiceDto.ReferenceOur = invoice.ReferenceOur;
                invoiceDto.TotalAmount = invoice.TotalAmount;
                invoiceDto.TotalAmountCurrency = invoice.TotalAmountCurrency;
                invoiceDto.VatAmount = invoice.VATAmount;
                invoiceDto.OrderType = (TermGroup_OrderType)invoice.OrderType;

                #endregion

                #region CustomerInvoice

                invoiceDto.RegistrationType = (OrderInvoiceRegistrationType)invoice.RegistrationType;
                invoiceDto.SumAmount = invoice.SumAmount;
                invoiceDto.FreightAmount = invoice.FreightAmount;
                invoiceDto.InvoiceFee = invoice.InvoiceFee;
                invoiceDto.CentRounding = invoice.CentRounding;
                invoiceDto.MarginalIncome = invoice.MarginalIncome;
                invoiceDto.FixedPriceOrder = invoice.FixedPriceOrder;
                invoiceDto.PrintTimeReport = invoice.PrintTimeReport;
                invoiceDto.DeliveryDate = invoice.DeliveryDate;
                invoiceDto.OrderDate = invoice.OrderDate;
                invoiceDto.ReferenceYour = invoice.ReferenceYour;
                invoiceDto.SysWholeSellerId = invoice.SysWholeSellerId;
                invoiceDto.PriceListTypeId = invoice.PriceListTypeId;
                invoiceDto.PaymentConditionId = invoice.PaymentConditionId.HasValue ? invoice.PaymentConditionId.Value : 0;
                invoiceDto.DeliveryTypeId = invoice.DeliveryTypeId.HasValue ? invoice.DeliveryTypeId.Value : 0;
                invoiceDto.DeliveryConditionId = invoice.DeliveryConditionId.HasValue ? invoice.DeliveryConditionId.Value : 0;
                invoiceDto.DeliveryAddressId = invoice.DeliveryAddressId;
                invoiceDto.BillingAddressId = invoice.BillingAddressId;
                invoiceDto.ContactEComId = invoice.ContactEComId;
                invoiceDto.WorkingDescription = invoice.WorkingDescription;
                invoiceDto.IncludeOnInvoice = invoice.IncludeOnInvoice;
                invoiceDto.IncludeOnlyInvoicedTime = invoice.IncludeOnlyInvoicedTime;
                invoiceDto.ShiftTypeId = invoice.ShiftTypeId;
                invoiceDto.PlannedStartDate = invoice.PlannedStartDate;
                invoiceDto.PlannedStopDate = invoice.PlannedStopDate;
                invoiceDto.EstimatedTime = invoice.EstimatedTime;
                invoiceDto.RemainingTime = invoice.RemainingTime;
                invoiceDto.KeepAsPlanned = invoice.KeepAsPlanned;
                invoiceDto.Priority = invoice.Priority;
                invoiceDto.CashSale = invoice.CashSale;
                invoiceDto.ExternalId = invoice.ExternalId;
                invoiceDto.AddAttachementsToEInvoice = invoice.AddAttachementsToEInvoice;
                invoiceDto.AddSupplierInvoicesToEInvoices = invoice.AddSupplierInvoicesToEInvoices;
                invoiceDto.ContactGLNId = invoice.ContactGLNId;

                invoiceDto.Dim1AccountId = invoice.DefaultDim1AccountId;
                invoiceDto.Dim2AccountId = invoice.DefaultDim2AccountId;
                invoiceDto.Dim3AccountId = invoice.DefaultDim3AccountId;
                invoiceDto.Dim4AccountId = invoice.DefaultDim4AccountId;
                invoiceDto.Dim5AccountId = invoice.DefaultDim5AccountId;
                invoiceDto.Dim6AccountId = invoice.DefaultDim6AccountId;
                #endregion

                #endregion

                #region Update invoice with input parameters

                //VatType
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_VatType, true, showAllFields))
                    invoiceDto.VatType = vatType;

                //SalesPriceList
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_SalesPriceList, true, showAllFields))
                    invoiceDto.PriceListTypeId = priceListId;

                //Label
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_Label, true, showAllFields))
                    invoiceDto.InvoiceLabel = label;

                //InternalText
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_InternalText, true, showAllFields))
                    invoiceDto.OriginDescription = descriptionText;

                //Currency
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_Currency, true, showAllFields))
                {
                    invoiceDto.CurrencyDate = currency.Date;
                    invoiceDto.CurrencyRate = currency.RateToBase;
                    invoiceDto.CurrencyId = currency.CurrencyId;
                }

                //InvoiceAddress
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_InvoiceAddress, true, showAllFields))
                    invoiceDto.BillingAddressId = billingAddressId;

                //DeliveryAddress
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_DeliveryAddress, true, showAllFields))
                {
                    invoiceDto.InvoiceHeadText = headText;
                    invoiceDto.DeliveryAddressId = deliveryAddressId;
                }

                //Reference
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_OurReference, true, showAllFields))
                    invoiceDto.ReferenceOur = referenceOur;

                //Wholeseller
                if (wholeSellerId != 0) // temp solution
                {
                    if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_WholeSeller, true, showAllFields))
                        invoiceDto.SysWholeSellerId = wholeSellerId;
                }

                //Reference
                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_YourReference, true, showAllFields))
                    invoiceDto.ReferenceYour = referenceYour;

                //DeliveryDate

                if (FieldSettingManager.DoShowMobileField(fieldSettings, TermGroup_MobileFields.OrderEdit_DDate, false, showAllFields)) //deliverydate is not visible by default
                    invoiceDto.DeliveryDate = deliveryDate;

                //Customer
                invoiceDto.ActorId = customer.ActorCustomerId;

                //Order type
                if (orderTypeId >= 0)
                    invoiceDto.OrderType = (TermGroup_OrderType)orderTypeId;

                #region Project

                if (!invoice.ProjectId.HasValue || (invoice.ProjectId.HasValue && invoice.ProjectId.Value == 0))
                {
                    invoiceDto.ProjectId = projectId;
                }


                #endregion

                #endregion
            }

            #endregion

            return invoiceDto;
        }

        public ActionResult ConvertToCustomerInvoiceSaveDTO(CompEntities entities, CustomerInvoiceHeadIO io, int currencyId, int actorCompanyId, ref CustomerInvoiceSaveDTO invoiceDto, List<string> specialFuntionalities)
        {
            int invoiceId = io.InvoiceId.GetValueOrDefault();

            #region Prereq

            if (!io.CustomerId.HasValue)
                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8416, "Kund kunde inte mappas"));

            Customer customer = CustomerManager.GetCustomer(entities, io.CustomerId.Value);
            if (customer == null)
                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8416, "Kund kunde inte mappas"));

            //Settings
            int defaultPriceListTypeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, 0, actorCompanyId, 0);
            int defaultPaymentConditionId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerPaymentDefaultPaymentCondition, 0, actorCompanyId, 0);
            int defaultDeliveryTypeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultDeliveryType, 0, actorCompanyId, 0);
            int defaultDeliveryConditionId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultDeliveryCondition, 0, actorCompanyId, 0);
            int defaultWholeSellerId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultWholeseller, 0, actorCompanyId, 0);
            var eInvoiceFormat = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingEInvoiceFormat, 0, actorCompanyId, 0);

            List<ContactAddress> deliveryAddresses = CustomerManager.GetCustomerDeliveryAddresses(entities, io.CustomerId.Value, false);
            List<ContactAddress> billingAddresses = CustomerManager.GetCustomerBillingAddresses(entities, io.CustomerId.Value, false);

            List<CompCurrency> currencies = CountryCurrencyManager.GetCompCurrencies(entities, actorCompanyId, false);
            CompCurrency currency = null;

            if (!string.IsNullOrEmpty(io.Currency))
            {
                currency = currencies.FirstOrDefault(c => c.Code == io.Currency);
            }

            if (currencyId == 0 && string.IsNullOrEmpty(io.Currency))
                currency = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId);
            else if (currency == null)
                currency = CountryCurrencyManager.GetCompanyCurrency(entities, currencyId, actorCompanyId);

            if (currency == null)
                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8417, "Valuta kunde inte mappas/hittas"));

            #endregion

            #region CustomerInvoiceSaveDTO

            if (!io.InvoiceId.HasValue && !string.IsNullOrEmpty(io.CustomerInvoiceNr))
            {
                TermGroup_BillingType? billingType = null;
                if (io.BillingType.HasValue)
                    billingType = (TermGroup_BillingType)io.BillingType.Value;

                SoeOriginType originType = io.OriginType != 0 ? (SoeOriginType)io.OriginType : SoeOriginType.CustomerInvoice;

                List<Invoice> invoices = GetInvoicesSearchInvoiceNr(entities, actorCompanyId, io.CustomerInvoiceNr, 5, originType);

                if (invoices != null && invoices.Count > 1)
                {
                    var matchingBillingType = invoices.Where(i => i.BillingType == (int)billingType);

                    if (matchingBillingType.Any())
                        io.InvoiceId = matchingBillingType.FirstOrDefault().InvoiceId;
                }

                if (invoices != null && invoices.Count == 1)
                    io.InvoiceId = invoices.FirstOrDefault().InvoiceId;
            }

            invoiceDto = new CustomerInvoiceSaveDTO()
            {
                InvoiceId = invoiceId,
            };


            #region Origin

            invoiceDto.OriginStatus = (SoeOriginStatus)io.OriginStatus;
            if (invoiceDto.OriginStatus == SoeOriginStatus.Voucher)
            {
                invoiceDto.FullyPayed = true;
                if (io.PaidAmount.HasValue)
                    invoiceDto.SumAmount = io.PaidAmount.Value;
                if (io.PaidAmountCurrency.HasValue)
                    invoiceDto.SumAmountCurrency = io.PaidAmountCurrency.Value;
            }

            invoiceDto.InvoiceText = GetDefaultInvoiceText(entities, actorCompanyId);
            invoiceDto.OriginDescription = io.Note;

            //Set FK
            var defaultVoucherSeries = GetDefaultVoucherSeries(entities, actorCompanyId, io.VoucherDate ?? io.InvoiceDate);
            if (defaultVoucherSeries == null)
                return new ActionResult(null, GetText(8403, "Verifikatserie saknas"));

            invoiceDto.VoucherSeriesId = defaultVoucherSeries.VoucherSeriesId;
            invoiceDto.VoucherSeriesTypeId = defaultVoucherSeries.VoucherSeriesTypeId;

            #endregion

            #region Special

            if (specialFuntionalities != null && specialFuntionalities.Any(v => v.ToLower().Equals("icon")))
            {
                invoiceDto.StatusIcon = SoeStatusIcon.Imported;
            }

            #endregion

            #endregion

            #region Invoice

            invoiceDto.InvoiceNr = io.CustomerInvoiceNr;
            invoiceDto.ActorId = io.CustomerId.Value;
            invoiceDto.OrderType = TermGroup_OrderType.Unspecified;
            if (io.BillingType.HasValue)
                invoiceDto.BillingType = (TermGroup_BillingType)io.BillingType.Value;
            else if (!io.TotalAmount.HasValue && !io.TotalAmountCurrency.HasValue)
                invoiceDto.BillingType = TermGroup_BillingType.Debit;
            else if (io.TotalAmount > 0 || io.TotalAmountCurrency > 0 || io.OriginType == (int)SoeOriginType.Order)
                invoiceDto.BillingType = TermGroup_BillingType.Debit;
            else if (io.TotalAmount < 0 || io.TotalAmountCurrency < 0)
                invoiceDto.BillingType = TermGroup_BillingType.Credit;

            invoiceDto.PrevInvoiceId = 0;

            if (!string.IsNullOrEmpty(io.OrderNr))
            {
                invoiceDto.OrderNumbers = io.OrderNr;

                var orders = InvoiceManager.GetInvoicesSearchInvoiceNr(entities, actorCompanyId, io.OrderNr, 1, SoeOriginType.Order);

                if (orders != null && orders.Any())
                    invoiceDto.PrevInvoiceId = orders.FirstOrDefault().InvoiceId;
            }

            if (!string.IsNullOrEmpty(io.DebetInvoiceNr) && invoiceDto.PrevInvoiceId == 0)
            {
                invoiceDto.PrevInvoiceId = InvoiceManager.GetInvoiceId(entities, io.DebetInvoiceNr, actorCompanyId, SoeOriginType.CustomerInvoice) ?? 0;
            }

            if (!string.IsNullOrEmpty(io.OfferNr) && invoiceDto.PrevInvoiceId == 0)
            {
                invoiceDto.PrevInvoiceId = InvoiceManager.GetInvoiceId(entities, io.OfferNr, actorCompanyId, SoeOriginType.Offer) ?? 0;
            }

            if (!string.IsNullOrEmpty(io.ContractNr) && invoiceDto.PrevInvoiceId == 0)
            {
                invoiceDto.PrevInvoiceId = InvoiceManager.GetInvoiceId(entities, io.ContractNr, actorCompanyId, SoeOriginType.Contract) ?? 0;
            }

            if (!string.IsNullOrEmpty(io.ProjectNr))
            {
                var proj = ProjectManager.GetProjectByNumber(entities, actorCompanyId, io.ProjectNr);
                invoiceDto.ProjectId = proj != null ? proj.ProjectId : invoiceDto.ProjectId;
                invoiceDto.ProjectNr = io.ProjectNr;
            }
            else if (io.ProjectId.HasValue && io.ProjectId > 0)
            {
                invoiceDto.ProjectId = (int)io.ProjectId;
            }

            invoiceDto.InvoiceHeadText = !string.IsNullOrEmpty(io.InvoiceHeadText) ? io.InvoiceHeadText : string.Empty;
            invoiceDto.InvoiceLabel = !string.IsNullOrEmpty(io.InvoiceLabel) ? io.InvoiceLabel : string.Empty;
            if (string.IsNullOrEmpty(invoiceDto.InvoiceLabel))
            {
                invoiceDto.InvoiceLabel = customer.InvoiceLabel;
            }

            invoiceDto.InternalDescription = io.InternalDescription;
            invoiceDto.WorkingDescription = io.WorkingDescription;

            if (invoiceId == 0 && !string.IsNullOrEmpty(invoiceDto.WorkingDescription))
            {
                invoiceDto.IncludeOnInvoice = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingIncludeWorkDescriptionOnInvoice, 0, actorCompanyId, 0);
            }

            if ((!string.IsNullOrEmpty(io.SalesAccountNr) || !string.IsNullOrEmpty(io.SalesAccountNrDim2) || !string.IsNullOrEmpty(io.SalesAccountNrDim3) || !string.IsNullOrEmpty(io.SalesAccountNrDim4) || !string.IsNullOrEmpty(io.SalesAccountNrDim5) || !string.IsNullOrEmpty(io.SalesAccountNrDim6)))
            {
                List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId);

                if (accountDims.Any())
                {
                    accountDims = accountDims.OrderBy(a => a.AccountDimNr).ToList();

                    int dimCounter = 1;

                    foreach (var dim in accountDims)
                    {
                        if (!string.IsNullOrEmpty(io.SalesAccountNr) && dimCounter == 1)
                            invoiceDto.Dim1AccountId = AccountManager.GetAccountByNr(io.SalesAccountNr, dim.AccountDimId, actorCompanyId) != null ? (int?)AccountManager.GetAccountByNr(io.SalesAccountNr, dim.AccountDimId, actorCompanyId).AccountId : null;

                        if (!string.IsNullOrEmpty(io.SalesAccountNrDim2) && dimCounter == 2)
                            invoiceDto.Dim2AccountId = AccountManager.GetAccountByNr(io.SalesAccountNrDim2, dim.AccountDimId, actorCompanyId) != null ? (int?)AccountManager.GetAccountByNr(io.SalesAccountNrDim2, dim.AccountDimId, actorCompanyId).AccountId : null;

                        if (!string.IsNullOrEmpty(io.SalesAccountNrDim3) && dimCounter == 3)
                            invoiceDto.Dim3AccountId = AccountManager.GetAccountByNr(io.SalesAccountNrDim3, dim.AccountDimId, actorCompanyId) != null ? (int?)AccountManager.GetAccountByNr(io.SalesAccountNrDim3, dim.AccountDimId, actorCompanyId).AccountId : null;

                        if (!string.IsNullOrEmpty(io.SalesAccountNrDim4) && dimCounter == 4)
                            invoiceDto.Dim4AccountId = AccountManager.GetAccountByNr(io.SalesAccountNrDim4, dim.AccountDimId, actorCompanyId) != null ? (int?)AccountManager.GetAccountByNr(io.SalesAccountNrDim4, dim.AccountDimId, actorCompanyId).AccountId : null;

                        if (!string.IsNullOrEmpty(io.SalesAccountNrDim5) && dimCounter == 5)
                            invoiceDto.Dim5AccountId = AccountManager.GetAccountByNr(io.SalesAccountNrDim5, dim.AccountDimId, actorCompanyId) != null ? (int?)AccountManager.GetAccountByNr(io.SalesAccountNrDim5, dim.AccountDimId, actorCompanyId).AccountId : null;

                        if (!string.IsNullOrEmpty(io.SalesAccountNrDim6) && dimCounter == 6)
                            invoiceDto.Dim6AccountId = AccountManager.GetAccountByNr(io.SalesAccountNrDim6, dim.AccountDimId, actorCompanyId) != null ? (int?)AccountManager.GetAccountByNr(io.SalesAccountNrDim6, dim.AccountDimId, actorCompanyId).AccountId : null;

                        dimCounter++;
                    }
                }
            }

            invoiceDto.InvoiceDate = io.InvoiceDate;
            invoiceDto.VoucherDate = io.VoucherDate;
            invoiceDto.DueDate = io.DueDate;
            invoiceDto.DeliveryDate = io.DeliveryDate;
            invoiceDto.VatType = (io.VatType.HasValue && io.VatType > 0) ? (TermGroup_InvoiceVatType)io.VatType : GetDefaultVatType(entities, customer, actorCompanyId);

            invoiceDto.ReferenceOur = !string.IsNullOrEmpty(io.ReferenceOur) ? io.ReferenceOur : GetDefaultOurReference(entities, actorCompanyId);
            invoiceDto.ReferenceYour = !string.IsNullOrEmpty(io.ReferenceYour) ? io.ReferenceYour : customer.InvoiceReference;
            invoiceDto.ExternalId = !string.IsNullOrEmpty(io.ExternalId) ? io.ExternalId : string.Empty;
            invoiceDto.InvoiceDeliveryType = io.InvoiceDeliveryType;

            invoiceDto.CurrencyDate = io.CurrencyDate.HasValue ? io.CurrencyDate.Value : currency.Date;
            invoiceDto.CurrencyRate = (io.CurrencyRate.HasValue && io.CurrencyRate != 1) ? (decimal)io.CurrencyRate : currency.RateToBase;

            //Set FK
            invoiceDto.CurrencyId = currency.CurrencyId;

            #region VoucherSeries

            int? voucherHeadId = null;

            if (io.VoucherDate.HasValue && !string.IsNullOrEmpty(io.VoucherNr))
            {
                var accountYear = AccountManager.GetAccountYear(entities, (DateTime)io.VoucherDate, actorCompanyId);

                if (accountYear != null)
                {
                    List<VoucherSeries> voucherSeries = VoucherManager.GetVoucherSeriesByYear(accountYear.AccountYearId, actorCompanyId, false, false);

                    if (voucherSeries != null && voucherSeries.Any())
                    {
                        bool foundVoucherHead = false;

                        foreach (var serie in voucherSeries)
                        {
                            if (foundVoucherHead)
                                continue;

                            int voucherNr = 0;
                            if (int.TryParse(io.VoucherNr, out voucherNr))
                            {
                                if (voucherNr != 0)
                                {
                                    var voucherHead = VoucherManager.GetVoucherHeadByNr(entities, voucherNr, serie.VoucherSeriesId, actorCompanyId, false, false, false, false);

                                    if (voucherHead != null && voucherHead.Date == io.VoucherDate)
                                    {
                                        voucherHeadId = voucherHead.VoucherHeadId;
                                        foundVoucherHead = true;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            if (voucherHeadId != 0 && voucherHeadId.HasValue)
                invoiceDto.VoucherHeadId = voucherHeadId;

            #endregion

            #endregion

            #region CustomerInvoice

            if (io.OriginType == (int)SoeOriginType.Order)
                invoiceDto.RegistrationType = OrderInvoiceRegistrationType.Order;
            else if (io.OriginType == (int)SoeOriginType.CustomerInvoice)
                invoiceDto.RegistrationType = OrderInvoiceRegistrationType.Invoice;
            else if (io.OriginType == (int)SoeOriginType.Offer)
                invoiceDto.RegistrationType = OrderInvoiceRegistrationType.Offer;
            else if (io.OriginType == (int)SoeOriginType.Contract)
                invoiceDto.RegistrationType = OrderInvoiceRegistrationType.Contract;

            invoiceDto.CentRounding = io.CentRounding.HasValue ? io.CentRounding.Value : 0;

            invoiceDto.VatAmount = io.VATAmount.HasValue ? io.VATAmount.Value : 0;

            //If invoice is missing VATAmountCurrency the amount will be the same as VATAmount
            if (!io.VATAmountCurrency.HasValue && (io.CurrencyRate.HasValue && io.CurrencyRate.Value == 1))
            {
                invoiceDto.VatAmountCurrency = io.VATAmount.HasValue ? io.VATAmount.Value : 0;
            }

            invoiceDto.TotalAmount = io.TotalAmount.HasValue ? io.TotalAmount.Value : 0;
            invoiceDto.TotalAmountCurrency = io.TotalAmountCurrency.HasValue ? io.TotalAmountCurrency.Value : 0;

            invoiceDto.RemainingAmount = io.RemainingAmount.HasValue ? io.RemainingAmount.Value : 0;

            if (invoiceDto.TotalAmountCurrency == 0 && invoiceDto.TotalAmount != 0)
                invoiceDto.TotalAmountCurrency = invoiceDto.TotalAmount;

            invoiceDto.FreightAmount = io.FreightAmount.HasValue ? io.FreightAmount.Value : 0;
            invoiceDto.FreightAmountCurrency = io.FreightAmountCurrency.HasValue ? io.FreightAmountCurrency.Value : 0;

            if (invoiceDto.FreightAmountCurrency == 0 && invoiceDto.FreightAmount != 0)
                invoiceDto.FreightAmountCurrency = invoiceDto.FreightAmount;

            invoiceDto.InvoiceFee = io.InvoiceFee.HasValue ? io.InvoiceFee.Value : 0;
            invoiceDto.InvoiceFeeCurrency = io.InvoiceFeeCurrency.HasValue ? io.InvoiceFeeCurrency.Value : 0;

            if (invoiceDto.InvoiceFeeCurrency == 0 && invoiceDto.InvoiceFee != 0)
                invoiceDto.InvoiceFeeCurrency = invoiceDto.InvoiceFee;

            if (invoiceDto.FullyPayed == true && invoiceDto.TotalAmount == 0 && io.PaidAmount.HasValue)
            {
                // Special for paid invoices and SOP
                invoiceDto.SumAmount = io.PaidAmount.Value;
                invoiceDto.SumAmountCurrency = io.PaidAmountCurrency.Value;
                invoiceDto.TotalAmount = invoiceDto.SumAmount + invoiceDto.VatAmount;
                invoiceDto.TotalAmountCurrency = invoiceDto.SumAmountCurrency + invoiceDto.VatAmountCurrency;
            }
            else
            {
                invoiceDto.SumAmount = invoiceDto.TotalAmount - invoiceDto.VatAmount;
                invoiceDto.SumAmountCurrency = invoiceDto.TotalAmountCurrency - invoiceDto.VatAmountCurrency;
            }
            if ((invoiceDto.TotalAmount != 0 && io.PaidAmount.HasValue && invoiceDto.TotalAmount != io.PaidAmount.Value) || (invoiceDto.TotalAmount != 0 && io.PaidAmount.HasValue == false))
            {
                invoiceDto.FullyPayed = false;
            }
            //Add totalamount if it is unknown and we know sumamount and vat

            if (invoiceDto.TotalAmount == 0 && invoiceDto.SumAmount != 0 && invoiceDto.VatAmount != 0)
                invoiceDto.TotalAmount = invoiceDto.SumAmount + invoiceDto.VatAmount + invoiceDto.CentRounding;

            if (invoiceDto.TotalAmountCurrency == 0 && invoiceDto.SumAmountCurrency != 0 && invoiceDto.VatAmountCurrency != 0)
                invoiceDto.TotalAmountCurrency = invoiceDto.SumAmountCurrency + invoiceDto.VatAmountCurrency;

            #endregion

            #region Set customer settings on invoice

            PaymentCondition paymentCondition = null;
            DeliveryType deliveryType = null;
            DeliveryCondition deliveryCondition = null;

            if (!string.IsNullOrEmpty(io.PaymentConditionCode))
                paymentCondition = PaymentManager.GetPaymentConditionByCode(entities, io.PaymentConditionCode, actorCompanyId);

            if (!string.IsNullOrEmpty(io.DeliveryTypeCode))
                deliveryType = GetDeliveryTypeByCode(entities, io.DeliveryTypeCode, actorCompanyId);

            if (!string.IsNullOrEmpty(io.DeliveryConditionCode))
                deliveryCondition = GetDeliveryConditionByCode(entities, io.DeliveryConditionCode, actorCompanyId);

            invoiceDto.PriceListTypeId = io.PriceListTypeId.HasValue ? io.PriceListTypeId : GetPriceListTypeIdBasedOnPriority(customer, defaultPriceListTypeId);
            invoiceDto.PaymentConditionId = paymentCondition != null ? paymentCondition.PaymentConditionId : GetPaymentConditionIdBasedOnPriority(customer, defaultPaymentConditionId);
            invoiceDto.DeliveryTypeId = deliveryType != null ? deliveryType.DeliveryTypeId : GetDeliveryTypeIdBasedOnPriority(customer, defaultDeliveryTypeId);
            invoiceDto.DeliveryConditionId = deliveryCondition != null ? deliveryCondition.DeliveryConditionId : GetDeliveryConditionIdBasedOnPriority(customer, defaultDeliveryConditionId);

            if ((invoiceDto.InvoiceDeliveryType.GetValueOrDefault() == 0) && (customer.InvoiceDeliveryType.GetValueOrDefault() > 0))
            {
                invoiceDto.InvoiceDeliveryType = customer.InvoiceDeliveryType.Value;
            }

            if (eInvoiceFormat == (int)TermGroup_EInvoiceFormat.Intrum)
            {
                invoiceDto.InvoiceDeliveryProvider = (int)SoeInvoiceDeliveryProvider.Intrum;
            }

            invoiceDto.AddAttachementsToEInvoice = customer.AddAttachementsToEInvoice;
            invoiceDto.AddSupplierInvoicesToEInvoices = customer.AddSupplierInvoicesToEInvoices.GetValueOrDefault();

            invoiceDto.SysWholeSellerId = GetWholeSellerBasedOnPriority(customer, defaultWholeSellerId);

            //Email
            if (string.IsNullOrEmpty(io.Email))
            {
                invoiceDto.ContactEComId = customer.ContactEComId;
                if (!invoiceDto.ContactEComId.HasValue)
                {
                    invoiceDto.ContactEComId = ContactManager.GetContactEComsFromActor(customer.ActorCustomerId, false, TermGroup_SysContactEComType.Email).FirstOrDefault()?.ContactEComId;
                }
            }
            else
            {
                invoiceDto.ContactEComId = ContactManager.GetContactEComsFromActor(customer.ActorCustomerId, false, TermGroup_SysContactEComType.Email, io.Email).FirstOrDefault()?.ContactEComId;
                if (invoiceDto.ContactEComId.GetValueOrDefault() == 0)
                {
                    invoiceDto.ContactEComId = CustomerManager.AddCustomerEcom(customer.ActorCustomerId, TermGroup_SysContactEComType.Email, io.Email).IntegerValue;
                }
            }

            //Gln
            if (string.IsNullOrEmpty(io.CustomerGlnNr))
            {
                invoiceDto.ContactGLNId = customer.ContactGLNId;
            }
            else
            {
                invoiceDto.ContactGLNId = ContactManager.GetContactEComsFromActor(customer.ActorCustomerId, false, TermGroup_SysContactEComType.GlnNumber, io.CustomerGlnNr).FirstOrDefault()?.ContactEComId;
                if (invoiceDto.ContactGLNId.GetValueOrDefault() == 0)
                {
                    invoiceDto.ContactGLNId = CustomerManager.AddCustomerEcom(customer.ActorCustomerId, TermGroup_SysContactEComType.GlnNumber, io.CustomerGlnNr).IntegerValue;
                }
            }

            // Contract nr
            if (!String.IsNullOrEmpty(customer.ContractNr))
                invoiceDto.ContractNr = customer.ContractNr;

            var deliveryAddress = deliveryAddresses != null ? deliveryAddresses.FirstOrDefault() : null;
            var billingAddress = billingAddresses != null ? billingAddresses.FirstOrDefault() : null;

            if (!string.IsNullOrEmpty(io.BillingAddressAddress))
            {
                // Check if it already exists
                if (!billingAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, io.BillingAddressAddress))
                {
                    var result = CustomerManager.AddCustomerAddress(TermGroup_SysContactAddressType.Billing, io.CustomerId.Value, io.BillingAddressAddress, io.BillingAddressCity, io.BillingAddressCO, io.BillingAddressPostNr, io.BillingAddressCountry, io.BillingAddressName);
                    if (result.Success && result.IntegerValue > 0)
                    {
                        billingAddress = ContactManager.GetContactAddress(result.IntegerValue, false);
                    }
                }
                else
                {
                    int? contactAddressId = billingAddresses.ReturnExistingContactAddressId(TermGroup_SysContactAddressRowType.Address, io.BillingAddressAddress);

                    if (contactAddressId.HasValue)
                        billingAddress = ContactManager.GetContactAddress((int)contactAddressId, false);
                }
            }
            if (!string.IsNullOrEmpty(io.DeliveryAddressAddress))
            {

                if (io.CreateDeliveryAddressAsTextOnly.HasValue && io.CreateDeliveryAddressAsTextOnly == true)
                {
                    StringBuilder sb = new StringBuilder();
                    sb.AppendLine(io.DeliveryAddressName);
                    sb.AppendLine(io.DeliveryAddressAddress);
                    sb.AppendLine(io.DeliveryAddressPostNr);
                    sb.AppendLine(io.DeliveryAddressCity);
                    sb.Append(io.DeliveryAddressCountry);

                    invoiceDto.InvoiceHeadText = sb.ToString();
                    deliveryAddress = null;
                }
                else
                {
                    if (!deliveryAddresses.AddressExists(TermGroup_SysContactAddressRowType.Address, io.DeliveryAddressAddress))
                    {
                        var result = CustomerManager.AddCustomerAddress(TermGroup_SysContactAddressType.Delivery, io.CustomerId.Value, io.DeliveryAddressAddress, io.DeliveryAddressCity, io.DeliveryAddressCO, io.DeliveryAddressPostNr, io.DeliveryAddressCountry, io.DeliveryAddressName);
                        if (result.Success && result.IntegerValue > 0)
                        {
                            deliveryAddress = ContactManager.GetContactAddress(result.IntegerValue, false);
                        }
                    }
                    else
                    {
                        int? contactAddressId = deliveryAddresses.ReturnExistingContactAddressId(TermGroup_SysContactAddressRowType.Address, io.DeliveryAddressAddress);

                        if (contactAddressId.HasValue)
                            deliveryAddress = ContactManager.GetContactAddress((int)contactAddressId, false);
                    }
                }
            }

            invoiceDto.DeliveryAddressId = deliveryAddress == null ? 0 : deliveryAddress.ContactAddressId;
            invoiceDto.BillingAddressId = billingAddress == null ? 0 : billingAddress.ContactAddressId;

            #endregion

            #region Contract

            if (io.RegistrationType == (int)OrderInvoiceRegistrationType.Contract)
            {
                if (io.ContractGroupId.HasValue && io.ContractGroupId != 0)
                {
                    invoiceDto.ContractGroupId = io.ContractGroupId;
                }
                else
                {
                    IEnumerable<ContractGroup> contractGroups = ContractManager.GetContractGroups(actorCompanyId);

                    if (contractGroups.Any(g => g.Name.ToLower() == io.ContractGroupName.ToLower()))
                    {
                        invoiceDto.ContractGroupId = contractGroups.FirstOrDefault(g => g.Name.ToLower() == io.ContractGroupName.ToLower())?.ContractGroupId;
                    }
                }
            }

            invoiceDto.NextContractPeriodDate = io.NextContractPeriodDate;
            invoiceDto.NextContractPeriodYear = io.NextContractPeriodYear.HasValue ? (int)io.NextContractPeriodYear : 0;
            invoiceDto.NextContractPeriodValue = io.NextContractPeriodValue.HasValue ? (int)io.NextContractPeriodValue : 0;

            #endregion

            return new ActionResult(true);
        }

        public ActionResult ConvertToCustomerLedgerSaveDTO(CompEntities entities, CustomerInvoiceHeadIO io, int currencyId, int actorCompanyId, ref CustomerLedgerSaveDTO invoiceDto, List<string> specialFuntionalities)
        {
            int invoiceId = 0;

            if (io.InvoiceId.HasValue)
                invoiceId = io.InvoiceId.Value;

            #region Prereq

            if (!io.CustomerId.HasValue)
                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8416, "Kund kunde inte mappas"));

            Customer customer = CustomerManager.GetCustomer(entities, io.CustomerId.Value);
            if (customer == null)
                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8416, "Kund kunde inte mappas"));

            //Settings
            int defaultPriceListTypeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, 0, actorCompanyId, 0);
            int defaultPaymentConditionId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerPaymentDefaultPaymentCondition, 0, actorCompanyId, 0);
            int defaultDeliveryTypeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultDeliveryType, 0, actorCompanyId, 0);
            int defaultDeliveryConditionId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultDeliveryCondition, 0, actorCompanyId, 0);
            int defaultWholeSellerId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultWholeseller, 0, actorCompanyId, 0);

            CompCurrency currency = null;
            if (currencyId == 0)
                currency = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId);
            else
                currency = CountryCurrencyManager.GetCompanyCurrency(entities, currencyId, actorCompanyId);

            if (currency == null)
                return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8417, "Valuta kunde inte mappas/hittas"));

            #endregion

            #region CustomerInvoiceSaveDTO

            invoiceDto = new CustomerLedgerSaveDTO()
            {
                InvoiceId = invoiceId,
            };

            #region Origin

            invoiceDto.OriginStatus = (SoeOriginStatus)io.OriginStatus;
            invoiceDto.InvoiceText = GetDefaultInvoiceText(entities, actorCompanyId);
            invoiceDto.OriginDescription = !string.IsNullOrEmpty(io.Note) ? io.Note : "";
            invoiceDto.InternalDescription = io.InternalDescription;

            if (!string.IsNullOrEmpty(io.TransferType))
                invoiceDto.OriginDescription += GetText(8430, "Överföringstyp:") + " " + io.TransferType;

            //Set FK
            var defaultVoucherSeries = GetDefaultVoucherSeries(entities, actorCompanyId);
            if (defaultVoucherSeries == null)
                return new ActionResult(null, GetText(8403, "Verifikatserie saknas"));

            invoiceDto.VoucherSeriesId = defaultVoucherSeries.VoucherSeriesId;
            invoiceDto.VoucherSeriesTypeId = defaultVoucherSeries.VoucherSeriesTypeId;

            #endregion

            #region Invoice

            invoiceDto.InvoiceNr = io.CustomerInvoiceNr;
            invoiceDto.ActorId = io.CustomerId.Value;
            invoiceDto.BillingType = (TermGroup_BillingType)io.BillingType.Value;
            invoiceDto.InvoiceDate = io.InvoiceDate;
            invoiceDto.VatType = GetDefaultVatType(entities, customer, actorCompanyId);
            invoiceDto.ReferenceOur = GetDefaultOurReference(entities, actorCompanyId);
            invoiceDto.ExternalId = io.ExternalId ?? string.Empty;

            invoiceDto.CurrencyDate = (io.CurrencyDate.HasValue) ? io.CurrencyDate.Value : currency.Date;
            invoiceDto.CurrencyRate = io.CurrencyRate.HasValue ? io.CurrencyRate.Value : currency.RateToBase;
            invoiceDto.CurrencyId = currency.CurrencyId;

            if (!string.IsNullOrEmpty(io.OCR))
                invoiceDto.OCR = io.OCR;

            #endregion

            #region CustomerInvoice

            invoiceDto.CentRounding = io.CentRounding.HasValue ? io.CentRounding.Value : 0;

            invoiceDto.TotalAmount = io.TotalAmount.HasValue ? io.TotalAmount.Value : 0;
            invoiceDto.TotalAmountCurrency = io.TotalAmountCurrency.HasValue ? io.TotalAmountCurrency.Value : 0;
            if (invoiceDto.TotalAmountCurrency == 0 && invoiceDto.TotalAmount != 0)
                invoiceDto.TotalAmountCurrency = invoiceDto.TotalAmount;

            invoiceDto.VatAmount = io.VATAmount.HasValue ? (decimal)io.VATAmount : 0;
            invoiceDto.VatAmountCurrency = io.VATAmountCurrency.HasValue ? (decimal)io.VATAmountCurrency : 0;
            if (invoiceDto.VatAmountCurrency == 0 && invoiceDto.VatAmount != 0)
                invoiceDto.VatAmountCurrency = invoiceDto.VatAmount;

            invoiceDto.FreightAmount = io.FreightAmount.HasValue ? io.FreightAmount.Value : 0;
            invoiceDto.FreightAmountCurrency = io.FreightAmountCurrency.HasValue ? io.FreightAmountCurrency.Value : 0;

            if (invoiceDto.FreightAmountCurrency == 0 && invoiceDto.FreightAmount != 0)
                invoiceDto.FreightAmountCurrency = invoiceDto.FreightAmount;

            invoiceDto.InvoiceFee = io.InvoiceFee.HasValue ? io.InvoiceFee.Value : 0;
            invoiceDto.InvoiceFeeCurrency = io.InvoiceFeeCurrency.HasValue ? io.InvoiceFeeCurrency.Value : 0;

            if (invoiceDto.InvoiceFeeCurrency == 0 && invoiceDto.InvoiceFee != 0)
                invoiceDto.InvoiceFeeCurrency = invoiceDto.InvoiceFee;

            invoiceDto.SumAmount = invoiceDto.TotalAmount - invoiceDto.VatAmount;
            invoiceDto.SumAmountCurrency = invoiceDto.TotalAmountCurrency - invoiceDto.VatAmountCurrency;

            invoiceDto.PaidAmount = io.PaidAmount.HasValue ? io.PaidAmount.Value : 0;
            invoiceDto.PaidAmountCurrency = io.PaidAmount.HasValue ? io.PaidAmount.Value : 0;

            invoiceDto.RemainingAmount = io.RemainingAmount.HasValue ? io.RemainingAmount.Value : 0;

            invoiceDto.DueDate = io.DueDate;
            invoiceDto.VoucherDate = invoiceDto.VoucherDate.HasValue ? io.VoucherDate : io.InvoiceDate;

            #endregion

            #endregion

            #region Set customer settings on invoice

            invoiceDto.ReferenceYour = customer.InvoiceReference;

            #endregion


            foreach (var specialFuntionality in specialFuntionalities)
            {
                if (specialFuntionality.ToLower() == "automaster")
                {
                    string transferTypeString = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceTransferTypesToBeClosed, 0, actorCompanyId, 0);

                    bool isFullyPayed = false;

                    if (!transferTypeString.IsNullOrEmpty())
                    {
                        List<string> transferTypesToBeClosed = transferTypeString.Split(',').ToList();
                        isFullyPayed = transferTypesToBeClosed.Contains(io.TransferType);
                    }

                    if (io.TotalAmount == 0)
                        isFullyPayed = true;

                    invoiceDto.FullyPayed = isFullyPayed;
                    invoiceDto.VoucherDate = io.InvoiceDate;
                    invoiceDto.DueDate = io.DueDate.HasValue ? io.DueDate : io.InvoiceDate;

                    invoiceDto.SeqNr = io.SeqNr != null ? io.SeqNr : 0;
                }

                if (specialFuntionality.ToLower() == "sauma")
                {
                    if (io.OCR == string.Empty)
                        invoiceDto.OCR = InvoiceUtility.GetCheckedBankPaymentReference(io.CustomerNr + io.CustomerInvoiceNr);

                    if (io.FullyPayed == true)
                        invoiceDto.FullyPayed = true;
                }

                if (specialFuntionality.ToLower() == "scanlog")
                {
                    invoiceDto.VatAmount = invoiceDto.VatAmountCurrency = (io.VatAmount1 ?? 0) + (io.VatAmount2 ?? 0) + (io.VatAmount3 ?? 0);
                    if (invoiceDto.VatAmount == 0)
                        invoiceDto.VatType = TermGroup_InvoiceVatType.NoVat;

                    if (invoiceDto.BillingType == TermGroup_BillingType.Credit)
                    {
                        //Always negative
                        invoiceDto.TotalAmountCurrency = -Math.Abs(invoiceDto.TotalAmountCurrency);
                        invoiceDto.TotalAmount = -Math.Abs(invoiceDto.TotalAmount);
                        invoiceDto.VatAmountCurrency = -Math.Abs(invoiceDto.VatAmountCurrency);
                        invoiceDto.VatAmount = -Math.Abs(invoiceDto.VatAmount);
                    }

                    if (string.IsNullOrEmpty(invoiceDto.OCR))
                        invoiceDto.OCR = io.CustomerInvoiceNr;
                }
            }

            return new ActionResult(true);
        }

        public ActionResult ConvertToCustomerInvoiceRowDTO(CompEntities entities, int actorCompanyId, List<CustomerInvoiceRowIO> invoiceRowIOs, List<Account> accounts, List<CustomerInvoiceRowDTO> productRows, OrderInvoiceRegistrationType invRegType, int? invoiceId = null)
        {
            if (invoiceRowIOs == null || invoiceRowIOs.Count == 0)
                return new ActionResult((int)ActionResultSave.NothingSaved);

            ActionResult result = new ActionResult();
            var miscProduct = ProductManager.GetInvoiceProductFromSetting(CompanySettingType.ProductMisc, actorCompanyId);

            int rowNr = productRows.Count == 0 ? 0 : productRows.OrderByDescending(r => r.TempRowId).First().TempRowId + 1;
            foreach (var io in invoiceRowIOs)
            {
                string productName = string.Empty;

                if (!string.IsNullOrEmpty(io.ProductName2))
                    productName = !string.IsNullOrEmpty(io.ProductName2) ? io.ProductName + " " + io.ProductName2 : io.ProductName;

                var dto = new CustomerInvoiceRowDTO()
                {
                    InvoiceId = invoiceId ?? 0,
                    Type = io.CustomerRowType == (int)SoeInvoiceRowType.Unknown ? SoeInvoiceRowType.ProductRow : (SoeInvoiceRowType)io.CustomerRowType,
                    VatAmount = io.VatAmount ?? 0,
                    VatAmountCurrency = io.VatAmountCurrency ?? 0,
                    Quantity = io.Quantity,
                    PurchasePrice = io.PurchasePrice ?? 0,
                    ProductNr = io.ProductNr,
                    ProductName = productName,
                    Text = productName,
                    Date = io.RowDate,
                    DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                    DiscountPercent = io.Discount ?? 0,
                    DiscountAmount = io.DiscountAmount ?? 0,
                    DiscountAmountCurrency = io.DiscountAmountCurrency ?? 0,
                    VatRate = io.VatRate ?? 0,
                    SumAmount = io.SumAmount ?? 0,
                    SumAmountCurrency = io.SumAmount ?? 0,
                    Amount = io.UnitPrice ?? 0,
                    AmountCurrency = io.UnitPrice ?? 0,
                    StockCode = io.Stock ?? string.Empty,
                    StockId = io.StockId,
                    TempRowId = rowNr++,
                };

                #region Amounts

                if (dto.VatAmount != 0 && dto.VatAmountCurrency == 0)
                    dto.VatAmountCurrency = dto.VatAmount;

                if (dto.SumAmount != 0 && dto.SumAmountCurrency == 0)
                    dto.SumAmountCurrency = dto.SumAmount;

                #endregion

                var unit = ProductManager.GetProductUnit(io.Unit, actorCompanyId);
                if (unit == null && !string.IsNullOrEmpty(io.Unit))
                {
                    unit = new ProductUnit()
                    {
                        Code = io.Unit,
                        Name = io.Unit,
                    };

                    ProductManager.AddProductUnit(unit, actorCompanyId);
                }

                if (unit != null)
                    dto.ProductUnitId = unit.ProductUnitId;

                if (!string.IsNullOrEmpty(dto.StockCode) && !dto.StockId.HasValue)
                {
                    var stock = StockManager.GetStockByCode(actorCompanyId, dto.StockCode);

                    if (stock == null)
                    {
                        var stockDto = new StockDTO()
                        {
                            Code = dto.StockCode,
                            Name = dto.StockCode,
                        };

                        StockManager.SaveStock(stockDto, actorCompanyId);

                        stock = StockManager.GetStockByCode(actorCompanyId, dto.StockCode);
                    }

                    if (stock != null)
                    {
                        dto.StockId = stock.StockId;
                        dto.IsStockRow = true;
                    }
                }

                if (!string.IsNullOrEmpty(io.RowStatus))
                {
                    if (invRegType == OrderInvoiceRegistrationType.Order)
                    {
                        int InitialattestStateId = AttestManager.GetInitialAttestStateId(entities, invoiceRowIOs.First().ActorCompanyId, TermGroup_AttestEntity.Order);
                        int defaultStatusTransferredOrderToInvoice = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, 0, actorCompanyId, 0);
                        int defaultStatusTransferredOrderReadyMobile = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusOrderReadyMobile, 0, actorCompanyId, 0);

                        if (io.RowStatus == "0")
                            dto.AttestStateId = InitialattestStateId;
                        else if (io.RowStatus == "5")
                            dto.AttestStateId = defaultStatusTransferredOrderToInvoice;
                        else
                            dto.AttestStateId = defaultStatusTransferredOrderReadyMobile;

                        if (io.RowStatus.ToLower() == "closed")
                            dto.AttestStateId = defaultStatusTransferredOrderToInvoice;
                    }

                    if (invRegType == OrderInvoiceRegistrationType.Offer)
                    {
                        int InitialattestStateId = AttestManager.GetInitialAttestStateId(invoiceRowIOs.First().ActorCompanyId, TermGroup_AttestEntity.Order);
                        int defaultStatusTransferredOfferToInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOfferToInvoice, 0, actorCompanyId, 0);

                        if (io.RowStatus == "0")
                            dto.AttestStateId = InitialattestStateId;
                        else
                            dto.AttestStateId = defaultStatusTransferredOfferToInvoice;

                        if (io.RowStatus.ToLower() == "closed")
                            dto.AttestStateId = defaultStatusTransferredOfferToInvoice;
                    }
                }

                if (!string.IsNullOrEmpty(io.VatCode))
                {
                    var vatCode = AccountManager.GetVatCodeByCode(actorCompanyId, io.VatCode);

                    dto.VatCodeId = vatCode != null ? vatCode.VatCodeId : dto.VatCodeId;
                    dto.VatCodeCode = vatCode != null ? vatCode.Code : dto.VatCodeCode;
                }

                var product = ProductManager.GetInvoiceProductByProductNr(io.ProductNr, io.ActorCompanyId);

                if (product == null && miscProduct == null)
                {
                    return new ActionResult(null, GetText(9144, "Ingen ströartikel hittad på företaget"));
                }
                else if (product == null && miscProduct != null)
                {
                    // Use misc product
                    dto.ProductId = miscProduct.ProductId;
                }
                else if (product != null)
                {
                    dto.ProductId = product.ProductId;
                }

                #region Decide dim accountids

                var c1 = !string.IsNullOrEmpty(io.AccountNr);
                var c2 = !string.IsNullOrEmpty(io.AccountDim2Nr);
                var c3 = !string.IsNullOrEmpty(io.AccountDim3Nr);
                var c4 = !string.IsNullOrEmpty(io.AccountDim4Nr);
                var c5 = !string.IsNullOrEmpty(io.AccountDim5Nr);
                var c6 = !string.IsNullOrEmpty(io.AccountDim6Nr);

                if (c1 || c2 || c3 || c4 || c5 || c6)
                {
                    var accountRowDTO = new AccountingRowDTO();

                    if (c1)
                    {
                        Account accountStd = accounts.FirstOrDefault(a => a.AccountNr == io.AccountNr && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD);
                        if (accountStd != null)
                            accountRowDTO.Dim1Id = accountStd.AccountId;
                    }

                    if (c2)
                    {
                        Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim2Nr && a.AccountDim.AccountDimNr == 2);
                        if (account != null)
                            accountRowDTO.Dim2Id = account.AccountId;
                    }

                    if (c3)
                    {
                        Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim3Nr && a.AccountDim.AccountDimNr == 3);
                        if (account != null)
                            accountRowDTO.Dim3Id = account.AccountId;
                    }
                    if (c4)
                    {
                        Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim4Nr && a.AccountDim.AccountDimNr == 4);
                        if (account != null)
                            accountRowDTO.Dim4Id = account.AccountId;
                    }
                    if (c5)
                    {
                        Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim5Nr && a.AccountDim.AccountDimNr == 5);
                        if (account != null)
                            accountRowDTO.Dim5Id = account.AccountId;
                    }
                    if (c6)
                    {
                        Account account = accounts.FirstOrDefault(a => a.AccountNr == io.AccountDim6Nr && a.AccountDim.AccountDimNr == 6);
                        if (account != null)
                            accountRowDTO.Dim6Id = account.AccountId;
                    }

                    if (dto.AccountingRows == null)
                        dto.AccountingRows = new List<AccountingRowDTO>();

                    dto.AccountingRows.Add(accountRowDTO);
                }
                #endregion

                productRows.Add(dto);
            }

            return result;
        }

        public ActionResult ConvertToCustomerLedgerSaveDTO(CustomerInvoice invoice, ref CustomerLedgerSaveDTO invoiceDto)
        {
            #region CustomerInvoiceSaveDTO

            invoiceDto = new CustomerLedgerSaveDTO()
            {
                InvoiceId = invoice.InvoiceId,
            };

            #region Origin

            invoiceDto.OriginStatus = (SoeOriginStatus)invoice.Origin.Status;
            invoiceDto.InvoiceText = invoice.InvoiceText;
            invoiceDto.OriginDescription = invoice.Origin.Description;

            //Set FK
            invoiceDto.VoucherSeriesId = invoice.Origin.VoucherSeriesId;
            invoiceDto.VoucherSeriesTypeId = invoice.Origin.VoucherSeriesTypeId;

            #endregion

            #region Invoice

            invoiceDto.InvoiceNr = invoice.InvoiceNr;
            invoiceDto.ActorId = invoice.ActorId.HasValue ? invoice.ActorId.Value : 0;
            invoiceDto.BillingType = (TermGroup_BillingType)invoice.BillingType;

            invoiceDto.InvoiceDate = invoice.InvoiceDate;
            invoiceDto.VatType = (TermGroup_InvoiceVatType)invoice.VatType;
            invoiceDto.ReferenceOur = invoice.ReferenceOur;
            invoiceDto.CurrencyDate = invoice.CurrencyDate;
            invoiceDto.CurrencyRate = invoice.CurrencyRate;
            invoiceDto.FullyPayed = invoice.FullyPayed;

            invoiceDto.SeqNr = invoice.SeqNr;
            invoiceDto.OCR = invoice.OCR;
            invoiceDto.DueDate = invoice.DueDate;
            invoiceDto.VoucherDate = invoice.VoucherDate;
            invoiceDto.SysPaymentTypeId = invoice.SysPaymentTypeId;
            invoiceDto.PaymentNr = invoice.PaymentNr;

            //Set FK
            invoiceDto.CurrencyId = invoice.CurrencyId;

            #endregion

            //Amounts
            invoiceDto.VatAmount = invoice.VATAmount;
            invoiceDto.VatAmountCurrency = invoice.VATAmountCurrency;

            invoiceDto.CentRounding = invoice.CentRounding;

            invoiceDto.TotalAmount = invoice.TotalAmount;
            invoiceDto.TotalAmountCurrency = invoice.TotalAmountCurrency;


            invoiceDto.FreightAmount = invoice.FreightAmount;
            invoiceDto.FreightAmountCurrency = invoice.FreightAmountCurrency;

            invoiceDto.InvoiceFee = invoice.InvoiceFee;
            invoiceDto.InvoiceFeeCurrency = invoice.InvoiceFeeCurrency;

            invoiceDto.SumAmount = invoice.SumAmount;
            invoiceDto.SumAmountCurrency = invoice.SumAmountCurrency;

            invoiceDto.PaidAmount = invoice.PaidAmount;
            invoiceDto.PaidAmountCurrency = invoice.PaidAmountCurrency;
            invoiceDto.MarginalIncome = invoice.MarginalIncome;
            invoiceDto.MarginalIncomeCurrency = invoice.MarginalIncomeCurrency;
            invoiceDto.MarginalIncomeRatio = invoice.MarginalIncomeRatio.HasValue ? invoice.MarginalIncomeRatio.Value : 0;

            #endregion

            invoiceDto.ReferenceYour = invoice.ReferenceYour;

            return new ActionResult(true);
        }

        public ActionResult ConvertToCustomerLedgerAccountingRowDTO(List<CustomerInvoiceRowIO> ios, List<Account> accounts, List<AccountingRowDTO> accountingRowDTOs, DateTime? voucherDate = null)
        {
            var result = new ActionResult();
            int internalIdCounter = 0;
            Dictionary<int, string> errorList = new Dictionary<int, string>();

            foreach (var io in ios)
            {
                // Add a new row to the collection
                var dto = new AccountingRowDTO
                {
                    Type = AccountingRowType.AccountingRow,
                    InvoiceAccountRowId = 0,
                    TempRowId = ++internalIdCounter,
                    RowNr = ++internalIdCounter,
                    Dim1Id = 0,
                    Dim1Nr = string.Empty,
                    Dim1Name = string.Empty,
                    Dim1Disabled = false,
                    Dim1Mandatory = true,
                    AmountStop = 1,
                    Amount = io.Amount.HasValue ? io.Amount.Value : 0,
                    AmountCurrency = io.AmountCurrency.HasValue ? io.AmountCurrency.Value : 0,
                    Quantity = io.Quantity.HasValue ? io.Quantity.Value : 0,
                    Date = voucherDate ?? DateTime.Today,
                    Balance = 0,
                    IsTemplateRow = false,//how to decide??
                    IsInterimRow = false,//how to decide??                  
                    State = SoeEntityState.Active
                };

                dto.CreditAmount = dto.Amount < 0 ? Math.Abs(dto.Amount) : 0;
                dto.DebitAmount = dto.Amount > 0 ? dto.Amount : 0;
                dto.CreditAmountCurrency = dto.AmountCurrency < 0 ? Math.Abs(dto.AmountCurrency) : 0;
                dto.DebitAmountCurrency = dto.AmountCurrency > 0 ? dto.AmountCurrency : 0;
                dto.IsCreditRow = dto.CreditAmount > 0;
                dto.IsDebitRow = dto.DebitAmount > 0;
                dto.IsVatRow = false;                       //how to decide??
                dto.IsContractorVatRow = false;             //how to decide??
                dto.IsCentRoundingRow = false;              //how to decide??
                dto.IsHouseholdRow = false;                 //how to decide??
                dto.IsClaimRow = false;                     //how to decide??

                #region Decide dim accountids

                if (!string.IsNullOrEmpty(io.AccountNr))
                {
                    Account accountStd = accounts.FirstOrDefault(a => a.AccountNr.Trim() == io.AccountNr.Trim() && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD);
                    if (accountStd != null)
                    {
                        dto.Dim1Id = accountStd.AccountId;
                        dto.Dim1Nr = accountStd.AccountNr;
                    }
                    else
                        return new ActionResult(false, 5540, GetText(5540, "Konto saknas i kontoplan") + ": " + io.AccountNr);
                }

                if (!string.IsNullOrEmpty(io.AccountDim2Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr.Trim() == io.AccountDim2Nr.Trim() && a.AccountDim.AccountDimNr == 2);
                    if (account != null)
                    {
                        dto.Dim2Id = account.AccountId;
                        dto.Dim2Nr = account.AccountNr;
                    }
                    else
                    {
                        if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                        {
                            errorList.Add(io.CustomerInvoiceRowIOId, GetText(4874, "Internkonto saknas") + ": " + io.AccountDim2Nr);
                        }
                    }

                }

                if (!string.IsNullOrEmpty(io.AccountDim3Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr.Trim() == io.AccountDim3Nr.Trim() && a.AccountDim.AccountDimNr == 3);
                    if (account != null)
                    {
                        dto.Dim3Id = account.AccountId;
                        dto.Dim3Nr = account.AccountNr;
                    }
                    else
                    {
                        if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                        {
                            errorList.Add(io.CustomerInvoiceRowIOId, GetText(4874, "Internkonto saknas") + ": " + io.AccountDim3Nr);
                        }
                    }
                }
                if (!string.IsNullOrEmpty(io.AccountDim4Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr.Trim() == io.AccountDim4Nr.Trim() && a.AccountDim.AccountDimNr == 4);
                    if (account != null)
                    {
                        dto.Dim4Id = account.AccountId;
                        dto.Dim4Nr = account.AccountNr;
                    }
                    else
                    {
                        if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                        {
                            errorList.Add(io.CustomerInvoiceRowIOId, GetText(4874, "Internkonto saknas") + ": " + io.AccountDim4Nr);
                        }
                    }
                }
                if (!string.IsNullOrEmpty(io.AccountDim5Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr.Trim() == io.AccountDim5Nr.Trim() && a.AccountDim.AccountDimNr == 5);
                    if (account != null)
                    {
                        dto.Dim5Id = account.AccountId;
                        dto.Dim5Nr = account.AccountNr;
                    }
                    else
                    {
                        if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                        {
                            errorList.Add(io.CustomerInvoiceRowIOId, GetText(4874, "Internkonto saknas") + ": " + io.AccountDim5Nr);
                        }
                    }
                }
                if (!string.IsNullOrEmpty(io.AccountDim6Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr.Trim() == io.AccountDim6Nr.Trim() && a.AccountDim.AccountDimNr == 6);
                    if (account != null)
                    {
                        dto.Dim6Id = account.AccountId;
                        dto.Dim6Nr = account.AccountNr;
                    }
                    else
                    {
                        if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                        {
                            errorList.Add(io.CustomerInvoiceRowIOId, GetText(4874, "Internkonto saknas") + ": " + io.AccountDim6Nr);
                        }
                    }
                }
                #endregion

                accountingRowDTOs.Add(dto);
            }

            result.StrDict = errorList;
            if (errorList.Count > 0)
            {
                result.Success = false;
            }
            return result;
        }

        public ActionResult ConvertToCustomerLedgerCombinedAccountingRowDTO(List<CustomerInvoiceRowIO> ios, List<Account> accounts, List<AccountingRowDTO> accountingRowDTOs, DateTime? voucherDate = null)
        {
            ActionResult result = new ActionResult();
            int internalIdCounter = 0;
            decimal amount = 0, amountCurrency = 0, quantity = 0;
            string accountNr = string.Empty, accountDim2Nr = string.Empty;
            Dictionary<int, string> errorList = new Dictionary<int, string>();

            var ioGroups = ios.GroupBy(i => new { i.AccountNr, i.AccountDim2Nr }).ToList();

            foreach (var ioGroup in ioGroups)
            {
                amount = amountCurrency = 0;

                foreach (var io in ioGroup)
                {
                    amount += io.Amount.HasValue ? io.Amount.Value : 0;
                    amountCurrency += io.AmountCurrency.HasValue ? io.AmountCurrency.Value : 0;
                    quantity += io.Quantity.HasValue ? io.Quantity.Value : 0;
                    accountNr = io.AccountNr;
                    accountDim2Nr = io.AccountDim2Nr;
                }

                // Add a new row to the collection
                AccountingRowDTO dto = new AccountingRowDTO()
                {
                    Type = AccountingRowType.AccountingRow,
                    InvoiceAccountRowId = 0,
                    TempRowId = ++internalIdCounter,
                    RowNr = ++internalIdCounter,
                    Dim1Id = 0,
                    Dim1Nr = String.Empty,
                    Dim1Name = String.Empty,
                    Dim1Disabled = false,
                    Dim1Mandatory = true,
                    AmountStop = 1,
                    Amount = amount,
                    AmountCurrency = amountCurrency,
                    Quantity = quantity,
                    Date = voucherDate ?? DateTime.Today,
                    Balance = 0,
                    IsTemplateRow = false,//how to decide??
                    IsInterimRow = false,//how to decide??                  
                    State = SoeEntityState.Active
                };

                dto.CreditAmount = dto.Amount < 0 ? Math.Abs(dto.Amount) : 0;
                dto.DebitAmount = dto.Amount > 0 ? dto.Amount : 0;
                dto.CreditAmountCurrency = dto.AmountCurrency < 0 ? Math.Abs(dto.AmountCurrency) : 0;
                dto.DebitAmountCurrency = dto.AmountCurrency > 0 ? dto.AmountCurrency : 0;
                dto.IsCreditRow = dto.CreditAmount > 0;
                dto.IsDebitRow = dto.DebitAmount > 0;
                dto.IsVatRow = false;                       //how to decide??
                dto.IsContractorVatRow = false;             //how to decide??
                dto.IsCentRoundingRow = false;              //how to decide??
                dto.IsHouseholdRow = false;                 //how to decide??
                dto.IsClaimRow = false;                     //how to decide??

                #region Decide dim accountids

                if (!string.IsNullOrEmpty(accountNr))
                {
                    Account accountStd = accounts.FirstOrDefault(a => a.AccountNr == accountNr && a.AccountDim.AccountDimNr == Constants.ACCOUNTDIM_STANDARD);
                    if (accountStd != null)
                    {
                        dto.Dim1Id = accountStd.AccountId;
                        dto.Dim1Nr = accountStd.AccountNr;
                    }
                    else
                    {
                        foreach (var io in ioGroup)
                        {
                            if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                            {
                                errorList.Add(io.CustomerInvoiceRowIOId, GetText(5540, "Konto saknas i kontoplan") + ": " + accountNr);
                            }
                        }
                    }
                }

                if (!string.IsNullOrEmpty(accountDim2Nr))
                {
                    Account account = accounts.FirstOrDefault(a => a.AccountNr == accountDim2Nr && a.AccountDim.AccountDimNr == 2);
                    if (account != null)
                    {
                        dto.Dim2Id = account.AccountId;
                        dto.Dim2Nr = account.AccountNr;
                    }
                    else
                        foreach (var io in ioGroup)
                        {
                            if (!errorList.ContainsKey(io.CustomerInvoiceRowIOId))
                            {
                                errorList.Add(io.CustomerInvoiceRowIOId, GetText(4874, "Internkonto saknas") + ": " + accountDim2Nr);
                            }
                        }
                }

                #endregion

                accountingRowDTOs.Add(dto);
            }

            result.StrDict = errorList;
            if (errorList.Count > 0)
                result.Success = false;

            return result;
        }

        public void SetCustomerInvoiceDateAndDueDateIfMissing(CompEntities entities, CustomerInvoice invoice, int actorCompanyId, PaymentCondition paymentCondition = null, DateTime? invoiceDate = null, DateTime? dueDate = null)
        {
            if (invoice == null)
                return;

            #region InvoiceDate

            if (!invoice.InvoiceDate.HasValue)
            {
                invoice.InvoiceDate = invoiceDate.HasValue ? invoiceDate.Value : DateTime.Now.Date;
                invoice.DueDate = null;
            }
            else if (invoiceDate.HasValue)
            {
                invoice.InvoiceDate = invoiceDate;
            }

            #endregion

            #region DueDate


            /*  
                * Payment condition prio:
                1) Date from parameter
                2) PaymentCondition from parameter
                3) PaymentCondition from Invoice
                4) PaymentCondition from setting
                5) Default
            */

            if (dueDate.HasValue)
            {
                //1
                invoice.DueDate = dueDate.Value;

                //Check if invoicedate is after duedate
                if (invoice.InvoiceDate != null && invoice.DueDate != null && invoice.InvoiceDate > invoice.DueDate)
                {
                    if (dueDate.HasValue && dueDate.Value > invoice.InvoiceDate)
                    {
                        //1
                        invoice.DueDate = dueDate.Value;
                    }
                    else
                    {
                        //2
                        if (paymentCondition == null)
                        {
                            if (!invoice.PaymentConditionReference.IsLoaded)
                                invoice.PaymentConditionReference.Load();

                            //3
                            paymentCondition = invoice.PaymentCondition;
                            if (paymentCondition == null)
                            {
                                //4
                                int defaultCustomerPaymentCondition = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerPaymentDefaultPaymentCondition, 0, actorCompanyId, 0);
                                if (defaultCustomerPaymentCondition > 0)
                                    paymentCondition = PaymentManager.GetPaymentCondition(entities, defaultCustomerPaymentCondition, actorCompanyId);
                            }
                        }

                        //5
                        if (paymentCondition != null)
                        {
                            var startDate = paymentCondition.StartOfNextMonth ?
                                CalendarUtility.GetFirstDateOfNextMonth(invoice.InvoiceDate) :
                                invoice.InvoiceDate.Value;
                            invoice.DueDate = startDate.AddDays(paymentCondition.Days);
                        }
                        else
                            invoice.DueDate = invoice.InvoiceDate.Value.AddDays(30);
                    }
                }
            }
            else
            {
                //2
                if (paymentCondition == null)
                {
                    if (!invoice.PaymentConditionReference.IsLoaded)
                        invoice.PaymentConditionReference.Load();

                    //3
                    paymentCondition = invoice.PaymentCondition;
                    if (paymentCondition == null)
                    {
                        //4
                        int defaultCustomerPaymentCondition = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerPaymentDefaultPaymentCondition, 0, actorCompanyId, 0);
                        if (defaultCustomerPaymentCondition > 0)
                            paymentCondition = PaymentManager.GetPaymentCondition(entities, defaultCustomerPaymentCondition, actorCompanyId);
                    }
                }

                //5
                if (paymentCondition != null)
                {
                    var startDate = paymentCondition.StartOfNextMonth ?
                        CalendarUtility.GetFirstDateOfNextMonth(invoice.InvoiceDate) :
                        invoice.InvoiceDate.Value;
                    invoice.DueDate = startDate.AddDays(paymentCondition.Days);
                }
                else
                    invoice.DueDate = invoice.InvoiceDate.Value.AddDays(30);
            }

            #endregion
        }

        //Create ocr was missing when status changed through grid button
        public void SetCustomerInvoiceOcrIfMissing(CompEntities entities, CustomerInvoice invoice, int actorCompanyId)
        {
            if (invoice == null)
                return;

            if (!invoice.ManuallyAdjustedAccounting && invoice.SeqNr != 0 && SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormReferenceNumberToOCR, 0, actorCompanyId, 0))
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);

                if (company != null && company.SysCountryId != null)
                {
                    switch ((int)company.SysCountryId)
                    {
                        case 2: //US
                            break;
                        case 3: //Finland
                            if (invoice.InvoiceNr != null && invoice.Actor.Customer.CustomerNr != null)
                            {
                                string tmpReference = invoice.Actor.Customer.CustomerNr.ToString() + "0000" + invoice.InvoiceNr.ToString();
                                if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, actorCompanyId, 0))
                                {
                                    invoice.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                }
                                else
                                {
                                    invoice.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                }

                            }
                            else
                            {
                                string errorCheck = "";
                                if (invoice.InvoiceNr == null) errorCheck += "A=null";
                                if (invoice.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                invoice.OCR = "Virhe(2):" + errorCheck;

                            }
                            break;
                        case 4: //Norge
                            if (invoice.InvoiceNr != null && invoice.Actor.Customer.CustomerNr != null)
                            {
                                invoice.OCR = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), invoice.Actor.Customer.CustomerNr.ToString(), (DateTime)invoice.InvoiceDate, 0);
                            }
                            break;
                        default: //Sverige
                            invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoice.InvoiceId.ToString() + invoice.SeqNr.ToString());
                            break;
                    }
                }
                else
                {
                    //Svenskt
                    invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoice.InvoiceId.ToString() + invoice.SeqNr.ToString());
                }
            }
        }


        /// <summary>
        /// 
        /// </summary>
        /// <param name="actorCompanyId"></param>
        /// <param name="userId"></param>
        /// <param name="orderId"></param>
        /// <param name="rowId"></param>
        /// <param name="productId"></param>
        /// <param name="roleId"></param>
        /// <param name="quantity"></param>
        /// <param name="amount"></param>
        /// <param name="text"></param>
        /// <returns></returns>
        public ActionResult SaveOrderRowFromSupplierInvoice(
            TransactionScope transaction,
            CompEntities entities,
            SupplierInvoice invoice,
            List<SupplierInvoiceOrderRowDTO> rows,
            int actorCompanyId,
            int roleId,
            string rowDescription,
            bool voucherDateChanged = false,
            bool fromApp = false,
            bool isCostAllocation = false,
            bool skipAmountRecalculation = false,
            bool fromBaseCurrency = false)
        {
            ActionResult result = new ActionResult();
            List<int> orderIds = new List<int>();
            int lastCustomerInvoiceRowId = 0;

            #region Init

            if (invoice == null)
            {
                var invoiceId = rows.Select(i => i.SupplierInvoiceId).Distinct().FirstOrDefault();
                if (invoiceId > 0)
                {
                    invoice = SupplierInvoiceManager.GetSupplierInvoice(entities, invoiceId);
                }
            }

            #endregion

            bool autoCreateDateOnProductRows = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingAutoCreateDateOnProductRows, base.UserId, base.ActorCompanyId, 0);

            InvoiceProduct miscProduct = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductMisc, actorCompanyId);
            if (miscProduct == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "InvoiceProduct");

            foreach (SupplierInvoiceOrderRowDTO row in rows)
            {
                #region Prereq

                CustomerInvoice order = InvoiceManager.GetCustomerInvoiceByType(
                    entities,
                    row.CustomerInvoiceId,
                    SoeOriginType.Order,
                    OrderInvoiceRegistrationType.Order,
                    actorCompanyId,
                    loadInvoiceRow: true,
                    loadInvoiceAccountRow: true,
                    loadProject: true);
                if (order == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                Customer customer = CustomerManager.GetCustomer(entities, order.ActorId.Value);
                if (customer == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "Customer");

                #endregion

                if (row.State == SoeEntityState.Deleted)
                {

                    //supplierInvoice.OriginInvoiceMapping.Remove(oimap);
                    result = DeleteCustomerInvoiceRow(transaction, entities, actorCompanyId, order.InvoiceId, row.CustomerInvoiceRowId, saveChanges: fromApp);
                    if (result.Success)
                    {
                        OriginInvoiceMapping oimap = (from a in entities.OriginInvoiceMapping
                                                      where a.InvoiceId == row.SupplierInvoiceId &&
                                                      a.OriginId == order.InvoiceId &&
                                                      a.Type == (int)SoeOriginType.SupplierInvoice
                                                      select a).FirstOrDefault();

                        if (oimap != null)
                        {
                            if (oimap.EntityState == EntityState.Detached)
                                entities.Attach(oimap);
                            entities.DeleteObject(oimap);
                        }
                    }
                }
                else
                {
                    if (row.SupplementCharge == 0 && order.PriceListTypeId.HasValue && !skipAmountRecalculation)
                    {
                        decimal naiveMarkup = 1 + PriceRuleManager.GetMarkupNaive(entities, actorCompanyId, order.PriceListTypeId.Value);
                        row.SumAmountCurrency = row.AmountCurrency * naiveMarkup;
                        row.SumAmount = row.Amount * naiveMarkup;
                    }
                    DateTime? customerInvoiceRowDate = null;

                    if (autoCreateDateOnProductRows)
                    {
                        customerInvoiceRowDate = invoice?.VoucherDate;
                    }
                    else
                    {
                        customerInvoiceRowDate = invoice?.InvoiceDate;
                    }

                    decimal? amountCurrencyInput = null;
                    decimal? amountInput = null;

                    if (fromBaseCurrency)
                    {
                        amountInput = row.SumAmount;
                    }
                    else
                    {
                        amountCurrencyInput = row.SumAmountCurrency;
                    }


                    result = SaveCustomerInvoiceRow(
                        transaction: transaction,
                        entities: entities,
                        actorCompanyId: actorCompanyId,
                        order: order,
                        orderRowId: row.CustomerInvoiceRowId,
                        productId: row.InvoiceProductId != 0 ? row.InvoiceProductId : miscProduct.ProductId,
                        quantity: 1,
                        amountCurrencyInput: amountCurrencyInput,
                        textRowText: isCostAllocation ? row.InvoiceProductName : String.Empty,
                        rowtype: SoeInvoiceRowType.ProductRow,
                        supplierInvoiceId: row.SupplierInvoiceId,
                        rowDescription: rowDescription,
                        productPurchasePrice: row.Amount,
                        includeSupplierInvoiceImage: row.IncludeSupplierInvoiceImage,
                        dcPercentAndAmount: true,
                        productRowType: SoeProductRowType.FromSupplierInvoice,
                        customerInvoiceRowDate: customerInvoiceRowDate,
                        setDateIfExisting: voucherDateChanged,
                        isCostAllocation: isCostAllocation,
                        amountInput: amountInput);


                    if (result.Success)
                    {
                        lastCustomerInvoiceRowId = result.IntegerValue;
                        OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                        {
                            OriginId = order.InvoiceId,
                            Type = (int)SoeOriginType.SupplierInvoice,
                            InvoiceId = row.SupplierInvoiceId
                        };

                        entities.OriginInvoiceMapping.AddObject(oimap);

                        if (!orderIds.Contains(order.InvoiceId))
                            orderIds.Add(order.InvoiceId);
                    }

                    if (!result.Success)
                        return result;
                }
            }

            result.Value = orderIds;
            result.IntegerValue = lastCustomerInvoiceRowId;

            return result;
        }

        /// <summary>
        /// Only used from mobile
        /// </summary>
        /// <param name="actorCompanyId"></param>
        /// <param name="orderId"></param>
        /// <param name="rowId"></param>
        /// <param name="productId"></param>
        /// <param name="roleId"></param>
        /// <param name="quantity"></param>
        /// <param name="amount"></param>
        /// <param name="text"></param>
        /// <returns></returns>
        public ActionResult SaveOrderRow(int actorCompanyId, int orderId, int rowId, int productId, int roleId, decimal quantity, decimal amountCurrency, string text, decimal quantityToInvoice, int stockId, string extraTextRow)
        {
            ActionResult result = new ActionResult();

            #region Init

            int newOrUpdatedOrderRowId = 0;
            object newOrUpdatedOrderRow = null;

            #endregion

            using (CompEntities entities = new CompEntities())
            {

                try
                {
                    entities.Connection.Open();

                    InitializeAttestStateIds(entities, actorCompanyId);

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        CustomerInvoice order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: true);
                        if (order == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                        var customer = CustomerManager.GetCustomerSmall(entities, order.ActorId.Value);
                        if (customer == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "Customer");

                        #endregion

                        SetModifiedProperties(order);
                        SoeInvoiceRowType rowtype = (productId > 0) ? SoeInvoiceRowType.ProductRow : SoeInvoiceRowType.TextRow;

                        //save current order rows so stock handling will know which rows are new....
                        var stockDict = new Dictionary<int, Tuple<decimal, decimal, bool, int, int, int>>();
                        if (rowtype == SoeInvoiceRowType.ProductRow)
                        {
                            foreach (var row in order.ActiveCustomerInvoiceRows)
                            {
                                stockDict.Add(row.CustomerInvoiceRowId, CreateInvoiceRowStockInfo(row));
                            }
                        }

                        result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, rowId, productId, quantity, amountCurrency, text, rowtype, quantityToInvoice: quantityToInvoice, stockId: stockId);
                        if (result.Success && rowtype == SoeInvoiceRowType.ProductRow)
                        {
                            HandleStockOnInvoice(order, entities, transaction, actorCompanyId, stockDict, true, false);
                        }

                        newOrUpdatedOrderRowId = result.IntegerValue;
                        newOrUpdatedOrderRow = result.Value;

                        #region Fixed Price
                        if (result.Success)
                        {
                            int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                            if (fixedPriceProductId == productId)
                            {
                                result = UpdateOrderDueToAddedFixedPriceProduct(entities, transaction, order, fixedPriceProductId, actorCompanyId);
                            }
                        }
                        #endregion

                        if (result.Success && rowtype == SoeInvoiceRowType.ProductRow && rowId <= 0 && newOrUpdatedOrderRowId > 0 && !extraTextRow.IsNullOrEmpty())
                        {
                            result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, 0, 0, 0, extraTextRow, SoeInvoiceRowType.TextRow, quantityToInvoice: 0, stockId: 0, parentRowId: newOrUpdatedOrderRowId);
                        }

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = newOrUpdatedOrderRowId;
                        result.Value = newOrUpdatedOrderRow;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
                return result;
            }
        }

        private ActionResult UpdateOrderDueToAddedFixedPriceProduct(CompEntities entities, TransactionScope transaction, CustomerInvoice order, int fixedPriceProductId, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            order.FixedPriceOrder = true;
            //set all rows to zero due to flatprice
            foreach (var row in order.ActiveCustomerInvoiceRows)
            {
                if (row.Type != (int)SoeInvoiceRowType.ProductRow || !row.ProductId.HasValue || !row.Quantity.HasValue || row.ProductId.Value == fixedPriceProductId)
                    continue;

                if (!row.ProductReference.IsLoaded)
                    row.ProductReference.Load();

                if (((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                    continue;

                result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, row.CustomerInvoiceRowId, row.ProductId.Value, row.Quantity.Value, 0, row.Text, (SoeInvoiceRowType)row.Type, null, row.ProductUnitId, true, false, row.IsInvoiceFeeRow, row.IsTimeProjectRow);
                if (!result.Success)
                    break;
            }

            if (result.Success)
                result = SaveChanges(entities, transaction);

            return result;
        }

        public ActionResult CreateInvoiceFee(TransactionScope transaction, CompEntities entities, int actorCompanyId, CustomerInvoice order, bool updateInvoice = true)
        {
            ActionResult result = new ActionResult(true);

            if (!order.ActorReference.IsLoaded)
                order.ActorReference.Load();

            if (order.Actor != null && !order.Actor.CustomerReference.IsLoaded)
                order.Actor.CustomerReference.Load();

            if (order.Actor == null || order.Actor.Customer == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "Customer");


            bool customerDisableInvoiceFee = order.Actor.Customer.DisableInvoiceFee;

            if (!customerDisableInvoiceFee || order.InvoiceFeeCurrency != 0)
            {
                // Invoice fee product
                bool useInvoiceFee = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseInvoiceFee, 0, actorCompanyId, 0);

                if (!useInvoiceFee && order.InvoiceFeeCurrency != 0)
                    useInvoiceFee = true;

                if (useInvoiceFee)
                {
                    int invoiceFeeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductInvoiceFee, 0, actorCompanyId, 0);

                    // Add/Update product row
                    decimal invoiceFeeCurrency = 0;
                    if (order.PriceListTypeId.HasValue && invoiceFeeProductId > 0)
                    {
                        if (order.InvoiceFeeCurrency == 0)
                            invoiceFeeCurrency = ProductManager.GetProductPriceDecimal(entities, invoiceFeeProductId, order.PriceListTypeId.Value);
                        else
                            invoiceFeeCurrency = order.InvoiceFeeCurrency;
                    }

                    SoeInvoiceRowType rowType = invoiceFeeCurrency != 0 ? SoeInvoiceRowType.BaseProductRow : SoeInvoiceRowType.AccountingRow;
                    CustomerInvoiceRow rowItem = order.ActiveCustomerInvoiceRows.FirstOrDefault(r => r.IsInvoiceFeeRow);
                    if (invoiceFeeCurrency != 0 && rowItem == null)
                    {
                        AttestStateDTO initialAttestState = AttestManager.GetInitialAttestState(entities, actorCompanyId, TermGroup_AttestEntity.Order).ToDTO();
                        if (initialAttestState != null)
                        {
                            result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, invoiceFeeProductId, 1, invoiceFeeCurrency, "", SoeInvoiceRowType.BaseProductRow, null, null, updateInvoice, true, true);
                        }
                        else
                            result = new ActionResult((int)ActionResultSave.EntityIsNull, "initialAttestState");
                    }
                }
            }

            return result;
        }

        public ActionResult CreateInvoiceFreight(TransactionScope transaction, CompEntities entities, int actorCompanyId, CustomerInvoice order, bool updateInvoice = true)
        {
            ActionResult result = new ActionResult(true);

            if (!order.ActorReference.IsLoaded)
                order.ActorReference.Load();

            if (order.Actor != null && !order.Actor.CustomerReference.IsLoaded)
                order.Actor.CustomerReference.Load();

            if (order.Actor == null || order.Actor.Customer == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "Customer");

            // Invoice freight product
            bool useInvoiceFreightAmount = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseFreightAmount, 0, actorCompanyId, 0);

            if (useInvoiceFreightAmount || order.FreightAmountCurrency != 0)
            {
                int invoiceFreightAmountProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFreight, 0, actorCompanyId, 0);

                // Add/Update product row
                decimal invoiceFreightAmountCurrency = 0;
                if (order.PriceListTypeId.HasValue && invoiceFreightAmountProductId > 0)
                {
                    if (order.FreightAmountCurrency == 0)
                        invoiceFreightAmountCurrency = ProductManager.GetProductPriceDecimal(entities, invoiceFreightAmountProductId, order.PriceListTypeId.Value);
                    else
                        invoiceFreightAmountCurrency = order.FreightAmountCurrency;
                }
                else
                    LogWarning("Either pricelisttypeid is null or invoiceFreightAmountProductId is zero");

                SoeInvoiceRowType rowType = invoiceFreightAmountCurrency != 0 ? SoeInvoiceRowType.BaseProductRow : SoeInvoiceRowType.AccountingRow;
                CustomerInvoiceRow rowItem = order.ActiveCustomerInvoiceRows.FirstOrDefault(r => r.IsFreightAmountRow);
                if (invoiceFreightAmountCurrency != 0 && rowItem == null)
                {
                    result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, invoiceFreightAmountProductId, 1, invoiceFreightAmountCurrency, "", SoeInvoiceRowType.BaseProductRow, isFreightRow: true, updateInvoice: updateInvoice, saveChanges: true);
                }
            }


            return result;
        }

        public ActionResult SaveCustomerInvoiceRow(
            TransactionScope transaction,
            CompEntities entities,
            int actorCompanyId,
            CustomerInvoice order,
            int orderRowId,
            int productId,
            decimal quantity,
            decimal? amountCurrencyInput,
            string textRowText,
            SoeInvoiceRowType rowtype,
            HouseholdTaxDeductionRow houseHoldTaxDeductionRow = null,
            int? productUnitId = null,
            bool updateInvoice = true,
            bool saveChanges = true,
            bool isInvoiceFee = false,
            bool isTimeProjectRow = false,
            bool noTransaction = false,
            decimal? vatAmountCurrency = null,
            decimal? vatRate = null,
            decimal? sumAmountCurr = null,
            int? supplierInvoiceId = null,
            string rowDescription = null,
            decimal? quantityToInvoice = null,
            bool useOriginalVat = false,
            int? vatAccId = null,
            decimal? vatAmount = null,
            decimal? productPurchasePrice = null,
            bool isFreightRow = false,
            string deliveryDateText = null,
            int? stockId = null,
            bool includeSupplierInvoiceImage = false,
            bool dcPercentAndAmount = false,
            SoeProductRowType productRowType = SoeProductRowType.None,
            DateTime? customerInvoiceRowDate = null,
            bool setDateIfExisting = false,
            int? ediEdiEntryId = null,
            string sysWholeSellerName = null,
            bool addQuantityOnAccountingRow = false,
            bool calcVATfromPrice = false,
            int parentRowId = 0,
            bool isCostAllocation = false,
            bool applyPriceFormula = false,
            CustomerInvoiceRow orderRow = null,
            decimal? amountInput = null)
        {
            ActionResult result = new ActionResult();
            int rowsAdded = 0;
            bool isProductRow = productId > 0;
            bool newOrderRow = orderRowId == 0 && orderRow == null;

            InvoiceProduct invoiceProduct = null;

            #region Prereq

            if (!order.ProjectReference.IsLoaded)
                order.ProjectReference.Load();

            if (!order.OriginReference.IsLoaded)
                order.OriginReference.Load();

            int standardMaterialCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStandardMaterialCode, 0, actorCompanyId, 0);
            int defaultInvoiceProductUnitId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultInvoiceProductUnit, 0, actorCompanyId, 0);
            int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, actorCompanyId, 0);
            bool autoCreateDateOnProductRows = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingAutoCreateDateOnProductRows, 0, actorCompanyId, 0);

            if (order.Project != null && standardMaterialCodeId <= 0)
                return new ActionResult((int)ActionResultSave.TimeCodeMaterialStandardMissing, GetText(8423, "Inställning för standard materialkod saknas"));

            this.InitializeAttestStateIds(entities, actorCompanyId);
            int? initialAttestStateId = null;

            switch ((SoeOriginType)order.Origin.Type)
            {
                case SoeOriginType.Order:
                    initialAttestStateId = InvoiceAttestStatesIds.OrderInitialId;
                    break;
                case SoeOriginType.Offer:
                    initialAttestStateId = InvoiceAttestStatesIds.OfferInitialId;
                    break;
            }

            #endregion

            #region InvoiceProduct

            if (isProductRow)
            {
                invoiceProduct = ProductManager.GetInvoiceProduct(entities, productId, true, true, false);
                if (invoiceProduct == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "InvoiceProduct");
            }

            #endregion

            #region Fixed price

            int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);

            bool hasFixedPriceProduct = order.ActiveCustomerInvoiceRows.Any(i => i.ProductId == fixedPriceProductId);

            if ((order.FixedPriceOrder || hasFixedPriceProduct) && fixedPriceProductId != productId)
            {
                amountCurrencyInput = 0;
                amountInput = 0;
            }


            #endregion

            #region Decide RowNrs

            int rowNr = 1;
            int accountRowNr = 2; // Claim row will get number 1

            CalculateNextRowNbrs(order, ref rowNr, ref accountRowNr);

            #endregion

            #region CustomerInvoiceRow

            #region Variables

            string productName = invoiceProduct != null ? invoiceProduct.Name : string.Empty;

            decimal purchasePrice = 0;

            if (productPurchasePrice.HasValue)
            {
                purchasePrice = productPurchasePrice.Value;
            }
            else if (sumAmountCurr.HasValue && amountCurrencyInput.HasValue)
            {
                // not sure this is correct. Need to find this use case.
                purchasePrice = amountCurrencyInput.Value;
            }
            else if (invoiceProduct != null)
            {
                purchasePrice = invoiceProduct.PurchasePrice;
            }

            decimal purchasePriceCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(purchasePrice, order.CurrencyRate);

            decimal sumAmountCurrency = 0;
            decimal sumAmount = 0;
            if (sumAmountCurr.HasValue)
            {
                sumAmountCurrency = sumAmountCurr.Value;
                sumAmount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(sumAmountCurrency, order.CurrencyRate);
            }
            else if (amountCurrencyInput.HasValue)
            {
                sumAmountCurrency = Math.Round(amountCurrencyInput.Value * quantity, 2);
                sumAmount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(sumAmountCurrency, order.CurrencyRate);
            }
            else if (amountInput.HasValue)
            {
                sumAmount = Math.Round(amountInput.Value * quantity, 2);
                sumAmountCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(sumAmount, order.CurrencyRate);
            }

            decimal amount = 0;
            decimal amountCurrency = 0;

            if (amountCurrencyInput.HasValue)
            {
                amountCurrency = decimal.Round(amountCurrencyInput.Value, 4);
                amount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(amountCurrency, order.CurrencyRate, 4);
            }
            else if (amountInput.HasValue)
            {
                amount = decimal.Round(amountInput.Value, 4);
                amountCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(amount, order.CurrencyRate, 4);
            }

            decimal discountPercent = 0;
            decimal discount2Percent = 0;
            if (invoiceProduct != null && order.Actor?.Customer != null && !invoiceProduct.DontUseDiscountPercent.GetValueOrDefault())
            {
                if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseProductGroupCustomerCategoryDiscount, 0, actorCompanyId, 0))
                {
                    discountPercent = MarkupManager.GetDiscountByCustomerAndProduct(entities, order.Actor.Customer.ActorCustomerId, invoiceProduct, actorCompanyId) ?? 0;
                }

                if (discountPercent == 0)
                {
                    if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Merchandise)
                        discountPercent = order.Actor.Customer.DiscountMerchandise;
                    else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Service)
                        discountPercent = order.Actor.Customer.DiscountService;
                }
                if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Merchandise)
                    discount2Percent = order.Actor.Customer.Discount2Merchandise;
                else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Service)
                    discount2Percent = order.Actor.Customer.Discount2Service;
            }

            decimal discountAmount = decimal.Round(sumAmount * discountPercent / 100, 2);
            decimal discountAmountCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(discountAmount, order.CurrencyRate);
            decimal discount2Amount = decimal.Round((sumAmount - discountAmount) * discount2Percent / 100, 2);
            decimal discount2AmountCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(discount2Amount, order.CurrencyRate);

            if (discountAmount != 0)
            {
                sumAmount -= (discountAmount + discount2Amount);
                sumAmountCurrency -= (discountAmountCurrency + discount2AmountCurrency);
                if (vatAmount != 0 && vatRate.GetValueOrDefault() != 0)
                {
                    vatAmount = CalculateVatAmountFromVatRate(order.PriceListTypeInclusiveVat, sumAmount, vatRate.GetValueOrDefault());
                }
                if (vatAmountCurrency != 0 && vatRate.GetValueOrDefault() != 0)
                {
                    vatAmountCurrency = CalculateVatAmountFromVatRate(order.PriceListTypeInclusiveVat, sumAmountCurrency, vatRate.GetValueOrDefault());
                }
            }

            decimal salesAmount = sumAmount;
            decimal marginalIncome = salesAmount - (purchasePrice * quantity);
            decimal marginalIncomeCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(marginalIncome, order.CurrencyRate);
            decimal marginalIncomeRatio = (salesAmount != 0 ? marginalIncome / salesAmount : 1) * 100;
            marginalIncomeRatio = CheckMarginalIncomeRatio(marginalIncomeRatio);

            #region UnitCode

            ProductUnit productUnit = null;
            if (isProductRow)
            {
                productUnit = productUnitId.HasValue ? ProductManager.GetProductUnit(entities, productUnitId.Value) : invoiceProduct.ProductUnit;
                if (productUnit == null)
                    productUnit = ProductManager.GetProductUnit(entities, defaultInvoiceProductUnitId);
            }

            #endregion

            #endregion

            if (newOrderRow)
            {
                #region New OrderRow

                if (rowtype == SoeInvoiceRowType.BaseProductRow || rowtype == SoeInvoiceRowType.ProductRow)
                {
                    #region ProductRow

                    var text = string.Empty;
                    if (isCostAllocation)
                        text = textRowText + rowDescription;
                    else
                        text = !string.IsNullOrEmpty(textRowText) ? textRowText : (rowDescription != null ? productName + rowDescription : productName);

                    orderRow = new CustomerInvoiceRow
                    {
                        RowNr = rowNr,
                        Type = (int)rowtype,
                        Amount = amount,
                        AmountCurrency = amountCurrency,
                        Quantity = quantity,
                        DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                        DiscountPercent = decimal.Round(discountPercent, 2),
                        DiscountAmount = decimal.Round(discountAmount, 2),
                        DiscountAmountCurrency = decimal.Round(discountAmountCurrency, 2),
                        Discount2Type = (int)SoeInvoiceRowDiscountType.Percent,
                        Discount2Percent = decimal.Round(discount2Percent, 2),
                        Discount2Amount = decimal.Round(discount2Amount, 2),
                        Discount2AmountCurrency = decimal.Round(discount2AmountCurrency, 2),
                        SumAmount = decimal.Round(sumAmount, 2),
                        SumAmountCurrency = decimal.Round(sumAmountCurrency, 2),
                        PurchasePrice = decimal.Round(purchasePrice, 2),
                        PurchasePriceCurrency = decimal.Round(purchasePriceCurrency, 2),
                        SysWholesellerName = string.IsNullOrEmpty(sysWholeSellerName) ? invoiceProduct.SysWholesellerName : sysWholeSellerName,
                        MarginalIncome = decimal.Round(marginalIncome, 2),
                        MarginalIncomeCurrency = decimal.Round(marginalIncomeCurrency, 2),
                        MarginalIncomeRatio = decimal.Round(marginalIncomeRatio, 2),
                        Text = text,
                        IsFreightAmountRow = isFreightRow,
                        IsInvoiceFeeRow = isInvoiceFee,
                        IsCentRoundingRow = false,
                        IsInterestRow = false,
                        IsReminderRow = false,
                        IsTimeProjectRow = isTimeProjectRow,
                        IsStockRow = (stockId.HasValue && stockId > 0),
                        StockId = (stockId.HasValue && stockId > 0) ? stockId : null,
                        EdiEntryId = ediEdiEntryId,
                        InvoiceQuantity = quantityToInvoice,
                        DeliveryDateText = !string.IsNullOrEmpty(deliveryDateText) ? deliveryDateText : string.Empty,
                        IncludeSupplierInvoiceImage = includeSupplierInvoiceImage,
                        ProductRowType = (int)productRowType,
                        Date = customerInvoiceRowDate,
                        //Set FK
                        AttestStateId = initialAttestStateId,

                        //References
                        Product = invoiceProduct,
                        ProductUnit = productUnit,
                    };

                    if (invoiceProduct.HouseholdDeductionType.HasValue)
                        orderRow.HouseholdDeductionType = invoiceProduct.HouseholdDeductionType.Value;
                    else if (defaultHouseholdDeductionType != 0)
                        orderRow.HouseholdDeductionType = defaultHouseholdDeductionType;

                    if (supplierInvoiceId != null && supplierInvoiceId != 0)
                    {
                        SupplierInvoice si = SupplierInvoiceManager.GetSupplierInvoice(entities, (int)supplierInvoiceId);

                        if (si != null)
                            orderRow.SupplierInvoice = si;
                    }

                    SetCreatedProperties(orderRow);

                    if (autoCreateDateOnProductRows && !orderRow.Date.HasValue && !orderRow.IsTimeProjectRow && !orderRow.IsFreightAmountRow && !orderRow.IsInvoiceFeeRow && !orderRow.IsCentRoundingRow && houseHoldTaxDeductionRow == null)
                        orderRow.Date = customerInvoiceRowDate.HasValue ? customerInvoiceRowDate.Value.Date : (orderRow.Created.HasValue ? orderRow.Created.Value.Date : DateTime.Today);


                    rowsAdded++;

                    #endregion

                }
                else if (rowtype == SoeInvoiceRowType.TextRow)
                {
                    #region TextRow

                    orderRow = new CustomerInvoiceRow
                    {
                        RowNr = rowNr,
                        Type = (int)rowtype,
                        Text = textRowText,
                        AttestStateId = initialAttestStateId,
                        ParentRowId = parentRowId > 0 ? parentRowId : (int?)null,
                    };

                    #endregion
                }

                #endregion

                if (order.Project != null && !noTransaction)
                {
                    result = TimeTransactionManager.CreateTimeCodeTransaction(entities, actorCompanyId, orderRow, order.Project, standardMaterialCodeId);
                    if (!result.Success)
                        return result;
                }

                order.CustomerInvoiceRow.Add(orderRow);
            }
            else
            {
                #region Update OrderRow

                orderRow = orderRow == null ? GetCustomerInvoiceRow(entities, orderRowId) : orderRow;
                if (orderRow == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoiceRow");

                if (rowtype == SoeInvoiceRowType.BaseProductRow || rowtype == SoeInvoiceRowType.ProductRow)
                {
                    #region ProductRow

                    SetAccountRowsAsDeleted(orderRow);

                    // orderRow.SumAmountCurrency != amountCurrency need to check this is correct.
                    if (!dcPercentAndAmount || orderRow.DiscountPercent != discountPercent || orderRow.SumAmountCurrency != amountCurrency)
                    {
                        orderRow.Amount = amount;
                        orderRow.AmountCurrency = amountCurrency;
                        orderRow.DiscountPercent = decimal.Round(discountPercent, 2);
                        orderRow.DiscountAmount = decimal.Round(discountAmount, 2);
                        orderRow.DiscountAmountCurrency = decimal.Round(discountAmountCurrency, 2);
                        orderRow.SumAmount = decimal.Round(sumAmount, 2);
                        orderRow.SumAmountCurrency = decimal.Round(sumAmountCurrency, 2);
                        orderRow.PurchasePrice = decimal.Round(purchasePrice, 2);
                        orderRow.PurchasePriceCurrency = decimal.Round(purchasePriceCurrency, 2);
                        orderRow.MarginalIncome = decimal.Round(marginalIncome, 2);
                        orderRow.MarginalIncomeCurrency = decimal.Round(marginalIncomeCurrency, 2);
                        orderRow.MarginalIncomeRatio = decimal.Round(marginalIncomeRatio, 2);
                        orderRow.SysWholesellerName = invoiceProduct.SysWholesellerName;
                    }
                    orderRow.Quantity = quantity;

                    if (isCostAllocation)
                        orderRow.Text = orderRow.ProductId == invoiceProduct.ProductId ? textRowText : textRowText + rowDescription;
                    else
                        orderRow.Text = !string.IsNullOrEmpty(textRowText) ? textRowText : (rowDescription != null ? productName + rowDescription : productName);

                    orderRow.DeliveryDateText = !string.IsNullOrEmpty(deliveryDateText) ? deliveryDateText : string.Empty;
                    orderRow.IncludeSupplierInvoiceImage = includeSupplierInvoiceImage;

                    if (quantityToInvoice.HasValue)
                        orderRow.InvoiceQuantity = quantityToInvoice;

                    if (autoCreateDateOnProductRows && setDateIfExisting && customerInvoiceRowDate.HasValue && !orderRow.IsTimeProjectRow && !orderRow.IsFreightAmountRow && !orderRow.IsInvoiceFeeRow && !orderRow.IsCentRoundingRow && houseHoldTaxDeductionRow == null)
                        orderRow.Date = customerInvoiceRowDate.Value.Date;

                    //Set references
                    orderRow.Product = invoiceProduct;
                    orderRow.ProductUnit = productUnit;

                    SetModifiedProperties(orderRow);

                    #endregion
                }
                else if (rowtype == SoeInvoiceRowType.TextRow)
                {
                    #region TextRow

                    orderRow.Text = textRowText;

                    #endregion
                }

                if (order.Project != null)
                {
                    result = TimeTransactionManager.UpdateTimeCodeTransactions(entities, actorCompanyId, orderRow, order.Project, standardMaterialCodeId);
                    if (!result.Success)
                        return result;
                }

                #endregion
            }

            ConvertProductRowsTextUppercase(entities, new List<CustomerInvoiceRow> { orderRow }, base.ActorCompanyId);

            #region Household

            if (houseHoldTaxDeductionRow != null)
            {
                houseHoldTaxDeductionRow.CustomerInvoiceRow = orderRow;
                orderRow.HouseholdTaxDeductionRow = houseHoldTaxDeductionRow;
            }

            #endregion

            #region VAT account

            if (useOriginalVat && vatAccId != null && vatAmount != null && vatAmountCurrency != null)
            {
                orderRow.VatAccountId = vatAccId;
                orderRow.VatAmountCurrency = vatAmountCurrency.Value;
                orderRow.VatAmount = vatAmount.Value;
                orderRow.VatRate = vatRate.HasValue ? vatRate.Value : 0;
            }
            else
            {
                // Check VAT type
                bool noVAT = (order.VatType == (int)TermGroup_InvoiceVatType.Contractor || order.VatType == (int)TermGroup_InvoiceVatType.NoVat || order.VatType == (int)TermGroup_InvoiceVatType.ExportWithinEU || orderRow.HouseholdTaxDeductionRow != null);
                VatCode vatCode;

                if (invoiceProduct != null && !noVAT)
                {
                    int vatAccountId = 0;
                    int defaultVatCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultVatCode, 0, actorCompanyId, 0);

                    if (defaultVatCodeId != 0)
                    {
                        vatCode = AccountManager.GetVatCode(entities, defaultVatCodeId);
                        orderRow.VatCodeId = vatCode.VatCodeId;
                        orderRow.VatRate = vatCode.Percent;
                        vatAccountId = vatCode.AccountId;
                        vatRate = vatCode.Percent;
                    }

                    if (invoiceProduct.VatCodeId.HasValue)
                    {
                        vatCode = AccountManager.GetVatCode(entities, invoiceProduct.VatCodeId.Value);
                        orderRow.VatCodeId = vatCode.VatCodeId;
                        vatAccountId = vatCode.AccountId;
                        vatRate = vatCode.Percent;
                    }
                    else
                    {
                        AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, invoiceProduct.ProductId, 0, order.ActorId.Value, 0, ProductAccountType.VAT, (TermGroup_InvoiceVatType)order.VatType, false);
                        if (prioDTO != null && prioDTO.AccountId.HasValue)
                            vatAccountId = prioDTO.AccountId.Value;
                    }

                    // Set VAT account
                    orderRow.VatAccountId = vatAccountId;

                    if (vatRate.HasValue)
                    {
                        orderRow.VatRate = vatRate.Value;
                    }
                    else
                    {
                        // Set VAT rate from account
                        decimal vatRateValue = AccountManager.GetVatRateValue(entities, vatAccountId);
                        if (vatRateValue != 0)
                            orderRow.VatRate = vatRateValue;
                    }

                    // Set VAT amount
                    if (vatAmountCurrency.HasValue)
                    {
                        orderRow.VatAmountCurrency = vatAmountCurrency.Value;
                        orderRow.VatAmount = decimal.Round(CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(orderRow.VatAmountCurrency, order.CurrencyRate), 2);
                    }
                    else
                    {
                        if (order.PriceListTypeInclusiveVat && sumAmount != 0 && orderRow.VatRate != 0 && (orderRow.IsInvoiceFeeRow || productRowType == SoeProductRowType.ExpenseRow || calcVATfromPrice)) //Vatamount is included in sumAmount
                            orderRow.VatAmount = decimal.Round(sumAmount - (sumAmount * (1 / (1 + (orderRow.VatRate / 100)))), 2);
                        else
                            orderRow.VatAmount = decimal.Round(sumAmount * (orderRow.VatRate / 100), 2);

                        orderRow.VatAmountCurrency = decimal.Round(CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(orderRow.VatAmount, order.CurrencyRate), 2);
                    }
                }
            }

            #endregion

            #endregion

            if (isProductRow && (invoiceProduct.CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift || order.Origin.Type == (int)SoeOriginType.CustomerInvoice))
            {
                #region CustomerInvoiceAccountRow

                InvoiceManager.CreateCustomerInvoiceAccountRow(entities, order, orderRow, (TermGroup_InvoiceVatType)order.VatType, ref accountRowNr, order.ActorId.Value, 0, order.ProjectId.HasValue ? order.ProjectId.Value : 0, actorCompanyId, addQuantityOnAccountingRow: addQuantityOnAccountingRow);

                #endregion

                #region Update invoice

                if (updateInvoice)
                {
                    int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, order.CurrencyId);
                    int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                    UpdateInvoiceAfterRowModification(entities, order, accountRowNr, actorCompanyId, order.Origin.Type != (int)SoeOriginType.CustomerInvoice, sysCurrencyIdInvoice != sysCurrencyIdBase);
                }

                #endregion
            }

            #region Order Status

            if (order.Status == (int)SoeOriginStatus.OrderFullyInvoice && rowsAdded > 0)
                order.Status = (int)SoeOriginStatus.OrderPartlyInvoice;

            #endregion

            #region Save

            if (saveChanges)
            {
                result = SaveChanges(entities, transaction);

                if (result.Success)
                {
                    result.IntegerValue = orderRow.CustomerInvoiceRowId;
                    result.Value = orderRow;
                }
            }

            #endregion

            return result;
        }

		public static decimal CalculateVatAmountFromVatRate(bool priceListTypeInclusiveVat, decimal sumAmount, decimal vatRate)
		{
			if (priceListTypeInclusiveVat && sumAmount != 0 && vatRate != 0) //Vatamount is included in sumAmount
				return decimal.Round(sumAmount - (sumAmount * (1 / (1 + (vatRate / 100)))), 2);
			else
				return decimal.Round(sumAmount * (vatRate / 100), 2);
		}

		public void CalculateMarginIncome(CustomerInvoice invoice, CustomerInvoiceRow row)
		{
            decimal salesAmountCurrency = invoice.PriceListTypeInclusiveVat ? row.SumAmountCurrency - row.VatAmountCurrency  : row.SumAmountCurrency;
			decimal sumPurchasePriceCurrency = row.PurchasePriceCurrency * row.Quantity.GetValueOrDefault();

            decimal marginalIncome = salesAmountCurrency - (sumPurchasePriceCurrency);
            decimal marginalIncomeRatio = (salesAmountCurrency != 0 ? marginalIncome / salesAmountCurrency : 1) * 100;
            if (marginalIncome < 0 && marginalIncomeRatio > 0)
                marginalIncomeRatio *= -1;

			row.MarginalIncome = decimal.Round(marginalIncome, 2);
			row.MarginalIncomeCurrency = decimal.Round(CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(marginalIncome, invoice.CurrencyRate), 2);
			row.MarginalIncomeRatio = CheckMarginalIncomeRatio(marginalIncomeRatio);
		}

		private static decimal CheckMarginalIncomeRatio(decimal percent)
		{
			if (percent > 999999 || percent < -999999)
				percent = 0;

            percent = Decimal.Round(percent, 2);
            return percent;
        }

        //Rader

        public ActionResult SaveCustomerInvoiceRowsFromIO(int actorCompanyId, string invoiceNr, IEnumerable<CustomerInvoiceRowIO> ios, ImportCustomerInvoiceCache invoiceImportCache, int accountDimStdId, OrderInvoiceRegistrationType invRegType = OrderInvoiceRegistrationType.Ledger, SoeOriginType originType = SoeOriginType.CustomerInvoice)
        {
            ActionResult result = new ActionResult();

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    InvoiceManager.InitializeAttestStateIds(entities, actorCompanyId);

                    CustomerInvoice invoice = InvoiceManager.GetCustomerInvoiceByNr(entities, invoiceNr, originType, invRegType, actorCompanyId, false);
                    if (invoice == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, string.Format(GetText(8427, "Faktura med fakturanr {0} kunde inte hittas"), invoiceNr));

                    using (TransactionScope transaction = CreateTransactionScope(new TimeSpan(0, 30, 0), System.Transactions.IsolationLevel.ReadCommitted))
                    {
                        result = InvoiceManager.SaveCustomerInvoiceRowsFromIO(transaction, entities, actorCompanyId, invoice, ios, invoiceImportCache, accountDimStdId, true, pricelistTypeinclVat: invoice.PriceListTypeInclusiveVat, false, true);

                        if (result.Success)
                        {
                            transaction.Complete();
                        }
                    }
                }
                finally
                {
                    entities.Connection.Close();
                }
            }


            return result;
        }

        public ActionResult SaveCustomerInvoiceRowsFromIO(TransactionScope transaction, CompEntities entities, int actorCompanyId, CustomerInvoice invoice, IEnumerable<CustomerInvoiceRowIO> ios, ImportCustomerInvoiceCache invoiceImportCache, int accountDimStdId, bool updateInvoice, bool pricelistTypeinclVat, bool addQuantityOnAccountingRow, bool ignoreReloadAccountRows)
        {
            int rowsAdded = 0;

            // Settings
            int standardMaterialCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStandardMaterialCode, 0, actorCompanyId, 0);
            int defaultInvoiceProductUnitId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultInvoiceProductUnit, 0, actorCompanyId, 0);
            int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, actorCompanyId, 0);
            int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
            var miscInvoiceProduct = invoiceImportCache.GetMiscProduct(entities, actorCompanyId);

            this.InitializeAttestStateIds(entities, actorCompanyId);
            int? initialAttestStateId = null;

            switch ((SoeOriginType)invoice.Origin.Type)
            {
                case SoeOriginType.Order:
                    initialAttestStateId = InvoiceAttestStatesIds.OrderInitialId;
                    break;
                case SoeOriginType.Offer:
                    initialAttestStateId = InvoiceAttestStatesIds.OfferInitialId;
                    break;
            }

            // Load references
            if (!invoice.ProjectReference.IsLoaded)
                invoice.ProjectReference.Load();

            if (invoice != null)
            {
                if (!invoice.ActorReference.IsLoaded)
                    invoice.ActorReference.Load();

                if (invoice.Actor != null && !invoice.Actor.CustomerReference.IsLoaded)
                {
                    invoice.Actor.CustomerReference.Load();
                }
            }

            // Validate
            if (invoice.Project != null && standardMaterialCodeId <= 0)
                return new ActionResult((int)ActionResultSave.TimeCodeMaterialStandardMissing, GetText(8423, "Inställning för standard materialkod saknas"));

            List<Tuple<CustomerInvoiceRowIO, CustomerInvoiceRow>> rows = new List<Tuple<CustomerInvoiceRowIO, CustomerInvoiceRow>>();

            foreach (var io in ios.OrderBy(r => r.RowNr))
            {
                // SOP defines textrow by not specifing the productnr
                SoeInvoiceRowType rowType = (SoeInvoiceRowType)io.CustomerRowType;
                if (rowType == SoeInvoiceRowType.Unknown)
                {
                    rowType = !string.IsNullOrEmpty(io.ProductNr) || (io.SumAmount != null && io.SumAmount > 0) ? SoeInvoiceRowType.ProductRow : SoeInvoiceRowType.TextRow;
                }

                bool newOrderRow = !io.InvoiceRowId.HasValue || io.InvoiceRowId.Value <= 0;

                int invoiceRowId = io.InvoiceRowId.HasValue ? io.InvoiceRowId.Value : 0;
                decimal quantity = io.Quantity.HasValue ? io.Quantity.Value : 1;

                #region Check currency - ICA version

                if (io.Amount.HasValue && !io.AmountCurrency.HasValue)
                    io.AmountCurrency = io.Amount.Value;

                if (io.SumAmount.HasValue && !io.SumAmountCurrency.HasValue)
                    io.SumAmountCurrency = io.SumAmount.Value;

                if (io.VatAmount.HasValue && !io.VatAmountCurrency.HasValue)
                    io.VatAmountCurrency = io.VatAmount.Value;

                #endregion

                decimal amount = 0;
                if (io.Amount.HasValue)
                    amount = decimal.Round(io.Amount.Value, 4);

                decimal amountCurrency = 0;
                if (io.AmountCurrency.HasValue)
                    amountCurrency = decimal.Round(io.AmountCurrency.Value, 4);

                int productId = 0;
                int? productUnitId = null;

                CustomerInvoiceRow orderRow = null;
                InvoiceProduct invoiceProduct = null;

                #region InvoiceProduct

                bool miscProduct = false;
                io.CustomerRowType = (int)rowType;
                if (rowType == SoeInvoiceRowType.ProductRow)
                {
                    #region Get invoice product by priority

                    #region Prio 1 and 2 : By productnr and ProductName

                    invoiceProduct = invoiceImportCache.GetInvoiceProduct(entities, io.ProductNr?.Trim(), io.ProductName?.Trim(), actorCompanyId);

                    #endregion


                    #region Prio 3. Find in syProducts

                    // Try to find external product and add to invoiceproduct
                    if (invoiceProduct == null && io.ProductNr.Length > 5 && invoiceImportCache.DefaultWholesellerId > 0 && invoice.PriceListTypeId.HasValue)
                    {
                        int sysWholeSellerId = invoiceImportCache.DefaultWholesellerId;

                        var sysproduct = ProductManager.GetExternalInvoiceProductByProductNr(entities, io.ProductNr, io.ActorCompanyId, ref sysWholeSellerId, tryAll: true, sysWholesellers: invoiceImportCache.SysWholesellers);
                        if (sysproduct != null)
                        {
                            InvoiceProductPriceSearchViewDTO productPrice = ProductManager.SearchInvoiceProductPrice(entities, actorCompanyId, invoice.PriceListTypeId.Value, invoice.ActorId.Value, invoice.CurrencyId, sysproduct.ProductId, sysWholeSellerId, false);

                            if (sysproduct != null)
                            {
                                int SysPriceListHeadId = productPrice != null ? productPrice.SysPriceListHeadId : 0;
                                decimal purchaseprice = io.PurchasePrice != null ? io.PurchasePrice.Value : 0;
                                decimal salesPrice = io.Amount.HasValue ? io.Amount.Value : 0;
                                string unit = io.Unit;
                                invoiceProduct = ProductManager.CopyExternalInvoiceProduct(entities, sysproduct.ProductId, purchaseprice, salesPrice, unit, invoice.PriceListTypeId.HasValue ? invoice.PriceListTypeId.Value : 0, SysPriceListHeadId, "", 0, io.ActorCompanyId, true, PriceListOrigin.SysDbPriceList);
                            }
                        }
                    }

                    #endregion

                    #region Prio 4: use Misc product
                    if (invoiceProduct == null || invoiceProduct.State != (int)SoeEntityState.Active && (miscInvoiceProduct != null))
                    {
                        //Misc product                                       
                        invoiceProduct = miscInvoiceProduct;
                        miscProduct = true;
                    }

                    #endregion

                    #region Prio 5: create Invoice Product

                    if (!miscProduct && invoiceProduct == null && io.ProductNr.HasValue())
                    {
                        invoiceProduct = new InvoiceProduct()
                        {
                            Type = (int)SoeProductType.InvoiceProduct,
                            Number = io.ProductNr,
                            Name = io.ProductName.HasValue() ? io.ProductName : string.Empty,
                            Description = "",
                            AccountingPrio = "1=0,2=0,3=0,4=0,5=0,6=0",
                            Created = DateTime.Now,
                            CreatedBy = "Created by import ",
                        };

                        entities.Product.AddObject(invoiceProduct);
                    }

                    #endregion

                    if (invoiceProduct == null || invoiceProduct.State != (int)SoeEntityState.Active)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(8422, "Artikel kunde inte mappas och ingen ströartikel hittades"));
                    else
                    {
                        if (!miscProduct && invoiceProduct.ProductId != 0)
                        {
                            if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                invoiceProduct.ProductUnitReference.Load();

                            if (!invoiceProduct.ProductGroupReference.IsLoaded)
                                invoiceProduct.ProductGroupReference.Load();
                        }

                        productId = invoiceProduct.ProductId;
                        productUnitId = invoiceProduct.ProductUnitId;
                    }

                    #endregion
                }

                #endregion

                #region Fixed price

                if (invoice.FixedPriceOrder && fixedPriceProductId != productId)
                    amountCurrency = 0;

                #endregion

                #region Decide RowNrs

                int rowNr = 1;
                int accountRowNr = 2; // Claim row will get number 1

                CalculateNextRowNbrs(invoice, ref rowNr, ref accountRowNr);

                #endregion

                #region CustomerInvoiceRow

                #region Variables
                string productName = invoiceProduct != null ? invoiceProduct.Name : String.Empty;
                if (!string.IsNullOrEmpty(io.ProductName))
                    productName = io.ProductName;

                //if (((miscProduct || newProduct) && !string.IsNullOrEmpty(io.ProductName)))
                //    productName += " (" + io.ProductName + ")";

                decimal purchasePrice = io.PurchasePrice.HasValue ? io.PurchasePrice.Value : 0;
                decimal purchasePriceCurrency = io.PurchasePriceCurrency.HasValue ? io.PurchasePriceCurrency.Value : 0;

                decimal sumAmountCurrency = io.SumAmountCurrency.HasValue ? io.SumAmountCurrency.Value : 0;
                decimal sumAmount = io.SumAmount.HasValue ? io.SumAmount.Value : 0;

                if (!io.Amount.HasValue && io.SumAmount.HasValue && io.Quantity != 0 && !invoice.FixedPriceOrder)
                    amount = sumAmount / quantity;
                if (!io.AmountCurrency.HasValue && io.SumAmountCurrency.HasValue && io.Quantity != 0 && !invoice.FixedPriceOrder)
                    amountCurrency = sumAmountCurrency / quantity;

                decimal discountAmount = io.DiscountAmount.HasValue ? io.DiscountAmount.Value : 0;
                decimal discountAmountCurrency = io.DiscountAmountCurrency.HasValue ? io.DiscountAmountCurrency.Value : 0;
                decimal discount = io.Discount.HasValue ? io.Discount.Value : 0;

                decimal salesAmount = sumAmount;
                decimal marginalIncome = io.MarginalIncome.HasValue ? io.MarginalIncome.Value : 0;
                decimal marginalIncomeCurrency = io.MarginalIncomeCurrency.HasValue ? io.MarginalIncomeCurrency.Value : 0;
                decimal marginalIncomeRatio = (salesAmount != 0 ? marginalIncome / salesAmount : 1) * 100;
                marginalIncomeRatio = CheckMarginalIncomeRatio(marginalIncomeRatio);

                #region UnitCode

                ProductUnit productUnit = null;
                if (rowType == SoeInvoiceRowType.ProductRow)
                {
                    if (productUnitId.HasValue && invoiceProduct != null && invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnitId == productUnitId.Value)
                    {
                        productUnit = invoiceProduct.ProductUnit;
                    }
                    else
                    {
                        productUnit = productUnitId.HasValue ? ProductManager.GetProductUnit(entities, productUnitId.Value) : invoiceProduct.ProductUnit;
                    }

                    if (productUnit == null)
                        productUnit = ProductManager.GetProductUnit(entities, defaultInvoiceProductUnitId);
                }

                #endregion

                #region Stock

                if (!string.IsNullOrEmpty(io.Stock) && !io.StockId.HasValue)
                {
                    var stock = StockManager.GetStockByCode(entities, actorCompanyId, io.Stock);

                    if (stock == null)
                    {
                        stock = new Stock()
                        {
                            Code = io.Stock,
                            Name = io.Stock,
                        };

                        StockManager.SaveStock(entities, transaction, stock, actorCompanyId);
                        stock = StockManager.GetStockByCode(entities, actorCompanyId, io.Stock);
                    }

                    if (stock != null)
                    {
                        io.StockId = stock.StockId;
                    }
                }

                #endregion

                #endregion

                #region VAT

                //Find vatcode
                VatCode vatCode = new VatCode();
                int? codeId = null;
                int? vatAccountId = null;
                bool mixedVat = true;
                decimal rowVatRate = 0;

                if (!string.IsNullOrEmpty(io.VatCode))
                {
                    vatCode = AccountManager.GetVatCodeByCode(entities, actorCompanyId, io.VatCode);

                    if (vatCode != null)
                    {
                        codeId = vatCode.VatCodeId;
                        vatAccountId = vatCode.AccountId;
                        rowVatRate = vatCode.Percent;
                    }
                }

                if (io.VatRate.HasValue && vatCode == null)
                {
                    vatCode = AccountManager.GetVatCodeByVateRate(entities, actorCompanyId, (decimal)io.VatRate);

                    if (vatCode != null)
                    {
                        vatAccountId = vatCode.AccountId;
                        rowVatRate = vatCode.Percent;
                        codeId = vatCode.VatCodeId;
                        mixedVat = false;
                    }
                }

                //Check for standard value
                if (string.IsNullOrEmpty(io.VatCode) && !io.VatRate.HasValue)
                {
                    int compVatCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultVatCode, 0, actorCompanyId, 0);
                    if (compVatCodeId > 0)
                    {
                        vatCode = AccountManager.GetVatCode(entities, compVatCodeId);
                        if (vatCode != null)
                        {
                            codeId = vatCode.VatCodeId;
                            vatAccountId = vatCode.AccountId;
                            rowVatRate = vatCode.Percent;
                        }
                    }
                }

                if (io.VatRate.GetValueOrDefault() > 0)
                    rowVatRate = (decimal)io.VatRate;

                var caskcustomerinvoiceFunctionality = invoiceImportCache.SpecialFunctionalityDict.ContainsKey("CASKkundfakturor");
                if (io.VatRate != null && caskcustomerinvoiceFunctionality)
                {
                    decimal vatRate = (decimal)io.VatRate;
                    if (vatRate == 25)
                        vatAccountId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCommonVatPayable1, 0, actorCompanyId, 0);
                    else if (vatRate == 12)
                        vatAccountId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCommonVatPayable2, 0, actorCompanyId, 0);
                }

                // Mixed Vat - If vat is not found in vatcodes then we use the mixed vat setting.
                // ICA Special - Using absolute filed VatRate3 to know filetype donw in this method.
                // VatRate3 = 1 = Mixed vat
                // VatRate3 = 2 = Detailed vat
                // VatRate3 = 3 = Detailed vat with product rows
                if (invoiceImportCache.CustomerInvoiceHeadIO != null && invoiceImportCache.CustomerInvoiceHeadIO.VatRate3 == 1)
                    mixedVat = true;

                if (mixedVat && io.VatRate != null)
                {
                    //Remove VatCode since it not needed when mixedvat
                    codeId = null;
                    int accountId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCommonMixedVat, 0, actorCompanyId, 0);

                    if (accountId != 0)
                    {
                        vatAccountId = accountId;
                    }
                }

                if (!string.IsNullOrEmpty(io.VatAccountnr))
                {
                    var vatAccount = invoiceImportCache.GetAccountStdByNr(entities, io.VatAccountnr, actorCompanyId);
                    vatAccountId = vatAccount.AccountId;
                }

                //Last try
                if (vatAccountId == null)
                {
                    int accountId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCommonVatPayable1, 0, actorCompanyId, 0);

                    if (accountId != 0)
                    {
                        vatAccountId = accountId;
                    }
                }

                if (rowVatRate == 0 && vatCode != null && vatCode.Percent != 0)
                {
                    rowVatRate = vatCode.Percent;
                }

                #endregion

                #region PriceListType InclVAT

                if (pricelistTypeinclVat)
                {
                    decimal vatAmount = io.VatAmount ?? 0;
                    decimal vatAmountCurrency = io.VatAmountCurrency.GetValueOrDefault() != 0 ? io.VatAmountCurrency.Value : vatAmount;

                    decimal vatPerQuantity = 0;
                    decimal vatPerQuantityCurrency = 0;

                    if (quantity != 0 && vatAmount != 0)
                    {
                        vatPerQuantity = vatAmount / quantity;
                        vatPerQuantityCurrency = vatAmountCurrency / quantity;
                    }

                    amount = amount + vatPerQuantity;
                    amountCurrency = amountCurrency + vatPerQuantityCurrency;

                    sumAmount = quantity < 0 ? sumAmount - Math.Abs(vatAmount) : sumAmount + vatAmount;
                    sumAmountCurrency = quantity < 0 ? sumAmountCurrency - Math.Abs(vatAmountCurrency) : sumAmountCurrency + vatAmountCurrency;
                }

                #endregion

                #region Discount

                bool discountcreatedFromCustomer = false;

                if (discount == 0)
                {
                    if (invoiceProduct != null && invoice.Actor != null && invoice.Actor.Customer != null)
                    {
                        if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Merchandise)
                            discount = invoice.Actor.Customer.DiscountMerchandise;
                        else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Service)
                            discount = invoice.Actor.Customer.DiscountService;
                    }


                    if (discount != 0)
                        discountcreatedFromCustomer = true;
                }

                if (discountAmount == 0)
                    discountAmount = sumAmount * discount / 100;
                if (discountAmountCurrency == 0)
                    discountAmountCurrency = CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(discountAmount, invoice.CurrencyRate);

                //If discount is included in file sumAmount is already correct.
                if (discountcreatedFromCustomer)
                {
                    sumAmount -= discountAmount;
                    sumAmountCurrency -= discountAmountCurrency;
                }


                #endregion

                if (newOrderRow)
                {
                    #region New OrderRow

                    if (io.CustomerRowType == (int)SoeInvoiceRowType.BaseProductRow || io.CustomerRowType == (int)SoeInvoiceRowType.ProductRow)
                    {
                        #region ProductRow

                        orderRow = new CustomerInvoiceRow()
                        {
                            RowNr = rowNr,
                            Type = io.CustomerRowType,
                            Amount = amount,
                            AmountCurrency = decimal.Round(amountCurrency, 4),
                            Quantity = quantity,
                            DiscountPercent = decimal.Round(discount, 2),
                            DiscountAmount = decimal.Round(discountAmount, 2),
                            DiscountAmountCurrency = decimal.Round(discountAmountCurrency, 2),
                            Date = io.RowDate,
                            SumAmount = decimal.Round(sumAmount, 2),
                            SumAmountCurrency = decimal.Round(sumAmountCurrency, 2),
                            PurchasePrice = decimal.Round(purchasePrice, 2),
                            PurchasePriceCurrency = decimal.Round(purchasePriceCurrency, 2),
                            SysWholesellerName = invoiceProduct.SysWholesellerName,
                            MarginalIncome = decimal.Round(marginalIncome, 2),
                            MarginalIncomeCurrency = decimal.Round(marginalIncomeCurrency, 2),
                            MarginalIncomeRatio = decimal.Round(marginalIncomeRatio, 2),
                            Text = !string.IsNullOrEmpty(io.Text) ? io.Text : productName,
                            IsFreightAmountRow = false,
                            IsInvoiceFeeRow = false,
                            IsCentRoundingRow = false,
                            IsInterestRow = false,
                            IsReminderRow = false,
                            IsTimeProjectRow = false,
                            VatRate = rowVatRate,
                            VatAccountId = vatAccountId,
                            VatCodeId = codeId != null ? codeId : null,
                            StockId = io.StockId,
                            IsStockRow = io.StockId.GetValueOrDefault() > 0,
                            HouseholdDeductionType = defaultHouseholdDeductionType != 0 ? defaultHouseholdDeductionType : (int?)null,
                            DeliveryDateText = io.DeliveryDateText,
                            //Set FK
                            AttestStateId = initialAttestStateId,

                            //References
                            Product = invoiceProduct,
                            ProductUnit = productUnit,
                        };

                        if (orderRow.DiscountPercent == 0 && orderRow.DiscountAmount != 0)
                        {
                            orderRow.DiscountType = (int)SoeInvoiceRowDiscountType.Amount;
                        }
                        else
                        {
                            orderRow.DiscountType = (discount <= 100 && discount >= -100) ? (int)SoeInvoiceRowDiscountType.Percent : (int)SoeInvoiceRowDiscountType.Amount;
                        }

                        SetCreatedProperties(orderRow);
                        rowsAdded++;

                        #endregion

                    }
                    else if (io.CustomerRowType == (int)SoeInvoiceRowType.TextRow)
                    {
                        #region TextRow

                        orderRow = new CustomerInvoiceRow();
                        orderRow.RowNr = rowNr;
                        orderRow.Type = io.CustomerRowType;
                        orderRow.Text = io.Text ?? io.ProductName;
                        orderRow.AttestStateId = initialAttestStateId;

                        #endregion
                    }
                    else
                    {
                        return new ActionResult((int)ActionResultSave.Unknown, "Unknown SoeInvoiceRowType:" + io.CustomerRowType.ToString());
                    }
                    #endregion

                    if (invoice.Project != null)
                    {
                        var createTimeResult = TimeTransactionManager.CreateTimeCodeTransaction(entities, actorCompanyId, orderRow, invoice.Project, standardMaterialCodeId);
                        if (!createTimeResult.Success)
                            return createTimeResult;
                    }
                }
                else
                {
                    #region Update OrderRow

                    orderRow = GetCustomerInvoiceRow(entities, invoiceRowId);
                    if (orderRow == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(8424, "Artikelrad kunde inte hittas"));

                    if (io.CustomerRowType == (int)SoeInvoiceRowType.BaseProductRow || io.CustomerRowType == (int)SoeInvoiceRowType.ProductRow)
                    {
                        #region ProductRow

                        SetAccountRowsAsDeleted(orderRow);
                        orderRow.Amount = io.Amount.HasValue ? decimal.Round(io.Amount.Value, 4) : 0;
                        orderRow.AmountCurrency = decimal.Round(amountCurrency, 4);
                        orderRow.Quantity = quantity;
                        orderRow.Date = io.RowDate;
                        //orderRow.DiscountPercent = Decimal.Round(discountPercent, 2);
                        orderRow.DiscountAmount = decimal.Round(discountAmount, 2);
                        orderRow.DiscountAmountCurrency = decimal.Round(discountAmountCurrency, 2);
                        orderRow.SumAmount = decimal.Round(sumAmount, 2);
                        orderRow.SumAmountCurrency = decimal.Round(sumAmountCurrency, 2);
                        orderRow.PurchasePrice = decimal.Round(purchasePrice, 2);
                        orderRow.PurchasePriceCurrency = decimal.Round(purchasePriceCurrency, 2);
                        orderRow.SysWholesellerName = invoiceProduct.SysWholesellerName;
                        orderRow.MarginalIncome = decimal.Round(marginalIncome, 2);
                        orderRow.MarginalIncomeCurrency = decimal.Round(marginalIncomeCurrency, 2);
                        orderRow.MarginalIncomeRatio = decimal.Round(marginalIncomeRatio, 2);
                        orderRow.Text = !string.IsNullOrEmpty(io.Text) ? io.Text : productName;

                        //Set references
                        orderRow.Product = invoiceProduct;
                        orderRow.ProductUnit = productUnit;

                        SetModifiedProperties(orderRow);

                        #endregion
                    }
                    else if (io.CustomerRowType == (int)SoeInvoiceRowType.TextRow)
                    {
                        #region TextRow

                        orderRow.Text = io.Text;

                        #endregion
                    }

                    if (invoice.Project != null)
                    {
                        var updateTimeResult = TimeTransactionManager.UpdateTimeCodeTransactions(entities, actorCompanyId, orderRow, invoice.Project, standardMaterialCodeId);
                        if (!updateTimeResult.Success)
                            return updateTimeResult;
                    }

                    #endregion
                }

                #region VAT account

                // Check VAT type
                bool noVAT = (invoice.VatType == (int)TermGroup_InvoiceVatType.Contractor || invoice.VatType == (int)TermGroup_InvoiceVatType.NoVat || orderRow.HouseholdTaxDeductionRow != null);

                if (invoiceProduct != null && !noVAT && (orderRow.VatAccountId == null || orderRow.VatAccountId == 0) && rowVatRate == 0)
                {
                    AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, invoiceProduct.ProductId, 0, invoice.ActorId.Value, 0, ProductAccountType.VAT, (TermGroup_InvoiceVatType)invoice.VatType, false);
                    if (prioDTO != null && prioDTO.AccountId.HasValue)
                    {
                        // Set VAT account
                        orderRow.VatAccountId = prioDTO.AccountId.Value;

                        // Set VAT rate from account
                        orderRow.VatRate = AccountManager.GetVatRateValue(entities, prioDTO.AccountId.Value);

                        // Set VAT amount
                        orderRow.VatAmount = io.VatAmount.HasValue ? io.VatAmount.Value : 0;
                        orderRow.VatAmountCurrency = io.VatAmountCurrency.HasValue ? io.VatAmountCurrency.Value : 0;
                    }
                }
                else
                {

                    // Set VAT rate from account
                    orderRow.VatRate = rowVatRate;
                    CalculateRowSum(orderRow, invoice.CurrencyRate, 0, pricelistTypeinclVat);
                }

                #endregion

                invoice.CustomerInvoiceRow.Add(orderRow);
                rowNr++;

                #endregion
                int? dim2Id = null;
                int? dim3Id = null;
                int? dim4Id = null;
                int? dim5Id = null;
                int? dim6Id = null;
                if (rowType == SoeInvoiceRowType.ProductRow)
                {
                    AccountingPrioDTO accountingPrioDTO = null;

                    if (!string.IsNullOrEmpty(io.AccountNr))
                    {
                        AccountStd accountStd = invoiceImportCache.GetAccountStdByNr(entities, io.AccountNr, actorCompanyId);

                        if (io.AccountNr != "0")
                        {
                            if (accountStd == null)
                            {
                                //Create Account if account not Found

                                Account account = new Account();

                                account.AccountNr = io.AccountNr;
                                account.Name = io.AccountNr;
                                account.Created = DateTime.Now;
                                account.CreatedBy = "Import";
                                account.ActorCompanyId = actorCompanyId;
                                account.AccountDimId = accountDimStdId;

                                entities.Account.AddObject(account);

                                accountStd = new AccountStd();

                                accountStd.Account = account;
                                accountStd.Unit = "";
                                accountStd.UnitStop = true;
                                accountStd.SieKpTyp = "";
                                accountStd.AmountStop = 0;
                                accountStd.AccountTypeSysTermId = (int)TermGroup_AccountType.Asset;

                                account.AccountStd = accountStd;

                                entities.AccountStd.AddObject(accountStd);
                            }

                            accountingPrioDTO = new AccountingPrioDTO
                            {
                                AccountId = accountStd.Account.AccountId,
                                AccountNr = accountStd.Account.AccountNr,
                                AccountName = accountStd.Account.Name,
                                CompanyType = CompanySettingType.AccountInvoiceProductSales,
                                Percent = 100,
                            };
                        }

                        if (!string.IsNullOrEmpty(io.AccountDim2Nr))
                        {
                            var acc2 = invoiceImportCache.AccountDims.FirstOrDefault(a => a.AccountDimNr == 2).Account.FirstOrDefault(a => a.AccountNr == io.AccountDim2Nr && a.State != (int)SoeEntityState.Deleted);
                            if (acc2 != null)
                                dim2Id = acc2.AccountId;
                        }

                        if (!string.IsNullOrEmpty(io.AccountDim3Nr))
                        {
                            var acc3 = invoiceImportCache.AccountDims.FirstOrDefault(a => a.AccountDimNr == 3).Account.FirstOrDefault(a => a.AccountNr == io.AccountDim3Nr && a.State != (int)SoeEntityState.Deleted);
                            if (acc3 != null)
                                dim3Id = acc3.AccountId;
                        }

                        if (!string.IsNullOrEmpty(io.AccountDim4Nr))
                        {
                            var acc4 = invoiceImportCache.AccountDims.FirstOrDefault(a => a.AccountDimNr == 4).Account.FirstOrDefault(a => a.AccountNr == io.AccountDim4Nr && a.State != (int)SoeEntityState.Deleted);
                            if (acc4 != null)
                                dim4Id = acc4.AccountId;
                        }

                        if (!string.IsNullOrEmpty(io.AccountDim5Nr))
                        {
                            var acc5 = invoiceImportCache.AccountDims.FirstOrDefault(a => a.AccountDimNr == 5).Account.FirstOrDefault(a => a.AccountNr == io.AccountDim5Nr && a.State != (int)SoeEntityState.Deleted);
                            if (acc5 != null)
                                dim5Id = acc5.AccountId;
                        }

                        if (!string.IsNullOrEmpty(io.AccountDim6Nr))
                        {
                            var acc6 = invoiceImportCache.AccountDims.FirstOrDefault(a => a.AccountDimNr == 6).Account.FirstOrDefault(a => a.AccountNr == io.AccountDim6Nr && a.State != (int)SoeEntityState.Deleted);
                            if (acc6 != null)
                                dim6Id = acc6.AccountId;
                        }
                    }

                    #region CustomerInvoiceAccountRow

                    InvoiceManager.CreateCustomerInvoiceAccountRow(entities, orderRow, (TermGroup_InvoiceVatType)invoice.VatType, ref accountRowNr, invoice.ActorId.Value, 0, invoice.ProjectId.GetValueOrDefault(), actorCompanyId, accountingPrioDTO,
                        invoiceDim2AccountId: dim2Id, invoiceDim3AccountId: dim3Id, invoiceDim4AccountId: dim4Id,
                        invoiceDim5AccountId: dim5Id, invoiceDim6AccountId: dim6Id, addQuantityOnAccountingRow: addQuantityOnAccountingRow, invoice.TriangulationSales);

                    #endregion
                }

                rows.Add(new Tuple<CustomerInvoiceRowIO, CustomerInvoiceRow>(io, orderRow));
            }

            #region Order Status

            if (invoice.Status == (int)SoeOriginStatus.OrderFullyInvoice && rowsAdded > 0)
            {
                invoice.Status = (int)SoeOriginStatus.OrderPartlyInvoice;
            }

            #endregion

            #region Save

            if (updateInvoice)
            {
                #region InvoiceFee

                ActionResult invoiceFeeResult = InvoiceManager.CreateInvoiceFee(transaction, entities, actorCompanyId, invoice, false);

                #endregion

                #region Freight

                ActionResult freightResult = InvoiceManager.CreateInvoiceFreight(transaction, entities, actorCompanyId, invoice, false);

                #endregion

                int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, invoice.CurrencyId);
                int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                UpdateInvoiceAfterRowModification(entities, invoice, rowsAdded + 1, ActorCompanyId, false, sysCurrencyIdInvoice != sysCurrencyIdBase, ignoreReloadAccountRows: ignoreReloadAccountRows);
            }


            var result = SaveChanges(entities, transaction, useBulkSaveChanges: true);

            if (ios.Any(r => r.StockId.HasValue))
            {
                var stockDict = new Dictionary<int, Tuple<Decimal, Decimal, bool, int, int, int>>();
                HandleStockOnInvoice(invoice, entities, transaction, actorCompanyId, stockDict, false, false, true);
            }

            if (result.Success)
            {
                foreach (var row in rows)
                {
                    row.Item1.InvoiceRowId = row.Item2.CustomerInvoiceRowId;
                }

                result = SaveChanges(entities, transaction, useBulkSaveChanges: true);
            }

            return result;

            #endregion
        }

        public ActionResult CopyCustomerInvoiceRows(List<CustomerInvoiceRowDTO> rows, int actorCompanyId, int orderId, int? originalOrderId = null, bool updateOriginalInvoice = false)
        {
            return CopyCustomerInvoiceRows(rows, SoeOriginType.Order, actorCompanyId, orderId, originalOrderId, updateOriginalInvoice);
        }

        public ActionResult CopyCustomerInvoiceRows(List<CustomerInvoiceRowDTO> rows, SoeOriginType originType, int actorCompanyId, int orderId, int? originalOrderId = null, bool updateOriginalInvoice = false, bool recalculateSalesPrices = false)
        {
            var result = new ActionResult();
            bool usePartialInvoicingOnOrderRow = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingUsePartialInvoicingOnOrderRow, base.UserId, base.ActorCompanyId, 0);

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);

                    this.InitializeAttestStateIds(entities, actorCompanyId);

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region NewInvoice

                        bool copyFromFixedPriceOrder = false;

                        CustomerInvoice order = null;
                        OrderInvoiceRegistrationType registrationType = OrderInvoiceRegistrationType.Unknown;

                        if (originType == SoeOriginType.Order)
                        {
                            order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, originType, OrderInvoiceRegistrationType.Order, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: true);
                            registrationType = OrderInvoiceRegistrationType.Order;
                        }
                        else if (originType == SoeOriginType.Contract)
                        {
                            order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, originType, OrderInvoiceRegistrationType.Contract, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: false);
                            registrationType = OrderInvoiceRegistrationType.Contract;
                        }
                        else if (originType == SoeOriginType.Offer)
                        {
                            order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, originType, OrderInvoiceRegistrationType.Offer, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: false);
                            registrationType = OrderInvoiceRegistrationType.Offer;
                        }
                        else if (originType == SoeOriginType.CustomerInvoice)
                        {
                            order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, originType, OrderInvoiceRegistrationType.Invoice, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: true);
                            registrationType = OrderInvoiceRegistrationType.Invoice;

                            if (order == null)
                                order = InvoiceManager.GetCustomerInvoiceByType(entities, orderId, originType, OrderInvoiceRegistrationType.Ledger, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: true);
                        }

                        if (order == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                        if (!order.ActorReference.IsLoaded)
                            order.ActorReference.Load();

                        Customer customer = CustomerManager.GetCustomer(entities, order.ActorId.Value);
                        if (customer == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "Customer");

                        // Check if order has PriceListType is inclusive VAT
                        SetPriceListTypeInclusiveVat(entities, order, actorCompanyId, true);

                        SetModifiedProperties(order);

                        //save current order rows so stock handling will know which rows are new....
                        var stockDict = new Dictionary<int, Tuple<decimal, decimal, bool, int, int, int>>();
                        foreach (var row in order.ActiveCustomerInvoiceRows)
                        {
                            stockDict.Add(row.CustomerInvoiceRowId, CreateInvoiceRowStockInfo(row));
                        }

                        for (var i = 1; i <= rows.Count; i++)
                        {
                            var item = rows[i - 1];

                            if ((!item.ProductId.HasValue || item.ProductId.Value == 0) && string.IsNullOrEmpty(item.Text))
                                continue;

                            #region Get productprice

                            decimal productPrice = item.Amount;
                            decimal? vatAmount = item.VatAmount;
                            decimal? vatAmountCurrency = item.VatAmountCurrency;
                            if (recalculateSalesPrices && order.PriceListTypeId.HasValue && item.Quantity.HasValue)
                            {
                                InvoiceProductPriceResult priceResult = ProductManager.GetProductPrice(entities, actorCompanyId, new ProductPriceRequestDTO { PriceListTypeId = order.PriceListTypeId.Value, ProductId = item.ProductId.Value, CustomerId = order.ActorId.Value, CurrencyId = order.CurrencyId, Quantity = item.Quantity.Value, PurchasePrice = item.PurchasePrice }, wholeSellerName: item.SysWholesellerName, includeCustomerPrices: true);
                                if (priceResult != null)
                                {
                                    // Set price
                                    productPrice = priceResult.SalesPrice;
                                    if (priceResult.CurrencyDiffer)
                                        productPrice = (productPrice / order.CurrencyRate);

                                    // Empty vat, will be calculated in savecustomerinvoicerow
                                    vatAmount = vatAmountCurrency = null;
                                }
                            }

                            #endregion

                            var save = (i == rows.Count && !copyFromFixedPriceOrder);

                            if (originType == SoeOriginType.CustomerInvoice)
                                result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, item.ProductId ?? 0, item.Quantity ?? 0, productPrice, item.Text, item.Type, null, item.ProductUnitId, i == rows.Count, save, item.IsInvoiceFeeRow, useOriginalVat: true, vatRate: item.VatRate, vatAccId: item.VatAccountId, vatAmount: vatAmount, vatAmountCurrency: vatAmountCurrency, productPurchasePrice: item.PurchasePriceCurrency, deliveryDateText: item.DeliveryDateText, quantityToInvoice: item.InvoiceQuantity, stockId: item.StockId, ediEdiEntryId: item.EdiEntryId, sysWholeSellerName: item.SysWholesellerName);
                            else if (originType == SoeOriginType.Order)
                                result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, item.ProductId ?? 0, item.Quantity ?? 0, productPrice, item.Text, item.Type, null, item.ProductUnitId, i == rows.Count, save, item.IsInvoiceFeeRow, productPurchasePrice: item.PurchasePriceCurrency, quantityToInvoice: item.InvoiceQuantity, stockId: item.StockId, customerInvoiceRowDate: item.Date, ediEdiEntryId: item.EdiEntryId, sysWholeSellerName: item.SysWholesellerName, supplierInvoiceId: item.SupplierInvoiceId);
                            else
                                result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, order, 0, item.ProductId ?? 0, item.Quantity ?? 0, productPrice, item.Text, item.Type, null, item.ProductUnitId, i == rows.Count, save, item.IsInvoiceFeeRow, productPurchasePrice: item.PurchasePriceCurrency, quantityToInvoice: item.InvoiceQuantity, stockId: item.StockId);

                            if (!result.Success)
                            {
                                return new ActionResult(false);
                            }

                            if (fixedPriceProductId == item.ProductId)
                            {
                                copyFromFixedPriceOrder = true;
                            }
                        }

                        if (copyFromFixedPriceOrder)
                        {
                            result = UpdateOrderDueToAddedFixedPriceProduct(entities, transaction, order, fixedPriceProductId, actorCompanyId);
                        }

                        this.HandleStockOnInvoice(order, entities, transaction, actorCompanyId, stockDict, usePartialInvoicingOnOrderRow, false);

                        #endregion

                        #region OriginalInvoice
                        if (updateOriginalInvoice && originalOrderId.HasValue)
                        {
                            CustomerInvoice originalOrder = InvoiceManager.GetCustomerInvoiceByType(entities, originalOrderId.Value, originType, registrationType, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadProject: true);
                            if (originalOrder == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                            for (var i = 1; i <= rows.Count; i++)
                            {
                                var row = rows[i - 1];

                                if ((!row.ProductId.HasValue || row.ProductId.Value == 0) && String.IsNullOrEmpty(row.Text))
                                    continue;

                                decimal remainingQuantity = 0;
                                var dbRow = originalOrder.CustomerInvoiceRow.FirstOrDefault(x => x.CustomerInvoiceRowId == row.CustomerInvoiceRowId);
                                if (dbRow == null)
                                    continue;

                                if (dbRow.Quantity.HasValue && row.Quantity.HasValue)
                                {
                                    remainingQuantity = dbRow.Quantity.Value - row.Quantity.Value;
                                }


                                if (remainingQuantity == 0)
                                {
                                    result = DeleteCustomerInvoiceRow(transaction, entities, actorCompanyId, originalOrder, row.CustomerInvoiceRowId, saveChanges: i == rows.Count, reNumberRows: true, updateInvoice: i == rows.Count);
                                    if (!result.Success)
                                        return result;
                                }
                                else
                                {
                                    result = SaveCustomerInvoiceRow(transaction, entities, actorCompanyId, originalOrder, row.CustomerInvoiceRowId, row.ProductId.HasValue ? row.ProductId.Value : 0, remainingQuantity, row.Amount, row.Text, row.Type, saveChanges: i == rows.Count, updateInvoice: i == rows.Count);
                                    if (!result.Success)
                                        return result;
                                }
                            }
                        }

                        #endregion

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
                return result;
            }
        }

        public ActionResult SetOrderReady(int orderId, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {

                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        int attestStateToId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusOrderReadyMobile, 0, actorCompanyId, 0);

                        AttestState attestStateInitial = AttestManager.GetInitialAttestState(entities, actorCompanyId, TermGroup_AttestEntity.Order);
                        if (attestStateInitial == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "AttestState initial");

                        AttestState attestStateTo = AttestManager.GetAttestState(entities, attestStateToId);
                        if (attestStateTo == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "AttestState");

                        List<AttestTransition> attestTransitions = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, userId, actorCompanyId, entity: TermGroup_AttestEntity.Order);
                        if (attestTransitions.IsNullOrEmpty())
                            return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestTransitions);

                        Dictionary<int, bool> orderRowsValidationDict = new Dictionary<int, bool>(); //Used for validation

                        #endregion

                        CustomerInvoice order = GetCustomerInvoiceByType(entities, orderId, SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true);
                        if (order == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                        //Users AttestTransitions with StartAttestState = InvoiceRow.AttestState - Lowest SortNr om AttestState and not IsStart
                        foreach (var orderRow in order.ActiveCustomerInvoiceRows)
                        {
                            if (orderRow.AttestStateId != attestStateInitial.AttestStateId)
                                continue;

                            bool isValid = false;
                            if (!orderRow.IsInvoiceFeeRow && !orderRow.IsFreightAmountRow)
                                isValid = IsCustomerInvoiceRowAttestStateValid(orderRow, attestStateTo, attestTransitions);

                            if (isValid)
                                orderRow.AttestStateId = attestStateTo.AttestStateId;

                            orderRowsValidationDict.Add(orderRow.CustomerInvoiceRowId, isValid);
                        }

                        //Must have at least one row that has valid state
                        int noOfValidatedPrototypeRows = orderRowsValidationDict.Count(i => i.Value);
                        if (noOfValidatedPrototypeRows > 0)
                        {
                            result = SaveChanges(entities, transaction);

                            //Commit transaction
                            if (result.Success)
                                transaction.Complete();
                        }

                        result.Value = orderRowsValidationDict;
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult SetOrderRowsAsReady(int orderId, int actorCompanyId, int userId, List<int> orderRowIds)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {

                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        int attestStateToId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusOrderReadyMobile, 0, actorCompanyId, 0);

                        AttestState attestStateInitial = AttestManager.GetInitialAttestState(entities, actorCompanyId, TermGroup_AttestEntity.Order);
                        if (attestStateInitial == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "AttestState initial");

                        AttestState attestStateTo = AttestManager.GetAttestState(entities, attestStateToId);
                        if (attestStateTo == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "AttestState");

                        List<AttestTransition> attestTransitions = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, userId, actorCompanyId, entity: TermGroup_AttestEntity.Order);
                        if (attestTransitions.IsNullOrEmpty())
                            return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestTransitions);

                        Dictionary<int, bool> orderRowsValidationDict = new Dictionary<int, bool>(); //Used for validation

                        #endregion

                        CustomerInvoice order = GetCustomerInvoiceByType(entities, orderId, SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId, loadInvoiceRow: true, loadInvoiceAccountRow: true);
                        if (order == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                        foreach (var orderRow in order.ActiveCustomerInvoiceRows)
                        {
                            if (orderRow.AttestStateId != attestStateInitial.AttestStateId)
                                continue;

                            if (orderRowIds.Exists(x => x == orderRow.CustomerInvoiceRowId))
                            {
                                bool isValid = false;
                                if (!orderRow.IsInvoiceFeeRow && !orderRow.IsFreightAmountRow)
                                    isValid = IsCustomerInvoiceRowAttestStateValid(orderRow, attestStateTo, attestTransitions);

                                if (isValid)
                                    orderRow.AttestStateId = attestStateTo.AttestStateId;

                                orderRowsValidationDict.Add(orderRow.CustomerInvoiceRowId, isValid);
                            }
                        }

                        //Must have at least one row that has valid state
                        int noOfValidatedPrototypeRows = orderRowsValidationDict.Count(i => i.Value);
                        if (noOfValidatedPrototypeRows > 0)
                        {
                            result = SaveChanges(entities, transaction);

                            //Commit transaction
                            if (result.Success)
                                transaction.Complete();
                        }

                        result.Value = orderRowsValidationDict;
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult UpdateInvoiceAfterRowModification(CompEntities entities, CustomerInvoice order, int accountRowNr, int actorCompanyId, bool checkLiftProducts = false, bool useCurrencyProp = false, bool overrideUseRounding = false, bool ignoreCalculateRemaining = false, bool ignoreReloadAccountRows = false, bool check4NewClaimAccount = false)
        {
            var result = new ActionResult();

            #region Prereq

            //Settings
            bool useCentRounding = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseCentRounding, 0, actorCompanyId, 0) || overrideUseRounding;

            #endregion

            #region Calculate Amounts

            CalculateAmountsByCurrency(entities, order, useCentRounding, actorCompanyId, checkLiftProducts, ignoreCalculateRemaining);

            #endregion

            #region Claim row

            UpdateCreateClaimRow(entities, actorCompanyId, order, check4NewClaimAccount);

            #endregion

            CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, order);

            #region Cent rounding row

            if (useCentRounding)
                UpdateCreateCentRoundingRow(entities, order, actorCompanyId, accountRowNr);

            #endregion

            return result;
        }

        public ActionResult DeleteCustomerInvoiceRow(int actorCompanyId, int invoiceId, int invoiceRowId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        result = DeleteCustomerInvoiceRow(transaction, entities, actorCompanyId, invoiceId, invoiceRowId, reNumberRows: true);

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
                return result;
            }
        }

        public ActionResult DeleteCustomerInvoiceRow(TransactionScope transaction, CompEntities entities, int actorCompanyId, int invoiceId, int invoiceRowId, bool saveChanges = false, bool reNumberRows = false)
        {

            #region Prereq

            CustomerInvoice customerInvoice = InvoiceManager.GetCustomerInvoiceByType(entities, invoiceId, SoeOriginType.Order, OrderInvoiceRegistrationType.Order, actorCompanyId, false, false, false, true, true);
            if (customerInvoice == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

            int rowNr = 1;
            int accountRowNr = 2; // Claim has number 1
            CalculateNextRowNbrs(customerInvoice, ref rowNr, ref accountRowNr);

            #endregion

            var result = DeleteCustomerInvoiceRow(transaction, entities, customerInvoice, invoiceRowId, actorCompanyId);

            if (!result.Success)
                return result;

            if (reNumberRows && customerInvoice.CustomerInvoiceRow != null && customerInvoice.CustomerInvoiceRow.Count > 0)
            {
                var deletedRow = customerInvoice.CustomerInvoiceRow.FirstOrDefault(x => x.CustomerInvoiceRowId == invoiceRowId);
                if (deletedRow != null)
                {
                    foreach (var row in customerInvoice.ActiveCustomerInvoiceRows.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.TextRow || r.Type == (int)SoeInvoiceRowType.PageBreakRow || r.Type == (int)SoeInvoiceRowType.SubTotalRow))
                    {
                        if (row.RowNr == 0 || row.RowNr <= deletedRow.RowNr)
                            continue;

                        row.RowNr = row.RowNr - 1;
                    }
                }
            }

            int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, customerInvoice.CurrencyId);
            int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
            result = UpdateInvoiceAfterRowModification(entities, customerInvoice, accountRowNr, actorCompanyId, false, sysCurrencyIdInvoice != sysCurrencyIdBase);

            if (!result.Success)
                return result;

            if (result.Success && saveChanges)
                result = SaveChanges(entities, transaction);

            return result;
        }

        public ActionResult DeleteCustomerInvoiceRow(TransactionScope transaction, CompEntities entities, int actorCompanyId, CustomerInvoice customerInvoice, int invoiceRowId, bool saveChanges = false, bool reNumberRows = false, bool updateInvoice = true)
        {
            #region Prereq

            int rowNr = 1;
            int accountRowNr = 2; // Claim has number 1
            CalculateNextRowNbrs(customerInvoice, ref rowNr, ref accountRowNr);

            #endregion

            var result = DeleteCustomerInvoiceRow(transaction, entities, customerInvoice, invoiceRowId, actorCompanyId);
            if (!result.Success)
                return result;

            if (reNumberRows && customerInvoice.CustomerInvoiceRow != null && customerInvoice.CustomerInvoiceRow.Count > 0)
            {
                var deletedRow = customerInvoice.CustomerInvoiceRow.FirstOrDefault(x => x.CustomerInvoiceRowId == invoiceRowId);
                if (deletedRow != null)
                {
                    foreach (var row in customerInvoice.ActiveCustomerInvoiceRows.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.TextRow || r.Type == (int)SoeInvoiceRowType.PageBreakRow || r.Type == (int)SoeInvoiceRowType.SubTotalRow))
                    {
                        if (row.RowNr == 0 || row.RowNr <= deletedRow.RowNr)
                            continue;

                        row.RowNr = row.RowNr - 1;
                    }
                }
            }

            if (updateInvoice)
            {
                int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, customerInvoice.CurrencyId);
                int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                result = UpdateInvoiceAfterRowModification(entities, customerInvoice, accountRowNr, actorCompanyId, false, sysCurrencyIdInvoice != sysCurrencyIdBase);

                if (!result.Success)
                    return result;
            }

            if (result.Success && saveChanges)
                result = SaveChanges(entities, transaction);

            return result;
        }
        public ActionResult DeleteCustomerInvoiceRow(TransactionScope transaction, CompEntities entities, CustomerInvoice customerInvoice, int invoiceRowId, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            CustomerInvoiceRow invoiceRow = customerInvoice.CustomerInvoiceRow.FirstOrDefault(x => x.CustomerInvoiceRowId == invoiceRowId);
            if (invoiceRow == null)
            {
                invoiceRow = GetCustomerInvoiceRow(entities, invoiceRowId);
            }

            if (invoiceRow == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoiceRow");

            int householdProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductHouseholdTaxDeduction, 0, actorCompanyId, 0);

            #region Fixed Price Product

            if (invoiceRow.ProductId.HasValue && customerInvoice.FixedPriceOrder)
            {
                int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                if (fixedPriceProductId == invoiceRow.ProductId.Value)
                {
                    bool otherFixedPriceProductsExists = (from cir in entities.CustomerInvoiceRow
                                                          where cir.InvoiceId == customerInvoice.InvoiceId &&
                                                          cir.ProductId.HasValue &&
                                                          cir.ProductId.Value == fixedPriceProductId &&
                                                          cir.CustomerInvoiceRowId != invoiceRow.CustomerInvoiceRowId &&
                                                          cir.State == (int)SoeEntityState.Active
                                                          select cir).Count() > 0;

                    if (!otherFixedPriceProductsExists)
                        customerInvoice.FixedPriceOrder = false;
                }
            }

            if (invoiceRow.ProductId.HasValue && householdProductId != 0 && invoiceRow.ProductId.Value == householdProductId)
            {
                CustomerInvoiceRow textRow = GetHouseholdDeductionTextRow(entities, invoiceRowId);
                if (textRow != null)
                {
                    // Delete existing textrow
                    ChangeEntityState(textRow, SoeEntityState.Deleted);
                }

                HouseholdTaxDeductionRow deductionRow = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRow(entities, invoiceRowId);
                if (deductionRow != null)
                {
                    // Delete existing deductionrow
                    ChangeEntityState(deductionRow, SoeEntityState.Deleted);
                }
            }

            #endregion

            // Delete existing CustomerInvoiceRow
            ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

            HandleStockOnInvoiceRowDelete(entities, transaction, customerInvoice, invoiceRow, true);

            //Delete connected accountrows
            SetAccountRowsAsDeleted(invoiceRow);

            return result;
        }

        public ActionResult SaveOriginUsers(TransactionScope transaction, CompEntities entities, int originId, List<OriginUserDTO> originUsers, int actorCompanyId, int licenseId, bool sendXEMail = false, string subject = "", string text = "", bool dontSendPush = false, TermGroup_MessageType messageType = TermGroup_MessageType.None)
        {
            if (entities.Connection.State != ConnectionState.Open)
                entities.Connection.Open();

            // Get origin
            Origin origin = OriginManager.GetOrigin(entities, originId, true);

            if (originUsers == null)
                originUsers = new List<OriginUserDTO>();
            if (origin.OriginUser == null)
                origin.OriginUser = new EntityCollection<OriginUser>();

            foreach (OriginUserDTO originUser in originUsers)
            {
                OriginUser existingUser = origin.OriginUser.FirstOrDefault(u => u.UserId == originUser.UserId);
                if (existingUser != null)
                {
                    #region Update

                    // User exists on origin
                    if (existingUser.State != (int)SoeEntityState.Active)
                    {
                        // User is deleted or inactive, reactivate it
                        existingUser.State = (int)SoeEntityState.Active;
                        SetModifiedProperties(existingUser);
                    }
                    if (existingUser.Main != originUser.Main)
                    {
                        existingUser.Main = originUser.Main;
                        SetModifiedProperties(existingUser);
                    }

                    #endregion
                }
                else
                {
                    #region Add

                    User newUser = UserManager.GetUser(entities, originUser.UserId);
                    if (newUser != null)
                    {
                        OriginUser newOriginUser = new OriginUser();
                        newOriginUser.Origin = origin;
                        newOriginUser.User = newUser;
                        newOriginUser.Main = originUser.Main;
                        newOriginUser.Status = (int)OriginUserStatus.UnRead;
                        origin.OriginUser.Add(newOriginUser);
                        SetCreatedProperties(newOriginUser);
                    }

                    #endregion
                }
            }

            #region Delete

            // Remove deleted users
            foreach (OriginUser originUser in origin.OriginUser.Where(o => o.State == (int)SoeEntityState.Active))
            {
                if (originUser.User == null || !originUsers.Any(u => u.UserId == originUser.User.UserId && u.State == (int)SoeEntityState.Active))
                {
                    ChangeEntityState(entities, originUser, SoeEntityState.Deleted, false);
                }
            }

            //Remove deleted users mail
            List<MessageRecipient> recipients = CommunicationManager.GetMessageRecipients(entities, (int)SoeEntityType.Order, originId);
            if (recipients.Count > 0)
            {
                foreach (MessageRecipient rec in recipients)
                {
                    if (!originUsers.Any(u => u.UserId == rec.UserId))
                        ChangeEntityState(entities, rec, SoeEntityState.Deleted, false);
                }
            }

            #endregion

            var result = SaveChanges(entities, transaction);

            #region Send mail

            if (sendXEMail)
            {
                User sender = UserManager.GetUser(entities, base.UserId);

                if (sender != null)
                {
                    MessageEditDTO message = new MessageEditDTO()
                    {
                        Entity = SoeEntityType.Order,
                        RecordId = originId,
                        ActorCompanyId = actorCompanyId,
                        LicenseId = licenseId,
                        SenderUserId = base.UserId,
                        Subject = subject,
                        Text = text,
                        ShortText = text,
                        SenderName = sender.Name,
                        SenderEmail = sender.Email,
                        Created = DateTime.Now,
                        SentDate = DateTime.Now,
                        MessagePriority = TermGroup_MessagePriority.None,
                        MessageType = messageType,
                        MessageDeliveryType = TermGroup_MessageDeliveryType.XEmail,
                        MessageTextType = TermGroup_MessageTextType.HTML,
                    };

                    foreach (OriginUserDTO originUser in originUsers)
                    {
                        User user = UserManager.GetUser(entities, originUser.UserId);
                        if (user != null)
                        {
                            MessageRecipientDTO rec = new MessageRecipientDTO()
                            {
                                UserId = user.UserId,
                                SendCopyAsEmail = false,
                                UserName = user.LoginName,
                                Name = user.Name,
                                EmailAddress = user.Email,
                                Type = XEMailRecipientType.User,
                            };

                            message.Recievers.Add(rec);
                        }
                    }

                    var sendMailResult = CommunicationManager.SendXEMail(transaction, entities, message, actorCompanyId, 0, base.UserId, true, dontSendPush);
                    if (!sendMailResult.Success && sendMailResult.ErrorNumber != 4469)
                        return sendMailResult;
                    else if (dontSendPush && sendMailResult.IntegerValue > 0)
                        result.IntegerValue = sendMailResult.IntegerValue;
                }
            }

            #endregion

            return result;
        }

        public ActionResult SaveOriginUsers(int originId, List<OriginUserDTO> originUsers, int actorCompanyId, int licenseId, bool sendXEMail = false, string subject = "", string text = "")
        {
            ActionResult result;

            using (CompEntities entities = new CompEntities())
            {
                if (entities.Connection.State != ConnectionState.Open)
                    entities.Connection.Open();

                Origin origin = OriginManager.GetOrigin(entities, originId, true);

                if (originUsers == null)
                    originUsers = new List<OriginUserDTO>();
                if (origin.OriginUser == null)
                    origin.OriginUser = new EntityCollection<OriginUser>();

                foreach (OriginUserDTO originUser in originUsers)
                {
                    OriginUser existingUser = origin.OriginUser.FirstOrDefault(u => u.User != null && u.User.UserId == originUser.UserId);
                    if (existingUser != null)
                    {
                        #region Update

                        // User exists on origin
                        if (existingUser.State != (int)SoeEntityState.Active)
                        {
                            // User is deleted or inactive, reactivate it
                            existingUser.State = (int)SoeEntityState.Active;
                            SetModifiedProperties(existingUser);
                        }
                        if (existingUser.Main != originUser.Main)
                        {
                            existingUser.Main = originUser.Main;
                            SetModifiedProperties(existingUser);
                        }

                        #endregion
                    }
                    else
                    {
                        #region Add

                        User newUser = UserManager.GetUser(entities, originUser.UserId);
                        if (newUser != null)
                        {
                            OriginUser newOriginUser = new OriginUser();
                            newOriginUser.Origin = origin;
                            newOriginUser.User = newUser;
                            newOriginUser.Main = originUser.Main;
                            origin.OriginUser.Add(newOriginUser);
                            SetCreatedProperties(newOriginUser);
                        }

                        #endregion
                    }
                }

                #region Delete

                // Remove deleted users
                foreach (OriginUser originUser in origin.OriginUser.Where(o => o.State == (int)SoeEntityState.Active))
                {
                    if (originUser.User == null || !originUsers.Any(u => u.UserId == originUser.User.UserId && u.State == (int)SoeEntityState.Active))
                    {
                        ChangeEntityState(originUser, SoeEntityState.Deleted);
                    }
                }

                //Remove deleted users mail
                List<MessageRecipient> recipients = CommunicationManager.GetMessageRecipients(entities, (int)SoeEntityType.Order, originId);
                if (recipients.Count > 0)
                {
                    foreach (MessageRecipient rec in recipients)
                    {
                        if (!originUsers.Any(u => u.UserId == rec.UserId))
                            ChangeEntityState(rec, SoeEntityState.Deleted);
                    }
                }

                #endregion

                result = SaveChanges(entities);
            }

            #region Send mail

            if (sendXEMail)
            {
                UserDTO user = UserManager.GetUser(parameterObject.UserId).ToDTO();

                MessageEditDTO message = new MessageEditDTO()
                {
                    Entity = SoeEntityType.Order,
                    RecordId = originId,
                    ActorCompanyId = actorCompanyId,
                    LicenseId = licenseId,
                    SenderUserId = base.UserId,
                    Subject = subject,
                    Text = text,
                    ShortText = text,
                    SenderName = (user ?? parameterObject.SoeUser).Name,
                    SenderEmail = (user ?? parameterObject.SoeUser).Email,
                    Created = DateTime.Now,
                    SentDate = DateTime.Now,
                    MessagePriority = TermGroup_MessagePriority.None,
                    MessageType = TermGroup_MessageType.None,
                    MessageDeliveryType = TermGroup_MessageDeliveryType.XEmail,
                    MessageTextType = TermGroup_MessageTextType.HTML,
                };

                foreach (OriginUserDTO originUser in originUsers)
                {
                    User oUser = UserManager.GetUser(originUser.UserId);
                    if (oUser != null)
                    {
                        MessageRecipientDTO rec = new MessageRecipientDTO()
                        {
                            UserId = oUser.UserId,
                            SendCopyAsEmail = false,
                            UserName = oUser.LoginName,
                            Name = oUser.Name,
                            EmailAddress = oUser.Email,
                            Type = XEMailRecipientType.User,
                        };

                        message.Recievers.Add(rec);
                    }
                }

                CommunicationManager.SendXEMail(message, actorCompanyId, base.RoleId, base.UserId, true);
            }

            #endregion

            return result;
        }

        public ActionResult UnlockCustomerInvoice(int invoiceId, int actorCompanyId)
        {
            // Default result is successful
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        // Get CustomerInvoice
                        CustomerInvoice invoice = GetCustomerInvoice(entities, invoiceId);
                        if (invoice == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");
                        if (invoice.Origin == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "Origin");

                        if (invoice.RegistrationType == (int)OrderInvoiceRegistrationType.Order)
                        {
                            // Status must be Closed, Cancel or fully invoiced
                            if (invoice.Origin.Status != (int)SoeOriginStatus.OrderClosed && invoice.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice && invoice.Origin.Status != (int)SoeOriginStatus.Cancel)
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition, string.Format(GetText(7764, "{0} har en felaktig status för att öppnas."), GetText(invoice.Origin.Type, (int)TermGroup.OriginType)));

                            InitializeAttestStateIds(entities, actorCompanyId);

                            // Check row statuses
                            bool isAllRowsClosed = true;
                            foreach (CustomerInvoiceRow customerInvoiceRow in invoice.ActiveCustomerInvoiceRows)
                            {
                                bool isRowClosed = false;
                                bool isRowTransferred = false;
                                SoeOriginType transferredTo = SoeOriginType.None;

                                InvoiceAttestStatesIds.DetermineTransferredState(invoice, customerInvoiceRow, ref isRowTransferred, ref isRowClosed, ref transferredTo);
                                if (!isRowClosed)
                                {
                                    isAllRowsClosed = false;
                                    break;
                                }
                            }

                            if (invoice.Origin.Status == (int)SoeOriginStatus.Cancel)
                            {
                                // See if any closed project are attached and open them
                                if (!invoice.ProjectReference.IsLoaded)
                                    invoice.ProjectReference.Load();

                                if (invoice.Project != null && invoice.Project.State != (int)SoeEntityState.Active)
                                {
                                    invoice.Project.State = (int)SoeEntityState.Active;
                                    SetModifiedProperties(invoice.Project);
                                }
                            }

                            // If all rows closed, reset status back to Origin, otherwise partly invoiced
                            invoice.Origin.Status = (int)(isAllRowsClosed ? SoeOriginStatus.Origin : SoeOriginStatus.OrderPartlyInvoice);
                            ProjectManager.ChangeStopDateForHiddenProject(entities, invoice);
                            SetModifiedProperties(invoice);
                        }
                        else if (invoice.RegistrationType == (int)OrderInvoiceRegistrationType.Offer)
                        {
                            // Status must be Closed, Cancel or fully invoiced
                            if (invoice.Origin.Status != (int)SoeOriginStatus.OfferClosed &&
                                invoice.Origin.Status != (int)SoeOriginStatus.OfferFullyInvoice &&
                                invoice.Origin.Status != (int)SoeOriginStatus.OfferFullyOrder &&
                                invoice.Origin.Status != (int)SoeOriginStatus.Cancel)
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition, string.Format(GetText(7764, "{0} har en felaktig status för att öppnas."), GetText(invoice.Origin.Type, (int)TermGroup.OriginType)));

                            InitializeAttestStateIds(entities, actorCompanyId);

                            // Check row statuses
                            bool isAllRowClosed = true;
                            SoeOriginType transferredTo = SoeOriginType.None;
                            foreach (var customerInvoiceRow in invoice.ActiveCustomerInvoiceRows.Where(r => r.Type != (int)SoeInvoiceRowType.AccountingRow && !r.IsCentRoundingRow))
                            {
                                bool isRowClosed = false;
                                bool isRowTransferred = false;

                                InvoiceAttestStatesIds.DetermineTransferredState(invoice, customerInvoiceRow, ref isRowTransferred, ref isRowClosed, ref transferredTo);
                                if (!isRowClosed)
                                {
                                    isAllRowClosed = false;
                                    break;
                                }
                            }

                            // If all rows closed, reset status back to Origin, otherwise partly
                            if (isAllRowClosed || invoice.Origin.Status == (int)SoeOriginStatus.OfferClosed)
                            {
                                invoice.Origin.Status = (int)SoeOriginStatus.Origin;
                            }
                            else
                            {
                                invoice.Origin.Status = invoice.Origin.Status == (int)SoeOriginStatus.OfferFullyInvoice ? (int)SoeOriginStatus.OfferPartlyInvoice : (int)SoeOriginStatus.OfferPartlyOrder;
                            }

                            SetModifiedProperties(invoice);
                        }
                        else if (invoice.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice)
                        {
                            // Status must be Origin
                            if (invoice.Origin.Status != (int)SoeOriginStatus.Origin)
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition);

                            // Reset status back to Draft
                            invoice.Origin.Status = (int)SoeOriginStatus.Draft;
                            SetModifiedProperties(invoice);
                        }

                        result = SaveChanges(entities, transaction);

                        // Commit transaction
                        if (result.Success)
                        {
                            transaction.Complete();
                        }
                        else
                        {
                            result.ErrorMessage = string.Format(GetText(7765, "Ett fel uppstod, {0} kunde inte öppnas."), GetText(invoice.Origin.Type, (int)TermGroup.OriginType));
                        }

                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                    {
                        base.LogTransactionFailed(this.ToString(), this.log);
                    }


                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult CloseOrderOffer(int invoiceId)
        {
            // Default result is successful
            ActionResult result = new ActionResult();

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        // Get CustomerInvoice
                        CustomerInvoice invoice = GetCustomerInvoice(entities, invoiceId);
                        if (invoice == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");
                        if (invoice.Origin == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "Origin");

                        if (invoice.Origin.Type == (int)SoeOriginType.Order)
                        {
                            // Status can be Partly, Fully or Origin? : Bug 12029
                            if (invoice.Origin.Status == (int)SoeOriginStatus.OrderPartlyInvoice ||
                                invoice.Origin.Status == (int)SoeOriginStatus.OrderFullyInvoice ||
                                invoice.Origin.Status == (int)SoeOriginStatus.Origin)
                            {
                                // Set status OrderFullyInvoice
                                invoice.Origin.Status = (int)SoeOriginStatus.OrderFullyInvoice;
                                SetModifiedProperties(invoice);
                                ProjectManager.ChangeStopDateForHiddenProject(entities, invoice);
                            }
                            else
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition);
                        }
                        else if (invoice.Origin.Type == (int)SoeOriginType.Offer)
                        {
                            SoeOriginStatus newStatus;

                            if (invoice.Origin.Status == (int)SoeOriginStatus.OfferPartlyOrder ||
                                invoice.Origin.Status == (int)SoeOriginStatus.OfferFullyOrder)
                            {
                                // Set status OrderFullyInvoice
                                newStatus = SoeOriginStatus.OfferFullyOrder;
                            }
                            else if (invoice.Origin.Status == (int)SoeOriginStatus.OfferPartlyInvoice ||
                                invoice.Origin.Status == (int)SoeOriginStatus.OfferFullyInvoice)
                            {
                                newStatus = SoeOriginStatus.OfferFullyInvoice;
                            }
                            else if (invoice.Origin.Status == (int)SoeOriginStatus.Origin)
                            {
                                newStatus = SoeOriginStatus.OfferClosed;
                            }
                            else
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition);

                            invoice.Origin.Status = (int)newStatus;
                            SetModifiedProperties(invoice);
                        }
                        result = SaveChanges(entities, transaction);

                        // Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult SetOrderKeepAsPlanned(int orderId, int actorCompanyId, bool keepAsPlanned)
        {
            // Default result is successful
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                CustomerInvoice invoice = (from i in entities.Invoice.OfType<CustomerInvoice>()
                                           where i.InvoiceId == orderId &&
                                           i.Origin.ActorCompanyId == actorCompanyId &&
                                           i.State == (int)SoeEntityState.Active
                                           select i).FirstOrDefault();

                if (invoice == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                invoice.KeepAsPlanned = keepAsPlanned;
                SetModifiedProperties(invoice);

                result = SaveChanges(entities);
            }

            return result;
        }

        public ActionResult SaveCustomerInvoiceWorkingDescription(int invoiceId, string workingDescription)
        {
            // Default result is successful
            ActionResult result = new ActionResult();

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        // Get CustomerInvoice
                        CustomerInvoice invoice = GetCustomerInvoice(entities, invoiceId);
                        if (invoice == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(5605, "Ordern hittades inte"));


                        invoice.WorkingDescription = workingDescription;

                        result = SaveChanges(entities, transaction);

                        // Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult SetOrderMyOriginStatus(List<int> orderIds, int userId, OriginUserStatus status)
        {
            var result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                foreach (int orderId in orderIds)
                {
                    var originUser = GetOriginUser(entities, orderId, userId);
                    if (originUser == null)
                    {
                        result.Success = false;
                        return result;
                    }

                    originUser.Status = (int)status;
                }

                entities.SaveChanges();
                result.Success = true;
            }

            return result;
        }

        public IEnumerable<OrderMapDTO> GetOrderMaps(List<int> invoiceIds, DateTime? dateFrom, DateTime? dateTo)
        {
            var records = new List<OrderMapDTO>();
            if (invoiceIds.Count == 0)
            {
                return records;
            }

            if (dateFrom.HasValue)
                dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom.Value);
            if (dateTo.HasValue)
                dateTo = CalendarUtility.GetEndOfDay(dateTo.Value);


            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.OfType<CustomerInvoice>().AsNoTracking();
            entitiesReadOnly.ContactAddress.NoTracking();
            entitiesReadOnly.ContactAddressRow.NoTracking();
            var invoices = (from i in entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                                .Include("Actor.Customer")
                                .Include("TimeScheduleTemplateBlock.Employee.ContactPerson")
                                .Include("ShiftType")
                            where invoiceIds.Contains(i.InvoiceId)
                            select i).ToList();

            // Build addresses
            foreach (var invoice in invoices)
            {
                string adr = string.Empty;
                if (!string.IsNullOrEmpty(invoice.InvoiceHeadText))
                    adr = invoice.InvoiceHeadText.Replace('\r', ' ');
                else
                {
                    int contactAddressId = 0;
                    if (invoice.DeliveryAddressId != 0)
                        contactAddressId = invoice.DeliveryAddressId;
                    else if (invoice.BillingAddressId != 0)
                        contactAddressId = invoice.BillingAddressId;

                    if (contactAddressId != 0)
                    {
                        var addresses = (from v in entitiesReadOnly.CustomerContactAddressRowView
                                         where v.ContactAddressId == contactAddressId
                                         select v).ToList();
                        var address = addresses.FirstOrDefault(a => a.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address);
                        var postalCode = addresses.FirstOrDefault(a => a.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode);
                        var postalAddress = addresses.FirstOrDefault(a => a.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress);
                        adr = String.Format("{0}, {1} {2}", address != null ? address.Text : String.Empty, postalCode != null ? postalCode.Text : String.Empty, postalAddress != null ? postalAddress.Text : String.Empty);
                    }
                }

                if (!string.IsNullOrEmpty(adr))
                {
                    OrderMapDTO dto = new OrderMapDTO
                    {
                        ID = invoice.InvoiceId,
                        OrderNr = invoice.SeqNr,
                        CustomerName = invoice.Actor != null && invoice.Actor.Customer != null ? invoice.Actor.Customer.Name : String.Empty,
                        WorkingDescription = invoice.WorkingDescription,
                        Address = adr
                    };

                    // Shifts
                    dto.Shifts = new List<OrderMapShiftDTO>();
                    foreach (var block in invoice.TimeScheduleTemplateBlock.Where(b => (!dateFrom.HasValue || b.Date >= dateFrom.Value) && (!dateTo.HasValue || b.Date <= dateTo.Value) && b.State == (int)SoeEntityState.Active).OrderBy(b => b.Date).ThenBy(b => b.StartTime))
                    {
                        OrderMapShiftDTO shift = new OrderMapShiftDTO()
                        {
                            Start = CalendarUtility.MergeDateAndTime(block.Date.Value, block.StartTime),
                            EmployeeNr = block.Employee.EmployeeNr,
                            EmployeeName = block.Employee.Name,
                            ShiftTypeName = block.ShiftType != null ? block.ShiftType.Name : String.Empty
                        };
                        shift.End = shift.Start.Add(block.StopTime - block.StartTime);

                        dto.Shifts.Add(shift);
                    }

                    records.Add(dto);
                }
            }

            return records;
        }

        public ActionResult SaveOrderPlanningData(int orderId, int? shiftTypeId, DateTime? plannedStartDate, DateTime? plannedStopDate, int estimatedTime, int remainingTime, int? priority)
        {
            ActionResult result = new ActionResult();

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        // Get CustomerInvoice
                        CustomerInvoice order = GetCustomerInvoice(entities, orderId);
                        if (order == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(5605, "Ordern hittades inte"));

                        order.ShiftTypeId = shiftTypeId;
                        order.PlannedStartDate = plannedStartDate;
                        order.PlannedStopDate = plannedStopDate;
                        order.EstimatedTime = estimatedTime;
                        order.RemainingTime = remainingTime;
                        // TODO: KeepAsPlanned not supported in mobile, so do not update it (sent as false from service now)
                        //order.KeepAsPlanned = keepAsPlanned;
                        order.Priority = priority;

                        result = SaveChanges(entities, transaction);

                        // Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult TransferCustomerInvoices(List<CustomerInvoiceGridDTO> items, SoeOriginStatusChange statusChange, int paymentMethodId, bool mergeInvoices, int claimLevel, DateTime? bulkPayDate, DateTime? bulkInvoiceDate, DateTime? bulkDueDate, DateTime? bulkVoucherDate, bool keepFixedPriceOrderOpen, bool checkPartianInvoicing, bool createCopiesOfTransferedContractRows, bool setStatusToOrigin = false, int? emailTemplateId = null, int? reportId = null, int? languageId = null, bool mergePdfs = false, bool overrideWarnings = false)
        {
            var result = new ActionResult(false);
            PaymentManager pm = new PaymentManager(parameterObject);
            OriginManager om = new OriginManager(parameterObject);
            ImportExportManager iem = new ImportExportManager(parameterObject);
            var eim = new ElectronicInvoiceMananger(parameterObject);
            var invDisr = new InvoiceDistributionManager(parameterObject);

            // Email values
            string validationMessage = String.Empty;
            List<CustomerInvoice> invoicesToSend = null;

            switch (statusChange)
            {
                #region General
                case SoeOriginStatusChange.DraftToOrigin:
                    result = om.UpdateOriginStatus(items, SoeOriginStatus.Origin, base.ActorCompanyId, bulkInvoiceDate, bulkDueDate, bulkVoucherDate);
                    break;
                case SoeOriginStatusChange.OriginToVoucher:
                    result = TransferCustomerInvoicesToVoucher(items, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.OriginToMatched:
                    result = AddMatchUpdateInvoicePaymentStatus(items, base.ActorCompanyId);
                    break;
                #endregion

                #region CustomerInvoice
                case SoeOriginStatusChange.CustomerInvoice_OriginToPayment:
                    if (paymentMethodId > 0)
                        result = pm.SavePaymentFromCustomerInvoice(items, bulkPayDate, paymentMethodId, base.ActorCompanyId, false); //Foreign flag not in use
                    break;
                case SoeOriginStatusChange.CustomerInvoice_DraftToInvoiceAndPrintInvoice:
                    result = om.UpdateOriginStatus(items, SoeOriginStatus.Origin, base.ActorCompanyId, bulkInvoiceDate, bulkDueDate, bulkVoucherDate);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportSOP:
                    result = iem.CreateSOPCustomerInvoiceExportFile(items, base.ActorCompanyId, base.UserId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportDIRegnskap:
                    result = iem.CreateDIRegnCustomerInvoiceExportFile(items, base.ActorCompanyId, base.UserId, false);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportUniMicro:
                    result = iem.CreateUniMicroCustomerInvoiceExportFile(items, base.ActorCompanyId, base.UserId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportDnBNor:
                    result = iem.CreateDnBNorCustomerInvoiceExportFile(items, base.ActorCompanyId, base.UserId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_InvoiceToReminder:
                    result = SaveReminderCustomerInvoice(items, mergeInvoices, base.ActorCompanyId, base.UserId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_UpdateReminderLevel:
                    result = UpdateReminderLevel(items, claimLevel, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_InvoiceToInterest:
                    result = SaveInterestCustomerInvoice(items, mergeInvoices, base.ActorCompanyId, base.UserId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_InvoiceToClosed:
                    result = CloseInterestCustomerInvoice(items, base.UserId, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_DraftToInvoice_And_SendEInvoice:
                case SoeOriginStatusChange.CustomerInvoice_DraftToInvoice_And_CreateEInvoice:
                    ActionResult result1st = om.UpdateOriginStatus(items, SoeOriginStatus.Origin, base.ActorCompanyId, bulkInvoiceDate, bulkDueDate, bulkVoucherDate);
                    if (result1st.Success)
                        result = eim.CreateEInvoice(items, base.ActorCompanyId, base.UserId, statusChange == SoeOriginStatusChange.CustomerInvoice_DraftToInvoice_And_CreateEInvoice);
                    else
                        result = result1st;
                    break;
                case SoeOriginStatusChange.CustomerInvoice_EInvoice_Send:
                    result = eim.CreateEInvoice(items, base.ActorCompanyId, base.UserId, false);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_EInvoice_Create:
                    result = eim.CreateEInvoice(items, base.ActorCompanyId, base.UserId, true, overrideWarnings);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_SendAsEmail:
                    invoicesToSend = ValidateInvoiceEmails(items, out validationMessage);
                    result.Success = true;
                    result.ErrorMessage = validationMessage;
                    Task.Run(() => CompEntitiesProvider.RunWithTaskScopedReadOnlyEntities(() => invDisr.SendAsEmails(invoicesToSend, base.ActorCompanyId, this.parameterObject, emailTemplateId, reportId, languageId, mergePdfs)));
                    break;
                case SoeOriginStatusChange.CustomerInvoice_SendReminderAsEmail:
                    result.Success = true;
                    invDisr.SendRemindersAsEmails(items, base.ActorCompanyId, this.parameterObject, emailTemplateId);
                    //Task.Run(() => invDisr.SendRemindersAsEmails(items, base.ActorCompanyId, this.parameterObject, emailTemplateId));
                    break;
                case SoeOriginStatusChange.CustomerInvoice_DraftToInvoiceAndSendAsEmail:
                    ActionResult transferResult = om.UpdateOriginStatus(items, SoeOriginStatus.Origin, base.ActorCompanyId, bulkInvoiceDate, bulkDueDate, bulkVoucherDate);
                    if (transferResult.Success)
                    {
                        invoicesToSend = ValidateInvoiceEmails(items, out validationMessage);
                        result.Success = true;
                        result.ErrorMessage = validationMessage;
                        Task.Run(() => CompEntitiesProvider.RunWithTaskScopedReadOnlyEntities(() => invDisr.SendAsEmails(invoicesToSend, base.ActorCompanyId, this.parameterObject, emailTemplateId, reportId, languageId, mergePdfs)));
                    }
                    else
                        result = transferResult;
                    break;
                case SoeOriginStatusChange.CustomerInvoice_Delete:
                    result = this.DeleteInvoices(items.Select(i => i.CustomerInvoiceId).ToList(), base.ActorCompanyId, true, true);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportFortnox:
                    result = eim.CreateFortnoxInvoices(items.OrderBy(i => i.SeqNr).Select(i => i.CustomerInvoiceId).ToList(), base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportVismaEAccounting:
                    result = eim.CreateVismaEAccountingInvoices(items.OrderBy(i => i.SeqNr).Select(i => i.CustomerInvoiceId).ToList(), base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.CustomerInvoice_OriginToExportZetes:
                    result = iem.ExportToZetes(items, base.ActorCompanyId, false);
                    break;
                #endregion

                #region CustomerPayment
                case SoeOriginStatusChange.CustomerPayment_PayedToVoucher:
                    result = pm.TransferPaymentRowsToVoucher(items, SoeOriginType.CustomerPayment, false, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.CustomerPayment_PayedToExportDIRegnskap:
                    result = iem.CreateDIRegnCustomerInvoiceExportFile(items, base.ActorCompanyId, base.UserId, true);
                    break;
                case SoeOriginStatusChange.CustomerPayment_PayedToZetes:
                    result = iem.ExportToZetes(items, base.ActorCompanyId, true);
                    break;
                #endregion

                #region Billing

                case SoeOriginStatusChange.Billing_DraftToOffer:
                    result = om.UpdateOriginStatus(items, SoeOriginStatus.Origin, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_DraftToOrder:
                    result = om.UpdateOriginStatus(items, SoeOriginStatus.Origin, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_OfferToOrder:
                    result = CreateOrderFromOffers(items, true, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_OfferToPriceOptimization:
                case SoeOriginStatusChange.Billing_OrderToPriceOptimization:
                    result = PriceOptimizationManager.CreatePriceOptimization(items.Select(po => po.CustomerInvoiceId).FirstOrDefault(), statusChange, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_OfferToInvoice:
                    result = CreateInvoiceFromOffers(items, mergeInvoices, setStatusToOrigin, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_OrderToInvoice:
                case SoeOriginStatusChange.Billing_OrderToInvoiceAndPrint:
                    result = CreateInvoiceFromOrder(items, mergeInvoices, setStatusToOrigin, base.ActorCompanyId, keepFixedPriceOrderOpen, checkPartianInvoicing, createCopiesOfTransferedContractRows);
                    break;
                case SoeOriginStatusChange.Billing_OrderToDeleted:
                    result = this.DeleteInvoices(items.Select(i => i.CustomerInvoiceId).ToList(), base.ActorCompanyId, true, false);
                    break;
                case SoeOriginStatusChange.Billing_ContractToOrder:
                    result = CreateOrderFromContracts(items, setStatusToOrigin, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_ContractToServiceOrder:
                    result = CreateServiceOrderFromContracts(items, setStatusToOrigin, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_ContractToInvoice:
                    result = CreateInvoiceFromContracts(items, mergeInvoices, setStatusToOrigin, base.ActorCompanyId);
                    break;
                case SoeOriginStatusChange.Billing_ContractToClosed:
                    result = om.UpdateOriginStatus(items, SoeOriginStatus.ContractClosed, base.ActorCompanyId);
                    break;
                    /*case SoeOriginStatusChange.Billing_OrderToContract:
                        result = TransferToContractFromOrder(items, base.ActorCompanyId, existingContractId, p.ContractGroupId, p.ContractStartDate, p.SetInvoicingDateNextPeriod);
                        break;*/

                #endregion
            }

            return result;
        }

        public List<CustomerInvoice> ValidateInvoiceEmails(List<CustomerInvoiceGridDTO> items, out string message)
        {
            var invoices = new List<CustomerInvoice>();
            message = String.Empty;

            foreach (var item in items)
            {
                CustomerInvoice invoice = GetCustomerInvoice(item.CustomerInvoiceId, loadActor: true, loadOriginInvoiceMapping: true);
                if (invoice == null)
                    continue;

                invoices.Add(invoice);
                if (invoice.ContactEComId.GetValueOrDefault() == 0 && (invoice.CustomerEmail == null || string.IsNullOrEmpty(invoice.CustomerEmail.Trim())) && string.IsNullOrEmpty(message))
                    message = GetText(7625, "En eller flera fakturor saknar e-postadress.  Vänligen kontrollera status under Försäljning > Rapporter > Elektroniska utskick");
            }

            return invoices;
        }
        public CustomerInvoiceDistributionResultDTO AutomaticInvoiceDistribution(int actorCompanyId, List<CustomerInvoiceGridDTO> invoices)
        {
            /* Automatic distribution of invoices means the user can rely on the settings they have done in the system to 
             * automatically distribute invoices to the correct recipient, with the appropiate settings.
             * 
             * Steps:
             *  1. Validate that the user has appropiate permissions.
             *  2. Prepare information required for making correct distribution
             *      - Company settings (default report templates, language, etc.)
             *      - Customer settings (default report templates, language, etc.)
             *      - Customer invoices (selected invoices with required data)
             *  3. Distribute work depending on type:
             *      - Printout (queue job)
             *      - Email (new task)
             *      - E-invoice (new task)
             *  4. Return when work has been distributed/performed.
             */

            var result = new CustomerInvoiceDistributionResultDTO();
            var emailInvoices = invoices
                .Where(i => i.DeliveryType == (int)SoeInvoiceDeliveryType.Email)
                .ToList();
            var eInvoices = invoices
                .Where(i => i.DeliveryType == (int)SoeInvoiceDeliveryType.Electronic)
                .ToList();
            var printInvoices = invoices
                .Where(i => i.DeliveryType == (int)SoeInvoiceDeliveryType.Print)
                .ToList();

            result.PermissionCheck = HasInvoiceDistributionPermissions();
            if (!result.PermissionCheck.Success)
                return result;

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            result.PrintResult = TriggerInvoicePrint(entities, printInvoices);
            result.EmailResult = AutomaticEmailDistribution(entities, emailInvoices);
            result.EInvoiceResult = AutomaticEInvoiceDistribution(eInvoices);

            result.UnhandledCount = invoices
                .Count(i => i.DeliveryType == (int)SoeInvoiceDeliveryType.Unknown);
            result.PrintedCount = printInvoices.Count();
            result.EInvoicedCount = eInvoices.Count();
            result.EmailedCount = emailInvoices.Count();

            return result;
        }

        public ActionResult HasInvoiceDistributionPermissions()
        {
            var economySelection = FeatureManager.HasRolePermission(Feature.Economy_Distribution_Reports_Selection, Permission.Modify, this.RoleId, this.ActorCompanyId);
            var economyDownload = FeatureManager.HasRolePermission(Feature.Economy_Distribution_Reports_Selection_Download, Permission.Modify, this.RoleId, this.ActorCompanyId);
            var billingSelection = FeatureManager.HasRolePermission(Feature.Billing_Distribution_Reports_Selection, Permission.Modify, this.RoleId, this.ActorCompanyId);
            var billingDownload = FeatureManager.HasRolePermission(Feature.Billing_Distribution_Reports_Selection_Download, Permission.Modify, this.RoleId, this.ActorCompanyId);
            var hasInvoicePermission = FeatureManager.HasRolePermission(Feature.Billing_Invoice_Invoices, Permission.Modify, this.RoleId, this.ActorCompanyId);
            var hasEInvoicesPermission = FeatureManager.HasRolePermission(Feature.Billing_Invoice_Invoices_Edit_EInvoice, Permission.Modify, this.RoleId, this.ActorCompanyId);

            var hasReportPermission = (economySelection && economyDownload) || (billingSelection && billingDownload);

            if (!hasReportPermission || !hasInvoicePermission || !hasEInvoicesPermission)
                return new ActionResult((int)ActionResultSave.InsufficienPermissionToSave, GetText(1155, "Behörighet saknas"));

            return new ActionResult();
        }

        public ActionResult AutomaticEInvoiceDistribution(List<CustomerInvoiceGridDTO> invoices)
        {
            if (!invoices.Any()) return new ActionResult();

            var eim = new ElectronicInvoiceMananger(parameterObject);

            //If we need to send back references to a file, we cannot offload the work to another thread.
            if (eim.WillExportEInvoiceAsFile(this.ActorCompanyId))
                return eim.CreateEInvoice(invoices, this.ActorCompanyId, this.UserId);

            Task.Run(() => CompEntitiesProvider.RunWithTaskScopedReadOnlyEntities(() =>
            {
                var result = eim.CreateEInvoice(invoices, this.ActorCompanyId, this.UserId);
                if (!result.Success)
                {
                    base.LogInfo($"Failed to create EInvoice, message: {result.ErrorMessage}");
                    eim.SetDistributionStatusOnUnsetInvoices(invoices.Select(i => i.CustomerInvoiceId).ToList(), result.ErrorMessage);
                }

            }));

            return new ActionResult();
        }

        public ActionResult AutomaticEmailDistribution(CompEntities entities, List<CustomerInvoiceGridDTO> invoices)
        {
            if (!invoices.Any()) return new ActionResult();

            var invDisr = new InvoiceDistributionManager(parameterObject);

            int defaultInvoiceRptTemplateId = SettingManager.GetCompanyIntSetting(CompanySettingType.BillingDefaultInvoiceTemplate);
            if (defaultInvoiceRptTemplateId == 0)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(4209, "Standardrapport saknas"));

            int defaultInvoiceEmailTemplateId = SettingManager.GetCompanyIntSetting(CompanySettingType.BillingDefaultEmailTemplate);
            if (defaultInvoiceEmailTemplateId == 0)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(4146, "E-postmall hittades inte"));

            int defaultLangId = GetLangId();

            var groupedInvoices = GetCustomerInvoices(entities,
                invoices.Select(i => i.CustomerInvoiceId).ToList(),
                loadActor: true,
                loadOriginInvoiceMapping: true)
                .GroupBy(i => new { i.Actor.Customer.BillingTemplate, i.Actor.Customer.SysLanguageId })
                .ToList();

            Task.Run(() => CompEntitiesProvider.RunWithTaskScopedReadOnlyEntities(() =>
            {
                foreach (var group in groupedInvoices)
                {
                    var billingTemplateId = group.Key.BillingTemplate ?? 0;
                    if (billingTemplateId == 0)
                        billingTemplateId = defaultInvoiceRptTemplateId;

                    var languageId = group.Key.SysLanguageId ?? 0;
                    if (languageId == 0)
                        languageId = defaultLangId;

                    var invoicesInGroup = group.ToList();

                    invDisr.SendAsEmails(invoicesInGroup, this.ActorCompanyId, this.parameterObject, defaultInvoiceEmailTemplateId, billingTemplateId, languageId, true);
                }
            }));

            return new ActionResult();
        }
        public ActionResult TriggerInvoicePrint(CompEntities entities, List<CustomerInvoiceGridDTO> invoices)
        {
            if (!invoices.Any()) return new ActionResult();

            int defaultInvoiceRptTemplateId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultInvoiceTemplate, 0, this.ActorCompanyId, 0);
            int defaultLangId = GetLangId();

            var defaultReport = ReportManager.GetReport(entities, defaultInvoiceRptTemplateId, this.ActorCompanyId);

            if (defaultReport == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(4209, "Standardrapport saknas"));

            var groupedInvoices = GetCustomerInvoices(entities,
                    invoices.Select(i => i.CustomerInvoiceId).ToList(),
                    loadActor: true,
                    loadOriginInvoiceMapping: true)
                .GroupBy(i => new { i.Actor.Customer.BillingTemplate, i.Actor.Customer.SysLanguageId })
                .ToList();

            var result = new ActionResult();
            foreach (var group in groupedInvoices)
            {
                var billingTemplateId = group.Key.BillingTemplate ?? 0;
                if (billingTemplateId == 0)
                    billingTemplateId = defaultInvoiceRptTemplateId;

                var languageId = group.Key.SysLanguageId ?? 0;
                if (languageId == 0)
                    languageId = defaultLangId;

                var invoiceIds = group.Select(i => i.InvoiceId).ToList();

                var report = billingTemplateId != defaultReport.ReportId ?
                    ReportManager.GetReport(entities, billingTemplateId, this.ActorCompanyId) :
                    defaultReport;

                var printResult = QueueCustomerInvoicePrintJob(report ?? defaultReport, SoeReportTemplateType.BillingInvoice, invoiceIds);

                result.IntegerValue++;
                if (!printResult.Success)
                {
                    base.LogInfo($"Failed to queue automatic distribution print job. Message: {result.ErrorMessage}");
                    result.ErrorMessage += printResult.ErrorMessage + "\n";
                    result.IntegerValue2++;
                }
            }
            result.Success = result.IntegerValue != result.IntegerValue2;
            return result;
        }
        public ActionResult QueueCustomerInvoicePrintJob(Report report, SoeReportTemplateType templateType, List<int> invoiceIds)
        {
            var exportType = (TermGroup_ReportExportType)report.ExportType;
            if (exportType == TermGroup_ReportExportType.Unknown)
            {
                exportType = TermGroup_ReportExportType.Pdf;
            }

            ReportJobDefinitionDTO reportJobDefinitionDTO = new ReportJobDefinitionDTO(report.ReportId, templateType, exportType);
            reportJobDefinitionDTO.Selections.Add(new IdListSelectionDTO(invoiceIds, "IdListSelectionDTO", "invoiceIds"));
            reportJobDefinitionDTO.Selections.Add(new BoolSelectionDTO(true, "BoolSelectionDTO", "showAnyUnprinted"));
            reportJobDefinitionDTO.Selections.Add(new BoolSelectionDTO(true, "BoolSelectionDTO", "showCopies"));
            reportJobDefinitionDTO.Selections.Add(new BoolSelectionDTO(true, "BoolSelectionDTO", "showCopiesOfOriginal"));

            //Queues the printing job, which most likely will be taken care of by another server.
            var dto = ReportDataManager.PrintMigratedReportDTO(reportJobDefinitionDTO, base.ActorCompanyId, base.UserId, base.RoleId);

            if (dto == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(5970, "Rapport kunde inte skrivas ut"));

            return new ActionResult();
        }
        public CustomerInvoiceSummaryDTO GetCustomerInvoiceSummary(int invoiceId, int? projectId)
        {
            var dto = new CustomerInvoiceSummaryDTO();

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    //Check if attestates are loaded
                    InitializeAttestStateIds(entities, this.ActorCompanyId);

                    bool useProjectTimeBlock = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.UseProjectTimeBlocks, this.UserId, this.ActorCompanyId, 0, false);
                    int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, this.ActorCompanyId, 0);
                    int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, this.ActorCompanyId, 0);
                    int guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, this.ActorCompanyId, 0);
                    bool calculateMarginalIncomeForZeroPurchase = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingCalculateMarginalIncomeForRowsWithZeroPurchasePrice, 0, this.ActorCompanyId, 0, true);

                    var invoiceRows = GetCustomerInvoiceRows(entities, invoiceId, true, true);

                    bool hasFixedPriceKeepPricesRows = invoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceKeepPricesProductId);
                    bool hasFixedPriceRows = invoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceProductId);

                    // Timecodetransactions
                    var transactions = entities.GetTimeCodeTransactionsForOrderOverview(invoiceId, useProjectTimeBlock).ToList();

                    foreach (var row in invoiceRows)
                    {
                        // Do not sum text, page break or sub total rows
                        if (row.Type == (int)SoeInvoiceRowType.TextRow || row.Type == (int)SoeInvoiceRowType.PageBreakRow || row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                            continue;

                        if (row.IsFreightAmountRow || row.IsInvoiceFeeRow)
                            continue;

                        // Get product
                        if (row.Product == null && !row.ProductReference.IsLoaded)
                            row.ProductReference.Load();

                        //Do not sum the claim row...can be both Debit or Credit depending on billing type....
                        if (row.Type == (int)SoeInvoiceRowType.AccountingRow && row.Product == null && row.IsCentRoundingRow == false &&
                            ((row.CustomerInvoiceAccountRow != null && row.CustomerInvoiceAccountRow.FirstOrDefault(r => /*r.DebitRow == true &&*/ r.VatRow == false) != null) ||
                            row.CustomerInvoiceAccountRow.Count == 0))
                            continue;

                        //Do not sum existing cent rounding row
                        if (row.IsCentRoundingRow == true)
                            continue;

                        // If Fixed orice type 2 only sum those rows
                        if (hasFixedPriceKeepPricesRows && row.ProductId != null && row.ProductId != fixedPriceKeepPricesProductId)
                            continue;

                        // Do not sum guarantee rows
                        if (row.ProductId != null && row.ProductId == guaranteeProductId && (hasFixedPriceRows || hasFixedPriceKeepPricesRows))
                            continue;

                        // Dont sum lift
                        if (row.Product != null && ((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                            continue;

                        // Dont sum household rows
                        if (row.HouseholdTaxDeductionRow != null && row.HouseholdTaxDeductionRow.State == (int)SoeEntityState.Active)
                            continue;

                        if (row.IsTimeProjectRow)
                        {
                            foreach (var timeCodeTrans in transactions.Where(t => t.CustomerInvoiceRowId == row.CustomerInvoiceRowId))
                            {
                                if (useProjectTimeBlock)
                                {
                                    var workedMinutes = Convert.ToDecimal(CalendarUtility.TimeSpanToMinutes(timeCodeTrans.Stop, timeCodeTrans.Start));
                                    decimal quantity = (workedMinutes / 60);

                                    if (timeCodeTrans.CustomerInvoiceBillingType == (int)TermGroup_BillingType.Credit)
                                        quantity = decimal.Negate(quantity);

                                    decimal price = timeCodeTrans.UseCalculatedCost.HasValue && timeCodeTrans.UseCalculatedCost.Value ? EmployeeManager.GetEmployeeCalculatedCost(new Employee() { EmployeeId = timeCodeTrans.EmployeeId, ActorCompanyId = base.ActorCompanyId }, timeCodeTrans.TransactionDate.Date, projectId) : row.PurchasePrice;
                                    decimal cost = quantity * price;

                                    dto.CostPersonell += cost;
                                    dto.WorkedMinutes += workedMinutes;
                                }
                                else
                                {
                                    var workedMinutes = timeCodeTrans.TransactionQuantity.HasValue && timeCodeTrans.TransactionQuantity.Value > 0 ? timeCodeTrans.TransactionQuantity.Value : 0;
                                    decimal quantity = (workedMinutes / 60);

                                    if (timeCodeTrans.CustomerInvoiceBillingType == (int)TermGroup_BillingType.Credit)
                                        quantity = decimal.Negate(quantity);

                                    decimal price = timeCodeTrans.UseCalculatedCost.HasValue && timeCodeTrans.UseCalculatedCost.Value ? EmployeeManager.GetEmployeeCalculatedCost(new Employee() { EmployeeId = timeCodeTrans.EmployeeId, ActorCompanyId = base.ActorCompanyId }, timeCodeTrans.TransactionDate.Date, projectId) : row.PurchasePrice;
                                    decimal cost = quantity * price;

                                    dto.CostPersonell += cost;
                                    dto.WorkedMinutes += workedMinutes;
                                }
                            }

                            if (row.Quantity.HasValue)
                                dto.BillableMinutes += (row.Quantity.Value * 60);

                            dto.IncomePersonell += row.SumAmountCurrency;
                        }
                        else
                        {
                            if (row.Product != null && ((InvoiceProduct)row.Product).VatType == (int)TermGroup_InvoiceProductVatType.Service)
                            {
                                if (row.Quantity.HasValue)
                                {
                                    dto.WorkedMinutes += (row.Quantity.Value * 60);
                                    dto.BillableMinutes += (row.Quantity.Value * 60);

                                    dto.CostPersonell += (row.Quantity.Value * row.PurchasePriceCurrency);
                                    dto.IncomePersonell += row.SumAmountCurrency;
                                }
                            }
                            else
                            {
                                if (row.Quantity.HasValue)
                                {
                                    dto.CostMaterial += (row.Quantity.Value * row.PurchasePriceCurrency);
                                    dto.IncomeMaterial += row.SumAmountCurrency;
                                }
                            }
                        }
                    }

                    dto.MarginalIncomePersonell = dto.IncomePersonell - dto.CostPersonell;
                    dto.MarginalIncomeRatioPersonell = dto.MarginalIncomePersonell == 0 || dto.IncomePersonell == 0 ? 100 : Decimal.Round((dto.MarginalIncomePersonell / dto.IncomePersonell) * 100, 2);

                    dto.MarginalIncomeMaterial = dto.IncomeMaterial - dto.CostMaterial;
                    dto.MarginalIncomeRatioMaterial = dto.MarginalIncomeMaterial == 0 || dto.IncomeMaterial == 0 ? 100 : Decimal.Round((dto.MarginalIncomeMaterial / dto.IncomeMaterial) * 100, 2);

                    dto.CostTotal = (dto.CostPersonell + dto.CostMaterial);
                    dto.IncomeTotal = (dto.IncomePersonell + dto.IncomeMaterial);
                    dto.MarginalIncomeTotal = dto.IncomeTotal - dto.CostTotal;
                    dto.MarginalIncomeRatioTotal = dto.MarginalIncomeTotal == 0 || dto.IncomeTotal == 0 ? 100 : Decimal.Round((dto.MarginalIncomeTotal / dto.IncomeTotal) * 100, 2);
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    return new CustomerInvoiceSummaryDTO();
                }
                finally
                {
                    entities.Connection.Close();
                }
            }

            return dto;
        }

        #region Convert

        private List<CustomerInvoiceRow> ConvertToCustomerInvoiceRows(CompEntities entities, bool isManuallyAdjusted, List<CustomerInvoiceRowDTO> invoiceRowsInputDTO, List<AccountingRowDTO> accountingRowsInput, int actorCompanyId, ref Dictionary<int, CustomerInvoiceRow> modifiedRows, ref Dictionary<int, CustomerInvoiceAccountRow> modifiedAccRows, ref string message, ImportCustomerInvoiceCache invoiceImportCache)
        {
            #region Init

            var rows = new List<CustomerInvoiceRow>();
            modifiedRows = new Dictionary<int, CustomerInvoiceRow>();
            modifiedAccRows = new Dictionary<int, CustomerInvoiceAccountRow>();

            if (!invoiceRowsInputDTO.Any())
            {
                return rows;
            }

            var parentRowDict = new Dictionary<int, CustomerInvoiceRow>();

            #endregion

            foreach (CustomerInvoiceRowDTO dto in invoiceRowsInputDTO.OrderBy(r => r.TempRowId))
            {
                #region Prereq

                // Do not include new inactive rows
                if (dto.CustomerInvoiceRowId == 0 && dto.State != (int)SoeEntityState.Active)
                    continue;

                // Do not include product rows without products
                /*if (item.Type == (int)SoeInvoiceRowType.ProductRow && item.ProductId == 0)
                    continue;*/

                #endregion

                #region CustomerInvoiceRow

                // Create one CustomerInvoiceRow for each product row
                CustomerInvoiceRow row = new CustomerInvoiceRow
                {
                    CustomerInvoiceRowId = dto.CustomerInvoiceRowId,
                    TempRowId = dto.TempRowId,
                    AttestStateId = dto.AttestStateId,
                    RowNr = dto.RowNr,
                    Type = (int)dto.Type,
                    VatRate = dto.VatRate,
                    VatAmount = dto.VatAmount,
                    VatAmountCurrency = dto.VatAmountCurrency,
                    Quantity = dto.Quantity,
                    InvoiceQuantity = dto.InvoiceQuantity,
                    PreviouslyInvoicedQuantity = dto.PreviouslyInvoicedQuantity,
                    Amount = dto.Amount,
                    AmountCurrency = dto.AmountCurrency,
                    DiscountType = dto.DiscountType,
                    DiscountPercent = dto.DiscountPercent,
                    DiscountAmount = dto.DiscountAmount,
                    DiscountAmountCurrency = dto.DiscountAmountCurrency,
                    SumAmount = dto.SumAmount,
                    SumAmountCurrency = dto.SumAmountCurrency,
                    Text = dto.Text,
                    IsFreightAmountRow = dto.IsFreightAmountRow,
                    IsInvoiceFeeRow = dto.IsInvoiceFeeRow,
                    IsCentRoundingRow = dto.IsCentRoundingRow,
                    IsInterestRow = dto.IsInterestRow,
                    IsReminderRow = dto.IsReminderRow,
                    PurchasePrice = dto.PurchasePrice,
                    PurchasePriceCurrency = dto.PurchasePriceCurrency,
                    SysWholesellerName = dto.SysWholesellerName,
                    MarginalIncome = dto.MarginalIncome,
                    MarginalIncomeCurrency = dto.MarginalIncomeCurrency,
                    MarginalIncomeRatio = dto.MarginalIncomeRatio,
                    State = (int)dto.State,
                    IsTimeProjectRow = dto.IsTimeProjectRow,
                    IsStockRow = dto.IsStockRow,
                    //Set FK
                    ProductId = dto.ProductId.ToNullable(),
                    ProductUnitId = dto.ProductUnitId.ToNullable(),
                    VatAccountId = dto.VatAccountId.ToNullable(),
                    CustomerInvoiceInterestId = dto.IsInterestRow ? dto.CustomerInvoiceInterestId.ToNullable() : (int?)null,
                    CustomerInvoiceReminderId = dto.IsReminderRow ? dto.CustomerInvoiceReminderId.ToNullable() : (int?)null,
                    Date = dto.Date,
                    TimeManuallyChanged = dto.TimeManuallyChanged,
                    StockId = dto.StockId.ToNullable(),
                    HouseholdDeductionType = dto.HouseholdDeductionType,
                    DateTo = dto.DateTo,
                    DeliveryDateText = dto.DeliveryDateText,
                };
                SetCreatedProperties(row);

                // Set parent row
                if (dto.ParentRowId.HasValue && parentRowDict.ContainsKey(dto.ParentRowId.Value))
                {
                    row.ParentRow = parentRowDict[dto.ParentRowId.Value];

                    if (row.ParentRow != null && row.ParentRow.CustomerInvoiceRowId != 0)
                        row.ParentRowId = row.ParentRow.CustomerInvoiceRowId;
                }

                // Household tax deduction
                if (!string.IsNullOrEmpty(dto.HouseholdProperty) || (!string.IsNullOrEmpty(dto.HouseholdApartmentNbr) && !string.IsNullOrEmpty(dto.HouseholdCooperativeOrgNbr)) || dto.HouseHoldTaxDeductionType != (int)TermGroup_HouseHoldTaxDeductionType.None)
                {
                    // Validate
                    var result = HouseholdTaxDeductionManager.CreateHouseholdTaxDeductionRow(dto, row);
                    if (!result.Success)
                    {
                        message = result.ErrorMessage;
                        return null;
                    }
                }

                // Add account rows connected to current product row
                if (dto.TempRowId != 0)
                {
                    var accountRowItems = accountingRowsInput.Where(r => r.TempInvoiceRowId == dto.TempRowId).AsEnumerable();
                    foreach (var accountRowItem in accountRowItems)
                    {
                        // Do not include new inactive rows
                        if (accountRowItem.InvoiceAccountRowId == 0 && accountRowItem.State != (int)SoeEntityState.Active)
                            continue;

                        CustomerInvoiceAccountRow accRow = ConvertToCustomerInvoiceAccountRow(entities, accountRowItem, actorCompanyId, invoiceImportCache);
                        if (accRow == null)
                            return null;

                        // If invoice has manually adjusted accounting rows, delete accounting rows not marked as manually adjusted
                        if (isManuallyAdjusted && !accountRowItem.IsManuallyAdjusted)
                            ChangeEntityState(accRow, SoeEntityState.Deleted);

                        row.CustomerInvoiceAccountRow.Add(accRow);
                        if (!modifiedAccRows.ContainsKey((accountRowItem.TempRowId)))
                            modifiedAccRows.Add(accountRowItem.TempRowId, accRow);
                    }
                }

                // Add product row with connected account rows to the collection of CustomerInvoiceRows
                rows.Add(row);

                // If a child row refers to this row, add it to a dictionary
                // so we can get hold of it when adding the child row
                if (invoiceRowsInputDTO.Any(r => r.ParentRowId == dto.TempRowId) && !parentRowDict.ContainsKey(dto.TempRowId))
                    parentRowDict.Add(dto.TempRowId, row);

                // Add row here to be able to get actual id for added rows when saved
                if (!modifiedRows.ContainsKey(dto.TempRowId))
                    modifiedRows.Add(dto.TempRowId, row);

                #endregion
            }

            return rows;
        }

        private CustomerInvoiceAccountRow ConvertToCustomerInvoiceAccountRow(CompEntities entities, AccountingRowDTO item, int actorCompanyId, ImportCustomerInvoiceCache invoiceImportCache)
        {
            // Create new account row
            CustomerInvoiceAccountRow row = new CustomerInvoiceAccountRow()
            {
                CustomerInvoiceAccountRowId = item.InvoiceAccountRowId,
                RowNr = item.RowNr,
                SplitType = item.SplitType,
                SplitPercent = item.SplitPercent,
                Amount = item.Amount,
                AmountCurrency = item.AmountCurrency,
                AmountEntCurrency = item.AmountEntCurrency,
                AmountLedgerCurrency = item.AmountLedgerCurrency,
                Quantity = item.Quantity,
                Text = item.Text,
                VatRow = item.IsVatRow,
                ContractorVatRow = item.IsContractorVatRow,
                CreditRow = item.IsCreditRow,
                DebitRow = item.IsDebitRow,
                State = (int)item.State
            };

            // Get standard account
            AccountStd accStd = invoiceImportCache.GetAccountStdById(entities, item.Dim1Id, actorCompanyId);

            row.AccountStd = accStd;
            if (row.AccountStd == null)
                return null;

            // Get internal accounts (Dim2-6)
            if (item.Dim2Id != 0)
            {
                AccountInternal accountInternal = invoiceImportCache.GetAccountInternal(entities, actorCompanyId, item.Dim2Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim3Id != 0)
            {
                AccountInternal accountInternal = invoiceImportCache.GetAccountInternal(entities, actorCompanyId, item.Dim3Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim4Id != 0)
            {
                AccountInternal accountInternal = invoiceImportCache.GetAccountInternal(entities, actorCompanyId, item.Dim4Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim5Id != 0)
            {
                AccountInternal accountInternal = invoiceImportCache.GetAccountInternal(entities, actorCompanyId, item.Dim5Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim6Id != 0)
            {
                AccountInternal accountInternal = invoiceImportCache.GetAccountInternal(entities, actorCompanyId, item.Dim6Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }

            return row;
        }

        #endregion

        #region Priority

        public int GetPaymentConditionIdBasedOnPriority(Customer customer, int defaultPriceListTypeId)
        {
            if (customer != null && customer.PaymentConditionId.HasValue)
                return customer.PaymentConditionId.Value;
            else
                return defaultPriceListTypeId;
        }

        public int GetPriceListTypeIdBasedOnPriority(Customer customer, int defaultPriceListTypeId)
        {
            return customer != null && customer.PriceListTypeId.HasValue ? customer.PriceListTypeId.Value : defaultPriceListTypeId;
        }

        public int GetDeliveryTypeIdBasedOnPriority(Customer customer, int defaultDeliveryTypeId)
        {
            if (customer != null && customer.DeliveryTypeId.HasValue)
                return customer.DeliveryTypeId.Value;
            else
                return defaultDeliveryTypeId;
        }

        public int GetDeliveryConditionIdBasedOnPriority(Customer customer, int defaultDeliveryConditionId)
        {
            if (customer != null && customer.DeliveryConditionId.HasValue)
                return customer.DeliveryConditionId.Value;
            else
                return defaultDeliveryConditionId;
        }


        public int? GetWholeSellerBasedOnPriority(Customer customer, int defaultWholeSellerId)
        {
            if (customer != null && customer.SysWholeSellerId.HasValue)
                return customer.SysWholeSellerId.Value;

            if (defaultWholeSellerId > 0)
                return defaultWholeSellerId;

            return null;
        }

        #endregion

        #region Help-methods

        private TermGroup_InvoiceVatType GetDefaultVatType(Customer customer, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetDefaultVatType(entities, customer, actorCompanyId);
        }

        private TermGroup_InvoiceVatType GetDefaultVatType(CompEntities entities, Customer customer, int actorCompanyId)
        {
            if (customer != null && customer.VatType > 0)
                return (TermGroup_InvoiceVatType)customer.VatType;

            int defaultVatType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceDefaultVatType, 0, actorCompanyId, 0);
            if (defaultVatType > 0)
                return (TermGroup_InvoiceVatType)defaultVatType;
            else
                return TermGroup_InvoiceVatType.Merchandise;
        }

        private VoucherSeries GetDefaultVoucherSeries(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetDefaultVoucherSeries(entities, actorCompanyId);
        }

        private VoucherSeries GetDefaultVoucherSeries(CompEntities entities, int actorCompanyId, DateTime? voucherDate = null)
        {
            int voucherSeriesTypeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceVoucherSeriesType, 0, actorCompanyId, 0);
            var accountYear = AccountManager.GetAccountYear(entities, voucherDate ?? DateTime.Today.Date, actorCompanyId);
            if (accountYear == null)
            {
                throw new Exception(GetText(8404, "Redovisningsår saknas"));
            }

            VoucherSeries voucherSerie = VoucherManager.GetVoucherSerieByYear(entities, accountYear.AccountYearId, voucherSeriesTypeId);

            if (voucherSerie == null)
            {
                throw new Exception(GetText(8403, "Verifikatserie saknas"));
            }

            return voucherSerie;
        }

        private int GetCustomerInvoiceGracePeriodDays(int defaultGracePeriodDays, int customerGracePeriodDays)
        {
            //Customers GracePeriod has prio 1
            int gracePeriodDays = defaultGracePeriodDays;
            if (customerGracePeriodDays > 0)
                gracePeriodDays = customerGracePeriodDays;
            return gracePeriodDays;
        }

        public bool ConvertProductRowsTextUppercase(CompEntities entities, List<CustomerInvoiceRow> productRows, int actorCompanyId)
        {
            var productRowDescriptionsUppercase = SettingManager.GetBoolSetting(entities,
                SettingMainType.Company,
                (int)CompanySettingType.BillingProductRowTextUppercase,
                0,
                actorCompanyId,
                0);

            if (!productRowDescriptionsUppercase)
                return false;

            if (!productRows.IsNullOrEmpty())
            {
                var updatedRows = 0;
                foreach (var productRow in productRows)
                {
                    if (productRow.Type == (int)SoeInvoiceRowType.ProductRow)
                    {
                        var convertedText = productRow.Text?.ToUpper();
                        if (!StringUtility.IsEqual(productRow.Text, convertedText))
                        {
                            productRow.Text = convertedText;
                            updatedRows++;
                        }
                    }
                }
                if (updatedRows > 0) return true;
            }
            return false;
        }


        public string GetDefaultInvoiceText(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetDefaultInvoiceText(entities, actorCompanyId);
        }

        private string GetDefaultInvoiceText(CompEntities entities, int actorCompanyId)
        {
            return SettingManager.GetStringSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingInvoiceText, 0, actorCompanyId, 0);
        }

        private string GetDefaultOurReference(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetDefaultOurReference(entities, actorCompanyId);
        }

        private string GetDefaultOurReference(CompEntities entities, int actorCompanyId)
        {
            string reference = null;
            if (base.UserId > 0)
            {
                var defaultOurReferenceUserId = SettingManager.GetIntSetting(entities, SettingMainType.User, (int)UserSettingType.BillingInvoiceOurReference, base.UserId, actorCompanyId, 0);
                if (defaultOurReferenceUserId > 0)
                {
                    reference = UserManager.GetUser(entities, defaultOurReferenceUserId)?.Name;
                }
            }

            if (string.IsNullOrEmpty(reference))
            {
                reference = SettingManager.GetStringSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceOurReference, 0, actorCompanyId, 0);
            }

            if (string.IsNullOrEmpty(reference) && (base.UserId > 0))
            {
                reference = UserManager.GetUser(entities, base.UserId)?.Name;
            }

            return reference;
        }

        private SoeOriginType GetOriginType(OrderInvoiceRegistrationType registrationType)
        {
            switch (registrationType)
            {
                case OrderInvoiceRegistrationType.Offer:
                    return SoeOriginType.Offer;
                case OrderInvoiceRegistrationType.Order:
                    return SoeOriginType.Order;
                case OrderInvoiceRegistrationType.Invoice:
                    return SoeOriginType.CustomerInvoice;
                case OrderInvoiceRegistrationType.Contract:
                    return SoeOriginType.Contract;
                default:
                    return SoeOriginType.None;
            }
        }

        private SoeEntityType GetEntityType(SoeOriginType originType)
        {
            switch (originType)
            {
                case SoeOriginType.SupplierInvoice:
                    return SoeEntityType.SupplierInvoice;
                case SoeOriginType.CustomerInvoice:
                    return SoeEntityType.CustomerInvoice;
                case SoeOriginType.SupplierPayment:
                    return SoeEntityType.SupplierPayment;
                case SoeOriginType.CustomerPayment:
                    return SoeEntityType.CustomerPayment;
                case SoeOriginType.Offer:
                    return SoeEntityType.Offer;
                case SoeOriginType.Order:
                    return SoeEntityType.Order;
                case SoeOriginType.Contract:
                    return SoeEntityType.Contract;
                default:
                    return SoeEntityType.None;
            }
        }

        private void CalculateNextRowNbrs(CustomerInvoice order, ref int rowNr, ref int accountRowNr)
        {
            if (order.CustomerInvoiceRow != null && order.CustomerInvoiceRow.Any(r => r.State == (int)SoeEntityState.Active))
            {
                // Get next product row number
                rowNr = order.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active).Max(i => i.RowNr) + 1;

                // Get next account row number
                foreach (CustomerInvoiceRow invoiceRow in order.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active))
                {
                    if (invoiceRow.CustomerInvoiceAccountRow != null && invoiceRow.CustomerInvoiceAccountRow.Any(r => r.State == (int)SoeEntityState.Active))
                    {
                        int maxRowNr = invoiceRow.CustomerInvoiceAccountRow.Where(r => r.State == (int)SoeEntityState.Active).Max(i => i.RowNr) + 1;
                        if (maxRowNr > accountRowNr)
                            accountRowNr = maxRowNr;
                    }
                }
            }
        }

        private void UpdateInvoiceStatus(CustomerInvoice invoice, int noOfTransferredRows, int noOfClosedRows, int noOfNotTransferredRows, SoeOriginStatus closedStatus, SoeOriginStatus fullyTransferredStatus, SoeOriginStatus partlyTransferredStatus)
        {
            if (noOfTransferredRows == 0)
            {
                if (noOfNotTransferredRows == 0 && noOfClosedRows > 0)
                {
                    invoice.Origin.Status = (int)closedStatus;
                }
                else
                {
                    invoice.Origin.Status = (int)SoeOriginStatus.Origin;
                }
            }
            else
            {
                if (noOfNotTransferredRows == 0)
                {
                    invoice.Origin.Status = (int)fullyTransferredStatus;
                }
                else
                {
                    invoice.Origin.Status = (int)partlyTransferredStatus;
                }
            }
        }

        public ActionResult UpdateCreateClaimRow(int actorCompanyId, int orderId)
        {
            using (var entities = new CompEntities())
            {
                entities.CommandTimeout = 300;

                var order = (from entry in entities.Invoice.OfType<CustomerInvoice>().Include("CustomerInvoiceRow.CustomerInvoiceAccountRow")
                             where entry.InvoiceId == orderId
                             select entry).FirstOrDefault();

                UpdateCreateClaimRow(entities, actorCompanyId, order);

                return SaveChanges(entities);
            }
        }

        private void UpdateCreateClaimRow(CompEntities entities, int actorCompanyId, CustomerInvoice order, bool check4NewClaimAccount = false)
        {
            // Check if claim row exists
            CustomerInvoiceRow productClaimRow = null;
            CustomerInvoiceAccountRow claimRow = null;

            productClaimRow = order.ActiveCustomerInvoiceRows.FirstOrDefault(r => r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && !r.IsCentRoundingRow);

            // Delete extras
            if (productClaimRow != null)
            {
                foreach (var extraClaimRow in order.CustomerInvoiceRow.Where(r => r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && !r.IsCentRoundingRow && r.CustomerInvoiceRowId != productClaimRow.CustomerInvoiceRowId))
                {
                    foreach (var extraClaimAccountRow in extraClaimRow.CustomerInvoiceAccountRow)
                    {
                        extraClaimAccountRow.State = (int)SoeEntityState.Deleted;
                    }
                    extraClaimRow.State = (int)SoeEntityState.Deleted;
                }
            }

            // Is Amount negative
            var isCredit = (order.SumAmountCurrency < 0);

            if (productClaimRow != null)
            {
                claimRow = productClaimRow.CustomerInvoiceAccountRow.FirstOrDefault(); // should only be one
            }

            if (productClaimRow == null)
            {
                // Add new product row
                productClaimRow = new CustomerInvoiceRow()
                {
                    Type = (int)SoeInvoiceRowType.AccountingRow,
                    Amount = order.TotalAmount,
                    AmountCurrency = order.TotalAmountCurrency,
                    SumAmount = order.TotalAmount,
                    SumAmountCurrency = order.TotalAmountCurrency
                };
                SetCreatedProperties(productClaimRow);
                order.CustomerInvoiceRow.Add(productClaimRow);
            }
            else
            {
                // Update existing product row
                productClaimRow.Amount = order.TotalAmount;
                productClaimRow.AmountCurrency = order.TotalAmountCurrency;
                productClaimRow.SumAmount = order.TotalAmount;
                productClaimRow.SumAmountCurrency = order.TotalAmountCurrency;
                SetModifiedProperties(productClaimRow);
            }


            if (claimRow == null || check4NewClaimAccount)
            {
                // Add new account row
                AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, order.ProjectId ?? 0, order.ActorId ?? 0, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)order.VatType, false);

                if (prioDTO != null && prioDTO.AccountId.HasValue)
                {
                    if (claimRow != null && claimRow.AccountId != prioDTO.AccountId)
                    {
                        // Delete existing account row
                        claimRow.State = (int)SoeEntityState.Deleted;
                        claimRow = null;
                    }

                    if (claimRow == null)
                    {
                        claimRow = new CustomerInvoiceAccountRow
                        {
                            RowNr = 1,
                            AccountId = prioDTO.AccountId.Value,
                            Amount = order.TotalAmount,
                            AmountCurrency = order.TotalAmountCurrency,
                            DebitRow = !isCredit,
                            CreditRow = isCredit
                        };
                        productClaimRow.CustomerInvoiceAccountRow.Add(claimRow);
                    }
                }
            }

            if (claimRow != null)
            {
                // Update existing account row
                claimRow.Amount = order.TotalAmount;
                claimRow.AmountCurrency = order.TotalAmountCurrency;
                claimRow.DebitRow = !isCredit;
                claimRow.CreditRow = isCredit;
            }
        }

        private void UpdateCreateCentRoundingRow(CompEntities entities, CustomerInvoice order, int actorCompanyId, int accountRowNr)
        {
            // Get cent rounding product row
            CustomerInvoiceRow productCentRow = order.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);

            // Delete extras
            if (productCentRow != null)
            {
                foreach (var extraCentRow in order.CustomerInvoiceRow.Where(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active && r.CustomerInvoiceRowId != productCentRow.CustomerInvoiceRowId))
                {
                    foreach (var extraCentAccountRow in extraCentRow.CustomerInvoiceAccountRow)
                    {
                        extraCentAccountRow.State = (int)SoeEntityState.Deleted;
                    }
                    extraCentRow.State = (int)SoeEntityState.Deleted;
                }
            }

            var centRoundingAmount = 0m;
            var centRoundingAmountCurrency = 0m;
            var centRoundingAmountLedgerCurrency = 0m;
            var centRoundingAmountEntCurreny = 0m;

            /*
            var accountingRows = entities.CustomerInvoiceAccountRow.Where(r => r.CustomerInvoiceRow.InvoiceId == order.InvoiceId &&
                                                                                                        r.CustomerInvoiceRow.State == (int)SoeEntityState.Active &&
                                                                                                        !r.CustomerInvoiceRow.IsCentRoundingRow &&
                                                                                                        r.State == (int)SoeEntityState.Active).ToList();
            */
            foreach (var productRow in order.ActiveCustomerInvoiceRows.Where(r => !r.IsCentRoundingRow))
            {
                foreach (var accountingRow in productRow.ActiveCustomerInvoiceAccountRows)
                {
                    centRoundingAmount += accountingRow.Amount;
                    centRoundingAmountCurrency += accountingRow.AmountCurrency;
                    centRoundingAmountLedgerCurrency += accountingRow.AmountLedgerCurrency;
                    centRoundingAmountEntCurreny += accountingRow.AmountEntCurrency;
                }
            }

            if (productCentRow != null)
            {
                // Check if cent rounding account row exists
                if (!productCentRow.IsAdded() && !productCentRow.CustomerInvoiceAccountRowIsLoaded)
                    productCentRow.LoadCustomerInvoiceAccountRow();

                CustomerInvoiceAccountRow centAccountRow = productCentRow.CustomerInvoiceAccountRow.FirstOrDefault();
                bool isCreditRow = (centRoundingAmount > 0);

                centRoundingAmount = decimal.Negate(centRoundingAmount);
                centRoundingAmountCurrency = decimal.Negate(centRoundingAmountCurrency);
                centRoundingAmountLedgerCurrency = decimal.Negate(centRoundingAmountLedgerCurrency);
                centRoundingAmountEntCurreny = decimal.Negate(centRoundingAmountEntCurreny);

                if (centAccountRow == null && centRoundingAmount != 0)
                {
                    if (!productCentRow.IsAdded() && !productCentRow.ProductReference.IsLoaded)
                        productCentRow.ProductReference.Load();

                    // Add a cent rounding account row
                    AccountingPrioDTO dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productCentRow.Product != null ? productCentRow.Product.ProductId : 0, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)order.VatType, false);
                    if (dto != null && dto.AccountId.HasValue)
                    {
                        centAccountRow = new CustomerInvoiceAccountRow()
                        {
                            RowNr = accountRowNr,
                            AccountId = dto.AccountId.Value,
                        };
                        productCentRow.CustomerInvoiceAccountRow.Add(centAccountRow);
                    }
                }

                if (centAccountRow != null)
                {
                    if (centRoundingAmount != 0)
                    {
                        // Update existing cent rounding account row
                        centAccountRow.Amount = decimal.Round(centRoundingAmount, 2);
                        centAccountRow.AmountCurrency = decimal.Round(centRoundingAmountCurrency, 2);
                        centAccountRow.AmountEntCurrency = decimal.Round(centRoundingAmountEntCurreny, 2);
                        centAccountRow.AmountLedgerCurrency = decimal.Round(centRoundingAmountLedgerCurrency, 2);
                        centAccountRow.DebitRow = !isCreditRow;
                        centAccountRow.CreditRow = isCreditRow;
                    }
                    else
                    {
                        // Cent rounding is zero, remove rows
                        centAccountRow.State = (int)SoeEntityState.Deleted;
                        productCentRow.State = (int)SoeEntityState.Deleted;
                    }
                }

                productCentRow.Amount = productCentRow.SumAmount = centRoundingAmount;
                productCentRow.AmountCurrency = productCentRow.SumAmountCurrency = centRoundingAmountCurrency;
                productCentRow.AmountEntCurrency = productCentRow.SumAmountEntCurrency = centRoundingAmountEntCurreny;
                productCentRow.AmountLedgerCurrency = productCentRow.SumAmountLedgerCurrency = centRoundingAmountLedgerCurrency;
            }

        }

        private void UpdateTransferRowCount(bool rowIsTransferred, bool isRowClosed, ref int noOfTransferredRows, ref int noOfClosedRows, ref int noOfNotTransferredRows)
        {
            if (rowIsTransferred)
            {
                noOfTransferredRows++;
            }
            else if (isRowClosed)
            {
                noOfClosedRows++;
            }
            else
            {
                noOfNotTransferredRows++;
            }
        }

        private void SetAccountRowsAsDeleted(CustomerInvoiceRow invoiceRow)
        {
            foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
            {
                // Delete existing CustomerInvoiceAccountRow
                ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
            }
        }

        public CustomerInvoiceSequenceDTO GetNextSequenceNumber(CompEntities entities, CustomerInvoice customerInvoice, bool saveChanges)
        {
            int seqNbr = 0;
            string entityName = string.Empty;
            int startNbr = 1;
            int invoiceNumberLength = 0;
            InvoiceManager.GetNextSequenceNumber(entities, (SoeOriginType)customerInvoice.Origin.Type, (SoeOriginStatus)customerInvoice.Origin.Status, (TermGroup_BillingType)customerInvoice.BillingType, base.ActorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, saveChanges, customerInvoice.CashSale, (TermGroup_OrderType)customerInvoice.OrderType);

            return new CustomerInvoiceSequenceDTO
            {
                EntityName = entityName,
                SeqNr = seqNbr,
                NumberLength = invoiceNumberLength
            };
        }

        public int GetNextSequenceNumber(CompEntities entities, SoeOriginType originType, SoeOriginStatus originStatus, TermGroup_BillingType billingType, int actorCompanyId, bool saveChanges, bool cashSale = false, TermGroup_OrderType orderType = TermGroup_OrderType.Unspecified)
        {
            int seqNbr = 0;
            string entityName = String.Empty;
            int startNbr = 1;
            int invoiceNumberLength = 0;
            InvoiceManager.GetNextSequenceNumber(entities, originType, originStatus, billingType, actorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, saveChanges, cashSale, orderType);

            return seqNbr;
        }

        private void GetNextSequenceNumber(CompEntities entities, SoeOriginType originType, SoeOriginStatus originStatus, TermGroup_BillingType billingType, int actorCompanyId, ref int seqNbr, ref string entityName, ref int startNbr, ref int invoiceNumberLength, bool saveChanges, bool cashSale = false, TermGroup_OrderType orderType = TermGroup_OrderType.Unspecified)
        {
            if (seqNbr == 0 && (originStatus != SoeOriginStatus.Draft || originType == SoeOriginType.Offer || originType == SoeOriginType.Order))
            {
                entityName = Enum.GetName(typeof(SoeOriginType), originType);
                var newLockMethod = false;
                CompanySettingType startNbrType = CompanySettingType.CustomerInvoiceSeqNbrStart;
                if (originType == SoeOriginType.SupplierInvoice)
                {
                    #region Supplier invoice

                    startNbrType = CompanySettingType.SupplierInvoiceSeqNbrStart;

                    // Check if one series for each type should be used
                    bool seqNbrPerType = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.SupplierInvoiceSeqNbrPerType, 0, actorCompanyId, 0);

                    // Get start number for the invoice number
                    if (seqNbrPerType)
                    {
                        entityName += Enum.GetName(typeof(TermGroup_BillingType), (int)billingType);

                        switch (billingType)
                        {
                            case (TermGroup_BillingType.Debit):
                                startNbrType = CompanySettingType.SupplierInvoiceSeqNbrStartDebit;
                                break;
                            case (TermGroup_BillingType.Credit):
                                startNbrType = CompanySettingType.SupplierInvoiceSeqNbrStartCredit;
                                break;
                            case (TermGroup_BillingType.Interest):
                                startNbrType = CompanySettingType.SupplierInvoiceSeqNbrStartInterest;
                                break;
                            case (TermGroup_BillingType.Reminder):
                                startNbrType = CompanySettingType.SupplierInvoiceSeqNbrStartClaim;
                                break;
                        }
                    }

                    #endregion
                }
                else if (originType == SoeOriginType.Order)
                {
                    startNbrType = CompanySettingType.BillingOrderSeqNbrStart;
                    if (orderType == TermGroup_OrderType.Internal)
                    {
                        // Check if series for interal orders should be used
                        bool seqNbrForInternal = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingOrderUseSeqNbrForInternal, 0, actorCompanyId, 0);
                        if (seqNbrForInternal)
                        {
                            entityName = "OrderInternal";
                            startNbrType = CompanySettingType.BillingOrderSeqNbrStartInternal;
                        }
                    }
                    newLockMethod = true;
                }
                else if (originType == SoeOriginType.Offer)
                {
                    startNbrType = CompanySettingType.BillingOfferSeqNbrStart;
                }
                else if (originType == SoeOriginType.Contract)
                {
                    //No gui for this setting yet...
                    startNbrType = CompanySettingType.BillingContractSeqNbrStart;
                }
                else
                {
                    #region Customer invoice
                    newLockMethod = true;

                    // Check if one series for each type should be used
                    bool seqNbrPerType = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerInvoiceSeqNbrPerType, 0, actorCompanyId, 0);

                    // Get start number for the invoice number
                    if (seqNbrPerType)
                    {
                        if (cashSale)
                        {
                            entityName = "CustomerInvoiceCash";
                            startNbrType = CompanySettingType.CustomerInvoiceSeqNbrStartCash;
                        }
                        else
                        {
                            entityName += Enum.GetName(typeof(TermGroup_BillingType), (int)billingType);

                            switch (billingType)
                            {
                                case (TermGroup_BillingType.Debit):
                                    startNbrType = CompanySettingType.CustomerInvoiceSeqNbrStartDebit;
                                    break;
                                case (TermGroup_BillingType.Credit):
                                    startNbrType = CompanySettingType.CustomerInvoiceSeqNbrStartCredit;
                                    break;
                                case (TermGroup_BillingType.Interest):
                                    startNbrType = CompanySettingType.CustomerInvoiceSeqNbrStartInterest;
                                    break;
                                case (TermGroup_BillingType.Reminder):
                                    startNbrType = CompanySettingType.CustomerInvoiceSeqNbrStartInterest;
                                    break;
                            }
                        }
                    }

                    #endregion
                }

                // Get start number
                startNbr = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)startNbrType, 0, actorCompanyId, 0);
                if (startNbr == 0)
                    startNbr = 1;

                // Get sequence number
                seqNbr = newLockMethod
                    ? SequenceNumberManager.GetNextSequenceNumberLock(entities, actorCompanyId, entityName, startNbr, saveChanges)
                    : SequenceNumberManager.GetNextSequenceNumber(entities, actorCompanyId, entityName, startNbr, saveChanges);

                // Get invoice number length
                invoiceNumberLength = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingInvoiceNumberLength, 0, actorCompanyId, 0);
            }
        }

        private void CalculateInvoiceRemainingAmount(CustomerInvoice customerInvoice, int fixedPriceKeepPricesProductId, ref decimal amountIncVat, ref decimal amountExVat, ref decimal amountVat, bool ignoreLift = false)
        {
            bool hasTransferedRows = false;
            bool hasFixedPriceKeepPricesRows = false;
            decimal cents = 0;
            decimal remainingAmount = 0;
            decimal remainingAmountVat = 0;
            decimal remainingAmountExVat = 0;


            if (customerInvoice.Origin != null && customerInvoice.Origin.Type == (int)SoeOriginType.Order)
            {
                if (fixedPriceKeepPricesProductId != 0)
                    hasFixedPriceKeepPricesRows = customerInvoice.ActiveCustomerInvoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceKeepPricesProductId);

                foreach (var invoiceRow in customerInvoice.ActiveCustomerInvoiceRows)
                {
                    if (invoiceRow.AttestStateId.HasValue && (InvoiceAttestStatesIds.OrderClosedIds.Contains(invoiceRow.AttestStateId.Value) || InvoiceAttestStatesIds.OrderHiddenIds.Contains(invoiceRow.AttestStateId.Value)))
                        continue;

                    if (((invoiceRow.Type == (int)SoeInvoiceRowType.ProductRow || (invoiceRow.Type == (int)SoeInvoiceRowType.BaseProductRow && !invoiceRow.IsCentRoundingRow)) ||
                        (invoiceRow.IsFreightAmountRow || invoiceRow.IsInterestRow || invoiceRow.IsInvoiceFeeRow || invoiceRow.IsReminderRow)) &&
                        invoiceRow.AttestStateId != InvoiceAttestStatesIds.TransferredOrderToInvoiceId &&
                        invoiceRow.State != (int)SoeEntityState.Deleted &&
                        !(invoiceRow.Product != null && (((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)))
                    {
                        if (hasFixedPriceKeepPricesRows && invoiceRow.ProductId != fixedPriceKeepPricesProductId)
                            continue;

                        if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !customerInvoice.PriceListTypeInclusiveVat)
                        {
                            remainingAmount += invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency;
                            remainingAmountExVat += invoiceRow.SumAmountCurrency;
                        }
                        else
                        {
                            remainingAmount += invoiceRow.SumAmountCurrency;
                            remainingAmountExVat += invoiceRow.SumAmountCurrency - invoiceRow.VatAmountCurrency;
                        }
                        remainingAmountVat += invoiceRow.VatAmountCurrency;
                    }
                    else if (invoiceRow.Product != null && (((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)invoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                       && invoiceRow.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        if (!ignoreLift)
                        {
                            if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !customerInvoice.PriceListTypeInclusiveVat)
                            {
                                remainingAmount += invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency;
                                remainingAmountExVat += invoiceRow.SumAmountCurrency;
                            }
                            else
                            {
                                remainingAmount += invoiceRow.SumAmountCurrency;
                                remainingAmountExVat += invoiceRow.SumAmountCurrency - invoiceRow.VatAmountCurrency;
                            }
                            remainingAmountVat += invoiceRow.VatAmountCurrency;
                        }
                    }
                    else if (invoiceRow.IsCentRoundingRow)
                    {
                        cents = (invoiceRow.SumAmountCurrency + invoiceRow.VatAmountCurrency);
                    }
                    else if (invoiceRow.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        hasTransferedRows = true;
                    }
                }

                int tryAmount = 0;

                if (!Int32.TryParse(remainingAmount.ToString(), out tryAmount))
                {
                    if (hasTransferedRows)
                    {
                        remainingAmount = Math.Round(remainingAmount, 0, MidpointRounding.ToEven);
                    }
                    else
                    {
                        remainingAmount += cents;
                    }
                }

                /* SHOULDN'T BE ROUNDED?
                int tryAmountVat = 0;

                if (!Int32.TryParse(remainingAmountVat.ToString(), out tryAmountVat))
                {
                    if (hasTransferedRows)
                    {
                        remainingAmountVat = Math.Round(remainingAmountVat, 0, MidpointRounding.ToEven);
                    }
                    else
                    {
                        remainingAmountVat += cents;
                    }
                }

                int tryAmountExVat = 0;

                if (!Int32.TryParse(remainingAmountExVat.ToString(), out tryAmountExVat))
                {
                    if (hasTransferedRows)
                    {
                        remainingAmountExVat = Math.Round(remainingAmountExVat, 0, MidpointRounding.ToEven);
                    }
                    else
                    {
                        remainingAmountExVat += cents;
                    }
                }*/
            }

            amountIncVat = remainingAmount;
            amountExVat = remainingAmountExVat;
            amountVat = remainingAmountVat;
        }

        #endregion

        #region CustomerInvoice (Ledger)

        /// <summary>
        /// Adds/updates a CustomerInvoice of type Ledger with its CustomerInvoiceRows and CustomerInvoiceAccountRows
        /// </summary>
        /// <param name="invoiceInput">The CustomerInvoice to save</param>
        /// <param name="accountingRowsInput">Collection of AccountingRowDTOs to convert to CustomerInvoiceRow</param>
        /// <param name="actorCompanyId">The Company that owns the Invoice</param>
        /// <returns>ActionResult</returns>        
        public ActionResult SaveCustomerLedger(CustomerLedgerSaveDTO invoiceInput, List<AccountingRowDTO> accountingRowsInput, int actorCompanyId, List<string> specialfunctionality = null, bool isImport = false, bool updateExistingInvoice = false, List<FileUploadDTO> invoiceAttachments = null)
        {
            if (invoiceInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoice");

            // Default result is successful
            ActionResult result = new ActionResult();

            #region Init

            bool addInvoice = false;
            int invoiceId = invoiceInput.InvoiceId;
            string invoiceNbr = string.Empty;
            int seqNbr = invoiceInput.SeqNr.HasValue ? invoiceInput.SeqNr.Value : 0;
            Dictionary<int, int> voucherHeadsDict = null;

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    #region Prereq  
                    List<AccountInternal> accountInternals = AccountManager.GetAccountInternals(entities, actorCompanyId, true);

                    CompCurrency currency = null;
                    if (invoiceInput.CurrencyId == 0)
                        currency = CountryCurrencyManager.GetCompanyBaseCurrency(entities, actorCompanyId);
                    else
                        currency = CountryCurrencyManager.GetCompanyCurrency(entities, invoiceInput.CurrencyId, actorCompanyId);

                    if (currency == null)
                        return new ActionResult((int)ActionResultSave.EntityNotCreated, GetText(8417, "Valuta kunde inte mappas/hittas"));


                    // Convert collection of AccountingRowDTOs to collection of SupplierInvoiceRow with SupplierInvoiceAccountRows
                    List<CustomerInvoiceRow> invoiceRowsInput = ConvertToCustomerLedgerRows(entities, accountingRowsInput, actorCompanyId, accountInternals);

                    var companySysCountryId = GetCompanySysCountryIdFromCache(entities, actorCompanyId);

                    #endregion

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {

                        #region Sequence number/Invoice nr

                        var seqNrAsInvoiceNr = false;
                        if (string.IsNullOrEmpty(invoiceInput.InvoiceNr))
                        {
                            seqNrAsInvoiceNr = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.AutomaticLedgerInvoiceNrWhenImport, 0, actorCompanyId, 0);
                        }

                        if (!seqNrAsInvoiceNr)
                        {
                            ActionResult exists = CustomerInvoiceNumberExist(entities, actorCompanyId, invoiceId, invoiceInput.InvoiceNr);
                            if (exists.Success)
                            {
                                invoiceId = exists.IntegerValue2;

                                if (!updateExistingInvoice)
                                {
                                    result = new ActionResult((int)ActionResultSave.CustomerInvoiceNumberExists, GetText(8429, "Fakturanr finns redan"));
                                    result.IntegerValue = exists.IntegerValue;
                                    return result;
                                }
                            }
                        }

                        if (seqNbr == 0 && invoiceInput.OriginStatus != SoeOriginStatus.Draft)
                        {
                            seqNbr = GetNextSequenceNumber(entities, SoeOriginType.CustomerInvoice, invoiceInput.OriginStatus, invoiceInput.BillingType, actorCompanyId, false);
                            invoiceInput.SeqNr = seqNbr;

                            if (seqNrAsInvoiceNr)
                            {
                                invoiceInput.InvoiceNr = seqNbr.ToString();
                            }
                        }

                        #endregion

                        #region CustomerInvoice

                        invoiceNbr = invoiceInput.InvoiceNr;

                        // Get existing loaded CustomerInvoice
                        CustomerInvoice invoice = GetCustomerInvoice(entities, invoiceId, true, true, true, false, true, false, true, true, true, false, false, true);

                        if (invoice == null)
                        {
                            addInvoice = true;

                            #region Origin Add

                            // Add Origin
                            Origin origin = new Origin()
                            {
                                ActorCompanyId = actorCompanyId,
                                Type = (int)SoeOriginType.CustomerInvoice,
                            };
                            SetCreatedProperties(origin);
                            entities.Origin.AddObject(origin);

                            #endregion

                            #region OriginUser Add

                            // Add current user to origin
                            OriginUser originUser = new OriginUser()
                            {
                                //Set FK
                                UserId = base.UserId,

                                //Set references
                                Origin = origin,
                            };
                            origin.OriginUser.Add(originUser);
                            SetCreatedProperties(originUser);

                            #endregion

                            #region CustomerInvoice Add

                            invoice = new CustomerInvoice()
                            {
                                Origin = origin,
                                RegistrationType = (int)OrderInvoiceRegistrationType.Ledger,
                                ExternalId = invoiceInput.ExternalId
                            };
                            SetCreatedProperties(invoice);

                            result.InfoMessage = "Add";

                            #endregion
                        }
                        else
                        {
                            #region Origin Update

                            result.InfoMessage = "Update";

                            // Cannot change to Draft from Origin
                            if (invoice.Origin.Status == (int)SoeOriginStatus.Origin && invoiceInput.OriginStatus == SoeOriginStatus.Draft)
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition);

                            // Changes allowed only when status is draft or origin
                            if (isImport && (invoice.Origin.Status != (int)SoeOriginStatus.Origin && invoice.Origin.Status != (int)SoeOriginStatus.Draft))
                                return new ActionResult((int)ActionResultSave.InvalidStateTransition, GetText(4875, "Fakturan har ogiltig status"));

                            SetModifiedProperties(invoice.Origin);

                            #endregion

                            #region CustomerInvoice Update

                            SetModifiedProperties(invoice);

                            #endregion
                        }

                        // Opdate Origin fields
                        invoice.Origin.VoucherSeriesId = invoiceInput.VoucherSeriesId;
                        invoice.Origin.VoucherSeriesTypeId = invoiceInput.VoucherSeriesTypeId;
                        invoice.Origin.Description = invoiceInput.OriginDescription;
                        invoice.Origin.Status = (int)invoiceInput.OriginStatus;

                        // Update Invoice fields
                        invoice.ActorId = invoiceInput.ActorId;
                        invoice.Type = (int)SoeInvoiceType.CustomerInvoice;
                        invoice.BillingType = (int)invoiceInput.BillingType;
                        invoice.VatType = (int)invoiceInput.VatType;
                        invoice.VatCodeId = invoiceInput.VatCodeId != 0 ? invoiceInput.VatCodeId : (int?)null;
                        invoice.SeqNr = seqNbr != 0 ? seqNbr : (int?)null;
                        invoice.InvoiceNr = invoiceInput.InvoiceNr;
                        invoice.InvoiceDate = invoiceInput.InvoiceDate.HasValue ? invoiceInput.InvoiceDate.Value.Date : invoiceInput.InvoiceDate;
                        invoice.DueDate = invoiceInput.DueDate.HasValue ? invoiceInput.DueDate.Value.Date : invoiceInput.DueDate;
                        invoice.VoucherDate = invoiceInput.VoucherDate.HasValue ? invoiceInput.VoucherDate.Value.Date : invoiceInput.VoucherDate;
                        invoice.ReferenceOur = invoiceInput.ReferenceOur;
                        invoice.ReferenceYour = invoiceInput.ReferenceYour;
                        invoice.OCR = invoiceInput.OCR;
                        invoice.InternalDescription = invoiceInput.InternalDescription;

                        switch (companySysCountryId)
                        {
                            case 2: //US
                                break;
                            case 3: //Finland
                                if (invoice.OCR == null || invoice.OCR == string.Empty)
                                {
                                    if (invoice.InvoiceNr != null && invoice.Actor != null)
                                    {
                                        string tmpReference = "";
                                        if (specialfunctionality != null && specialfunctionality.Contains("Automaster"))
                                        {
                                            string fmt = "00000000";
                                            tmpReference = invoice.Actor.Customer.CustomerNr.ToString() + Convert.ToInt32(invoice.InvoiceNr).ToString(fmt);
                                        }
                                        else
                                        {
                                            tmpReference = invoice.Actor.Customer.CustomerNr.ToString() + "0000" + invoice.InvoiceNr.ToString();
                                        }
                                        if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, actorCompanyId, 0))
                                        {
                                            invoice.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                        }
                                        else
                                        {
                                            invoice.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                        }

                                    }
                                    else
                                    {
                                        if (invoice.Actor == null)
                                        {
                                            //Cannot make ocr without customer in invoice (Automaster)
                                            //invoice.OCR = GetCheckedBankPaymentReference(invoice.InvoiceNr);  // Normal Finnish Bank Reference 
                                        }
                                        else
                                        {
                                            string errorCheck = "";
                                            if (invoice.InvoiceNr == null) errorCheck += "A=null";
                                            if (invoice.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                            invoice.OCR = "Virhe(3):" + errorCheck;
                                        }
                                    }
                                }

                                break;
                            case 4: //Norge
                                if (invoice.InvoiceNr != null && invoice.Actor != null && invoice.Actor.Customer.CustomerNr != null)
                                {
                                    invoice.OCR = InvoiceUtility.GetNorwegianKIDNumber(invoice.InvoiceNr.ToString(), invoice.Actor.Customer.CustomerNr.ToString(), (DateTime)invoice.InvoiceDate, 0);
                                }
                                break;
                            default: //Sverige
                                if (invoice.OCR == null || invoice.OCR == string.Empty)
                                    invoice.OCR = InvoiceUtility.GetSwedishOCRNumber(invoiceId.ToString() + seqNbr.ToString());
                                break;
                        }


                        invoice.TotalAmount = invoiceInput.TotalAmount;
                        invoice.TotalAmountCurrency = invoiceInput.TotalAmountCurrency;
                        invoice.VATAmount = invoiceInput.VatAmount;
                        invoice.VATAmountCurrency = invoiceInput.VatAmountCurrency;
                        if (specialfunctionality != null && specialfunctionality.Contains("Automaster"))
                        {
                            invoice.PaidAmount = invoice.PaidAmount != 0 ? invoice.PaidAmount : invoiceInput.PaidAmount;
                            invoice.PaidAmountCurrency = invoice.PaidAmountCurrency != 0 ? invoice.PaidAmountCurrency : invoiceInput.PaidAmountCurrency;
                            invoice.FullyPayed = invoice.FullyPayed == true && invoice.PaidAmount != 0 ? invoice.FullyPayed : invoiceInput.FullyPayed;
                        }
                        else
                        {
                            invoice.PaidAmount = invoiceInput.PaidAmount;
                            invoice.PaidAmountCurrency = invoiceInput.PaidAmountCurrency;
                            invoice.FullyPayed = invoiceInput.FullyPayed;
                        }
                        invoice.CurrencyId = currency.CurrencyId;
                        invoice.CurrencyRate = invoiceInput.CurrencyRate;
                        invoice.CurrencyDate = invoiceInput.CurrencyDate;
                        invoice.OnlyPayment = false;
                        invoice.SysPaymentTypeId = invoiceInput.SysPaymentTypeId;
                        invoice.PaymentNr = invoiceInput.PaymentNr;

                        // CustomerInvoice
                        invoice.MultipleAssetRows = false; // Will be calculated
                        invoice.SumAmount = invoiceInput.SumAmount;
                        invoice.FreightAmount = invoiceInput.FreightAmount;
                        invoice.FreightAmountCurrency = invoiceInput.FreightAmountCurrency;
                        invoice.InvoiceFee = invoiceInput.InvoiceFee;
                        invoice.InvoiceFeeCurrency = invoiceInput.InvoiceFeeCurrency;
                        invoice.CentRounding = invoiceInput.CentRounding;
                        invoice.InvoiceText = invoiceInput.InvoiceText;
                        invoice.MarginalIncome = invoiceInput.MarginalIncome;
                        invoice.MarginalIncomeCurrency = invoiceInput.MarginalIncomeCurrency;
                        invoice.MarginalIncomeRatio = invoiceInput.MarginalIncomeRatio;
                        invoice.PaymentConditionId = invoiceInput.PaymentConditionId;

                        #endregion

                        #region CustomerInvoiceRows

                        int noOfAssetRows = 0;

                        #region CustomerInvoiceRow Update/Delete

                        // Update or Delete existing CustomerInvoiceRows
                        foreach (CustomerInvoiceRow invoiceRow in invoice.ActiveCustomerInvoiceRows)
                        {
                            #region CustomerInvoiceRow

                            // Try get CustomerInvoiceRow from input
                            CustomerInvoiceRow invoiceRowInput = (from r in invoiceRowsInput
                                                                  where r.CustomerInvoiceRowId == invoiceRow.CustomerInvoiceRowId
                                                                  select r).FirstOrDefault();

                            if (invoiceRowInput != null)
                            {
                                // Update existing CustomerInvoiceRow
                                invoiceRow.Amount = invoiceRowInput.Amount;
                                invoiceRow.AmountCurrency = invoiceRowInput.AmountCurrency;
                                invoiceRow.Quantity = invoiceRowInput.Quantity;
                                invoiceRow.SumAmount = invoiceRowInput.SumAmount;
                                invoiceRow.SumAmountCurrency = invoiceRowInput.SumAmountCurrency;
                                invoiceRow.State = invoiceRowInput.State;

                                SetModifiedProperties(invoiceRow);

                                #region CustomerInvoiceAccountRow

                                foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                {
                                    // Count asset rows
                                    if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRow, invoiceAccountRow))
                                        noOfAssetRows++;

                                    // Try get CustomerInvoiceAccountRow from input
                                    CustomerInvoiceAccountRow invoiceAccountRowInput = (from r in invoiceRowInput.CustomerInvoiceAccountRow
                                                                                        where r.CustomerInvoiceAccountRowId == invoiceAccountRow.CustomerInvoiceAccountRowId
                                                                                        select r).FirstOrDefault();

                                    if (invoiceAccountRowInput != null)
                                    {
                                        // Update existing CustomerInvoiceAccountRow
                                        invoiceAccountRow.RowNr = invoiceAccountRowInput.RowNr;
                                        invoiceAccountRow.SplitType = invoiceAccountRowInput.SplitType;
                                        invoiceAccountRow.SplitPercent = invoiceAccountRowInput.SplitPercent;
                                        invoiceAccountRow.Amount = invoiceAccountRowInput.Amount;
                                        invoiceAccountRow.AmountCurrency = invoiceAccountRowInput.AmountCurrency;
                                        invoiceAccountRow.Quantity = invoiceAccountRowInput.Quantity;
                                        invoiceAccountRow.Text = invoiceAccountRowInput.Text;
                                        invoiceAccountRow.VatRow = invoiceAccountRowInput.VatRow;
                                        invoiceAccountRow.ContractorVatRow = invoiceAccountRowInput.ContractorVatRow;
                                        invoiceAccountRow.CreditRow = invoiceAccountRowInput.CreditRow;
                                        invoiceAccountRow.DebitRow = invoiceAccountRowInput.DebitRow;
                                        invoiceAccountRow.State = invoiceAccountRowInput.State;
                                        invoiceAccountRow.AccountStd = invoiceAccountRowInput.AccountStd;
                                        invoiceAccountRow.AccountDistributionHeadId = invoiceAccountRowInput.AccountDistributionHeadId;

                                        // Set AccountInternal
                                        if (invoiceAccountRowInput.AccountInternal != null)
                                        {
                                            // Clear all
                                            invoiceAccountRow.AccountInternal.Clear();

                                            foreach (AccountInternal accountInternalInput in invoiceAccountRowInput.AccountInternal)
                                            {
                                                // Add AccountInternal
                                                AccountInternal accountInternal = accountInternals.FirstOrDefault(a => a.AccountId == accountInternalInput.AccountId);
                                                if (accountInternal != null)
                                                    invoiceAccountRow.AccountInternal.Add(accountInternal);
                                            }
                                        }

                                        // Detach the input row to prevent adding a new
                                        base.TryDetachEntity(entities, invoiceAccountRowInput);
                                    }
                                    else
                                    {
                                        // Delete existing CustomerInvoiceAccountRow
                                        // Can only delete when Origin has status Draft or Origin
                                        if (invoice.Origin.Status == (int)SoeOriginStatus.Draft || invoice.Origin.Status == (int)SoeOriginStatus.Origin)
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                    }
                                }

                                // Add new CustomerInvoiceAccountRow rows
                                foreach (CustomerInvoiceAccountRow invoiceAccountRowToAdd in invoiceRowInput.CustomerInvoiceAccountRow.Where(r => r.CustomerInvoiceAccountRowId == 0).ToList())
                                {
                                    // Count asset rows
                                    if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRow, invoiceAccountRowToAdd))
                                        noOfAssetRows++;

                                    invoiceRow.CustomerInvoiceAccountRow.Add(invoiceAccountRowToAdd);
                                }

                                #endregion

                                // Detach the input row to prevent adding a new
                                base.TryDetachEntity(entities, invoiceRowInput);
                            }
                            else
                            {
                                // Can only delete when Origin has status Draft or Origin
                                if (invoice.Origin.Status == (int)SoeOriginStatus.Draft || invoice.Origin.Status == (int)SoeOriginStatus.Origin)
                                {
                                    if (specialfunctionality != null && specialfunctionality.Contains("Automaster"))
                                    {
                                        if (specialfunctionality.Contains("deleteRows"))
                                        {
                                            foreach (CustomerInvoiceRow row in invoice.ActiveCustomerInvoiceRows)
                                            {
                                                // Delete existing CustomerInvoiceRow
                                                ChangeEntityState(row, SoeEntityState.Deleted);

                                                foreach (CustomerInvoiceAccountRow invoiceAccountRow in row.ActiveCustomerInvoiceAccountRows)
                                                {
                                                    // Delete existing CustomerInvoiceAccountRow
                                                    ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                                }
                                            }
                                        }
                                    }
                                    else
                                    {
                                        // Delete existing CustomerInvoiceRow
                                        ChangeEntityState(invoiceRow, SoeEntityState.Deleted);

                                        foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                                        {
                                            // Delete existing CustomerInvoiceAccountRow
                                            ChangeEntityState(invoiceAccountRow, SoeEntityState.Deleted);
                                        }
                                    }
                                }

                            }

                            #endregion
                        }

                        #endregion

                        #region CustomerInvoiceRow Add

                        // Get new CustomerInvoiceRows
                        IEnumerable<CustomerInvoiceRow> invoiceRowsToAdd = (from r in invoiceRowsInput
                                                                            where r.CustomerInvoiceRowId == 0
                                                                            select r);

                        foreach (CustomerInvoiceRow invoiceRowToAdd in invoiceRowsToAdd)
                        {
                            foreach (CustomerInvoiceAccountRow invoiceAccountRowToAdd in invoiceRowToAdd.CustomerInvoiceAccountRow)
                            {
                                // Count asset rows
                                if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, invoiceRowToAdd, invoiceAccountRowToAdd))
                                    noOfAssetRows++;
                            }

                            // Add CustomerInvoiceRow to CustomerInvoice
                            invoice.CustomerInvoiceRow.Add(invoiceRowToAdd);
                        }

                        #endregion

                        #endregion

                        #region Postfix

                        // Check for multiple asset rows
                        invoice.MultipleAssetRows = noOfAssetRows > 1;

                        // Add CustomerInvoice
                        if (addInvoice)
                            entities.Invoice.AddObject(invoice);

                        #endregion

                        #region Calculate currency amounts

                        //Calculate currency amounts
                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, invoice, calculateForImport: isImport && specialfunctionality.Contains("Automaster"));

                        #endregion

                        #region Validate invoice accounting rows

                        if (!isImport && ValidateCustomerInvoiceAccountingRowsDiff(invoice))
                        {
                            return new ActionResult((int)ActionResultSave.HasUnbalancedAccountingRows, GetText(7406, 1, "Debet och kredit balanserar inte. Kontrollera konteringsrader och spara igen."));
                        }

                        #endregion

                        #region Voucher

                        // Check if Voucher should also should be saved at once
                        if (result.Success)
                        {
                            int accountYearId = invoice.VoucherDate.HasValue ? AccountManager.GetAccountYearId(entities, invoice.VoucherDate.Value, actorCompanyId) : SettingManager.GetIntSetting(entities, SettingMainType.UserAndCompany, (int)UserSettingType.AccountingAccountYear, base.UserId, actorCompanyId, 0);

                            result = TryTransferCustomerInvoiceToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, invoice, accountYearId, actorCompanyId);
                            if (result.Success)
                                voucherHeadsDict = NumberUtility.MergeDictictionary(voucherHeadsDict, result.IdDict);
                        }

                        #endregion

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        if (invoiceAttachments != null)
                        {
                            var newStatusIcon = SaveOrderInvoiceAttachments(entities, invoice.InvoiceId, invoice.StatusIcon, invoiceAttachments, invoice.InvoiceNr);
                            if (newStatusIcon != invoice.StatusIcon)
                            {
                                invoice.StatusIcon = newStatusIcon;
                                SaveChanges(entities);
                            }
                        }

                        if (result.Success)
                        {
                            invoiceId = invoice.Origin.OriginId;

                            //voucher successfully saved, create account distribution entries
                            #region AccountDistributionEntry

                            bool saveChanges = false;

                            //remove existing entries if voucher row deleted
                            List<CustomerInvoiceRow> deletedRows = invoice.CustomerInvoiceRow.Where(i => i.State == (int)SoeEntityState.Deleted).ToList();
                            foreach (var deletedRow in deletedRows)
                            {
                                int rowId = 0;
                                if (deletedRow.CustomerInvoiceAccountRow.FirstOrDefault() != null &&
                                    deletedRow.CustomerInvoiceAccountRow.FirstOrDefault().AccountDistributionHeadId != 0)
                                    rowId = deletedRow.CustomerInvoiceAccountRow.FirstOrDefault().CustomerInvoiceAccountRowId;

                                //set previously created entries to state deleted
                                if (rowId > 0)
                                {
                                    List<AccountDistributionEntry> existingEntries = AccountDistributionManager.GetAccountDistributionEntriesForSourceRow(entities, actorCompanyId, (int)TermGroup_AccountDistributionRegistrationType.CustomerInvoice, invoiceId, rowId).ToList();
                                    bool transferredEntries = existingEntries.Where(i => i.VoucherHeadId != null).ToList().Count > 0;
                                    if (!transferredEntries)
                                    {
                                        foreach (var entry in existingEntries)
                                        {
                                            entry.State = (int)SoeEntityState.Deleted;
                                            SetModifiedProperties(entry);
                                            saveChanges = true;
                                        }
                                    }
                                }
                            }

                            //create entries
                            for (int i = 0; i < accountingRowsInput.Count; i++)
                            {
                                if (accountingRowsInput[i].AccountDistributionHeadId != 0 && accountingRowsInput[i].AccountDistributionNbrOfPeriods != 0)
                                {
                                    int rowId = invoice.CustomerInvoiceRow.ElementAt(i).CustomerInvoiceAccountRow.FirstOrDefault().CustomerInvoiceAccountRowId;

                                    //set previously created entries to state deleted
                                    List<AccountDistributionEntry> existingEntries = AccountDistributionManager.GetAccountDistributionEntriesForSourceRow(entities, actorCompanyId, (int)TermGroup_AccountDistributionRegistrationType.CustomerInvoice, invoiceId, rowId).ToList();
                                    foreach (var entry in existingEntries)
                                    {
                                        entry.State = (int)SoeEntityState.Deleted;
                                        SetModifiedProperties(entry);
                                        saveChanges = true;
                                    }

                                    //create new entries
                                    List<AccountDistributionEntry> entries = AccountDistributionManager.CreateAccountDistributionEntriesFromAccountingRowDTO(entities, accountingRowsInput[i], rowId, actorCompanyId, (int)TermGroup_AccountDistributionRegistrationType.CustomerInvoice, invoiceId);
                                    foreach (var entry in entries)
                                    {
                                        SetCreatedProperties(entry);
                                        entities.AccountDistributionEntry.AddObject(entry);
                                        saveChanges = true;
                                    }
                                }
                            }

                            if (saveChanges)
                                result = SaveChanges(entities, transaction);

                            #endregion

                            //Commit transaction
                            transaction.Complete();

                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                    seqNbr = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = invoiceId;
                        result.StringValue = invoiceNbr;
                        result.BooleanValue = addInvoice;
                        result.Value = seqNbr;
                        if (voucherHeadsDict != null)
                        {
                            result.IdDict = voucherHeadsDict;
                            //result.IntegerValue = voucherHeadsDict.Count;
                        }
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        private List<CustomerInvoiceRow> ConvertToCustomerLedgerRows(CompEntities entities, List<AccountingRowDTO> accountingRowDTOs, int actorCompanyId, List<AccountInternal> accountInternals)
        {
            var rows = new List<CustomerInvoiceRow>();

            foreach (var item in accountingRowDTOs.Where(r => r.ParentRowId == 0))
            {
                // Do not include empty rows
                if (item.Dim1Id == 0 && item.DebitAmount - item.CreditAmount == 0)
                    continue;

                //Prevent that one CustomerInvoiceRow has multiple CustomerInvoiceAccountRows (old solution by Joakim)
                bool added = rows.Any(i => i.CustomerInvoiceRowId == item.InvoiceRowId && item.InvoiceRowId != 0);

                var row = new CustomerInvoiceRow
                {
                    CustomerInvoiceRowId = added ? 0 : item.InvoiceRowId,
                    Amount = item.Amount,
                    AmountCurrency = item.AmountCurrency,
                    AmountEntCurrency = item.AmountEntCurrency,
                    AmountLedgerCurrency = item.AmountLedgerCurrency,
                    SumAmount = item.Amount,
                    SumAmountCurrency = item.AmountCurrency,
                    SumAmountEntCurrency = item.AmountEntCurrency,
                    SumAmountLedgerCurrency = item.AmountLedgerCurrency,
                    Quantity = item.Quantity,
                    State = (int)item.State,
                    Type = (int)SoeInvoiceRowType.AccountingRow,
                };
                SetCreatedProperties(row);

                var accountRow = ConvertToCustomerLedgerAccountRow(entities, item, actorCompanyId, accountInternals);

                // Check for children
                foreach (var childItem in accountingRowDTOs.Where(r => r.ParentRowId == item.TempRowId))
                {
                    //Prevent that one CustomerInvoiceRow has multiple CustomerInvoiceAccountRows (old solution by Joakim)
                    bool childAdded = rows.Any(i => i.CustomerInvoiceRowId == childItem.InvoiceRowId && childItem.InvoiceRowId != 0);

                    var childRow = new CustomerInvoiceRow
                    {
                        CustomerInvoiceRowId = childAdded ? 0 : childItem.InvoiceRowId,
                        Amount = childItem.Amount,
                        AmountCurrency = childItem.AmountCurrency,
                        AmountEntCurrency = childItem.AmountEntCurrency,
                        AmountLedgerCurrency = childItem.AmountLedgerCurrency,
                        SumAmount = childItem.Amount,
                        SumAmountCurrency = childItem.AmountCurrency,
                        SumAmountEntCurrency = childItem.AmountEntCurrency,
                        SumAmountLedgerCurrency = childItem.AmountLedgerCurrency,
                        Quantity = childItem.Quantity,
                        State = (int)childItem.State,
                        Type = (int)SoeInvoiceRowType.AccountingRow,
                    };
                    SetCreatedProperties(childRow);

                    childRow.CustomerInvoiceAccountRow.Add(ConvertToCustomerLedgerAccountRow(entities, childItem, actorCompanyId, accountInternals, accountRow));
                    rows.Add(childRow);
                }

                row.CustomerInvoiceAccountRow.Add(accountRow);
                rows.Add(row);
            }

            return rows;
        }

        private CustomerInvoiceAccountRow ConvertToCustomerLedgerAccountRow(CompEntities entities, AccountingRowDTO item, int actorCompanyId, IEnumerable<AccountInternal> accountInternals, CustomerInvoiceAccountRow parentRow = null)
        {
            // Create new account row
            CustomerInvoiceAccountRow row = new CustomerInvoiceAccountRow()
            {
                CustomerInvoiceAccountRowId = item.InvoiceAccountRowId,
                RowNr = item.RowNr,
                SplitType = item.SplitType,
                SplitPercent = item.SplitPercent,
                Amount = item.Amount,
                AmountCurrency = item.AmountCurrency,
                AmountEntCurrency = item.AmountEntCurrency,
                AmountLedgerCurrency = item.AmountLedgerCurrency,
                Quantity = item.Quantity,
                Text = item.Text,
                VatRow = item.IsVatRow,
                ContractorVatRow = item.IsContractorVatRow,
                CreditRow = item.IsCreditRow,
                DebitRow = item.IsDebitRow,
                State = (int)item.State,
                AccountDistributionHeadId = item.AccountDistributionHeadId,
            };

            // Parent row
            if (parentRow != null)
                row.CustomerInvoiceAccountRow2 = parentRow;

            // Get standard account
            row.AccountStd = AccountManager.GetAccountStd(entities, item.Dim1Id, actorCompanyId, true, false);

            // Get internal accounts (Dim2-6)
            if (item.Dim2Id != 0)
            {
                AccountInternal accountInternal = accountInternals.FirstOrDefault(a => a.AccountId == item.Dim2Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim3Id != 0)
            {
                AccountInternal accountInternal = accountInternals.FirstOrDefault(a => a.AccountId == item.Dim3Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim4Id != 0)
            {
                AccountInternal accountInternal = accountInternals.FirstOrDefault(a => a.AccountId == item.Dim4Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim5Id != 0)
            {
                AccountInternal accountInternal = accountInternals.FirstOrDefault(a => a.AccountId == item.Dim5Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }
            if (item.Dim6Id != 0)
            {
                AccountInternal accountInternal = accountInternals.FirstOrDefault(a => a.AccountId == item.Dim6Id);
                if (accountInternal != null)
                    row.AccountInternal.Add(accountInternal);
            }

            return row;
        }

        #endregion

        #region CustomerInvoice (InsecureDeptDTO)

        public IEnumerable<CustomerInvoiceInsecureDTO> GetCustomerInsecureDebtDTO(int actorCompanyId)
        {
            List<CustomerInvoiceInsecureDTO> list = new List<CustomerInvoiceInsecureDTO>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var query = (from invoice in entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                         .Include("Actor.Customer")
                         .Include("Currency")
                         .Include("Origin")
                         where invoice.Origin.ActorCompanyId == actorCompanyId &&
                         invoice.RegistrationType == (int)OrderInvoiceRegistrationType.Invoice &&
                         !invoice.FullyPayed &&
                         invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice &&
                         (invoice.Origin.Status == (int)SoeOriginStatus.Origin || invoice.Origin.Status == (int)SoeOriginStatus.Voucher)
                         select invoice).ToList();

            foreach (var item in query)
            {
                var dto = new CustomerInvoiceInsecureDTO()
                {
                    InvoiceId = item.InvoiceId,
                    InvoiceNr = item.InvoiceNr,
                    InvoiceNrSort = item.InvoiceNrSort,
                    Status = item.Status,
                    StatusName = GetText(item.Origin.Status, (int)TermGroup.OriginStatus),
                    ActorId = item.ActorId,
                    CustomerName = item.Actor.Customer.Name,
                    InsecureDebt = item.InsecureDebt,
                    CurrencyId = item.CurrencyId,
                    CurrencyCode = item.Currency.Code,
                    TotalAmountCurrency = item.TotalAmountCurrency,
                    DueDate = item.DueDate,
                    InvoiceDate = item.InvoiceDate,
                    InternalText = item.Origin.Description,
                };

                list.Add(dto);
            }

            return list;
        }

        #endregion CustomerInvoice (InsecureDeptDTO)

        #endregion

        #region CustomerInvoiceRow

        public List<CustomerInvoiceRowSmallDTO> GetCustomerInvoiceRowsSmall(CompEntities entities, int invoiceId)
        {
            entities.CustomerInvoiceRow.NoTracking();
            return (from cr in entities.CustomerInvoiceRow
                    where cr.InvoiceId == invoiceId &&
                        cr.State == (int)SoeEntityState.Active &&
                        (cr.Type == (int)SoeInvoiceRowType.ProductRow || cr.Type == (int)SoeInvoiceRowType.TextRow)
                    select new CustomerInvoiceRowSmallDTO
                    {
                        CustomerInvoiceRowId = cr.CustomerInvoiceRowId,
                        RowNr = cr.RowNr,
                        Quantity = cr.Quantity ?? 0,
                        ProductId = cr.ProductId,
                        Text = cr.Text,
                        AmountCurrency = cr.AmountCurrency,
                        VATAmountCurrency = cr.VatAmountCurrency,
                        AttestStateId = cr.AttestStateId,
                        EdiEntryId = cr.EdiEntryId,
                        SumAmountCurrency = cr.SumAmountCurrency,
                        VatRate = cr.VatRate,
                        DeliveryDateText = cr.DeliveryDateText,
                        Type = cr.Type
                    }).ToList();
        }

        public List<CustomerInvoiceRowDistributionDTO> GetCustomerInvoiceRowsDistribution(CompEntities entities, int invoiceId)
        {

            entities.CustomerInvoiceRow.NoTracking();
            return (from cr in entities.CustomerInvoiceRow
                    join ip in entities.Product.OfType<InvoiceProduct>() on cr.ProductId equals ip.ProductId into gj
                    from x in gj.DefaultIfEmpty()
                    where cr.InvoiceId == invoiceId &&
                        cr.State == (int)SoeEntityState.Active &&
                        (cr.Type == (int)SoeInvoiceRowType.ProductRow || cr.Type == (int)SoeInvoiceRowType.TextRow)
                    select new CustomerInvoiceRowDistributionDTO
                    {
                        Product = new InvoiceProductDistributionDTO
                        {
                            Name = cr.Product.Name,
                            Number = cr.Product.Number,
                            VatType = (x == null ? 0 : x.VatType),
                            HouseholdDeductionType = (cr.HouseholdDeductionType ?? 0),
                            Created = cr.Product.Created,
                            Modified = cr.Product.Modified,
                        },
                        Type = cr.Type,
                        Quantity = (cr.Quantity ?? 0),
                        Text = cr.Text,
                        Unit = cr.ProductUnit.Code,
                        PurchasePrice = cr.PurchasePriceCurrency,
                        AmountCurrency = cr.AmountCurrency,
                        SumVATAmountCurrency = cr.VatAmountCurrency,
                        SumAmountCurrency = cr.SumAmountCurrency,
                        VatRate = cr.VatRate,
                        DiscountPercent = cr.DiscountPercent,
                        HousholdDeductionRow = (cr.HouseholdTaxDeductionRow != null
                            ? new HouseholdTaxDeductionRowDTO
                            {
                                Property = cr.HouseholdTaxDeductionRow.Property,
                                ApartmentNr = cr.HouseholdTaxDeductionRow.ApartmentNr,
                                CooperativeOrgNr = cr.HouseholdTaxDeductionRow.CooperativeOrgNr,
                                SocialSecNr = cr.HouseholdTaxDeductionRow.SocialSecNr,
                                Name = cr.HouseholdTaxDeductionRow.Name,
                                Amount = cr.HouseholdTaxDeductionRow.Amount,
                            } : null),
                    }).ToList();
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceAccountTypeRows(CompEntities entities, int invoiceId)
        {
            return (from cr in entities.CustomerInvoiceRow
                           .Include("CustomerInvoiceAccountRow")
                           .Include("CustomerInvoiceAccountRow.AccountStd.Account")
                           .Include("HouseholdTaxDeductionRow")
                    where cr.InvoiceId == invoiceId &&
                        cr.State == (int)SoeEntityState.Active &&
                        cr.Type == (int)SoeInvoiceRowType.AccountingRow &&
                        cr.ProductId == null &&
                        cr.IsCentRoundingRow == false
                    select cr).ToList();
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceRowsForOrderInvoiceEdit(CompEntities entities, int invoiceId, bool includeAccountRows = false, bool includeProduct = true, bool includeCustomerInvoice = true)
        {
            IQueryable<CustomerInvoiceRow> query = entities.CustomerInvoiceRow;

            if (includeAccountRows)
            {
                query = query.Include("CustomerInvoiceAccountRow");
                query = query.Include("CustomerInvoiceAccountRow.AccountStd.Account");
                query = query.Include("CustomerInvoiceAccountRow.AccountInternal.Account.AccountDim");
            }

            if (includeProduct)
            {
                query = query.Include("Product");
                query = query.Include("ProductUnit");
            }

            if (includeCustomerInvoice)
            {
                query = query.Include("HouseholdTaxDeductionRow");
                query = query.Include("CustomerInvoice");
            }

            return (from cr in query
                            .Include("VatAccountStd.Account")
                    where cr.InvoiceId == invoiceId &&
                        cr.State == (int)SoeEntityState.Active
                    select cr).ToList();
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceRowsForCustomerInvoiceEdit(int invoiceId, bool includeHouseHoldRows, bool includeCustomerInvoice)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceRow.NoTracking();
            return GetCustomerInvoiceRowsForCustomerInvoiceEdit(entities, invoiceId, includeHouseHoldRows, includeCustomerInvoice);
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceRowsForCustomerInvoiceEdit(CompEntities entities, int invoiceId, bool includeHouseHoldRows, bool includeCustomerInvoice)
        {
            IQueryable<CustomerInvoiceRow> query = entities.CustomerInvoiceRow.Include("VatAccountStd.Account");

            if (includeHouseHoldRows)
                query = query.Include("HouseholdTaxDeductionRow");

            if (includeCustomerInvoice)
                query = query.Include("CustomerInvoice");

            return (from cr in query
                    where cr.InvoiceId == invoiceId &&
                    cr.State == (int)SoeEntityState.Active
                    select cr).ToList();
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceRows(int invoiceId, bool loadProduct, bool householdTaxDeductionRow = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceRow.NoTracking();
            return GetCustomerInvoiceRows(entities, invoiceId, loadProduct, householdTaxDeductionRow);
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceRows(CompEntities entities, int invoiceId, bool loadProduct, bool householdTaxDeductionRow = false)
        {
            IQueryable<CustomerInvoiceRow> query = entities.CustomerInvoiceRow;

            if (loadProduct)
                query = query.Include("Product");

            if (householdTaxDeductionRow)
                query = query.Include("HouseholdTaxDeductionRow");

            return (from r in query
                    where r.InvoiceId == invoiceId &&
                    r.State == (int)SoeEntityState.Active
                    select r).ToList();
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceRowsByProduct(CompEntities entities, int invoiceId, int productId, bool loadProduct = false, bool loadProductUnit = false)
        {
            IQueryable<CustomerInvoiceRow> query = entities.CustomerInvoiceRow;
            if (loadProduct)
                query = query.Include("Product");
            if (loadProductUnit)
                query = query.Include("ProductUnit");

            return (from r in query
                    where r.InvoiceId == invoiceId &&
                    r.ProductId == productId &&
                    r.State == (int)SoeEntityState.Active
                    select r).ToList();
        }

        public List<CustomerInvoiceRow> GetUnAttestedCustomerInvoiceRows(CompEntities entities, int actorCompanyId, int invoiceId, int productid, TermGroup_AttestEntity attestEntity, bool loadProduct = false, bool loadProductUnit = false)
        {
            List<CustomerInvoiceRow> invoiceProductRows = GetCustomerInvoiceRowsByProduct(entities, invoiceId, productid, loadProduct, loadProductUnit);
            if (invoiceProductRows.Count == 0)
                return new List<CustomerInvoiceRow>();

            var initialAttestStateId = AttestManager.GetInitialAttestStateId(entities, actorCompanyId, attestEntity);

            return (from cir in invoiceProductRows
                    where (!cir.AttestStateId.HasValue || (cir.AttestStateId.Value == initialAttestStateId))
                    select cir).ToList();
        }

        public CustomerInvoiceRow GetCustomerInvoiceRow(int customerInvoiceRowId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceRow.NoTracking();
            return GetCustomerInvoiceRow(entities, customerInvoiceRowId);
        }

        public CustomerInvoiceRow GetCustomerInvoiceRow(CompEntities entities, int customerInvoiceRowId, bool loadProductUnit = false, bool loadCustomerInvoice = false)
        {
            if (customerInvoiceRowId == 0)
                return null;

            IQueryable<CustomerInvoiceRow> query = entities.CustomerInvoiceRow;
            if (loadProductUnit)
                query = query.Include("ProductUnit");

            if (loadCustomerInvoice)
                query = query.Include("CustomerInvoice");

            return (from r in query
                    where r.CustomerInvoiceRowId == customerInvoiceRowId
                    select r).FirstOrDefault();
        }

        public CustomerInvoiceRow GetCustomerInvoiceRowFromTargetRow(CompEntities entities, int customerInvoiceRowId)
        {
            return (from r in entities.CustomerInvoiceRow
                    where r.TargetRowId == customerInvoiceRowId &&
                          r.State == (int)SoeEntityState.Active
                    select r).FirstOrDefault();
        }

        public CustomerInvoiceRow GetHouseholdDeductionTextRow(CompEntities entities, int customerInvoiceRowId)
        {
            return (from r in entities.CustomerInvoiceRow
                    where r.ParentRowId == customerInvoiceRowId &&
                        r.Type == (int)SoeInvoiceRowType.TextRow &&
                        r.State == (int)SoeEntityState.Active
                    select r).FirstOrDefault();
        }


        public decimal GetSuggestedHouseholdAmount(int actorCompanyId, int orderId, bool isRut, TermGroup_MobileHouseHoldTaxDeductionType mobileDeductionType)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceRow.NoTracking();
            entities.Invoice.NoTracking();
            return GetSuggestedHouseholdAmount(entities, actorCompanyId, orderId, isRut, mobileDeductionType);
        }

        //See InvoiceProductRows.ShowHouseholdTaxDeduction()
        public decimal GetSuggestedHouseholdAmount(CompEntities entities, int actorCompanyId, int orderId, bool isRut, TermGroup_MobileHouseHoldTaxDeductionType mobileDeductionType)
        {
            var deductionProductIds = new List<int>();
            var vatTypes = new List<int>();

            var productId = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductHouseholdTaxDeduction, actorCompanyId)?.ProductId;
            if (productId.HasValue && productId.GetValueOrDefault() > 0)
            {
                deductionProductIds.Add(productId.Value);
            }

            productId = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductHousehold50TaxDeduction, actorCompanyId)?.ProductId;
            if (productId.HasValue && productId.GetValueOrDefault() > 0)
            {
                deductionProductIds.Add(productId.Value);
            }

            productId = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductRUTTaxDeduction, actorCompanyId)?.ProductId;
            if (productId.HasValue && productId.GetValueOrDefault() > 0)
            {
                deductionProductIds.Add(productId.Value);
            }

            productId = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductGreen20TaxDeduction, actorCompanyId)?.ProductId;
            if (productId.HasValue && productId.GetValueOrDefault() > 0)
            {
                deductionProductIds.Add(productId.Value);
            }

            productId = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductGreen50TaxDeduction, actorCompanyId)?.ProductId;
            if (productId.HasValue && productId.GetValueOrDefault() > 0)
            {
                deductionProductIds.Add(productId.Value);
            }

            //Vat types
            vatTypes.Add((int)TermGroup_InvoiceProductVatType.Service);
            switch (mobileDeductionType)
            {
                case TermGroup_MobileHouseHoldTaxDeductionType.ChargePoint:
                case TermGroup_MobileHouseHoldTaxDeductionType.EneryStorage:
                case TermGroup_MobileHouseHoldTaxDeductionType.SolarPanels:
                    vatTypes.Add((int)TermGroup_InvoiceProductVatType.Merchandise);
                    break;
            }

            bool priceListTypeInclusiveVat = (from r in entities.Invoice.OfType<CustomerInvoice>()
                                              where r.InvoiceId == orderId && r.PriceListTypeId.HasValue
                                              select r.PriceListType.InclusiveVat).FirstOrDefault();

            decimal usedAmount = (from r in entities.CustomerInvoiceRow
                                  where r.InvoiceId == orderId &&
                                      deductionProductIds.Contains(r.ProductId.Value) &&
                                      r.State == (int)SoeEntityState.Active
                                  select r.SumAmountCurrency
                                  ).AsEnumerable().Sum(x => x);

            decimal serviceAmount = 0;
            var items = (from r in entities.CustomerInvoiceRow
                         where r.InvoiceId == orderId &&
                               r.ProductId.HasValue && (r.Product is InvoiceProduct) &&
                               !deductionProductIds.Contains(r.ProductId.Value) &&
                               vatTypes.Contains((r.Product as InvoiceProduct).VatType) &&
                               r.State == (int)SoeEntityState.Active &&
                               r.HouseholdDeductionType != 16 //Övrig
                         select new { SumAmountCurrency = r.SumAmountCurrency, VatAmountCurrency = r.VatAmountCurrency }).ToList();

            if (items != null)
            {
                foreach (var item in items)
                {
                    serviceAmount += item.SumAmountCurrency + (!priceListTypeInclusiveVat ? item.VatAmountCurrency : 0);
                }
            }

            //Since 2016-01-01 ROT is 30%
            //decimal householdAmount = (serviceAmount / 2) + usedAmount; // usedAmount is negative, therefore we add it here instead of subtracting
            decimal householdAmount = 0;

            switch (mobileDeductionType)
            {
                case TermGroup_MobileHouseHoldTaxDeductionType.ROT:
                    householdAmount = (serviceAmount * 0.3m);
                    break;
                case TermGroup_MobileHouseHoldTaxDeductionType.ROT_50:
                    householdAmount = (serviceAmount * 0.5m);
                    break;
                case TermGroup_MobileHouseHoldTaxDeductionType.RUT:
                case TermGroup_MobileHouseHoldTaxDeductionType.ChargePoint:
                case TermGroup_MobileHouseHoldTaxDeductionType.EneryStorage:
                    householdAmount = (serviceAmount * 0.5m);
                    break;
                case TermGroup_MobileHouseHoldTaxDeductionType.SolarPanels:
                    householdAmount = (serviceAmount * 0.20m);
                    break;
                default:
                    householdAmount = (isRut ? (serviceAmount * 0.5m) : (serviceAmount * 0.3m));
                    break;
            }

            return Math.Floor(householdAmount + usedAmount);
        }

        public List<CustomerInvoiceRow> GetCustomerInvoiceAssetRow(List<CustomerInvoiceRow> customerInvoiceRows)
        {
            return customerInvoiceRows.Where(r => r.State == (int)SoeEntityState.Active && r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && r.IsCentRoundingRow == false && r.SumAmountCurrency != 0).ToList();
        }

        public int GetNrOfCustomerInvoiceRowsByInvoice(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceRow.NoTracking();
            return GetNrOfCustomerInvoiceRowsByInvoice(entities, invoiceId);
        }

        public int GetNrOfCustomerInvoiceRowsByInvoice(CompEntities entities, int invoiceId)
        {
            return (from r in entities.CustomerInvoiceRow
                    where r.InvoiceId == invoiceId &&
                    r.State == (int)SoeEntityState.Active &&
                    r.Type == (int)SoeInvoiceRowType.ProductRow
                    select r).Count();
        }

        public bool IsCustomerInvoiceAssetRow(CompEntities entities, TermGroup_BillingType billingType, CustomerInvoiceRow invoiceRow, CustomerInvoiceAccountRow invoiceAccountRow)
        {
            // Check CustomerInvoiceRow
            if (invoiceRow.Type != (int)SoeInvoiceRowType.AccountingRow && invoiceRow.Product != null || invoiceRow.HouseholdTaxDeductionRow != null || invoiceRow.IsCentRoundingRow)
                return false;

            // Check CustomerInvoiceAccountRow
            if (invoiceAccountRow.VatRow || invoiceAccountRow.ContractorVatRow)
                return false;

            //Check Debit/credit
            decimal quantity = invoiceAccountRow.Quantity.HasValue ? invoiceAccountRow.Quantity.Value : 0;
            if (billingType == TermGroup_BillingType.Credit && IsCustomerInvoiceAssetAccount(entities, invoiceAccountRow.AccountId))
            {
                if (invoiceAccountRow.CreditRow && quantity <= 0)
                    return true;
            }
            else
            {
                if (invoiceAccountRow.DebitRow && quantity >= 0 && IsCustomerInvoiceAssetAccount(entities, invoiceAccountRow.AccountId))
                    return true;
            }

            return false;
        }

        public bool IsCustomerInvoiceAssetAccount(CompEntities entities, int accountId)
        {
            if (entities == null)
            {
                if (AccountManager.GetAccountType(accountId) == (int)TermGroup_AccountType.Asset)
                    return true;
            }
            else if (AccountManager.GetAccountType(entities, accountId) == (int)TermGroup_AccountType.Asset)
                return true;

            return false;
        }

        public bool IsAnyCustomerInvoiceRowActive(List<CustomerInvoiceRow> customerInvoiceRows)
        {
            if (customerInvoiceRows.Count > 0)
            {
                foreach (var customerInvoiceRow in customerInvoiceRows)
                {
                    //Make sure CustomerInvoice is loaded
                    if (!customerInvoiceRow.CustomerInvoiceReference.IsLoaded)
                        customerInvoiceRow.CustomerInvoiceReference.Load();

                    if (customerInvoiceRow.CustomerInvoice.State == (int)SoeEntityState.Active)
                        return true;
                }
            }

            return false;
        }

        public void LoadCustomerInvoiceRows(CustomerInvoice customerInvoice, bool loadInterestAndReminder = false, bool loadInvoiceAccountRow = false, bool loadTimeCodetransaction = false, bool loadIntrastatTransaction = false)
        {
            if (customerInvoice == null || customerInvoice.IsAdded())
                return;

            #region InvoiceRow

            if (!customerInvoice.CustomerInvoiceRow.IsLoaded)
                customerInvoice.CustomerInvoiceRow.Load();

            foreach (CustomerInvoiceRow invoiceRow in customerInvoice.ActiveCustomerInvoiceRows.Where(r => r.State != (int)SoeEntityState.Deleted))
            {
                #region CustomerInvoiceRow

                if (invoiceRow.IsAdded())
                    continue;

                // Parent row
                if (!invoiceRow.ParentRowReference.IsLoaded)
                    invoiceRow.ParentRowReference.Load();

                // AccountStd
                if (!invoiceRow.VatAccountStdReference.IsLoaded)
                    invoiceRow.VatAccountStdReference.Load();
                if (invoiceRow.VatAccountStd != null && !invoiceRow.VatAccountStd.AccountReference.IsLoaded)
                    invoiceRow.VatAccountStd.AccountReference.Load();

                // Product
                if (!invoiceRow.ProductReference.IsLoaded)
                    invoiceRow.ProductReference.Load();

                // ProductUnit
                if (!invoiceRow.ProductUnitReference.IsLoaded)
                    invoiceRow.ProductUnitReference.Load();

                // HouseholdTaxDeduction
                invoiceRow.LoadHouseholdTaxDeductionRowReference();
                //if (!invoiceRow.HouseholdTaxDeductionRowReference.IsLoaded)
                //    invoiceRow.HouseholdTaxDeductionRowReference.Load();

                if (!invoiceRow.StockReference.IsLoaded)
                    invoiceRow.StockReference.Load();

                // InterestAndReminder
                if (loadInterestAndReminder)
                {
                    if (!invoiceRow.CustomerInvoiceInterestReference.IsLoaded)
                        invoiceRow.CustomerInvoiceInterestReference.Load();
                    if (!invoiceRow.CustomerInvoiceReminderReference.IsLoaded)
                        invoiceRow.CustomerInvoiceReminderReference.Load();
                }

                if (loadInvoiceAccountRow)
                {
                    #region InvoiceAccountRow

                    // CustomerInvoiceAccountRow
                    if (!invoiceRow.CustomerInvoiceAccountRowIsLoaded)
                        invoiceRow.LoadCustomerInvoiceAccountRow();
                    //    entities.GetOrCreateDbContext().Entry(invoiceRow).Collection(x => x.CustomerInvoiceAccountRow).Query().Where(x => x.State == 0).Load();

                    foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                    {
                        // AccountStd
                        if (!invoiceAccountRow.AccountStdReference.IsLoaded)
                            invoiceAccountRow.AccountStdReference.Load();
                        if (invoiceAccountRow.AccountStd != null)
                        {
                            if (!invoiceAccountRow.AccountStd.AccountReference.IsLoaded)
                                invoiceAccountRow.AccountStd.AccountReference.Load();
                            if (!invoiceAccountRow.AccountStd.AccountBalance.IsLoaded)
                                invoiceAccountRow.AccountStd.AccountBalance.Load();
                        }

                        // AccountInternal
                        if (!invoiceAccountRow.AccountInternal.IsLoaded)
                            invoiceAccountRow.AccountInternal.Load();

                        foreach (AccountInternal accountInternal in invoiceAccountRow.AccountInternal)
                        {
                            if (!accountInternal.AccountReference.IsLoaded)
                                accountInternal.AccountReference.Load();
                            if (!accountInternal.Account.AccountDimReference.IsLoaded)
                                accountInternal.Account.AccountDimReference.Load();
                        }
                    }

                    #endregion
                }

                if (loadTimeCodetransaction && !invoiceRow.TimeCodeTransaction.IsLoaded)
                {
                    invoiceRow.TimeCodeTransaction.Load();
                }

                if (loadIntrastatTransaction && !invoiceRow.IntrastatTransactionReference.IsLoaded)
                {
                    invoiceRow.IntrastatTransactionReference.Load();
                }

                #endregion
            }

            #endregion
        }

        public IQueryable<CustomerInvoice> LoadCustomerInvoiceRowsToQuery(IQueryable<CustomerInvoice> query, bool loadInterestAndReminder = false, bool loadInvoiceAccountRow = false, bool loadTimeCodetransaction = false, bool loadIntrastatTransaction = false)
        {
            query = query.Include("CustomerInvoiceRow.ParentRow")
                            .Include("CustomerInvoiceRow.VatAccountStd.Account")
                             .Include("CustomerInvoiceRow.HouseholdTaxDeductionRow")
                             .Include("CustomerInvoiceRow.Product")
                             .Include("CustomerInvoiceRow.ProductUnit")
                             .Include("CustomerInvoiceRow.Stock");

            if (loadInterestAndReminder)
            {
                query = query.Include("CustomerInvoiceRow.CustomerInvoiceInterest")
                                .Include("CustomerInvoiceRow.CustomerInvoiceReminder");
            }

            if (loadInvoiceAccountRow)
            {
                query = query.Include("CustomerInvoiceRow.CustomerInvoiceAccountRow.AccountStd.Account")
                                .Include("CustomerInvoiceRow.CustomerInvoiceAccountRow.AccountStd.AccountBalance")
                                .Include("CustomerInvoiceRow.CustomerInvoiceAccountRow.AccountInternal.Account.AccountDim");
            }

            if (loadTimeCodetransaction)
            {
                query = query.Include("CustomerInvoiceRow.TimeCodeTransaction");
            }

            if (loadIntrastatTransaction)
            {
                query = query.Include("CustomerInvoiceRow.IntrastatTransaction");
            }

            return query;
        }

        public CustomerInvoiceRow CopyCustomerInvoiceRow(CompEntities entities, CustomerInvoiceRow prototype)
        {
            #region Properties

            var clone = new CustomerInvoiceRow();
            EntityUtil.Copy<CustomerInvoiceRow>(clone, prototype);

            SetCreatedProperties(clone);

            #endregion

            #region References

            //References
            clone.Product = prototype.Product;
            clone.ProductUnit = prototype.ProductUnit;
            clone.VatAccountStd = prototype.VatAccountStd;
            clone.CustomerInvoiceInterest = null;
            clone.CustomerInvoiceReminder = null;

            // Household tax deduction row
            if (prototype.HouseholdTaxDeductionRow != null)
            {
                HouseholdTaxDeductionRow household = new HouseholdTaxDeductionRow();
                EntityUtil.Copy<HouseholdTaxDeductionRow>(household, prototype.HouseholdTaxDeductionRow);
                clone.HouseholdTaxDeductionRow = household;
            }

            // Intrastat transaction
            if (prototype.IntrastatTransaction != null)
            {
                IntrastatTransaction transaction = new IntrastatTransaction();
                EntityUtil.Copy<IntrastatTransaction>(transaction, prototype.IntrastatTransaction);

                SetCreatedProperties(transaction);
                clone.IntrastatTransaction = transaction;
            }

            #endregion

            return clone;
        }

        public ActionResult ChangeAttestStateOnOrderRows(List<GenericType<int, int>> rows, int attestStateId, int actorCompanyId)
        {
            ActionResult result;

            using (var entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        foreach (var item in rows)
                        {
                            var invoice = GetCustomerInvoice(entities, item.Field1, loadOrigin: true, loadInvoiceRow: true);
                            if (invoice == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                            var attestState = AttestManager.GetAttestState(entities, attestStateId);
                            if (attestState == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "AttestState");

                            var row = invoice.CustomerInvoiceRow.FirstOrDefault(r => r.CustomerInvoiceRowId == item.Field2);
                            if (row != null)
                            {
                                row.AttestStateId = attestStateId;
                                SetModifiedProperties(row);

                                int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, invoice.CurrencyId);
                                int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                                result = UpdateInvoiceAfterRowModification(entities, invoice, invoice.ActiveCustomerInvoiceRows.Count + 1, actorCompanyId, true, sysCurrencyIdInvoice != sysCurrencyIdBase);


                                if (!result.Success)
                                    return result;
                            }
                        }

                        result = SaveChanges(entities);
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    log.Error(ex.Message, ex);
                    return new ActionResult(ex);
                }
            }

            return result;
        }

        #endregion

        #region CustomerInvoiceAccountRow

        public int GetCustomerInvoiceClaimAccountId(TermGroup_BillingType billingType, int invoiceId)
        {
            int claimAccountId;
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.CustomerInvoiceAccountRow.NoTracking();

            IQueryable<CustomerInvoiceAccountRow> query = (from ca in entitiesReadOnly.CustomerInvoiceAccountRow
                                                           where
                                                               ca.CustomerInvoiceRow.InvoiceId == invoiceId &&
                                                               !ca.CustomerInvoiceRow.IsCentRoundingRow &&
                                                               !ca.CustomerInvoiceRow.IsFreightAmountRow &&
                                                               !ca.CustomerInvoiceRow.IsInterestRow &&
                                                               !ca.CustomerInvoiceRow.IsInvoiceFeeRow &&
                                                               ca.State == (int)SoeEntityState.Active &&
                                                               ca.AccountStd.AccountTypeSysTermId == (int)TermGroup_AccountType.Asset &&
                                                               !ca.VatRow &&
                                                               ca.CustomerInvoiceRow.HouseholdDeductionType == null
                                                           select ca
                                                           );


            if (billingType == TermGroup_BillingType.Credit)
            {
                claimAccountId = query.Where(a => a.CreditRow).Select(a => a.AccountId).FirstOrDefault();
            }
            else
            {
                claimAccountId = query.Where(a => a.DebitRow).Select(a => a.AccountId).FirstOrDefault();
            }

            return claimAccountId;
        }

        public List<CustomerInvoiceAccountRow> GetCustomerInvoiceAccountRowsForCustomerInvoiceEdit(int invoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceAccountRow.NoTracking();
            return (from cr in entities.CustomerInvoiceAccountRow
                        .Include("CustomerInvoiceRow")
                        .Include("AccountStd.Account")
                        .Include("AccountInternal.Account.AccountDim")
                    where cr.CustomerInvoiceRow.InvoiceId == invoiceId &&
                    cr.State == (int)SoeEntityState.Active
                    select cr).ToList();
        }

        public CustomerInvoiceAccountRow GetCustomerInvoiceAccountRow(CompEntities entities, int customerInvoiceAccountRowId)
        {
            return (from r in entities.CustomerInvoiceAccountRow
                    where r.CustomerInvoiceAccountRowId == customerInvoiceAccountRowId
                    select r).FirstOrDefault();
        }

        public CustomerInvoiceAccountRow GetCustomerInvoiceAccountRow(CompEntities entities, int customerInvoiceRowId, bool isVatAccount, bool loadAccounts = false)
        {
            if (customerInvoiceRowId == 0)
                return null;

            IQueryable<CustomerInvoiceAccountRow> query = entities.CustomerInvoiceAccountRow;
            if (loadAccounts)
            {
                query = query.Include("AccountStd.Account");
                query = query.Include("AccountInternal.Account");
            }

            return (from r in query
                    where r.CustomerInvoiceRowId == customerInvoiceRowId &&
                    r.VatRow == isVatAccount &&
                    r.State == (int)SoeEntityState.Active
                    select r).FirstOrDefault();
        }

        public CustomerInvoiceAccountRow GetCustomerInvoiceAssetAccountRow(CompEntities entities, CustomerInvoice invoice, List<CustomerInvoiceRow> preLoadedCustomerInvoiceRows = null)
        {
            List<CustomerInvoiceRow> customerInvoiceRows = preLoadedCustomerInvoiceRows.IsNullOrEmpty() ? GetCustomerInvoiceAssetRow(invoice.ActiveCustomerInvoiceRows) : GetCustomerInvoiceAssetRow(preLoadedCustomerInvoiceRows);
            if (customerInvoiceRows == null)
                return null;

            foreach (var customerInvoiceRow in customerInvoiceRows)
            {
                if (!customerInvoiceRow.CustomerInvoiceAccountRowIsLoaded)
                    customerInvoiceRow.LoadCustomerInvoiceAccountRow();

                IEnumerable<CustomerInvoiceAccountRow> customerInvoiceAccountRows = customerInvoiceRow.CustomerInvoiceAccountRow;

                foreach (var customerInvoiceAccountRow in customerInvoiceAccountRows)
                {
                    if (IsCustomerInvoiceAssetRow(entities, (TermGroup_BillingType)invoice.BillingType, customerInvoiceRow, customerInvoiceAccountRow))
                        return customerInvoiceAccountRow;
                }
            }

            return null;
        }

        public CustomerInvoiceAccountRow CopyCustomerInvoiceAccountRow(CustomerInvoiceAccountRow prototype)
        {
            #region Properties

            var clone = new CustomerInvoiceAccountRow();
            EntityUtil.Copy<CustomerInvoiceAccountRow>(clone, prototype);
            SetCreatedProperties(clone);

            #endregion

            #region References

            //References
            clone.AccountStd = prototype.AccountStd;

            //AccountInternals
            foreach (AccountInternal accountInternal in prototype.AccountInternal)
            {
                clone.AccountInternal.Add(accountInternal);
            }

            #endregion

            return clone;
        }

        public void CreateCustomerInvoiceAccountRow(CompEntities entities, CustomerInvoiceRow productRow, TermGroup_InvoiceVatType vatType, ref int nextRowNr, int customerId, int employeeId, int projectId, int actorCompanyId, AccountingPrioDTO accountingPrioDTO, int? invoiceDim2AccountId = null, int? invoiceDim3AccountId = null, int? invoiceDim4AccountId = null, int? invoiceDim5AccountId = null, int? invoiceDim6AccountId = null, bool addQuantityOnAccountingRow = false, bool tripartiteTrade = false)
        {
            if (productRow == null)
                return;

            AccountingPrioDTO dto = null;

            // Check for discount accounts
            var discountAccountId = productRow.DiscountAmountCurrency != 0 ? SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCustomerDiscount, 0, actorCompanyId, 0) : 0;
            var discountOffsetAccountId = productRow.DiscountAmountCurrency != 0 ? SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCustomerDiscountOffset, 0, actorCompanyId, 0) : 0;
            var isCredit = (productRow.SumAmount >= 0);

            if (accountingPrioDTO == null)
            {
                // Add sales row
                if (productRow.ProductId.HasValue)
                {
                    if (productRow.HouseholdTaxDeductionRow == null)
                    {
                        ProductAccountType accountType = ProductAccountType.Sales;
                        switch (vatType)
                        {
                            case TermGroup_InvoiceVatType.Contractor:
                                accountType = ProductAccountType.SalesContractor;
                                break;
                            case TermGroup_InvoiceVatType.NoVat:
                                accountType = ProductAccountType.SalesNoVat;
                                break;
                            case TermGroup_InvoiceVatType.ExportWithinEU:
                                accountType = tripartiteTrade ? ProductAccountType.TripartiteTrade : ProductAccountType.ExportWithinEU;
                                break;
                            case TermGroup_InvoiceVatType.ExportOutsideEU:
                                accountType = tripartiteTrade ? ProductAccountType.TripartiteTrade : ProductAccountType.ExportOutsideEU;
                                break;
                            default:
                                break;
                        }

                        dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productRow.ProductId.Value, projectId, customerId, employeeId, accountType, vatType, true, false, null, productRow.Product as InvoiceProduct);
                    }
                    else
                        dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productRow.ProductId.Value, projectId, customerId, employeeId, ProductAccountType.Purchase, vatType, true, false, null, productRow.Product as InvoiceProduct);

                }
            }
            else
            {
                dto = accountingPrioDTO;
            }

            if (dto != null && dto.AccountId.HasValue)
            {
                var priceListTypeInclusiveVat = productRow.CustomerInvoice != null && productRow.CustomerInvoice.PriceListTypeInclusiveVat;

                #region Sales row

                // Create account row
                var salesAccountRow = new CustomerInvoiceAccountRow
                {
                    RowNr = nextRowNr,
                    AccountId = dto.AccountId.Value,
                    Amount = priceListTypeInclusiveVat ? -(productRow.SumAmount - productRow.VatAmount) : -productRow.SumAmount,
                    AmountCurrency = priceListTypeInclusiveVat ? -(productRow.SumAmountCurrency - productRow.VatAmountCurrency) : -productRow.SumAmountCurrency,
                    CreditRow = isCredit,
                    DebitRow = !isCredit,
                };

                if (addQuantityOnAccountingRow)
                    salesAccountRow.Quantity = productRow.Quantity;

                bool usePrioForInternal = true;
                if (invoiceDim2AccountId.HasValue && invoiceDim2AccountId != 0)
                {
                    AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoiceDim2AccountId.Value, actorCompanyId);
                    if (accInt != null)
                        salesAccountRow.AccountInternal.Add(accInt);
                    usePrioForInternal = false;
                }
                if (invoiceDim3AccountId.HasValue && invoiceDim3AccountId != 0)
                {
                    AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoiceDim3AccountId.Value, actorCompanyId);
                    if (accInt != null)
                        salesAccountRow.AccountInternal.Add(accInt);
                    usePrioForInternal = false;
                }
                if (invoiceDim4AccountId.HasValue && invoiceDim4AccountId != 0)
                {
                    AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoiceDim4AccountId.Value, actorCompanyId);
                    if (accInt != null)
                        salesAccountRow.AccountInternal.Add(accInt);
                    usePrioForInternal = false;
                }
                if (invoiceDim5AccountId.HasValue && invoiceDim5AccountId != 0)
                {
                    AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoiceDim5AccountId.Value, actorCompanyId);
                    if (accInt != null)
                        salesAccountRow.AccountInternal.Add(accInt);
                    usePrioForInternal = false;
                }
                if (invoiceDim6AccountId.HasValue && invoiceDim6AccountId != 0)
                {
                    AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoiceDim6AccountId.Value, actorCompanyId);
                    if (accInt != null)
                        salesAccountRow.AccountInternal.Add(accInt);
                    usePrioForInternal = false;
                }

                if (usePrioForInternal)
                {
                    // Add internal accounts from prio
                    if (dto.AccountInternals != null && dto.AccountInternals.Count > 0)
                    {
                        if (salesAccountRow.AccountInternal == null)
                            salesAccountRow.AccountInternal = new EntityCollection<AccountInternal>();

                        foreach (AccountInternalDTO accountInternal in dto.AccountInternals)
                        {
                            AccountInternal accInt = AccountManager.GetAccountInternal(entities, accountInternal.AccountId, actorCompanyId);
                            if (accInt != null)
                                salesAccountRow.AccountInternal.Add(accInt);
                        }
                    }
                }

                // Connect account row to product row
                productRow.CustomerInvoiceAccountRow.Add(salesAccountRow);
                nextRowNr++;
                // Add customer discount rows if needed
                if (discountAccountId != 0)
                {
                    var discountAccount = AccountManager.GetAccount(entities, actorCompanyId, discountAccountId, loadAccount: true, loadAccountMapping: true);
                    if (discountAccount != null)
                    {
                        var discountRow = new CustomerInvoiceAccountRow
                        {
                            RowNr = nextRowNr,
                            AccountId = discountAccountId,
                            //Amount = isCredit ? productRow.DiscountAmount : -productRow.DiscountAmount,
                            //AmountCurrency = isCredit ? productRow.DiscountAmountCurrency : -productRow.DiscountAmountCurrency,
                            CreditRow = !isCredit,
                            DebitRow = isCredit,
                        };

                        if (discountRow.CreditRow)
                        {
                            discountRow.Amount = (productRow.DiscountAmount > 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                            discountRow.AmountCurrency = (productRow.DiscountAmountCurrency > 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                        }
                        else
                        {
                            discountRow.Amount = (productRow.DiscountAmount < 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                            discountRow.AmountCurrency = (productRow.DiscountAmountCurrency < 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                        }

                        if (!discountAccount.AccountMapping.IsNullOrEmpty())
                        {
                            foreach (var map in discountAccount.AccountMapping)
                            {
                                if (!map.AccountInternalReference.IsLoaded)
                                    map.AccountInternalReference.Load();
                                if (map.AccountInternal != null)
                                    discountRow.AccountInternal.Add(map.AccountInternal);
                            }
                        }

                        productRow.CustomerInvoiceAccountRow.Add(discountRow);
                        nextRowNr++;
                    }

                    var discountOffsetAccount = AccountManager.GetAccount(entities, actorCompanyId, discountOffsetAccountId, loadAccount: true, loadAccountMapping: true);
                    if (discountOffsetAccount != null)
                    {
                        // Add offset row
                        var discountOffsetRow = new CustomerInvoiceAccountRow
                        {
                            RowNr = nextRowNr,
                            AccountId = discountOffsetAccountId,
                            //Amount = isCredit ? -productRow.DiscountAmount : productRow.DiscountAmount,
                            //AmountCurrency = isCredit ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency,
                            CreditRow = isCredit,
                            DebitRow = !isCredit,
                        };

                        if (discountOffsetRow.CreditRow)
                        {
                            discountOffsetRow.Amount = (productRow.DiscountAmount > 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                            discountOffsetRow.AmountCurrency = (productRow.DiscountAmountCurrency > 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                        }
                        else
                        {
                            discountOffsetRow.Amount = (productRow.DiscountAmount < 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                            discountOffsetRow.AmountCurrency = (productRow.DiscountAmountCurrency < 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                        }

                        if (discountOffsetAccount.AccountMapping != null && discountOffsetAccount.AccountMapping.Any())
                        {
                            foreach (var map in discountOffsetAccount.AccountMapping)
                            {
                                if (!map.AccountInternalReference.IsLoaded)
                                    map.AccountInternalReference.Load();
                                if (map.AccountInternal != null)
                                    discountOffsetRow.AccountInternal.Add(map.AccountInternal);
                            }
                        }

                        productRow.CustomerInvoiceAccountRow.Add(discountOffsetRow);
                        nextRowNr++;
                    }
                    else
                    {
                        // Reset value on sales row
                        salesAccountRow.Amount -= productRow.DiscountAmount;
                        salesAccountRow.AmountCurrency -= productRow.DiscountAmountCurrency;
                    }
                }


                #endregion

                #region VAT row

                // Add VAT row
                if (productRow.VatAccountId.HasValue && productRow.VatAmount != 0 && vatType != TermGroup_InvoiceVatType.Contractor && vatType != TermGroup_InvoiceVatType.NoVat)
                {
                    // Create account row
                    CustomerInvoiceAccountRow vatAccountRow = new CustomerInvoiceAccountRow()
                    {
                        RowNr = nextRowNr,
                        Amount = -productRow.VatAmount,
                        AmountCurrency = -productRow.VatAmountCurrency,
                        VatRow = true,
                        CreditRow = productRow.VatAmountCurrency < 0 ? false : true,
                        DebitRow = productRow.VatAmountCurrency < 0 ? true : false,

                        //Set FK
                        AccountId = productRow.VatAccountId.Value,
                    };

                    // Connect account row to product row
                    productRow.CustomerInvoiceAccountRow.Add(vatAccountRow);
                    nextRowNr++;
                }

                #endregion
            }
        }

        public void CreateCustomerInvoiceAccountRow(CompEntities entities, CustomerInvoice invoice, CustomerInvoiceRow productRow, TermGroup_InvoiceVatType vatType, ref int nextRowNr, int customerId, int employeeId, int projectId, int actorCompanyId, List<object> splitAccountingRows = null, bool useExistingAsTemplate = false, List<AccountInternal> internals = null, bool addQuantityOnAccountingRow = false)
        {
            if (productRow == null)
                return;

            #region Prereq

            // Check for discount accounts
            var discountAccountId = productRow.DiscountAmountCurrency != 0 ? SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCustomerDiscount, 0, actorCompanyId, 0) : 0;
            var discountOffsetAccountId = productRow.DiscountAmountCurrency != 0 ? SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountCustomerDiscountOffset, 0, actorCompanyId, 0) : 0;

            #endregion

            #region Sales row

            if (useExistingAsTemplate) // Used when there is existing split accounting
            {
                foreach (var accountingRow in productRow.ActiveCustomerInvoiceAccountRows)
                {
                    var amount = invoice.PriceListTypeInclusiveVat ? (productRow.SumAmount - productRow.VatAmount) * (accountingRow.SplitPercent / 100) : productRow.SumAmount * (accountingRow.SplitPercent / 100);
                    var amountCurrency = invoice.PriceListTypeInclusiveVat ? (productRow.SumAmountCurrency - productRow.VatAmountCurrency) * (accountingRow.SplitPercent / 100) : productRow.SumAmountCurrency * (accountingRow.SplitPercent / 100);

                    accountingRow.Amount = accountingRow.CreditRow ? -amount : amount;
                    accountingRow.AmountCurrency = accountingRow.CreditRow ? -amountCurrency : amountCurrency;
                }
            }
            else if (splitAccountingRows == null || splitAccountingRows.Count == 0)
            {
                // Add sales row
                if (productRow.ProductId.HasValue)
                {
                    AccountingPrioDTO dto;
                    if (productRow.HouseholdTaxDeductionRow == null)
                    {
                        ProductAccountType accountType = ProductAccountType.Sales;
                        switch (vatType)
                        {
                            case TermGroup_InvoiceVatType.Contractor:
                                accountType = ProductAccountType.SalesContractor;
                                break;
                            case TermGroup_InvoiceVatType.NoVat:
                                accountType = ProductAccountType.SalesNoVat;
                                break;
                            case TermGroup_InvoiceVatType.ExportWithinEU:
                                accountType = invoice.TriangulationSales ? ProductAccountType.TripartiteTrade : ProductAccountType.ExportWithinEU;
                                break;
                            case TermGroup_InvoiceVatType.ExportOutsideEU:
                                accountType = invoice.TriangulationSales ? ProductAccountType.TripartiteTrade : ProductAccountType.ExportOutsideEU;
                                break;
                            default:
                                break;
                        }

                        dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productRow.ProductId.Value, projectId, customerId, employeeId, accountType, vatType, true);
                    }
                    else
                        dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productRow.ProductId.Value, projectId, customerId, employeeId, ProductAccountType.Purchase, vatType, true);

                    if (dto != null && dto.AccountId.HasValue)
                    {
                        // Create account row
                        var isCredit = (productRow.SumAmount >= 0);
                        var salesAccountRow = new CustomerInvoiceAccountRow
                        {
                            RowNr = nextRowNr,
                            AccountId = dto.AccountId.Value,
                            Amount = invoice.PriceListTypeInclusiveVat ? -(productRow.SumAmount - productRow.VatAmount) : -productRow.SumAmount,
                            AmountCurrency = invoice.PriceListTypeInclusiveVat ? -(productRow.SumAmountCurrency - productRow.VatAmountCurrency) : -productRow.SumAmountCurrency,
                            CreditRow = isCredit,
                            DebitRow = !isCredit,
                            //AccountDistributionHeadId 
                        };

                        if (addQuantityOnAccountingRow)
                            salesAccountRow.Quantity = productRow.Quantity;

                        if (productRow.HouseholdTaxDeductionRow == null && ((invoice.DefaultDim2AccountId.HasValue && invoice.DefaultDim2AccountId.Value != 0) ||
                            (invoice.DefaultDim3AccountId.HasValue && invoice.DefaultDim3AccountId.Value != 0) ||
                            (invoice.DefaultDim4AccountId.HasValue && invoice.DefaultDim4AccountId.Value != 0) ||
                            (invoice.DefaultDim5AccountId.HasValue && invoice.DefaultDim5AccountId.Value != 0) ||
                            (invoice.DefaultDim6AccountId.HasValue && invoice.DefaultDim6AccountId.Value != 0)))
                        {
                            if (invoice.DefaultDim2AccountId.HasValue)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoice.DefaultDim2AccountId.Value, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (invoice.DefaultDim3AccountId.HasValue)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoice.DefaultDim3AccountId.Value, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (invoice.DefaultDim4AccountId.HasValue)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoice.DefaultDim4AccountId.Value, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (invoice.DefaultDim5AccountId.HasValue)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoice.DefaultDim5AccountId.Value, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (invoice.DefaultDim6AccountId.HasValue)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, invoice.DefaultDim6AccountId.Value, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }
                        }
                        else if (!internals.IsNullOrEmpty())
                        {
                            if (salesAccountRow.AccountInternal == null)
                                salesAccountRow.AccountInternal = new EntityCollection<AccountInternal>();

                            salesAccountRow.AccountInternal.AddRange(internals);
                        }
                        else
                        {
                            // Add internal accounts
                            if (!dto.AccountInternals.IsNullOrEmpty())
                            {
                                if (salesAccountRow.AccountInternal == null)
                                    salesAccountRow.AccountInternal = new EntityCollection<AccountInternal>();

                                foreach (AccountInternalDTO accountInternal in dto.AccountInternals)
                                {
                                    AccountInternal accInt = AccountManager.GetAccountInternal(entities, accountInternal.AccountId, actorCompanyId);
                                    if (accInt != null)
                                        salesAccountRow.AccountInternal.Add(accInt);
                                }
                            }
                        }

                        // Connect account row to product row
                        productRow.CustomerInvoiceAccountRow.Add(salesAccountRow);
                        nextRowNr++;

                        // Add customer discount rows if needed
                        if (discountAccountId != 0)
                        {
                            var discountAccount = AccountManager.GetAccount(entities, actorCompanyId, discountAccountId, loadAccount: true, loadAccountMapping: true);
                            if (discountAccount != null)
                            {
                                var discountRow = new CustomerInvoiceAccountRow
                                {
                                    RowNr = nextRowNr,
                                    AccountId = discountAccountId,
                                    CreditRow = !salesAccountRow.CreditRow,
                                    DebitRow = !salesAccountRow.DebitRow,
                                };

                                if (discountRow.CreditRow)
                                {
                                    discountRow.Amount = (productRow.DiscountAmount > 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                                    discountRow.AmountCurrency = (productRow.DiscountAmountCurrency > 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                                }
                                else
                                {
                                    discountRow.Amount = (productRow.DiscountAmount < 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                                    discountRow.AmountCurrency = (productRow.DiscountAmountCurrency < 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                                }

                                if (discountAccount.AccountMapping != null && discountAccount.AccountMapping.Any())
                                {
                                    foreach (var map in discountAccount.AccountMapping)
                                    {
                                        if (!map.AccountInternalReference.IsLoaded)
                                            map.AccountInternalReference.Load();
                                        if (map.AccountInternal != null)
                                            discountRow.AccountInternal.Add(map.AccountInternal);
                                    }
                                }

                                productRow.CustomerInvoiceAccountRow.Add(discountRow);
                                nextRowNr++;
                            }

                            var discountOffsetAccount = AccountManager.GetAccount(entities, actorCompanyId, discountOffsetAccountId, loadAccount: true, loadAccountMapping: true);
                            if (discountOffsetAccount != null)
                            {
                                // Add offset row
                                var discountOffsetRow = new CustomerInvoiceAccountRow
                                {
                                    RowNr = nextRowNr,
                                    AccountId = discountOffsetAccountId,
                                    CreditRow = salesAccountRow.CreditRow,
                                    DebitRow = salesAccountRow.DebitRow,
                                };

                                if (discountOffsetRow.CreditRow)
                                {
                                    discountOffsetRow.Amount = (productRow.DiscountAmount > 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                                    discountOffsetRow.AmountCurrency = (productRow.DiscountAmountCurrency > 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                                }
                                else
                                {
                                    discountOffsetRow.Amount = (productRow.DiscountAmount < 0 ? -productRow.DiscountAmount : productRow.DiscountAmount) + productRow.Discount2Amount;
                                    discountOffsetRow.AmountCurrency = (productRow.DiscountAmountCurrency < 0 ? -productRow.DiscountAmountCurrency : productRow.DiscountAmountCurrency) + productRow.Discount2AmountCurrency;
                                }

                                if (discountOffsetAccount.AccountMapping != null && discountOffsetAccount.AccountMapping.Any())
                                {
                                    foreach (var map in discountOffsetAccount.AccountMapping)
                                    {
                                        if (!map.AccountInternalReference.IsLoaded)
                                            map.AccountInternalReference.Load();
                                        if (map.AccountInternal != null)
                                            discountOffsetRow.AccountInternal.Add(map.AccountInternal);
                                    }
                                }

                                productRow.CustomerInvoiceAccountRow.Add(discountOffsetRow);
                                nextRowNr++;
                            }
                            else
                            {
                                // Reset value on sales row
                                salesAccountRow.Amount -= (productRow.DiscountAmount + productRow.Discount2Amount);
                                salesAccountRow.AmountCurrency -= (productRow.DiscountAmountCurrency + productRow.Discount2AmountCurrency);
                            }
                        }
                    }
                }
            }
            else
            {
                if (splitAccountingRows[0].GetType() == typeof(SplitAccountingRowDTO)) //New produktrow
                {
                    //Add split accounting rows
                    foreach (SplitAccountingRowDTO obj in splitAccountingRows)
                    {
                        if (obj.Dim1Id > 0)
                        {
                            // Create account row
                            var salesAccountRow = new CustomerInvoiceAccountRow
                            {
                                RowNr = nextRowNr,
                                AccountId = obj.Dim1Id,
                                CreditRow = obj.IsCreditRow,
                                DebitRow = obj.IsDebitRow,
                                SplitType = obj.SplitType,
                                SplitPercent = obj.SplitPercent,
                            };

                            var amount = obj.AmountCurrency;
                            if (invoice.CurrencyRate != 1)
                            {
                                amount = decimal.Round(CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(amount, invoice.CurrencyRate), 2);
                            }

                            if (salesAccountRow.CreditRow)
                            {
                                salesAccountRow.Amount = amount > 0 ? -amount : amount;
                                salesAccountRow.AmountCurrency = obj.CreditAmountCurrency > 0 ? -obj.AmountCurrency : obj.AmountCurrency;
                            }
                            else
                            {
                                salesAccountRow.Amount = amount < 0 ? -amount : amount;
                                salesAccountRow.AmountCurrency = obj.CreditAmountCurrency < 0 ? -obj.AmountCurrency : obj.AmountCurrency;
                            }

                            if (obj.Dim2Id > 0)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, obj.Dim2Id, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (obj.Dim3Id > 0)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, obj.Dim3Id, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (obj.Dim4Id > 0)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, obj.Dim4Id, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (obj.Dim5Id > 0)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, obj.Dim5Id, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (obj.Dim6Id > 0)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, obj.Dim6Id, actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            // Connect account row to product row
                            productRow.CustomerInvoiceAccountRow.Add(salesAccountRow);
                            nextRowNr++;
                        }
                    }
                }
                else
                { //Update
                  //Add split accounting rows
                    foreach (ExpandoObject obj in splitAccountingRows)
                    {
                        var values = (IDictionary<string, object>)obj;

                        if (values.TryGetValue("dim1Id", out var dim1Id))
                        {
                            var accountId = Convert.ToInt32(dim1Id);

                            // Create account row
                            var salesAccountRow = new CustomerInvoiceAccountRow
                            {
                                RowNr = nextRowNr,
                                AccountId = accountId,
                                SplitType = Convert.ToInt32(values["splitType"]),
                                SplitPercent = Convert.ToInt32(values["splitPercent"]),
                                CreditRow = Convert.ToBoolean(values["isCreditRow"]),
                                DebitRow = Convert.ToBoolean(values["isDebitRow"]),
                            };

                            var amount = Convert.ToDecimal(values["amountCurrency"]);
                            var amountCurrency = Convert.ToDecimal(values["creditAmountCurrency"]);

                            if (invoice.CurrencyRate != 1)
                            {
                                amount = decimal.Round(CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(amount, invoice.CurrencyRate), 2);
                            }

                            if (salesAccountRow.CreditRow)
                            {
                                salesAccountRow.Amount = amount > 0 ? -amount : amount;
                                salesAccountRow.AmountCurrency = amountCurrency > 0 ? -amountCurrency : amountCurrency;
                            }
                            else
                            {
                                salesAccountRow.Amount = amount < 0 ? -amount : amount;
                                salesAccountRow.AmountCurrency = amountCurrency < 0 ? -amountCurrency : amountCurrency;
                            }

                            if (values.Keys.Contains("dim2Id") && values["dim2Id"] != null)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, Convert.ToInt32(values["dim2Id"]), actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (values.Keys.Contains("dim3Id") && values["dim3Id"] != null)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, Convert.ToInt32(values["dim3Id"]), actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (values.Keys.Contains("dim4Id") && values["dim4Id"] != null)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, Convert.ToInt32(values["dim4Id"]), actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (values.Keys.Contains("dim5Id") && values["dim5Id"] != null)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, Convert.ToInt32(values["dim5Id"]), actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            if (values.Keys.Contains("dim6Id") && values["dim6Id"] != null)
                            {
                                AccountInternal accInt = AccountManager.GetAccountInternal(entities, Convert.ToInt32(values["dim6Id"]), actorCompanyId);
                                if (accInt != null)
                                    salesAccountRow.AccountInternal.Add(accInt);
                            }

                            // Connect account row to product row
                            productRow.CustomerInvoiceAccountRow.Add(salesAccountRow);
                            nextRowNr++;
                        }
                    }
                }
            }

            #endregion

            #region VAT row

            // Add VAT row
            if (productRow.VatAccountId.HasValue && productRow.VatAmount != 0 && vatType != TermGroup_InvoiceVatType.Contractor && vatType != TermGroup_InvoiceVatType.NoVat)
            {
                // Create account row
                CustomerInvoiceAccountRow vatAccountRow = new CustomerInvoiceAccountRow()
                {
                    RowNr = nextRowNr,
                    Amount = -productRow.VatAmount,
                    AmountCurrency = -productRow.VatAmountCurrency,
                    VatRow = true,
                    CreditRow = productRow.VatAmountCurrency < 0 ? false : true,
                    DebitRow = productRow.VatAmountCurrency < 0 ? true : false,

                    //Set FK
                    AccountId = productRow.VatAccountId.Value,
                };

                // Connect account row to product row
                productRow.CustomerInvoiceAccountRow.Add(vatAccountRow);
                nextRowNr++;
            }

            #endregion
        }

        public List<CustomerInvoiceRow> GetParentCustomerInvoiceRows(CompEntities entities, int invoiceRowId, int actorCompanyId)
        {
            return (from cr in entities.CustomerInvoiceRow
                        .Include("CustomerInvoice")
                        .Include("CustomerInvoice.Origin")
                    where cr.TargetRowId == invoiceRowId &&
                    cr.CustomerInvoice.Origin.ActorCompanyId == actorCompanyId &&
                    cr.State == (int)SoeEntityState.Active
                    select cr).ToList();
        }

        #endregion

        #region CustomerInvoiceInterest / CustomerInvoiceReminder

        private ActionResult CreateCustomerInvoiceRowsForInterestAndReminder(CompEntities entities, CustomerInvoice customerInvoice, CustomerInvoiceReminder reminder, CustomerInvoiceInterest interest, InvoiceProduct invoiceProduct, AccountStd accountStdSales, AccountStd accountStdPurchase, AccountStd accountStdVat, decimal amount, int actorCompanyId)
        {
            if (customerInvoice == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoice");

            var result = new ActionResult(true);

            CustomerInvoiceRow latestRow = customerInvoice.CustomerInvoiceRow != null ? customerInvoice.CustomerInvoiceRow.OrderByDescending(i => i.RowNr).FirstOrDefault() : null;
            int invoiceRowNr = latestRow != null ? latestRow.RowNr : 0;
            int invoiceAccountRowNr = 0;

            bool isReminderRow = reminder != null;
            bool isInterestRow = !isReminderRow;

            #region TextRow

            if (isInterestRow)
            {
                invoiceRowNr++;
                CustomerInvoiceRow customerInvoiceRowText = new CustomerInvoiceRow()
                {
                    RowNr = invoiceRowNr,
                    Type = (int)SoeInvoiceRowType.TextRow,
                    Text = String.Format(GetText(83, "Faktura {0}, betalning inkom {1}, {2} dagar efter förfallodatum {3}"), interest.InvoiceNr, interest.PayDate.ToShortDateString(), (interest.PayDate - interest.DueDate).Days, interest.DueDate.ToShortDateString()),
                };
                customerInvoice.CustomerInvoiceRow.Add(customerInvoiceRowText);
            }

            #endregion

            #region CustomerInvoiceRow Sales

            //Calculate amounts
            decimal salesQuantity = 1;
            decimal salesAmount = Decimal.Round(amount, 2);
            decimal salesAmountCurrency = Decimal.Round(salesAmount * customerInvoice.CurrencyRate, 2);
            decimal salesSumAmount = Decimal.Round(salesAmount * salesQuantity, 2);
            decimal salesSumAmountCurrency = Decimal.Round(salesSumAmount * customerInvoice.CurrencyRate, 2);

            invoiceRowNr++;
            CustomerInvoiceRow customerInvoiceRowSales = new CustomerInvoiceRow()
            {
                CustomerInvoiceRowId = 0,
                RowNr = invoiceRowNr,
                Type = (int)SoeInvoiceRowType.ProductRow,
                Quantity = salesQuantity,
                Amount = salesAmount,
                AmountCurrency = salesAmountCurrency,
                SumAmount = salesSumAmount,
                SumAmountCurrency = salesSumAmountCurrency,
                VatRate = 0,
                VatAmount = 0,
                DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                DiscountPercent = Decimal.Zero,
                DiscountAmount = Decimal.Zero,
                Text = invoiceProduct.Name,
                IsReminderRow = isReminderRow,
                IsInterestRow = isInterestRow,
                State = 0,

                //Set references
                Product = invoiceProduct,
                ProductUnit = invoiceProduct.ProductUnit,
                VatAccountStd = accountStdVat,
                CustomerInvoiceInterest = interest,
                CustomerInvoiceReminder = reminder,
            };

            #region CustomerInvoiceAccountRow Sales

            invoiceAccountRowNr++;
            CustomerInvoiceAccountRow customerInvoiceAccountRowSales = new CustomerInvoiceAccountRow()
            {
                AccountStd = accountStdSales,
                CustomerInvoiceAccountRowId = 0,
                RowNr = invoiceAccountRowNr,
                SplitType = 0,
                SplitPercent = 0,
                Amount = Decimal.Negate(salesAmount),
                AmountCurrency = Decimal.Negate(salesAmountCurrency),
                Quantity = null,
                Text = "",
                VatRow = false,
                ContractorVatRow = false,
                CreditRow = true,
                DebitRow = false,
                State = 0,
            };
            customerInvoiceRowSales.CustomerInvoiceAccountRow.Add(customerInvoiceAccountRowSales);

            #endregion

            #region CustomerInvoiceAccountRow Vat

            if (accountStdVat != null)
            {
                //Calculate VAT
                decimal vatRate = 0;
                var accountVatRate = AccountManager.GetAccountVatRate(entities, accountStdVat.AccountId, actorCompanyId);
                if (accountVatRate != null)
                    vatRate = accountVatRate.VatRate.HasValue ? accountVatRate.VatRate.Value : 0;
                decimal vatAmount = customerInvoiceRowSales.SumAmount * (vatRate / 100);

                //Set VAT on CustomerInvoiceRow
                customerInvoiceRowSales.VatRate = vatRate;
                customerInvoiceRowSales.VatAmount = vatAmount;

                invoiceAccountRowNr++;
                CustomerInvoiceAccountRow customerInvoiceAccountRowVat = new CustomerInvoiceAccountRow()
                {
                    AccountStd = accountStdVat,
                    CustomerInvoiceAccountRowId = 0,
                    RowNr = invoiceAccountRowNr,
                    SplitType = 0,
                    SplitPercent = 0,
                    Amount = Decimal.Negate(vatAmount),
                    Quantity = null,
                    Text = "",
                    VatRow = true,
                    ContractorVatRow = false,
                    CreditRow = true,
                    DebitRow = false,
                    State = 0,
                };
                customerInvoiceRowSales.CustomerInvoiceAccountRow.Add(customerInvoiceAccountRowVat);
            }

            #endregion

            customerInvoice.CustomerInvoiceRow.Add(customerInvoiceRowSales);

            #endregion

            #region CustomerInvoiceRow Purchase

            var purchaseRow = customerInvoice.CustomerInvoiceRow.FirstOrDefault(r => r.Type == (int)SoeInvoiceRowType.AccountingRow);
            if (purchaseRow != null)
            {
                purchaseRow.Amount += Decimal.Round(customerInvoiceRowSales.Amount + customerInvoiceRowSales.VatAmount, 2);
                purchaseRow.SumAmount += Decimal.Round(customerInvoiceRowSales.Amount + customerInvoiceRowSales.VatAmount, 2);
                purchaseRow.SumAmountCurrency += Decimal.Round(purchaseRow.SumAmount * customerInvoice.CurrencyRate, 2);

                var purchaseAccountRow = purchaseRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.State == (int)SoeEntityState.Active);
                if (purchaseAccountRow != null)
                {
                    purchaseAccountRow.Amount += customerInvoiceRowSales.Amount + customerInvoiceRowSales.VatAmount;
                }
                else
                {
                    invoiceAccountRowNr++;
                    CustomerInvoiceAccountRow customerInvoiceAccountRowPurchase = new CustomerInvoiceAccountRow()
                    {
                        AccountStd = accountStdPurchase,
                        CustomerInvoiceAccountRowId = 0,
                        RowNr = invoiceAccountRowNr,
                        SplitType = 0,
                        SplitPercent = 0,
                        Amount = purchaseRow.SumAmount,
                        AmountCurrency = purchaseRow.SumAmountCurrency,
                        Quantity = null,
                        Text = "",
                        VatRow = false,
                        ContractorVatRow = false,
                        CreditRow = false,
                        DebitRow = true,
                        State = 0,
                    };
                    purchaseRow.CustomerInvoiceAccountRow.Add(customerInvoiceAccountRowPurchase);
                }

                customerInvoice.TotalAmount += purchaseRow.SumAmount;
                customerInvoice.TotalAmountCurrency += purchaseRow.SumAmountCurrency;
                customerInvoice.VATAmount += customerInvoiceRowSales.VatAmount;
            }
            else
            {
                //Calculate amounts
                decimal purchaseQuantity = 1;
                decimal purchaseSumAmount = customerInvoiceRowSales.Amount + customerInvoiceRowSales.VatAmount;
                decimal purchaseSumAmountCurrency = purchaseSumAmount * customerInvoice.CurrencyRate;

                invoiceRowNr++;
                CustomerInvoiceRow customerInvoiceRowPurchase = new CustomerInvoiceRow()
                {
                    VatAccountStd = null,
                    CustomerInvoiceRowId = 0,
                    RowNr = invoiceRowNr,
                    Type = (int)SoeInvoiceRowType.AccountingRow,
                    Quantity = purchaseQuantity,
                    Amount = purchaseSumAmount,
                    SumAmount = purchaseSumAmount,
                    SumAmountCurrency = purchaseSumAmountCurrency,
                    VatRate = 0,
                    VatAmount = 0,
                    DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                    DiscountPercent = 0,
                    DiscountAmount = 0,
                    Text = invoiceProduct.Name,
                    State = 0,
                };

                #region CustomerInvoiceAccountRow Purchase

                invoiceAccountRowNr++;
                CustomerInvoiceAccountRow customerInvoiceAccountRowPurchase = new CustomerInvoiceAccountRow()
                {
                    AccountStd = accountStdPurchase,
                    CustomerInvoiceAccountRowId = 0,
                    RowNr = invoiceAccountRowNr,
                    SplitType = 0,
                    SplitPercent = 0,
                    Amount = purchaseSumAmount,
                    AmountCurrency = purchaseSumAmountCurrency,
                    Quantity = null,
                    Text = "",
                    VatRow = false,
                    ContractorVatRow = false,
                    CreditRow = false,
                    DebitRow = true,
                    State = 0,
                };
                customerInvoiceRowPurchase.CustomerInvoiceAccountRow.Add(customerInvoiceAccountRowPurchase);

                #endregion

                customerInvoice.CustomerInvoiceRow.Add(customerInvoiceRowPurchase);

                customerInvoice.TotalAmount += customerInvoiceRowPurchase.SumAmount;
                customerInvoice.TotalAmountCurrency += customerInvoiceRowPurchase.SumAmountCurrency;
                customerInvoice.VATAmount += customerInvoiceRowSales.VatAmount;
            }

            #endregion

            return result;
        }

        #region CustomerInvoiceInterest

        public List<CustomerInvoiceInterest> GetPendingCustomerInvoiceInterests(int customerId, bool loadCustomer, bool loadProduct)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetPendingCustomerInvoiceInterests(entities, customerId, loadCustomer, loadProduct);
        }

        public List<CustomerInvoiceInterest> GetPendingCustomerInvoiceInterests(CompEntities entities, int customerId, bool loadCustomer, bool loadProduct)
        {
            List<CustomerInvoiceInterest> unhandledInterests = new List<CustomerInvoiceInterest>();

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.CustomerInvoiceInterest.NoTracking();
            List<CustomerInvoiceInterest> interests = (from cii in entities.CustomerInvoiceInterest
                                                        .Include("CustomerInvoiceOrigin")
                                                       where cii.CustomerInvoiceOrigin.ActorId == customerId &&
                                                       cii.CustomerInvoiceOrigin.State == (int)SoeEntityState.Active
                                                       select cii).ToList();

            foreach (CustomerInvoiceInterest interest in interests)
            {
                //Check type after query to make sure index is used most efficient
                if (interest.Type != (int)SoeInvoiceInterestHandlingType.AddToNextInvoice)
                    continue;
                if (IsCustomerInvoiceInterestHandled(entities, interest))
                    continue;

                if (loadCustomer)
                {
                    if (interest.CustomerInvoiceOrigin != null)
                    {
                        if (!interest.CustomerInvoiceOrigin.ActorReference.IsLoaded)
                            interest.CustomerInvoiceOrigin.ActorReference.Load();
                        if (!interest.CustomerInvoiceOrigin.Actor.CustomerReference.IsLoaded)
                            interest.CustomerInvoiceOrigin.Actor.CustomerReference.Load();
                    }
                }

                if (loadProduct)
                {
                    if (!interest.InvoiceProductReference.IsLoaded)
                        interest.InvoiceProductReference.Load();
                }

                unhandledInterests.Add(interest);
            }

            return unhandledInterests;
        }

        public List<CustomerInvoice> GetOriginInvoicesFromInterest(CompEntities entities, int interestInvoiceId)
        {
            List<CustomerInvoice> customerInvoices = new List<CustomerInvoice>();

            var interests = (from cir in entities.CustomerInvoiceInterestView
                             where cir.NewInvoiceId == interestInvoiceId
                             select cir).ToList();

            foreach (var interest in interests)
            {
                CustomerInvoice customerInvoice = (from ci in entities.Invoice.OfType<CustomerInvoice>()
                                                   where ci.InvoiceId == interest.InvoiceId
                                                   select ci).FirstOrDefault();

                if (customerInvoice != null)
                    customerInvoices.Add(customerInvoice);
            }

            return customerInvoices;
        }

        public decimal CalculateInterestAmount(CompEntities entities, int invoiceId, decimal interestPercent, decimal invoiceTotalAmount, DateTime? dueDate, bool calcInterestOnRemainAmount)
        {
            if (!dueDate.HasValue || interestPercent == Decimal.Zero)
                return 0;

            decimal interestAmount = 0;
            decimal paymentTotalAmount = 0;

            var activePayments = PaymentManager.GetPaymentRowsByInvoice(entities, invoiceId).Where(x => x.Status != (int)SoePaymentStatus.Cancel);
            foreach (var payment in activePayments)
            {
                //Dont calculate interest on amount larger than total
                decimal paymentAmount = payment.Amount;
                decimal remainingAmount = invoiceTotalAmount - paymentTotalAmount;
                if (paymentAmount > remainingAmount)
                    paymentAmount = remainingAmount;

                //Accumulate total
                paymentTotalAmount += paymentAmount;

                //Calculate interest for payment
                int days = payment.PayDate.Subtract(dueDate.Value).Days;
                if (days > 0)
                    interestAmount += paymentAmount * Decimal.Divide(interestPercent, 100) * Decimal.Divide(days, 365);
            }

            //Validate that total amount is payed, otherwise interest is not allowed
            if (paymentTotalAmount < invoiceTotalAmount)
                interestAmount = 0;

            if (paymentTotalAmount == 0 || (calcInterestOnRemainAmount && paymentTotalAmount < invoiceTotalAmount))
            {
                int days = DateTime.Now.Subtract(dueDate.Value).Days;
                if (days > 0)
                    interestAmount += (invoiceTotalAmount - paymentTotalAmount) * Decimal.Divide(interestPercent, 100) * Decimal.Divide(days, 365);
            }
            return interestAmount;
        }

        public bool HasCustomerInvoiceInterest(CompEntities entities, int invoiceId)
        {
            return (from cir in entities.CustomerInvoiceInterestView
                    where cir.InvoiceId == invoiceId
                    select cir).Count() > 0;
        }

        public bool HasCustomerInvoiceInterest(List<CustomerInvoiceInterestView> interests, int invoiceId)
        {
            if (interests == null)
                return false;

            return (from cir in interests
                    where cir.InvoiceId == invoiceId
                    select cir).Any();
        }

        private bool IsCustomerInvoiceInterestHandled(CompEntities entities, CustomerInvoiceInterest interest)
        {
            if (interest == null)
                return false;

            //Get CustomerInvoiceRows interest
            List<CustomerInvoiceRow> customerInvoiceRows = entities.CustomerInvoiceRow.Where(i => i.CustomerInvoiceInterestId == interest.CustomerInvoiceInterestId).ToList();

            //Only active (filter after query to make sure index is used most efficient)
            customerInvoiceRows = customerInvoiceRows.Where(i => i.State == (int)SoeEntityState.Active).ToList();

            //Check if not added to any CustomerInvoice yet
            if (customerInvoiceRows.Count == 0 && interest.Type == (int)SoeInvoiceInterestHandlingType.AddToNextInvoice)
                return false;

            //Check if interest CustomerInvoiceRow or CustomerInvoice is active
            return IsAnyCustomerInvoiceRowActive(customerInvoiceRows);
        }


        public ActionResult SaveInterestCustomerInvoice(List<CustomerInvoiceGridDTO> items, bool merge, int actorCompanyId, int userId)
        {
            if (items == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ChangeStatusGridView");

            // Default result is successful
            ActionResult result = new ActionResult();

            #region Prereq

            //Settings
            int defaultHandlingType = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestHandlingType, userId, actorCompanyId, 0);
            int defaultInterestAccumulatedBeforeInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestAccumulatedBeforeInvoice, userId, actorCompanyId, 0);
            int defaultPaymentConditionId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerDefaultPaymentConditionClaimAndInterest, 0, actorCompanyId, 0);
            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, actorCompanyId, 0);
            bool useCentRounding = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingUseCentRounding, 0, actorCompanyId, 0);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                List<CustomerInvoiceInterest> interests = new List<CustomerInvoiceInterest>();
                List<CustomerInvoice> customerInvoices = new List<CustomerInvoice>();

                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        User user = UserManager.GetUser(entities, userId);
                        if (user == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductNotFound, "User");

                        //Get product interest
                        InvoiceProduct productInterest = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductInterestInvoicing, actorCompanyId, loadAccounts: true);
                        if (productInterest == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceInterestProductNotFound, "InvoiceProduct");

                        //Get AccountStd sales
                        AccountStd accountStdSales = AccountManager.GetAccountStdFromInvoiceProductOrCompany(entities, productInterest, ProductAccountType.Sales, CompanySettingType.AccountInvoiceProductSales, actorCompanyId);
                        if (accountStdSales == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceInterestProductAccountSalesNotFound);

                        //Get AccountStd purchase (kundfordran)
                        AccountStd accountStdPurchase = AccountManager.GetAccountStdFromInvoiceProductOrCompany(entities, productInterest, ProductAccountType.Purchase, CompanySettingType.AccountInvoiceProductPurchase, actorCompanyId);
                        if (accountStdPurchase == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceInterestProductAccountPurchaseNotFound);

                        //Get AccountStd Vat
                        AccountStd accountStdVat = null;
                        ProductAccountStd productAccountStdVat = productInterest.ProductAccountStd.FirstOrDefault(i => i.Type == (int)ProductAccountType.VAT);
                        if (productAccountStdVat != null)
                        {
                            //Make sure AccountStd is loaded
                            if (!productAccountStdVat.AccountStdReference.IsLoaded)
                                productAccountStdVat.AccountStdReference.Load();

                            accountStdVat = productAccountStdVat.AccountStd;
                        }

                        string batchId = Guid.NewGuid().ToString();

                        #endregion

                        foreach (var item in items)
                        {
                            #region Prereq

                            //IsTotalAmountPayed needed for backward compabillity. 
                            //With current solution: Interests can only be created when the invoice is FullyPayed, and no interest has been created earlier
                            //With previous solution: IsTotalAmountPayed must be handled also
                            if (!item.FullyPaid)
                            {
                                result = new ActionResult((int)ActionResultSave.CustomerInvoiceInterestNotFullyPayed);
                                result.StringValue = item.InvoiceNr;
                                return result;
                            }

                            //Need to load necessary relations to be able to copy the invoice to a new interest invoice
                            CustomerInvoice customerInvoice = GetCustomerInvoice(entities, item.CustomerInvoiceId, true, true, false, false, true, true, true, false, false, false, false, true);
                            if (customerInvoice == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                            //Cannot create interest for credit invoice
                            if (customerInvoice.BillingType == (int)TermGroup_BillingType.Credit)
                                continue;

                            //Must have Customer
                            if (!customerInvoice.ActorId.HasValue)
                                continue;

                            //Interests can only be created if no interest has been created earlier
                            if (HasCustomerInvoiceInterest(entities, item.CustomerInvoiceId))
                            {
                                result = new ActionResult((int)ActionResultSave.CustomerInvoiceInterestAlreadyExists);
                                result.StringValue = item.InvoiceNr;
                                return result;
                            }

                            //Check that totalamount is larger than minimum amount in company setting
                            decimal interestAmount = CalculateInterestAmount(entities, item.CustomerInvoiceId, interestPercent, item.TotalAmount, item.DueDate, false);
                            if (interestAmount < defaultInterestAccumulatedBeforeInvoice)
                            {
                                result = new ActionResult((int)ActionResultSave.CustomerInvoiceInterestBelowAccumulatedBeforeInvoice);
                                result.StringValue = item.InvoiceNr;
                                return result;
                            }

                            int actorId = customerInvoice.ActorId.HasValue ? customerInvoice.ActorId.Value : 0;

                            #endregion

                            #region CustomerInvoiceInterest

                            CustomerInvoiceInterest interest = new CustomerInvoiceInterest()
                            {
                                Type = defaultHandlingType,
                                InvoiceNr = item.InvoiceNr,
                                DueDate = item.DueDate.Value,
                                PayDate = item.PayDate.Value,
                                Amount = interestAmount,
                                BatchId = batchId,

                                //Set references
                                CustomerInvoiceOrigin = customerInvoice,
                                InvoiceProduct = productInterest,
                            };
                            SetCreatedProperties(interest);
                            entities.CustomerInvoiceInterest.AddObject(interest);

                            //Set currency amounts
                            CountryCurrencyManager.SetCurrencyAmounts(entities, actorCompanyId, interest, customerInvoice.CurrencyRate, actorId);

                            interests.Add(interest);

                            #endregion
                        }

                        if (defaultHandlingType == (int)SoeInvoiceInterestHandlingType.CreateNewInvoice)
                        {
                            foreach (var group in interests.GroupBy(o => o.CustomerInvoiceOrigin.ActorId.Value))
                            {
                                #region Common for customer

                                PaymentCondition paymentCondition = defaultPaymentConditionId > 0 ? PaymentManager.GetPaymentCondition(entities, defaultPaymentConditionId, actorCompanyId) : null;

                                //DeliveryType
                                List<DeliveryType> deliveryTypes = group.Select(i => i.CustomerInvoiceOrigin.DeliveryType).Distinct().ToList();
                                DeliveryType deliveryType = deliveryTypes.Count == 1 ? deliveryTypes.First() : null;

                                //DeliveryCondition
                                List<DeliveryCondition> deliveryConditions = group.Select(i => i.CustomerInvoiceOrigin.DeliveryCondition).Distinct().ToList();
                                DeliveryCondition deliveryCondition = deliveryConditions.Count == 1 ? deliveryConditions.First() : null;

                                //Currency
                                List<Currency> currencies = group.Select(i => i.CustomerInvoiceOrigin.Currency).Distinct().ToList();
                                Currency currency = currencies.Count == 1 ? currencies.First() : null;

                                //DeliveryAddressId
                                List<int> deliveryAddressIds = group.Select(i => i.CustomerInvoiceOrigin.DeliveryAddressId).Distinct().ToList();
                                int deliveryAddressId = deliveryAddressIds.Count == 1 ? deliveryAddressIds.First() : 0;

                                //BillingAddressId
                                List<int> billingAddressIds = group.Select(i => i.CustomerInvoiceOrigin.BillingAddressId).Distinct().ToList();
                                int billingAddressId = billingAddressIds.Count == 1 ? billingAddressIds.First() : 0;

                                #endregion

                                CustomerInvoice newCustomerInvoice = null;
                                int counter = 0;

                                List<CustomerInvoice> customerInvoiceOrigins = new List<CustomerInvoice>();
                                foreach (CustomerInvoiceInterest interest in group.OrderBy(i => i.DueDate))
                                {
                                    counter++;
                                    customerInvoiceOrigins.Add(interest.CustomerInvoiceOrigin);

                                    #region Create new CustomerInvoice

                                    //Create CustomerInvoice
                                    if (!merge || counter == 1)
                                    {
                                        newCustomerInvoice = CreateCustomerInvoiceForInterest(entities, interest.CustomerInvoiceOrigin, paymentCondition, deliveryType, deliveryCondition, currency, deliveryAddressId, billingAddressId, actorCompanyId);
                                        if (newCustomerInvoice == null)
                                            return new ActionResult((int)ActionResultSave.CustomerInvoiceFailedCopy);

                                        //Set description
                                        newCustomerInvoice.Origin.Description = GetText(5615, "Räntefaktura");
                                        newCustomerInvoice.Origin.Description += ":";

                                        customerInvoices.Add(newCustomerInvoice);
                                    }
                                    else
                                    {
                                        if (newCustomerInvoice == null)
                                            return new ActionResult((int)ActionResultSave.EntityIsNull, "CustomerInvoice");
                                    }

                                    //Set description
                                    if (String.IsNullOrEmpty(interest.CustomerInvoiceOrigin.Origin.Description))
                                        newCustomerInvoice.Origin.Description += String.Format(" {0}.", interest.CustomerInvoiceOrigin.InvoiceNr);
                                    else
                                        newCustomerInvoice.Origin.Description += String.Format(" {0} {1}.", interest.CustomerInvoiceOrigin.InvoiceNr, interest.CustomerInvoiceOrigin.Origin.Description);

                                    //Create CustomerInvoiceRows
                                    result = CreateCustomerInvoiceRowsForInterestAndReminder(entities, newCustomerInvoice, null, interest, interest.InvoiceProduct, accountStdSales, accountStdPurchase, accountStdVat, interest.Amount, actorCompanyId);
                                    if (!result.Success)
                                        return result;

                                    var accountRowNr = newCustomerInvoice.CustomerInvoiceRow.SelectMany(r => r.CustomerInvoiceAccountRow).Max(r => r.RowNr);
                                    UpdateInvoiceAfterRowModification(entities, newCustomerInvoice, accountRowNr, actorCompanyId);

                                    #endregion
                                }
                            }
                        }

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        if (defaultHandlingType == (int)SoeInvoiceInterestHandlingType.CreateNewInvoice)
                        {
                            result.StrDict = GetCustomerInvoicesDict(customerInvoices);
                            result.IntegerValue = customerInvoices.Count;
                            result.IntegerValue2 = defaultHandlingType;
                        }
                        else if (defaultHandlingType == (int)SoeInvoiceInterestHandlingType.AddToNextInvoice)
                        {
                            result.IntegerValue = interests.Count;
                            result.IntegerValue2 = defaultHandlingType;
                        }
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }


        public ActionResult CloseInterestCustomerInvoice(List<CustomerInvoiceGridDTO> items, int userId, int actorCompanyId)
        {
            if (items == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ChangeStatusGridView");

            // Default result is successful
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        User user = UserManager.GetUser(entities, userId);
                        if (user == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductNotFound, "User");

                        //Get Product
                        InvoiceProduct productInterest = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductInterestInvoicing, actorCompanyId);
                        if (productInterest == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceInterestProductNotFound, "InvoiceProduct");

                        #endregion

                        foreach (var item in items)
                        {
                            CustomerInvoice customerInvoice = GetCustomerInvoice(entities, item.CustomerInvoiceId);
                            if (customerInvoice == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                            //IsTotalAmountPayed needed for backward compabillity. 
                            //With current solution you should not be able to create interest invoice before it is FullyPayed
                            //To handled invoices handled with previous version, IsTotalAmountPayed must be handled also
                            if (!customerInvoice.FullyPayed && !customerInvoice.IsTotalAmountPayed)
                            {
                                result = new ActionResult((int)ActionResultSave.CustomerInvoiceInterestNotFullyPayed);
                                result.StringValue = item.InvoiceNr;
                                return result;
                            }

                            //Needed for backwardo compabillity (se reason above)
                            SetInvoiceFullyPayed(entities, customerInvoice);

                            CustomerInvoiceInterest interest = new CustomerInvoiceInterest()
                            {
                                Type = (int)SoeInvoiceInterestHandlingType.NoInterest,
                                InvoiceNr = item.InvoiceNr,
                                DueDate = item.DueDate.HasValue ? item.DueDate.Value : CalendarUtility.DATETIME_DEFAULT,
                                PayDate = item.PayDate.HasValue ? item.PayDate.Value : CalendarUtility.DATETIME_DEFAULT,
                                Amount = 0,

                                //Set references
                                CustomerInvoiceOrigin = customerInvoice,
                                InvoiceProduct = productInterest,
                            };
                            SetCreatedProperties(interest);
                            entities.CustomerInvoiceInterest.AddObject(interest);
                        }

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeletePendingCustomerInvoiceInterests(int customerId)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                List<CustomerInvoiceInterest> interests = GetPendingCustomerInvoiceInterests(entities, customerId, false, false);
                foreach (CustomerInvoiceInterest interest in interests)
                {
                    entities.DeleteObject(interest);
                }

                result = SaveChanges(entities);
            }

            return result;
        }

        #endregion

        #region CustomerInvoiceReminder

        public List<CustomerInvoiceReminder> GetPendingCustomerInvoiceReminders(int customerId, bool loadCustomer, bool loadProduct)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.CustomerInvoiceReminder.NoTracking();
            return GetPendingCustomerInvoiceReminders(entities, customerId, loadCustomer, loadProduct);
        }

        public List<CustomerInvoiceReminder> GetPendingCustomerInvoiceReminders(CompEntities entities, int customerId, bool loadCustomer, bool loadProduct)
        {
            List<CustomerInvoiceReminder> unhandledReminders = new List<CustomerInvoiceReminder>();

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.CustomerInvoiceReminder.NoTracking();
            List<CustomerInvoiceReminder> reminders = (from cir in entities.CustomerInvoiceReminder
                                                        .Include("CustomerInvoiceOrigin")
                                                       where cir.CustomerInvoiceOrigin.ActorId == customerId &&
                                                       cir.CustomerInvoiceOrigin.State == (int)SoeEntityState.Active
                                                       select cir).ToList();

            foreach (CustomerInvoiceReminder reminder in reminders)
            {
                //Check type after query to make sure index is used most efficient
                if (reminder.Type != (int)SoeInvoiceReminderHandlingType.AddToNextInvoice)
                    continue;
                if (IsCustomerInvoiceReminderHandled(entities, reminder))
                    continue;

                if (loadCustomer)
                {
                    if (reminder.CustomerInvoiceOrigin != null)
                    {
                        if (!reminder.CustomerInvoiceOrigin.ActorReference.IsLoaded)
                            reminder.CustomerInvoiceOrigin.ActorReference.Load();
                        if (!reminder.CustomerInvoiceOrigin.Actor.CustomerReference.IsLoaded)
                            reminder.CustomerInvoiceOrigin.Actor.CustomerReference.Load();
                    }
                }

                if (loadProduct)
                {
                    if (!reminder.InvoiceProductReference.IsLoaded)
                        reminder.InvoiceProductReference.Load();
                }

                unhandledReminders.Add(reminder);
            }

            return unhandledReminders;
        }

        public CustomerInvoiceReminder GetCustomerInvoiceReminder(CompEntities entities, int customerInvoiceOriginId, int noOfReminder)
        {
            return (from cir in entities.CustomerInvoiceReminder
                    where cir.CustomerInvoiceOrigin.InvoiceId == customerInvoiceOriginId &&
                    cir.NoOfReminder == noOfReminder
                    select cir).FirstOrDefault();
        }

        public string GetCustomerInvoicePrintedRemindersMessage(int customerInvoiceOriginId)
        {
            StringBuilder message = new StringBuilder();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            int actorCompanyId = base.ActorCompanyId;
            var reminderItems = (from i in entitiesReadOnly.CustomerInvoicePrintedReminder
                                 where i.CustomerInvoiceOriginId == customerInvoiceOriginId &&
                                 i.ActorCompanyId == actorCompanyId
                                 select i).ToList();

            foreach (var reminderItem in reminderItems)
            {
                string reminderNumberText = reminderItem.NoOfReminder >= (int)TermGroup_InvoiceClaimLevel.Collection ? GetText(664, (int)TermGroup.ChangeStatusGrid, "inkasso") : reminderItem.NoOfReminder.ToString();

                message.Append(
                    string.Format(GetText(66, (int)TermGroup.ChangeStatusGrid, "Krav") +
                    " {0} " +
                    GetText(663, (int)TermGroup.ChangeStatusGrid, "framställt") +
                    " {1} " +
                    GetText(656, (int)TermGroup.ChangeStatusGrid, "På").ToLower() +
                    " " +
                    GetText(4, (int)TermGroup.ChangeStatusGrid, "Belopp").ToLower() +
                    " {2} " +
                    GetText(657, (int)TermGroup.ChangeStatusGrid, "Med").ToLower() +
                    " " +
                    GetText(6, (int)TermGroup.ChangeStatusGrid, "Förfallodatum").ToLower() +
                    " {3}",
                    reminderNumberText,
                    reminderItem.ReminderDate.ToString("yyyy-MM-dd"),
                    reminderItem.Amount,
                    reminderItem.DueDate.ToString("yyyy-MM-dd")) +
                    "\r\n");
            }

            return message.ToString();
        }

        public List<CustomerInvoice> GetOriginInvoicesFromReminder(CompEntities entities, int reminderInvoiceId)
        {
            List<CustomerInvoice> customerInvoices = new List<CustomerInvoice>();

            var reminders = (from cir in entities.CustomerInvoiceReminderView
                             where cir.NewInvoiceId == reminderInvoiceId
                             select cir).ToList();

            foreach (var reminder in reminders)
            {
                CustomerInvoice customerInvoice = (from ci in entities.Invoice.OfType<CustomerInvoice>()
                                                   where ci.InvoiceId == reminder.InvoiceId
                                                   select ci).FirstOrDefault();

                if (customerInvoice != null)
                    customerInvoices.Add(customerInvoice);
            }

            return customerInvoices;
        }

        public CustomerInvoiceRow GetCustomerInvoiceRowFromReminder(CompEntities entities, int customerInvoiceReminderId)
        {
            return (from cir in entities.CustomerInvoiceRow
                        .Include("CustomerInvoice")
                        .Include("CustomerInvoice.Origin")
                    where cir.CustomerInvoiceReminderId == customerInvoiceReminderId
                    select cir).FirstOrDefault();
        }

        public decimal GetReminderProductPrice(CompEntities entities, InvoiceProduct productReminder, int priceListTypeId)
        {
            if (productReminder == null || priceListTypeId <= 0)
                return 0;

            decimal reminderAmount = 0;

            //Make sure PriceList is loaded
            if (!productReminder.PriceList.IsLoaded)
                productReminder.PriceList.Load();

            if (productReminder.PriceList != null && productReminder.PriceList.Count > 0)
            {
                //Probably wont have different prices for reminder product. If they only have one - take it! (according to Ingjerd)
                if (productReminder.PriceList.Count == 1)
                    reminderAmount = productReminder.PriceList.First().Price;
                else
                {
                    PriceList priceList = productReminder.PriceList.FirstOrDefault(i => i.PriceListTypeId == priceListTypeId);
                    if (priceList != null)
                        reminderAmount = priceList.Price;
                }
            }

            return reminderAmount;
        }

        private bool IsCustomerInvoiceReminderHandled(CompEntities entities, CustomerInvoiceReminder reminder)
        {
            if (reminder == null)
                return false;

            //Get CustomerInvoiceRows interest
            List<CustomerInvoiceRow> customerInvoiceRows = entities.CustomerInvoiceRow.Where(i => i.CustomerInvoiceReminderId == reminder.CustomerInvoiceReminderId).ToList();

            //Only active (filter after query to make sure index is used most efficient)
            customerInvoiceRows = customerInvoiceRows.Where(i => i.State == (int)SoeEntityState.Active).ToList();

            //Check if not added to any CustomerInvoice yet
            if (customerInvoiceRows.Count == 0 && reminder.Type == (int)SoeInvoiceReminderHandlingType.AddToNextInvoice)
                return false;

            //Check if CustomerInvoiceRow or CustomerInvoice is active
            return IsAnyCustomerInvoiceRowActive(customerInvoiceRows);
        }

        public string GetClaimText(CustomerInvoice customerInvoice, int actorCompanyId)
        {
            string claimText = "";
            if (customerInvoice == null)
                return claimText;

            switch (customerInvoice.NoOfReminders)
            {
                case (int)TermGroup_InvoiceClaimLevel.Claim1:
                    claimText = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CustomerClaimLevel1Text, 0, actorCompanyId, 0);
                    break;
                case (int)TermGroup_InvoiceClaimLevel.Claim2:
                    claimText = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CustomerClaimLevel2Text, 0, actorCompanyId, 0);
                    break;
                case (int)TermGroup_InvoiceClaimLevel.Claim3:
                    claimText = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CustomerClaimLevel3Text, 0, actorCompanyId, 0);
                    break;
                case (int)TermGroup_InvoiceClaimLevel.Claim4:
                    claimText = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CustomerClaimLevel4Text, 0, actorCompanyId, 0);
                    break;
                case (int)TermGroup_InvoiceClaimLevel.Collection:
                    claimText = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.CustomerClaimLevelDebtCollectionText, 0, actorCompanyId, 0);
                    break;
            }

            return claimText;
        }

        public ActionResult IncreaseCustomerInvoiceReminder(CompEntities entities, CustomerInvoice customerInvoiceOrigin, int actorCompanyId, bool saveChanges = true)
        {
            if (customerInvoiceOrigin == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

            CustomerInvoiceReminder reminder = GetCustomerInvoiceReminder(entities, customerInvoiceOrigin.InvoiceId, customerInvoiceOrigin.NoOfReminders);
            return IncreaseCustomerInvoiceReminder(entities, customerInvoiceOrigin, reminder, actorCompanyId, saveChanges);
        }

        public ActionResult IncreaseCustomerInvoiceReminder(CompEntities entities, CustomerInvoice customerInvoiceOrigin, CustomerInvoiceReminder reminder, int actorCompanyId, bool saveChanges = true)
        {
            ActionResult result = new ActionResult(true);

            if (customerInvoiceOrigin == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

            #region Prereq

            int nrOfClaimLevels = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.CustomerReminderNrOfClaimLevels, 0, actorCompanyId, 0);

            #endregion

            #region CustomerInvoiceReminder

            //Coupled CustomerInvoiceReminder
            if (reminder != null)
            {
                //Increase NoOfReminder
                reminder.NoOfReminder++;

                //Set collection if exceeded nrOfClaimLevels
                if (reminder.NoOfReminder > nrOfClaimLevels)
                    reminder.NoOfReminder = (int)TermGroup_InvoiceClaimLevel.Collection;

                SetModifiedProperties(reminder);
            }

            #endregion

            #region CustomerInvoice (origin)

            //Increase NoOfReminders
            customerInvoiceOrigin.NoOfReminders++;

            //Set collection
            if (customerInvoiceOrigin.NoOfReminders > nrOfClaimLevels)
                customerInvoiceOrigin.NoOfReminders = (int)TermGroup_InvoiceClaimLevel.Collection;

            SetModifiedProperties(customerInvoiceOrigin);

            #endregion

            #region CustomerInvoicePrintedRemminder

            //Save to CustomerInvoicePrintedReminder
            CustomerInvoicePrintedReminder printedReminder = new CustomerInvoicePrintedReminder()
            {
                ActorCompanyId = actorCompanyId,
                CustomerInvoiceOriginId = customerInvoiceOrigin.Origin.OriginId,
                InvoiceNr = customerInvoiceOrigin.InvoiceNr,
                Amount = customerInvoiceOrigin.TotalAmount - customerInvoiceOrigin.PaidAmount,
                ReminderDate = DateTime.Now,
                DueDate = customerInvoiceOrigin.DueDate.Value,
                NoOfReminder = customerInvoiceOrigin.NoOfReminders,

                //Set references
                Company = CompanyManager.GetCompany(entities, actorCompanyId),
            };

            SetCreatedProperties(printedReminder);
            entities.CustomerInvoicePrintedReminder.AddObject(printedReminder);

            #endregion

            if (saveChanges)
                result = SaveChanges(entities);

            return result;
        }

        public ActionResult DecreaseNoOfReminders(CompEntities entities, CustomerInvoice customerInvoiceOrigin, CustomerInvoiceReminder reminder, bool saveChanges = true)
        {
            ActionResult result = new ActionResult(true);

            if (customerInvoiceOrigin == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

            #region CustomerInvoiceReminder

            if (reminder != null)
            {
                CustomerInvoiceRow reminderInvoiceRow = GetCustomerInvoiceRowFromReminder(entities, reminder.CustomerInvoiceReminderId);
                if (reminderInvoiceRow != null && reminderInvoiceRow.CustomerInvoice != null && reminderInvoiceRow.CustomerInvoice.Origin != null)
                {
                    if (reminderInvoiceRow.CustomerInvoice.Origin.Status != (int)SoeOriginStatus.Draft)
                        return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderCannotSetReminderLevelInvoiceNotDraft, reminderInvoiceRow.CustomerInvoice.InvoiceNr);

                    if (reminder.NoOfReminder == 1)
                    {
                        //Delete CustomerInvoice (only if new Reminder invoice was created - not added to next invoice)
                        if (reminder.Type == (int)SoeInvoiceReminderHandlingType.CreateNewInvoice)
                        {
                            if (reminderInvoiceRow.CustomerInvoice.State == (int)SoeEntityState.Active)
                                ChangeEntityState(reminderInvoiceRow.CustomerInvoice, SoeEntityState.Deleted);
                        }

                        //Delete CustomerInvoiceRow
                        if (reminderInvoiceRow.State == (int)SoeEntityState.Active)
                            ChangeEntityState(reminderInvoiceRow, SoeEntityState.Deleted);

                        //Decouple CustomerInvoiceRow from reminder
                        reminderInvoiceRow.CustomerInvoiceReminder = null;
                    }

                    if (reminder.NoOfReminder > 0)
                    {
                        //Decrease reminder
                        reminder.NoOfReminder--;
                    }
                    else
                    {
                        //Delete reminder
                        if (reminder.Type == (int)SoeInvoiceReminderHandlingType.CreateNewInvoice)
                            entities.DeleteObject(reminder);
                    }
                }
            }

            #endregion

            #region CustomerInvoice (origin)

            if (customerInvoiceOrigin.NoOfReminders > 0)
            {
                //Decrease NoOfReminders
                customerInvoiceOrigin.NoOfReminders--;
                SetModifiedProperties(customerInvoiceOrigin);
            }

            #endregion

            if (saveChanges)
                result = SaveChanges(entities);

            return result;
        }

        public ActionResult DecreaseNoOfReminders(CompEntities entities, CustomerInvoiceRow reminderInvoiceRow, bool saveChanges = true)
        {
            ActionResult result = new ActionResult(true);

            if (reminderInvoiceRow == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoiceRow");

            #region Prereq

            //Make sure CustomerInvoiceReminderReference is loaded
            if (!reminderInvoiceRow.CustomerInvoiceReminderReference.IsLoaded)
                reminderInvoiceRow.CustomerInvoiceReminderReference.Load();

            if (reminderInvoiceRow.CustomerInvoiceReminder != null)
            {
                //Make sure CustomerInvoiceOriginReference is loaded
                if (!reminderInvoiceRow.CustomerInvoiceReminder.CustomerInvoiceOriginReference.IsLoaded)
                    reminderInvoiceRow.CustomerInvoiceReminder.CustomerInvoiceOriginReference.Load();
            }

            #endregion

            #region CustomerInvoiceReminder

            CustomerInvoiceReminder reminder = reminderInvoiceRow.CustomerInvoiceReminder;
            if (reminder != null)
            {
                if (reminder.NoOfReminder == 1)
                {
                    //Delete CustomerInvoice (only if new Reminder invoice was created - not added to next invoice)
                    if (reminder.Type == (int)SoeInvoiceReminderHandlingType.CreateNewInvoice)
                    {
                        //Delete CustomerInvoiceRow
                        if (reminderInvoiceRow.State == (int)SoeEntityState.Active)
                            ChangeEntityState(reminderInvoiceRow, SoeEntityState.Deleted);
                    }
                }

                //Decouple CustomerInvoiceRow from reminder
                reminderInvoiceRow.CustomerInvoiceReminder = null;

                if (reminder.NoOfReminder > 0)
                {
                    //Decrease reminder
                    reminder.NoOfReminder--;
                }
                else
                {
                    //Delete reminder
                    if (reminder.Type == (int)SoeInvoiceReminderHandlingType.CreateNewInvoice)
                        entities.DeleteObject(reminder);
                }
            }

            #endregion

            #region CustomerInvoice (origin)

            if (reminder != null)
            {
                CustomerInvoice customerInvoiceOrigin = reminder.CustomerInvoiceOrigin;
                if (customerInvoiceOrigin != null)
                {
                    if (customerInvoiceOrigin.NoOfReminders > 0)
                    {
                        //Decrease NoOfReminders
                        customerInvoiceOrigin.NoOfReminders--;
                        SetModifiedProperties(customerInvoiceOrigin);
                    }
                }
            }

            #endregion

            if (saveChanges)
                result = SaveChanges(entities);

            return result;
        }

        public ActionResult SaveReminderCustomerInvoice(List<CustomerInvoiceGridDTO> items, bool merge, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult(true);

            if (items == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ChangeStatusGridView");

            #region Prereq

            bool generateProductRow = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.CustomerReminderGenerateProductRow, userId, actorCompanyId, 0);
            int defaultHandlingType = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerReminderHandlingType, userId, actorCompanyId, 0);
            if (!generateProductRow || defaultHandlingType == 0)
                return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderNotActivated);

            int defaultReminderProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductReminderFee, userId, actorCompanyId, 0);
            int defaultPriceListType = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, userId, actorCompanyId, 0);
            int defaultPaymentConditionId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerDefaultPaymentConditionClaimAndInterest, 0, actorCompanyId, 0);
            int defaultMinNrOfDaysForNewClaim = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerReminderMinNrOfDaysForNewClaim, 0, actorCompanyId, 0);
            bool useCentRounding = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingUseCentRounding, 0, actorCompanyId, 0);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                List<CustomerInvoiceReminder> reminders = new List<CustomerInvoiceReminder>();
                List<CustomerInvoice> customerInvoices = new List<CustomerInvoice>();

                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        User user = UserManager.GetUser(entities, userId);
                        if (user == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductNotFound, "User");

                        //Get Product reminder
                        InvoiceProduct productReminder = ProductManager.GetInvoiceProduct(entities, defaultReminderProductId, true, false, false);
                        if (productReminder == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductNotFound, "InvoiceProduct");

                        //Get AccountStd sales
                        AccountStd accountStdSales = AccountManager.GetAccountStdFromInvoiceProductOrCompany(entities, productReminder, ProductAccountType.Sales, CompanySettingType.AccountInvoiceProductSales, actorCompanyId);
                        if (accountStdSales == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductAccountSalesNotFound);

                        //Get AccountStd purchase
                        AccountStd accountStdPurchase = AccountManager.GetAccountStdFromInvoiceProductOrCompany(entities, productReminder, ProductAccountType.Purchase, CompanySettingType.AccountInvoiceProductPurchase, actorCompanyId);
                        if (accountStdPurchase == null)
                            return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductAccountPurchaseNotFound);

                        //Get AccountStd Vat
                        AccountStd accountStdVat = null;
                        ProductAccountStd productAccountStdVat = productReminder.ProductAccountStd.FirstOrDefault(i => i.Type == (int)ProductAccountType.VAT);
                        if (productAccountStdVat != null)
                        {
                            //Make sure AccountStd is loaded
                            if (!productAccountStdVat.AccountStdReference.IsLoaded)
                                productAccountStdVat.AccountStdReference.Load();

                            accountStdVat = productAccountStdVat.AccountStd;
                        }

                        string batchId = Guid.NewGuid().ToString();

                        #endregion

                        foreach (var item in items)
                        {
                            #region Prereq

                            if (defaultMinNrOfDaysForNewClaim > 0 && item.ActorCustomerId > 0)
                            {
                                DateTime? lastClaimDate = GetLastClaimDateForCustomer(entities, item.ActorCustomerId);
                                if (lastClaimDate.HasValue)
                                {
                                    int days = Convert.ToInt32(lastClaimDate.Value.AddDays(defaultMinNrOfDaysForNewClaim).Subtract(DateTime.Today).TotalDays);
                                    if (days > 0)
                                    {
                                        result = new ActionResult((int)ActionResultSave.CustomerInvoiceReminderDateToNearAfterPrevClaim);
                                        result.ErrorMessage = String.Format(GetText((int)TermGroup.ChangeStatusGrid, 757, "Nytt kravbrev får inte skickas till kund förrens om {0} dagar"), days);
                                        result.StringValue = item.InvoiceNr;
                                        result.IntegerValue = days;
                                        return result;
                                    }
                                }
                            }

                            if (item.FullyPaid)
                            {
                                result = new ActionResult((int)ActionResultSave.CustomerInvoiceReminderIsFullyPayed);
                                result.StringValue = item.InvoiceNr;
                                return result;
                            }

                            //Need to load necessary relations to be able to copy the invoice to a new interest invoice
                            CustomerInvoice customerInvoice = GetCustomerInvoice(entities, item.CustomerInvoiceId, true, true, false, false, true, true, true, false, false, false, false, false);
                            if (customerInvoice == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                            //Cannot create claim for credit invoice
                            if (customerInvoice.BillingType == (int)TermGroup_BillingType.Credit)
                                continue;

                            //Must have Customer
                            if (!customerInvoice.ActorId.HasValue)
                                continue;

                            //Make sure PriceListType is loaded
                            if (!customerInvoice.ActorReference.IsLoaded)
                                customerInvoice.ActorReference.Load();

                            //Make sure Customer is loaded
                            if (!customerInvoice.Actor.CustomerReference.IsLoaded)
                                customerInvoice.Actor.CustomerReference.Load();

                            //Get PriceListType from Customer if exists, otherwise Company setting
                            int priceListTypeId = GetPriceListTypeIdBasedOnPriority(customerInvoice.Actor.Customer, defaultPriceListType);

                            //Claim product amount
                            decimal reminderAmount = GetReminderProductPrice(entities, productReminder, priceListTypeId);

                            #endregion

                            #region CustomerInvoiceReminder

                            CustomerInvoiceReminder reminder = new CustomerInvoiceReminder()
                            {
                                Type = defaultHandlingType,
                                InvoiceNr = item.InvoiceNr,
                                DueDate = item.DueDate.Value,
                                Amount = reminderAmount,
                                NoOfReminder = item.NoOfReminders,
                                BatchId = batchId,

                                //Set references
                                CustomerInvoiceOrigin = customerInvoice,
                                InvoiceProduct = productReminder,
                            };
                            SetCreatedProperties(reminder);
                            entities.CustomerInvoiceReminder.AddObject(reminder);

                            //Set currency amounts
                            CountryCurrencyManager.SetCurrencyAmounts(entities, actorCompanyId, reminder, customerInvoice.CurrencyRate, customerInvoice.ActorId.Value);

                            reminders.Add(reminder);

                            #endregion
                        }

                        if (defaultHandlingType == (int)SoeInvoiceReminderHandlingType.CreateNewInvoice)
                        {
                            foreach (var group in reminders.GroupBy(o => o.CustomerInvoiceOrigin.ActorId.Value))
                            {
                                #region Common for customer

                                PaymentCondition paymentCondition = defaultPaymentConditionId > 0 ? PaymentManager.GetPaymentCondition(entities, defaultPaymentConditionId, actorCompanyId) : null;

                                //DeliveryType
                                List<DeliveryType> deliveryTypes = group.Select(i => i.CustomerInvoiceOrigin.DeliveryType).Distinct().ToList();
                                DeliveryType deliveryType = deliveryTypes.Count == 1 ? deliveryTypes.First() : null;

                                //DeliveryCondition
                                List<DeliveryCondition> deliveryConditions = group.Select(i => i.CustomerInvoiceOrigin.DeliveryCondition).Distinct().ToList();
                                DeliveryCondition deliveryCondition = deliveryConditions.Count == 1 ? deliveryConditions.First() : null;

                                //Currency
                                List<Currency> currencies = group.Select(i => i.CustomerInvoiceOrigin.Currency).Distinct().ToList();
                                Currency currency = currencies.Count == 1 ? currencies.First() : null;

                                //DeliveryAddressId
                                List<int> deliveryAddressIds = group.Select(i => i.CustomerInvoiceOrigin.DeliveryAddressId).Distinct().ToList();
                                int deliveryAddressId = deliveryAddressIds.Count == 1 ? deliveryAddressIds.First() : 0;

                                //BillingAddressId
                                List<int> billingAddressIds = group.Select(i => i.CustomerInvoiceOrigin.BillingAddressId).Distinct().ToList();
                                int billingAddressId = billingAddressIds.Count == 1 ? billingAddressIds.First() : 0;

                                #endregion

                                CustomerInvoice newCustomerInvoice = null;
                                int counter = 0;

                                foreach (CustomerInvoiceReminder reminder in group.OrderBy(i => i.DueDate))
                                {
                                    counter++;

                                    #region Create new CustomerInvoice

                                    decimal amount = 0;

                                    //Create CustomerInvoice
                                    if (!merge || counter == 1)
                                    {
                                        newCustomerInvoice = CreateCustomerInvoiceForReminder(entities, reminder.CustomerInvoiceOrigin, paymentCondition, deliveryType, deliveryCondition, currency, deliveryAddressId, billingAddressId, actorCompanyId);
                                        if (newCustomerInvoice == null)
                                            return new ActionResult((int)ActionResultSave.CustomerInvoiceFailedCopy);

                                        //Set description
                                        newCustomerInvoice.Origin.Description = GetText(5614, "Kravbrev");
                                        newCustomerInvoice.Origin.Description += ":";

                                        customerInvoices.Add(newCustomerInvoice);
                                    }

                                    amount = reminder.Amount;

                                    //Set description
                                    if (String.IsNullOrEmpty(reminder.CustomerInvoiceOrigin.Origin.Description))
                                        newCustomerInvoice.Origin.Description += String.Format(" {0}.", reminder.CustomerInvoiceOrigin.InvoiceNr);
                                    else
                                        newCustomerInvoice.Origin.Description += String.Format(" {0} {1}.", reminder.CustomerInvoiceOrigin.InvoiceNr, reminder.CustomerInvoiceOrigin.Origin.Description);

                                    //Create CustomerInvoiceRows
                                    result = CreateCustomerInvoiceRowsForInterestAndReminder(entities, newCustomerInvoice, reminder, null, reminder.InvoiceProduct, accountStdSales, accountStdPurchase, accountStdVat, amount, actorCompanyId);
                                    if (!result.Success)
                                        return result;

                                    var accountRowNr = newCustomerInvoice.CustomerInvoiceRow.SelectMany(r => r.CustomerInvoiceAccountRow).Max(r => r.RowNr);
                                    UpdateInvoiceAfterRowModification(entities, newCustomerInvoice, accountRowNr, actorCompanyId);

                                    //Increase reminder
                                    IncreaseCustomerInvoiceReminder(entities, reminder.CustomerInvoiceOrigin, reminder, actorCompanyId, false);

                                    #endregion
                                }
                            }
                        }

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        if (defaultHandlingType == (int)SoeInvoiceReminderHandlingType.CreateNewInvoice)
                        {
                            result.StrDict = GetCustomerInvoicesDict(customerInvoices);
                            result.IntegerValue = customerInvoices.Count;
                            result.IntegerValue2 = defaultHandlingType;
                        }
                        else if (defaultHandlingType == (int)SoeInvoiceReminderHandlingType.AddToNextInvoice)
                        {
                            result.IntegerValue = reminders.Count;
                            result.IntegerValue2 = defaultHandlingType;
                        }
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult UpdateReminderLevel(List<CustomerInvoiceGridDTO> items, int claimLevel, int actorCompanyId)
        {
            if (items == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ChangeStatusGridView");

            // Default result is successful
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        #endregion

                        foreach (var item in items)
                        {
                            //Cannot be same or update from 0 (must create reminder first)
                            if (item.NoOfReminders == claimLevel || item.NoOfReminders == 0)
                                continue;

                            CustomerInvoice customerInvoiceOrigin = GetCustomerInvoice(entities, item.CustomerInvoiceId);
                            if (customerInvoiceOrigin == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                            //Cannot create claim for credit invoice - removed by request bug 39205
                            /*if (customerInvoiceOrigin.BillingType == (int)TermGroup_BillingType.Credit)
                                continue;*/

                            CustomerInvoiceReminder reminder = GetCustomerInvoiceReminder(entities, customerInvoiceOrigin.InvoiceId, customerInvoiceOrigin.NoOfReminders);

                            if (item.NoOfReminders < claimLevel)
                            {
                                #region Increase

                                for (int i = item.NoOfReminders; i < claimLevel; i++)
                                {
                                    //Increase reminder
                                    result = IncreaseCustomerInvoiceReminder(entities, customerInvoiceOrigin, reminder, actorCompanyId, false);
                                    if (!result.Success)
                                        return result;
                                    if (reminder != null && reminder.NoOfReminder == (int)TermGroup_InvoiceClaimLevel.Collection)
                                        break;
                                }

                                #endregion
                            }
                            else if (item.NoOfReminders > claimLevel)
                            {
                                #region Decrease

                                for (int i = item.NoOfReminders; i > claimLevel; i--)
                                {
                                    //Decrease reminder
                                    result = DecreaseNoOfReminders(entities, customerInvoiceOrigin, reminder, false);
                                    if (!result.Success)
                                        return result;
                                    if (reminder != null && reminder.NoOfReminder == (int)TermGroup_InvoiceClaimLevel.None)
                                        break;
                                }

                                #endregion
                            }
                        }

                        if (result.Success)
                            result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeletePendingCustomerInvoiceReminders(int customerId)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                List<CustomerInvoiceReminder> reminders = GetPendingCustomerInvoiceReminders(entities, customerId, false, false);
                foreach (CustomerInvoiceReminder reminder in reminders)
                {
                    entities.DeleteObject(reminder);
                }

                result = SaveChanges(entities);
            }

            return result;
        }

        #endregion

        #endregion

        #region ChangeStatusGridView

        public List<ChangeStatusGridViewBalanceDTO> GetChangeStatusGridViewsCountersAndBalanceForCustomerCentral(List<int> classificationsGroups, int customerId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetChangeStatusGridViewsCountersAndBalanceForCustomerCentral(entities, classificationsGroups, customerId, actorCompanyId);
        }

        public List<ChangeStatusGridViewBalanceDTO> GetChangeStatusGridViewsCountersAndBalanceForCustomerCentral(CompEntities entities, List<int> classificationsGroups, int customerId, int actorCompanyId)
        {
            var balances = new List<ChangeStatusGridViewBalanceDTO>();
            var baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, actorCompanyId);

            if (classificationsGroups.Contains((int)SoeOriginStatusClassification.ContractsOpen))
            {
                var invoices = GetCustomerInvoicesForGrid(entities, SoeOriginStatusClassification.ContractsOpen, (int)SoeOriginType.Contract, actorCompanyId, base.UserId, true, false, false, false, TermGroup_ChangeStatusGridAllItemsSelection.All, false, null, false, null, customerId);
                var invoicesBaseCurrency = invoices.Where(o => o.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.ContractsOpen, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount), invoicesBaseCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
            }

            if (
                classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpen) ||
                classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenForeign) ||
                classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenUser) ||
                classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenUserForeign)
            )
            {
                var foreign = classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenForeign) || classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenUserForeign);
                var onlyMine = classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenUser) || classificationsGroups.Contains((int)SoeOriginStatusClassification.OffersOpenUserForeign);
                var invoices = GetCustomerInvoicesForGrid(entities, SoeOriginStatusClassification.OffersOpen, (int)SoeOriginType.Offer, actorCompanyId, base.UserId, true, false, onlyMine, false, TermGroup_ChangeStatusGridAllItemsSelection.All, false, null, false, null, customerId);
                var invoicesBaseCurrency = invoices.Where(o => o.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.OffersOpen, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount), invoicesBaseCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                if (foreign)
                {
                    var invoicesCurrency = invoices.Where(o => o.SysCurrencyId != baseSysCurrencyId).ToList();
                    balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.OffersOpenForeign, invoicesCurrency.Count, invoicesCurrency.Sum(c => c.TotalAmount), invoicesCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                }
            }

            if (
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpen) ||
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenForeign) ||
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenUser) ||
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenUserForeign)
                )
            {
                var foreign = classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenForeign) || classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenUserForeign);
                var onlyMine = classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenUser) || classificationsGroups.Contains((int)SoeOriginStatusClassification.OrdersOpenUserForeign);
                var orders = GetOrdersForGrid(entities, SoeOriginStatusClassification.OrdersOpen, actorCompanyId, base.UserId, true, false, onlyMine, true, customerId, null, false, null, false, null);
                var ordersBaseCurrency = orders.Where(o => o.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.OrdersOpen, ordersBaseCurrency.Count, ordersBaseCurrency.Sum(c => c.RemainingAmount), ordersBaseCurrency.Sum(c => c.RemainingAmountExVat)));
                if (foreign)
                {
                    var ordersCurrency = orders.Where(o => o.SysCurrencyId != baseSysCurrencyId).ToList();
                    balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.OrdersOpenForeign, ordersCurrency.Count, ordersCurrency.Sum(c => c.TotalAmountCurrency - c.PaidAmountCurrency), ordersCurrency.Sum(c => c.RemainingAmountExVat)));
                }
            }

            if (
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpen) ||
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenForeign) ||
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenUser) ||
                    classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenUserForeign)
                )
            {
                var foreign = classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenForeign) || classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenUserForeign);
                var onlyMine = classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenUser) || classificationsGroups.Contains((int)SoeOriginStatusClassification.CustomerInvoicesOpenUserForeign);
                var invoices = GetCustomerInvoicesForGrid(entities, SoeOriginStatusClassification.CustomerInvoicesOpen, (int)SoeOriginType.CustomerInvoice, actorCompanyId, base.UserId, true, false, onlyMine, false, TermGroup_ChangeStatusGridAllItemsSelection.All, false, null, false, null, customerId);
                var invoicesBaseCurrency = invoices.Where(o => o.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.CustomerInvoicesOpen, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount), invoicesBaseCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.CustomerPaymentsUnpayed, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount - c.PaidAmount), 0));
                if (foreign)
                {
                    var invoicesCurrency = invoices.Where(o => o.SysCurrencyId != baseSysCurrencyId).ToList();
                    balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.CustomerInvoicesOpenUserForeign, invoicesCurrency.Count, invoicesCurrency.Sum(c => c.TotalAmount), invoicesCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                }
            }

            return balances;
        }

        public List<ChangeStatusGridViewBalanceDTO> GetChangeStatusGridViewsCountersAndBalanceForSupplierCentral(List<int> classificationsGroups, int supplierId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetChangeStatusGridViewsCountersAndBalanceForSupplierCentral(entities, classificationsGroups, supplierId, actorCompanyId);
        }

        public List<ChangeStatusGridViewBalanceDTO> GetChangeStatusGridViewsCountersAndBalanceForSupplierCentral(CompEntities entities, List<int> classificationsGroups, int supplierId, int actorCompanyId)
        {
            var balances = new List<ChangeStatusGridViewBalanceDTO>();
            var baseSysCurrencyId = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, actorCompanyId);

            if (classificationsGroups.Contains((int)SoeOriginStatusClassification.SupplierPaymentsSupplierCentralUnpayed))
            {
                var foregin = classificationsGroups.Contains((int)SoeOriginStatusClassification.SupplierInvoicesOverdueForeign);
                var invoices = SupplierInvoiceManager.GetSupplierInvoicesForGrid(entities, true, false, TermGroup_ChangeStatusGridAllItemsSelection.All, supplierId, true, null, false, null, SoeOriginStatusClassification.SupplierPaymentsUnpayed);
                var invoicesBaseCurrency = invoices.Where(i => i.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.SupplierPaymentsSupplierCentralUnpayed, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount), invoicesBaseCurrency.Sum(c => c.TotalAmount - c.VATAmount)));

                if (foregin)
                {
                    var invoicesCurrency = invoices.Where(i => i.SysCurrencyId != baseSysCurrencyId).ToList();
                    balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.SupplierPaymentsSupplierCentralUnpayedForeign, invoicesCurrency.Count, invoicesCurrency.Sum(c => c.TotalAmount), invoicesCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                }
            }

            if (classificationsGroups.Contains((int)SoeOriginStatusClassification.SupplierInvoicesOverdue))
            {

                var foregin = classificationsGroups.Contains((int)SoeOriginStatusClassification.SupplierInvoicesOverdueForeign);
                var invoices = SupplierInvoiceManager.GetSupplierInvoicesForGrid(entities, true, false, TermGroup_ChangeStatusGridAllItemsSelection.All, supplierId, true, null, false, null, SoeOriginStatusClassification.SupplierInvoicesOverdue);
                var invoicesBaseCurrency = invoices.Where(i => i.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.SupplierInvoicesOverdue, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount), invoicesBaseCurrency.Sum(c => c.TotalAmount - c.VATAmount)));

                if (foregin)
                {
                    var invoicesCurrency = invoices.Where(i => i.SysCurrencyId != baseSysCurrencyId).ToList();
                    balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.SupplierInvoicesOverdueForeign, invoicesCurrency.Count, invoicesCurrency.Sum(c => c.TotalAmount), invoicesCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                }
            }

            if (classificationsGroups.Contains((int)SoeOriginStatusClassification.SupplierPaymentsSupplierCentralPayed))
            {
                var foregin = classificationsGroups.Contains((int)SoeOriginStatusClassification.SupplierPaymentsSupplierCentralPayedForeign);
                var invoices = SupplierInvoiceManager.GetSupplierInvoicesForGrid(entities, true, false, TermGroup_ChangeStatusGridAllItemsSelection.All, supplierId, true, null, false, null, SoeOriginStatusClassification.SupplierPaymentsSupplierCentralPayed);
                var invoicesBaseCurrency = invoices.Where(i => i.SysCurrencyId == baseSysCurrencyId).ToList();
                balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.SupplierPaymentsSupplierCentralPayed, invoicesBaseCurrency.Count, invoicesBaseCurrency.Sum(c => c.TotalAmount), invoicesBaseCurrency.Sum(c => c.TotalAmount - c.VATAmount)));

                if (foregin)
                {
                    var invoicesCurrency = invoices.Where(i => i.SysCurrencyId != baseSysCurrencyId).ToList();
                    balances.Add(new ChangeStatusGridViewBalanceDTO(SoeOriginStatusClassification.SupplierPaymentsSupplierCentralPayedForeign, invoicesCurrency.Count, invoicesCurrency.Sum(c => c.TotalAmount), invoicesCurrency.Sum(c => c.TotalAmount - c.VATAmount)));
                }
            }

            return balances;
        }

        public Dictionary<int, List<SupplierInvoiceGridDTO>> GetSupplierInvoicesDictForStateAnalysis(CompEntities entities)
        {
            var counters = new Dictionary<int, List<SupplierInvoiceGridDTO>>();
            var supplierInvoicesOpen = SupplierInvoiceManager.GetSupplierInvoicesForGrid(entities, true, false, TermGroup_ChangeStatusGridAllItemsSelection.All, 0, true, null, false, null, SoeOriginStatusClassification.None, false);
            var supplierInvoicesClosed = SupplierInvoiceManager.GetSupplierInvoicesForGrid(entities, false, true, TermGroup_ChangeStatusGridAllItemsSelection.All, 0, true, null, false, null, SoeOriginStatusClassification.None, false);

            var supplierInvoicesAll = new List<SupplierInvoiceGridDTO>();
            supplierInvoicesAll.AddRange(supplierInvoicesOpen);
            supplierInvoicesAll.AddRange(supplierInvoicesClosed);

            //SupplierInvoice
            counters.Add((int)SoeOriginStatusClassification.SupplierInvoicesOpen, supplierInvoicesOpen);

            return counters;
        }

        public Dictionary<int, List<CustomerInvoiceGridDTO>> GetCustomerInvoicesDictForStateAnalysis(CompEntities entities, int actorCompanyId)
        {
            var counters = new Dictionary<int, List<CustomerInvoiceGridDTO>>();
            //var items = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), null, null, null, null, null).ToList();

            //CustomerInvoice
            var invoiceItems = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), (int)SoeOriginType.CustomerInvoice, null, null, base.UserId, false, "").Where(i => i.IsInvoiceTemplate == false).ToList();
            counters.Add((int)SoeOriginStatusClassification.CustomerInvoicesOpen, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.CustomerInvoicesAll, (int)SoeOriginType.CustomerInvoice, base.ActorCompanyId, base.UserId, true, false, false, false, null, true, inputInvoices: invoiceItems));
            counters.Add((int)SoeOriginStatusClassification.CustomerInvoicesOpenUser, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.CustomerInvoicesAll, (int)SoeOriginType.CustomerInvoice, base.ActorCompanyId, base.UserId, true, false, true, false, null, true, inputInvoices: invoiceItems));
            counters.Add((int)SoeOriginStatusClassification.CustomerInvoicesReminder, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.CustomerInvoicesReminder, (int)SoeOriginType.CustomerInvoice, base.ActorCompanyId, base.UserId, true, false, false, false, null, true, inputInvoices: invoiceItems));
            //counters.Add((int)SoeOriginStatusClassification.CustomerInvoicesInterest, FilterStatusClassificationCustomerInvoicesInterest(entities, items, actorCompanyId)); - NOT USED?

            //CustomerPayment
            counters.Add((int)SoeOriginStatusClassification.CustomerPaymentsUnpayed, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.CustomerPaymentsUnpayed, (int)SoeOriginType.CustomerInvoice, base.ActorCompanyId, base.UserId, true, false, false, false, TermGroup_ChangeStatusGridAllItemsSelection.All, true));

            //Offers
            var offerItems = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), (int)SoeOriginType.Offer, null, null, base.UserId, false, "").Where(i => i.IsInvoiceTemplate == false).ToList();
            counters.Add((int)SoeOriginStatusClassification.OffersOpen, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.OffersAll, (int)SoeOriginType.Offer, base.ActorCompanyId, base.UserId, true, false, false, false, null, true, inputInvoices: offerItems));
            counters.Add((int)SoeOriginStatusClassification.OffersOpenUser, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.OffersAll, (int)SoeOriginType.Offer, base.ActorCompanyId, base.UserId, true, false, true, false, null, true, inputInvoices: offerItems));

            //Contract
            counters.Add((int)SoeOriginStatusClassification.ContractsOpen, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.ContractsAll, (int)SoeOriginType.Contract, base.ActorCompanyId, base.UserId, true, false, false, false, null, true));

            //Orders
            var orderItems = entities.GetCustomerInvoices(actorCompanyId, base.GetLangId(), (int)SoeOriginType.Order, null, null, base.UserId, false, "").Where(i => i.IsInvoiceTemplate == false && i.OrderType != (int)TermGroup_OrderType.Internal).ToList();
            counters.Add((int)SoeOriginStatusClassification.OrdersOpen, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.OrdersAll, (int)SoeOriginType.Order, base.ActorCompanyId, base.UserId, true, false, false, false, null, true, inputInvoices: orderItems));
            counters.Add((int)SoeOriginStatusClassification.OrdersOpenUser, GetCustomerInvoicesForGrid(SoeOriginStatusClassification.OrdersAll, (int)SoeOriginType.Order, base.ActorCompanyId, base.UserId, true, false, true, false, null, true, inputInvoices: orderItems));

            return counters;
        }

        public bool InvoicesExistForActor(SoeOriginType originType, int actorId, int actorCompanyId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from i in entitiesReadOnly.Invoice
                    where i.ActorId == actorId &&
                    i.State != (int)SoeEntityState.Deleted &&
                    i.Origin.ActorCompanyId == actorCompanyId &&
                    i.Origin.Type == (int)originType
                    select i.InvoiceId).Any();
        }

        public List<InvoicePaymentUnionView> GetChangeStatusGridViewsByTypes(int actorCompanyId, SoeOriginType originTypeInvoice, SoeOriginType originTypePayment)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetChangeStatusGridViewsByTypes(entities, actorCompanyId, originTypeInvoice, originTypePayment);
        }

        public List<InvoicePaymentUnionView> GetChangeStatusGridViewsByTypes(CompEntities entities, int actorCompanyId, SoeOriginType originTypeInvoice, SoeOriginType originTypePayment)
        {
            return (from i in entities.InvoicePaymentUnionView
                    where i.ActorCompanyId == actorCompanyId &&
                    (i.OriginType == (int)originTypeInvoice || i.OriginType == (int)originTypePayment)
                    select i).ToList();
        }

        public List<SmallGenericType> GetCustomerInvoiceContractsDict(int actorCompanyId, int customerId, SoeOriginType originType, SoeOriginStatusClassification originStatusClassification, bool orderByNumber)
        {
            var invoices = new List<SmallGenericType>();

            var items = GetCustomerInvoicesForGrid(originStatusClassification, (int)originType, actorCompanyId, base.UserId, true, true, false, false, TermGroup_ChangeStatusGridAllItemsSelection.All, true, addCustomerInvoiceAttestStates: false);

            if (customerId != 0)
                items = items.Where(i => i.ActorCustomerId == customerId).ToList();

            if (originType == SoeOriginType.CustomerInvoice)
            {
                items = items.OrderBy(i => i.ActorCustomerNr).ToList();
                foreach (var item in items.Where(i => i.Status == (int)SoeOriginStatus.Draft))
                {
                    invoices.Add(new SmallGenericType() { Id = item.CustomerInvoiceId, Name = item.ActorCustomerNr + " " + item.ActorCustomerName + " - " + item.TotalAmount });
                }
            }
            else if (originType == SoeOriginType.Contract)
            {
                items = items.OrderByDescending(i => Convert.ToInt32(i.InvoiceNr)).ToList();
                foreach (var item in items)
                {
                    invoices.Add(new SmallGenericType() { Id = item.CustomerInvoiceId, Name = item.InvoiceNr + " " + item.ActorCustomerName });
                }
            }
            else
            {
                items = orderByNumber ? items.OrderBy(i => i.SeqNr).ToList() : items.OrderBy(i => i.ActorCustomerNr).ToList();
                foreach (var item in items)
                {
                    invoices.Add(new SmallGenericType() { Id = item.CustomerInvoiceId, Name = item.InvoiceNr + " " + item.ActorCustomerName });
                }
            }

            return invoices;
        }

        #region Help-methods


        private List<CustomerInvoiceGridDTO> AddCustomerInvoiceAttestStatesConverted(CompEntities entities, List<CustomerInvoiceGridDTO> items, int originType, int actorCompanyId, int userId)
        {
            if (items == null)
                return items;

            //Get only orders which has rows certain attest states?
            //no rows = Reg state

            var visibleattestStates = originType == (int)SoeOriginType.Order ? AttestManager.GetVisibleAttestStatesForUser(userId, actorCompanyId) : new List<int>();
            List<CustomerInvoiceGridDTO> itemsWithCorrectAttestState = visibleattestStates.Any() ? new List<CustomerInvoiceGridDTO>() : null;

            foreach (var groupCompany in items.GroupBy(i => i.OwnerActorId))
            {
                var ownerActorId = groupCompany.Key;
                var initialAttestStateId = itemsWithCorrectAttestState == null ? 0 : AttestManager.GetInitialAttestStateId(entities, ownerActorId, TermGroup_AttestEntity.Order);
                var visibleattestStatesContainsinitialAttestStateId = visibleattestStates.Contains(initialAttestStateId);

                //List<CustomerInvoiceRowAttestStateView> attestStatesForCompany = GetAttestStatesForCompanyAndInvoices(entities, actorCompanyId, items.Select(y => y.CustomerInvoiceId).ToList());
                var attestStatesForCompanyInvoice = GetAttestStatesForCompanyAndInvoices(entities, actorCompanyId, items.Select(y => y.CustomerInvoiceId).ToList()).ToLookup(i => i.InvoiceId);

                foreach (var item in groupCompany)
                {

                    //item.AttestStates = attestStatesForCompany.Where(i => i.InvoiceId == item.CustomerInvoiceId).ToDTOs().OrderBy(a => a.Sort).ToList();
                    var attestDtos = attestStatesForCompanyInvoice.Where(i => i.Key == item.CustomerInvoiceId).SelectMany(x => x).ToDTOs();
                    item.AttestStates = attestDtos.OrderBy(a => a.Sort).ToList();

                    item.AttestStateNames = string.Join(", ", item.AttestStates.Select(i => i.Name));
                    if (itemsWithCorrectAttestState != null)
                    {
                        if (item.AttestStates.Any())
                        {
                            var x = item.AttestStates.Where(n => visibleattestStates.Contains(n.AttestStateId));
                            if (x.Any())
                            {
                                itemsWithCorrectAttestState.Add(item);
                            }
                        }
                        else if (visibleattestStatesContainsinitialAttestStateId)
                        {
                            itemsWithCorrectAttestState.Add(item);
                        }
                    }
                }
            }

            return itemsWithCorrectAttestState == null ? items : itemsWithCorrectAttestState;
        }

        private void AddInternalAccounts(IEnumerable<CustomerInvoiceGridDTO> items, int actorCompanyId)
        {
            List<Account> accounts = AccountManager.GetAccounts(actorCompanyId);
            foreach (var item in items)
            {
                // Preset
                item.DefaultDim2AccountName = "";
                item.DefaultDim3AccountName = "";
                item.DefaultDim4AccountName = "";
                item.DefaultDim5AccountName = "";
                item.DefaultDim6AccountName = "";

                bool accountAdded = false;
                if (item.DefaultDim2AccountId.GetValueOrDefault() > 0)
                {
                    var account = accounts.FirstOrDefault(a => a.AccountId == item.DefaultDim2AccountId.Value);
                    if (account != null)
                    {
                        item.DefaultDim2AccountName = account.AccountNr + " " + account.Name;
                        item.DefaultDimAccountNames += item.DefaultDim2AccountName;
                        accountAdded = true;
                    }
                }

                if (item.DefaultDim3AccountId.GetValueOrDefault() > 0)
                {
                    var account = accounts.FirstOrDefault(a => a.AccountId == item.DefaultDim3AccountId.Value);
                    if (account != null)
                    {
                        item.DefaultDim3AccountName = account.AccountNr + " " + account.Name;
                        item.DefaultDimAccountNames += accountAdded ? ", " + item.DefaultDim3AccountName : item.DefaultDim3AccountName;
                        accountAdded = true;
                    }
                }

                if (item.DefaultDim4AccountId.GetValueOrDefault() > 0)
                {
                    var account = accounts.FirstOrDefault(a => a.AccountId == item.DefaultDim4AccountId.Value);
                    if (account != null)
                    {
                        item.DefaultDim4AccountName = account.AccountNr + " " + account.Name;
                        item.DefaultDimAccountNames += accountAdded ? ", " + item.DefaultDim4AccountName : item.DefaultDim4AccountName;
                        accountAdded = true;
                    }
                }

                if (item.DefaultDim5AccountId.GetValueOrDefault() > 0)
                {
                    var account = accounts.FirstOrDefault(a => a.AccountId == item.DefaultDim5AccountId.Value);
                    if (account != null)
                    {
                        item.DefaultDim5AccountName = account.AccountNr + " " + account.Name;
                        item.DefaultDimAccountNames += accountAdded ? ", " + item.DefaultDim5AccountName : item.DefaultDim5AccountName;
                        accountAdded = true;
                    }
                }

                if (item.DefaultDim6AccountId.GetValueOrDefault() > 0)
                {
                    var account = accounts.FirstOrDefault(a => a.AccountId == item.DefaultDim6AccountId.Value);
                    if (account != null)
                    {
                        item.DefaultDim6AccountName = account.AccountNr + " " + account.Name;
                        item.DefaultDimAccountNames += accountAdded ? ", " + item.DefaultDim6AccountName : item.DefaultDim6AccountName;
                    }
                }
            }
        }

        #endregion

        #region Filter status classification

        #region Help-methods

        public bool FilterOnDate(DateTime dateToFilterOn, string type, DateTime? fromDate, DateTime? toDate)
        {
            //Filter
            switch (type)
            {
                case "equals":
                    return dateToFilterOn == fromDate;
                case "greatherThan":
                    return dateToFilterOn > fromDate;
                case "lessThan":
                    return dateToFilterOn < fromDate;
                case "notEqual":
                    return dateToFilterOn != fromDate;
                case "inRange":
                    return fromDate <= dateToFilterOn && toDate >= dateToFilterOn;
                default:
                    return false;
            }
        }

        public bool FilterOnAmount(decimal amountToFilterOn, string type, decimal compareAmount)
        {
            //Filter
            switch (type)
            {
                case "equals":
                    return amountToFilterOn == compareAmount;
                case "notEqual":
                    return amountToFilterOn != compareAmount;
                case "startsWith":
                    return amountToFilterOn.ToString().StartsWith(compareAmount.ToString());
                case "endsWith":
                    return amountToFilterOn.ToString().EndsWith(compareAmount.ToString());
                case "contains":
                    return amountToFilterOn.ToString().Contains(compareAmount.ToString());
                case "notContains":
                    return !amountToFilterOn.ToString().Contains(compareAmount.ToString());
                default:
                    return false;
            }
        }
        public List<OriginUserView> GetOriginUsers(int actorCompanyId, int? invoiceId = null)
        {
            using (var entities = new CompEntities())
            {
                return GetOriginUsers(entities, actorCompanyId, invoiceId);
            }
        }

        public List<OriginUserView> GetOriginUsers(CompEntities entities, int actorCompanyId, int? invoiceId = null)
        {

            IQueryable<OriginUserView> originUsers = (from view in entities.OriginUserView
                                                      where view.ActorCompanyId == actorCompanyId
                                                      orderby view.Main, view.Name
                                                      select view);
            if (invoiceId.HasValue)
                originUsers = originUsers.Where(i => i.OriginId == invoiceId);

            return originUsers.ToList();
        }

        public OriginUser GetOriginUser(int invoiceId, int userId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetOriginUser(entities, invoiceId, userId);
        }

        public OriginUser GetOriginUser(CompEntities entities, int invoiceId, int userId)
        {
            return (from ou in entities.OriginUser
                    where ou.OriginId == invoiceId && ou.UserId == userId
                    select ou).FirstOrDefault();
        }

        public ActionResult UpdateOrderReadyState(int orderId, int userId, bool clearState)
        {
            var result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                var originUser = GetOriginUser(entities, orderId, userId);

                if (originUser == null)
                {
                    return new ActionResult((int)ActionResultSelect.EntityNotFound, "OriginUser");
                }
                else if (!clearState || (originUser.ReadyDate.HasValue && clearState))
                {
                    originUser.ReadyDate = originUser.ReadyDate.HasValue ? (DateTime?)null : DateTime.Now;
                    entities.SaveChanges();
                    result.BooleanValue = originUser.ReadyDate.HasValue;
                }
            }

            return result;
        }

        public ActionResult ClearReadyState(int orderId, List<int> userIds, int actorCompanyId)
        {
            var result = new ActionResult();
            foreach (var userId in userIds)
            {
                UpdateOrderReadyState(orderId, userId, true);
            }

            return result;
        }

        public ActionResult SendReminderForReadyState(int currentUserId, int orderId, List<int> userIds, int actorCompanyId, string orderNr)
        {
            var result = new ActionResult();
            User user = UserManager.GetUser(currentUserId);

            List<MessageRecipientDTO> receivers = new List<MessageRecipientDTO>();

            foreach (var userId in userIds)
            {
                receivers.Add(new MessageRecipientDTO() { UserId = userId });
            }

            var text = GetText(7442, "Påminnelse om att slutföra arbetet och sätta din klarstatus (tumme upp) på order:") + orderNr;
            var message = new MessageEditDTO
            {
                ActorCompanyId = actorCompanyId,
                LicenseId = user.LicenseId,
                Entity = SoeEntityType.Order,
                RecordId = orderId,
                Created = DateTime.Now,
                SentDate = DateTime.Now,
                SenderUserId = user.UserId,
                SenderName = user.Name,
                Subject = text,
                Text = text,
                AnswerType = XEMailAnswerType.None,
                MessagePriority = TermGroup_MessagePriority.Normal,
                MessageType = TermGroup_MessageType.UserInitiated,
                MessageDeliveryType = TermGroup_MessageDeliveryType.XEmail,
                MessageTextType = TermGroup_MessageTextType.HTML,
                Recievers = receivers
            };

            CommunicationManager.SendXEMail(message, actorCompanyId, base.RoleId, user.UserId);

            return result;
        }

        public List<CustomerInvoiceRowAttestStateView> GetAttestStatesForCompanyAndInvoices(CompEntities entities, int actorCompanyId, List<int> customerInvoices)
        {
            if (customerInvoices.Count < 1000)
                return (from view in entities.CustomerInvoiceRowAttestStateView
                        where view.ActorCompanyId == actorCompanyId &&
                        customerInvoices.Contains(view.InvoiceId)
                        select view).ToList();
            else
                return (from view in entities.CustomerInvoiceRowAttestStateView
                        where view.ActorCompanyId == actorCompanyId
                        select view).ToList().Where(i => customerInvoices.Contains(i.InvoiceId)).ToList(); //.ToList().Where to not overload sql since it dosent like big in ( statements
        }

        public List<CustomerInvoiceRowAttestStateView> GetAttestStatesForCustomerInvoice(CompEntities entities, int actorCompanyId, int invoiceId)
        {
            return (from view in entities.CustomerInvoiceRowAttestStateView
                    where view.ActorCompanyId == actorCompanyId &&
                    view.InvoiceId == invoiceId
                    orderby view.Sort
                    select view).ToList();
        }

        #endregion

        #endregion

        #endregion

        #region Offer - Order - Invoice

        #region From Contract

        public ActionResult CreateOrderFromContracts(List<CustomerInvoiceGridDTO> items, bool setStatusToOrigin, int actorCompanyId)
        {
            return CreateOfferOrderInvoiceFromType_v2(items, SoeOriginStatusChange.Billing_ContractToOrder, false, setStatusToOrigin, actorCompanyId);
        }

        public ActionResult CreateServiceOrderFromContracts(List<CustomerInvoiceGridDTO> items, bool setStatusToOrigin, int actorCompanyId)
        {
            return CreateOfferOrderInvoiceFromType_v2(items, SoeOriginStatusChange.Billing_ContractToServiceOrder, false, setStatusToOrigin, actorCompanyId);
        }

        public ActionResult CreateInvoiceFromContracts(List<CustomerInvoiceGridDTO> items, bool mergeInvoices, bool setStatusToOrigin, int actorCompanyId)
        {
            return CreateOfferOrderInvoiceFromType_v2(items, SoeOriginStatusChange.Billing_ContractToInvoice, mergeInvoices, setStatusToOrigin, actorCompanyId);
        }

        #endregion

        #region From Offer

        public ActionResult CreateOrderFromOffers(List<CustomerInvoiceGridDTO> items, bool setStatusToOrigin, int actorCompanyId)
        {
            return CreateOfferOrderInvoiceFromType_v2(items, SoeOriginStatusChange.Billing_OfferToOrder, false, setStatusToOrigin, actorCompanyId);
        }
        public ActionResult CreateInvoiceFromOffers(List<CustomerInvoiceGridDTO> items, bool mergeInvoices, bool setStatusToOrigin, int actorCompanyId)
        {
            return CreateOfferOrderInvoiceFromType_v2(items, SoeOriginStatusChange.Billing_OfferToInvoice, mergeInvoices, setStatusToOrigin, actorCompanyId);
        }

        #endregion

        #region From Order


        public ActionResult CreateInvoiceFromOrder(List<CustomerInvoiceGridDTO> items, bool mergeInvoices, bool setStatusToOrigin, int actorCompanyId, bool keepOrderOpen = false, bool checkPartialInvoicing = false, bool copyTransferredContractRows = false)
        {
            return CreateOfferOrderInvoiceFromType_v2(items, SoeOriginStatusChange.Billing_OrderToInvoice, mergeInvoices, setStatusToOrigin, actorCompanyId, keepOrderOpen, checkPartialInvoicing, copyTransferredContractRows);
        }

        public ActionResult CreateInvoiceFromOrders(List<int> ids, bool mergeInvoices, bool setStatusToOrigin, int actorCompanyId, bool keepOrderOpen = false, bool checkPartialInvoicing = false, bool finalInvoicingDeductLift = false, bool copyTransferredContractRows = false)
        {
            var items = new List<ChangeStatusGridViewDTO>();
            foreach (var id in ids)
            {
                items.Add(new ChangeStatusGridViewDTO() { InvoiceId = id });
            }
            return CreateOfferOrderInvoiceFromType(items, SoeOriginStatusChange.Billing_OrderToInvoice, mergeInvoices, setStatusToOrigin, actorCompanyId, keepOrderOpen, checkPartialInvoicing, finalInvoicingDeductLift, copyTransferredContractRows);
        }

        #endregion

        #region Help-methods

        private ActionResult CreateOfferOrderInvoiceFromType(List<ChangeStatusGridViewDTO> items, SoeOriginStatusChange originStatusChange, bool merge, bool setStatusToOrigin, int actorCompanyId, bool keepOrderOpen = false, bool checkPartialInvoicing = false, bool finalInvoicingDeductLift = false, bool copyTransferredContractRows = false)
        {
            ActionResult result = new ActionResult(false);

            if (items == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ChangeStatusGridView");

            List<string> invalidPrototypes = new List<string>();
            List<CustomerInvoice> clones = new List<CustomerInvoice>();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Init

                        InitializeAttestStateIds(entities, actorCompanyId);

                        #endregion

                        #region Prereq

                        int fixedPriceProductId = 0;
                        int guaranteeProductId = 0;
                        int fixedPriceKeepPricesProductId = 0;

                        #region Settings

                        bool useOurReferenceOnMerge = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingSetOurReferenceOnMergedInvoices, 0, actorCompanyId, 0, true);

                        #endregion

                        #region Cent rounding

                        bool useCentRounding = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseCentRounding, 0, actorCompanyId, 0);

                        #endregion

                        #region AttestStates

                        CompanySettingType companySettingType = CompanySettingType.Unknown;
                        TermGroup_AttestEntity entityFrom = TermGroup_AttestEntity.Unknown;
                        TermGroup_AttestEntity entityTo = TermGroup_AttestEntity.Unknown;
                        SoeOriginType originTypeTo = SoeOriginType.None;
                        SoeEntityType entityTypeFrom = SoeEntityType.None;
                        SoeEntityType entityTypeTo = SoeEntityType.None;
                        AttestState attestStateOrderInitial = null;
                        SoeEntityImageType imageType = SoeEntityImageType.Unknown;

                        switch (originStatusChange)
                        {
                            case SoeOriginStatusChange.Billing_OfferToOrder:
                                companySettingType = CompanySettingType.BillingStatusTransferredOfferToOrder;
                                entityFrom = TermGroup_AttestEntity.Offer;
                                entityTo = TermGroup_AttestEntity.Order;
                                originTypeTo = SoeOriginType.Order;
                                entityTypeFrom = SoeEntityType.Offer;
                                entityTypeTo = SoeEntityType.Order;
                                imageType = SoeEntityImageType.OrderInvoice;
                                break;
                            case SoeOriginStatusChange.Billing_OfferToInvoice:
                                companySettingType = CompanySettingType.BillingStatusTransferredOfferToInvoice;
                                entityFrom = TermGroup_AttestEntity.Offer;
                                entityTo = TermGroup_AttestEntity.InvoiceTime;
                                originTypeTo = SoeOriginType.CustomerInvoice;
                                fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                                guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, actorCompanyId, 0);
                                fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);
                                entityTypeFrom = SoeEntityType.Offer;
                                entityTypeTo = SoeEntityType.CustomerInvoice;
                                imageType = SoeEntityImageType.OrderInvoice;
                                break;
                            case SoeOriginStatusChange.Billing_OrderToInvoice:
                                companySettingType = CompanySettingType.BillingStatusTransferredOrderToInvoice;
                                entityFrom = TermGroup_AttestEntity.Order;
                                entityTo = TermGroup_AttestEntity.InvoiceTime;
                                originTypeTo = SoeOriginType.CustomerInvoice;
                                fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                                guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, actorCompanyId, 0);
                                fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);
                                entityTypeFrom = SoeEntityType.Order;
                                entityTypeTo = SoeEntityType.CustomerInvoice;
                                imageType = SoeEntityImageType.OrderInvoice;
                                break;
                            case SoeOriginStatusChange.Billing_ContractToOrder:
                                companySettingType = CompanySettingType.BillingStatusTransferredOfferToOrder;
                                entityTo = TermGroup_AttestEntity.Order;
                                originTypeTo = SoeOriginType.Order;
                                entityTypeFrom = SoeEntityType.Contract;
                                entityTypeTo = SoeEntityType.Order;
                                imageType = SoeEntityImageType.OrderInvoice;
                                break;
                            case SoeOriginStatusChange.Billing_ContractToInvoice:
                                companySettingType = CompanySettingType.BillingStatusTransferredOfferToInvoice;
                                entityTo = TermGroup_AttestEntity.InvoiceTime;
                                originTypeTo = SoeOriginType.CustomerInvoice;
                                entityTypeFrom = SoeEntityType.Contract;
                                entityTypeTo = SoeEntityType.CustomerInvoice;
                                imageType = SoeEntityImageType.OrderInvoice;
                                break;
                        }

                        //Initial status
                        if (originTypeTo == SoeOriginType.Order)
                        {
                            attestStateOrderInitial = AttestManager.GetInitialAttestState(entities, actorCompanyId, entityTo);
                            if (attestStateOrderInitial == null)
                                return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestStateInitial);
                        }
                        else if (entityFrom == TermGroup_AttestEntity.Order)
                        {
                            attestStateOrderInitial = AttestManager.GetInitialAttestState(entities, actorCompanyId, entityFrom);
                            if (attestStateOrderInitial == null)
                                return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestStateInitial);
                        }


                        AttestState attestStateTransferred = null;

                        //We dont set transferred status on contract rows
                        if (originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                        {
                            //Transferred status
                            int attestStateTransferredId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)companySettingType, 0, actorCompanyId, 0);
                            attestStateTransferred = AttestManager.GetAttestState(entities, attestStateTransferredId);
                            if (attestStateTransferred == null)
                                return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestStateTransferred);
                        }

                        #endregion

                        #region AttestTransitions

                        //AttestTransitions not used for contracts
                        List<AttestTransition> attestTransitions = null;
                        if (originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                        {
                            attestTransitions = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, base.UserId, actorCompanyId, entity: entityFrom);
                            if (attestTransitions.IsNullOrEmpty())
                                return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestTransitions);
                        }

                        #endregion

                        #endregion

                        #region Add prototypes to Dictionary sorted on Actor

                        Dictionary<int, List<CustomerInvoice>> prototypeDict = new Dictionary<int, List<CustomerInvoice>>();
                        int? vatType = null;
                        bool setContractInvoiceDate = false;

                        foreach (var item in items)
                        {
                            var target = GetCustomerInvoice(entities, item.InvoiceId, loadOrigin: true, loadActor: true, loadPaymentCondition: true, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadIntrastatTransaction: true);
                            if (target == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");
                            if (!target.ActorId.HasValue)
                                continue;

                            #region Check blocked

                            if (originTypeTo == SoeOriginType.CustomerInvoice)
                            {
                                var blocked = CustomerManager.IsCustomerBlocked(entities, target.ActorId, target.Actor);
                                if (blocked)
                                    return new ActionResult((int)ActionResultSave.CustomerIsBlocked);
                            }

                            #endregion

                            #region Check VatType (merge only)

                            if (merge)
                            {
                                //All targets must have same VatType
                                if (!vatType.HasValue)
                                {
                                    vatType = target.VatType;
                                }
                                else
                                {
                                    if (vatType != target.VatType)
                                        return new ActionResult((int)ActionResultSave.TransferOfferOrderHasDifferentVatTypes);
                                }
                            }

                            #endregion

                            #region Validate status

                            switch (originStatusChange)
                            {
                                case SoeOriginStatusChange.Billing_OfferToOrder:
                                    //Must be Origin or PartlyOrder
                                    if (target.Status != (int)SoeOriginStatus.Origin && target.Status != (int)SoeOriginStatus.OfferPartlyOrder)
                                        continue;
                                    break;
                                case SoeOriginStatusChange.Billing_OfferToInvoice:
                                    //Must be Origin or PartlyInvoice
                                    if (target.Status != (int)SoeOriginStatus.Origin && target.Status != (int)SoeOriginStatus.OfferPartlyInvoice)
                                        continue;
                                    break;
                                case SoeOriginStatusChange.Billing_OrderToInvoice:
                                    //Must be Origin or PartlyInvoice
                                    if (target.Status != (int)SoeOriginStatus.Origin && target.Status != (int)SoeOriginStatus.OrderPartlyInvoice)
                                        continue;
                                    break;
                                case SoeOriginStatusChange.Billing_ContractToOrder:
                                case SoeOriginStatusChange.Billing_ContractToInvoice:
                                    if (item.InvoiceDate.HasValue)
                                    {
                                        setContractInvoiceDate = true;
                                        target.InvoiceDate = item.InvoiceDate;
                                    }
                                    //Must be Origin
                                    if (target.Status != (int)SoeOriginStatus.Origin)
                                        continue;
                                    break;
                            }

                            #endregion

                            #region PriceListType Inclusive VAT

                            if (!target.PriceListTypeReference.IsLoaded)
                                target.PriceListTypeReference.Load();

                            // Set virtual field to be able to read it later
                            if (target.PriceListType != null)
                                target.PriceListTypeInclusiveVat = target.PriceListType.InclusiveVat;

                            #endregion

                            //Add prototype to Dictionary
                            if (prototypeDict.ContainsKey(target.ActorId.Value))
                                prototypeDict[target.ActorId.Value].Add(target);
                            else
                                prototypeDict.Add(target.ActorId.Value, new List<CustomerInvoice>() { target });


                        }

                        #endregion

                        bool saveSeqNumber = prototypeDict.Count > 1;
                        int invalidatedPrototypes = 0;
                        int validatedPrototypes = 0;

                        foreach (var prototypeList in prototypeDict)
                        {
                            #region Init

                            CustomerInvoice clone = null;

                            int rowNr = 0;
                            int accountRowNr = 0;
                            int prototypeCounter = 0;
                            bool invoiceFeeAdded = false;

                            List<CustomerInvoice> prototypes = null;
                            if (merge)
                            {
                                prototypes = (from t in prototypeList.Value
                                              orderby t.SeqNr
                                              select t).ToList();
                            }
                            else
                            {
                                prototypes = (from t in prototypeList.Value
                                              orderby t.Modified descending, t.InvoiceDate descending
                                              select t).ToList();
                            }

                            #endregion

                            foreach (var prototype in prototypes)
                            {
                                bool recalculatePrototype = false;

                                #region Init

                                bool prototypeHasInvalidatedRows = false;
                                bool isMaster = (!merge || clone == null); //Decides if new clone should be created
                                bool hasValidProductRows = false; //Used for validation
                                bool hasValidAccounting = true; //Used for validation
                                Dictionary<int, bool> prototypeRowsValidationDict = new Dictionary<int, bool>(); //Used for validation
                                Dictionary<int, CustomerInvoiceRow> prototypeRowDict = new Dictionary<int, CustomerInvoiceRow>(); //Used for parent rows

                                int nextContractPeriodYear = 0;
                                int nextContractPeriodValue = 0;
                                DateTime? nextContractPeriodDate = null;
                                int? numberOfDaysInPeriod = null;

                                #endregion

                                #region Validate prototype accounting rows

                                if (ValidateCustomerInvoiceAccountingRowsDiff(prototype))
                                {
                                    // Hard return on unbalanced rows
                                    return new ActionResult((int)ActionResultSave.HasUnbalancedAccountingRows, GetText(434, (int)TermGroup.ChangeStatusGrid, "Kontrollera konteringsraderna på fakturan") + ": " + prototype.InvoiceNr);
                                }

                                #endregion

                                #region Prereq

                                // Check if row of type ProductFlatPriceKeepPrices 
                                bool hasFlatPriceKeepPricesRowsToTransfer = false;
                                var fixedPricesRows = prototype.CustomerInvoiceRow.Where(r => r.ProductId == fixedPriceKeepPricesProductId && !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value)));

                                if (fixedPricesRows.Any())
                                {
                                    foreach (CustomerInvoiceRow row in fixedPricesRows)
                                    {
                                        if (IsCustomerInvoiceRowAttestStateValid(row, attestStateTransferred, attestTransitions))
                                        {
                                            hasFlatPriceKeepPricesRowsToTransfer = true;
                                        }
                                        else
                                        {
                                            hasFlatPriceKeepPricesRowsToTransfer = false;
                                            break;
                                        }
                                    }
                                }

                                var prototypeRows = (from r in prototype.CustomerInvoiceRow
                                                     where r.State == (int)SoeEntityState.Active &&
                                                     (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer || !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))) &&
                                                     !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OfferClosedIds.Contains(r.AttestStateId.Value))
                                                     orderby r.RowNr
                                                     select r).ToList();

                                //Validate which rows that should be transferred
                                foreach (var prototypeRow in prototypeRows)
                                {
                                    bool overrideValidation = false;

                                    // Calculate centrounding later
                                    if (prototypeRow.IsCentRoundingRow)
                                        continue;

                                    if (prototypeRow.IsInvoiceFeeRow)
                                    {
                                        if (invoiceFeeAdded)
                                            continue;
                                        else
                                            invoiceFeeAdded = true;
                                    }

                                    //Only transfer rows with product
                                    if (prototypeRow.Type == (int)SoeInvoiceRowType.AccountingRow && prototypeRow.Product == null)
                                        continue;

                                    if ((finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer) && prototypeRow.AttestStateId.HasValue && prototypeRow.AttestStateId.Value == attestStateTransferred.AttestStateId && prototypeRow.Product != null)
                                    {
                                        InvoiceProduct product = prototypeRow.ProductId.HasValue ? ProductManager.GetInvoiceProduct(entities, prototypeRow.ProductId.Value) : null;
                                        if (product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                            overrideValidation = true;
                                        else
                                            continue;
                                    }
                                    else
                                    {
                                        //Already transferred (not used for invoice fee, freight and contracts)
                                        if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                                        {
                                            if (prototypeRow.AttestStateId == attestStateTransferred.AttestStateId)
                                                continue;
                                        }
                                        else
                                        {
                                            if (hasFlatPriceKeepPricesRowsToTransfer && prototypeRow.ProductId == fixedPriceKeepPricesProductId && !IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions))
                                            {
                                                hasFlatPriceKeepPricesRowsToTransfer = false;
                                                overrideValidation = false;
                                            }
                                        }
                                    }

                                    // If guaranteeproduct, all lift articales must have transfered first
                                    /*if (prototypeRow.ProductId == guaranteeProductId && originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice)
                                    {
                                        foreach (var item in this.GetCustomerInvoiceRows(entities, prototype.InvoiceId, true))
                                        {
                                            var p = item.Product as InvoiceProduct;
                                            if (p == null)
                                                continue;

                                            if (p.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift &&
                                                p.GuaranteePercentage > 0 &&
                                                attestStateOrderInitial != null &&
                                                item.AttestStateId == attestStateOrderInitial.AttestStateId)
                                            {
                                                continue;
                                            }
                                        }
                                    }
                                    */

                                    //Validation check: Only rows with correct state. FixedPriceOrders are valid when all flat-price rows are valid
                                    //Not used for contracts, invoice fee or freight amount rows
                                    bool isValid = true;
                                    if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                                    {
                                        isValid = overrideValidation ? true : IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions);
                                        if (isValid)
                                            hasValidProductRows = true; //Has at least one valid product row (i.e. not IsInvoiceFee or IsFreightAmountRow). Prevent empty invoices with only InvoiceFee or Freight
                                    }
                                    else if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice))
                                        hasValidProductRows = true;

                                    prototypeRowsValidationDict.Add(prototypeRow.CustomerInvoiceRowId, isValid);
                                }

                                //Must have at least one row that has valid state
                                int noOfValidatedPrototypeRows = prototypeRowsValidationDict.Count(i => i.Value);
                                if (noOfValidatedPrototypeRows > 0 && hasValidProductRows && hasValidAccounting)
                                {
                                    validatedPrototypes++;
                                }
                                else
                                {
                                    invalidatedPrototypes++;
                                    continue;
                                }

                                #endregion

                                #region Process prototype

                                prototypeCounter++;

                                // Contract properties
                                TermGroup_ContractGroupPriceManagement priceManagement = TermGroup_ContractGroupPriceManagement.Fixed;
                                string invoiceTextRow = null;

                                if (isMaster)
                                {
                                    #region Master

                                    //Reset counters
                                    rowNr = 0;
                                    accountRowNr = 1; // Claim row will get number 1

                                    #region CustomerInvoice

                                    clone = CopyCustomerInvoice(entities, prototype, originTypeTo, merge);
                                    clone.PrintTimeReport = prototype.PrintTimeReport;
                                    clone.IncludeOnlyInvoicedTime = prototype.IncludeOnlyInvoicedTime;

                                    // Set order number
                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice)
                                        clone.OrderNumbers = prototype.InvoiceNr;

                                    #region Reset values

                                    clone.InvoiceNr = "";
                                    clone.SeqNr = null;
                                    clone.PaidAmount = 0;
                                    clone.PaidAmountCurrency = 0;
                                    clone.FullyPayed = false;
                                    clone.BillingInvoicePrinted = false;
                                    clone.RemainingAmount = 0;
                                    clone.OCR = "";

                                    // Order planning
                                    clone.ShiftTypeId = null;
                                    clone.PlannedStartDate = null;
                                    clone.PlannedStopDate = null;
                                    clone.EstimatedTime = 0;
                                    clone.RemainingTime = 0;
                                    clone.KeepAsPlanned = false;
                                    clone.Priority = null;

                                    #endregion

                                    #region Set new values

                                    //Status
                                    if (setStatusToOrigin)
                                        clone.Origin.Status = (int)SoeOriginStatus.Origin;

                                    //OrderDate
                                    clone.OrderDate = prototype.OrderDate.HasValue ? prototype.OrderDate.Value : prototype.InvoiceDate;
                                    if (setContractInvoiceDate && (originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder))
                                        clone.InvoiceDate = prototype.InvoiceDate;
                                    else
                                        clone.InvoiceDate = (setStatusToOrigin && (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice)) ? DateTime.Now.Date : (DateTime?)null;

                                    //VoucherDate
                                    clone.VoucherDate = clone.InvoiceDate.HasValue ? clone.InvoiceDate.Value : (DateTime?)null;

                                    //DueDate
                                    clone.DueDate = clone.InvoiceDate.HasValue ? clone.InvoiceDate.Value : (DateTime?)null;
                                    if (prototype.PaymentCondition != null && clone.DueDate.HasValue)
                                    {
                                        if (prototype.PaymentCondition.StartOfNextMonth)
                                        {
                                            clone.DueDate = CalendarUtility.GetEndOfMonth(clone.DueDate.Value).AddDays(1).Date;
                                        }
                                        clone.DueDate = clone.DueDate.Value.AddDays(prototype.PaymentCondition.Days);
                                    }

                                    #endregion

                                    #region Contract values

                                    if (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice)
                                    {
                                        if (!prototype.ContractGroupReference.IsLoaded)
                                            prototype.ContractGroupReference.Load();

                                        TermGroup_ContractGroupPeriod period = (TermGroup_ContractGroupPeriod)prototype.ContractGroup.Period;
                                        Tuple<int, int> nextPeriod = CalendarUtility.CalculateNextPeriod(period, prototype.ContractGroup.Interval, prototype.NextContractPeriodYear, prototype.NextContractPeriodValue);
                                        nextContractPeriodYear = nextPeriod.Item1;
                                        nextContractPeriodValue = nextPeriod.Item2;
                                        nextContractPeriodDate = CalendarUtility.ConvertContractPeriodToDate(period, prototype.InvoiceDate.Value, nextContractPeriodYear, nextContractPeriodValue, prototype.ContractGroup.DayInMonth);

                                        if (prototype.NextContractPeriodDate != null && nextContractPeriodDate != null)
                                        {
                                            DateTime currentContractPeriodDate = CalendarUtility.ConvertContractPeriodToDate(period, prototype.NextContractPeriodDate.Value, prototype.NextContractPeriodYear, prototype.NextContractPeriodValue, prototype.ContractGroup.DayInMonth);

                                            numberOfDaysInPeriod = (nextContractPeriodDate.Value - currentContractPeriodDate).Days;
                                        }

                                        clone.ContractGroup = null;
                                        clone.NextContractPeriodYear = 0;
                                        clone.NextContractPeriodValue = 0;

                                        //Make sure ContractGroup is loaded
                                        if (!prototype.ContractGroupReference.IsLoaded)
                                            prototype.ContractGroupReference.Load();

                                        // Get values from contract group
                                        if (prototype.ContractGroup != null)
                                        {
                                            priceManagement = (TermGroup_ContractGroupPriceManagement)prototype.ContractGroup.PriceManagement;

                                            if (!String.IsNullOrEmpty(prototype.ContractGroup.InvoiceText))
                                                clone.InvoiceText = EntityUtil.ParseEntityTaggedText<CustomerInvoice>(prototype, prototype.ContractGroup.InvoiceText);

                                            if (!String.IsNullOrEmpty(prototype.ContractGroup.InvoiceTextRow))
                                                invoiceTextRow = EntityUtil.ParseEntityTaggedText<CustomerInvoice>(prototype, prototype.ContractGroup.InvoiceTextRow);
                                        }
                                    }
                                    /*else if(originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice)
                                    {
                                        var text = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.BillingInvoiceText, base.UserId, base.ActorCompanyId);
                                        if (text != String.Empty)
                                            clone.InvoiceText = text;
                                    }*/

                                    #endregion

                                    #region Sequence number

                                    if (originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder ||
                                        originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder ||
                                        ((originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice && setStatusToOrigin) || (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && setStatusToOrigin)))
                                    {
                                        // Get next sequence number
                                        int seqNbr = clone.SeqNr.HasValue ? clone.SeqNr.Value : 0;
                                        string entityName = String.Empty;
                                        int startNbr = 0;
                                        int invoiceNumberLength = 0;
                                        GetNextSequenceNumber(entities, (SoeOriginType)clone.Origin.Type, (SoeOriginStatus)clone.Origin.Status, (TermGroup_BillingType)clone.BillingType, actorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, saveSeqNumber);
                                        clone.SeqNr = seqNbr;

                                        #region Validate Seqnr

                                        //string entityNameToValidate = Enum.GetName(typeof(SoeOriginType), clone.Origin.Type);
                                        //int latestSeqnr = SequenceNumberManager.GetLastUsedSequenceNumber(entities, ActorCompanyId, entityNameToValidate);

                                        //if (latestSeqnr != clone.SeqNr)
                                        //{
                                        //    result.Success = false;
                                        //    result.ErrorMessage = "Ett fel inträffade, försök igen!";
                                        //    result.IntegerValue = 0;

                                        //    base.LogWarning("Nummerserien är felaktig");

                                        //    return result;
                                        //}

                                        #endregion

                                        // Set invoice number to same as sequence number (padded to a specified number of digits)
                                        if (String.IsNullOrEmpty(clone.InvoiceNr))
                                            clone.InvoiceNr = seqNbr.ToString().PadLeft(invoiceNumberLength, '0');
                                        //In Finland and Norway we need to create OCR again, because otherwise OCR is formatted from ordernumber, cannot copy ocr from order.
                                        Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                                        if (company != null && company.SysCountryId != null && company.SysCountryId == (int)TermGroup_Country.FI)
                                        {
                                            string tmpReference = prototype.Actor.Customer.CustomerNr.ToString() + "0000" + clone.InvoiceNr.ToString();
                                            if (prototype.InvoiceNr != null && prototype.Actor.Customer.CustomerNr != null)
                                            {
                                                if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, actorCompanyId, 0))
                                                {
                                                    clone.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                                }
                                                else
                                                {
                                                    clone.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                                }
                                            }
                                            else
                                            {
                                                string errorCheck = "";
                                                if (prototype.InvoiceNr == null) errorCheck += "A=null";
                                                if (prototype.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                                clone.OCR = "Virhe(1):" + errorCheck;
                                            }
                                        }
                                        else if (company != null && company.SysCountryId != null && company.SysCountryId == (int)TermGroup_Country.NO)
                                        {
                                            clone.OCR = InvoiceUtility.GetNorwegianKIDNumber(clone.InvoiceNr.ToString(), prototype.Actor.Customer.CustomerNr.ToString(), clone.InvoiceDate.HasValue ? clone.InvoiceDate.Value : (DateTime)prototype.InvoiceDate, 0);
                                        }
                                        else
                                        {
                                            //Sweden and the rest
                                            //Since we don't have invoiceid on the not yet created invoice, we use the id from the order. Will still be unique.
                                            if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormReferenceNumberToOCR, 0, actorCompanyId, 0))
                                            {
                                                clone.OCR = InvoiceUtility.GetSwedishOCRNumber(prototype.InvoiceId.ToString() + clone.SeqNr);
                                            }
                                            else
                                            {
                                                clone.OCR = string.Empty;
                                            }
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region OriginUser

                                    foreach (var prototypeOriginUser in prototype.Origin.OriginUser.Where(o => o.State == (int)SoeEntityState.Active))
                                    {
                                        if (!prototypeOriginUser.UserReference.IsLoaded)
                                            prototypeOriginUser.UserReference.Load();
                                        if (!prototypeOriginUser.RoleReference.IsLoaded)
                                            prototypeOriginUser.RoleReference.Load();

                                        OriginUser cloneOriginUser = new OriginUser
                                        {
                                            Origin = clone.Origin,
                                            User = prototypeOriginUser.User,
                                            Role = prototypeOriginUser.Role,
                                            Main = prototypeOriginUser.Main,
                                        };
                                        SetCreatedProperties(cloneOriginUser);
                                        clone.Origin.OriginUser.Add(cloneOriginUser);
                                    }

                                    #endregion

                                    #endregion
                                }
                                else
                                {
                                    // Set order number
                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice)
                                        clone.OrderNumbers += ", " + prototype.InvoiceNr;
                                }

                                #region OriginInvoiceMapping

                                //Add prototype to clone's mapping
                                OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                                {
                                    Type = (int)GetOriginInvoiceMappingType(prototype),

                                    //Set references
                                    Origin = prototype.Origin,
                                };
                                clone.OriginInvoiceMapping.Add(oimap);

                                #endregion

                                #endregion

                                #region Process prototype rows

                                #region InvoiceTextRow - ContractGroup

                                if ((originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice) && !String.IsNullOrEmpty(invoiceTextRow))
                                {
                                    rowNr++;

                                    // Insert text row at beginning
                                    clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                    {
                                        RowNr = rowNr,
                                        Type = (int)SoeInvoiceRowType.TextRow,
                                        Text = invoiceTextRow,
                                    });
                                }

                                #endregion

                                #region InvoiceTextRow - Merge information

                                if (merge)
                                {
                                    rowNr++;

                                    //Add textrow, describing which offer/order/contract the subsequently rows comes from
                                    string text = "";
                                    bool addRow = true;
                                    switch (originStatusChange)
                                    {
                                        case SoeOriginStatusChange.Billing_OfferToOrder:
                                        case SoeOriginStatusChange.Billing_OfferToInvoice:
                                            text = GetText(5346, "Från offert") + " " + prototype.InvoiceNr;
                                            break;
                                        case SoeOriginStatusChange.Billing_OrderToInvoice:
                                            var useExtendedInfo = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingOrderMergeOrderWithExtendedInfo, 0, actorCompanyId, 0);
                                            if (useExtendedInfo)
                                            {
                                                #region ExtendedInfo
                                                addRow = false;

                                                if (prototypeCounter > 1)
                                                {
                                                    // Not the first so add empty row to seperate
                                                    clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                    {
                                                        RowNr = rowNr++,
                                                        Type = (int)SoeInvoiceRowType.TextRow,
                                                        Text = string.Empty,
                                                    });
                                                }

                                                text = GetText(5347, "Från order") + ": " + prototype.InvoiceNr +
                                                    "          " +
                                                    (!string.IsNullOrEmpty(prototype.ReferenceOur) && useOurReferenceOnMerge ? GetText(3291, "Vår referens") + ": " + prototype.ReferenceOur + "          " : string.Empty) +
                                                    (prototype.DeliveryDate.HasValue ? GetText(9115, "Levdatum") + ": " + prototype.DeliveryDate.Value.ToShortDateString() : string.Empty);
                                                clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                {
                                                    RowNr = rowNr++,
                                                    Type = (int)SoeInvoiceRowType.TextRow,
                                                    Text = text,
                                                });

                                                if (!string.IsNullOrEmpty(prototype.ReferenceYour))
                                                {
                                                    text = GetText(9116, "Er ref") + ": " + prototype.ReferenceYour;
                                                    clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                    {
                                                        RowNr = rowNr++,
                                                        Type = (int)SoeInvoiceRowType.TextRow,
                                                        Text = text,
                                                    });
                                                }

                                                if (!string.IsNullOrEmpty(prototype.InvoiceLabel))
                                                {
                                                    text = GetText(9117, "Märkning") + ": " + prototype.InvoiceLabel;
                                                    clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                    {
                                                        RowNr = rowNr++,
                                                        Type = (int)SoeInvoiceRowType.TextRow,
                                                        Text = text,
                                                    });
                                                }
                                                #endregion
                                            }
                                            else
                                            {
                                                text = GetText(5347, "Från order") + " " + prototype.InvoiceNr;
                                            }
                                            break;
                                        case SoeOriginStatusChange.Billing_ContractToOrder:
                                        case SoeOriginStatusChange.Billing_ContractToInvoice:
                                            text = GetText(3456, "Från avtal") + " " + prototype.InvoiceNr;
                                            break;
                                    }

                                    if (addRow)
                                    {
                                        clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                        {
                                            RowNr = rowNr,
                                            Type = (int)SoeInvoiceRowType.TextRow,
                                            Text = text,
                                        });
                                    }
                                }

                                #endregion

                                foreach (CustomerInvoiceRow prototypeRow in prototypeRows)
                                {
                                    #region Prereq

                                    InvoiceProduct product = null;

                                    //Check if row exists in dict, i.e. should be transferred at all
                                    int key = prototypeRow.CustomerInvoiceRowId;
                                    if (!prototypeRowsValidationDict.ContainsKey(key))
                                        continue;

                                    //Check if row is valid, i.e. has correct state to be transferred, wich decides if the offer/order is partly or fully transferred
                                    if (prototypeRowsValidationDict[key] == false)
                                    {
                                        //FixedPriceOrders are valid when all flat-price rows are valid
                                        if (!prototype.FixedPriceOrder || (prototypeRow.ProductId.HasValue && prototypeRow.ProductId.Value == fixedPriceProductId))
                                            prototypeHasInvalidatedRows = true;

                                        continue;
                                    }

                                    if (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer)
                                    {
                                        product = prototypeRow.ProductId.HasValue ? ProductManager.GetInvoiceProduct(entities, prototypeRow.ProductId.Value) : null;
                                        if (product != null)
                                        {
                                            if (product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                                            {
                                                if (prototypeRow.AttestStateId != attestStateTransferred.AttestStateId)
                                                {
                                                    // Since lift is not previously handled and its final invoicing, set atteststate but add no row to clone
                                                    prototypeRow.AttestStateId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : (int?)null;
                                                    continue;
                                                }
                                            }
                                        }
                                    }

                                    var prototypeAccountRows = (from r in prototypeRow.CustomerInvoiceAccountRow
                                                                where r.State == (int)SoeEntityState.Active
                                                                orderby r.RowNr
                                                                select r).ToList();

                                    #endregion

                                    #region Contract and days

                                    int noOfDays = 0;
                                    bool setContractSum = false;
                                    string rowPeriodDates = String.Empty;

                                    //Check if from contract and row has to and/or from date
                                    if ((originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder) && numberOfDaysInPeriod != null)
                                    {
                                        if (prototypeRow.Date != null && prototypeRow.DateTo != null)
                                        {
                                            if (prototypeRow.Date >= nextContractPeriodDate)
                                                continue;

                                            if (prototypeRow.DateTo <= prototype.NextContractPeriodDate)
                                                continue;

                                            noOfDays = numberOfDaysInPeriod.Value;

                                            if (prototypeRow.Date > prototype.NextContractPeriodDate)
                                            {
                                                noOfDays = (nextContractPeriodDate.Value - prototypeRow.Date.Value).Days;
                                                rowPeriodDates = prototypeRow.Date.Value.ToShortDateString() + " - ";
                                            }
                                            else
                                            {
                                                rowPeriodDates = prototype.NextContractPeriodDate.Value.ToShortDateString() + " - ";
                                            }

                                            if (prototypeRow.DateTo < nextContractPeriodDate)
                                            {
                                                noOfDays = (noOfDays - (nextContractPeriodDate.Value - prototypeRow.DateTo.Value).Days);
                                                rowPeriodDates += prototypeRow.DateTo.Value.ToShortDateString();
                                            }
                                            else
                                            {
                                                rowPeriodDates += nextContractPeriodDate.Value.AddDays(-1).ToShortDateString();
                                            }

                                            if (noOfDays < numberOfDaysInPeriod)
                                            {
                                                setContractSum = true;
                                            }
                                        }
                                        else if (prototypeRow.Date != null)
                                        {
                                            if (prototypeRow.Date > prototype.NextContractPeriodDate)
                                            {
                                                if (prototypeRow.Date >= nextContractPeriodDate)
                                                    continue;

                                                rowPeriodDates = prototypeRow.Date.Value.ToShortDateString() + " - " + nextContractPeriodDate.Value.AddDays(-1).ToShortDateString();
                                                noOfDays = (nextContractPeriodDate.Value - prototypeRow.Date.Value).Days;
                                                setContractSum = true;
                                            }

                                        }
                                        else if (prototypeRow.DateTo != null)
                                        {
                                            if (prototypeRow.DateTo < nextContractPeriodDate)
                                            {
                                                if (prototypeRow.DateTo <= prototype.NextContractPeriodDate)
                                                    continue;

                                                rowPeriodDates = prototype.NextContractPeriodDate.Value.ToShortDateString() + " - " + prototypeRow.DateTo.Value.ToShortDateString();
                                                noOfDays = (prototypeRow.DateTo.Value - prototype.NextContractPeriodDate.Value).Days;
                                                setContractSum = true;
                                            }
                                        }
                                    }

                                    #endregion

                                    #region CustomerInvoiceRow

                                    if (prototypeRow.RowNr > 0)
                                        rowNr++;

                                    bool resetAccountingRows = false;

                                    //Clone
                                    CustomerInvoiceRow cloneRow = CopyCustomerInvoiceRow(entities, prototypeRow);
                                    CustomerInvoiceRow cloneRestRow = null;

                                    if (cloneRow.ProductId.HasValue && cloneRow.ProductId > 0)
                                        product = ProductManager.GetInvoiceProduct(entities, (int)cloneRow.ProductId);

                                    //Check for partial invoicing
                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && checkPartialInvoicing && prototypeRow.InvoiceQuantity > 0)
                                    {
                                        if (prototypeRow.Quantity > prototypeRow.InvoiceQuantity)
                                        {
                                            if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Contract)
                                            {
                                                cloneRow.Quantity = cloneRow.InvoiceQuantity = prototypeRow.InvoiceQuantity;
                                                CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);
                                            }
                                            else
                                            {
                                                recalculatePrototype = true;

                                                decimal? prototypeQuantity = (prototypeRow.Quantity - prototypeRow.InvoiceQuantity);
                                                decimal? cloneRowQuantity = prototypeRow.InvoiceQuantity;
                                                decimal? newOrderRowQuantity = prototypeRow.InvoiceQuantity;

                                                cloneRestRow = CopyCustomerInvoiceRow(entities, prototypeRow);
                                                cloneRestRow.Quantity = cloneRestRow.InvoiceQuantity = newOrderRowQuantity;
                                                cloneRestRow.PreviouslyInvoicedQuantity = prototypeRow.PreviouslyInvoicedQuantity != null ? (decimal)prototypeRow.PreviouslyInvoicedQuantity + cloneRowQuantity : cloneRowQuantity;
                                                cloneRestRow.ParentRow = prototypeRow;
                                                CalculateRowSum(cloneRestRow, prototype.CurrencyRate, 0);
                                                prototype.CustomerInvoiceRow.Add(cloneRestRow);

                                                prototypeRow.Quantity = prototypeQuantity;
                                                prototypeRow.InvoiceQuantity = 0;
                                                prototypeRow.PreviouslyInvoicedQuantity = prototypeRow.PreviouslyInvoicedQuantity != null ? (decimal)prototypeRow.PreviouslyInvoicedQuantity + cloneRowQuantity : cloneRowQuantity;
                                                CalculateRowSum(prototypeRow, prototype.CurrencyRate, 0);

                                                cloneRow.Quantity = cloneRow.InvoiceQuantity = cloneRowQuantity;
                                                CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);

                                                prototypeHasInvalidatedRows = true;
                                                resetAccountingRows = true;
                                            }
                                        }
                                    }
                                    // Stock
                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && prototypeRow.IsStockRow != null && (bool)prototypeRow.IsStockRow && setStatusToOrigin && cloneRow.StockId > 0)
                                    {
                                        ActionResult resultStock = CreateStockTransaction(entities, transaction, actorCompanyId, true, TermGroup_StockTransactionType.Take, clone.Origin.Type, clone.SeqNr.ToString(),
                                               (int)cloneRow.ProductId, (int)cloneRow.StockId, Convert.ToDecimal(GetQuantity(clone.BillingType, cloneRow.Quantity)), Convert.ToDecimal(GetQuantity(clone.BillingType, cloneRow.Quantity)), cloneRow.PurchasePrice, cloneRow.CustomerInvoiceRowId, false);
                                        cloneRow.StockTransaction.Add((StockTransaction)resultStock.Value);

                                        resultStock = CreateStockTransaction(entities, transaction, actorCompanyId, true, TermGroup_StockTransactionType.Reserve, clone.Origin.Type, clone.SeqNr.ToString(),
                                              (int)cloneRow.ProductId, (int)cloneRow.StockId, -Convert.ToDecimal(GetQuantity(clone.BillingType, cloneRow.Quantity)), -Convert.ToDecimal(GetQuantity(clone.BillingType, cloneRow.Quantity)), cloneRow.PurchasePrice, prototypeRow.CustomerInvoiceRowId, false);
                                        prototypeRow.StockTransaction.Add((StockTransaction)resultStock.Value);

                                    }

                                    // Check if contract product
                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && copyTransferredContractRows)
                                    {
                                        if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Contract)
                                        {
                                            recalculatePrototype = true;

                                            cloneRestRow = CopyCustomerInvoiceRow(entities, prototypeRow);
                                            cloneRestRow.Quantity = prototypeRow.InvoiceQuantity;
                                            cloneRestRow.InvoiceQuantity = 0;
                                            cloneRestRow.ParentRow = prototypeRow;
                                            CalculateRowSum(cloneRestRow, prototype.CurrencyRate, 0);
                                            prototype.CustomerInvoiceRow.Add(cloneRestRow);

                                            prototypeRow.InvoiceQuantity = 0;
                                            CalculateRowSum(prototypeRow, prototype.CurrencyRate, 0);

                                            prototypeHasInvalidatedRows = true;
                                            resetAccountingRows = true;
                                        }
                                    }

                                    //Check if lift and recalculate
                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && cloneRow.ProductId != null)
                                    {
                                        if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                                        {
                                            cloneRow.Amount = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.Amount : Decimal.Negate(cloneRow.Amount);
                                            cloneRow.AmountCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountCurrency : Decimal.Negate(cloneRow.AmountCurrency);
                                            cloneRow.AmountEntCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountEntCurrency : Decimal.Negate(cloneRow.AmountEntCurrency);
                                            cloneRow.AmountLedgerCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountLedgerCurrency : Decimal.Negate(cloneRow.AmountLedgerCurrency);

                                            if (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer)
                                            {
                                                if (!prototypeRow.TargetRowReference.IsLoaded)
                                                    prototypeRow.TargetRowReference.Load();

                                                if (prototypeRow.TargetRow != null)
                                                {
                                                    if (!prototypeRow.TargetRow.CustomerInvoiceReference.IsLoaded)
                                                        prototypeRow.TargetRow.CustomerInvoiceReference.Load();

                                                    if (prototypeRow.TargetRow.CustomerInvoice != null && prototypeRow.TargetRow.CustomerInvoice.InvoiceNr.Trim() != String.Empty)
                                                    {
                                                        cloneRow.Text += " - " + GetText(7713, "tidigare fakturerad, fakturanr") + " " + prototypeRow.TargetRow.CustomerInvoice.InvoiceNr;
                                                    }
                                                    else
                                                    {
                                                        cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                    }
                                                }
                                                else
                                                {
                                                    cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                }
                                            }

                                            CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);

                                            resetAccountingRows = true;

                                            if (product.GuaranteePercentage.HasValue && product.GuaranteePercentage > 0)
                                            {
                                                // Update the order
                                                var guaranteeProd = this.GetCustomerInvoiceRows(entities, prototype.InvoiceId, false).FirstOrDefault(p => p.ProductId == guaranteeProductId && p.AttestStateId.HasValue && p.AttestStateId.Value == attestStateOrderInitial.AttestStateId);
                                                if (guaranteeProd != null)
                                                {
                                                    decimal percentage = (product.GuaranteePercentage.Value / 100);
                                                    guaranteeProd.Amount += cloneRow.Amount * percentage;
                                                    guaranteeProd.AmountCurrency += cloneRow.AmountCurrency * percentage;
                                                    guaranteeProd.AmountEntCurrency += cloneRow.AmountEntCurrency * percentage;
                                                    guaranteeProd.AmountLedgerCurrency += cloneRow.AmountLedgerCurrency * percentage;
                                                    CalculateRowSum(guaranteeProd, prototype.CurrencyRate, 0);

                                                    CustomerInvoiceRow liftCloneRow = CopyCustomerInvoiceRow(entities, guaranteeProd);
                                                    liftCloneRow.Amount = Decimal.Negate(cloneRow.Amount * percentage);
                                                    liftCloneRow.AmountCurrency = Decimal.Negate(cloneRow.AmountCurrency * percentage);
                                                    liftCloneRow.AmountEntCurrency = Decimal.Negate(cloneRow.AmountEntCurrency * percentage);
                                                    liftCloneRow.AmountLedgerCurrency = Decimal.Negate(cloneRow.AmountLedgerCurrency * percentage);
                                                    CalculateRowSum(liftCloneRow, prototype.CurrencyRate, 0);

                                                    // Add accounting for the liftRow
                                                    CreateCustomerInvoiceAccountRow(entities, liftCloneRow, (TermGroup_InvoiceVatType)prototype.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, clone.DefaultDim2AccountId, clone.DefaultDim3AccountId, clone.DefaultDim4AccountId, clone.DefaultDim5AccountId, clone.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);

                                                    clone.CustomerInvoiceRow.Add(liftCloneRow);
                                                }
                                            }
                                        }
                                        else if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                        {
                                            cloneRow.Amount = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.Amount : Decimal.Negate(cloneRow.Amount);
                                            cloneRow.AmountCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountCurrency : Decimal.Negate(cloneRow.AmountCurrency);
                                            cloneRow.AmountEntCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountEntCurrency : Decimal.Negate(cloneRow.AmountEntCurrency);
                                            cloneRow.AmountLedgerCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountLedgerCurrency : Decimal.Negate(cloneRow.AmountLedgerCurrency);

                                            if (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer)
                                            {
                                                if (!prototypeRow.TargetRowReference.IsLoaded)
                                                    prototypeRow.TargetRowReference.Load();

                                                if (prototypeRow.TargetRow != null)
                                                {
                                                    if (!prototypeRow.TargetRow.CustomerInvoiceReference.IsLoaded)
                                                        prototypeRow.TargetRow.CustomerInvoiceReference.Load();

                                                    if (prototypeRow.TargetRow.CustomerInvoice != null && prototypeRow.TargetRow.CustomerInvoice.InvoiceNr.Trim() != String.Empty)
                                                    {
                                                        cloneRow.Text += " - " + GetText(7713, "tidigare fakturerad, fakturanr") + " " + prototypeRow.TargetRow.CustomerInvoice.InvoiceNr;
                                                    }
                                                    else
                                                    {
                                                        cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                    }
                                                }
                                                else
                                                {
                                                    cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                }
                                            }

                                            CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);
                                            resetAccountingRows = true;
                                        }
                                        else if (product.ProductId == guaranteeProductId)
                                        {
                                            // Reset accounting rows for the guaranteeProduct (should not have accounting)
                                            if (prototypeAccountRows.Count == 0)
                                                resetAccountingRows = true;
                                        }
                                    }

                                    //Set new values
                                    if (cloneRestRow == null)
                                    {
                                        cloneRow.RowNr = prototypeRow.RowNr == 0 ? 0 : rowNr;
                                        if (originTypeTo == SoeOriginType.Order)
                                            cloneRow.AttestStateId = attestStateOrderInitial != null ? attestStateOrderInitial.AttestStateId : (int?)null; //attestStateOrderInitial when SoeOriginStatusChange is Billing_ContractToInvoice
                                        prototypeRow.AttestStateId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : (int?)null; //attestStateTransferred is null when  SoeOriginStatusChange is Billing_ContractToOrder or Billing_ContractToInvoice
                                    }
                                    else
                                    {
                                        cloneRow.RowNr = prototypeRow.RowNr == 0 ? 0 : rowNr;

                                        cloneRow.AttestStateId = attestStateOrderInitial != null ? attestStateOrderInitial.AttestStateId : (int?)null;
                                        prototypeRow.AttestStateId = attestStateOrderInitial != null ? attestStateOrderInitial.AttestStateId : (int?)null;
                                        cloneRestRow.AttestStateId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : (int?)null;
                                    }

                                    if ((originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice) &&
                                        priceManagement != TermGroup_ContractGroupPriceManagement.Fixed &&
                                        !cloneRow.IsCentRoundingRow && !cloneRow.IsFreightAmountRow && !cloneRow.IsInvoiceFeeRow)
                                    {
                                        if (priceManagement == TermGroup_ContractGroupPriceManagement.UpdateFromPriceList)
                                        {
                                            // Get price from current price list
                                            if (cloneRow.ProductId.HasValue && prototype.ActorId.HasValue)
                                            {
                                                InvoiceProductPriceResult price = ProductManager.GetProductPrice(entities, actorCompanyId, new ProductPriceRequestDTO { ProductId = cloneRow.ProductId.Value, CustomerId = prototype.ActorId.Value, CurrencyId = prototype.CurrencyId });
                                                // If no price found, keep original amount
                                                if (price.SalesPrice != 0)
                                                {
                                                    cloneRow.AmountCurrency = Decimal.Round(price.SalesPrice, 2);
                                                    cloneRow.Amount = Decimal.Round(cloneRow.AmountCurrency / prototype.CurrencyRate, 2);
                                                    cloneRow.PurchasePrice = Decimal.Round(price.PurchasePrice, 2);
                                                    CalculateRowSum(cloneRow, prototype.CurrencyRate, fixedPriceProductId);
                                                    resetAccountingRows = true;
                                                }
                                            }
                                        }
                                    }

                                    if (setContractSum)
                                    {
                                        decimal sumPerDay = cloneRow.SumAmountCurrency / (int)numberOfDaysInPeriod;
                                        cloneRow.SumAmountCurrency = sumPerDay * noOfDays;
                                        cloneRow.SumAmount = Decimal.Round(cloneRow.SumAmountCurrency / prototype.CurrencyRate, 2);
                                        cloneRow.Text += " - " + GetText(7717, "avser period") + " " + rowPeriodDates;
                                        resetAccountingRows = true;
                                    }

                                    if (cloneRow.IntrastatTransaction != null)
                                        cloneRow.IntrastatTransaction.Origin = clone.Origin;

                                    //Set CustomerInvoiceRow target
                                    if (cloneRestRow == null)
                                        prototypeRow.TargetRow = cloneRow;
                                    else
                                        cloneRestRow.TargetRow = cloneRow;

                                    //Keep relation, needed later to set parentrow
                                    prototypeRowDict.Add(prototypeRow.CustomerInvoiceRowId, cloneRow);

                                    #endregion

                                    if (resetAccountingRows)
                                    {
                                        CreateCustomerInvoiceAccountRow(entities, cloneRow, (TermGroup_InvoiceVatType)prototype.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, clone.DefaultDim2AccountId, clone.DefaultDim3AccountId, clone.DefaultDim4AccountId, clone.DefaultDim5AccountId, clone.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);

                                        if (cloneRestRow != null)
                                        {
                                            foreach (CustomerInvoiceAccountRow accRow in prototypeRow.CustomerInvoiceAccountRow)
                                            {
                                                if (accRow.VatRow)
                                                {
                                                    accRow.Amount = -prototypeRow.VatAmount;
                                                    accRow.AmountCurrency = -prototypeRow.VatAmountCurrency;
                                                }
                                                else
                                                {
                                                    accRow.Amount = -prototypeRow.SumAmount;
                                                    accRow.AmountCurrency = -prototypeRow.SumAmountCurrency;
                                                }

                                                SetModifiedProperties(accRow);
                                            }

                                            CreateCustomerInvoiceAccountRow(entities, cloneRestRow, (TermGroup_InvoiceVatType)prototype.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, prototype.DefaultDim2AccountId, prototype.DefaultDim3AccountId, prototype.DefaultDim4AccountId, prototype.DefaultDim5AccountId, prototype.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);
                                        }

                                    }
                                    else
                                    {
                                        foreach (CustomerInvoiceAccountRow prototypeAccountRow in prototypeAccountRows)
                                        {
                                            #region CustomerInvoiceAccountRow

                                            //Clone
                                            var cloneAccountRow = CopyCustomerInvoiceAccountRow(prototypeAccountRow);

                                            //Set new values
                                            cloneAccountRow.RowNr = ++accountRowNr;

                                            cloneRow.CustomerInvoiceAccountRow.Add(cloneAccountRow);

                                            #endregion
                                        }
                                    }

                                    clone.CustomerInvoiceRow.Add(cloneRow);
                                }

                                #region ParentRow

                                foreach (CustomerInvoiceRow prototypeRow in prototypeRows)
                                {
                                    if (prototypeRow.ParentRowId.HasValue && prototypeRowDict.ContainsKey(prototypeRow.ParentRowId.Value) && prototypeRowDict.ContainsKey(prototypeRow.CustomerInvoiceRowId))
                                    {
                                        //Get the equivalent clone rows
                                        CustomerInvoiceRow cloneRow = prototypeRowDict[prototypeRow.CustomerInvoiceRowId];
                                        CustomerInvoiceRow cloneParentRow = prototypeRowDict[prototypeRow.ParentRowId.Value];
                                        if (cloneRow != null && cloneParentRow != null)
                                            cloneRow.ParentRow = cloneParentRow;
                                    }
                                }

                                #endregion

                                #endregion

                                #region Final calculation and add clone

                                if (!merge || prototypeCounter == prototypes.Count)
                                {
                                    #region Calculate totals

                                    CalculateAmountsByCurrency(entities, clone, useCentRounding, actorCompanyId);

                                    //Copy values to Invoice in order to get information to customerinvoicereport.
                                    if (clone.Origin.Type == (int)SoeOriginType.CustomerInvoice && prototype.Origin.Type == (int)SoeOriginType.Order && prototype.FixedPriceOrder)
                                    {
                                        clone.RemainingAmount = prototype.RemainingAmount - clone.TotalAmount;
                                        clone.RemainingAmountExVat = prototype.RemainingAmountExVat - clone.SumAmount;
                                        clone.RemainingAmountVat = prototype.RemainingAmountVat - clone.VATAmount;
                                    }

                                    decimal sum = 0;
                                    foreach (CustomerInvoiceRow row in clone.CustomerInvoiceRow.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.SubTotalRow).OrderBy(r => r.RowNr))
                                    {
                                        if (row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                                        {
                                            row.SumAmountCurrency = sum;
                                            sum = 0;
                                        }
                                        else
                                        {
                                            sum += row.SumAmountCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Add clone

                                    entities.Invoice.AddObject(clone);
                                    clones.Add(clone);

                                    #endregion
                                }

                                #region CustomerInvoiceRow - Claim row

                                CustomerInvoiceRow productClaimRow = clone.CustomerInvoiceRow.FirstOrDefault(r => r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && !r.IsCentRoundingRow);
                                if (productClaimRow == null)
                                {
                                    #region Add

                                    #region CustomerInvoiceRow

                                    productClaimRow = new CustomerInvoiceRow()
                                    {
                                        Type = (int)SoeInvoiceRowType.AccountingRow,
                                        DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                                        Amount = clone.TotalAmount,
                                        AmountCurrency = clone.TotalAmountCurrency,
                                        SumAmount = clone.TotalAmount,
                                        SumAmountCurrency = clone.TotalAmountCurrency,
                                    };
                                    SetCreatedProperties(productClaimRow);
                                    clone.CustomerInvoiceRow.Add(productClaimRow);

                                    #endregion

                                    #region CustomerInvoiceAccountRow

                                    CustomerInvoiceAccountRow productClaimAccountRow = null;
                                    AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, 0, prototype.ActorId.Value, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)clone.VatType, false);
                                    if (prioDTO != null && prioDTO.AccountId.HasValue)
                                    {
                                        var isCredit = (clone.TotalAmount < 0);

                                        productClaimAccountRow = new CustomerInvoiceAccountRow()
                                        {
                                            RowNr = 1,
                                            AccountId = prioDTO.AccountId.Value,
                                            Amount = clone.TotalAmount,
                                            AmountCurrency = clone.TotalAmountCurrency,
                                            DebitRow = !isCredit,
                                            CreditRow = isCredit,
                                        };
                                        productClaimRow.CustomerInvoiceAccountRow.Add(productClaimAccountRow);
                                    }

                                    #endregion

                                    #region Cent rounding row

                                    if (useCentRounding)
                                    {
                                        decimal centAmount = clone.CentRounding;

                                        // Get cent rounding product row
                                        CustomerInvoiceRow productCentRow = clone.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                                        if (productCentRow != null && productCentRow.Product != null)
                                        {
                                            // Add a cent rounding account row
                                            prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productCentRow.Product.ProductId, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)clone.VatType, false);
                                            if (prioDTO != null && prioDTO.AccountId.HasValue)
                                            {
                                                //get currency amount for cent rounding row
                                                decimal centAmountCurrency = productCentRow.AmountCurrency;

                                                // A positive cent amount from the product row will be a credit accounting row
                                                bool isCreditRow = centAmount > 0;
                                                centAmount = Math.Abs(centAmount);
                                                centAmountCurrency = Math.Abs(centAmountCurrency);
                                                if (isCreditRow)
                                                {
                                                    centAmount = -centAmount;
                                                    centAmountCurrency = -centAmountCurrency;
                                                }

                                                accountRowNr++;

                                                CustomerInvoiceAccountRow centRow = new CustomerInvoiceAccountRow()
                                                {
                                                    RowNr = accountRowNr,
                                                    AccountId = prioDTO.AccountId.Value,
                                                    Quantity = 1,
                                                    Amount = centAmount,
                                                    AmountCurrency = centAmountCurrency,
                                                    DebitRow = !isCreditRow,
                                                    CreditRow = isCreditRow
                                                };

                                                productCentRow.CustomerInvoiceAccountRow.Add(centRow);
                                            }
                                        }
                                    }

                                    // Update amount on claim row after calculation
                                    if (productClaimAccountRow != null)
                                    {
                                        productClaimAccountRow.Amount = clone.TotalAmount;
                                        productClaimAccountRow.AmountCurrency = clone.TotalAmountCurrency;
                                    }

                                    #endregion

                                    #endregion
                                }
                                else
                                {
                                    #region Update

                                    #region CustomerInvoiceRow

                                    productClaimRow.Amount = clone.TotalAmount;
                                    productClaimRow.SumAmount = clone.TotalAmount;
                                    productClaimRow.SumAmountCurrency = clone.TotalAmountCurrency;
                                    SetModifiedProperties(productClaimRow);

                                    #endregion

                                    #region CustomerInvoiceAccountRow

                                    CustomerInvoiceAccountRow productClaimAccountRow = productClaimRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.RowNr == 1);
                                    AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, 0, prototype.ActorId.Value, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)clone.VatType, false);
                                    if (prioDTO != null && prioDTO.AccountId.HasValue && productClaimAccountRow == null)
                                    {
                                        var isCredit = (clone.TotalAmount < 0);

                                        productClaimAccountRow = new CustomerInvoiceAccountRow
                                        {
                                            RowNr = 1,
                                            AccountId = prioDTO.AccountId.Value,
                                            Amount = clone.TotalAmount,
                                            AmountCurrency = clone.TotalAmountCurrency,
                                            DebitRow = !isCredit,
                                            CreditRow = isCredit,
                                        };
                                        productClaimRow.CustomerInvoiceAccountRow.Add(productClaimAccountRow);
                                    }

                                    #endregion

                                    #region Cent rounding row

                                    if (useCentRounding)
                                    {
                                        decimal centAmount = clone.CentRounding;

                                        // Get cent rounding product row
                                        CustomerInvoiceRow productCentRow = clone.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                                        if (productCentRow != null && productCentRow.ProductId.HasValue)
                                        {
                                            // Add a cent rounding account row
                                            prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productCentRow.ProductId.Value, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)clone.VatType, false);
                                            if (prioDTO.AccountId.HasValue)
                                            {
                                                // A positive cent amount from the product row will be a credit accounting row
                                                bool isCreditRow = centAmount > 0;
                                                centAmount = Math.Abs(centAmount);
                                                if (isCreditRow)
                                                    centAmount = -centAmount;

                                                accountRowNr++;

                                                CustomerInvoiceAccountRow centRow = new CustomerInvoiceAccountRow()
                                                {
                                                    RowNr = accountRowNr,
                                                    AccountId = prioDTO.AccountId.Value,
                                                    Quantity = 1,
                                                    Amount = centAmount,
                                                    DebitRow = !isCreditRow,
                                                    CreditRow = isCreditRow
                                                };

                                                productCentRow.CustomerInvoiceAccountRow.Add(centRow);
                                            }
                                        }
                                    }

                                    // Update amount on claim row after calculation
                                    if (productClaimAccountRow != null)
                                    {
                                        productClaimAccountRow.Amount = clone.TotalAmount;
                                        productClaimAccountRow.AmountCurrency = clone.TotalAmountCurrency;
                                    }

                                    #endregion

                                    #endregion
                                }

                                #endregion

                                #region Update status

                                bool setContractPeriod = false;
                                switch (originStatusChange)
                                {
                                    case SoeOriginStatusChange.Billing_OfferToOrder:
                                        #region OfferToOrder

                                        clone.RegistrationType = (int)OrderInvoiceRegistrationType.Order;
                                        clone.Origin.Type = (int)SoeOriginType.Order;
                                        clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Offer;
                                        prototype.Origin.Status = prototypeHasInvalidatedRows ? (int)SoeOriginStatus.OfferPartlyOrder : (int)SoeOriginStatus.OfferFullyOrder;

                                        //Calculate currency amounts
                                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                        #endregion
                                        break;
                                    case SoeOriginStatusChange.Billing_OfferToInvoice:
                                        #region OfferToInvoice

                                        clone.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;
                                        clone.Origin.Type = (int)SoeOriginType.CustomerInvoice;
                                        clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Offer;
                                        prototype.Origin.Status = prototypeHasInvalidatedRows ? (int)SoeOriginStatus.OfferPartlyInvoice : (int)SoeOriginStatus.OfferFullyInvoice;

                                        //Calculate currency amounts
                                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                        #endregion
                                        break;
                                    case SoeOriginStatusChange.Billing_OrderToInvoice:
                                        #region OrderToInvoice

                                        clone.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;
                                        clone.Origin.Type = (int)SoeOriginType.CustomerInvoice;
                                        clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Order;

                                        if (finalInvoicingDeductLift || (hasFlatPriceKeepPricesRowsToTransfer && !keepOrderOpen))
                                            prototype.Origin.Status = (int)SoeOriginStatus.OrderFullyInvoice;
                                        else
                                            prototype.Origin.Status = prototypeHasInvalidatedRows || keepOrderOpen ? (int)SoeOriginStatus.OrderPartlyInvoice : (int)SoeOriginStatus.OrderFullyInvoice;


                                        decimal ra = 0;
                                        decimal raExVat = 0;
                                        decimal raVat = 0;
                                        CalculateInvoiceRemainingAmount(prototype, fixedPriceKeepPricesProductId, ref ra, ref raExVat, ref raVat, (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer));

                                        prototype.RemainingAmount = ra;
                                        prototype.RemainingAmountVat = raVat;
                                        prototype.RemainingAmountExVat = raExVat;

                                        //Calculate currency amounts
                                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                        #endregion
                                        break;
                                    case SoeOriginStatusChange.Billing_ContractToOrder:
                                        #region ContractToOrder

                                        clone.RegistrationType = (int)OrderInvoiceRegistrationType.Order;
                                        clone.Origin.Type = (int)SoeOriginType.Order;
                                        clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Contract;
                                        setContractPeriod = true;

                                        //Calculate currency amounts
                                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                        #endregion
                                        break;
                                    case SoeOriginStatusChange.Billing_ContractToInvoice:
                                        #region ContractToInvoice

                                        clone.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;
                                        clone.Origin.Type = (int)SoeOriginType.CustomerInvoice;
                                        clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Contract;
                                        setContractPeriod = true;

                                        //Calculate currency amounts
                                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                        #endregion
                                        break;
                                }

                                #endregion

                                #region Contract

                                if (setContractPeriod)
                                {
                                    // Set next period
                                    if (prototype.ContractGroup != null)
                                    {
                                        prototype.NextContractPeriodYear = nextContractPeriodYear;
                                        prototype.NextContractPeriodValue = nextContractPeriodValue;
                                        prototype.NextContractPeriodDate = nextContractPeriodDate;
                                    }
                                }

                                #endregion

                                #endregion

                                #region Validate clone accounting rows

                                if (!merge || prototypeCounter == prototypes.Count)
                                {
                                    if (ValidateCustomerInvoiceAccountingRowsDiff(clone))
                                    {
                                        accountRowNr = 1; //Reset account row number
                                        foreach (CustomerInvoiceRow cloneRow in clone.ActiveCustomerInvoiceRows)
                                        {
                                            cloneRow.CustomerInvoiceAccountRow.ToList().ForEach(x => entities.DeleteObject(x));
                                            CreateCustomerInvoiceAccountRow(entities, cloneRow, (TermGroup_InvoiceVatType)clone.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, clone.DefaultDim2AccountId, clone.DefaultDim3AccountId, clone.DefaultDim4AccountId, clone.DefaultDim5AccountId, clone.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);
                                        }

                                        //TODO: Second validation never succeeds because claim row is missing! All account rows are deleted above, but claim row is never formed again.

                                        if (ValidateCustomerInvoiceAccountingRowsDiff(clone))
                                            return new ActionResult((int)ActionResultSave.HasUnbalancedAccountingRows, "CustomerInvoice");
                                    }
                                }

                                #endregion

                                if (recalculatePrototype)
                                {
                                    #region Calculate totals

                                    CalculateAmountsByCurrency(entities, prototype, useCentRounding, actorCompanyId);

                                    decimal sum = 0;
                                    foreach (CustomerInvoiceRow row in prototype.CustomerInvoiceRow.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.SubTotalRow).OrderBy(r => r.RowNr))
                                    {
                                        if (row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                                        {
                                            row.SumAmountCurrency = sum;
                                            sum = 0;
                                        }
                                        else
                                        {
                                            sum += row.SumAmountCurrency;
                                        }
                                    }

                                    #endregion

                                    #region CustomerInvoiceRow - Claim row

                                    CustomerInvoiceRow prototypeProductClaimRow = prototype.CustomerInvoiceRow.FirstOrDefault(r => r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && r.IsCentRoundingRow == false);
                                    if (prototypeProductClaimRow != null)
                                    {
                                        #region Update

                                        #region CustomerInvoiceRow

                                        prototypeProductClaimRow.Amount = prototype.TotalAmount;
                                        prototypeProductClaimRow.SumAmount = prototype.TotalAmount;
                                        prototypeProductClaimRow.SumAmountCurrency = prototype.TotalAmountCurrency;
                                        SetModifiedProperties(prototypeProductClaimRow);

                                        #endregion

                                        #region CustomerInvoiceAccountRow

                                        CustomerInvoiceAccountRow prototypeProductClaimAccountRow = prototypeProductClaimRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.RowNr == 1);
                                        AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, 0, prototype.ActorId.Value, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)clone.VatType, false);
                                        if (prioDTO != null && prioDTO.AccountId.HasValue && prototypeProductClaimAccountRow == null)
                                        {
                                            // Is Amount negative
                                            var isCredit = (clone.TotalAmount < 0);

                                            prototypeProductClaimAccountRow = new CustomerInvoiceAccountRow()
                                            {
                                                RowNr = 1,
                                                AccountId = prioDTO.AccountId.Value,
                                                Amount = clone.TotalAmount,
                                                DebitRow = !isCredit,
                                                CreditRow = isCredit,
                                            };
                                            prototypeProductClaimRow.CustomerInvoiceAccountRow.Add(prototypeProductClaimAccountRow);
                                        }

                                        #endregion

                                        #region Cent rounding row

                                        if (useCentRounding)
                                        {
                                            decimal centAmount = prototype.CentRounding;

                                            // Get cent rounding product row
                                            CustomerInvoiceRow prototypeProductCentRow = prototype.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                                            if (prototypeProductCentRow != null && prototypeProductCentRow.ProductId.HasValue)
                                            {
                                                // Add a cent rounding account row
                                                prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, prototypeProductCentRow.ProductId.Value, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)clone.VatType, false);
                                                if (prioDTO != null && prioDTO.AccountId.HasValue)
                                                {
                                                    // A positive cent amount from the product row will be a credit accounting row
                                                    bool isCreditRow = centAmount > 0;
                                                    centAmount = Math.Abs(centAmount);
                                                    if (isCreditRow)
                                                        centAmount = -centAmount;

                                                    accountRowNr++;

                                                    CustomerInvoiceAccountRow centRow = prototypeProductCentRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.AccountId == prioDTO.AccountId.Value && r.State == (int)SoeEntityState.Active);

                                                    if (centRow != null)
                                                    {
                                                        centRow.Amount = centAmount;
                                                    }
                                                    else
                                                    {
                                                        centRow = new CustomerInvoiceAccountRow()
                                                        {
                                                            RowNr = accountRowNr,
                                                            AccountId = prioDTO.AccountId.Value,
                                                            Quantity = 1,
                                                            Amount = centAmount,
                                                            DebitRow = !isCreditRow,
                                                            CreditRow = isCreditRow
                                                        };

                                                        prototypeProductCentRow.CustomerInvoiceAccountRow.Add(centRow);
                                                    }
                                                }
                                            }
                                        }

                                        // Update amount on claim row after calculation
                                        if (prototypeProductClaimAccountRow != null)
                                        {
                                            prototypeProductClaimAccountRow.Amount = prototype.TotalAmount;
                                            prototypeProductClaimAccountRow.AmountCurrency = prototype.TotalAmountCurrency;
                                        }

                                        #endregion

                                        #endregion
                                    }

                                    #endregion

                                    CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, prototype);
                                }

                                #region Copy Attachments

                                if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice)
                                {
                                    GraphicsManager gm = new GraphicsManager(null);
                                    GeneralManager gem = new GeneralManager(null);

                                    List<Images> imagesToTransfer = new List<Images>();
                                    List<DataStorageRecord> attachmentToTransfer = new List<DataStorageRecord>();

                                    var imagesFromOldOrderOffer = gm.GetImages(entities, actorCompanyId, imageType, entityTypeFrom, prototype.InvoiceId).ToList();
                                    var attachmentsFromOldOrderOffer = gem.GetDataStorageRecords(entities, actorCompanyId, null, prototype.InvoiceId, SoeEntityType.None, SoeDataStorageRecordType.OrderInvoiceFileAttachment);

                                    // Add images
                                    if (imagesFromOldOrderOffer != null && imagesFromOldOrderOffer.Count > 0)
                                    {
                                        foreach (var image in imagesFromOldOrderOffer)
                                        {
                                            Images img = new Images()
                                            {
                                                ActorCompanyId = image.ActorCompanyId,
                                                Type = image.Type,
                                                Entity = (int)entityTypeTo,
                                                RecordId = 0,
                                                FormatType = image.FormatType,
                                                Thumbnail = image.Thumbnail,
                                                Image = image.Image,
                                                Description = image.Description,
                                            };

                                            imagesToTransfer.Add(img);
                                        }

                                        clone.TempImagesToCopy = imagesToTransfer;
                                    }

                                    // Add attachements
                                    if (attachmentsFromOldOrderOffer != null && attachmentsFromOldOrderOffer.Count > 0)
                                    {
                                        foreach (var attachments in attachmentsFromOldOrderOffer)
                                        {
                                            DataStorage newDataStorage = new DataStorage();
                                            DataStorageRecord datastorageRecord = gem.GetDataStorageRecord(entities, actorCompanyId, attachments.DataStorageRecordId);

                                            if (datastorageRecord != null && datastorageRecord.DataStorage != null)
                                            {
                                                newDataStorage.ActorCompanyId = datastorageRecord.DataStorage.ActorCompanyId;
                                                newDataStorage.Type = datastorageRecord.DataStorage.Type;
                                                newDataStorage.Description = datastorageRecord.DataStorage.Description;
                                                newDataStorage.XML = datastorageRecord.DataStorage.XML;
                                                newDataStorage.Data = datastorageRecord.DataStorage.Data;
                                                newDataStorage.FileSize = datastorageRecord.DataStorage.FileSize;
                                                newDataStorage.State = datastorageRecord.DataStorage.State;
                                                newDataStorage.OriginType = datastorageRecord.DataStorage.OriginType;
                                                newDataStorage.FileName = datastorageRecord.DataStorage.FileName;
                                                newDataStorage.Extension = datastorageRecord.DataStorage.Extension;

                                                var newDataStoreRecord = gem.CreateDataStorageRecord(entities, (SoeDataStorageRecordType)datastorageRecord.Type, 0, datastorageRecord.RecordNumber, (SoeEntityType)datastorageRecord.Entity, newDataStorage);

                                                attachmentToTransfer.Add(newDataStoreRecord);
                                            }


                                        }

                                        clone.TempAttachmentsToCopy = attachmentToTransfer;
                                    }
                                }

                                #endregion
                            }
                        }

                        #region Save

                        if (validatedPrototypes > 0)
                        {
                            result = SaveChanges(entities, transaction);

                            if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice)
                            {
                                // Check if Voucher should also should be saved at once
                                result = TryTransferCustomerInvoicesToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, clones, actorCompanyId);
                                if (!result.Success)
                                    return result;

                                //Update Attachments
                                result = TryTransferAttachments(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, clones);
                                if (!result.Success)
                                    return result;
                            }

                            //Commit transaction
                            if (result.Success)
                                transaction.Complete();
                        }
                        else
                        {
                            if (invalidatedPrototypes > 0)
                            {
                                result = new ActionResult((int)ActionResultSave.TransferOfferOrderHasInvalidatedItems, string.Format(GetText(6224), invalidPrototypes.Aggregate((x, y) => x + ",\r\n" + y)));
                                result.IntegerValue = invalidatedPrototypes;
                            }
                        }

                        #endregion
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.Value = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = clones.Count;
                        result.StrDict = clones.Select(c => new { c.InvoiceId, c.SeqNr }).ToDictionary(c => c.InvoiceId, c => c.SeqNr.ToString());

                        if (invalidPrototypes.Count > 0)
                            result.InfoMessage = invalidPrototypes.Aggregate((x, y) => x + ",\r\n" + y);
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }


        private ActionResult CreateOfferOrderInvoiceFromType_v2(List<CustomerInvoiceGridDTO> invoiceItems, SoeOriginStatusChange originStatusChange, bool merge, bool setStatusToOrigin, int actorCompanyId, bool keepOrderOpen = false, bool checkPartialInvoicing = false, bool copyTransferredContractRows = false)
        {
            ActionResult result = new ActionResult(false);

            if (invoiceItems == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "CreateOfferOrderInvoiceFromType");

            var invalidPrototypes = new List<string>();
            var clones = new List<CustomerInvoice>();

            var groupedByCustomer = invoiceItems.GroupBy(i => i.ActorCustomerId);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    #region Init

                    InitializeAttestStateIds(entities, actorCompanyId);

                    #endregion

                    #region Prereq

                    int fixedPriceProductId = 0;
                    int guaranteeProductId = 0;
                    int fixedPriceKeepPricesProductId = 0;

                    #region Settings

                    bool allowInvoiceOfCreditOrders = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.AllowInvoiceOfCreditOrders, 0, actorCompanyId, 0, false);
                    bool useOurReferenceOnMerge = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingSetOurReferenceOnMergedInvoices, 0, actorCompanyId, 0, true);
                    bool createSubTotalRowOnMerge = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingCreateSubtotalRowInConsolidatedInvoices, 0, actorCompanyId, 0);
                    bool showPurchaseDateOnInvoice = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingShowPurchaseDateOnInvoice, 0, actorCompanyId, 0, false);

                    #endregion

                    #region Cent rounding

                    bool useCentRounding = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingUseCentRounding, 0, actorCompanyId, 0);

                    List<int> liftProducts = ProductManager.GetInvoiceProductsByCalculationType(entities, actorCompanyId, TermGroup_InvoiceProductCalculationType.Lift).Select(p => p.ProductId).ToList();

                    #endregion

                    #region AttestStates

                    CompanySettingType companySettingType = CompanySettingType.Unknown;
                    TermGroup_AttestEntity entityFrom = TermGroup_AttestEntity.Unknown;
                    TermGroup_AttestEntity entityTo = TermGroup_AttestEntity.Unknown;
                    SoeOriginType originTypeTo = SoeOriginType.None;
                    SoeEntityType entityTypeFrom = SoeEntityType.None;
                    SoeEntityType entityTypeTo = SoeEntityType.None;
                    SoeEntityImageType imageType = SoeEntityImageType.Unknown;

                    switch (originStatusChange)
                    {
                        case SoeOriginStatusChange.Billing_OfferToOrder:
                            companySettingType = CompanySettingType.BillingStatusTransferredOfferToOrder;
                            entityFrom = TermGroup_AttestEntity.Offer;
                            entityTo = TermGroup_AttestEntity.Order;
                            originTypeTo = SoeOriginType.Order;
                            entityTypeFrom = SoeEntityType.Offer;
                            entityTypeTo = SoeEntityType.Order;
                            imageType = SoeEntityImageType.OrderInvoice;
                            fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                            break;
                        case SoeOriginStatusChange.Billing_OfferToInvoice:
                            companySettingType = CompanySettingType.BillingStatusTransferredOfferToInvoice;
                            entityFrom = TermGroup_AttestEntity.Offer;
                            entityTo = TermGroup_AttestEntity.InvoiceTime;
                            originTypeTo = SoeOriginType.CustomerInvoice;
                            fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                            guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, actorCompanyId, 0);
                            fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);
                            entityTypeFrom = SoeEntityType.Offer;
                            entityTypeTo = SoeEntityType.CustomerInvoice;
                            imageType = SoeEntityImageType.OrderInvoice;
                            break;
                        case SoeOriginStatusChange.Billing_OrderToInvoice:
                            companySettingType = CompanySettingType.BillingStatusTransferredOrderToInvoice;
                            entityFrom = TermGroup_AttestEntity.Order;
                            entityTo = TermGroup_AttestEntity.InvoiceTime;
                            originTypeTo = SoeOriginType.CustomerInvoice;
                            fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
                            guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, actorCompanyId, 0);
                            fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);
                            entityTypeFrom = SoeEntityType.Order;
                            entityTypeTo = SoeEntityType.CustomerInvoice;
                            imageType = SoeEntityImageType.OrderInvoice;
                            break;
                        case SoeOriginStatusChange.Billing_ContractToOrder:
                        case SoeOriginStatusChange.Billing_ContractToServiceOrder:
                            companySettingType = CompanySettingType.BillingStatusTransferredOfferToOrder;
                            entityTo = TermGroup_AttestEntity.Order;
                            originTypeTo = SoeOriginType.Order;
                            entityTypeFrom = SoeEntityType.Contract;
                            entityTypeTo = SoeEntityType.Order;
                            imageType = SoeEntityImageType.OrderInvoice;
                            break;
                        case SoeOriginStatusChange.Billing_ContractToInvoice:
                            companySettingType = CompanySettingType.BillingStatusTransferredOfferToInvoice;
                            entityTo = TermGroup_AttestEntity.InvoiceTime;
                            originTypeTo = SoeOriginType.CustomerInvoice;
                            entityTypeFrom = SoeEntityType.Contract;
                            entityTypeTo = SoeEntityType.CustomerInvoice;
                            imageType = SoeEntityImageType.OrderInvoice;
                            break;
                    }

                    int? attestStateOrderInitialId = null;
                    //Initial status
                    if (originTypeTo == SoeOriginType.Order)
                    {
                        attestStateOrderInitialId = AttestManager.GetInitialAttestState(entities, actorCompanyId, entityTo)?.AttestStateId;
                        if (attestStateOrderInitialId == null)
                            return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestStateInitial);
                    }
                    else if (entityFrom == TermGroup_AttestEntity.Order || entityFrom == TermGroup_AttestEntity.Offer)
                    {
                        attestStateOrderInitialId = AttestManager.GetInitialAttestState(entities, actorCompanyId, entityFrom)?.AttestStateId;
                        if (attestStateOrderInitialId == null)
                            return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestStateInitial);
                    }


                    AttestState attestStateTransferred = null;

                    //We dont set transferred status on contract rows
                    if (originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice && originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                    {
                        //Transferred status
                        int attestStateTransferredId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)companySettingType, 0, actorCompanyId, 0);
                        attestStateTransferred = AttestManager.GetAttestState(entities, attestStateTransferredId);
                        if (attestStateTransferred == null)
                            return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestStateTransferred);
                    }

                    #endregion

                    #region AttestTransitions

                    //AttestTransitions not used for contracts
                    List<AttestTransition> attestTransitions = new List<AttestTransition>();
                    if (originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice && originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                    {
                        attestTransitions = AttestManager.GetAttestTransitionsForAttestRoleUser(entities, base.UserId, actorCompanyId, entity: entityFrom);
                        if (attestTransitions.IsNullOrEmpty())
                            return new ActionResult((int)ActionResultSave.TransferOfferOrderInvalidAttestTransitions, GetText(7618, "Ogiltig överföring. Kontrollera användarens attestroller och försök igen. "));
                    }

                    #endregion

                    #endregion

                    foreach (var group in groupedByCustomer)
                    {
                        using (TransactionScope transaction = CreateTransactionScope(new TimeSpan(0, 30, 0), System.Transactions.IsolationLevel.ReadCommitted))
                        {
                            #region Add prototypes to Dictionary sorted on Actor

                            var prototypeDict = new Dictionary<int, List<CustomerInvoice>>();
                            int? vatType = null;
                            bool setContractInvoiceDate = false;
                            string targetInvoiceNrs = "";
                            bool validAmountCheck = true;
                            string message = string.Empty;
                            decimal transferTotalOnMerge = 0;

                            foreach (var item in group)
                            {
                                var target = GetCustomerInvoice(entities, item.CustomerInvoiceId, loadOrigin: true, loadActor: true, loadPaymentCondition: true, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadIntrastatTransaction: true);

                                if (target == null)
                                    return new ActionResult((int)ActionResultSave.EntityNotFound, "CustomerInvoice");

                                if (!target.ActorId.HasValue)
                                    continue;

                                if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder && target.OrderInvoiceTemplateId.HasValue && target.OrderInvoiceTemplateId.Value > 0)
                                {
                                    var sectarget = GetCustomerInvoice(entities, target.OrderInvoiceTemplateId.Value, loadOrigin: true, loadActor: true, loadPaymentCondition: true, loadInvoiceRow: true, loadInvoiceAccountRow: true, loadIntrastatTransaction: true);
                                    if (sectarget != null)
                                    {
                                        if (sectarget.ActorId == null)
                                            sectarget.AgreementActorIdForServiceOrder = target.ActorId.Value;

                                        sectarget.AgreementOriginIdForServiceOrder = target.InvoiceId;

                                        target = sectarget;
                                    }
                                }

                                targetInvoiceNrs = string.IsNullOrEmpty(targetInvoiceNrs) ? target.InvoiceNr : "," + target.InvoiceNr;

                                #region Check blocked

                                if (originTypeTo == SoeOriginType.CustomerInvoice)
                                {
                                    var blocked = CustomerManager.IsCustomerBlocked(entities, target.ActorId, target.Actor);
                                    if (blocked)
                                        return new ActionResult((int)ActionResultSave.CustomerIsBlocked, GetText(8309));
                                }

                                #endregion

                                #region Check VatType (merge only)

                                if (merge)
                                {
                                    //All targets must have same VatType
                                    if (!vatType.HasValue)
                                    {
                                        vatType = target.VatType;
                                    }
                                    else
                                    {
                                        if (vatType != target.VatType)
                                            return new ActionResult((int)ActionResultSave.TransferOfferOrderHasDifferentVatTypes, TermCacheManager.Instance.GetText(7490, (int)TermGroup.General, "De valda ordrarna har olika momstyper och kan därför ej samfaktureras.", base.GetLangId()));
                                    }
                                }

                                #endregion

                                #region Validate status

                                switch (originStatusChange)
                                {
                                    case SoeOriginStatusChange.Billing_OfferToOrder:
                                        //Must be Origin or PartlyOrder
                                        if (target.Status != (int)SoeOriginStatus.Origin && target.Status != (int)SoeOriginStatus.OfferPartlyOrder && target.Status != (int)SoeOriginStatus.OfferPartlyInvoice)
                                            continue;
                                        break;
                                    case SoeOriginStatusChange.Billing_OfferToInvoice:
                                        //Must be Origin or PartlyInvoice
                                        if (target.Status != (int)SoeOriginStatus.Origin && target.Status != (int)SoeOriginStatus.OfferPartlyInvoice)
                                            continue;
                                        break;
                                    case SoeOriginStatusChange.Billing_OrderToInvoice:
                                        //Must be Origin or PartlyInvoice
                                        if (target.Status != (int)SoeOriginStatus.Origin && target.Status != (int)SoeOriginStatus.OrderPartlyInvoice)
                                            continue;
                                        break;
                                    case SoeOriginStatusChange.Billing_ContractToOrder:
                                    case SoeOriginStatusChange.Billing_ContractToInvoice:
                                        setContractInvoiceDate = true;
                                        if (item.InvoiceDate.HasValue)
                                            target.NextContractPeriodDate = item.InvoiceDate;

                                        //Must be Origin
                                        if (target.Status != (int)SoeOriginStatus.Origin)
                                            continue;
                                        break;
                                }

                                #endregion

                                #region PriceListType Inclusive VAT

                                if (!target.PriceListTypeReference.IsLoaded)
                                    target.PriceListTypeReference.Load();

                                // Set virtual field to be able to read it later
                                if (target.PriceListType != null)
                                    target.PriceListTypeInclusiveVat = target.PriceListType.InclusiveVat;

                                #endregion

                                #region Validate negative transfer amount

                                if (!allowInvoiceOfCreditOrders)
                                {

                                    if (merge)
                                    {
                                        transferTotalOnMerge += this.ValidateNegativeTransferAmountMerge(entities, target, originStatusChange, attestTransitions, liftProducts, attestStateTransferred, fixedPriceKeepPricesProductId, attestStateOrderInitialId.GetValueOrDefault());
                                    }
                                    else
                                    {
                                        this.ValidateNegativeTransferAmount(entities, target, originStatusChange, attestTransitions, liftProducts, attestStateTransferred, fixedPriceKeepPricesProductId, attestStateOrderInitialId.GetValueOrDefault(), ref validAmountCheck, ref message);
                                    }
                                }

                                #endregion

                                //Add prototype to Dictionary
                                if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder && !target.ActorId.HasValue)
                                {
                                    if (prototypeDict.ContainsKey(0))
                                        prototypeDict[0].Add(target);
                                    else
                                        prototypeDict.Add(0, new List<CustomerInvoice>() { target });
                                }
                                else
                                {
                                    if (prototypeDict.ContainsKey(target.ActorId.Value))
                                        prototypeDict[target.ActorId.Value].Add(target);
                                    else
                                        prototypeDict.Add(target.ActorId.Value, new List<CustomerInvoice>() { target });
                                }
                            }

                            if (merge)
                                validAmountCheck = (transferTotalOnMerge >= 0);

                            //Validate sum and final invoicing
                            if (!validAmountCheck)
                            {
                                string errorMessage = "";
                                if (prototypeDict.Count == 1)
                                    errorMessage = GetText(308, (int)TermGroup.ChangeStatusGrid, "De rader som ska överföras kommer att generera en faktura med negativt belopp.\n Endast positiva rader får föras över om inte inställningen för att tillåta fakturering av negativa ordrar är satt.");
                                else
                                {
                                    string name = "";
                                    switch (entityFrom)
                                    {
                                        case TermGroup_AttestEntity.Offer:
                                            name = TermCacheManager.Instance.GetText(11, (int)TermGroup.StateAnalysis, "Offerter", base.GetLangId());
                                            break;
                                        case TermGroup_AttestEntity.Order:
                                            name = TermCacheManager.Instance.GetText(13, (int)TermGroup.StateAnalysis, "Ordrar", base.GetLangId());
                                            break;
                                        case TermGroup_AttestEntity.Contract:
                                            name = TermCacheManager.Instance.GetText(12, (int)TermGroup.StateAnalysis, "Avtal", base.GetLangId());
                                            break;
                                    }
                                    errorMessage = string.Format(TermCacheManager.Instance.GetText(641, (int)TermGroup.ChangeStatusGrid, "De rader som ska överföras i nedanstående {0} kommer att generera en faktura med negativt belopp, detta är inte tillåtet.\nKlarmarkera endast positiva rader eller se på annat sätt till att totalsumman blir positiv och försök igen.", base.GetLangId()), name) + message;
                                }
                                return new ActionResult(false, (int)ActionResultSave.NegativeTransferAmount, errorMessage);
                            }

                            #endregion

                            bool saveSeqNumber = prototypeDict.Count > 1;
                            int invalidatedPrototypes = 0;
                            int validatedPrototypes = 0;

                            foreach (var prototypeList in prototypeDict)
                            {
                                #region Init

                                CustomerInvoice clone = null;

                                int rowNr = 0;
                                int accountRowNr = 0;
                                int prototypeCounter = 0;
                                bool invoiceFeeAdded = false;

                                var prototypes = merge ? (from t in prototypeList.Value
                                                          orderby t.SeqNr
                                                          select t).ToList() :
                                                         (from t in prototypeList.Value
                                                          orderby t.Modified descending, t.InvoiceDate descending
                                                          select t).ToList();

                                #endregion

                                foreach (var prototype in prototypes)
                                {
                                    bool recalculatePrototype = false;

                                    #region Init

                                    bool prototypeHasInvalidatedRows = false;
                                    bool isMaster = (!merge || clone == null); //Decides if new clone should be created
                                    bool hasValidProductRows = false; //Used for validation
                                    bool hasValidAccounting = true; //Used for validation
                                    var prototypeRowsValidationDict = new Dictionary<int, bool>(); //Used for validation
                                    var prototypeRowDict = new Dictionary<int, CustomerInvoiceRow>(); //Used for parent rows

                                    int nextContractPeriodYear = 0;
                                    int nextContractPeriodValue = 0;
                                    DateTime? nextContractPeriodDate = null;
                                    int? numberOfDaysInPeriod = null;

                                    bool hasHouseholdTaxDeduction = false;

                                    #endregion

                                    #region Validate prototype accounting rows

                                    if (ValidateCustomerInvoiceAccountingRowsDiff(prototype))
                                    {
                                        hasValidAccounting = false;
                                        invalidPrototypes.Add(prototype.InvoiceNr);
                                    }

                                    #endregion

                                    #region Prereq

                                    // Check if row of type ProductFlatPriceKeepPrices 
                                    bool hasFlatPriceKeepPricesRowsToTransfer = false;
                                    var fixedPricesRows = prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && r.ProductId == fixedPriceKeepPricesProductId && !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value)));

                                    if (fixedPricesRows.Any())
                                    {
                                        foreach (CustomerInvoiceRow row in fixedPricesRows)
                                        {
                                            if (IsCustomerInvoiceRowAttestStateValid(row, attestStateTransferred, attestTransitions))
                                            {
                                                hasFlatPriceKeepPricesRowsToTransfer = true;
                                            }
                                            else
                                            {
                                                hasFlatPriceKeepPricesRowsToTransfer = false;
                                                break;
                                            }
                                        }
                                    }

                                    // Check if this is final invoicing deduct lift  
                                    bool finalInvoicingDeductLift = false;
                                    var liftRows = prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && r.ProductId != null && liftProducts.Contains((int)r.ProductId) &&
                                    (r.AttestStateId.HasValue && r.AttestStateId.Value == attestStateTransferred.AttestStateId) &&
                                    !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))).ToList();

                                    if (!fixedPricesRows.Any() && liftRows.Count > 0)
                                    {
                                        finalInvoicingDeductLift = true;
                                        foreach (var rowAttestStateId in prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && (r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.TextRow) && r.AttestStateId != attestStateTransferred.AttestStateId && !InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value)).Select(x => x.AttestStateId))
                                        {
                                            if (rowAttestStateId == attestStateOrderInitialId.GetValueOrDefault())
                                            {
                                                finalInvoicingDeductLift = false;
                                                continue;
                                            }

                                            var attestTransition = (from at in attestTransitions
                                                                    where at.AttestStateFrom != null &&
                                                                    at.AttestStateTo != null &&
                                                                    at.AttestStateFrom.AttestStateId == rowAttestStateId &&
                                                                    at.AttestStateTo.AttestStateId == attestStateTransferred.AttestStateId
                                                                    select at).FirstOrDefault();

                                            if (attestTransition == null)
                                            {
                                                finalInvoicingDeductLift = false;
                                            }

                                        }
                                    }

                                    decimal rowsToBeTransferredTotal = 0;
                                    List<CustomerInvoiceRow> prototypeRows = null;
                                    if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                    {
                                        finalInvoicingDeductLift = false;
                                        hasFlatPriceKeepPricesRowsToTransfer = false;
                                        prototypeRows = prototype.Origin.Type == (int)SoeOriginType.Contract ? new List<CustomerInvoiceRow>() : (from r in prototype.CustomerInvoiceRow
                                                                                                                                                 where r.State == (int)SoeEntityState.Active
                                                                                                                                                 orderby r.RowNr
                                                                                                                                                 select r).ToList();
                                    }
                                    else
                                    {
                                        prototypeRows = (from r in prototype.CustomerInvoiceRow
                                                         where r.State == (int)SoeEntityState.Active &&
                                                         (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer || !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))) &&
                                                         !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OfferClosedIds.Contains(r.AttestStateId.Value))
                                                         orderby r.RowNr
                                                         select r).ToList();
                                    }


                                    //Validate which rows that should be transferred
                                    foreach (var prototypeRow in prototypeRows)
                                    {
                                        bool overrideValidation = false;

                                        // Calculate centrounding later
                                        if (prototypeRow.IsCentRoundingRow)
                                            continue;

                                        if (prototypeRow.IsInvoiceFeeRow)
                                        {
                                            if (invoiceFeeAdded)
                                                continue;
                                            else
                                                invoiceFeeAdded = true;
                                        }

                                        //Only transfer rows with product
                                        if (prototypeRow.Type == (int)SoeInvoiceRowType.AccountingRow && prototypeRow.Product == null)
                                            continue;

                                        if ((finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer) && prototypeRow.AttestStateId.HasValue && prototypeRow.AttestStateId.Value == attestStateTransferred.AttestStateId && prototypeRow.Product != null)
                                        {
                                            InvoiceProduct product = prototypeRow.ProductId.HasValue ? ProductManager.GetInvoiceProduct(entities, prototypeRow.ProductId.Value) : null;
                                            if (product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                            {
                                                if (!prototypeRow.TargetRowReference.IsLoaded)
                                                    prototypeRow.TargetRowReference.Load();

                                                if (prototypeRow.TargetRow != null)
                                                {
                                                    var targetRow = prototypeRow.TargetRow;

                                                    if (!targetRow.TargetRowReference.IsLoaded)
                                                        targetRow.TargetRowReference.Load();

                                                    // Lift has already been withdrawn from an invoice
                                                    if (targetRow.TargetRow != null && targetRow.State == (int)SoeEntityState.Active)
                                                        continue;
                                                }

                                                overrideValidation = true;
                                            }
                                            else
                                                continue;
                                        }
                                        else
                                        {
                                            //Already transferred (not used for invoice fee, freight and contracts)
                                            if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice && originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                            {
                                                if (prototypeRow.AttestStateId == attestStateTransferred.AttestStateId)
                                                    continue;
                                            }
                                            else
                                            {
                                                if (hasFlatPriceKeepPricesRowsToTransfer && prototypeRow.ProductId == fixedPriceKeepPricesProductId && !IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions))
                                                {
                                                    hasFlatPriceKeepPricesRowsToTransfer = false;
                                                    overrideValidation = false;
                                                }
                                            }
                                        }

                                        //Validation check: Only rows with correct state. FixedPriceOrders are valid when all flat-price rows are valid
                                        //Not used for contracts, invoice fee or freight amount rows
                                        bool isValid = true;
                                        if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice && originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                        {
                                            isValid = overrideValidation ? true : IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions);
                                            if (isValid)
                                                hasValidProductRows = true; //Has at least one valid product row (i.e. not IsInvoiceFee or IsFreightAmountRow). Prevent empty invoices with only InvoiceFee or Freight
                                        }
                                        else if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder))
                                            hasValidProductRows = true;

                                        if (isValid)
                                            rowsToBeTransferredTotal += prototypeRow.SumAmountCurrency;

                                        prototypeRowsValidationDict.Add(prototypeRow.CustomerInvoiceRowId, isValid);
                                    }

                                    //Must have at least one row that has valid state
                                    int noOfValidatedPrototypeRows = prototypeRowsValidationDict.Count(i => i.Value);
                                    if (((noOfValidatedPrototypeRows > 0 && hasValidProductRows) || originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder) && hasValidAccounting)
                                    {
                                        validatedPrototypes++;
                                    }
                                    else
                                    {
                                        invalidatedPrototypes++;
                                        continue;
                                    }

                                    #endregion

                                    #region Process prototype

                                    prototypeCounter++;

                                    // Contract properties
                                    TermGroup_ContractGroupPriceManagement priceManagement = TermGroup_ContractGroupPriceManagement.Fixed;
                                    string invoiceTextRow = null;

                                    if (isMaster)
                                    {
                                        #region Master

                                        //Reset counters
                                        rowNr = 0;
                                        accountRowNr = 1; // Claim row will get number 1

                                        #region CustomerInvoice

                                        clone = CopyCustomerInvoice(entities, prototype, originTypeTo, false);
                                        entities.Invoice.AddObject(clone);

                                        clone.PrintTimeReport = prototype.PrintTimeReport;
                                        clone.IncludeOnlyInvoicedTime = prototype.IncludeOnlyInvoicedTime;

                                        if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                        {
                                            if (clone.ActorId == null || clone.ActorId == 0)
                                                clone.ActorId = prototype.AgreementActorIdForServiceOrder;

                                            clone.Origin.Description = String.Empty;
                                            clone.IsTemplate = false;
                                        }

                                        // Set order number
                                        if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice)
                                        {
                                            clone.OrderNumbers = prototype.InvoiceNr;
                                            if(merge && prototype.IncludeOnInvoice && !string.IsNullOrEmpty(prototype.WorkingDescription))
                                            {
                                                clone.IncludeOnInvoice = true;
                                                clone.WorkingDescription = GetText(3797, "Order") + ": " + prototype.WorkingDescription;
                                            }
                                        }

                                        // Check customer invoice email
                                        if (clone.ActorId.HasValue)
                                        {
                                            Customer customer = null;
                                            if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder && prototype.ActorId == null)
                                                customer = CustomerManager.GetCustomer(entities, prototype.AgreementActorIdForServiceOrder);
                                            else
                                                customer = prototype.Actor.ActorId == clone.ActorId.Value && prototype.Actor?.Customer != null ? prototype.Actor.Customer : CustomerManager.GetCustomer(entities, clone.ActorId.Value);

                                            if (originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                            {
                                                if (customer != null && customer.OrderContactEComId.GetValueOrDefault() > 0)
                                                    clone.ContactEComId = customer.OrderContactEComId;
                                                else if (customer != null && customer.ContactEComId.GetValueOrDefault() > 0)
                                                    clone.ContactEComId = customer.ContactEComId;
                                            }
                                            else
                                            {
                                                if (customer != null && customer.ContactEComId.GetValueOrDefault() > 0)
                                                    clone.ContactEComId = customer.ContactEComId;
                                            }

                                            if (customer != null && (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice))
                                            {
                                                if (!clone.InvoiceDeliveryType.HasValue && customer.InvoiceDeliveryType.HasValue)
                                                    clone.InvoiceDeliveryType = customer.InvoiceDeliveryType;

                                                clone.InvoiceDeliveryProvider = customer.InvoiceDeliveryProvider;
                                            }
                                        }

                                        #region Reset values

                                        clone.InvoiceNr = "";
                                        clone.SeqNr = null;
                                        clone.PaidAmount = 0;
                                        clone.PaidAmountCurrency = 0;
                                        clone.FullyPayed = false;
                                        clone.BillingInvoicePrinted = false;
                                        clone.RemainingAmount = 0;
                                        clone.OCR = "";
                                        clone.StatusIcon = 0;

                                        if (originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                        {
                                            // Order planning
                                            clone.ShiftTypeId = null;
                                            clone.PlannedStartDate = null;
                                            clone.PlannedStopDate = null;
                                            clone.EstimatedTime = 0;
                                            clone.RemainingTime = 0;
                                            clone.KeepAsPlanned = false;
                                            clone.Priority = null;
                                        }
                                        else
                                        {
                                            clone.ContractGroupId = null;
                                            clone.NextContractPeriodDate = null;
                                            clone.NextContractPeriodYear = 0;
                                            clone.NextContractPeriodValue = 0;
                                        }

                                        #endregion

                                        #region Set new values

                                        //Status
                                        if (setStatusToOrigin)
                                            clone.Origin.Status = (int)SoeOriginStatus.Origin;

                                        //OrderDate
                                        if (originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                        {
                                            if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && showPurchaseDateOnInvoice)
                                                clone.OrderDate = prototype.OrderDate.HasValue ? prototype.OrderDate.Value : (DateTime?)null;
                                            else
                                                clone.OrderDate = prototype.OrderDate.HasValue ? prototype.OrderDate.Value : prototype.InvoiceDate;
                                        }

                                        if (setContractInvoiceDate && (originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder))
                                            clone.InvoiceDate = prototype.NextContractPeriodDate;
                                        else
                                            clone.InvoiceDate = (setStatusToOrigin && (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)) ? DateTime.Now.Date : (DateTime?)null;

                                        //VoucherDate
                                        clone.VoucherDate = clone.InvoiceDate.HasValue ? clone.InvoiceDate.Value : (DateTime?)null;

                                        //DueDate
                                        clone.DueDate = clone.InvoiceDate.HasValue ? clone.InvoiceDate.Value : (DateTime?)null;
                                        if (prototype.PaymentCondition != null && clone.DueDate.HasValue)
                                        {
                                            if (prototype.PaymentCondition.StartOfNextMonth)
                                            {
                                                clone.DueDate = CalendarUtility.GetEndOfMonth(clone.DueDate.Value).AddDays(1).Date;
                                            }
                                            clone.DueDate = clone.DueDate.Value.AddDays(prototype.PaymentCondition.Days);
                                        }

                                        #endregion

                                        //Previous position of sequence number

                                        #endregion

                                        #region OriginUser

                                        foreach (var prototypeOriginUser in prototype.Origin.OriginUser.Where(o => o.State == (int)SoeEntityState.Active))
                                        {
                                            if (!prototypeOriginUser.UserReference.IsLoaded)
                                                prototypeOriginUser.UserReference.Load();
                                            if (!prototypeOriginUser.RoleReference.IsLoaded)
                                                prototypeOriginUser.RoleReference.Load();

                                            OriginUser cloneOriginUser = new OriginUser
                                            {
                                                Origin = clone.Origin,
                                                User = prototypeOriginUser.User,
                                                Role = prototypeOriginUser.Role,
                                                Main = prototypeOriginUser.Main,
                                            };
                                            SetCreatedProperties(cloneOriginUser);
                                            clone.Origin.OriginUser.Add(cloneOriginUser);
                                        }

                                        #endregion

                                        #endregion
                                    }
                                    else
                                    {
                                        // Set order number
                                        if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice)
                                            clone.OrderNumbers += ", " + prototype.InvoiceNr;

                                        // Check dim accounts
                                        if (clone.DefaultDim1AccountId != prototype.DefaultDim1AccountId)
                                            clone.DefaultDim1AccountId = (int?)null;
                                        if (clone.DefaultDim2AccountId != prototype.DefaultDim2AccountId)
                                            clone.DefaultDim2AccountId = (int?)null;
                                        if (clone.DefaultDim3AccountId != prototype.DefaultDim3AccountId)
                                            clone.DefaultDim3AccountId = (int?)null;
                                        if (clone.DefaultDim4AccountId != prototype.DefaultDim4AccountId)
                                            clone.DefaultDim4AccountId = (int?)null;
                                        if (clone.DefaultDim5AccountId != prototype.DefaultDim5AccountId)
                                            clone.DefaultDim5AccountId = (int?)null;
                                        if (clone.DefaultDim6AccountId != prototype.DefaultDim6AccountId)
                                            clone.DefaultDim6AccountId = (int?)null;

                                        if (merge && prototype.IncludeOnInvoice && !string.IsNullOrEmpty(prototype.WorkingDescription))
                                        {
                                            clone.IncludeOnInvoice = true;
                                            clone.WorkingDescription += string.IsNullOrEmpty(clone.WorkingDescription) ? GetText(3797, "Order") + ": " + prototype.WorkingDescription : "\n" + GetText(3797, "Order") + ": " + prototype.WorkingDescription;
                                        }
                                    }

                                    #region Contract values

                                    if (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice)
                                    {
                                        if (!prototype.ContractGroupReference.IsLoaded)
                                            prototype.ContractGroupReference.Load();

                                        TermGroup_ContractGroupPeriod period = (TermGroup_ContractGroupPeriod)prototype.ContractGroup.Period;
                                        Tuple<int, int> nextPeriod = CalendarUtility.CalculateNextPeriod(period, prototype.ContractGroup.Interval, prototype.NextContractPeriodYear, prototype.NextContractPeriodValue);
                                        nextContractPeriodYear = nextPeriod.Item1;
                                        nextContractPeriodValue = nextPeriod.Item2;
                                        nextContractPeriodDate = CalendarUtility.ConvertContractPeriodToDate(period, prototype.InvoiceDate.Value, nextContractPeriodYear, nextContractPeriodValue, prototype.ContractGroup.DayInMonth);

                                        if (prototype.NextContractPeriodDate != null && nextContractPeriodDate != null)
                                        {
                                            DateTime currentContractPeriodDate = CalendarUtility.ConvertContractPeriodToDate(period, prototype.NextContractPeriodDate.Value, prototype.NextContractPeriodYear, prototype.NextContractPeriodValue, prototype.ContractGroup.DayInMonth);

                                            numberOfDaysInPeriod = (nextContractPeriodDate.Value - currentContractPeriodDate).Days;
                                        }

                                        clone.ContractGroup = null;
                                        clone.NextContractPeriodYear = 0;
                                        clone.NextContractPeriodValue = 0;

                                        //Make sure ContractGroup is loaded
                                        if (!prototype.ContractGroupReference.IsLoaded)
                                            prototype.ContractGroupReference.Load();

                                        // Get values from contract group
                                        if (prototype.ContractGroup != null)
                                        {
                                            if (isMaster)
                                                priceManagement = (TermGroup_ContractGroupPriceManagement)prototype.ContractGroup.PriceManagement;

                                            if (!String.IsNullOrEmpty(prototype.ContractGroup.InvoiceText))
                                                clone.InvoiceText = EntityUtil.ParseEntityTaggedText<CustomerInvoice>(prototype, prototype.ContractGroup.InvoiceText);

                                            if (!String.IsNullOrEmpty(prototype.ContractGroup.InvoiceTextRow))
                                                invoiceTextRow = EntityUtil.ParseEntityTaggedText<CustomerInvoice>(prototype, prototype.ContractGroup.InvoiceTextRow);
                                        }

                                        if (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder && prototype.OrderType == (int)TermGroup_OrderType.Unspecified)
                                            clone.OrderType = (int)TermGroup_OrderType.Contract;
                                    }
                                    else if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                    {
                                        if (prototype.OrderType == (int)TermGroup_OrderType.Unspecified)
                                            clone.OrderType = (int)TermGroup_OrderType.Service;
                                    }
                                    else if (originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder)
                                    {
                                        clone.OrderType = (int)TermGroup_OrderType.Project;
                                        clone.InvoiceDate = DateTime.Today;
                                    }

                                    #endregion

                                    #region OriginInvoiceMapping
                                    if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                    {
                                        //Add prototype to clone's mapping
                                        OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                                        {
                                            Type = (int)SoeOriginInvoiceMappingType.Contract,
                                            OriginId = prototype.RegistrationType == (int)OrderInvoiceRegistrationType.Contract ? prototype.InvoiceId : prototype.AgreementOriginIdForServiceOrder,
                                        };
                                        clone.OriginInvoiceMapping.Add(oimap);
                                    }
                                    else
                                    {
                                        //Add prototype to clone's mapping
                                        OriginInvoiceMapping oimap = new OriginInvoiceMapping()
                                        {
                                            Type = (int)GetOriginInvoiceMappingType(prototype),

                                            //Set references
                                            Origin = prototype.Origin,
                                        };
                                        clone.OriginInvoiceMapping.Add(oimap);
                                    }

                                    #endregion

                                    #endregion

                                    #region Process prototype rows

                                    #region InvoiceTextRow - ContractGroup

                                    if ((originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice) && !String.IsNullOrEmpty(invoiceTextRow))
                                    {
                                        rowNr++;

                                        // Insert text row at beginning
                                        clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                        {
                                            RowNr = rowNr,
                                            Type = (int)SoeInvoiceRowType.TextRow,
                                            Text = invoiceTextRow,
                                            AttestStateId = attestStateOrderInitialId,
                                        });
                                    }

                                    #endregion

                                    #region InvoiceTextRow - Merge information

                                    if (merge)
                                    {
                                        //Add textrow, describing which offer/order/contract the subsequently rows comes from
                                        string text = "";
                                        bool addRow = true;

                                        switch (originStatusChange)
                                        {
                                            case SoeOriginStatusChange.Billing_OfferToOrder:
                                            case SoeOriginStatusChange.Billing_OfferToInvoice:
                                                text = GetText(5346, "Från offert") + " " + prototype.InvoiceNr;
                                                break;
                                            case SoeOriginStatusChange.Billing_OrderToInvoice:
                                                var useExtendedInfo = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingOrderMergeOrderWithExtendedInfo, 0, actorCompanyId, 0);
                                                if (useExtendedInfo)
                                                {
                                                    #region ExtendedInfo
                                                    addRow = false;

                                                    if (prototypeCounter > 1)
                                                    {
                                                        // Not the first so add empty row to seperate
                                                        clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                        {
                                                            RowNr = ++rowNr,
                                                            Type = (int)SoeInvoiceRowType.TextRow,
                                                            Text = string.Empty,
                                                        });
                                                    }

                                                    text = GetText(5347, "Från order") + ": " + prototype.InvoiceNr +
                                                        "          " +
                                                        (!string.IsNullOrEmpty(prototype.ReferenceOur) && useOurReferenceOnMerge ? GetText(3291, "Vår referens") + ": " + prototype.ReferenceOur + "          " : string.Empty) +
                                                        (prototype.DeliveryDate.HasValue ? GetText(9115, "Levdatum") + ": " + prototype.DeliveryDate.Value.ToShortDateString() : string.Empty);

                                                    clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                    {
                                                        RowNr = ++rowNr,
                                                        Type = (int)SoeInvoiceRowType.TextRow,
                                                        Text = text,
                                                    });

                                                    if (!string.IsNullOrEmpty(prototype.ReferenceYour))
                                                    {
                                                        text = GetText(9116, "Er ref") + ": " + prototype.ReferenceYour;
                                                        clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                        {
                                                            RowNr = ++rowNr,
                                                            Type = (int)SoeInvoiceRowType.TextRow,
                                                            Text = text,
                                                        });
                                                    }

                                                    if (!string.IsNullOrEmpty(prototype.InvoiceLabel))
                                                    {
                                                        text = GetText(9117, "Märkning") + ": " + prototype.InvoiceLabel;
                                                        clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                                        {
                                                            RowNr = ++rowNr,
                                                            Type = (int)SoeInvoiceRowType.TextRow,
                                                            Text = text,
                                                        });
                                                    }
                                                    #endregion
                                                }
                                                else
                                                {
                                                    text = GetText(5347, "Från order") + " " + prototype.InvoiceNr;
                                                }
                                                break;
                                            case SoeOriginStatusChange.Billing_ContractToOrder:
                                            case SoeOriginStatusChange.Billing_ContractToInvoice:
                                                text = GetText(3456, "Från avtal") + " " + prototype.InvoiceNr;
                                                break;
                                        }

                                        if (addRow)
                                        {
                                            clone.CustomerInvoiceRow.Add(new CustomerInvoiceRow()
                                            {
                                                RowNr = ++rowNr,
                                                Type = (int)SoeInvoiceRowType.TextRow,
                                                Text = text,
                                            });
                                        }
                                    }

                                    #endregion

                                    decimal cloneSumAmount = 0;
                                    decimal cloneSumAmountCurrency = 0;
                                    decimal cloneSumAmountEntCurrency = 0;
                                    decimal cloneSumAmountLedgerCurrency = 0;
                                    var hasFixedPriceRows = false;
                                    foreach (CustomerInvoiceRow prototypeRow in prototypeRows)
                                    {
                                        #region Prereq

                                        InvoiceProductSmallDTO product = null;

                                        //Check if row exists in dict, i.e. should be transferred at all
                                        int key = prototypeRow.CustomerInvoiceRowId;
                                        if (!prototypeRowsValidationDict.ContainsKey(key))
                                            continue;

                                        //Check if row is valid, i.e. has correct state to be transferred, wich decides if the offer/order is partly or fully transferred
                                        if (prototypeRowsValidationDict[key] == false)
                                        {
                                            //FixedPriceOrders are valid when all flat-price rows are valid
                                            if (!prototype.FixedPriceOrder || (prototypeRow.ProductId.HasValue && prototypeRow.ProductId.Value == fixedPriceProductId))
                                                prototypeHasInvalidatedRows = true;

                                            continue;
                                        }

                                        if (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer)
                                        {
                                            product = prototypeRow.ProductId.HasValue ? ProductManager.GetInvoiceProductSmall(entities, prototypeRow.ProductId.Value, actorCompanyId) : null;
                                            if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                                            {
                                                if (prototypeRow.AttestStateId != attestStateTransferred.AttestStateId)
                                                {
                                                    // Since lift is not previously handled and its final invoicing, set atteststate but add no row to clone
                                                    prototypeRow.AttestStateId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : (int?)null;
                                                    continue;
                                                }
                                            }
                                        }

                                        var prototypeAccountRows = (from r in prototypeRow.CustomerInvoiceAccountRow
                                                                    where r.State == (int)SoeEntityState.Active
                                                                    orderby r.RowNr
                                                                    select r).ToList();

                                        #endregion

                                        #region Contract and days

                                        int noOfDays = 0;
                                        bool setContractSum = false;
                                        string rowPeriodDates = string.Empty;

                                        //Check if from contract and row has to and/or from date
                                        if ((originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice || originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder) && numberOfDaysInPeriod != null)
                                        {
                                            if (prototypeRow.Date != null && prototypeRow.DateTo != null)
                                            {
                                                if (prototypeRow.Date >= nextContractPeriodDate)
                                                    continue;

                                                if (prototypeRow.DateTo <= prototype.NextContractPeriodDate)
                                                    continue;

                                                noOfDays = numberOfDaysInPeriod.Value;

                                                if (prototypeRow.Date > prototype.NextContractPeriodDate)
                                                {
                                                    noOfDays = (nextContractPeriodDate.Value - prototypeRow.Date.Value).Days;
                                                    rowPeriodDates = prototypeRow.Date.Value.ToShortDateString() + " - ";
                                                }
                                                else
                                                {
                                                    rowPeriodDates = prototype.NextContractPeriodDate.Value.ToShortDateString() + " - ";
                                                }

                                                if (prototypeRow.DateTo < nextContractPeriodDate)
                                                {
                                                    noOfDays = (noOfDays - (nextContractPeriodDate.Value - prototypeRow.DateTo.Value).Days);
                                                    rowPeriodDates += prototypeRow.DateTo.Value.ToShortDateString();
                                                }
                                                else
                                                {
                                                    rowPeriodDates += nextContractPeriodDate.Value.AddDays(-1).ToShortDateString();
                                                }

                                                if (noOfDays < numberOfDaysInPeriod)
                                                {
                                                    setContractSum = true;
                                                }
                                            }
                                            else if (prototypeRow.Date != null)
                                            {
                                                if (prototypeRow.Date > prototype.NextContractPeriodDate)
                                                {
                                                    if (prototypeRow.Date >= nextContractPeriodDate)
                                                        continue;

                                                    rowPeriodDates = prototypeRow.Date.Value.ToShortDateString() + " - " + nextContractPeriodDate.Value.AddDays(-1).ToShortDateString();
                                                    noOfDays = (nextContractPeriodDate.Value - prototypeRow.Date.Value).Days;
                                                    setContractSum = true;
                                                }

                                            }
                                            else if (prototypeRow.DateTo != null)
                                            {
                                                if (prototypeRow.DateTo < nextContractPeriodDate)
                                                {
                                                    if (prototypeRow.DateTo <= prototype.NextContractPeriodDate)
                                                        continue;

                                                    rowPeriodDates = prototype.NextContractPeriodDate.Value.ToShortDateString() + " - " + prototypeRow.DateTo.Value.ToShortDateString();
                                                    noOfDays = (prototypeRow.DateTo.Value - prototype.NextContractPeriodDate.Value).Days;
                                                    setContractSum = true;
                                                }
                                            }
                                        }

                                        #endregion

                                        #region CustomerInvoiceRow

                                        if (prototypeRow.RowNr > 0)
                                            rowNr++;

                                        bool resetAccountingRows = false;

                                        //Clone
                                        CustomerInvoiceRow cloneRow = CopyCustomerInvoiceRow(entities, prototypeRow);
                                        CustomerInvoiceRow cloneRestRow = null;

                                        if (cloneRow.ProductId.GetValueOrDefault() > 0)
                                        {
                                            product = ProductManager.GetInvoiceProductSmall(entities, cloneRow.ProductId.Value, actorCompanyId);
                                        }

                                        //Check for partial invoicing
                                        if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && checkPartialInvoicing && prototypeRow.InvoiceQuantity > 0)
                                        {
                                            if (prototypeRow.Quantity > prototypeRow.InvoiceQuantity)
                                            {
                                                if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Contract)
                                                {
                                                    cloneRow.Quantity = cloneRow.InvoiceQuantity = prototypeRow.InvoiceQuantity;
                                                    CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);
                                                }
                                                else
                                                {
                                                    decimal? cloneRowQuantity = prototypeRow.InvoiceQuantity;
                                                    cloneRestRow = HandlePartialInvoicing(entities, transaction, prototype, prototypeRow, false);

                                                    cloneRow.Quantity = cloneRow.InvoiceQuantity = cloneRowQuantity;
                                                    CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);

                                                    recalculatePrototype = true;
                                                    prototypeHasInvalidatedRows = true;
                                                    resetAccountingRows = true;
                                                }
                                            }
                                        }

                                        // Check if contract product
                                        if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && copyTransferredContractRows)
                                        {
                                            if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Contract)
                                            {
                                                recalculatePrototype = true;

                                                cloneRestRow = CopyCustomerInvoiceRow(entities, prototypeRow);
                                                cloneRestRow.Quantity = prototypeRow.InvoiceQuantity;
                                                cloneRestRow.InvoiceQuantity = 0;
                                                cloneRestRow.ParentRow = prototypeRow;
                                                CalculateRowSum(cloneRestRow, prototype.CurrencyRate, 0);
                                                prototype.CustomerInvoiceRow.Add(cloneRestRow);

                                                prototypeRow.InvoiceQuantity = 0;
                                                CalculateRowSum(prototypeRow, prototype.CurrencyRate, 0);

                                                prototypeHasInvalidatedRows = true;
                                                resetAccountingRows = true;
                                            }
                                        }

                                        //Check if lift and recalculate
                                        if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && cloneRow.ProductId != null)
                                        {
                                            if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                                            {
                                                cloneRow.Amount = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.Amount : Decimal.Negate(cloneRow.Amount);
                                                cloneRow.AmountCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountCurrency : Decimal.Negate(cloneRow.AmountCurrency);
                                                cloneRow.AmountEntCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountEntCurrency : Decimal.Negate(cloneRow.AmountEntCurrency);
                                                cloneRow.AmountLedgerCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountLedgerCurrency : Decimal.Negate(cloneRow.AmountLedgerCurrency);

                                                if (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer)
                                                {
                                                    if (!prototypeRow.TargetRowReference.IsLoaded)
                                                        prototypeRow.TargetRowReference.Load();

                                                    if (prototypeRow.TargetRow != null)
                                                    {
                                                        if (!prototypeRow.TargetRow.CustomerInvoiceReference.IsLoaded)
                                                            prototypeRow.TargetRow.CustomerInvoiceReference.Load();

                                                        if (prototypeRow.TargetRow.CustomerInvoice != null && prototypeRow.TargetRow.CustomerInvoice.InvoiceNr.Trim() != String.Empty)
                                                        {
                                                            cloneRow.Text += " - " + GetText(7713, "tidigare fakturerad, fakturanr") + " " + prototypeRow.TargetRow.CustomerInvoice.InvoiceNr;
                                                        }
                                                        else
                                                        {
                                                            cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                        }
                                                    }
                                                    else
                                                    {
                                                        cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                    }
                                                }

                                                CalculateRowSum(cloneRow, prototype.CurrencyRate, 0, clone.PriceListTypeInclusiveVat);

                                                resetAccountingRows = true;

                                                if (product.GuaranteePercentage.HasValue && product.GuaranteePercentage > 0)
                                                {
                                                    // Update the order
                                                    var liftRow = prototypeRow;
                                                    var guaranteeProd = this.GetCustomerInvoiceRows(entities, prototype.InvoiceId, false).FirstOrDefault(p => p.ProductId == guaranteeProductId && p.AttestStateId.HasValue && p.AttestStateId.Value == attestStateOrderInitialId);
                                                    if (guaranteeProd != null)
                                                    {
                                                        decimal percentage = (product.GuaranteePercentage.Value / 100);
                                                        guaranteeProd.Amount += cloneRow.Amount * percentage;
                                                        guaranteeProd.AmountCurrency += cloneRow.AmountCurrency * percentage;
                                                        guaranteeProd.AmountEntCurrency += cloneRow.AmountEntCurrency * percentage;
                                                        guaranteeProd.AmountLedgerCurrency += cloneRow.AmountLedgerCurrency * percentage;
                                                        CalculateRowSum(guaranteeProd, prototype.CurrencyRate, 0);

                                                        CustomerInvoiceRow liftCloneRow = CopyCustomerInvoiceRow(entities, guaranteeProd);
                                                        liftCloneRow.Amount = Decimal.Negate(cloneRow.Amount * percentage);
                                                        liftCloneRow.AmountCurrency = Decimal.Negate(cloneRow.AmountCurrency * percentage);
                                                        liftCloneRow.AmountEntCurrency = Decimal.Negate(cloneRow.AmountEntCurrency * percentage);
                                                        liftCloneRow.AmountLedgerCurrency = Decimal.Negate(cloneRow.AmountLedgerCurrency * percentage);
                                                        CalculateRowSum(liftCloneRow, prototype.CurrencyRate, 0);

                                                        // Add accounting for the liftRow
                                                        CreateCustomerInvoiceAccountRow(entities, liftCloneRow, (TermGroup_InvoiceVatType)prototype.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, clone.DefaultDim2AccountId, clone.DefaultDim3AccountId, clone.DefaultDim4AccountId, clone.DefaultDim5AccountId, clone.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);

                                                        clone.CustomerInvoiceRow.Add(liftCloneRow);
                                                    }
                                                }
                                            }
                                            else if (product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                                            {
                                                cloneRow.Amount = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.Amount : Decimal.Negate(cloneRow.Amount);
                                                cloneRow.AmountCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountCurrency : Decimal.Negate(cloneRow.AmountCurrency);
                                                cloneRow.AmountEntCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountEntCurrency : Decimal.Negate(cloneRow.AmountEntCurrency);
                                                cloneRow.AmountLedgerCurrency = finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer ? cloneRow.AmountLedgerCurrency : Decimal.Negate(cloneRow.AmountLedgerCurrency);

                                                if (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer)
                                                {
                                                    if (!prototypeRow.TargetRowReference.IsLoaded)
                                                        prototypeRow.TargetRowReference.Load();

                                                    if (prototypeRow.TargetRow != null)
                                                    {
                                                        if (!prototypeRow.TargetRow.CustomerInvoiceReference.IsLoaded)
                                                            prototypeRow.TargetRow.CustomerInvoiceReference.Load();

                                                        if (prototypeRow.TargetRow.CustomerInvoice != null && prototypeRow.TargetRow.CustomerInvoice.InvoiceNr.Trim() != String.Empty)
                                                        {
                                                            cloneRow.Text += " - " + GetText(7713, "tidigare fakturerad, fakturanr") + " " + prototypeRow.TargetRow.CustomerInvoice.InvoiceNr;
                                                        }
                                                        else
                                                        {
                                                            cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                        }
                                                    }
                                                    else
                                                    {
                                                        cloneRow.Text += " - " + GetText(7714, "tidigare fakturerad");
                                                    }
                                                }

                                                CalculateRowSum(cloneRow, prototype.CurrencyRate, 0);
                                                resetAccountingRows = true;
                                            }
                                            else if (product.ProductId == guaranteeProductId)
                                            {
                                                // Reset accounting rows for the guaranteeProduct (should not have accounting)
                                                if (prototypeAccountRows.Count == 0)
                                                    resetAccountingRows = true;
                                            }
                                        }

                                        //Check household
                                        prototypeRow.LoadHouseholdTaxDeductionRowReference();
                                        //if (!prototypeRow.HouseholdTaxDeductionRowReference.IsLoaded)
                                        //    prototypeRow.HouseholdTaxDeductionRowReference.Load();

                                        if (prototypeRow.HouseholdTaxDeductionRow != null && prototypeRow.HouseholdTaxDeductionRow.State == (int)SoeEntityState.Active)
                                            hasHouseholdTaxDeduction = true;

                                        //Set new values
                                        if (cloneRestRow == null)
                                        {
                                            cloneRow.RowNr = prototypeRow.RowNr == 0 ? 0 : rowNr;
                                            if (originTypeTo == SoeOriginType.Order)
                                                cloneRow.AttestStateId = attestStateOrderInitialId; //attestStateOrderInitial when SoeOriginStatusChange is Billing_ContractToInvoice
                                            prototypeRow.AttestStateId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : (int?)null; //attestStateTransferred is null when  SoeOriginStatusChange is Billing_ContractToOrder or Billing_ContractToInvoice
                                        }
                                        else
                                        {
                                            cloneRow.RowNr = prototypeRow.RowNr == 0 ? 0 : rowNr;

                                            cloneRow.AttestStateId = attestStateOrderInitialId;
                                            prototypeRow.AttestStateId = attestStateOrderInitialId;
                                            cloneRestRow.AttestStateId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : (int?)null;
                                        }

                                        if ((originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice) &&
                                            priceManagement != TermGroup_ContractGroupPriceManagement.Fixed &&
                                            !cloneRow.IsCentRoundingRow && !cloneRow.IsFreightAmountRow && !cloneRow.IsInvoiceFeeRow)
                                        {
                                            if (priceManagement == TermGroup_ContractGroupPriceManagement.UpdateFromPriceList)
                                            {
                                                // Get price from current price list
                                                if (cloneRow.ProductId.HasValue && prototype.ActorId.HasValue)
                                                {
                                                    InvoiceProductPriceResult price = ProductManager.GetProductPrice(entities, actorCompanyId, new ProductPriceRequestDTO { ProductId = cloneRow.ProductId.Value, CustomerId = prototype.ActorId.Value, CurrencyId = prototype.CurrencyId });
                                                    // If no price found, keep original amount
                                                    if (price.SalesPrice != 0)
                                                    {
                                                        cloneRow.AmountCurrency = Decimal.Round(price.SalesPrice, 2);
                                                        cloneRow.Amount = Decimal.Round(cloneRow.AmountCurrency / prototype.CurrencyRate, 2);
                                                        cloneRow.PurchasePrice = Decimal.Round(price.PurchasePrice, 2);
                                                        CalculateRowSum(cloneRow, prototype.CurrencyRate, fixedPriceProductId);
                                                        resetAccountingRows = true;
                                                    }
                                                }
                                            }
                                        }

                                        if (setContractSum)
                                        {
                                            decimal sumPerDay = cloneRow.SumAmountCurrency / (int)numberOfDaysInPeriod;
                                            cloneRow.SumAmountCurrency = Decimal.Round(sumPerDay * noOfDays, 2);
                                            cloneRow.SumAmount = Decimal.Round(cloneRow.SumAmountCurrency / prototype.CurrencyRate, 2);
                                            cloneRow.Text += " - " + GetText(7717, "avser period") + " " + rowPeriodDates;
                                            resetAccountingRows = true;
                                        }

                                        if (cloneRow.IntrastatTransaction != null)
                                            cloneRow.IntrastatTransaction.Origin = clone.Origin;

                                        //Set CustomerInvoiceRow target
                                        if (originStatusChange != SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                        {
                                            if (cloneRestRow == null)
                                                prototypeRow.TargetRow = cloneRow;
                                            else
                                                cloneRestRow.TargetRow = cloneRow;
                                        }

                                        if (!hasFixedPriceRows && prototypeRow.ProductId.HasValue && prototypeRow.ProductId.Value == fixedPriceProductId)
                                            hasFixedPriceRows = true;

                                        //Keep relation, needed later to set parentrow
                                        prototypeRowDict.Add(prototypeRow.CustomerInvoiceRowId, cloneRow);

                                        #endregion

                                        if (resetAccountingRows)
                                        {
                                            CreateCustomerInvoiceAccountRow(entities, cloneRow, (TermGroup_InvoiceVatType)prototype.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, clone.DefaultDim2AccountId, clone.DefaultDim3AccountId, clone.DefaultDim4AccountId, clone.DefaultDim5AccountId, clone.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);

                                            if (cloneRestRow != null)
                                            {
                                                foreach (CustomerInvoiceAccountRow accRow in prototypeRow.CustomerInvoiceAccountRow)
                                                {
                                                    if (accRow.VatRow)
                                                    {
                                                        accRow.Amount = -prototypeRow.VatAmount;
                                                        accRow.AmountCurrency = -prototypeRow.VatAmountCurrency;
                                                    }
                                                    else
                                                    {
                                                        accRow.Amount = -prototypeRow.SumAmount;
                                                        accRow.AmountCurrency = -prototypeRow.SumAmountCurrency;
                                                    }

                                                    SetModifiedProperties(accRow);
                                                }

                                                CreateCustomerInvoiceAccountRow(entities, cloneRestRow, (TermGroup_InvoiceVatType)prototype.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, prototype.DefaultDim2AccountId, prototype.DefaultDim3AccountId, prototype.DefaultDim4AccountId, prototype.DefaultDim5AccountId, prototype.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);
                                            }

                                        }
                                        else
                                        {
                                            foreach (CustomerInvoiceAccountRow prototypeAccountRow in prototypeAccountRows)
                                            {
                                                #region CustomerInvoiceAccountRow

                                                //Clone
                                                var cloneAccountRow = CopyCustomerInvoiceAccountRow(prototypeAccountRow);

                                                //Set new values
                                                cloneAccountRow.RowNr = ++accountRowNr;

                                                cloneRow.CustomerInvoiceAccountRow.Add(cloneAccountRow);

                                                #endregion
                                            }
                                        }

                                        // Add to sum
                                        cloneSumAmount += cloneRow.SumAmount;
                                        cloneSumAmountCurrency += cloneRow.SumAmountCurrency;
                                        cloneSumAmountEntCurrency += cloneRow.SumAmountEntCurrency;
                                        cloneSumAmountLedgerCurrency += cloneRow.SumAmountLedgerCurrency;

                                        clone.CustomerInvoiceRow.Add(cloneRow);
                                    }

                                    if (createSubTotalRowOnMerge && merge)
                                    {
                                        var subTotalRow = new CustomerInvoiceRow()
                                        {
                                            RowNr = ++rowNr,
                                            Type = (int)SoeInvoiceRowType.SubTotalRow,
                                            Text = TermCacheManager.Instance.GetText(86, (int)TermGroup.InvoiceProductRows, "Delsumma", base.GetLangId()),

                                            SumAmount = cloneSumAmount,
                                            SumAmountCurrency = cloneSumAmountCurrency,
                                            SumAmountEntCurrency = cloneSumAmountEntCurrency,
                                            SumAmountLedgerCurrency = cloneSumAmountLedgerCurrency,
                                        };

                                        SetCreatedProperties(subTotalRow);
                                        clone.CustomerInvoiceRow.Add(subTotalRow);
                                    }

                                    #region Check currency rate change

                                    if ((clone.Origin.Type == (int)SoeOriginType.CustomerInvoice) &&
                                         (clone.Origin.Status == (int)SoeOriginStatus.Origin) &&
                                         (clone.InvoiceDate.HasValue && clone.CurrencyDate != clone.InvoiceDate.Value)
                                       )
                                    {
                                        ChangeCurrencyDate(entities, clone, clone.InvoiceDate.Value);

                                    }

                                    #endregion

                                    #region ParentRow

                                    foreach (CustomerInvoiceRow prototypeRow in prototypeRows)
                                    {
                                        if (prototypeRow.ParentRowId.HasValue && prototypeRowDict.ContainsKey(prototypeRow.ParentRowId.Value) && prototypeRowDict.ContainsKey(prototypeRow.CustomerInvoiceRowId))
                                        {
                                            //Get the equivalent clone rows
                                            CustomerInvoiceRow cloneRow = prototypeRowDict[prototypeRow.CustomerInvoiceRowId];
                                            CustomerInvoiceRow cloneParentRow = prototypeRowDict[prototypeRow.ParentRowId.Value];
                                            if (cloneRow != null && cloneParentRow != null)
                                                cloneRow.ParentRow = cloneParentRow;
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Final calculation and add clone

                                    //Set household value
                                    clone.HasHouseholdTaxDeduction = hasHouseholdTaxDeduction;

                                    if (!merge || prototypeCounter == prototypes.Count)
                                    {
                                        #region Calculate totals

                                        CalculateAmountsByCurrency(entities, clone, useCentRounding, actorCompanyId);

                                        //Copy values to Invoice in order to get information to customerinvoicereport.
                                        if (clone.Origin.Type == (int)SoeOriginType.CustomerInvoice && prototype.Origin.Type == (int)SoeOriginType.Order && prototype.FixedPriceOrder)
                                        {
                                            clone.RemainingAmount = prototype.RemainingAmount - clone.TotalAmount;
                                            clone.RemainingAmountExVat = prototype.RemainingAmountExVat - clone.SumAmount;
                                            clone.RemainingAmountVat = prototype.RemainingAmountVat - clone.VATAmount;
                                        }

                                        decimal sum = 0;
                                        decimal rowTotals = 0;
                                        foreach (CustomerInvoiceRow row in clone.CustomerInvoiceRow.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.SubTotalRow).OrderBy(r => r.RowNr))
                                        {
                                            if (row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                                            {
                                                row.SumAmountCurrency = sum;
                                                sum = 0;
                                            }
                                            else
                                            {
                                                sum += row.SumAmountCurrency;
                                            }

                                            rowTotals += row.SumAmountCurrency;
                                        }

                                        #endregion

                                        //Billing type fix if final invoicing and invoice total is negative aka credit
                                        if (rowTotals < 0 && clone.BillingType == (int)TermGroup_BillingType.Debit)
                                            clone.BillingType = (int)TermGroup_BillingType.Credit;

                                        if (isMaster)
                                        {
                                            #region Sequence number

                                            if (originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder ||
                                                originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder ||
                                                originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder ||
                                                ((originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice && setStatusToOrigin) || (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && setStatusToOrigin) || (originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice && setStatusToOrigin)))
                                            {
                                                // Get next sequence number
                                                int seqNbr = clone.SeqNr.HasValue ? clone.SeqNr.Value : 0;
                                                string entityName = String.Empty;
                                                int startNbr = 0;
                                                int invoiceNumberLength = 0;
                                                GetNextSequenceNumber(entities, (SoeOriginType)clone.Origin.Type, (SoeOriginStatus)clone.Origin.Status, (TermGroup_BillingType)clone.BillingType, actorCompanyId, ref seqNbr, ref entityName, ref startNbr, ref invoiceNumberLength, saveSeqNumber);
                                                clone.SeqNr = seqNbr;

                                                // Set invoice number to same as sequence number (padded to a specified number of digits)
                                                if (String.IsNullOrEmpty(clone.InvoiceNr))
                                                    clone.InvoiceNr = seqNbr.ToString().PadLeft(invoiceNumberLength, '0');
                                                //In Finland and Norway we need to create OCR again, because otherwise OCR is formatted from ordernumber, cannot copy ocr from order.
                                                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                                                if (company != null && company.SysCountryId != null && company.SysCountryId == (int)TermGroup_Country.FI)
                                                {
                                                    string tmpReference = prototype.Actor.Customer.CustomerNr.ToString() + "0000" + clone.InvoiceNr.ToString();
                                                    if (prototype.InvoiceNr != null && prototype.Actor.Customer.CustomerNr != null)
                                                    {
                                                        if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormFIReferenceNumberToOCR, 0, actorCompanyId, 0))
                                                        {
                                                            clone.OCR = InvoiceUtility.GetCheckedBankPaymentReference(tmpReference);  // Normal Finnish Bank Reference 
                                                        }
                                                        else
                                                        {
                                                            clone.OCR = InvoiceUtility.GetISO11649(InvoiceUtility.GetCheckedBankPaymentReference(tmpReference));
                                                        }
                                                    }
                                                    else
                                                    {
                                                        string errorCheck = "";
                                                        if (prototype.InvoiceNr == null) errorCheck += "A=null";
                                                        if (prototype.Actor.Customer.CustomerNr == null) errorCheck += "B=null";
                                                        clone.OCR = "Virhe(1):" + errorCheck;
                                                    }
                                                }
                                                else if (company != null && company.SysCountryId != null && company.SysCountryId == (int)TermGroup_Country.NO)
                                                {
                                                    clone.OCR = InvoiceUtility.GetNorwegianKIDNumber(clone.InvoiceNr.ToString(), prototype.Actor.Customer.CustomerNr.ToString(), clone.InvoiceDate.HasValue ? clone.InvoiceDate.Value : (DateTime)prototype.InvoiceDate, 0);
                                                }
                                                else
                                                {
                                                    //Sweden and the rest
                                                    //Since we don't have invoiceid on the not yet created invoice, we use the id from the order. Will still be unique.

                                                    if (SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingFormReferenceNumberToOCR, 0, actorCompanyId, 0))
                                                    {
                                                        clone.OCR = InvoiceUtility.GetSwedishOCRNumber(prototype.InvoiceId.ToString() + clone.SeqNr);
                                                    }
                                                    else
                                                    {
                                                        clone.OCR = string.Empty;
                                                    }
                                                }
                                            }

                                            #endregion
                                        }

                                        #region Add clone

                                        if (result.Success)
                                            entities.SaveChanges();

                                        clones.Add(clone);

                                        #endregion
                                    }

                                    int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                                    result = UpdateInvoiceAfterRowModification(entities, clone, clone.ActiveCustomerInvoiceRows.Count + 1, actorCompanyId, false, clone.CurrencyId != sysCurrencyIdBase);

                                    /*
                                    #region CustomerInvoiceRow - Claim row

                                    CustomerInvoiceRow productClaimRow = clone.CustomerInvoiceRow.FirstOrDefault(r => r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && !r.IsCentRoundingRow);
                                    if (productClaimRow == null)
                                    {
                                        #region Add

                                        #region CustomerInvoiceRow

                                        productClaimRow = new CustomerInvoiceRow()
                                        {
                                            Type = (int)SoeInvoiceRowType.AccountingRow,
                                            DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                                            Amount = clone.TotalAmount,
                                            AmountCurrency = clone.TotalAmountCurrency,
                                            SumAmount = clone.TotalAmount,
                                            SumAmountCurrency = clone.TotalAmountCurrency,
                                        };
                                        SetCreatedProperties(productClaimRow);
                                        clone.CustomerInvoiceRow.Add(productClaimRow);

                                        #endregion

                                        #region CustomerInvoiceAccountRow

                                        CustomerInvoiceAccountRow productClaimAccountRow = null;
                                        AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, 0, prototype.ActorId.Value, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)clone.VatType, false);
                                        if (prioDTO != null && prioDTO.AccountId.HasValue)
                                        {
                                            var isCredit = (clone.TotalAmount < 0);

                                            productClaimAccountRow = new CustomerInvoiceAccountRow()
                                            {
                                                RowNr = 1,
                                                AccountId = prioDTO.AccountId.Value,
                                                Amount = clone.TotalAmount,
                                                AmountCurrency = clone.TotalAmountCurrency,
                                                DebitRow = !isCredit,
                                                CreditRow = isCredit,
                                            };
                                            productClaimRow.CustomerInvoiceAccountRow.Add(productClaimAccountRow);
                                        }

                                        #endregion

                                        #region Cent rounding row

                                        if (useCentRounding)
                                        {
                                            decimal centAmount = clone.CentRounding;

                                            // Get cent rounding product row
                                            CustomerInvoiceRow productCentRow = clone.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                                            if (productCentRow != null && productCentRow.Product != null)
                                            {
                                                // Add a cent rounding account row
                                                prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productCentRow.Product.ProductId, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)clone.VatType, false);
                                                if (prioDTO != null && prioDTO.AccountId.HasValue)
                                                {
                                                    //get currency amount for cent rounding row
                                                    decimal centAmountCurrency = productCentRow.AmountCurrency;

                                                    // A positive cent amount from the product row will be a credit accounting row
                                                    bool isCreditRow = centAmount > 0;
                                                    centAmount = Math.Abs(centAmount);
                                                    centAmountCurrency = Math.Abs(centAmountCurrency);
                                                    if (isCreditRow)
                                                    {
                                                        centAmount = -centAmount;
                                                        centAmountCurrency = -centAmountCurrency;
                                                    }

                                                    accountRowNr++;

                                                    CustomerInvoiceAccountRow centRow = new CustomerInvoiceAccountRow()
                                                    {
                                                        RowNr = accountRowNr,
                                                        AccountId = prioDTO.AccountId.Value,
                                                        Quantity = 1,
                                                        Amount = centAmount,
                                                        AmountCurrency = centAmountCurrency,
                                                        DebitRow = !isCreditRow,
                                                        CreditRow = isCreditRow
                                                    };

                                                    productCentRow.CustomerInvoiceAccountRow.Add(centRow);
                                                }
                                            }
                                        }

                                        // Update amount on claim row after calculation
                                        if (productClaimAccountRow != null)
                                        {
                                            productClaimAccountRow.Amount = clone.TotalAmount;
                                            productClaimAccountRow.AmountCurrency = clone.TotalAmountCurrency;
                                        }

                                        #endregion

                                        #endregion
                                    }
                                    else
                                    {
                                        #region Update

                                        #region CustomerInvoiceRow

                                        productClaimRow.Amount = clone.TotalAmount;
                                        productClaimRow.SumAmount = clone.TotalAmount;
                                        productClaimRow.SumAmountCurrency = clone.TotalAmountCurrency;
                                        SetModifiedProperties(productClaimRow);

                                        #endregion

                                        #region CustomerInvoiceAccountRow

                                        CustomerInvoiceAccountRow productClaimAccountRow = productClaimRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.RowNr == 1);
                                        AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, 0, prototype.ActorId.Value, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)clone.VatType, false);
                                        if (prioDTO != null && prioDTO.AccountId.HasValue && productClaimAccountRow == null)
                                        {
                                            var isCredit = (clone.TotalAmount < 0);

                                            productClaimAccountRow = new CustomerInvoiceAccountRow()
                                            {
                                                RowNr = 1,
                                                AccountId = prioDTO.AccountId.Value,
                                                Amount = clone.TotalAmount,
                                                AmountCurrency = clone.TotalAmountCurrency,
                                                DebitRow = !isCredit,
                                                CreditRow = isCredit,
                                            };
                                            productClaimRow.CustomerInvoiceAccountRow.Add(productClaimAccountRow);
                                        }

                                        #endregion

                                        #region Cent rounding row

                                        if (useCentRounding)
                                        {
                                            decimal centAmount = clone.CentRounding;

                                            // Get cent rounding product row
                                            CustomerInvoiceRow productCentRow = clone.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                                            if (productCentRow != null && productCentRow.ProductId.HasValue)
                                            {
                                                // Add a cent rounding account row
                                                prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, productCentRow.ProductId.Value, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)clone.VatType, false);
                                                if (prioDTO.AccountId.HasValue)
                                                {
                                                    //get currency amount for cent rounding row
                                                    decimal centAmountCurrency = productCentRow.AmountCurrency;

                                                    // A positive cent amount from the product row will be a credit accounting row
                                                    bool isCreditRow = centAmount > 0;
                                                    centAmount = Math.Abs(centAmount);
                                                    centAmountCurrency = Math.Abs(centAmountCurrency);
                                                    if (isCreditRow)
                                                    {
                                                        centAmount = -centAmount;
                                                        centAmountCurrency = -centAmountCurrency;
                                                    }

                                                    accountRowNr++;

                                                    CustomerInvoiceAccountRow centRow = new CustomerInvoiceAccountRow()
                                                    {
                                                        RowNr = accountRowNr,
                                                        AccountId = prioDTO.AccountId.Value,
                                                        Quantity = 1,
                                                        Amount = centAmount,
                                                        AmountCurrency = centAmountCurrency,
                                                        DebitRow = !isCreditRow,
                                                        CreditRow = isCreditRow
                                                    };

                                                    productCentRow.CustomerInvoiceAccountRow.Add(centRow);
                                                }
                                            }
                                        }

                                        // Update amount on claim row after calculation
                                        if (productClaimAccountRow != null)
                                        {
                                            var isCredit = (clone.TotalAmount < 0);
                                            productClaimAccountRow.Amount = clone.TotalAmount;
                                            productClaimAccountRow.AmountCurrency = clone.TotalAmountCurrency;
                                            productClaimAccountRow.DebitRow = !isCredit;
                                            productClaimAccountRow.CreditRow = isCredit;
                                        }

                                        #endregion

                                        #endregion
                                    }

                                    #endregion
                                    */

                                    #region Update status

                                    bool setContractPeriod = false;
                                    switch (originStatusChange)
                                    {
                                        case SoeOriginStatusChange.Billing_OfferToOrder:
                                            #region OfferToOrder

                                            clone.RegistrationType = (int)OrderInvoiceRegistrationType.Order;
                                            clone.Origin.Type = (int)SoeOriginType.Order;
                                            clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Offer;
                                            prototype.Origin.Status = prototypeHasInvalidatedRows ? (int)SoeOriginStatus.OfferPartlyOrder : (int)SoeOriginStatus.OfferFullyOrder;

                                            //Calculate currency amounts
                                            CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                            //Extra check for offers missing fixed price flag
                                            if (!clone.FixedPriceOrder && hasFixedPriceRows)
                                                clone.FixedPriceOrder = true;

                                            #endregion
                                            break;
                                        case SoeOriginStatusChange.Billing_OfferToInvoice:
                                            #region OfferToInvoice

                                            clone.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;
                                            clone.Origin.Type = (int)SoeOriginType.CustomerInvoice;
                                            clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Offer;
                                            prototype.Origin.Status = prototypeHasInvalidatedRows ? (int)SoeOriginStatus.OfferPartlyInvoice : (int)SoeOriginStatus.OfferFullyInvoice;

                                            //Calculate currency amounts
                                            CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                            #endregion
                                            break;
                                        case SoeOriginStatusChange.Billing_OrderToInvoice:
                                            #region OrderToInvoice

                                            clone.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;
                                            clone.Origin.Type = (int)SoeOriginType.CustomerInvoice;
                                            clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Order;

                                            if (finalInvoicingDeductLift || (hasFlatPriceKeepPricesRowsToTransfer && !keepOrderOpen))
                                                prototype.Origin.Status = (int)SoeOriginStatus.OrderFullyInvoice;
                                            else
                                                prototype.Origin.Status = prototypeHasInvalidatedRows || keepOrderOpen ? (int)SoeOriginStatus.OrderPartlyInvoice : (int)SoeOriginStatus.OrderFullyInvoice;

                                            ProjectManager.ChangeStopDateForHiddenProject(entities, prototype);

                                            decimal ra = 0;
                                            decimal raExVat = 0;
                                            decimal raVat = 0;
                                            CalculateInvoiceRemainingAmount(prototype, fixedPriceKeepPricesProductId, ref ra, ref raExVat, ref raVat, (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer));

                                            prototype.RemainingAmount = ra;
                                            prototype.RemainingAmountVat = raVat;
                                            prototype.RemainingAmountExVat = raExVat;

                                            //Calculate currency amounts
                                            CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                            #endregion
                                            break;
                                        case SoeOriginStatusChange.Billing_ContractToOrder:
                                            #region ContractToOrder

                                            clone.RegistrationType = (int)OrderInvoiceRegistrationType.Order;
                                            clone.Origin.Type = (int)SoeOriginType.Order;
                                            clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Contract;
                                            setContractPeriod = true;

                                            //Calculate currency amounts
                                            CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                            #endregion
                                            break;
                                        case SoeOriginStatusChange.Billing_ContractToInvoice:
                                            #region ContractToInvoice

                                            clone.RegistrationType = (int)OrderInvoiceRegistrationType.Invoice;
                                            clone.Origin.Type = (int)SoeOriginType.CustomerInvoice;
                                            clone.OriginateFrom = (int)TermGroup_CustomerInvoiceOriginateFrom.Contract;
                                            setContractPeriod = true;

                                            //Calculate currency amounts
                                            CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, clone);

                                            #endregion
                                            break;
                                    }

                                    #endregion

                                    #region Contract

                                    if (setContractPeriod)
                                    {
                                        // Set next period
                                        if (prototype.ContractGroup != null)
                                        {
                                            prototype.NextContractPeriodYear = nextContractPeriodYear;
                                            prototype.NextContractPeriodValue = nextContractPeriodValue;
                                            prototype.NextContractPeriodDate = nextContractPeriodDate;
                                        }
                                    }

                                    #endregion

                                    #region Project

                                    if (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder)
                                    {
                                        //Standard materialcode
                                        int standardMaterialCodeId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStandardMaterialCode, 0, base.ActorCompanyId, 0);

                                        TimeProjectDTO proj = null;
                                        result = HandleProjectOnSaveInvoice(entities, clone, ActorCompanyId, new Dictionary<string, object>(), standardMaterialCodeId, ref proj);

                                        if (!result.Success)
                                            return result;
                                    }

                                    #endregion

                                    #endregion

                                    #region Validate clone accounting rows

                                    if (!merge || prototypeCounter == prototypes.Count)
                                    {
                                        if (ValidateCustomerInvoiceAccountingRowsDiff(clone))
                                        {
                                            accountRowNr = 1; //Reset account row number
                                            foreach (CustomerInvoiceRow cloneRow in clone.ActiveCustomerInvoiceRows)
                                            {
                                                cloneRow.CustomerInvoiceAccountRow.ToList().ForEach(x => entities.DeleteObject(x));
                                                CreateCustomerInvoiceAccountRow(entities, cloneRow, (TermGroup_InvoiceVatType)clone.VatType, ref accountRowNr, prototype.ActorId.Value, 0, prototype.ProjectId != null ? (int)prototype.ProjectId : 0, actorCompanyId, null, clone.DefaultDim2AccountId, clone.DefaultDim3AccountId, clone.DefaultDim4AccountId, clone.DefaultDim5AccountId, clone.DefaultDim6AccountId, tripartiteTrade: clone.TriangulationSales);
                                            }

                                            //TODO: Second validation never succeeds because claim row is missing! All account rows are deleted above, but claim row is never formed again.
                                            if (ValidateCustomerInvoiceAccountingRowsDiff(clone))
                                                return new ActionResult((int)ActionResultSave.HasUnbalancedAccountingRows, GetText(7406, ""));
                                        }
                                    }

                                    #endregion

                                    if (recalculatePrototype)
                                    {
                                        #region Calculate totals

                                        CalculateAmountsByCurrency(entities, prototype, useCentRounding, actorCompanyId);

                                        decimal sum = 0;
                                        foreach (CustomerInvoiceRow row in prototype.CustomerInvoiceRow.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.SubTotalRow).OrderBy(r => r.RowNr))
                                        {
                                            if (row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                                            {
                                                row.SumAmountCurrency = sum;
                                                sum = 0;
                                            }
                                            else
                                            {
                                                sum += row.SumAmountCurrency;
                                            }
                                        }

                                        #endregion

                                        #region CustomerInvoiceRow - Claim row

                                        CustomerInvoiceRow prototypeProductClaimRow = prototype.CustomerInvoiceRow.FirstOrDefault(r => r.Type == (int)SoeInvoiceRowType.AccountingRow && r.Product == null && !r.IsCentRoundingRow);
                                        if (prototypeProductClaimRow != null)
                                        {
                                            #region Update

                                            #region CustomerInvoiceRow

                                            prototypeProductClaimRow.Amount = prototype.TotalAmount;
                                            prototypeProductClaimRow.SumAmount = prototype.TotalAmount;
                                            prototypeProductClaimRow.SumAmountCurrency = prototype.TotalAmountCurrency;
                                            SetModifiedProperties(prototypeProductClaimRow);

                                            #endregion

                                            #region CustomerInvoiceAccountRow

                                            CustomerInvoiceAccountRow prototypeProductClaimAccountRow = prototypeProductClaimRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.RowNr == 1);
                                            AccountingPrioDTO prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, 0, 0, prototype.ActorId.Value, 0, ProductAccountType.Purchase, (TermGroup_InvoiceVatType)clone.VatType, false);
                                            if (prioDTO != null && prioDTO.AccountId.HasValue)
                                            {
                                                if (prototypeProductClaimAccountRow == null)
                                                {
                                                    var isCredit = (prototype.TotalAmount < 0);

                                                    prototypeProductClaimAccountRow = new CustomerInvoiceAccountRow()
                                                    {
                                                        RowNr = 1,
                                                        AccountId = prioDTO.AccountId.Value,
                                                        Amount = clone.TotalAmount,
                                                        DebitRow = !isCredit,
                                                        CreditRow = isCredit,
                                                    };
                                                    prototypeProductClaimRow.CustomerInvoiceAccountRow.Add(prototypeProductClaimAccountRow);
                                                }
                                            }

                                            #endregion

                                            #region Cent rounding row

                                            if (useCentRounding)
                                            {
                                                decimal centAmount = prototype.CentRounding;

                                                // Get cent rounding product row
                                                CustomerInvoiceRow prototypeProductCentRow = prototype.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                                                if (prototypeProductCentRow != null && prototypeProductCentRow.ProductId.HasValue)
                                                {
                                                    // Add a cent rounding account row
                                                    prioDTO = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, prototypeProductCentRow.ProductId.Value, 0, 0, 0, ProductAccountType.Sales, (TermGroup_InvoiceVatType)clone.VatType, false);
                                                    if (prioDTO != null && prioDTO.AccountId.HasValue)
                                                    {
                                                        // A positive cent amount from the product row will be a credit accounting row
                                                        bool isCreditRow = centAmount > 0;
                                                        centAmount = Math.Abs(centAmount);
                                                        if (isCreditRow)
                                                            centAmount = -centAmount;

                                                        accountRowNr++;

                                                        CustomerInvoiceAccountRow centRow = prototypeProductCentRow.CustomerInvoiceAccountRow.FirstOrDefault(r => r.AccountId == prioDTO.AccountId.Value && r.State == (int)SoeEntityState.Active);

                                                        if (centRow != null)
                                                        {
                                                            centRow.Amount = centAmount;
                                                        }
                                                        else
                                                        {
                                                            centRow = new CustomerInvoiceAccountRow()
                                                            {
                                                                RowNr = accountRowNr,
                                                                AccountId = prioDTO.AccountId.Value,
                                                                Quantity = 1,
                                                                Amount = centAmount,
                                                                DebitRow = !isCreditRow,
                                                                CreditRow = isCreditRow
                                                            };

                                                            prototypeProductCentRow.CustomerInvoiceAccountRow.Add(centRow);
                                                        }
                                                    }
                                                }
                                            }

                                            // Update amount on claim row after calculation
                                            if (prototypeProductClaimAccountRow != null)
                                            {
                                                prototypeProductClaimAccountRow.Amount = prototype.TotalAmount;
                                                prototypeProductClaimAccountRow.AmountCurrency = prototype.TotalAmountCurrency;
                                            }

                                            #endregion

                                            #endregion
                                        }

                                        #endregion

                                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, actorCompanyId, prototype);
                                    }

                                    #region Copy Attachments

                                    GraphicsManager gm = new GraphicsManager(parameterObject);
                                    GeneralManager gem = new GeneralManager(parameterObject);

                                    if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoiceAndPrint)
                                    {
                                        if (merge)
                                        {
                                            if (clone.TempImagesToCopy == null)
                                                clone.TempImagesToCopy = new List<Images>();

                                            clone.TempImagesToCopy.AddRange(TransferImagesFromOfferOrderContract(entities, prototype, imageType, entityTypeFrom, entityTypeTo, actorCompanyId));

                                            if (clone.TempAttachmentsToCopy == null)
                                                clone.TempAttachmentsToCopy = new List<DataStorageRecord>();

                                            clone.TempAttachmentsToCopy.AddRange(TransferAttachementsFromOrder(entities, prototype, clone, actorCompanyId, prototypeRowDict.Keys.ToList()));

                                            // Get mappings
                                            var mappings = GetChildInvoices(entities, prototype.InvoiceId);
                                            foreach (var mapping in mappings)
                                            {
                                                clone.TempAttachmentsToCopy.AddRange(TransferAttachementsFromOrder(entities, mapping.Invoice1 as CustomerInvoice, clone, actorCompanyId));
                                            }
                                        }
                                        else
                                        {
                                            clone.TempImagesToCopy = TransferImagesFromOfferOrderContract(entities, prototype, imageType, entityTypeFrom, entityTypeTo, actorCompanyId);
                                            clone.TempAttachmentsToCopy = TransferAttachementsFromOrder(entities, prototype, clone, actorCompanyId, prototypeRowDict.Keys.ToList());

                                            // Get mappings
                                            var mappings = GetChildInvoices(entities, prototype.InvoiceId);
                                            foreach (var mapping in mappings)
                                            {
                                                var invoice = GetCustomerInvoice(entities, mapping.ChildInvoiceId, true, true, loadInvoiceRow: true);
                                                clone.TempAttachmentsToCopy.AddRange(TransferAttachementsFromOrder(entities, invoice, clone, actorCompanyId));
                                            }
                                        }
                                    }
                                    else
                                    {
                                        if (merge)
                                        {
                                            if (clone.TempImagesToCopy == null)
                                                clone.TempImagesToCopy = new List<Images>();

                                            clone.TempImagesToCopy.AddRange(TransferImagesFromOfferOrderContract(entities, prototype, imageType, entityTypeFrom, entityTypeTo, actorCompanyId));

                                            if (clone.TempAttachmentsToCopy == null)
                                                clone.TempAttachmentsToCopy = new List<DataStorageRecord>();

                                            clone.TempAttachmentsToCopy.AddRange(TransferAttachementsFromOfferContract(entities, prototype, clone, actorCompanyId));
                                        }
                                        else
                                        {
                                            clone.TempImagesToCopy = TransferImagesFromOfferOrderContract(entities, prototype, imageType, entityTypeFrom, entityTypeTo, actorCompanyId);
                                            clone.TempAttachmentsToCopy = TransferAttachementsFromOfferContract(entities, prototype, clone, actorCompanyId);
                                        }
                                    }

                                    #endregion

                                    #region Copy checklists

                                    if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder && prototype.Origin.Type == (int)SoeOriginType.Order)
                                    {
                                        clone.ChecklistHeadRecords = new List<ChecklistHeadRecord>();

                                        var checklists = ChecklistManager.GetChecklistHeadRecordsWithRows(entities, SoeEntityType.Order, prototype.InvoiceId, actorCompanyId, true);

                                        foreach (var head in checklists)
                                        {
                                            var cloneChecklist = new ChecklistHeadRecord()
                                            {
                                                ActorCompanyId = head.ActorCompanyId,
                                                Entity = (int)SoeEntityType.Order,
                                                RecordId = clone.InvoiceId,
                                                AddAttachementsToEInvoice = head.AddAttachementsToEInvoice,

                                                //references
                                                ChecklistHead = head.ChecklistHead,
                                            };

                                            SetCreatedProperties(cloneChecklist);

                                            foreach (var record in head.ChecklistRowRecord)
                                            {
                                                var cloneChecklistRow = new ChecklistRowRecord()
                                                {
                                                    ActorCompanyId = actorCompanyId,
                                                    Text = record.Text,
                                                    Type = record.Type,

                                                    // reference
                                                    ChecklistRow = record.ChecklistRow,
                                                    ChecklistHeadRecord = cloneChecklist,
                                                };
                                                SetCreatedProperties(cloneChecklistRow);

                                                entities.AddToChecklistRowRecord(cloneChecklistRow);
                                                cloneChecklist.ChecklistRowRecord.Add(cloneChecklistRow);
                                            }

                                            entities.AddToChecklistHeadRecord(cloneChecklist);
                                            clone.ChecklistHeadRecords.Add(cloneChecklist);
                                        }
                                    }

                                    #endregion
                                }

                            }

                            #region Save

                            if (validatedPrototypes > 0)
                            {
                                result = SaveChanges(entities, transaction);

                                //Handle stock....order => Invoice, Reserved should have happen when reg=>klar on order so skip it here
                                //To definitiv invoice, reserved => minus on stock
                                if (
                                    (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice && setStatusToOrigin) ||
                                    originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice ||
                                    originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder ||
                                    (originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice && setStatusToOrigin))
                                {
                                    foreach (var clone in clones)
                                    {
                                        HandleStockOnInvoice(clone, entities, transaction, actorCompanyId, null, false, setStatusToOrigin, originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice);
                                    }
                                }

                                //if(originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoiceAndPrint || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OfferToOrder)
                                //{
                                if (originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoice || originStatusChange == SoeOriginStatusChange.Billing_OrderToInvoiceAndPrint || originStatusChange == SoeOriginStatusChange.Billing_OfferToInvoice)
                                {
                                    // Check if Voucher should also should be saved at once
                                    result = TryTransferCustomerInvoicesToVoucher(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, clones, actorCompanyId);
                                    if (!result.Success)
                                        return result;
                                }

                                if (originStatusChange == SoeOriginStatusChange.Billing_ContractToServiceOrder)
                                {
                                    foreach (var clone in clones)
                                    {
                                        if (clone.ChecklistHeadRecords == null)
                                            continue;

                                        foreach (var head in clone.ChecklistHeadRecords)
                                        {
                                            head.RecordId = clone.InvoiceId;
                                            clone.StatusIcon = GetStatusIcon(clone.StatusIcon, true, SoeStatusIcon.Checklist);
                                        }
                                    }

                                    result = SaveChanges(entities, transaction);
                                }

                                //Update Attachments
                                result = TryTransferAttachments(entities, ConfigSettings.TRANSACTIONSCOPEOPTION_ATTACH, clones);
                                if (!result.Success)
                                    return result;
                                //}

                                //Commit transaction
                                if (result.Success)
                                    transaction.Complete();
                            }
                            else
                            {
                                if (invalidatedPrototypes > 0)
                                {
                                    result = new ActionResult((int)ActionResultSave.TransferOfferOrderHasInvalidatedItems, string.Format(GetText(6224), targetInvoiceNrs));
                                    result.IntegerValue = invalidatedPrototypes;
                                }
                            }

                            #endregion
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.Value = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = clones.Count;
                        result.StrDict = clones.Select(c => new { c.InvoiceId, c.SeqNr }).ToDictionary(c => c.InvoiceId, c => c.SeqNr.ToString());

                        if (invalidPrototypes.Count > 0)
                            result.InfoMessage = invalidPrototypes.Aggregate((x, y) => x + ",\r\n" + y);
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        private List<Images> TransferImagesFromOfferOrderContract(CompEntities entities, CustomerInvoice prototype, SoeEntityImageType imageType, SoeEntityType entityTypeFrom, SoeEntityType entityTypeTo, int actorCompanyId)
        {
            List<Images> imagesToTransfer = new List<Images>();

            // Get images from prototype
            var imagesFromOldOrder = GraphicsManager.GetImages(entities, actorCompanyId, imageType, entityTypeFrom, prototype.InvoiceId).ToList();

            // Add images
            if (imagesFromOldOrder != null && imagesFromOldOrder.Count > 0)
            {
                foreach (var image in imagesFromOldOrder)
                {
                    Images img = new Images()
                    {
                        ActorCompanyId = image.ActorCompanyId,
                        Type = image.Type,
                        Entity = (int)entityTypeTo,
                        RecordId = 0,
                        FormatType = image.FormatType,
                        Thumbnail = image.Thumbnail,
                        Image = image.Image,
                        Description = image.Description,
                    };

                    imagesToTransfer.Add(img);
                }
            }

            return imagesToTransfer;
        }

        private List<DataStorageRecord> TransferAttachementsFromOrder(CompEntities entities, CustomerInvoice prototype, CustomerInvoice clone, int actorCompanyId, List<int> rowIds = null)
        {
            List<DataStorageRecord> attachmentToTransfer = new List<DataStorageRecord>();

            // Get attachments from prototyp
            var attachmentsFromOldOrder = GeneralManager.GetDataStorageRecords(entities, actorCompanyId, null, prototype.InvoiceId, SoeEntityType.None, SoeDataStorageRecordType.OrderInvoiceFileAttachment, includeInvoiceAttachment: true);

            // Get signatures from prototype
            attachmentsFromOldOrder.AddRange(GeneralManager.GetDataStorageRecords(entities, actorCompanyId, null, prototype.InvoiceId, SoeEntityType.None, SoeDataStorageRecordType.OrderInvoiceSignature, includeInvoiceAttachment: true));

            // Get attachments connected or transfered to prototype
            var ids = (from r in prototype.ActiveCustomerInvoiceRows
                       where
                       (rowIds == null || rowIds.Contains(r.CustomerInvoiceRowId)) &&
                       r.IncludeSupplierInvoiceImage != null && r.IncludeSupplierInvoiceImage == true &&
                       r.State == (int)SoeEntityState.Active &&
                       r.SupplierInvoiceId != null
                       select r.SupplierInvoiceId.Value).Distinct().ToList();

            var idsFromTransactions = (from tct in entities.TimeCodeTransaction
                                       where tct.SupplierInvoiceId.HasValue &&
                                       (!tct.CustomerInvoiceId.HasValue || tct.CustomerInvoiceId == prototype.InvoiceId) &&
                                       tct.ProjectId == prototype.ProjectId &&
                                       tct.State == (int)SoeEntityState.Active &&
                                       tct.IncludeSupplierInvoiceImage == true
                                       select tct.SupplierInvoiceId.Value).Distinct().ToList();

            idsFromTransactions.ForEach(i =>
            {
                if (!ids.Contains(i))
                    ids.Add(i);
            });

            var connectedAttachments = SupplierInvoiceManager.GetSupplierInvoiceImages(entities, actorCompanyId, ids, includeInvoiceAttachment: true);

            // Add attachements
            if (attachmentsFromOldOrder != null && attachmentsFromOldOrder.Count > 0)
            {
                foreach (var attachment in attachmentsFromOldOrder)
                {
                    var addAttachmentOnTransfer = true; // Default always true?
                    var invoiceAttachment = attachment.InvoiceAttachment.FirstOrDefault(i => i.InvoiceId == prototype.InvoiceId);
                    if (invoiceAttachment != null)
                        addAttachmentOnTransfer = invoiceAttachment.AddAttachmentsOnTransfer;

                    if (addAttachmentOnTransfer)
                    {
                        DataStorageRecord datastorageRecord = GeneralManager.GetDataStorageRecord(entities, actorCompanyId, attachment.DataStorageRecordId);

                        if (datastorageRecord != null && datastorageRecord.DataStorage != null)
                        {
                            var newDataStoreRecord = GeneralManager.CreateDataStorageRecord(entities, (SoeDataStorageRecordType)datastorageRecord.Type, 0, datastorageRecord.RecordNumber, SoeEntityType.None, datastorageRecord.DataStorage);
                            InvoiceAttachmentManager.AddInvoiceAttachmentToDataStorageRecord(entities, clone, newDataStoreRecord, InvoiceAttachmentConnectType.Manual, invoiceAttachment != null ? invoiceAttachment.AddAttachmentsOnEInvoice : prototype.AddAttachementsToEInvoice, true, false);
                            attachmentToTransfer.Add(newDataStoreRecord);
                        }
                    }

                }
            }

            // Add connected attachements
            if (connectedAttachments != null && connectedAttachments.Count > 0)
            {
                foreach (var attachment in connectedAttachments)
                {
                    var addAttachmentOnTransfer = true; // Default always true?
                    var invoiceAttachment = attachment.InvoiceAttachments.FirstOrDefault(i => i.InvoiceId == prototype.InvoiceId);
                    if (invoiceAttachment != null)
                        addAttachmentOnTransfer = invoiceAttachment.AddAttachmentsOnTransfer;

                    if (addAttachmentOnTransfer)
                    {
                        if (attachment.SourceType == InvoiceAttachmentSourceType.DataStorage)
                        {
                            DataStorageRecord existingRecord = GeneralManager.GetDataStorageRecord(entities, actorCompanyId, attachment.Id);
                            if (existingRecord != null)
                            {
                                DataStorageRecord newDataStoreRecord = GeneralManager.CreateDataStorageRecord(entities, attachment.ImageFormatType, 0, clone.InvoiceNr, SoeEntityType.None, existingRecord.DataStorage);
                                InvoiceAttachmentManager.AddInvoiceAttachmentToDataStorageRecord(entities, clone, newDataStoreRecord, InvoiceAttachmentConnectType.SupplierInvoice, invoiceAttachment != null ? invoiceAttachment.AddAttachmentsOnEInvoice : prototype.AddAttachementsToEInvoice, true, false);
                                attachmentToTransfer.Add(newDataStoreRecord);
                            }
                        }
                        else
                        {
                            DataStorage newDataStorage = new DataStorage();

                            newDataStorage.ActorCompanyId = actorCompanyId;
                            newDataStorage.Type = (int)attachment.ImageFormatType;
                            newDataStorage.Description = attachment.Description;
                            newDataStorage.XML = null;
                            newDataStorage.Data = attachment.Image;
                            newDataStorage.FileSize = null;
                            newDataStorage.State = (int)SoeEntityState.Active;
                            newDataStorage.OriginType = clone.Origin.Type;
                            newDataStorage.FileName = attachment.Filename;

                            switch (attachment.ImageFormatType)
                            {
                                case SoeDataStorageRecordType.InvoiceBitmap:
                                    newDataStorage.Extension = ".jpg";
                                    break;
                                case SoeDataStorageRecordType.InvoicePdf:
                                    newDataStorage.Extension = ".pdf";
                                    break;
                                case SoeDataStorageRecordType.OrderInvoiceFileAttachment_Image:
                                    newDataStorage.Extension = ".jpg";
                                    break;
                                default:
                                    break;
                            }

                            var newDataStoreRecord = GeneralManager.CreateDataStorageRecord(entities, attachment.ImageFormatType, 0, clone.InvoiceNr, SoeEntityType.None, newDataStorage);
                            InvoiceAttachmentManager.AddInvoiceAttachmentToDataStorageRecord(entities, clone, newDataStoreRecord, InvoiceAttachmentConnectType.SupplierInvoice, invoiceAttachment != null ? invoiceAttachment.AddAttachmentsOnEInvoice : prototype.AddAttachementsToEInvoice, true, false);
                            attachmentToTransfer.Add(newDataStoreRecord);
                        }
                    }
                }
            }

            return attachmentToTransfer;
        }

        private List<DataStorageRecord> TransferAttachementsFromOfferContract(CompEntities entities, CustomerInvoice prototype, CustomerInvoice clone, int actorCompanyId)
        {
            List<DataStorageRecord> attachmentToTransfer = new List<DataStorageRecord>();

            var attachmentsFromOldOrigin = GeneralManager.GetDataStorageRecords(entities, actorCompanyId, null, prototype.InvoiceId, SoeEntityType.None, SoeDataStorageRecordType.OrderInvoiceFileAttachment, includeInvoiceAttachment: true);

            // Add attachements
            if (attachmentsFromOldOrigin != null && attachmentsFromOldOrigin.Count > 0)
            {
                foreach (var attachment in attachmentsFromOldOrigin)
                {
                    var addAttachmentOnTransfer = true; // Default always true?
                    var invoiceAttachment = attachment.InvoiceAttachment.FirstOrDefault(i => i.InvoiceId == prototype.InvoiceId);
                    if (invoiceAttachment != null)
                        addAttachmentOnTransfer = invoiceAttachment.AddAttachmentsOnTransfer;

                    if (addAttachmentOnTransfer)
                    {
                        DataStorageRecord datastorageRecord = GeneralManager.GetDataStorageRecord(entities, actorCompanyId, attachment.DataStorageRecordId);

                        if (datastorageRecord != null && datastorageRecord.DataStorage != null)
                        {
                            var newDataStoreRecord = GeneralManager.CreateDataStorageRecord(entities, (SoeDataStorageRecordType)datastorageRecord.Type, 0, datastorageRecord.RecordNumber, SoeEntityType.None, datastorageRecord.DataStorage);
                            InvoiceAttachmentManager.AddInvoiceAttachmentToDataStorageRecord(entities, clone, newDataStoreRecord, InvoiceAttachmentConnectType.Manual, invoiceAttachment != null ? invoiceAttachment.AddAttachmentsOnEInvoice : prototype.AddAttachementsToEInvoice, true, false);
                            attachmentToTransfer.Add(newDataStoreRecord);
                        }
                    }

                }
            }

            return attachmentToTransfer;
        }

        private void ValidateNegativeTransferAmount(CompEntities entities, CustomerInvoice prototype, SoeOriginStatusChange originStatusChange, List<AttestTransition> attestTransitions, List<int> liftProducts, AttestState attestStateTransferred, int fixedPriceKeepPricesProductId, int attestStateOrderInitialId, ref bool valid, ref string errorMessage)
        {
            // Check if this is final invoicing deduct lift  
            bool finalInvoicingDeductLift = false;
            bool hasFlatPriceKeepPricesRowsToTransfer = false;
            int attestStateTransferredId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : 0;
            var liftRows = prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && r.ProductId != null && liftProducts.Contains((int)r.ProductId) &&
            (r.AttestStateId.HasValue && r.AttestStateId.Value == attestStateTransferredId) &&
            !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))).ToList();
            var fixedPricesRows = prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && r.ProductId == fixedPriceKeepPricesProductId && !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value)));

            if (!fixedPricesRows.Any() && liftRows.Any())
            {
                finalInvoicingDeductLift = true;
                foreach (var rowAttestStateId in prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && (r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.BaseProductRow) && r.AttestStateId != attestStateTransferredId).Select(r => r.AttestStateId))
                {
                    if (rowAttestStateId == attestStateOrderInitialId)
                    {
                        finalInvoicingDeductLift = false;
                        continue;
                    }

                    var attestTransition = (from at in attestTransitions
                                            where at.AttestStateFrom != null &&
                                            at.AttestStateTo != null &&
                                            at.AttestStateFrom.AttestStateId == rowAttestStateId &&
                                            at.AttestStateTo.AttestStateId == attestStateTransferredId
                                            select at).FirstOrDefault();

                    if (attestTransition == null)
                    {
                        finalInvoicingDeductLift = false;
                    }

                }
            }

            bool hasValidProductRows = false;
            decimal rowsToBeTransferredTotal = 0;
            var prototypeRows = (from r in prototype.CustomerInvoiceRow
                                 where r.State == (int)SoeEntityState.Active &&
                                 (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer || !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))) &&
                                 !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OfferClosedIds.Contains(r.AttestStateId.Value))
                                 orderby r.RowNr
                                 select r).ToList();

            //Validate which rows that should be transferred
            foreach (var prototypeRow in prototypeRows)
            {
                bool overrideValidation = false;

                // Calculate centrounding later
                if (prototypeRow.IsCentRoundingRow)
                    continue;

                //Only transfer rows with product
                if (prototypeRow.Type == (int)SoeInvoiceRowType.AccountingRow && prototypeRow.Product == null)
                    continue;

                var product = prototypeRow.ProductId.HasValue ? ProductManager.GetInvoiceProductSmall(entities, prototypeRow.ProductId.Value, ActorCompanyId) : null;

                if ((finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer) && prototypeRow.AttestStateId.HasValue && prototypeRow.AttestStateId.Value == attestStateTransferredId && prototypeRow.Product != null)
                {
                    if (product != null && (product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing))
                    {
                        if (!prototypeRow.TargetRowReference.IsLoaded)
                            prototypeRow.TargetRowReference.Load();

                        if (prototypeRow.TargetRow != null)
                        {
                            var targetRow = prototypeRow.TargetRow;

                            if (!targetRow.TargetRowReference.IsLoaded)
                                targetRow.TargetRowReference.Load();

                            // Lift has already been withdrawn from an invoice
                            if (targetRow.TargetRow != null && targetRow.State == (int)SoeEntityState.Active)
                                continue;
                        }

                        overrideValidation = true;
                    }
                    else
                        continue;
                }
                else
                {
                    //Already transferred (not used for invoice fee, freight and contracts)
                    if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                    {
                        if (prototypeRow.AttestStateId == attestStateTransferredId)
                            continue;
                    }
                    else
                    {
                        if (hasFlatPriceKeepPricesRowsToTransfer && prototypeRow.ProductId == fixedPriceKeepPricesProductId && !IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions))
                        {
                            hasFlatPriceKeepPricesRowsToTransfer = false;
                            overrideValidation = false;
                        }
                    }
                }

                //Validation check: Only rows with correct state. FixedPriceOrders are valid when all flat-price rows are valid
                //Not used for contracts, invoice fee or freight amount rows
                bool isValid = true;
                if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                {
                    isValid = overrideValidation ? true : IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions);
                    if (isValid)
                        hasValidProductRows = true; //Has at least one valid product row (i.e. not IsInvoiceFee or IsFreightAmountRow). Prevent empty invoices with only InvoiceFee or Freight
                }
                else if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice))
                    hasValidProductRows = true;

                if (hasValidProductRows)
                {
                    rowsToBeTransferredTotal += product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift ? Decimal.Negate(prototypeRow.SumAmountCurrency) : prototypeRow.SumAmountCurrency;
                }
            }

            if (rowsToBeTransferredTotal < 0 && !finalInvoicingDeductLift)
            {
                errorMessage += "\\" + prototype.InvoiceNr;
                valid = false;
            }
        }

        private decimal ValidateNegativeTransferAmountMerge(CompEntities entities, CustomerInvoice prototype, SoeOriginStatusChange originStatusChange, List<AttestTransition> attestTransitions, List<int> liftProducts, AttestState attestStateTransferred, int fixedPriceKeepPricesProductId, int attestStateOrderInitialId)
        {
            // Check if this is final invoicing deduct lift  
            bool finalInvoicingDeductLift = false;
            bool hasFlatPriceKeepPricesRowsToTransfer = false;
            int attestStateTransferredId = attestStateTransferred != null ? attestStateTransferred.AttestStateId : 0;
            var liftRows = prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && r.ProductId != null && liftProducts.Contains((int)r.ProductId) &&
            (r.AttestStateId.HasValue && r.AttestStateId.Value == attestStateTransferredId) &&
            !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))).ToList();
            var fixedPricesRows = prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && r.ProductId == fixedPriceKeepPricesProductId && !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value)));

            if (!fixedPricesRows.Any() && liftRows.Any())
            {
                finalInvoicingDeductLift = true;
                foreach (var row in prototype.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active && (r.Type == (int)SoeInvoiceRowType.ProductRow || r.Type == (int)SoeInvoiceRowType.BaseProductRow) && r.AttestStateId != attestStateTransferredId))
                {
                    if (row.AttestStateId == attestStateOrderInitialId)
                    {
                        finalInvoicingDeductLift = false;
                        continue;
                    }

                    var attestTransition = (from at in attestTransitions
                                            where at.AttestStateFrom != null &&
                                            at.AttestStateTo != null &&
                                            at.AttestStateFrom.AttestStateId == row.AttestStateId &&
                                            at.AttestStateTo.AttestStateId == attestStateTransferredId
                                            select at).FirstOrDefault();

                    if (attestTransition == null)
                    {
                        finalInvoicingDeductLift = false;
                    }

                }
            }

            bool hasValidProductRows = false;
            decimal rowsToBeTransferredTotal = 0;
            var prototypeRows = (from r in prototype.CustomerInvoiceRow
                                 where r.State == (int)SoeEntityState.Active &&
                                 (finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer || !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(r.AttestStateId.Value))) &&
                                 !(r.AttestStateId.HasValue && InvoiceAttestStatesIds.OfferClosedIds.Contains(r.AttestStateId.Value))
                                 orderby r.RowNr
                                 select r).ToList();

            //Validate which rows that should be transferred
            foreach (var prototypeRow in prototypeRows)
            {
                bool overrideValidation = false;

                // Calculate centrounding later
                if (prototypeRow.IsCentRoundingRow)
                    continue;

                //Only transfer rows with product
                if (prototypeRow.Type == (int)SoeInvoiceRowType.AccountingRow && prototypeRow.Product == null)
                    continue;

                var product = prototypeRow.ProductId.HasValue ? ProductManager.GetInvoiceProductSmall(entities, prototypeRow.ProductId.Value, ActorCompanyId) : null;

                if ((finalInvoicingDeductLift || hasFlatPriceKeepPricesRowsToTransfer) && prototypeRow.AttestStateId.HasValue && prototypeRow.AttestStateId.Value == attestStateTransferredId && prototypeRow.Product != null)
                {
                    if (product != null && (product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing))
                        overrideValidation = true;
                    else
                        continue;
                }
                else
                {
                    //Already transferred (not used for invoice fee, freight and contracts)
                    if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                    {
                        if (prototypeRow.AttestStateId == attestStateTransferredId)
                            continue;
                    }
                    else
                    {
                        if (hasFlatPriceKeepPricesRowsToTransfer && prototypeRow.ProductId == fixedPriceKeepPricesProductId && !IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions))
                        {
                            hasFlatPriceKeepPricesRowsToTransfer = false;
                            overrideValidation = false;
                        }
                    }
                }

                //Validation check: Only rows with correct state. FixedPriceOrders are valid when all flat-price rows are valid
                //Not used for contracts, invoice fee or freight amount rows
                bool isValid = true;
                if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && originStatusChange != SoeOriginStatusChange.Billing_ContractToOrder && originStatusChange != SoeOriginStatusChange.Billing_ContractToInvoice)
                {
                    isValid = overrideValidation ? true : IsCustomerInvoiceRowAttestStateValid(prototypeRow, attestStateTransferred, attestTransitions);
                    if (isValid)
                        hasValidProductRows = true; //Has at least one valid product row (i.e. not IsInvoiceFee or IsFreightAmountRow). Prevent empty invoices with only InvoiceFee or Freight
                }
                else if (!prototypeRow.IsInvoiceFeeRow && !prototypeRow.IsFreightAmountRow && (originStatusChange == SoeOriginStatusChange.Billing_ContractToOrder || originStatusChange == SoeOriginStatusChange.Billing_ContractToInvoice))
                    hasValidProductRows = true;

                if (hasValidProductRows)
                {
                    rowsToBeTransferredTotal += product != null && product.CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift ? Decimal.Negate(prototypeRow.SumAmountCurrency) : prototypeRow.SumAmountCurrency;
                }
            }

            return rowsToBeTransferredTotal;
        }

        private CustomerInvoiceRow HandlePartialInvoicing(CompEntities entities, TransactionScope transaction, CustomerInvoice invoice, CustomerInvoiceRow invoiceRow, bool closefromOrderRow)
        {
            decimal? prototypeQuantity = (invoiceRow.Quantity - invoiceRow.InvoiceQuantity);
            decimal? cloneRowQuantity = invoiceRow.InvoiceQuantity;

            var cloneRestRow = CopyCustomerInvoiceRow(entities, invoiceRow);
            cloneRestRow.ParentRow = invoiceRow;

            if (closefromOrderRow)
            {
                //new row with remaning quantity

                cloneRestRow.Quantity = prototypeQuantity;
                cloneRestRow.InvoiceQuantity = 0;
                cloneRestRow.PreviouslyInvoicedQuantity = invoiceRow.InvoiceQuantity;

                invoiceRow.Quantity = invoiceRow.InvoiceQuantity;

                //because it will be added after new row is saved
                CreateStockTransaction(entities, transaction, base.ActorCompanyId, true, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                (int)cloneRestRow.ProductId, (int)cloneRestRow.StockId, -Convert.ToDecimal(GetQuantity(invoice.BillingType, cloneRestRow.Quantity)), 0, cloneRestRow.PurchasePrice, cloneRestRow.CustomerInvoiceRowId);
            }
            else
            {
                invoiceRow.PreviouslyInvoicedQuantity = invoiceRow.PreviouslyInvoicedQuantity != null ? (decimal)invoiceRow.PreviouslyInvoicedQuantity + cloneRowQuantity : cloneRowQuantity;
                cloneRestRow.Quantity = cloneRestRow.InvoiceQuantity = invoiceRow.InvoiceQuantity;
                invoiceRow.Quantity = prototypeQuantity;
                invoiceRow.InvoiceQuantity = 0;
            }

            CalculateRowSum(cloneRestRow, invoice.CurrencyRate, 0);
            invoice.CustomerInvoiceRow.Add(cloneRestRow);
            CalculateRowSum(invoiceRow, invoice.CurrencyRate, 0);

            return cloneRestRow;
        }

        public void CalculateRowSum(CustomerInvoiceRow row, decimal currencyRate, int fixedPriceProductId, bool pricelistTypeinclVat = false)
        {
            if (row == null)
                return;

            // Calculate discount
            decimal quantity = row.Quantity.HasValue ? row.Quantity.Value : 0;

            if (row.DiscountType != (int)SoeInvoiceRowDiscountType.Unknown && row.Amount != 0 && !row.IsCentRoundingRow)
            {
                if (row.DiscountType == (int)SoeInvoiceRowDiscountType.Amount)
                    row.DiscountPercent = Math.Round((row.Amount * quantity != 0 ? (row.DiscountAmount / (row.Amount * quantity)) * 100 : 0), 2);
                else if (row.DiscountType == (int)SoeInvoiceRowDiscountType.Percent)
                    row.DiscountAmount = Decimal.Round(row.Amount * quantity * row.DiscountPercent / 100, 2);
            }
            else
            {
                row.DiscountAmount = 0;
                row.DiscountPercent = 0;
            }

            // Calculate row sum            
            decimal amount = Decimal.Round(row.Amount * quantity - row.DiscountAmount, 2);
            row.SumAmount = amount;
            row.SumAmountCurrency = Decimal.Round(row.SumAmount / currencyRate, 2);

            if (!row.IsCentRoundingRow)
            {
                //amount = row.VatAccountId.HasValue && row.VatAccountId.Value != 0 ? decimal.Round(row.SumAmountCurrency * row.VatRate / 100, 2) : 0;
                if (row.VatRate > 0 && row.SumAmountCurrency != 0)
                {
                    amount = pricelistTypeinclVat ? Math.Round(row.SumAmountCurrency - (row.SumAmountCurrency / (1 + (row.VatRate / 100))), 3) : decimal.Round(row.SumAmountCurrency * row.VatRate / 100, 2);
                }
                else
                {
                    amount = 0;
                }

                if (row.VatAmountCurrency != amount)
                {
                    row.VatAmountCurrency = Decimal.Round(amount, 2);
                    row.VatAmount = Decimal.Round(row.VatAmountCurrency * currencyRate, 2);
                }

                // Calculate marginal income
                decimal purchasePrice = Decimal.Round(row.PurchasePrice * quantity, 2);
                if (row.ProductId.HasValue && row.ProductId.Value == fixedPriceProductId && fixedPriceProductId != 0)
                    row.MarginalIncome = row.SumAmountCurrency;
                else
                    row.MarginalIncome = purchasePrice != 0 ? row.SumAmountCurrency - purchasePrice : 0;
                row.MarginalIncomeRatio = (row.SumAmountCurrency != 0 ? Decimal.Round(row.MarginalIncome / row.SumAmountCurrency, 2) : 1) * 100;
                row.MarginalIncomeRatio = CheckMarginalIncomeRatio((decimal)row.MarginalIncomeRatio);
            }
        }

        #region deleted
        /*
        public void CalculateAmounts(CompEntities entities, CustomerInvoice customerInvoice, bool useCentRounding, bool showCentRoundingAsRow, bool showCentRoundingIfNotZero, int actorCompanyId, bool checkLiftProducts = false, bool ignoreCalculateRemaining = false, bool ignoreReloadAccountRows = false)
        {
            bool setRemainingAmount = false;
            decimal totalAmount = 0;
            decimal totalAmountCurrency = 0;
            decimal sumAmountCurrency = 0;
            decimal rowVatAmount = 0;
            decimal vatAmount = 0;
            decimal freightAmountCurrency = 0;
            decimal invoiceFeeCurrency = 0;
            decimal salesAmount = 0;
            decimal purchaseAmount = 0;
            decimal remainingAmount = 0;
            decimal remainingAmountVat = 0;
            decimal remainingAmountExVat = 0;
            decimal vatOnInvoiceFee = 0;

            //Check if attestates are loaded
            InitializeAttestStateIds(entities, actorCompanyId);

            // Check VAT type
            bool noVAT = (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Contractor || customerInvoice.VatType == (int)TermGroup_InvoiceVatType.NoVat);

            int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, actorCompanyId, 0);

            int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);
            bool hasFixedPriceKeepPricesRows = customerInvoice.ActiveCustomerInvoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceKeepPricesProductId);

            int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
            bool hasFixedPriceRows = customerInvoice.ActiveCustomerInvoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceProductId);

            int guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, actorCompanyId, 0);

            bool calculateMarginalIncomeForZeroPurchase = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingCalculateMarginalIncomeForRowsWithZeroPurchasePrice, 0, actorCompanyId, 0, true);

            var hasTransferredRows = false;

            foreach (CustomerInvoiceRow row in customerInvoice.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active))
            {
                // Do not sum text, page break or sub total rows
                if (row.Type == (int)SoeInvoiceRowType.TextRow || row.Type == (int)SoeInvoiceRowType.PageBreakRow || row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                    continue;

                // Get product
                if (row.Product == null && !row.ProductReference.IsLoaded)
                    row.ProductReference.Load();
                if (!ignoreReloadAccountRows && !row.CustomerInvoiceAccountRow.IsLoaded && row.EntityState != System.Data.Entity.EntityState.Added && row.EntityState != System.Data.Entity.EntityState.Detached)
                    row.CustomerInvoiceAccountRow.Load();

                //Do not sum the claim row...can be both Debit or Credit depending on billing type....
                if (row.Type == (int)SoeInvoiceRowType.AccountingRow && row.Product == null && row.IsCentRoundingRow == false &&
                    ((row.CustomerInvoiceAccountRow != null && row.CustomerInvoiceAccountRow.FirstOrDefault(r => r.VatRow == false) != null) ||
                    row.CustomerInvoiceAccountRow.Count == 0))
                    continue;

                //Do not sum existing cent rounding row
                if (row.IsCentRoundingRow == true)
                    continue;

                // If Fixed orice type 2 only sum those rows
                if (hasFixedPriceKeepPricesRows && row.ProductId != null && row.ProductId != fixedPriceKeepPricesProductId)
                    continue;

                // Do not sum guarantee rows
                if (row.ProductId != null && row.ProductId == guaranteeProductId && (hasFixedPriceRows || hasFixedPriceKeepPricesRows))
                    continue;

                if (!checkLiftProducts || (row.Product == null || ((InvoiceProduct)row.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift))
                {
                    //SumAmount
                    if (row.Type == (int)SoeInvoiceRowType.ProductRow && row.HouseholdTaxDeductionRow == null)
                        sumAmountCurrency += row.sumAmountCurrency;

                    // Add row sum to total amount
                    totalAmountCurrency += row.SumAmountCurrency;

                    // summerize vat on invoicefee on invoices where vat is included
                    if (customerInvoice.PriceListTypeInclusiveVat && row.IsInvoiceFeeRow)
                        vatOnInvoiceFee += row.VatAmount;

                    // VAT amount
                    rowVatAmount = noVAT ? decimal.Zero : row.VatAmount;
                    if (!customerInvoice.PriceListTypeInclusiveVat)
                        totalAmountCurrency += CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(rowVatAmount, customerInvoice.CurrencyRate);
                    vatAmount += rowVatAmount;

                    if (calculateMarginalIncomeForZeroPurchase || row.PurchasePriceCurrency != 0)
                        salesAmount += row.SumAmount;
                }

                if (row.Quantity.HasValue)
                    purchaseAmount += decimal.Round(row.PurchasePrice * row.Quantity.Value, 2);

                //if (invoiceProduct != null && row.Type == (int)SoeInvoiceRowType.ProductRow && row.PurchasePrice != 0 && row.Quantity.HasValue)
                //{
                //    salesAmount += row.SumAmount;
                //    if (invoiceProduct != null)
                //        purchaseAmount += Decimal.Round(invoiceProduct.PurchasePrice * row.Quantity.Value, 2);
                //}

                //Freight
                if (row.IsFreightAmountRow)
                    freightAmountCurrency += row.SumAmountCurrency;

                //InvoiceFee
                if (row.IsInvoiceFeeRow)
                    invoiceFeeCurrency += row.SumAmountCurrency;

                //RemainingAmount - using checkLiftRows flag to not calculate remaining since thats already been done in SaveOrder
                if (customerInvoice.Origin != null && !ignoreCalculateRemaining)
                {
                    if (row.AttestStateId.HasValue && InvoiceAttestStatesIds.OrderClosedIds.Contains(row.AttestStateId.Value))
                        continue;

                    if (row.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                        hasTransferredRows = true;

                    if (customerInvoice.Origin.Type == (int)SoeOriginType.Order && ((row.Type == (int)SoeInvoiceRowType.ProductRow || row.Type == (int)SoeInvoiceRowType.BaseProductRow) ||
                                                (row.IsFreightAmountRow || row.IsInterestRow || row.IsInvoiceFeeRow || row.IsReminderRow)) &&
                                                row.AttestStateId != InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        if (!checkLiftProducts || (row.Product == null || (((InvoiceProduct)row.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)row.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)))
                        {

                            if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !customerInvoice.PriceListTypeInclusiveVat)
                            {
                                remainingAmount += row.SumAmountCurrency + row.VatAmountCurrency;
                                remainingAmountExVat += row.SumAmountCurrency;
                            }
                            else
                            {
                                remainingAmount += row.SumAmountCurrency;
                                remainingAmountExVat += row.SumAmountCurrency - row.VatAmountCurrency;
                            }

                            remainingAmountVat += row.VatAmountCurrency;
                            setRemainingAmount = true;
                        }
                    }
                    else if (row.Product != null && (((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                        && row.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !customerInvoice.PriceListTypeInclusiveVat)
                        {
                            remainingAmount += row.SumAmountCurrency + row.VatAmountCurrency;
                            remainingAmountExVat += row.SumAmountCurrency;
                        }
                        else
                        {
                            remainingAmount += row.SumAmountCurrency;
                            remainingAmountExVat += row.SumAmountCurrency - row.VatAmountCurrency;
                        }

                        remainingAmountVat += row.VatAmountCurrency;
                        setRemainingAmount = true;
                    }
                }
            }

            //Marginal
            decimal marginalIncome = salesAmount - purchaseAmount;
            decimal marginalIncomeRatio = (salesAmount != 0 ? Decimal.Round(marginalIncome / salesAmount, 2) : 1) * 100;
            if (marginalIncome < 0 && marginalIncomeRatio > 0)
                marginalIncomeRatio *= -1;
            marginalIncomeRatio = CheckMarginalIncomeRatio(marginalIncomeRatio);

            //Cent rounding
            decimal cent = Decimal.Zero;
            if (useCentRounding)
            {
                CustomerInvoiceRow centRow = customerInvoice.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                var companySysCountryId = base.GetCompanySysCountryIdFromCache(entities, actorCompanyId);

                //different cent rounding in Finland
                CalculateCentRounding(companySysCountryId, ref totalAmountCurrency, ref cent);

                if (cent != 0)
                {
                    if (centRow == null)
                    {
                        #region Add

                        centRow = new CustomerInvoiceRow()
                        {
                            Quantity = 1,
                            IsCentRoundingRow = true,
                            Type = (showCentRoundingAsRow && (!showCentRoundingIfNotZero || cent != 0)) ? (int)SoeInvoiceRowType.BaseProductRow : (int)SoeInvoiceRowType.AccountingRow,
                            DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                            HouseholdDeductionType = defaultHouseholdDeductionType != 0 ? defaultHouseholdDeductionType : (int?)null,
                        };
                        SetCreatedProperties(centRow);

                        //Set product
                        InvoiceProduct product = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductCentRounding, actorCompanyId);
                        if (product != null)
                        {
                            centRow.Text = product.Name;
                            centRow.Product = product as Product;
                            centRow.ProductUnit = product.ProductUnit;

                            // Get VAT information
                            AccountingPrioDTO dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, product.ProductId, 0, customerInvoice.ActorId.HasValue ? customerInvoice.ActorId.Value : 0, 0, ProductAccountType.VAT, (TermGroup_InvoiceVatType)customerInvoice.VatType, false);
                            int centVatAccountId = dto != null && dto.AccountId.HasValue ? dto.AccountId.Value : 0;
                            if (centVatAccountId != 0)
                            {
                                // Set VAT account
                                centRow.VatAccountId = centVatAccountId;

                                // Set VAT rate
                                centRow.VatRate = AccountManager.GetVatRateValue(entities, centVatAccountId);
                            }
                        }

                        customerInvoice.CustomerInvoiceRow.Add(centRow);

                        #endregion
                    }
                    else
                    {
                        #region Update

                        SetModifiedProperties(centRow);

                        #endregion
                    }

                    centRow.Amount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(cent, customerInvoice.CurrencyRate);
                    centRow.AmountCurrency = cent;

                    centRow.SumAmount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(cent, customerInvoice.CurrencyRate);
                    centRow.SumAmountCurrency = cent;
                }
                else if (centRow != null)
                {
                    #region Delete

                    //Cent rounding is zero, but a row exists, delete it
                    if (centRow.CustomerInvoiceAccountRow != null)
                    {
                        foreach (CustomerInvoiceAccountRow accRow in centRow.CustomerInvoiceAccountRow.ToList())
                        {
                            accRow.State = (int)SoeEntityState.Deleted;
                        }
                    }
                    centRow.State = (int)SoeEntityState.Deleted;

                    #endregion
                }
            }

            if (customerInvoice.PriceListTypeInclusiveVat)
            {
                sumAmountCurrency -= vatAmount;
                sumAmountCurrency += vatOnInvoiceFee; // Needs to be added again since sumamount is not including InvoiceFee but vatamount is.
            }

            //Set new values
            customerInvoice.TotalAmountCurrency = Decimal.Round(totalAmountCurrency, 2);
            customerInvoice.TotalAmount = Decimal.Round(CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(totalAmountCurrency, customerInvoice.CurrencyRate), 2);

            customerInvoice.SumAmount = Decimal.Round(sumAmount, 2);
            customerInvoice.SumAmountCurrency = Decimal.Round(CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(sumAmount, customerInvoice.CurrencyRate), 2);

            customerInvoice.VATAmount = Decimal.Round(vatAmount, 2);
            customerInvoice.VATAmountCurrency = Decimal.Round(CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(vatAmount, customerInvoice.CurrencyRate), 2);

            customerInvoice.FreightAmountCurrency = Decimal.Round(freightAmountCurrency, 2);
            customerInvoice.FreightAmount = Decimal.Round(CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(freightAmountCurrency, customerInvoice.CurrencyRate), 2);

            customerInvoice.InvoiceFeeCurrency = Decimal.Round(invoiceFeeCurrency, 2);
            customerInvoice.InvoiceFee = Decimal.Round(CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(invoiceFeeCurrency, customerInvoice.CurrencyRate), 2);

            customerInvoice.MarginalIncome = Decimal.Round(marginalIncome, 2);
            customerInvoice.MarginalIncomeCurrency = Decimal.Round(CountryCurrencyManager.GetCurrencyAmountFromBaseAmount(marginalIncome, customerInvoice.CurrencyRate), 2);

            customerInvoice.MarginalIncomeRatio = Decimal.Round(marginalIncomeRatio, 2);
            customerInvoice.CentRounding = Decimal.Round(cent, 2);

            if (!ignoreCalculateRemaining)
            {
                customerInvoice.RemainingAmount = setRemainingAmount ? hasTransferredRows ? Math.Round(remainingAmount, 0, MidpointRounding.ToEven) : remainingAmount + cent : 0;
                customerInvoice.RemainingAmountVat = setRemainingAmount ? remainingAmountVat : 0;
                customerInvoice.RemainingAmountExVat = setRemainingAmount ? remainingAmountExVat : 0;
            }

        }
        */
        #endregion

        public void CalculateAmountsByCurrency(CompEntities entities, CustomerInvoice customerInvoice, bool useCentRounding, int actorCompanyId, bool checkLiftProducts = false, bool ignoreCalculateRemaining = false)
        {
            bool setRemainingAmount = false;
            decimal totalAmount = 0;
            decimal totalAmountCurrency = 0;
            decimal sumAmount = 0;
            decimal sumAmountCurrency = 0;
            decimal rowVatAmount = 0;
            decimal rowVatAmountCurrency = 0;
            decimal vatAmount = 0;
            decimal vatAmountCurrency = 0;
            decimal freightAmount = 0;
            decimal freightAmountCurrency = 0;
            decimal invoiceFee = 0;
            decimal invoiceFeeCurrency = 0;
            decimal salesAmount = 0;
            decimal salesAmountCurrency = 0;
            decimal purchaseAmount = 0;
            decimal purchaseAmountCurrency = 0;
            decimal remainingAmount = 0;
            decimal remainingAmountVat = 0;
            decimal remainingAmountExVat = 0;
            decimal vatOnInvoiceFee = 0;
            decimal vatOnInvoiceFeeAmount = 0;

            //Check if attestates are loaded
            InitializeAttestStateIds(entities, actorCompanyId);

            // Check VAT type
            bool noVAT = (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Contractor || customerInvoice.VatType == (int)TermGroup_InvoiceVatType.NoVat);

            int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, actorCompanyId, 0);

            int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, actorCompanyId, 0);
            bool hasFixedPriceKeepPricesRows = customerInvoice.ActiveCustomerInvoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceKeepPricesProductId);

            int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, actorCompanyId, 0);
            bool hasFixedPriceRows = customerInvoice.ActiveCustomerInvoiceRows.Any(r => r.ProductId != null && r.ProductId == fixedPriceProductId);

            int guaranteeProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, actorCompanyId, 0);

            bool calculateMarginalIncomeForZeroPurchase = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingCalculateMarginalIncomeForRowsWithZeroPurchasePrice, 0, actorCompanyId, 0, true);

            var hasTransferredRows = false;

            customerInvoice.LoadCustomerInvoiceAccountRows(entities);

            foreach (CustomerInvoiceRow row in customerInvoice.CustomerInvoiceRow.Where(r => r.State == (int)SoeEntityState.Active))
            {
                // Do not sum text, page break or sub total rows
                if (row.Type == (int)SoeInvoiceRowType.TextRow || row.Type == (int)SoeInvoiceRowType.PageBreakRow || row.Type == (int)SoeInvoiceRowType.SubTotalRow)
                    continue;

                // Get product
                if (!row.ProductReference.IsLoaded)
                    row.ProductReference.Load();

                //if (row.Type == (int)SoeInvoiceRowType.AccountingRow)
                //{
                if (!row.CustomerInvoiceAccountRowIsLoaded && row.EntityState != System.Data.Entity.EntityState.Added && row.EntityState != System.Data.Entity.EntityState.Detached)
                    row.LoadCustomerInvoiceAccountRow();


                //Do not sum the claim row...can be both Debit or Credit depending on billing type....
                if (row.Type == (int)SoeInvoiceRowType.AccountingRow && row.Product == null && row.IsCentRoundingRow == false &&
                    ((row.CustomerInvoiceAccountRow != null && row.CustomerInvoiceAccountRow.FirstOrDefault(r => /*r.DebitRow == true &&*/ r.VatRow == false) != null) ||
                    row.CustomerInvoiceAccountRow.Count == 0))
                    continue;
                //}


                //Do not sum existing cent rounding row
                if (row.IsCentRoundingRow)
                    continue;

                // If Fixed orice type 2 only sum those rows
                if (hasFixedPriceKeepPricesRows && row.ProductId != null && row.ProductId != fixedPriceKeepPricesProductId)
                    continue;

                // Do not sum guarantee rows
                if (row.ProductId != null && row.ProductId == guaranteeProductId && (hasFixedPriceRows || hasFixedPriceKeepPricesRows))
                    continue;

                if (!checkLiftProducts || (row.Product == null || ((InvoiceProduct)row.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift))
                {
                    //SumAmount
                    if (row.Type == (int)SoeInvoiceRowType.ProductRow && row.HouseholdTaxDeductionRow == null)
                    {
                        sumAmountCurrency += row.SumAmountCurrency;
                        sumAmount += row.SumAmount;
                    }

                    // Add row sum to total amount
                    totalAmountCurrency += row.SumAmountCurrency;
                    totalAmount += row.SumAmount;

                    // summerize vat on invoicefee on invoices where vat is included
                    if (customerInvoice.PriceListTypeInclusiveVat && row.IsInvoiceFeeRow)
                    {
                        vatOnInvoiceFee += row.VatAmountCurrency;
                        vatOnInvoiceFeeAmount += row.VatAmount;
                    }

                    // VAT amount
                    rowVatAmountCurrency = noVAT ? Decimal.Zero : row.VatAmountCurrency;
                    rowVatAmount = noVAT ? Decimal.Zero : row.VatAmount;
                    if (!customerInvoice.PriceListTypeInclusiveVat)
                    {
                        totalAmountCurrency += rowVatAmountCurrency;
                        totalAmount += rowVatAmount;
                    }
                    vatAmountCurrency += rowVatAmountCurrency;
                    vatAmount += rowVatAmount;

                    if (calculateMarginalIncomeForZeroPurchase || row.PurchasePriceCurrency != 0)
                    {
                        salesAmountCurrency += row.SumAmountCurrency;
                        salesAmount += row.SumAmount;
                    }
                }

                //Sales and PurchaseAmount
                if (row.Quantity.HasValue)
                {
                    purchaseAmountCurrency += Decimal.Round(row.PurchasePriceCurrency * row.Quantity.Value, 2);
                    purchaseAmount += Decimal.Round(row.PurchasePrice * row.Quantity.Value, 2);
                }

                /*if (invoiceProduct != null && row.Type == (int)SoeInvoiceRowType.ProductRow && row.PurchasePrice != 0 && row.Quantity.HasValue)
                {
                    salesAmount += row.SumAmount;
                    if (invoiceProduct != null)
                        purchaseAmount += Decimal.Round(invoiceProduct.PurchasePrice * row.Quantity.Value, 2);
                }*/

                //Freight
                if (row.IsFreightAmountRow)
                {
                    freightAmountCurrency += row.SumAmountCurrency;
                    freightAmount += row.SumAmount;
                }

                //InvoiceFee
                if (row.IsInvoiceFeeRow)
                {
                    invoiceFeeCurrency += row.SumAmountCurrency;
                    invoiceFee += row.SumAmount;
                }

                //RemainingAmount
                if (customerInvoice.Origin != null && !ignoreCalculateRemaining)
                {
                    if (row.AttestStateId.HasValue && (InvoiceAttestStatesIds.OrderClosedIds.Contains(row.AttestStateId.Value) || InvoiceAttestStatesIds.OrderHiddenIds.Contains(row.AttestStateId.Value)))
                        continue;

                    if (row.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                        hasTransferredRows = true;

                    if (customerInvoice.Origin.Type == (int)SoeOriginType.Order && ((row.Type == (int)SoeInvoiceRowType.ProductRow || row.Type == (int)SoeInvoiceRowType.BaseProductRow) ||
                                                (row.IsCentRoundingRow || row.IsFreightAmountRow || row.IsInterestRow || row.IsInvoiceFeeRow || row.IsReminderRow)) &&
                                                row.AttestStateId != InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        if (!checkLiftProducts || (row.Product == null || (((InvoiceProduct)row.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Lift && ((InvoiceProduct)row.Product).CalculationType != (int)TermGroup_InvoiceProductCalculationType.Clearing)))
                        {
                            if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise)
                            {
                                if (customerInvoice.PriceListTypeInclusiveVat)
                                {
                                    remainingAmount += row.SumAmountCurrency;
                                    remainingAmountExVat += row.SumAmountCurrency - row.VatAmountCurrency;
                                }
                                else
                                {
                                    remainingAmount += row.SumAmountCurrency + row.VatAmountCurrency;
                                    remainingAmountExVat += row.SumAmountCurrency;
                                }

                                remainingAmountVat += row.VatAmountCurrency;
                            }
                            else
                            {
                                remainingAmount += row.SumAmountCurrency;
                                remainingAmountExVat += row.SumAmountCurrency;
                            }

                            /*
                            if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise)
                            {
                                remainingAmount += (row.SumAmountCurrency + row.VatAmountCurrency);
                            }
                            else
                            {
                                remainingAmount += row.SumAmountCurrency;
                            }

                            remainingAmountVat += row.VatAmountCurrency;
                            remainingAmountExVat += row.SumAmountCurrency;
                            */
                            setRemainingAmount = true;
                        }
                    }
                    else if (row.Product != null && (((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift || ((InvoiceProduct)row.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Clearing)
                        && row.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise && !customerInvoice.PriceListTypeInclusiveVat)
                        {
                            remainingAmount += row.SumAmountCurrency + row.VatAmountCurrency;
                            remainingAmountExVat += row.SumAmountCurrency;
                        }
                        else
                        {
                            remainingAmount += row.SumAmountCurrency;
                            remainingAmountExVat += row.SumAmountCurrency - row.VatAmountCurrency;
                        }

                        remainingAmountVat += row.VatAmountCurrency;

                        /*
                        if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Merchandise)
                        {
                            remainingAmount += (row.SumAmountCurrency + row.VatAmountCurrency);
                        }
                        else
                        {
                            remainingAmount += row.SumAmountCurrency;
                        }

                        remainingAmountVat += row.VatAmountCurrency;
                        remainingAmountExVat += row.SumAmountCurrency;
                        */
                        setRemainingAmount = true;
                    }
                }
            }

            //Marginal
            decimal marginalIncomeCurrency = salesAmountCurrency - purchaseAmountCurrency;
            decimal marginalIncome = salesAmount - purchaseAmount;
            decimal marginalIncomeRatio = (salesAmountCurrency != 0 ? decimal.Round(marginalIncomeCurrency / salesAmountCurrency, 2) : 1) * 100;
            if (marginalIncomeCurrency < 0 && marginalIncomeRatio > 0)
                marginalIncomeRatio *= -1;
            marginalIncomeRatio = CheckMarginalIncomeRatio(marginalIncomeRatio);

            //Cent rounding
            decimal cent = decimal.Zero;
            if (useCentRounding)
            {
                CustomerInvoiceRow centRow = customerInvoice.CustomerInvoiceRow.FirstOrDefault(r => r.IsCentRoundingRow && r.State == (int)SoeEntityState.Active);
                var companySysCountryId = base.GetCompanySysCountryIdFromCache(entities, actorCompanyId);
                CalculateCentRounding(companySysCountryId, ref totalAmountCurrency, ref cent);

                if (cent != 0)
                {
                    if (centRow == null)
                    {
                        #region Add

                        centRow = new CustomerInvoiceRow()
                        {
                            Quantity = 1,
                            IsCentRoundingRow = true,
                            Type = cent != 0 ? (int)SoeInvoiceRowType.BaseProductRow : (int)SoeInvoiceRowType.AccountingRow,
                            DiscountType = (int)SoeInvoiceRowDiscountType.Percent,
                            HouseholdDeductionType = defaultHouseholdDeductionType != 0 ? defaultHouseholdDeductionType : (int?)null,
                        };
                        SetCreatedProperties(centRow);

                        //Set product
                        InvoiceProduct product = ProductManager.GetInvoiceProductFromSetting(entities, CompanySettingType.ProductCentRounding, actorCompanyId);
                        if (product != null)
                        {
                            centRow.Text = product.Name;
                            centRow.Product = product as Product;
                            centRow.ProductUnit = product.ProductUnit;

                            // Get VAT information
                            AccountingPrioDTO dto = AccountManager.GetInvoiceProductAccount(entities, actorCompanyId, product.ProductId, 0, customerInvoice.ActorId.HasValue ? customerInvoice.ActorId.Value : 0, 0, ProductAccountType.VAT, (TermGroup_InvoiceVatType)customerInvoice.VatType, false);
                            int centVatAccountId = dto != null && dto.AccountId.HasValue ? dto.AccountId.Value : 0;
                            if (centVatAccountId != 0)
                            {
                                // Set VAT account
                                centRow.VatAccountId = centVatAccountId;

                                // Set VAT rate
                                centRow.VatRate = AccountManager.GetVatRateValue(entities, centVatAccountId);
                            }
                        }

                        customerInvoice.CustomerInvoiceRow.Add(centRow);

                        #endregion
                    }
                    else
                    {
                        #region Update

                        SetModifiedProperties(centRow);

                        #endregion
                    }

                    centRow.Amount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(cent, customerInvoice.CurrencyRate);
                    centRow.AmountCurrency = cent;

                    centRow.SumAmount = CountryCurrencyManager.GetBaseAmountFromCurrencyAmount(cent, customerInvoice.CurrencyRate);
                    centRow.SumAmountCurrency = cent;

                    // Add to base currency total
                    totalAmount += centRow.Amount;
                }
                else if (centRow != null)
                {
                    #region Delete

                    //Cent rounding is zero, but a row exists, delete it
                    if (centRow.CustomerInvoiceAccountRow != null)
                    {
                        foreach (CustomerInvoiceAccountRow accRow in centRow.CustomerInvoiceAccountRow.ToList())
                        {
                            accRow.State = (int)SoeEntityState.Deleted;
                        }
                    }
                    centRow.State = (int)SoeEntityState.Deleted;

                    #endregion
                }
            }

            if (customerInvoice.PriceListTypeInclusiveVat)
            {
                sumAmountCurrency -= vatAmountCurrency;
                sumAmountCurrency += vatOnInvoiceFee; // Needs to be added again since sumamount is not including InvoiceFee but vatamount is.
            }

            //Set new values
            customerInvoice.TotalAmountCurrency = Decimal.Round(totalAmountCurrency, 2);
            customerInvoice.TotalAmount = Decimal.Round(totalAmount, 2);

            customerInvoice.SumAmountCurrency = Decimal.Round(sumAmountCurrency, 2);
            customerInvoice.SumAmount = Decimal.Round(sumAmount, 2);

            customerInvoice.VATAmountCurrency = Decimal.Round(vatAmountCurrency, 2);
            customerInvoice.VATAmount = Decimal.Round(vatAmount, 2);

            customerInvoice.FreightAmountCurrency = Decimal.Round(freightAmountCurrency, 2);
            customerInvoice.FreightAmount = Decimal.Round(freightAmount, 2);

            customerInvoice.InvoiceFeeCurrency = Decimal.Round(invoiceFeeCurrency, 2);
            customerInvoice.InvoiceFee = Decimal.Round(invoiceFee, 2);

            customerInvoice.MarginalIncome = Decimal.Round(marginalIncome, 2);
            customerInvoice.MarginalIncomeCurrency = Decimal.Round(marginalIncomeCurrency, 2);

            customerInvoice.MarginalIncomeRatio = Decimal.Round(marginalIncomeRatio, 2);
            customerInvoice.CentRounding = Decimal.Round(cent, 2);
            if (!ignoreCalculateRemaining)
            {
                customerInvoice.RemainingAmount = setRemainingAmount ? hasTransferredRows ? Math.Round(remainingAmount, 0, MidpointRounding.ToEven) : remainingAmount + cent : 0;
                customerInvoice.RemainingAmountVat = setRemainingAmount ? remainingAmountVat : 0;
                customerInvoice.RemainingAmountExVat = setRemainingAmount ? remainingAmountExVat : 0;
            }

        }

        private static void CalculateCentRounding(int companySysCountryId, ref decimal value, ref decimal cent)
        {
            cent = Math.Abs(value) - Math.Abs(decimal.Truncate(value));

            if (cent != decimal.Zero)
            {
                //different cent rounding in Finland
                if (companySysCountryId == (int)TermGroup_Languages.Finnish)
                {
                    cent = (Math.Round((value / 0.05m), 0) * 0.05m) - value;
                    value = Math.Round((value / 0.05m), 0) * 0.05m;
                }
                else
                {
                    cent = Math.Round(value, 0, MidpointRounding.AwayFromZero) - value;
                    value = Math.Round(value, 0, MidpointRounding.AwayFromZero);
                }
            }
        }

        public bool ChangeCurrencyDate(CompEntities entities, CustomerInvoice customerInvoice, DateTime newdate, bool recalculateTotals = false)
        {
            if (newdate != customerInvoice.CurrencyDate)
            {
                var baseCurrency = CountryCurrencyManager.GetCompanyBaseCurrencyDTO(entities, base.ActorCompanyId);
                customerInvoice.CurrencyDate = newdate;
                if (customerInvoice.CurrencyId != baseCurrency.CurrencyId)
                {
                    var newRate = CountryCurrencyManager.GetCurrencyRateFromCurrencyId(entities, customerInvoice.CurrencyId, base.ActorCompanyId, customerInvoice.CurrencyDate);
                    if (newRate != customerInvoice.CurrencyRate)
                    {
                        customerInvoice.CurrencyRate = newRate;
                        CountryCurrencyManager.CalculateCurrencyAmounts(entities, base.ActorCompanyId, customerInvoice, calculateForImport: true, recalculateTotals: recalculateTotals);
                        return true;
                    }
                }
            }

            return false;
        }

        public static DateTime GetSelectionDate(TermGroup_GridDateSelectionType allSelection)
        {
            switch (allSelection)
            {
                case TermGroup_GridDateSelectionType.One_Day:
                    return DateTime.Today;//.AddDays(-1);
                case TermGroup_GridDateSelectionType.One_Week:
                    return DateTime.Today.AddDays(-7);
                case TermGroup_GridDateSelectionType.One_Month:
                    return DateTime.Today.AddMonths(-1);
                case TermGroup_GridDateSelectionType.Tree_Months:
                    return DateTime.Today.AddMonths(-3);
                case TermGroup_GridDateSelectionType.Six_Months:
                    return DateTime.Today.AddMonths(-6);
                case TermGroup_GridDateSelectionType.Twelve_Months:
                    return DateTime.Today.AddYears(-1);
                case TermGroup_GridDateSelectionType.TwentyFour_Months:
                    return DateTime.Today.AddYears(-2);
                case TermGroup_GridDateSelectionType.All:
                    return DateTime.Today.AddYears(-100);
                default:
                    throw new Exception("GetAllItemsSelectionDate got unknown type");
            }
        }

        private bool IsCustomerInvoiceRowAttestStateValid(CustomerInvoiceRow row, AttestState attestStateTo, List<AttestTransition> attestTransitions)
        {
            if (row == null || !row.AttestStateId.HasValue || attestTransitions == null || attestTransitions.Count == 0 || attestStateTo == null)
                return false;

            var attestTransition = (from at in attestTransitions
                                    where at.AttestStateFrom != null &&
                                    at.AttestStateTo != null &&
                                    at.AttestStateFrom.AttestStateId == row.AttestStateId &&
                                    at.AttestStateTo.AttestStateId == attestStateTo.AttestStateId
                                    select at).FirstOrDefault();

            return attestTransition != null;
        }

        public List<OriginInvoiceMappingDTO> GetMappedInvoices(CompEntities entities, int invoiceId, List<SoeOriginInvoiceMappingType> types, bool reversed)
        {
            IQueryable<OriginInvoiceMapping> query = (from m in entities.OriginInvoiceMapping
                                                      where types.Contains((SoeOriginInvoiceMappingType)m.Type)
                                                      select m
                                                 );

            if (reversed)
            {
                query = query.Where(m => m.OriginId == invoiceId);
            }
            else
            {
                query = query.Where(m => m.InvoiceId == invoiceId);
            }

            return query.Select(map => new OriginInvoiceMappingDTO()
            {
                OriginInvoiceMappingId = map.OriginInvoiceMappingId,
                OriginId = map.OriginId,
                InvoiceId = map.InvoiceId,
                Type = (SoeOriginInvoiceMappingType)map.Type
            }).ToList();
        }
        public List<CustomerInvoiceSmallExDTO> GetMappedInvoices(CompEntities entities, int invoiceId, SoeOriginInvoiceMappingType type, bool reversed, bool getOriginData)
        {

            IQueryable<OriginInvoiceMapping> query = (from m in entities.OriginInvoiceMapping
                                                      where m.Type == (int)type
                                                      select m
                                                 );
            if (reversed)
            {
                query = query.Where(m => m.OriginId == invoiceId);
            }
            else
            {
                query = query.Where(m => m.InvoiceId == invoiceId);
            }

            if (getOriginData)
                return (from m in query
                        select new CustomerInvoiceSmallExDTO
                        {
                            ActorId = m.Origin.Invoice.ActorId,
                            InvoiceId = m.Origin.Invoice.InvoiceId,
                            InvoiceNr = m.Origin.Invoice.InvoiceNr,
                            SeqNr = m.Origin.Invoice.SeqNr,
                            ProjectId = m.Origin.Invoice.ProjectId,
                            CurrencyId = m.Origin.Invoice.CurrencyId,
                            InvoiceDate = m.Origin.Invoice.InvoiceDate,
                        }).ToList();
            else
                return (from m in query
                        select new CustomerInvoiceSmallExDTO
                        {
                            ActorId = m.Invoice.ActorId,
                            InvoiceId = m.Invoice.InvoiceId,
                            InvoiceNr = m.Invoice.InvoiceNr,
                            SeqNr = m.Invoice.SeqNr,
                            ProjectId = m.Invoice.ProjectId,
                            CurrencyId = m.Invoice.CurrencyId,
                            InvoiceDate = m.Invoice.InvoiceDate
                        }).ToList();
        }

        public static SoeOriginInvoiceMappingType GetOriginInvoiceMappingType(Invoice invoice)
        {
            if (invoice is SupplierInvoice)
                return SoeOriginInvoiceMappingType.SupplierInvoice;
            else if (invoice is CustomerInvoice)
            {
                switch ((OrderInvoiceRegistrationType)(invoice as CustomerInvoice).RegistrationType)
                {
                    case OrderInvoiceRegistrationType.Offer:
                        return SoeOriginInvoiceMappingType.Offer;
                    case OrderInvoiceRegistrationType.Order:
                        return SoeOriginInvoiceMappingType.Order;
                    case OrderInvoiceRegistrationType.Contract:
                        return SoeOriginInvoiceMappingType.Contract;
                    case OrderInvoiceRegistrationType.Ledger:
                        return SoeOriginInvoiceMappingType.CustomerInvoice;
                    case OrderInvoiceRegistrationType.Invoice:
                        {
                            switch ((TermGroup_BillingType)invoice.BillingType)
                            {
                                case TermGroup_BillingType.Debit:
                                    return SoeOriginInvoiceMappingType.DebitInvoice;
                                case TermGroup_BillingType.Credit:
                                    return SoeOriginInvoiceMappingType.CreditInvoice;
                                case TermGroup_BillingType.Interest:
                                    return SoeOriginInvoiceMappingType.InterestInvoice;
                                case TermGroup_BillingType.Reminder:
                                    return SoeOriginInvoiceMappingType.ClaimInvoice;
                            }
                            break;
                        }
                }
            }

            return SoeOriginInvoiceMappingType.None;
        }

        #endregion

        #endregion

        #region Invoice and paymentStatus

        public List<GenericType> GetInvoiceAndPaymentStatus(SoeOriginType originType, bool addEmptyRow)
        {
            List<GenericType> terms = new List<GenericType>();

            switch (originType)
            {
                case SoeOriginType.SupplierInvoice:
                    terms = base.GetTermGroupContent(TermGroup.OriginStatus);
                    terms = (from i in terms
                             where i.Id <= (int)SoeOriginStatusGroup.GeneralStop ||
                             (i.Id >= (int)SoeOriginStatusGroup.SupplierInvoiceStart && i.Id <= (int)SoeOriginStatusGroup.SupplierInvoiceStop)
                             select i).ToList();
                    break;
                case SoeOriginType.CustomerInvoice:
                    terms = base.GetTermGroupContent(TermGroup.OriginStatus);
                    terms = (from i in terms
                             where i.Id <= (int)SoeOriginStatusGroup.GeneralStop ||
                             (i.Id >= (int)SoeOriginStatusGroup.CustomerInvoiceStart && i.Id <= (int)SoeOriginStatusGroup.CustomerInvoiceStop)
                             select i).ToList();
                    break;
                case SoeOriginType.SupplierPayment:
                    terms = base.GetTermGroupContent(TermGroup.PaymentStatus);
                    terms = (from i in terms
                             where (i.Id >= (int)SoePaymentStatusGroup.GeneralStart && i.Id <= (int)SoePaymentStatusGroup.GeneralStop) ||
                             (i.Id >= (int)SoePaymentStatusGroup.SupplierInvoiceStart && i.Id <= (int)SoePaymentStatusGroup.SupplierInvoiceStop) ||
                              (i.Id == (int)SoeOriginStatusGroup.PaymentStart)  // Show Avprickad also 
                             select i).ToList();
                    break;
                case SoeOriginType.CustomerPayment:
                    terms = base.GetTermGroupContent(TermGroup.PaymentStatus);
                    terms = (from i in terms
                             where i.Id <= (int)SoePaymentStatusGroup.GeneralStop ||
                             (i.Id >= (int)SoePaymentStatusGroup.CustomerInvoiceStart && i.Id <= (int)SoePaymentStatusGroup.CustomerInvoiceStop)
                             select i).ToList();
                    break;
                case SoeOriginType.Offer:
                    terms = base.GetTermGroupContent(TermGroup.OriginStatus);
                    terms = (from i in terms
                             where i.Id == (int)SoeOriginStatus.Draft ||
                             i.Id == (int)SoeOriginStatus.Origin ||
                             i.Id == (int)SoeOriginStatus.Cancel ||
                             (i.Id >= (int)SoeOriginStatusGroup.OfferStart && i.Id <= (int)SoeOriginStatusGroup.OfferStop)
                             select i).ToList();
                    break;
                case SoeOriginType.Order:
                    terms = base.GetTermGroupContent(TermGroup.OriginStatus);
                    terms = (from i in terms
                             where i.Id == (int)SoeOriginStatus.Draft ||
                             i.Id == (int)SoeOriginStatus.Origin ||
                             i.Id == (int)SoeOriginStatus.Cancel ||
                             (i.Id >= (int)SoeOriginStatusGroup.OrderStart && i.Id <= (int)SoeOriginStatusGroup.OrderStop)
                             select i).ToList();
                    break;
                case SoeOriginType.Contract:
                    terms = base.GetTermGroupContent(TermGroup.OriginStatus);
                    terms = (from i in terms
                             where i.Id == (int)SoeOriginStatus.Origin ||
                             i.Id == (int)SoeOriginStatus.Cancel ||
                             (i.Id >= (int)SoeOriginStatusGroup.ContractStart && i.Id <= (int)SoeOriginStatusGroup.ContractStop)
                             select i).ToList();

                    // Swap term 'underlag' for 'aktivt'
                    var term = terms.FirstOrDefault(t => t.Id == (int)SoeOriginStatus.Origin);
                    if (term != null)
                        term.Name = GetText(98, "Aktivt");
                    break;
            }

            if (addEmptyRow)
            {
                terms = terms.Where(i => i.Id > 0).ToList();

                terms.Insert(0, new GenericType()
                {
                    Id = 0,
                    Name = " ",
                });
            }

            return terms;
        }

        public ActionResult AddMatchUpdateInvoicePaymentStatus(List<CustomerInvoiceGridDTO> items, int actorCompanyId)
        {
            if (items == null || items.Count != 2)
            {
                return new ActionResult(false, 0, "Illigal number of invoices, needs 2 for even out");
            }

            var creditInvoice = items.FirstOrDefault(i => i.BillingTypeId == (int)TermGroup_BillingType.Credit);

            var creditAmount = creditInvoice.TotalAmount - creditInvoice.PaidAmount;
            var creditAmountCurrency = creditInvoice.TotalAmountCurrency - creditInvoice.PaidAmountCurrency;

            var debetInvoice = items.FirstOrDefault(i => i.BillingTypeId == (int)TermGroup_BillingType.Debit);
            var debetAmount = debetInvoice.TotalAmount - debetInvoice.PaidAmount;
            var debetAmountCurrency = debetInvoice.TotalAmountCurrency - debetInvoice.PaidAmountCurrency;

            return AddMatchUpdateInvoicePaymentStatus(SoeInvoiceType.CustomerInvoice, creditInvoice.CustomerInvoiceId, creditAmount, creditAmountCurrency, debetInvoice.CustomerInvoiceId, debetAmount, debetAmountCurrency, actorCompanyId);



        }

        public ActionResult AddMatchUpdateInvoicePaymentStatus(List<SupplierPaymentGridDTO> items, int actorCompanyId, DateTime? bulkPayDate)
        {
            var result = new ActionResult(true);

            #region prereq

            var debitInvoices = items.Where(i => i.BillingTypeId == (int)TermGroup_BillingType.Debit).OrderBy(i => i.InvoiceSeqNr);
            var creditInvoices = items.Where(i => i.BillingTypeId == (int)TermGroup_BillingType.Credit).OrderBy(i => i.InvoiceSeqNr);

            var nrOfDebits = debitInvoices.Count();
            var nrOfCredits = creditInvoices.Count();
            if (nrOfDebits == 0 || nrOfCredits == 0 || (nrOfDebits > 1 && nrOfCredits > 1))
                return new ActionResult(false, 0, GetText(9334, "Du måste ange en debetfaktura eller en kreditfaktura för att utföra utjämning."));

            var accountYearId = AccountManager.GetAccountYearId(bulkPayDate.HasValue ? bulkPayDate.Value : DateTime.Today, actorCompanyId);
            var paymentMethodId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.SupplierPaymentSettlePaymentMethod, base.UserId, base.ActorCompanyId, 0);
            var voucherSeries = VoucherManager.GetDefaultVoucherSeries(accountYearId, CompanySettingType.SupplierPaymentVoucherSeriesType, actorCompanyId);
            if (voucherSeries == null)
                return new ActionResult(null, GetText(8403, "Verifikatserie saknas"));

            if (paymentMethodId == 0)
                return new ActionResult(false, 0, GetText(9300, "Inställning för betalningsmetod vid utjämning är inte satt"));

            var creditTotalAmount = creditInvoices.Sum(i => i.TotalAmount) - creditInvoices.Sum(i => i.PaidAmount);
            var creditTotalAmountCurrency = creditInvoices.Sum(i => i.TotalAmountCurrency) - creditInvoices.Sum(i => i.PaidAmountCurrency);

            var debitTotalAmount = debitInvoices.Sum(i => i.TotalAmount) - creditInvoices.Sum(i => i.PaidAmount);
            var debitTotalAmountCurrency = debitInvoices.Sum(i => i.TotalAmountCurrency) - creditInvoices.Sum(i => i.PaidAmountCurrency);

            #endregion

            #region perform

            using (var entities = new CompEntities())
            {
                using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                {
                    try
                    {
                        var matchInvoiceId = nrOfDebits == 1 ? debitInvoices.FirstOrDefault().SupplierInvoiceId : creditInvoices.FirstOrDefault().SupplierInvoiceId;
                        var matchInvoice = InvoiceManager.GetInvoice(entities, matchInvoiceId);
                        if (matchInvoice == null)
                            return new ActionResult((int)ActionResultSave.EntityNotFound, "SupplierInvoice");

                        var matchTotalAmount = nrOfDebits == 1 ? Decimal.Negate(matchInvoice.TotalAmount - matchInvoice.PaidAmount) : matchInvoice.TotalAmount - matchInvoice.PaidAmount;
                        var matchTotalAmountCurrency = nrOfDebits == 1 ? Decimal.Negate(matchInvoice.TotalAmountCurrency - matchInvoice.PaidAmountCurrency) : matchInvoice.TotalAmountCurrency - matchInvoice.PaidAmountCurrency;

                        var invoicesToMatch = nrOfDebits == 1 ? creditInvoices : debitInvoices;

                        InvoicePaymentMatching match = new InvoicePaymentMatching()
                        {
                            ActorCompanyId = actorCompanyId,
                        };

                        result = this.AddEntityItem(entities, match, "InvoicePaymentMatching", transaction);

                        if (!result.Success)
                            return result;

                        #region handle matches

                        foreach (var invoiceToMatch in invoicesToMatch)
                        {
                            var invoice = InvoiceManager.GetInvoice(entities, invoiceToMatch.SupplierInvoiceId);

                            if (invoice == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "SupplierInvoice");

                            var paymentSave = new PaymentRowSaveDTO
                            {
                                InvoiceId = invoice.InvoiceId,
                                ActorId = (int)invoice.ActorId,
                                OnlyPayment = true,
                                PaymentDate = bulkPayDate.HasValue ? bulkPayDate.Value : DateTime.Today,
                                PaymentStatus = SoePaymentStatus.Pending,
                                CurrencyId = invoice.CurrencyId,
                                PaymentMethodId = paymentMethodId,
                                OriginType = SoeOriginType.SupplierPayment,
                                OriginStatus = SoeOriginStatus.Matched,
                                CurrencyDate = invoice.CurrencyDate,
                                CurrencyRate = invoice.CurrencyRate,
                                AccountYearId = accountYearId,
                                InvoiceType = SoeInvoiceType.SupplierInvoice,
                                VoucherSeriesId = voucherSeries.VoucherSeriesId,
                            };

                            var matchAmount = (invoice.TotalAmount - invoice.PaidAmount);
                            var matchAmountCurrency = (invoice.TotalAmountCurrency - invoice.PaidAmountCurrency);
                            if ((nrOfDebits == 1 && (matchTotalAmount - matchAmount) > 0) || (nrOfCredits == 1 && (matchTotalAmount + matchAmount) > 0))
                            {
                                matchAmount = invoiceToMatch.BillingTypeId == (int)TermGroup_BillingType.Credit ? matchTotalAmount : Decimal.Negate(matchTotalAmount);
                                matchAmountCurrency = invoiceToMatch.BillingTypeId == (int)TermGroup_BillingType.Credit ? matchTotalAmountCurrency : Decimal.Negate(matchTotalAmountCurrency);
                            }

                            paymentSave.Amount = matchAmount;
                            paymentSave.AmountCurrency = matchAmountCurrency;
                            paymentSave.FullyPayed = ((invoice.TotalAmount - invoice.PaidAmount) == paymentSave.Amount);

                            result = PaymentManager.SavePaymentRow(entities, transaction, paymentSave, null, actorCompanyId, true, false, true, true, true);

                            if (!result.Success)
                                return result;

                            //set match record
                            InvoicePaymentMatchingRecord record = new InvoicePaymentMatchingRecord()
                            {
                                Entity = (int)SoeEntityType.SupplierInvoice,
                                RecordId = invoice.InvoiceId,

                                //Set FK
                                InvoicePaymentMatchingId = match.InvoicePaymentMatchingId,
                            };

                            result = this.AddEntityItem(entities, record, "InvoicePaymentMatchingRecord", transaction);

                            if (!result.Success)
                                return result;

                            OriginInvoiceMapping oimap = new OriginInvoiceMapping
                            {
                                Origin = invoice.Origin,
                                Type = (int)GetOriginInvoiceMappingType(invoice),
                                InvoiceId = matchInvoice.InvoiceId,
                            };

                            result = this.AddEntityItem(entities, oimap, "OriginInvoiceMapping", transaction);

                            if (!result.Success)
                                return result;

                            OriginInvoiceMapping roimap = new OriginInvoiceMapping
                            {
                                Origin = matchInvoice.Origin,
                                Type = (int)GetOriginInvoiceMappingType(invoice),
                                InvoiceId = invoice.InvoiceId,
                            };

                            result = this.AddEntityItem(entities, roimap, "OriginInvoiceMapping", transaction);

                            if (!result.Success)
                                return result;

                            matchTotalAmount = nrOfDebits == 1 ? matchTotalAmount - matchAmount : matchTotalAmount + matchAmount;
                            matchTotalAmountCurrency = nrOfDebits == 1 ? matchTotalAmountCurrency - matchAmountCurrency : matchTotalAmountCurrency + matchAmountCurrency;
                            if (matchTotalAmount == 0)
                                break;


                        }

                        #endregion

                        #region handle match

                        if (matchTotalAmount == (matchInvoice.TotalAmount - matchInvoice.PaidAmount))
                            return new ActionResult(false, 0, GetText(9335, "Ingen utjämning utfördes"));

                        var paymentSaveMatch = new PaymentRowSaveDTO
                        {
                            InvoiceId = matchInvoice.InvoiceId,
                            ActorId = (int)matchInvoice.ActorId,
                            OnlyPayment = true,
                            PaymentDate = bulkPayDate.HasValue ? bulkPayDate.Value : DateTime.Today,
                            PaymentStatus = SoePaymentStatus.Pending,
                            CurrencyId = matchInvoice.CurrencyId,
                            PaymentMethodId = paymentMethodId,
                            OriginType = SoeOriginType.SupplierPayment,
                            OriginStatus = SoeOriginStatus.Matched,
                            CurrencyDate = matchInvoice.CurrencyDate,
                            CurrencyRate = matchInvoice.CurrencyRate,
                            AccountYearId = accountYearId,
                            InvoiceType = SoeInvoiceType.SupplierInvoice,
                            VoucherSeriesId = voucherSeries.VoucherSeriesId
                        };

                        var amount = matchTotalAmount == 0 ? (matchInvoice.TotalAmount - matchInvoice.PaidAmount) : (matchInvoice.BillingType == (int)TermGroup_BillingType.Debit ? (matchInvoice.TotalAmount - matchInvoice.PaidAmount) + matchTotalAmount : (matchInvoice.TotalAmount - matchInvoice.PaidAmount) - matchTotalAmount);
                        var amountCurrency = matchTotalAmountCurrency == 0 ? (matchInvoice.TotalAmountCurrency - matchInvoice.PaidAmountCurrency) : (matchInvoice.BillingType == (int)TermGroup_BillingType.Debit ? (matchInvoice.TotalAmountCurrency - matchInvoice.PaidAmountCurrency) + matchTotalAmountCurrency : (matchInvoice.TotalAmountCurrency - matchInvoice.PaidAmountCurrency) - matchTotalAmountCurrency);

                        paymentSaveMatch.Amount = amount;
                        paymentSaveMatch.AmountCurrency = amountCurrency;
                        paymentSaveMatch.FullyPayed = ((matchInvoice.TotalAmount - matchInvoice.PaidAmount) == paymentSaveMatch.Amount);

                        result = PaymentManager.SavePaymentRow(entities, transaction, paymentSaveMatch, null, actorCompanyId, true, false, true, true, true);

                        if (!result.Success)
                            return result;

                        //set match record
                        InvoicePaymentMatchingRecord matchRecord = new InvoicePaymentMatchingRecord()
                        {
                            Entity = (int)SoeEntityType.SupplierInvoice,
                            RecordId = matchInvoice.InvoiceId,

                            //Set FK
                            InvoicePaymentMatchingId = match.InvoicePaymentMatchingId,
                        };

                        result = this.AddEntityItem(entities, matchRecord, "InvoicePaymentMatchingRecord", transaction);

                        if (!result.Success)
                            return result;

                        result = SaveChanges(entities, transaction);

                        if (result.Success)
                            transaction.Complete();

                        #endregion
                    }
                    catch (Exception ex)
                    {
                        base.LogError(ex, this.log);
                        result.Exception = ex;
                        log.Error(ex.Message, ex);
                    }
                    finally
                    {
                        if (!result.Success)
                            base.LogTransactionFailed(this.ToString(), this.log);

                        entities.Connection.Close();
                    }
                }
            }

            #endregion

            return result;

            #region old

            /*if (items == null || items.Count != 2)
            {
                return new ActionResult(false, 0, "Illigal number of invoices, needs 2 for even out");
            }

            var creditInvoice = items.FirstOrDefault(i => i.BillingTypeId == (int)TermGroup_BillingType.Credit);
            var creditAmount = creditInvoice.TotalAmount - creditInvoice.PaidAmount;
            var creditAmountCurrency = creditInvoice.TotalAmountCurrency - creditInvoice.PaidAmountCurrency;

            var debetInvoice = items.FirstOrDefault(i => i.BillingTypeId == (int)TermGroup_BillingType.Debit);
            var debetAmount = debetInvoice.TotalAmount - debetInvoice.PaidAmount;
            var debetAmountCurrency = debetInvoice.TotalAmountCurrency - debetInvoice.PaidAmountCurrency;

            return AddMatchUpdateInvoicePaymentStatus(SoeInvoiceType.SupplierInvoice, creditInvoice.SupplierInvoiceId, creditAmount, creditAmountCurrency, debetInvoice.SupplierInvoiceId, debetAmount, debetAmountCurrency, actorCompanyId);*/

            #endregion
        }

        public ActionResult AddMatchUpdateInvoicePaymentStatus(SoeInvoiceType invoiceType, int creditInvoiceId, decimal creditAmount, decimal creditAmountCurrency, int debetInvoiceId, decimal debetAmount, decimal debetAmountCurrency, int actorCompanyId)
        {

            var result = new ActionResult(true);
            var invoiceIds = new List<int> { creditInvoiceId, debetInvoiceId };

            using (var entities = new CompEntities())
            {
                using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                {
                    //Create matchitem
                    InvoicePaymentMatching match = new InvoicePaymentMatching()
                    {
                        ActorCompanyId = actorCompanyId,
                    };

                    result = this.AddEntityItem(entities, match, "InvoicePaymentMatching", transaction);

                    if (result.Success)
                    {
                        var accountYearId = AccountManager.GetAccountYearId(entities, DateTime.Today, actorCompanyId);
                        var paymentMethodId = invoiceType == SoeInvoiceType.SupplierInvoice ?
                                                        SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.SupplierPaymentSettlePaymentMethod, base.UserId, base.ActorCompanyId, 0) :
                                                        SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerPaymentSettlePaymentMethod, base.UserId, base.ActorCompanyId, 0);

                        var vocherSeriesType = invoiceType == SoeInvoiceType.SupplierInvoice ? CompanySettingType.SupplierPaymentVoucherSeriesType : CompanySettingType.CustomerPaymentVoucherSeriesType;
                        var voucherSeries = VoucherManager.GetDefaultVoucherSeries(accountYearId, vocherSeriesType, actorCompanyId);
                        if (voucherSeries == null)
                            return new ActionResult(null, GetText(8403, "Verifikatserie saknas"));

                        if (paymentMethodId == 0)
                            return new ActionResult(false, 0, GetText(9300, "Inställning för betalningsmetod vid utjämning är inte satt"));

                        foreach (var invoiceId in invoiceIds)
                        {
                            #region Invoice

                            Invoice invoice = InvoiceManager.GetInvoice(entities, invoiceId);

                            if (invoice == null)
                                return new ActionResult((int)ActionResultSave.EntityNotFound, "SupplierInvoice");

                            var paymentSave = new PaymentRowSaveDTO
                            {
                                InvoiceId = invoice.InvoiceId,
                                ActorId = (int)invoice.ActorId,
                                OnlyPayment = true,
                                PaymentDate = DateTime.Today,
                                PaymentStatus = SoePaymentStatus.Pending,
                                CurrencyId = invoice.CurrencyId,
                                PaymentMethodId = paymentMethodId,
                                OriginType = invoiceType == SoeInvoiceType.SupplierInvoice ? SoeOriginType.SupplierPayment : SoeOriginType.CustomerPayment,
                                OriginStatus = SoeOriginStatus.Matched,
                                CurrencyDate = invoice.CurrencyDate,
                                CurrencyRate = invoice.CurrencyRate,
                                AccountYearId = accountYearId,
                                InvoiceType = invoiceType,
                                VoucherSeriesId = voucherSeries.VoucherSeriesId
                            };

                            if (creditInvoiceId == invoice.InvoiceId)
                            {
                                paymentSave.Amount = paymentSave.TotalAmount = decimal.Negate(creditAmount) < debetAmount ? creditAmount : decimal.Negate(debetAmount);
                                paymentSave.AmountCurrency = paymentSave.TotalAmountCurrency = decimal.Negate(creditAmountCurrency) < debetAmountCurrency ? creditAmountCurrency : decimal.Negate(debetAmountCurrency);
                            }
                            else if (debetInvoiceId == invoice.InvoiceId)
                            {
                                paymentSave.Amount = paymentSave.TotalAmount = debetAmount > Decimal.Negate(creditAmount) ? decimal.Negate(creditAmount) : debetAmount;
                                paymentSave.AmountCurrency = paymentSave.TotalAmountCurrency = debetAmountCurrency > decimal.Negate(creditAmountCurrency) ? decimal.Negate(creditAmountCurrency) : debetAmountCurrency;
                            }

                            paymentSave.FullyPayed = ((invoice.TotalAmount - invoice.PaidAmount) == paymentSave.Amount);

                            result = PaymentManager.SavePaymentRow(entities, transaction, paymentSave, null, actorCompanyId, true, false, true, true, true);

                            if (!result.Success)
                            { return result; }

                            //set match record
                            InvoicePaymentMatchingRecord record = new InvoicePaymentMatchingRecord()
                            {
                                Entity = invoiceType == SoeInvoiceType.SupplierInvoice ? (int)SoeEntityType.SupplierInvoice : (int)SoeEntityType.CustomerInvoice,
                                RecordId = invoiceId,

                                //Set FK
                                InvoicePaymentMatchingId = match.InvoicePaymentMatchingId,
                            };

                            this.AddEntityItem(entities, record, "InvoicePaymentMatchingRecord", transaction);

                            //Add origininvoicemapping for getting tracing item to invoice
                            if (creditInvoiceId != 0 && invoice.InvoiceId != creditInvoiceId)
                            {
                                OriginInvoiceMapping oimap = new OriginInvoiceMapping
                                {
                                    Origin = invoice.Origin,
                                    Type = (int)GetOriginInvoiceMappingType(invoice),
                                    InvoiceId = creditInvoiceId
                                };
                                entities.OriginInvoiceMapping.AddObject(oimap);
                            }

                            #endregion
                        }

                        result = SaveChanges(entities, transaction);
                    }
                    //Commit transaction
                    if (result.Success)
                        transaction.Complete();
                }

            }

            return result;
        }

        #endregion

        public List<ChecklistHeadRecord> GetInvoiceFromOrderCheckLists(int actorCompanyId, int InvoiceId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.OriginInvoiceMapping.NoTracking();
            return GetInvoiceFromOrderCheckLists(entities, actorCompanyId, InvoiceId);
        }
        public List<ChecklistHeadRecord> GetInvoiceFromOrderCheckLists(CompEntities entities, int actorCompanyId, int InvoiceId)
        {
            var result = new List<ChecklistHeadRecord>();

            var mappings = (from i in entities.OriginInvoiceMapping
                            where i.InvoiceId == InvoiceId &&
                            i.Type == (int)SoeOriginInvoiceMappingType.Order
                            select i);

            if (mappings.Any())
            {
                var chm = new ChecklistManager(this.parameterObject);
                foreach (var mapping in mappings)
                {
                    var checkList = chm.GetChecklistHeadRecords(SoeEntityType.Order, mapping.OriginId, actorCompanyId, true);
                    if (checkList.Any())
                    {
                        result.AddRange(checkList);
                    }
                }
            }

            return result;
        }


        #region Tracing

        #region ContractTraceView

        public List<ContractTraceViewDTO> GetContractTraceViews(int contractId, int baseSysCurrencyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ContractTraceView.NoTracking();
            return GetContractTraceViews(entities, contractId, baseSysCurrencyId);
        }

        public List<ContractTraceViewDTO> GetContractTraceViews(CompEntities entities, int contractId, int baseSysCurrencyId)
        {
            List<ContractTraceViewDTO> dtos = new List<ContractTraceViewDTO>();
            if (contractId == 0)
                return dtos;

            var items = (from v in entities.ContractTraceView
                         where v.ContractId == contractId
                         select v).ToList();

            if (!items.IsNullOrEmpty())
            {
                int langId = GetLangId();
                var originTypes = base.GetTermGroupDict(TermGroup.OriginType, langId);
                var originStatuses = base.GetTermGroupDict(TermGroup.OriginStatus, langId);

                foreach (var item in items)
                {
                    var dto = item.ToDTO();
                    dto.Foreign = item.SysCurrencyId != baseSysCurrencyId;
                    dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.SysCurrencyId);
                    if (dto.IsProject)
                    {
                        dto.OriginTypeName = GetText(3357, 1);
                        dto.OriginStatusName = "";
                        dto.BillingTypeName = "";
                    }
                    else
                    {
                        dto.OriginTypeName = dto.OriginType != 0 ? originTypes[(int)dto.OriginType] : "";
                        dto.OriginStatusName = dto.OriginStatus != 0 ? originStatuses[(int)dto.OriginStatus] : "";
                        dto.BillingTypeName = dto.BillingType != 0 ? originStatuses[(int)dto.BillingType] : "";
                    }

                    dtos.Add(dto);
                }
            }

            return dtos;
        }

        #endregion

        #region OfferTraceView

        public List<OfferTraceViewDTO> GetOfferTraceViews(int offerId, int baseSysCurrencyId, bool isOrder = false, bool isInvoice = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.OfferTraceView.NoTracking();
            return GetOfferTraceViews(entities, offerId, baseSysCurrencyId, isOrder, isInvoice);
        }

        public List<OfferTraceViewDTO> GetOfferTraceViews(CompEntities entities, int offerId, int baseSysCurrencyId, bool isOrder = false, bool isInvoice = false)
        {
            List<OfferTraceViewDTO> dtos = new List<OfferTraceViewDTO>();

            if (offerId == 0)
                return dtos;

            var items = (from v in entities.OfferTraceView
                         where v.OfferId == offerId &&
                         (!isOrder || v.IsOrder) &&
                         (!isInvoice || v.IsInvoice)
                         select v).ToList();

            if (!items.IsNullOrEmpty())
            {
                int langId = GetLangId();
                var originTypes = base.GetTermGroupDict(TermGroup.OriginType, langId);
                var originStatuses = base.GetTermGroupDict(TermGroup.OriginStatus, langId);
                var projectTypes = base.GetTermGroupDict(TermGroup.ProjectType, langId);
                var projectStatuses = base.GetTermGroupDict(TermGroup.ProjectStatus, langId);

                foreach (var item in items)
                {
                    var dto = item.ToDTO();
                    dto.Foreign = item.SysCurrencyId != baseSysCurrencyId;
                    dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.SysCurrencyId);

                    if (dto.IsProject)
                    {
                        dto.OriginTypeName = dto.OriginType != 0 ? projectTypes[(int)dto.OriginType] : "";
                        dto.OriginStatusName = dto.OriginStatus != 0 ? projectStatuses[(int)dto.OriginStatus] : "";
                        dto.BillingTypeName = "";
                    }
                    else
                    {
                        dto.OriginTypeName = dto.OriginType != 0 ? originTypes[(int)dto.OriginType] : "";
                        dto.OriginStatusName = dto.OriginStatus != 0 ? originStatuses[(int)dto.OriginStatus] : "";
                        dto.BillingTypeName = dto.BillingType != 0 ? originStatuses[(int)dto.BillingType] : "";
                    }

                    dtos.Add(dto);
                }
            }

            return dtos;
        }

        #endregion

        #region OrderTraceView

        public List<OrderTraceViewDTO> GetOrderTraceViews(int orderId, int baseSysCurrencyId, bool isOffer = false, bool isInvoice = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.OrderTraceView.NoTracking();
            return GetOrderTraceViews(entities, orderId, baseSysCurrencyId, isOffer, isInvoice);
        }

        public List<OrderTraceViewDTO> GetOrderTraceViews(CompEntities entities, int orderId, int baseSysCurrencyId, bool isOffer = false, bool isInvoice = false)
        {
            List<OrderTraceViewDTO> dtos = new List<OrderTraceViewDTO>();

            if (orderId == 0)
                return dtos;

            var items = (from v in entities.OrderTraceView
                         where v.OrderId == orderId &&
                         (isOffer == false || v.IsOffer == true) &&
                         (isInvoice == false || v.IsInvoice == true)
                         select v).ToList();

            if (!items.IsNullOrEmpty())
            {
                int langId = GetLangId();
                var originTypes = base.GetTermGroupDict(TermGroup.OriginType, langId);
                var originStatuses = base.GetTermGroupDict(TermGroup.OriginStatus, langId);
                var projectTypes = base.GetTermGroupDict(TermGroup.ProjectType, langId);
                var projectStatuses = base.GetTermGroupDict(TermGroup.ProjectStatus, langId);
                var tracingTexts = base.GetTermGroupDict(TermGroup.Tracing, langId);

                foreach (var item in items)
                {
                    var dto = item.ToDTO();
                    dto.Foreign = item.SysCurrencyId != baseSysCurrencyId;
                    dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.SysCurrencyId);

                    if (dto.IsProject)
                    {
                        dto.OriginTypeName = dto.OriginType != 0 ? projectTypes[(int)dto.OriginType] : "";
                        dto.OriginStatusName = dto.OriginStatus != 0 ? projectStatuses[(int)dto.OriginStatus] : "";
                        dto.BillingTypeName = "";
                    }
                    else if (dto.IsEdi)
                    {
                        dto.OriginTypeName = "EDI";
                        var ediView = entities.EdiEntryView.FirstOrDefault(e => e.EdiEntryId == dto.EdiEntryId);
                        dto.OriginStatusName = ediView != null ? originStatuses[ediView.OrderStatus] : "";
                        dto.BillingTypeName = dto.BillingType != 0 ? originStatuses[(int)dto.BillingType] : "";
                    }
                    else if (dto.IsStockVoucher)
                    {
                        dto.OriginTypeName = tracingTexts[22];
                        dto.OriginStatusName = "";
                    }
                    else
                    {
                        dto.OriginTypeName = dto.OriginType != 0 ? originTypes[(int)dto.OriginType] : "";
                        dto.OriginStatusName = dto.OriginStatus != 0 ? originStatuses[(int)dto.OriginStatus] : "";
                        dto.BillingTypeName = dto.BillingType != 0 ? originStatuses[(int)dto.BillingType] : "";
                    }

                    dtos.Add(dto);
                }
            }

            // Sort
            var sortedList = dtos.Where(p => p.IsProject).ToList();
            sortedList.AddRange(dtos.Where(i => !i.IsProject && !i.IsInvoice));
            sortedList.AddRange(dtos.Where(i => i.IsInvoice).OrderByDescending(i => i.OriginStatus));

            return sortedList;
        }

        #endregion

        #region InvoiceTraceView

        public List<InvoiceTraceViewDTO> GetInvoiceTraceViews(int invoiceId, int baseSysCurrencyId, bool isOffer = false, bool isOrder = false, bool isInvoice = false, bool isContract = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetInvoiceTraceViews(entities, invoiceId, baseSysCurrencyId, isOffer, isOrder, isInvoice, isContract);
        }

        public List<InvoiceTraceViewDTO> GetInvoiceTraceViews(CompEntities entities, int invoiceId, int baseSysCurrencyId, bool isOffer = false, bool isOrder = false, bool isInvoice = false, bool isContract = false)
        {
            var dtos = new List<InvoiceTraceViewDTO>();
            if (invoiceId == 0)
                return dtos;

            int langId = GetLangId();
            var originTypes = base.GetTermGroupDict(TermGroup.OriginType, langId);
            var originStatuses = base.GetTermGroupDict(TermGroup.OriginStatus, langId);
            var billingTypes = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);
            var projectTypes = base.GetTermGroupDict(TermGroup.ProjectType, langId);
            var projectStatuses = base.GetTermGroupDict(TermGroup.ProjectStatus, langId);
            var paymentStatuses = base.GetTermGroupDict(TermGroup.PaymentStatus, langId);
            var tracingTexts = base.GetTermGroupDict(TermGroup.Tracing, langId);
            var inventoryStatuses = base.GetTermGroupDict(TermGroup.InventoryStatus, langId);
            var triggerTypes = base.GetTermGroupDict(TermGroup.AccountDistributionTriggerType, langId);

            var items = (from v in entities.InvoiceTraceView
                         where v.InvoiceId == invoiceId &&
                         (!isOffer || v.IsOffer) &&
                         (!isOrder || v.IsOrder) &&
                         (!isInvoice || v.IsInvoice) &&
                         (!isContract || v.IsContract)
                         select v).ToList();

            foreach (var item in items)
            {
                var dto = item.ToDTO();
                dto.Foreign = item.SysCurrencyId != baseSysCurrencyId;
                dto.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(dto.SysCurrencyId);

                if (dto.IsAccountDistribution)
                {
                    dto.TriggerTypeName = dto.TriggerType != 0 ? triggerTypes[dto.TriggerType] : "";
                }
                else if (dto.IsProject)
                {
                    dto.OriginTypeName = dto.OriginType != 0 ? projectTypes[(int)dto.OriginType] : "";
                    dto.OriginStatusName = dto.OriginStatus != 0 ? projectStatuses[(int)dto.OriginStatus] : "";
                }
                else if (dto.IsInventory)
                {
                    dto.OriginTypeName = dto.OriginType != 0 ? originTypes[(int)dto.OriginType] : "";
                    dto.OriginStatusName = dto.OriginStatus != 0 ? originStatuses[(int)dto.OriginStatus] : "";
                    dto.BillingTypeName = dto.BillingType != 0 ? billingTypes[(int)dto.BillingType] : "";
                    dto.InventoryTypeName = tracingTexts[24];
                    dto.InventoryStatusName = dto.InventoryStatusId != 0 ? inventoryStatuses[(int)dto.InventoryStatusId] : "";
                }
                else if (dto.IsVoucher || dto.IsStockVoucher)
                {
                    dto.OriginTypeName = tracingTexts[22];
                    dto.OriginStatusName = "";
                }
                else if (dto.IsEdi)
                {
                    dto.OriginTypeName = "EDI";
                    var ediView = entities.EdiEntryView.FirstOrDefault(e => e.EdiEntryId == dto.EdiEntryId);
                    dto.OriginStatusName = ediView != null ? originStatuses[ediView.OrderStatus] : "";
                }
                else if (dto.IsScanning)
                {
                    dto.OriginTypeName = GetText(5501, (int)TermGroup.General, "Tolkad");
                    var ediView = entities.EdiEntryView.FirstOrDefault(e => e.EdiEntryId == dto.EdiEntryId);
                    dto.OriginStatusName = ediView != null ? originStatuses[ediView.OrderStatus] : "";
                }
                else if (dto.IsPayment)
                {
                    dto.OriginTypeName = dto.OriginType != 0 ? originTypes[(int)dto.OriginType] : "";
                    dto.OriginStatusName = dto.OriginStatus != 0 ? originStatuses[(int)dto.OriginStatus] : "";
                    dto.BillingTypeName = dto.BillingType != 0 ? billingTypes[(int)dto.BillingType] : "";
                    dto.PaymentStatusName = dto.PaymentStatusId != 0 ? paymentStatuses[(int)dto.PaymentStatusId] : "";
                }
                else
                {
                    dto.OriginTypeName = dto.OriginType != 0 ? originTypes[(int)dto.OriginType] : "";
                    dto.OriginStatusName = dto.OriginStatus != 0 ? originStatuses[(int)dto.OriginStatus] : "";
                    dto.BillingTypeName = dto.BillingType != 0 ? billingTypes[(int)dto.BillingType] : "";

                    if (dto.OriginType == SoeOriginType.CustomerInvoice && dto.BillingType != TermGroup_BillingType.Debit)
                    {
                        dto.Description = dto.BillingTypeName;
                    }
                }

                dtos.Add(dto);
            }

            return dtos;
        }

        public List<int> GetConnectedOrdersForCustomerInvoice(CompEntities entities, int invoiceId)
        {
            List<int> distinctIds = new List<int>();

            var invoice = (from i in entities.Invoice
                               .Include("Origin")
                           where i.InvoiceId == invoiceId &&
                           i.State == (int)SoeEntityState.Active
                           select i).OfType<CustomerInvoice>().FirstOrDefault();

            if (invoice != null)
            {
                distinctIds.Add(invoice.InvoiceId);

                if (invoice.Origin != null && invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice)
                {
                    #region InvoiceTracing (to find Order's)

                    var invoiceTraceViews = InvoiceManager.GetInvoiceTraceViews(invoice.InvoiceId, 0, isOrder: true);
                    foreach (var invoiceTraceView in invoiceTraceViews.Where(i => i.IsOrder))
                    {
                        var order = (from i in entities.Invoice.OfType<CustomerInvoice>()
                                     where i.InvoiceId == invoiceTraceView.OrderId &&
                                     i.State == (int)SoeEntityState.Active &&
                                     i.PrintTimeReport == true &&
                                     i.Project != null &&
                                     i.Project.State == (int)SoeEntityState.Active
                                     select i).FirstOrDefault();

                        //Add Order id
                        if (order != null && order.State == (int)SoeEntityState.Active && !distinctIds.Any(x => x == order.InvoiceId))
                            distinctIds.Add(order.InvoiceId);
                    }

                    #endregion
                }
            }

            return distinctIds;
        }
        #endregion

        #endregion

        #region DeliveryCondition

        public List<DeliveryCondition> GetDeliveryConditions(int actorCompanyId, int? deliveryConditionId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryCondition.NoTracking();
            return GetDeliveryConditions(entities, actorCompanyId, deliveryConditionId);
        }

        public List<DeliveryCondition> GetDeliveryConditions(CompEntities entities, int actorCompanyId, int? deliveryConditionId = null)
        {
            IQueryable<DeliveryCondition> query = (from dc in entities.DeliveryCondition
                                                   where dc.Company.ActorCompanyId == actorCompanyId
                                                   orderby dc.Name
                                                   select dc);

            if (deliveryConditionId.HasValue)
                query = query.Where(dc => dc.DeliveryConditionId == deliveryConditionId);

            return query.ToList();
        }

        public Dictionary<int, string> GetDeliveryConditionsDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryCondition.NoTracking();
            return GetDeliveryConditionsDict(entities, actorCompanyId, addEmptyRow);
        }

        public Dictionary<int, string> GetDeliveryConditionsDict(CompEntities entities, int actorCompanyId, bool addEmptyRow)
        {
            var dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            var deliveryConditions = GetDeliveryConditions(entities, actorCompanyId);
            foreach (var dc in deliveryConditions)
            {
                dict.Add(dc.DeliveryConditionId, dc.Name);
            }

            return dict;
        }

        public DeliveryCondition GetDeliveryCondition(int conditionId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryCondition.NoTracking();
            return GetDeliveryCondition(entities, conditionId);
        }

        public DeliveryCondition GetDeliveryCondition(CompEntities entities, int conditionId)
        {
            return (from dc in entities.DeliveryCondition
                    where dc.DeliveryConditionId == conditionId
                    select dc).FirstOrDefault<DeliveryCondition>();
        }

        public DeliveryCondition GetDeliveryConditionByCode(string code, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryCondition.NoTracking();
            return GetDeliveryConditionByCode(entities, code, actorCompanyId);
        }

        public DeliveryCondition GetDeliveryConditionByCode(CompEntities entities, string code, int actorCompanyId)
        {
            return (from dc in entities.DeliveryCondition
                    .Include("Company")
                    where dc.Code == code &&
                    dc.Company.ActorCompanyId == actorCompanyId
                    select dc).FirstOrDefault<DeliveryCondition>();
        }

        public DeliveryCondition GetPrevNextDeliveryCondition(int deliveryConditionId, int actorCompanyId, SoeFormMode mode)
        {
            // Get all conditions
            List<DeliveryCondition> deliveryConditions = GetDeliveryConditions(actorCompanyId);

            // Get index of current condition
            int i = 0;
            foreach (DeliveryCondition deliveryCondition in deliveryConditions)
            {
                if (deliveryCondition.DeliveryConditionId == deliveryConditionId)
                    break;
                i++;
            }

            if (mode == SoeFormMode.Next && i < deliveryConditions.Count - 1)
                i++;
            else if (mode == SoeFormMode.Prev && i > 0)
                i--;

            return deliveryConditions.ElementAt(i);
        }

        public bool DeliveryConditionExists(string code, int actorCompanyId, int? deliveryConditionId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryCondition.NoTracking();
            var query = (from dc in entities.DeliveryCondition
                         where dc.Company.ActorCompanyId == actorCompanyId &&
                         dc.Code == code
                         select dc);

            if (deliveryConditionId.HasValue && deliveryConditionId.Value > 0)
                query = query.Where(d => d.DeliveryConditionId != deliveryConditionId);

            int counter = query.Count();

            if (counter > 0)
                return true;
            return false;
        }

        public ActionResult SaveDeliveryCondition(DeliveryConditionDTO conditionInput, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            if (conditionInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "DeliveryConditionDTO");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                // Get original condition
                DeliveryCondition deliveryCondition = GetDeliveryCondition(entities, conditionInput.DeliveryConditionId);

                if (deliveryCondition == null)
                {
                    deliveryCondition = new DeliveryCondition()
                    {
                        Company = company,
                    };

                    SetCreatedProperties(deliveryCondition);
                    entities.DeliveryCondition.AddObject(deliveryCondition);
                }
                else
                {
                    SetModifiedProperties(deliveryCondition);
                }

                if (DeliveryConditionExists(conditionInput.Code, actorCompanyId, deliveryCondition?.DeliveryConditionId ?? null))
                    return new ActionResult((int)ActionResultSave.EntityExists, GetText(92025, "Kod existerar redan"));

                // Modify it
                deliveryCondition.Code = conditionInput.Code;
                deliveryCondition.Name = conditionInput.Name;

                result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                result.IntegerValue = deliveryCondition.DeliveryConditionId;
            }

            return result;
        }

        public ActionResult AddDeliveryCondition(DeliveryCondition condition, int actorCompanyId)
        {
            if (condition == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "DeliveryCondition");

            using (CompEntities entities = new CompEntities())
            {
                // Get company
                condition.Company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (condition.Company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                return AddEntityItem(entities, condition, "DeliveryCondition");
            }
        }

        public ActionResult UpdateDeliveryCondition(DeliveryCondition condition)
        {
            if (condition == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "DeliveryCondition");

            using (CompEntities entities = new CompEntities())
            {
                // Get original condition
                DeliveryCondition originalCondition = GetDeliveryCondition(entities, condition.DeliveryConditionId);
                if (originalCondition == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "DeliveryCondition");

                // Modify it
                originalCondition.Code = condition.Code;
                originalCondition.Name = condition.Name;

                // Save it
                return SaveEntityItem(entities, originalCondition);
            }
        }

        public ActionResult DeleteDeliveryCondition(int deliveryConditionId)
        {
            using (CompEntities entities = new CompEntities())
            {
                DeliveryCondition orginalCondition = GetDeliveryCondition(entities, deliveryConditionId);
                if (orginalCondition == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "DeliveryCondition");

                return DeleteEntityItem(entities, orginalCondition);
            }
        }

        public ActionResult DeleteDeliveryCondition(DeliveryCondition condition)
        {
            if (condition == null)
                return new ActionResult((int)ActionResultDelete.EntityIsNull, "DeliveryCondition");

            using (CompEntities entities = new CompEntities())
            {
                DeliveryCondition orginalCondition = GetDeliveryCondition(entities, condition.DeliveryConditionId);
                if (orginalCondition == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "DeliveryCondition");

                return DeleteEntityItem(entities, orginalCondition);
            }
        }

        #endregion

        #region DeliveryType

        public List<DeliveryType> GetDeliveryTypes(int actorCompanyId, int? deliveryTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryType.NoTracking();
            return GetDeliveryTypes(entities, actorCompanyId, deliveryTypeId);
        }

        public List<DeliveryType> GetDeliveryTypes(CompEntities entities, int actorCompanyId, int? deliveryTypeId = null)
        {
            var list = (from dt in entities.DeliveryType
                        where dt.Company.ActorCompanyId == actorCompanyId
                        orderby dt.Name
                        select dt).AsQueryable();
            if (deliveryTypeId.HasValue)
            {
                list = list.Where(x => x.DeliveryTypeId == deliveryTypeId);
            }
            return list.ToList();
        }

        public Dictionary<int, string> GetDeliveryTypesDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryType.NoTracking();
            return GetDeliveryTypesDict(entities, actorCompanyId, addEmptyRow);
        }

        public Dictionary<int, string> GetDeliveryTypesDict(CompEntities entities, int actorCompanyId, bool addEmptyRow)
        {
            var dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            var deliveryTypes = GetDeliveryTypes(entities, actorCompanyId);
            foreach (DeliveryType dt in deliveryTypes.OrderBy(t => t.Name))
            {
                dict.Add(dt.DeliveryTypeId, dt.Name);
            }

            return dict;
        }

        public DeliveryType GetDeliveryType(int typeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryType.NoTracking();
            return GetDeliveryType(entities, typeId);
        }

        public DeliveryType GetDeliveryType(CompEntities entities, int typeId)
        {
            return (from dt in entities.DeliveryType
                    where dt.DeliveryTypeId == typeId
                    select dt).FirstOrDefault<DeliveryType>();
        }

        public DeliveryType GetDeliveryTypeByCode(string code, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryType.NoTracking();
            return GetDeliveryTypeByCode(entities, code, actorCompanyId);
        }

        public DeliveryType GetDeliveryTypeByCode(CompEntities entities, string code, int actorCompanyId)
        {
            return (from dt in entities.DeliveryType
                    .Include("Company")
                    where dt.Code == code &&
                    dt.Company.ActorCompanyId == actorCompanyId
                    select dt).FirstOrDefault<DeliveryType>();
        }

        public DeliveryType GetPrevNextDeliveryType(int typeId, int actorCompanyId, SoeFormMode mode)
        {
            // Get all types
            List<DeliveryType> deliveryTypes = GetDeliveryTypes(actorCompanyId);

            // Get index of current type
            int i = 0;
            foreach (DeliveryType deliveryType in deliveryTypes)
            {
                if (deliveryType.DeliveryTypeId == typeId)
                    break;
                i++;
            }

            if (mode == SoeFormMode.Next && i < deliveryTypes.Count - 1)
                i++;
            else if (mode == SoeFormMode.Prev && i > 0)
                i--;

            return deliveryTypes.ElementAt(i);
        }

        public bool DeliveryTypeExists(string code, int actorCompanyId, int? deliveryTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.DeliveryType.NoTracking();
            var query = (from dt in entities.DeliveryType
                         where dt.Company.ActorCompanyId == actorCompanyId &&
                         dt.Code == code
                         select dt);

            if (deliveryTypeId.HasValue)
                query = query.Where(dt => dt.DeliveryTypeId != deliveryTypeId.Value);

            return query.Any();
        }
        public ActionResult SaveDeliveryType(DeliveryTypeDTO typeInput, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            if (typeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "DeliveryTypeDTO");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                // Get original condition
                DeliveryType deliveryType = GetDeliveryType(entities, typeInput.DeliveryTypeId);

                if (DeliveryTypeExists(typeInput.Code, actorCompanyId, deliveryType?.DeliveryTypeId ?? null))
                    return new ActionResult(
                            string.Format(
                                GetText(92030, (int)TermGroup.General, "{0}: {1} finns redan."),
                                GetText(5075, (int)TermGroup.General, "Kod"),
                                typeInput.Code
                                )
                            );

                if (deliveryType == null)
                {
                    deliveryType = new DeliveryType()
                    {
                        Company = company,
                    };

                    SetCreatedProperties(deliveryType);
                    entities.DeliveryType.AddObject(deliveryType);
                }
                else
                {
                    SetModifiedProperties(deliveryType);
                }

                // Modify it
                deliveryType.Code = typeInput.Code;
                deliveryType.Name = typeInput.Name;

                result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                result.IntegerValue = deliveryType.DeliveryTypeId;
            }

            return result;
        }

        public ActionResult AddDeliveryType(DeliveryType type, int actorCompanyId)
        {
            if (type == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "DeliveryType");

            using (CompEntities entities = new CompEntities())
            {
                // Get company
                type.Company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (type.Company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                return AddEntityItem(entities, type, "DeliveryType");
            }
        }

        public ActionResult UpdateDeliveryType(DeliveryType type)
        {
            if (type == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "DeliveryType");

            using (CompEntities entities = new CompEntities())
            {
                // Get original type
                DeliveryType originalType = GetDeliveryType(entities, type.DeliveryTypeId);
                if (originalType == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "DeliveryType");

                // Modify it
                originalType.Code = type.Code;
                originalType.Name = type.Name;

                return SaveEntityItem(entities, originalType);
            }
        }

        public ActionResult DeleteDeliveryType(DeliveryType type)
        {
            if (type == null)
                return new ActionResult((int)ActionResultDelete.EntityIsNull, "DeliveryType");

            using (CompEntities entities = new CompEntities())
            {
                DeliveryType orginalType = GetDeliveryType(entities, type.DeliveryTypeId);
                if (orginalType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "DeliveryType");

                return DeleteEntityItem(entities, orginalType);
            }
        }
        public ActionResult DeleteDeliveryType(int deliveryTypeId)
        {
            using (CompEntities entities = new CompEntities())
            {
                DeliveryType orginalType = GetDeliveryType(entities, deliveryTypeId);
                if (orginalType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "DeliveryType");

                return DeleteEntityItem(entities, orginalType);
            }
        }

        #endregion

        #region MatchCode

        public IEnumerable<MatchCodeGridDTO> GetMatchCodesForGrid(int actorCompanyId, SoeInvoiceMatchingType? matchCodeType, int? matchCodeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.MatchCode.NoTracking();
            return GetMatchCodesForGrid(entities, actorCompanyId, matchCodeType, matchCodeId);
        }

        public IEnumerable<MatchCodeGridDTO> GetMatchCodesForGrid(CompEntities entities, int actorCompanyId, SoeInvoiceMatchingType? matchCodeType, int? matchCodeId = null)
        {
            List<GenericType> types = base.GetTermGroupContent(TermGroup.MatchCodeType);

            var query = (from mc in entities.MatchCode
                         where mc.ActorCompanyId == actorCompanyId &&
                         mc.State == (int)SoeEntityState.Active
                         select mc);

            if (matchCodeId.HasValue)
                query = query.Where(m => m.MatchCodeId == matchCodeId.Value);

            if (matchCodeType != null)
                query = query.Where(mc => mc.Type == (int)matchCodeType || mc.Type == (int)SoeInvoiceMatchingType.General);

            var matchCodes = query.OrderBy(mc => mc.Name).Select(EntityExtensions.GetMatchCodeGridDTO).ToList();

            matchCodes.ForEach(mc =>
            {
                mc.Type = types.Where(t => t.Id == mc.TypeId).Select(x => x.Name).FirstOrDefault() ?? string.Empty;
            });

            return matchCodes;
        }

        public IEnumerable<MatchCode> GetMatchCodes(int actorCompanyId, SoeInvoiceMatchingType? matchCodeType, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.MatchCode.NoTracking();
            return GetMatchCodes(entities, actorCompanyId, matchCodeType, addEmptyRow);
        }

        public IEnumerable<MatchCode> GetMatchCodes(CompEntities entities, int actorCompanyId, SoeInvoiceMatchingType? matchCodeType, bool addEmptyRow)
        {
            var query = (from mc in entities.MatchCode
                          .Include("Account")
                         where mc.ActorCompanyId == actorCompanyId &&
                         mc.State == (int)SoeEntityState.Active
                         select mc);

            if (matchCodeType != null)
                query = query.Where(mc => mc.Type == (int)matchCodeType || mc.Type == (int)SoeInvoiceMatchingType.General);

            var matchCodes = new List<MatchCode>();
            if (addEmptyRow)
            {
                matchCodes.Add(new MatchCode()
                {
                    Type = 0,
                    Description = " ",
                    Name = " ",
                    AccountId = 0,
                    AccountNr = "",
                });
            }

            foreach (MatchCode matchCode in query.OrderBy(mc => mc.Name).ToList())
            {
                matchCodes.Add(matchCode);
            }

            return matchCodes;
        }

        public Dictionary<int, string> GetMatchCodesDict(int actorCompanyId, SoeInvoiceMatchingType? matchCodeType, bool addEmptyRow)
        {
            var dict = new Dictionary<int, string>();

            var matchCodes = GetMatchCodes(actorCompanyId, matchCodeType, addEmptyRow);

            foreach (MatchCode mc in matchCodes)
            {
                dict.Add(mc.MatchCodeId, mc.Name);
            }

            return dict;
        }

        public MatchCodeDTO GetMatchCodeDto(int matchCodeId, bool includeType = false)
        {
            var matchCode = this.GetMatchCode(matchCodeId);
            if (!(matchCode is null))
            {
                MatchCodeDTO matchCodeDto = new MatchCodeDTO();
                matchCodeDto = matchCode.ToDTO();
                if (includeType)
                {
                    var type = base.GetTermGroupContent(TermGroup.MatchCodeType).FirstOrDefault(x => x.Id == matchCode.Type);
                    if (!(type is null))
                    {
                        matchCodeDto.TypeName = type.Name;
                    }
                }
                return matchCodeDto;
            }
            return null;
        }

        public MatchCode GetMatchCode(int matchCodeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.MatchCode.NoTracking();
            return GetMatchCode(entities, matchCodeId);
        }

        public MatchCode GetMatchCode(CompEntities entities, int matchCodeId)
        {
            return (from mc in entities.MatchCode
                    where mc.MatchCodeId == matchCodeId
                    select mc).FirstOrDefault<MatchCode>();
        }

        private bool MatchCodeExists(int actorCompanyId, string name, int? matchCodeId = null)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.MatchCode.NoTracking();
            var query = from mc in entitiesReadOnly.MatchCode
                        where mc.ActorCompanyId == actorCompanyId && mc.Name == name
                        select mc;

            if (matchCodeId.HasValue)
                query = query.Where(mc => mc.MatchCodeId != matchCodeId.Value);

            return query.Any();
        }

        public ActionResult SaveMatchCode(MatchCodeDTO matchCode)
        {
            var result = new ActionResult();

            if (matchCode == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "MatchCode");

            using (CompEntities entities = new CompEntities())
            {
                // Get original MatchCode
                MatchCode originalMatchCode = GetMatchCode(entities, matchCode.MatchCodeId);

                if (MatchCodeExists(base.ActorCompanyId, matchCode.Name, originalMatchCode?.MatchCodeId ?? null))
                    return new ActionResult((int)ActionResultSave.EntityExists, string.Format(
                                    GetText(92030, (int)TermGroup.General, "{0}: {1} finns redan."),
                                    GetText(9177, (int)TermGroup.General, "Namn"),
                                    matchCode.Name
                                    ));

                if (originalMatchCode == null)
                {
                    originalMatchCode = new MatchCode();

                    originalMatchCode.ActorCompanyId = base.ActorCompanyId;
                    originalMatchCode.AccountId = matchCode.AccountId;
                    originalMatchCode.AccountNr = matchCode.AccountNr;

                    //Vat account optional
                    if (matchCode.VatAccountId != null && matchCode.VatAccountId != 0)
                    {
                        originalMatchCode.VatAccountId = matchCode.VatAccountId;
                        originalMatchCode.VatAccountNr = matchCode.VatAccountNr;
                    }

                    originalMatchCode.Description = matchCode.Description;
                    originalMatchCode.Name = matchCode.Name;
                    originalMatchCode.Type = (int)matchCode.Type;

                    result = AddEntityItem(entities, originalMatchCode, "MatchCode");

                    if (result.Success)
                        result.IntegerValue = originalMatchCode.MatchCodeId;
                }
                else
                {
                    // Modify it
                    originalMatchCode.AccountId = matchCode.AccountId;
                    originalMatchCode.AccountNr = matchCode.AccountNr;

                    //Vat account optional
                    if (matchCode.VatAccountId != null && matchCode.VatAccountId != 0)
                    {
                        originalMatchCode.VatAccountId = matchCode.VatAccountId;
                        originalMatchCode.VatAccountNr = matchCode.VatAccountNr;
                    }

                    originalMatchCode.Description = matchCode.Description;
                    originalMatchCode.Name = matchCode.Name;
                    originalMatchCode.Type = (int)matchCode.Type;

                    result = SaveEntityItem(entities, originalMatchCode);
                    if (result.Success)
                        result.IntegerValue = originalMatchCode.MatchCodeId;
                }
            }

            return result;
        }

        public ActionResult AddMatchCode(MatchCode matchCode)
        {
            ActionResult result = null;

            if (matchCode == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "MatchCode");

            if (matchCode.State == 0)
                matchCode.State = (int)SoeEntityState.Active;

            using (CompEntities entities = new CompEntities())
            {
                result = AddEntityItem(entities, matchCode, "MatchCode");
            }

            return result;
        }

        public ActionResult UpdateMatchCode(MatchCode matchCode)
        {
            if (matchCode == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "MatchCode");

            using (CompEntities entities = new CompEntities())
            {
                // Get original MatchCode
                MatchCode originalMatchCode = GetMatchCode(entities, matchCode.MatchCodeId);
                if (originalMatchCode == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "MatchCode");

                // Modify it
                originalMatchCode.AccountId = matchCode.AccountId;
                originalMatchCode.AccountNr = matchCode.AccountNr;
                originalMatchCode.VatAccountId = matchCode.VatAccountId;
                originalMatchCode.VatAccountNr = matchCode.VatAccountNr;
                originalMatchCode.Description = matchCode.Description;
                originalMatchCode.Name = matchCode.Name;
                originalMatchCode.Type = matchCode.Type;

                return SaveEntityItem(entities, matchCode);
            }
        }

        public ActionResult DeleteMatchCode(int matchCodeId)
        {
            if (matchCodeId == 0)
                return new ActionResult((int)ActionResultDelete.EntityIsNull, "MatchCode");

            using (CompEntities entities = new CompEntities())
            {
                // Get original MatchCode
                MatchCode originalMatchCode = GetMatchCode(entities, matchCodeId);
                if (originalMatchCode == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "MatchCode");

                ChangeEntityState(originalMatchCode, SoeEntityState.Deleted);

                return SaveEntityItem(entities, originalMatchCode);
            }
        }

        public ActionResult DeleteMatchCode(MatchCode matchCode)
        {
            if (matchCode == null)
                return new ActionResult((int)ActionResultDelete.EntityIsNull, "MatchCode");

            using (CompEntities entities = new CompEntities())
            {
                // Get original MatchCode
                MatchCode originalMatchCode = GetMatchCode(entities, matchCode.MatchCodeId);
                if (originalMatchCode == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "MatchCode");

                ChangeEntityState(originalMatchCode, SoeEntityState.Deleted);

                return SaveEntityItem(entities, originalMatchCode);
            }
        }

        #endregion

        #region ProductGroup

        public List<ProductGroupDTO> GetProductGroups(int actorCompanyId, bool addEmptyRow, int? productGroupId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ProductGroup.NoTracking();
            return GetProductGroups(entities, actorCompanyId, addEmptyRow, productGroupId);
        }

        public List<ProductGroupDTO> GetProductGroups(CompEntities entities, int actorCompanyId, bool addEmptyRow, int? productGroupId = null)
        {
            var query = (from dc in entities.ProductGroup
                         where dc.Company.ActorCompanyId == actorCompanyId
                         select dc);

            if (productGroupId.HasValue)
                query = query.Where(x => x.ProductGroupId == productGroupId.Value);

            var productGroups = query.OrderBy(x => x.Name).Select(x => new ProductGroupDTO
            {
                Code = x.Code,
                Name = x.Name,
                ProductGroupId = x.ProductGroupId
            }).ToList();

            if (addEmptyRow && !productGroupId.HasValue)
                productGroups.Insert(0, new ProductGroupDTO() { ProductGroupId = 0, Code = " ", Name = " " });

            return productGroups;
        }

        public bool ProductGroupExists(string code, string name, int actorCompanyId, int? productGroupId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ProductGroup.NoTracking();
            var query = (from pg in entities.ProductGroup
                         where pg.Company.ActorCompanyId == actorCompanyId &&
                         (pg.Code == code || pg.Name == name)
                         select pg);

            if (productGroupId.HasValue && productGroupId.Value > 0)
                query = query.Where(pg => pg.ProductGroupId != productGroupId);

            int counter = query.Count();

            if (counter > 0)
                return true;
            return false;
        }

        public ProductGroup GetProductGroup(int productGroupId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ProductGroup.NoTracking();
            return GetProductGroup(entities, productGroupId);
        }

        public ProductGroup GetProductGroup(CompEntities entities, int productGroupId)
        {
            return (from pg in entities.ProductGroup
                    where pg.ProductGroupId == productGroupId
                    select pg).FirstOrDefault<ProductGroup>();
        }

        public ActionResult SaveProductGroup(ProductGroupDTO conditionInput, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            if (conditionInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ProductGroupDTO");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                // Get original condition
                ProductGroup productGroup = GetProductGroup(entities, conditionInput.ProductGroupId);

                if (ProductGroupExists(conditionInput.Code, conditionInput.Name, actorCompanyId, productGroup?.ProductGroupId ?? null))
                    return new ActionResult((int)ActionResultSave.EntityExists, GetText(7500, "En produktgrupp med samma kod och/eller samma namn existerar redan."));

                if (productGroup == null)
                {
                    productGroup = new ProductGroup()
                    {
                        Company = company,
                    };

                    SetCreatedProperties(productGroup);
                    entities.ProductGroup.AddObject(productGroup);
                }
                else
                {
                    SetModifiedProperties(productGroup);
                }

                // Modify it
                productGroup.Code = conditionInput.Code;
                productGroup.Name = conditionInput.Name;

                result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                result.IntegerValue = productGroup.ProductGroupId;
            }

            return result;
        }

        public ActionResult DeleteProductGroup(int productGroupId)
        {
            using (CompEntities entities = new CompEntities())
            {
                ProductGroup orginalProductGroup = GetProductGroup(entities, productGroupId);
                if (orginalProductGroup == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "ProductGroup");

                var result = DeleteEntityItem(entities, orginalProductGroup);

                if (result.ErrorNumber == (int)ActionResultDelete.EntityInUse)
                    result.ErrorMessage = this.GetText(14070, (int)TermGroup.AngularBilling, "Det gick inte att ta bort, Produktgrupp används");

                return result;
            }
        }

        #endregion

        #region PaymentService
        public IEnumerable<InvoiceExportIODTO> GetInvoicesForPaymentService(int actorCompanyId, int paymentService)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.NoTracking();
            entitiesReadOnly.Origin.NoTracking();
            entitiesReadOnly.Actor.NoTracking();
            entitiesReadOnly.Customer.NoTracking();
            entitiesReadOnly.Currency.NoTracking();

            IQueryable<CustomerInvoice> query = (from i in entitiesReadOnly.Invoice.Include("Origin").Include("Actor.Customer").Include("Currency")
                                                 where i.Origin.ActorCompanyId == actorCompanyId &&
                                                 i.State == (int)SoeEntityState.Active &&
                                                 i.Type == (int)SoeInvoiceType.CustomerInvoice &&
                                                 i.Origin.Status == (int)SoeOriginStatus.Voucher &&
                                                 i.ExportStatus == (int)SoeInvoiceExportStatusType.NotExported
                                                 select i).OfType<CustomerInvoice>();


            //PaymentService
            query = query.Where(i => i.InvoicePaymentService == paymentService);
            List<InvoiceExportIODTO> invoices = new List<InvoiceExportIODTO>();
            foreach (CustomerInvoice inv in query)
            {
                invoices.Add(new InvoiceExportIODTO()
                {
                    InvoiceExportId = -1,
                    PayerId = inv.Actor.Customer.OrgNr,
                    BankAccount = inv.Actor.Customer.BankAccountNr,
                    CustomerId = inv.Actor.Customer.ActorCustomerId,
                    CustomerName = inv.Actor.Customer.Name,
                    InvoiceDate = inv.InvoiceDate,
                    InvoiceId = inv.InvoiceId,
                    InvoiceNr = inv.InvoiceNr,
                    InvoiceSeqnr = inv.SeqNr.ToString(),
                    DueDate = inv.DueDate,
                    Currency = inv.Currency.Code,
                    InvoiceAmount = inv.TotalAmount,
                    InvoiceType = (TermGroup_BillingType)inv.BillingType
                });

            }

            return invoices;
        }
        public ActionResult SaveCustomerInvoicePaymentService(List<InvoiceExportIODTO> items, int actorCompanyId, int userId, int sysPaymentServiceId)
        {
            ActionResult result = new ActionResult(false);

            if (items.Count == 0)
                return new ActionResult((int)ActionResultSave.NoItemsToProcess, GetText(5726, "Inga rader"));

            result = ImportExportManager.CreateCustomerPaymentServiceExportFile(items, actorCompanyId, userId, sysPaymentServiceId);

            return result;
        }
        #endregion PaymentService

        #region Validation

        public bool ValidateCustomerInvoiceAccountingRowsDiff(CustomerInvoice invoice)
        {
            decimal totalDebitAmount = 0;
            decimal totalCreditAmount = 0;

            foreach (CustomerInvoiceRow invoiceRow in invoice.ActiveCustomerInvoiceRows)
            {
                foreach (CustomerInvoiceAccountRow invoiceAccountRow in invoiceRow.ActiveCustomerInvoiceAccountRows)
                {
                    if (invoiceAccountRow.DebitRow)
                        totalDebitAmount += invoiceAccountRow.AmountCurrency;
                    else
                        totalCreditAmount -= invoiceAccountRow.AmountCurrency;
                }
            }

            return (totalDebitAmount - totalCreditAmount != 0);
        }

        #endregion

        public ActionResult SaveInvoiceCompany(int invoiceId, int actorCompanyId, int supplierId, int voucherSeriesId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        var invoice = SupplierInvoiceManager.GetSupplierInvoice(entities, invoiceId, loadOrigin: true, loadInvoiceRow: true);
                        if (invoice.Origin.ActorCompanyId == actorCompanyId)
                            return new ActionResult(false, (int)ActionResultSave.NothingSaved, "Företagsid måste skilja sig från orginalet");
                        if (invoice.VoucherHeadId != null)
                            return new ActionResult(false, (int)ActionResultSave.VoucherExists, "Verifikat finns på fakturan");
                        if (!FeatureManager.HasRolePermission(Feature.Economy_Supplier_Invoice_Invoices_Edit, Permission.Modify, base.RoleId, actorCompanyId, entities: entities))
                            return new ActionResult(false, (int)ActionResultSave.Unknown, "Användaren har inte behörlighet att skapa levfakturor på det nya företaget");

                        invoice.Origin.ActorCompanyId = actorCompanyId;
                        invoice.Origin.VoucherSeriesId = voucherSeriesId;
                        invoice.ActorId = supplierId;

                        if (invoice.SupplierInvoiceRow != null)
                            invoice.SupplierInvoiceRow.Clear();

                        result = SaveChanges(entities);
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    LogError(ex, this.log);
                }
            }

            return result;
        }

        public IEnumerable<AccountingRowDTO> GenerateAccountingRowsForCustomerInvoice(CustomerLedgerSaveDTO invoice, int actorCompanyId, Dictionary<decimal, decimal> vatDict = null)
        {
            // This method is copied from CustomerInvoiceEdit.SetDefaultAccountingRows. Maybe it could be moved to Common project and reused both on SL and Business?

            List<AccountingRowDTO> accountingRows = new List<AccountingRowDTO>();

            var defaultCreditAccountId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountCustomerSalesVat, 0, actorCompanyId, 0);
            var defaultDebitAccountId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountCustomerClaim, 0, actorCompanyId, 0);
            var defaultVatAccountId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountCommonVatPayable1, 0, actorCompanyId, 0);

            // If no customer selected, or account not configured on customer, use default company setting
            int creditAccountId = defaultCreditAccountId;
            int debitAccountId = defaultDebitAccountId;
            int vatAccountId = defaultVatAccountId;
            if (invoice.VatType == TermGroup_InvoiceVatType.Contractor)
                creditAccountId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountCommonReverseVatSales, 0, actorCompanyId, 0);

            // Check if BillingType is Debit or Credit
            bool isCredit = invoice.BillingType == TermGroup_BillingType.Credit;

            int internalIdCounter = 0;

            // Debit row
            decimal debitAmount = invoice.TotalAmount;
            accountingRows.Add(CreateAccountingRow(debitAccountId, debitAmount, isCredit, true, false, false, false, actorCompanyId, ++internalIdCounter));

            // Check VAT type
            decimal vatAmount = invoice.VatAmountCurrency;
            var vatType = invoice.VatType;
            if (vatType == TermGroup_InvoiceVatType.Contractor)
            {
                // 'Contractor' invoices does not have any regular VAT
                vatAmount = 0;
            }
            else if (vatType == TermGroup_InvoiceVatType.NoVat)
            {
                // 'No VAT' invoices does not have any VAT at all
                vatAmount = 0;
            }
            else if (vatDict != null && vatDict.Count > 0)
            {
                // Special (different vat rates)
                bool accountAdded = false;
                foreach (var vat in vatDict)
                {
                    int vatRate = (int)vat.Key;
                    decimal vAmount = vat.Value;
                    var code = AccountManager.GetVatCodeByVateRate(actorCompanyId, vatRate);
                    if (code != null && code.AccountId > 0)
                    {
                        accountingRows.Add(CreateAccountingRow(code.AccountId, vat.Value, isCredit, false, true, false, false, actorCompanyId, ++internalIdCounter));
                        accountAdded = true;
                    }
                }

                if (!accountAdded)
                    accountingRows.Add(CreateAccountingRow(vatAccountId, vatAmount, isCredit, false, true, false, false, actorCompanyId, ++internalIdCounter));
            }
            else
            {
                // VAT row
                accountingRows.Add(CreateAccountingRow(vatAccountId, vatAmount, isCredit, false, true, false, false, actorCompanyId, ++internalIdCounter));
            }

            // Credit row
            decimal creditAmount = debitAmount - vatAmount;
            accountingRows.Add(CreateAccountingRow(creditAccountId, creditAmount, isCredit, false, false, false, false, actorCompanyId, ++internalIdCounter));

            // Contractor VAT rows
            if (vatType == TermGroup_InvoiceVatType.Contractor)
            {
                var contractorVatAccountCreditId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountCommonVatPayable1Reversed, 0, actorCompanyId, 0);
                var contractorVatAccountDebitId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.AccountCommonVatReceivableReversed, 0, actorCompanyId, 0);

                accountingRows.Add(CreateAccountingRow(contractorVatAccountCreditId, invoice.VatAmountCurrency, isCredit, false, false, true, false, actorCompanyId, ++internalIdCounter));
                accountingRows.Add(CreateAccountingRow(contractorVatAccountDebitId, invoice.VatAmountCurrency, isCredit, true, false, true, false, actorCompanyId, ++internalIdCounter));
            }

            return accountingRows;
        }

        private AccountingRowDTO CreateAccountingRow(int accountId, decimal amount, bool isCreditInvoice, bool isDebitRow, bool isVatRow, bool isContractorVatRow, bool isInterimRow, int actorCompanyId, int tempId)
        {
            // Get account
            var account = AccountManager.GetAccount(actorCompanyId, accountId, loadAccount: true, loadAccountDim: true).ToDTO(includeAccountDim: true, includeInternalAccounts: true);

            // Credit invoice, negate isDebitRow
            if (isCreditInvoice)
                isDebitRow = !isDebitRow;

            amount = Math.Abs(amount);

            var rowItem = new AccountingRowDTO
            {
                InvoiceAccountRowId = 0,
                TempRowId = tempId,
                RowNr = tempId,
                Quantity = null,
                Date = DateTime.Today,
                IsCreditRow = !isDebitRow,
                IsDebitRow = isDebitRow,
                IsVatRow = isVatRow,
                IsContractorVatRow = isContractorVatRow,
                IsInterimRow = isInterimRow,
                State = SoeEntityState.Active
            };

            rowItem.DebitAmount = isDebitRow ? amount : 0;
            rowItem.CreditAmount = isDebitRow ? 0 : amount;

            rowItem.Amount = rowItem.AmountCurrency = isDebitRow ? Math.Abs(amount) : -Math.Abs(amount);

            AccountUtility.SetRowItemAccounts(rowItem, account, true, true);

            return rowItem;
        }

        public ActionResult UpdateContractPrices(decimal percentage, decimal amount, decimal rounding, List<int> invoiceIds)
        {
            decimal percentagemultiply = 1;
            if (percentage != 0)
                percentagemultiply = (percentage / 100) + 1;

            using (var entities = new CompEntities())
            {
                foreach (int invoiceId in invoiceIds)
                {
                    CustomerInvoice invoice = GetCustomerInvoiceAndRows(entities, invoiceId, false, false);
                    if (invoice == null)
                        continue;

                    foreach (var invoiceRow in invoice.ActiveCustomerInvoiceRows.Where(r => r.Type == (int)SoeInvoiceRowType.ProductRow && r.State != (int)SoeEntityState.Deleted))
                    {
                        var maxNrOfDecimals = Math.Max((invoiceRow.Amount % 1).ToString().RemoveTralingZeros().Length - 2, 2);

                        invoiceRow.Amount = RoundingFunction(decimal.Multiply((invoiceRow.Amount + amount), percentagemultiply), rounding, maxNrOfDecimals);
                        invoiceRow.AmountCurrency = RoundingFunction(decimal.Multiply((invoiceRow.AmountCurrency + amount), percentagemultiply), rounding, maxNrOfDecimals);
                        invoiceRow.AmountEntCurrency = RoundingFunction(decimal.Multiply((invoiceRow.AmountEntCurrency + amount), percentagemultiply), rounding, maxNrOfDecimals);
                        invoiceRow.AmountLedgerCurrency = RoundingFunction(decimal.Multiply((invoiceRow.AmountLedgerCurrency + amount), percentagemultiply), rounding, maxNrOfDecimals);

                        CalculateRowSum(invoiceRow, invoice.CurrencyRate, 0);
                    }

                    RegenerateProductAccountRows(entities, invoice);

                    int rowNr = 1;
                    var accountRowNr = 2; // Claim row will get number 1
                    CalculateNextRowNbrs(invoice, ref rowNr, ref accountRowNr);

                    int sysCurrencyIdInvoice = CountryCurrencyManager.GetSysCurrencyId(entities, invoice.CurrencyId);
                    int sysCurrencyIdBase = CountryCurrencyManager.GetCompanyBaseSysCurrencyId(entities, base.ActorCompanyId);
                    UpdateInvoiceAfterRowModification(entities, invoice, accountRowNr, ActorCompanyId, false, sysCurrencyIdInvoice != sysCurrencyIdBase);
                }

                return SaveChanges(entities);
            }
        }

        private decimal RoundingFunction(decimal amount, decimal rounding, int maxDecimals)
        {
            if (rounding > 0)
            {
                return Math.Round(amount / rounding, 0, MidpointRounding.AwayFromZero) * rounding;
            }
            else
            {
                return Math.Round(amount, maxDecimals);
            }

        }

        private static int GetStatusIcon(int currentStatusIcon, bool hasFiles, SoeStatusIcon icon)
        {
            if (hasFiles)
                currentStatusIcon |= (int)icon;
            else
                currentStatusIcon &= ~(int)icon;
            return currentStatusIcon;
        }

        private static int GetStatusIcon(int currentStatusIcon, IEnumerable<FileUploadDTO> files, SoeStatusIcon icon)
        {
            if (files.Any(i => !i.IsDeleted && !i.IsSupplierInvoice))
                currentStatusIcon |= (int)icon;
            else
                currentStatusIcon &= ~(int)icon;
            return currentStatusIcon;
        }

        private Tuple<decimal, decimal, bool, int, int, int> CreateInvoiceRowStockInfo(CustomerInvoiceRow row)
        {
            return new Tuple<decimal, decimal, bool, int, int, int>(
                row.Quantity != null ? row.Quantity.Value : decimal.Zero,
                row.InvoiceQuantity != null ? row.InvoiceQuantity.Value : decimal.Zero,
                row.IsStockRow != null ? row.IsStockRow.Value : false,
                row.StockId != null ? row.StockId.Value : 0,
                row.ProductId != null ? row.ProductId.Value : 0,
                row.AttestStateId != null ? row.AttestStateId.Value : 0);
        }

        private void HandleStockOnInvoiceRowDelete(CompEntities entities, TransactionScope transaction, CustomerInvoice invoice, CustomerInvoiceRow invoiceRow, bool usePartialInvoicingOnOrderRow)
        {
            if (invoiceRow.StockId > 0)
            {

                if (invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice)
                {
                    CreateStockTransaction(entities, transaction, base.ActorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                                         (int)invoiceRow.ProductId, (int)invoiceRow.StockId, 0, -Convert.ToDecimal(GetQuantity(invoice.BillingType, invoiceRow.Quantity)), invoiceRow.PurchasePrice, invoiceRow.CustomerInvoiceRowId);
                }
                else if (invoice.Origin.Type == (int)SoeOriginType.Order && !InvoiceAttestStatesIds.OrderLockedIds.Contains(invoiceRow.AttestStateId.GetValueOrDefault()))
                {
                    CreateStockTransaction(entities, transaction, base.ActorCompanyId, TermGroup_StockTransactionType.Reserve, invoice, invoiceRow, usePartialInvoicingOnOrderRow);

                    //CreateStockTransaction(entities, transaction, base.ActorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                    //(int)invoiceRow.ProductId, (int)invoiceRow.StockId, -Convert.ToDecimal(GetQuantity(invoice.BillingType, invoiceRow.Quantity)), -Convert.ToDecimal(GetQuantity(invoice.BillingType, invoiceRow.InvoiceQuantity)), invoiceRow.PurchasePrice, invoiceRow.CustomerInvoiceRowId);
                }
            }
        }

        public void HandleStockOnInvoice(CustomerInvoice invoice, CompEntities entities, TransactionScope transaction, int actorCompanyId, Dictionary<int, Tuple<Decimal, Decimal, bool, int, int, int>> stockDict, bool usePartialInvoicingOnOrderRow, bool draftToOrigin, bool isNew = false)
        {
            var stockTransactionsToVoucher = new List<StockTransaction>();

            if (invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice &&
                    (
                        draftToOrigin ||
                        (isNew &&
                            (
                                invoice.Origin.Status == (int)SoeOriginStatus.Voucher || invoice.Origin.Status == (int)SoeOriginStatus.Origin
                            )
                        )
                    )
               )
            {
                foreach (var row in invoice.ActiveCustomerInvoiceRows)
                {
                    if (row.StockId > 0)
                    {
                        var quantity = Convert.ToDecimal(GetQuantity(invoice.BillingType, row.Quantity));
                        var stockProduct = StockManager.GetStockProductFromInvoiceProduct(entities, (int)row.ProductId, (int)row.StockId);
                        if (stockProduct != null)
                        {
                            var result = CreateStockTransaction(entities, transaction, actorCompanyId, false, quantity > 0 ? TermGroup_StockTransactionType.Take : TermGroup_StockTransactionType.Add, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                (int)row.ProductId, (int)row.StockId, Math.Abs(quantity), Math.Abs(quantity), row.PurchasePrice, row.CustomerInvoiceRowId, true, false, transactionDate: invoice.InvoiceDate, stockProduct: stockProduct);

                            if (result.Success)
                            {
                                stockTransactionsToVoucher.Add((StockTransaction)result.Value);
                            }

                            if (!isNew)
                                CreateStockTransaction(entities, transaction, actorCompanyId, false, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                    (int)row.ProductId, (int)row.StockId, 0, -GetQuantity(invoice.BillingType, row.Quantity), row.PurchasePrice, row.CustomerInvoiceRowId, stockProduct: stockProduct);
                        }
                    }
                }
            }
            else if (invoice.Origin.Type == (int)SoeOriginType.Order || (invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice && IsFirstDraft(invoice)))
            {
                foreach (var row in invoice.ActiveCustomerInvoiceRows)
                {
                    if (invoice.Origin.Type == (int)SoeOriginType.Order && row.AttestStateId == InvoiceAttestStatesIds.TransferredOrderToInvoiceId)
                    {
                        continue;
                    }

                    bool isStockRow = row.IsStockRow != null ? row.IsStockRow.Value : false;
                    Tuple<decimal, decimal, bool, int, int, int> dictValue = null;

                    if (stockDict != null && stockDict.TryGetValue(row.CustomerInvoiceRowId, out dictValue))
                    {
                        if (isStockRow && (!dictValue.Item3 || dictValue.Item4 == 0) && row.StockId != null && row.StockId.Value > 0) // Not stock before - stock now
                        {
                            CreateStockTransaction(entities, transaction, actorCompanyId, TermGroup_StockTransactionType.Reserve, invoice, row, usePartialInvoicingOnOrderRow);
                        }
                        else if (isStockRow && dictValue.Item3 && row.StockId != null && row.StockId.Value > 0) // Stock before - stock now
                        {
                            decimal rowQuantity = row.Quantity != null ? row.Quantity.Value : decimal.Zero;
                            decimal rowInvoiceQuantity = row.InvoiceQuantity != null ? row.InvoiceQuantity.Value : decimal.Zero;
                            int rowStockId = row.StockId != null ? row.StockId.Value : 0;
                            int rowAttestStateId = row.AttestStateId != null ? row.AttestStateId.Value : 0;

                            //changed stock place
                            if (rowStockId != dictValue.Item4)
                            {
                                // credit old stocktransaction
                                if (invoice.Origin.Type == (int)SoeOriginType.CustomerInvoice)
                                {
                                    CreateStockTransaction(entities, transaction, actorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                             dictValue.Item5, dictValue.Item4, 0, -GetQuantity(invoice.BillingType, dictValue.Item1), row.PurchasePrice, row.CustomerInvoiceRowId);
                                }
                                else
                                {
                                    CreateStockTransaction(entities, transaction, actorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                      dictValue.Item5, dictValue.Item4, -GetQuantity(invoice.BillingType, dictValue.Item1), -GetQuantity(invoice.BillingType, dictValue.Item2), row.PurchasePrice, row.CustomerInvoiceRowId, orderRowIsReserved: InvoiceAttestStatesIds.OrderLockedIds.Contains(rowAttestStateId));
                                }

                                // new stocktransaction
                                CreateStockTransaction(entities, transaction, actorCompanyId, TermGroup_StockTransactionType.Reserve, invoice, row, usePartialInvoicingOnOrderRow);
                            }
                            else if ((rowQuantity != dictValue.Item1 || rowInvoiceQuantity != dictValue.Item2))
                            {
                                CreateStockTransaction(entities, transaction, actorCompanyId, TermGroup_StockTransactionType.Reserve, invoice, row, usePartialInvoicingOnOrderRow, dictValue.Item1, dictValue.Item2);
                            }

                            //changed row state
                            if (rowAttestStateId != dictValue.Item6)
                            {
                                //deliver row without creating a invoice
                                if (row.AttestStateId == InvoiceAttestStatesIds.DeliverOrderToStockId)
                                {
                                    CreateDeliveryTransaction(row, true);
                                }
                                //reg >> stängd
                                else if (InvoiceAttestStatesIds.OrderClosedIds.Contains(rowAttestStateId) && !InvoiceAttestStatesIds.OrderClosedIds.Contains(dictValue.Item6))
                                {
                                    var reservedQuantity = usePartialInvoicingOnOrderRow ? dictValue.Item2 : 0;
                                    CreateStockTransaction(entities, transaction, actorCompanyId, true, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                        dictValue.Item5, dictValue.Item4, -GetQuantity(invoice.BillingType, dictValue.Item1), -GetQuantity(invoice.BillingType, reservedQuantity), row.PurchasePrice, row.CustomerInvoiceRowId);
                                }

                                //reg >> klar
                                else if (InvoiceAttestStatesIds.OrderLockedIds.Contains(rowAttestStateId) && !InvoiceAttestStatesIds.OrderLockedIds.Contains(dictValue.Item6) && !InvoiceAttestStatesIds.OrderClosedIds.Contains(dictValue.Item6))
                                {
                                    //minus from order and plus on reserved...
                                    var quantityToReserve = usePartialInvoicingOnOrderRow ? 0 : row.Quantity;
                                    CreateStockTransaction(entities, transaction, actorCompanyId, true, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                        (int)row.ProductId, (int)row.StockId, -(decimal)row.Quantity, quantityToReserve, row.PurchasePrice, row.CustomerInvoiceRowId);
                                }
                                //klar >> reg
                                else if (InvoiceAttestStatesIds.OrderLockedIds.Contains(dictValue.Item6) && !InvoiceAttestStatesIds.OrderLockedIds.Contains(rowAttestStateId) && !InvoiceAttestStatesIds.OrderClosedIds.Contains(rowAttestStateId))
                                {
                                    //plus on order and minus on reserved...
                                    var quantityToReserve = usePartialInvoicingOnOrderRow ? 0 : -row.Quantity;
                                    CreateStockTransaction(entities, transaction, actorCompanyId, true, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                        (int)row.ProductId, (int)row.StockId, (decimal)row.Quantity, quantityToReserve, row.PurchasePrice, row.CustomerInvoiceRowId);
                                }
                            }
                        }
                        else if (!isStockRow && dictValue.Item3 && row.StockId > 0) // Stock before - not stock now
                        {
                            CreateStockTransaction(entities, transaction, actorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                                    (int)row.ProductId, (int)row.StockId, -GetQuantity(invoice.BillingType, dictValue.Item1), -GetQuantity(invoice.BillingType, dictValue.Item2), row.PurchasePrice, row.CustomerInvoiceRowId);
                        }
                    }
                    else if (dictValue == null && isStockRow && row.StockId > 0)
                    {
                        //deliver row without creating a invoice
                        if (row.AttestStateId == InvoiceAttestStatesIds.DeliverOrderToStockId)
                        {
                            CreateDeliveryTransaction(row, false);
                        }
                        else
                        {
                            CreateStockTransaction(entities, transaction, actorCompanyId, TermGroup_StockTransactionType.Reserve, invoice, row, usePartialInvoicingOnOrderRow);
                        }
                    }
                }
            }

            if (stockTransactionsToVoucher.Any())
            {
                // Voucher setting
                var createVoucherSetting = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.AccountingCreateVouchersForStockTransactions, 0, base.ActorCompanyId, 0, true);

                if (createVoucherSetting)
                {
                    var voucherText = invoice.Origin.Type == (int)SoeOriginType.Order ? GetText(8013, "Ordernr").ToLower() : GetText(7133, "Fakturanr").ToLower();
                    StockManager.CreateVoucherFromTransactions(entities, transaction, stockTransactionsToVoucher, base.UserId, actorCompanyId, TermGroup_StockTransactionType.Take, invoice.VoucherDate ?? DateTime.Now, voucherText + ": " + invoice.InvoiceNr);
                }
            }

            void CreateDeliveryTransaction(CustomerInvoiceRow rowToDeliver, bool wasReserved)
            {
                if (!usePartialInvoicingOnOrderRow || rowToDeliver.InvoiceQuantity > 0)
                {
                    var result = CreateStockTransaction(entities, transaction, actorCompanyId, usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType.Take, invoice.Origin.Type, invoice.SeqNr.ToString(),
                    (int)rowToDeliver.ProductId, (int)rowToDeliver.StockId, (usePartialInvoicingOnOrderRow ? Convert.ToDecimal(GetQuantity(invoice.BillingType, rowToDeliver.InvoiceQuantity)) : Convert.ToDecimal(GetQuantity(invoice.BillingType, rowToDeliver.Quantity))), 0, rowToDeliver.PurchasePrice, rowToDeliver.CustomerInvoiceRowId, true, false);

                    if (result.Success)
                    {
                        stockTransactionsToVoucher.Add((StockTransaction)result.Value);
                    }
                }
                if (wasReserved)
                {
                    var quantityToDeliver = (rowToDeliver.InvoiceQuantity.HasValue && rowToDeliver.InvoiceQuantity > 0) ? rowToDeliver.InvoiceQuantity : rowToDeliver.Quantity;
                    CreateStockTransaction(entities, transaction, actorCompanyId, true, TermGroup_StockTransactionType.Reserve, invoice.Origin.Type, invoice.SeqNr.ToString(),
                        (int)rowToDeliver.ProductId, (int)rowToDeliver.StockId, -Convert.ToDecimal(GetQuantity(invoice.BillingType, quantityToDeliver)), 0, rowToDeliver.PurchasePrice, rowToDeliver.CustomerInvoiceRowId);
                }
            }
        }

        private ActionResult CreateStockTransaction(CompEntities entities, TransactionScope transaction, int actorCompanyId, TermGroup_StockTransactionType actionType, CustomerInvoice invoice, CustomerInvoiceRow row, bool usePartialInvoicingOnOrderRow, decimal prevQuantity = 0, decimal prevReservedQuantity = 0)
        {
            StockProduct stPr = StockManager.GetStockProductFromInvoiceProduct(entities, (int)row.ProductId, (int)row.StockId);
            if (stPr == null)
            {
                return new ActionResult(7533, GetText(7533, "Lagerartikel saknas"));
            }
            var originType = invoice.Origin.Type;
            decimal reservedQuantity = decimal.Zero;
            decimal quantity = GetQuantity(invoice.BillingType, row.Quantity) - prevQuantity;

            if (usePartialInvoicingOnOrderRow && originType == (int)SoeOriginType.Order && row.InvoiceQuantity.HasValue)
            {
                reservedQuantity = GetQuantity(invoice.BillingType, row.InvoiceQuantity) - prevReservedQuantity;
            }
            else if (originType == (int)SoeOriginType.CustomerInvoice && row.Quantity.HasValue)
            {
                reservedQuantity = GetQuantity(invoice.BillingType, row.Quantity) - prevQuantity;
                quantity = 0;
            }

            if ((row.State == (int)SoeEntityState.Deleted) || (invoice.Origin.Status == (int)SoeOriginStatus.Cancel))
            {
                quantity = decimal.Negate(quantity);
                reservedQuantity = decimal.Negate(reservedQuantity);
            }

            var stockTransactionDTO = new StockTransactionDTO
            {
                StockTransactionId = 0, //allways new
                StockProductId = stPr.StockProductId,
                Quantity = quantity,
                Price = row.PurchasePrice,
                ActionType = actionType,
                InvoiceRowId = row.CustomerInvoiceRowId,
                ReservedQuantity = reservedQuantity,
            };
            //Create transactions
            return StockManager.SaveStockTransaction(entities, transaction, stockTransactionDTO, actorCompanyId, true, true);
        }

        private ActionResult CreateStockTransaction(CompEntities entities, TransactionScope transaction, int actorCompanyId, bool usePartialInvoicingOnOrderRow, TermGroup_StockTransactionType actionType, int originType, string seqNr, int productId, int stockId, decimal quantity, decimal? invoiceQuantity, decimal price, int invoiceRowId, bool saveChanges = true, bool createVoucher = true, bool orderRowIsReserved = true, DateTime? transactionDate = null, StockProduct stockProduct = null)
        {
            StockProduct stPr = stockProduct != null ? stockProduct : StockManager.GetStockProductFromInvoiceProduct(entities, productId, stockId);
            if (stPr == null)
            {
                return new ActionResult(7533, GetText(7533, "Lagerartikel saknas"));
            }

            decimal? reservedQuantity = decimal.Zero;

            if (originType == (int)SoeOriginType.Order && orderRowIsReserved)
            {
                reservedQuantity = usePartialInvoicingOnOrderRow ? invoiceQuantity : quantity;
            }
            else if (originType == (int)SoeOriginType.CustomerInvoice)
            {
                reservedQuantity = invoiceQuantity;
            }

            var stockTransactionDTO = new StockTransactionDTO
            {
                StockTransactionId = 0, //allways new
                StockProductId = stPr.StockProductId,
                Quantity = quantity,
                Price = price,
                ActionType = actionType,
                InvoiceRowId = invoiceRowId,
                TransactionDate = transactionDate,
                ReservedQuantity = reservedQuantity.HasValue ? reservedQuantity.Value : 0
            };
            //Create transactions
            return StockManager.SaveStockTransaction(entities, transaction, stockTransactionDTO, actorCompanyId, saveChanges, createVoucher);
        }

        public void SetExportStatus(CompEntities entities, int actorCompanyId, int invoiceId, SoeInvoiceExportStatusType status, bool changeOriginStatus = true)
        {
            var invoice = entities.Invoice.FirstOrDefault(i => i.InvoiceId == invoiceId && i.Origin.ActorCompanyId == actorCompanyId);
            if (invoice != null)
            {
                invoice.ExportStatus = (int)status;

                if (changeOriginStatus)
                {
                    invoice.OriginReference.Load();
                    if (invoice.Origin != null)
                    {
                        invoice.Origin.Status = (int)SoeOriginStatus.Export;
                    }
                }
            }
        }

        public void SetExternalId(CompEntities entities, int actorCompanyID, int invoiceId, string externalId)
        {
            var invoice = entities.Invoice.FirstOrDefault(i => i.InvoiceId == invoiceId && i.Origin.ActorCompanyId == actorCompanyID);
            if (invoice != null)
            {
                invoice.ExternalId = externalId;
            }
        }

        private decimal GetQuantity(int billingType, decimal? quantity)
        {
            if (!quantity.HasValue)
                return 0;

            return billingType == (int)TermGroup_BillingType.Debit ? quantity.Value : decimal.Negate(quantity.Value);
        }

        public string GetErrorMessage(int errorNumber, string stringValue)
        {
            string message = String.Empty;

            switch (errorNumber)
            {
                #region General

                case (int)ActionResultSave.InvalidStateTransition:
                    message += GetText(93, (int)TermGroup.ChangeStatusGrid, "Felaktig statusförändring");
                    break;
                case (int)ActionResultSave.AccountYearNotOpen:
                    message += GetText(110, (int)TermGroup.ChangeStatusGrid, "Redovisningsåret är inte öppet") + ". " + stringValue;
                    break;
                case (int)ActionResultSave.AccountPeriodNotOpen:
                    message += GetText(111, (int)TermGroup.ChangeStatusGrid, "Perioden är inte öppen") + ". " + stringValue;
                    break;
                case (int)ActionResultSave.AccountYearVoucherDateDoNotMatch:
                    message += GetText(444, (int)TermGroup.ChangeStatusGrid, "Bokf.datum stämmer inte med aktuellt år") + ". " + stringValue;
                    break;
                case (int)ActionResultSave.AccountYearNotFound:
                    message += GetText(458, (int)TermGroup.ChangeStatusGrid, "Redovisningsåret finns inte upplagt") + ". " + stringValue;
                    break;
                case (int)ActionResultSave.AccountPeriodNotFound:
                    message += GetText(498, (int)TermGroup.ChangeStatusGrid, "Redovisningsperioden finns inte upplagt") + ". " + stringValue;
                    break;
                case (int)ActionResultSave.CustomerIsBlocked:
                    message += GetText(506, (int)TermGroup.ChangeStatusGrid, "En eller flera kunder är spärrade") + ".";
                    break;

                #endregion
            }

            return message;
        }

        private int? GetMaxNumber(string numbers)
        {
            if (string.IsNullOrWhiteSpace(numbers))
            {
                return null;
            }

            string[] numsstr = numbers.Split(',');

            if (!numsstr.Any())
            {
                return null;
            }

            int? number = null;

            foreach (string numstr in numsstr)
            {
                bool isNum = int.TryParse(numstr, out int num);

                if (isNum && (!number.HasValue || number < num))
                {
                    number = num;
                }
            }

            return number;
        }
    }
}