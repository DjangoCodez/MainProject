using SoftOne.Soe.Business.DataCache;
using SoftOne.Soe.Business.DTO;
using SoftOne.Soe.Common.DTO;
using SoftOne.Soe.Common.Util;
using SoftOne.Soe.Data;
using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Xml.Linq;
using SoftOne.Soe.Business.Core.Reporting.Models.Economy.Models;
using SoftOne.Soe.Business.Core.Reporting.Billing;
using SoftOne.Soe.Business.Core.ManagerWrappers;

namespace SoftOne.Soe.Business.Core.Reporting
{
    public class EconomyReportDataManager : BaseReportDataManager
    {
        #region Ctor

        public EconomyReportDataManager(ParameterObject parameterObject) : base(parameterObject) { }

        #endregion

        #region Data

        public XDocument CreateResultReportDataV2(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            this.Company = CompanyManager.GetCompany(es.ActorCompanyId);
            if (this.Company == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ResultReportV2");

            //ResultReport
            XElement resultReportElement = new XElement("ResultReportV2");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonDataV2(es, resultReportElement).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(resultReportElement);
            document.Add(rootElement);

            return this.GetValidatedDocument(document, SoeReportTemplateType.ResultReportV2);

            #endregion
        }


        public XDocument CreateResultReportDataV2(CreateReportResult reportResult)
        {
            #region Prereq

            if (reportResult == null)
                return null;

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            if (this.Company == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ResultReportV2");

            //ResultReport
            XElement resultReportElement = new XElement("ResultReportV2");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonDataV2(reportResult, resultReportElement).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(resultReportElement);
            document.Add(rootElement);

            return this.GetValidatedDocument(document, SoeReportTemplateType.ResultReportV2);

            #endregion
        }


        #endregion

        #region Help-methods
        public XDocument CreateVoucherListData(CreateReportResult reportResult)
        {
            #region Prereq

            //Get AccountDims
            AccountDimDTO accountDimStdDTO = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId).ToDTO();
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId).ToDTOs();
            List<AccountInternalDTO> accountInternalInIntervalDTOs = new List<AccountInternalDTO>();
            List<AccountPeriod> accountPeriods = AccountManager.GetAccountPeriods(reportResult.ActorCompanyId);
            List<AccountPeriodDTO> accountPeriodDTOs = new List<AccountPeriodDTO>();
            List<AccountYearDTO> accountYearsDTOs = AccountManager.GetAccountYears(reportResult.ActorCompanyId, false, false).ToDTOs().ToList();

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            string companyName_shortName = CompanyManager.GetCompanyName(reportResult.ActorCompanyId, true, false);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            foreach (var period in accountPeriods)
            {
                accountPeriodDTOs.Add(period.ToDTO());
            }

            //Get sysVatAccounts
            List<SysVatAccount> sysVatAccounts = AccountManager.GetSysVatAccounts(true);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "VoucherList");

            //VoucherList
            XElement voucherListElement = new XElement("VoucherList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateLatestVoucherLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherSerieIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            CreateAccountingOrderReportHeaderLabelsElement(reportHeaderLabelsElement);
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            voucherListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(CreateLatestVoucherElement(reportParams));
            reportHeaderElement.Add(CreateAccountIntervalElement(am, reportResult, reportParams.SA_AccountIntervals, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateVoucherIntervalElement(reportParams));
            reportHeaderElement.Add(CreateVoucherSerieIntervalElement(reportParams));
            reportHeaderElement.Add(CreateDateIntervalElement(reportParams));
            reportHeaderElement.Add(new XElement("CompanyShortname", companyName_shortName));
            reportHeaderElement.Add(new XElement("ExportType", reportResult.ExportType));
            voucherListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStdDTO, accountDimInternalsDTOs);
            CreateVoucherListPageHeaderLabelsElement(pageHeaderLabelsElement);
            voucherListElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                bool addYear = false;
                bool addPeriod = false;
                AccountYearDTO accountYearDTO = null;
                DateTime? from = null;
                DateTime? to = null;
                int voucherHeadXmlId = 1;

                List<VoucherHeadDTO> voucherHeads = VoucherManager.GetVoucherHeadDTOsFromSelection(reportResult, reportParams, accountDimStdDTO, orderByVoucherNr: false);
                List<AccountStd> accounts = AccountManager.GetAccountStdsByCompany(reportResult.ActorCompanyId, null, false, false);

                List<AccountStd> accountStdsInInterval = new List<AccountStd>();
                List<AccountInternal> accountInternalsInInterval = new List<AccountInternal>();
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
                bool validSelection = AccountManager.GetAccountsInInterval(entities, reportResult, reportParams, accountDimStd, false, ref accountStdsInInterval, ref accountInternalsInInterval);
                if (validSelection && accountInternalsInInterval.Any())
                    accountInternalInIntervalDTOs = accountInternalsInInterval.ToDTOs();

                foreach (VoucherHeadDTO voucherHead in voucherHeads)
                {
                    if (voucherHead.Template)
                        continue;

                    #region Content

                    XElement apEl = reportHeaderElement.Elements("AccountPeriod").FirstOrDefault();
                    if (apEl.Value == String.Empty)
                    {
                        addPeriod = true;

                        if (accountPeriodDTOs.Any(p => p.AccountPeriodId == voucherHead.AccountPeriodId))
                        {
                            var accountPeriod = accountPeriodDTOs.FirstOrDefault(p => p.AccountPeriodId == voucherHead.AccountPeriodId);
                            if (from == null || accountPeriod.From <= from)
                                from = accountPeriod.From;
                            if (to == null || accountPeriod.To <= to)
                                to = accountPeriod.To;
                        }
                    }

                    XElement ayEl = reportHeaderElement.Elements("AccountYear").FirstOrDefault();
                    if (ayEl.Value == String.Empty && accountYearDTO == null && accountYearsDTOs.Any(y => y.AccountYearId == voucherHead.AccountYearId))
                    {
                        addYear = true;
                        accountYearDTO = accountYearsDTOs.FirstOrDefault(y => y.AccountYearId == voucherHead.AccountYearId);
                    }

                    //VoucherHead
                    XElement voucherHeadElement = new XElement("VoucherHead",
                        new XAttribute("id", voucherHeadXmlId),
                        new XElement("VoucherNr", voucherHead.VoucherNr),
                        new XElement("VoucherSerieNr", voucherHead.VoucherSeriesTypeNr),
                        new XElement("VoucherSerieName", voucherHead.VoucherSeriesTypeName),
                        new XElement("VoucherDate", voucherHead.Date),
                        new XElement("VoucherText", voucherHead.Text),
                        new XElement("IsVatVoucher", voucherHead.VatVoucher.ToInt()),
                        new XElement("IsAccountingOrder", reportParams.SV_IsAccountingOrder.ToInt()));

                    //VoucherRows
                    int voucherRowXmlId = 1;
                    foreach (VoucherRowDTO voucherRowDTO in voucherHead.Rows.OrderBy(r => r.VoucherRowId))
                    {
                        //Skip inactive or deleted rows
                        if (voucherRowDTO.State != (int)SoeEntityState.Active)
                            continue;
                        if (!VoucherManager.VoucherRowDTOContainsAccountInternals(voucherRowDTO, accountInternalInIntervalDTOs))
                            continue;

                        //Debet and credit
                        decimal debet;
                        decimal credit;
                        this.GetDebetCredit(voucherRowDTO.Amount, out debet, out credit);

                        //Date
                        DateTime voucherRowDate = voucherHead.Date;
                        if (voucherRowDTO.Date != null)
                            voucherRowDate = Convert.ToDateTime(voucherRowDTO.Date);

                        //VatAccount
                        string vatAccountName = string.Empty;
                        int vatAccountVatNr1 = 0;
                        int vatAccountVatNr2 = 0;
                        decimal vatAccountPercent = 0;

                        if (sysVatAccounts.Any() && accounts.Any(a => a.AccountId == voucherRowDTO.Dim1Id && a.SysVatAccountId.HasValue))
                        {
                            int? sysVatAccountId = accounts.FirstOrDefault(a => a.AccountId == voucherRowDTO.Dim1Id)?.SysVatAccountId;

                            if (sysVatAccountId.HasValue && sysVatAccountId != 0 && sysVatAccounts.Any(v => v.SysVatAccountId == (int)sysVatAccountId))
                            {
                                SysVatAccount sysVatAccount = sysVatAccounts.FirstOrDefault(v => v.SysVatAccountId == (int)sysVatAccountId);
                                if (sysVatAccount != null)
                                {
                                    vatAccountName = sysVatAccount.Name;
                                    vatAccountVatNr1 = sysVatAccount.VatNr1.HasValue ? (int)sysVatAccount.VatNr1 : 0;
                                    vatAccountVatNr2 = sysVatAccount.VatNr2.HasValue ? (int)sysVatAccount.VatNr2 : 0;
                                    vatAccountPercent = sysVatAccount.SysVatRate != null ? sysVatAccount.SysVatRate.VatRate : 0;
                                }
                            }
                        }


                        //VoucherRow
                        XElement voucherRowElement = new XElement("VoucherRow",
                            new XAttribute("id", voucherRowXmlId),
                            new XElement("VoucherRowDate", voucherRowDate),
                            new XElement("VoucherRowText", voucherRowDTO.Text),
                            new XElement("AccountNr", voucherRowDTO.Dim1Nr),
                            new XElement("AccountName", voucherRowDTO.Dim1Name),
                            new XElement("VatAccountName", vatAccountName),
                            new XElement("VatAccountVatNr1", vatAccountVatNr1),
                            new XElement("VatAccountVatNr2", vatAccountVatNr2),
                            new XElement("VatAccountPercent", vatAccountPercent),
                            new XElement("Debit", debet),
                            new XElement("Credit", credit),
                            new XElement("Quantity", Convert.ToDecimal(voucherRowDTO.Quantity)),
                            new XElement("VoucherRowNr", voucherRowDTO.RowNr.HasValue ? voucherRowDTO.RowNr : voucherRowXmlId)
                            );

                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                        {
                            if (i > accountDimInternalsDTOs.Count)
                            {
                                voucherRowElement.Add(
                                    new XElement("AccountInternalNr" + i, String.Empty),
                                    new XElement("AccountInternalName" + i, String.Empty));
                                continue;
                            }

                            AccountInternalDTO accountInternal = null;
                            var accountDim = accountDimInternalsDTOs.Any() ? accountDimInternalsDTOs.ElementAt(i - 1) : null;
                            if (accountDim != null)
                                accountInternal = voucherRowDTO.AccountInternalDTO_forReports.FirstOrDefault(ai => ai.AccountDimId == accountDim.AccountDimId);

                            voucherRowElement.Add(
                                new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                                new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
                        }

                        voucherHeadElement.Add(voucherRowElement);
                        voucherRowXmlId++;
                    }

                    #region Default element VoucherRow

                    if (voucherRowXmlId == 1)
                        voucherHeadElement.Add(new XElement("VoucherRow", String.Empty));

                    #endregion

                    voucherListElement.Add(voucherHeadElement);
                    voucherHeadXmlId++;

                    #endregion
                }

                if (addPeriod)
                {
                    XElement accountPeriodElement = reportHeaderElement.Elements("AccountPeriod").FirstOrDefault();
                    if (accountPeriodElement != null && from != null && to != null)
                        accountPeriodElement.Value = ((DateTime)from).ToShortDateString() + "-" + ((DateTime)to).ToShortDateString();
                }

                if (addYear)
                {
                    XElement accountYearElement = reportHeaderElement.Elements("AccountYear").FirstOrDefault();
                    if (accountYearElement != null && accountYearDTO != null)
                        accountYearElement.Value = accountYearDTO.From.ToShortDateString() + "-" + accountYearDTO.To.ToShortDateString();
                }

                #region Default element VoucherHead/VoucherRow

                if (voucherHeadXmlId == 1)
                {
                    XElement voucherHeadElement = new XElement("VoucherHead",
                        new XAttribute("id", 1),
                        new XElement("VoucherNr", 0),
                        new XElement("VoucherSerieNr", "-"),
                        new XElement("VoucherSerieName", "-"),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherText", "-"));

                    XElement voucherRowElement = new XElement("VoucherRow",
                        new XAttribute("id", 1));

                    voucherHeadElement.Add(voucherRowElement);
                    voucherListElement.Add(voucherHeadElement);
                }

                #endregion
            }

            #region Close document

            rootElement.Add(voucherListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.VoucherList);

            #endregion

        }

        public XDocument CreateGeneralLedgerData(CreateReportResult reportResult)
        {
            #region Prereq

            if (reportResult == null)
                return null;

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId).ToDTOs();
            string companyName_shortName = CompanyManager.GetCompanyName(reportResult.ActorCompanyId, true, false);

            #endregion

            #region Init document

            base.reportResult = reportResult;

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "GeneralLedger");

            //GeneralLedger
            XElement generalLedgerElement = new XElement("GeneralLedger");

            var am = new AccountManager(parameterObject);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateLatestVoucherLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            generalLedgerElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(CreateLatestVoucherElement(reportParams));
            reportHeaderElement.Add(CreateAccountIntervalElement(am, reportResult, reportParams.SA_AccountIntervals, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateDateIntervalElement(reportParams.DateFrom, reportParams.DateTo));
            AddEnterpriseCurrencyPageLabelElements(reportHeaderElement);
            reportHeaderElement.Add(new XElement("SeparateAccountDim", reportParams.SSTD_SeparateAccountDim.ToInt()));
            reportHeaderElement.Add(new XElement("CompanyShortname", companyName_shortName));
            reportHeaderElement.Add(new XElement("ExportType", reportResult.ExportType));
            generalLedgerElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            CreateGeneralLedgerPageHeaderLabelsElement(pageHeaderLabelsElement);
            generalLedgerElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                List<AccountStd> accountStdsInInterval = new List<AccountStd>();

                var accountInternalsInInterval = new List<AccountInternal>();
                var reportAccountInternalsInInterval = new List<AccountInternal>();
                var voucherRowDTOs = new List<VoucherRowDTO>();
                var biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                var biYearInBalanceDict = new Dictionary<int, BalanceItemDTO>();
                var accountStdInIntervalDTOs = new List<AccountDTO>();
                var accountInternalInIntervalDTOs = new List<AccountInternalDTO>();
                var reportAccountInternalInIntervalDTOs = new List<AccountInternalDTO>();
                var accountYearDTO = new AccountYearDTO();
                var accountDimInternalDTOs = new List<AccountDimDTO>();

                //if (reportParams.SSTD_SeparateAccountDim)
                //{
                //    reportParams.OnlyActiveAccounts = true;
                //}

                bool validSelection = AccountManager.GetAccountsInInterval(entities, reportResult, reportParams, accountDimStd, false, ref accountStdsInInterval, ref reportAccountInternalsInInterval);
                if (validSelection)
                {
                    #region Load data

                    voucherRowDTOs = VoucherManager.GetVoucherRowsDTOFromSelection(entities, reportResult.ActorCompanyId, reportParams.SA_AccountIntervals, reportParams.ProjectReport, reportParams.DateFrom, reportParams.DateTo, null, null, null, null, reportParams.HasVoucherSeriesTypeSelection, reportParams.VoucherSeriesTypeSelection);

                    //AccountYear
                    accountYearDTO = reportParams.AccountYear.ToDTO();

                    if (reportAccountInternalsInInterval.Any())
                        reportAccountInternalInIntervalDTOs = reportAccountInternalsInInterval.ToDTOs();

                    if (accountStdsInInterval.Any())
                    {
                        foreach (var account in accountStdsInInterval)
                        {
                            accountStdInIntervalDTOs.Add(account.ToDTO());
                        }
                    }

                    if (accountDimInternals.Any())
                        accountDimInternalDTOs = accountDimInternals.ToDTOs();

                    if (reportParams.AccountYear != null)
                    {
                        if (reportParams.AccountYear.From != reportParams.DateFrom)
                        {
                            biBalanceChangeToPeriodDict = AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeFromDTO(accountYearDTO, reportParams.AccountYear.From, reportParams.UntilDateFrom(), accountStdInIntervalDTOs, accountDimInternalDTOs, reportAccountInternalInIntervalDTOs, reportResult.ActorCompanyId);
                        }

                        //Ingående balans för aktuellt år
                        biYearInBalanceDict = AccountBalanceManager(reportResult.ActorCompanyId).GetYearInBalanceFromDTO(entities, accountYearDTO, accountStdInIntervalDTOs, reportAccountInternalInIntervalDTOs, reportResult.ActorCompanyId);
                    }

                    #endregion
                }

                if (accountStdInIntervalDTOs != null)
                {
                    accountStdInIntervalDTOs = AccountManager.TranslateAccountNamesByLang(accountStdInIntervalDTOs); // 2015-04-27 / Jukka - Translate account names for the names for which current translation exists
                }
                #endregion

                #region Content

                bool isAccountSelectionValid = AccountManager.GetAccountsInInterval(entities, reportParams.SA_AccountIntervals, reportResult.ActorCompanyId, reportParams.OnlyActiveAccounts, accountDimStd, false, ref accountStdsInInterval, ref reportAccountInternalsInInterval);

                int reportI = 0;

                while (isAccountSelectionValid)
                {
                    if (reportAccountInternalInIntervalDTOs.Count > 0 && reportParams.SeparateAccountDim)
                    {
                        int accountMatchCounter = 0;
                        foreach (var account in reportAccountInternalInIntervalDTOs)
                        {
                            if (account.AccountDimId == reportParams.AccountDimId.GetValueOrDefault())
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                            else
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                        }
                    }
                    else
                        accountInternalInIntervalDTOs = reportAccountInternalInIntervalDTOs;

                    #region Sheet

                    int sheetId = 1;
                    XElement sheetElement = new XElement("Sheet");
                    if (accountInternalInIntervalDTOs.Count > 0 && reportParams.SeparateAccountDim)
                    {
                        AccountInternalDTO accountinternal = null;

                        int accountMatchCounter = 0;
                        foreach (var account in reportAccountInternalInIntervalDTOs)
                        {
                            if (account.AccountDimId == reportParams.AccountDimId.GetValueOrDefault())
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountinternal = account;
                                }
                                accountMatchCounter++;
                            }
                            else
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountinternal = account;
                                }
                                accountMatchCounter++;
                            }
                        }

                        var accountdiminternal = accountDimInternals.FirstOrDefault(i => i.AccountDimId == accountinternal.AccountDimId);

                        sheetElement.Add(
                            new XAttribute("id", (reportI + 1)),
                            new XElement("DimensionNr", accountinternal?.AccountDimNr.ToString()),
                            new XElement("DimensionName", accountdiminternal?.Name),
                            new XElement("InternalNr", accountinternal?.AccountNr),
                            new XElement("InternalName", accountinternal?.Name)
                        );
                    }
                    else
                    {
                        sheetElement.Add(
                        new XAttribute("id", sheetId),
                        new XElement("DimensionNr", String.Empty),
                        new XElement("DimensionName", String.Empty),
                        new XElement("InternalNr", String.Empty),
                        new XElement("InternalName", String.Empty));
                    }
                    #endregion

                    int accountId = 1;

                    #region ByDTO

                    if (validSelection)
                    {
                        if (reportParams.ProjectReport)
                        {
                            XElement accountElement = null;
                            XElement voucherRowElement = null;



                            int projectDimId = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId).Where(d => d.LinkedToProject).Select(d => d.AccountDimId).FirstOrDefault();

                            List<AccountInternalDTO> projectsInInterval = accountInternalInIntervalDTOs.Where(a => a.AccountDimId == projectDimId).ToList();

                            //get all projects if user hasn't given any interval
                            if (!projectsInInterval.Any())
                                projectsInInterval = AccountManager.GetAccountInternalsByDim(projectDimId, reportResult.ActorCompanyId).ToDTOs();

                            List<AccountInternalDTO> accountsInInterval2 = null;

                            //project report handles one additional level of internal accounts in addition to project (e.g. costplaces)
                            if (reportParams.SA_AccountIntervals != null)
                            {
                                for (int i = 0; i < reportParams.SA_AccountIntervals.Count; i++)
                                {
                                    if (reportParams.SA_AccountIntervals[i].AccountDimId == accountDimStd.AccountDimId || reportParams.SA_AccountIntervals[i].AccountDimId == projectDimId)
                                        continue;

                                    if (accountsInInterval2 == null)
                                        accountsInInterval2 = accountInternalInIntervalDTOs.Where(a => a.AccountDimId == reportParams.SA_AccountIntervals[i].AccountDimId).ToList();
                                }
                            }

                            foreach (var project in projectsInInterval)
                            {
                                foreach (AccountDTO account in accountStdInIntervalDTOs)
                                {

                                    //VoucherRows for AccountStd
                                    List<VoucherRowDTO> voucherRowDTOForAccount = voucherRowDTOs.Where(vr => vr.Dim1Id == account.AccountId).ToList();

                                    List<VoucherRowDTO> projectRows = voucherRowDTOForAccount.Where(r => r.Dim1Id == account.AccountId && (r.Dim2Id == project.AccountId ||
                                                                r.Dim3Id == project.AccountId || r.Dim4Id == project.AccountId ||
                                                                r.Dim5Id == project.AccountId || r.Dim6Id == project.AccountId)).ToList();

                                    if (accountsInInterval2 == null)
                                    {
                                        if (projectRows.Count > 0)
                                        {
                                            accountElement = CreateAccountElementForProjectReport(accountId, account, projectRows, reportParams.DateFrom);

                                            int voucherRowXmlId = 0;
                                            bool hasTransactions = false;

                                            foreach (var voucherRow in projectRows.Where(r => r.Date >= reportParams.DateFrom && r.Date <= reportParams.DateTo).ToList())
                                            {
                                                voucherRowElement = CreateVoucherRowElementsForProjectReport(voucherRowXmlId, voucherRow, accountDimInternals);

                                                if (voucherRowElement != null)
                                                {
                                                    hasTransactions = true;
                                                    accountElement.Add(voucherRowElement);
                                                    voucherRowXmlId++;
                                                }
                                            }

                                            if (!hasTransactions)
                                            {
                                                voucherRowElement = new XElement("VoucherRow",
                                                    new XAttribute("id", 1));

                                                accountElement.Add(voucherRowElement);
                                            }

                                            if (accountElement != null)
                                            {
                                                sheetElement.Add(accountElement);
                                                accountId++;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        foreach (var accountInternal2 in accountsInInterval2)
                                        {
                                            List<VoucherRowDTO> accountInternal2Rows = projectRows.Where(r => r.Dim2Id == accountInternal2.AccountId ||
                                                                        r.Dim3Id == accountInternal2.AccountId || r.Dim4Id == accountInternal2.AccountId ||
                                                                        r.Dim5Id == accountInternal2.AccountId || r.Dim6Id == accountInternal2.AccountId).ToList();

                                            if (accountInternal2Rows.Count > 0)
                                            {
                                                accountElement = CreateAccountElementForProjectReport(accountId, account, accountInternal2Rows, reportParams.DateFrom);

                                                int voucherRowXmlId = 0;
                                                bool hasTransactions = false;

                                                foreach (var voucherRow in accountInternal2Rows.Where(r => r.Date >= reportParams.DateFrom && r.Date <= reportParams.DateTo).ToList())
                                                {
                                                    voucherRowElement = CreateVoucherRowElementsForProjectReport(voucherRowXmlId, voucherRow, accountDimInternals);

                                                    if (voucherRowElement != null)
                                                    {
                                                        hasTransactions = true;
                                                        accountElement.Add(voucherRowElement);
                                                        voucherRowXmlId++;
                                                    }
                                                }

                                                if (!hasTransactions)
                                                {
                                                    voucherRowElement = new XElement("VoucherRow",
                                                        new XAttribute("id", 1));

                                                    accountElement.Add(voucherRowElement);
                                                }

                                                if (accountElement != null)
                                                {
                                                    sheetElement.Add(accountElement);
                                                    accountId++;
                                                }

                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach (AccountDTO account in accountStdInIntervalDTOs)
                            {
                                #region AccountStd

                                //VoucherRows for AccountStd
                                List<VoucherRowDTO> voucherRowDTOForAccount = voucherRowDTOs.Where(vr => vr.Dim1Id == account.AccountId).ToList();
                                bool hasVoucherRows = voucherRowDTOForAccount.Count > 0;

                                //Get Balance
                                BalanceItemDTO biYearInBalance = AccountBalanceManager(reportResult.ActorCompanyId).GetAccountBalanceFromDTO(accountYearDTO, account.AccountId, biYearInBalanceDict, biBalanceChangeToPeriodDict);
                                bool hasBalance = biYearInBalance.Balance != 0;

                                if (!hasVoucherRows && !hasBalance)
                                    continue;

                                XElement accountElement = null;
                                bool foundVoucherRows = false;

                                if (hasVoucherRows)
                                {
                                    #region Accounts with transactions

                                    int voucherRowXmlId = 1;
                                    foreach (VoucherRowDTO voucherRowDTO in voucherRowDTOForAccount)
                                    {
                                        #region Prereq VoucherRow

                                        if (!VoucherManager.VoucherRowDTOContainsAccountInternals(voucherRowDTO, accountInternalInIntervalDTOs))
                                            continue;
                                        foundVoucherRows = true;
                                        #endregion

                                        #region Account

                                        if (voucherRowXmlId == 1)
                                        {
                                            accountElement = CreateGeneralLedgerAccountElementFromDTO(accountId, account, biYearInBalance, accountDimInternalDTOs);
                                            if (accountElement == null)
                                                return null;
                                        }

                                        #endregion

                                        #region VoucherRow

                                        this.GetDebetCredit(voucherRowDTO.Amount, out decimal debet, out decimal credit);
                                        this.GetDebetCredit(voucherRowDTO.AmountEntCurrency, out decimal debetEntCurrency, out decimal creditEntCurrency);

                                        string voucherRowText = voucherRowDTO.Text;
                                        if (String.IsNullOrEmpty(voucherRowText))
                                            voucherRowText = voucherRowDTO.Text;

                                        XElement voucherRowElement = new XElement("VoucherRow",
                                            new XAttribute("id", voucherRowXmlId),
                                            new XElement("VoucherSerieNr", voucherRowDTO.VoucherSeriesTypeNr),
                                            new XElement("VoucherSerieName", voucherRowDTO.VoucherSeriesTypeName),
                                            new XElement("VoucherNr", voucherRowDTO.VoucherNr),
                                            new XElement("VoucherRowDate", voucherRowDTO.Date), //Cannot use VoucherRow.Date beacuse that data is corrupted in many cases (i.e. set to date when currency was fetched from ws)
                                            new XElement("VoucherRowText", voucherRowText),
                                            new XElement("Debit", debet),
                                            new XElement("DebitEntCurrency", debetEntCurrency),
                                            new XElement("Credit", credit),
                                            new XElement("CreditEntCurrency", creditEntCurrency),
                                            new XElement("Quantity", Convert.ToDecimal(voucherRowDTO.Quantity)));

                                        #region AccountInternal

                                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                                        {
                                            if (i > accountDimInternals.Count)
                                            {
                                                voucherRowElement.Add(
                                                    new XElement("AccountInternalNr" + i, String.Empty),
                                                    new XElement("AccountInternalName" + i, String.Empty));
                                                continue;
                                            }

                                            AccountInternalDTO accountInternal = null;
                                            var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                                            if (accountDim != null)
                                            {
                                                accountInternal = (from ai in voucherRowDTO.AccountInternalDTO_forReports
                                                                   where ai.AccountDimId == accountDim.AccountDimId
                                                                   select ai).FirstOrDefault<AccountInternalDTO>();
                                            }

                                            voucherRowElement.Add(
                                                new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                                                new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
                                        }

                                        #endregion

                                        accountElement.Add(voucherRowElement);
                                        voucherRowXmlId++;

                                        #endregion
                                    }

                                    #endregion
                                }
                                else if (hasBalance)
                                //                   && (!foundVoucherRows && (hasVoucherRows)))
                                {
                                    #region Accounts with no transactions but with Balance

                                    #region Account
                                    accountElement = CreateGeneralLedgerAccountElementFromDTO(accountId, account, biYearInBalance, accountDimInternalDTOs);

                                    #endregion

                                    #region VoucherRow

                                    XElement voucherRowElement = new XElement("VoucherRow",
                                        new XAttribute("id", 1));

                                    accountElement.Add(voucherRowElement);

                                    #endregion
                                    #endregion

                                }
                                if ((hasBalance) && (!foundVoucherRows) && (hasVoucherRows) && (accountId == 1))
                                {
                                    #region Accounts with no transactions but with Balance

                                    #region Account
                                    accountElement = CreateGeneralLedgerAccountElementFromDTO(accountId, account, biYearInBalance, accountDimInternalDTOs);

                                    #endregion

                                    #region VoucherRow

                                    XElement voucherRowElement = new XElement("VoucherRow",
                                        new XAttribute("id", 1));

                                    accountElement.Add(voucherRowElement);

                                    #endregion
                                    #endregion
                                }
                                //if (!foundVoucherRows && reportParams.SeparateAccountDim)
                                //{
                                //    accountElement = null;
                                //}
                                if (accountElement != null)
                                {
                                    sheetElement.Add(accountElement);
                                    accountId++;
                                }

                                #endregion

                            }





                        }
                    }

                    #region Default element Account

                    if (accountId == 1)
                    {
                        XElement accountElement = new XElement("Account",
                            new XAttribute("id", 1),
                            new XElement("AccountNr", "-"),
                            new XElement("AccountName", "-"),
                            new XElement("AccountBalance", 0));

                        XElement voucherRowElement = new XElement("VoucherRow",
                            new XAttribute("id", 1));

                        accountElement.Add(voucherRowElement);
                        sheetElement.Add(accountElement);
                    }

                    #endregion

                    #endregion

                    generalLedgerElement.Add(sheetElement);

                    reportI++;
                    if (reportAccountInternalInIntervalDTOs.Count > 0 && (reportI) < reportAccountInternalInIntervalDTOs.Count && reportParams.SeparateAccountDim)
                    {
                        accountInternalInIntervalDTOs.Clear();

                        int accountMatchCounter = 0;
                        foreach (var account in reportAccountInternalInIntervalDTOs)
                        {
                            if (account.AccountDimId == reportParams.AccountDimId.GetValueOrDefault())
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                            else
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                        }

                        AccountInternalDTO accountinternal = null;
                        if (reportParams.AccountDimId.GetValueOrDefault() != 0)
                        {
                            accountinternal = accountInternalInIntervalDTOs.FirstOrDefault(i => i.AccountDimId == reportParams.AccountDimId.GetValueOrDefault());
                            if (accountinternal == null)
                                isAccountSelectionValid = false;
                        }
                        #endregion
                    }
                    else
                    {
                        isAccountSelectionValid = false;
                    }
                }
            }

            #region Close document

            rootElement.Add(generalLedgerElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.GeneralLedger);

            #endregion
        }

        public XDocument CreateSupplierPaymentJournalData(CreateReportResult reportResult)
        {
            #region Prereq

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierPaymentJournal");

            //SupplierInvoiceJournal
            XElement supplierPaymentJournalElement = new XElement("SupplierPaymentJournal");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSupplierReportHeaderLabelsElement();
            supplierPaymentJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(reportResult, reportParams);
            supplierPaymentJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSupplierPaymentJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            supplierPaymentJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateSupplierJournalCommonContent(entities, reportResult, reportParams, supplierPaymentJournalElement, SoeOriginType.SupplierPayment, accountDimInternals).Success)
                    return null;
            }

            #region Close document

            rootElement.Add(supplierPaymentJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierPaymentJournal);

            #endregion
        }

        public XDocument CreateCustomerPaymentJournalData(CreateReportResult reportResult)
        {
            #region Prereq

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerPaymentJournal");

            //CustomerInvoiceJournal
            XElement customerPaymentJournalElement = new XElement("CustomerPaymentJournal");

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateCustomerReportHeaderLabelsElement();
            customerPaymentJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(reportResult, reportParams);
            customerPaymentJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateCustomerPaymentJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            customerPaymentJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateCustomerJournalCommonContent(entities, reportResult, reportParams, customerPaymentJournalElement, SoeOriginType.CustomerPayment, accountDimInternals).Success)
                    return null;
            }

            #endregion

            #region Close document

            rootElement.Add(customerPaymentJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerPaymentJournal);

            #endregion
        }

        public XDocument CreateInterestRateCalculationData(CreateReportResult reportResult, EvaluatedSelection es = null)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerInterestRateCalculation");

            //CustomerBalanceList
            XElement interestRateCalculationElement = new XElement("CustomerInterestRateCalculation");

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            if (es != null)
            {
                reportParams.SL_HasInvoiceSeqNrInterval = es.SL_HasInvoiceSeqNrInterval;
                reportParams.SL_InvoiceSeqNrFrom = es.SL_InvoiceSeqNrFrom;
                reportParams.SL_InvoiceSeqNrTo = es.SL_InvoiceSeqNrTo;
                reportParams.SL_HasInvoiceIds = es.SL_HasInvoiceIds;
                reportParams.SL_InvoiceIds = es.SL_InvoiceIds;

                reportParams.SL_HasActorNrInterval = es.SL_HasActorNrInterval;
                reportParams.SL_ActorNrFrom = es.SL_ActorNrFrom;
                reportParams.SL_ActorNrTo = es.SL_ActorNrTo;
            }
            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateInterestRateCalculationReportHeaderLabelsElement();
            interestRateCalculationElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, reportResult.ActorCompanyId, 0);
            XElement reportHeaderElement = CreateInterestRateCalculationPageHeaderElement(reportResult, reportParams, interestPercent);
            interestRateCalculationElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateInterestRateCalculationPageHeaderLabelsElement(pageHeaderLabelsElement);
            interestRateCalculationElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content
                // muuta
                if (!CreateInterestRateCalculationCommonContent(entities, reportResult, reportParams, interestRateCalculationElement).Success)
                    return null;

                #endregion
            }

            #region Close document

            rootElement.Add(interestRateCalculationElement); // muuta
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.InterestRateCalculation);

            #endregion
        }

        public XDocument CreateIOVoucherData(CreateReportResult reportResult, EvaluatedSelection es1 = null)
        {
            #region Prereq

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            if (es1 != null)
            {
                reportParams.SI_VoucherHeadIOIds = es1.SI_VoucherHeadIOIds;
            }

            List<AccountYear> accountYears = AccountManager.GetAccountYears(reportResult.ActorCompanyId, false, false);
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId, true);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId).ToDTOs();
            List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(reportResult.ActorCompanyId, true, false, false);
            List<AccountInternal> accountInternals = AccountManager.GetAccountInternals(reportResult.ActorCompanyId, true);
            List<VoucherHeadIO> voucherHeadIOs = ImportExportManager.GetVoucherHeadIOResult(reportResult.ActorCompanyId, reportParams.SI_VoucherHeadIOIds);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "IOVoucherList");

            //VoucherList
            XElement ioVoucherListElement = new XElement("IOVoucherList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateLatestVoucherLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherSerieIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            CreateAccountingOrderReportHeaderLabelsElement(reportHeaderLabelsElement);
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            ioVoucherListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateIOVoucherAccountingReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(CreateLatestVoucherElement(reportParams));
            reportHeaderElement.Add(CreateAccountIntervalElement(am, reportResult, reportParams.SA_AccountIntervals, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateVoucherIntervalElement(reportParams));
            reportHeaderElement.Add(CreateVoucherSerieIntervalElement(reportParams));
            reportHeaderElement.Add(CreateDateIntervalElement(reportParams));
            ioVoucherListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            CreateVoucherListPageHeaderLabelsElement(pageHeaderLabelsElement);
            ioVoucherListElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            XElement voucherHeadIOElement = null;
            List<XElement> voucherHeadIOElements = new List<XElement>();

            int voucherHeadIOXmlId = 1;
            foreach (var voucherHeadIO in voucherHeadIOs)
            {
                #region VoucherHead

                #region Prereq

                AccountYear accountYear = null;
                if (voucherHeadIO.AccountYearId != 0)
                    accountYear = accountYears.FirstOrDefault(i => i.AccountYearId == voucherHeadIO.AccountYearId);

                VoucherSeries voucherSeries = null;
                VoucherSeriesType voucherSeriesType = null;
                if (voucherHeadIO.VoucherSeriesId != 0)
                {
                    voucherSeries = VoucherManager.GetVoucherSerie(voucherHeadIO.VoucherSeriesId, reportResult.ActorCompanyId, true);
                    if (voucherSeries != null)
                        voucherSeriesType = voucherSeries.VoucherSeriesType;
                }
                else if (voucherHeadIO.VoucherSeriesTypeNr != null && voucherHeadIO.VoucherSeriesTypeNr != -1 && voucherHeadIO.VoucherSeriesId == 0)
                {
                    if (accountYear == null && voucherHeadIO.Date != null)
                        accountYear = AccountManager.GetAccountYear(voucherHeadIO.Date, voucherHeadIO.ActorCompanyId, false);

                    voucherSeries = VoucherManager.GetVoucherSerieByTypeNr((int)voucherHeadIO.VoucherSeriesTypeNr, accountYear.AccountYearId);
                    if (voucherSeries != null)
                        voucherSeriesType = voucherSeries.VoucherSeriesType;
                }

                #endregion

                #region VoucherHeadIO element

                voucherHeadIOElement = new XElement("VoucherHeadIO",
                    new XAttribute("Id", voucherHeadIOXmlId),
                    new XElement("VoucherBatchdId", voucherHeadIO.BatchId),
                    new XElement("VoucherDate", voucherHeadIO.Date.ToShortDateString()),
                    new XElement("VoucherVoucherNr", voucherHeadIO.VoucherNr.NullToEmpty()),
                    new XElement("VoucherText", voucherHeadIO.Text.NullToEmpty()),
                    new XElement("VoucherNote", voucherHeadIO.Note.NullToEmpty()),
                    new XElement("VoucherErrorMessage", voucherHeadIO.ErrorMessage.NullToEmpty()),
                    new XElement("isVATVoucher", voucherHeadIO.IsVatVoucher.ToInt()),
                    new XElement("AccountYearFrom", accountYear?.From.ToShortDateString() ?? string.Empty),
                    new XElement("AccountYearTo", accountYear?.To.ToShortDateString() ?? string.Empty),
                    new XElement("AccountYearStatusText", accountYear?.StatusText ?? string.Empty),
                    new XElement("VoucherSeriesType", voucherSeriesType?.Name ?? string.Empty));

                #endregion

                int voucherRowIOXMLId = 0;
                if (!voucherHeadIO.VoucherRowIO.IsNullOrEmpty())
                {
                    foreach (var voucherRowIO in voucherHeadIO.VoucherRowIO)
                    {
                        #region VoucherRowIO element

                        voucherRowIOXMLId++;

                        XElement voucherRowIOElement = new XElement("VoucherRowIO",
                            new XAttribute("Id", voucherRowIOXMLId),
                            new XElement("VoucherBatchdId", voucherHeadIO.BatchId),
                            new XElement("VoucherRowText", voucherRowIO.Text.NullToEmpty()),
                            new XElement("VoucherRowAmount", voucherRowIO.Amount ?? 0),
                            new XElement("VoucherRowQuantity", voucherRowIO.Quantity ?? 0),
                            new XElement("VoucherRowAccountNr", voucherRowIO.AccountNr.NullToEmpty()),
                            new XElement("VoucherRowAccountName", accountStds?.FirstOrDefault(a => a.Account?.AccountNr == voucherRowIO.AccountNr)?.Account?.Name ?? "Account not found"),
                            new XElement("VoucherRowAccountDim2Nr", voucherRowIO.AccountDim2Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim3Nr", voucherRowIO.AccountDim3Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim4Nr", voucherRowIO.AccountDim4Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim5Nr", voucherRowIO.AccountDim5Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim6Nr", voucherRowIO.AccountDim6Nr.NullToEmpty()),
                            new XElement("VoucherRowDebetAmount", voucherRowIO.DebetAmount ?? 0),
                            new XElement("VoucherRowCreditAmount", voucherRowIO.CreditAmount ?? 0),
                            new XElement("VoucherRowErrorMessage", voucherRowIO.ErrorMessage.NullToEmpty()));

                        List<string> voucherRowErrorMessageDetails = new List<string>();

                        if (!accountStds.Any(a => a.Account.AccountNr == voucherRowIO.AccountNr))
                            voucherRowErrorMessageDetails.Add($"AccountNr not found: {voucherRowIO.AccountNr}");

                        int accountDimNr = 2;
                        foreach (AccountDim dim in accountDimInternals.Where(i => i.AccountDimNr != Constants.ACCOUNTDIM_STANDARD).OrderBy(i => i.AccountDimNr))
                        {
                            if (accountDimNr == 2 && !voucherRowIO.AccountDim2Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim2Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim2Nr}");
                            else if (accountDimNr == 3 && !voucherRowIO.AccountDim3Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim3Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim3Nr}");
                            else if (accountDimNr == 4 && !voucherRowIO.AccountDim4Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim4Nr.NullToEmpty()))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim4Nr}");
                            else if (accountDimNr == 5 && !voucherRowIO.AccountDim5Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim5Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim5Nr}");
                            else if (accountDimNr == 6 && !voucherRowIO.AccountDim6Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim6Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim6Nr}");

                            accountDimNr++;
                        }

                        voucherRowIOElement.Add(
                            new XElement("VoucherRowErrorMessageDetails", voucherRowErrorMessageDetails.ToCommaSeparated()));

                        voucherHeadIOElement.Add(voucherRowIOElement);

                        #endregion
                    }
                }

                voucherHeadIOElements.Add(voucherHeadIOElement);
                voucherHeadIOXmlId++;

                #endregion
            }

            ioVoucherListElement.Add(voucherHeadIOElements);

            #endregion

            #region Close document

            rootElement.Add(ioVoucherListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.IOVoucher);

            #endregion
        }

        private ActionResult CreateInterestRateCalculationCommonContent(CompEntities entities, CreateReportResult reportResult, EconomyReportParamsDTO reportParams, XElement interestRateCalculationElement)
        {
            #region Prereq

            ActionResult result = new ActionResult(true);


            if (interestRateCalculationElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #endregion

            #region Init

            int invoiceElementCount = 0;
            int customerElementCount = 0;

            int rateMinAmount = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestAccumulatedBeforeInvoice, 0, reportResult.ActorCompanyId, 0);
            int rateMinDays = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerGracePeriodDays, 0, reportResult.ActorCompanyId, 0);
            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, reportResult.ActorCompanyId, 0);

            #endregion

            var invoiceItems = (from i in entities.Invoice.Include("Origin")
                                where i.Origin.ActorCompanyId == reportResult.ActorCompanyId &&
                                i.FullyPayed &&
                                i.Origin.Type == (int)SoeOriginType.CustomerInvoice
                                select i).OrderBy(i => i.ActorId).ToList();

            if (reportParams.SL_HasInvoiceSeqNrInterval)
            {
                invoiceItems = (from s in invoiceItems
                                where s.SeqNr >= reportParams.SL_InvoiceSeqNrFrom &&
                                s.SeqNr <= reportParams.SL_InvoiceSeqNrTo
                                select s).OrderBy(i => i.ActorId).ToList();

            }
            else if (reportParams.SL_HasInvoiceIds)
            {
                invoiceItems = (from s in invoiceItems
                                where reportParams.SL_InvoiceIds.Contains(s.InvoiceId)
                                select s).OrderBy(i => i.ActorId).ToList();
            }

            foreach (var group in invoiceItems.GroupBy(o => o.ActorId.Value))
            {
                invoiceElementCount = 0;

                Customer customer = CustomerManager.GetCustomer(group.Key);

                if (reportParams.SL_HasActorNrInterval && !StringUtility.IsInInterval(customer.CustomerNr, reportParams.SL_ActorNrFrom, reportParams.SL_ActorNrTo))
                    continue;

                string customerNr = customer.CustomerNr;
                string customerName = customer.Name;
                string customerAddress = "", customerAddressCO = "", customerPostalCode = "", customerPostalAddress = "";

                Contact contact = ContactManager.GetContactAndEcomFromActor(entities, customer.ActorCustomerId);
                List<ContactAddress> contactAddresses = ContactManager.GetContactAddresses(entities, contact.ContactId);

                if (contactAddresses.Count > 0)
                {
                    ContactAddress billingAddress = contactAddresses.FirstOrDefault(i => i.SysContactAddressTypeId == (int)ContactAddressItemType.AddressBilling);

                    if (billingAddress != null)
                    {
                        foreach (ContactAddressRow addressRow in billingAddress.ContactAddressRow)
                        {
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                customerAddress = addressRow.Text;
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                customerAddressCO = addressRow.Text;
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                customerPostalCode = addressRow.Text;
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                customerPostalAddress = addressRow.Text;
                        }
                    }
                }

                XElement customerElement = new XElement("Customer");

                customerElement.Add(
                    new XElement("CustomerNr", customerNr),
                    new XElement("CustomerName", customerName),
                    new XElement("CustomerAddress", customerAddress),
                    new XElement("CustomerAddressCO", customerAddressCO),
                    new XElement("CustomerPostalCode", customerPostalCode),
                    new XElement("CustomerPostalAddress", customerPostalAddress));

                foreach (var item in group)
                {
                    List<PaymentRow> paymentRows = PaymentManager.GetPaymentRowsByInvoice(entities, item.InvoiceId).Where(i => i.Status != (int)SoePaymentStatus.Cancel && i.Status != (int)SoePaymentStatus.Error).OrderBy(i => i.PayDate).ToList();

                    if (paymentRows == null || paymentRows.Count == 0)
                        continue;

                    // check that invoice has been dued more than grace period days
                    DateTime dateFrom = item.DueDate.Value;
                    DateTime dateTo = paymentRows.Select(i => i.PayDate).LastOrDefault();
                    int daysDued = Convert.ToInt32(dateTo.Subtract(dateFrom).TotalDays);

                    if (daysDued <= rateMinDays)
                        continue;

                    //invoice element                                                            
                    XElement invoiceElement = new XElement("Invoice");

                    invoiceElement.Add(
                            new XElement("InvoiceNr", item.InvoiceNr),
                            new XElement("InvoiceDate", item.InvoiceDate),
                            new XElement("InvoiceDueDate", item.DueDate),
                            new XElement("InvoiceTotalAmount", item.TotalAmount),
                            new XElement("InvoiceTotalVATAmount", item.VATAmount)
                        );

                    decimal interestAmount = 0;
                    DateTime interestDayFrom = item.DueDate.Value;
                    decimal openBalance = item.TotalAmount;

                    foreach (var payment in paymentRows)
                    {
                        //calculate interest days
                        int interestDays = Convert.ToInt32(payment.PayDate.Subtract(interestDayFrom).TotalDays);

                        //update start date for calculating interest amount (in case of several payments)
                        if (payment.PayDate >= interestDayFrom)
                            interestDayFrom = payment.PayDate;

                        //calculate interest amount from due date or previous payment date until next payment date
                        decimal paymentInterestAmount = 0;
                        if (interestDays > 0)
                            paymentInterestAmount = openBalance * Decimal.Divide(interestPercent, 100) * Decimal.Divide(interestDays, 365);

                        interestAmount += Math.Round(paymentInterestAmount, 2);

                        //update open balance for further interest amount calculation
                        openBalance -= payment.Amount;

                        XElement paymentElement = new XElement("Payment");

                        paymentElement.Add(
                                new XElement("PaymentSeqNr", payment.SeqNr),
                                new XElement("PaymentDate", payment.PayDate),
                                new XElement("PaymentAmount", payment.Amount),
                                new XElement("PaymentRateDays", interestDays > 0 ? interestDays : 0),
                                new XElement("PaymentRateAmount", Math.Round(paymentInterestAmount, 2))
                            );

                        invoiceElement.Add(paymentElement);
                    }

                    //Check that totalamount is larger than minimum amount in company setting
                    if (interestAmount < rateMinAmount)
                        continue;

                    customerElement.Add(invoiceElement);
                    invoiceElementCount++;
                }

                if (invoiceElementCount > 0)
                {
                    interestRateCalculationElement.Add(customerElement);
                    customerElementCount++;
                }
            }

            //add empty element if no other elements created
            if (customerElementCount == 0)
            {
                interestRateCalculationElement.Add(
                        new XElement("Customer",
                            new XElement("CustomerNr", string.Empty),
                            new XElement("CustomerName", string.Empty),
                            new XElement("CustomerAddress", string.Empty),
                            new XElement("CustomerAddressCO", string.Empty),
                            new XElement("CustomerPostalCode", string.Empty),
                            new XElement("Invoice",
                                new XElement("InvoiceNr", string.Empty),
                                new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("InvoiceDueDate", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("InvoiceTotalAmount", 0),
                                new XElement("InvoiceTotalVATAmount", 0),
                                new XElement("Payment",
                                    new XElement("PaymentSeqNr", 0),
                                    new XElement("PaymentDate", CalendarUtility.DATETIME_DEFAULT),
                                    new XElement("PaymentAmount", 0),
                                    new XElement("PaymentRateDays", 0),
                                    new XElement("PaymentRateAmount", 0)))));

            }

            return result;
        }

        protected XElement CreateInterestRateCalculationPageHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams, decimal interestPercent)
        {
            return new XElement("ReportHeader",
                this.CreateLoginNameElement(reportResult.LoginName),
                new XElement("DateInterval", this.GetDateIntervalText(reportParams)),
                this.CreateReportTitleElement(reportResult.ReportName),
                this.CreateReportDescriptionElement(reportResult.ReportDescription),
                this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                this.CreateCompanyElement(),
                this.CreateCompanyOrgNrElement(),
                new XElement("InterestRate", interestPercent));
        }
        public XDocument CreateCustomerInvoiceJournalData(CreateReportResult reportResult)
        {
            #region Prereq

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerInvoiceJournal");

            //CustomerInvoiceJournal
            XElement customerInvoiceJournalElement = new XElement("CustomerInvoiceJournal");

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateCustomerReportHeaderLabelsElement();
            customerInvoiceJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(reportResult, reportParams);
            customerInvoiceJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateCustomerInvoiceJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            customerInvoiceJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateCustomerJournalCommonContent(entities, reportResult, reportParams, customerInvoiceJournalElement, SoeOriginType.CustomerInvoice, accountDimInternals).Success)
                    return null;
            }

            #endregion

            #region Close document

            rootElement.Add(customerInvoiceJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerInvoiceJournal);

            #endregion
        }
        private ActionResult CreateCustomerJournalCommonContent(CompEntities entities, CreateReportResult reportResult, EconomyReportParamsDTO reportParams, XElement customerJournalElement, SoeOriginType originType, IEnumerable<AccountDim> accountDimInternals)
        {

            if (customerJournalElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #region Content

            var result = CreateBalanceListCommonContent(entities, reportResult, reportParams, customerJournalElement, SoeOriginType.CustomerInvoice, SoeOriginType.CustomerPayment, true, true);
            if (!result.Success)
                return result;

            var items = result.Value as IEnumerable<GetReportBalanceListItemsResult>;
            if (items == null)
                items = new List<GetReportBalanceListItemsResult>().AsEnumerable();

            items = SortBalanceListInvoices(reportParams, items, originType);

            int journalCounter = 1;
            foreach (var item in items)
            {
                if (!reportParams.SL_IncludeCashSalesInvoices && item.IsCashSale)
                {
                    continue;
                }

                if (item.OriginType != (int)originType)
                    continue;

                XElement journalElement = null;
                if (originType == SoeOriginType.CustomerInvoice)
                    journalElement = CreateCustomerInvoiceJournalElement(entities, reportParams, item, accountDimInternals);
                else if (originType == SoeOriginType.CustomerPayment)
                    journalElement = CreatePaymentJournalElement(entities, reportParams, item, SoeOriginType.CustomerPayment, accountDimInternals);

                if (journalElement != null)
                {
                    journalElement.SetAttributeValue("id", journalCounter);
                    journalCounter++;

                    customerJournalElement.Add(journalElement);
                }
            }

            #region Default element Journal/InvoiceRow/PaymentAccountRow

            if (journalCounter == 1)
            {
                if (originType == SoeOriginType.CustomerInvoice)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("InvoiceNr", 0),
                        new XElement("CustomerNr", String.Empty),
                        new XElement("CustomerName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0)
                        );

                    var invoiceRowElement = new XElement("InvoiceRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                    customerJournalElement.Add(journalElement);
                }
                else if (originType == SoeOriginType.CustomerPayment)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", CalendarUtility.DATETIME_DEFAULT), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", 0),
                        new XElement("PaymentNr", String.Empty), //Differ (added) from InvoiceJournal
                        new XElement("CustomerNr", String.Empty),
                        new XElement("CustomerName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0));

                    var paymentAccountRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        paymentAccountRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(paymentAccountRowElement);
                    customerJournalElement.Add(journalElement);
                }
            }

            #endregion

            #endregion

            return result;
        }
        private XElement CreateCustomerInvoiceJournalElement(CompEntities entities, EconomyReportParamsDTO reportParams, GetReportBalanceListItemsResult item, IEnumerable<AccountDim> accountDimInternals)
        {
            XElement journalElement = null;
            if (reportParams == null || item == null || accountDimInternals == null)
                return journalElement;

            CustomerInvoice customerInvoice = InvoiceManager.GetCustomerInvoiceAndRows(entities, item.InvoiceId, true, true);
            if (customerInvoice != null)
            {
                #region Journal

                bool hasVoucher = item.HasVoucher ?? false;
                bool showVoucher = reportParams.SL_ShowVoucher && hasVoucher;
                string custName = "";
                if (String.IsNullOrEmpty(customerInvoice.CustomerName))
                {
                    custName = item.ActorName;
                }
                else
                {
                    custName = customerInvoice.CustomerName;
                }

                journalElement = new XElement("Journal",
                    new XElement("InvoiceDate", item.InvoiceDate.HasValue ? item.InvoiceDate.Value : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("InvoiceNr", item.InvoiceNr),
                    new XElement("SeqNr", item.SeqNr.HasValue ? item.SeqNr.Value : 0),
                    new XElement("CustomerNr", item.ActorNr),
                    new XElement("CustomerName", custName),
                    new XElement("ShowVoucher", showVoucher.ToInt()),
                    new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                    new XElement("VoucherDate", item.VoucherDate.HasValue ? item.VoucherDate.Value : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("VoucherNr", item.VoucherNr.HasValue ? item.VoucherNr.Value : 0),
                    new XElement("Description", item.Description),
                    new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                    new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                    );

                int invoiceRowXmlId = 1;
                foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoice.ActiveCustomerInvoiceRows)
                {
                    bool isHouseholdRow = customerInvoiceRow.IsHouseholdTaxDeductionRow();

                    foreach (CustomerInvoiceAccountRow customerInvoiceAccountRow in customerInvoiceRow.ActiveCustomerInvoiceAccountRows)
                    {
                        #region CustomerInvoiceAccountRow

                        decimal amount = customerInvoiceAccountRow.Amount;
                        decimal amountCurrency = customerInvoiceAccountRow.AmountCurrency;
                        decimal amountEntCurrency = customerInvoiceAccountRow.AmountEntCurrency;
                        decimal amountLedgerCurrency = customerInvoiceAccountRow.AmountLedgerCurrency;

                        if (amount > 0 && customerInvoiceAccountRow.CreditRow)
                        {
                            customerInvoiceAccountRow.CreditRow = false;
                            customerInvoiceAccountRow.DebitRow = true;
                        }
                        if (amount < 0 && customerInvoiceAccountRow.DebitRow)
                        {
                            customerInvoiceAccountRow.CreditRow = true;
                            customerInvoiceAccountRow.DebitRow = false;
                        }

                        if (amount < 0)
                        {
                            amount = Decimal.Negate(amount);
                            amountCurrency = Decimal.Negate(amountCurrency);
                            amountEntCurrency = Decimal.Negate(amountEntCurrency);
                            amountLedgerCurrency = Decimal.Negate(amountLedgerCurrency);
                        }

                        var invoiceRowElement = new XElement("InvoiceRow",
                            new XAttribute("id", invoiceRowXmlId),
                            new XElement("AccountNr", customerInvoiceAccountRow.AccountStd.Account.AccountNr),
                            new XElement("AccountName", customerInvoiceAccountRow.AccountStd.Account.Name),
                            new XElement("Debit", isHouseholdRow ? (customerInvoiceAccountRow.Amount > 0 ? amount : 0) : (customerInvoiceAccountRow.DebitRow ? amount : 0)),
                            new XElement("DebitCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountCurrency > 0 ? amountCurrency : 0) : (customerInvoiceAccountRow.DebitRow ? amountCurrency : 0)), //TODO
                            new XElement("DebitEntCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountEntCurrency > 0 ? amountEntCurrency : 0) : (customerInvoiceAccountRow.DebitRow ? amountEntCurrency : 0)),
                            new XElement("DebitLedgerCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountLedgerCurrency > 0 ? amountLedgerCurrency : 0) : (customerInvoiceAccountRow.DebitRow ? amountLedgerCurrency : 0)),
                            new XElement("Credit", isHouseholdRow ? (customerInvoiceAccountRow.Amount < 0 ? amount : 0) : (customerInvoiceAccountRow.CreditRow ? amount : 0)),
                            new XElement("CreditCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountCurrency < 0 ? amountCurrency : 0) : (customerInvoiceAccountRow.CreditRow ? amountCurrency : 0)), //TODO
                            new XElement("CreditEntCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountEntCurrency < 0 ? amountEntCurrency : 0) : (customerInvoiceAccountRow.CreditRow ? amountEntCurrency : 0)),
                            new XElement("CreditLedgerCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountLedgerCurrency < 0 ? amountLedgerCurrency : 0) : (customerInvoiceAccountRow.CreditRow ? amountLedgerCurrency : 0)),
                            new XElement("Quantity", customerInvoiceAccountRow.Quantity.HasValue ? customerInvoiceAccountRow.Quantity : 0));

                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                        {
                            if (i > accountDimInternals.Count<AccountDim>())
                            {
                                invoiceRowElement.Add(
                                    new XElement("AccountInternalNr" + i, String.Empty),
                                    new XElement("AccountInternalName" + i, String.Empty));
                                continue;
                            }

                            AccountInternal accountInternal = null;
                            var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                            if (accountDim != null)
                            {
                                accountInternal = (from ai in customerInvoiceAccountRow.AccountInternal
                                                   where ai.Account.AccountDimId == accountDim.AccountDimId
                                                   select ai).FirstOrDefault();
                            }

                            invoiceRowElement.Add(
                                new XElement("AccountInternalNr" + i, accountInternal?.Account?.AccountNr ?? string.Empty),
                                new XElement("AccountInternalName" + i, accountInternal?.Account?.Name ?? string.Empty));
                        }

                        journalElement.Add(invoiceRowElement);

                        invoiceRowXmlId++;

                        #endregion
                    }
                }

                #region Default element InvoiceRow

                if (invoiceRowXmlId == 1)
                {
                    var invoiceRowElement = new XElement("InvoiceRow",
                       new XAttribute("id", 1),
                       new XElement("AccountNr", String.Empty),
                       new XElement("AccountName", String.Empty),
                       new XElement("Debit", 0),
                       new XElement("DebitCurrency", 0),
                       new XElement("DebitEntCurrency", 0),
                       new XElement("DebitLedgerCurrency", 0),
                       new XElement("Credit", 0),
                       new XElement("CreditCurrency", 0),
                       new XElement("CreditEntCurrency", 0),
                       new XElement("CreditLedgerCurrency", 0),
                       new XElement("Quantity", 0));
                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                }

                #endregion

                #endregion
            }

            return journalElement;
        }
        private XElement CreateSupplierInvoiceJournalElement(CompEntities entities, EconomyReportParamsDTO reportParams, GetReportBalanceListItemsResult item, IEnumerable<AccountDim> accountDimInternals)
        {
            XElement journalElement = null;
            if (item == null || accountDimInternals == null)
                return journalElement;

            SupplierInvoice supplierInvoice = SupplierInvoiceManager.GetSupplierInvoice(entities, item.InvoiceId, loadInvoiceRow: true, loadInvoiceAccountRow: true);
            if (supplierInvoice != null)
            {
                #region Journal

                bool hasVoucher = item.HasVoucher ?? false;
                bool showVoucher = reportParams.SL_ShowVoucher && hasVoucher;

                journalElement = new XElement("Journal",
                    new XElement("InvoiceDate", item.InvoiceDate.HasValue ? item.InvoiceDate.Value : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("InvoiceNr", item.InvoiceNr),
                    new XElement("SeqNr", item.SeqNr.HasValue ? item.SeqNr.Value : 0),
                    new XElement("SupplierNr", item.ActorNr),
                    new XElement("SupplierName", item.ActorName),
                    new XElement("ShowVoucher", showVoucher.ToInt()),
                    new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                    new XElement("VoucherDate", item.VoucherDate.HasValue ? item.VoucherDate.Value : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("VoucherNr", item.VoucherNr.HasValue ? item.VoucherNr.Value : 0),
                    new XElement("Description", item.Description),
                    new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                    new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                    );

                int invoiceRowXmlId = 1;
                foreach (SupplierInvoiceRow supplierInvoiceRow in supplierInvoice.ActiveSupplierInvoiceRows)
                {
                    foreach (SupplierInvoiceAccountRow supplierInvoiceAccountRow in supplierInvoiceRow.SupplierInvoiceAccountRow.Where(r => r.State == (int)SoeEntityState.Active && r.Type == (int)AccountingRowType.AccountingRow))
                    {
                        #region InvoiceRow

                        if (supplierInvoiceAccountRow.State != (int)SoeEntityState.Active)
                            continue;

                        decimal amount = supplierInvoiceAccountRow.Amount;
                        decimal amountCurrency = supplierInvoiceAccountRow.AmountCurrency;
                        decimal amountEntCurrency = supplierInvoiceAccountRow.AmountEntCurrency;
                        decimal amountLedgerCurrency = supplierInvoiceAccountRow.AmountLedgerCurrency;

                        if (amount < 0)
                        {
                            amount = Decimal.Negate(amount);
                            amountCurrency = Decimal.Negate(amountCurrency);
                            amountEntCurrency = Decimal.Negate(amountEntCurrency);
                            amountLedgerCurrency = Decimal.Negate(amountLedgerCurrency);
                        }

                        var invoiceRowElement = new XElement("InvoiceRow",
                            new XAttribute("id", invoiceRowXmlId),
                            new XElement("AccountNr", supplierInvoiceAccountRow.AccountStd.Account.AccountNr),
                            new XElement("AccountName", supplierInvoiceAccountRow.AccountStd.Account.Name),
                            new XElement("Debit", supplierInvoiceAccountRow.Amount > 0 ? amount : 0),
                            new XElement("DebitCurrency", supplierInvoiceAccountRow.Amount > 0 ? amountCurrency : 0),
                            new XElement("DebitEntCurrency", supplierInvoiceAccountRow.Amount > 0 ? amountEntCurrency : 0),
                            new XElement("DebitLedgerCurrency", supplierInvoiceAccountRow.Amount > 0 ? amountLedgerCurrency : 0),
                            new XElement("Credit", supplierInvoiceAccountRow.Amount < 0 ? amount : 0),
                            new XElement("CreditCurrency", supplierInvoiceAccountRow.Amount < 0 ? amountCurrency : 0),
                            new XElement("CreditEntCurrency", supplierInvoiceAccountRow.Amount < 0 ? amountEntCurrency : 0),
                            new XElement("CreditLedgerCurrency", supplierInvoiceAccountRow.Amount < 0 ? amountLedgerCurrency : 0),
                            new XElement("Quantity", supplierInvoiceAccountRow.Quantity.HasValue ? supplierInvoiceAccountRow.Quantity : 0));

                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                        {
                            if (i > accountDimInternals.Count<AccountDim>())
                            {
                                invoiceRowElement.Add(
                                    new XElement("AccountInternalNr" + i, String.Empty),
                                    new XElement("AccountInternalName" + i, String.Empty));
                                continue;
                            }

                            AccountInternal accountInternal = null;
                            var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                            if (accountDim != null)
                            {
                                accountInternal = (from ai in supplierInvoiceAccountRow.AccountInternal
                                                   where ai.Account.AccountDimId == accountDim.AccountDimId
                                                   select ai).FirstOrDefault();
                            }

                            invoiceRowElement.Add(
                                new XElement("AccountInternalNr" + i, accountInternal?.Account?.AccountNr ?? string.Empty),
                                new XElement("AccountInternalName" + i, accountInternal?.Account?.Name ?? string.Empty));
                        }

                        journalElement.Add(invoiceRowElement);
                        invoiceRowXmlId++;

                        #endregion
                    }
                }

                #region Default element InvoiceRow

                if (invoiceRowXmlId == 1)
                {
                    var invoiceRowElement = new XElement("InvoiceRow",
                       new XAttribute("id", 1),
                       new XElement("AccountNr", String.Empty),
                       new XElement("AccountName", String.Empty),
                       new XElement("Debit", 0),
                       new XElement("DebitCurrency", 0),
                       new XElement("DebitEntCurrency", 0),
                       new XElement("DebitLedgerCurrency", 0),
                       new XElement("Credit", 0),
                       new XElement("CreditCurrency", 0),
                       new XElement("CreditEntCurrency", 0),
                       new XElement("CreditLedgerCurrency", 0),
                       new XElement("Quantity", 0));
                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                }

                #endregion

                #endregion
            }

            return journalElement;
        }

        private XElement CreatePaymentJournalElement(CompEntities entities, EconomyReportParamsDTO reportParams, GetReportBalanceListItemsResult item, SoeOriginType originType, IEnumerable<AccountDim> accountDimInternals)
        {
            XElement journalElement = null;
            if (item == null || accountDimInternals == null)
                return journalElement;

            PaymentRow paymentRow = PaymentManager.GetPaymentRow(entities, item.PaymentRowId, false, true, true);
            if (paymentRow != null && paymentRow.Status != (int)SoePaymentStatus.Cancel)
            {
                #region Journal

                bool hasVoucher = item.HasVoucher ?? false;
                bool showVoucher = reportParams.SL_ShowVoucher && hasVoucher;
                //if (item.InvoiceNr == null || paymentRow.Invoice == null)
                //{
                //    hasVoucher = item.HasVoucher.HasValue ? item.HasVoucher.Value : false;
                //}
                string actorNrLabel = "";
                string actorNameLabel = "";
                if (originType == SoeOriginType.SupplierPayment)
                {
                    actorNrLabel = "SupplierNr";
                    actorNameLabel = "SupplierName";
                    if (!paymentRow.InvoiceReference.IsLoaded)
                        paymentRow.InvoiceReference.Load();
                    journalElement = new XElement("Journal",
                        new XElement("InvoiceDate", item.InvoiceDate.HasValue ? item.InvoiceDate.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", item.PayDate), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", item.InvoiceNr + ' ' + GetText(7009, "Löpnr") + " " + paymentRow.Invoice?.SeqNr.GetValueOrDefault()),
                        new XElement("PaymentNr", item.PaymentNr), //Differ (added) from InvoiceJournal
                        new XElement("SeqNr", item.SeqNr.HasValue ? item.SeqNr.Value : 0),
                        new XElement(actorNrLabel, item.ActorNr),
                        new XElement(actorNameLabel, item.ActorName),
                        new XElement("ShowVoucher", showVoucher.ToInt()),
                        new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                        new XElement("VoucherDate", item.VoucherDate.HasValue ? item.VoucherDate.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", item.VoucherNr.HasValue ? item.VoucherNr.Value : 0),
                        new XElement("Description", item.Description),
                        new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                        new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                        );
                }
                else if (originType == SoeOriginType.CustomerPayment)
                {
                    actorNrLabel = "CustomerNr";
                    actorNameLabel = "CustomerName";

                    journalElement = new XElement("Journal",
                        new XElement("InvoiceDate", item.InvoiceDate.HasValue ? item.InvoiceDate.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", item.PayDate), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", item.InvoiceNr),
                        new XElement("PaymentNr", item.PaymentNr), //Differ (added) from InvoiceJournal
                        new XElement("SeqNr", item.SeqNr.HasValue ? item.SeqNr.Value : 0),
                        new XElement(actorNrLabel, item.ActorNr),
                        new XElement(actorNameLabel, item.ActorName),
                        new XElement("ShowVoucher", showVoucher.ToInt()),
                        new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                        new XElement("VoucherDate", item.VoucherDate.HasValue ? item.VoucherDate.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", item.VoucherNr.HasValue ? item.VoucherNr.Value : 0),
                        new XElement("Description", item.Description),
                        new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                        new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                        );
                }


                int paymentAccountRowXmlId = 1;
                foreach (PaymentAccountRow paymentAccountRow in paymentRow.ActivePaymentAccountRows)
                {
                    #region PaymentAccountRow

                    decimal amount = paymentAccountRow.Amount;
                    decimal amountCurrency = paymentAccountRow.AmountCurrency;
                    decimal amountEntCurrency = paymentAccountRow.AmountEntCurrency;
                    decimal amountLedgerCurrency = paymentAccountRow.AmountLedgerCurrency;

                    if (amount < 0)
                    {
                        amount = Decimal.Negate(amount);
                        amountCurrency = Decimal.Negate(amountCurrency);
                        amountEntCurrency = Decimal.Negate(amountEntCurrency);
                        amountLedgerCurrency = Decimal.Negate(amountLedgerCurrency);
                    }

                    var invoiceRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", paymentAccountRowXmlId),
                        new XElement("AccountNr", paymentAccountRow.AccountStd.Account.AccountNr),
                        new XElement("AccountName", paymentAccountRow.AccountStd.Account.Name),
                        new XElement("Debit", paymentAccountRow.DebitRow ? amount : 0),
                        new XElement("DebitCurrency", paymentAccountRow.DebitRow ? amountCurrency : 0),
                        new XElement("DebitEntCurrency", paymentAccountRow.DebitRow ? amountEntCurrency : 0),
                        new XElement("DebitLedgerCurrency", paymentAccountRow.DebitRow ? amountLedgerCurrency : 0),
                        new XElement("Credit", paymentAccountRow.CreditRow ? amount : 0),
                        new XElement("CreditCurrency", paymentAccountRow.CreditRow ? amountCurrency : 0),
                        new XElement("CreditEntCurrency", paymentAccountRow.CreditRow ? amountEntCurrency : 0),
                        new XElement("CreditLedgerCurrency", paymentAccountRow.CreditRow ? amountLedgerCurrency : 0),
                        new XElement("Quantity", paymentAccountRow.Quantity.HasValue ? paymentAccountRow.Quantity : 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        if (i > accountDimInternals.Count<AccountDim>())
                        {
                            invoiceRowElement.Add(
                                new XElement("AccountInternalNr" + i, String.Empty),
                                new XElement("AccountInternalName" + i, String.Empty));
                            continue;
                        }

                        AccountInternal accountInternal = null;
                        var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                        if (accountDim != null)
                        {
                            accountInternal = (from ai in paymentAccountRow.AccountInternal
                                               where ai.Account.AccountDimId == accountDim.AccountDimId
                                               select ai).FirstOrDefault();
                        }

                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, accountInternal?.Account?.AccountNr ?? string.Empty),
                            new XElement("AccountInternalName" + i, accountInternal?.Account?.Name ?? string.Empty));
                    }

                    journalElement.Add(invoiceRowElement);

                    paymentAccountRowXmlId++;

                    #endregion
                }

                #region Default element PaymentAccountRow

                if (paymentAccountRowXmlId == 1)
                {
                    var paymentAccountRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));
                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        paymentAccountRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(paymentAccountRowElement);
                }

                #endregion

                #endregion
            }

            return journalElement;
        }

        private ActionResult CreateSupplierJournalCommonContent(CompEntities entities, CreateReportResult reportResult, EconomyReportParamsDTO reportParams, XElement supplierJournalElement, SoeOriginType originType, IEnumerable<AccountDim> accountDimInternals)
        {
            //if (es == null)
            //    return new ActionResult((int)ActionResultSave.EntityIsNull, "EvaluatedSelection");
            if (supplierJournalElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #region Content

            var result = CreateBalanceListCommonContent(entities, reportResult, reportParams, supplierJournalElement, SoeOriginType.SupplierInvoice, SoeOriginType.SupplierPayment, true, true);
            if (!result.Success)
                return null;

            var items = result.Value as IEnumerable<GetReportBalanceListItemsResult>;
            if (items == null)
                items = new List<GetReportBalanceListItemsResult>().AsEnumerable();

            items = SortBalanceListInvoices(reportParams, items, originType);

            int journalCounter = 1;
            foreach (var item in items)
            {
                if (item.OriginType != (int)originType)
                    continue;

                XElement journalElement = null;
                if (originType == SoeOriginType.SupplierInvoice)
                    journalElement = CreateSupplierInvoiceJournalElement(entities, reportParams, item, accountDimInternals);
                else if (originType == SoeOriginType.SupplierPayment)
                    journalElement = CreatePaymentJournalElement(entities, reportParams, item, SoeOriginType.SupplierPayment, accountDimInternals);

                if (journalElement != null)
                {
                    journalElement.SetAttributeValue("id", journalCounter);
                    journalCounter++;

                    supplierJournalElement.Add(journalElement);
                }
            }

            #region Default element Journal/InvoiceRow/PaymentAccountRow

            if (journalCounter == 1)
            {
                if (originType == SoeOriginType.SupplierInvoice)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("InvoiceNr", 0),
                        new XElement("SupplierNr", String.Empty),
                        new XElement("SupplierName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0)
                        );

                    var invoiceRowElement = new XElement("InvoiceRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                    supplierJournalElement.Add(journalElement);
                }
                else if (originType == SoeOriginType.SupplierPayment)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", CalendarUtility.DATETIME_DEFAULT), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", 0),
                        new XElement("PaymentNr", String.Empty), //Differ (added) from InvoiceJournal
                        new XElement("SupplierNr", String.Empty),
                        new XElement("SupplierName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0)
                        );

                    var paymentAccountRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        paymentAccountRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(paymentAccountRowElement);
                    supplierJournalElement.Add(journalElement);
                }
            }

            #endregion

            #endregion

            return result;
        }

        public XDocument CreateSupplierInvoiceJournalData(CreateReportResult reportResult)
        {
            #region Prereq

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierInvoiceJournal");

            //SupplierInvoiceJournal
            XElement supplierInvoiceJournalElement = new XElement("SupplierInvoiceJournal");
            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSupplierReportHeaderLabelsElement();
            supplierInvoiceJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(reportResult, reportParams);
            supplierInvoiceJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSupplierInvoiceJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            supplierInvoiceJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateSupplierJournalCommonContent(entities, reportResult, reportParams, supplierInvoiceJournalElement, SoeOriginType.SupplierInvoice, accountDimInternals).Success)
                    return null;
            }

            #region Close document

            rootElement.Add(supplierInvoiceJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierInvoiceJournal);

            #endregion
        }

        protected string GetSupplierSortOrderText(EconomyReportParamsDTO reportParams)
        {
            return GetText(reportParams.SL_SortOrder, (int)TermGroup.ReportSupplierLedgerSortOrder);
        }
        protected XElement CreateSupplierReportHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams)
        {
            Currency currency = CountryCurrencyManager.GetCurrencyFromType(Company.ActorCompanyId, TermGroup_CurrencyType.EnterpriseCurrency);

            if (reportResult.ReportTemplateType == SoeReportTemplateType.SupplierBalanceList)
            {
                return new XElement("ReportHeader",
                        this.CreateReportTitleElement(reportResult.ReportName),
                        this.CreateReportDescriptionElement(reportResult.ReportDescription),
                        this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                        this.CreateCompanyElement(),
                        this.CreateCompanyOrgNrElement(),
                        this.CreateLoginNameElement(reportResult.LoginName),
                        new XElement("DateRegardName", this.GetLedgerDateRegardText(reportParams)),
                        new XElement("SortOrderName", this.GetSupplierSortOrderText(reportParams)),
                        new XElement("InvoiceSelectionName", this.GetLedgerInvoiceSelectionText(reportParams)),
                        new XElement("DateInterval", this.GetDateIntervalText(reportParams)),                        
                        new XElement("InvoiceInterval", this.GetLedgerInvoiceIntervalText(reportParams)),
                        new XElement("SupplierInterval", this.GetLedgerActorIntervalText(reportParams)),
                        new XElement("EntCurrencyName", currency?.Name ?? ""),
                        new XElement("EntCurrencyCode", currency?.Code ?? ""),
                        new XElement("Showpending", reportParams.SL_ShowPendingPaymentsInReport),
                        new XElement("ExportType", reportResult.ExportType),
                        new XElement("DateFrom", reportParams.DateFrom),
                        new XElement("DateTo", reportParams.DateTo));

            }
            else if (reportResult.ReportTemplateType == SoeReportTemplateType.SupplierPaymentJournal)
            {
                //      Show pending payments in betaljournal(?)
                reportParams.SL_ShowPendingPaymentsInReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.SupplierInvoiceReportShowPendingPayments, 0, reportResult.ActorCompanyId, 0);
                return new XElement("ReportHeader",
                        this.CreateReportTitleElement(reportResult.ReportName),
                        this.CreateReportDescriptionElement(reportResult.ReportDescription),
                        this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                        this.CreateCompanyElement(),
                        this.CreateCompanyOrgNrElement(),
                        this.CreateLoginNameElement(reportResult.LoginName),
                        new XElement("DateRegardName", this.GetLedgerDateRegardText(reportParams)),
                        new XElement("SortOrderName", this.GetSupplierSortOrderText(reportParams)),
                        new XElement("InvoiceSelectionName", this.GetLedgerInvoiceSelectionText(reportParams)),
                        new XElement("DateInterval", this.GetDateIntervalText(reportParams)),
                        new XElement("InvoiceInterval", this.GetLedgerInvoiceIntervalText(reportParams)),
                        new XElement("SupplierInterval", this.GetLedgerActorIntervalText(reportParams)),
                        new XElement("EntCurrencyName", currency?.Name ?? ""),
                        new XElement("EntCurrencyCode", currency?.Code ?? ""),
                        new XElement("Showpending", reportParams.SL_ShowPendingPaymentsInReport));
            }
            else
            {
                return new XElement("ReportHeader",
                      this.CreateReportTitleElement(reportResult.ReportName),
                      this.CreateReportDescriptionElement(reportResult.ReportDescription),
                      this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                      this.CreateCompanyElement(),
                      this.CreateCompanyOrgNrElement(),
                      this.CreateLoginNameElement(reportResult.LoginName),
                      new XElement("DateRegardName", this.GetLedgerDateRegardText(reportParams)),
                      new XElement("SortOrderName", this.GetSupplierSortOrderText(reportParams)),
                      new XElement("InvoiceSelectionName", this.GetLedgerInvoiceSelectionText(reportParams)),
                      new XElement("DateInterval", this.GetDateIntervalText(reportParams)),
                      new XElement("InvoiceInterval", this.GetLedgerInvoiceIntervalText(reportParams)),
                      new XElement("SupplierInterval", this.GetLedgerActorIntervalText(reportParams)),
                      new XElement("EntCurrencyName", currency?.Name ?? ""),
                      new XElement("EntCurrencyCode", currency?.Code ?? ""));
            }
        }

        protected XElement CreateTaxAuditReportHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams, XElement parent, AccountPeriod nextAccountPeriod)
        {
            DateTimeFormatInfo dtfi = new CultureInfo(Thread.CurrentThread.CurrentCulture.Name, false).DateTimeFormat;

            string taxVatPeriod = dtfi.MonthNames[reportParams.DateFrom.Month - 1] + " " + reportParams.DateFrom.Year.ToString() + " - " + dtfi.MonthNames[reportParams.DateTo.Month - 1] + " " + reportParams.DateTo.Year.ToString();
            string taxLabourPeriod = "";
            if (nextAccountPeriod != null)
                taxLabourPeriod = dtfi.MonthNames[nextAccountPeriod.From.Month - 1] + " " + nextAccountPeriod.From.Year.ToString();

            //Add 1 one month, and day 12 the month after that (16 if januari)
            DateTime taxAuditDate = reportParams.DateTo.AddMonths(2);
            taxAuditDate = new DateTime(taxAuditDate.Year, taxAuditDate.Month, taxAuditDate.Month == 1 ? 16 : 12);

            parent.Add(
                this.CreateCompanyElement(),
                new XElement("CompanyTaxSupport", Convert.ToBoolean(Company.CompanyTaxSupport).ToInt()),
                new XElement("CompanyVATNr", Company.VatNr),
                new XElement("TaxAuditDate", taxAuditDate),
                new XElement("TaxVatPeriod", taxVatPeriod),
                new XElement("TaxLabourPeriod", taxLabourPeriod));

            return parent;
        }

        public XDocument CreateTaxAudit_FI_Data(CreateReportResult reportResult)
        {
            #region Prereq

            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);


            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TaxAudit_FI");

            //TaxAudit
            XElement taxAuditElement = new XElement("TaxAudit_FI");

            #endregion

            #region ReportHeader

            DateTimeFormatInfo dtfi = new CultureInfo(Thread.CurrentThread.CurrentCulture.Name, false).DateTimeFormat;

            string taxVatPeriod = dtfi.MonthNames[reportParams.DateFrom.Month - 1] + " " + reportParams.DateFrom.Year.ToString();

            taxAuditElement.Add(
                this.CreateCompanyElement(),
                new XElement("CompanyOrgNr", Company.OrgNr),
                new XElement("TaxVatPeriod", taxVatPeriod));

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                AccountYear accountYear = AccountManager.GetAccountYear(reportParams.DateFrom, reportResult.ActorCompanyId);
                List<SysVatAccount> sysVatAccounts = SysDbCache.Instance.SysVatAccounts;
                List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(reportResult.ActorCompanyId, null, true, false);
                if (accountStds != null)
                {
                    accountStds = AccountManager.TranslateAccountNamesByLang(accountStds);
                }
                BalanceItemDTO balanceItem = new BalanceItemDTO();
                int actorCompanyId = reportResult.ActorCompanyId;
                DateTime dateFrom = reportParams.DateFrom;
                DateTime dateTo = reportParams.DateTo;
                DateTime dateToPrevMonth = reportParams.DateFrom.AddDays(-1);

                //suoritettava 24% / 25,5% vero kotimaan myynnistä
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 301),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 1, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 10, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 3, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 30, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 923, 1, reverseSign: true)));

                //suoritettava 13,5% / 14% vero kotimaan myynnistä
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 302),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 302, 1, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 302, 10, reverseSign: true)));

                //suoritettava 10%:n vero kotimaan myynnistä
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 303),
                     CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 303, 1, reverseSign: true)));

                //vero tavaroiden maahantuonnista EU:n ulkopuolelta
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 304),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 50),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 6)));

                //vero tavaraostoista muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 305),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 50),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 6)));

                //vero palveluostoista muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 306),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 50),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 6)));

                //vero rakentamispalveluiden ostoista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 318),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 10)));


                //kohdekauden vähennettävä vero
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 307),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 10)));

                //maksettava/palautettava arvonlisävero
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 308),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 301),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 302),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 303),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 304),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 305),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 306),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 318),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 307)));

                //0-verokannan alainen liikevaihto
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 309),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 309, 1, reverseSign: true)));

                //tavaroiden maahantuonnit EU:n ulkopuolelta
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 310),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 50),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 6)));

                //tavaroiden myynnit muihin EU-maihin
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 311),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 311, 1, reverseSign: true)));

                //palveluiden myynnit muihin EU-maihin
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 312),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 312, 1, reverseSign: true)));

                //tavaraostot muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 313),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 1),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 10),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 2),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 20),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 3),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 4),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 40),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 5),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 50),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 6)));

                //palveluostot muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 314),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 50),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 6)));

                //rakentamispalvelun myynnit
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 319),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 319, 1, reverseSign: true)));

                //rakentamispalvelun ostot
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 320),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 10)));

                //Käytetyt tavaran kaupan kertymä taseessa (AVL79)
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 920),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, accountYear.From, dateToPrevMonth, sysVatAccounts, accountStds, balanceItem, 920, 1, clearCache: true, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 921, 1, clearCache: true, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 922, 1, reverseSign: true)));

                //Suoritettavat verot
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 900),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 900, 1, reverseSign: true),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 900, 2, reverseSign: true),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 900, 20, reverseSign: true),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 905, 1, reverseSign: true)));

                #endregion
            }

            #region Close document

            rootElement.Add(taxAuditElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.TaxAudit_FI);

            #endregion
        }

        public XDocument CreatePeriodAccountingRegulationsReportData(CreateReportResult reportResult)
        {
            #region Prereq

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            List<GenericType> calculationTypes = base.GetTermGroupContent(TermGroup.AccountDistributionCalculationType);
            List<GenericType> triggerTypes = base.GetTermGroupContent(TermGroup.AccountDistributionTriggerType);
            List<GenericType> periodTypes = base.GetTermGroupContent(TermGroup.AccountDistributionPeriodType);
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId).ToDTOs();
            List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(reportResult.ActorCompanyId, false);
            List<AccountDistributionHeadDTO> accountDistributionHeads = AccountDistributionManager.GetAccountDistributionHeads(reportResult.ActorCompanyId, SoeAccountDistributionType.Period, false).ToDTOs(true, true, accountDimInternals).ToList();
            List<AccountDistributionHeadDTO> validaccountDistributionHeads = new List<AccountDistributionHeadDTO>();


            #region Validate Accounts

            if (reportParams.SA_HasAccountInterval)
            {

                foreach (AccountDistributionHeadDTO accountDistributionHead in accountDistributionHeads)
                {
                    //Selection AccountInterval: Continue if there is no interval, or no VoucherRow have AccountStd/AccountInternal in interval
                    bool accountsValid = AccountDistributionManager.AccountDistributionHeadContainsAccounts(accountDistributionHead, reportParams.SA_AccountIntervals, accountDimStd.AccountDimId);
                    if (!accountsValid)
                        continue;
                    validaccountDistributionHeads.Add(accountDistributionHead);
                }
                accountDistributionHeads = validaccountDistributionHeads;
            }

            #endregion

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "AccountDistributionHeadList");

            //TaxAudit
            XElement accountDistributionHeadListElement = new XElement("AccountDistributionHeadList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountDistributionHeadListReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            accountDistributionHeadListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(CreateLatestVoucherElement(reportParams));
            reportHeaderElement.Add(CreateAccountIntervalElement(am, reportResult, reportParams.SA_AccountIntervals, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateDateIntervalElement(reportParams));
            accountDistributionHeadListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateAccountDistributionHeadListPageHeaderLabelsElement(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            accountDistributionHeadListElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            foreach (var accountDistributionHead in accountDistributionHeads)
            {
                #region AccountDistributionHead

                XElement accountDistributionHeadElement = new XElement("AccountDistributionHead",
                    new XElement("Name", accountDistributionHead.Name),
                    new XElement("Description", accountDistributionHead.Description),
                    new XElement("CalculationType", calculationTypes.Where(i => i.Id == (int)accountDistributionHead.CalculationType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("StartDate", accountDistributionHead.StartDate != null ? accountDistributionHead.StartDate : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("EndDate", accountDistributionHead.EndDate != null ? accountDistributionHead.EndDate : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("DayNumber", accountDistributionHead.DayNumber),
                    new XElement("TriggerType", triggerTypes.Where(i => i.Id == (int)accountDistributionHead.TriggerType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("PeriodType", periodTypes.Where(i => i.Id == (int)accountDistributionHead.PeriodType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("PeriodValue", accountDistributionHead.PeriodValue),
                    new XElement("VoucherSerieName", accountDistributionHead.VoucherSeriesTypeId != null ? voucherSeriesTypes.Where(i => i.VoucherSeriesTypeId == accountDistributionHead.VoucherSeriesTypeId).Select(i => i.Name).FirstOrDefault() : string.Empty),
                    new XElement("UseInVoucher", accountDistributionHead.UseInVoucher.ToString()),
                    new XElement("UseInCustomerInvoice", accountDistributionHead.UseInCustomerInvoice.ToString()),
                    new XElement("UseInSupplierInvoice", accountDistributionHead.UseInSupplierInvoice.ToString()),
                    new XElement("UseInImport", accountDistributionHead.UseInImport.ToString()),
                    new XElement("Sort", accountDistributionHead.Sort),
                    new XElement("AccountDim1Expression", accountDistributionHead.Dim1Expression),
                    new XElement("AccountDim2Expression", accountDistributionHead.Dim2Expression),
                    new XElement("AccountDim3Expression", accountDistributionHead.Dim3Expression),
                    new XElement("AccountDim4Expression", accountDistributionHead.Dim4Expression),
                    new XElement("AccountDim5Expression", accountDistributionHead.Dim5Expression),
                    new XElement("AccountDim6Expression", accountDistributionHead.Dim6Expression),
                    new XElement("KeepRow", accountDistributionHead.KeepRow.ToString()),
                    new XElement("Amount", accountDistributionHead.Amount),
                    new XElement("AmountOperator", accountDistributionHead.AmountOperator));

                #endregion

                #region AccountDistributionRows

                foreach (var accountDistributionRow in accountDistributionHead.Rows)
                {
                    XElement accountDistributionRowElement = new XElement("AccountDistributionRow");

                    if (accountDistributionRow.Dim1Id == null)
                        accountDistributionRowElement.Add(
                            new XElement("AccountInternalStdNr", "*"),
                            new XElement("AccountInternalStdName", ""));
                    else
                        accountDistributionRowElement.Add(
                            new XElement("AccountInternalStdNr", accountDistributionRow.Dim1Nr),
                            new XElement("AccountInternalStdName", accountDistributionRow.Dim1Name));

                    accountDistributionRowElement.Add(
                         new XElement("AccountInternalNr1", accountDistributionRow.Dim2Nr),
                         new XElement("AccountInternalName1", accountDistributionRow.Dim2Name),
                         new XElement("AccountInternalNr2", accountDistributionRow.Dim3Nr),
                         new XElement("AccountInternalName2", accountDistributionRow.Dim3Name),
                         new XElement("AccountInternalNr3", accountDistributionRow.Dim4Nr),
                         new XElement("AccountInternalName3", accountDistributionRow.Dim4Name),
                         new XElement("AccountInternalNr4", accountDistributionRow.Dim5Nr),
                         new XElement("AccountInternalName4", accountDistributionRow.Dim5Name),
                         new XElement("AccountInternalNr5", accountDistributionRow.Dim6Nr),
                         new XElement("AccountInternalName5", accountDistributionRow.Dim6Name)
                        );

                    accountDistributionRowElement.Add(
                    new XElement("RowNumber", accountDistributionRow.RowNbr),
                    new XElement("CalculateRowNbr", accountDistributionRow.CalculateRowNbr),
                    new XElement("SameBalance", accountDistributionRow.SameBalance),
                    new XElement("OppositeBalance", accountDistributionRow.OppositeBalance),
                    new XElement("Description", accountDistributionRow.Description)
                    );

                    accountDistributionHeadElement.Add(accountDistributionRowElement);
                }

                accountDistributionHeadListElement.Add(accountDistributionHeadElement);

                #endregion
            }

            #endregion

            #region Close document

            rootElement.Add(accountDistributionHeadListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.PeriodAccountingRegulationsReport);

            #endregion
        }

		private static IEnumerable<IGrouping<string, AccountDistributionEntryRow>> GroupByAccrualAccounts(
	        IEnumerable<AccountDistributionEntryRow> entries)
		{
			return entries
				.Where(entry =>
					entry.AccountStd.AccountTypeSysTermId == (int)TermGroup_AccountType.Asset ||
					entry.AccountStd.AccountTypeSysTermId == (int)TermGroup_AccountType.Debt
				)
				.GroupBy(entry => entry.AccountStd.Account.AccountNr);
		}

		public XDocument CreatePeriodAccountingForecastReportData(CreateReportResult reportResult)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
                var am = new AccountManager(parameterObject);
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

                List<GenericType> calculationTypes = base.GetTermGroupContent(TermGroup.AccountDistributionCalculationType);
                List<GenericType> triggerTypes = base.GetTermGroupContent(TermGroup.AccountDistributionTriggerType);
                List<GenericType> registrationTypes = base.GetTermGroupContent(TermGroup.AccountDistributionRegistrationType);
                List<GenericType> periodTypes = base.GetTermGroupContent(TermGroup.AccountDistributionPeriodType);
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);
                List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId);
                List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId).ToDTOs();
                List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(reportResult.ActorCompanyId, false);

                List<AccountDistributionEntry> accountDistributionEntries = AccountDistributionManager
                    .GetAccountDistributionEntriesReportData(
						reportResult.ActorCompanyId,
                        reportParams.DateFrom.Date == CalendarUtility.DATETIME_DEFAULT
                            ? reportParams.DateFrom.AddYears(-5)
						    : reportParams.DateFrom.AddYears(-1) // can't just use dateFrom on AccountDistribution, see DevOps #117597
					).OrderBy(a => a.AccountDistributionHeadId ?? 0)
                    .ThenBy(a => (a.SourceCustomerInvoiceId, a.SourceSupplierInvoiceId, a.SourceVoucherHeadId))
                    .ThenBy(a => a.Date)
                    .ToList();

                #region Validate Accounts

                if (reportParams.SA_HasAccountInterval)
                {
				    var validaccountDistributionEntries = new List<AccountDistributionEntry>();

                    foreach (AccountDistributionEntry accountDistributionEntry in accountDistributionEntries)
                    {
                        //Selection AccountInterval: Continue if there is no interval, or no VoucherRow have AccountStd/AccountInternal in interval
                        bool accountsValid = AccountDistributionManager.AccountDistributionEntryContainsAccounts(accountDistributionEntry, reportParams.SA_AccountIntervals, accountDimStd.AccountDimId);
                        if (!accountsValid)
                            continue;
                        validaccountDistributionEntries.Add(accountDistributionEntry);
                    }
                    accountDistributionEntries = validaccountDistributionEntries;
                }

                #endregion

				var sourceDict = AccountDistributionManager.GetAccrualSourceDict(accountDistributionEntries);
				#endregion

                #region Init document

                //Document
                XDocument document = XmlUtil.CreateDocument();

                //Root
                XElement rootElement = new XElement(ROOT + "_" + "AccountDistributionEntriesList");

                XElement accountDistributionEntriesListElement = new XElement("AccountDistributionEntriesList");

                #endregion

                #region ReportHeaderLabels

                XElement reportHeaderLabelsElement = CreateAccountDistributionHeadListReportHeaderLabelsElement();
                reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
                accountDistributionEntriesListElement.Add(reportHeaderLabelsElement);
                #endregion

                #region ReportHeader

                XElement reportHeaderElement = CreateAccountingReportHeaderElement(reportResult, reportParams);
                reportHeaderElement.Add(CreateLatestVoucherElement(reportParams));
                //reportHeaderElement.Add(CreateAccountIntervalElement(am,reportResult, accountIntervals, accountDimInternalsDTOs));
                reportHeaderElement.Add(CreateAccountIntervalElement(am, reportResult, reportParams.SA_AccountIntervals, accountDimInternalsDTOs));
                reportHeaderElement.Add(CreateDateIntervalElement(reportParams));
                accountDistributionEntriesListElement.Add(reportHeaderElement);

                #endregion

                #region PageHeaderLabels

                XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
                CreateAccountDistributionHeadListPageHeaderLabelsElement(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
                accountDistributionEntriesListElement.Add(pageHeaderLabelsElement);

                #endregion

                #region Content
				int periodsExecuted = 0;
                int periodsTotal = 0;
                var accrualsSummary = new List<AccountAccruals>();
                bool hasSource = false;
				DateTime latestVoucherDate = new DateTime(1900, 1, 1);
				var accrualSource = new AccrualSource();
                var groupKey = (0,0,0);

				foreach (var ade in accountDistributionEntries)
                {
                    #region accountDistributionEntrys
                    var accrualSourceKey = new AccrualSourceKey(ade.AccountDistributionHeadId ?? 0, ade.SourceCustomerInvoiceId, ade.SourceSupplierInvoiceId, ade.SourceVoucherHeadId)
                        .ToTuple();
                    bool isNewGroup = !groupKey.Equals(accrualSourceKey);

					/* When a new Account Distribution object is encountered (isHeadIdDifferent), e.g. new invoice or voucher - reset/re-calculate given values.
					 * Also re-calculate periodsTotal & accrualsSummary.TotalAmount.
					 * */
					if (isNewGroup) {
                        groupKey = accrualSourceKey;
                        periodsExecuted = 0;
                        latestVoucherDate = new DateTime(1900, 1, 1); // Basically reset date to 0 for Crystal reports (CR). C#'s DateTime default value can't be handled by CR.
						periodsTotal = accountDistributionEntries
                            .Where(w => new AccrualSourceKey(
                                w.AccountDistributionHeadId ?? 0,
                                w.SourceCustomerInvoiceId, 
                                w.SourceSupplierInvoiceId, 
                                w.SourceVoucherHeadId).ToTuple().Equals(accrualSourceKey))
                            .Count();

						accrualsSummary = GroupByAccrualAccounts(
                            accountDistributionEntries
								.Where(w => new AccrualSourceKey(
								    w.AccountDistributionHeadId ?? 0,
								    w.SourceCustomerInvoiceId,
								    w.SourceSupplierInvoiceId,
								    w.SourceVoucherHeadId).ToTuple().Equals(accrualSourceKey))
								.SelectMany(m => m.AccountDistributionEntryRow)
						)
                        .Select(group => new AccountAccruals()
                        {
                            AccountNr = group.Key,
							PeriodAmount = 0m,
							AccumulatedAmount = 0m,
							TotalAmount = group.Sum(s => s.DebitAmount - s.CreditAmount)
                        })
                        .ToList();
					    hasSource = sourceDict.TryGetValue(accrualSourceKey, out accrualSource);
					}
					if (!(accountDistributionEntries.Any(w =>
						w.AccountDistributionHeadId == ade.AccountDistributionHeadId &&
						w.Date >= reportParams.DateFrom &&
						w.Date < reportParams.DateTo.AddDays(1))
						||
						hasSource && 
                        accrualSource.Date > new DateTime(1900,1,1) &&
						accrualSource.Date >= reportParams.DateFrom &&
						accrualSource.Date < reportParams.DateTo.AddDays(1))
                    )
                        continue;

                    bool voucherExists = ade.VoucherHeadId != null;
					List<AccountDistributionEntryRow> accountingRows = accountDistributionEntries
	                    .Where(w => 
                            new AccrualSourceKey(w.AccountDistributionHeadId ?? 0, w.SourceCustomerInvoiceId, w.SourceSupplierInvoiceId, w.SourceVoucherHeadId)
                            .ToTuple()
                            .Equals(accrualSourceKey))
	                    .SelectMany(m => m.AccountDistributionEntryRow)
	                    .ToList();
					if (voucherExists && ade.Date <= reportParams.DateTo)
					{
						periodsExecuted++;
                        latestVoucherDate = ade.Date;
					}

                    // In-place update of accrualsSummary periodAmount and accumulatedAmount, grouped by Account, using entry's rows as source.
                    var result = GroupByAccrualAccounts(ade.AccountDistributionEntryRow)
                        .Select(group => new AccountAccruals()
                        {
                            AccountNr = group.Key,
                            PeriodAmount = group.Sum(s => s.DebitAmount - s.CreditAmount)
                        })
                        .Join(
                            accrualsSummary, // Object being updated.
                            a => a.AccountNr,
                            b => b.AccountNr,
                            (a, b) =>
                            {
                                b.PeriodAmount = ade.Date < reportParams.DateFrom ? 0 : a.PeriodAmount; // New value for PeriodAmount.
                                b.AccumulatedAmount += voucherExists && ade.Date <= reportParams.DateTo ? a.PeriodAmount : 0; // Update AccumulatedAmount by adding PeriodAmount.
                                return b;
                            }
                        );
					foreach (var _ in result) {
						/* 
						    * This is just to trigger the execution, while avoiding memory allocating of ToList().
						    * No action needed here, accrualsAmount is adjusted in the Join statement, which is the sole goal of the opretaion.
                        */
					}

					if (ade.Date < reportParams.DateFrom)
						continue;

					XElement accountDistributionEntryElement = new XElement("AccountDistributionEntry",
                        new XElement("HeadId", ade.AccountDistributionHead.AccountDistributionHeadId),
                        new XElement("Name", ade.AccountDistributionHead.Name),
                        new XElement("Description", ade.AccountDistributionHead.Description),
                        new XElement("CalculationType", calculationTypes.Where(i => i.Id == ade.AccountDistributionHead.CalculationType).Select(i => i.Name).FirstOrDefault()),
                        new XElement("StartDate", ade.AccountDistributionHead.StartDate != null ? ade.AccountDistributionHead.StartDate : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("EndDate", ade.AccountDistributionHead.EndDate != null ? ade.AccountDistributionHead.EndDate : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("DayNumber", ade.AccountDistributionHead.DayNumber),
                        new XElement("TriggerType", triggerTypes.Where(i => i.Id == ade.AccountDistributionHead.TriggerType).Select(i => i.Name).FirstOrDefault()),
                        new XElement("RegistrationType", registrationTypes.Where(i => i.Id == ade.RegistrationType).Select(i => i.Name).FirstOrDefault()),
                        new XElement("PeriodType", periodTypes.Where(i => i.Id == ade.AccountDistributionHead.PeriodType).Select(i => i.Name).FirstOrDefault()),
                        new XElement("PeriodValue", ade.AccountDistributionHead.PeriodValue),
                        new XElement("VoucherSerieName", ade.AccountDistributionHead.VoucherSeriesTypeId != null ? voucherSeriesTypes.Where(i => i.VoucherSeriesTypeId == ade.AccountDistributionHead.VoucherSeriesTypeId).Select(i => i.Name).FirstOrDefault() : string.Empty),
                        new XElement("UseInVoucher", ade.AccountDistributionHead.UseInVoucher.ToString()),
                        new XElement("UseInCustomerInvoice", ade.AccountDistributionHead.UseInCustomerInvoice.ToString()),
                        new XElement("UseInSupplierInvoice", ade.AccountDistributionHead.UseInSupplierInvoice.ToString()),
                        new XElement("UseInImport", ade.AccountDistributionHead.UseInImport.ToString()),
                        new XElement("Sort", ade.AccountDistributionHead.Sort),
                        new XElement("KeepRow", ade.AccountDistributionHead.KeepRow.ToString()),
                        new XElement("Amount", ade.AccountDistributionHead.Amount),
                        new XElement("AmountOperator", ade.AccountDistributionHead.AmountOperator),
                        new XElement("VoucherNr", ade.VoucherHeadId != null ? ade.VoucherHead.VoucherNr : 0),
                        new XElement("Date", ade.Date),
						new XElement("LatestVoucherDate", latestVoucherDate),
						new XElement("PeriodsExecuted", periodsExecuted),
						new XElement("PeriodsRemaining", periodsTotal - periodsExecuted),
                        new XElement("SourceVoucherDate", hasSource ? accrualSource.Date : new DateTime(1900,1,1)),
                        new XElement("SourceSeqNr", hasSource ? accrualSource.SeqNr.ToString() : "")
                        ,new XElement("GroupId", hasSource ? sourceDict.Comparer.GetHashCode(accrualSourceKey) : ade.AccountDistributionHeadId)
					);

                    foreach (var summary in accrualsSummary)
                    {
                        XElement accrualsSummaryElement = new XElement("AccrualsSummary",
                            new XElement("AccountNr", summary.AccountNr),
                            new XElement("PeriodAmount", summary.PeriodAmount),
                            new XElement("AccumulatedAmount", summary.AccumulatedAmount),
                            new XElement("TotalAmount", summary.TotalAmount)
                        );
                        accountDistributionEntryElement.Add(accrualsSummaryElement);
                    };

					#endregion

					#region accountDistributionEntryRows

					foreach (var accountDistributionEntryRow in ade.AccountDistributionEntryRow)
                    {
                        if (accountDistributionEntryRow.CreditAmount != 0)
                        {
                            XElement accountDistributionEntryRowElement = new XElement("AccountDistributionEntryRow",
                                new XElement("CreditRowAccountNr", accountDistributionEntryRow.AccountStd.Account.AccountNr),
                                new XElement("CreditRowAccountName", accountDistributionEntryRow.AccountStd.Account.Name),
                                new XElement("CreditAmount", accountDistributionEntryRow.CreditAmount),
                                new XElement("DebitRowAccountNr", string.Empty),
                                new XElement("DebitRowAccountName", string.Empty),
                                new XElement("DebitAmount", 0)
                            );

                            var counter = 1;
                            foreach (var internalAccount in accountDistributionEntryRow.AccountInternal.OrderBy(i => i.Account.AccountDim.AccountDimNr))
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, internalAccount.Account.AccountNr));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, internalAccount.Account.Name));
                                counter++;
                            }

                            while (counter < 7)
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, String.Empty));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, String.Empty));
                                counter++;
                            }

                            accountDistributionEntryElement.Add(accountDistributionEntryRowElement);
                        }
                        else
                        {
                            XElement accountDistributionEntryRowElement = new XElement("AccountDistributionEntryRow",
                                new XElement("CreditRowAccountNr", string.Empty),
                                new XElement("CreditRowAccountName", string.Empty),
                                new XElement("CreditAmount", 0),
                                new XElement("DebitRowAccountNr", accountDistributionEntryRow.AccountStd.Account.AccountNr),
                                new XElement("DebitRowAccountName", accountDistributionEntryRow.AccountStd.Account.Name),
                                new XElement("DebitAmount", accountDistributionEntryRow.DebitAmount)
                            );

                            var counter = 1;
                            foreach (var internalAccount in accountDistributionEntryRow.AccountInternal.OrderBy(i => i.Account.AccountDim.AccountDimNr))
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, internalAccount.Account.AccountNr));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, internalAccount.Account.Name));
                                counter++;
                            }

                            while (counter < 7)
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, String.Empty));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, String.Empty));
                                counter++;
                            }

                            accountDistributionEntryElement.Add(accountDistributionEntryRowElement);
                        }
                    }
                    #endregion

                    accountDistributionEntriesListElement.Add(accountDistributionEntryElement);
                }

                #endregion

                #region Close document

                rootElement.Add(accountDistributionEntriesListElement);
                document.Add(rootElement);

                return GetValidatedDocument(document, SoeReportTemplateType.PeriodAccountingForecastReport);

                #endregion
            }
        }


        public XDocument CreateTaxAuditData(CreateReportResult reportResult, out string createVoucherError)
        {
            #region Prereq
            createVoucherError = null;
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            AccountPeriod nextAccountPeriod = AccountManager.GetNextAccountPeriod(reportParams.DateTo, reportResult.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TaxAudit");

            //TaxAudit
            XElement taxAuditElement = new XElement("TaxAudit");


            #endregion

            #region ReportHeader

            CreateTaxAuditReportHeaderElement(reportResult, reportParams, taxAuditElement, nextAccountPeriod);

            #endregion

            using (var entities = new CompEntities())
            {
                #region Content

                entities.CommandTimeout = 180; // 3 minutes

                List<SysVatAccount> sysVatAccounts = SysDbCache.Instance.SysVatAccounts;
                List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(reportResult.ActorCompanyId, null, true, false);
                if (accountStds != null)
                {
                    accountStds = AccountManager.TranslateAccountNamesByLang(accountStds); // 2015-03-16 / Jukka - Translate account names for the names for which current translation exists
                }
                List<AccountYear> accountYears = AccountManager.GetAccountYears(reportResult.ActorCompanyId, false, reportParams.DateFrom, reportParams.DateTo);

                taxAuditElement.Add(new XElement("Output02", Company.OrgNr));
                taxAuditElement.Add(new XElement("Output05", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 05, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output06", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 06, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output07", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 07, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output08", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 08, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output10", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 10, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output11", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 11, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output12", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 12, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output20", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 20, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output21", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 21, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output22", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 22, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output23", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 23, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output24", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 24, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output30", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 30, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output31", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 31, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output32", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 32, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output35", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 35, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output36", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 36, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output37", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 37, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output38", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 38, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output39", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 39, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output40", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 40, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output41", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 41, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output42", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 42, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output48", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 48, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output50", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 50, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output51", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 51, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output52", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 52, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output55", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 55, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output57", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 57, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output59", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 59, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output81", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 81, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output82", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 82, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output83", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 83, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output84", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 84, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output85", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 85, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output86", nextAccountPeriod != null ? AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 86, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("OutputI50", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 50, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));
                taxAuditElement.Add(new XElement("OutputI60", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 60, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));
                taxAuditElement.Add(new XElement("OutputI61", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 61, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));
                taxAuditElement.Add(new XElement("OutputI62", AccountBalanceManager(reportResult.ActorCompanyId).GetBalanceChangeForVatAccount(entities, reportResult.ActorCompanyId, 62, accountYears, reportParams.DateFrom, reportParams.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));

                #endregion
            }

            #region Close document

            rootElement.Add(taxAuditElement);
            document.Add(rootElement);

            #endregion

            #region Create Vat Voucher

            if (reportParams.SSTD_CreateVatVoucher)
            {
                var createResult = VoucherManager.CreateVatVoucher(reportParams.DateFrom, reportParams.DateTo.Date, reportResult.ActorCompanyId);
                createVoucherError = createResult.Success ? "" : createResult.ErrorMessage;
            }

            #endregion

            return GetValidatedDocument(document, SoeReportTemplateType.TaxAudit);
        }


        public XDocument CreateSruReportData(CreateReportResult reportResult)
        {


            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SruReport");

            //ResultReport
            XElement sruReport = new XElement("SruReport");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonData(reportResult, sruReport).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(sruReport);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SruReport);

            #endregion
        }


        public XDocument CreateSupplierBalanceListData(CreateReportResult reportResult)
        {

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierBalanceList");

            //SupplierBalanceList
            XElement supplierBalanceListElement = new XElement("SupplierBalanceList");

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSupplierReportHeaderLabelsElement();
            supplierBalanceListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(reportResult, reportParams);
            supplierBalanceListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSupplierBalanceListPageHeaderLabelsElement(pageHeaderLabelsElement);
            supplierBalanceListElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                if (!CreateBalanceListCommonContent(entities, reportResult, reportParams, supplierBalanceListElement, SoeOriginType.SupplierInvoice, SoeOriginType.SupplierPayment, false, false).Success)
                    return null;

                #endregion
            }

            #region Close document

            rootElement.Add(supplierBalanceListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierBalanceList);

            #endregion
        }

        public XDocument CreateCustomerBalanceListData(CreateReportResult reportResult)
        {

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerBalanceList");

            //CustomerBalanceList
            XElement customerBalanceListElement = new XElement("CustomerBalanceList");
            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            // Default is excluding cash sales invoices. However, to get a correct balance list we cannot exclude those.
            // Consider scenario where a customer pays the invoice in the store after receiving the invoice.
            reportParams.SL_IncludeCashSalesInvoices = true;  


            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateCustomerReportHeaderLabelsElement();
            customerBalanceListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(new XElement("ExportType", reportResult.ExportType));

            customerBalanceListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateCustomerBalanceListPageHeaderLabelsElement(pageHeaderLabelsElement);
            customerBalanceListElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                if (!CreateBalanceListCommonContent(entities, reportResult, reportParams, customerBalanceListElement, SoeOriginType.CustomerInvoice, SoeOriginType.CustomerPayment, true, false).Success)
                    return null;

                #endregion
            }

            #region Close document

            rootElement.Add(customerBalanceListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerBalanceList);

            #endregion
        }

        private ActionResult CreateBalanceListCommonContent(CompEntities entities, CreateReportResult reportResult, EconomyReportParamsDTO reportParams, XElement balanceListElement, SoeOriginType soeOriginTypeInvoice, SoeOriginType soeOriginTypePayment, bool includeHouseholdTaxDeduction, bool journal)
        {
            ActionResult result = new ActionResult(true);

            if (balanceListElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #region Content

            // Increase the command timeout
            entities.CommandTimeout = 180; // 3 minutes

            //Get all items from selection
            var items = GetBalanceListItems(entities, reportResult, reportParams, soeOriginTypeInvoice, soeOriginTypePayment, journal);

            //Current Group holders
            GetReportBalanceListItemsResult currentGroupInvoice = null;
            XElement groupElement = null;
            int groupXmlId = 0;
            int originXmlId = 0;
            int actionId = 0;

            var invoiceItems = SortBalanceListInvoices(reportParams, items, soeOriginTypeInvoice);
            var paymentMethodCache = new Dictionary<int, PaymentMethod>();

            foreach (var invoiceItem in invoiceItems)
            {
                if (!reportParams.SL_IncludeCashSalesInvoices && invoiceItem.IsCashSale)
                {
                    continue;
                }
                // Dont print Invoices with OnlyPayment as a Action
                if (invoiceItem.OnlyPayment)
                {
                    continue;
                }
                #region Group

                DateTime groupDate = CalendarUtility.DATETIME_DEFAULT;

                //Check if group should be created
                if (groupElement == null || CheckNewBalanceListGroup(reportParams, currentGroupInvoice, invoiceItem, groupXmlId))
                {
                    //Add group before create new
                    if (groupElement != null)
                    {
                        balanceListElement.Add(groupElement);
                    }

                    //Supplier
                    string actorNr = "";
                    string actorName = "";

                    if (reportParams.SL_SortOrder == (int)SoeReportSortOrder.ActorNr || reportParams.SL_SortOrder == (int)SoeReportSortOrder.ActorName)
                    {
                        actorNr = invoiceItem.ActorNr;
                        actorName = invoiceItem.ActorName;
                    }
                    else if (reportParams.SL_SortOrder == (int)SoeReportSortOrder.Date)
                    {
                        if (reportParams.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.InvoiceDate && invoiceItem.InvoiceDate.HasValue)
                            groupDate = invoiceItem.InvoiceDate.Value;
                        else if (reportParams.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.VoucherDate && invoiceItem.VoucherDate.HasValue)
                            groupDate = invoiceItem.VoucherDate.Value;
                        else if (reportParams.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.DueDate && invoiceItem.DueDate.HasValue)
                            groupDate = invoiceItem.DueDate.Value;
                        else if (reportParams.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.PaymentDate && invoiceItem.PayDate.HasValue)
                            groupDate = invoiceItem.PayDate.Value;
                    }

                    currentGroupInvoice = invoiceItem;
                    groupXmlId++;
                    originXmlId = 0; //reset

                    string actorNrLabel = "";
                    string actorNameLabel = "";
                    if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                    {
                        actorNrLabel = "GroupSupplierNr";
                        actorNameLabel = "GroupSupplierName";
                    }
                    else if (soeOriginTypeInvoice == SoeOriginType.CustomerInvoice)
                    {
                        actorNrLabel = "GroupCustomerNr";
                        actorNameLabel = "GroupCustomerName";
                    }

                    groupElement = new XElement("Group",
                        new XAttribute("id", groupXmlId),
                        new XElement("GroupSumLabel", GetReportText(34, "Summa")),
                        new XElement("GroupType", reportParams.SL_SortOrder),
                        new XElement(actorNrLabel, actorNr),
                        new XElement(actorNameLabel, actorName),
                        new XElement("GroupDate", groupDate),
                        new XElement("GroupDateType", reportParams.SL_DateRegard));
                }

                #endregion

                #region Invoice

                #region Origin (identifier in group)

                DateTime originDate = invoiceItem.InvoiceDate.HasValue ? invoiceItem.InvoiceDate.Value : DateTime.Now; //default
                if (reportParams.SL_SortOrder == (int)SoeReportSortOrder.Date)
                    originDate = groupDate;

                var paymentSuggestionItem = items.FirstOrDefault(r => r.InvoiceId == invoiceItem.InvoiceId && r.OriginType == (int)SoeOriginType.SupplierPayment);

                string projectNumber = "";
                string projectName = "";
                string workSiteKey = "";
                string workSiteNumber = "";
                bool originFullyPaid = false;

                if (invoiceItem.ProjectId > 0)
                {
                    Project project = ProjectManager.GetProject(invoiceItem.ProjectId, false);
                    if (project != null)
                    {
                        projectNumber = project.Number;
                        projectName = project.Name;
                        workSiteKey = project.WorkSiteKey;
                        workSiteNumber = project.WorkSiteNumber;
                    }
                }

                originXmlId++;
                actionId = 0; //reset
                XElement originElement = new XElement("Origin",
                    new XAttribute("id", originXmlId),
                    new XElement("OriginInvoiceNr", invoiceItem.InvoiceNr),
                    new XElement("OriginInvoiceSeqNr", invoiceItem.SeqNr.HasValue ? invoiceItem.SeqNr.Value : 0),
                    new XElement("PaymentSuggestionNr", paymentSuggestionItem != null ? paymentSuggestionItem.SequenceNumber : 0),
                    new XElement("OriginFullyPayed", invoiceItem.FullyPayed),
                    new XElement("OriginInvoiceId", invoiceItem.InvoiceId),
                    new XElement("OriginDate", originDate),
                    new XElement("IsMatched", invoiceItem.IsMatched.ToInt()),
                    new XElement("IsMatchedAgainstInvoice", invoiceItem.IsMatchedAgainstInvoice.ToInt()),
                    new XElement("IsMatchedAgainstPayment", invoiceItem.IsMatchedAgainstPayment.ToInt()),
                    new XElement("MatchedNr", invoiceItem.MatchedNr),
                    new XElement("ProjectNumber", projectNumber),
                    new XElement("ProjectName", projectName),
                    new XElement("WorkSiteKey", workSiteKey),
                    new XElement("WorkSiteNumber", workSiteNumber),
                    new XElement("Description", invoiceItem.Description));

                #endregion

                #region Action (invoice)

                //Dont print Invoices with OnlyPayment as a Action
                if (!invoiceItem.OnlyPayment)
                {
                    //Add action to origin
                    actionId++;
                    originElement.Add(CreateBalanceListAction(entities, reportResult, reportParams, invoiceItem, actionId, soeOriginTypeInvoice, soeOriginTypePayment, includeHouseholdTaxDeduction, paymentMethodCache));
                }

                #endregion

                #endregion

                #region Payments

                var paymentItems = (from i in items
                                    where ((i.OriginType == (int)soeOriginTypePayment) &&
                                    (i.InvoiceId == invoiceItem.InvoiceId) &&
                                    (i.InvoiceNr == invoiceItem.InvoiceNr))
                                    orderby i.PayDate, i.SeqNr
                                    select i).ToList();

                foreach (var paymentItem in paymentItems)
                {
                    #region Action (payment)

                    if (paymentItem.OriginType != (int)SoeOriginType.SupplierPayment && (!paymentItem.PayDate.HasValue || (paymentItem.PayDate > reportParams.DateTo)))
                        continue;

                    paymentItem.FullyPayed = invoiceItem.FullyPayed;

                    //Add action to origin
                    actionId++;
                    originElement.Add(CreateBalanceListAction(entities, reportResult, reportParams, paymentItem, actionId, soeOriginTypeInvoice, soeOriginTypePayment, includeHouseholdTaxDeduction, paymentMethodCache));

                    #endregion
                }

                //Add origin to group
                if (!originFullyPaid)
                    groupElement.Add(originElement);

                #endregion
            }

            //Add last group
            if (groupElement != null)
            {
                balanceListElement.Add(groupElement);
            }

            #region Default element Group/Origin/Action

            if (groupXmlId == 0)
            {
                groupElement = new XElement("Group",
                    new XAttribute("id", 1));
                XElement originElement = new XElement("Origin",
                    new XAttribute("id", 1));
                XElement actionElement = new XElement("Action",
                    new XAttribute("id", 1));

                originElement.Add(actionElement);
                groupElement.Add(originElement);
                balanceListElement.Add(groupElement);
            }

            #endregion

            #endregion

            result.Success = true;
            result.Value = items;

            return result;
        }

        private XElement CreateBalanceListAction(CompEntities entities, CreateReportResult reportResult, EconomyReportParamsDTO reportParams, GetReportBalanceListItemsResult item, int actionXmlId, SoeOriginType soeOriginTypeInvoice, SoeOriginType soeOriginTypePayment, bool includeHouseholdTaxDeduction, Dictionary<int, PaymentMethod> paymentMethodCache)
        {
            bool isCustomerInvoice = soeOriginTypeInvoice == SoeOriginType.CustomerInvoice;
            bool isSupplierInvoice = soeOriginTypeInvoice == SoeOriginType.SupplierInvoice;
            bool hasVoucher = item.HasVoucher == true;
            bool showVoucher = reportParams.SL_ShowVoucher && hasVoucher;

            Currency baseCurrency = CountryCurrencyManager.GetCurrencyFromType(reportResult.ActorCompanyId, TermGroup_CurrencyType.TransactionCurrency);
            Currency ledgerCurrency = CountryCurrencyManager.GetCurrencyWithCode(item.ActorCurrencyId);

            //ActionAmount should be zero if a invoice is fully payed (see above) and a negative value if it is a payment
            decimal actionAmount = 0;
            decimal actionAmountCurrency = 0;
            decimal actionAmountEntCurrency = 0;
            decimal actionAmountLedgerCurrency = 0;

            PaymentMethod paymentMethod = null;
            paymentMethodCache.TryGetValue(item.PaymentMethodId, out paymentMethod);
            if (item.PaymentMethodId > 0 && paymentMethod == null)
            {
                paymentMethod = PaymentManager.GetPaymentMethod(item.PaymentMethodId, reportResult.ActorCompanyId, false);
                if (paymentMethod != null)
                {
                    paymentMethodCache.Add(paymentMethod.PaymentMethodId, paymentMethod);
                }
            }

            PaymentInformationRow mtdPaymentInformationRow = paymentMethod?.PaymentInformationRow;


            if (!item.FullyPayed)
            {
                if (item.OriginType == (int)soeOriginTypePayment)
                {
                    actionAmount = decimal.Negate(item.PaymentAmount);
                    actionAmountCurrency = decimal.Negate(item.PaymentAmountCurrency);
                    actionAmountEntCurrency = decimal.Negate(item.PaymentAmountEntCurrency);
                    actionAmountLedgerCurrency = decimal.Negate(item.PaymentAmountLedgerCurrency);
                }
                else
                {
                    actionAmount = item.InvoiceTotalAmount;
                    actionAmountCurrency = item.InvoiceTotalAmountCurrency;
                    actionAmountEntCurrency = item.InvoiceTotalAmountEntCurrency;
                    actionAmountLedgerCurrency = item.InvoiceTotalAmountLedgerCurrency;
                }
            }

            XElement actionElement = new XElement("Action",
                new XAttribute("id", actionXmlId),
                new XElement("ActionType", item.OriginType), //SupplierInvoice, CustomerInvoice or Payment
                new XElement("ActionShowVoucher", showVoucher.ToInt()),
                new XElement("ActionAmount", actionAmount),
                new XElement("ActionAmountCurrency", actionAmountCurrency),
                new XElement("ActionAmountEntCurrency", actionAmountEntCurrency),
                new XElement("ActionAmountLedgerCurrency", actionAmountLedgerCurrency),
                new XElement(isCustomerInvoice ? "ActionCustomerName" : "ActionSupplierName", item.ActorName));

            if (isSupplierInvoice)
            {
                PaymentInformationRow paymentInformationRow = PaymentManager.GetPaymentInformationRowForActor(entities, item.ActorId.GetValueOrDefault(),item.PaymentNr);
                actionElement.Add(
                   new XElement("ActionSupplierNr", item.ActorNr),
                   new XElement("ActionInvoiceReferenceOur", item.ReferenceOur),
                   new XElement("ActionPaymentmethodBIC", mtdPaymentInformationRow?.BIC ?? string.Empty),
                   new XElement("ActionPaymentmethodPaymentNr", mtdPaymentInformationRow?.PaymentNr ?? string.Empty),
                   new XElement("ActionPaymentSeqNr", item.SeqNr.HasValue ? item.SeqNr.Value : 0),
                   new XElement("ActionPaymentBIC", paymentInformationRow?.BIC ?? string.Empty),
                   new XElement("ActionPaymentNr", item.PaymentNr));
            }

            actionElement.Add(
                new XElement("ActionBatchId", hasVoucher && item.VoucherHeadId.HasValue ? item.VoucherHeadId.Value : 0),
                new XElement("ActionBatchUser", hasVoucher ? item.VoucherCreatedBy : ""),
                new XElement("ActionAccountYear", item.AccountYearFrom.ToString("yyyyMM") + "-" + item.AccountYearTo.ToString("yyyyMM")),
                new XElement("ActionVoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                new XElement("ActionVoucherDate", item.VoucherDate.HasValue ? item.VoucherDate.Value : CalendarUtility.DATETIME_DEFAULT),
                new XElement("ActionVoucherNr", item.VoucherNr.HasValue ? item.VoucherNr.Value : 0),
                //Invoice
                new XElement("ActionInvoiceBillingType", item.BillingTypeName),
                new XElement("ActionInvoiceSeqNr", item.SeqNr.HasValue ? item.SeqNr.Value : 0), //Should always have value. Only Drafts have null SeqNr, and Drafts should not be included in any reports
                new XElement("ActionInvoiceDate", item.InvoiceDate.HasValue ? item.InvoiceDate.Value : CalendarUtility.DATETIME_DEFAULT),
                new XElement("ActionInvoiceDueDate", item.DueDate.HasValue ? item.DueDate.Value : CalendarUtility.DATETIME_DEFAULT),
                new XElement("ActionInvoiceNr", item.InvoiceNr),
                new XElement("ActionInvoiceOcr", item.InvoiceOCR),
                new XElement("ActionInvoiceTotalAmount", item.InvoiceTotalAmount),
                new XElement("ActionInvoiceTotalAmountCurrency", item.InvoiceTotalAmountCurrency),
                new XElement("ActionInvoiceVATAmount", item.InvoiceVATAmount));

            actionElement.Add(
                 new XElement("ActionInvoiceCurrency", item.CurrencyCode),
                 new XElement("ActionInvoiceCurrencyRate", item.CurrencyRate),
                 new XElement("ActionInvoiceTotalAmountEntCurrency", item.InvoiceTotalAmountEntCurrency),
                 new XElement("ActionInvoiceTotalAmountLedgerCurrency", item.InvoiceTotalAmountLedgerCurrency),
                 new XElement("ActionInvoiceVatType", item.VatType),
                 new XElement("ActionInvoiceId", item.InvoiceId),
                 //Payment
                 new XElement("ActionPaymentDate", item.PayDate.HasValue ? item.PayDate.Value : CalendarUtility.DATETIME_DEFAULT),
                 new XElement("ActionPaymentAmount", item.PaymentAmount),
                 new XElement("ActionPaymentAmountCurrency", item.PaymentAmountCurrency),
                 new XElement("ActionPaymentCurrency", item.CurrencyCode),
                 new XElement("ActionPaymentCurrencyRate", item.CurrencyRate),
                 new XElement("ActionPaymentAmountEntCurrency", item.PaymentAmountEntCurrency),
                 new XElement("ActionPaymentAmountLedgerCurrency", item.PaymentAmountLedgerCurrency),
                 new XElement("ActionPaymentmethod", item.PaymentMethodName),
                 new XElement("ActionCurrencyName", baseCurrency != null ? baseCurrency.Name : ""),
                 new XElement("ActionCurrencyCode", baseCurrency != null ? baseCurrency.Code : ""),
                 new XElement("ActionLedgerCurrencyName", ledgerCurrency != null ? ledgerCurrency.Name : ""),
                 new XElement("ActionLedgerCurrencyCode", ledgerCurrency != null ? ledgerCurrency.Code : ""));

            if (isSupplierInvoice)
            {
                actionElement.Add(
                new XElement("ActionInvoiceTimeDiscountDate", item.TimeDiscountDate.HasValue ? item.TimeDiscountDate.Value : CalendarUtility.DATETIME_DEFAULT),
                new XElement("ActionInvoiceTimeDiscountPercent", item.TimeDiscountPercent != null ? item.TimeDiscountPercent : 0),
                new XElement("ActionPaymentIsSuggestion", item.PaymentIsSuggestion.ToInt()));
            }

            if (soeOriginTypeInvoice == SoeOriginType.CustomerInvoice)
            {
                actionElement.Add(
                    new XElement("ActionInvoiceCentRounding", item.InvoiceCentRounding));
            }

            if (isCustomerInvoice && includeHouseholdTaxDeduction && item.HasHouseholdTaxDeduction)
            {
                int householdTaxDeductionRowXmlId = 1;
                List<HouseholdTaxDeductionRow> householdTaxDeductionRows = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRows(item.InvoiceId);
                foreach (HouseholdTaxDeductionRow householdTaxDeductionRow in householdTaxDeductionRows)
                {
                    actionElement.Add(new XElement("HouseholdTaxDeductionRow",
                        new XAttribute("id", householdTaxDeductionRowXmlId),
                        new XElement("CustomerInvoiceId", item.InvoiceId),
                        new XElement("Property", householdTaxDeductionRow.Property),
                        new XElement("ApartmentNr", householdTaxDeductionRow.ApartmentNr),
                        new XElement("CooperativeOrgNr", householdTaxDeductionRow.CooperativeOrgNr),
                        new XElement("SocialSecNr", householdTaxDeductionRow.SocialSecNr),
                        new XElement("Name", householdTaxDeductionRow.Name),
                        new XElement("Amount", householdTaxDeductionRow.Amount),
                        new XElement("AmountCurrency", householdTaxDeductionRow.AmountCurrency),
                        new XElement("AmountEntCurrency", householdTaxDeductionRow.AmountEntCurrency),
                        new XElement("AmountLedgerCurrency", householdTaxDeductionRow.AmountLedgerCurrency),
                        new XElement("SequenceNumber", householdTaxDeductionRow.SeqNr),
                        new XElement("Applied", householdTaxDeductionRow.Applied.ToInt()),
                        new XElement("AppliedDate", householdTaxDeductionRow.AppliedDate.HasValue ? householdTaxDeductionRow.AppliedDate.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("Received", householdTaxDeductionRow.Received.ToInt()),
                        new XElement("ReceivedDate", householdTaxDeductionRow.ReceivedDate.HasValue ? householdTaxDeductionRow.ReceivedDate.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("Denied", householdTaxDeductionRow.Denied.ToInt()),
                        new XElement("DeniedDate", householdTaxDeductionRow.DeniedDate.HasValue ? householdTaxDeductionRow.DeniedDate.Value : CalendarUtility.DATETIME_DEFAULT)));

                    householdTaxDeductionRowXmlId++;
                }
            }

            return actionElement;
        }

        private bool CheckNewBalanceListGroup(EconomyReportParamsDTO reportParams, GetReportBalanceListItemsResult currentGroupInvoice, GetReportBalanceListItemsResult newInvoice, int groupId)
        {
            bool result = false;

            switch (reportParams.SL_SortOrder)
            {
                case (int)SoeReportSortOrder.SeqNr:
                    #region SeqNr

                    result = groupId == 0;
                    break;

                #endregion
                case (int)SoeReportSortOrder.Date:
                    #region Date

                    switch (reportParams.SL_DateRegard)
                    {
                        case (int)TermGroup_ReportLedgerDateRegard.InvoiceDate:
                            result = newInvoice.InvoiceDate > currentGroupInvoice.InvoiceDate;
                            break;
                        case (int)TermGroup_ReportLedgerDateRegard.VoucherDate:
                            result = newInvoice.VoucherDate > currentGroupInvoice.VoucherDate;
                            break;
                        case (int)TermGroup_ReportLedgerDateRegard.DueDate:
                            result = newInvoice.DueDate > currentGroupInvoice.DueDate;
                            break;
                        case (int)TermGroup_ReportLedgerDateRegard.PaymentDate:
                            result = newInvoice.PayDate > currentGroupInvoice.PayDate;
                            break;
                    }
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorNr:
                    #region ActorNr

                    result = newInvoice.ActorNr != currentGroupInvoice.ActorNr;
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorName:
                    #region ActorName

                    result = newInvoice.ActorName != currentGroupInvoice.ActorName;
                    break;

                    #endregion
            }

            return result;
        }

        private List<GetReportBalanceListItemsResult> SortBalanceListInvoices(EconomyReportParamsDTO reportParams, IEnumerable<GetReportBalanceListItemsResult> items, SoeOriginType soeOriginTypeInvoice)
        {
            List<GetReportBalanceListItemsResult> invoiceItems = new List<GetReportBalanceListItemsResult>();

            int invoiceType = (int)soeOriginTypeInvoice;

            int paymentType = (int)SoeOriginType.CustomerPayment;
            if (invoiceType == (int)SoeOriginType.SupplierInvoice)
                paymentType = (int)SoeOriginType.SupplierPayment;


            //Sort invoices according to given SortOrder
            switch (reportParams.SL_SortOrder)
            {
                case (int)SoeReportSortOrder.SeqNr:
                    #region SeqNr

                    invoiceItems = (from i in items
                                    where i.OriginType == invoiceType ||
                                    (i.OriginType == paymentType && i.OnlyPayment)
                                    orderby i.SeqNr ascending
                                    select i).ToList();
                    break;

                #endregion
                case (int)SoeReportSortOrder.Date:
                    #region Date

                    //Sort invoices according to given DateType
                    switch (reportParams.SL_DateRegard)
                    {
                        case (int)TermGroup_ReportLedgerDateRegard.InvoiceDate:
                            #region InvoiceDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.InvoiceDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                        #endregion
                        case (int)TermGroup_ReportLedgerDateRegard.VoucherDate:
                            #region VoucherDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.VoucherDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                        #endregion
                        case (int)TermGroup_ReportLedgerDateRegard.DueDate:
                            #region DueDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.DueDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                        #endregion
                        case (int)TermGroup_ReportLedgerDateRegard.PaymentDate:
                            #region PaymentDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.PayDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                            #endregion
                    }
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorNr:
                    #region ActorNr

                    invoiceItems = (from i in items
                                    where i.OriginType == invoiceType ||
                                    (i.OriginType == paymentType && i.OnlyPayment)
                                    orderby i.ActorNr ascending, i.SeqNr ascending
                                    select i).ToList();
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorName:
                    #region ActorName

                    invoiceItems = (from i in items
                                    where i.OriginType == invoiceType ||
                                    (i.OriginType == paymentType && i.OnlyPayment)
                                    orderby i.ActorName ascending, i.SeqNr ascending
                                    select i).ToList();
                    break;
                    #endregion
            }

            return invoiceItems;
        }

        private List<GetReportBalanceListItemsResult> GetBalanceListItems(CompEntities entities, CreateReportResult reportResult, EconomyReportParamsDTO reportParams, SoeOriginType soeOriginTypeInvoice, SoeOriginType soeOriginTypePayment, bool journal)
        {
            List<GetReportBalanceListItemsResult> evaluatedItems = new List<GetReportBalanceListItemsResult>();

            #region Prereq

            int invoiceType = (int)soeOriginTypeInvoice;
            int paymentType = (int)soeOriginTypePayment;
            bool showPending = false;
            DateTime reconciliationDateFrom = CalendarUtility.GetFirstDateOfMonth(DateTime.Now);
            DateTime reconciliationDateTo = CalendarUtility.GetLastDateOfMonth(DateTime.Now);
            if (reportParams.DateTo.Year != 9999)
            {
                reconciliationDateFrom = CalendarUtility.GetFirstDateOfMonth(reportParams.DateTo);
                reconciliationDateTo = CalendarUtility.GetLastDateOfMonth(reportParams.DateTo);
                reconciliationDateTo = CalendarUtility.GetEndOfDay(reconciliationDateTo);
            }
            if (reportParams.DateFrom.Year != 1753)
            {
                reconciliationDateFrom = CalendarUtility.GetFirstDateOfMonth(reportParams.DateFrom);
            }
            if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
            {
                if (reportParams.ReportTemplateType == SoeReportTemplateType.SupplierBalanceList)
                {
                    showPending = reportParams.SL_ShowPendingPaymentsInReport;
                }
                else
                {
                    showPending = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.SupplierInvoiceReportShowPendingPayments, reportResult.UserId, reportResult.ActorCompanyId, 0);
                }
            }

            var items = entities.GetReportBalanceListItems(reportResult.ActorCompanyId, invoiceType, paymentType).ToList();
            items = SetGetReportBalanceListItemsResultTexts(items);

            var invoicePaymentMatchingItems = InvoiceManager.GetInvoicePaymentMatches(entities, reportResult.ActorCompanyId, reportParams.DateFrom, DateTime.Now);

            #endregion

            #region InvoiceSeqNr

            if (reportParams.SL_HasInvoiceSeqNrInterval)
            {
                items = FilterReportBalanceItemsOnSeqNr(reportParams, items, invoiceType, paymentType);
            }

            if (!reportParams.SL_ShowPreliminaryInvoices)
            {
                items = FilterReportBalanceItemsOnOriginStatus(reportParams, items, invoiceType, paymentType);
            }

            #endregion

            #region DateRegard

            if (reportParams.HasDateInterval)
            {
                items = FilterReportBalanceItemsOnDateRegard(reportParams, items, invoiceType, paymentType, reconciliationDateFrom, reconciliationDateTo);
            }

            #endregion


            var itemsLookup = items.ToLookup(p => new { p.OriginType, p.InvoiceId });

            var invoiceItems = (from i in items
                                where (i.OriginType == invoiceType ||
                                (i.OriginType == paymentType
                                && i.OnlyPayment
                                ))
                                select i).ToList();

            foreach (var invoiceItem in invoiceItems)
            {
                bool valid = false;

                #region InvoiceSeqNrList

                //Reset
                valid = false;

                if (reportParams.SL_HasInvoiceIds)
                {
                    //Validate each item against the list of InvoiceSeqNr
                    foreach (int invoiceId in reportParams.SL_InvoiceIds)
                    {
                        if (invoiceItem.InvoiceId == invoiceId)
                        {
                            valid = true;
                            break;
                        }
                    }
                }
                else
                {
                    valid = true;
                }

                if (!valid)
                    continue;

                #endregion

                #region ActorNr

                //Reset
                valid = false;

                if (reportParams.SL_HasActorNrInterval)
                {
                    //Validate against ActorNr
                    if (StringUtility.IsInInterval(invoiceItem.ActorNr, reportParams.SL_ActorNrFrom, reportParams.SL_ActorNrTo))
                        valid = true;
                }
                else
                {
                    valid = true;
                }
                if (!valid)
                    continue;

                //Invoice with Totalsum
                if ((reportParams.SL_InvoiceSelection == 4 || reportParams.SL_InvoiceSelection == 5) && invoiceItem.InvoiceTotalAmount == 0)
                    continue;

                #endregion

                #region Payments and matches

                int invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                var validatedPaymentItems = new List<GetReportBalanceListItemsResult>();

                var paymentItems = itemsLookup[new { OriginType = paymentType, InvoiceId = invoiceItem.InvoiceId }].Where(x => !x.OnlyPayment).ToList();

                if (reportParams.SL_PaymentRowIds != null && reportParams.SL_PaymentRowIds.Count > 0)
                {
                    List<GetReportBalanceListItemsResult> tempPaymentRows 
                        = new List<GetReportBalanceListItemsResult>();
                    foreach (GetReportBalanceListItemsResult row in paymentItems)
                    {
                        if (reportParams.SL_PaymentRowIds.Contains(row.PaymentRowId))
                        {
                            tempPaymentRows.Add(row);
                        }
                    }
                    paymentItems = tempPaymentRows;
                }

                #region Invoice matched

                List<InvoicePaymentMatchingView> matches = new List<InvoicePaymentMatchingView>();
                List<InvoicePaymentMatchingView> allMatches = new List<InvoicePaymentMatchingView>();

                int[] invoicePaymentMatchingId = invoicePaymentMatchingItems.Where(i => i.RecordId == invoiceItem.InvoiceId).Select(i => i.InvoicePaymentMatchingId).ToArray();
                for (int j = 0; j < invoicePaymentMatchingId.Length; j++)
                {
                    //collect first all matches
                    allMatches = invoicePaymentMatchingItems.Where(i => i.InvoicePaymentMatchingId == invoicePaymentMatchingId[j] && i.RecordId != invoiceItem.InvoiceId).ToList();

                    int paymentMatchingId = invoicePaymentMatchingId[j];
                    foreach (var tmpMatch in allMatches)
                    {
                        //compare to voucher date if voucher is created
                        var invoicePaymentMatchingRecord = (from i in entities.InvoicePaymentMatchingRecord
                                                            where i.InvoicePaymentMatchingId == paymentMatchingId
                                                            select i).FirstOrDefault();

                        if (invoicePaymentMatchingRecord?.VoucherId != null)
                        {
                            var voucherHead = (from i in entities.VoucherHead
                                               where i.ActorCompanyId == reportResult.ActorCompanyId &&
                                               i.VoucherHeadId == invoicePaymentMatchingRecord.VoucherId
                                               select i).FirstOrDefault();

                            if (voucherHead.Date < reportParams.DateTo || reportParams.DateTo.Year == 1900)
                                matches.Add(tmpMatch);
                        }
                        else
                        {
                            //compare to created date if voucher is not created
                            if (tmpMatch.Created < reportParams.DateTo || reportParams.DateTo.Year == 1900)
                                matches.Add(tmpMatch);
                        }
                    }

                    bool isMatchCodeUsed = matches.Any(i => i.MatchCodeId != null && i.MatchCodeId != 0);

                    //invoice is fully paid if match code is used
                    if (isMatchCodeUsed)
                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;

                    if (!isMatchCodeUsed && matches.Any())
                    {
                        List<string> matchedInvoiceNr = new List<string>();

                        for (int i = 0; i < matches.Where(m => m.Created < reportParams.DateTo || (reportParams.DateTo.Year == 1900 && m.Created <= DateTime.Now)).ToList().Count; i++)
                        {
                            var match = matches[i];
                            if (i == 0)
                            {
                                invoiceItem.IsMatched = true;
                                invoiceItem.IsMatchedAgainstInvoice = match.IsInvoice;
                                invoiceItem.IsMatchedAgainstPayment = match.IsPayment;
                            }
                            //if (!String.IsNullOrEmpty(invoiceItem.MatchedNr))
                            matchedInvoiceNr.Add(match.InvoiceNr);

                            // do not update payment amount when origin is payment because payment amount is already correct
                            if (invoiceItem.OriginType != (int)SoeOriginType.CustomerPayment)
                            {
                                if (match.InvoiceId == null && match.IsPayment)
                                {
                                    // invoice total amount is null when matched invoice is actually prepayment
                                    invoiceItem.PaymentAmount += match.PaymentAmount ?? 0;
                                    invoiceItem.PaymentAmountCurrency += match.PaymentAmountCurrency ?? 0;
                                    invoiceItem.PaymentAmountLedgerCurrency += match.PaymentAmountLedgerCurrency ?? 0;
                                    invoiceItem.PaymentAmountEntCurrency += match.PaymentAmountEntCurrency ?? 0;
                                }
                                else
                                {
                                    invoiceItem.PaymentAmount += (match.InvoiceTotalAmount ?? match.Amount) ?? 0;
                                    invoiceItem.PaymentAmountCurrency += (match.InvoiceTotalAmountCurrency ?? match.Amount) ?? 0;
                                    invoiceItem.PaymentAmountLedgerCurrency += (match.InvoiceTotalAmountLedgerCurrency ?? match.Amount) ?? 0;
                                    invoiceItem.PaymentAmountEntCurrency += (match.InvoiceTotalAmountEntCurrency ?? match.Amount) ?? 0;
                                }
                            }
                            if (invoiceItem.PaymentAmount != 0 && Math.Abs(invoiceItem.PaymentAmount) >= Math.Abs(invoiceItem.InvoiceTotalAmount))
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                        }

                        invoiceItem.MatchedNr = matchedInvoiceNr.Distinct().ToCommaSeparated();
                    }
                }
                #endregion

                #region Calculate payments

                decimal payedAmount = invoiceItem.PaymentAmount;

                var lastPayment = paymentItems.OrderByDescending(i => i.PayDate).FirstOrDefault();
                bool isPayed = false;
                bool isPayedSet = false;

                foreach (var paymentItem in paymentItems)
                {
                    #region Payment

                    //PayDate
                    if (reportParams.HasDateInterval && soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                    {
                        if (paymentItem.PayDate > reportParams.DateTo)
                            continue;

                        /*if (paymentItem.PayDate < reportParams.DateFrom)
                            continue;*/
                        //   else if (paymentItem.PayDate < reportParams.DateFrom || paymentItem.PayDate > reportParams.DateTo)  to show payments after dateto
                        //       continue;
                    }

                    //PaymentAmount
                    payedAmount += paymentItem.PaymentAmount;

                    bool isFullyPayed = invoiceItem.FullyPayed;

                    if (paymentItem.Status == (int)SoePaymentStatus.Checked || paymentItem.Status == (int)SoePaymentStatus.Cancel || paymentItem.Status == (int)SoePaymentStatus.ManualPayment || (paymentItem.Status == (int)SoePaymentStatus.Pending && journal && showPending))
                    {
                        if (!isPayedSet)
                        {
                            isPayed = invoiceItem.FullyPayed;
                            isPayedSet = true;
                        }
                    }
                    else
                    {
                        isPayed = false;
                        isPayedSet = true;
                    }

                    if (journal)
                    {
                        isPayed = invoiceItem.FullyPayed;
                    }
                    else
                    {
                        if (!isPayed)
                        {
                            isFullyPayed = isPayed;
                        }
                    }

                    if (isFullyPayed)
                    {
                        //Check last payment                        
                        if (reportParams.HasDateInterval && reportParams.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.VoucherDate && lastPayment != null && lastPayment.VoucherDate > reportParams.DateTo)
                            isFullyPayed = false;
                        else if (reportParams.HasDateInterval && lastPayment != null && lastPayment.PayDate > reportParams.DateTo)
                            isFullyPayed = false;
                        else if (lastPayment != null && lastPayment.Status == (int)SoePaymentStatus.Pending && !journal)
                            isFullyPayed = false;
                    }

                    if (isFullyPayed)
                    {
                        if (showPending && paymentItem.Status == (int)SoePaymentStatus.Pending)
                            invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
                        else
                            invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                    }
                    else
                    {
                        if (invoiceItem.InvoiceTotalAmount >= 0)
                        {
                            //Debit
                            if (payedAmount == 0)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount > 0 && payedAmount != invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount > 0 && payedAmount != invoiceItem.InvoiceTotalAmount)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
                            else if (payedAmount > 0 && payedAmount == invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount > 0 && payedAmount == invoiceItem.InvoiceTotalAmount && lastPayment.Status != (int)SoePaymentStatus.Pending && !journal)
                            {
                                if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                                {
                                    if (reportParams.HasDateInterval && lastPayment != null && lastPayment.PayDate > reportParams.DateTo)
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                    else
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                                }
                                else if (reportParams.HasDateInterval && lastPayment != null && (lastPayment.PayDate < reportParams.DateFrom || lastPayment.PayDate > reportParams.DateTo))
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                else
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                            }
							else if (payedAmount != 0)
								invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;

                            if (!isPayed && soeOriginTypeInvoice != SoeOriginType.CustomerInvoice && !journal)
                            {
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            }
                        }
                        else
                        {
                            //Credit
                            if (payedAmount == 0)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount < 0 && payedAmount != invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount < 0 && payedAmount != invoiceItem.InvoiceTotalAmount)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
                            else if (payedAmount < 0 && payedAmount == invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount < 0 && payedAmount == invoiceItem.InvoiceTotalAmount && lastPayment.Status != (int)SoePaymentStatus.Pending && !journal)
                                if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                                    if (reportParams.HasDateInterval && lastPayment != null && lastPayment.PayDate > reportParams.DateTo)
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                    else
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                                else if (reportParams.HasDateInterval && lastPayment != null && (lastPayment.PayDate < reportParams.DateFrom || lastPayment.PayDate > reportParams.DateTo))
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                else
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
							else if (payedAmount != 0)
								invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
							if (!isPayed && soeOriginTypeInvoice != SoeOriginType.CustomerInvoice && !journal)
                            {
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            }
                        }
                    }

                    validatedPaymentItems.Add(paymentItem);

                    #endregion
                }

                #endregion


                //consider as fully paid when invoice is marked as fully paid and still not having any matches or payments  
                //why this? 
                //Because Finnish car dealers are having their cash invoices in A/R, and those invoices are not having
                //any payment or match. Those invoices does not belong to balance list, and this is the only way to catch them -Nancy-
                if (invoiceItem.FullyPayed && allMatches.Count == 0 && paymentItems.Count == 0)
                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;

                //consider payment without invoice as partly paid when it's not matched against any invoice and it has "open balance"
                if (invoiceItem.OnlyPayment && allMatches.Count == 0)
                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;

                invoiceItem.FullyPayed = (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed);

                #endregion

                #region InvoiceSelection

                if (IsInvoiceStatusValid(reportParams.SL_InvoiceSelection, invoiceStatus, reconciliationDateFrom, reconciliationDateTo, invoiceItem.InvoiceDate, invoiceItem.VoucherDate, invoiceItem.PayDate)
                    || reportParams.SL_HasInvoiceIds)
                {
                    evaluatedItems.Add(invoiceItem);
                    if (invoiceItem.IsMatched)
                    {
                        evaluatedItems.AddRange(validatedPaymentItems.DistinctBy(x => x.PaymentRowId).ToList());
                    }
                    else
                    {
                        evaluatedItems.AddRange(validatedPaymentItems);
                    }
                }

                #endregion
            }

            return evaluatedItems;
        }

        private bool IsInvoiceStatusValid(int invoiceSelection, int invoiceStatus, DateTime reconciliationDateFrom, DateTime reconciliationDateTo, DateTime? invoiceDate, DateTime? voucherDate, DateTime? payDate)
        {
            bool valid = false;

            if (invoiceSelection == invoiceStatus)
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed && (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed || invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed))
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayedAndPartlyPayed && (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed || invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed))
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayedAndPartlyPayed && (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed || invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed))
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.All)
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.Reconciliation)
            {
                if (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed && invoiceDate < reconciliationDateFrom)
                    valid = true;
                if (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed && invoiceDate < reconciliationDateFrom)
                    valid = true;
                if ((invoiceDate >= reconciliationDateFrom && invoiceDate <= reconciliationDateTo) ||
                    (voucherDate >= reconciliationDateFrom && voucherDate <= reconciliationDateTo)
                    || (payDate >= reconciliationDateFrom)
                    )
                    valid = true;

            }

            return valid;
        }

        private List<GetReportBalanceListItemsResult> FilterReportBalanceItemsOnDateRegard(EconomyReportParamsDTO reportParams, List<GetReportBalanceListItemsResult> items, int invoiceType, int paymentType, DateTime reconciliationDateFrom, DateTime reconciliationDateTo)
        {
            if (reportParams == null || items == null)
                return new List<GetReportBalanceListItemsResult>();

            var filteredItems = new List<GetReportBalanceListItemsResult>();

            switch (reportParams.SL_DateRegard)
            {
                case (int)TermGroup_ReportLedgerDateRegard.InvoiceDate:
                    #region InvoiceDate

                    List<GetReportBalanceListItemsResult> invoiceItems = null;

                    if (reportParams.SL_ShowPreliminaryInvoices)
                    {
                        invoiceItems = (from i in items
                                        where
                                        (i.OriginType == invoiceType || (i.OriginType == paymentType && i.OnlyPayment)
                                        && (i.InvoiceDate == null || (i.InvoiceDate >= reportParams.DateFrom && i.InvoiceDate <= reportParams.DateTo))
                                        )

                                        select i).ToList();
                    }
                    else
                    {
                        if (reportParams.SL_InvoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.Reconciliation)
                        {
                            invoiceItems = (from i in items
                                            where
                                            (i.OriginType == invoiceType || (i.OriginType == paymentType && i.OnlyPayment))
                                            && ((i.InvoiceDate >= reconciliationDateFrom && i.InvoiceDate <= reconciliationDateTo)
                                                || (i.PayDate <= reconciliationDateFrom && !i.FullyPayed && i.OriginType == invoiceType)
                                                || (i.PayDate >= reconciliationDateFrom && i.OriginType == invoiceType)
                                                || ((i.PayDate >= reconciliationDateFrom && i.OriginType == invoiceType) &&
                                                    (i.PayDate <= reconciliationDateTo && i.OriginType == paymentType))
                                            )
                                            select i).ToList();

                        }
                        else
                        {
                            invoiceItems = (from i in items
                                            where ((i.OriginType == invoiceType || (i.OriginType == paymentType && i.OnlyPayment)) && (i.InvoiceDate >= reportParams.DateFrom && i.InvoiceDate <= reportParams.DateTo))
                                            select i).ToList();
                        }
                    }

                    // Start with invoices, and then fetch all payments from those invoices
                    var invoiceIdsForInvoiceDate = invoiceItems.Select(i => i.InvoiceId).Distinct().ToList();
                    var paymentsForInvoice = items.Where(i => i.OriginType == paymentType && !i.OnlyPayment && invoiceIdsForInvoiceDate.Contains(i.InvoiceId)).ToList();

                    filteredItems.AddRange(paymentsForInvoice);
                    filteredItems.AddRange(invoiceItems);
                    break;
                #endregion
                case (int)TermGroup_ReportLedgerDateRegard.VoucherDate:
                    #region VoucherDate

                    filteredItems = (from i in items
                                     where ((i.OriginType == paymentType && (i.PayDate >= reportParams.DateFrom && i.PayDate <= reportParams.DateTo)) ||
                                            (i.OriginType == paymentType && (i.PayDate >= reportParams.DateTo)) ||
                                            (i.OriginType == invoiceType && (i.VoucherDate >= reportParams.DateFrom && i.VoucherDate <= reportParams.DateTo)))
                                     select i).ToList();

                    var tempInvoiceItems = (from j in items
                                            where (j.OriginType == invoiceType && (j.VoucherDate < reportParams.DateFrom || j.VoucherDate > reportParams.DateTo))
                                            select j).ToList();

                    if (tempInvoiceItems.Any())
                    {
                        var invoiceIds = tempInvoiceItems.Select(i => i.InvoiceId).ToList();
                        var paymentsForInvoice2 = items.Where(i => i.OriginType == paymentType && invoiceIds.Contains(i.InvoiceId) &&
                                                                 (i.PayDate >= reportParams.DateFrom && i.PayDate <= reportParams.DateTo)).ToList();

                        invoiceIds = paymentsForInvoice2.Select(i => i.InvoiceId).Distinct().ToList();

                        foreach (var invoice in tempInvoiceItems.Where(i => invoiceIds.Contains(i.InvoiceId)).ToList())
                        {
                            invoice.InvoiceTotalAmount = 0;
                            filteredItems.Add(invoice);
                        }
                    }

                    break;
                #endregion
                case (int)TermGroup_ReportLedgerDateRegard.DueDate:
                    #region DueDate

                    filteredItems = (from i in items
                                     where (i.DueDate >= reportParams.DateFrom && i.DueDate <= reportParams.DateTo)
                                     select i).ToList();

                    break;
                #endregion
                case (int)TermGroup_ReportLedgerDateRegard.PaymentDate:
                    #region PaymentDate

                    var paymentItems = (from i in items
                                        where (i.OriginType == paymentType && (i.PayDate >= reportParams.DateFrom && i.PayDate <= reportParams.DateTo))
                                        select i).ToList();

                    //Start with payments, and then fetch all invoices from those payments
                    var invoiceIdsForPayments = paymentItems.Select(i => i.InvoiceId).Distinct().ToList();
                    var invoicesForPayments = items.Where(i => i.OriginType == invoiceType && invoiceIdsForPayments.Contains(i.InvoiceId)).ToList();
                    filteredItems.AddRange(invoicesForPayments);
                    filteredItems.AddRange(paymentItems);

                    break;
                    #endregion
            }

            return filteredItems;
        }

        private List<GetReportBalanceListItemsResult> FilterReportBalanceItemsOnOriginStatus(EconomyReportParamsDTO reportParams, List<GetReportBalanceListItemsResult> items, int invoiceType, int paymentType)
        {
            var filteredItems = new List<GetReportBalanceListItemsResult>();
            if (reportParams == null || items == null)
                return filteredItems;

            var invoiceItems = (from i in items
                                where i.Status > 1 &&
                                (i.OriginType == invoiceType ||
                                (i.OriginType == paymentType && i.OnlyPayment))
                                select i).ToList();

            //Start with invoices, and then fetch all payments from those invoices

            var invoiceIds = invoiceItems.Select(i => i.InvoiceId).ToList();
            var paymentItems = items.Where(i => i.OriginType == paymentType && !i.OnlyPayment && invoiceIds.Contains(i.InvoiceId)).Distinct().ToList();

            filteredItems.AddRange(invoiceItems);
            filteredItems.AddRange(paymentItems);

            return filteredItems;
        }

        private List<GetReportBalanceListItemsResult> FilterReportBalanceItemsOnSeqNr(EconomyReportParamsDTO reportParams, List<GetReportBalanceListItemsResult> items, int invoiceType, int paymentType)
        {
            var filteredItems = new List<GetReportBalanceListItemsResult>();
            if (reportParams == null || items == null)
                return filteredItems;

            var paymentItems = new List<GetReportBalanceListItemsResult>();

            var invoiceItems = (from i in items
                                where i.SeqNr >= reportParams.SL_InvoiceSeqNrFrom &&
                                i.SeqNr <= reportParams.SL_InvoiceSeqNrTo &&
                                (i.OriginType == invoiceType ||
                                (i.OriginType == paymentType && i.OnlyPayment))
                                select i).ToList();

            //Start with invoices, and then fetch all payments from those invoices
            foreach (var invoice in invoiceItems)
            {
                var paymentsForInvoice = items.Where(i => i.OriginType == paymentType && !i.OnlyPayment && i.InvoiceId == invoice.InvoiceId).ToList();
                if (paymentsForInvoice.Any() && !paymentItems.Any(i => i.PaymentRowId == invoice.PaymentRowId))
                    paymentItems.AddRange(paymentsForInvoice);
            }

            filteredItems.AddRange(invoiceItems);
            filteredItems.AddRange(paymentItems);

            return filteredItems;
        }

        private List<GetReportBalanceListItemsResult> SetGetReportBalanceListItemsResultTexts(List<GetReportBalanceListItemsResult> items)
        {
            if (items.IsNullOrEmpty())
                return new List<GetReportBalanceListItemsResult>();

            int langId = GetLangId();
            var billingTypeTexts = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);

            items.ForEach(i =>
            {
                i.BillingTypeName = i.BillingTypeId != 0 ? billingTypeTexts[i.BillingTypeId] : "";
                i.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(i.SysCurrencyId);
            });

            return items;
        }

        protected XElement CreateCustomerReportHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams)
        {
            Currency currency = CountryCurrencyManager.GetCurrencyFromType(reportResult.ActorCompanyId, TermGroup_CurrencyType.EnterpriseCurrency);

            return new XElement("ReportHeader",
                    this.CreateReportTitleElement(reportResult.ReportName),
                    this.CreateReportDescriptionElement(reportResult.ReportDescription),
                    this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                    this.CreateCompanyElement(),
                    this.CreateCompanyOrgNrElement(),
                    this.CreateLoginNameElement(reportResult.LoginName),
                    new XElement("DateRegardName", this.GetLedgerDateRegardText(reportParams)),
                    new XElement("SortOrderName", this.GetCustomerSortOrderText(reportParams)),
                    new XElement("InvoiceSelectionName", this.GetLedgerInvoiceSelectionText(reportParams)),
                    new XElement("DateInterval", this.GetDateIntervalText(reportParams)),
                    new XElement("InvoiceInterval", this.GetLedgerInvoiceIntervalText(reportParams)),
                    new XElement("CustomerInterval", this.GetLedgerActorIntervalText(reportParams)),
                    new XElement("EntCurrencyName", currency?.Name ?? ""),
                    new XElement("EntCurrencyCode", currency?.Code ?? ""));
            
        }

        protected string GetLedgerActorIntervalText(EconomyReportParamsDTO reportParams)
        {
            string text = "";
            if (reportParams.SL_HasActorNrInterval)
                text = reportParams.SL_ActorNrFrom + "-" + reportParams.SL_ActorNrTo;
            return text;
        }

        protected string GetLedgerInvoiceIntervalText(EconomyReportParamsDTO reportParams)
        {
            string text = "";
            if (reportParams.SL_HasInvoiceSeqNrInterval)
                text = reportParams.SL_InvoiceSeqNrFrom + "-" + reportParams.SL_InvoiceSeqNrTo;
            else if (reportParams.SL_HasInvoiceIds)
                text = StringUtility.GetCommaSeparatedString<int>(reportParams.SL_InvoiceIds);
            return text;
        }
        protected string GetLedgerDateRegardText(EconomyReportParamsDTO reportParams)
        {
            return GetText(reportParams.SL_DateRegard, (int)TermGroup.ReportLedgerDateRegard);
        }

        protected string GetCustomerSortOrderText(EconomyReportParamsDTO reportParams)
        {
            return GetText(reportParams.SL_SortOrder, (int)TermGroup.ReportCustomerLedgerSortOrder);
        }
        protected string GetLedgerInvoiceSelectionText(EconomyReportParamsDTO reportParams)
        {
            return GetText(reportParams.SL_InvoiceSelection, (int)TermGroup.ReportLedgerInvoiceSelection);
        }

        public XDocument CreateBalanceReportData(CreateReportResult reportResult)
        {
            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "BalanceReport");

            //BalanceReport
            XElement balanceReportElement = new XElement("BalanceReport");

            #endregion

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);

            #region Content

            if (!CreateBalanceResultAndSruReportCommonData(reportResult, balanceReportElement).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(balanceReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.BalanceReport);

            #endregion
        }

        private XElement CreateIOVoucherAccountingReportHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            string companyLogoPath = GetCompanyLogoFilePath(entitiesReadOnly, reportResult.ActorCompanyId, false);

            string reportSelectionText = reportResult
                .Input
                .Selections
                .GetSelection<TextSelectionDTO>("reportSelectionText")?
                .Text ?? string.Empty;

            return new XElement("ReportHeader",
                    this.CreateReportTitleElement(reportResult.ReportName),
                    this.CreateReportDescriptionElement(reportResult.ReportDescription),
                    this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                    this.CreateReportSelectionTextElement(reportSelectionText),
                   this.CreateCompanyElement(),
                   this.CreateCompanyOrgNrElement(),
                   new XElement("AccountYear", string.Empty),
                   new XElement("AccountYearLong", string.Empty),
                   new XElement("AccountPeriod", string.Empty),
                   new XElement("PreviousAccountYear", string.Empty),
                   this.CreateLoginNameElement(reportResult.LoginName),
                   new XElement("AccountPeriodFrom", reportParams.DateFrom.Date),
                   new XElement("AccountPeriodTo", reportParams.DateTo.Date),
                   new XElement("CompanyLogo", companyLogoPath));
        }

        private XElement CreateAccountingReportHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            string companyLogoPath = GetCompanyLogoFilePath(entitiesReadOnly, reportResult.ActorCompanyId, false);

            string reportSelectionText = reportResult
                .Input
                .Selections
                .GetSelection<TextSelectionDTO>("reportSelectionText")?
                .Text ?? string.Empty;

            return new XElement("ReportHeader",
                    this.CreateReportTitleElement(reportResult.ReportName),
                    this.CreateReportDescriptionElement(reportResult.ReportDescription),
                    this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                    this.CreateReportSelectionTextElement(reportSelectionText),
                   this.CreateCompanyElement(),
                   this.CreateCompanyOrgNrElement(),
                   new XElement("AccountYear", reportParams.GetAccountYearIntervalText()),
                   new XElement("AccountYearLong", reportParams.GetLongAccountYearIntervalText()),
                   new XElement("AccountPeriod", reportParams.GetAccountPeriodIntervalText()),
                   new XElement("PreviousAccountYear", reportParams.GetPreviousAccountYearIntervalText()),
                   this.CreateLoginNameElement(reportResult.LoginName),
                   new XElement("AccountPeriodFrom", reportParams.DateFrom.Date),
                   new XElement("AccountPeriodTo", reportParams.DateTo.Date),
                   new XElement("CompanyLogo", companyLogoPath));
        }

        private XElement CreateGeneralLedgerAccountElementFromDTO(int accountXmlId, AccountDTO account, BalanceItemDTO biAccountBalance, List<AccountDimDTO> accountDimInternals)
        {
            if (account == null || biAccountBalance == null || accountDimInternals == null)
                return null;

            XElement accountElement = new XElement("Account",
                new XAttribute("id", accountXmlId),
                new XElement("AccountNr", account.AccountNr),
                new XElement("AccountName", account.Name),
                new XElement("AccountBalance", biAccountBalance.Balance),
                new XElement("AccountQuantity", Convert.ToDecimal(biAccountBalance.Quantity)));

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    accountElement.Add(
                        new XElement("InternalNr" + i, string.Empty),
                        new XElement("InternalName" + i, string.Empty));
                }
            }

            return accountElement;
        }

        private XElement CreateVoucherRowElementsForProjectReport(int voucherRowXmlId, VoucherRowDTO voucherRow, List<AccountDim> accountDimInternals)
        {
            decimal debet;
            decimal credit;
            GetDebetCredit(voucherRow.Amount, out debet, out credit);

            decimal debetEntCurrency;
            decimal creditEntCurrency;
            GetDebetCredit(voucherRow.AmountEntCurrency, out debetEntCurrency, out creditEntCurrency);

            string voucherRowText = voucherRow.Text;
            if (string.IsNullOrEmpty(voucherRowText))
                voucherRowText = voucherRow.Text;

            XElement voucherRowElement = new XElement("VoucherRow",
                new XAttribute("id", voucherRowXmlId),
                new XElement("VoucherSerieNr", voucherRow.VoucherSeriesTypeNr),
                new XElement("VoucherSerieName", voucherRow.VoucherSeriesTypeName),
                new XElement("VoucherNr", voucherRow.VoucherNr),
                new XElement("VoucherRowDate", voucherRow.Date), //Cannot use VoucherRow.Date beacuse that data is corrupted in many cases (i.e. set to date when currency was fetched from ws)
                new XElement("VoucherRowText", voucherRowText),
                new XElement("Debit", debet),
                new XElement("DebitEntCurrency", debetEntCurrency),
                new XElement("Credit", credit),
                new XElement("CreditEntCurrency", creditEntCurrency),
                new XElement("Quantity", Convert.ToDecimal(voucherRow.Quantity)));

            #region AccountInternal

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    voucherRowElement.Add(
                        new XElement("AccountInternalNr" + i, string.Empty),
                        new XElement("AccountInternalName" + i, string.Empty));
                    continue;
                }

                AccountInternalDTO accountInternal = null;
                var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                if (accountDim != null)
                {
                    accountInternal = (from ai in voucherRow.AccountInternalDTO_forReports
                                       where ai.AccountDimId == accountDim.AccountDimId
                                       select ai).FirstOrDefault();
                }

                voucherRowElement.Add(
                    new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : string.Empty),
                    new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : string.Empty));
            }

            #endregion AccountInternal

            return voucherRowElement;
        }

        protected XElement CreateFixedAssetsReportHeaderElement(CreateReportResult reportResult, EconomyReportParamsDTO reportParams)
        {
            DateTime prognoseInterval1From = CalendarUtility.GetFirstDateOfMonth(reportParams.DateTo.AddMonths(1));
            DateTime prognoseInterval1To = CalendarUtility.DATETIME_DEFAULT;
            Account inventoryAccountFrom = null;
            if (reportParams.SFA_InventoryAccountFrom != 0)
                inventoryAccountFrom = AccountManager.GetAccount(base.ActorCompanyId, reportParams.SFA_InventoryAccountFrom);
            Account inventoryAccountTo = null;
            if (reportParams.SFA_InventoryAccountTo != 0)
                inventoryAccountTo = AccountManager.GetAccount(base.ActorCompanyId, reportParams.SFA_InventoryAccountTo);

            if (reportParams.SFA_PrognoseType == 1)
                prognoseInterval1To = CalendarUtility.GetLastDateOfMonth(reportParams.DateTo.AddMonths(1));
            if (reportParams.SFA_PrognoseType == 2)
                prognoseInterval1To = CalendarUtility.GetLastDateOfMonth(reportParams.DateTo.AddMonths(3));
            if (reportParams.SFA_PrognoseType == 3)
                prognoseInterval1To = CalendarUtility.GetLastDateOfMonth(reportParams.DateTo.AddMonths(6));
            if (reportParams.SFA_PrognoseType == 4)
                prognoseInterval1To = CalendarUtility.GetLastDateOfMonth(reportParams.DateTo.AddMonths(12));

            DateTime prognoseInterval2From = CalendarUtility.GetFirstDateOfMonth(prognoseInterval1To.AddMonths(1));
            DateTime prognoseInterval2To = CalendarUtility.DATETIME_DEFAULT;
            if (reportParams.SFA_PrognoseType == 1)
                prognoseInterval2To = CalendarUtility.GetLastDateOfMonth(prognoseInterval1To.AddMonths(1));
            if (reportParams.SFA_PrognoseType == 2)
                prognoseInterval2To = CalendarUtility.GetLastDateOfMonth(prognoseInterval1To.AddMonths(3));
            if (reportParams.SFA_PrognoseType == 3)
                prognoseInterval2To = CalendarUtility.GetLastDateOfMonth(prognoseInterval1To.AddMonths(6));
            if (reportParams.SFA_PrognoseType == 4)
                prognoseInterval2To = CalendarUtility.GetLastDateOfMonth(prognoseInterval1To.AddMonths(12));

            DateTime prognoseInterval3From = CalendarUtility.GetFirstDateOfMonth(prognoseInterval2To.AddMonths(1));
            DateTime prognoseInterval3To = CalendarUtility.DATETIME_DEFAULT;
            if (reportParams.SFA_PrognoseType == 1)
                prognoseInterval3To = CalendarUtility.GetLastDateOfMonth(prognoseInterval2To.AddMonths(1));
            if (reportParams.SFA_PrognoseType == 2)
                prognoseInterval3To = CalendarUtility.GetLastDateOfMonth(prognoseInterval2To.AddMonths(3));
            if (reportParams.SFA_PrognoseType == 3)
                prognoseInterval3To = CalendarUtility.GetLastDateOfMonth(prognoseInterval2To.AddMonths(6));
            if (reportParams.SFA_PrognoseType == 4)
                prognoseInterval3To = CalendarUtility.GetLastDateOfMonth(prognoseInterval2To.AddMonths(12));

            DateTime prognoseInterval4From = CalendarUtility.GetFirstDateOfMonth(prognoseInterval3To.AddMonths(1));
            DateTime prognoseInterval4To = CalendarUtility.DATETIME_DEFAULT;
            if (reportParams.SFA_PrognoseType == 1)
                prognoseInterval4To = CalendarUtility.GetLastDateOfMonth(prognoseInterval3To.AddMonths(1));
            if (reportParams.SFA_PrognoseType == 2)
                prognoseInterval4To = CalendarUtility.GetLastDateOfMonth(prognoseInterval3To.AddMonths(3));
            if (reportParams.SFA_PrognoseType == 3)
                prognoseInterval4To = CalendarUtility.GetLastDateOfMonth(prognoseInterval3To.AddMonths(6));
            if (reportParams.SFA_PrognoseType == 4)
                prognoseInterval4To = CalendarUtility.GetLastDateOfMonth(prognoseInterval3To.AddMonths(12));

            DateTime prognoseInterval5From = CalendarUtility.GetFirstDateOfMonth(prognoseInterval4To.AddMonths(1));
            DateTime prognoseInterval5To = CalendarUtility.DATETIME_DEFAULT;
            if (reportParams.SFA_PrognoseType == 1)
                prognoseInterval5To = CalendarUtility.GetLastDateOfMonth(prognoseInterval4To.AddMonths(1));
            if (reportParams.SFA_PrognoseType == 2)
                prognoseInterval5To = CalendarUtility.GetLastDateOfMonth(prognoseInterval4To.AddMonths(3));
            if (reportParams.SFA_PrognoseType == 3)
                prognoseInterval5To = CalendarUtility.GetLastDateOfMonth(prognoseInterval4To.AddMonths(6));
            if (reportParams.SFA_PrognoseType == 4)
                prognoseInterval5To = CalendarUtility.GetLastDateOfMonth(prognoseInterval4To.AddMonths(12));

            return new XElement("ReportHeader",
                   this.CreateReportTitleElement(reportResult.ReportName),
                   this.CreateReportDescriptionElement(reportResult.ReportDescription),
                   this.CreateReportNrElement(reportResult.ReportNr.ToString()),
                   this.CreateReportSelectionTextElement(reportResult.Input.Selections.GetSelection<TextSelectionDTO>("reportSelectionText").Text),
                   this.CreateCompanyElement(),
                   this.CreateCompanyOrgNrElement(),
                   new XElement("AccountYear", reportParams.GetAccountYearIntervalText()),
                   new XElement("AccountYearLong", reportParams.GetLongAccountYearIntervalText()),
                   new XElement("AccountPeriod", reportParams.GetAccountPeriodIntervalText()),
                   new XElement("InventoryInterval", reportParams.GetInventoryIntervalText()),
                   new XElement("CategoryInterval", reportParams.GetCategoryIntervalText()),
                   new XElement("PrognoseInterval", this.GetInventoryPrognoseText(reportParams, (int)TermGroup.PrognosTypes)),
                   new XElement("PrognoseInterval1", GetPrognoseIntervalText(prognoseInterval1From.ToString("yyyyMMdd"), prognoseInterval1To.ToString("yyyyMMdd"))),
                   new XElement("PrognoseInterval2", GetPrognoseIntervalText(prognoseInterval2From.ToString("yyyyMMdd"), prognoseInterval2To.ToString("yyyyMMdd"))),
                   new XElement("PrognoseInterval3", GetPrognoseIntervalText(prognoseInterval3From.ToString("yyyyMMdd"), prognoseInterval3To.ToString("yyyyMMdd"))),
                   new XElement("PrognoseInterval4", GetPrognoseIntervalText(prognoseInterval4From.ToString("yyyyMMdd"), prognoseInterval4To.ToString("yyyyMMdd"))),
                   new XElement("PrognoseInterval5", GetPrognoseIntervalText(prognoseInterval5From.ToString("yyyyMMdd"), prognoseInterval5To.ToString("yyyyMMdd"))),
                   new XElement("InventoryAccountFrom", inventoryAccountFrom != null ? inventoryAccountFrom.AccountNr.ToString() : string.Empty),
                   new XElement("InventoryAccountTo", inventoryAccountFrom != null ? inventoryAccountTo.AccountNr.ToString() : string.Empty),
                   this.CreateLoginNameElement(reportResult.LoginName),
				   new XElement("DateFrom", reportParams.DateFrom),
				   new XElement("DateTo", reportParams.DateTo)
                   );

        }


        public string GetInventoryPrognoseText(EconomyReportParamsDTO reportParams, int termGroup)
        {
            return GetText(reportParams.SFA_PrognoseType, termGroup);
        }

        public XDocument CreateFixedAssetsData(CreateReportResult reportResult)
        {

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "FixedAssets");

            //Fixed assets
            XElement fixedAssetsElement = new XElement("FixedAssets");

            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateFixedAssetsgReportHeaderLabelsElement();
            fixedAssetsElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateFixedAssetsReportHeaderElement(reportResult, reportParams);
            fixedAssetsElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateFixedAssetsPageHeaderLabelsElement(pageHeaderLabelsElement);
            fixedAssetsElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                int inventoryXmlId = 1;

                List<Inventory> inventories = InventoryManager.GetInventories(entities, reportResult.ActorCompanyId, true, 0, "", true, true);
                List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(entities, reportResult.ActorCompanyId, false);

                Account inventoryAccountFrom = reportParams.SFA_InventoryAccountFrom != 0 ? AccountManager.GetAccount(base.ActorCompanyId, reportParams.SFA_InventoryAccountFrom) : null;
                Account inventoryAccountTo = reportParams.SFA_InventoryAccountTo != 0 ? AccountManager.GetAccount(base.ActorCompanyId, reportParams.SFA_InventoryAccountTo) : null;

                foreach (Inventory inventory in inventories)
                {
                    if (reportParams.SFA_HasInventoryInterval)
                    {
                        if (!StringUtility.IsInInterval(inventory.InventoryNr, reportParams.SFA_InventoryFrom, reportParams.SFA_InventoryTo))
                        {
                            continue;
                        }
                    }

                    if (reportParams.SFA_HasInventoryAccountInterval )
                    {
                        if (!StringUtility.IsInInterval(inventory.InventoryAccountNr, inventoryAccountFrom?.AccountNr ?? "", inventoryAccountTo?.AccountNr ?? ""))
                        { 
                            continue;
                        }
                    }

                    if (reportParams.SFA_HasCategoryInterval)
                    {
                        bool inInterval = false;
                        List<CompanyCategoryRecord> companyCategoryRecords = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Inventory, SoeCategoryRecordEntity.Inventory, inventory.InventoryId, reportResult.ActorCompanyId).ToList();

                        foreach (var categoryRecord in companyCategoryRecords)
                        {
                            var CategoryNr = CategoryManager.GetCategoryCode(entities, categoryRecord.CategoryId, reportResult.ActorCompanyId);
                            inInterval = StringUtility.IsInInterval(CategoryNr, reportParams.SFA_CategoryFrom, reportParams.SFA_CategoryTo);
                        }

                        if (!inInterval)
                            continue;
                    }

                    if (reportParams.HasDateInterval)
                    {
                        if (reportParams.DateFrom != CalendarUtility.DATETIME_DEFAULT
                            && (!inventory.PurchaseDate.HasValue 
                            || reportParams.DateFrom > inventory.PurchaseDate))
                        {
                            continue;
                        }

                        if (reportParams.DateTo != CalendarUtility.DATETIME_DEFAULT
                            && (!inventory.PurchaseDate.HasValue
                            || reportParams.DateTo < inventory.PurchaseDate))
                        {
                            continue;
                        }
                    }

                    #region Content

                    string voucherSerie = voucherSeriesTypes.Where(i => i.VoucherSeriesTypeId == inventory.VoucherSeriesTypeId).Select(i => i.Name).FirstOrDefault();

                    int invoiceSeqNr = 0;
                    string invoiceNr = string.Empty;

                    if (inventory.SupplierInvoiceId.GetValueOrDefault() != 0)
                    {
                        var supplierinvoice = SupplierInvoiceManager.GetSupplierInvoiceSmall(entities, inventory.SupplierInvoiceId.GetValueOrDefault());
                        invoiceSeqNr = supplierinvoice?.SeqNr ?? 0;
                        invoiceNr = supplierinvoice.InvoiceNr;
                    }
                    else if (inventory.CustomerInvoiceId.GetValueOrDefault() != 0)
                    {
                        var customerinvoice = InvoiceManager.GetCustomerInvoiceSmall(entities, (int)inventory.CustomerInvoiceId);
                        invoiceSeqNr = customerinvoice?.SeqNr ?? 0;
                        invoiceNr = customerinvoice.InvoiceNr;
                    }

                    //Inventory
                    XElement inventoryElement = new XElement("Inventory",
                        new XAttribute("id", inventoryXmlId),
                        new XElement("InventoryId", inventory.InventoryId),
                        new XElement("WriteOffMethodName", inventory.InventoryWriteOffMethod?.Name ?? string.Empty),
                        new XElement("WriteOffMethodType", inventory.InventoryWriteOffMethod != null ? GetText(inventory.InventoryWriteOffMethod.Type, (int)TermGroup.InventoryWriteOffMethodType) : string.Empty),
                        new XElement("VoucherSeries", voucherSerie),
                        new XElement("SupplierInvoiceId", inventory.SupplierInvoiceId ?? 0),
                        new XElement("CustomerInvoiceId", inventory.CustomerInvoiceId ?? 0),
                        new XElement("InvoiceSeqNr", invoiceSeqNr),
                        new XElement("InvoiceNr", invoiceNr),
						new XElement("InventoryNr", inventory.InventoryNr),
                        new XElement("InventoryName", inventory.Name),
						new XElement("InventoryAccountNr", inventory.InventoryAccountNr),
						new XElement("InventoryAccountName", inventory.InventoryAccountName),
						new XElement("Description", inventory.Description),
                        new XElement("Notes", inventory.Notes),
                        new XElement("PurchaseDate", inventory.PurchaseDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("WriteOffDate", inventory.WriteOffDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PurchaseAmount", inventory.PurchaseAmount),
                        new XElement("WriteOffAmount", inventory.WriteOffAmount),
                        new XElement("WriteOffSum", inventory.WriteOffSum),
                        new XElement("WriteOffRemainingAmount", inventory.WriteOffRemainingAmount),
                        new XElement("EndAmount", inventory.EndAmount),
                        new XElement("PeriodType", GetText(inventory.PeriodType, (int)TermGroup.InventoryWriteOffMethodPeriodType)),
                        new XElement("PeriodValue", inventory.PeriodValue),
                        new XElement("StatusType", GetText(inventory.Status, (int)TermGroup.InventoryStatus)),
                        new XElement("StatusValue", inventory.Status),
                        new XElement("WriteOffPeriods", inventory.WriteOffPeriods),
                        new XElement("Created", inventory.Created.HasValue ? inventory.Created.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("CreatedBy", inventory.CreatedBy),
                        new XElement("Modified", inventory.Modified.HasValue ? inventory.Modified.Value : CalendarUtility.DATETIME_DEFAULT),
                        new XElement("ModifiedBy", inventory.ModifiedBy),
						new XElement("CategoryNames", inventory.CategoryNamesString)
						);

                    //InventoryLog
                    int inventoryLogXmlId = 1;

                    List<InventoryTraceViewDTO> traceViews = InventoryManager.GetInventoryTraceViews(inventory.InventoryId)
                        .Where(i => i.Date <= reportParams.DateTo).OrderBy(i => i.Date).ToList();

                    foreach (var inventoryLog in traceViews)
                    {
                        //InventoryLog
                        XElement inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", inventoryLog.VoucherNr),
                            new XElement("InvoiceSeqNr", inventoryLog.InvoiceId ?? 0),
                            new XElement("InvoiceNr", inventoryLog.InvoiceNr),
                            new XElement("User", ""),
                            new XElement("Date", inventoryLog.Date),
                            new XElement("Type", (int)inventoryLog.Type),
                            new XElement("TypeName", inventoryLog.TypeName),
                            new XElement("Amount", inventoryLog.Amount),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 0)
                            );


                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                    }
                    #region Prognose element InventoryLog

                    if (inventoryLogXmlId > 1 && inventory.Status == 2 && inventory.WriteOffPeriods > 0 && inventory.WriteOffAmount > 0 && inventory.WriteOffRemainingAmount > 0)
                    {
                        decimal periodValue = inventory.PeriodValue != 0 ? inventory.WriteOffAmount / inventory.PeriodValue : inventory.WriteOffAmount;
                        decimal remainingAmount = inventory.WriteOffRemainingAmount;
                        decimal amountInterval1 = 0;
                        decimal remainingAmountInterval1 = 0;
                        decimal amountInterval2 = 0;
                        decimal remainingAmountInterval2 = 0;
                        decimal amountInterval3 = 0;
                        decimal remainingAmountInterval3 = 0;
                        decimal amountInterval4 = 0;
                        decimal remainingAmountInterval4 = 0;
                        decimal amountInterval5 = 0;
                        decimal remainingAmountInterval5 = 0;
                        if (reportParams.SFA_PrognoseType == 1)
                        {
                            amountInterval1 = periodValue;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }
                            amountInterval2 = periodValue;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }
                            amountInterval3 = periodValue;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }
                            amountInterval4 = periodValue;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }
                            amountInterval5 = periodValue;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        if (reportParams.SFA_PrognoseType == 2)
                        {
                            amountInterval1 = periodValue * 3;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }
                            amountInterval2 = periodValue * 3;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }
                            amountInterval3 = periodValue * 3;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }
                            amountInterval4 = periodValue * 3;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }
                            amountInterval5 = periodValue * 3;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        if (reportParams.SFA_PrognoseType == 3)
                        {
                            amountInterval1 = periodValue * 6;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }

                            amountInterval2 = periodValue * 6;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }
                            amountInterval3 = periodValue * 6;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }
                            amountInterval4 = periodValue * 6;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }
                            amountInterval5 = periodValue * 6;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        if (reportParams.SFA_PrognoseType == 4)
                        {
                            amountInterval1 = periodValue * 12;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }

                            amountInterval2 = periodValue * 12;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }

                            amountInterval3 = periodValue * 12;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }

                            amountInterval4 = periodValue * 12;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }

                            amountInterval5 = periodValue * 12;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        //InventoryLog interval 1
                        XElement inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval1),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 1)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 2
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval2),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 2)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 3
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval3),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 3)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 4
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval4),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 4)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 5
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval5),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 5)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval remaining amount
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", remainingAmountInterval5),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 6)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;

                    }
                    #endregion

                    #region Default element InventoryLog

                    if (inventoryLogXmlId == 1)
                        inventoryElement.Add(new XElement("InventoryLog", String.Empty));

                    #endregion

                    fixedAssetsElement.Add(inventoryElement);
                    inventoryXmlId++;

                    #endregion
                }
            }

            #region Close document

            rootElement.Add(fixedAssetsElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.FixedAssets);

            #endregion
        }


        public XDocument CreateResultReportData(CreateReportResult reportResult)
        {

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ResultReport");

            //ResultReport
            XElement resultReportElement = new XElement("ResultReport");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonData(reportResult, resultReportElement).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(resultReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ResultReport);

            #endregion

        }

        private ActionResult CreateBalanceResultAndSruReportCommonData(CreateReportResult reportResult, XElement reportElement)
        {

            #region Prereq

            ActionResult result = new ActionResult(true);
            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            Report report = ReportManager.GetReport(reportResult.ReportId, reportResult.ActorCompanyId, loadSysReportTemplateType: true);

        //    List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId).ToDTOs();
            List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId).ToDTOs();
            string companyName_shortName = CompanyManager.GetCompanyName(reportResult.ActorCompanyId, true, false);


            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(new XElement("AccountYearDiffLabel", GetReportText(35, "Jämförelseår:")));
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            reportHeaderLabelsElement.Add(new XElement("SumLabel", GetReportText(34, "Summa")));

            reportElement.Add(reportHeaderLabelsElement);

            List<AccountFilterSelectionDTO> accountFilters;
            TryGetAccountFilters(reportResult, out accountFilters, "namedFilterRanges");
            var accountIntervals = accountFilters.Select(x => new AccountIntervalDTO() { AccountDimId = x.Id, AccountNrFrom = x.From, AccountNrTo = x.To }).ToList();
            if (accountIntervals.Count == 1)
            {
                var account = accountIntervals.First();
                if (account.AccountNrFrom.IsNullOrEmpty() && account.AccountNrTo.IsNullOrEmpty())
                {
                    accountIntervals.Clear();
                }
            }

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(CreateAccountIntervalElement(am, reportResult, accountIntervals, accountDimInternals));
            reportHeaderElement.Add(CreateAccountDim(reportParams.SSTD_AccountDimId, accountDimInternals));
            reportHeaderElement.Add(new XElement("AccountYearDiff", String.Empty));

            if (reportResult.ReportTemplateType != SoeReportTemplateType.SruReport)
            {
                reportHeaderElement.Add(new XElement("IncludeMissingAccountDim", reportParams.SSTD_IncludeMissingAccountDim.ToInt()));
                reportHeaderElement.Add(new XElement("SeparateAccountDim", reportParams.SSTD_SeparateAccountDim.ToInt()));
                // Budget
                int budgetHId = 0;
                string budgetName = string.Empty;
                if (reportParams.SSTD_BudgetId.HasValue)
                    budgetHId = reportParams.SSTD_BudgetId.Value;
                BudgetManager bm = new BudgetManager(null);
                List<BudgetHead> budgetHeads = bm.GetBudgetHeads(reportResult.ActorCompanyId, (int)DistributionCodeBudgetType.AccountingBudget);
                foreach (BudgetHead budgetHead in budgetHeads)
                {
                    if (budgetHead.BudgetHeadId == budgetHId)
                        budgetName = budgetHead.Name;
                }
                reportHeaderElement.Add(new XElement("Budget", budgetName));
                reportHeaderElement.Add(new XElement("ShowRowsByAccount", reportParams.ShowRowsByAccount.ToInt()));
                reportHeaderElement.Add(new XElement("NrOfDecimals", report.NrOfDecimals ?? 2));
                reportHeaderElement.Add(new XElement("CompanyShortname", companyName_shortName));
                reportHeaderElement.Add(new XElement("ExportType", reportResult.ExportType));
            }
            reportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    pageHeaderLabelsElement.Add(
                        new XElement("DimensionInternalName" + i + "Label", String.Empty),
                        new XElement("DimensionInternalShortName" + i + "Label", String.Empty));
                    continue;
                }

                var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;

                pageHeaderLabelsElement.Add(
                    new XElement("DimensionInternalName" + i + "Label", accountDim != null ? accountDim.AccountDimNr.ToString() : String.Empty),
                    new XElement("DimensionInternalShortName" + i + "Label", accountDim != null ? accountDim.Name : String.Empty));
            }

            this.AddAccountBalanceChangePeriodPageHeaderLabelElements(pageHeaderLabelsElement);

            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
            {
                #region BalanceReport, ResultReport

                this.AddAccountBalanceChangePageHeaderLabelElements(pageHeaderLabelsElement);

                #endregion

                if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                {
                    #region BalanceReport

                    this.AddAccountBalancePageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
                else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
                {
                    #region ResultReport

                    this.AddAccountBalanceChangePreviousPageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
            }

            reportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Init

                AccountBalanceManager abm = AccountBalanceManager(reportResult.ActorCompanyId);
                abm.InitBalanceChangeVoucherHeadCache();

                List<AccountDTO> accountStdsInInterval = new List<AccountDTO>();
                List<AccountInternalDTO> accountInternalsInInterval = new List<AccountInternalDTO>();
                List<AccountInternalDTO> reportAccountInternalsInInterval = new List<AccountInternalDTO>();
                List<AccountInternalDTO> reportAccountInternalsSpecificDim = new List<AccountInternalDTO>();

                Dictionary<int, BalanceItemDTO> biBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeIncludingPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalanceDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousThisYearDict = new Dictionary<int, BalanceItemDTO>();

                // Previous Year
                Dictionary<int, BalanceItemDTO> biBalancechangePreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeIncludingPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalancePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, BalanceItemDTO>();

                //PreviousPeriods
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus1YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus2YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus3YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus4YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus5YearDict = new Dictionary<int, BalanceItemDTO>();

                // Budget TODO BudgetBalanceItemDTO
                Dictionary<int, BalanceItemDTO> biBudgetBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeIncludingPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();

                //Gross profit
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousThisYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit and Budget
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit Previous Year
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalancePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //historical Data
                List<VoucherHeadDTO> voucherHeadsAllPreviousThisYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousPreviousYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPreviousYearPeriod = new List<VoucherHeadDTO>();

                //VoucherHeads
                List<VoucherHeadDTO> voucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads Budget
                List<VoucherHeadDTO> budgetVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads PreviuousPeriods
                List<VoucherHeadDTO> previousPeriodMinus1YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus2YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus3YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus4YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus5YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();

                //VoucherHeads PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfitBudget
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                #endregion

                #region Prereq

                AccountYearDTO accountYear = AccountManager.GetAccountYear(entities, reportParams.DateFrom, reportResult.ActorCompanyId).ToDTO();
                if (accountYear == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountYear");

                AccountYearDTO accountYearTo = AccountManager.GetAccountYear(entities, reportParams.DateTo, reportResult.ActorCompanyId).ToDTO();
                if (accountYearTo == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountYear");

                AccountDimDTO accountDimStd = AccountManager.GetAccountDimStd(entities, reportResult.ActorCompanyId).ToDTO();
                if (accountDimStd == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountDim");

                List<AccountDimDTO> internalaccountDims = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId, false, true, true).OrderBy(a => a.AccountDimNr).ToDTOs();
                List<AccountDTO> allAccountDTOStds = AccountManager.GetAccountStdsByCompany(reportResult.ActorCompanyId, null).ToDTOs().ToList();

                //Fetch all related report groups with headers and intervals populated at once.
                List<ReportGroupDTO> reportGroups = ReportManager.GetReportGroupsForReport(reportResult.ActorCompanyId, report);

                //All intervals with a SelectValue is grabbed. The select value refers to a Gross Profit Code.
                List<IReportHeaderInterval> grossProfitReportHeaderIntervals = reportGroups
                    .SelectMany(group => group.ReportHeaders)
                    .SelectMany(header => header.ReportHeaderIntervals)
                    .Where(interval => interval.SelectValue.HasValue)
                    .Cast<IReportHeaderInterval>()
                    .ToList();

                //Get detailed Information - Information is only needed in some reports
                bool detailedInformation = reportResult.GetDetailedInformation;

                DateTime firstMonth = CalendarUtility.GetFirstDateOfMonth(reportParams.DateFrom);
                DateTime prevYearDateFrom = reportParams.DateFrom.AddYears(-1);
                DateTime prevYearDateTo = reportParams.DateTo.AddYears(-1);

                prevYearDateTo = CalendarUtility.GetLastDateOfMonth(prevYearDateTo);
                DateTime prevYearUntilDateFrom = reportParams.UntilDateFrom().AddYears(-reportParams.NoOfYearsBackinPreviousYear);
                prevYearUntilDateFrom = CalendarUtility.GetLastDateOfMonth(prevYearUntilDateFrom);
                //Previous year
                AccountYearDTO previousAccountYear = reportParams.NoOfYearsBackinPreviousYear != 0 ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-1), reportResult.ActorCompanyId).ToDTO() : null;
                
                // Year minus 1
                DateTime prevPeriodMinus1YearDateFrom = reportParams.DateFrom.AddYears(-1);
                DateTime prevPeriodMinus1YearDateTo = reportParams.DateTo.AddYears(-1);
                prevPeriodMinus1YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus1YearDateTo);
                AccountYearDTO previousPeriodMinus1AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-1), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 2
                DateTime prevPeriodMinus2YearDateFrom = reportParams.DateFrom.AddYears(-2);
                DateTime prevPeriodMinus2YearDateTo = reportParams.DateTo.AddYears(-2);
                prevPeriodMinus2YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus2YearDateTo);
                AccountYearDTO previousPeriodMinus2AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-2), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 3
                DateTime prevPeriodMinus3YearDateFrom = reportParams.DateFrom.AddYears(-3);
                DateTime prevPeriodMinus3YearDateTo = reportParams.DateTo.AddYears(-3);
                prevPeriodMinus3YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus3YearDateTo);
                AccountYearDTO previousPeriodMinus3AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-3), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 4
                DateTime prevPeriodMinus4YearDateFrom = reportParams.DateFrom.AddYears(-4);
                DateTime prevPeriodMinus4YearDateTo = reportParams.DateTo.AddYears(-4);
                prevPeriodMinus4YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus4YearDateTo);
                AccountYearDTO previousPeriodMinus4AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-4), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 5
                DateTime prevPeriodMinus5YearDateFrom = reportParams.DateFrom.AddYears(-5);
                DateTime prevPeriodMinus5YearDateTo = reportParams.DateTo.AddYears(-5);
                prevPeriodMinus5YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus5YearDateTo);
                AccountYearDTO previousPeriodMinus5AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-5), reportResult.ActorCompanyId).ToDTO() : null;

                // Budget
                int budgetHeadId = 0;
                bool getBudget = true;
                if (reportParams.SSTD_BudgetId.HasValue && reportParams.IncludeBudget)
                    budgetHeadId = reportParams.SSTD_BudgetId.Value;
                if (budgetHeadId == 0)
                    getBudget = false;

                List<GrossProfitCode> grossProfCodes = GrossProfitManager.GetGrossProfitCodes(reportResult.ActorCompanyId);
                List<GrossProfitCodeDTO> grossProfitCodes = new List<GrossProfitCodeDTO>();
                foreach (var code in grossProfCodes)
                {
                    grossProfitCodes.Add(code.ToDTO());
                }

                bool hasGrossProfitCodes = grossProfitCodes.Any() && grossProfitReportHeaderIntervals.Any();

                List<AccountStd> accountStds = new List<AccountStd>();
                List<AccountInternal> accountInternals = new List<AccountInternal>();

                bool isAccountSelectionValid = AccountManager.GetAccountsInInterval(entities, reportResult, reportParams, accountDimStd, false, ref accountStdsInInterval, ref reportAccountInternalsInInterval);

                if (accountInternals.Any())
                    reportAccountInternalsInInterval = accountInternals.ToDTOs();

                if (accountStds.Any())
                {
                    foreach (var account in accountStds)
                    {
                        accountStdsInInterval.Add(account.ToDTO());
                    }
                }

                if (reportParams.SSTD_SeparateAccountDim)
                {
                    if (reportParams.SSTD_AccountDimId != 0)
                    {
                        reportAccountInternalsSpecificDim = reportAccountInternalsInInterval.Where(a => a.AccountDimId == reportParams.SSTD_AccountDimId).ToList();
                    }
                    else
                    {
                        int firstAccountDimId = reportParams.SA_AccountIntervals?.FirstOrDefault(a => a.AccountDimId != accountDimStd.AccountDimId)?.AccountDimId ?? 0;
                        if (firstAccountDimId > 0)
                            reportAccountInternalsSpecificDim = reportAccountInternalsInInterval.Where(a => a.AccountDimId == firstAccountDimId).ToList();
                    }
                    reportAccountInternalsInInterval.RemoveAll(x => reportAccountInternalsSpecificDim.Exists(y => y.AccountId == x.AccountId));

                    if (reportAccountInternalsSpecificDim.Count > 0)
                        reportAccountInternalsInInterval.Add(reportAccountInternalsSpecificDim.ElementAt(0));
                }

                int reportI = 0;
                int currentAccountIdx = 0;
                bool delaySetAccount = false;
                if (!reportParams.SSTD_IncludeMissingAccountDim)
                    accountInternalsInInterval = reportAccountInternalsInInterval;
                else
                    delaySetAccount = true;

                while (isAccountSelectionValid)
                {
                    //Cache
                    abm.InitBalanceChangeVoucherHeadDTOCache();

                    if (reportParams.IncludeAllHistoricalData)
                        abm.FillVoucherHeadDTOCache(CalendarUtility.DATETIME_DEFAULT, accountYear.To, reportResult.ActorCompanyId);
                    else if (previousAccountYear != null)
                        abm.FillVoucherHeadDTOCache(previousAccountYear.From, accountYear.To, reportResult.ActorCompanyId);
                    else
                        abm.FillVoucherHeadDTOCache(accountYear.From, accountYear.To, reportResult.ActorCompanyId);

                    // Translate Account Names
                    if (accountStdsInInterval != null)
                    {
                        accountStdsInInterval = AccountManager.TranslateAccountNamesByLang(accountStdsInInterval); // 2015-04-27 / Jukka - Translate account names for the names for which current translation exists
                    }
                    // Hela året
                    biBalanceChangeYearDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalanceChangeYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                    // Hela Förra året
                    if (previousAccountYear != null)
                        biBalanceChangePreviousYearDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);

                    //Omsättning  inom period (hela urvalet)
                    if (accountYear != null && reportParams.DateFrom.Day == 1 && CalendarUtility.GetLastDateOfMonth(reportParams.DateTo.Date) == reportParams.DateTo.Date)
                    {
                        biBalancechangePeriodDict = abm.GetBalanceChangeFromDTO(accountYear, reportParams.DateFrom, reportParams.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                    }
                    else
                    {
                        biBalancechangePeriodDict = abm.GetBalanceChangeFromDTO(reportParams.DateFrom, reportParams.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                    }


                    //Omsättning inom perioden förra året (hela urvalet)
                    if (previousAccountYear != null)
                        biBalancechangePreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);

                    //Omsättning per period i fem tidigare år
                    if (previousAccountYear != null)
                    {
                        if (previousPeriodMinus1AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus1YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus1AccountYear, prevPeriodMinus1YearDateFrom, prevPeriodMinus1YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus1YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus2AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus2YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus2AccountYear, prevPeriodMinus2YearDateFrom, prevPeriodMinus2YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus2YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus3AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus3YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus3AccountYear, prevPeriodMinus3YearDateFrom, prevPeriodMinus3YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus3YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus4AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus4YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus4AccountYear, prevPeriodMinus4YearDateFrom, prevPeriodMinus4YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus4YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus5AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus5YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus5AccountYear, prevPeriodMinus5YearDateFrom, prevPeriodMinus5YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus5YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                    }

                    //Budget inom perioden
                    if (getBudget)
                    {
                        bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                        biBudgetBalancechangePeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, reportParams.DateFrom, reportParams.DateTo, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalancechangePeriod);

                        if (hasGrossProfitCodes)
                            biGrossProfitBalanceChangePeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, reportParams.DateFrom, reportParams.DateTo, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalancechangePeriod, out voucherHeadsGrossProfitBudgetBalanceChangePeriod, delaySetAccount);
                    }

                    if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport || reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                    {
                        #region BalanceReport and ResultReport

                        #region Load data in order largest range first (to be able to use cache and re-use data)

                        // Budget
                        if (getBudget)
                        {
                            bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                            biBudgetBalanceChangeYearDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalanceChangeYear);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeYearBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalanceChangeYear, out voucherHeadsGrossProfitBudgetBalanceChangeYear, delaySetAccount);
                        }

                        // Från år start till period slut
                        biBalanceChangeIncludingPeriodDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From.Date, reportParams.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalanceChangeIncludingPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                        // Från förra året start till period slut
                        if (previousAccountYear != null)
                            biBalanceChangeIncludingPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeIncludingPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                        //Budget
                        if (getBudget)
                        {
                            bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                            biBudgetBalanceChangeIncludingPeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, reportParams.DateTo, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalanceChangeIncludingPeriod);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeIncludingPeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, reportParams.DateTo, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalanceChangeIncludingPeriod, out voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod);
                        }

                        //Från år start till period start (Edit 090319: Parameter dateTo, es.SSTD_DateFrom --> SSTD_DateTo) (Edit 090423: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom)(Edit 100322: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom.AddDays(-1))
                        biBalanceChangeToPeriodDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalanceChangeToPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                        // Budget
                        if (getBudget)
                        {
                            bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                            biBudgetBalanceChangeToPeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, reportParams.UntilDateFrom(), accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalanceChangeToPeriod);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeToPeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, reportParams.UntilDateFrom(), accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalanceChangeToPeriod, out voucherHeadsGrossProfitBudgetBalanceChangeToPeriod, delaySetAccount);
                        }

                        // Förra året
                        if (previousAccountYear != null)
                            biBalanceChangeToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeToPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);

                        #endregion


                        //GrossProfitCode
                        if (hasGrossProfitCodes)
                        {

                            biGrossProfitBalanceChangePeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, reportParams.DateFrom, reportParams.DateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);

                            biGrossProfitBalanceChangeToPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, reportParams.DateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);

                            biGrossProfitBalanceChangeIncludingPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, reportParams.DateTo, accountStdsInInterval, allAccountDTOStds, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                            biGrossProfitBalanceChangeYearDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, allAccountDTOStds, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                            //Förra året
                            if (previousAccountYear != null)
                            {
                                biGrossProfitBalanceChangePreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);

                                biGrossProfitBalanceChangeToPreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);

                                biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                                biGrossProfitBalanceChangePreviousYearDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                            }
                        }

                        #endregion

                        if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                        {
                            #region BalanceReport

                            //Ingående balans för aktuellt år
                            biYearInBalanceDict = abm.GetYearInBalanceFromDTO(entities, accountYear, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId);
                            //Ingående balans för förra året
                            if (previousAccountYear != null)
                                biYearInBalancePreviousYearDict = abm.GetYearInBalanceFromDTO(entities, previousAccountYear, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId);

                            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport && reportParams.IncludeAllHistoricalData)
                            {
                                //All data fram till dagen innan urval start
                                biAccountBalanceChangeAllPreviousToPeriodDict = abm.GetBalanceChangeFromDTO(null, reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousToPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                                //All data fram till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(null, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousToPreviousYearPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);

                                //All data från 1 jan till dagen innan urval start
                                biAccountBalanceChangeAllPreviousThisYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(reportParams.DateFrom), reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousThisYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                                //All data från 1 jan förra året till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousPreviousYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(prevYearDateFrom), prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousPreviousYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                            }
                            #endregion
                        }
                        else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport && reportParams.IncludeAllHistoricalData)
                        {
                            #region ResultReport

                            //All data fram till dagen innan urval start
                            biAccountBalanceChangeAllPreviousToPeriodDict = abm.GetBalanceChangeFromDTO(null, reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousToPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                            //All data fram till dagen innan urval start förra året
                            if (previousAccountYear != null)
                                biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(null, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousToPreviousYearPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);

                            //All data från 1 jan till dagen innan urval start
                            biAccountBalanceChangeAllPreviousThisYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(reportParams.DateFrom), reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousThisYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);
                            //All data från 1 jan förra året till dagen innan urval start förra året
                            if (previousAccountYear != null)
                                biAccountBalanceChangeAllPreviousPreviousYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(prevYearDateFrom), prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousPreviousYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers, delaySetAccount);

                            #endregion
                        }
                    }
                    #endregion

                    #region Check which accounts that got balance

                    List<int> accountIdsWithBalance = new List<int>();

                    foreach (AccountDTO accountStd in accountStdsInInterval)
                    {
                        if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && biBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeIncludingPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && biBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && biYearInBalanceDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biBalancechangePreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeIncludingPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeIncludingPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId) && biBalanceChangePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && biYearInBalancePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && biBudgetBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && biBudgetBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId) && biBudgetBalanceChangeIncludingPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && biBudgetBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    #endregion

                    #region Content

                    #region Sheet

                    int sheetId = 1;
                    XElement sheetElement = new XElement("Sheet");
                    if (accountInternalsInInterval.Count > 0 && reportParams.SSTD_SeparateAccountDim)
                    {
                        AccountInternalDTO accountinternal = reportAccountInternalsSpecificDim.ElementAt(currentAccountIdx);

                        var accountdiminternal = accountDimInternals.FirstOrDefault(i => i.AccountDimId == accountinternal.AccountDimId);
                        sheetElement.Add(
                            new XAttribute("id", (reportI + 1)),
                            new XElement("DimensionNr", accountinternal?.AccountDimNr.ToString()),
                            new XElement("DimensionName", accountdiminternal?.Name),
                            new XElement("InternalNr", accountinternal?.AccountNr),
                            new XElement("InternalName", accountinternal?.Name)
                        );
                    }
                    else
                    {
                        sheetElement.Add(
                        new XAttribute("id", sheetId),
                        new XElement("DimensionNr", String.Empty),
                        new XElement("DimensionName", String.Empty),
                        new XElement("InternalNr", String.Empty),
                        new XElement("InternalName", String.Empty));
                    }
                    #endregion

                    int reportGroupXmlId = 1;
                    foreach (var reportGroup in reportGroups)
                    {
                        #region ReportGroup

                        #region Init

                        bool invertRow = reportGroup.InvertRow;

                        //BalanceReport, ResultReport, SRU,
                        decimal groupSumAccountBalancechangePeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriod = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                        //previousYear
                        decimal groupSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                        //PreviousYearPeriodOnly to be able to look at the year for multiple periods
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus1Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus2Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus3Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus4Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus5Year = Decimal.Zero;

                        //Budget
                        decimal groupSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                        //BalanceReport, ResultReport
                        decimal groupSumAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;

                        //previousYear
                        decimal groupSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;

                        //Budget
                        decimal groupSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeYear = Decimal.Zero;
                        decimal groupSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYear = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangePeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal groupSumAccountBalancechangePreviousYear = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYear = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPreviousYearPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = Decimal.Zero;

                        //Budget
                        decimal groupSumBudgetAccountBalancechangeYear = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangePeriodDiff = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeToPeriodDiff = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                        //BalanceReport
                        decimal groupSumAccountPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountYearInBalance = Decimal.Zero;
                        decimal groupSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYearInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalance = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountPeriodInBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiffEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal groupSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountPreviousYearInBalance = Decimal.Zero;
                        decimal groupSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalancePreviousYear = Decimal.Zero;
                        decimal groupSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountPreviousYearPeriodInBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountPreviousYearPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiffPreviousYear = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiffPreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiffPreviousYear = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiffPreviousYearEntCurrency = Decimal.Zero;

                        //ResultReport
                        decimal groupSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                        //PreviousYear
                        decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;

                        //Grossprofit and Budget
                        decimal groupSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitToPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitIncludingPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitYear = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                        List<XElement> reportHeaderElements = new List<XElement>();

                        #endregion

                        #region AccountStds

                        DateTime startAccount = DateTime.UtcNow;


                        //AccountStds for ReportGroup
                        var reportHeaderIntervalsForReportGroup = reportGroup.ReportHeaders
                            .SelectMany(r => r.ReportHeaderIntervals)
                            .ToList();

                        List<AccountDTO> accountStdsForReportGroup = new List<AccountDTO>();
                        foreach (AccountDTO accountStd in accountStdsInInterval)
                        {
                            foreach (var interval in reportHeaderIntervalsForReportGroup)
                            {
                                if (Validator.IsAccountInInterval(accountStd.AccountNr, interval.IntervalFrom, interval.IntervalTo))
                                {
                                    accountStdsForReportGroup.Add(accountStd);
                                    break;
                                }
                            }
                        }

                        #endregion

                        #endregion


                        int reportHeaderXmlId = 1;
                        foreach (var reportHeader in reportGroup.ReportHeaders)
                        {
                            #region ReportHeader

                            #region Init

                            //BalanceReport, ResultReport, SRU
                            decimal headerSumAccountBalancechangePeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                            //PreviousPeriod
                            decimal headerSumAccountBalancechangePreviousPeriodMinus1Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus2Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus3Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus4Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus5Year = Decimal.Zero;

                            //Budget
                            decimal headerSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                            //BalanceReport, ResultReport
                            decimal headerSumAccountBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeYear = Decimal.Zero;
                            decimal headerSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYear = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangePeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountBalancechangePreviousYear = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = Decimal.Zero;

                            //Budget
                            decimal headerSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeYear = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangePeriodDiff = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeToPeriodDiff = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                            //BalanceReport
                            decimal headerSumAccountPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountYearInBalance = Decimal.Zero;
                            decimal headerSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYearInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalance = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountPeriodInBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiffEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountPreviousYearInBalance = Decimal.Zero;
                            decimal headerSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalancePreviousYear = Decimal.Zero;
                            decimal headerSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountPreviousYearPeriodInBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountPreviousYearPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiffPreviousYear = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiffPreviousYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiffPreviousYear = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiffPreviousYearEntCurrency = Decimal.Zero;

                            //ResultReport
                            decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;

                            //GrossProfit and Budget
                            decimal headerSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitYear = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                            List<XElement> accountElementsForHeader = new List<XElement>();

                            #endregion

                            #region AccountStd

                            //AccountStds for ReportHeader
                            List<AccountDTO> accountStdsForReportHeader = new List<AccountDTO>();
                            foreach (AccountDTO accountStd in accountStdsForReportGroup)
                            {
                                accountStd.GrossProfitCode = new List<int?>();

                                foreach (var interval in reportHeader.ReportHeaderIntervals)
                                {

                                    if (StringUtility.IsInInterval(accountStd.AccountNr, interval.IntervalFrom, interval.IntervalTo))
                                    {
                                        if (accountStd.GrossProfitCode == null)
                                            accountStd.GrossProfitCode = new List<int?>();

                                        accountStd.GrossProfitCode.Add(interval.SelectValue);
                                        if (reportHeader.ShowZeroRow || accountIdsWithBalance.Contains(accountStd.AccountId))
                                            accountStdsForReportHeader.Add(accountStd);
                                        break;
                                    }
                                }
                            }

                            #endregion

                            #endregion

                            int accountXmlId = 1;
                            foreach (AccountDTO accountStd in accountStdsForReportHeader)
                            {
                                #region AccountStd

                                #region Init BalanceReport, ResultReport, SRU

                                bool onlyGrossCodesInInterval = false;
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty() && hasGrossProfitCodes)
                                {
                                    bool grossInInterval = false;
                                    bool netInInterval = false;

                                    foreach (var interval in reportHeader.ReportHeaderIntervals)
                                    {
                                        if (StringUtility.IsInInterval(accountStd.AccountNr, interval.IntervalFrom, interval.IntervalTo))
                                        {
                                            if (!interval.SelectValue.HasValue)
                                                netInInterval = true;

                                            if (interval.SelectValue.HasValue)
                                                grossInInterval = true;
                                        }
                                    }

                                    if (grossInInterval)
                                        onlyGrossCodesInInterval = true;

                                    if (netInInterval)
                                        onlyGrossCodesInInterval = false;

                                }

                                BalanceItemDTO biBalancechangePeriod = new BalanceItemDTO();

                                //Previus Year
                                BalanceItemDTO biBalancechangePreviousYearPeriod = new BalanceItemDTO();

                                //Previous Periods
                                BalanceItemDTO biBalancechangePreviousPeriodMinus1YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus2YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus3YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus4YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus5YearPeriod = new BalanceItemDTO();

                                //Budget
                                BalanceItemDTO biBudgetBalancechangePeriod = new BalanceItemDTO();

                                #endregion

                                #region Init BalanceReport, ResultReport

                                BalanceItemDTO biBalancechangeToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeIncludingPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeYear = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousYearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeIncludingPreviousYearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousYear = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus1Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus2Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus3Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus4Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus5Year = new BalanceItemDTO();
                                BalanceItemDTO biBudgetBalancechangeToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBudgetBalancechangeIncludingPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBudgetBalancechangeYear = new BalanceItemDTO();

                                decimal accountBalancechangePeriodDiff = Decimal.Zero;
                                decimal accountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeToPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPeriod = Decimal.Zero;
                                decimal accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitToPeriod = Decimal.Zero;
                                decimal accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitIncludingPeriod = Decimal.Zero;
                                decimal accountGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitYear = Decimal.Zero;
                                decimal accountGrossProfitYearEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPeriodInBalance = Decimal.Zero;
                                decimal accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                                decimal accountGrossProfitYearOpeningBalance = Decimal.Zero;
                                decimal accountGrossProfitYearEntCurrencyOpeningBalance = Decimal.Zero;

                                //PreviousYear
                                decimal accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                                decimal accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitIncludingPreviousYearPeriod = Decimal.Zero;
                                decimal accountGrossProfitIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPreviousYear = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearOpeningBalance = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Decimal.Zero;
                                decimal accountBalancechangePreviousYearPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangePreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeToPreviousYearPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeToPreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeIncludingPreviousYearPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = Decimal.Zero;

                                //Budget
                                decimal accountBudgetBalancechangePeriodDiff = Decimal.Zero;
                                decimal accountBudgetBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBudgetBalancechangeToPeriodDiff = Decimal.Zero;
                                decimal accountBudgetBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBudgetBalancechangeIncludingPeriodDiff = Decimal.Zero;
                                decimal accountBudgetBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                                //Budget and GrossProfit
                                decimal accountBudgetGrossProfitPeriod = Decimal.Zero;
                                decimal accountBudgetGrossProfitPeriodEntCurrency = Decimal.Zero;
                                decimal accountBudgetGrossProfitToPeriod = Decimal.Zero;
                                decimal accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                decimal accountBudgetGrossProfitIncludingPeriod = Decimal.Zero;
                                decimal accountBudgetGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                decimal accountBudgetGrossProfitYear = Decimal.Zero;
                                decimal accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;

                                //Voucher Period Summery
                                decimal accountQuantity = Decimal.Zero;
                                decimal accountPeriod1 = Decimal.Zero;
                                decimal accountPeriod2 = Decimal.Zero;
                                decimal accountPeriod3 = Decimal.Zero;
                                decimal accountPeriod4 = Decimal.Zero;
                                decimal accountPeriod5 = Decimal.Zero;
                                decimal accountPeriod6 = Decimal.Zero;
                                decimal accountPeriod7 = Decimal.Zero;
                                decimal accountPeriod8 = Decimal.Zero;
                                decimal accountPeriod9 = Decimal.Zero;
                                decimal accountPeriod10 = Decimal.Zero;
                                decimal accountPeriod11 = Decimal.Zero;
                                decimal accountPeriod12 = Decimal.Zero;

                                //PreviousYear Voucher Period Summery
                                decimal previousYearAccountPeriod1 = Decimal.Zero;
                                decimal previousYearAccountPeriod2 = Decimal.Zero;
                                decimal previousYearAccountPeriod3 = Decimal.Zero;
                                decimal previousYearAccountPeriod4 = Decimal.Zero;
                                decimal previousYearAccountPeriod5 = Decimal.Zero;
                                decimal previousYearAccountPeriod6 = Decimal.Zero;
                                decimal previousYearAccountPeriod7 = Decimal.Zero;
                                decimal previousYearAccountPeriod8 = Decimal.Zero;
                                decimal previousYearAccountPeriod9 = Decimal.Zero;
                                decimal previousYearAccountPeriod10 = Decimal.Zero;
                                decimal previousYearAccountPeriod11 = Decimal.Zero;
                                decimal previousYearAccountPeriod12 = Decimal.Zero;

                                //Previous Period
                                decimal previousPeriodMinus1YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus2YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus3YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus4YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus5YearAccountPeriod = Decimal.Zero;

                                //Budget Voucher Period Summery
                                decimal budgetAccountPeriod1 = Decimal.Zero;
                                decimal budgetAccountPeriod2 = Decimal.Zero;
                                decimal budgetAccountPeriod3 = Decimal.Zero;
                                decimal budgetAccountPeriod4 = Decimal.Zero;
                                decimal budgetAccountPeriod5 = Decimal.Zero;
                                decimal budgetAccountPeriod6 = Decimal.Zero;
                                decimal budgetAccountPeriod7 = Decimal.Zero;
                                decimal budgetAccountPeriod8 = Decimal.Zero;
                                decimal budgetAccountPeriod9 = Decimal.Zero;
                                decimal budgetAccountPeriod10 = Decimal.Zero;
                                decimal budgetAccountPeriod11 = Decimal.Zero;
                                decimal budgetAccountPeriod12 = Decimal.Zero;

                                //Previous Year Voucher Year Summery
                                decimal accountYear0 = Decimal.Zero;
                                decimal accountYearMinus1 = Decimal.Zero;
                                decimal accountYearMinus2 = Decimal.Zero;
                                decimal accountYearMinus3 = Decimal.Zero;
                                decimal accountYearMinus4 = Decimal.Zero;

                                XElement voucherSummeryElement = null;
                                int voucherSummeryXmlId = 0;

                                //Voucher details
                                List<XElement> voucherRowElements = new List<XElement>();

                                #endregion

                                #region Calculate BalanceChangePeriod

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePeriod = biBalancechangePeriodDict[accountStd.AccountId];

                                    if (voucherHeadsBalancechangePeriod.Any())
                                    {
                                        string voucherType = "Selection";

                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount.AddRange(voucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList());
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (voucherRow.Quantity.HasValue)
                                                    accountQuantity += voucherRow.Quantity.Value;

                                                if (voucherHead.Date.Year == reportParams.DateTo.Year)
                                                    accountYear0 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-1).Year)
                                                    accountYearMinus1 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-2).Year)
                                                    accountYearMinus2 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-3).Year)
                                                    accountYearMinus3 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-4).Year)
                                                    accountYearMinus4 += voucherRow.Amount;
                                                if (firstMonth == voucherHeadMonth)
                                                    accountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    accountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    accountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    accountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    accountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    accountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    accountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    accountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    accountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    accountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    accountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    accountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                            if ((accountVoucherRowAmount != 0 || voucherRowsForAccount.Count != 0) && ((detailedInformation && reportHeader.ShowRow) || reportParams.SSTD_AccountDimId != 0))
                                                AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                    headerSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                        groupSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangePeriod

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitPeriod = Decimal.Zero;
                                        accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                accountGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBalanceChangePeriod.Any())
                                        {
                                            string voucherType = "GrossProfitCode";

                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    if (voucherRow.Quantity.HasValue)
                                                        accountQuantity += voucherRow.Quantity.Value;

                                                    if (voucherHead.Date.Year == reportParams.DateTo.Year)
                                                        accountYear0 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-1).Year)
                                                        accountYearMinus1 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-2).Year)
                                                        accountYearMinus2 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-3).Year)
                                                        accountYearMinus3 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-4).Year)
                                                        accountYearMinus4 += voucherRow.Amount;
                                                    if (firstMonth == voucherHeadMonth)
                                                        accountPeriod1 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                        accountPeriod2 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                        accountPeriod3 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                        accountPeriod4 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                        accountPeriod5 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                        accountPeriod6 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                        accountPeriod7 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                        accountPeriod8 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                        accountPeriod9 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                        accountPeriod10 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                        accountPeriod11 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                        accountPeriod12 += voucherRow.Amount;

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }

                                                if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                    AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                    headerSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                        groupSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangePeriodBudget

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            var x = pair.Value.Where(a => a.AccountId == accountStd.AccountId).ToList();
                                            foreach (var accountDto in x)
                                            {
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                    accountBudgetGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountBudgetGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBudgetBalanceChangePeriod.Any())
                                        // && detailedInformation)
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    if (firstMonth == voucherHeadMonth)
                                                        budgetAccountPeriod1 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                        budgetAccountPeriod2 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                        budgetAccountPeriod3 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                        budgetAccountPeriod4 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                        budgetAccountPeriod5 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                        budgetAccountPeriod6 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                        budgetAccountPeriod7 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                        budgetAccountPeriod8 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                        budgetAccountPeriod9 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                        budgetAccountPeriod10 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                        budgetAccountPeriod11 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                        budgetAccountPeriod12 += voucherRow.Amount;

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                    headerSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                        groupSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                    }
                                }

                                #region Calculate BalanceChangePreviousYearPeriod

                                if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousYearPeriod = biBalancechangePreviousYearPeriodDict[accountStd.AccountId];

                                    if (previousYearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousYear";

                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousYearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (firstMonth == voucherHeadMonth)
                                                    previousYearAccountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    previousYearAccountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    previousYearAccountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    previousYearAccountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    previousYearAccountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    previousYearAccountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    previousYearAccountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    previousYearAccountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    previousYearAccountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    previousYearAccountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    previousYearAccountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    previousYearAccountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                            if (accountVoucherRowAmount != 0)
                                                AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                    headerSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                        groupSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                    }
                                }
                                #endregion

                                #region Calculate GrossProfitChangePeriod Previous Year

                                if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                                        accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= prevYearDateFrom && b.PeriodTo <= prevYearDateTo).ToList();
                                                accountGrossProfitPreviousYearPeriod += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                accountGrossProfitPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }


                                        if (previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "GrossProfitCodePreviousYear";

                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    if (firstMonth == voucherHeadMonth)
                                                        previousYearAccountPeriod1 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                        previousYearAccountPeriod2 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                        previousYearAccountPeriod3 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                        previousYearAccountPeriod4 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                        previousYearAccountPeriod5 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                        previousYearAccountPeriod6 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                        previousYearAccountPeriod7 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                        previousYearAccountPeriod8 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                        previousYearAccountPeriod9 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                        previousYearAccountPeriod10 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                        previousYearAccountPeriod11 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                        previousYearAccountPeriod12 += voucherRow.Amount;

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }

                                                if (accountVoucherRowAmount != 0)
                                                    AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                    headerSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                        groupSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus1Year

                                if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus1YearPeriod = biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus1YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus1Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus1YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();

                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus2Year

                                if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus2YearPeriod = biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus2YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus2Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus2YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus3Year

                                if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus3YearPeriod = biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus3YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus3Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus3YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus4Year

                                if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus4YearPeriod = biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId];

                                    //VoucherHeadss
                                    if (previousPeriodMinus4YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus4Year";
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus4YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus5Year

                                if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus5YearPeriod = biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus5YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus5Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus5YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceBudgetChangePeriod

                                if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBudgetBalancechangePeriod = biBudgetBalancechangePeriodDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (budgetVoucherHeadsBalancechangePeriod.Any())
                                    //&& detailedInformation)
                                    {

                                        //BudgetAccountId is only used for performance
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = budgetVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (firstMonth == voucherHeadMonth)
                                                    budgetAccountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    budgetAccountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    budgetAccountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    budgetAccountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    budgetAccountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    budgetAccountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    budgetAccountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    budgetAccountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    budgetAccountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    budgetAccountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    budgetAccountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    budgetAccountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                    headerSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                        groupSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport || reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                                {
                                    #region BalanceReport and ResultReport

                                    #region Init BalanceReport

                                    BalanceItemDTO biYearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPeriodInBalance = new BalanceItemDTO();

                                    //previousYear
                                    BalanceItemDTO biPreviousYearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousYearPeriodInBalance = new BalanceItemDTO();

                                    //Previous Period
                                    BalanceItemDTO biPreviousPeriodMinus1YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus2YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus3YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus4YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus5YearInBalance = new BalanceItemDTO();

                                    decimal accountClosingBalance = Decimal.Zero;
                                    decimal accountClosingBalanceEntCurrency = Decimal.Zero;
                                    decimal accountPeriodInBalanceDiff = Decimal.Zero;
                                    decimal accountPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                                    decimal accountOpeningBalanceDiff = Decimal.Zero;
                                    decimal accountOpeningBalanceDiffEntCurrency = Decimal.Zero;
                                    decimal accountClosingBalanceDiff = Decimal.Zero;
                                    decimal accountClosingBalanceDiffEntCurrency = Decimal.Zero;

                                    //PreviousYear
                                    decimal accountClosingBalancePreviousYear = Decimal.Zero;
                                    decimal accountClosingBalancePreviousYearEntCurrency = Decimal.Zero;
                                    decimal accountPreviousYearPeriodInBalanceDiff = Decimal.Zero;
                                    decimal accountPreviousYearPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                                    decimal accountOpeningBalanceDiffPreviousYear = Decimal.Zero;
                                    decimal accountOpeningBalanceDiffPreviousYearEntCurrency = Decimal.Zero;
                                    decimal accountClosingBalanceDiffPreviousYear = Decimal.Zero;
                                    decimal accountClosingBalanceDiffPreviousYearEntCurrency = Decimal.Zero;

                                    #endregion

                                    #region Init ResultReport

                                    BalanceItemDTO biAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                    BalanceItemDTO biAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                    //PreviousYear
                                    BalanceItemDTO biAccountBalanceChangeAllPreviousToPreviousYearPeriod = new BalanceItemDTO();
                                    BalanceItemDTO biAccountBalanceChangeAllPreviousPreviousYear = new BalanceItemDTO();

                                    //Budget
                                    BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                    BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                    #endregion

                                    #region Calculate BalanceChangeToPeriod

                                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangeToPeriod = biBalanceChangeToPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (voucherHeadsBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeToSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                        headerSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                            groupSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeToPeriod

                                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitToPeriod = Decimal.Zero;
                                            accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                    accountGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "GrossProfitCodeToPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts
                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0)
                                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }


                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeToPeriod += accountGrossProfitToPeriod;
                                        headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitToPeriod += accountGrossProfitToPeriod;
                                            groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeToPeriodBudget

                                    if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountBudgetGrossProfitToPeriod = Decimal.Zero;
                                            accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                    accountBudgetGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountBudgetGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "BudgetGrossProfitCodeToPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                                voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts

                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0)
                                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountGrossProfitBalancechangeToPeriod += accountBudgetGrossProfitToPeriod;
                                        headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountGrossProfitToPeriod += accountBudgetGrossProfitToPeriod;
                                            groupSumBudgetAccountGrossProfitToPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                        }
                                    }


                                    #endregion

                                    #region Calculate BalanceChangeIncludingPeriod

                                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval && biBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        biBalancechangeIncludingPeriod = biBalanceChangeIncludingPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (voucherHeadsBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeIncludingSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeIncludingPeriod += biBalancechangeIncludingPeriod.Balance;
                                        headerSumAccountBalancechangeIncludingPeriodEntCurrency += biBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeIncludingPeriod += biBalancechangeIncludingPeriod.Balance;
                                            groupSumAccountBalancechangeIncludingPeriodEntCurrency += biBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeIncludingPeriod

                                    if (biBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitIncludingPeriod = Decimal.Zero;
                                            accountGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeIncludingPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodTo <= reportParams.DateTo).ToList();
                                                    accountGrossProfitIncludingPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitIncludingPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "GrossProfitCodeIncludingPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts

                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeIncludingPeriod += accountGrossProfitIncludingPeriod;
                                        headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency += accountGrossProfitIncludingPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitIncludingPeriod += accountGrossProfitIncludingPeriod;
                                            groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency += accountGrossProfitIncludingPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeIncludingPeriodBudget

                                    if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountBudgetGrossProfitIncludingPeriod = Decimal.Zero;
                                            accountBudgetGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeIncludingPeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                var x = pair.Value.Where(a => a.AccountId == accountStd.AccountId).ToList();
                                                foreach (var accountDto in x)
                                                {
                                                    if (accountDto != null)
                                                    {
                                                        List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodTo <= reportParams.DateTo).ToList();
                                                        accountBudgetGrossProfitIncludingPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                        accountBudgetGrossProfitIncludingPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                    }
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "BudgetGrossProfitCodeIncludingPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts

                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0)
                                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod += accountBudgetGrossProfitIncludingPeriod;
                                        headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriodEntCurrency += accountBudgetGrossProfitIncludingPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountGrossProfitIncludingPeriod += accountBudgetGrossProfitIncludingPeriod;
                                            groupSumBudgetAccountGrossProfitIncludingPeriodEntCurrency += accountBudgetGrossProfitIncludingPeriodEntCurrency;
                                        }
                                    }

                                    #endregion


                                    #region Calculate BalanceChangeToPreviousYearPeriod

                                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangeToPreviousYearPeriod = biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (previousYearVoucherHeadsBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeToPreviousYearSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = previousYearVoucherHeadsBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                        headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                            groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeToPreviousYearPeriod

                                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                                            accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                    accountGrossProfitToPreviousYearPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitToPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Any())
                                            {
                                                string voucherType = "GrossProfitCodeToPreviousYearPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts



                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                        headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                            groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BalanceChangeIncludingPreviousYearPeriod

                                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval && biBalanceChangeIncludingPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        biBalancechangeIncludingPreviousYearPeriod = biBalanceChangeIncludingPreviousYearPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (previousYearVoucherHeadsBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeIncludingPreviousYearSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = previousYearVoucherHeadsBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeIncludingPreviousYearPeriod += biBalancechangeIncludingPreviousYearPeriod.Balance;
                                        headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency += biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeIncludingPreviousYearPeriod += biBalancechangeIncludingPreviousYearPeriod.Balance;
                                            groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency += biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeIncludingPreviousYearPeriod

                                    if (biBalanceChangeIncludingPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitIncludingPreviousYearPeriod = Decimal.Zero;
                                            accountGrossProfitIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodTo <= reportParams.DateTo).ToList();
                                                    accountGrossProfitIncludingPreviousYearPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitIncludingPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "GrossProfitCodePreviousYearIncludingPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts



                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                        AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod += accountGrossProfitIncludingPreviousYearPeriod;
                                        headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriodEntCurrency += accountGrossProfitIncludingPreviousYearPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod += accountGrossProfitIncludingPreviousYearPeriod;
                                            groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriodEntCurrency += accountGrossProfitIncludingPreviousYearPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BudgetBalanceChangeToPeriod

                                    if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBudgetBalancechangeToPeriod = biBudgetBalanceChangeToPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (budgetVoucherHeadsBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "BudgetToPeriod";

                                            //BudgetAccountId is only used for performance
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = budgetVoucherHeadsBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                        headerSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                            groupSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BudgetBalanceChangeIncludingPeriod

                                    if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval && biBudgetBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        biBudgetBalancechangeIncludingPeriod = biBudgetBalanceChangeIncludingPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (budgetVoucherHeadsBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "BudgetIncludingPeriod";

                                            //BudgetAccountId is only used for performance
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = budgetVoucherHeadsBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountBalancechangeIncludingPeriod += biBudgetBalancechangeIncludingPeriod.Balance;
                                        headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency += biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountBalancechangeIncludingPeriod += biBudgetBalancechangeIncludingPeriod.Balance;
                                            groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency += biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BalanceChangeYear

                                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangeYear = biBalanceChangeYearDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (voucherHeadsBalanceChangeYear.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeYear";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsBalanceChangeYear.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                        headerSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                            groupSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                        }
                                    }

                                    #region Calculate GrossProfitCode BalanceChangeYear

                                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitYear = Decimal.Zero;
                                            accountGrossProfitYearEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (var pair in biGrossProfitBalanceChangeYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime startYear = accountYear.From;
                                                    DateTime endYear = accountYear.To;

                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitYear += accountGrossProfitYear;
                                        headerSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitYear += accountGrossProfitYear;
                                            groupSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitCode BalanceChangeYear Budget

                                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountBudgetGrossProfitYear = Decimal.Zero;
                                            accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (var pair in biGrossProfitBalanceChangeYearBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime startYear = accountYear.From;
                                                    DateTime endYear = accountYear.To;

                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                    accountBudgetGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountBudgetGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                        headerSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                            groupSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Calculate BalanceChangePreviousYear

                                    if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangePreviousYear = biBalanceChangePreviousYearDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (previousYearVoucherHeadsBalanceChangeYear.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangePreviousYear";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = previousYearVoucherHeadsBalanceChangeYear.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                        headerSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                            groupSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                        }
                                    }

                                    #region Calculate GrossProfitCode BalanceChangePreviousYear

                                    if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitPreviousYear = Decimal.Zero;
                                            accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;

                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();
                                            foreach (var pair in biGrossProfitBalanceChangePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime startYear = previousAccountYear.From;
                                                    DateTime endYear = previousAccountYear.To;

                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitPreviousYear += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                    accountGrossProfitPreviousYearEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangePreviousYearPeriod += accountGrossProfitPreviousYear;
                                        headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPreviousYear += accountGrossProfitPreviousYear;
                                            groupSumAccountGrossProfitPreviousYearEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                        }
                                    }

                                    #endregion


                                    #endregion

                                    #region Calculate BudgetBalanceChangeYear

                                    if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBudgetBalancechangeYear = biBudgetBalanceChangeYearDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (budgetVoucherHeadsBalanceChangeYear.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "BudgetChangeYear";

                                            //BudgetAccountId is only used for performance
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount.AddRange(budgetVoucherHeadsBalanceChangeYear.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList());
                                            AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                        headerSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                            groupSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate Diff (TODO)

                                    accountBalancechangePeriodDiff = 0; //TODO
                                    accountBalancechangePeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangePeriodDiff += accountBalancechangePeriodDiff;
                                    headerSumAccountBalancechangePeriodDiffEntCurrency += accountBalancechangePeriodDiffEntCurrency;
                                    groupSumAccountBalancechangePeriodDiff += accountBalancechangePeriodDiff;
                                    groupSumAccountBalancechangePeriodDiffEntCurrency += accountBalancechangePeriodDiffEntCurrency;

                                    accountBalancechangeToPeriodDiff = 0; //TODO
                                    accountBalancechangeToPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeToPeriodDiff += accountBalancechangeToPeriodDiff;
                                    headerSumAccountBalancechangeToPeriodDiffEntCurrency += accountBalancechangeToPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeToPeriodDiff += accountBalancechangeToPeriodDiff;
                                    groupSumAccountBalancechangeToPeriodDiffEntCurrency += accountBalancechangeToPeriodDiffEntCurrency;

                                    accountBalancechangeIncludingPeriodDiff = 0; //TODO
                                    accountBalancechangeIncludingPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeIncludingPeriodDiff += accountBalancechangeIncludingPeriodDiff;
                                    headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBalancechangeIncludingPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeIncludingPeriodDiff += accountBalancechangeIncludingPeriodDiff;
                                    groupSumAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBalancechangeIncludingPeriodDiffEntCurrency;

                                    // PreviousYear
                                    accountBalancechangePreviousYearPeriodDiff = 0; //TODO
                                    accountBalancechangePreviousYearPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangePreviousYearPeriodDiff += accountBalancechangePreviousYearPeriodDiff;
                                    headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency += accountBalancechangePreviousYearPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangePreviousYearPeriodDiff += accountBalancechangePreviousYearPeriodDiff;
                                    groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency += accountBalancechangePreviousYearPeriodDiffEntCurrency;

                                    accountBalancechangeToPreviousYearPeriodDiff = 0; //TODO
                                    accountBalancechangeToPreviousYearPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeToPreviousYearPeriodDiff += accountBalancechangeToPreviousYearPeriodDiff;
                                    headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency += accountBalancechangeToPreviousYearPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeToPreviousYearPeriodDiff += accountBalancechangeToPreviousYearPeriodDiff;
                                    groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency += accountBalancechangeToPreviousYearPeriodDiffEntCurrency;

                                    accountBalancechangeIncludingPreviousYearPeriodDiff = 0; //TODO
                                    accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff += accountBalancechangeIncludingPreviousYearPeriodDiff;
                                    headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency += accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeIncludingPreviousYearPeriodDiff += accountBalancechangeIncludingPreviousYearPeriodDiff;
                                    groupSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency += accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency;


                                    //Budget
                                    accountBudgetBalancechangePeriodDiff = 0; //TODO
                                    accountBudgetBalancechangePeriodDiffEntCurrency = 0; //TODO
                                    headerSumBudgetAccountBalancechangePeriodDiff += accountBudgetBalancechangePeriodDiff;
                                    headerSumBudgetAccountBalancechangePeriodDiffEntCurrency += accountBudgetBalancechangePeriodDiffEntCurrency;
                                    groupSumBudgetAccountBalancechangePeriodDiff += accountBudgetBalancechangePeriodDiff;
                                    groupSumBudgetAccountBalancechangePeriodDiffEntCurrency += accountBudgetBalancechangePeriodDiffEntCurrency;

                                    accountBudgetBalancechangeToPeriodDiff = 0; //TODO
                                    accountBudgetBalancechangeToPeriodDiffEntCurrency = 0; //TODO
                                    headerSumBudgetAccountBalancechangeToPeriodDiff += accountBudgetBalancechangeToPeriodDiff;
                                    headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency += accountBudgetBalancechangeToPeriodDiffEntCurrency;
                                    groupSumBudgetAccountBalancechangeToPeriodDiff += accountBudgetBalancechangeToPeriodDiff;
                                    groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency += accountBudgetBalancechangeToPeriodDiffEntCurrency;

                                    accountBudgetBalancechangeIncludingPeriodDiff = 0; //TODO
                                    accountBudgetBalancechangeIncludingPeriodDiffEntCurrency = 0; //TODO
                                    headerSumBudgetAccountBalancechangeIncludingPeriodDiff += accountBudgetBalancechangeIncludingPeriodDiff;
                                    headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBudgetBalancechangeIncludingPeriodDiffEntCurrency;
                                    groupSumBudgetAccountBalancechangeIncludingPeriodDiff += accountBudgetBalancechangeIncludingPeriodDiff;
                                    groupSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBudgetBalancechangeIncludingPeriodDiffEntCurrency;

                                    #endregion

                                    if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                                    {
                                        #region BalanceReport

                                        #region Calculate AccountBalanceChangeAllPreviousToPeriod

                                        if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousToPeriod = biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                            headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                                groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate OpeningYearBalance

                                        if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biYearInBalance = biYearInBalanceDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountYearInBalance += biYearInBalance.Balance;
                                            headerSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountYearInBalance += biYearInBalance.Balance;
                                                groupSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                            }
                                            headerSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                            headerSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                                groupSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                            }
                                        }

                                        #region Calculate GrossProfitCode

                                        if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                        {
                                            GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                            if (grossProfitCode != null)
                                            {
                                                accountGrossProfitYearOpeningBalance = Math.Round((biYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                                accountGrossProfitYearEntCurrencyOpeningBalance = Math.Round((biYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                            }
                                        }

                                        #endregion

                                        #endregion

                                        #region Calculate OpeningYearBalance Previus Year

                                        if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biPreviousYearInBalance = biYearInBalancePreviousYearDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                            headerSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                                groupSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                            }
                                            headerSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                            headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                                groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                            }
                                        }

                                        #region Calculate OpeningYearBalance GrossProfitCode PreviousYear

                                        if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                        {
                                            GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                            if (grossProfitCode != null)
                                            {
                                                accountGrossProfitPreviousYearOpeningBalance = Math.Round((biPreviousYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                                accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Math.Round((biPreviousYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                            }
                                        }

                                        #endregion

                                        #endregion

                                        #region Calculate PeriodInBalance

                                        //Ingående saldo för aktuell period. (Ingående balans för aktuellt år + Från år start till period start)
                                        //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                        biPeriodInBalance.Balance = biYearInBalance.Balance;

                                        #region Calculate GrossProfitCode

                                        if (accountYear.From != reportParams.DateFrom)
                                        {
                                            if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                            {
                                                accountGrossProfitPeriodInBalance = Decimal.Zero;
                                                accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                                                List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                                foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                                {
                                                    GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                    if (accountDto != null)
                                                    {
                                                        DateTime endYear = new DateTime(reportParams.DateFrom.Year, reportParams.DateFrom.Month, DateTime.DaysInMonth(reportParams.DateTo.Year, reportParams.DateFrom.Month)).AddMonths(-1);
                                                        List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                        accountGrossProfitPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                        accountGrossProfitPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);

                                                    }
                                                }

                                            }

                                            biPeriodInBalance.Balance += biBalancechangeToPeriod.Balance;
                                            biPeriodInBalance.BalanceEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                        }
                                        else
                                        {
                                            accountGrossProfitYearEntCurrencyOpeningBalance = accountGrossProfitYearOpeningBalance;
                                        }

                                        #endregion

                                        if (biYearInBalance.Quantity.HasValue)
                                            biPeriodInBalance.Quantity += biYearInBalance.Quantity.Value;
                                        if (biBalancechangeToPeriod.Quantity.HasValue)
                                            biPeriodInBalance.Quantity += biBalancechangeToPeriod.Quantity.Value;

                                        //Accumulate
                                        headerSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                        headerSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                            groupSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                        headerSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                            groupSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                        }

                                        #endregion

                                        #region Calculate PeriodInBalance Previus Year

                                        //Ingående saldo för aktuell period förra året. (Ingående balans för förra året + Från år start till period start)
                                        //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                        biPreviousYearPeriodInBalance.Balance = biPreviousYearInBalance.Balance;

                                        #region Calculate GrossProfitCode Previus Year

                                        if (previousAccountYear != null && previousAccountYear.From != prevYearDateFrom)
                                        {
                                            if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                            {
                                                accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                                                accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                                                List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                                foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitYearInBalancePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                                {
                                                    GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                    if (accountDto != null)
                                                    {
                                                        DateTime endYear = new DateTime(prevYearDateFrom.Year, prevYearDateFrom.Month, DateTime.DaysInMonth(prevYearDateTo.Year, prevYearDateFrom.Month)).AddMonths(-1);
                                                        List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                        accountGrossProfitPreviousYearPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                        accountGrossProfitPreviousYearPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                                    }
                                                }
                                            }

                                            biPreviousYearPeriodInBalance.Balance += biBalancechangeToPreviousYearPeriod.Balance;
                                            biPreviousYearPeriodInBalance.BalanceEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                        else
                                        {
                                            accountGrossProfitPreviousYearEntCurrencyOpeningBalance = accountGrossProfitPreviousYearOpeningBalance;
                                        }

                                        #endregion

                                        if (biPreviousYearInBalance.Quantity.HasValue)
                                            biPreviousYearPeriodInBalance.Quantity += biPreviousYearInBalance.Quantity.Value;

                                        if (biBalancechangeToPreviousYearPeriod.Quantity.HasValue)
                                            biPreviousYearPeriodInBalance.Quantity += biBalancechangeToPreviousYearPeriod.Quantity.Value;

                                        //Accumulate
                                        headerSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                        headerSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                            groupSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                        headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                            groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                        }

                                        #endregion

                                        #region Calculate ClosingYearBalance

                                        //Utgående balans för aktuellt år
                                        accountClosingBalance = biPeriodInBalance.Balance + biBalancechangePeriod.Balance;
                                        accountClosingBalanceEntCurrency = biPeriodInBalance.BalanceEntCurrency + biBalancechangePeriod.BalanceEntCurrency;

                                        //Accumulate
                                        headerSumAccountClosingBalance += accountClosingBalance;
                                        headerSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountClosingBalance += accountClosingBalance;
                                            groupSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                        }

                                        #endregion

                                        #region Calculate ClosingYearBalance Previus Year

                                        //Utgående balans för aktuellt år
                                        accountClosingBalancePreviousYear = biPreviousYearPeriodInBalance.Balance + biBalancechangePreviousYearPeriod.Balance;
                                        accountClosingBalancePreviousYearEntCurrency = biPreviousYearPeriodInBalance.BalanceEntCurrency + biBalancechangePreviousYearPeriod.BalanceEntCurrency;

                                        //Accumulate
                                        headerSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                        headerSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                            groupSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                        }

                                        #endregion

                                        #region Calculate Diff

                                        //Ingående saldo för jämförd period
                                        accountPeriodInBalanceDiff = headerSumAccountPeriodInBalance - headerSumAccountPreviousYearInBalance;
                                        if (accountPeriodInBalanceDiff != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountPeriodInBalanceDiff += accountPeriodInBalanceDiff;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountPeriodInBalanceDiff += accountPeriodInBalanceDiff;
                                                groupSumAccountBalancechangePeriodDiff += accountPeriodInBalanceDiff;
                                            }
                                        }

                                        //Ingående saldo för jämförd period - valuta
                                        accountPeriodInBalanceDiffEntCurrency = headerSumAccountPeriodInBalanceEntCurrency - headerSumAccountPreviousYearInBalanceEntCurrency;
                                        if (accountPeriodInBalanceDiffEntCurrency != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountPeriodInBalanceDiffEntCurrency += accountPeriodInBalanceDiffEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountPeriodInBalanceDiffEntCurrency += accountPeriodInBalanceDiffEntCurrency;
                                                groupSumAccountBalancechangePeriodDiffEntCurrency += accountPeriodInBalanceDiffEntCurrency;
                                            }
                                        }

                                        //Ingående balans för jämförd år
                                        accountOpeningBalanceDiff = headerSumAccountYearInBalance - headerSumAccountPreviousYearInBalance;
                                        if (accountOpeningBalanceDiff != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountOpeningBalanceDiff += accountOpeningBalanceDiff;
                                            groupSumAccountOpeningBalanceDiff += accountOpeningBalanceDiff;

                                            groupSumAccountBalancechangeToPeriodDiff += accountOpeningBalanceDiff;
                                        }

                                        //Ingående balans för jämförd år
                                        accountOpeningBalanceDiffEntCurrency = headerSumAccountYearInBalanceEntCurrency - headerSumAccountPreviousYearInBalanceEntCurrency;
                                        if (accountOpeningBalanceDiffEntCurrency != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountOpeningBalanceDiffEntCurrency += accountOpeningBalanceDiffEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountOpeningBalanceDiffEntCurrency += accountOpeningBalanceDiffEntCurrency;
                                                groupSumAccountBalancechangeToPeriodDiffEntCurrency += accountOpeningBalanceDiffEntCurrency;
                                            }
                                        }

                                        //Utgående balans för jämförd år
                                        accountClosingBalanceDiff = accountClosingBalance - accountClosingBalancePreviousYear;
                                        accountClosingBalanceDiffEntCurrency = accountClosingBalanceEntCurrency - accountClosingBalancePreviousYear;

                                        //Accumulate
                                        headerSumAccountClosingBalanceDiff += accountClosingBalanceDiff;
                                        headerSumAccountClosingBalanceDiffEntCurrency += accountClosingBalanceDiffEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountClosingBalanceDiff += accountClosingBalanceDiff;
                                            groupSumAccountClosingBalanceDiffEntCurrency += accountClosingBalanceDiffEntCurrency;
                                        }

                                        #endregion


                                        #endregion
                                    }
                                    else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
                                    {
                                        #region ResultReport

                                        #region Calculate AccountBalanceChangeAllPreviousToPeriod

                                        if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousToPeriod = biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                            headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                                groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate AccountBalanceChangeAllPreviousToPreviousYearPeriod

                                        if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousToPreviousYearPeriod = biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                            headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                                groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate AccountBalanceChangeAllPreviousThisYear

                                        if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousThisYear = biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                            headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                                groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate AccountBalanceChangeAllPreviousPreviousYear

                                        if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousPreviousYear = biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                            headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                                groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #endregion
                                    }

                                    #endregion

                                    #region XElement Account

                                    XElement accountElement = null;

                                    #region Init

                                    bool isInactive = accountStd.State == SoeEntityState.Inactive;
                                    decimal period = invertRow ? Decimal.Negate(biBalancechangePeriod.Balance) : biBalancechangePeriod.Balance;
                                    decimal periodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePeriod.BalanceEntCurrency) : biBalancechangePeriod.BalanceEntCurrency;
                                    decimal grossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriod) : accountGrossProfitPeriod;
                                    decimal grossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrency) : accountGrossProfitPeriodEntCurrency;
                                    decimal toPeriod = invertRow ? Decimal.Negate(biBalancechangeToPeriod.Balance) : biBalancechangeToPeriod.Balance;
                                    decimal toPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPeriod.BalanceEntCurrency) : biBalancechangeToPeriod.BalanceEntCurrency;
                                    decimal includingPeriod = invertRow ? Decimal.Negate(biBalancechangeIncludingPeriod.Balance) : biBalancechangeIncludingPeriod.Balance;
                                    decimal includingPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeIncludingPeriod.BalanceEntCurrency) : biBalancechangeIncludingPeriod.BalanceEntCurrency;
                                    decimal year = invertRow ? Decimal.Negate(biBalancechangeYear.Balance) : biBalancechangeYear.Balance;
                                    decimal yearEntCurrency = invertRow ? Decimal.Negate(biBalancechangeYear.BalanceEntCurrency) : biBalancechangeYear.BalanceEntCurrency;
                                    decimal grossProfitYear = invertRow ? Decimal.Negate(accountGrossProfitYear) : accountGrossProfitYear;
                                    decimal grossProfitEntCurrencyYear = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrency) : accountGrossProfitYearEntCurrency;
                                    decimal periodDiff = invertRow ? Decimal.Negate(accountBalancechangePeriodDiff) : accountBalancechangePeriodDiff;
                                    decimal periodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangePeriodDiffEntCurrency) : accountBalancechangePeriodDiffEntCurrency;
                                    decimal toPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeToPeriodDiff) : accountBalancechangeToPeriodDiff;
                                    decimal toPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeToPeriodDiffEntCurrency) : accountBalancechangeToPeriodDiffEntCurrency;
                                    decimal includingPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeIncludingPeriodDiff) : accountBalancechangeIncludingPeriodDiff;
                                    decimal includingPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeIncludingPeriodDiffEntCurrency) : accountBalancechangeIncludingPeriodDiffEntCurrency;
                                    //Previous Year
                                    decimal previousYearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.Balance) : biBalancechangePreviousYearPeriod.Balance;
                                    decimal previousYearPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.BalanceEntCurrency) : biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYearGrossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriod) : accountGrossProfitPreviousYearPeriod;
                                    decimal previousYearGrossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrency) : accountGrossProfitPreviousYearPeriodEntCurrency;
                                    decimal previousYearToPeriod = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.Balance) : biBalancechangeToPreviousYearPeriod.Balance;
                                    decimal previousYearToPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.BalanceEntCurrency) : biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYearIncludingPeriod = invertRow ? Decimal.Negate(biBalancechangeIncludingPreviousYearPeriod.Balance) : biBalancechangeIncludingPreviousYearPeriod.Balance;
                                    decimal previousYearIncludingPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency) : biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYear = invertRow ? Decimal.Negate(biBalancechangePreviousYear.Balance) : biBalancechangePreviousYear.Balance;
                                    decimal previousYearEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYear.BalanceEntCurrency) : biBalancechangePreviousYear.BalanceEntCurrency;
                                    decimal previousYearGrossProfit = invertRow ? Decimal.Negate(accountGrossProfitPreviousYear) : accountGrossProfitPreviousYear;
                                    decimal previousYearGrossProfitEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearEntCurrency) : accountGrossProfitPreviousYearEntCurrency;
                                    decimal previousYearperiodDiff = invertRow ? Decimal.Negate(accountBalancechangePreviousYearPeriodDiff) : accountBalancechangePreviousYearPeriodDiff;
                                    decimal previousYearperiodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangePreviousYearPeriodDiffEntCurrency) : accountBalancechangePreviousYearPeriodDiffEntCurrency;
                                    decimal previousYearToPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeToPreviousYearPeriodDiff) : accountBalancechangeToPreviousYearPeriodDiff;
                                    decimal previousYearToPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeToPreviousYearPeriodDiffEntCurrency) : accountBalancechangeToPreviousYearPeriodDiffEntCurrency;
                                    decimal previousYearIncludingPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeIncludingPreviousYearPeriodDiff) : accountBalancechangeIncludingPreviousYearPeriodDiff;
                                    decimal previousYearIncludingPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency) : accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency;
                                    //Previous Period
                                    decimal previousPeriodMinus1YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus1YearPeriod.Balance) : biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                    decimal previousPeriodMinus2YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus2YearPeriod.Balance) : biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                    decimal previousPeriodMinus3YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus3YearPeriod.Balance) : biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                    decimal previousPeriodMinus4YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus4YearPeriod.Balance) : biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                    decimal previousPeriodMinus5YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus5YearPeriod.Balance) : biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                    //Budget
                                    decimal budgetPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.Balance) : biBudgetBalancechangePeriod.Balance;
                                    decimal budgetPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.BalanceEntCurrency) : biBudgetBalancechangePeriod.BalanceEntCurrency;
                                    decimal budgetToPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.Balance) : biBudgetBalancechangeToPeriod.Balance;
                                    decimal budgetToPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.BalanceEntCurrency) : biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                    decimal budgetIncludingPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangeIncludingPeriod.Balance) : biBudgetBalancechangeIncludingPeriod.Balance;
                                    decimal budgetIncludingPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency) : biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency;
                                    decimal budgetYear = invertRow ? Decimal.Negate(biBudgetBalancechangeYear.Balance) : biBudgetBalancechangeYear.Balance;
                                    decimal budgetYearEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeYear.BalanceEntCurrency) : biBudgetBalancechangeYear.BalanceEntCurrency;
                                    decimal budgetPeriodDiff = invertRow ? Decimal.Negate(accountBudgetBalancechangePeriodDiff) : accountBudgetBalancechangePeriodDiff;
                                    decimal budgetPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBudgetBalancechangePeriodDiffEntCurrency) : accountBudgetBalancechangePeriodDiffEntCurrency;
                                    decimal budgetToPeriodDiff = invertRow ? Decimal.Negate(accountBudgetBalancechangeToPeriodDiff) : accountBudgetBalancechangeToPeriodDiff;
                                    decimal budgetToPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBudgetBalancechangeToPeriodDiffEntCurrency) : accountBudgetBalancechangeToPeriodDiffEntCurrency;
                                    decimal budgetIncludingPeriodDiff = invertRow ? Decimal.Negate(accountBudgetBalancechangeIncludingPeriodDiff) : accountBudgetBalancechangeIncludingPeriodDiff;
                                    decimal budgetIncludingPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBudgetBalancechangeIncludingPeriodDiffEntCurrency) : accountBudgetBalancechangeIncludingPeriodDiffEntCurrency;

                                    //Do not include inactive accounts that has no balance
                                    //if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport || reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                                    //{
                                    //    if (isInactive && NumberUtility.IsAllZero(period, toPeriod, includingPeriod, year, periodDiff, toPeriodDiff, includingPeriodDiff, previousPeriodMinus1YearPeriod, previousPeriodMinus2YearPeriod, previousPeriodMinus3YearPeriod, previousPeriodMinus4YearPeriod, previousPeriodMinus5YearPeriod))
                                    //        continue;
                                    //}

                                    #endregion

                                    #region Add elements

                                    accountElement = new XElement("Account",
                                        new XAttribute("id", accountXmlId),
                                        new XElement("AccountNr", accountStd.AccountNr),
                                        new XElement("AccountName", accountStd.Name),
                                        new XElement("AccountInternalNr1", String.Empty), //TODO
                                        new XElement("AccountInternalName1", String.Empty), //TODO
                                        new XElement("AccountInternalNr2", String.Empty), //TODO
                                        new XElement("AccountInternalName2", String.Empty), //TODO
                                        new XElement("AccountInternalNr3", String.Empty), //TODO
                                        new XElement("AccountInternalName3", String.Empty), //TODO
                                        new XElement("AccountInternalNr4", String.Empty), //TODO
                                        new XElement("AccountInternalName4", String.Empty), //TODO
                                        new XElement("AccountInternalNr5", String.Empty), //TODO
                                        new XElement("AccountInternalName5", String.Empty), //TODO
                                        new XElement("AccountInternalNr6", String.Empty), //TODO
                                        new XElement("AccountInternalName6", String.Empty), //TODO
                                        new XElement("AccountBalancechangePeriod", period),
                                        new XElement("AccountBalancechangePeriodEntCurrency", periodEntCurrency),
                                        new XElement("AccountGrossProfitPeriod", grossProfitPeriod),
                                        new XElement("AccountGrossProfitPeriodEntCurrency", grossProfitEntCurrencyPeriod),
                                        new XElement("AccountBalancechangeToPeriod", toPeriod),
                                        new XElement("AccountBalancechangeToPeriodEntCurrency", toPeriodEntCurrency),
                                        new XElement("AccountBalancechangeIncludingPeriod", includingPeriod),
                                        new XElement("AccountBalancechangeIncludingPeriodEntCurrency", includingPeriodEntCurrency),
                                        new XElement("AccountBalancechangeYear", year),
                                        new XElement("AccountBalancechangeYearEntCurrency", yearEntCurrency),
                                        new XElement("AccountGrossProfitYear", grossProfitYear),
                                        new XElement("AccountGrossProfitYearEntCurrency", grossProfitEntCurrencyYear),
                                        new XElement("AccountBalancechangePeriodDiff", periodDiff),
                                        new XElement("AccountBalancechangePeriodDiffEntCurrency", periodDiffEntCurrency),
                                        new XElement("AccountBalancechangeToPeriodDiff", toPeriodDiff),
                                        new XElement("AccountBalancechangeToPeriodDiffEntCurrency", toPeriodDiffEntCurrency),
                                        new XElement("AccountBalancechangeIncludingPeriodDiff", includingPeriodDiff),
                                        new XElement("AccountBalancechangeIncludingPeriodDiffEntCurrency", includingPeriodDiffEntCurrency),
                                        //Previous Year
                                        new XElement("PreviousYearAccountBalancechangePeriod", previousYearPeriod),
                                        new XElement("PreviousYearAccountBalancechangePeriodEntCurrency", previousYearPeriodEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitPeriod", previousYearGrossProfitPeriod),
                                        new XElement("PreviousYearAccountGrossProfitPeriodEntCurrency", previousYearGrossProfitEntCurrencyPeriod),
                                        new XElement("PreviousYearAccountBalancechangeToPeriod", previousYearToPeriod),
                                        new XElement("PreviousYearAccountBalancechangeToPeriodEntCurrency", previousYearToPeriodEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriod", previousYearIncludingPeriod),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriodEntCurrency", previousYearIncludingPeriodEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeYear", previousYear),
                                        new XElement("PreviousYearAccountBalancechangeYearEntCurrency", previousYearEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitYear", previousYearGrossProfit),
                                        new XElement("PreviousYearAccountGrossProfitYearEntCurrency", previousYearGrossProfitEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangePeriodDiff", previousYearperiodDiff),
                                        new XElement("PreviousYearAccountBalancechangePeriodDiffEntCurrency", previousYearperiodDiffEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeToPeriodDiff", previousYearToPeriodDiff),
                                        new XElement("PreviousYearAccountBalancechangeToPeriodDiffEntCurrency", previousYearToPeriodDiffEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriodDiff", previousYearIncludingPeriodDiff),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriodDiffEntCurrency", previousYearIncludingPeriodDiffEntCurrency),
                                        //previous Period
                                        new XElement("PreviousPeriodMinus1YearAccountBalancechangePeriod", previousPeriodMinus1YearPeriod),
                                        new XElement("PreviousPeriodMinus2YearAccountBalancechangePeriod", previousPeriodMinus2YearPeriod),
                                        new XElement("PreviousPeriodMinus3YearAccountBalancechangePeriod", previousPeriodMinus3YearPeriod),
                                        new XElement("PreviousPeriodMinus4YearAccountBalancechangePeriod", previousPeriodMinus4YearPeriod),
                                        new XElement("PreviousPeriodMinus5YearAccountBalancechangePeriod", previousPeriodMinus5YearPeriod),

                                        //Budget
                                        new XElement("BudgetAccountBalancechangePeriod", budgetPeriod),
                                        new XElement("BudgetAccountBalancechangePeriodEntCurrency", budgetPeriodEntCurrency),
                                        new XElement("BudgetAccountBalancechangeToPeriod", budgetToPeriod),
                                        new XElement("BudgetAccountBalancechangeToPeriodEntCurrency", budgetToPeriodEntCurrency),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriod", budgetIncludingPeriod),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriodEntCurrency", budgetIncludingPeriodEntCurrency),
                                        new XElement("BudgetAccountBalancechangeYear", budgetYear),
                                        new XElement("BudgetAccountBalancechangeYearEntCurrency", budgetYearEntCurrency),
                                        new XElement("BudgetAccountGrossProfitPeriod", accountBudgetGrossProfitPeriod),
                                        new XElement("BudgetAccountBalancechangePeriodDiff", budgetPeriodDiff),
                                        new XElement("BudgetAccountBalancechangePeriodDiffEntCurrency", budgetPeriodDiffEntCurrency),
                                        new XElement("BudgetAccountBalancechangeToPeriodDiff", budgetToPeriodDiff),
                                        new XElement("BudgetAccountBalancechangeToPeriodDiffEntCurrency", budgetToPeriodDiffEntCurrency),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriodDiff", budgetIncludingPeriodDiff),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriodDiffEntCurrency", budgetIncludingPeriodDiffEntCurrency));


                                    #endregion

                                    if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                    {
                                        #region BalanceReport

                                        #region Init

                                        decimal periodInBalance = invertRow ? Decimal.Negate(biPeriodInBalance.Balance) : biPeriodInBalance.Balance;
                                        decimal periodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPeriodInBalance.BalanceEntCurrency) : biPeriodInBalance.BalanceEntCurrency;
                                        decimal grossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPeriodInBalance) : accountGrossProfitPeriodInBalance;
                                        decimal grossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrencyInBalance) : accountGrossProfitPeriodEntCurrencyInBalance;
                                        decimal periodOpeningBalance = invertRow ? Decimal.Negate(biYearInBalance.Balance) : biYearInBalance.Balance;
                                        decimal periodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biYearInBalance.BalanceEntCurrency) : biYearInBalance.BalanceEntCurrency;
                                        decimal grossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitYearOpeningBalance) : accountGrossProfitYearOpeningBalance;
                                        decimal grossProfitPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrencyOpeningBalance) : accountGrossProfitYearEntCurrencyOpeningBalance;
                                        decimal periodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalance) : accountClosingBalance;
                                        decimal periodClosingBalanceEntCurrency = invertRow ? Decimal.Negate(accountClosingBalanceEntCurrency) : accountClosingBalanceEntCurrency;
                                        decimal periodInBalanceDiff = invertRow ? Decimal.Negate(accountPeriodInBalanceDiff) : accountPeriodInBalanceDiff;
                                        decimal periodInBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountPeriodInBalanceDiffEntCurrency) : accountPeriodInBalanceDiffEntCurrency;
                                        decimal periodOpeningBalanceDiff = invertRow ? Decimal.Negate(accountOpeningBalanceDiff) : accountOpeningBalanceDiff;
                                        decimal periodOpeningBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountOpeningBalanceDiffEntCurrency) : accountOpeningBalanceDiffEntCurrency;
                                        decimal periodClosingBalanceDiff = invertRow ? Decimal.Negate(accountClosingBalanceDiff) : accountClosingBalanceDiff;
                                        decimal periodClosingBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountClosingBalanceDiffEntCurrency) : accountClosingBalanceDiffEntCurrency;

                                        decimal accountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.Balance) : biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                        decimal accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;

                                        //PreviousYear
                                        decimal previousYearPeriodInBalance = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.Balance) : biPreviousYearPeriodInBalance.Balance;
                                        decimal previousYearPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.BalanceEntCurrency) : biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                        decimal previousYearGrossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodInBalance) : accountGrossProfitPreviousYearPeriodInBalance;
                                        decimal previousYearGrossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrencyInBalance) : accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                        decimal previousYearPeriodOpeningBalance = invertRow ? Decimal.Negate(biPreviousYearInBalance.Balance) : biPreviousYearInBalance.Balance;
                                        decimal previousYearPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearInBalance.BalanceEntCurrency) : biPreviousYearInBalance.BalanceEntCurrency;
                                        decimal previousYearGrossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearOpeningBalance) : accountGrossProfitPreviousYearOpeningBalance;
                                        decimal previousYearGrossProfitPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearEntCurrencyOpeningBalance) : accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                        decimal previousYearPeriodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalancePreviousYear) : accountClosingBalancePreviousYear;
                                        decimal previousYearPeriodClosingBalanceEntCurrency = invertRow ? Decimal.Negate(accountClosingBalancePreviousYearEntCurrency) : accountClosingBalancePreviousYearEntCurrency;
                                        decimal previousYearPeriodInBalanceDiff = invertRow ? Decimal.Negate(accountPreviousYearPeriodInBalanceDiff) : accountPreviousYearPeriodInBalanceDiff;
                                        decimal previousYearPeriodInBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountPreviousYearPeriodInBalanceDiffEntCurrency) : accountPreviousYearPeriodInBalanceDiffEntCurrency;
                                        decimal previousYearPeriodOpeningBalanceDiff = invertRow ? Decimal.Negate(accountOpeningBalanceDiffPreviousYear) : accountOpeningBalanceDiffPreviousYear;
                                        decimal previousYearPeriodOpeningBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountOpeningBalanceDiffPreviousYearEntCurrency) : accountOpeningBalanceDiffPreviousYearEntCurrency;
                                        decimal previousYearPeriodClosingBalanceDiff = invertRow ? Decimal.Negate(accountClosingBalanceDiffPreviousYear) : accountClosingBalanceDiffPreviousYear;
                                        decimal previousYearPeriodClosingBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountClosingBalanceDiffPreviousYearEntCurrency) : accountClosingBalanceDiffPreviousYearEntCurrency;

                                        //Do not include inactive accounts that has no balance
                                        //if (isInactive && NumberUtility.IsAllZero(periodInBalance, periodOpeningBalance, periodClosingBalance, periodInBalanceDiff, periodOpeningBalanceDiff, periodClosingBalanceDiff))
                                        //    continue;

                                        #endregion

                                        #region Add elements

                                        accountElement.Add(
                                            new XElement("AccountPeriodInBalance", periodInBalance),
                                            new XElement("AccountPeriodInBalanceEntCurrency", periodInBalanceEntCurrency),
                                            new XElement("AccountGrossProfitPeriodInBalance", grossProfitPeriodInBalance),
                                            new XElement("AccountGrossProfitPeriodInBalanceEntCurrency", grossProfitPeriodInBalanceEntCurrency),
                                            new XElement("AccountOpeningBalance", periodOpeningBalance),
                                            new XElement("AccountOpeningBalanceEntCurrency", periodOpeningBalanceEntCurrency),
                                            new XElement("AccountGrossProfitOpeningBalance", grossProfitPeriodOpeningBalance),
                                            new XElement("AccountGrossProfitOpeningBalanceEntCurrency", grossProfitPeriodOpeningBalanceEntCurrency),
                                            new XElement("AccountClosingBalance", periodClosingBalance),
                                            new XElement("AccountClosingBalanceEntCurrency", periodClosingBalanceEntCurrency),
                                            new XElement("AccountPeriodInBalanceDiff", periodInBalanceDiff),
                                            new XElement("AccountPeriodInBalanceDiffEntCurrency", periodInBalanceDiffEntCurrency),
                                            new XElement("AccountOpeningBalanceDiff", periodOpeningBalanceDiff),
                                            new XElement("AccountOpeningBalanceDiffEntCurrency", periodOpeningBalanceDiffEntCurrency),
                                            new XElement("AccountClosingBalanceDiff", periodClosingBalanceDiff),
                                            new XElement("AccountClosingBalanceDiffEntCurrency", periodClosingBalanceDiffEntCurrency),

                                            new XElement("AccountBalanceChangeAllPreviousToPeriodBalance", accountBalanceChangeAllPreviousToPeriodBalance),
                                            new XElement("AccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                            //Previous Year
                                            new XElement("PreviousYearAccountPeriodInBalance", previousYearPeriodInBalance),
                                            new XElement("PreviousYearAccountPeriodInBalanceEntCurrency", previousYearPeriodInBalanceEntCurrency),
                                            new XElement("PreviousYearAccountGrossProfitPeriodInBalance", previousYearGrossProfitPeriodInBalance),
                                            new XElement("PreviousYearAccountGrossProfitPeriodInBalanceEntCurrency", previousYearGrossProfitPeriodInBalanceEntCurrency),
                                            new XElement("PreviousYearAccountOpeningBalance", previousYearPeriodOpeningBalance),
                                            new XElement("PreviousYearAccountOpeningBalanceEntCurrency", previousYearPeriodOpeningBalanceEntCurrency),
                                            new XElement("PreviousYearAccountGrossProfitOpeningBalance", previousYearGrossProfitPeriodOpeningBalance),
                                            new XElement("PreviousYearAccountGrossProfitOpeningBalanceEntCurrency", previousYearGrossProfitPeriodOpeningBalanceEntCurrency),
                                            new XElement("PreviousYearAccountClosingBalance", previousYearPeriodClosingBalance),
                                            new XElement("PreviousYearAccountClosingBalanceEntCurrency", previousYearPeriodClosingBalanceEntCurrency),
                                            new XElement("PreviousYearAccountPeriodInBalanceDiff", previousYearPeriodInBalanceDiff),
                                            new XElement("PreviousYearAccountPeriodInBalanceDiffEntCurrency", previousYearPeriodInBalanceDiffEntCurrency),
                                            new XElement("PreviousYearAccountOpeningBalanceDiff", previousYearPeriodOpeningBalanceDiff),
                                            new XElement("PreviousYearAccountOpeningBalanceDiffEntCurrency", previousYearPeriodOpeningBalanceDiffEntCurrency),
                                            new XElement("PreviousYearAccountClosingBalanceDiff", previousYearPeriodClosingBalanceDiff),
                                            new XElement("PreviousYearAccountClosingBalanceDiffEntCurrency", previousYearPeriodClosingBalanceDiffEntCurrency));

                                        #endregion

                                        #endregion
                                    }
                                    else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
                                    {
                                        #region ResultReport

                                        #region Init

                                        decimal accountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.Balance) : biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                        decimal accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                        decimal accountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.Balance) : biAccountBalanceChangeAllPreviousThisYear.Balance;
                                        decimal accountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                        //Previous Year
                                        decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                        decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                        decimal previousYearAccountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.Balance) : biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                        decimal previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;

                                        //Do not include inactive accounts that has no balance
                                        //if (isInactive && reportParams.IncludeAllHistoricalData && NumberUtility.IsAllZero(accountBalanceChangeAllPreviousToPeriodBalance, accountBalanceChangeAllPreviousThisYearBalance))
                                        //    continue;

                                        #endregion

                                        #region Add elements

                                        accountElement.Add(
                                            new XElement("AccountBalanceChangeAllPreviousToPeriodBalance", accountBalanceChangeAllPreviousToPeriodBalance),
                                            new XElement("AccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                            new XElement("AccountBalanceChangeAllPreviousThisYearBalance", accountBalanceChangeAllPreviousThisYearBalance),
                                            new XElement("AccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", accountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                            //Previous Year
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalance", previousYearAccountBalanceChangeAllPreviousToPeriodBalance),
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalance", previousYearAccountBalanceChangeAllPreviousThisYearBalance),
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency));

                                        #endregion

                                        #endregion
                                    }

                                    #region VoucherSummery

                                    if (accountQuantity != 0 || accountPeriod1 != 0 || accountPeriod2 != 0 || accountPeriod3 != 0 || accountPeriod4 != 0 || accountPeriod5 != 0 || accountPeriod5 != 0 || accountPeriod6 != 0 || accountPeriod7 != 0 || accountPeriod8 != 0 || accountPeriod9 != 0 || accountPeriod10 != 0 || accountPeriod11 != 0 || accountPeriod12 != 0 ||
                                        budgetAccountPeriod1 != 0 || budgetAccountPeriod2 != 0 || budgetAccountPeriod3 != 0 || budgetAccountPeriod4 != 0 || budgetAccountPeriod5 != 0 || budgetAccountPeriod6 != 0 || budgetAccountPeriod7 != 0 || budgetAccountPeriod8 != 0 || budgetAccountPeriod9 != 0 || budgetAccountPeriod10 != 0 || budgetAccountPeriod11 != 0 || budgetAccountPeriod12 != 0 ||
                                        previousYearAccountPeriod1 != 0)
                                    {
                                        voucherSummeryElement = new XElement("VoucherSummery",
                                            new XAttribute("id", voucherSummeryXmlId),
                                            new XElement("VoucherSummeryAccountNr", accountStd.AccountNr),
                                            new XElement("VoucherSummeryAccountName", accountStd.Name),
                                            new XElement("VoucherSummeryAccountQuantity", accountQuantity),
                                            new XElement("VoucherSummeryYear0", invertRow ? Decimal.Negate(accountYear0) : accountYear0),
                                            new XElement("VoucherSummeryYearMinus1", invertRow ? Decimal.Negate(accountYearMinus1) : accountYearMinus1),
                                            new XElement("VoucherSummeryYearMinus2", invertRow ? Decimal.Negate(accountYearMinus2) : accountYearMinus2),
                                            new XElement("VoucherSummeryYearMinus3", invertRow ? Decimal.Negate(accountYearMinus3) : accountYearMinus3),
                                            new XElement("VoucherSummeryYearMinus4", invertRow ? Decimal.Negate(accountYearMinus4) : accountYearMinus4),
                                            new XElement("VoucherSummeryAccountPeriod1", invertRow ? Decimal.Negate(accountPeriod1) : accountPeriod1),
                                            new XElement("VoucherSummeryAccountPeriod2", invertRow ? Decimal.Negate(accountPeriod2) : accountPeriod2),
                                            new XElement("VoucherSummeryAccountPeriod3", invertRow ? Decimal.Negate(accountPeriod3) : accountPeriod3),
                                            new XElement("VoucherSummeryAccountPeriod4", invertRow ? Decimal.Negate(accountPeriod4) : accountPeriod4),
                                            new XElement("VoucherSummeryAccountPeriod5", invertRow ? Decimal.Negate(accountPeriod5) : accountPeriod5),
                                            new XElement("VoucherSummeryAccountPeriod6", invertRow ? Decimal.Negate(accountPeriod6) : accountPeriod6),
                                            new XElement("VoucherSummeryAccountPeriod7", invertRow ? Decimal.Negate(accountPeriod7) : accountPeriod7),
                                            new XElement("VoucherSummeryAccountPeriod8", invertRow ? Decimal.Negate(accountPeriod8) : accountPeriod8),
                                            new XElement("VoucherSummeryAccountPeriod9", invertRow ? Decimal.Negate(accountPeriod9) : accountPeriod9),
                                            new XElement("VoucherSummeryAccountPeriod10", invertRow ? Decimal.Negate(accountPeriod10) : accountPeriod10),
                                            new XElement("VoucherSummeryAccountPeriod11", invertRow ? Decimal.Negate(accountPeriod11) : accountPeriod11),
                                            new XElement("VoucherSummeryAccountPeriod12", invertRow ? Decimal.Negate(accountPeriod12) : accountPeriod12),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod1", invertRow ? Decimal.Negate(previousYearAccountPeriod1) : previousYearAccountPeriod1),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod2", invertRow ? Decimal.Negate(previousYearAccountPeriod2) : previousYearAccountPeriod2),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod3", invertRow ? Decimal.Negate(previousYearAccountPeriod3) : previousYearAccountPeriod3),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod4", invertRow ? Decimal.Negate(previousYearAccountPeriod4) : previousYearAccountPeriod4),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod5", invertRow ? Decimal.Negate(previousYearAccountPeriod5) : previousYearAccountPeriod5),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod6", invertRow ? Decimal.Negate(previousYearAccountPeriod6) : previousYearAccountPeriod6),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod7", invertRow ? Decimal.Negate(previousYearAccountPeriod7) : previousYearAccountPeriod7),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod8", invertRow ? Decimal.Negate(previousYearAccountPeriod8) : previousYearAccountPeriod8),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod9", invertRow ? Decimal.Negate(previousYearAccountPeriod9) : previousYearAccountPeriod9),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod10", invertRow ? Decimal.Negate(previousYearAccountPeriod10) : previousYearAccountPeriod10),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod11", invertRow ? Decimal.Negate(previousYearAccountPeriod11) : previousYearAccountPeriod11),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod12", invertRow ? Decimal.Negate(previousYearAccountPeriod12) : previousYearAccountPeriod12),
                                            new XElement("VoucherSummeryPreviousPeriodMinus1Year", invertRow ? Decimal.Negate(previousPeriodMinus1YearAccountPeriod) : previousPeriodMinus1YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus2Year", invertRow ? Decimal.Negate(previousPeriodMinus2YearAccountPeriod) : previousPeriodMinus2YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus3Year", invertRow ? Decimal.Negate(previousPeriodMinus3YearAccountPeriod) : previousPeriodMinus3YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus4Year", invertRow ? Decimal.Negate(previousPeriodMinus4YearAccountPeriod) : previousPeriodMinus4YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus5Year", invertRow ? Decimal.Negate(previousPeriodMinus5YearAccountPeriod) : previousPeriodMinus5YearAccountPeriod),
                                            new XElement("VoucherSummeryBudgetAccountPeriod1", invertRow ? Decimal.Negate(budgetAccountPeriod1) : budgetAccountPeriod1),
                                            new XElement("VoucherSummeryBudgetAccountPeriod2", invertRow ? Decimal.Negate(budgetAccountPeriod2) : budgetAccountPeriod2),
                                            new XElement("VoucherSummeryBudgetAccountPeriod3", invertRow ? Decimal.Negate(budgetAccountPeriod3) : budgetAccountPeriod3),
                                            new XElement("VoucherSummeryBudgetAccountPeriod4", invertRow ? Decimal.Negate(budgetAccountPeriod4) : budgetAccountPeriod4),
                                            new XElement("VoucherSummeryBudgetAccountPeriod5", invertRow ? Decimal.Negate(budgetAccountPeriod5) : budgetAccountPeriod5),
                                            new XElement("VoucherSummeryBudgetAccountPeriod6", invertRow ? Decimal.Negate(budgetAccountPeriod6) : budgetAccountPeriod6),
                                            new XElement("VoucherSummeryBudgetAccountPeriod7", invertRow ? Decimal.Negate(budgetAccountPeriod7) : budgetAccountPeriod7),
                                            new XElement("VoucherSummeryBudgetAccountPeriod8", invertRow ? Decimal.Negate(budgetAccountPeriod8) : budgetAccountPeriod8),
                                            new XElement("VoucherSummeryBudgetAccountPeriod9", invertRow ? Decimal.Negate(budgetAccountPeriod9) : budgetAccountPeriod9),
                                            new XElement("VoucherSummeryBudgetAccountPeriod10", invertRow ? Decimal.Negate(budgetAccountPeriod10) : budgetAccountPeriod10),
                                            new XElement("VoucherSummeryBudgetAccountPeriod11", invertRow ? Decimal.Negate(budgetAccountPeriod11) : budgetAccountPeriod11),
                                            new XElement("VoucherSummeryBudgetAccountPeriod12", invertRow ? Decimal.Negate(budgetAccountPeriod12) : budgetAccountPeriod12));

                                        voucherSummeryXmlId += 1;
                                        if (!voucherRowElements.Any())
                                        {
                                            XElement voucherRowElement = new XElement("VoucherRow",
                                            new XAttribute("id", 1),
                                            new XElement("AccountInternalNr1"));
                                            voucherRowElements.Add(voucherRowElement);
                                        }
                                        voucherSummeryElement.Add(voucherRowElements);
                                        accountElement.Add(voucherSummeryElement);
                                    }

                                    if (!voucherRowElements.Any() || voucherSummeryXmlId == 0)
                                    {
                                        voucherSummeryElement = new XElement("VoucherSummery",
                                            new XAttribute("id", voucherSummeryXmlId),
                                            new XElement("VoucherSummeryAccountNr", "Empty"),
                                            new XElement("VoucherSummeryAccountName", "Empty Element ONLY available with detailed information"),
                                            new XElement("VoucherSummeryAccountQuantity", 0),
                                            new XElement("VoucherSummeryYear0", 0),
                                            new XElement("VoucherSummeryYearMinus1", 0),
                                            new XElement("VoucherSummeryYearMinus2", 0),
                                            new XElement("VoucherSummeryYearMinus3", 0),
                                            new XElement("VoucherSummeryYearMinus4", 0),
                                            new XElement("VoucherSummeryAccountPeriod1", 0),
                                            new XElement("VoucherSummeryAccountPeriod2", 0),
                                            new XElement("VoucherSummeryAccountPeriod3", 0),
                                            new XElement("VoucherSummeryAccountPeriod4", 0),
                                            new XElement("VoucherSummeryAccountPeriod5", 0),
                                            new XElement("VoucherSummeryAccountPeriod6", 0),
                                            new XElement("VoucherSummeryAccountPeriod7", 0),
                                            new XElement("VoucherSummeryAccountPeriod8", 0),
                                            new XElement("VoucherSummeryAccountPeriod9", 0),
                                            new XElement("VoucherSummeryAccountPeriod10", 0),
                                            new XElement("VoucherSummeryAccountPeriod11", 0),
                                            new XElement("VoucherSummeryAccountPeriod12", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod1", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod2", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod3", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod4", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod5", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod6", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod7", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod8", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod9", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod10", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod11", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod12", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus1Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus2Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus3Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus4Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus5Year", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod1", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod2", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod3", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod4", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod5", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod6", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod7", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod8", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod9", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod10", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod11", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod12", 0));

                                        voucherSummeryXmlId += 1;

                                        XElement voucherRowElement = new XElement("VoucherRow",
                                            new XAttribute("id", 1),
                                            new XElement("AccountInternalNr1"));

                                        voucherSummeryElement.Add(voucherRowElement);
                                        accountElement.Add(voucherSummeryElement);
                                    }

                                    #endregion

                                    accountElementsForHeader.Add(accountElement);

                                    #endregion
                                }

                                accountXmlId++;

                                #endregion

                                #endregion
                            }

                            #region XElement ReportHeader

                            #region BalanceReport, ResultReport, SRU

                            XElement headerElement = new XElement("Header");
                            if (reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                            {
                                headerElement.Add(
                                new XAttribute("id", reportHeaderXmlId),
                                new XElement("HeaderName", reportHeader.Name),
                                new XElement("HeaderShowLabel", reportHeader.ShowLabel.ToInt()),
                                new XElement("HeaderShowRows", reportHeader.ShowRow.ToInt()),
                                new XElement("HeaderShowZeroRows", reportHeader.ShowZeroRow.ToInt()),
                                new XElement("HeaderShowSum", reportHeader.ShowSum.ToInt()),
                                new XElement("HeaderInvertRow", reportHeader.InvertRow.ToInt()),
                                new XElement("HeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriod) : headerSumAccountBalancechangePeriod),
                                new XElement("HeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodEntCurrency) : headerSumAccountBalancechangePeriodEntCurrency),
                                new XElement("HeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountYearInBalance) : headerSumAccountYearInBalance),
                                new XElement("HeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountYearInBalanceEntCurrency) : headerSumAccountYearInBalanceEntCurrency));
                            }
                            else
                            {
                                headerElement.Add(
                                new XAttribute("id", reportHeaderXmlId),
                                new XElement("HeaderName", reportHeader.Name),
                                new XElement("HeaderShowLabel", reportHeader.ShowLabel.ToInt()),
                                new XElement("HeaderShowRows", reportHeader.ShowRow.ToInt()),
                                new XElement("HeaderShowZeroRows", reportHeader.ShowZeroRow.ToInt()),
                                new XElement("HeaderShowSum", reportHeader.ShowSum.ToInt()),
                                new XElement("HeaderInvertRow", reportHeader.InvertRow.ToInt()),
                                new XElement("HeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriod) : headerSumAccountBalancechangePeriod),
                                new XElement("HeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodEntCurrency) : headerSumAccountBalancechangePeriodEntCurrency),
                                new XElement("HeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriod) : headerSumAccountGrossProfitPeriod),
                                new XElement("HeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodEntCurrency) : headerSumAccountGrossProfitPeriodEntCurrency),
                                new XElement("HeaderSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangeIncludingPeriod) : headerSumAccountGrossProfitBalancechangeIncludingPeriod),
                                new XElement("HeaderSumAccountGrossProfitIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency) : headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency),

                                //Previous Year
                                new XElement("PreviousYearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriod) : headerSumAccountBalancechangePreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountBalancechangePreviousYearPeriodEntCurrency),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriod) : headerSumAccountGrossProfitPreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                                //Previous Period
                                new XElement("PreviousPeriodMinus1YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus1Year) : headerSumAccountBalancechangePreviousPeriodMinus1Year),
                                new XElement("PreviousPeriodMinus2YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus2Year) : headerSumAccountBalancechangePreviousPeriodMinus2Year),
                                new XElement("PreviousPeriodMinus3YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus3Year) : headerSumAccountBalancechangePreviousPeriodMinus3Year),
                                new XElement("PreviousPeriodMinus4YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus4Year) : headerSumAccountBalancechangePreviousPeriodMinus4Year),
                                new XElement("PreviousPeriodMinus5YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus5Year) : headerSumAccountBalancechangePreviousPeriodMinus5Year),
                                //Budget
                                new XElement("BudgetHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriod) : headerSumBudgetAccountBalancechangePeriod),
                                new XElement("BudgetHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodEntCurrency) : headerSumBudgetAccountBalancechangePeriodEntCurrency));
                            }
                            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
                            {
                                #region BalanceReport, ResultReport

                                headerElement.Add(
                                    new XElement("HeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriod) : headerSumAccountBalancechangeToPeriod),
                                    new XElement("HeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodEntCurrency) : headerSumAccountBalancechangeToPeriodEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriod) : headerSumAccountBalancechangeIncludingPeriod),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriodEntCurrency) : headerSumAccountBalancechangeIncludingPeriodEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYear) : headerSumAccountBalancechangeYear),
                                    new XElement("HeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYearEntCurrency) : headerSumAccountBalancechangeYearEntCurrency),
                                    new XElement("HeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYear) : headerSumAccountGrossProfitYear),
                                    new XElement("HeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearEntCurrency) : headerSumAccountGrossProfitYearEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodDiff) : headerSumAccountBalancechangePeriodDiff),
                                    new XElement("HeaderSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodDiffEntCurrency) : headerSumAccountBalancechangePeriodDiffEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodDiff) : headerSumAccountBalancechangeToPeriodDiff),
                                    new XElement("HeaderSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodDiffEntCurrency) : headerSumAccountBalancechangeToPeriodDiffEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriodDiff) : headerSumAccountBalancechangeIncludingPeriodDiff),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency) : headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency),
                                    //PreviousYear
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriod) : headerSumAccountBalancechangeToPreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency) : headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriod) : headerSumAccountBalancechangeIncludingPreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency) : headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYear) : headerSumAccountBalancechangePreviousYear),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearEntCurrency) : headerSumAccountBalancechangePreviousYearEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriod) : headerSumAccountGrossProfitBalancechangePreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod) : headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodDiff) : headerSumAccountBalancechangePreviousYearPeriodDiff),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency) : headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriodDiff) : headerSumAccountBalancechangeToPreviousYearPeriodDiff),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency) : headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff) : headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency) : headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency),

                                    //Budget
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriod) : headerSumBudgetAccountBalancechangeToPeriod),
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodEntCurrency) : headerSumBudgetAccountBalancechangeToPeriodEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriod) : headerSumBudgetAccountBalancechangeIncludingPeriod),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency) : headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYear) : headerSumBudgetAccountBalancechangeYear),
                                    new XElement("BudgetHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYearEntCurrency) : headerSumBudgetAccountBalancechangeYearEntCurrency),
                                    new XElement("BudgetHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitPeriod) : headerSumBudgetAccountGrossProfitPeriod),
                                    new XElement("BudgetHeaderSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod) : headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod),
                                    new XElement("BudgetHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYear) : headerSumBudgetAccountGrossProfitYear),
                                    new XElement("BudgetHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYearEntCurrency) : headerSumBudgetAccountGrossProfitYearEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodDiff) : headerSumBudgetAccountBalancechangePeriodDiff),
                                    new XElement("BudgetHeaderSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodDiffEntCurrency) : headerSumBudgetAccountBalancechangePeriodDiffEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodDiff) : headerSumBudgetAccountBalancechangeToPeriodDiff),
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency) : headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriodDiff) : headerSumBudgetAccountBalancechangeIncludingPeriodDiff),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency) : headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency));

                                #endregion

                                if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                {
                                    #region BalanceReport

                                    headerElement.Add(
                                        new XElement("HeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalance) : headerSumAccountPeriodInBalance),
                                        new XElement("HeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceEntCurrency) : headerSumAccountPeriodInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalance) : headerSumAccountGrossProfitPeriodInBalance),
                                        new XElement("HeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountYearInBalance) : headerSumAccountYearInBalance),
                                        new XElement("HeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountYearInBalanceEntCurrency) : headerSumAccountYearInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalance) : headerSumAccountGrossProfitYearInBalance),
                                        new XElement("HeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalanceEntCurrency) : headerSumAccountGrossProfitYearInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalance) : headerSumAccountClosingBalance),
                                        new XElement("HeaderSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceEntCurrency) : headerSumAccountClosingBalanceEntCurrency),
                                        new XElement("HeaderSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceDiff) : headerSumAccountPeriodInBalanceDiff),
                                        new XElement("HeaderSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceDiffEntCurrency) : headerSumAccountPeriodInBalanceDiffEntCurrency),
                                        new XElement("HeaderSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiff) : headerSumAccountOpeningBalanceDiff),
                                        new XElement("HeaderSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiffEntCurrency) : headerSumAccountOpeningBalanceDiffEntCurrency),
                                        new XElement("HeaderSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiff) : headerSumAccountClosingBalanceDiff),
                                        new XElement("HeaderSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiffEntCurrency) : headerSumAccountClosingBalanceDiffEntCurrency),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        //PreviousYear
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalance) : headerSumAccountPreviousYearPeriodInBalance),
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalance) : headerSumAccountGrossProfitPreviousYearPeriodInBalance),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalance) : headerSumAccountPreviousYearInBalance),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalanceEntCurrency) : headerSumAccountPreviousYearInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalance) : headerSumAccountGrossProfitPreviousYearInBalance),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYear) : headerSumAccountClosingBalancePreviousYear),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYearEntCurrency) : headerSumAccountClosingBalancePreviousYearEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceDiff) : headerSumAccountPreviousYearPeriodInBalanceDiff),
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceDiffEntCurrency) : headerSumAccountPreviousYearPeriodInBalanceDiffEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiffPreviousYear) : headerSumAccountOpeningBalanceDiffPreviousYear),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiffPreviousYearEntCurrency) : headerSumAccountOpeningBalanceDiffPreviousYearEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiffPreviousYear) : headerSumAccountClosingBalanceDiffPreviousYear),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiffPreviousYearEntCurrency) : headerSumAccountClosingBalanceDiffPreviousYearEntCurrency));

                                    headerElement.Add(
                                        new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                    #endregion
                                }
                                else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
                                {
                                    #region ResultReport

                                    headerElement.Add(
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalance) : headerSumAccountBalanceChangeAllPreviousThisYearBalance),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                        //Previous Year
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalance) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency));

                                    headerElement.Add(
                                        new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                    #endregion
                                }

                                #region BalanceReport, ResultReport

                                foreach (XElement element in accountElementsForHeader)
                                {
                                    headerElement.Add(element);
                                }

                                #endregion
                            }
                            else
                            {
                                #region Sru

                                headerElement.Add(new XElement("Account",
                                    new XAttribute("id", 1),
                                    new XElement("AccountNr", String.Empty),
                                    new XElement("AccountName", String.Empty),
                                    new XElement("AccountInternalNr1", String.Empty),
                                    new XElement("AccountInternalName1", String.Empty),
                                    new XElement("AccountInternalNr2", String.Empty),
                                    new XElement("AccountInternalName2", String.Empty),
                                    new XElement("AccountInternalNr3", String.Empty),
                                    new XElement("AccountInternalName3", String.Empty),
                                    new XElement("AccountInternalNr4", String.Empty),
                                    new XElement("AccountInternalName4", String.Empty),
                                    new XElement("AccountInternalNr5", String.Empty),
                                    new XElement("AccountInternalName5", String.Empty),
                                    new XElement("AccountInternalNr6", String.Empty),
                                    new XElement("AccountInternalName6", String.Empty),
                                    new XElement("AccountBalancechangePeriod", Decimal.Zero)));

                                #endregion
                            }

                            #endregion

                            #endregion

                            reportHeaderElements.Add(headerElement);
                            reportHeaderXmlId++;
                        }

                        #region XElement ReportGroup
                        XElement groupElement = new XElement("Group");
                        if (reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                        {
                            //SRU
                            groupElement.Add(
                            new XAttribute("id", reportGroupXmlId),
                            new XElement("GroupName", reportGroup.Name),
                            new XElement("GroupShowLabel", reportGroup.ShowLabel.ToInt()),
                            new XElement("GroupShowSum", reportGroup.ShowSum.ToInt()),
                            new XElement("GroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriod) : groupSumAccountBalancechangePeriod),
                           new XElement("GroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodEntCurrency) : groupSumAccountBalancechangePeriodEntCurrency),
                            new XElement("GroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountYearInBalance) : groupSumAccountYearInBalance),
                            new XElement("GroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountYearInBalanceEntCurrency) : groupSumAccountYearInBalanceEntCurrency));
                        }
                        else
                        {
                            //BalanceReport, ResultReport, SRU
                            groupElement.Add(
                            new XAttribute("id", reportGroupXmlId),
                            new XElement("GroupName", reportGroup.Name),
                            new XElement("GroupShowLabel", reportGroup.ShowLabel.ToInt()),
                            new XElement("GroupShowSum", reportGroup.ShowSum.ToInt()),
                            new XElement("GroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriod) : groupSumAccountBalancechangePeriod),
                            new XElement("GroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodEntCurrency) : groupSumAccountBalancechangePeriodEntCurrency),
                            new XElement("GroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriod) : groupSumAccountGrossProfitPeriod),
                            new XElement("GroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodEntCurrency) : groupSumAccountGrossProfitPeriodEntCurrency),
                            //PreviousYear
                            new XElement("PreviousYearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriod) : groupSumAccountBalancechangePreviousYearPeriod),
                            new XElement("PreviousYearGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodEntCurrency) : groupSumAccountBalancechangePreviousYearPeriodEntCurrency),
                            new XElement("PreviousYearGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriod) : groupSumAccountGrossProfitPreviousYearPeriod),
                            new XElement("PreviousYearGroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                            //Previous Period
                            new XElement("PreviousPeriodMinus1YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus1Year) : groupSumAccountBalancechangePreviousPeriodYearMinus1Year),
                            new XElement("PreviousPeriodMinus2YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus2Year) : groupSumAccountBalancechangePreviousPeriodYearMinus2Year),
                            new XElement("PreviousPeriodMinus3YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus3Year) : groupSumAccountBalancechangePreviousPeriodYearMinus3Year),
                            new XElement("PreviousPeriodMinus4YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus4Year) : groupSumAccountBalancechangePreviousPeriodYearMinus4Year),
                            new XElement("PreviousPeriodMinus5YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus5Year) : groupSumAccountBalancechangePreviousPeriodYearMinus5Year),
                            //Budget
                            new XElement("BudgetGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriod) : groupSumBudgetAccountBalancechangePeriod),
                            new XElement("BudgetGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodEntCurrency) : groupSumBudgetAccountBalancechangePeriodEntCurrency));
                        }
                        //BalanceReport, ResultReport
                        if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport || reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                        {
                            groupElement.Add(
                                new XElement("GroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriod) : groupSumAccountBalancechangeToPeriod),
                                new XElement("GroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodEntCurrency) : groupSumAccountBalancechangeToPeriodEntCurrency),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPeriod) : groupSumAccountBalancechangeIncludingPeriod),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPeriodEntCurrency) : groupSumAccountBalancechangeIncludingPeriodEntCurrency),
                                new XElement("GroupSumAccountBalancechangeGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeGrossProfitIncludingPeriod) : groupSumAccountBalancechangeGrossProfitIncludingPeriod),
                                new XElement("GroupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency) : groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency),
                                new XElement("GroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYear) : groupSumAccountBalancechangeYear),
                                new XElement("GroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYearEntCurrency) : groupSumAccountBalancechangeYearEntCurrency),
                                new XElement("GroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYear) : groupSumAccountGrossProfitYear),
                                new XElement("GroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearEntCurrency) : groupSumAccountGrossProfitYearEntCurrency),
                                new XElement("GroupSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodDiff) : groupSumAccountBalancechangePeriodDiff),
                                new XElement("GroupSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodDiffEntCurrency) : groupSumAccountBalancechangePeriodDiffEntCurrency),
                                new XElement("GroupSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiff) : groupSumAccountBalancechangeToPeriodDiff),
                                new XElement("GroupSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPeriodDiffEntCurrency),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiff) : groupSumAccountBalancechangeToPeriodDiff),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPeriodDiffEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriod) : groupSumAccountBalancechangeToPreviousYearPeriod),
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPreviousYearPeriod) : groupSumAccountBalancechangeIncludingPreviousYearPeriod),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency) : groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYear) : groupSumAccountBalancechangePreviousYear),
                                new XElement("PreviousYearGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearEntCurrency) : groupSumAccountBalancechangePreviousYearEntCurrency),
                                new XElement("PreviousYearGroupSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod) : groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod),

                                new XElement("PreviousYearGroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYear) : groupSumAccountGrossProfitPreviousYear),
                                new XElement("PreviousYearGroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearEntCurrency) : groupSumAccountGrossProfitPreviousYearEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodDiff) : groupSumAccountBalancechangePreviousYearPeriodDiff),
                                new XElement("PreviousYearGroupSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency) : groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiff) : groupSumAccountBalancechangeToPreviousYearPeriodDiff),
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiff) : groupSumAccountBalancechangeToPreviousYearPeriodDiff),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency),
                                //Budget
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriod) : groupSumBudgetAccountBalancechangeToPeriod),
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeIncludingPeriod) : groupSumBudgetAccountBalancechangeIncludingPeriod),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency) : groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYear) : groupSumBudgetAccountBalancechangeYear),
                                new XElement("BudgetGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYearEntCurrency) : groupSumBudgetAccountBalancechangeYearEntCurrency),
                                new XElement("BudgetGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitPeriod) : groupSumBudgetAccountGrossProfitPeriod),
                                new XElement("BudgetGroupSumAccountGrossProfitToPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitToPeriod) : groupSumBudgetAccountGrossProfitToPeriod),
                                new XElement("BudgetGroupSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitIncludingPeriod) : groupSumBudgetAccountGrossProfitIncludingPeriod),
                                new XElement("BudgetGroupSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodDiff) : groupSumBudgetAccountBalancechangePeriodDiff),
                                new XElement("BudgetGroupSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodDiffEntCurrency) : groupSumBudgetAccountBalancechangePeriodDiffEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiff) : groupSumBudgetAccountBalancechangeToPeriodDiff),
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiff) : groupSumBudgetAccountBalancechangeToPeriodDiff),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency));


                            //BalanceReport
                            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                            {
                                #region BalanceReport

                                groupElement.Add(
                                    new XElement("GroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalance) : groupSumAccountPeriodInBalance),
                                    new XElement("GroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceEntCurrency) : groupSumAccountPeriodInBalanceEntCurrency),
                                    new XElement("GroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalance) : groupSumAccountGrossProfitPeriodInBalance),
                                    new XElement("GroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                    new XElement("GroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountYearInBalance) : groupSumAccountYearInBalance),
                                    new XElement("GroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountYearInBalanceEntCurrency) : groupSumAccountYearInBalanceEntCurrency),
                                    new XElement("GroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                    new XElement("GroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalanceEntCurrency) : groupSumAccountGrossProfitYearInBalanceEntCurrency),
                                    new XElement("GroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalance) : groupSumAccountClosingBalance),
                                    new XElement("GroupSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceEntCurrency) : groupSumAccountClosingBalanceEntCurrency),
                                    new XElement("GroupSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceDiff) : groupSumAccountPeriodInBalanceDiff),
                                    new XElement("GroupSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceDiffEntCurrency) : groupSumAccountPeriodInBalanceDiffEntCurrency),
                                    new XElement("GroupSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiff) : groupSumAccountOpeningBalanceDiff),
                                    new XElement("GroupSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiffEntCurrency) : groupSumAccountOpeningBalanceDiffEntCurrency),
                                    new XElement("GroupSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiff) : groupSumAccountClosingBalanceDiff),
                                    new XElement("GroupSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiffEntCurrency) : groupSumAccountClosingBalanceDiffEntCurrency),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                    //PreviousYear
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalance) : groupSumAccountPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalance) : groupSumAccountGrossProfitPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalance) : groupSumAccountPreviousYearInBalance),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalanceEntCurrency) : groupSumAccountPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalancePreviousYear) : groupSumAccountClosingBalancePreviousYear),
                                    new XElement("PreviousYearGroupSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalancePreviousYearEntCurrency) : groupSumAccountClosingBalancePreviousYearEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceDiff) : groupSumAccountPreviousYearPeriodInBalanceDiff),
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceDiffEntCurrency) : groupSumAccountPreviousYearPeriodInBalanceDiffEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiffPreviousYear) : groupSumAccountOpeningBalanceDiffPreviousYear),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiffPreviousYearEntCurrency) : groupSumAccountOpeningBalanceDiffPreviousYearEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiffPreviousYear) : groupSumAccountClosingBalanceDiffPreviousYear),
                                    new XElement("PreviousYearGroupSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiffPreviousYearEntCurrency) : groupSumAccountClosingBalanceDiffPreviousYearEntCurrency));

                                #endregion
                            }
                            else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReport)
                            {
                                #region ResultReport

                                groupElement.Add(
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalance) : groupSumAccountBalanceChangeAllPreviousThisYearBalance),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                    //PreviousYear
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalance) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency));


                                #endregion
                            }
                        }

                        //Add ReportHeaders to ReportGroup
                        foreach (XElement element in reportHeaderElements)
                        {
                            groupElement.Add(element);
                        }

                        #endregion

                        sheetElement.Add(groupElement);
                        reportGroupXmlId++;
                    }

                    reportElement.Add(sheetElement);

                    #endregion

                    reportI++;
                    if (reportAccountInternalsSpecificDim.Count > 0 && (reportI) < (reportParams.SSTD_IncludeMissingAccountDim ? reportAccountInternalsSpecificDim.Count + 1 : reportAccountInternalsSpecificDim.Count) && reportParams.SSTD_SeparateAccountDim)
                    {
                        var currentAccount = reportAccountInternalsSpecificDim.ElementAt(currentAccountIdx);
                        accountInternalsInInterval.RemoveAll(i => i.AccountId == currentAccount.AccountId);

                        if (!delaySetAccount)
                        {
                            currentAccountIdx++;
                            accountInternalsInInterval.Add(reportAccountInternalsSpecificDim.ElementAt(currentAccountIdx));
                        }
                        else
                        {
                            accountInternalsInInterval = reportAccountInternalsInInterval;
                            delaySetAccount = false;
                        }

                        AccountInternalDTO accountinternal = null;
                        if (reportParams.SSTD_AccountDimId != 0)
                        {
                            accountinternal = accountInternalsInInterval.FirstOrDefault(i => i.AccountDimId == reportParams.SSTD_AccountDimId);
                            if (accountinternal == null)
                                isAccountSelectionValid = false;
                        }

                        biBalancechangePeriodDict.Clear();
                        biBalanceChangeToPeriodDict.Clear();
                        biBalanceChangeIncludingPeriodDict.Clear();
                        biBalanceChangeYearDict.Clear();
                        biYearInBalanceDict.Clear();
                        biAccountBalanceChangeAllPreviousToPeriodDict.Clear();
                        biAccountBalanceChangeAllPreviousThisYearDict.Clear();
                        // Previous Year
                        biBalancechangePreviousYearPeriodDict.Clear();
                        biBalanceChangeToPreviousYearPeriodDict.Clear();
                        biBalanceChangeIncludingPreviousYearPeriodDict.Clear();
                        biBalanceChangePreviousYearDict.Clear();
                        biYearInBalancePreviousYearDict.Clear();
                        biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.Clear();
                        biAccountBalanceChangeAllPreviousPreviousYearDict.Clear();
                        //PreviousPeriods
                        biBalancechangePrevoiusPeriodMinus1YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus2YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus3YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus4YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus5YearDict.Clear();
                        // Budget TODO BudgetBalanceItemDTO
                        biBudgetBalancechangePeriodDict.Clear();
                        biBudgetBalanceChangeToPeriodDict.Clear();
                        biBudgetBalanceChangeIncludingPeriodDict.Clear();
                        biBudgetBalanceChangeYearDict.Clear();
                        //Gross profit
                        biGrossProfitBalanceChangePeriodDict.Clear();
                        biGrossProfitBalanceChangeToPeriodDict.Clear();
                        biGrossProfitBalanceChangeIncludingPeriodDict.Clear();
                        biGrossProfitBalanceChangeYearDict.Clear();
                        biGrossProfitYearInBalanceDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousToPeriodDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousThisYearDict.Clear();
                        //Gross profit and Budget
                        biGrossProfitBalanceChangePeriodBudgetDict.Clear();
                        biGrossProfitBalanceChangeToPeriodBudgetDict.Clear();
                        biGrossProfitBalanceChangeIncludingPeriodBudgetDict.Clear();
                        biGrossProfitBalanceChangeYearBudgetDict.Clear();
                        biGrossProfitYearInBalanceBudgetDict.Clear();
                        //Gross profit Previous Year
                        biGrossProfitBalanceChangePreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangeToPreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangePreviousYearDict.Clear();
                        biGrossProfitYearInBalancePreviousYearDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousToPreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousPreviousYearDict.Clear();
                        //historical Data
                        voucherHeadsAllPreviousThisYear.Clear();
                        voucherHeadsAllPreviousToPeriod.Clear();
                        voucherHeadsAllPreviousPreviousYear.Clear();
                        voucherHeadsAllPreviousToPreviousYearPeriod.Clear();
                        //VoucherHeads
                        voucherHeadsBalancechangePeriod.Clear();
                        voucherHeadsBalanceChangeToPeriod.Clear();
                        voucherHeadsBalanceChangeIncludingPeriod.Clear();
                        voucherHeadsBalanceChangeYear.Clear();
                        //VoucherHeads Budget
                        budgetVoucherHeadsBalancechangePeriod.Clear();
                        budgetVoucherHeadsBalanceChangeToPeriod.Clear();
                        budgetVoucherHeadsBalanceChangeIncludingPeriod.Clear();
                        budgetVoucherHeadsBalanceChangeYear.Clear();
                        //VoucherHeads PreviuousPeriods
                        previousPeriodMinus1YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus2YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus3YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus4YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus5YearVoucherHeadsBalancechangePeriod.Clear();
                        //VoucherHeads PreviousYear
                        previousYearVoucherHeadsBalancechangePeriod.Clear();
                        previousYearVoucherHeadsBalanceChangeToPeriod.Clear();
                        previousYearVoucherHeadsBalanceChangeIncludingPeriod.Clear();
                        previousYearVoucherHeadsBalanceChangeYear.Clear();
                        //VoucherHeads GrossProfit
                        voucherHeadsGrossProfitBalanceChangePeriod.Clear();
                        voucherHeadsGrossProfitBalanceChangeToPeriod.Clear();
                        voucherHeadsGrossProfitBalanceChangeIncludingPeriod.Clear();
                        voucherHeadsGrossProfitBalanceChangeYear.Clear();
                        //VoucherHeads GrossProfitBudget
                        voucherHeadsGrossProfitBudgetBalanceChangePeriod.Clear();
                        voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Clear();
                        voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod.Clear();
                        voucherHeadsGrossProfitBudgetBalanceChangeYear.Clear();
                        //VoucherHeads GrossProfit PreviousYear
                        previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Clear();
                        previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Clear();
                        previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod.Clear();
                        previousYearVoucherHeadsGrossProfitBalanceChangeYear.Clear();

                    }
                    else
                    {
                        isAccountSelectionValid = false;

                    }
                }

            }

            return result;
        }

        private void AddBalanceResultListVoucherRowElement(EconomyReportParamsDTO reportParams, List<XElement> voucherRowElements, List<VoucherHeadDTO> voucherHeadsForAccount, AccountDTO accountStd, List<AccountDimDTO> accountDimInternals, string voucherType, bool invertRow, List<AccountInternalDTO> accountInternalsInInterval, string reportHeaderName)
        {
            if (voucherHeadsForAccount == null || accountStd == null)
                return;

            if (voucherRowElements == null)
                voucherRowElements = new List<XElement>();
            if (accountDimInternals == null)
                accountDimInternals = new List<AccountDimDTO>();

            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
            {
                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();

                decimal accountVoucherRowAmount = voucherRowsForAccount.Sum(i => i.Amount);
                if (accountVoucherRowAmount != 0)
                    AddBalanceResultListVoucherRowElement(reportParams, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeaderName);
            }
        }

        private void AddBalanceResultListVoucherRowElement(EconomyReportParamsDTO reportParams, List<XElement> voucherRowElements, List<VoucherRowDTO> voucherRowsForAccount, AccountDTO accountStd, List<AccountDimDTO> accountDimInternals, string voucherType, bool invertRow, string reportHeaderName)
        {
            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
            {
                if (reportParams.SSTD_IncludeMissingAccountDim)
                {
                    int? accountDimNr = accountDimInternals.FirstOrDefault((x) => x.AccountDimId == reportParams.SSTD_AccountDimId)?.AccountDimNr;
                    if (accountDimNr == 2 && voucherRow.Dim2Nr != null)
                    {
                        continue;
                    }
                    if (accountDimNr == 3 && voucherRow.Dim3Nr != null)
                    {
                        continue;
                    }
                }
                XElement voucherRowElement = new XElement("VoucherRow",
                    new XAttribute("id", voucherRowElements.Count + 1),
                    new XElement("VoucherRowAccountNr", accountStd.AccountNr),
                    new XElement("VoucherRowAccountName", accountStd.Name),
                    new XElement("VoucherRowVoucherSerie", voucherRow.VoucherSeriesTypeNr),
                    new XElement("VoucherRowVoucherNr", voucherRow.VoucherNr),
                    new XElement("VoucherRowAccountAmount", invertRow ? Decimal.Negate(voucherRow.Amount) : voucherRow.Amount),
                    new XElement("VoucherRowText", voucherRow.Text),
                    new XElement("VoucherRowAccountDate", voucherRow.Date.HasValue ? voucherRow.Date.Value : voucherRow.Date),
                    new XElement("VoucherRowType", voucherType));

                for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                {
                    if (i > accountDimInternals.Count)
                    {
                        voucherRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                        continue;
                    }

                    AccountInternalDTO accountInternal = null;
                    AccountDimDTO accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;

                    if (accountDim != null)
                    {
                        if ((reportParams.SSTD_AccountDimId != 0 && accountDim.AccountDimId == reportParams.SSTD_AccountDimId) || reportParams.SSTD_AccountDimId == 0)

                        {
                            accountInternal = (from ai in voucherRow.AccountInternalDTO_forReports
                                               where ai.AccountDimId == accountDim.AccountDimId
                                               select ai).FirstOrDefault<AccountInternalDTO>();
                        }
                    }

                    voucherRowElement.Add(
                        new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                        new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
                }
                voucherRowElement.Add(
                        new XElement("VoucherRowReportHeaderName", reportHeaderName));
                voucherRowElements.Add(voucherRowElement);
            }

        }

        protected XElement CreateAccountDim(int AccountDimId, List<AccountDimDTO> accountDims)
        {
            return new XElement("AccountDimension", GetAccountDimTextByAccountDimId(AccountDimId, accountDims));
        }

        protected string GetAccountDimTextByAccountDimId(int accountDimId, List<AccountDimDTO> dim)
        {
            StringBuilder sb = new StringBuilder();

            if (accountDimId > 0)
            {
                foreach (AccountDimDTO d in dim)
                {
                    if (accountDimId == d.AccountDimId)
                        sb.Append($"{d.AccountDimNr - 1} {d.SysSieDimNr} {d.Name}");
                }
            }

            return sb.ToString();
        }

        private XElement CreateAccountElementForProjectReport(int accountId, AccountDTO account, List<VoucherRowDTO> accountInternalRows, DateTime dateFrom)
        {
            decimal ib = 0;
            decimal quantity = 0;

            foreach (var row in accountInternalRows)
            {
                if (row.Date < dateFrom)
                {
                    ib += row.Amount;
                    quantity += row.Quantity != null ? (decimal)row.Quantity : 0;
                }
            }

            XElement accountElement = new XElement("Account",
                    new XAttribute("id", accountId),
                    new XElement("AccountNr", account.AccountNr),
                    new XElement("AccountName", account.Name),
                    new XElement("AccountBalance", ib),
                    new XElement("AccountQuantity", Convert.ToDecimal(quantity)),
                    new XElement("InternalNr1", accountInternalRows[0].Dim2Nr),
                    new XElement("InternalName1", accountInternalRows[0].Dim2Name),
                    new XElement("InternalNr2", accountInternalRows[0].Dim3Nr),
                    new XElement("InternalName2", accountInternalRows[0].Dim3Name),
                    new XElement("InternalNr3", accountInternalRows[0].Dim4Nr),
                    new XElement("InternalName3", accountInternalRows[0].Dim4Name),
                    new XElement("InternalNr4", accountInternalRows[0].Dim5Nr),
                    new XElement("InternalName4", accountInternalRows[0].Dim5Name),
                    new XElement("InternalNr5", accountInternalRows[0].Dim6Nr),
                    new XElement("InternalName5", accountInternalRows[0].Dim6Name));

            return accountElement;
        }

        private XElement CreateLatestVoucherElement(EconomyReportParamsDTO reportParams)
        {
            return new XElement("LatestVoucher", reportParams.GetLatestVoucherText());
        }
        protected XElement CreateDateIntervalElement(EconomyReportParamsDTO param)
        {
            return new XElement("DateInterval", GetDateIntervalText(param));
        }
        protected XElement CreateVoucherSerieIntervalElement(EconomyReportParamsDTO param)
        {
            return new XElement("VoucherSerieInterval", GetVoucherSerieIntervalText(param));
        }
        protected XElement CreateVoucherIntervalElement(EconomyReportParamsDTO param)
        {
            return new XElement("VoucherInterval", GetVoucherIntervalText(param));
        }
        private XElement CreateAccountIntervalElement(AccountManager am, CreateReportResult reportResult, List<AccountIntervalDTO> accountIntervals, List<AccountDimDTO> accountDims)
        {
            return new XElement("AccountInterval", GetAccountIntervalText(am, reportResult, accountIntervals, accountDims));
        }
        protected string GetVoucherIntervalText(EconomyReportParamsDTO param)
        {
            string text = "";
            if (param.SV_HasVoucherNrInterval)
                text = param.SV_VoucherNrFrom.ToString() + "-" + param.SV_VoucherNrTo.ToString();
            return text;
        }
        protected string GetVoucherSerieIntervalText(EconomyReportParamsDTO param)
        {
            string text = "";
            if (param.SV_HasVoucherSeriesTypeNrInterval)
                text = param.SV_VoucherSeriesTypeNrFrom.ToString() + "-" + param.SV_VoucherSeriesTypeNrTo.ToString();
            return text;
        }

        protected string GetDateIntervalText(EconomyReportParamsDTO param)
        {
            string text = "";
            if (param != null && param.HasDateInterval)
            {
                if (param.DateFrom != CalendarUtility.DATETIME_MINVALUE)
                {
                    text += param.DateFrom.ToShortDateString();
                }

                if (param.DateTo != CalendarUtility.DATETIME_MAXVALUE)
                {
                    text += "-";
                    text += param.DateTo.ToShortDateString();
                }
            }
            return text;
        }

        private string GetAccountIntervalText(AccountManager am, CreateReportResult reportResult, List<AccountIntervalDTO> accountIntervals, List<AccountDimDTO> accountDims)
        {
            if (accountIntervals.IsNullOrEmpty() || accountDims == null)
                return string.Empty;

            StringBuilder sb = new StringBuilder();

            foreach (AccountIntervalDTO accountInterval in accountIntervals)
            {
                if (accountDims.Any(i => i.AccountDimId == accountInterval.AccountDimId))
                    sb.Append(accountInterval.AccountNrFrom + "-" + accountInterval.AccountNrTo + " ");
            }

            foreach (AccountDimDTO accountDim in accountDims)
            {
                bool first = true;
                foreach (AccountIntervalDTO accountInterval in accountIntervals)
                {
                    if (accountInterval.AccountDimId == accountDim.AccountDimId)
                    {
                        if (first)
                        {
                            if (sb.Length > 0)
                                sb.Append("; ");
                            sb.Append(accountDim.Name + ": ");
                            first = false;
                        }
                        if (accountInterval.AccountNrFrom == accountInterval.AccountNrTo)
                        {
                            if (accountInterval.AccountNrFrom == " ")
                            {
                                sb.Append(" ");
                            }
                            else
                            {
                                Account accountFrom = am.GetAccountByNr(accountInterval.AccountNrFrom, accountDim.AccountDimId, reportResult.ActorCompanyId, onlyActive: false);
                                if (accountFrom != null)
                                    sb.Append($"{accountInterval.AccountNrFrom} {accountFrom.Name}");
                            }
                        }
                        else
                        {
                            Account accountFrom = am.GetAccountByNr(accountInterval.AccountNrFrom, accountDim.AccountDimId, reportResult.ActorCompanyId, onlyActive: false);
                            if (accountFrom == null)
                                sb.Append(accountInterval.AccountNrFrom);
                            else
                                sb.Append($"{accountInterval.AccountNrFrom} {accountFrom.Name}");

                            Account accountTo = am.GetAccountByNr(accountInterval.AccountNrTo, accountDim.AccountDimId, reportResult.ActorCompanyId, onlyActive: false);
                            if (accountTo == null)
                                sb.Append($" - {accountInterval.AccountNrTo}");
                            else
                                sb.Append($" - {accountInterval.AccountNrTo} {accountTo.Name}");
                        }
                    }
                }
            }

            return sb.ToString();
        }

        private void AddBalanceResultListVoucherRowElement(EconomyReportParamsDTO reportParams, List<XElement> voucherRowElements, List<VoucherRowDTO> voucherRowsForAccount, AccountDTO accountStd, List<AccountDimDTO> accountDimInternals, string voucherType, bool invertRow, DateTime voucherHeadDate, string reportHeaderName)
        {
            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
            {
                if (reportParams.SSTD_IncludeMissingAccountDim && (reportParams.SSTD_AccountDimId == voucherRow.Dim2Id || reportParams.SSTD_AccountDimId == voucherRow.Dim3Id))
                {
                    continue;
                }

                XElement voucherRowElement = new XElement("VoucherRow",
                    new XAttribute("id", voucherRowElements.Count + 1),
                    new XElement("VoucherRowAccountNr", accountStd.AccountNr),
                    new XElement("VoucherRowAccountName", accountStd.Name),
                    new XElement("VoucherRowVoucherSerie", voucherRow.VoucherSeriesTypeNr),
                    new XElement("VoucherRowVoucherNr", voucherRow.VoucherNr),
                    new XElement("VoucherRowAccountAmount", invertRow ? Decimal.Negate(voucherRow.Amount) : voucherRow.Amount),
                    new XElement("VoucherRowText", voucherRow.Text),
                    new XElement("VoucherRowAccountDate", voucherRow.Date.HasValue ? voucherRow.Date.Value : voucherHeadDate),
                    new XElement("VoucherRowType", voucherType));

                for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                {
                    if (i > accountDimInternals.Count)
                    {
                        voucherRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                        continue;
                    }

                    string accountNr = String.Empty;
                    string accountName = String.Empty;
                    switch (i)
                    {
                        case 1:
                            accountNr = voucherRow.Dim2Nr;
                            accountName = voucherRow.Dim2Name;
                            break;
                        case 2:
                            accountNr = voucherRow.Dim3Nr;
                            accountName = voucherRow.Dim3Name;
                            break;
                        case 3:
                            accountNr = voucherRow.Dim4Nr;
                            accountName = voucherRow.Dim4Name;
                            break;
                        case 4:
                            accountNr = voucherRow.Dim5Nr;
                            accountName = voucherRow.Dim5Name;
                            break;
                        case 5:
                            accountNr = voucherRow.Dim6Nr;
                            accountName = voucherRow.Dim6Name;
                            break;
                    }

                    voucherRowElement.Add(
                        new XElement("AccountInternalNr" + i, accountNr),
                        new XElement("AccountInternalName" + i, accountName));
                }
                voucherRowElement.Add(
                        new XElement("VoucherRowReportHeaderName", reportHeaderName));

                voucherRowElements.Add(voucherRowElement);
            }
        }

        private ActionResult CreateBalanceResultAndSruReportCommonDataV2(EvaluatedSelection es, XElement reportElement)
        {
            ActionResult result = new ActionResult(true);

            #region Prereq

            //AccountDim internal
            List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = this.CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(this.CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(new XElement("AccountYearDiffLabel", this.GetReportText(35, "Jämförelseår:")));
            //reportHeaderLabelsElement.Add(new XElement("EntCurrencyNameLabel", this.GetReportText(299, "Valutanamn")));
            //reportHeaderLabelsElement.Add(new XElement("EntCurrencyCodeLabel", this.GetReportText(300, "Valutakod")));
            this.CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            reportHeaderLabelsElement.Add(new XElement("SumLabel", this.GetReportText(34, "Summa")));

            reportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = this.CreateAccountingReportHeaderElement(es);
            reportHeaderElement.Add(this.CreateAccountIntervalElement(es, accountDimInternals));


            reportHeaderElement.Add(new XElement("AccountYearDiff"), String.Empty); //TODO
            reportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    pageHeaderLabelsElement.Add(
                        new XElement("DimensionInternalName" + i + "Label", String.Empty),
                        new XElement("DimensionInternalShortName" + i + "Label", String.Empty));
                    continue;
                }

                var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;

                pageHeaderLabelsElement.Add(
                    new XElement("DimensionInternalName" + i + "Label", accountDim != null ? accountDim.AccountDimNr.ToString() : String.Empty),
                    new XElement("DimensionInternalShortName" + i + "Label", accountDim != null ? accountDim.Name : String.Empty));
            }

            AddAccountBalanceChangePeriodPageHeaderLabelElements(pageHeaderLabelsElement);

            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
            {
                #region BalanceReport, ResultReport

                AddAccountBalanceChangePageHeaderLabelElements(pageHeaderLabelsElement);

                #endregion

                if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                {
                    #region BalanceReport

                    AddAccountBalancePageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
                else if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                {
                    #region ResultReport

                    this.AddAccountBalanceChangePreviousPageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
            }

            reportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Init

                AccountBalanceManager abm = AccountBalanceManager(es.ActorCompanyId);
                abm.InitBalanceChangeVoucherHeadCache();

                List<AccountDTO> accountStdsInInterval = new List<AccountDTO>();
                List<AccountInternalDTO> accountInternalsInInterval = new List<AccountInternalDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalanceDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousThisYearDict = new Dictionary<int, BalanceItemDTO>();

                // Previous Year
                Dictionary<int, BalanceItemDTO> biBalancechangePreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalancePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, BalanceItemDTO>();

                //PreviousPeriods
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus1YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus2YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus3YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus4YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus5YearDict = new Dictionary<int, BalanceItemDTO>();

                // Budget TODO BudgetBalanceItemDTO
                Dictionary<int, BalanceItemDTO> biBudgetBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();

                //Gross profit
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousThisYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit and Budget
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit Previous Year
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalancePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //historical Data
                List<VoucherHeadDTO> voucherHeadsAllPreviousThisYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousPreviousYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPreviousYearPeriod = new List<VoucherHeadDTO>();

                //VoucherHeads
                List<VoucherHeadDTO> voucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads Budget
                List<VoucherHeadDTO> budgetVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads PreviuousPeriods
                List<VoucherHeadDTO> previousPeriodMinus1YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus2YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus3YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus4YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus5YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();

                //VoucherHeads PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfitBudget
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                #endregion

                #region Prereq

                AccountYearDTO accountYear = AccountManager.GetAccountYear(entities, es.DateFrom, es.ActorCompanyId).ToDTO();
                if (accountYear == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountYear");

                AccountDimDTO accountDimStd = AccountManager.GetAccountDimStd(entities, es.ActorCompanyId).ToDTO();
                if (accountDimStd == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountDim");

                List<AccountDimDTO> internalaccountDims = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId, false, true, true).OrderBy(a => a.AccountDimNr).ToDTOs();
                List<AccountDTO> allAccountDTOStds = AccountManager.GetAccountStdsByCompany(es.ActorCompanyId, null).ToDTOs().ToList();
                List<ReportHeaderInterval> grossProfitReportHeaderIntervalsUnfiltered = ReportManager.GetReportHeaderIntervalsForCompany(es.ActorCompanyId, onlyGrossProfit: true).ToList();
                List<ReportGroup> reportGroups = ReportManager.GetReportGroupsByReport(entities, es.ReportId, es.ActorCompanyId);
                List<int> reportGroupIds = reportGroups.Select(g => g.ReportGroupId).ToList();
                List<int> reportHeaderIds = grossProfitReportHeaderIntervalsUnfiltered.Select(i => i.ReportHeader.ReportHeaderId).ToList();
                List<ReportGroupHeaderMapping> reportHeaderGroupMappings = ReportManager.GetReportGroupHeaderMappings(entities, es.ActorCompanyId);
                reportHeaderGroupMappings = reportHeaderGroupMappings.Where(g => reportGroupIds.Contains(g.ReportGroupId)).ToList();

                List<ReportHeaderInterval> test = new List<ReportHeaderInterval>();


                foreach (var mapping in reportHeaderGroupMappings)
                {
                    if (grossProfitReportHeaderIntervalsUnfiltered.Any(i => i.ReportHeader.ReportHeaderId == mapping.ReportHeaderId))
                    {
                        foreach (var interval in mapping.ReportHeader.ReportHeaderInterval)
                            test.Add(interval);
                    }
                }

                var grossProfitReportHeaderIntervals = test.Distinct().Cast<IReportHeaderInterval>().ToList();


                //Get detailed Information - Information is only needed in some reports
                bool detailedInformation = es.GetDetailedInformation;

                DateTime firstMonth = CalendarUtility.GetFirstDateOfMonth(es.DateFrom);
                DateTime prevYearDateFrom = es.DateFrom.AddYears(-es.NoOfYearsBackinPreviousYear);
                DateTime prevYearDateTo = es.DateTo.AddYears(-es.NoOfYearsBackinPreviousYear);
                prevYearDateTo = CalendarUtility.GetLastDateOfMonth(prevYearDateTo);
                DateTime prevYearUntilDateFrom = es.UntilDateFrom.AddYears(-es.NoOfYearsBackinPreviousYear);
                prevYearUntilDateFrom = CalendarUtility.GetLastDateOfMonth(prevYearUntilDateFrom);
                //Previous year
                AccountYearDTO previousAccountYear = es.NoOfYearsBackinPreviousYear != 0 ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-es.NoOfYearsBackinPreviousYear), es.ActorCompanyId).ToDTO() : null;

                // Year minus 1
                DateTime prevPeriodMinus1YearDateFrom = es.DateFrom.AddYears(-1);
                DateTime prevPeriodMinus1YearDateTo = es.DateTo.AddYears(-1);
                prevPeriodMinus1YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus1YearDateTo);
                AccountYearDTO previousPeriodMinus1AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-1), es.ActorCompanyId).ToDTO() : null;

                // Year minus 2
                DateTime prevPeriodMinus2YearDateFrom = es.DateFrom.AddYears(-2);
                DateTime prevPeriodMinus2YearDateTo = es.DateTo.AddYears(-2);
                prevPeriodMinus2YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus2YearDateTo);
                AccountYearDTO previousPeriodMinus2AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-2), es.ActorCompanyId).ToDTO() : null;

                // Year minus 3
                DateTime prevPeriodMinus3YearDateFrom = es.DateFrom.AddYears(-3);
                DateTime prevPeriodMinus3YearDateTo = es.DateTo.AddYears(-3);
                prevPeriodMinus3YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus3YearDateTo);
                AccountYearDTO previousPeriodMinus3AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-3), es.ActorCompanyId).ToDTO() : null;

                // Year minus 4
                DateTime prevPeriodMinus4YearDateFrom = es.DateFrom.AddYears(-4);
                DateTime prevPeriodMinus4YearDateTo = es.DateTo.AddYears(-4);
                prevPeriodMinus4YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus4YearDateTo);
                AccountYearDTO previousPeriodMinus4AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-4), es.ActorCompanyId).ToDTO() : null;

                // Year minus 5
                DateTime prevPeriodMinus5YearDateFrom = es.DateFrom.AddYears(-5);
                DateTime prevPeriodMinus5YearDateTo = es.DateTo.AddYears(-5);
                prevPeriodMinus5YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus5YearDateTo);
                AccountYearDTO previousPeriodMinus5AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-5), es.ActorCompanyId).ToDTO() : null;

                // Budget
                int budgetHeadId = 0;
                bool getBudget = true;
                if (es.SSTD_BudgetId.HasValue && es.IncludeBudget)
                    budgetHeadId = es.SSTD_BudgetId.Value;
                if (budgetHeadId == 0)
                    getBudget = false;

                List<GrossProfitCode> grossProfCodes = GrossProfitManager.GetGrossProfitCodes(es.ActorCompanyId);

                List<GrossProfitCodeDTO> grossProfitCodes = new List<GrossProfitCodeDTO>();

                foreach (var code in grossProfCodes)
                    grossProfitCodes.Add(code.ToDTO());

                bool hasGrossProfitCodes = !grossProfitCodes.IsNullOrEmpty() && !grossProfitReportHeaderIntervals.IsNullOrEmpty();

                //Cache

                if (es.IncludeAllHistoricalData)
                    abm.FillVoucherHeadDTOCache(CalendarUtility.DATETIME_DEFAULT, accountYear.To, es.ActorCompanyId);
                else if (previousAccountYear != null)
                    abm.FillVoucherHeadDTOCache(previousAccountYear.From, accountYear.To, es.ActorCompanyId);
                else
                    abm.FillVoucherHeadDTOCache(accountYear.From, accountYear.To, es.ActorCompanyId);

                bool isAccountSelectionValid = AccountManager.GetAccountsInInterval(entities, es, accountDimStd, false, ref accountStdsInInterval, ref accountInternalsInInterval);
                if (isAccountSelectionValid)
                {
                    // Translate Account Names
                    if (accountStdsInInterval != null)
                    {
                        accountStdsInInterval = AccountManager.TranslateAccountNamesByLang(accountStdsInInterval); // 2015-04-27 / Jukka - Translate account names for the names for which current translation exists
                    }
                    // Hela året
                    biBalanceChangeYearDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalanceChangeYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                    // Hela Förra året
                    if (previousAccountYear != null)
                        biBalanceChangePreviousYearDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);

                    //Omsättning  inom period (hela urvalet)
                    biBalancechangePeriodDict = abm.GetBalanceChangeFromDTO(accountYear, es.DateFrom, es.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);

                    //Omsättning inom perioden förra året (hela urvalet)
                    if (previousAccountYear != null)
                        biBalancechangePreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);

                    //Omsättning per period i fem tidigare år
                    if (previousAccountYear != null)
                    {
                        if (previousPeriodMinus1AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus1YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus1AccountYear, prevPeriodMinus1YearDateFrom, prevPeriodMinus1YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus1YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus2AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus2YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus2AccountYear, prevPeriodMinus2YearDateFrom, prevPeriodMinus2YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus2YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus3AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus3YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus3AccountYear, prevPeriodMinus3YearDateFrom, prevPeriodMinus3YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus3YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus4AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus4YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus4AccountYear, prevPeriodMinus4YearDateFrom, prevPeriodMinus4YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus4YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus5AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus5YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus5AccountYear, prevPeriodMinus5YearDateFrom, prevPeriodMinus5YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus5YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                    }

                    //Budget inom perioden
                    if (getBudget)
                    {
                        biBudgetBalancechangePeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, es.DateFrom, es.DateTo, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, false, out budgetVoucherHeadsBalancechangePeriod);
                        if (hasGrossProfitCodes)
                            biGrossProfitBalanceChangePeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, es.DateFrom, es.DateTo, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalancechangePeriod, out voucherHeadsGrossProfitBudgetBalanceChangePeriod);
                    }

                    if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReportV2 || es.ReportTemplateType == SoeReportTemplateType.SruReport)
                    {
                        #region BalanceReport and ResultReport

                        #region Load data in order largest range first (to be able to use cache and re-use data)

                        // Budget
                        if (getBudget)
                        {
                            biBudgetBalanceChangeYearDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, false, out budgetVoucherHeadsBalanceChangeYear);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeYearBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalanceChangeYear, out voucherHeadsGrossProfitBudgetBalanceChangeYear);
                        }

                        //Från år start till period start (Edit 090319: Parameter dateTo, es.SSTD_DateFrom --> SSTD_DateTo) (Edit 090423: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom)(Edit 100322: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom.AddDays(-1))
                        biBalanceChangeToPeriodDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalanceChangeToPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                        // Budget
                        if (getBudget)
                        {
                            biBudgetBalanceChangeToPeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, es.UntilDateFrom, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, false, out budgetVoucherHeadsBalanceChangeToPeriod);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeToPeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, es.UntilDateFrom, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalanceChangeToPeriod, out voucherHeadsGrossProfitBudgetBalanceChangeToPeriod);
                        }

                        // Förra året
                        if (previousAccountYear != null)
                            biBalanceChangeToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeToPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);

                        #endregion

                        //GrossProfitCode
                        if (hasGrossProfitCodes)
                        {
                            Parallel.Invoke(GetDefaultParallelOptions(), () =>
                            {
                                biGrossProfitBalanceChangePeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, es.DateFrom, es.DateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);
                            },

                            () =>
                            {
                                biGrossProfitBalanceChangeToPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, es.DateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);
                            },

                            () =>
                            {
                                biGrossProfitBalanceChangeYearDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, allAccountDTOStds, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeYear, detailedInformation);
                            }
                            ); //close parallel.invoke           

                            //Förra året
                            if (previousAccountYear != null)
                            {

                                Parallel.Invoke(GetDefaultParallelOptions(), () =>
                                {
                                    biGrossProfitBalanceChangePreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);
                                },

                                () =>
                                {
                                    biGrossProfitBalanceChangeToPreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);
                                },

                                () =>
                                {
                                    biGrossProfitBalanceChangePreviousYearDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeYear, detailedInformation);
                                }
                                ); //close parallel.invoke
                            }
                        }

                        #endregion

                        if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                        {
                            #region BalanceReport

                            //Ingående balans för aktuellt år
                            biYearInBalanceDict = abm.GetYearInBalanceFromDTO(entities, accountYear, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId);
                            //Ingående balans för förra året
                            if (previousAccountYear != null)
                                biYearInBalancePreviousYearDict = abm.GetYearInBalanceFromDTO(entities, previousAccountYear, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId);

                            #endregion
                        }
                        else if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                        {
                            #region ResultReport

                            if (es.IncludeAllHistoricalData)
                            {
                                //All data fram till dagen innan urval start
                                biAccountBalanceChangeAllPreviousToPeriodDict = abm.GetBalanceChangeFromDTO(null, es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousToPeriod, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                                //All data fram till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(null, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousToPreviousYearPeriod, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);

                                //All data från 1 jan till dagen innan urval start
                                biAccountBalanceChangeAllPreviousThisYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(es.DateFrom), es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousThisYear, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);
                                //All data från 1 jan förra året till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousPreviousYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(prevYearDateFrom), prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousPreviousYear, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers);

                            }

                            #endregion
                        }
                    }
                }

                #endregion

                #region Check which accounts that got balance

                List<int> AccountIdsWithBalance = new List<int>();

                foreach (AccountDTO accountStd in accountStdsInInterval)
                {
                    if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biYearInBalanceDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biYearInBalanceDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biYearInBalancePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId); continue;
                        }
                    }

                    if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBudgetBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBudgetBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBudgetBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }
                }

                #endregion

                #region Content

                #region Sheet

                int sheetId = 1;
                XElement sheetElement = new XElement("Sheet",
                    new XAttribute("id", sheetId),
                    new XElement("DimensionNr", String.Empty),
                    new XElement("DimensionName", String.Empty),
                    new XElement("InternalNr", String.Empty),
                    new XElement("InternalName", String.Empty));

                #endregion

                int reportGroupXmlId = 1;
                foreach (ReportGroup reportGroup in reportGroups)
                {
                    #region ReportGroup

                    #region Init

                    bool invertRow = reportGroup.InvertRow;

                    //BalanceReport, ResultReport, SRU,
                    decimal groupSumAccountBalancechangePeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriod = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                    //previousYear
                    decimal groupSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                    //PreviousYearPeriodOnly to be able to look at the year for multiple periods
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus1Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus2Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus3Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus4Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus5Year = Decimal.Zero;

                    //Budget
                    decimal groupSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                    decimal groupSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                    //BalanceReport, ResultReport
                    decimal groupSumAccountBalancechangeToPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency = Decimal.Zero;

                    //previousYear
                    decimal groupSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;


                    //Budget
                    decimal groupSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                    decimal groupSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalancechangeYear = Decimal.Zero;
                    decimal groupSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYear = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYearEntCurrency = Decimal.Zero;

                    //PreviousYear
                    decimal groupSumAccountBalancechangePreviousYear = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYear = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearEntCurrency = Decimal.Zero;


                    //Budget
                    decimal groupSumBudgetAccountBalancechangeYear = Decimal.Zero;
                    decimal groupSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;

                    //BalanceReport
                    decimal groupSumAccountPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountYearInBalance = Decimal.Zero;
                    decimal groupSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYearInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountClosingBalance = Decimal.Zero;
                    decimal groupSumAccountClosingBalanceEntCurrency = Decimal.Zero;


                    //PreviousYear
                    decimal groupSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountPreviousYearInBalance = Decimal.Zero;
                    decimal groupSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountClosingBalancePreviousYear = Decimal.Zero;
                    decimal groupSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;


                    //ResultReport
                    decimal groupSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                    //PreviousYear
                    decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;

                    //Grossprofit and Budget
                    decimal groupSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                    decimal groupSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumBudgetAccountGrossProfitYear = Decimal.Zero;
                    decimal groupSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                    List<XElement> reportHeaderElements = new List<XElement>();

                    #endregion

                    #region ReportHeaderInterval

                    //ReportHeaderIntervals for ReportGroup
                    List<ReportHeaderInterval> reportHeaderIntervalsForReportGroup = ReportManager.GetReportHeaderIntervals(entities, reportGroup.ReportGroupId, es.ActorCompanyId);

                    #endregion

                    #region AccountStds

                    DateTime startAccount = DateTime.UtcNow;


                    //AccountStds for ReportGroup
                    List<AccountDTO> accountStdsForReportGroup = new List<AccountDTO>();
                    foreach (AccountDTO accountStd in accountStdsInInterval)
                    {
                        foreach (ReportHeaderInterval reportHeaderInterval in reportHeaderIntervalsForReportGroup)
                        {
                            if (Validator.IsAccountInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                            {
                                accountStdsForReportGroup.Add(accountStd);
                                break;
                            }
                        }
                    }

                    #endregion

                    #endregion

                    List<ReportHeader> reportHeaders = (from rh in reportHeaderGroupMappings
                                                        where rh.ReportGroup.ReportGroupId == reportGroup.ReportGroupId
                                                        select rh.ReportHeader).ToList();

                    int reportHeaderXmlId = 1;
                    foreach (ReportHeader reportHeader in reportHeaders)
                    {
                        #region ReportHeader

                        #region Init

                        //BalanceReport, ResultReport, SRU
                        decimal headerSumAccountBalancechangePeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal headerSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                        //PreviousPeriod
                        decimal headerSumAccountBalancechangePreviousPeriodMinus1Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus2Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus3Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus4Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus5Year = Decimal.Zero;

                        //Budget
                        decimal headerSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                        //BalanceReport, ResultReport
                        decimal headerSumAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalancechangeYear = Decimal.Zero;
                        decimal headerSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYear = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYearEntCurrency = Decimal.Zero;


                        //PreviousYear
                        decimal headerSumAccountBalancechangePreviousYear = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;


                        //Budget
                        decimal headerSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangeYear = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;


                        //BalanceReport
                        decimal headerSumAccountPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountYearInBalance = Decimal.Zero;
                        decimal headerSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYearInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountClosingBalance = Decimal.Zero;
                        decimal headerSumAccountClosingBalanceEntCurrency = Decimal.Zero;


                        //PreviousYear
                        decimal headerSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountPreviousYearInBalance = Decimal.Zero;
                        decimal headerSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountClosingBalancePreviousYear = Decimal.Zero;
                        decimal headerSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;


                        //ResultReport
                        decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;

                        //GrossProfit and Budget
                        decimal headerSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitYear = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                        List<XElement> accountElementsForHeader = new List<XElement>();

                        #endregion

                        #region AccountStd

                        //AccountStds for ReportHeader
                        List<AccountDTO> accountStdsForReportHeader = new List<AccountDTO>();


                        List<ReportHeaderInterval> reportHeadersIntervalsForReportHeader = (from rh in reportHeaderIntervalsForReportGroup
                                                                                            where rh.ReportHeader.ReportHeaderId == reportHeader.ReportHeaderId
                                                                                            select rh).ToList();

                        foreach (AccountDTO accountStd in accountStdsForReportGroup)
                        {
                            foreach (ReportHeaderInterval reportHeaderInterval in reportHeadersIntervalsForReportHeader)
                            {

                                if (StringUtility.IsInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                                {
                                    if (accountStd.GrossProfitCode == null)
                                        accountStd.GrossProfitCode = new List<int?>();

                                    accountStd.GrossProfitCode.Add(reportHeaderInterval.SelectValue);

                                    if (reportHeader.ShowZeroRow || AccountIdsWithBalance.Contains(accountStd.AccountId))
                                        accountStdsForReportHeader.Add(accountStd);
                                    break;
                                }
                            }
                        }

                        #endregion

                        #endregion

                        int accountXmlId = 1;
                        foreach (AccountDTO accountStd in accountStdsForReportHeader)
                        {
                            XElement accountElement = null;

                            #region AccountCombination

                            List<AccountAndInternalAccountComboDTO> accountAndInternalAccountComboDTOs = new List<AccountAndInternalAccountComboDTO>();

                            if (es.GetDetailedInformation)
                            {
                                //VoucherHeads
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads Budget
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, budgetVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, budgetVoucherHeadsBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, budgetVoucherHeadsBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads PreviuousPeriods
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus1YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus2YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus3YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus4YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus5YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads PreviousYear
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads GrossProfit
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBalanceChangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads GrossProfitBudget
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBudgetBalanceChangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBudgetBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBudgetBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads GrossProfit PreviousYear
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsGrossProfitBalanceChangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsGrossProfitBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //Historical Data
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsAllPreviousToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsAllPreviousThisYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                            }

                            #region Init BalanceReport, ResultReport, SRU

                            bool onlyGrossCodesInInterval = false;
                            if (accountStd.GrossProfitCode != null && hasGrossProfitCodes)
                            {
                                bool grossInInterval = false;
                                bool netInInterval = false;

                                foreach (ReportHeaderInterval reportHeaderInterval in reportHeadersIntervalsForReportHeader)
                                {
                                    if (StringUtility.IsInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                                    {
                                        if (!reportHeaderInterval.SelectValue.HasValue)
                                            netInInterval = true;

                                        if (reportHeaderInterval.SelectValue.HasValue)
                                            grossInInterval = true;
                                    }
                                }

                                if (grossInInterval)
                                    onlyGrossCodesInInterval = true;

                                if (netInInterval)
                                    onlyGrossCodesInInterval = false;

                            }

                            BalanceItemDTO biBalancechangePeriod = new BalanceItemDTO();

                            //Previus Year
                            BalanceItemDTO biBalancechangePreviousYearPeriod = new BalanceItemDTO();

                            //Previous Periods
                            BalanceItemDTO biBalancechangePreviousPeriodMinus1YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus2YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus3YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus4YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus5YearPeriod = new BalanceItemDTO();

                            //Budget
                            BalanceItemDTO biBudgetBalancechangePeriod = new BalanceItemDTO();

                            #endregion

                            #region Init BalanceReport, ResultReport

                            BalanceItemDTO biBalancechangeToPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeYear = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousYearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousYear = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus1Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus2Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus3Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus4Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus5Year = new BalanceItemDTO();
                            BalanceItemDTO biBudgetBalancechangeToPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBudgetBalancechangeYear = new BalanceItemDTO();

                            //decimal accountBalancechangeToPeriodEnd = Decimal.Zero;
                            decimal accountGrossProfitPeriod = Decimal.Zero;
                            decimal accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitToPeriod = Decimal.Zero;
                            decimal accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitYear = Decimal.Zero;
                            decimal accountGrossProfitYearEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitPeriodInBalance = Decimal.Zero;
                            decimal accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                            decimal accountGrossProfitYearOpeningBalance = Decimal.Zero;
                            decimal accountGrossProfitYearEntCurrencyOpeningBalance = Decimal.Zero;

                            //PreviousYear
                            decimal accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                            decimal accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitPreviousYear = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearOpeningBalance = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Decimal.Zero;


                            //Budget and GrossProfit
                            decimal accountBudgetGrossProfitPeriod = Decimal.Zero;
                            decimal accountBudgetGrossProfitPeriodEntCurrency = Decimal.Zero;
                            decimal accountBudgetGrossProfitToPeriod = Decimal.Zero;
                            decimal accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                            decimal accountBudgetGrossProfitYear = Decimal.Zero;
                            decimal accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;

                            //Voucher Period Summery
                            decimal accountQuantity = Decimal.Zero;
                            decimal accountPeriod1 = Decimal.Zero;
                            decimal accountPeriod2 = Decimal.Zero;
                            decimal accountPeriod3 = Decimal.Zero;
                            decimal accountPeriod4 = Decimal.Zero;
                            decimal accountPeriod5 = Decimal.Zero;
                            decimal accountPeriod6 = Decimal.Zero;
                            decimal accountPeriod7 = Decimal.Zero;
                            decimal accountPeriod8 = Decimal.Zero;
                            decimal accountPeriod9 = Decimal.Zero;
                            decimal accountPeriod10 = Decimal.Zero;
                            decimal accountPeriod11 = Decimal.Zero;
                            decimal accountPeriod12 = Decimal.Zero;

                            //PreviousYear Voucher Period Summery
                            decimal previousYearAccountPeriod1 = Decimal.Zero;
                            decimal previousYearAccountPeriod2 = Decimal.Zero;
                            decimal previousYearAccountPeriod3 = Decimal.Zero;
                            decimal previousYearAccountPeriod4 = Decimal.Zero;
                            decimal previousYearAccountPeriod5 = Decimal.Zero;
                            decimal previousYearAccountPeriod6 = Decimal.Zero;
                            decimal previousYearAccountPeriod7 = Decimal.Zero;
                            decimal previousYearAccountPeriod8 = Decimal.Zero;
                            decimal previousYearAccountPeriod9 = Decimal.Zero;
                            decimal previousYearAccountPeriod10 = Decimal.Zero;
                            decimal previousYearAccountPeriod11 = Decimal.Zero;
                            decimal previousYearAccountPeriod12 = Decimal.Zero;

                            //Previous Period
                            decimal previousPeriodMinus1YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus2YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus3YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus4YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus5YearAccountPeriod = Decimal.Zero;

                            //Budget Voucher Period Summery
                            decimal budgetAccountPeriod1 = Decimal.Zero;
                            decimal budgetAccountPeriod2 = Decimal.Zero;
                            decimal budgetAccountPeriod3 = Decimal.Zero;
                            decimal budgetAccountPeriod4 = Decimal.Zero;
                            decimal budgetAccountPeriod5 = Decimal.Zero;
                            decimal budgetAccountPeriod6 = Decimal.Zero;
                            decimal budgetAccountPeriod7 = Decimal.Zero;
                            decimal budgetAccountPeriod8 = Decimal.Zero;
                            decimal budgetAccountPeriod9 = Decimal.Zero;
                            decimal budgetAccountPeriod10 = Decimal.Zero;
                            decimal budgetAccountPeriod11 = Decimal.Zero;
                            decimal budgetAccountPeriod12 = Decimal.Zero;

                            //Previous Year Voucher Year Summery
                            decimal accountYear0 = Decimal.Zero;
                            decimal accountYearMinus1 = Decimal.Zero;
                            decimal accountYearMinus2 = Decimal.Zero;
                            decimal accountYearMinus3 = Decimal.Zero;
                            decimal accountYearMinus4 = Decimal.Zero;

                            XElement voucherSummeryElement = null;
                            int voucherSummeryXmlId = 0;

                            //Voucher details
                            List<XElement> voucherRowElements = new List<XElement>();

                            #endregion

                            #region Calculate BalanceChangePeriod

                            if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePeriod = biBalancechangePeriodDict[accountStd.AccountId];

                                if (voucherHeadsBalancechangePeriod.Any())
                                {
                                    //VoucherHeads
                                    List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                    voucherHeadsForAccount = voucherHeadsBalancechangePeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)) ? voucherHeadsBalancechangePeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId)).ToList() : new List<VoucherHeadDTO>();
                                    foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                    {
                                        decimal accountVoucherRowAmount = 0;
                                        DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                        List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                        foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                        {
                                            #region Accumulate amounts

                                            if (voucherRow.Quantity.HasValue)
                                                accountQuantity += voucherRow.Quantity.Value;

                                            if (voucherHead.Date.Year == es.DateTo.Year)
                                                accountYear0 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == es.DateTo.AddYears(-1).Year)
                                                accountYearMinus1 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == es.DateTo.AddYears(-2).Year)
                                                accountYearMinus2 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == es.DateTo.AddYears(-3).Year)
                                                accountYearMinus3 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == es.DateTo.AddYears(-4).Year)
                                                accountYearMinus4 += voucherRow.Amount;
                                            if (firstMonth == voucherHeadMonth)
                                                accountPeriod1 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                accountPeriod2 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                accountPeriod3 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                accountPeriod4 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                accountPeriod5 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                accountPeriod6 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                accountPeriod7 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                accountPeriod8 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                accountPeriod9 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                accountPeriod10 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                accountPeriod11 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                accountPeriod12 += voucherRow.Amount;

                                            accountVoucherRowAmount += voucherRow.Amount;

                                            #endregion
                                        }
                                    }
                                }

                                //Accumulate
                                headerSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                headerSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                    groupSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                }
                            }

                            #endregion

                            #region Calculate GrossProfitChangePeriod

                            if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                            {
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                {
                                    accountGrossProfitPeriod = Decimal.Zero;
                                    accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                                    List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                    foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                    {
                                        GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                        if (accountDto != null)
                                        {
                                            List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                            accountGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                            accountGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                        }
                                    }

                                    if (voucherHeadsGrossProfitBalanceChangePeriod.Any())
                                    {
                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (voucherRow.Quantity.HasValue)
                                                    accountQuantity += voucherRow.Quantity.Value;

                                                if (voucherHead.Date.Year == es.DateTo.Year)
                                                    accountYear0 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-1).Year)
                                                    accountYearMinus1 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-2).Year)
                                                    accountYearMinus2 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-3).Year)
                                                    accountYearMinus3 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-4).Year)
                                                    accountYearMinus4 += voucherRow.Amount;
                                                if (firstMonth == voucherHeadMonth)
                                                    accountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    accountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    accountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    accountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    accountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    accountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    accountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    accountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    accountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    accountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    accountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    accountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                        }
                                    }
                                }

                                //Accumulate
                                headerSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                headerSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                    groupSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                }
                            }

                            #endregion

                            #region Calculate GrossProfitChangePeriodBudget

                            if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                            {
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                {
                                    accountBudgetGrossProfitPeriod = Decimal.Zero;
                                    accountBudgetGrossProfitPeriodEntCurrency = Decimal.Zero;
                                    List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                    foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                    {
                                        GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                        if (accountDto != null)
                                        {
                                            List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                            accountBudgetGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                            accountBudgetGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                        }
                                    }

                                    if (voucherHeadsGrossProfitBudgetBalanceChangePeriod.Any() && detailedInformation)
                                    {
                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                        }
                                    }
                                }

                                //Accumulate
                                headerSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                headerSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                    groupSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                }
                            }



                            #endregion

                            #region Calculate BalanceChangePreviousYearPeriod

                            if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousYearPeriod = biBalancechangePreviousYearPeriodDict[accountStd.AccountId];

                                if (previousYearVoucherHeadsBalancechangePeriod.Any() && detailedInformation)
                                {
                                    //VoucherHeads
                                    List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                    voucherHeadsForAccount = previousYearVoucherHeadsBalancechangePeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)) ? previousYearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId)).ToList() : new List<VoucherHeadDTO>();
                                    foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                    {
                                        decimal accountVoucherRowAmount = 0;
                                        DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                        List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                        foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                        {
                                            #region Accumulate amounts

                                            if (firstMonth == voucherHeadMonth)
                                                previousYearAccountPeriod1 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                previousYearAccountPeriod2 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                previousYearAccountPeriod3 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                previousYearAccountPeriod4 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                previousYearAccountPeriod5 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                previousYearAccountPeriod6 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                previousYearAccountPeriod7 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                previousYearAccountPeriod8 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                previousYearAccountPeriod9 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                previousYearAccountPeriod10 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                previousYearAccountPeriod11 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                previousYearAccountPeriod12 += voucherRow.Amount;

                                            accountVoucherRowAmount += voucherRow.Amount;

                                            #endregion
                                        }

                                    }
                                }

                                //Accumulate
                                headerSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                headerSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                    groupSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                }
                            }
                            #endregion

                            #region Calculate GrossProfitChangePeriod Previous Year

                            if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                            {
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                {
                                    accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                                    accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                                    List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                    foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                    {
                                        GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                        if (accountDto != null)
                                        {
                                            List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= prevYearDateFrom && b.PeriodTo <= prevYearDateTo).ToList();
                                            accountGrossProfitPreviousYearPeriod += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                            accountGrossProfitPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                        }
                                    }


                                    if (previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Any() && detailedInformation)
                                    {
                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (firstMonth == voucherHeadMonth)
                                                    previousYearAccountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    previousYearAccountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    previousYearAccountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    previousYearAccountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    previousYearAccountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    previousYearAccountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    previousYearAccountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    previousYearAccountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    previousYearAccountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    previousYearAccountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    previousYearAccountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    previousYearAccountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                        }
                                    }
                                }

                                //Accumulate
                                headerSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                headerSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                    groupSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                }
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus1Year

                            if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus1YearPeriod = biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus2Year

                            if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus2YearPeriod = biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus3Year

                            if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus3YearPeriod = biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus4Year

                            if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus4YearPeriod = biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus5Year

                            if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus5YearPeriod = biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceBudgetChangePeriod

                            if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBudgetBalancechangePeriod = biBudgetBalancechangePeriodDict[accountStd.AccountId];

                                //VoucherHeads
                                if (budgetVoucherHeadsBalancechangePeriod.Any() && detailedInformation)
                                {
                                    //BudgetAccountId is only used for performance
                                    List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                    voucherHeadsForAccount = budgetVoucherHeadsBalancechangePeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId) ? budgetVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList() : new List<VoucherHeadDTO>();
                                    foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                    {
                                        decimal accountVoucherRowAmount = 0;
                                        DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                        List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                        foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                        {
                                            #region Accumulate amounts

                                            if (firstMonth == voucherHeadMonth)
                                                budgetAccountPeriod1 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                budgetAccountPeriod2 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                budgetAccountPeriod3 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                budgetAccountPeriod4 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                budgetAccountPeriod5 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                budgetAccountPeriod6 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                budgetAccountPeriod7 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                budgetAccountPeriod8 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                budgetAccountPeriod9 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                budgetAccountPeriod10 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                budgetAccountPeriod11 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                budgetAccountPeriod12 += voucherRow.Amount;

                                            accountVoucherRowAmount += voucherRow.Amount;

                                            #endregion
                                        }
                                    }
                                }

                                //Accumulate
                                headerSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                headerSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                    groupSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                }
                            }

                            #endregion

                            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                            {
                                #region BalanceReport and ResultReport

                                #region Init BalanceReport

                                BalanceItemDTO biYearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPeriodInBalance = new BalanceItemDTO();

                                //previousYear
                                BalanceItemDTO biPreviousYearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousYearPeriodInBalance = new BalanceItemDTO();

                                //Previous Period
                                BalanceItemDTO biPreviousPeriodMinus1YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus2YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus3YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus4YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus5YearInBalance = new BalanceItemDTO();

                                decimal accountClosingBalance = Decimal.Zero;
                                decimal accountClosingBalanceEntCurrency = Decimal.Zero;


                                //PreviousYear
                                decimal accountClosingBalancePreviousYear = Decimal.Zero;
                                decimal accountClosingBalancePreviousYearEntCurrency = Decimal.Zero;

                                #endregion

                                #region Init ResultReport

                                BalanceItemDTO biAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                //PreviousYear
                                BalanceItemDTO biAccountBalanceChangeAllPreviousToPreviousYearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biAccountBalanceChangeAllPreviousPreviousYear = new BalanceItemDTO();

                                //Budget
                                BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                #endregion

                                #region Calculate BalanceChangeToPeriod

                                if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangeToPeriod = biBalanceChangeToPeriodDict[accountStd.AccountId];


                                    //Accumulate
                                    headerSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                    headerSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                        groupSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangeToPeriod

                                if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitToPeriod = Decimal.Zero;
                                        accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                accountGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBalanceChangeToPeriod.Any() && detailedInformation)
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts
                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }
                                            }
                                        }
                                    }


                                    //Accumulate
                                    headerSumAccountGrossProfitBalancechangeToPeriod += accountGrossProfitToPeriod;
                                    headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeGrossProfitToPeriod += accountGrossProfitToPeriod;
                                        groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangeToPeriodBudget

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountBudgetGrossProfitToPeriod = Decimal.Zero;
                                        accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                accountBudgetGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountBudgetGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Any() && detailedInformation)
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)) ? voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId)).ToList() : new List<VoucherHeadDTO>();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }

                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountGrossProfitBalancechangeToPeriod += accountBudgetGrossProfitToPeriod;
                                    headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitToPeriod;
                                        groupSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                    }
                                }


                                #endregion


                                #region Calculate BalanceChangeToPreviousYearPeriod

                                if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangeToPreviousYearPeriod = biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                    headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                        groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangeToPreviousYearPeriod

                                if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                                        accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                accountGrossProfitToPreviousYearPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitToPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Any())
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                    headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                        groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate BudgetBalanceChangeToPeriod

                                if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBudgetBalancechangeToPeriod = biBudgetBalanceChangeToPeriodDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                    headerSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                        groupSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #endregion

                                #region Calculate BalanceChangeYear

                                if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangeYear = biBalanceChangeYearDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                    headerSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                        groupSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                    }
                                }

                                #region Calculate GrossProfitCode BalanceChangeYear

                                if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitYear = Decimal.Zero;
                                        accountGrossProfitYearEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (var pair in biGrossProfitBalanceChangeYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                DateTime startYear = accountYear.From;
                                                DateTime endYear = accountYear.To;

                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                accountGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitYear += accountGrossProfitYear;
                                    headerSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitYear += accountGrossProfitYear;
                                        groupSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitCode BalanceChangeYear Budget

                                if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountBudgetGrossProfitYear = Decimal.Zero;
                                        accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (var pair in biGrossProfitBalanceChangeYearBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                DateTime startYear = accountYear.From;
                                                DateTime endYear = accountYear.To;

                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                accountBudgetGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountBudgetGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                    headerSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                        groupSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                    }
                                }

                                #endregion

                                #endregion

                                #region Calculate BalanceChangePreviousYear

                                if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousYear = biBalanceChangePreviousYearDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                    headerSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                        groupSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                    }
                                }

                                #region Calculate GrossProfitCode BalanceChangePreviousYear

                                if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitPreviousYear = Decimal.Zero;
                                        accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;

                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();
                                        foreach (var pair in biGrossProfitBalanceChangePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                DateTime startYear = previousAccountYear.From;
                                                DateTime endYear = previousAccountYear.To;

                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                accountGrossProfitPreviousYear += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                accountGrossProfitPreviousYearEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitBalancechangePreviousYearPeriod += accountGrossProfitPreviousYear;
                                    headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPreviousYear += accountGrossProfitPreviousYear;
                                        groupSumAccountGrossProfitPreviousYearEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                    }
                                }

                                #endregion


                                #endregion

                                #region Calculate BudgetBalanceChangeYear

                                if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBudgetBalancechangeYear = biBudgetBalanceChangeYearDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                    headerSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                        groupSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                {
                                    #region BalanceReport

                                    #region Calculate OpeningYearBalance

                                    if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biYearInBalance = biYearInBalanceDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountYearInBalance += biYearInBalance.Balance;
                                        headerSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountYearInBalance += biYearInBalance.Balance;
                                            groupSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                        headerSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                            groupSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                        }
                                    }

                                    #region Calculate GrossProfitCode

                                    if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                    {
                                        GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                        if (grossProfitCode != null)
                                        {
                                            accountGrossProfitYearOpeningBalance = Math.Round((biYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                            accountGrossProfitYearEntCurrencyOpeningBalance = Math.Round((biYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Calculate OpeningYearBalance Previus Year

                                    if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biPreviousYearInBalance = biYearInBalancePreviousYearDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                        headerSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                            groupSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                        headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                            groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                        }
                                    }

                                    #region Calculate OpeningYearBalance GrossProfitCode PreviousYear

                                    if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                    {
                                        GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                        if (grossProfitCode != null)
                                        {
                                            accountGrossProfitPreviousYearOpeningBalance = Math.Round((biPreviousYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                            accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Math.Round((biPreviousYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Calculate PeriodInBalance

                                    //Ingående saldo för aktuell period. (Ingående balans för aktuellt år + Från år start till period start)
                                    //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                    biPeriodInBalance.Balance = biYearInBalance.Balance;

                                    #region Calculate GrossProfitCode

                                    if (accountYear.From != es.DateFrom)
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitPeriodInBalance = Decimal.Zero;
                                            accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime endYear = new DateTime(es.DateFrom.Year, es.DateFrom.Month - 1, DateTime.DaysInMonth(es.DateTo.Year, es.DateFrom.Month - 1));
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);

                                                }
                                            }

                                        }

                                        biPeriodInBalance.Balance += biBalancechangeToPeriod.Balance;
                                        biPeriodInBalance.BalanceEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                    }
                                    else
                                    {
                                        accountGrossProfitYearEntCurrencyOpeningBalance = accountGrossProfitYearOpeningBalance;
                                    }

                                    #endregion

                                    if (biYearInBalance.Quantity.HasValue)
                                        biPeriodInBalance.Quantity += biYearInBalance.Quantity.Value;
                                    if (biBalancechangeToPeriod.Quantity.HasValue)
                                        biPeriodInBalance.Quantity += biBalancechangeToPeriod.Quantity.Value;

                                    //Accumulate
                                    headerSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                    headerSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                        groupSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                    }
                                    headerSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                    headerSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                        groupSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                    }

                                    #endregion

                                    #region Calculate PeriodInBalance Previus Year

                                    //Ingående saldo för aktuell period förra året. (Ingående balans för förra året + Från år start till period start)
                                    //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                    biPreviousYearPeriodInBalance.Balance = biPreviousYearInBalance.Balance;

                                    #region Calculate GrossProfitCode Previus Year

                                    if (previousAccountYear != null && previousAccountYear.From != prevYearDateFrom)
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                                            accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitYearInBalancePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime endYear = new DateTime(prevYearDateFrom.Year, prevYearDateFrom.Month - 1, DateTime.DaysInMonth(prevYearDateTo.Year, prevYearDateFrom.Month - 1));
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitPreviousYearPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                    accountGrossProfitPreviousYearPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        biPreviousYearPeriodInBalance.Balance += biBalancechangeToPreviousYearPeriod.Balance;
                                        biPreviousYearPeriodInBalance.BalanceEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    }
                                    else
                                    {
                                        accountGrossProfitPreviousYearEntCurrencyOpeningBalance = accountGrossProfitPreviousYearOpeningBalance;
                                    }

                                    #endregion

                                    if (biPreviousYearInBalance.Quantity.HasValue)
                                        biPreviousYearPeriodInBalance.Quantity += biPreviousYearInBalance.Quantity.Value;

                                    if (biBalancechangeToPreviousYearPeriod.Quantity.HasValue)
                                        biPreviousYearPeriodInBalance.Quantity += biBalancechangeToPreviousYearPeriod.Quantity.Value;

                                    //Accumulate
                                    headerSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                    headerSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                        groupSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                    }
                                    headerSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                    headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                        groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                    }

                                    #endregion

                                    #region Calculate ClosingYearBalance

                                    //Utgående balans för aktuellt år
                                    accountClosingBalance = biPeriodInBalance.Balance + biBalancechangePeriod.Balance;
                                    accountClosingBalanceEntCurrency = biPeriodInBalance.BalanceEntCurrency + biBalancechangePeriod.BalanceEntCurrency;

                                    //Accumulate
                                    headerSumAccountClosingBalance += accountClosingBalance;
                                    headerSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountClosingBalance += accountClosingBalance;
                                        groupSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                    }

                                    #endregion

                                    #region Calculate ClosingYearBalance Previus Year

                                    //Utgående balans för aktuellt år
                                    accountClosingBalancePreviousYear = biPreviousYearPeriodInBalance.Balance + biBalancechangePreviousYearPeriod.Balance;
                                    accountClosingBalancePreviousYearEntCurrency = biPreviousYearPeriodInBalance.BalanceEntCurrency + biBalancechangePreviousYearPeriod.BalanceEntCurrency;

                                    //Accumulate
                                    headerSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                    headerSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                        groupSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                    }

                                    #endregion

                                    #region Calculate BalanceChangeToPeriodEnd

                                    ////Från år start till period slut
                                    //accountBalancechangeToPeriodEnd = accountClosingBalance - biOpeningBalance.Balance;

                                    ////Accumulate
                                    //headerSumAccountBalancechangeToPeriodEnd += accountBalancechangeToPeriodEnd;
                                    //groupSumAccountBalancechangeToPeriodEnd += accountBalancechangeToPeriodEnd;

                                    #endregion

                                    #endregion
                                }
                                else if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                                {
                                    #region ResultReport

                                    #region Calculate AccountBalanceChangeAllPreviousToPeriod

                                    if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousToPeriod = biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                        headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                            groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate AccountBalanceChangeAllPreviousToPreviousYearPeriod

                                    if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousToPreviousYearPeriod = biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                        headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                            groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate AccountBalanceChangeAllPreviousThisYear

                                    if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousThisYear = biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                        headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                            groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate AccountBalanceChangeAllPreviousPreviousYear

                                    if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousPreviousYear = biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                        headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                            groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #endregion
                                }

                                #endregion

                                #region XElement Account



                                #region Init

                                bool isInactive = accountStd.State == SoeEntityState.Inactive;
                                decimal period = invertRow ? Decimal.Negate(biBalancechangePeriod.Balance) : biBalancechangePeriod.Balance;
                                decimal periodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePeriod.BalanceEntCurrency) : biBalancechangePeriod.BalanceEntCurrency;
                                decimal grossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriod) : accountGrossProfitPeriod;
                                decimal grossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrency) : accountGrossProfitPeriodEntCurrency;
                                decimal toPeriod = invertRow ? Decimal.Negate(biBalancechangeToPeriod.Balance) : biBalancechangeToPeriod.Balance;
                                decimal toPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPeriod.BalanceEntCurrency) : biBalancechangeToPeriod.BalanceEntCurrency;
                                decimal year = invertRow ? Decimal.Negate(biBalancechangeYear.Balance) : biBalancechangeYear.Balance;
                                decimal yearEntCurrency = invertRow ? Decimal.Negate(biBalancechangeYear.BalanceEntCurrency) : biBalancechangeYear.BalanceEntCurrency;
                                decimal grossProfitYear = invertRow ? Decimal.Negate(accountGrossProfitYear) : accountGrossProfitYear;
                                decimal grossProfitEntCurrencyYear = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrency) : accountGrossProfitYearEntCurrency;
                                //Previous Year
                                decimal previousYearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.Balance) : biBalancechangePreviousYearPeriod.Balance;
                                decimal previousYearPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.BalanceEntCurrency) : biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                decimal previousYearGrossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriod) : accountGrossProfitPreviousYearPeriod;
                                decimal previousYearGrossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrency) : accountGrossProfitPreviousYearPeriodEntCurrency;
                                decimal previousYearToPeriod = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.Balance) : biBalancechangeToPreviousYearPeriod.Balance;
                                decimal previousYearToPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.BalanceEntCurrency) : biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                decimal previousYear = invertRow ? Decimal.Negate(biBalancechangePreviousYear.Balance) : biBalancechangePreviousYear.Balance;
                                decimal previousYearEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYear.BalanceEntCurrency) : biBalancechangePreviousYear.BalanceEntCurrency;
                                decimal previousYearGrossProfit = invertRow ? Decimal.Negate(accountGrossProfitPreviousYear) : accountGrossProfitPreviousYear;
                                decimal previousYearGrossProfitEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearEntCurrency) : accountGrossProfitPreviousYearEntCurrency;
                                //Previous Period
                                decimal previousPeriodMinus1YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus1YearPeriod.Balance) : biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                decimal previousPeriodMinus2YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus2YearPeriod.Balance) : biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                decimal previousPeriodMinus3YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus3YearPeriod.Balance) : biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                decimal previousPeriodMinus4YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus4YearPeriod.Balance) : biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                decimal previousPeriodMinus5YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus5YearPeriod.Balance) : biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                //Budget
                                decimal budgetPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.Balance) : biBudgetBalancechangePeriod.Balance;
                                decimal budgetPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.BalanceEntCurrency) : biBudgetBalancechangePeriod.BalanceEntCurrency;
                                decimal budgetToPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.Balance) : biBudgetBalancechangeToPeriod.Balance;
                                decimal budgetToPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.BalanceEntCurrency) : biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                decimal budgetYear = invertRow ? Decimal.Negate(biBalancechangeYear.Balance) : biBudgetBalancechangeYear.Balance;
                                decimal budgetYearEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeYear.BalanceEntCurrency) : biBudgetBalancechangeYear.BalanceEntCurrency;

                                //Do not include inactive accounts that has no balance
                                //if (isInactive && NumberUtility.IsAllZero(period, toPeriod, year, previousYear, budgetYear, previousPeriodMinus2YearPeriod, previousPeriodMinus3YearPeriod, previousPeriodMinus4YearPeriod, previousPeriodMinus5YearPeriod))
                                //    continue;

                                #endregion

                                #region Add elements

                                accountElement = new XElement("Account",
                                    new XAttribute("id", accountXmlId),
                                    new XElement("AccountNr", accountStd.AccountNr),
                                    new XElement("AccountName", accountStd.Name),
                                    new XElement("AccountInternalNr1", String.Empty), //TODO
                                    new XElement("AccountInternalName1", String.Empty), //TODO
                                    new XElement("AccountInternalNr2", String.Empty), //TODO
                                    new XElement("AccountInternalName2", String.Empty), //TODO
                                    new XElement("AccountInternalNr3", String.Empty), //TODO
                                    new XElement("AccountInternalName3", String.Empty), //TODO
                                    new XElement("AccountInternalNr4", String.Empty), //TODO
                                    new XElement("AccountInternalName4", String.Empty), //TODO
                                    new XElement("AccountInternalNr5", String.Empty), //TODO
                                    new XElement("AccountInternalName5", String.Empty), //TODO
                                    new XElement("AccountInternalNr6", String.Empty), //TODO
                                    new XElement("AccountInternalName6", String.Empty), //TODO
                                    new XElement("AccountBalancechangePeriod", period),
                                    new XElement("AccountBalancechangePeriodEntCurrency", periodEntCurrency),
                                    new XElement("AccountGrossProfitPeriod", grossProfitPeriod),
                                    new XElement("AccountGrossProfitPeriodEntCurrency", grossProfitEntCurrencyPeriod),
                                    new XElement("AccountBalancechangeToPeriod", toPeriod),
                                    new XElement("AccountBalancechangeToPeriodEntCurrency", toPeriodEntCurrency),
                                    new XElement("AccountBalancechangeYear", year),
                                    new XElement("AccountBalancechangeYearEntCurrency", yearEntCurrency),
                                    new XElement("AccountGrossProfitYear", grossProfitYear),
                                    new XElement("AccountGrossProfitYearEntCurrency", grossProfitEntCurrencyYear),

                                    //Previous Year
                                    new XElement("PreviousYearAccountBalancechangePeriod", previousYearPeriod),
                                    new XElement("PreviousYearAccountBalancechangePeriodEntCurrency", previousYearPeriodEntCurrency),
                                    new XElement("PreviousYearAccountGrossProfitPeriod", previousYearGrossProfitPeriod),
                                    new XElement("PreviousYearAccountGrossProfitPeriodEntCurrency", previousYearGrossProfitEntCurrencyPeriod),
                                    new XElement("PreviousYearAccountBalancechangeToPeriod", previousYearToPeriod),
                                    new XElement("PreviousYearAccountBalancechangeToPeriodEntCurrency", previousYearToPeriodEntCurrency),
                                    new XElement("PreviousYearAccountBalancechangeYear", previousYear),
                                    new XElement("PreviousYearAccountBalancechangeYearEntCurrency", previousYearEntCurrency),
                                    new XElement("PreviousYearAccountGrossProfitYear", previousYearGrossProfit),
                                    new XElement("PreviousYearAccountGrossProfitYearEntCurrency", previousYearGrossProfitEntCurrency),

                                    //previous Period
                                    new XElement("PreviousPeriodMinus1YearAccountBalancechangePeriod", previousPeriodMinus1YearPeriod),
                                    new XElement("PreviousPeriodMinus2YearAccountBalancechangePeriod", previousPeriodMinus2YearPeriod),
                                    new XElement("PreviousPeriodMinus3YearAccountBalancechangePeriod", previousPeriodMinus3YearPeriod),
                                    new XElement("PreviousPeriodMinus4YearAccountBalancechangePeriod", previousPeriodMinus4YearPeriod),
                                    new XElement("PreviousPeriodMinus5YearAccountBalancechangePeriod", previousPeriodMinus5YearPeriod),

                                    //Budget
                                    new XElement("BudgetAccountBalancechangePeriod", budgetPeriod),
                                    new XElement("BudgetAccountBalancechangePeriodEntCurrency", budgetPeriodEntCurrency),
                                    new XElement("BudgetAccountBalancechangeToPeriod", budgetToPeriod),
                                    new XElement("BudgetAccountBalancechangeToPeriodEntCurrency", budgetToPeriodEntCurrency),
                                    new XElement("BudgetAccountBalancechangeYear", budgetYear),
                                    new XElement("BudgetAccountBalancechangeYearEntCurrency", budgetYearEntCurrency),
                                    new XElement("BudgetAccountGrossProfitPeriod", accountBudgetGrossProfitPeriod));



                                #endregion

                                if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                {
                                    #region BalanceReport

                                    #region Init

                                    decimal periodInBalance = invertRow ? Decimal.Negate(biPeriodInBalance.Balance) : biPeriodInBalance.Balance;
                                    decimal periodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPeriodInBalance.BalanceEntCurrency) : biPeriodInBalance.BalanceEntCurrency;
                                    decimal grossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPeriodInBalance) : accountGrossProfitPeriodInBalance;
                                    decimal grossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrencyInBalance) : accountGrossProfitPeriodEntCurrencyInBalance;
                                    decimal periodOpeningBalance = invertRow ? Decimal.Negate(biYearInBalance.Balance) : biYearInBalance.Balance;
                                    decimal periodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biYearInBalance.BalanceEntCurrency) : biYearInBalance.BalanceEntCurrency;
                                    decimal grossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitYearOpeningBalance) : accountGrossProfitYearOpeningBalance;
                                    decimal grossProfitPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrencyOpeningBalance) : accountGrossProfitYearEntCurrencyOpeningBalance;
                                    decimal periodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalance) : accountClosingBalance;


                                    //PreviousYear
                                    decimal previousYearPeriodInBalance = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.Balance) : biPreviousYearPeriodInBalance.Balance;
                                    decimal previousYearPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.BalanceEntCurrency) : biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                    decimal previousYearGrossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodInBalance) : accountGrossProfitPreviousYearPeriodInBalance;
                                    decimal previousYearGrossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrencyInBalance) : accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                    decimal previousYearPeriodOpeningBalance = invertRow ? Decimal.Negate(biPreviousYearInBalance.Balance) : biPreviousYearInBalance.Balance;
                                    decimal previousYearPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearInBalance.BalanceEntCurrency) : biPreviousYearInBalance.BalanceEntCurrency;
                                    decimal previousYearGrossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearOpeningBalance) : accountGrossProfitPreviousYearOpeningBalance;
                                    decimal previousYearPeriodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalancePreviousYear) : accountClosingBalancePreviousYear;
                                    decimal previousYearPeriodClosingBalanceEntCurrency = invertRow ? Decimal.Negate(accountClosingBalancePreviousYearEntCurrency) : accountClosingBalancePreviousYearEntCurrency;


                                    //Do not include inactive accounts that has no balance
                                    //if (isInactive && NumberUtility.IsAllZero(periodInBalance, periodOpeningBalance, periodClosingBalance, previousYearPeriodInBalance, previousYearPeriodOpeningBalance, previousYearPeriodClosingBalance))
                                    //    continue;

                                    #endregion

                                    #region Add elements

                                    accountElement.Add(
                                        new XElement("AccountPeriodInBalance", periodInBalance),
                                        new XElement("AccountPeriodInBalanceEntCurrency", periodInBalanceEntCurrency),
                                        new XElement("AccountGrossProfitPeriodInBalance", grossProfitPeriodInBalance),
                                        new XElement("AccountGrossProfitPeriodInBalanceEntCurrency", grossProfitPeriodInBalanceEntCurrency),
                                        new XElement("AccountOpeningBalance", periodOpeningBalance),
                                        new XElement("AccountOpeningBalanceEntCurrency", periodOpeningBalanceEntCurrency),
                                        new XElement("AccountGrossProfitOpeningBalance", grossProfitPeriodOpeningBalance),
                                        new XElement("AccountGrossProfitOpeningBalanceEntCurrency", grossProfitPeriodOpeningBalanceEntCurrency),
                                        new XElement("AccountClosingBalance", periodClosingBalance),

                                        //Previous Year
                                        new XElement("PreviousYearAccountPeriodInBalance", previousYearPeriodInBalance),
                                        new XElement("PreviousYearAccountPeriodInBalanceEntCurrency", previousYearPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitPeriodInBalance", previousYearGrossProfitPeriodInBalance),
                                        new XElement("PreviousYearAccountGrossProfitPeriodInBalanceEntCurrency", previousYearGrossProfitPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearAccountOpeningBalance", previousYearPeriodOpeningBalance),
                                        new XElement("PreviousYearAccountOpeningBalanceEntCurrency", previousYearPeriodOpeningBalanceEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitOpeningBalance", previousYearGrossProfitPeriodOpeningBalance),
                                        new XElement("PreviousYearAccountClosingBalance", previousYearPeriodClosingBalance),
                                        new XElement("PreviousYearAccountClosingBalanceEntCurrency", previousYearPeriodClosingBalanceEntCurrency));


                                    #endregion

                                    #endregion
                                }
                                else if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                                {
                                    #region ResultReport

                                    #region Init

                                    decimal accountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.Balance) : biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                    decimal accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                    decimal accountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.Balance) : biAccountBalanceChangeAllPreviousThisYear.Balance;
                                    decimal accountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                    //Previous Year
                                    decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                    decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYearAccountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.Balance) : biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                    decimal previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;


                                    //Do not include inactive accounts that has no balance
                                    //if (isInactive && es.IncludeAllHistoricalData && NumberUtility.IsAllZero(accountBalanceChangeAllPreviousToPeriodBalance, accountBalanceChangeAllPreviousThisYearBalance))
                                    //    continue;

                                    #endregion

                                    #region Add elements

                                    accountElement.Add(
                                        new XElement("AccountBalanceChangeAllPreviousToPeriodBalance", accountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("AccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        new XElement("AccountBalanceChangeAllPreviousThisYearBalance", accountBalanceChangeAllPreviousThisYearBalance),
                                        new XElement("AccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", accountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                        //Previous Year
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalance", previousYearAccountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalance", previousYearAccountBalanceChangeAllPreviousThisYearBalance),
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency));

                                    #endregion

                                    #endregion
                                }

                                #region VoucherSummery

                                if (accountQuantity != 0 || accountPeriod1 != 0 || accountPeriod2 != 0 || accountPeriod3 != 0 || accountPeriod4 != 0 || accountPeriod5 != 0 || accountPeriod5 != 0 || accountPeriod6 != 0 || accountPeriod7 != 0 || accountPeriod8 != 0 || accountPeriod9 != 0 || accountPeriod10 != 0 || accountPeriod11 != 0 || accountPeriod12 != 0 || previousYearAccountPeriod1 != 0)
                                {
                                    voucherSummeryElement = new XElement("VoucherSummery",
                                        new XAttribute("id", voucherSummeryXmlId),
                                        new XElement("VoucherSummeryAccountNr", accountStd.AccountNr),
                                        new XElement("VoucherSummeryAccountName", accountStd.Name),
                                        new XElement("VoucherSummeryAccountQuantity", accountQuantity),
                                        new XElement("VoucherSummeryYear0", invertRow ? Decimal.Negate(accountYear0) : accountYear0),
                                        new XElement("VoucherSummeryYearMinus1", invertRow ? Decimal.Negate(accountYearMinus1) : accountYearMinus1),
                                        new XElement("VoucherSummeryYearMinus2", invertRow ? Decimal.Negate(accountYearMinus2) : accountYearMinus2),
                                        new XElement("VoucherSummeryYearMinus3", invertRow ? Decimal.Negate(accountYearMinus3) : accountYearMinus3),
                                        new XElement("VoucherSummeryYearMinus4", invertRow ? Decimal.Negate(accountYearMinus4) : accountYearMinus4),
                                        new XElement("VoucherSummeryAccountPeriod1", invertRow ? Decimal.Negate(accountPeriod1) : accountPeriod1),
                                        new XElement("VoucherSummeryAccountPeriod2", invertRow ? Decimal.Negate(accountPeriod2) : accountPeriod2),
                                        new XElement("VoucherSummeryAccountPeriod3", invertRow ? Decimal.Negate(accountPeriod3) : accountPeriod3),
                                        new XElement("VoucherSummeryAccountPeriod4", invertRow ? Decimal.Negate(accountPeriod4) : accountPeriod4),
                                        new XElement("VoucherSummeryAccountPeriod5", invertRow ? Decimal.Negate(accountPeriod5) : accountPeriod5),
                                        new XElement("VoucherSummeryAccountPeriod6", invertRow ? Decimal.Negate(accountPeriod6) : accountPeriod6),
                                        new XElement("VoucherSummeryAccountPeriod7", invertRow ? Decimal.Negate(accountPeriod7) : accountPeriod7),
                                        new XElement("VoucherSummeryAccountPeriod8", invertRow ? Decimal.Negate(accountPeriod8) : accountPeriod8),
                                        new XElement("VoucherSummeryAccountPeriod9", invertRow ? Decimal.Negate(accountPeriod9) : accountPeriod9),
                                        new XElement("VoucherSummeryAccountPeriod10", invertRow ? Decimal.Negate(accountPeriod10) : accountPeriod10),
                                        new XElement("VoucherSummeryAccountPeriod11", invertRow ? Decimal.Negate(accountPeriod11) : accountPeriod11),
                                        new XElement("VoucherSummeryAccountPeriod12", invertRow ? Decimal.Negate(accountPeriod12) : accountPeriod12),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod1", invertRow ? Decimal.Negate(previousYearAccountPeriod1) : previousYearAccountPeriod1),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod2", invertRow ? Decimal.Negate(previousYearAccountPeriod2) : previousYearAccountPeriod2),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod3", invertRow ? Decimal.Negate(previousYearAccountPeriod3) : previousYearAccountPeriod3),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod4", invertRow ? Decimal.Negate(previousYearAccountPeriod4) : previousYearAccountPeriod4),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod5", invertRow ? Decimal.Negate(previousYearAccountPeriod5) : previousYearAccountPeriod5),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod6", invertRow ? Decimal.Negate(previousYearAccountPeriod6) : previousYearAccountPeriod6),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod7", invertRow ? Decimal.Negate(previousYearAccountPeriod7) : previousYearAccountPeriod7),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod8", invertRow ? Decimal.Negate(previousYearAccountPeriod8) : previousYearAccountPeriod8),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod9", invertRow ? Decimal.Negate(previousYearAccountPeriod9) : previousYearAccountPeriod9),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod10", invertRow ? Decimal.Negate(previousYearAccountPeriod10) : previousYearAccountPeriod10),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod11", invertRow ? Decimal.Negate(previousYearAccountPeriod11) : previousYearAccountPeriod11),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod12", invertRow ? Decimal.Negate(previousYearAccountPeriod12) : previousYearAccountPeriod12),
                                        new XElement("VoucherSummeryPreviousPeriodMinus1Year", invertRow ? Decimal.Negate(previousPeriodMinus1YearAccountPeriod) : previousPeriodMinus1YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus2Year", invertRow ? Decimal.Negate(previousPeriodMinus2YearAccountPeriod) : previousPeriodMinus2YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus3Year", invertRow ? Decimal.Negate(previousPeriodMinus3YearAccountPeriod) : previousPeriodMinus3YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus4Year", invertRow ? Decimal.Negate(previousPeriodMinus4YearAccountPeriod) : previousPeriodMinus4YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus5Year", invertRow ? Decimal.Negate(previousPeriodMinus5YearAccountPeriod) : previousPeriodMinus5YearAccountPeriod),
                                        new XElement("VoucherSummeryBudgetAccountPeriod1", invertRow ? Decimal.Negate(budgetAccountPeriod1) : budgetAccountPeriod1),
                                        new XElement("VoucherSummeryBudgetAccountPeriod2", invertRow ? Decimal.Negate(budgetAccountPeriod2) : budgetAccountPeriod2),
                                        new XElement("VoucherSummeryBudgetAccountPeriod3", invertRow ? Decimal.Negate(budgetAccountPeriod3) : budgetAccountPeriod3),
                                        new XElement("VoucherSummeryBudgetAccountPeriod4", invertRow ? Decimal.Negate(budgetAccountPeriod4) : budgetAccountPeriod4),
                                        new XElement("VoucherSummeryBudgetAccountPeriod5", invertRow ? Decimal.Negate(budgetAccountPeriod5) : budgetAccountPeriod5),
                                        new XElement("VoucherSummeryBudgetAccountPeriod6", invertRow ? Decimal.Negate(budgetAccountPeriod6) : budgetAccountPeriod6),
                                        new XElement("VoucherSummeryBudgetAccountPeriod7", invertRow ? Decimal.Negate(budgetAccountPeriod7) : budgetAccountPeriod7),
                                        new XElement("VoucherSummeryBudgetAccountPeriod8", invertRow ? Decimal.Negate(budgetAccountPeriod8) : budgetAccountPeriod8),
                                        new XElement("VoucherSummeryBudgetAccountPeriod9", invertRow ? Decimal.Negate(budgetAccountPeriod9) : budgetAccountPeriod9),
                                        new XElement("VoucherSummeryBudgetAccountPeriod10", invertRow ? Decimal.Negate(budgetAccountPeriod10) : budgetAccountPeriod10),
                                        new XElement("VoucherSummeryBudgetAccountPeriod11", invertRow ? Decimal.Negate(budgetAccountPeriod11) : budgetAccountPeriod11),
                                        new XElement("VoucherSummeryBudgetAccountPeriod12", invertRow ? Decimal.Negate(budgetAccountPeriod12) : budgetAccountPeriod12));

                                    voucherSummeryXmlId += 1;
                                    voucherSummeryElement.Add(voucherRowElements);
                                    accountElement.Add(voucherSummeryElement);
                                }

                                if (!voucherRowElements.Any() && accountXmlId == 1)
                                {
                                    voucherSummeryElement = new XElement("VoucherSummery",
                                        new XAttribute("id", voucherSummeryXmlId),
                                        new XElement("VoucherSummeryAccountNr", "Empty"),
                                        new XElement("VoucherSummeryAccountName", "Empty Element ONLY available with detailed information"),
                                        new XElement("VoucherSummeryAccountQuantity", 0),
                                        new XElement("VoucherSummeryYear0", 0),
                                        new XElement("VoucherSummeryYearMinus1", 0),
                                        new XElement("VoucherSummeryYearMinus2", 0),
                                        new XElement("VoucherSummeryYearMinus3", 0),
                                        new XElement("VoucherSummeryYearMinus4", 0),
                                        new XElement("VoucherSummeryAccountPeriod1", 0),
                                        new XElement("VoucherSummeryAccountPeriod2", 0),
                                        new XElement("VoucherSummeryAccountPeriod3", 0),
                                        new XElement("VoucherSummeryAccountPeriod4", 0),
                                        new XElement("VoucherSummeryAccountPeriod5", 0),
                                        new XElement("VoucherSummeryAccountPeriod6", 0),
                                        new XElement("VoucherSummeryAccountPeriod7", 0),
                                        new XElement("VoucherSummeryAccountPeriod8", 0),
                                        new XElement("VoucherSummeryAccountPeriod9", 0),
                                        new XElement("VoucherSummeryAccountPeriod10", 0),
                                        new XElement("VoucherSummeryAccountPeriod11", 0),
                                        new XElement("VoucherSummeryAccountPeriod12", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod1", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod2", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod3", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod4", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod5", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod6", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod7", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod8", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod9", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod10", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod11", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod12", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus1Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus2Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus3Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus4Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus5Year", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod1", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod2", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod3", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod4", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod5", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod6", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod7", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod8", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod9", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod10", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod11", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod12", 0));

                                    voucherSummeryXmlId += 1;
                                    voucherSummeryElement.Add(voucherRowElements);
                                    accountElement.Add(voucherSummeryElement);
                                }

                                #endregion

                                accountElementsForHeader.Add(accountElement);

                                #endregion
                            }

                            accountXmlId++;

                            #region DetailedInformation

                            if (es.GetDetailedInformation && accountAndInternalAccountComboDTOs.Any())
                            {
                                int accountDetailXmlId = 0;

                                List<XElement> accountDetailElements = new List<XElement>();

                                foreach (var comboDTO in accountAndInternalAccountComboDTOs)
                                {
                                    if (!comboDTO.Dim2Id.HasValue && !comboDTO.Dim3Id.HasValue && !comboDTO.Dim4Id.HasValue && !comboDTO.Dim5Id.HasValue && !comboDTO.Dim6Id.HasValue)
                                        continue;

                                    decimal detAccchangeAllPrevToPer = Decimal.Zero;
                                    decimal detAccchangeAllPrevToPerEntCurr = Decimal.Zero;
                                    decimal detAccchangeAllPrevThisYear = Decimal.Zero;
                                    decimal detAccchangeAllPrevThisYearEntCurr = Decimal.Zero;

                                    decimal detAccchangePer = Decimal.Zero;
                                    decimal detAccchangePerEntCurr = Decimal.Zero;
                                    decimal detAccchangeToPer = Decimal.Zero;
                                    decimal detAccchangeToPerEntCurr = Decimal.Zero;
                                    decimal detAccChangeYear = Decimal.Zero;
                                    decimal detAccChangeYearEntCurr = Decimal.Zero;
                                    decimal detAccChangePrevYearPer = Decimal.Zero;
                                    decimal detAccChangePrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccChangeToPrevYearPer = Decimal.Zero;
                                    decimal detAccChangeToPrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccChangePrevYear = Decimal.Zero;
                                    decimal detAccChangePrevYearEntCurr = Decimal.Zero;
                                    decimal detAccBudChangePer = Decimal.Zero;
                                    decimal detAccBudChangePerEntCurr = Decimal.Zero;
                                    decimal detAccBudChangeToPer = Decimal.Zero;
                                    decimal detAccBudChangeToPerEntCurr = Decimal.Zero;
                                    decimal detAccBudChangeYear = Decimal.Zero;
                                    decimal detAccBudChangeYearEntCurr = Decimal.Zero;

                                    //decimal detAccBalancechangeToPerEnd = Decimal.Zero;
                                    decimal detAccGPPer = Decimal.Zero;
                                    decimal detAccGPPerEntCurr = Decimal.Zero;
                                    decimal detAccGPToPer = Decimal.Zero;
                                    decimal detAccGPToPerEntCurr = Decimal.Zero;
                                    decimal detAccGPYear = Decimal.Zero;
                                    decimal detAccGPYearEntCurr = Decimal.Zero;
                                    //decimal detAccGPPerInBalance = Decimal.Zero;
                                    //decimal detAccGPPerEntCurrInBalance = Decimal.Zero;
                                    //decimal detAccGPYearOpeningBalance = Decimal.Zero;
                                    //decimal detAccGPYearEntCurrOpeningBalance = Decimal.Zero;

                                    //PrevYear
                                    decimal detAccGPPrevYearPer = Decimal.Zero;
                                    decimal detAccGPPrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccGPToPrevYearPer = Decimal.Zero;
                                    decimal detAccGPToPrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccGPPrevYear = Decimal.Zero;
                                    decimal detAccGPPrevYearEntCurr = Decimal.Zero;
                                    //decimal detAccGPPrevYearPerInBalance = Decimal.Zero;
                                    //decimal detAccGPPrevYearPerEntCurrInBalance = Decimal.Zero;
                                    //decimal detAccGPPrevYearOpeningBalance = Decimal.Zero;
                                    //decimal detAccGPPrevYearOpeningBalanceEntCurr = Decimal.Zero;


                                    //Budget and GP
                                    decimal detAccBudgetGPPer = Decimal.Zero;
                                    decimal detAccBudgetGPPerEntCurr = Decimal.Zero;
                                    decimal detAccBudgetGPToPer = Decimal.Zero;
                                    decimal detAccBudgetGPToPerEntCurr = Decimal.Zero;
                                    decimal detAccBudgetGPYear = Decimal.Zero;
                                    decimal detAccBudgetGPYearEntCurr = Decimal.Zero;


                                    var pairDetAccchangeAllPrevToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsAllPreviousToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccchangeAllPrevToPer = pairDetAccchangeAllPrevToPer.Key;
                                    detAccchangeAllPrevToPerEntCurr = pairDetAccchangeAllPrevToPer.Value;

                                    var pairDetAccchangeAllPrevThisYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsAllPreviousThisYear, accountDimInternals, accountInternalsInInterval);
                                    detAccchangeAllPrevThisYear = pairDetAccchangeAllPrevToPer.Key;
                                    detAccchangeAllPrevThisYearEntCurr = pairDetAccchangeAllPrevToPer.Value;

                                    var pairDetAccchangePer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsBalancechangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccchangePer = pairDetAccchangePer.Key;
                                    detAccchangePerEntCurr = pairDetAccchangePer.Value;

                                    var pairDetAccchangeToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccchangeToPer = pairDetAccchangeToPer.Key;
                                    detAccchangeToPerEntCurr = pairDetAccchangeToPer.Value;

                                    var pairDetAccChangeYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccChangeYear = pairDetAccChangeYear.Key;
                                    detAccChangeYearEntCurr = pairDetAccChangeYear.Value;

                                    var pairDetAccChangePreYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsBalancechangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccChangePrevYearPer = pairDetAccChangePreYearPer.Key;
                                    detAccChangePrevYearPerEntCurr = pairDetAccChangePreYearPer.Value;

                                    var pairDetAccChangeToPreYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccChangeToPrevYearPer = pairDetAccChangeToPreYearPer.Key;
                                    detAccChangeToPrevYearPerEntCurr = pairDetAccChangeToPreYearPer.Value;

                                    var pairDetAccChangePrevYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccChangePrevYear = pairDetAccChangePrevYear.Key;
                                    detAccChangePrevYearEntCurr = pairDetAccChangePrevYear.Value;

                                    var pairDetAccBudChangePer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudChangePer = pairDetAccBudChangePer.Key;
                                    detAccBudChangePerEntCurr = pairDetAccBudChangePer.Value;

                                    var pairDetAccBudChangeToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudChangeToPer = pairDetAccBudChangeToPer.Key;
                                    detAccBudChangeToPerEntCurr = pairDetAccBudChangeToPer.Value;

                                    var pairDetAccBudChangeYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccBudChangeYear = pairDetAccBudChangeYear.Key;
                                    detAccBudChangeYearEntCurr = pairDetAccBudChangeYear.Value;

                                    var pairDetAccGPPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPPer = pairDetAccGPPer.Key;
                                    detAccGPPerEntCurr = pairDetAccGPPer.Value;

                                    var pairDetAccGPToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPToPer = pairDetAccGPToPer.Key;
                                    detAccGPToPerEntCurr = pairDetAccGPToPer.Value;

                                    var pairDetAccGPYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccGPYear = pairDetAccGPYear.Key;
                                    detAccGPYearEntCurr = pairDetAccGPYear.Value;

                                    //var pairDetAccGPPerInBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeInBalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPPerInBalance = pairDetAccGPPerInBalance.Key;
                                    //detAccGPPerEntCurrInBalance = pairDetAccGPPerInBalance.Value;

                                    //var pairDetAccGPYearOpeningBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeOpeningBalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPYearOpeningBalance = pairDetAccGPYearOpeningBalance.Key;
                                    //detAccGPYearEntCurrOpeningBalance = pairDetAccGPYearOpeningBalance.Value;

                                    var pairDetAccGPPrevYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPPrevYearPer = pairDetAccGPPrevYearPer.Key;
                                    detAccGPPrevYearPerEntCurr = pairDetAccGPPrevYearPer.Value;

                                    var pairDetAccGPToPrevYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPToPrevYearPer = pairDetAccGPToPrevYearPer.Key;
                                    detAccGPToPrevYearPerEntCurr = pairDetAccGPToPrevYearPer.Value;

                                    var pairDetAccGPPrevYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccGPPrevYear = pairDetAccGPPrevYear.Key;
                                    detAccGPPrevYearEntCurr = pairDetAccGPPrevYear.Value;

                                    //var pairDetAccGPPrevYearPerInBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeInbalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPPrevYearPerInBalance = pairDetAccGPPrevYearPerInBalance.Key;
                                    //detAccGPPrevYearPerEntCurrInBalance = pairDetAccGPPrevYearPerInBalance.Value;

                                    //var pairDetAccGPPrevYearOpeningBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeOpeningBalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPPrevYearOpeningBalance = pairDetAccGPPrevYearOpeningBalance.Key;
                                    //detAccGPPrevYearOpeningBalanceEntCurr = pairDetAccGPPrevYearOpeningBalance.Value;

                                    var pairDetAccBudgetGPPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalancechangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudgetGPPer = pairDetAccBudgetGPPer.Key;
                                    detAccBudgetGPPerEntCurr = pairDetAccBudgetGPPer.Value;

                                    var pairDetAccBudgetGPToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudgetGPToPer = pairDetAccBudgetGPToPer.Key;
                                    detAccBudgetGPToPerEntCurr = pairDetAccBudgetGPToPer.Value;

                                    var pairDetAccBudgetGPYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccBudgetGPYear = pairDetAccBudgetGPYear.Key;
                                    detAccBudgetGPYearEntCurr = pairDetAccBudgetGPYear.Value;

                                    XElement accountDetailElement = new XElement("AccountDetail",
                                    new XAttribute("id", accountDetailXmlId),
                                    new XElement("DetAccountNr", comboDTO.Dim1Nr),
                                    new XElement("DetDim2Nr", comboDTO.Dim2Nr),
                                    new XElement("DetDim3Nr", comboDTO.Dim3Nr),
                                    new XElement("DetDim4Nr", comboDTO.Dim4Nr),
                                    new XElement("DetDim5Nr", comboDTO.Dim5Nr),
                                    new XElement("DetDim6Nr", comboDTO.Dim6Nr),
                                    new XElement("DetAccountName", comboDTO.Dim1Name),
                                    new XElement("DetDim2Name", comboDTO.Dim2Name),
                                    new XElement("DetDim3Name", comboDTO.Dim3Name),
                                    new XElement("DetDim4Name", comboDTO.Dim4Name),
                                    new XElement("DetDim5Name", comboDTO.Dim5Name),
                                    new XElement("DetDim6Name", comboDTO.Dim6Name),
                                    new XElement("DetAccchangeAllPrevToPer", invertRow ? Decimal.Negate(detAccchangeAllPrevToPer) : detAccchangeAllPrevToPer),
                                    new XElement("DetAccchangeAllPrevToPerEntCurr", invertRow ? Decimal.Negate(detAccchangeAllPrevToPerEntCurr) : detAccchangeAllPrevToPerEntCurr),
                                    new XElement("DetAccchangeAllPrevThisYear", invertRow ? Decimal.Negate(detAccchangeAllPrevThisYear) : detAccchangeAllPrevThisYear),
                                    new XElement("DetAccchangeAllPrevThisYearEntCurr", invertRow ? Decimal.Negate(detAccchangeAllPrevThisYearEntCurr) : detAccchangeAllPrevThisYearEntCurr),
                                    new XElement("DetAccchangePer", invertRow ? Decimal.Negate(detAccchangePer) : detAccchangePer),
                                    new XElement("DetAccchangePerEntCurr", invertRow ? Decimal.Negate(detAccchangePerEntCurr) : detAccchangePerEntCurr),
                                    new XElement("DetAccchangeToPer", invertRow ? Decimal.Negate(detAccchangeToPer) : detAccchangeToPer),
                                    new XElement("DetAccchangeToPerEntCurr", invertRow ? Decimal.Negate(detAccchangeToPerEntCurr) : detAccchangeToPerEntCurr),
                                    new XElement("DetAccChangeYear", invertRow ? Decimal.Negate(detAccChangeYear) : detAccChangeYear),
                                    new XElement("DetAccChangeYearEntCurr", invertRow ? Decimal.Negate(detAccChangeYearEntCurr) : detAccChangeYearEntCurr),
                                    new XElement("DetAccChangePrevYearPer", invertRow ? Decimal.Negate(detAccChangePrevYearPer) : detAccChangePrevYearPer),
                                    new XElement("DetAccChangePrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccChangePrevYearPerEntCurr) : detAccChangePrevYearPerEntCurr),
                                    new XElement("DetAccChangeToPrevYearPer", invertRow ? Decimal.Negate(detAccChangeToPrevYearPer) : detAccChangeToPrevYearPer),
                                    new XElement("DetAccChangeToPrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccChangeToPrevYearPerEntCurr) : detAccChangeToPrevYearPerEntCurr),
                                    new XElement("DetAccChangePrevYear", invertRow ? Decimal.Negate(detAccChangePrevYear) : detAccChangePrevYear),
                                    new XElement("DetAccChangePrevYearEntCurr", invertRow ? Decimal.Negate(detAccChangePrevYearEntCurr) : detAccChangePrevYearEntCurr),
                                    new XElement("DetAccBudChangePer", invertRow ? Decimal.Negate(detAccBudChangePer) : detAccBudChangePer),
                                    new XElement("DetAccBudChangePerEntCurr", invertRow ? Decimal.Negate(detAccBudChangePerEntCurr) : detAccBudChangePerEntCurr),
                                    new XElement("DetAccBudChangeToPer", invertRow ? Decimal.Negate(detAccBudChangeToPer) : detAccBudChangeToPer),
                                    new XElement("DetAccBudChangeToPerEntCurr", invertRow ? Decimal.Negate(detAccBudChangeToPerEntCurr) : detAccBudChangeToPerEntCurr),
                                    new XElement("DetAccBudChangeYear", invertRow ? Decimal.Negate(detAccBudChangeYear) : detAccBudChangeYear),
                                    new XElement("DetAccBudChangeYearEntCurr", invertRow ? Decimal.Negate(detAccBudChangeYearEntCurr) : detAccBudChangeYearEntCurr),
                                    new XElement("DetAccGPPer", invertRow ? Decimal.Negate(detAccGPPer) : detAccGPPer),
                                    new XElement("DetAccGPPerEntCurr", invertRow ? Decimal.Negate(detAccGPPerEntCurr) : detAccGPPerEntCurr),
                                    new XElement("DetAccGPToPer", invertRow ? Decimal.Negate(detAccGPToPer) : detAccGPToPer),
                                    new XElement("DetAccGPToPerEntCurr", invertRow ? Decimal.Negate(detAccGPToPerEntCurr) : detAccGPToPerEntCurr),
                                    new XElement("DetAccGPYear", invertRow ? Decimal.Negate(detAccGPYear) : detAccGPYear),
                                    new XElement("DetAccGPYearEntCurr", invertRow ? Decimal.Negate(detAccGPYearEntCurr) : detAccGPYearEntCurr),
                                    new XElement("DetAccGPPrevYearPer", invertRow ? Decimal.Negate(detAccGPPrevYearPer) : detAccGPPrevYearPer),
                                    new XElement("DetAccGPPrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccGPPrevYearPerEntCurr) : detAccGPPrevYearPerEntCurr),
                                    new XElement("DetAccGPToPrevYearPer", invertRow ? Decimal.Negate(detAccGPToPrevYearPer) : detAccGPToPrevYearPer),
                                    new XElement("DetAccGPToPrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccGPToPrevYearPerEntCurr) : detAccGPToPrevYearPerEntCurr),
                                    new XElement("DetAccGPPrevYear", invertRow ? Decimal.Negate(detAccGPPrevYear) : detAccGPPrevYear),
                                    new XElement("DetAccGPPrevYearEntCurr", invertRow ? Decimal.Negate(detAccGPPrevYearEntCurr) : detAccGPPrevYearEntCurr),
                                    new XElement("DetAccBudgetGPPer", invertRow ? Decimal.Negate(detAccBudgetGPPer) : detAccBudgetGPPer),
                                    new XElement("DetAccBudgetGPPerEntCurr", invertRow ? Decimal.Negate(detAccBudgetGPPerEntCurr) : detAccBudgetGPPerEntCurr),
                                    new XElement("DetAccBudgetGPToPer", invertRow ? Decimal.Negate(detAccBudgetGPToPer) : detAccBudgetGPToPer),
                                    new XElement("DetAccBudgetGPToPerEntCurr", invertRow ? Decimal.Negate(detAccBudgetGPToPerEntCurr) : detAccBudgetGPToPerEntCurr),
                                    new XElement("DetAccBudgetGPYear", invertRow ? Decimal.Negate(detAccBudgetGPYear) : detAccBudgetGPYear),
                                    new XElement("DetAccBudgetGPYearEntCurr", invertRow ? Decimal.Negate(detAccBudgetGPYearEntCurr) : detAccBudgetGPYearEntCurr));

                                    accountDetailElements.Add(accountDetailElement);

                                    accountDetailXmlId++;
                                }

                                accountElement.Add(accountDetailElements);

                            }

                            #endregion

                            #endregion
                        }

                        #region XElement ReportHeader

                        #region BalanceReport, ResultReport, SRU

                        XElement headerElement = new XElement("Header",
                            new XAttribute("id", reportHeaderXmlId),
                            new XElement("HeaderName", reportHeader.Name),
                            new XElement("HeaderShowLabel", reportHeader.ShowLabel.ToInt()),
                            new XElement("HeaderShowRows", reportHeader.ShowRow.ToInt()),
                            new XElement("HeaderShowZeroRows", reportHeader.ShowZeroRow.ToInt()),
                            new XElement("HeaderShowSum", reportHeader.ShowSum.ToInt()),
                            new XElement("HeaderInvertRow", reportHeader.InvertRow.ToInt()),
                            new XElement("HeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriod) : headerSumAccountBalancechangePeriod),
                            new XElement("HeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodEntCurrency) : headerSumAccountBalancechangePeriodEntCurrency),
                            new XElement("HeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriod) : headerSumAccountGrossProfitPeriod),
                            new XElement("HeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodEntCurrency) : headerSumAccountGrossProfitPeriodEntCurrency),

                            //Previous Year
                            new XElement("PreviousYearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriod) : headerSumAccountBalancechangePreviousYearPeriod),
                            new XElement("PreviousYearHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountBalancechangePreviousYearPeriodEntCurrency),
                            new XElement("PreviousYearHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriod) : headerSumAccountGrossProfitPreviousYearPeriod),
                            new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                            //Previous Period
                            new XElement("PreviousPeriodMinus1YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus1Year) : headerSumAccountBalancechangePreviousPeriodMinus1Year),
                            new XElement("PreviousPeriodMinus2YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus2Year) : headerSumAccountBalancechangePreviousPeriodMinus2Year),
                            new XElement("PreviousPeriodMinus3YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus3Year) : headerSumAccountBalancechangePreviousPeriodMinus3Year),
                            new XElement("PreviousPeriodMinus4YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus4Year) : headerSumAccountBalancechangePreviousPeriodMinus4Year),
                            new XElement("PreviousPeriodMinus5YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus5Year) : headerSumAccountBalancechangePreviousPeriodMinus5Year),
                            //Budget
                            new XElement("BudgetHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriod) : headerSumBudgetAccountBalancechangePeriod),
                            new XElement("BudgetHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodEntCurrency) : headerSumBudgetAccountBalancechangePeriodEntCurrency));

                        if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                        {
                            #region BalanceReport, ResultReport

                            headerElement.Add(
                                new XElement("HeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriod) : headerSumAccountBalancechangeToPeriod),
                                new XElement("HeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodEntCurrency) : headerSumAccountBalancechangeToPeriodEntCurrency),
                                new XElement("HeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYear) : headerSumAccountBalancechangeYear),
                                new XElement("HeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYearEntCurrency) : headerSumAccountBalancechangeYearEntCurrency),
                                new XElement("HeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYear) : headerSumAccountGrossProfitYear),
                                new XElement("HeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearEntCurrency) : headerSumAccountGrossProfitYearEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriod) : headerSumAccountBalancechangeToPreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYear) : headerSumAccountBalancechangePreviousYear),
                                new XElement("PreviousYearHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearEntCurrency) : headerSumAccountBalancechangePreviousYearEntCurrency),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriod) : headerSumAccountGrossProfitBalancechangePreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency),

                                //Budget
                                new XElement("BudgetHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriod) : headerSumBudgetAccountBalancechangeToPeriod),
                                new XElement("BudgetHeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodEntCurrency) : headerSumBudgetAccountBalancechangeToPeriodEntCurrency),
                                new XElement("BudgetHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYear) : headerSumBudgetAccountBalancechangeYear),
                                new XElement("BudgetHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYearEntCurrency) : headerSumBudgetAccountBalancechangeYearEntCurrency),
                                new XElement("BudgetHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitPeriod) : headerSumBudgetAccountGrossProfitPeriod),
                                new XElement("BudgetHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYear) : headerSumBudgetAccountGrossProfitYear),
                                new XElement("BudgetHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYearEntCurrency) : headerSumBudgetAccountGrossProfitYearEntCurrency));

                            #endregion

                            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                            {
                                #region BalanceReport

                                headerElement.Add(
                                    new XElement("HeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalance) : headerSumAccountPeriodInBalance),
                                    new XElement("HeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceEntCurrency) : headerSumAccountPeriodInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalance) : headerSumAccountGrossProfitPeriodInBalance),
                                    new XElement("HeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountYearInBalance) : headerSumAccountYearInBalance),
                                    new XElement("HeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountYearInBalanceEntCurrency) : headerSumAccountYearInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalance) : headerSumAccountGrossProfitYearInBalance),
                                    new XElement("HeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalanceEntCurrency) : headerSumAccountGrossProfitYearInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalance) : headerSumAccountClosingBalance),
                                    //PreviousYear
                                    new XElement("PreviousYearHeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalance) : headerSumAccountPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearHeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalance) : headerSumAccountGrossProfitPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalance) : headerSumAccountPreviousYearInBalance),
                                    new XElement("PreviousYearHeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalanceEntCurrency) : headerSumAccountPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalance) : headerSumAccountGrossProfitPreviousYearInBalance),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYear) : headerSumAccountClosingBalancePreviousYear),
                                    new XElement("PreviousYearHeaderSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYearEntCurrency) : headerSumAccountClosingBalancePreviousYearEntCurrency));

                                headerElement.Add(
                                    new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                #endregion
                            }
                            else if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                            {
                                #region ResultReport

                                headerElement.Add(
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalance) : headerSumAccountBalanceChangeAllPreviousThisYearBalance),
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                    //Previous Year
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalance) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency));

                                headerElement.Add(
                                    new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                #endregion
                            }

                            #region BalanceReport, ResultReport

                            foreach (XElement element in accountElementsForHeader)
                            {
                                headerElement.Add(element);
                            }

                            #endregion
                        }
                        else
                        {
                            #region Sru

                            headerElement.Add(new XElement("Account",
                                new XAttribute("id", 1),
                                new XElement("AccountNr", String.Empty),
                                new XElement("AccountName", String.Empty),
                                new XElement("AccountInternalNr1", String.Empty),
                                new XElement("AccountInternalName1", String.Empty),
                                new XElement("AccountInternalNr2", String.Empty),
                                new XElement("AccountInternalName2", String.Empty),
                                new XElement("AccountInternalNr3", String.Empty),
                                new XElement("AccountInternalName3", String.Empty),
                                new XElement("AccountInternalNr4", String.Empty),
                                new XElement("AccountInternalName4", String.Empty),
                                new XElement("AccountInternalNr5", String.Empty),
                                new XElement("AccountInternalName5", String.Empty),
                                new XElement("AccountInternalNr6", String.Empty),
                                new XElement("AccountInternalName6", String.Empty),
                                new XElement("AccountBalancechangePeriod", Decimal.Zero)));

                            #endregion
                        }

                        #endregion

                        #endregion

                        reportHeaderElements.Add(headerElement);
                        reportHeaderXmlId++;
                    }

                    #region XElement ReportGroup

                    //BalanceReport, ResultReport, SRU
                    XElement groupElement = new XElement("Group",
                        new XAttribute("id", reportGroupXmlId),
                        new XElement("GroupName", reportGroup.Name),
                        new XElement("GroupShowLabel", reportGroup.ShowLabel.ToInt()),
                        new XElement("GroupShowSum", reportGroup.ShowSum.ToInt()),
                        new XElement("GroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriod) : groupSumAccountBalancechangePeriod),
                        new XElement("GroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodEntCurrency) : groupSumAccountBalancechangePeriodEntCurrency),
                        new XElement("GroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriod) : groupSumAccountGrossProfitPeriod),
                        new XElement("GroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodEntCurrency) : groupSumAccountGrossProfitPeriodEntCurrency),
                        //PreviousYear
                        new XElement("PreviousYearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriod) : groupSumAccountBalancechangePreviousYearPeriod),
                        new XElement("PreviousYearGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodEntCurrency) : groupSumAccountBalancechangePreviousYearPeriodEntCurrency),
                        new XElement("PreviousYearGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriod) : groupSumAccountGrossProfitPreviousYearPeriod),
                        new XElement("PreviousYearGroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                        //Previous Period
                        new XElement("PreviousPeriodMinus1YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus1Year) : groupSumAccountBalancechangePreviousPeriodYearMinus1Year),
                        new XElement("PreviousPeriodMinus2YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus2Year) : groupSumAccountBalancechangePreviousPeriodYearMinus2Year),
                        new XElement("PreviousPeriodMinus3YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus3Year) : groupSumAccountBalancechangePreviousPeriodYearMinus3Year),
                        new XElement("PreviousPeriodMinus4YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus4Year) : groupSumAccountBalancechangePreviousPeriodYearMinus4Year),
                        new XElement("PreviousPeriodMinus5YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus5Year) : groupSumAccountBalancechangePreviousPeriodYearMinus5Year),
                        //Budget
                        new XElement("BudgetGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriod) : groupSumBudgetAccountBalancechangePeriod),
                        new XElement("BudgetGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodEntCurrency) : groupSumBudgetAccountBalancechangePeriodEntCurrency));

                    //BalanceReport, ResultReport
                    if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2 || es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                    {
                        groupElement.Add(
                            new XElement("GroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriod) : groupSumAccountBalancechangeToPeriod),
                            new XElement("GroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodEntCurrency) : groupSumAccountBalancechangeToPeriodEntCurrency),
                            new XElement("GroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYear) : groupSumAccountBalancechangeYear),
                            new XElement("GroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYearEntCurrency) : groupSumAccountBalancechangeYearEntCurrency),
                            new XElement("GroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYear) : groupSumAccountGrossProfitYear),
                            new XElement("GroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearEntCurrency) : groupSumAccountGrossProfitYearEntCurrency),
                            //PreviousYear
                            new XElement("PreviousYearGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriod) : groupSumAccountBalancechangeToPreviousYearPeriod),
                            new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency),
                            new XElement("PreviousYearGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYear) : groupSumAccountBalancechangePreviousYear),
                            new XElement("PreviousYearGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearEntCurrency) : groupSumAccountBalancechangePreviousYearEntCurrency),
                            new XElement("PreviousYearGroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYear) : groupSumAccountGrossProfitPreviousYear),
                            new XElement("PreviousYearGroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearEntCurrency) : groupSumAccountGrossProfitPreviousYearEntCurrency),
                            //Budget
                            new XElement("BudgetGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriod) : groupSumBudgetAccountBalancechangeToPeriod),
                            new XElement("BudgetGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodEntCurrency),
                            new XElement("BudgetGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYear) : groupSumBudgetAccountBalancechangeYear),
                            new XElement("BudgetGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYearEntCurrency) : groupSumBudgetAccountBalancechangeYearEntCurrency),
                            new XElement("BudgetGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitPeriod) : groupSumBudgetAccountGrossProfitPeriod));


                        //BalanceReport
                        if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                        {
                            #region BalanceReport

                            groupElement.Add(
                                new XElement("GroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalance) : groupSumAccountPeriodInBalance),
                                new XElement("GroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceEntCurrency) : groupSumAccountPeriodInBalanceEntCurrency),
                                new XElement("GroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalance) : groupSumAccountGrossProfitPeriodInBalance),
                                new XElement("GroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                new XElement("GroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountYearInBalance) : groupSumAccountYearInBalance),
                                new XElement("GroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountYearInBalanceEntCurrency) : groupSumAccountYearInBalanceEntCurrency),
                                new XElement("GroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                new XElement("GroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalanceEntCurrency) : groupSumAccountGrossProfitYearInBalanceEntCurrency),
                                new XElement("GroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalance) : groupSumAccountClosingBalance),
                                new XElement("GroupSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceEntCurrency) : groupSumAccountClosingBalanceEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearGroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalance) : groupSumAccountPreviousYearPeriodInBalance),
                                new XElement("PreviousYearGroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalance) : groupSumAccountGrossProfitPreviousYearPeriodInBalance),
                                new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalance) : groupSumAccountPreviousYearInBalance),
                                new XElement("PreviousYearGroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalanceEntCurrency) : groupSumAccountPreviousYearInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalancePreviousYear) : groupSumAccountClosingBalancePreviousYear));

                            #endregion
                        }
                        else if (es.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                        {
                            #region ResultReport

                            groupElement.Add(
                                new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalance) : groupSumAccountBalanceChangeAllPreviousThisYearBalance),
                                new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalance) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency));


                            #endregion
                        }
                    }

                    //Add ReportHeaders to ReportGroup
                    foreach (XElement element in reportHeaderElements)
                    {
                        groupElement.Add(element);
                    }

                    #endregion

                    sheetElement.Add(groupElement);
                    reportGroupXmlId++;
                }

                reportElement.Add(sheetElement);
                #region
                #endregion
            }

            return result;
        }

        private ActionResult CreateBalanceResultAndSruReportCommonDataV2(CreateReportResult reportResult, XElement reportElement)
        {
            ActionResult result = new ActionResult(true);

            #region Prereq

            //AccountDim internal
            List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(reportResult.ActorCompanyId).ToDTOs();
            AccountDim accountDimStdList = AccountManager.GetAccountDimStd(reportResult.ActorCompanyId);

            this.Company = CompanyManager.GetCompany(reportResult.ActorCompanyId);
            var am = new AccountManager(parameterObject);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reportParams = new EconomyReportParamsDTO(this.parameterObject, am, reportResult, entitiesReadOnly, this);
            Report report = ReportManager.GetReport(reportResult.ReportId, reportResult.ActorCompanyId, loadSysReportTemplateType: true);

            List<AccountFilterSelectionDTO> accountFilters;
            TryGetAccountFilters(reportResult, out accountFilters, "namedFilterRanges");
            var accountIntervals = accountFilters.Select(x => new AccountIntervalDTO() { AccountDimId = x.Id, AccountNrFrom = x.From, AccountNrTo = x.To }).ToList();
            if (accountIntervals.Count == 1)
            {
                var account = accountIntervals.First();
                if (account.AccountNrFrom.IsNullOrEmpty() && account.AccountNrTo.IsNullOrEmpty())
                {
                    accountIntervals.Clear();
                }
            }

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = this.CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(this.CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(new XElement("AccountYearDiffLabel", this.GetReportText(35, "Jämförelseår:")));
            //reportHeaderLabelsElement.Add(new XElement("EntCurrencyNameLabel", this.GetReportText(299, "Valutanamn")));
            //reportHeaderLabelsElement.Add(new XElement("EntCurrencyCodeLabel", this.GetReportText(300, "Valutakod")));
            this.CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            reportHeaderLabelsElement.Add(new XElement("SumLabel", this.GetReportText(34, "Summa")));

            reportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = this.CreateAccountingReportHeaderElement(reportResult, reportParams);
            reportHeaderElement.Add(this.CreateAccountIntervalElement(am, reportResult, accountIntervals, accountDimInternals));


            reportHeaderElement.Add(new XElement("AccountYearDiff"), String.Empty); //TODO
            reportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    pageHeaderLabelsElement.Add(
                        new XElement("DimensionInternalName" + i + "Label", String.Empty),
                        new XElement("DimensionInternalShortName" + i + "Label", String.Empty));
                    continue;
                }

                var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;

                pageHeaderLabelsElement.Add(
                    new XElement("DimensionInternalName" + i + "Label", accountDim != null ? accountDim.AccountDimNr.ToString() : String.Empty),
                    new XElement("DimensionInternalShortName" + i + "Label", accountDim != null ? accountDim.Name : String.Empty));
            }

            AddAccountBalanceChangePeriodPageHeaderLabelElements(pageHeaderLabelsElement);

            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
            {
                #region BalanceReport, ResultReport

                AddAccountBalanceChangePageHeaderLabelElements(pageHeaderLabelsElement);

                #endregion

                if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                {
                    #region BalanceReport

                    AddAccountBalancePageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
                else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                {
                    #region ResultReport

                    this.AddAccountBalanceChangePreviousPageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
            }

            reportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Init

                AccountBalanceManager abm = AccountBalanceManager(reportResult.ActorCompanyId);
                abm.InitBalanceChangeVoucherHeadCache();

                List<AccountDTO> accountStdsInInterval = new List<AccountDTO>();
                List<AccountInternalDTO> accountInternalsInInterval = new List<AccountInternalDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalanceDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousThisYearDict = new Dictionary<int, BalanceItemDTO>();

                // Previous Year
                Dictionary<int, BalanceItemDTO> biBalancechangePreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalancePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, BalanceItemDTO>();

                //PreviousPeriods
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus1YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus2YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus3YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus4YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus5YearDict = new Dictionary<int, BalanceItemDTO>();

                // Budget TODO BudgetBalanceItemDTO
                Dictionary<int, BalanceItemDTO> biBudgetBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();

                //Gross profit
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousThisYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit and Budget
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit Previous Year
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalancePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //historical Data
                List<VoucherHeadDTO> voucherHeadsAllPreviousThisYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousPreviousYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPreviousYearPeriod = new List<VoucherHeadDTO>();

                //VoucherHeads
                List<VoucherHeadDTO> voucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads Budget
                List<VoucherHeadDTO> budgetVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads PreviuousPeriods
                List<VoucherHeadDTO> previousPeriodMinus1YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus2YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus3YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus4YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus5YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();

                //VoucherHeads PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfitBudget
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                #endregion

                #region Prereq

                AccountYearDTO accountYear = AccountManager.GetAccountYear(entities, reportParams.DateFrom, reportResult.ActorCompanyId).ToDTO();
                if (accountYear == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountYear");

                AccountDimDTO accountDimStd = AccountManager.GetAccountDimStd(entities, reportResult.ActorCompanyId).ToDTO();
                if (accountDimStd == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountDim");

                List<AccountDimDTO> internalaccountDims = AccountManager.GetAccountDimsByCompany(reportResult.ActorCompanyId, false, true, true).OrderBy(a => a.AccountDimNr).ToDTOs();
                List<AccountDTO> allAccountDTOStds = AccountManager.GetAccountStdsByCompany(reportResult.ActorCompanyId, null).ToDTOs().ToList();

                List<ReportGroupDTO> reportGroups = ReportManager.GetReportGroupsForReport(reportResult.ActorCompanyId, report);

                //All intervals with a SelectValue is grabbed. The select value refers to a Gross Profit Code.
                List<IReportHeaderInterval> grossProfitReportHeaderIntervals = reportGroups
                    .SelectMany(group => group.ReportHeaders)
                    .SelectMany(header => header.ReportHeaderIntervals)
                    .Where(interval => interval.SelectValue.HasValue)
                    .Cast<IReportHeaderInterval>()
                    .ToList();

                //Get detailed Information - Information is only needed in some reports
                bool detailedInformation = reportResult.GetDetailedInformation;

                DateTime firstMonth = CalendarUtility.GetFirstDateOfMonth(reportParams.DateFrom);
                DateTime prevYearDateFrom = reportParams.DateFrom.AddYears(-reportParams.NoOfYearsBackinPreviousYear);
                DateTime prevYearDateTo = reportParams.DateTo.AddYears(-reportParams.NoOfYearsBackinPreviousYear);
                prevYearDateTo = CalendarUtility.GetLastDateOfMonth(prevYearDateTo);
                DateTime prevYearUntilDateFrom = reportParams.UntilDateFrom().AddYears(-reportParams.NoOfYearsBackinPreviousYear);
                prevYearUntilDateFrom = CalendarUtility.GetLastDateOfMonth(prevYearUntilDateFrom);
                //Previous year
                AccountYearDTO previousAccountYear = reportParams.NoOfYearsBackinPreviousYear != 0 ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-reportParams.NoOfYearsBackinPreviousYear), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 1
                DateTime prevPeriodMinus1YearDateFrom = reportParams.DateFrom.AddYears(-1);
                DateTime prevPeriodMinus1YearDateTo = reportParams.DateTo.AddYears(-1);
                prevPeriodMinus1YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus1YearDateTo);
                AccountYearDTO previousPeriodMinus1AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-1), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 2
                DateTime prevPeriodMinus2YearDateFrom = reportParams.DateFrom.AddYears(-2);
                DateTime prevPeriodMinus2YearDateTo = reportParams.DateTo.AddYears(-2);
                prevPeriodMinus2YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus2YearDateTo);
                AccountYearDTO previousPeriodMinus2AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-2), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 3
                DateTime prevPeriodMinus3YearDateFrom = reportParams.DateFrom.AddYears(-3);
                DateTime prevPeriodMinus3YearDateTo = reportParams.DateTo.AddYears(-3);
                prevPeriodMinus3YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus3YearDateTo);
                AccountYearDTO previousPeriodMinus3AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-3), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 4
                DateTime prevPeriodMinus4YearDateFrom = reportParams.DateFrom.AddYears(-4);
                DateTime prevPeriodMinus4YearDateTo = reportParams.DateTo.AddYears(-4);
                prevPeriodMinus4YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus4YearDateTo);
                AccountYearDTO previousPeriodMinus4AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-4), reportResult.ActorCompanyId).ToDTO() : null;

                // Year minus 5
                DateTime prevPeriodMinus5YearDateFrom = reportParams.DateFrom.AddYears(-5);
                DateTime prevPeriodMinus5YearDateTo = reportParams.DateTo.AddYears(-5);
                prevPeriodMinus5YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus5YearDateTo);
                AccountYearDTO previousPeriodMinus5AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, reportParams.DateFrom.AddYears(-5), reportResult.ActorCompanyId).ToDTO() : null;

                // Budget
                int budgetHeadId = 0;
                bool getBudget = true;
                if (reportParams.SSTD_BudgetId.HasValue && reportParams.IncludeBudget)
                    budgetHeadId = reportParams.SSTD_BudgetId.Value;
                if (budgetHeadId == 0)
                    getBudget = false;

                List<GrossProfitCode> grossProfCodes = GrossProfitManager.GetGrossProfitCodes(reportResult.ActorCompanyId);

                List<GrossProfitCodeDTO> grossProfitCodes = new List<GrossProfitCodeDTO>();

                foreach (var code in grossProfCodes)
                    grossProfitCodes.Add(code.ToDTO());

                bool hasGrossProfitCodes = !grossProfitCodes.IsNullOrEmpty() && !grossProfitReportHeaderIntervals.IsNullOrEmpty();

                //Cache

                if (reportParams.IncludeAllHistoricalData)
                    abm.FillVoucherHeadDTOCache(CalendarUtility.DATETIME_DEFAULT, accountYear.To, reportResult.ActorCompanyId);
                else if (previousAccountYear != null)
                    abm.FillVoucherHeadDTOCache(previousAccountYear.From, accountYear.To, reportResult.ActorCompanyId);
                else
                    abm.FillVoucherHeadDTOCache(accountYear.From, accountYear.To, reportResult.ActorCompanyId);

                bool isAccountSelectionValid = AccountManager.GetAccountsInInterval(entities, reportResult, reportParams, accountDimStd, false, ref accountStdsInInterval, ref accountInternalsInInterval);
                if (isAccountSelectionValid)
                {
                    // Translate Account Names
                    if (accountStdsInInterval != null)
                    {
                        accountStdsInInterval = AccountManager.TranslateAccountNamesByLang(accountStdsInInterval); // 2015-04-27 / Jukka - Translate account names for the names for which current translation exists
                    }
                    // Hela året
                    biBalanceChangeYearDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalanceChangeYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                    // Hela Förra året
                    if (previousAccountYear != null)
                        biBalanceChangePreviousYearDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeYear, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);

                    //Omsättning  inom period (hela urvalet)
                    biBalancechangePeriodDict = abm.GetBalanceChangeFromDTO(accountYear, reportParams.DateFrom, reportParams.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);

                    //Omsättning inom perioden förra året (hela urvalet)
                    if (previousAccountYear != null)
                        biBalancechangePreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);

                    //Omsättning per period i fem tidigare år
                    if (previousAccountYear != null)
                    {
                        if (previousPeriodMinus1AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus1YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus1AccountYear, prevPeriodMinus1YearDateFrom, prevPeriodMinus1YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus1YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus2AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus2YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus2AccountYear, prevPeriodMinus2YearDateFrom, prevPeriodMinus2YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus2YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus3AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus3YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus3AccountYear, prevPeriodMinus3YearDateFrom, prevPeriodMinus3YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus3YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus4AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus4YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus4AccountYear, prevPeriodMinus4YearDateFrom, prevPeriodMinus4YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus4YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                        if (previousPeriodMinus5AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus5YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus5AccountYear, prevPeriodMinus5YearDateFrom, prevPeriodMinus5YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousPeriodMinus5YearVoucherHeadsBalancechangePeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                    }

                    //Budget inom perioden
                    if (getBudget)
                    {
                        biBudgetBalancechangePeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, reportParams.DateFrom, reportParams.DateTo, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, false, out budgetVoucherHeadsBalancechangePeriod);
                        if (hasGrossProfitCodes)
                            biGrossProfitBalanceChangePeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, reportParams.DateFrom, reportParams.DateTo, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalancechangePeriod, out voucherHeadsGrossProfitBudgetBalanceChangePeriod);
                    }

                    if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2 || reportResult.ReportTemplateType == SoeReportTemplateType.SruReport)
                    {
                        #region BalanceReport and ResultReport

                        #region Load data in order largest range first (to be able to use cache and re-use data)

                        // Budget
                        if (getBudget)
                        {
                            biBudgetBalanceChangeYearDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, false, out budgetVoucherHeadsBalanceChangeYear);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeYearBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalanceChangeYear, out voucherHeadsGrossProfitBudgetBalanceChangeYear);
                        }

                        //Från år start till period start (Edit 090319: Parameter dateTo, es.SSTD_DateFrom --> SSTD_DateTo) (Edit 090423: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom)(Edit 100322: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom.AddDays(-1))
                        biBalanceChangeToPeriodDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsBalanceChangeToPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                        // Budget
                        if (getBudget)
                        {
                            biBudgetBalanceChangeToPeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, reportParams.UntilDateFrom(), accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId, false, out budgetVoucherHeadsBalanceChangeToPeriod);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeToPeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, reportParams.UntilDateFrom(), accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, reportResult.ActorCompanyId, budgetVoucherHeadsBalanceChangeToPeriod, out voucherHeadsGrossProfitBudgetBalanceChangeToPeriod);
                        }

                        // Förra året
                        if (previousAccountYear != null)
                            biBalanceChangeToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeToPeriod, false, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);

                        #endregion

                        //GrossProfitCode
                        if (hasGrossProfitCodes)
                        {
                            Parallel.Invoke(GetDefaultParallelOptions(), () =>
                            {
                                biGrossProfitBalanceChangePeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, reportParams.DateFrom, reportParams.DateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);
                            },

                            () =>
                            {
                                biGrossProfitBalanceChangeToPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, reportParams.DateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);
                            },

                            () =>
                            {
                                biGrossProfitBalanceChangeYearDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, allAccountDTOStds, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeYear, detailedInformation);
                            }
                            ); //close parallel.invoke           

                            //Förra året
                            if (previousAccountYear != null)
                            {

                                Parallel.Invoke(GetDefaultParallelOptions(), () =>
                                {
                                    biGrossProfitBalanceChangePreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);
                                },

                                () =>
                                {
                                    biGrossProfitBalanceChangeToPreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);
                                },

                                () =>
                                {
                                    biGrossProfitBalanceChangePreviousYearDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, reportResult.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeYear, detailedInformation);
                                }
                                ); //close parallel.invoke
                            }
                        }

                        #endregion

                        if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                        {
                            #region BalanceReport

                            //Ingående balans för aktuellt år
                            biYearInBalanceDict = abm.GetYearInBalanceFromDTO(entities, accountYear, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId);
                            //Ingående balans för förra året
                            if (previousAccountYear != null)
                                biYearInBalancePreviousYearDict = abm.GetYearInBalanceFromDTO(entities, previousAccountYear, accountStdsInInterval, accountInternalsInInterval, reportResult.ActorCompanyId);

                            #endregion
                        }
                        else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                        {
                            #region ResultReport

                            if (reportParams.IncludeAllHistoricalData)
                            {
                                //All data fram till dagen innan urval start
                                biAccountBalanceChangeAllPreviousToPeriodDict = abm.GetBalanceChangeFromDTO(null, reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousToPeriod, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                                //All data fram till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(null, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousToPreviousYearPeriod, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);

                                //All data från 1 jan till dagen innan urval start
                                biAccountBalanceChangeAllPreviousThisYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(reportParams.DateFrom), reportParams.UntilDateFrom(), accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousThisYear, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);
                                //All data från 1 jan förra året till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousPreviousYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(prevYearDateFrom), prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, reportResult.ActorCompanyId, out voucherHeadsAllPreviousPreviousYear, reportParams.SSTD_IncludeYearEndVouchers, reportParams.SSTD_IncludeExternalVouchers);

                            }

                            #endregion
                        }
                    }
                }

                #endregion

                #region Check which accounts that got balance

                List<int> AccountIdsWithBalance = new List<int>();

                foreach (AccountDTO accountStd in accountStdsInInterval)
                {
                    if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biYearInBalanceDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biYearInBalanceDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalanceChangePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biYearInBalancePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId); continue;
                        }
                    }

                    if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBudgetBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBudgetBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBudgetBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId))
                    {
                        if (biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId].Balance != 0)
                        {
                            AccountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }
                }

                #endregion

                #region Content

                #region Sheet

                int sheetId = 1;
                XElement sheetElement = new XElement("Sheet",
                    new XAttribute("id", sheetId),
                    new XElement("DimensionNr", String.Empty),
                    new XElement("DimensionName", String.Empty),
                    new XElement("InternalNr", String.Empty),
                    new XElement("InternalName", String.Empty));

                #endregion

                int reportGroupXmlId = 1;
                foreach (var reportGroup in reportGroups)
                {
                    #region ReportGroup

                    #region Init

                    bool invertRow = reportGroup.InvertRow;

                    //BalanceReport, ResultReport, SRU,
                    decimal groupSumAccountBalancechangePeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriod = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                    //previousYear
                    decimal groupSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                    //PreviousYearPeriodOnly to be able to look at the year for multiple periods
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus1Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus2Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus3Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus4Year = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousPeriodYearMinus5Year = Decimal.Zero;

                    //Budget
                    decimal groupSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                    decimal groupSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                    //BalanceReport, ResultReport
                    decimal groupSumAccountBalancechangeToPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency = Decimal.Zero;

                    //previousYear
                    decimal groupSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod = Decimal.Zero;
                    decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;


                    //Budget
                    decimal groupSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                    decimal groupSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalancechangeYear = Decimal.Zero;
                    decimal groupSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYear = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYearEntCurrency = Decimal.Zero;

                    //PreviousYear
                    decimal groupSumAccountBalancechangePreviousYear = Decimal.Zero;
                    decimal groupSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYear = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearEntCurrency = Decimal.Zero;


                    //Budget
                    decimal groupSumBudgetAccountBalancechangeYear = Decimal.Zero;
                    decimal groupSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;

                    //BalanceReport
                    decimal groupSumAccountPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountYearInBalance = Decimal.Zero;
                    decimal groupSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYearInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountClosingBalance = Decimal.Zero;
                    decimal groupSumAccountClosingBalanceEntCurrency = Decimal.Zero;


                    //PreviousYear
                    decimal groupSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountPreviousYearInBalance = Decimal.Zero;
                    decimal groupSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                    decimal groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountClosingBalancePreviousYear = Decimal.Zero;
                    decimal groupSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;


                    //ResultReport
                    decimal groupSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                    //PreviousYear
                    decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                    decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;

                    //Grossprofit and Budget
                    decimal groupSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                    decimal groupSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                    decimal groupSumBudgetAccountGrossProfitYear = Decimal.Zero;
                    decimal groupSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                    List<XElement> reportHeaderElements = new List<XElement>();

                    #endregion


                    #region AccountStds

                    DateTime startAccount = DateTime.UtcNow;


                    //AccountStds for ReportGroup
                    var reportHeaderIntervalsForReportGroup = reportGroup.ReportHeaders
                        .SelectMany(r => r.ReportHeaderIntervals)
                        .ToList();
                    List<AccountDTO> accountStdsForReportGroup = new List<AccountDTO>();
                    foreach (AccountDTO accountStd in accountStdsInInterval)
                    {
                        foreach (var interval in reportHeaderIntervalsForReportGroup)
                        {
                            if (Validator.IsAccountInInterval(accountStd.AccountNr, interval.IntervalFrom, interval.IntervalTo))
                            {
                                accountStdsForReportGroup.Add(accountStd);
                                break;
                            }
                        }
                    }

                    #endregion

                    #endregion

                    int reportHeaderXmlId = 1;
                    foreach (var reportHeader in reportGroup.ReportHeaders)
                    {
                        #region ReportHeader

                        #region Init

                        //BalanceReport, ResultReport, SRU
                        decimal headerSumAccountBalancechangePeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal headerSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                        //PreviousPeriod
                        decimal headerSumAccountBalancechangePreviousPeriodMinus1Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus2Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus3Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus4Year = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousPeriodMinus5Year = Decimal.Zero;

                        //Budget
                        decimal headerSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                        //BalanceReport, ResultReport
                        decimal headerSumAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalancechangeYear = Decimal.Zero;
                        decimal headerSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYear = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYearEntCurrency = Decimal.Zero;


                        //PreviousYear
                        decimal headerSumAccountBalancechangePreviousYear = Decimal.Zero;
                        decimal headerSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod = Decimal.Zero;
                        decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;


                        //Budget
                        decimal headerSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangeYear = Decimal.Zero;
                        decimal headerSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;


                        //BalanceReport
                        decimal headerSumAccountPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountYearInBalance = Decimal.Zero;
                        decimal headerSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYearInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountClosingBalance = Decimal.Zero;
                        decimal headerSumAccountClosingBalanceEntCurrency = Decimal.Zero;


                        //PreviousYear
                        decimal headerSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountPreviousYearInBalance = Decimal.Zero;
                        decimal headerSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                        decimal headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountClosingBalancePreviousYear = Decimal.Zero;
                        decimal headerSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;


                        //ResultReport
                        decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                        decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;

                        //GrossProfit and Budget
                        decimal headerSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitYear = Decimal.Zero;
                        decimal headerSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                        List<XElement> accountElementsForHeader = new List<XElement>();

                        #endregion

                        #region AccountStd

                        //AccountStds for ReportHeader
                        List<AccountDTO> accountStdsForReportHeader = new List<AccountDTO>();
                        foreach (AccountDTO accountStd in accountStdsForReportGroup)
                        {
                            foreach (var interval in reportHeader.ReportHeaderIntervals)
                            {

                                if (StringUtility.IsInInterval(accountStd.AccountNr, interval.IntervalFrom, interval.IntervalTo))
                                {
                                    if (accountStd.GrossProfitCode == null)
                                        accountStd.GrossProfitCode = new List<int?>();

                                    accountStd.GrossProfitCode.Add(interval.SelectValue);

                                    if (reportHeader.ShowZeroRow || AccountIdsWithBalance.Contains(accountStd.AccountId))
                                        accountStdsForReportHeader.Add(accountStd);
                                    break;
                                }
                            }
                        }

                        #endregion

                        #endregion

                        int accountXmlId = 1;
                        foreach (AccountDTO accountStd in accountStdsForReportHeader)
                        {
                            XElement accountElement = null;

                            #region AccountCombination

                            List<AccountAndInternalAccountComboDTO> accountAndInternalAccountComboDTOs = new List<AccountAndInternalAccountComboDTO>();

                            if (reportResult.GetDetailedInformation)
                            {
                                //VoucherHeads
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads Budget
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, budgetVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, budgetVoucherHeadsBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, budgetVoucherHeadsBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads PreviuousPeriods
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus1YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus2YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus3YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus4YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousPeriodMinus5YearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads PreviousYear
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsBalancechangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads GrossProfit
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBalanceChangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads GrossProfitBudget
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBudgetBalanceChangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBudgetBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsGrossProfitBudgetBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //VoucherHeads GrossProfit PreviousYear
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsGrossProfitBalanceChangePeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, previousYearVoucherHeadsGrossProfitBalanceChangeYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                                //Historical Data
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsAllPreviousToPeriod, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);
                                accountAndInternalAccountComboDTOs = CreateAccountAndInternalAccountComboDTO(accountStd.AccountId, voucherHeadsAllPreviousThisYear, accountAndInternalAccountComboDTOs, accountDimInternals, accountInternalsInInterval);

                            }

                            #region Init BalanceReport, ResultReport, SRU

                            bool onlyGrossCodesInInterval = false;
                            if (accountStd.GrossProfitCode != null && hasGrossProfitCodes)
                            {
                                bool grossInInterval = false;
                                bool netInInterval = false;

                                foreach (var reportHeaderInterval in reportHeader.ReportHeaderIntervals)
                                {
                                    if (StringUtility.IsInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                                    {
                                        if (!reportHeaderInterval.SelectValue.HasValue)
                                            netInInterval = true;

                                        if (reportHeaderInterval.SelectValue.HasValue)
                                            grossInInterval = true;
                                    }
                                }

                                if (grossInInterval)
                                    onlyGrossCodesInInterval = true;

                                if (netInInterval)
                                    onlyGrossCodesInInterval = false;

                            }

                            BalanceItemDTO biBalancechangePeriod = new BalanceItemDTO();

                            //Previus Year
                            BalanceItemDTO biBalancechangePreviousYearPeriod = new BalanceItemDTO();

                            //Previous Periods
                            BalanceItemDTO biBalancechangePreviousPeriodMinus1YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus2YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus3YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus4YearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousPeriodMinus5YearPeriod = new BalanceItemDTO();

                            //Budget
                            BalanceItemDTO biBudgetBalancechangePeriod = new BalanceItemDTO();

                            #endregion

                            #region Init BalanceReport, ResultReport

                            BalanceItemDTO biBalancechangeToPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeYear = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousYearPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangePreviousYear = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus1Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus2Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus3Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus4Year = new BalanceItemDTO();
                            BalanceItemDTO biBalancechangeToPreviousPeriodMinus5Year = new BalanceItemDTO();
                            BalanceItemDTO biBudgetBalancechangeToPeriod = new BalanceItemDTO();
                            BalanceItemDTO biBudgetBalancechangeYear = new BalanceItemDTO();

                            //decimal accountBalancechangeToPeriodEnd = Decimal.Zero;
                            decimal accountGrossProfitPeriod = Decimal.Zero;
                            decimal accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitToPeriod = Decimal.Zero;
                            decimal accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitYear = Decimal.Zero;
                            decimal accountGrossProfitYearEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitPeriodInBalance = Decimal.Zero;
                            decimal accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                            decimal accountGrossProfitYearOpeningBalance = Decimal.Zero;
                            decimal accountGrossProfitYearEntCurrencyOpeningBalance = Decimal.Zero;

                            //PreviousYear
                            decimal accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                            decimal accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitPreviousYear = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearOpeningBalance = Decimal.Zero;
                            decimal accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Decimal.Zero;


                            //Budget and GrossProfit
                            decimal accountBudgetGrossProfitPeriod = Decimal.Zero;
                            decimal accountBudgetGrossProfitPeriodEntCurrency = Decimal.Zero;
                            decimal accountBudgetGrossProfitToPeriod = Decimal.Zero;
                            decimal accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                            decimal accountBudgetGrossProfitYear = Decimal.Zero;
                            decimal accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;

                            //Voucher Period Summery
                            decimal accountQuantity = Decimal.Zero;
                            decimal accountPeriod1 = Decimal.Zero;
                            decimal accountPeriod2 = Decimal.Zero;
                            decimal accountPeriod3 = Decimal.Zero;
                            decimal accountPeriod4 = Decimal.Zero;
                            decimal accountPeriod5 = Decimal.Zero;
                            decimal accountPeriod6 = Decimal.Zero;
                            decimal accountPeriod7 = Decimal.Zero;
                            decimal accountPeriod8 = Decimal.Zero;
                            decimal accountPeriod9 = Decimal.Zero;
                            decimal accountPeriod10 = Decimal.Zero;
                            decimal accountPeriod11 = Decimal.Zero;
                            decimal accountPeriod12 = Decimal.Zero;

                            //PreviousYear Voucher Period Summery
                            decimal previousYearAccountPeriod1 = Decimal.Zero;
                            decimal previousYearAccountPeriod2 = Decimal.Zero;
                            decimal previousYearAccountPeriod3 = Decimal.Zero;
                            decimal previousYearAccountPeriod4 = Decimal.Zero;
                            decimal previousYearAccountPeriod5 = Decimal.Zero;
                            decimal previousYearAccountPeriod6 = Decimal.Zero;
                            decimal previousYearAccountPeriod7 = Decimal.Zero;
                            decimal previousYearAccountPeriod8 = Decimal.Zero;
                            decimal previousYearAccountPeriod9 = Decimal.Zero;
                            decimal previousYearAccountPeriod10 = Decimal.Zero;
                            decimal previousYearAccountPeriod11 = Decimal.Zero;
                            decimal previousYearAccountPeriod12 = Decimal.Zero;

                            //Previous Period
                            decimal previousPeriodMinus1YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus2YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus3YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus4YearAccountPeriod = Decimal.Zero;
                            decimal previousPeriodMinus5YearAccountPeriod = Decimal.Zero;

                            //Budget Voucher Period Summery
                            decimal budgetAccountPeriod1 = Decimal.Zero;
                            decimal budgetAccountPeriod2 = Decimal.Zero;
                            decimal budgetAccountPeriod3 = Decimal.Zero;
                            decimal budgetAccountPeriod4 = Decimal.Zero;
                            decimal budgetAccountPeriod5 = Decimal.Zero;
                            decimal budgetAccountPeriod6 = Decimal.Zero;
                            decimal budgetAccountPeriod7 = Decimal.Zero;
                            decimal budgetAccountPeriod8 = Decimal.Zero;
                            decimal budgetAccountPeriod9 = Decimal.Zero;
                            decimal budgetAccountPeriod10 = Decimal.Zero;
                            decimal budgetAccountPeriod11 = Decimal.Zero;
                            decimal budgetAccountPeriod12 = Decimal.Zero;

                            //Previous Year Voucher Year Summery
                            decimal accountYear0 = Decimal.Zero;
                            decimal accountYearMinus1 = Decimal.Zero;
                            decimal accountYearMinus2 = Decimal.Zero;
                            decimal accountYearMinus3 = Decimal.Zero;
                            decimal accountYearMinus4 = Decimal.Zero;

                            XElement voucherSummeryElement = null;
                            int voucherSummeryXmlId = 0;

                            //Voucher details
                            List<XElement> voucherRowElements = new List<XElement>();

                            #endregion

                            #region Calculate BalanceChangePeriod

                            if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePeriod = biBalancechangePeriodDict[accountStd.AccountId];

                                if (voucherHeadsBalancechangePeriod.Any())
                                {
                                    //VoucherHeads
                                    List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                    voucherHeadsForAccount = voucherHeadsBalancechangePeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)) ? voucherHeadsBalancechangePeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId)).ToList() : new List<VoucherHeadDTO>();
                                    foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                    {
                                        decimal accountVoucherRowAmount = 0;
                                        DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                        List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                        foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                        {
                                            #region Accumulate amounts

                                            if (voucherRow.Quantity.HasValue)
                                                accountQuantity += voucherRow.Quantity.Value;

                                            if (voucherHead.Date.Year == reportParams.DateTo.Year)
                                                accountYear0 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-1).Year)
                                                accountYearMinus1 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-2).Year)
                                                accountYearMinus2 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-3).Year)
                                                accountYearMinus3 += voucherRow.Amount;
                                            if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-4).Year)
                                                accountYearMinus4 += voucherRow.Amount;
                                            if (firstMonth == voucherHeadMonth)
                                                accountPeriod1 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                accountPeriod2 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                accountPeriod3 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                accountPeriod4 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                accountPeriod5 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                accountPeriod6 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                accountPeriod7 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                accountPeriod8 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                accountPeriod9 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                accountPeriod10 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                accountPeriod11 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                accountPeriod12 += voucherRow.Amount;

                                            accountVoucherRowAmount += voucherRow.Amount;

                                            #endregion
                                        }
                                    }
                                }

                                //Accumulate
                                headerSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                headerSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                    groupSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                }
                            }

                            #endregion

                            #region Calculate GrossProfitChangePeriod

                            if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                            {
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                {
                                    accountGrossProfitPeriod = Decimal.Zero;
                                    accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                                    List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                    foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                    {
                                        GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                        if (accountDto != null)
                                        {
                                            List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                            accountGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                            accountGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                        }
                                    }

                                    if (voucherHeadsGrossProfitBalanceChangePeriod.Any())
                                    {
                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (voucherRow.Quantity.HasValue)
                                                    accountQuantity += voucherRow.Quantity.Value;

                                                if (voucherHead.Date.Year == reportParams.DateTo.Year)
                                                    accountYear0 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-1).Year)
                                                    accountYearMinus1 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-2).Year)
                                                    accountYearMinus2 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-3).Year)
                                                    accountYearMinus3 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == reportParams.DateTo.AddYears(-4).Year)
                                                    accountYearMinus4 += voucherRow.Amount;
                                                if (firstMonth == voucherHeadMonth)
                                                    accountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    accountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    accountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    accountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    accountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    accountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    accountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    accountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    accountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    accountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    accountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    accountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                        }
                                    }
                                }

                                //Accumulate
                                headerSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                headerSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                    groupSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                }
                            }

                            #endregion

                            #region Calculate GrossProfitChangePeriodBudget

                            if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                            {
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                {
                                    accountBudgetGrossProfitPeriod = Decimal.Zero;
                                    accountBudgetGrossProfitPeriodEntCurrency = Decimal.Zero;
                                    List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                    foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                    {
                                        GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                        if (accountDto != null)
                                        {
                                            List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                            accountBudgetGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                            accountBudgetGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                        }
                                    }

                                    if (voucherHeadsGrossProfitBudgetBalanceChangePeriod.Any() && detailedInformation)
                                    {
                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                        }
                                    }
                                }

                                //Accumulate
                                headerSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                headerSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                    groupSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                }
                            }



                            #endregion

                            #region Calculate BalanceChangePreviousYearPeriod

                            if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousYearPeriod = biBalancechangePreviousYearPeriodDict[accountStd.AccountId];

                                if (previousYearVoucherHeadsBalancechangePeriod.Any() && detailedInformation)
                                {
                                    //VoucherHeads
                                    List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                    voucherHeadsForAccount = previousYearVoucherHeadsBalancechangePeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)) ? previousYearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId)).ToList() : new List<VoucherHeadDTO>();
                                    foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                    {
                                        decimal accountVoucherRowAmount = 0;
                                        DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                        List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                        foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                        {
                                            #region Accumulate amounts

                                            if (firstMonth == voucherHeadMonth)
                                                previousYearAccountPeriod1 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                previousYearAccountPeriod2 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                previousYearAccountPeriod3 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                previousYearAccountPeriod4 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                previousYearAccountPeriod5 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                previousYearAccountPeriod6 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                previousYearAccountPeriod7 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                previousYearAccountPeriod8 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                previousYearAccountPeriod9 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                previousYearAccountPeriod10 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                previousYearAccountPeriod11 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                previousYearAccountPeriod12 += voucherRow.Amount;

                                            accountVoucherRowAmount += voucherRow.Amount;

                                            #endregion
                                        }

                                    }
                                }

                                //Accumulate
                                headerSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                headerSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                    groupSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                }
                            }
                            #endregion

                            #region Calculate GrossProfitChangePeriod Previous Year

                            if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                            {
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                {
                                    accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                                    accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                                    List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                    foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                    {
                                        GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                        if (accountDto != null)
                                        {
                                            List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= prevYearDateFrom && b.PeriodTo <= prevYearDateTo).ToList();
                                            accountGrossProfitPreviousYearPeriod += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                            accountGrossProfitPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                        }
                                    }


                                    if (previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Any() && detailedInformation)
                                    {
                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (firstMonth == voucherHeadMonth)
                                                    previousYearAccountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    previousYearAccountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    previousYearAccountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    previousYearAccountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    previousYearAccountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    previousYearAccountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    previousYearAccountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    previousYearAccountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    previousYearAccountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    previousYearAccountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    previousYearAccountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    previousYearAccountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                        }
                                    }
                                }

                                //Accumulate
                                headerSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                headerSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                    groupSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                }
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus1Year

                            if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus1YearPeriod = biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus2Year

                            if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus2YearPeriod = biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus3Year

                            if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus3YearPeriod = biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus4Year

                            if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus4YearPeriod = biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;

                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceChangePreviousPeriodMinus5Year

                            if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBalancechangePreviousPeriodMinus5YearPeriod = biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId];

                                //Accumulate
                                headerSumAccountBalancechangePreviousPeriodMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                    groupSumAccountBalancechangePreviousPeriodYearMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;
                                //TODO maybe.. Grossprofit
                            }

                            #endregion

                            #region Calculate BalanceBudgetChangePeriod

                            if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                            {
                                biBudgetBalancechangePeriod = biBudgetBalancechangePeriodDict[accountStd.AccountId];

                                //VoucherHeads
                                if (budgetVoucherHeadsBalancechangePeriod.Any() && detailedInformation)
                                {
                                    //BudgetAccountId is only used for performance
                                    List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                    voucherHeadsForAccount = budgetVoucherHeadsBalancechangePeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId) ? budgetVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList() : new List<VoucherHeadDTO>();
                                    foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                    {
                                        decimal accountVoucherRowAmount = 0;
                                        DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                        List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                        foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                        {
                                            #region Accumulate amounts

                                            if (firstMonth == voucherHeadMonth)
                                                budgetAccountPeriod1 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                budgetAccountPeriod2 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                budgetAccountPeriod3 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                budgetAccountPeriod4 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                budgetAccountPeriod5 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                budgetAccountPeriod6 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                budgetAccountPeriod7 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                budgetAccountPeriod8 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                budgetAccountPeriod9 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                budgetAccountPeriod10 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                budgetAccountPeriod11 += voucherRow.Amount;
                                            if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                budgetAccountPeriod12 += voucherRow.Amount;

                                            accountVoucherRowAmount += voucherRow.Amount;

                                            #endregion
                                        }
                                    }
                                }

                                //Accumulate
                                headerSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                headerSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                if (!reportHeader.DoNotSummarizeOnGroup)
                                {
                                    groupSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                    groupSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                }
                            }

                            #endregion

                            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                            {
                                #region BalanceReport and ResultReport

                                #region Init BalanceReport

                                BalanceItemDTO biYearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPeriodInBalance = new BalanceItemDTO();

                                //previousYear
                                BalanceItemDTO biPreviousYearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousYearPeriodInBalance = new BalanceItemDTO();

                                //Previous Period
                                BalanceItemDTO biPreviousPeriodMinus1YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus2YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus3YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus4YearInBalance = new BalanceItemDTO();
                                BalanceItemDTO biPreviousPeriodMinus5YearInBalance = new BalanceItemDTO();

                                decimal accountClosingBalance = Decimal.Zero;
                                decimal accountClosingBalanceEntCurrency = Decimal.Zero;


                                //PreviousYear
                                decimal accountClosingBalancePreviousYear = Decimal.Zero;
                                decimal accountClosingBalancePreviousYearEntCurrency = Decimal.Zero;

                                #endregion

                                #region Init ResultReport

                                BalanceItemDTO biAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                //PreviousYear
                                BalanceItemDTO biAccountBalanceChangeAllPreviousToPreviousYearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biAccountBalanceChangeAllPreviousPreviousYear = new BalanceItemDTO();

                                //Budget
                                BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                #endregion

                                #region Calculate BalanceChangeToPeriod

                                if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangeToPeriod = biBalanceChangeToPeriodDict[accountStd.AccountId];


                                    //Accumulate
                                    headerSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                    headerSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                        groupSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangeToPeriod

                                if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitToPeriod = Decimal.Zero;
                                        accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                accountGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBalanceChangeToPeriod.Any() && detailedInformation)
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts
                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }
                                            }
                                        }
                                    }


                                    //Accumulate
                                    headerSumAccountGrossProfitBalancechangeToPeriod += accountGrossProfitToPeriod;
                                    headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeGrossProfitToPeriod += accountGrossProfitToPeriod;
                                        groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangeToPeriodBudget

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountBudgetGrossProfitToPeriod = Decimal.Zero;
                                        accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                accountBudgetGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountBudgetGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Any() && detailedInformation)
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Any(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)) ? voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Where(i => i.AccountIds.Contains(accountStd.AccountId)).ToList() : new List<VoucherHeadDTO>();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }

                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountGrossProfitBalancechangeToPeriod += accountBudgetGrossProfitToPeriod;
                                    headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitToPeriod;
                                        groupSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                    }
                                }


                                #endregion


                                #region Calculate BalanceChangeToPreviousYearPeriod

                                if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangeToPreviousYearPeriod = biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                    headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                        groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangeToPreviousYearPeriod

                                if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                                        accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= reportParams.DateFrom && b.PeriodTo <= reportParams.DateTo).ToList();
                                                accountGrossProfitToPreviousYearPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitToPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Any())
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                    headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                        groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate BudgetBalanceChangeToPeriod

                                if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBudgetBalancechangeToPeriod = biBudgetBalanceChangeToPeriodDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                    headerSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                        groupSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #endregion

                                #region Calculate BalanceChangeYear

                                if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangeYear = biBalanceChangeYearDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                    headerSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                        groupSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                    }
                                }

                                #region Calculate GrossProfitCode BalanceChangeYear

                                if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitYear = Decimal.Zero;
                                        accountGrossProfitYearEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (var pair in biGrossProfitBalanceChangeYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                DateTime startYear = accountYear.From;
                                                DateTime endYear = accountYear.To;

                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                accountGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitYear += accountGrossProfitYear;
                                    headerSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitYear += accountGrossProfitYear;
                                        groupSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitCode BalanceChangeYear Budget

                                if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountBudgetGrossProfitYear = Decimal.Zero;
                                        accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (var pair in biGrossProfitBalanceChangeYearBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                DateTime startYear = accountYear.From;
                                                DateTime endYear = accountYear.To;

                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                accountBudgetGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountBudgetGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                    headerSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                        groupSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                    }
                                }

                                #endregion

                                #endregion

                                #region Calculate BalanceChangePreviousYear

                                if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousYear = biBalanceChangePreviousYearDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                    headerSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                        groupSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                    }
                                }

                                #region Calculate GrossProfitCode BalanceChangePreviousYear

                                if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitPreviousYear = Decimal.Zero;
                                        accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;

                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();
                                        foreach (var pair in biGrossProfitBalanceChangePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                DateTime startYear = previousAccountYear.From;
                                                DateTime endYear = previousAccountYear.To;

                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                accountGrossProfitPreviousYear += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                accountGrossProfitPreviousYearEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitBalancechangePreviousYearPeriod += accountGrossProfitPreviousYear;
                                    headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPreviousYear += accountGrossProfitPreviousYear;
                                        groupSumAccountGrossProfitPreviousYearEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                    }
                                }

                                #endregion


                                #endregion

                                #region Calculate BudgetBalanceChangeYear

                                if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBudgetBalancechangeYear = biBudgetBalanceChangeYearDict[accountStd.AccountId];

                                    //Accumulate
                                    headerSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                    headerSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                        groupSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                {
                                    #region BalanceReport

                                    #region Calculate OpeningYearBalance

                                    if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biYearInBalance = biYearInBalanceDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountYearInBalance += biYearInBalance.Balance;
                                        headerSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountYearInBalance += biYearInBalance.Balance;
                                            groupSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                        headerSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                            groupSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                        }
                                    }

                                    #region Calculate GrossProfitCode

                                    if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                    {
                                        GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                        if (grossProfitCode != null)
                                        {
                                            accountGrossProfitYearOpeningBalance = Math.Round((biYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                            accountGrossProfitYearEntCurrencyOpeningBalance = Math.Round((biYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Calculate OpeningYearBalance Previus Year

                                    if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biPreviousYearInBalance = biYearInBalancePreviousYearDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                        headerSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                            groupSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                        headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                            groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                        }
                                    }

                                    #region Calculate OpeningYearBalance GrossProfitCode PreviousYear

                                    if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                    {
                                        GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                        if (grossProfitCode != null)
                                        {
                                            accountGrossProfitPreviousYearOpeningBalance = Math.Round((biPreviousYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                            accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Math.Round((biPreviousYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Calculate PeriodInBalance

                                    //Ingående saldo för aktuell period. (Ingående balans för aktuellt år + Från år start till period start)
                                    //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                    biPeriodInBalance.Balance = biYearInBalance.Balance;

                                    #region Calculate GrossProfitCode

                                    if (accountYear.From != reportParams.DateFrom)
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitPeriodInBalance = Decimal.Zero;
                                            accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime endYear = new DateTime(reportParams.DateFrom.Year, reportParams.DateFrom.Month - 1, DateTime.DaysInMonth(reportParams.DateTo.Year, reportParams.DateFrom.Month - 1));
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);

                                                }
                                            }

                                        }

                                        biPeriodInBalance.Balance += biBalancechangeToPeriod.Balance;
                                        biPeriodInBalance.BalanceEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                    }
                                    else
                                    {
                                        accountGrossProfitYearEntCurrencyOpeningBalance = accountGrossProfitYearOpeningBalance;
                                    }

                                    #endregion

                                    if (biYearInBalance.Quantity.HasValue)
                                        biPeriodInBalance.Quantity += biYearInBalance.Quantity.Value;
                                    if (biBalancechangeToPeriod.Quantity.HasValue)
                                        biPeriodInBalance.Quantity += biBalancechangeToPeriod.Quantity.Value;

                                    //Accumulate
                                    headerSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                    headerSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                        groupSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                    }
                                    headerSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                    headerSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                        groupSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                    }

                                    #endregion

                                    #region Calculate PeriodInBalance Previus Year

                                    //Ingående saldo för aktuell period förra året. (Ingående balans för förra året + Från år start till period start)
                                    //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                    biPreviousYearPeriodInBalance.Balance = biPreviousYearInBalance.Balance;

                                    #region Calculate GrossProfitCode Previus Year

                                    if (previousAccountYear != null && previousAccountYear.From != prevYearDateFrom)
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                                            accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitYearInBalancePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime endYear = new DateTime(prevYearDateFrom.Year, prevYearDateFrom.Month - 1, DateTime.DaysInMonth(prevYearDateTo.Year, prevYearDateFrom.Month - 1));
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitPreviousYearPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                    accountGrossProfitPreviousYearPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        biPreviousYearPeriodInBalance.Balance += biBalancechangeToPreviousYearPeriod.Balance;
                                        biPreviousYearPeriodInBalance.BalanceEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    }
                                    else
                                    {
                                        accountGrossProfitPreviousYearEntCurrencyOpeningBalance = accountGrossProfitPreviousYearOpeningBalance;
                                    }

                                    #endregion

                                    if (biPreviousYearInBalance.Quantity.HasValue)
                                        biPreviousYearPeriodInBalance.Quantity += biPreviousYearInBalance.Quantity.Value;

                                    if (biBalancechangeToPreviousYearPeriod.Quantity.HasValue)
                                        biPreviousYearPeriodInBalance.Quantity += biBalancechangeToPreviousYearPeriod.Quantity.Value;

                                    //Accumulate
                                    headerSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                    headerSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                        groupSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                    }
                                    headerSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                    headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                        groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                    }

                                    #endregion

                                    #region Calculate ClosingYearBalance

                                    //Utgående balans för aktuellt år
                                    accountClosingBalance = biPeriodInBalance.Balance + biBalancechangePeriod.Balance;
                                    accountClosingBalanceEntCurrency = biPeriodInBalance.BalanceEntCurrency + biBalancechangePeriod.BalanceEntCurrency;

                                    //Accumulate
                                    headerSumAccountClosingBalance += accountClosingBalance;
                                    headerSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountClosingBalance += accountClosingBalance;
                                        groupSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                    }

                                    #endregion

                                    #region Calculate ClosingYearBalance Previus Year

                                    //Utgående balans för aktuellt år
                                    accountClosingBalancePreviousYear = biPreviousYearPeriodInBalance.Balance + biBalancechangePreviousYearPeriod.Balance;
                                    accountClosingBalancePreviousYearEntCurrency = biPreviousYearPeriodInBalance.BalanceEntCurrency + biBalancechangePreviousYearPeriod.BalanceEntCurrency;

                                    //Accumulate
                                    headerSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                    headerSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                        groupSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                    }

                                    #endregion

                                    #region Calculate BalanceChangeToPeriodEnd

                                    ////Från år start till period slut
                                    //accountBalancechangeToPeriodEnd = accountClosingBalance - biOpeningBalance.Balance;

                                    ////Accumulate
                                    //headerSumAccountBalancechangeToPeriodEnd += accountBalancechangeToPeriodEnd;
                                    //groupSumAccountBalancechangeToPeriodEnd += accountBalancechangeToPeriodEnd;

                                    #endregion

                                    #endregion
                                }
                                else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                                {
                                    #region ResultReport

                                    #region Calculate AccountBalanceChangeAllPreviousToPeriod

                                    if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousToPeriod = biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                        headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                            groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate AccountBalanceChangeAllPreviousToPreviousYearPeriod

                                    if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousToPreviousYearPeriod = biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                        headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                            groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate AccountBalanceChangeAllPreviousThisYear

                                    if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousThisYear = biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                        headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                            groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate AccountBalanceChangeAllPreviousPreviousYear

                                    if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biAccountBalanceChangeAllPreviousPreviousYear = biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId];

                                        //Accumulate
                                        headerSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                        headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                            groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #endregion
                                }

                                #endregion

                                #region XElement Account



                                #region Init

                                bool isInactive = accountStd.State == SoeEntityState.Inactive;
                                decimal period = invertRow ? Decimal.Negate(biBalancechangePeriod.Balance) : biBalancechangePeriod.Balance;
                                decimal periodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePeriod.BalanceEntCurrency) : biBalancechangePeriod.BalanceEntCurrency;
                                decimal grossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriod) : accountGrossProfitPeriod;
                                decimal grossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrency) : accountGrossProfitPeriodEntCurrency;
                                decimal toPeriod = invertRow ? Decimal.Negate(biBalancechangeToPeriod.Balance) : biBalancechangeToPeriod.Balance;
                                decimal toPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPeriod.BalanceEntCurrency) : biBalancechangeToPeriod.BalanceEntCurrency;
                                decimal year = invertRow ? Decimal.Negate(biBalancechangeYear.Balance) : biBalancechangeYear.Balance;
                                decimal yearEntCurrency = invertRow ? Decimal.Negate(biBalancechangeYear.BalanceEntCurrency) : biBalancechangeYear.BalanceEntCurrency;
                                decimal grossProfitYear = invertRow ? Decimal.Negate(accountGrossProfitYear) : accountGrossProfitYear;
                                decimal grossProfitEntCurrencyYear = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrency) : accountGrossProfitYearEntCurrency;
                                //Previous Year
                                decimal previousYearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.Balance) : biBalancechangePreviousYearPeriod.Balance;
                                decimal previousYearPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.BalanceEntCurrency) : biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                decimal previousYearGrossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriod) : accountGrossProfitPreviousYearPeriod;
                                decimal previousYearGrossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrency) : accountGrossProfitPreviousYearPeriodEntCurrency;
                                decimal previousYearToPeriod = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.Balance) : biBalancechangeToPreviousYearPeriod.Balance;
                                decimal previousYearToPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.BalanceEntCurrency) : biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                decimal previousYear = invertRow ? Decimal.Negate(biBalancechangePreviousYear.Balance) : biBalancechangePreviousYear.Balance;
                                decimal previousYearEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYear.BalanceEntCurrency) : biBalancechangePreviousYear.BalanceEntCurrency;
                                decimal previousYearGrossProfit = invertRow ? Decimal.Negate(accountGrossProfitPreviousYear) : accountGrossProfitPreviousYear;
                                decimal previousYearGrossProfitEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearEntCurrency) : accountGrossProfitPreviousYearEntCurrency;
                                //Previous Period
                                decimal previousPeriodMinus1YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus1YearPeriod.Balance) : biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                decimal previousPeriodMinus2YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus2YearPeriod.Balance) : biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                decimal previousPeriodMinus3YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus3YearPeriod.Balance) : biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                decimal previousPeriodMinus4YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus4YearPeriod.Balance) : biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                decimal previousPeriodMinus5YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus5YearPeriod.Balance) : biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                //Budget
                                decimal budgetPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.Balance) : biBudgetBalancechangePeriod.Balance;
                                decimal budgetPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.BalanceEntCurrency) : biBudgetBalancechangePeriod.BalanceEntCurrency;
                                decimal budgetToPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.Balance) : biBudgetBalancechangeToPeriod.Balance;
                                decimal budgetToPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.BalanceEntCurrency) : biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                decimal budgetYear = invertRow ? Decimal.Negate(biBalancechangeYear.Balance) : biBudgetBalancechangeYear.Balance;
                                decimal budgetYearEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeYear.BalanceEntCurrency) : biBudgetBalancechangeYear.BalanceEntCurrency;

                                //Do not include inactive accounts that has no balance
                                //if (isInactive && NumberUtility.IsAllZero(period, toPeriod, year, previousYear, budgetYear, previousPeriodMinus2YearPeriod, previousPeriodMinus3YearPeriod, previousPeriodMinus4YearPeriod, previousPeriodMinus5YearPeriod))
                                //    continue;

                                #endregion

                                #region Add elements

                                accountElement = new XElement("Account",
                                    new XAttribute("id", accountXmlId),
                                    new XElement("AccountNr", accountStd.AccountNr),
                                    new XElement("AccountName", accountStd.Name),
                                    new XElement("AccountInternalNr1", String.Empty), //TODO
                                    new XElement("AccountInternalName1", String.Empty), //TODO
                                    new XElement("AccountInternalNr2", String.Empty), //TODO
                                    new XElement("AccountInternalName2", String.Empty), //TODO
                                    new XElement("AccountInternalNr3", String.Empty), //TODO
                                    new XElement("AccountInternalName3", String.Empty), //TODO
                                    new XElement("AccountInternalNr4", String.Empty), //TODO
                                    new XElement("AccountInternalName4", String.Empty), //TODO
                                    new XElement("AccountInternalNr5", String.Empty), //TODO
                                    new XElement("AccountInternalName5", String.Empty), //TODO
                                    new XElement("AccountInternalNr6", String.Empty), //TODO
                                    new XElement("AccountInternalName6", String.Empty), //TODO
                                    new XElement("AccountBalancechangePeriod", period),
                                    new XElement("AccountBalancechangePeriodEntCurrency", periodEntCurrency),
                                    new XElement("AccountGrossProfitPeriod", grossProfitPeriod),
                                    new XElement("AccountGrossProfitPeriodEntCurrency", grossProfitEntCurrencyPeriod),
                                    new XElement("AccountBalancechangeToPeriod", toPeriod),
                                    new XElement("AccountBalancechangeToPeriodEntCurrency", toPeriodEntCurrency),
                                    new XElement("AccountBalancechangeYear", year),
                                    new XElement("AccountBalancechangeYearEntCurrency", yearEntCurrency),
                                    new XElement("AccountGrossProfitYear", grossProfitYear),
                                    new XElement("AccountGrossProfitYearEntCurrency", grossProfitEntCurrencyYear),

                                    //Previous Year
                                    new XElement("PreviousYearAccountBalancechangePeriod", previousYearPeriod),
                                    new XElement("PreviousYearAccountBalancechangePeriodEntCurrency", previousYearPeriodEntCurrency),
                                    new XElement("PreviousYearAccountGrossProfitPeriod", previousYearGrossProfitPeriod),
                                    new XElement("PreviousYearAccountGrossProfitPeriodEntCurrency", previousYearGrossProfitEntCurrencyPeriod),
                                    new XElement("PreviousYearAccountBalancechangeToPeriod", previousYearToPeriod),
                                    new XElement("PreviousYearAccountBalancechangeToPeriodEntCurrency", previousYearToPeriodEntCurrency),
                                    new XElement("PreviousYearAccountBalancechangeYear", previousYear),
                                    new XElement("PreviousYearAccountBalancechangeYearEntCurrency", previousYearEntCurrency),
                                    new XElement("PreviousYearAccountGrossProfitYear", previousYearGrossProfit),
                                    new XElement("PreviousYearAccountGrossProfitYearEntCurrency", previousYearGrossProfitEntCurrency),

                                    //previous Period
                                    new XElement("PreviousPeriodMinus1YearAccountBalancechangePeriod", previousPeriodMinus1YearPeriod),
                                    new XElement("PreviousPeriodMinus2YearAccountBalancechangePeriod", previousPeriodMinus2YearPeriod),
                                    new XElement("PreviousPeriodMinus3YearAccountBalancechangePeriod", previousPeriodMinus3YearPeriod),
                                    new XElement("PreviousPeriodMinus4YearAccountBalancechangePeriod", previousPeriodMinus4YearPeriod),
                                    new XElement("PreviousPeriodMinus5YearAccountBalancechangePeriod", previousPeriodMinus5YearPeriod),

                                    //Budget
                                    new XElement("BudgetAccountBalancechangePeriod", budgetPeriod),
                                    new XElement("BudgetAccountBalancechangePeriodEntCurrency", budgetPeriodEntCurrency),
                                    new XElement("BudgetAccountBalancechangeToPeriod", budgetToPeriod),
                                    new XElement("BudgetAccountBalancechangeToPeriodEntCurrency", budgetToPeriodEntCurrency),
                                    new XElement("BudgetAccountBalancechangeYear", budgetYear),
                                    new XElement("BudgetAccountBalancechangeYearEntCurrency", budgetYearEntCurrency),
                                    new XElement("BudgetAccountGrossProfitPeriod", accountBudgetGrossProfitPeriod));



                                #endregion

                                if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                {
                                    #region BalanceReport

                                    #region Init

                                    decimal periodInBalance = invertRow ? Decimal.Negate(biPeriodInBalance.Balance) : biPeriodInBalance.Balance;
                                    decimal periodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPeriodInBalance.BalanceEntCurrency) : biPeriodInBalance.BalanceEntCurrency;
                                    decimal grossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPeriodInBalance) : accountGrossProfitPeriodInBalance;
                                    decimal grossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrencyInBalance) : accountGrossProfitPeriodEntCurrencyInBalance;
                                    decimal periodOpeningBalance = invertRow ? Decimal.Negate(biYearInBalance.Balance) : biYearInBalance.Balance;
                                    decimal periodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biYearInBalance.BalanceEntCurrency) : biYearInBalance.BalanceEntCurrency;
                                    decimal grossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitYearOpeningBalance) : accountGrossProfitYearOpeningBalance;
                                    decimal grossProfitPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrencyOpeningBalance) : accountGrossProfitYearEntCurrencyOpeningBalance;
                                    decimal periodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalance) : accountClosingBalance;


                                    //PreviousYear
                                    decimal previousYearPeriodInBalance = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.Balance) : biPreviousYearPeriodInBalance.Balance;
                                    decimal previousYearPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.BalanceEntCurrency) : biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                    decimal previousYearGrossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodInBalance) : accountGrossProfitPreviousYearPeriodInBalance;
                                    decimal previousYearGrossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrencyInBalance) : accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                    decimal previousYearPeriodOpeningBalance = invertRow ? Decimal.Negate(biPreviousYearInBalance.Balance) : biPreviousYearInBalance.Balance;
                                    decimal previousYearPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearInBalance.BalanceEntCurrency) : biPreviousYearInBalance.BalanceEntCurrency;
                                    decimal previousYearGrossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearOpeningBalance) : accountGrossProfitPreviousYearOpeningBalance;
                                    decimal previousYearPeriodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalancePreviousYear) : accountClosingBalancePreviousYear;
                                    decimal previousYearPeriodClosingBalanceEntCurrency = invertRow ? Decimal.Negate(accountClosingBalancePreviousYearEntCurrency) : accountClosingBalancePreviousYearEntCurrency;


                                    //Do not include inactive accounts that has no balance
                                    //if (isInactive && NumberUtility.IsAllZero(periodInBalance, periodOpeningBalance, periodClosingBalance, previousYearPeriodInBalance, previousYearPeriodOpeningBalance, previousYearPeriodClosingBalance))
                                    //    continue;

                                    #endregion

                                    #region Add elements

                                    accountElement.Add(
                                        new XElement("AccountPeriodInBalance", periodInBalance),
                                        new XElement("AccountPeriodInBalanceEntCurrency", periodInBalanceEntCurrency),
                                        new XElement("AccountGrossProfitPeriodInBalance", grossProfitPeriodInBalance),
                                        new XElement("AccountGrossProfitPeriodInBalanceEntCurrency", grossProfitPeriodInBalanceEntCurrency),
                                        new XElement("AccountOpeningBalance", periodOpeningBalance),
                                        new XElement("AccountOpeningBalanceEntCurrency", periodOpeningBalanceEntCurrency),
                                        new XElement("AccountGrossProfitOpeningBalance", grossProfitPeriodOpeningBalance),
                                        new XElement("AccountGrossProfitOpeningBalanceEntCurrency", grossProfitPeriodOpeningBalanceEntCurrency),
                                        new XElement("AccountClosingBalance", periodClosingBalance),

                                        //Previous Year
                                        new XElement("PreviousYearAccountPeriodInBalance", previousYearPeriodInBalance),
                                        new XElement("PreviousYearAccountPeriodInBalanceEntCurrency", previousYearPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitPeriodInBalance", previousYearGrossProfitPeriodInBalance),
                                        new XElement("PreviousYearAccountGrossProfitPeriodInBalanceEntCurrency", previousYearGrossProfitPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearAccountOpeningBalance", previousYearPeriodOpeningBalance),
                                        new XElement("PreviousYearAccountOpeningBalanceEntCurrency", previousYearPeriodOpeningBalanceEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitOpeningBalance", previousYearGrossProfitPeriodOpeningBalance),
                                        new XElement("PreviousYearAccountClosingBalance", previousYearPeriodClosingBalance),
                                        new XElement("PreviousYearAccountClosingBalanceEntCurrency", previousYearPeriodClosingBalanceEntCurrency));


                                    #endregion

                                    #endregion
                                }
                                else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                                {
                                    #region ResultReport

                                    #region Init

                                    decimal accountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.Balance) : biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                    decimal accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                    decimal accountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.Balance) : biAccountBalanceChangeAllPreviousThisYear.Balance;
                                    decimal accountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                    //Previous Year
                                    decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                    decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYearAccountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.Balance) : biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                    decimal previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;


                                    //Do not include inactive accounts that has no balance
                                    //if (isInactive && reportParams.IncludeAllHistoricalData && NumberUtility.IsAllZero(accountBalanceChangeAllPreviousToPeriodBalance, accountBalanceChangeAllPreviousThisYearBalance))
                                    //    continue;

                                    #endregion

                                    #region Add elements

                                    accountElement.Add(
                                        new XElement("AccountBalanceChangeAllPreviousToPeriodBalance", accountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("AccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        new XElement("AccountBalanceChangeAllPreviousThisYearBalance", accountBalanceChangeAllPreviousThisYearBalance),
                                        new XElement("AccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", accountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                        //Previous Year
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalance", previousYearAccountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalance", previousYearAccountBalanceChangeAllPreviousThisYearBalance),
                                        new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency));

                                    #endregion

                                    #endregion
                                }

                                #region VoucherSummery

                                if (accountQuantity != 0 || accountPeriod1 != 0 || accountPeriod2 != 0 || accountPeriod3 != 0 || accountPeriod4 != 0 || accountPeriod5 != 0 || accountPeriod5 != 0 || accountPeriod6 != 0 || accountPeriod7 != 0 || accountPeriod8 != 0 || accountPeriod9 != 0 || accountPeriod10 != 0 || accountPeriod11 != 0 || accountPeriod12 != 0 || previousYearAccountPeriod1 != 0)
                                {
                                    voucherSummeryElement = new XElement("VoucherSummery",
                                        new XAttribute("id", voucherSummeryXmlId),
                                        new XElement("VoucherSummeryAccountNr", accountStd.AccountNr),
                                        new XElement("VoucherSummeryAccountName", accountStd.Name),
                                        new XElement("VoucherSummeryAccountQuantity", accountQuantity),
                                        new XElement("VoucherSummeryYear0", invertRow ? Decimal.Negate(accountYear0) : accountYear0),
                                        new XElement("VoucherSummeryYearMinus1", invertRow ? Decimal.Negate(accountYearMinus1) : accountYearMinus1),
                                        new XElement("VoucherSummeryYearMinus2", invertRow ? Decimal.Negate(accountYearMinus2) : accountYearMinus2),
                                        new XElement("VoucherSummeryYearMinus3", invertRow ? Decimal.Negate(accountYearMinus3) : accountYearMinus3),
                                        new XElement("VoucherSummeryYearMinus4", invertRow ? Decimal.Negate(accountYearMinus4) : accountYearMinus4),
                                        new XElement("VoucherSummeryAccountPeriod1", invertRow ? Decimal.Negate(accountPeriod1) : accountPeriod1),
                                        new XElement("VoucherSummeryAccountPeriod2", invertRow ? Decimal.Negate(accountPeriod2) : accountPeriod2),
                                        new XElement("VoucherSummeryAccountPeriod3", invertRow ? Decimal.Negate(accountPeriod3) : accountPeriod3),
                                        new XElement("VoucherSummeryAccountPeriod4", invertRow ? Decimal.Negate(accountPeriod4) : accountPeriod4),
                                        new XElement("VoucherSummeryAccountPeriod5", invertRow ? Decimal.Negate(accountPeriod5) : accountPeriod5),
                                        new XElement("VoucherSummeryAccountPeriod6", invertRow ? Decimal.Negate(accountPeriod6) : accountPeriod6),
                                        new XElement("VoucherSummeryAccountPeriod7", invertRow ? Decimal.Negate(accountPeriod7) : accountPeriod7),
                                        new XElement("VoucherSummeryAccountPeriod8", invertRow ? Decimal.Negate(accountPeriod8) : accountPeriod8),
                                        new XElement("VoucherSummeryAccountPeriod9", invertRow ? Decimal.Negate(accountPeriod9) : accountPeriod9),
                                        new XElement("VoucherSummeryAccountPeriod10", invertRow ? Decimal.Negate(accountPeriod10) : accountPeriod10),
                                        new XElement("VoucherSummeryAccountPeriod11", invertRow ? Decimal.Negate(accountPeriod11) : accountPeriod11),
                                        new XElement("VoucherSummeryAccountPeriod12", invertRow ? Decimal.Negate(accountPeriod12) : accountPeriod12),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod1", invertRow ? Decimal.Negate(previousYearAccountPeriod1) : previousYearAccountPeriod1),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod2", invertRow ? Decimal.Negate(previousYearAccountPeriod2) : previousYearAccountPeriod2),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod3", invertRow ? Decimal.Negate(previousYearAccountPeriod3) : previousYearAccountPeriod3),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod4", invertRow ? Decimal.Negate(previousYearAccountPeriod4) : previousYearAccountPeriod4),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod5", invertRow ? Decimal.Negate(previousYearAccountPeriod5) : previousYearAccountPeriod5),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod6", invertRow ? Decimal.Negate(previousYearAccountPeriod6) : previousYearAccountPeriod6),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod7", invertRow ? Decimal.Negate(previousYearAccountPeriod7) : previousYearAccountPeriod7),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod8", invertRow ? Decimal.Negate(previousYearAccountPeriod8) : previousYearAccountPeriod8),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod9", invertRow ? Decimal.Negate(previousYearAccountPeriod9) : previousYearAccountPeriod9),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod10", invertRow ? Decimal.Negate(previousYearAccountPeriod10) : previousYearAccountPeriod10),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod11", invertRow ? Decimal.Negate(previousYearAccountPeriod11) : previousYearAccountPeriod11),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod12", invertRow ? Decimal.Negate(previousYearAccountPeriod12) : previousYearAccountPeriod12),
                                        new XElement("VoucherSummeryPreviousPeriodMinus1Year", invertRow ? Decimal.Negate(previousPeriodMinus1YearAccountPeriod) : previousPeriodMinus1YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus2Year", invertRow ? Decimal.Negate(previousPeriodMinus2YearAccountPeriod) : previousPeriodMinus2YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus3Year", invertRow ? Decimal.Negate(previousPeriodMinus3YearAccountPeriod) : previousPeriodMinus3YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus4Year", invertRow ? Decimal.Negate(previousPeriodMinus4YearAccountPeriod) : previousPeriodMinus4YearAccountPeriod),
                                        new XElement("VoucherSummeryPreviousPeriodMinus5Year", invertRow ? Decimal.Negate(previousPeriodMinus5YearAccountPeriod) : previousPeriodMinus5YearAccountPeriod),
                                        new XElement("VoucherSummeryBudgetAccountPeriod1", invertRow ? Decimal.Negate(budgetAccountPeriod1) : budgetAccountPeriod1),
                                        new XElement("VoucherSummeryBudgetAccountPeriod2", invertRow ? Decimal.Negate(budgetAccountPeriod2) : budgetAccountPeriod2),
                                        new XElement("VoucherSummeryBudgetAccountPeriod3", invertRow ? Decimal.Negate(budgetAccountPeriod3) : budgetAccountPeriod3),
                                        new XElement("VoucherSummeryBudgetAccountPeriod4", invertRow ? Decimal.Negate(budgetAccountPeriod4) : budgetAccountPeriod4),
                                        new XElement("VoucherSummeryBudgetAccountPeriod5", invertRow ? Decimal.Negate(budgetAccountPeriod5) : budgetAccountPeriod5),
                                        new XElement("VoucherSummeryBudgetAccountPeriod6", invertRow ? Decimal.Negate(budgetAccountPeriod6) : budgetAccountPeriod6),
                                        new XElement("VoucherSummeryBudgetAccountPeriod7", invertRow ? Decimal.Negate(budgetAccountPeriod7) : budgetAccountPeriod7),
                                        new XElement("VoucherSummeryBudgetAccountPeriod8", invertRow ? Decimal.Negate(budgetAccountPeriod8) : budgetAccountPeriod8),
                                        new XElement("VoucherSummeryBudgetAccountPeriod9", invertRow ? Decimal.Negate(budgetAccountPeriod9) : budgetAccountPeriod9),
                                        new XElement("VoucherSummeryBudgetAccountPeriod10", invertRow ? Decimal.Negate(budgetAccountPeriod10) : budgetAccountPeriod10),
                                        new XElement("VoucherSummeryBudgetAccountPeriod11", invertRow ? Decimal.Negate(budgetAccountPeriod11) : budgetAccountPeriod11),
                                        new XElement("VoucherSummeryBudgetAccountPeriod12", invertRow ? Decimal.Negate(budgetAccountPeriod12) : budgetAccountPeriod12));

                                    voucherSummeryXmlId += 1;
                                    voucherSummeryElement.Add(voucherRowElements);
                                    accountElement.Add(voucherSummeryElement);
                                }

                                if (!voucherRowElements.Any() && accountXmlId == 1)
                                {
                                    voucherSummeryElement = new XElement("VoucherSummery",
                                        new XAttribute("id", voucherSummeryXmlId),
                                        new XElement("VoucherSummeryAccountNr", "Empty"),
                                        new XElement("VoucherSummeryAccountName", "Empty Element ONLY available with detailed information"),
                                        new XElement("VoucherSummeryAccountQuantity", 0),
                                        new XElement("VoucherSummeryYear0", 0),
                                        new XElement("VoucherSummeryYearMinus1", 0),
                                        new XElement("VoucherSummeryYearMinus2", 0),
                                        new XElement("VoucherSummeryYearMinus3", 0),
                                        new XElement("VoucherSummeryYearMinus4", 0),
                                        new XElement("VoucherSummeryAccountPeriod1", 0),
                                        new XElement("VoucherSummeryAccountPeriod2", 0),
                                        new XElement("VoucherSummeryAccountPeriod3", 0),
                                        new XElement("VoucherSummeryAccountPeriod4", 0),
                                        new XElement("VoucherSummeryAccountPeriod5", 0),
                                        new XElement("VoucherSummeryAccountPeriod6", 0),
                                        new XElement("VoucherSummeryAccountPeriod7", 0),
                                        new XElement("VoucherSummeryAccountPeriod8", 0),
                                        new XElement("VoucherSummeryAccountPeriod9", 0),
                                        new XElement("VoucherSummeryAccountPeriod10", 0),
                                        new XElement("VoucherSummeryAccountPeriod11", 0),
                                        new XElement("VoucherSummeryAccountPeriod12", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod1", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod2", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod3", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod4", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod5", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod6", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod7", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod8", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod9", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod10", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod11", 0),
                                        new XElement("VoucherSummeryPreviousYearAccountPeriod12", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus1Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus2Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus3Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus4Year", 0),
                                        new XElement("VoucherSummeryPreviousPeriodMinus5Year", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod1", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod2", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod3", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod4", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod5", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod6", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod7", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod8", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod9", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod10", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod11", 0),
                                        new XElement("VoucherSummeryBudgetAccountPeriod12", 0));

                                    voucherSummeryXmlId += 1;
                                    voucherSummeryElement.Add(voucherRowElements);
                                    accountElement.Add(voucherSummeryElement);
                                }

                                #endregion

                                accountElementsForHeader.Add(accountElement);

                                #endregion
                            }

                            accountXmlId++;

                            #region DetailedInformation

                            if (reportResult.GetDetailedInformation && accountAndInternalAccountComboDTOs.Any())
                            {
                                int accountDetailXmlId = 0;

                                List<XElement> accountDetailElements = new List<XElement>();

                                foreach (var comboDTO in accountAndInternalAccountComboDTOs)
                                {
                                    if (!comboDTO.Dim2Id.HasValue && !comboDTO.Dim3Id.HasValue && !comboDTO.Dim4Id.HasValue && !comboDTO.Dim5Id.HasValue && !comboDTO.Dim6Id.HasValue)
                                        continue;

                                    decimal detAccchangeAllPrevToPer = Decimal.Zero;
                                    decimal detAccchangeAllPrevToPerEntCurr = Decimal.Zero;
                                    decimal detAccchangeAllPrevThisYear = Decimal.Zero;
                                    decimal detAccchangeAllPrevThisYearEntCurr = Decimal.Zero;

                                    decimal detAccchangePer = Decimal.Zero;
                                    decimal detAccchangePerEntCurr = Decimal.Zero;
                                    decimal detAccchangeToPer = Decimal.Zero;
                                    decimal detAccchangeToPerEntCurr = Decimal.Zero;
                                    decimal detAccChangeYear = Decimal.Zero;
                                    decimal detAccChangeYearEntCurr = Decimal.Zero;
                                    decimal detAccChangePrevYearPer = Decimal.Zero;
                                    decimal detAccChangePrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccChangeToPrevYearPer = Decimal.Zero;
                                    decimal detAccChangeToPrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccChangePrevYear = Decimal.Zero;
                                    decimal detAccChangePrevYearEntCurr = Decimal.Zero;
                                    decimal detAccBudChangePer = Decimal.Zero;
                                    decimal detAccBudChangePerEntCurr = Decimal.Zero;
                                    decimal detAccBudChangeToPer = Decimal.Zero;
                                    decimal detAccBudChangeToPerEntCurr = Decimal.Zero;
                                    decimal detAccBudChangeYear = Decimal.Zero;
                                    decimal detAccBudChangeYearEntCurr = Decimal.Zero;

                                    //decimal detAccBalancechangeToPerEnd = Decimal.Zero;
                                    decimal detAccGPPer = Decimal.Zero;
                                    decimal detAccGPPerEntCurr = Decimal.Zero;
                                    decimal detAccGPToPer = Decimal.Zero;
                                    decimal detAccGPToPerEntCurr = Decimal.Zero;
                                    decimal detAccGPYear = Decimal.Zero;
                                    decimal detAccGPYearEntCurr = Decimal.Zero;
                                    //decimal detAccGPPerInBalance = Decimal.Zero;
                                    //decimal detAccGPPerEntCurrInBalance = Decimal.Zero;
                                    //decimal detAccGPYearOpeningBalance = Decimal.Zero;
                                    //decimal detAccGPYearEntCurrOpeningBalance = Decimal.Zero;

                                    //PrevYear
                                    decimal detAccGPPrevYearPer = Decimal.Zero;
                                    decimal detAccGPPrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccGPToPrevYearPer = Decimal.Zero;
                                    decimal detAccGPToPrevYearPerEntCurr = Decimal.Zero;
                                    decimal detAccGPPrevYear = Decimal.Zero;
                                    decimal detAccGPPrevYearEntCurr = Decimal.Zero;
                                    //decimal detAccGPPrevYearPerInBalance = Decimal.Zero;
                                    //decimal detAccGPPrevYearPerEntCurrInBalance = Decimal.Zero;
                                    //decimal detAccGPPrevYearOpeningBalance = Decimal.Zero;
                                    //decimal detAccGPPrevYearOpeningBalanceEntCurr = Decimal.Zero;


                                    //Budget and GP
                                    decimal detAccBudgetGPPer = Decimal.Zero;
                                    decimal detAccBudgetGPPerEntCurr = Decimal.Zero;
                                    decimal detAccBudgetGPToPer = Decimal.Zero;
                                    decimal detAccBudgetGPToPerEntCurr = Decimal.Zero;
                                    decimal detAccBudgetGPYear = Decimal.Zero;
                                    decimal detAccBudgetGPYearEntCurr = Decimal.Zero;


                                    var pairDetAccchangeAllPrevToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsAllPreviousToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccchangeAllPrevToPer = pairDetAccchangeAllPrevToPer.Key;
                                    detAccchangeAllPrevToPerEntCurr = pairDetAccchangeAllPrevToPer.Value;

                                    var pairDetAccchangeAllPrevThisYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsAllPreviousThisYear, accountDimInternals, accountInternalsInInterval);
                                    detAccchangeAllPrevThisYear = pairDetAccchangeAllPrevToPer.Key;
                                    detAccchangeAllPrevThisYearEntCurr = pairDetAccchangeAllPrevToPer.Value;

                                    var pairDetAccchangePer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsBalancechangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccchangePer = pairDetAccchangePer.Key;
                                    detAccchangePerEntCurr = pairDetAccchangePer.Value;

                                    var pairDetAccchangeToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccchangeToPer = pairDetAccchangeToPer.Key;
                                    detAccchangeToPerEntCurr = pairDetAccchangeToPer.Value;

                                    var pairDetAccChangeYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccChangeYear = pairDetAccChangeYear.Key;
                                    detAccChangeYearEntCurr = pairDetAccChangeYear.Value;

                                    var pairDetAccChangePreYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsBalancechangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccChangePrevYearPer = pairDetAccChangePreYearPer.Key;
                                    detAccChangePrevYearPerEntCurr = pairDetAccChangePreYearPer.Value;

                                    var pairDetAccChangeToPreYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccChangeToPrevYearPer = pairDetAccChangeToPreYearPer.Key;
                                    detAccChangeToPrevYearPerEntCurr = pairDetAccChangeToPreYearPer.Value;

                                    var pairDetAccChangePrevYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccChangePrevYear = pairDetAccChangePrevYear.Key;
                                    detAccChangePrevYearEntCurr = pairDetAccChangePrevYear.Value;

                                    var pairDetAccBudChangePer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudChangePer = pairDetAccBudChangePer.Key;
                                    detAccBudChangePerEntCurr = pairDetAccBudChangePer.Value;

                                    var pairDetAccBudChangeToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudChangeToPer = pairDetAccBudChangeToPer.Key;
                                    detAccBudChangeToPerEntCurr = pairDetAccBudChangeToPer.Value;

                                    var pairDetAccBudChangeYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccBudChangeYear = pairDetAccBudChangeYear.Key;
                                    detAccBudChangeYearEntCurr = pairDetAccBudChangeYear.Value;

                                    var pairDetAccGPPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPPer = pairDetAccGPPer.Key;
                                    detAccGPPerEntCurr = pairDetAccGPPer.Value;

                                    var pairDetAccGPToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPToPer = pairDetAccGPToPer.Key;
                                    detAccGPToPerEntCurr = pairDetAccGPToPer.Value;

                                    var pairDetAccGPYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccGPYear = pairDetAccGPYear.Key;
                                    detAccGPYearEntCurr = pairDetAccGPYear.Value;

                                    //var pairDetAccGPPerInBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeInBalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPPerInBalance = pairDetAccGPPerInBalance.Key;
                                    //detAccGPPerEntCurrInBalance = pairDetAccGPPerInBalance.Value;

                                    //var pairDetAccGPYearOpeningBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, voucherHeadsGrossProfitBalanceChangeOpeningBalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPYearOpeningBalance = pairDetAccGPYearOpeningBalance.Key;
                                    //detAccGPYearEntCurrOpeningBalance = pairDetAccGPYearOpeningBalance.Value;

                                    var pairDetAccGPPrevYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPPrevYearPer = pairDetAccGPPrevYearPer.Key;
                                    detAccGPPrevYearPerEntCurr = pairDetAccGPPrevYearPer.Value;

                                    var pairDetAccGPToPrevYearPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccGPToPrevYearPer = pairDetAccGPToPrevYearPer.Key;
                                    detAccGPToPrevYearPerEntCurr = pairDetAccGPToPrevYearPer.Value;

                                    var pairDetAccGPPrevYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccGPPrevYear = pairDetAccGPPrevYear.Key;
                                    detAccGPPrevYearEntCurr = pairDetAccGPPrevYear.Value;

                                    //var pairDetAccGPPrevYearPerInBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeInbalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPPrevYearPerInBalance = pairDetAccGPPrevYearPerInBalance.Key;
                                    //detAccGPPrevYearPerEntCurrInBalance = pairDetAccGPPrevYearPerInBalance.Value;

                                    //var pairDetAccGPPrevYearOpeningBalance = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, previousYearVoucherHeadsGrossProfitBalanceChangeOpeningBalance, accountDimInternals, accountInternalsInInterval);
                                    //detAccGPPrevYearOpeningBalance = pairDetAccGPPrevYearOpeningBalance.Key;
                                    //detAccGPPrevYearOpeningBalanceEntCurr = pairDetAccGPPrevYearOpeningBalance.Value;

                                    var pairDetAccBudgetGPPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalancechangePeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudgetGPPer = pairDetAccBudgetGPPer.Key;
                                    detAccBudgetGPPerEntCurr = pairDetAccBudgetGPPer.Value;

                                    var pairDetAccBudgetGPToPer = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeToPeriod, accountDimInternals, accountInternalsInInterval);
                                    detAccBudgetGPToPer = pairDetAccBudgetGPToPer.Key;
                                    detAccBudgetGPToPerEntCurr = pairDetAccBudgetGPToPer.Value;

                                    var pairDetAccBudgetGPYear = GetValuefromAccountAndInternalAccountCombo(accountStd.AccountId, comboDTO, budgetVoucherHeadsBalanceChangeYear, accountDimInternals, accountInternalsInInterval);
                                    detAccBudgetGPYear = pairDetAccBudgetGPYear.Key;
                                    detAccBudgetGPYearEntCurr = pairDetAccBudgetGPYear.Value;

                                    XElement accountDetailElement = new XElement("AccountDetail",
                                    new XAttribute("id", accountDetailXmlId),
                                    new XElement("DetAccountNr", comboDTO.Dim1Nr),
                                    new XElement("DetDim2Nr", comboDTO.Dim2Nr),
                                    new XElement("DetDim3Nr", comboDTO.Dim3Nr),
                                    new XElement("DetDim4Nr", comboDTO.Dim4Nr),
                                    new XElement("DetDim5Nr", comboDTO.Dim5Nr),
                                    new XElement("DetDim6Nr", comboDTO.Dim6Nr),
                                    new XElement("DetAccountName", comboDTO.Dim1Name),
                                    new XElement("DetDim2Name", comboDTO.Dim2Name),
                                    new XElement("DetDim3Name", comboDTO.Dim3Name),
                                    new XElement("DetDim4Name", comboDTO.Dim4Name),
                                    new XElement("DetDim5Name", comboDTO.Dim5Name),
                                    new XElement("DetDim6Name", comboDTO.Dim6Name),
                                    new XElement("DetAccchangeAllPrevToPer", invertRow ? Decimal.Negate(detAccchangeAllPrevToPer) : detAccchangeAllPrevToPer),
                                    new XElement("DetAccchangeAllPrevToPerEntCurr", invertRow ? Decimal.Negate(detAccchangeAllPrevToPerEntCurr) : detAccchangeAllPrevToPerEntCurr),
                                    new XElement("DetAccchangeAllPrevThisYear", invertRow ? Decimal.Negate(detAccchangeAllPrevThisYear) : detAccchangeAllPrevThisYear),
                                    new XElement("DetAccchangeAllPrevThisYearEntCurr", invertRow ? Decimal.Negate(detAccchangeAllPrevThisYearEntCurr) : detAccchangeAllPrevThisYearEntCurr),
                                    new XElement("DetAccchangePer", invertRow ? Decimal.Negate(detAccchangePer) : detAccchangePer),
                                    new XElement("DetAccchangePerEntCurr", invertRow ? Decimal.Negate(detAccchangePerEntCurr) : detAccchangePerEntCurr),
                                    new XElement("DetAccchangeToPer", invertRow ? Decimal.Negate(detAccchangeToPer) : detAccchangeToPer),
                                    new XElement("DetAccchangeToPerEntCurr", invertRow ? Decimal.Negate(detAccchangeToPerEntCurr) : detAccchangeToPerEntCurr),
                                    new XElement("DetAccChangeYear", invertRow ? Decimal.Negate(detAccChangeYear) : detAccChangeYear),
                                    new XElement("DetAccChangeYearEntCurr", invertRow ? Decimal.Negate(detAccChangeYearEntCurr) : detAccChangeYearEntCurr),
                                    new XElement("DetAccChangePrevYearPer", invertRow ? Decimal.Negate(detAccChangePrevYearPer) : detAccChangePrevYearPer),
                                    new XElement("DetAccChangePrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccChangePrevYearPerEntCurr) : detAccChangePrevYearPerEntCurr),
                                    new XElement("DetAccChangeToPrevYearPer", invertRow ? Decimal.Negate(detAccChangeToPrevYearPer) : detAccChangeToPrevYearPer),
                                    new XElement("DetAccChangeToPrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccChangeToPrevYearPerEntCurr) : detAccChangeToPrevYearPerEntCurr),
                                    new XElement("DetAccChangePrevYear", invertRow ? Decimal.Negate(detAccChangePrevYear) : detAccChangePrevYear),
                                    new XElement("DetAccChangePrevYearEntCurr", invertRow ? Decimal.Negate(detAccChangePrevYearEntCurr) : detAccChangePrevYearEntCurr),
                                    new XElement("DetAccBudChangePer", invertRow ? Decimal.Negate(detAccBudChangePer) : detAccBudChangePer),
                                    new XElement("DetAccBudChangePerEntCurr", invertRow ? Decimal.Negate(detAccBudChangePerEntCurr) : detAccBudChangePerEntCurr),
                                    new XElement("DetAccBudChangeToPer", invertRow ? Decimal.Negate(detAccBudChangeToPer) : detAccBudChangeToPer),
                                    new XElement("DetAccBudChangeToPerEntCurr", invertRow ? Decimal.Negate(detAccBudChangeToPerEntCurr) : detAccBudChangeToPerEntCurr),
                                    new XElement("DetAccBudChangeYear", invertRow ? Decimal.Negate(detAccBudChangeYear) : detAccBudChangeYear),
                                    new XElement("DetAccBudChangeYearEntCurr", invertRow ? Decimal.Negate(detAccBudChangeYearEntCurr) : detAccBudChangeYearEntCurr),
                                    new XElement("DetAccGPPer", invertRow ? Decimal.Negate(detAccGPPer) : detAccGPPer),
                                    new XElement("DetAccGPPerEntCurr", invertRow ? Decimal.Negate(detAccGPPerEntCurr) : detAccGPPerEntCurr),
                                    new XElement("DetAccGPToPer", invertRow ? Decimal.Negate(detAccGPToPer) : detAccGPToPer),
                                    new XElement("DetAccGPToPerEntCurr", invertRow ? Decimal.Negate(detAccGPToPerEntCurr) : detAccGPToPerEntCurr),
                                    new XElement("DetAccGPYear", invertRow ? Decimal.Negate(detAccGPYear) : detAccGPYear),
                                    new XElement("DetAccGPYearEntCurr", invertRow ? Decimal.Negate(detAccGPYearEntCurr) : detAccGPYearEntCurr),
                                    new XElement("DetAccGPPrevYearPer", invertRow ? Decimal.Negate(detAccGPPrevYearPer) : detAccGPPrevYearPer),
                                    new XElement("DetAccGPPrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccGPPrevYearPerEntCurr) : detAccGPPrevYearPerEntCurr),
                                    new XElement("DetAccGPToPrevYearPer", invertRow ? Decimal.Negate(detAccGPToPrevYearPer) : detAccGPToPrevYearPer),
                                    new XElement("DetAccGPToPrevYearPerEntCurr", invertRow ? Decimal.Negate(detAccGPToPrevYearPerEntCurr) : detAccGPToPrevYearPerEntCurr),
                                    new XElement("DetAccGPPrevYear", invertRow ? Decimal.Negate(detAccGPPrevYear) : detAccGPPrevYear),
                                    new XElement("DetAccGPPrevYearEntCurr", invertRow ? Decimal.Negate(detAccGPPrevYearEntCurr) : detAccGPPrevYearEntCurr),
                                    new XElement("DetAccBudgetGPPer", invertRow ? Decimal.Negate(detAccBudgetGPPer) : detAccBudgetGPPer),
                                    new XElement("DetAccBudgetGPPerEntCurr", invertRow ? Decimal.Negate(detAccBudgetGPPerEntCurr) : detAccBudgetGPPerEntCurr),
                                    new XElement("DetAccBudgetGPToPer", invertRow ? Decimal.Negate(detAccBudgetGPToPer) : detAccBudgetGPToPer),
                                    new XElement("DetAccBudgetGPToPerEntCurr", invertRow ? Decimal.Negate(detAccBudgetGPToPerEntCurr) : detAccBudgetGPToPerEntCurr),
                                    new XElement("DetAccBudgetGPYear", invertRow ? Decimal.Negate(detAccBudgetGPYear) : detAccBudgetGPYear),
                                    new XElement("DetAccBudgetGPYearEntCurr", invertRow ? Decimal.Negate(detAccBudgetGPYearEntCurr) : detAccBudgetGPYearEntCurr));

                                    accountDetailElements.Add(accountDetailElement);

                                    accountDetailXmlId++;
                                }

                                accountElement.Add(accountDetailElements);

                            }

                            #endregion

                            #endregion
                        }

                        #region XElement ReportHeader

                        #region BalanceReport, ResultReport, SRU

                        XElement headerElement = new XElement("Header",
                            new XAttribute("id", reportHeaderXmlId),
                            new XElement("HeaderName", reportHeader.Name),
                            new XElement("HeaderShowLabel", reportHeader.ShowLabel.ToInt()),
                            new XElement("HeaderShowRows", reportHeader.ShowRow.ToInt()),
                            new XElement("HeaderShowZeroRows", reportHeader.ShowZeroRow.ToInt()),
                            new XElement("HeaderShowSum", reportHeader.ShowSum.ToInt()),
                            new XElement("HeaderInvertRow", reportHeader.InvertRow.ToInt()),
                            new XElement("HeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriod) : headerSumAccountBalancechangePeriod),
                            new XElement("HeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodEntCurrency) : headerSumAccountBalancechangePeriodEntCurrency),
                            new XElement("HeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriod) : headerSumAccountGrossProfitPeriod),
                            new XElement("HeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodEntCurrency) : headerSumAccountGrossProfitPeriodEntCurrency),

                            //Previous Year
                            new XElement("PreviousYearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriod) : headerSumAccountBalancechangePreviousYearPeriod),
                            new XElement("PreviousYearHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountBalancechangePreviousYearPeriodEntCurrency),
                            new XElement("PreviousYearHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriod) : headerSumAccountGrossProfitPreviousYearPeriod),
                            new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                            //Previous Period
                            new XElement("PreviousPeriodMinus1YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus1Year) : headerSumAccountBalancechangePreviousPeriodMinus1Year),
                            new XElement("PreviousPeriodMinus2YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus2Year) : headerSumAccountBalancechangePreviousPeriodMinus2Year),
                            new XElement("PreviousPeriodMinus3YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus3Year) : headerSumAccountBalancechangePreviousPeriodMinus3Year),
                            new XElement("PreviousPeriodMinus4YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus4Year) : headerSumAccountBalancechangePreviousPeriodMinus4Year),
                            new XElement("PreviousPeriodMinus5YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus5Year) : headerSumAccountBalancechangePreviousPeriodMinus5Year),
                            //Budget
                            new XElement("BudgetHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriod) : headerSumBudgetAccountBalancechangePeriod),
                            new XElement("BudgetHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodEntCurrency) : headerSumBudgetAccountBalancechangePeriodEntCurrency));

                        if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport || reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                        {
                            #region BalanceReport, ResultReport

                            headerElement.Add(
                                new XElement("HeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriod) : headerSumAccountBalancechangeToPeriod),
                                new XElement("HeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodEntCurrency) : headerSumAccountBalancechangeToPeriodEntCurrency),
                                new XElement("HeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYear) : headerSumAccountBalancechangeYear),
                                new XElement("HeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYearEntCurrency) : headerSumAccountBalancechangeYearEntCurrency),
                                new XElement("HeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYear) : headerSumAccountGrossProfitYear),
                                new XElement("HeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearEntCurrency) : headerSumAccountGrossProfitYearEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriod) : headerSumAccountBalancechangeToPreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYear) : headerSumAccountBalancechangePreviousYear),
                                new XElement("PreviousYearHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearEntCurrency) : headerSumAccountBalancechangePreviousYearEntCurrency),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriod) : headerSumAccountGrossProfitBalancechangePreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency),

                                //Budget
                                new XElement("BudgetHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriod) : headerSumBudgetAccountBalancechangeToPeriod),
                                new XElement("BudgetHeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodEntCurrency) : headerSumBudgetAccountBalancechangeToPeriodEntCurrency),
                                new XElement("BudgetHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYear) : headerSumBudgetAccountBalancechangeYear),
                                new XElement("BudgetHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYearEntCurrency) : headerSumBudgetAccountBalancechangeYearEntCurrency),
                                new XElement("BudgetHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitPeriod) : headerSumBudgetAccountGrossProfitPeriod),
                                new XElement("BudgetHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYear) : headerSumBudgetAccountGrossProfitYear),
                                new XElement("BudgetHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYearEntCurrency) : headerSumBudgetAccountGrossProfitYearEntCurrency));

                            #endregion

                            if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                            {
                                #region BalanceReport

                                headerElement.Add(
                                    new XElement("HeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalance) : headerSumAccountPeriodInBalance),
                                    new XElement("HeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceEntCurrency) : headerSumAccountPeriodInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalance) : headerSumAccountGrossProfitPeriodInBalance),
                                    new XElement("HeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountYearInBalance) : headerSumAccountYearInBalance),
                                    new XElement("HeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountYearInBalanceEntCurrency) : headerSumAccountYearInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalance) : headerSumAccountGrossProfitYearInBalance),
                                    new XElement("HeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalanceEntCurrency) : headerSumAccountGrossProfitYearInBalanceEntCurrency),
                                    new XElement("HeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalance) : headerSumAccountClosingBalance),
                                    //PreviousYear
                                    new XElement("PreviousYearHeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalance) : headerSumAccountPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearHeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalance) : headerSumAccountGrossProfitPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalance) : headerSumAccountPreviousYearInBalance),
                                    new XElement("PreviousYearHeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalanceEntCurrency) : headerSumAccountPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalance) : headerSumAccountGrossProfitPreviousYearInBalance),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYear) : headerSumAccountClosingBalancePreviousYear),
                                    new XElement("PreviousYearHeaderSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYearEntCurrency) : headerSumAccountClosingBalancePreviousYearEntCurrency));

                                headerElement.Add(
                                    new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                #endregion
                            }
                            else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                            {
                                #region ResultReport

                                headerElement.Add(
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalance) : headerSumAccountBalanceChangeAllPreviousThisYearBalance),
                                    new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                    //Previous Year
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalance) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                    new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency));

                                headerElement.Add(
                                    new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                #endregion
                            }

                            #region BalanceReport, ResultReport

                            foreach (XElement element in accountElementsForHeader)
                            {
                                headerElement.Add(element);
                            }

                            #endregion
                        }
                        else
                        {
                            #region Sru

                            headerElement.Add(new XElement("Account",
                                new XAttribute("id", 1),
                                new XElement("AccountNr", String.Empty),
                                new XElement("AccountName", String.Empty),
                                new XElement("AccountInternalNr1", String.Empty),
                                new XElement("AccountInternalName1", String.Empty),
                                new XElement("AccountInternalNr2", String.Empty),
                                new XElement("AccountInternalName2", String.Empty),
                                new XElement("AccountInternalNr3", String.Empty),
                                new XElement("AccountInternalName3", String.Empty),
                                new XElement("AccountInternalNr4", String.Empty),
                                new XElement("AccountInternalName4", String.Empty),
                                new XElement("AccountInternalNr5", String.Empty),
                                new XElement("AccountInternalName5", String.Empty),
                                new XElement("AccountInternalNr6", String.Empty),
                                new XElement("AccountInternalName6", String.Empty),
                                new XElement("AccountBalancechangePeriod", Decimal.Zero)));

                            #endregion
                        }

                        #endregion

                        #endregion

                        reportHeaderElements.Add(headerElement);
                        reportHeaderXmlId++;
                    }

                    #region XElement ReportGroup

                    //BalanceReport, ResultReport, SRU
                    XElement groupElement = new XElement("Group",
                        new XAttribute("id", reportGroupXmlId),
                        new XElement("GroupName", reportGroup.Name),
                        new XElement("GroupShowLabel", reportGroup.ShowLabel.ToInt()),
                        new XElement("GroupShowSum", reportGroup.ShowSum.ToInt()),
                        new XElement("GroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriod) : groupSumAccountBalancechangePeriod),
                        new XElement("GroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodEntCurrency) : groupSumAccountBalancechangePeriodEntCurrency),
                        new XElement("GroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriod) : groupSumAccountGrossProfitPeriod),
                        new XElement("GroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodEntCurrency) : groupSumAccountGrossProfitPeriodEntCurrency),
                        //PreviousYear
                        new XElement("PreviousYearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriod) : groupSumAccountBalancechangePreviousYearPeriod),
                        new XElement("PreviousYearGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodEntCurrency) : groupSumAccountBalancechangePreviousYearPeriodEntCurrency),
                        new XElement("PreviousYearGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriod) : groupSumAccountGrossProfitPreviousYearPeriod),
                        new XElement("PreviousYearGroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                        //Previous Period
                        new XElement("PreviousPeriodMinus1YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus1Year) : groupSumAccountBalancechangePreviousPeriodYearMinus1Year),
                        new XElement("PreviousPeriodMinus2YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus2Year) : groupSumAccountBalancechangePreviousPeriodYearMinus2Year),
                        new XElement("PreviousPeriodMinus3YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus3Year) : groupSumAccountBalancechangePreviousPeriodYearMinus3Year),
                        new XElement("PreviousPeriodMinus4YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus4Year) : groupSumAccountBalancechangePreviousPeriodYearMinus4Year),
                        new XElement("PreviousPeriodMinus5YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus5Year) : groupSumAccountBalancechangePreviousPeriodYearMinus5Year),
                        //Budget
                        new XElement("BudgetGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriod) : groupSumBudgetAccountBalancechangePeriod),
                        new XElement("BudgetGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodEntCurrency) : groupSumBudgetAccountBalancechangePeriodEntCurrency));

                    //BalanceReport, ResultReport
                    if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2 || reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                    {
                        groupElement.Add(
                            new XElement("GroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriod) : groupSumAccountBalancechangeToPeriod),
                            new XElement("GroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodEntCurrency) : groupSumAccountBalancechangeToPeriodEntCurrency),
                            new XElement("GroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYear) : groupSumAccountBalancechangeYear),
                            new XElement("GroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYearEntCurrency) : groupSumAccountBalancechangeYearEntCurrency),
                            new XElement("GroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYear) : groupSumAccountGrossProfitYear),
                            new XElement("GroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearEntCurrency) : groupSumAccountGrossProfitYearEntCurrency),
                            //PreviousYear
                            new XElement("PreviousYearGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriod) : groupSumAccountBalancechangeToPreviousYearPeriod),
                            new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency),
                            new XElement("PreviousYearGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYear) : groupSumAccountBalancechangePreviousYear),
                            new XElement("PreviousYearGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearEntCurrency) : groupSumAccountBalancechangePreviousYearEntCurrency),
                            new XElement("PreviousYearGroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYear) : groupSumAccountGrossProfitPreviousYear),
                            new XElement("PreviousYearGroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearEntCurrency) : groupSumAccountGrossProfitPreviousYearEntCurrency),
                            //Budget
                            new XElement("BudgetGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriod) : groupSumBudgetAccountBalancechangeToPeriod),
                            new XElement("BudgetGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodEntCurrency),
                            new XElement("BudgetGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYear) : groupSumBudgetAccountBalancechangeYear),
                            new XElement("BudgetGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYearEntCurrency) : groupSumBudgetAccountBalancechangeYearEntCurrency),
                            new XElement("BudgetGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitPeriod) : groupSumBudgetAccountGrossProfitPeriod));


                        //BalanceReport
                        if (reportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                        {
                            #region BalanceReport

                            groupElement.Add(
                                new XElement("GroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalance) : groupSumAccountPeriodInBalance),
                                new XElement("GroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceEntCurrency) : groupSumAccountPeriodInBalanceEntCurrency),
                                new XElement("GroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalance) : groupSumAccountGrossProfitPeriodInBalance),
                                new XElement("GroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                new XElement("GroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountYearInBalance) : groupSumAccountYearInBalance),
                                new XElement("GroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountYearInBalanceEntCurrency) : groupSumAccountYearInBalanceEntCurrency),
                                new XElement("GroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                new XElement("GroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalanceEntCurrency) : groupSumAccountGrossProfitYearInBalanceEntCurrency),
                                new XElement("GroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalance) : groupSumAccountClosingBalance),
                                new XElement("GroupSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceEntCurrency) : groupSumAccountClosingBalanceEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearGroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalance) : groupSumAccountPreviousYearPeriodInBalance),
                                new XElement("PreviousYearGroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalance) : groupSumAccountGrossProfitPreviousYearPeriodInBalance),
                                new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalance) : groupSumAccountPreviousYearInBalance),
                                new XElement("PreviousYearGroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalanceEntCurrency) : groupSumAccountPreviousYearInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalancePreviousYear) : groupSumAccountClosingBalancePreviousYear));

                            #endregion
                        }
                        else if (reportResult.ReportTemplateType == SoeReportTemplateType.ResultReportV2)
                        {
                            #region ResultReport

                            groupElement.Add(
                                new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalance) : groupSumAccountBalanceChangeAllPreviousThisYearBalance),
                                new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalance) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency));


                            #endregion
                        }
                    }

                    //Add ReportHeaders to ReportGroup
                    foreach (XElement element in reportHeaderElements)
                    {
                        groupElement.Add(element);
                    }

                    #endregion

                    sheetElement.Add(groupElement);
                    reportGroupXmlId++;
                }

                reportElement.Add(sheetElement);
                #region
                #endregion
            }

            return result;
        }

        private List<AccountAndInternalAccountComboDTO> CreateAccountAndInternalAccountComboDTO(int accountId, List<VoucherHeadDTO> voucherHeadDTOs, List<AccountAndInternalAccountComboDTO> comboDTOs, List<AccountDimDTO> accountDimInternals, List<AccountInternalDTO> accountInternalsInInterval)
        {
            foreach (var head in voucherHeadDTOs)
            {
                foreach (var row in head.Rows)
                {
                    if (row.Dim1Id != accountId)
                        continue;

                    bool valid = AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, row.AccountInternalDTO_forReports);

                    if (valid)
                    {
                        AccountAndInternalAccountComboDTO comboDTO = new AccountAndInternalAccountComboDTO();

                        comboDTO.Dim1Id = row.Dim1Id;
                        comboDTO.Dim1Name = row.Dim1Name;
                        comboDTO.Dim1Nr = row.Dim1Nr;
                        comboDTO.Dim2Id = row.Dim2Id;
                        comboDTO.Dim2Name = row.Dim2Name;
                        comboDTO.Dim2Nr = row.Dim2Nr;
                        comboDTO.Dim3Id = row.Dim3Id;
                        comboDTO.Dim3Name = row.Dim3Name;
                        comboDTO.Dim3Nr = row.Dim3Nr;
                        comboDTO.Dim4Id = row.Dim4Id;
                        comboDTO.Dim4Name = row.Dim4Name;
                        comboDTO.Dim4Nr = row.Dim4Nr;
                        comboDTO.Dim5Id = row.Dim5Id;
                        comboDTO.Dim5Name = row.Dim5Name;
                        comboDTO.Dim5Nr = row.Dim5Nr;
                        comboDTO.Dim6Id = row.Dim6Id;
                        comboDTO.Dim6Name = row.Dim6Name;
                        comboDTO.Dim6Nr = row.Dim6Nr;

                        //Compare : If combo doesn't exist add.

                        if (!comboDTOs.Any(d => d.Dim2Id == row.Dim2Id && d.Dim3Id == row.Dim3Id && d.Dim4Id == row.Dim4Id && d.Dim5Id == row.Dim5Id && d.Dim6Id == row.Dim6Id))
                            comboDTOs.Add(comboDTO);
                    }

                }
            }


            return comboDTOs;
        }

        private KeyValuePair<decimal, decimal> GetValuefromAccountAndInternalAccountCombo(int accountId, AccountAndInternalAccountComboDTO comboDTO, List<VoucherHeadDTO> voucherHeadDTOs, List<AccountDimDTO> accountDimInternals, List<AccountInternalDTO> accountInternalsInInterval)
        {
            decimal amount = decimal.Zero;
            decimal amountEntCurrency = decimal.Zero;

            foreach (var head in voucherHeadDTOs)
            {
                foreach (var row in head.Rows)
                {
                    if (row.Dim1Id != accountId)
                        continue;

                    bool valid = AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, row.AccountInternalDTO_forReports);

                    if (valid)
                    {
                        if (comboDTO.Dim2Id == row.Dim2Id && comboDTO.Dim3Id == row.Dim3Id && comboDTO.Dim4Id == row.Dim4Id && comboDTO.Dim5Id == row.Dim5Id && comboDTO.Dim6Id == row.Dim6Id)
                        {
                            amount += row.Amount;
                            amountEntCurrency += row.AmountEntCurrency;
                        }
                    }
                }
            }

            return new KeyValuePair<decimal, decimal>(amount, amountEntCurrency);
        }

        #endregion

        #region PrivateClasses
        private class AccountAccruals
		{
			public string AccountNr { get; set; }
			public decimal PeriodAmount { get; set; }
			public decimal AccumulatedAmount { get; set; }
			public decimal TotalAmount { get; set; }
		}
		#endregion
	}

	public class EconomyReportParamsDTO
    {
        private readonly ParameterObject paramObject;
        private InventoryManager im;
        private CategoryManager cm;

        public bool IsSameYear { get; set; }
        public int AccountYearId { get; set; }

        public string AccountPeriodFromText { get; set; }
        public string LongAccountYearFromText { get; set; }
        public string LongAccountYearToText { get; set; }

        public string PreviousAccountYearFromText { get; set; }
        public string PreviousAccountYearToText { get; set; }

        public AccountYear AccountYear { get; set; }
        public AccountYear AccountYearTo { get; set; }
        public DateTime DateFrom { get; set; }
        public DateTime DateTo { get; set; }

        public bool ProjectReport;
        public bool SSTD_IncludeExternalVouchers;
        public bool SSTD_IncludeYearEndVouchers;
        public int? SSTD_AccountDimIdNullable;
        public int SSTD_AccountDimId;
        public bool ShowRowsByAccount;

        public bool SSTD_IncludeMissingAccountDim { get; set; }

        public bool SSTD_SeparateAccountDim { get; set; }
        public bool IncludeAllHistoricalData { get; set; }
        public int? SSTD_BudgetId { get; set; }
        public int NoOfYearsBackinPreviousYear { get; set; }
        public bool IncludeBudget { get; set; }

        public bool SeparateAccountDim;
        public int? AccountDimId;

        public bool HasVoucherSeriesTypeNrInterval;
        public int VoucherSeriesTypeNrFrom { get; set; }
        public int VoucherSeriesTypeNrTo { get; set; }
        public bool HasVoucherSeriesTypeSelection;
        public List<int> VoucherSeriesTypeSelection { get; set; }
        public string SSTD_AccountYearFromText { get; set; }
        public string SSTD_LongAccountYearFromText { get; set; }
        public string SSTD_AccountYearToText { get; set; }
        public string SSTD_LongAccountYearToText { get; set; }
        public bool SSTD_HasAccountYearText { get; set; }

        public string SSTD_PreviousAccountYearFromText { get; set; }
        public string SSTD_PreviousAccountYearToText { get; set; }
        public int SSTD_AccountYearId { get; set; }

        public CreateReportResult ReportResult { get; set; }

        public bool? OnlyActiveAccounts { get; set; }
        public bool SV_IsAccountingOrder { get; set; }
        public bool SV_HasVoucherNrInterval { get; set; }
        public int SV_VoucherNrFrom;
        public int SV_VoucherNrTo;
        public bool SV_HasVoucherSeriesTypeNrInterval { get; set; }
        public int SV_VoucherSeriesTypeNrTo;
        public int SV_VoucherSeriesTypeNrFrom;
        public bool HasDateInterval { get; set; }
        public bool SV_HasVoucherHeadIds { get; set; }
        public IEnumerable<int> SV_VoucherHeadIds { get; set; }
        public List<AccountIntervalDTO> SA_AccountIntervals { get; set; }
        public bool SL_IncludeCashSalesInvoices { get; set; }

        //*****************************************************//

        public bool SA_HasAccountInterval { get; set; }
        public int SL_SortOrder { get; set; }
        public int SL_DateRegard { get; set; }
        public bool SL_ShowVoucher { get; set; }
        public bool SL_ShowPendingPaymentsInReport { get; set; }
        public bool SL_ShowPreliminaryInvoices { get; set; }
        public bool SL_HasInvoiceSeqNrInterval { get; set; }
        public bool SL_HasInvoiceIds { get; set; }
        public IEnumerable<int> SL_InvoiceIds { get; set; }
        public List<int> SL_PaymentRowIds { get; set; }
        public bool SL_HasActorNrInterval { get; set; }
        public string SL_ActorNrFrom { get; set; }
        public string SL_ActorNrTo { get; set; }
        public int SL_InvoiceSelection { get; set; }
        public SoeReportTemplateType ReportTemplateType { get; set; }
        public int? SL_InvoiceSeqNrFrom { get; set; }
        public int? SL_InvoiceSeqNrTo { get; set; }

        public bool SSTD_CreateVatVoucher { get; set; }
        public int SFA_PrognoseType { get; set; }
        public string SFA_CategoryFrom { get; set; }
        public string SFA_CategoryTo { get; set; }
        public bool SFA_HasCategoryInterval { get; set; }
        public string SFA_InventoryTo { get; set; }
        public string SFA_InventoryFrom { get; set; }
        public int SFA_InventoryAccountTo { get; set; }
        public int SFA_InventoryAccountFrom { get; set; }
        public bool SFA_HasInventoryInterval { get; set; }
        public bool SFA_HasInventoryAccountInterval { get; set; }
        public string ReportSelectionText { get; set; }
        public bool SFA_IsEvaluated { get; set; }
        public bool SB_IncludeOnlyInvoiced { get; set; }
        public List<int> SB_InvoiceIds { get; set; }
        public TermGroup_ReportGroupAndSortingTypes SortByLevel1 { get; set; }
        public TermGroup_ReportGroupAndSortingTypes SortByLevel2 { get; set; }
        public TermGroup_ReportGroupAndSortingTypes SortByLevel3 { get; set; }
        public TermGroup_ReportGroupAndSortingTypes SortByLevel4 { get; set; }
        public bool IsSortAscending { get; set; }
        public string Special { get; set; }
        public TermGroup_ReportGroupAndSortingTypes GroupByLevel1 { get; set; }
        public TermGroup_ReportGroupAndSortingTypes GroupByLevel2 { get; set; }
        public TermGroup_ReportGroupAndSortingTypes GroupByLevel3 { get; set; }
        public TermGroup_ReportGroupAndSortingTypes GroupByLevel4 { get; set; }

        public List<AccountFilterSelectionDTO> accountFilters;

        public List<int> SI_VoucherHeadIOIds { get; set; }
        public EconomyReportParamsDTO(ParameterObject pm, AccountManager am, CreateReportResult reportResult, CompEntities entity, BaseReportDataManager baseReportMgr)
        {
            paramObject = pm;

            ReportTemplateType = reportResult.ReportTemplateType;

            List<int> voucherHeadIds;
            baseReportMgr.TryGetIdsFromSelection(
                reportResult, out voucherHeadIds, "voucherHeadIds");

            if (voucherHeadIds.Count > 0)
            {
                SV_VoucherHeadIds = voucherHeadIds;
                SV_HasVoucherHeadIds = true;
            }

            List<int> invoiceIds;
            baseReportMgr.TryGetIdsFromSelection(
                reportResult, out invoiceIds, "invoiceIds");

            if (invoiceIds.Count > 0)
            {
                SL_InvoiceIds = invoiceIds;
                SL_HasInvoiceIds = true;
            }

            List<int> paymentRowIds;
            baseReportMgr.TryGetIdsFromSelection(
                reportResult, out paymentRowIds, "paymentRowIds");

            if (paymentRowIds.Count > 0)
            {
                SL_PaymentRowIds = paymentRowIds;
            }

            List<int> voucherHeadIOIds;
            baseReportMgr.TryGetIdsFromSelection(
                reportResult, out voucherHeadIOIds, "voucherHeadIOIds");

            if (voucherHeadIOIds.Count > 0)
            {
                SI_VoucherHeadIOIds = voucherHeadIOIds;
            }

            bool isAccountingOrder;

            baseReportMgr.TryGetBoolFromSelection(
                reportResult,out isAccountingOrder, "isAccountingOrder");
            SV_IsAccountingOrder = isAccountingOrder;

            NoOfYearsBackinPreviousYear = reportResult.Input.Report.NoOfYearsBackinPreviousYear;
            IncludeBudget = reportResult.Input.Report.IncludeBudget;
            IncludeAllHistoricalData = reportResult.Input.Report.IncludeAllHistoricalData;
            //reportParams.SB_IncludeOnlyInvoiced = es.SB_IncludeOnlyInvoiced;
            //reportParams.SB_InvoiceIds = es.SB_InvoiceIds;
            //reportParams.ST_TimePeriodId = es.ST_TimePeriodId;
            SortByLevel1 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.SortByLevel1.ToString());
            SortByLevel2 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.SortByLevel2.ToString());
            SortByLevel3 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.SortByLevel3.ToString());
            SortByLevel4 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.SortByLevel4.ToString());
            IsSortAscending = reportResult.Input.Report.IsSortAscending;
            GroupByLevel1 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.GroupByLevel1.ToString());
            GroupByLevel2 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.GroupByLevel2.ToString());
            GroupByLevel3 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.GroupByLevel3.ToString());
            GroupByLevel4 = (TermGroup_ReportGroupAndSortingTypes)Enum.Parse(typeof(TermGroup_ReportGroupAndSortingTypes), reportResult.Input.Report.GroupByLevel4.ToString());
            Special = reportResult.Input.Report.Special;
            DateTime selectionDateFrom = DateTime.MinValue;
            DateTime selectionDateTo = DateTime.MinValue;
            ReportResult = reportResult;
            int? voucherSeriesIdFrom;
            int? voucherSeriesIdTo;
            string voucherSeriesNumberIdFrom;
            string voucherSeriesNumberIdTo;
            string reportSelectionText;
            int vouNoFrom = 0;
            int vouNoTo = 0;

            int? invoiceSeqNoFrom = 0;
            int? invoiceSeqNoTo = 0;

            int? invoiceSelection;
            int? dateRegard;
            int? sortOrder;
            string actorNrFrom;
            string actorNrTo;
            bool showVoucher;
            bool showPendingPaymentsInReport;
            bool showPreliminaryInvoices;
            bool includeCashSalesInvoices;
            bool dateSelectionChoosed;
            bool createVatVoucher;

            int? inventoryFrom;
            int? inventoryTo;
            int? inventoryAccountFrom;
            int? inventoryAccountTo;
            int? categoryFrom;
            int? categoryTo;
            int? prognoseType;
            int? budgetId;

            List<int> voucherSeriesSelection;

            baseReportMgr.TryGetBoolFromSelection(reportResult, out dateSelectionChoosed, "dateSelectionChoosen");

            baseReportMgr.TryGetIdFromSelection(reportResult, out AccountDimId, "accountDimId");

            baseReportMgr.TryGetIdFromSelection(reportResult, out SSTD_AccountDimIdNullable, "postingDimension");
            SSTD_AccountDimId = SSTD_AccountDimIdNullable.HasValue ? SSTD_AccountDimIdNullable.Value : 0;
            baseReportMgr.TryGetBoolFromSelection(reportResult, out SeparateAccountDim, "separateAccountDim");
            SSTD_SeparateAccountDim = SeparateAccountDim;
            baseReportMgr.TryGetBoolFromSelection(reportResult, out ProjectReport, "projectSelectionChoosen");

            baseReportMgr.TryGetBoolFromSelection(reportResult, out SSTD_IncludeExternalVouchers, "includeexternalvouchers");
            baseReportMgr.TryGetBoolFromSelection(reportResult, out SSTD_IncludeYearEndVouchers, "includeyearendvouchers");
            baseReportMgr.TryGetBoolFromSelection(reportResult, out ShowRowsByAccount, "showrowsbyaccount");

            baseReportMgr.TryGetIdFromSelection(reportResult, out voucherSeriesIdFrom, "voucherSeriesFrom");
            baseReportMgr.TryGetIdFromSelection(reportResult, out voucherSeriesIdTo, "voucherSeriesTo");
            baseReportMgr.TryGetTextFromSelection(reportResult, out voucherSeriesNumberIdFrom, "voucherSeriesNumberFrom");
            baseReportMgr.TryGetTextFromSelection(reportResult, out voucherSeriesNumberIdTo, "voucherSeriesNumberTo");
            baseReportMgr.TryGetTextFromSelection(reportResult, out reportSelectionText, "reportSelectionText");


            baseReportMgr.TryGetIdFromSelection(reportResult, out dateRegard, "dateRegard");
            baseReportMgr.TryGetIdFromSelection(reportResult, out sortOrder, "sortOrder");

            baseReportMgr.TryGetIdFromSelection(reportResult, out budgetId, "budget");

            baseReportMgr.TryGetIdFromSelection(reportResult, out invoiceSelection, "invoiceSelection");

            baseReportMgr.TryGetTextFromSelection(reportResult, out actorNrFrom, "actorNrFrom");
            baseReportMgr.TryGetTextFromSelection(reportResult, out actorNrTo, "actorNrTo");

            baseReportMgr.TryGetIdFromSelection(reportResult, out invoiceSeqNoFrom, "invoiceSeqNrFrom");
            baseReportMgr.TryGetIdFromSelection(reportResult, out invoiceSeqNoTo, "invoiceSeqNrTo");

            baseReportMgr.TryGetBoolFromSelection(reportResult, out showVoucher, "showVoucher");
            baseReportMgr.TryGetBoolFromSelection(reportResult, out showPendingPaymentsInReport, "showPendingPaymentsInReport");

            baseReportMgr.TryGetBoolFromSelection(reportResult, out showPreliminaryInvoices, "showPreliminaryInvoices");
            baseReportMgr.TryGetBoolFromSelection(reportResult, out includeCashSalesInvoices, "includeCashSalesInvoices");
            baseReportMgr.TryGetBoolFromSelection(reportResult, out createVatVoucher, "createVatVoucher");

            baseReportMgr.TryGetAccountFilters(reportResult, out accountFilters, "namedFilterRanges");

            baseReportMgr.TryGetIdsFromSelection(reportResult, out voucherSeriesSelection, "voucherSeries");
            if (voucherSeriesSelection != null && voucherSeriesSelection.Count > 0)
                HasVoucherSeriesTypeSelection = true;

            var accountIntervals = accountFilters.Select(x => new AccountIntervalDTO() { AccountDimId = x.Id, AccountNrFrom = x.From, AccountNrTo = x.To }).ToList();
            SA_AccountIntervals = new List<AccountIntervalDTO>();
            foreach (var accountInterval in accountIntervals)
            {
                if (!(accountInterval.AccountNrFrom.IsNullOrEmpty() && accountInterval.AccountNrTo.IsNullOrEmpty()))
                {
                    SA_AccountIntervals.Add(accountInterval);
                }
            }
            if (SA_AccountIntervals.Count > 0)
            {
                SA_HasAccountInterval = true;
            }

            baseReportMgr.TryGetIdFromSelection(reportResult, out inventoryFrom, "inventoryFrom");
            baseReportMgr.TryGetIdFromSelection(reportResult, out inventoryTo, "inventoryTo");
            baseReportMgr.TryGetIdFromSelection(reportResult, out inventoryAccountFrom, "inventoryAccountFrom");
            baseReportMgr.TryGetIdFromSelection(reportResult, out inventoryAccountTo, "inventoryAccountTo");
            baseReportMgr.TryGetIdFromSelection(reportResult, out categoryFrom, "categoryFrom");
            baseReportMgr.TryGetIdFromSelection(reportResult, out categoryTo, "categoryTo");
            baseReportMgr.TryGetIdFromSelection(reportResult, out prognoseType, "prognoseType");


            if (ReportResult.ReportTemplateType == SoeReportTemplateType.FixedAssets)
            {

                im = new InventoryManager(paramObject);
                cm = new CategoryManager(paramObject);

                if ((inventoryFrom.HasValue && !String.IsNullOrEmpty(inventoryFrom.Value.ToString()) && inventoryFrom.Value.ToString() != "0") || (inventoryTo.HasValue && !String.IsNullOrEmpty(inventoryTo.Value.ToString()) && inventoryTo.Value.ToString() != "0"))
                {
                    int invIdFrom = 0;
                    if (Int32.TryParse(inventoryFrom.Value.ToString(), out invIdFrom) && invIdFrom > 0)
                    {
                        SFA_InventoryFrom = im.GetInventoryNumber(entity, invIdFrom);
                    }
                    int invIdTo = 0;
                    if (Int32.TryParse(inventoryTo.Value.ToString(), out invIdTo) && invIdTo > 0)
                    {
                        SFA_InventoryTo = im.GetInventoryNumber(entity, invIdTo);
                    }
                    SFA_HasInventoryInterval = true;
                }
                else
                    SFA_HasInventoryInterval = false;

                if ((inventoryAccountFrom.GetValueOrDefault() != 0) || (inventoryAccountTo.GetValueOrDefault() != 0))
                {
                    int invIdAccountFrom = inventoryAccountFrom.GetValueOrDefault();
                    if (invIdAccountFrom > 0)
                    {
                        SFA_InventoryAccountFrom = invIdAccountFrom;
                    }
                    int invIdAccountTo = inventoryAccountTo.GetValueOrDefault();
                    if (invIdAccountTo > 0)
                    {
                        SFA_InventoryAccountTo = invIdAccountTo;
                    }
                    SFA_HasInventoryAccountInterval = true;
                }
                else
                    SFA_HasInventoryAccountInterval = false;

                if (
                     (categoryFrom.GetValueOrDefault() != 0) || (categoryTo.GetValueOrDefault() != 0)
                   )
                {
                    int catIdFrom = categoryFrom.GetValueOrDefault();
                    if (catIdFrom > 0)
                    {
                        SFA_CategoryFrom = cm.GetCategoryCode(entity, catIdFrom, reportResult.ActorCompanyId);
                    }
                    int catIdTo = categoryTo.GetValueOrDefault();
                    if (catIdTo > 0)
                    {
                        SFA_CategoryTo = cm.GetCategoryCode(entity, catIdTo, reportResult.ActorCompanyId);
                    }

                    SFA_HasCategoryInterval = true;

                }
                else
                    SFA_HasCategoryInterval = false;
                if (prognoseType.HasValue)
                {
                    SFA_PrognoseType = prognoseType.Value;
                }
                if (reportResult.ReportTemplateType == SoeReportTemplateType.FixedAssets)
                {
                    SFA_IsEvaluated = true;
                }
            }

            if (!String.IsNullOrEmpty(actorNrFrom) && (!String.IsNullOrEmpty(actorNrTo)))
            {
                SL_ActorNrFrom = actorNrFrom;
                SL_ActorNrTo = actorNrTo;
                SL_HasActorNrInterval = true;
            }

            SL_InvoiceSelection = invoiceSelection.HasValue ? invoiceSelection.Value : 0;
            SL_DateRegard = dateRegard.HasValue ? dateRegard.Value : 0;
            SL_SortOrder = sortOrder.HasValue ? sortOrder.Value : 0;

            SSTD_BudgetId = budgetId;

            SL_InvoiceSeqNrFrom = invoiceSeqNoFrom.GetValueOrDefault();
            SL_InvoiceSeqNrTo = invoiceSeqNoTo.GetValueOrDefault();
            if (SL_InvoiceSeqNrFrom > 0 || SL_InvoiceSeqNrTo > 0)
            {
                SL_HasInvoiceSeqNrInterval = true;
            }
            SV_VoucherSeriesTypeNrFrom = voucherSeriesIdFrom.HasValue ? voucherSeriesIdFrom.Value : 0;
            VoucherSeriesTypeNrFrom = voucherSeriesIdFrom.HasValue ? voucherSeriesIdFrom.Value : 0;
            SV_VoucherSeriesTypeNrTo = voucherSeriesIdTo.HasValue ? voucherSeriesIdTo.Value : 0;
            VoucherSeriesTypeNrTo = voucherSeriesIdTo.HasValue ? voucherSeriesIdTo.Value : 0;
            SV_VoucherNrFrom = int.TryParse(voucherSeriesNumberIdFrom, out vouNoFrom) ? vouNoFrom : 0;
            SV_VoucherNrTo = int.TryParse(voucherSeriesNumberIdTo, out vouNoTo) ? vouNoTo : 0;
            SL_ShowVoucher = showVoucher;
            SL_ShowPendingPaymentsInReport = showPendingPaymentsInReport;
            SL_ShowPreliminaryInvoices = showPreliminaryInvoices;
            SL_IncludeCashSalesInvoices = includeCashSalesInvoices;
            SSTD_CreateVatVoucher = createVatVoucher;

            SV_HasVoucherSeriesTypeNrInterval = voucherSeriesIdFrom.HasValue || voucherSeriesIdTo.HasValue;
            HasVoucherSeriesTypeNrInterval = voucherSeriesIdFrom.HasValue || voucherSeriesIdTo.HasValue;
            SV_HasVoucherNrInterval = SV_VoucherNrFrom != 0 || SV_VoucherNrTo != 0;
            SSTD_IncludeMissingAccountDim = ProjectReport;
            VoucherSeriesTypeSelection = voucherSeriesSelection;

            //if ((ReportResult.ReportTemplateType != SoeReportTemplateType.ResultReport && ReportResult.ReportTemplateType != SoeReportTemplateType.ResultReportV2) && IncludeBudget)
            //{
            //    //budget 
            //}


            List<int> selectionTimePeriodIds = new List<int>();

            if (dateSelectionChoosed)
            {
                if (baseReportMgr.TryGetDatesFromSelection(reportResult, out selectionDateFrom, out selectionDateTo))
                {
                    AccountYear = am.GetAccountYear(selectionDateFrom, reportResult.ActorCompanyId);
                    AccountYearTo = am.GetAccountYear(selectionDateTo, reportResult.ActorCompanyId);
                }
            }
            else
            {
                AccountIntervalSelectionDTO rangeFrom = null;
                AccountIntervalSelectionDTO rangeTo = null;

                baseReportMgr.TryGetAccountIntervalSelectionRange(reportResult, out rangeFrom, "accountPeriodFrom");
                baseReportMgr.TryGetAccountIntervalSelectionRange(reportResult, out rangeTo, "accountPeriodTo");
                int rangeFromId = rangeFrom != null ? rangeFrom.Value.Value : 0;
                int rangeToId = rangeTo != null ? rangeTo.Value.Value : 0;
                if (rangeFromId != 0 && rangeToId != 0)
                {
                    selectionTimePeriodIds.Add(rangeFromId);
                    selectionTimePeriodIds.Add(rangeToId);
                    var selectedTimePeriods = entity.AccountPeriod.Where(w => selectionTimePeriodIds.Contains(w.AccountPeriodId)).OrderBy(o => o.From).ToList();
                    selectionDateFrom = selectedTimePeriods.First().From;
                    selectionDateTo = selectedTimePeriods.Last().To;
                    AccountYear = am.GetAccountYear(selectionDateFrom, reportResult.ActorCompanyId);
                    AccountYearTo = am.GetAccountYear(selectionDateTo, reportResult.ActorCompanyId);
                }
                else if (rangeFrom != null && rangeTo != null)
                {
                    selectionTimePeriodIds.Add(rangeFromId);
                    selectionTimePeriodIds.Add(rangeToId);

                    AccountYear = am.GetAccountYear(rangeFrom.YearId.Value, true);
                    AccountYearTo = am.GetAccountYear(rangeTo.YearId.Value, true);

                    var selectedTimePeriods = entity.AccountPeriod.Where(w => selectionTimePeriodIds.Contains(w.AccountPeriodId)).OrderBy(o => o.From).ToList();

                    if (rangeFrom.YearId.Value != 0 && rangeFromId > 0 && selectedTimePeriods.Any())
                    {
                        selectionDateFrom = selectedTimePeriods.FirstOrDefault().From;
                    }
                    else if (AccountYear != null && rangeFromId == 0)
                    {
                        selectionDateFrom = AccountYear.From;
                    }
                    else
                    {
                        if (AccountYear != null)
                        {
                            selectionDateFrom = AccountYear.From;
                        }
                        else
                        {
                            selectionDateFrom = CalendarUtility.DATETIME_DEFAULT;
                        }
                    }

                    if (rangeTo.YearId.Value != 0 && rangeToId > 0 && selectedTimePeriods.Any())
                    {
                        selectionDateTo = selectedTimePeriods.Last().To;
                    }
                    else if (AccountYearTo != null && rangeToId == 0)
                    {
                        selectionDateTo = AccountYearTo.To;
                    }
                    else
                    {
                        if (AccountYearTo != null)
                        {
                            selectionDateTo = AccountYearTo.To;
                        }
                        else
                        {
                            selectionDateTo = CalendarUtility.DATETIME_MAXVALUE;
                        }

                    }
                }
                else
                {
                    baseReportMgr.TryGetDatesFromSelection(reportResult, out selectionDateFrom, out selectionDateTo);

                    //if (baseReportMgr.TryGetDatesFromSelection(reportResult, out selectionDateFrom, out selectionDateTo))
                    //{
                    //    if (string.Compare(selectionDateFrom.Date.ToString("yyyyMMdd"), selectionDateTo.Date.ToString("yyyyMMdd")) < 0)
                    //    {
                    //        HasDateInterval = true;
                    //    }
                    //}
                }
            }

            if (!((selectionDateFrom.Date == CalendarUtility.DATETIME_DEFAULT.Date && selectionDateTo.Date == CalendarUtility.DATETIME_DEFAULT.Date) ||
            (selectionDateFrom.Date == CalendarUtility.DATETIME_MINVALUE.Date && selectionDateTo.Date == CalendarUtility.DATETIME_MAXVALUE.Date) ||
            (selectionDateFrom.Date == CalendarUtility.DATETIME_MINVALUE.Date && selectionDateTo.Date == CalendarUtility.DATETIME_0VALUE.Date)
            ))
            {
                HasDateInterval = true;
            }

            DateFrom = selectionDateFrom.Date;
            DateTo = selectionDateTo.Date;

            if (ReportResult.ReportTemplateType == SoeReportTemplateType.SupplierPaymentJournal)
            {
                HasDateInterval = true;
                if (DateFrom == DateTo)
                {
                    DateTo = selectionDateTo.GetLastMinuteOfDay();
                }
            }

            IsSameYear = AccountYear != null && AccountYearTo != null && AccountYear.AccountYearId == AccountYearTo.AccountYearId;


            if (AccountYear != null && AccountYearTo != null)
            {
                SSTD_AccountYearFromText = GetShortDateStringFromCulture(AccountYear.From);
                SSTD_LongAccountYearFromText = GetLongDateStringFromCulture(AccountYear.From);
                LongAccountYearFromText = GetLongDateStringFromCulture(AccountYear.From);

                SSTD_AccountYearToText = GetShortDateStringFromCulture(AccountYearTo.To);
                SSTD_LongAccountYearToText = GetLongDateStringFromCulture(AccountYearTo.To);
                LongAccountYearToText = GetLongDateStringFromCulture(AccountYearTo.To);
            }
            else
            {
                if (AccountYear != null)
                {
                    SSTD_AccountYearFromText = GetShortDateStringFromCulture(DateFrom);
                    SSTD_LongAccountYearFromText = GetLongDateStringFromCulture(DateFrom);
                    LongAccountYearFromText = GetLongDateStringFromCulture(DateFrom);
                }
                else
                {
                    SSTD_AccountYearFromText = null;
                    SSTD_LongAccountYearFromText = null;
                    LongAccountYearFromText = null;
                }

                SSTD_AccountYearToText = GetShortDateStringFromCulture(DateTo);
                SSTD_LongAccountYearToText = GetLongDateStringFromCulture(DateTo);
                LongAccountYearToText = GetLongDateStringFromCulture(DateTo);
            }

            #region PreviousAccountYear

            if (IsSameYear)
            {
                if (AccountYearTo != null)
                {
                    SSTD_AccountYearId = AccountYearTo.AccountYearId;
                    AccountYearId = AccountYearTo.AccountYearId;
                }
            }
            else
            {
                if (AccountYear != null)
                {
                    SSTD_AccountYearId = AccountYear.AccountYearId;
                    AccountYearId = AccountYear.AccountYearId;
                }
            }

            if (AccountYear != null)
            {
                AccountYear accountYear = am.GetAccountYear(AccountYear.AccountYearId, false);
                AccountYear previousaccountYear = am.GetPreviousAccountYear(accountYear, false);
                if (previousaccountYear != null)
                {
                    SSTD_PreviousAccountYearFromText = GetLongDateStringFromCulture(previousaccountYear.From.Date);
                    SSTD_PreviousAccountYearToText = GetLongDateStringFromCulture(previousaccountYear.To.Date);
                    PreviousAccountYearFromText = SSTD_PreviousAccountYearFromText;
                    PreviousAccountYearToText = SSTD_PreviousAccountYearToText;
                }
            }

            #endregion

            SSTD_HasAccountYearText = !String.IsNullOrEmpty(SSTD_AccountYearFromText) && !String.IsNullOrEmpty(SSTD_AccountYearToText);
        }

        public string GetAccountYearIntervalText()
        {
            string text = "";
            if (SSTD_HasAccountYearText)
                text = SSTD_AccountYearFromText + "-" + SSTD_AccountYearToText;
            //if (ReportResult.ReportTemplateType == SoeReportTemplateType.ResultReport || ReportResult.ReportTemplateType == SoeReportTemplateType.BalanceReport)
            //{
            //    if (SSTD_HasAccountYearText)
            //        text = SSTD_AccountYearFromText + "-" + SSTD_AccountYearToText;
            //}
            //else
            //{
            //    if (AccountYear != null)
            //        text = GetShortDateStringFromCulture(AccountYear.From) + "-" + GetShortDateStringFromCulture(AccountYear.To);
            //}
            return text;
        }

        private string GetShortDateStringFromCulture(DateTime dateTime)
        {
            string dateString = dateTime.ToString("yyyyMM");

            if (CultureInfo.CurrentCulture != null)
            {
                switch (CultureInfo.CurrentCulture.TwoLetterISOLanguageName)
                {
                    case "da":
                        dateString = dateTime.ToString("MM.yyyy");
                        break;
                    case "fi":
                        dateString = dateTime.ToString("M.yyyy");
                        break;
                    case "nb":
                        dateString = dateTime.ToString("MM.yyyy");
                        break;
                    case "en":
                        dateString = dateTime.ToString("M/yyyy");
                        break;
                }
            }

            return dateString;
        }

        private string GetLongDateStringFromCulture(DateTime dateTime)
        {
            string dateString = dateTime.ToString("yyyyMMdd");

            if (CultureInfo.CurrentCulture != null)
            {
                switch (CultureInfo.CurrentCulture.TwoLetterISOLanguageName)
                {
                    case "da":
                        dateString = dateTime.ToString("dd.MM.yyyy");
                        break;
                    case "fi":
                        dateString = dateTime.ToString("dd.MM.yyyy");
                        break;
                    case "nb":
                        dateString = dateTime.ToString("dd.MM.yyyy");
                        break;
                    case "en":
                        dateString = dateTime.ToString("d/M/yyyy");
                        break;
                }
            }

            return dateString;
        }

        public DateTime UntilDateFrom()
        {
            return DateFrom.Date.AddDays(-1);
        }

        public string GetLongAccountYearIntervalText()
        {
            if (!string.IsNullOrEmpty(LongAccountYearFromText) && !string.IsNullOrEmpty(LongAccountYearToText))
                return LongAccountYearFromText + "-" + LongAccountYearToText;
            else
            {
                return "";
            }
        }

        public string GetPreviousAccountYearIntervalText()
        {
            if (!string.IsNullOrEmpty(PreviousAccountYearFromText) && !string.IsNullOrEmpty(PreviousAccountYearToText))
                return PreviousAccountYearFromText + "-" + PreviousAccountYearToText;
            else
                return "";
        }

        public string GetAccountPeriodIntervalText()
        {
            string text = "";
            if (HasDateInterval)
                text = DateFrom.ToShortDateString() + "-" + DateTo.ToShortDateString();
            else if (!string.IsNullOrEmpty(AccountPeriodFromText))
                text = AccountPeriodFromText;
            return text;
        }

        public string GetInventoryIntervalText()
        {
            string text = "";
            if (SFA_HasInventoryInterval)
                text = SFA_InventoryFrom.ToString() + "-" + SFA_InventoryTo.ToString();
            return text;
        }

        public string GetCategoryIntervalText()
        {
            string text = "";
            if (SFA_HasCategoryInterval)
            {
                if (SFA_CategoryFrom != "")
                {
                    text = SFA_CategoryFrom;
                }
                if (SFA_CategoryTo != "")
                {
                    text += " - ";
                    text += SFA_CategoryTo;
                }
            }
            return text;
        }

        public string GetLatestVoucherText()
        {
            string text = "";
            if (IsSameYear && HasVoucherSeriesTypeNrInterval && VoucherSeriesTypeNrFrom == VoucherSeriesTypeNrTo)
            {
                VoucherSeries voucherSerie = new VoucherManager(paramObject).GetVoucherSerieByTypeNr(VoucherSeriesTypeNrFrom, AccountYearId);
                if (voucherSerie != null)
                    text = voucherSerie.VoucherNrLatest.ToString();
            }
            return text;
        }
    }
}
