using Soe.Sys.Common.DTO;
using SoftOne.Soe.Business.Core.Reporting.Models.Time;
using SoftOne.Soe.Business.Core.TimeEngine;
using SoftOne.Soe.Business.DataCache;
using SoftOne.Soe.Business.Util;
using SoftOne.Soe.Business.Util.BatchHelper;
using SoftOne.Soe.Business.Util.Config;
using SoftOne.Soe.Business.Util.Leisure.PreFlight.AutomaticAllocation;
using SoftOne.Soe.Business.Util.Leisure.PreFlight.AutomaticAllocation.Models;
using SoftOne.Soe.Business.Util.LogCollector;
using SoftOne.Soe.Common.DTO;
using SoftOne.Soe.Common.Interfaces.Common;
using SoftOne.Soe.Common.Util;
using SoftOne.Soe.Data;
using SoftOne.Soe.Data.Util;
using SoftOne.Soe.Util;
using StackExchange.Redis;
using System;
using System.Collections.Concurrent;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Data.Entity.Core.Objects.DataClasses;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Transactions;

namespace SoftOne.Soe.Business.Core
{
    public class TimeScheduleManager : ManagerBase
    {
        #region Variables

        // Create a logger for use in this class
        private readonly log4net.ILog log = log4net.LogManager.GetLogger(System.Reflection.MethodBase.GetCurrentMethod().DeclaringType);

        #endregion

        #region Ctor

        public TimeScheduleManager(ParameterObject parameterObject) : base(parameterObject) { }

        #endregion

        #region EmployeePost

        public List<EmployeeListDTO> GetEmployeePostList(int actorCompanyId, List<int> employeePostIds, DateTime? dateFrom = null, DateTime? dateTo = null)
        {
            ConcurrentBag<EmployeeListDTO> employeeList = new ConcurrentBag<EmployeeListDTO>();
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);

            DateTime yearDateFrom = CalendarUtility.GetFirstDateOfYear(dateFrom);
            DateTime yearDateTo = CalendarUtility.GetLastDateOfYear(dateTo);

            using (CompEntities entities = new CompEntities())
            {
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                IQueryable<EmployeePost> query = entitiesReadOnly.EmployeePost
                    .Include("EmployeePostSkill.Skill.SkillType")
                    .Include("EmployeeGroup")
                    .Include("TimeScheduleTemplateHead");

                if (employeePostIds != null && employeePostIds.Count > 0)
                    query = query.Where(e => employeePostIds.Contains(e.EmployeePostId));

                if (useAccountHierarchy)
                {
                    var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);
                    query = query.Where(t => t.AccountId.HasValue && accountIds.Contains(t.AccountId.Value));
                }

                List<EmployeePost> employeePosts = (from e in query
                                                    where e.ActorCompanyId == actorCompanyId &&
                                                    (e.DateFrom == null || !dateFrom.HasValue || e.DateFrom <= yearDateTo) &&
                                                    (e.DateTo == null || !dateTo.HasValue || e.DateTo >= yearDateFrom) &&
                                                    e.State == (int)SoeEntityState.Active
                                                    select e).ToList();

                foreach (var employeePost in employeePosts)
                {
                    // Create Employee DTO
                    EmployeeListDTO dto = new EmployeeListDTO()
                    {
                        EmployeePostId = employeePost.EmployeePostId,
                        EmployeePostStatus = (SoeEmployeePostStatus)employeePost.Status,
                        EmployeeNr = "",
                        FirstName = employeePost.Name,
                        LastName = "",
                        Description = employeePost.Description,
                        Sex = TermGroup_Sex.Unknown,
                        Hidden = false,
                        Vacant = false,
                        Active = true
                    };

                    #region Accounts

                    if (employeePost.AccountId.HasValue)
                    {
                        dto.Accounts = new List<EmployeeAccountDTO>
                        {
                            new EmployeeAccountDTO
                            {
                                EmployeeId = employeePost.EmployeePostId,
                                AccountId = employeePost.AccountId,
                                DateFrom = DateTime.Today.AddYears(-2),
                                Default = true,
                                State = SoeEntityState.Active
                            }
                        };
                    }

                    #endregion

                    #region Employments

                    dto.Employments = new List<EmployeeListEmploymentDTO>();
                    dto.Employments.Add(new EmployeeListEmploymentDTO()
                    {
                        DateFrom = employeePost.DateFrom,
                        DateTo = employeePost.DateTo,
                        EmployeeGroupId = employeePost.EmployeeGroupId,
                        EmployeeGroupName = employeePost.EmployeeGroup?.Name,
                        WorkTimeWeekMinutes = employeePost.WorkTimeWeek,
                        Percent = employeePost.EmployeeGroup != null ? Math.Round((decimal)employeePost.WorkTimeWeek / (decimal)employeePost.EmployeeGroup.RuleWorkTimeWeek * 100, 2) : 0
                    });

                    #endregion

                    #region TemplateSchedules

                    dto.TemplateSchedules = new List<TimeScheduleTemplateHeadSmallDTO>();
                    if (employeePost.TimeScheduleTemplateHead != null)
                    {
                        // Get all valid template schedules
                        List<TimeScheduleTemplateHead> allTemplates = employeePost.TimeScheduleTemplateHead.Where(t => t.StartDate.HasValue && t.State == (int)SoeEntityState.Active).OrderBy(t => t.StartDate).ToList();
                        if (allTemplates != null)
                        {
                            allTemplates = allTemplates.OrderBy(o => $"{o.StartDate}#{o.Created}").ToList();
                            List<TimeScheduleTemplateHead> filteredHeads = new List<TimeScheduleTemplateHead>();
                            foreach (var group in allTemplates.Where(w => !w.EmployeeId.HasValue).GroupBy(g => g.StartDate))
                                filteredHeads.Add(group.Last());

                            // Check if employee post is assigned to an employee
                            var employeeTemplate = allTemplates.LastOrDefault(t => t.EmployeeId != null && t.StartDate >= yearDateFrom || t.StopDate >= yearDateFrom);
                            if (employeeTemplate != null)
                                dto.EmployeeId = employeeTemplate.EmployeeId.Value;

                            // Get all template schedules that starts or ends within specified year(s)
                            dto.TemplateSchedules.AddRange(filteredHeads.Where(t => t.EmployeeId == null && t.StartDate >= yearDateFrom || t.StopDate >= yearDateFrom).ToSmallDTOs());

                            // Also get last template from before this year (if it's end date is not set)
                            var template = filteredHeads.LastOrDefault(t => t.EmployeeId == null && t.StartDate.HasValue && t.StartDate.Value < yearDateFrom);
                            if (template != null && !template.StopDate.HasValue)
                                dto.TemplateSchedules.Add(template.ToSmallDTO());

                        }
                    }

                    #endregion

                    #region Skills

                    if (employeePost.EmployeePostSkill != null)
                        dto.EmployeeSkills = employeePost.EmployeePostSkill.ToEmployeeSkillDTOs(false);

                    #endregion

                    employeeList.Add(dto);
                }
            }

            return employeeList.OrderBy(e => e.Name).ToList();
        }

        public List<EmployeePost> GetEmployeePosts(int actorCompanyId, bool? active, bool loadRelations = false, bool loadAccountHierarchyAccount = false, bool setSkillNames = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeePost.NoTracking();
            return GetEmployeePosts(entities, actorCompanyId, active, loadRelations, loadAccountHierarchyAccount, setSkillNames);
        }

        public List<EmployeePost> GetEmployeePosts(CompEntities entities, int actorCompanyId, bool? active, bool loadRelations = false, bool loadAccountHierarchyAccount = false, bool setSkillNames = false)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            IQueryable<EmployeePost> query = (from e in entities.EmployeePost
                                              where e.ActorCompanyId == actorCompanyId
                                              select e);

            if (loadAccountHierarchyAccount || useAccountHierarchy)
                query = query.Include("Account");

            if (loadRelations)
            {
                query = query.Include("EmployeeGroup")
                            .Include("EmployeePostSkill.Skill.SkillType")
                            .Include("ScheduleCycle.ScheduleCycleRule.ScheduleCycleRuleType");
            }

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            if (active == true)
                query = query.Where(a => a.State == (int)SoeEntityState.Active);
            else if (active == false)
                query = query.Where(a => a.State == (int)SoeEntityState.Inactive);
            else
                query = query.Where(a => a.State != (int)SoeEntityState.Deleted);

            List<EmployeePost> employeePosts = query.OrderBy(s => s.Name).ToList();
            foreach (EmployeePost employeePost in employeePosts)
            {
                employeePost.DayOfWeekIds = new List<int>();
                SetDayOfWeeks(employeePost);

                if (setSkillNames)
                    employeePost.SkillNames = string.Join(", ", employeePost.EmployeePostSkill.OrderBy(x => x.Skill.Name).Select(y => y.Skill.Name + " (" + y.SkillLevel + ")").ToList());
            }

            return employeePosts;
        }

        public Dictionary<int, string> GetEmployeePostsDict(int actorCompanyId, bool? active, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            List<EmployeePost> employeePosts = GetEmployeePosts(actorCompanyId, active);
            foreach (EmployeePost employeePost in employeePosts)
            {
                dict.Add(employeePost.EmployeePostId, employeePost.Name);
            }

            return dict;
        }

        public EmployeePost GetEmployeePost(int employeePostId, bool loadEmployeeGroup = false, bool loadEmployeePostSkill = false, bool loadScheduleCycle = false, bool loadAccountHierarchyAccount = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeePost.NoTracking();
            return GetEmployeePost(entities, employeePostId, loadEmployeeGroup, loadEmployeePostSkill, loadScheduleCycle, loadAccountHierarchyAccount);
        }

        public EmployeePost GetEmployeePost(CompEntities entities, int employeePostId, bool loadEmployeeGroup = false, bool loadEmployeePostSkill = false, bool loadScheduleCycle = false, bool loadAccountHierarchyAccount = false)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);

            var query = from sn in entities.EmployeePost
                        where sn.EmployeePostId == employeePostId &&
                        sn.State == (int)SoeEntityState.Active
                        select sn;

            if (loadAccountHierarchyAccount || useAccountHierarchy)
                query = query.Include("Account");
            if (loadEmployeeGroup)
                query = query.Include("EmployeeGroup");
            if (loadEmployeePostSkill)
                query = query.Include("EmployeePostSkill.Skill.SkillType");
            if (loadScheduleCycle)
                query = query.Include("ScheduleCycle.ScheduleCycleRule.ScheduleCycleRuleType");

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, base.ActorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            EmployeePost employeePost = query.FirstOrDefault();
            if (employeePost != null)
            {
                employeePost.DayOfWeekIds = new List<int>();
                SetDayOfWeeks(employeePost);
            }

            return employeePost;
        }

        private void SetDayOfWeeks(EmployeePost item)
        {
            List<SmallGenericType> dayOfWeeksGenericType = new List<SmallGenericType>();

            item.DayOfWeekIds = new List<int>();

            if (!String.IsNullOrEmpty(item.DayOfWeeks))
            {
                foreach (string dayOfWeek in item.DayOfWeeks.Split(','))
                {
                    if (Int32.TryParse(dayOfWeek, out int dayOfWeekId))
                    {
                        string name = "";
                        switch ((DayOfWeek)dayOfWeekId)
                        {
                            case DayOfWeek.Monday:
                                name = GetText(2, (int)TermGroup.StandardDayOfWeek, "Måndag");
                                break;
                            case DayOfWeek.Tuesday:
                                name = GetText(3, (int)TermGroup.StandardDayOfWeek, "Tisdag");
                                break;
                            case DayOfWeek.Wednesday:
                                name = GetText(4, (int)TermGroup.StandardDayOfWeek, "Onsdag");
                                break;
                            case DayOfWeek.Thursday:
                                name = GetText(5, (int)TermGroup.StandardDayOfWeek, "Torsdag");
                                break;
                            case DayOfWeek.Friday:
                                name = GetText(6, (int)TermGroup.StandardDayOfWeek, "Fredag");
                                break;
                            case DayOfWeek.Saturday:
                                name = GetText(7, (int)TermGroup.StandardDayOfWeek, "Lördag");
                                break;
                            case DayOfWeek.Sunday:
                                name = GetText(1, (int)TermGroup.StandardDayOfWeek, "Söndag");
                                break;
                        }
                        dayOfWeeksGenericType.Add(new SmallGenericType() { Id = dayOfWeekId, Name = name });
                    }
                }

            }

            int count = 1;
            foreach (var day in dayOfWeeksGenericType)
            {
                item.DayOfWeekIds.Add(day.Id);
                item.DayOfWeeksGridString += day.Name;
                if (count < dayOfWeeksGenericType.Count)
                    item.DayOfWeeksGridString += ", ";

                count++;
            }
        }

        public SoeEmployeePostStatus GetEmployeePostStatus(int employeePostId)
        {
            return GetEmployeePostStatus(GetEmployeePost(employeePostId));
        }

        public SoeEmployeePostStatus GetEmployeePostStatus(EmployeePost employeePost)
        {
            if (employeePost == null || employeePost.State != (int)SoeEntityState.Active)
                return SoeEmployeePostStatus.NotFound;

            if (employeePost.Status == (int)SoeEmployeePostStatus.Locked)
                return SoeEmployeePostStatus.Locked;

            TimeScheduleTemplateHead templateHeadEmployeePost = GetEmployeeTimeScheduleTemplateHeadForEmployeePost(employeePost.EmployeePostId, false, false);
            if (templateHeadEmployeePost != null)
            {
                TimeScheduleTemplateHead templateHeadEmployee = GetEmployeeTimeScheduleTemplateHeadForEmployeePost(employeePost.EmployeePostId, true, false);
                if (templateHeadEmployee != null)
                    return SoeEmployeePostStatus.HasEmployee;
                else
                    return SoeEmployeePostStatus.HasSchedule;
            }

            return SoeEmployeePostStatus.None;
        }

        public List<Employment> GetEmploymentsForCreatingEmployeePosts(DateTime fromDate, int actorCompanyId, int userId, int roleId)
        {
            using (CompEntities entities = new CompEntities())
            {
                List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, userId, roleId, fromDate, addEmployeeAuthModelInfo: true, onlyDefaultEmployeeAuthModel: false).ToList();
                List<int> employeeIds = employees.Select(e => e.EmployeeId).ToList();
                List<Employment> employments = EmployeeManager.GetEmployments(entities, actorCompanyId, employeeIds, true, true, false, true, true).Where(e => e.DateFrom <= fromDate && (!e.DateTo.HasValue || e.DateTo.Value >= fromDate)).ToList();

                foreach (Employment employment in employments)
                {
                    // Using field OriginalName (later mapped to DTO-field Name) to carry accountName
                    employment.OriginalName = employees.FirstOrDefault(e => e.EmployeeId == employment.EmployeeId)?.AccountNamesString;
                }

                return employments.OrderBy(e => e.Employee.ContactPerson.FirstName).ThenBy(e => e.Employee.ContactPerson.LastName).ToList();
            }
        }

        public ActionResult CreateEmployeePostsFromEmployments(int actorCompanyId, List<int> employmentIds, DateTime fromDate)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            string postNamePart = GetText(4689, 1, "Tjänst");
            string settingPrefix = SettingManager.GetStringSetting(SettingMainType.Company, (int)CompanySettingType.TimeEmployeePostPrefix, 0, actorCompanyId, 0);
            if (settingPrefix.HasValue() && !String.IsNullOrEmpty(settingPrefix))
                postNamePart = settingPrefix;

            List<int> accountIds = useAccountHierarchy ? AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Now, DateTime.Now) : new List<int>();

            if (useAccountHierarchy && accountIds.Count > 1)
            {
                var defaultDim = AccountManager.GetDefaultEmployeeAccountDim(actorCompanyId);
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                accountIds = accountIds.Where(w => base.GetAccountInternalsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId)).Any(a => a.AccountDimId == defaultDim.AccountDimId && a.AccountId == w)).ToList();

                if (defaultDim != null)
                {
                    var accountInternals = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId)).Where(w => accountIds.Contains(w.AccountId)).ToList();
                    var accountDims = base.GetAccountDimsFromCache(entities, CacheConfig.Company(actorCompanyId));
                    accountDims.CalculateLevels();
                    var accountDimsFilteredOnAccountInternals = accountDims.Where(w => accountInternals.Any(a => a.AccountDimId == w.AccountDimId)).ToList();
                    var validAccountIds = accountInternals.Where(w => w.AccountDimId == defaultDim.AccountDimId).Select(s => s.AccountId).ToList();

                    if (accountDimsFilteredOnAccountInternals.First().AccountDimId != defaultDim.AccountDimId)
                        return new ActionResult(false, 832498, "Default account dim is not the first in the hierarchy");

                    if (validAccountIds.Any())
                        accountIds = accountIds.Where(w => validAccountIds.Contains(w)).ToList();
                }
            }


            int i = 1;
            foreach (var empId in employmentIds)
            {
                Employment employment = EmployeeManager.GetEmployment(empId);
                if (employment == null)
                    continue;

                Employee employee = EmployeeManager.GetEmployee(employment.EmployeeId, actorCompanyId, loadUser: true, loadEmployeeAccount: useAccountHierarchy, loadEmployeeSkill: true, loadContactPerson: true);
                if (employee == null)
                    continue;

                int workDaysWeek = 5;
                int workTimeWeek = Convert.ToInt32(decimal.Divide(employment.GetWorkTimeWeek(), 60));
                if (workTimeWeek < 32 && workTimeWeek > 24)
                    workDaysWeek = 4;
                if (workTimeWeek <= 24 && workTimeWeek > 16)
                    workDaysWeek = 3;
                if (workTimeWeek <= 16 && workTimeWeek > 9)
                    workDaysWeek = 2;
                if (workTimeWeek <= 9)
                    workDaysWeek = 1;

                EmployeePostDTO empPost = new EmployeePostDTO()
                {
                    DateFrom = fromDate,
                    WorkDaysWeek = workDaysWeek,
                    WorkTimeWeek = employment.GetWorkTimeWeek(),
                    WorkTimePercent = employment.GetPercent(),
                    Description = employee.User?.Name ?? employee.Name ?? "***",
                    EmployeePostId = 0,
                    ActorCompanyId = actorCompanyId,
                    ScheduleCycleId = GetScheduleCycles(actorCompanyId).FirstOrDefault()?.ScheduleCycleId,
                    EmployeeGroupId = employment.GetEmployeeGroupId(),
                    EmployeePostSkillDTOs = new List<EmployeePostSkillDTO>(),
                };

                List<EmployeePosition> employeepositions = EmployeeManager.GetEmployeePositions(employment.EmployeeId);
                if (employeepositions.Any())
                {
                    var defaultPos = employeepositions.FirstOrDefault(e => e.Default);
                    if (defaultPos != null)
                    {
                        empPost.Name = defaultPos.Position.Name;
                    }
                    else
                    {
                        empPost.Name = postNamePart + " " + i.ToString().PadLeft(3, '0');
                        i++;
                    }
                }
                else
                {
                    empPost.Name = postNamePart + " " + i.ToString().PadLeft(3, '0');
                    i++;
                }

                foreach (EmployeeSkill employeeSkill in employee.EmployeeSkill)
                {
                    empPost.EmployeePostSkillDTOs.Add(new EmployeePostSkillDTO()
                    {
                        SkillId = employeeSkill.SkillId,
                        SkillLevel = employeeSkill.SkillLevel,
                        SkillName = employeeSkill.Skill.Name,
                    });
                }

                if (useAccountHierarchy)
                {
                    if (accountIds.Count == 1)
                    {
                        empPost.AccountId = accountIds.FirstOrDefault();
                        var result = SaveEmployeePost(empPost, actorCompanyId);
                        if (!result.Success)
                            return result;
                    }
                    else if (accountIds.Count > 1)
                    {
                        EmployeePostDTO empPostCopy;
                        foreach (EmployeeAccount employeeAccount in employee.EmployeeAccount)
                        {
                            if (accountIds.Contains((int)employeeAccount.AccountId))
                            {
                                empPostCopy = empPost;
                                empPostCopy.AccountId = employeeAccount.AccountId;
                                var result = SaveEmployeePost(empPostCopy, actorCompanyId);
                                if (!result.Success)
                                    return result;
                            }
                        }
                    }
                }
                else
                {
                    var result = SaveEmployeePost(empPost, actorCompanyId);
                    if (!result.Success)
                        return result;
                }
            }

            return new ActionResult(true);
        }

        /// <summary>
        /// Insert or update a employeepost
        /// </summary>
        /// <param name="employeePostInput">employeepost entity</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveEmployeePost(EmployeePostDTO employeePostInput, int actorCompanyId)
        {
            if (employeePostInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EmployeePost");

            // Default result is successful
            ActionResult result = null;

            int employeePostId = employeePostInput.EmployeePostId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region EmployeePosts

                        // Get existing
                        EmployeePost employeePost = GetEmployeePost(entities, employeePostId, true, true, true);
                        if (employeePost == null)
                        {
                            #region Add

                            employeePost = new EmployeePost()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(employeePost);
                            entities.EmployeePost.AddObject(employeePost);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(employeePost);

                            #endregion
                        }

                        employeePost.Name = employeePostInput.Name;
                        employeePost.Description = employeePostInput.Description;
                        employeePost.State = (int)employeePostInput.State;
                        employeePost.DateFrom = employeePostInput.DateFrom;
                        employeePost.WeekendType = (int)employeePostInput.EmployeePostWeekendType;
                        employeePost.DateTo = employeePostInput.DateTo;
                        employeePost.WorkTimePercent = employeePostInput.WorkTimePercent;
                        employeePost.WorkTimeWeek = employeePostInput.WorkTimeWeek;
                        employeePost.EmployeeGroupId = employeePostInput.EmployeeGroupId;
                        employeePost.ScheduleCycleId = employeePostInput.ScheduleCycleId;
                        employeePost.WorkDaysWeek = employeePostInput.WorkDaysWeek;
                        employeePost.Status = (int)employeePostInput.Status;
                        employeePost.AccountId = employeePostInput.AccountId.HasValue && employeePostInput.AccountId != 0 ? employeePostInput.AccountId : (int?)null;
                        employeePost.DayOfWeeks = employeePostInput.DayOfWeeks;
                        employeePost.DayOfWeeks = "";
                        if (employeePostInput.DayOfWeekIds != null)
                        {
                            foreach (int id in employeePostInput.DayOfWeekIds)
                            {
                                if (!String.IsNullOrEmpty(employeePost.DayOfWeeks))
                                    employeePost.DayOfWeeks += ",";
                                employeePost.DayOfWeeks += id;
                            }
                        }

                        #region Skills

                        List<EmployeePostSkill> existingEmployeePostSkills = employeePostInput.EmployeePostId > 0 ? GetEmployeePostSkills(entities, employeePostInput.EmployeePostId) : new List<EmployeePostSkill>();

                        #region Delete rows that exists in db but not in input.

                        foreach (var existingEmployeePostSkill in existingEmployeePostSkills)
                        {
                            if (!employeePostInput.EmployeePostSkillDTOs.Any(x => x.SkillId == existingEmployeePostSkill.SkillId))
                                DeleteEntityItem(entities, existingEmployeePostSkill);
                        }

                        #endregion

                        #region Add/update skills
                        if (employeePostInput.EmployeePostSkillDTOs != null)
                        {
                            foreach (var incomingEmployeePostSkill in employeePostInput.EmployeePostSkillDTOs)
                            {
                                EmployeePostSkill existingEmployeePostSkill = GetEmployeePostSkill(entities, employeePostInput.EmployeePostId, incomingEmployeePostSkill.SkillId);
                                if (existingEmployeePostSkill == null)
                                {
                                    existingEmployeePostSkill = new EmployeePostSkill()
                                    {
                                        EmployeePost = employeePost,
                                        SkillId = incomingEmployeePostSkill.SkillId,
                                        SkillLevel = incomingEmployeePostSkill.SkillLevel
                                    };
                                    SetCreatedProperties(existingEmployeePostSkill);
                                    entities.EmployeePostSkill.AddObject(existingEmployeePostSkill);
                                }
                                else
                                {
                                    existingEmployeePostSkill.SkillLevel = incomingEmployeePostSkill.SkillLevel;
                                    SetModifiedProperties(existingEmployeePostSkill);
                                }

                            }
                        }

                        #endregion

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            employeePostId = employeePost.EmployeePostId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = employeePostId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        /// <summary>
        /// Sets a employeepost state to Deleted
        /// </summary>
        /// <param name="employeePostId">employee to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteEmployeePost(int employeePostId)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                EmployeePost employeePost = GetEmployeePost(entities, employeePostId);
                if (employeePost == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "EmployeePost");

                SoeEmployeePostStatus status = GetEmployeePostStatus(employeePost);
                bool canDelete = status == SoeEmployeePostStatus.HasSchedule || status == SoeEmployeePostStatus.None;
                if (!canDelete)
                {
                    if (status == SoeEmployeePostStatus.Locked)
                        return new ActionResult((int)ActionResultDelete.NothingDeleted, GetText(11530, "Tjänst kan inte tas bort, den är låst") + String.Format(" ({0})", employeePost.Name));
                    if (status == SoeEmployeePostStatus.HasEmployee)
                        return new ActionResult((int)ActionResultDelete.NothingDeleted, GetText(11531, "Tjänst kan inte tas bort, den har en anställd kopplad till sig") + String.Format(" ({0})", employeePost.Name));
                    else
                        return new ActionResult((int)ActionResultDelete.NothingDeleted);
                }

                TimeScheduleTemplateHead templateHead = GetEmployeeTimeScheduleTemplateHeadForEmployeePost(employeePost.EmployeePostId, false, true);
                if (templateHead != null)
                {
                    foreach (TimeScheduleTemplatePeriod tempatePeriod in templateHead.TimeScheduleTemplatePeriod)
                    {
                        result = ChangeEntityState(entities, tempatePeriod, SoeEntityState.Deleted, saveChanges: false);
                        if (!result.Success)
                            return result;

                        foreach (TimeScheduleTemplateBlock templateBlock in tempatePeriod.TimeScheduleTemplateBlock)
                        {
                            result = ChangeEntityState(entities, templateBlock, SoeEntityState.Deleted, saveChanges: false);
                            if (!result.Success)
                                return result;

                            foreach (TimeScheduleTemplateBlockTask templateBlockTask in templateBlock.TimeScheduleTemplateBlockTask)
                            {
                                result = ChangeEntityState(entities, templateBlockTask, SoeEntityState.Deleted, saveChanges: false);
                                if (!result.Success)
                                    return result;
                            }
                        }
                    }
                }

                if (result.Success)
                {
                    result = ChangeEntityState(entities, employeePost, SoeEntityState.Deleted, saveChanges: false);
                    if (!result.Success)
                        return result;
                }

                if (result.Success)
                    result = SaveChanges(entities);

                return result;
            }
        }

        public ActionResult DeleteEmployeePosts(List<int> employeePostIds)
        {
            ActionResult result = new ActionResult(true);

            foreach (int employeePostId in employeePostIds)
            {
                result = DeleteEmployeePost(employeePostId);
                if (!result.Success)
                    return result;
            }

            return result;
        }

        public ActionResult UpdateEmployeePostsState(Dictionary<int, bool> employeePosts)
        {
            using (CompEntities entities = new CompEntities())
            {
                foreach (KeyValuePair<int, bool> employeePost in employeePosts)
                {
                    EmployeePost originalemployeePost = GetEmployeePost(entities, employeePost.Key);
                    if (originalemployeePost == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, "EmployeePost");

                    ChangeEntityState(originalemployeePost, employeePost.Value ? SoeEntityState.Active : SoeEntityState.Inactive);
                }

                return SaveChanges(entities);
            }
        }

        #endregion

        #region EmployeePostSkill

        public List<EmployeePostSkill> GetEmployeePostSkills(int employeePostId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetEmployeePostSkills(entities, employeePostId);
        }

        public List<EmployeePostSkill> GetEmployeePostSkills(CompEntities entities, int employeePostId)
        {
            return (from e in entities.EmployeePostSkill.Include("Skill.SkillType")
                    where e.EmployeePostId == employeePostId &&
                    e.Skill.State == (int)SoeEntityState.Active
                    orderby e.Skill.SkillType.Name, e.Skill.Name
                    select e).ToList();
        }

        public EmployeePostSkill GetEmployeePostSkill(CompEntities entities, int employeePostId, int skillId)
        {
            return (from eps in entities.EmployeePostSkill
                    where eps.EmployeePostId == employeePostId && eps.SkillId == skillId
                    select eps).FirstOrDefault();
        }

        #endregion

        #region EmployeeSchedule

        public List<EmployeeSchedule> GetEmployeeSchedules(int actorCompanyId, bool loadTemplate = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedule.NoTracking();
            return GetEmployeeSchedules(entities, actorCompanyId, loadTemplate);
        }

        public List<EmployeeSchedule> GetEmployeeSchedules(CompEntities entities, int actorCompanyId, bool loadTemplate = false)
        {
            IQueryable<EmployeeSchedule> query = entities.EmployeeSchedule;
            if (loadTemplate)
                query = query.Include("TimeScheduleTemplateHead");

            return (from es in query
                    where es.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                    es.State == (int)SoeEntityState.Active
                    select es).ToList();
        }

        public List<EmployeeSchedule> GetEmployeeSchedulesForEmployee(int employeeId, DateTime startDate, DateTime stopDate, int actorCompanyId, bool loadTemplateAndPeriods = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedule.NoTracking();
            return GetEmployeeSchedulesForEmployee(entities, employeeId, startDate, stopDate, actorCompanyId, loadTemplateAndPeriods);
        }

        public List<EmployeeSchedule> GetEmployeeSchedulesForEmployee(CompEntities entities, int employeeId, DateTime startDate, DateTime stopDate, int actorCompanyId, bool loadTemplateAndPeriods = false)
        {
            IQueryable<EmployeeSchedule> query = entities.EmployeeSchedule;
            if (loadTemplateAndPeriods)
                query = query.Include("TimeScheduleTemplateHead.TimeScheduleTemplatePeriod");

            return (from es in query
                    where es.EmployeeId == employeeId &&
                    ((startDate >= es.StartDate && startDate <= es.StopDate) || (stopDate >= es.StartDate && stopDate <= es.StopDate) || (startDate <= es.StartDate && stopDate >= es.StopDate)) &&
                    es.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                    es.State == (int)SoeEntityState.Active
                    orderby es.StartDate
                    select es).ToList();
        }

        public List<EmployeeSchedule> GetEndingEmployeeSchedules(int actorCompanyId, DateTime endDate)
        {
            List<EmployeeSchedule> endingEmployeeSchedules = new List<EmployeeSchedule>();

            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entitiesReadonly, CacheConfig.Company(actorCompanyId));

            using (CompEntities entities = new CompEntities())
            {
                List<EmployeeSchedule> employeeSchedules = (from es in entities.EmployeeSchedule
                                                             .Include("Employee.ContactPerson")
                                                            where es.Employee.ActorCompanyId == actorCompanyId &&
                                                            es.EmployeeId != hiddenEmployeeId &&
                                                            es.StopDate > DateTime.Now &&
                                                            es.StopDate < endDate &&
                                                            es.State == (int)SoeEntityState.Active
                                                            select es).ToList();

                foreach (EmployeeSchedule employeeSchedule in employeeSchedules)
                {
                    bool exists = (from es in entities.EmployeeSchedule
                                   where es.Employee.ActorCompanyId == actorCompanyId &&
                                   es.EmployeeId == employeeSchedule.EmployeeId &&
                                   es.StartDate > employeeSchedule.StopDate
                                   select es).Any();

                    if (!exists)
                        endingEmployeeSchedules.Add(employeeSchedule);

                }
            }

            return endingEmployeeSchedules;
        }

        public List<DateTime> UnActivatedDatesInInterval(CompEntities entities, int employeeId, DateTime startDate, DateTime stopDate, int actorCompanyId)
        {
            var schedules = GetEmployeeSchedulesForEmployee(entities, employeeId, startDate, stopDate, actorCompanyId, false);
            List<DateTime> unActivatedDatesInInterval = new List<DateTime>();
            var allDates = CalendarUtility.GetDates(startDate, stopDate);

            foreach (var date in allDates)
            {
                if (schedules.Get(date) == null)
                {
                    unActivatedDatesInInterval.Add(date);
                }
            }

            return unActivatedDatesInInterval;
        }

        public List<EmployeeSchedule> GetEmployeeSchedulesForEmployee(int employeeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedule.NoTracking();
            return GetEmployeeSchedulesForEmployee(entities, employeeId);
        }

        public List<EmployeeSchedule> GetEmployeeSchedulesForEmployee(CompEntities entities, int employeeId)
        {
            return (from es in entities.EmployeeSchedule
                    where es.EmployeeId == employeeId &&
                    es.State == (int)SoeEntityState.Active
                    orderby es.StartDate
                    select es).ToList<EmployeeSchedule>();
        }

        public List<EmployeeSchedule> GetEmployeeSchedulesForEmployeeForDateOrLater(CompEntities entities, DateTime date, int employeeId, bool loadTemplate = false)
        {
            return (from es in entities.EmployeeSchedule
                    where es.EmployeeId == employeeId &&
                    ((es.StartDate > date) || (es.StartDate <= date && es.StopDate >= date)) &&
                    es.State == (int)SoeEntityState.Active
                    select es).ToList();
        }

        public List<EmployeeSchedule> GetEmployeeSchedulesForEmployees(CompEntities entities, List<int> employeeIds)
        {
            return (from es in entities.EmployeeSchedule
                    where employeeIds.Contains(es.EmployeeId) &&
                    es.State == (int)SoeEntityState.Active
                    orderby es.StartDate
                    select es).ToList<EmployeeSchedule>();
        }

        public List<EmployeeSchedule> GetOverlappingEmployeeSchedules(CompEntities entities, int employeeId, DateTime startDate, DateTime stopDate)
        {
            return (from es in entities.EmployeeSchedule.Include("TimeScheduleTemplateHead")
                    where es.EmployeeId == employeeId &&
                    (es.StopDate >= startDate && es.StartDate <= stopDate) &&
                     es.State == (int)SoeEntityState.Active
                    orderby es.StartDate
                    select es).ToList();
        }

        public EmployeeSchedule GetEmployeeSchedule(CompEntities entities, DateTime date, int employeeId, bool loadTemplate = false)
        {
            EmployeeSchedule employeeSchedule = (from es in entities.EmployeeSchedule
                                                 where es.EmployeeId == employeeId &&
                                                 es.StartDate <= date &&
                                                 es.StopDate >= date &&
                                                 es.State == (int)SoeEntityState.Active
                                                 select es).FirstOrDefault();

            if (employeeSchedule != null && loadTemplate)
            {
                if (!employeeSchedule.TimeScheduleTemplateHeadReference.IsLoaded)
                    employeeSchedule.TimeScheduleTemplateHeadReference.Load();
                if (employeeSchedule.TimeScheduleTemplateHead != null && !employeeSchedule.TimeScheduleTemplateHead.TimeScheduleTemplatePeriod.IsLoaded)
                    employeeSchedule.TimeScheduleTemplateHead.TimeScheduleTemplatePeriod.Load();
            }

            return employeeSchedule;
        }

        public bool HasEmployeeSchedule(int employeeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedule.NoTracking();
            return HasEmployeeSchedule(entities, employeeId, date);
        }

        public bool HasEmployeeSchedule(CompEntities entities, int employeeId, DateTime date)
        {
            return (from es in entities.EmployeeSchedule
                    where es.EmployeeId == employeeId &&
                    es.StartDate <= date &&
                    es.StopDate >= date &&
                    es.State == (int)SoeEntityState.Active
                    select es).Any();
        }

        public bool EmployeeSchedulesForAllEmployeesExists(int actorCompanyId)
        {
            var employeeIds = EmployeeManager.GetAllEmployeeIds(actorCompanyId).ToList();
            if (employeeIds.IsNullOrEmpty())
                return false;

            foreach (int empId in employeeIds)
            {
                if (!EmployeeSchedulesForEmployeeExists(empId))
                    return false;
            }
            return true;
        }

        public bool EmployeeSchedulesForEmployeeExists(int employeeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedule.NoTracking();
            return (from es in entities.EmployeeSchedule
                    where es.EmployeeId == employeeId &&
                    es.State == (int)SoeEntityState.Active
                    select es).Any();
        }

        public ActionResult SetScheduleAndDeviationsToDeleted(CompEntities entities, int employeeId, int actorCompanyId, DateTime dateFrom, DateTime? dateTo = null, bool saveChanges = true)
        {
            ActionResult result = new ActionResult(true);

            try
            {
                List<EmployeeSchedule> employeeSchedules = GetEmployeeSchedulesForEmployeeForDateOrLater(entities, dateFrom, employeeId);
                if (!employeeSchedules.IsNullOrEmpty())
                {
                    List<int> payrollLockedAttestStateIds = AttestManager.GetPayrollLockedAttestStateIds(entities, actorCompanyId, includeExportPayrollMinimum: true);
                    List<TimeBlock> timeBlocks = TimeBlockManager.GetTimesWithBlockDatesAndTransactions(entities, employeeId, dateFrom, dateTo);
                    DateTime batchTimeStamp = DateTime.Now;

                    DateTime? lastUnlockedDate = null;
                    if (!timeBlocks.IsNullOrEmpty())
                    {
                        lastUnlockedDate = timeBlocks.GetLastUnlockedDate(dateFrom, dateTo ?? timeBlocks.Max(i => i.TimeBlockDate.Date), payrollLockedAttestStateIds);
                        if (lastUnlockedDate.HasValue)
                            timeBlocks = timeBlocks.Where(i => i.TimeBlockDate.Date >= lastUnlockedDate.Value).ToList();

                        foreach (var timeBlocksByDate in timeBlocks.GroupBy(i => i.TimeBlockDateId))
                        {
                            TimeBlockDate timeBlockDate = timeBlocksByDate.FirstOrDefault()?.TimeBlockDate;
                            if (timeBlockDate != null)
                            {
                                if (!timeBlockDate.TimeBlockDateDetail.IsLoaded)
                                    timeBlockDate.TimeBlockDateDetail.Load();
                                if (!timeBlockDate.TimePayrollScheduleTransaction.IsLoaded)
                                    timeBlockDate.TimePayrollScheduleTransaction.Load();

                                foreach (TimeBlockDateDetail timeBlockDateDetail in timeBlockDate.GetTimeBlockDateDetailsToDelete(SoeTimeBlockDateDetailType.Absence, null))
                                    ChangeEntityState(timeBlockDateDetail, SoeEntityState.Deleted, modified: batchTimeStamp);
                                foreach (TimePayrollScheduleTransaction timePayrollScheduleTransaction in timeBlockDate.TimePayrollScheduleTransaction.Where(i => i.State == (int)SoeEntityState.Active))
                                    ChangeEntityState(timePayrollScheduleTransaction, SoeEntityState.Deleted, modified: batchTimeStamp);
                            }

                            foreach (TimeBlock timeBlock in timeBlocksByDate.OrderBy(i => i.StartTime))
                            {
                                ChangeEntityState(timeBlock, SoeEntityState.Deleted, modified: batchTimeStamp);

                                foreach (TimeCodeTransaction timeCodeTransaction in timeBlock.TimeCodeTransaction.Where(i => i.State == (int)SoeEntityState.Active))
                                    ChangeEntityState(timeCodeTransaction, SoeEntityState.Deleted, modified: batchTimeStamp);
                                foreach (TimePayrollTransaction timePayrollTransaction in timeBlock.TimePayrollTransaction.Where(i => i.State == (int)SoeEntityState.Active))
                                    ChangeEntityState(timePayrollTransaction, SoeEntityState.Deleted, modified: batchTimeStamp);
                                foreach (TimeInvoiceTransaction timeInvoiceTransaction in timeBlock.TimeInvoiceTransaction.Where(i => i.State == (int)SoeEntityState.Active))
                                    ChangeEntityState(timeInvoiceTransaction, SoeEntityState.Deleted, modified: batchTimeStamp);
                            }
                        }
                    }

                    List<TimeScheduleTemplateBlock> templateBlocks = GetTimeScheduleTemplateBlocks(entities, employeeId, lastUnlockedDate ?? dateFrom, dateTo, includeBreaks: true);
                    foreach (TimeScheduleTemplateBlock templateBlock in templateBlocks)
                    {
                        templateBlock.State = (int)SoeEntityState.Deleted;
                        SetModifiedProperties(templateBlock, modified: batchTimeStamp);
                    }

                    if (ConfigurationSetupUtil.GetSiteType() == TermGroup_SysPageStatusSiteType.Test && templateBlocks.Any())
                    {
                        var employee = EmployeeManager.GetEmployee(entities, employeeId, actorCompanyId);
                        var executive = UserManager.GetEmployeeNearestExecutive(entities, employee, DateTime.Today, DateTime.Today, actorCompanyId);
                        var company = entities.Company.Include("License").FirstOrDefault(f => f.ActorCompanyId == actorCompanyId);

                        if (company?.License != null && company.License.LicenseNr.StartsWith("40") && employee != null && executive != null)
                        {
                            var employeeName = employee.NameOrNumber;
                            var dateFromString = dateFrom.ToShortDateString();
                            var dateToString = dateTo?.ToShortDateString() ?? "null";
                            Task.Run(() => CompEntitiesProvider.RunWithTaskScopedReadOnlyEntities(() => CommunicationManager.SendXEMailToExecutive(actorCompanyId, executive.UserId, $"Schema förkortat för anställd {employee.NameOrNumber}",
                               $"Schema förkortat för anställd {employee.NameOrNumber} från datum {dateFromString}")));
                        }
                    }

                    DateTime newEmployeeScheduleStopDate = (lastUnlockedDate ?? dateFrom).AddDays(-1);
                    foreach (EmployeeSchedule employeeSchedule in employeeSchedules)
                    {
                        if (employeeSchedule.StopDate < newEmployeeScheduleStopDate)
                            continue;

                        if (employeeSchedule.StartDate > newEmployeeScheduleStopDate)
                        {
                            employeeSchedule.State = (int)SoeEntityState.Deleted;
                        }
                        else
                        {
                            employeeSchedule.StopDate = newEmployeeScheduleStopDate;
                            if (employeeSchedule.StopDate < employeeSchedule.StartDate)
                                employeeSchedule.State = (int)SoeEntityState.Deleted;
                        }
                        SetModifiedProperties(employeeSchedule, modified: batchTimeStamp);
                    }

                    if (saveChanges)
                        result = SaveChanges(entities);
                }
            }
            catch (Exception ex)
            {
                LogError(ex, log);
                result = new ActionResult(ex);
            }

            return result;
        }

        #endregion

        #region EmployeeSchedulePlacementGridView

        public List<EmployeeSchedulePlacementGridView> GetPlacementsForEmployee(int employeeId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedulePlacementGridView.NoTracking();
            return GetPlacementsForEmployee(entities, employeeId, actorCompanyId);
        }

        public List<EmployeeSchedulePlacementGridView> GetPlacementsForEmployee(CompEntities entities, int employeeId, int actorCompanyId, List<Employment> employments = null)
        {
            var placementItems = (from i in entities.EmployeeSchedulePlacementGridView
                                  where i.EmployeeId == employeeId &&
                                  i.ActorCompanyId == actorCompanyId
                                  select i).ToList();

            if (placementItems.Any())
            {
                if (employments == null)
                    employments = EmployeeManager.GetEmployments(entities, employeeId, actorCompanyId);
                placementItems.SetEmployments(employments);
            }

            return placementItems;
        }

        public EmployeeSchedulePlacementGridView GetPlacementForEmployee(DateTime date, int employeeId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedulePlacementGridView.NoTracking();
            return (from i in entities.EmployeeSchedulePlacementGridView
                    where i.ActorCompanyId == actorCompanyId &&
                    i.EmployeeId == employeeId &&
                    i.EmployeeScheduleStartDate <= date &&
                    i.EmployeeScheduleStopDate >= date
                    orderby i.EmployeeScheduleStartDate descending
                    select i).FirstOrDefault();
        }

        public EmployeeSchedulePlacementGridView GetLastPlacementForEmployee(int employeeId, int actorCompanyId, int? timeScheduleTemplateHeadId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedulePlacementGridView.NoTracking();
            return GetLastPlacementForEmployee(entities, employeeId, actorCompanyId, timeScheduleTemplateHeadId);
        }

        public EmployeeSchedulePlacementGridView GetLastPlacementForEmployee(CompEntities entities, int employeeId, int actorCompanyId, int? timeScheduleTemplateHeadId = null)
        {
            return (from i in entities.EmployeeSchedulePlacementGridView
                    where i.ActorCompanyId == actorCompanyId &&
                    i.EmployeeId == employeeId &&
                    (!timeScheduleTemplateHeadId.HasValue || i.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId.Value)
                    orderby i.EmployeeScheduleStartDate descending
                    select i).FirstOrDefault();
        }

        public ActionResult ValidateShortenEmployment(int employeeId, DateTime? oldDateFrom, DateTime? oldDateTo, DateTime? newDateFrom, DateTime? newDateTo, bool validateEmploymentChanges, EmploymentDTO changedEmployment = null, List<EmployeeSchedulePlacementGridViewDTO> employeePlacements = null, List<RecalculateTimeRecordDTO> scheduledEmployeePlacements = null, List<EmploymentDTO> employments = null)
        {
            ActionResult result = new ActionResult(true);

            if (changedEmployment != null && changedEmployment.IsSecondaryEmployment)
                return result;

            bool shortenDateFrom = CalendarUtility.IsNewDateAfterOldDate(newDateFrom, oldDateFrom); //Shorten from left
            bool shortenDateTo = CalendarUtility.IsNewDateBeforeOldDate(newDateTo, oldDateTo); //Shorten from right

            if (shortenDateFrom || shortenDateTo)
            {
                if (employeePlacements == null)
                    employeePlacements = GetPlacementsForEmployee(employeeId, base.ActorCompanyId).ToDTOs().ToList();
                if (scheduledEmployeePlacements == null)
                    scheduledEmployeePlacements = GetScheduledPlacements(employeeId).ToDTOs();

                bool invalidChange = false;
                string message = "";

                if (shortenDateFrom)
                {
                    #region Shorten from left

                    // Check changes
                    if (validateEmploymentChanges && newDateFrom.HasValue && changedEmployment.HasChangeThatStartsBefore(newDateFrom.Value))
                    {
                        message += AddHasEmploymentChangesThatStartsBeforeMessage(message, newDateFrom.Value);
                    }
                    // Check placement
                    if (HasPlacement(employeePlacements, oldDateFrom, newDateFrom))
                    {
                        message = AddHasPlacementMessage(message, oldDateFrom, newDateFrom);
                        invalidChange = true;
                    }

                    // Check scheduled placement
                    if (HasScheduledPlacement(scheduledEmployeePlacements, oldDateFrom, newDateFrom, out DateTime? schedulePlacementDateFrom, out DateTime? schedulePlacementDateTo))
                    {
                        message = AddHasSchedulePlacementMessage(message, schedulePlacementDateFrom, schedulePlacementDateTo);
                        invalidChange = true;
                    }

                    #endregion
                }
                else
                {
                    #region Shorten from right

                    // Check changes
                    if (validateEmploymentChanges && newDateTo.HasValue && changedEmployment.HasChangeThatStartsAfter(newDateTo.Value))
                    {
                        message += AddHasEmploymentChangesThatStartsAfterMessage(message, newDateTo.Value);
                    }
                    if (employments == null || !employments.Any(w => w.DateFrom == changedEmployment.DateFrom && w.DateTo == changedEmployment.DateTo && w.State == (int)SoeEntityState.Active && w.EmploymentId != changedEmployment.EmploymentId && !w.IsSecondaryEmployment))
                    {
                        // Check placement
                        if (HasPlacement(employeePlacements, newDateTo, oldDateTo))
                        {
                            message = AddHasPlacementMessage(message, newDateTo, oldDateTo);
                            invalidChange = true;
                        }

                        // Check scheduled placement
                        if (HasScheduledPlacement(scheduledEmployeePlacements, newDateTo, oldDateTo, out DateTime? schedulePlacementDateFrom, out DateTime? schedulePlacementDateTo))
                        {
                            message = AddHasSchedulePlacementMessage(message, schedulePlacementDateFrom, schedulePlacementDateTo);
                            invalidChange = true;
                        }
                    }

                    #endregion
                }

                if (!String.IsNullOrEmpty(message))
                {
                    result.Success = false;
                    result.ErrorMessage += message;
                    result.BooleanValue = invalidChange;
                }
            }

            return result;
        }

        private bool HasPlacement(List<EmployeeSchedulePlacementGridViewDTO> employeePlacements, DateTime? dateFrom, DateTime? dateTo)
        {
            if (employeePlacements == null || employeePlacements.Count == 0)
                return false;

            var dateRanges = new List<Tuple<DateTime?, DateTime?>>();
            foreach (var employeePlacement in employeePlacements.Where(i => i.EmployeeScheduleId > 0).OrderBy(i => i.EmployeeScheduleStartDate))
            {
                dateRanges.Add(Tuple.Create(employeePlacement.EmployeeScheduleStartDate, employeePlacement.EmployeeScheduleStopDate));
            }

            return CalendarUtility.IsDatesOverlappingNullable(dateFrom?.AddDays(1), dateTo, dateRanges, validateDatesAreTouching: false);
        }

        private bool HasScheduledPlacement(List<RecalculateTimeRecordDTO> scheduledEmployeePlacements, DateTime? dateFrom, DateTime? dateTo, out DateTime? schedulePlacementDateFrom, out DateTime? schedulePlacementDateTo)
        {
            schedulePlacementDateFrom = null;
            schedulePlacementDateTo = null;

            if (scheduledEmployeePlacements == null || scheduledEmployeePlacements.Count == 0)
                return false;

            var dateRanges = new List<Tuple<DateTime?, DateTime?>>();
            foreach (var scheduledEmployeePlacement in scheduledEmployeePlacements.OrderBy(i => i.StartDate))
            {
                dateRanges.Add(Tuple.Create(scheduledEmployeePlacement.StartDate, scheduledEmployeePlacement.StopDate));
            }

            bool isDatesOverlapping = CalendarUtility.IsDatesOverlappingNullable(dateFrom, dateTo, dateRanges);
            if (isDatesOverlapping && dateRanges.Count > 0)
            {
                if (dateRanges[0].Item1.HasValue)
                    schedulePlacementDateFrom = dateRanges[0].Item1.Value;
                if (dateRanges[0].Item2.HasValue)
                    schedulePlacementDateTo = dateRanges[0].Item2.Value;
            }

            return isDatesOverlapping;
        }

        private string AddHasEmploymentChangesThatStartsBeforeMessage(string message, DateTime date)
        {
            if (!String.IsNullOrEmpty(message))
                message += "\r\n";
            message += String.Format(GetText(11706, "Kontrollera! Förändringar i anställningen finns innan {0}"), date.ToShortDateString());
            message += ". \r\n";
            return message;
        }

        private string AddHasEmploymentChangesThatStartsAfterMessage(string message, DateTime date)
        {
            if (!String.IsNullOrEmpty(message))
                message += "\r\n";
            message += String.Format(GetText(11713, "Kontrollera! Förändringar i anställningen finns efter {0}"), date.ToShortDateString());
            message += ". \r\n";
            return message;
        }

        private string AddHasPlacementMessage(string message, DateTime? dateFrom, DateTime? dateTo)
        {
            if (!String.IsNullOrEmpty(message))
                message += "\r\n";
            message += String.Format(GetText(11703, "Åtgärdas! Aktiverat schema finns i perioden {0} - {1}. Det måste backas innan ändringarna kan sparas"), dateFrom.ToShortDateString(), dateTo.ToShortDateString());
            message += ". \r\n";
            return message;
        }

        private string AddHasSchedulePlacementMessage(string message, DateTime? dateFrom, DateTime? dateTo)
        {
            if (!String.IsNullOrEmpty(message))
                message += "\r\n";
            message += String.Format(GetText(11704, "Åtgärdas! Schemalagd aktivering i perioden {0} - {1}"), dateFrom.ToShortDateString(), dateTo.ToShortDateString());
            message += ". \r\n";
            message += GetText(11705, "Den schemalagda aktiveringen kommer inte att utföras korrekt om anställningen förkortas");
            message += ". \r\n";
            return message;
        }

        #endregion

        #region EvacuationList
        public ActionResult UpdateEvacuationList(EvacuationListDTO input, int headId, int userId, int actorCompanyId)
        {

            using (CompEntities entities = new CompEntities())
            {

                EvacuationListHead evacuationListHead = GetEvacuationListHead(entities, headId, includeRows: true);

                if (evacuationListHead == null)
                {
                    evacuationListHead = new EvacuationListHead()
                    {
                        ActorCompanyId = actorCompanyId,
                        UserId = userId,
                        Name = input.Name,

                    };
                    SetCreatedProperties(evacuationListHead);
                    entities.EvacuationListHead.AddObject(evacuationListHead);
                }

                #region Save

                if (input.EvacuationListRow.Any())
                {
                    foreach (EvacuationListRowDTO inputRow in input.EvacuationListRow)
                    {
                        EvacuationListRow row = evacuationListHead.EvacuationListRow.FirstOrDefault(w => w.EmployeeId == inputRow.EmployeeId && w.State == (int)SoeEntityState.Active);
                        if (row != null)
                        {
                            if (inputRow.Marked)
                            {
                                row.State = (int)SoeEntityState.Active;
                                SetModifiedProperties(row);
                            }
                            else
                            {
                                ChangeEntityState(entities, row, SoeEntityState.Deleted, false);
                            }

                        }
                        else if (inputRow.Marked)
                        {
                            EvacuationListRow newRow = new EvacuationListRow()
                            {
                                EvacuationListHeadId = evacuationListHead.EvacuationListHeadId,
                                EmployeeId = inputRow.EmployeeId,
                                State = (int)SoeEntityState.Active
                            };
                            SetCreatedProperties(newRow);
                            entities.EvacuationListRow.AddObject(newRow);
                        }
                    }
                }

                #endregion

                ActionResult result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                result.IntegerValue = evacuationListHead.EvacuationListHeadId;

                return result;
            }
        }
        public EvacuationListHead GetEvacuationListHead(CompEntities entities, int headId, bool includeRows = false)
        {
            IQueryable<EvacuationListHead> query = (from e in entities.EvacuationListHead
                                                    where e.State == (int)SoeEntityState.Active &&
                                                    e.EvacuationListHeadId == headId
                                                    select e);

            if (includeRows)
                query = query.Include("EvacuationListRow");

            return query.FirstOrDefault();
        }

        public EvacuationListDTO GetEvacuationListFromEmployeeIds(int userId, int actorCompanyId, List<int> employeeIds, DateTime date)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.EvacuationListRow.NoTracking();
            entitiesReadOnly.EvacuationListHead.NoTracking();
            List<EvacuationListRow> rows = (from e in entitiesReadOnly.EvacuationListRow.Include("EvacuationListHead")
                                            where
                                            employeeIds.Contains(e.EmployeeId) &&
                                            e.EvacuationListHead.ActorCompanyId == actorCompanyId &&
                                            ((e.Created.HasValue && e.Created.Value >= date) || (e.Modified.HasValue && e.Modified.Value >= date))
                                            select e).ToList();

            EvacuationListDTO result = new EvacuationListDTO(actorCompanyId, userId, string.Empty);

            if (rows.Any())
            {
                foreach (EvacuationListRow row in rows)
                {
                    result.EvacuationListRow.Add(new EvacuationListRowDTO(row.EmployeeId, row.EvacuationListHead.UserId, row.EvacuationListHeadId, row.EvacuationListHead.Name, (SoeEntityState)row.State, row.Created, row.Modified));
                }
            }

            return result;
        }


        #endregion

        #region ActivateSchedule

        public List<ActivateScheduleGridDTO> GetPlacementsForGrid(int roleId, bool onlyLatest, bool addEmptyPlacement, List<int> employeeIds = null, DateTime? dateFrom = null, DateTime? dateTo = null)
        {
            List<ActivateScheduleGridDTO> items = new List<ActivateScheduleGridDTO>();

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<EmployeeGroup> employeeGroups = GetEmployeeGroupsFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId));
            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, base.ActorCompanyId, base.UserId, roleId, dateFrom: dateFrom, dateTo: dateTo, getHidden: true, employeeFilter: employeeIds, addEmployeeAuthModelInfo: true, loadScheduleAndTemplateHead: true);
            foreach (Employee employee in employees)
            {
                if (employee.EmployeeSchedule == null || !employee.EmployeeSchedule.Any(es => es.State != (int)SoeEntityState.Deleted))
                {
                    if (addEmptyPlacement)
                        items.Add(CreateActivateScheduleGridDTO(employee, employeeGroups, null, employee.CategoryNames, employee.AccountNames, dateFrom));
                }
                else
                {
                    int counter = 0;
                    foreach (EmployeeSchedule employeeSchedule in employee.EmployeeSchedule.Where(es => es.State != (int)SoeEntityState.Deleted).OrderByDescending(es => es.StartDate).ThenByDescending(es => es.StopDate).ToList())
                    {
                        counter++;
                        if (onlyLatest && counter > 1)
                            break;

                        items.Add(CreateActivateScheduleGridDTO(employee, employeeGroups, employeeSchedule, employee.CategoryNames, employee.AccountNames, dateFrom));
                    }
                }
            }

            return items.OrderBy(i => i.EmployeeNr.PadLeft(50, '0')).ThenByDescending(i => i.EmployeeScheduleStartDate).ThenByDescending(i => i.EmployeeScheduleStopDate).ToList();
        }

        private ActivateScheduleGridDTO CreateActivateScheduleGridDTO(Employee employee, List<EmployeeGroup> employeeGroups, EmployeeSchedule employeeSchedule, List<string> categoryNames, List<string> accountNames, DateTime? date = null)
        {
            Employment employment = employee.GetEmployment(date);
            Employment lastEmployment = employee.GetLastEmployment();
            EmployeeGroup employeeGroup = employment?.GetEmployeeGroup(date, employeeGroups);

            ActivateScheduleGridDTO dto = new ActivateScheduleGridDTO()
            {
                EmployeeScheduleId = employeeSchedule?.EmployeeScheduleId ?? 0,
                IsPlaced = employeeSchedule != null,
                IsPreliminary = employeeSchedule?.IsPreliminary ?? false,
                EmployeeScheduleStartDate = employeeSchedule?.StartDate,
                EmployeeScheduleStopDate = employeeSchedule?.StopDate,
                EmployeeScheduleStartDayNumber = employeeSchedule?.StartDayNumber ?? 0,
                EmployeeId = employee.EmployeeId,
                EmployeeNr = employee.EmployeeNr != "0" ? employee.EmployeeNr : String.Empty,
                EmployeeName = employee.ContactPerson.Name,
                EmploymentEndDate = lastEmployment?.DateTo,
                EmployeeHidden = employee.Hidden,
                TimeScheduleTemplateHeadId = employeeSchedule?.TimeScheduleTemplateHeadId ?? 0,
                TimeScheduleTemplateHeadName = employeeSchedule?.TimeScheduleTemplateHead.Name ?? String.Empty,
                TemplateEmployeeId = employeeSchedule?.TimeScheduleTemplateHead?.EmployeeId ?? 0,
                TemplateStartDate = employeeSchedule?.TimeScheduleTemplateHead?.StartDate,
                SimpleSchedule = employeeSchedule?.TimeScheduleTemplateHead?.SimpleSchedule ?? false,
                EmployeeGroupId = employeeGroup?.EmployeeGroupId ?? 0,
                EmployeeGroupName = employeeGroup?.Name,
                CategoryNamesString = StringUtility.GetCommaSeparatedString(categoryNames, addWhiteSpace: true),
                AccountNamesString = StringUtility.GetCommaSeparatedString(accountNames, addWhiteSpace: true),
            };

            return dto;
        }

        #endregion

        #region IncomingDelivery

        public List<IncomingDeliveryHead> GetIncomingDeliveries(int actorCompanyId, bool setRecurringDescription = false, bool loadRows = false, bool loadAccounting = false, bool loadAccountHierarchyAccount = false, int? incomingDeliveryHeadId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            entities.IncomingDeliveryHead.NoTracking();
            IQueryable<IncomingDeliveryHead> query = (from h in entities.IncomingDeliveryHead
                                                      where h.ActorCompanyId == actorCompanyId &&
                                                      h.State == (int)SoeEntityState.Active
                                                      orderby h.Name
                                                      select h);

            if (loadAccountHierarchyAccount)
                query = query.Include("Account");
            if (loadRows)
                query = query.Include("IncomingDeliveryRow");
            if (loadAccounting)
                query = query.Include("IncomingDeliveryRow.AccountInternal.Account.AccountDim");

            if (useAccountHierarchy)
            {
                if (!loadAccountHierarchyAccount) query = query.Include("Account");
                List<int> accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(h => !h.AccountId.HasValue || accountIds.Contains(h.AccountId.Value));
                else
                    query = query.Where(h => !h.AccountId.HasValue);
            }

            if (incomingDeliveryHeadId.HasValue)
                query = query.Where(h => h.IncomingDeliveryHeadId == incomingDeliveryHeadId.Value);

            List<IncomingDeliveryHead> heads = query.ToList();

            if (setRecurringDescription)
            {
                List<SysHolidayTypeDTO> sysHolidays = CalendarManager.GetSysHolidayTypeDTOs();

                foreach (IncomingDeliveryHead head in heads)
                {
                    head.RecurrencePatternDescription = GetRecurrenceDescription(head.RecurrencePattern, sysHolidays);
                    head.RecurrenceStartsOnDescription = GetRecurrenceStartsOnDescription(head.StartDate);
                    head.RecurrenceEndsOnDescription = GetRecurrenceEndsOnDescription(head.StopDate, head.NbrOfOccurrences);
                }
            }

            return heads;
        }

        public List<IncomingDeliveryHead> GetIncomingDeliveries(int actorCompanyId, DateTime dateFrom, DateTime dateTo, List<int> ids = null, bool setRecurringDescription = false, bool loadRows = false, bool loadAccounting = false, bool doIncludeRemovedDates = false, bool loadDeliveryType = false, bool loadTimeScheduleTemplateBlockTask = false, bool loadShiftType = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            dateFrom = dateFrom.Date;
            dateTo = dateTo.Date;

            entities.IncomingDeliveryHead.NoTracking();
            IQueryable<IncomingDeliveryHead> query = (from t in entities.IncomingDeliveryHead
                                                        .Include("IncomingDeliveryHeadExcludedDate")
                                                      where t.ActorCompanyId == actorCompanyId &&
                                                      t.StartDate <= dateTo &&
                                                      (!t.StopDate.HasValue || t.StopDate.Value >= dateFrom) &&
                                                      t.State == (int)SoeEntityState.Active
                                                      select t);

            if (loadRows || loadTimeScheduleTemplateBlockTask)
                query = query.Include("IncomingDeliveryRow");
            if (loadAccounting)
            {
                query = query.Include("Account");
                query = query.Include("IncomingDeliveryRow.AccountInternal.Account.AccountDim");
            }
            if (loadDeliveryType)
                query = query.Include("IncomingDeliveryRow.IncomingDeliveryType");
            if (loadShiftType)
                query = query.Include("IncomingDeliveryRow.ShiftType");
            if (ids != null && ids.Count > 0)
                query = query.Where(t => ids.Contains(t.IncomingDeliveryHeadId));

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            List<IncomingDeliveryHead> incomingDeliveryHeads = query.ToList();
            List<IncomingDeliveryHead> validIncomingDeliveryHeads = GetValidatedInComingDeliveryHeads(actorCompanyId, incomingDeliveryHeads, dateFrom, dateTo, setRecurringDescription, doIncludeRemovedDates);

            if (loadTimeScheduleTemplateBlockTask)
                LoadAndConnectBlockTasksToIncomingDeliveryRows(validIncomingDeliveryHeads, dateFrom, dateTo);

            return validIncomingDeliveryHeads;
        }

        public List<IncomingDeliveryHead> GetValidatedInComingDeliveryHeads(int actorCompanyId, List<IncomingDeliveryHead> incomingDeliveryHeads, DateTime dateFrom, DateTime dateTo, bool setRecurringDescription = false, bool doIncludeRemovedDates = false)
        {
            List<IncomingDeliveryHead> validIncomingDeliveryHeads = new List<IncomingDeliveryHead>();
            List<SysHolidayTypeDTO> sysHolidays = null;
            if (setRecurringDescription)
                sysHolidays = CalendarManager.GetSysHolidayTypeDTOs();

            foreach (IncomingDeliveryHead incomingDeliveryHead in incomingDeliveryHeads)
            {
                if (setRecurringDescription)
                {
                    incomingDeliveryHead.RecurrencePatternDescription = GetRecurrenceDescription(incomingDeliveryHead.RecurrencePattern, sysHolidays);
                    incomingDeliveryHead.RecurrenceStartsOnDescription = GetRecurrenceStartsOnDescription(incomingDeliveryHead.StartDate);
                    incomingDeliveryHead.RecurrenceEndsOnDescription = GetRecurrenceEndsOnDescription(incomingDeliveryHead.StopDate, incomingDeliveryHead.NbrOfOccurrences);
                }

                bool isSysHolidayTypePattern = DailyRecurrencePatternDTO.IsSysHolidayTypePattern(incomingDeliveryHead.RecurrencePattern);
                incomingDeliveryHead.RecurringDates = DailyRecurrencePatternDTO.GetDatesFromPattern(incomingDeliveryHead.RecurrencePattern, incomingDeliveryHead.StartDate, dateFrom, CalendarUtility.GetEarliestDate(dateTo, incomingDeliveryHead.StopDate), incomingDeliveryHead.NbrOfOccurrences, incomingDeliveryHead.IncomingDeliveryHeadExcludedDate.Select(i => i.Date).ToList(), isSysHolidayTypePattern ? CalendarManager.GetHolidaysByCompany(actorCompanyId, dateFrom, dateTo) : null);

                // No recurrence, just add the deliverys start date if inside interval
                if (incomingDeliveryHead.HasNoRecurrencePattern() && !incomingDeliveryHead.RecurringDates.HasRecurringDates(doIncludeRemovedDates) && incomingDeliveryHead.StartDate >= dateFrom && incomingDeliveryHead.StartDate <= dateTo)
                    incomingDeliveryHead.RecurringDates.AddRecurringDate(incomingDeliveryHead.StartDate);
                if (incomingDeliveryHead.RecurringDates.HasRecurringDates(doIncludeRemovedDates))
                    validIncomingDeliveryHeads.Add(incomingDeliveryHead);
            }

            return validIncomingDeliveryHeads;
        }

        private void LoadAndConnectBlockTasksToIncomingDeliveryRows(List<IncomingDeliveryHead> incomingDeliveryHeads, DateTime dateFrom, DateTime dateTo)
        {
            var incomingDeliveryRowIds = incomingDeliveryHeads.SelectMany(i => i.IncomingDeliveryRow.Where(w => w.State == (int)SoeEntityState.Active).Select(r => r.IncomingDeliveryRowId)).ToList();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var timeScheduleTemplateBlockTasks = GetTimeScheduleTemplateBlockTasksFromIncomingDeliveryRowIds(entitiesReadOnly, incomingDeliveryRowIds, dateFrom, dateTo);

            foreach (var row in incomingDeliveryHeads.SelectMany(i => i.IncomingDeliveryRow))
            {
                row.ConnectedTimeScheduleTemplateBlockTasks = timeScheduleTemplateBlockTasks.Where(w => w.IncomingDeliveryRowId == row.IncomingDeliveryRowId).ToList();
            }
        }

        private List<TimeScheduleTemplateBlockTask> GetTimeScheduleTemplateBlockTasksFromIncomingDeliveryRowIds(CompEntities entities, List<int> incomingDeliveryRowIds, DateTime dateFrom, DateTime dateTo)
        {
            return entities.TimeScheduleTemplateBlockTask.Include("TimeScheduleTemplateBlock").Where(w => w.TimeScheduleTemplateBlock.Date.HasValue && w.TimeScheduleTemplateBlock.Date.Value >= dateFrom && w.TimeScheduleTemplateBlock.Date.Value <= dateTo && w.State == (int)SoeEntityState.Active && w.IncomingDeliveryRowId.HasValue && incomingDeliveryRowIds.Contains(w.IncomingDeliveryRowId.Value)).ToList();
        }

        public IncomingDeliveryHead GetIncomingDelivery(int incomingDeliveryHeadId, int actorCompanyId, bool loadAccounts = false, bool loadRows = false, bool loadTimeScheduleTemplateBlockTasks = false, bool loadStaffingNeedsRowPeriod = false, bool loadExcludedDates = false, bool loadAccountHierarchyAccount = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.IncomingDeliveryHead.NoTracking();
            return GetIncomingDelivery(entities, incomingDeliveryHeadId, actorCompanyId, loadAccounts, loadRows, loadTimeScheduleTemplateBlockTasks, loadStaffingNeedsRowPeriod, loadExcludedDates, loadAccountHierarchyAccount);
        }

        public IncomingDeliveryHead GetIncomingDelivery(CompEntities entities, int incomingDeliveryHeadId, int actorCompanyId, bool loadAccounts = false, bool loadRows = false, bool loadTimeScheduleTemplateBlockTasks = false, bool loadStaffingNeedsRowPeriod = false, bool loadExcludedDates = false, bool loadAccountHierarchyAccount = false)
        {
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);

            IQueryable<IncomingDeliveryHead> query = (from id in entities.IncomingDeliveryHead
                                                      where id.ActorCompanyId == actorCompanyId &&
              id.IncomingDeliveryHeadId == incomingDeliveryHeadId &&
              id.State == (int)SoeEntityState.Active
                                                      select id);
            if (loadAccountHierarchyAccount)
                query = query.Include("Account");
            if (loadRows)
            {
                query = query.Include("IncomingDeliveryRow.ShiftType");
                query = query.Include("IncomingDeliveryRow.IncomingDeliveryType");
            }
            if (loadStaffingNeedsRowPeriod)
                query = query.Include("IncomingDeliveryRow.StaffingNeedsRowPeriod.StaffingNeedsRow");
            if (loadAccounts)
                query = query.Include("IncomingDeliveryRow.AccountInternal.Account.AccountDim");
            if (loadExcludedDates)
                query = query.Include("IncomingDeliveryHeadExcludedDate");

            if (useAccountHierarchy)
            {
                if (!loadAccountHierarchyAccount) query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.FirstOrDefault();
        }

        public bool ExistsIncomingDeliveryHead(string name, int actorCompanyId, int? excludeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.IncomingDeliveryHead.NoTracking();
            return ExistsIncomingDeliveryHead(entities, name, actorCompanyId, excludeId);
        }

        public bool ExistsIncomingDeliveryHead(CompEntities entities, string name, int actorCompanyId, int? excludeId = null)
        {
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);
            IQueryable<IncomingDeliveryHead> query = (from id in entities.IncomingDeliveryHead
                                                      where id.ActorCompanyId == actorCompanyId &&
                                                      (!excludeId.HasValue || id.IncomingDeliveryHeadId == excludeId.Value) &&
                                                      id.State == (int)SoeEntityState.Active
                                                      select id);

            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.Any();
        }

        public ActionResult SaveIncomingDelivery(IncomingDeliveryHeadDTO incomingDeliveryHeadInput, int actorCompanyId)
        {
            if (incomingDeliveryHeadInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "IncomingDeliveryHead");
            if (incomingDeliveryHeadInput.Rows == null)
                incomingDeliveryHeadInput.Rows = new List<IncomingDeliveryRowDTO>();

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                #region IncomingDeliveryHead

                IncomingDeliveryHead incomingDeliveryHead = GetIncomingDelivery(entities, incomingDeliveryHeadInput.IncomingDeliveryHeadId, actorCompanyId, loadRows: true, loadTimeScheduleTemplateBlockTasks: true, loadStaffingNeedsRowPeriod: true, loadExcludedDates: true);
                if (incomingDeliveryHead == null)
                {
                    incomingDeliveryHead = new IncomingDeliveryHead()
                    {
                        Company = company,
                    };
                    SetCreatedProperties(incomingDeliveryHead);
                    entities.IncomingDeliveryHead.AddObject(incomingDeliveryHead);
                }
                else
                {
                    SetModifiedProperties(incomingDeliveryHead);
                }

                incomingDeliveryHead.Name = incomingDeliveryHeadInput.Name;
                incomingDeliveryHead.Description = incomingDeliveryHeadInput.Description;
                incomingDeliveryHead.StartDate = incomingDeliveryHeadInput.StartDate > CalendarUtility.DATETIME_DEFAULT ? CalendarUtility.ClearSeconds(incomingDeliveryHeadInput.StartDate) : DateTime.Today;
                incomingDeliveryHead.StopDate = incomingDeliveryHeadInput.StopDate.HasValue && incomingDeliveryHeadInput.StopDate.Value > CalendarUtility.DATETIME_DEFAULT ? CalendarUtility.ClearSeconds(incomingDeliveryHeadInput.StopDate.Value) : (DateTime?)null;
                incomingDeliveryHead.AccountId = incomingDeliveryHeadInput.AccountId.HasValue && incomingDeliveryHeadInput.AccountId.Value != 0 ? incomingDeliveryHeadInput.AccountId : (int?)null;
                incomingDeliveryHead.NbrOfOccurrences = incomingDeliveryHeadInput.NbrOfOccurrences;
                incomingDeliveryHead.RecurrencePattern = incomingDeliveryHeadInput.RecurrencePattern;
                if (String.IsNullOrEmpty(incomingDeliveryHead.RecurrencePattern))
                    incomingDeliveryHead.RecurrencePattern = new DailyRecurrencePatternDTO().ToString();

                // Excluded dates
                if (incomingDeliveryHead.IncomingDeliveryHeadExcludedDate != null)
                {
                    foreach (var item in incomingDeliveryHead.IncomingDeliveryHeadExcludedDate.ToList())
                    {
                        entities.DeleteObject(item);
                    }
                    incomingDeliveryHead.IncomingDeliveryHeadExcludedDate.Clear();
                }
                else
                {
                    incomingDeliveryHead.IncomingDeliveryHeadExcludedDate = new EntityCollection<IncomingDeliveryHeadExcludedDate>();
                }

                foreach (DateTime excludedDate in incomingDeliveryHeadInput.ExcludedDates.Distinct().ToList())
                {
                    incomingDeliveryHead.IncomingDeliveryHeadExcludedDate.Add(new IncomingDeliveryHeadExcludedDate(excludedDate));
                }

                #endregion

                #region IncomingDeliveryRow

                List<IncomingDeliveryRow> existingIncomingDeliveryRows = incomingDeliveryHead.IncomingDeliveryHeadId > 0 ? incomingDeliveryHead.IncomingDeliveryRow.Where(x => x.State == (int)SoeEntityState.Active).ToList() : new List<IncomingDeliveryRow>();

                #region Delete rows that exists in db but not in input.

                foreach (var existingIncomingDeliveryRow in existingIncomingDeliveryRows)
                {
                    if (incomingDeliveryHeadInput.Rows.Any(x => x.IncomingDeliveryRowId == existingIncomingDeliveryRow.IncomingDeliveryRowId))
                        continue;

                    if (existingIncomingDeliveryRow.TimeScheduleTemplateBlockTask != null && existingIncomingDeliveryRow.TimeScheduleTemplateBlockTask.Any(i => i.State == (int)SoeEntityState.Active))
                        return new ActionResult((int)ActionResultDelete.IncomingDeliveryIsUsed, String.Format(GetText(11523, "Raden {0} kan inte tas bort, den används i ett aktivt schema"), existingIncomingDeliveryRow.Name));

                    if (existingIncomingDeliveryRow.StaffingNeedsRowPeriod != null && existingIncomingDeliveryRow.StaffingNeedsRowPeriod.Any(i => i.State == (int)SoeEntityState.Active))
                    {
                        // Period may be active even if row is deleted, so we need to check the row
                        foreach (StaffingNeedsRowPeriod period in existingIncomingDeliveryRow.StaffingNeedsRowPeriod.Where(i => i.State == (int)SoeEntityState.Active))
                        {
                            if (period?.StaffingNeedsRow.State == (int)SoeEntityState.Active)
                                return new ActionResult((int)ActionResultDelete.IncomingDeliveryIsUsed, String.Format(GetText(11524, "Raden {0} kan inte tas bort, den används i ett behov"), existingIncomingDeliveryRow.Name));
                        }
                    }

                    ChangeEntityState(existingIncomingDeliveryRow, SoeEntityState.Deleted);
                }

                #endregion

                #region Add/update rows

                foreach (var incomingDeliveryRowInput in incomingDeliveryHeadInput.Rows)
                {
                    IncomingDeliveryRow existingIncomingDeliveryRow = existingIncomingDeliveryRows.FirstOrDefault(x => x.IncomingDeliveryRowId == incomingDeliveryRowInput.IncomingDeliveryRowId);
                    if (existingIncomingDeliveryRow == null)
                    {
                        existingIncomingDeliveryRow = new IncomingDeliveryRow()
                        {
                            IncomingDeliveryHead = incomingDeliveryHead,
                            State = (int)SoeEntityState.Active,
                        };
                        SetCreatedProperties(existingIncomingDeliveryRow);
                        entities.IncomingDeliveryRow.AddObject(existingIncomingDeliveryRow);
                    }
                    else
                    {
                        SetModifiedProperties(existingIncomingDeliveryRow);
                    }

                    #region Common

                    if (incomingDeliveryRowInput.IncomingDeliveryTypeId == 0)
                        return new ActionResult((int)ActionResultSave.EntityIsNull, GetText(91989, "Typ av leverans måste anges"));

                    existingIncomingDeliveryRow.ShiftTypeId = incomingDeliveryRowInput.ShiftTypeId.ToNullable();
                    existingIncomingDeliveryRow.IncomingDeliveryTypeId = incomingDeliveryRowInput.IncomingDeliveryTypeId;
                    existingIncomingDeliveryRow.Name = incomingDeliveryRowInput.Name;
                    existingIncomingDeliveryRow.Description = incomingDeliveryRowInput.Description;
                    existingIncomingDeliveryRow.NbrOfPackages = incomingDeliveryRowInput.NbrOfPackages;
                    existingIncomingDeliveryRow.NbrOfPersons = incomingDeliveryRowInput.NbrOfPersons;
                    existingIncomingDeliveryRow.MinSplitLength = incomingDeliveryRowInput.MinSplitLength;
                    existingIncomingDeliveryRow.OnlyOneEmployee = incomingDeliveryRowInput.OnlyOneEmployee;
                    existingIncomingDeliveryRow.AllowOverlapping = incomingDeliveryRowInput.AllowOverlapping;
                    existingIncomingDeliveryRow.DontAssignBreakLeftovers = incomingDeliveryRowInput.DontAssignBreakLeftovers;

                    if (incomingDeliveryRowInput.OffsetDays < 0)
                        incomingDeliveryRowInput.OffsetDays = 0;

                    if (incomingDeliveryRowInput.StartTime.HasValue)
                        existingIncomingDeliveryRow.StartTime = CalendarUtility.GetDateTime(CalendarUtility.DATETIME_DEFAULT.AddDays(incomingDeliveryRowInput.OffsetDays), CalendarUtility.ClearSeconds(incomingDeliveryRowInput.StartTime.Value));
                    else
                        existingIncomingDeliveryRow.StartTime = null;

                    if (incomingDeliveryRowInput.StopTime.HasValue)
                        existingIncomingDeliveryRow.StopTime = CalendarUtility.GetDateTime(CalendarUtility.DATETIME_DEFAULT.AddDays(incomingDeliveryRowInput.OffsetDays), CalendarUtility.ClearSeconds(incomingDeliveryRowInput.StopTime.Value));
                    else
                        existingIncomingDeliveryRow.StopTime = null;

                    if (incomingDeliveryRowInput.StartTime.HasValue)
                        incomingDeliveryRowInput.StartTime = CalendarUtility.ClearSeconds(incomingDeliveryRowInput.StartTime.Value);
                    if (incomingDeliveryRowInput.StopTime.HasValue)
                        incomingDeliveryRowInput.StopTime = CalendarUtility.ClearSeconds(incomingDeliveryRowInput.StopTime.Value);

                    if (incomingDeliveryRowInput.Length == 0 && incomingDeliveryRowInput.StartTime.HasValue && incomingDeliveryRowInput.StopTime.HasValue)
                        existingIncomingDeliveryRow.Length = (int)existingIncomingDeliveryRow.StopTime.Value.Subtract(CalendarUtility.ClearSeconds(existingIncomingDeliveryRow.StartTime.Value)).TotalMinutes;
                    else
                        existingIncomingDeliveryRow.Length = incomingDeliveryRowInput.Length;

                    #endregion
                }

                #endregion

                #endregion

                ActionResult result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                result.IntegerValue = incomingDeliveryHead.IncomingDeliveryHeadId;
                return result;
            }
        }

        public ActionResult DeleteIncomingDelivery(int incomingDeliveryHeadId, int actorCompanyId)
        {
            ActionResult result = null;

            using (CompEntities entities = new CompEntities())
            {
                IncomingDeliveryHead incomingDeliveryHead = GetIncomingDelivery(entities, incomingDeliveryHeadId, actorCompanyId, loadRows: true, loadTimeScheduleTemplateBlockTasks: true, loadStaffingNeedsRowPeriod: true);
                if (incomingDeliveryHead == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "IncomingDeliveryHead");

                foreach (IncomingDeliveryRow incomingDeliveryRow in incomingDeliveryHead.IncomingDeliveryRow)
                {
                    if (incomingDeliveryRow.StaffingNeedsRowPeriod != null && incomingDeliveryRow.StaffingNeedsRowPeriod.Any(i => i.State == (int)SoeEntityState.Active))
                    {
                        // Period may be active even if row is deleted, so we need to check the row
                        foreach (StaffingNeedsRowPeriod period in incomingDeliveryRow.StaffingNeedsRowPeriod.Where(i => i.State == (int)SoeEntityState.Active))
                        {
                            if (period.StaffingNeedsRow != null && period.StaffingNeedsRow.State == (int)SoeEntityState.Active)
                                return new ActionResult((int)ActionResultDelete.IncomingDeliveryIsUsed, GetText(11522, "Kan inte tas bort, den används i ett behov"));
                        }
                    }
                    if (incomingDeliveryRow.TimeScheduleTemplateBlockTask != null && incomingDeliveryRow.TimeScheduleTemplateBlockTask.Any(i => i.IsTaskActive()))
                        return new ActionResult((int)ActionResultDelete.IncomingDeliveryIsUsed, GetText(11521, "Kan inte tas bort, den används i ett aktivt schema"));

                    result = ChangeEntityState(entities, incomingDeliveryRow, SoeEntityState.Deleted, false);
                    if (!result.Success)
                        return result;
                }

                result = ChangeEntityState(entities, incomingDeliveryHead, SoeEntityState.Deleted, false);
                if (!result.Success)
                    return result;

                result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                return result;
            }
        }

        #endregion

        #region IncominDeliveryRow

        public List<IncomingDeliveryRow> GetIncomingDeliveryRows(int incomingDeliveryHeadId, bool loadAccounts)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.IncomingDeliveryRow.NoTracking();
            IQueryable<IncomingDeliveryRow> query = entitiesReadOnly.IncomingDeliveryRow;
            query = query.Include("IncomingDeliveryType");
            query = query.Include("ShiftType");
            if (loadAccounts)
                query = query.Include("AccountInternal.Account.AccountDim");

            query.Include("IncomingDeliveryType");

            return (from id in query
                    where id.IncomingDeliveryHeadId == incomingDeliveryHeadId &&
                    id.State == (int)SoeEntityState.Active
                    select id).ToList();
        }

        #endregion

        #region IncomingDeliveryType

        public List<IncomingDeliveryType> GetIncomingDeliveryTypes(int actorCompanyId, int? incomingDeliveryTypeId = null)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            IQueryable<IncomingDeliveryType> query = (from id in entitiesReadOnly.IncomingDeliveryType
                                                      where id.ActorCompanyId == actorCompanyId &&
                                                      id.State == (int)SoeEntityState.Active
                                                      select id);

            if (incomingDeliveryTypeId.HasValue)
                query = query.Where(dt => dt.IncomingDeliveryTypeId == incomingDeliveryTypeId.Value);

            bool useAccountHierarchy = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseAccountHierarchy, 0, actorCompanyId, 0);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                List<int> accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.ToList();
        }

        public Dictionary<int, string> GetIncomingDeliveryTypesDict(int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            IEnumerable<IncomingDeliveryType> incomingDeliveryTypes = GetIncomingDeliveryTypes(actorCompanyId);
            foreach (IncomingDeliveryType incomingDeliveryType in incomingDeliveryTypes)
            {
                dict.Add(incomingDeliveryType.IncomingDeliveryTypeId, incomingDeliveryType.Name);
            }

            return dict;
        }

        public IncomingDeliveryType GetIncomingDeliveryType(int incomingDeliveryTypeId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.IncomingDeliveryType.NoTracking();
            return GetIncomingDeliveryType(entities, incomingDeliveryTypeId, actorCompanyId);
        }

        public IncomingDeliveryType GetIncomingDeliveryType(CompEntities entities, int incomingDeliveryTypeId, int actorCompanyId)
        {

            IQueryable<IncomingDeliveryType> query = (from id in entities.IncomingDeliveryType
                                                      where id.ActorCompanyId == actorCompanyId &&
                                                      id.IncomingDeliveryTypeId == incomingDeliveryTypeId &&
                                                      id.State == (int)SoeEntityState.Active
                                                      select id);

            bool useAccountHierarchy = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseAccountHierarchy, 0, actorCompanyId, 0);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.FirstOrDefault();
        }

        public ActionResult SaveIncomingDeliveryType(IncomingDeliveryTypeDTO incomingDeliveryTypeInput, int actorCompanyId)
        {
            if (incomingDeliveryTypeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "IncomingDeliveryType");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                // Get original type
                IncomingDeliveryType incomingDeliveryType = GetIncomingDeliveryType(entities, incomingDeliveryTypeInput.IncomingDeliveryTypeId, actorCompanyId);
                if (incomingDeliveryType == null)
                {
                    incomingDeliveryType = new IncomingDeliveryType()
                    {
                        Company = company,
                    };
                    SetCreatedProperties(incomingDeliveryType);
                    entities.IncomingDeliveryType.AddObject(incomingDeliveryType);
                }
                else
                {
                    SetModifiedProperties(incomingDeliveryType);
                }

                incomingDeliveryType.Name = incomingDeliveryTypeInput.Name;
                incomingDeliveryType.Description = incomingDeliveryTypeInput.Description;
                incomingDeliveryType.Length = incomingDeliveryTypeInput.Length;
                incomingDeliveryType.NbrOfPersons = incomingDeliveryTypeInput.NbrOfPersons;
                incomingDeliveryType.AccountId = incomingDeliveryTypeInput.AccountId;

                ActionResult result = SaveChanges(entities);
                if (!result.Success)
                    return result;

                result.IntegerValue = incomingDeliveryType.IncomingDeliveryTypeId;

                return result;
            }
        }

        public ActionResult DeleteIncomingDeliveryType(int incomingDeliveryTypeId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                IncomingDeliveryType incomingDeliveryType = GetIncomingDeliveryType(entities, incomingDeliveryTypeId, actorCompanyId);
                if (incomingDeliveryType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "IncomingDeliveryType");

                return DeleteEntityItem(entities, incomingDeliveryType);
            }
        }

        #endregion

        #region Order planning

        public bool includeDeliveryAddressOnOrder(int userId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return includeDeliveryAddressOnOrder(entities, userId, actorCompanyId);
        }

        public bool includeDeliveryAddressOnOrder(CompEntities entities, int userId, int actorCompanyId)
        {
            TermGroup_OrderPlanningShiftInfo info = (TermGroup_OrderPlanningShiftInfo)SettingManager.GetIntSetting(entities, SettingMainType.User, (int)UserSettingType.BillingOrderPlanningShiftInfoBottomRight, userId, actorCompanyId, 0);
            if (info == TermGroup_OrderPlanningShiftInfo.DeliveryAddress)
            {
                return true;
            }
            else
            {
                info = (TermGroup_OrderPlanningShiftInfo)SettingManager.GetIntSetting(entities, SettingMainType.User, (int)UserSettingType.BillingOrderPlanningShiftInfoBottomLeft, userId, actorCompanyId, 0);
                if (info == TermGroup_OrderPlanningShiftInfo.DeliveryAddress)
                    return true;
            }

            return false;
        }

        public List<OrderListDTO> GetUnscheduledOrders(int actorCompanyId, DateTime? dateTo, List<int> categoryIds, bool includeAttestStates, bool includeDeliveryAddress)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetUnscheduledOrders(entities, actorCompanyId, dateTo, categoryIds, includeAttestStates, includeDeliveryAddress);
        }

        public List<OrderListDTO> GetUnscheduledOrders(CompEntities entities, int actorCompanyId, DateTime? dateTo, List<int> categoryIds, bool includeAttestStates, bool includeDeliveryAddress)
        {
            if (dateTo.HasValue)
                dateTo = CalendarUtility.GetEndOfDay(dateTo.Value);

            IQueryable<CustomerInvoice> query = (from c in entities.Invoice.OfType<CustomerInvoice>()
                                                 where c.Origin.ActorCompanyId == actorCompanyId &&
                                                     //c.PlannedStartDate.HasValue &&
                                                     (c.RemainingTime > 0 || c.KeepAsPlanned) &&
                                                     c.State == (int)SoeEntityState.Active &&
                                                     c.Origin.Type == (int)SoeOriginType.Order &&
                                                     (c.Origin.Status != (int)SoeOriginStatus.Cancel &&
                                                     c.Origin.Status != (int)SoeOriginStatus.OrderClosed &&
                                                     c.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice)
                                                 select c);

            if (dateTo.HasValue)
            {
                query = query.Where(c => !c.PlannedStartDate.HasValue || c.PlannedStartDate.Value <= dateTo.Value);
            }

            var orderList = query.Select(EntityExtensions.GetOrderListDTO).ToList();

            // Filter on shift types (from category)
            List<int> shiftTypeIds = GetShiftTypeIdsForUsersCategories(entities, actorCompanyId, 0, 0, true, true, categoryIds);
            if (shiftTypeIds.Count > 0)
            {
                // This filter is performed after the actual SQL query.
                // The reason is that if there are a lot of shift types, the query will be too complex and will crash.
                orderList = orderList.Where(b => (b.ShiftTypeId.HasValue && shiftTypeIds.Contains(b.ShiftTypeId.Value)) || !b.ShiftTypeId.HasValue).ToList();
            }

            ILookup<int, CustomerInvoiceRowAttestStateView> attestStatesForCompanyInvoice = null;
            if (orderList.Count < 1000)
            {
                attestStatesForCompanyInvoice = InvoiceManager.GetAttestStatesForCompanyAndInvoices(entities, actorCompanyId, orderList.Select(y => y.OrderId).ToList()).ToLookup(i => i.InvoiceId);
            }

            foreach (var order in orderList)
            {
                AddOrderDetails(entities, order, actorCompanyId, includeAttestStates, includeDeliveryAddress, attestStatesForCompanyInvoice);
            }

            return orderList;
        }
        public List<CustomerInvoice> GetUserUnscheduledOrders(int actorCompanyId, DateTime? dateTo)
        {
            if (dateTo.HasValue)
                dateTo = CalendarUtility.GetEndOfDay(dateTo.Value);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.OfType<CustomerInvoice>().AsNoTracking();
            List<CustomerInvoice> orders = (from c in entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                                             .Include("Actor.Customer")
                                            where c.Origin.ActorCompanyId == actorCompanyId &&
                                            c.PlannedStartDate.HasValue &&
                                            (!dateTo.HasValue || (dateTo.HasValue && c.PlannedStartDate.Value <= dateTo.Value)) &&
                                            (c.RemainingTime > 0 || c.KeepAsPlanned) &&
                                            c.State == (int)SoeEntityState.Active &&
                                            c.Origin.Type == (int)SoeOriginType.Order &&
                                            (c.Origin.Status != (int)SoeOriginStatus.Cancel &&
                                             c.Origin.Status != (int)SoeOriginStatus.OrderClosed &&
                                             c.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice)
                                            select c).ToList();

            List<int> orderIds = orders.Select(x => x.InvoiceId).ToList();
            entitiesReadOnly.OriginUser.NoTracking();
            List<OriginUser> originUsers = (from ou in entitiesReadOnly.OriginUser
                                            where ou.UserId.HasValue && ou.UserId == UserId &&
                                                   orderIds.Contains(ou.OriginId) &&
                                                   ou.State == (int)SoeEntityState.Active
                                            select ou).ToList();

            List<int> userOrderIds = originUsers.Select(x => x.OriginId).ToList();
            List<CustomerInvoice> userOrders = orders.Where(x => userOrderIds.Contains(x.InvoiceId)).ToList();

            return userOrders;
        }

        public List<OrderListDTO> GetUnscheduledOrders(int actorCompanyId, List<int> orderIds, bool includeAttestStates, bool includeDeliveryAddress)
        {
            List<OrderListDTO> orderList = new List<OrderListDTO>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.OfType<CustomerInvoice>().AsNoTracking();
            var orders = (from c in entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                            .Include("Origin")
                            .Include("Actor.Customer")
                            .Include("Project")
                            .Include("ShiftType")
                          where c.Origin.ActorCompanyId == actorCompanyId &&
                          orderIds.Contains(c.InvoiceId) &&
                          (c.RemainingTime > 0 || c.KeepAsPlanned) &&
                          c.State == (int)SoeEntityState.Active &&
                          c.Origin.Type == (int)SoeOriginType.Order &&
                          (c.Origin.Status != (int)SoeOriginStatus.Cancel &&
                           c.Origin.Status != (int)SoeOriginStatus.OrderClosed &&
                           c.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice)
                          select c);

            foreach (CustomerInvoice order in orders)
            {
                orderList.Add(CreateOrderListDTO(entitiesReadOnly, order, actorCompanyId, includeAttestStates, includeDeliveryAddress));
            }

            return orderList;
        }

        public OrderListDTO GetUnscheduledOrder(int actorCompanyId, int orderId, bool includeAttestStates, bool includeDeliveryAddress)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.OfType<CustomerInvoice>().AsNoTracking();
            var order = (from c in entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                             .Include("Origin")
                             .Include("Actor.Customer")
                             .Include("Project")
                             .Include("ShiftType")
                         where c.Origin.ActorCompanyId == actorCompanyId &&
                         c.InvoiceId == orderId &&
                         (c.RemainingTime > 0 || c.KeepAsPlanned) &&
                         c.State == (int)SoeEntityState.Active &&
                         c.Origin.Type == (int)SoeOriginType.Order &&
                         (c.Origin.Status != (int)SoeOriginStatus.Cancel &&
                          c.Origin.Status != (int)SoeOriginStatus.OrderClosed &&
                          c.Origin.Status != (int)SoeOriginStatus.OrderFullyInvoice)
                         select c).FirstOrDefault();

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return CreateOrderListDTO(entities, order, actorCompanyId, includeAttestStates, includeDeliveryAddress);
        }

        public OrderListDTO GetOrderListDTO(int actorCompanyId, int orderId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.Invoice.OfType<CustomerInvoice>().AsNoTracking();
            var order = (from c in entitiesReadOnly.Invoice.OfType<CustomerInvoice>().Include("Origin")
                         where c.Origin.ActorCompanyId == actorCompanyId &&
                         c.InvoiceId == orderId &&
                         c.State == (int)SoeEntityState.Active
                         select c).FirstOrDefault();

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return CreateOrderListDTO(entities, order, actorCompanyId, false, false);
        }

        private OrderListDTO CreateOrderListDTO(CompEntities entities, CustomerInvoice order, int actorCompanyId, bool includeAttestStates, bool includeDeliveryAddress)
        {
            if (order == null)
                return null;

            var dto = new OrderListDTO()
            {
                OrderId = order.InvoiceId,
                OrderNr = order.SeqNr,
                CustomerId = order.ActorId ?? 0,
                CustomerNr = order.ActorNr,
                CustomerName = order.ActorName,
                ProjectId = order.ProjectId,
                ProjectNr = order.ProjectNr,
                ProjectName = order.ProjectName,
                ShiftTypeId = order.ShiftTypeId,
                ShiftTypeName = order.ShiftType?.Name,
                ShiftTypeColor = order.ShiftType?.Color,
                Priority = order.Priority,
                PlannedStartDate = order.PlannedStartDate,
                PlannedStopDate = order.PlannedStopDate,
                EstimatedTime = order.EstimatedTime,
                RemainingTime = order.RemainingTime,
                KeepAsPlanned = order.KeepAsPlanned,
                WorkingDescription = order.WorkingDescription,
                InternalDescription = order.Origin?.Description ?? String.Empty,
                DeliveryAddressId = order.DeliveryAddressId,
                InvoiceHeadText = order.InvoiceHeadText
            };

            AddOrderDetails(entities, dto, actorCompanyId, includeAttestStates, includeDeliveryAddress, null);

            return dto;
        }

        private void AddOrderDetails(CompEntities entities, OrderListDTO dto, int actorCompanyId, bool includeAttestStates, bool includeDeliveryAddress, ILookup<int, CustomerInvoiceRowAttestStateView> attestStatesForCompanyInvoice)
        {
            dto.AttestStateName = String.Empty;
            dto.AttestStateColor = "#00000000";
            dto.ShiftTypeName = dto.ShiftTypeName ?? String.Empty;
            dto.ShiftTypeColor = dto.ShiftTypeColor ?? "#00000000";
            dto.ProjectName = dto.ProjectName ?? String.Empty;
            dto.ProjectNr = dto.ProjectNr ?? String.Empty;
            dto.CustomerNr = dto.CustomerNr ?? String.Empty;
            dto.CustomerName = dto.CustomerName ?? String.Empty;

            dto.Categories = CategoryManager.GetCompanyCategoryRecordsDict(entities, SoeCategoryType.Order, SoeCategoryRecordEntity.Order, dto.OrderId, actorCompanyId);
            if (includeAttestStates)
            {
                string attestStateName = String.Empty;
                List<string> attestStateColors = new List<string>();

                List<CustomerInvoiceRowAttestStateView> attestStates = attestStatesForCompanyInvoice != null ?
                                attestStatesForCompanyInvoice.Where(i => i.Key == dto.OrderId).SelectMany(x => x).ToList() :
                                InvoiceManager.GetAttestStatesForCustomerInvoice(entities, actorCompanyId, dto.OrderId);

                if (attestStates.Count > 0)
                {
                    foreach (var attestState in attestStates)
                    {
                        if (!String.IsNullOrEmpty(attestStateName))
                            attestStateName += ", ";

                        attestStateName += attestState.Name;

                        attestStateColors.Add(attestState.Color);
                    }
                }
                else
                    attestStateName = GetText(10, (int)TermGroup.ConverterTerms, "Inga rader");

                dto.AttestStateName = attestStateName;

                if (attestStateColors.Count == 0)
                    dto.AttestStateColor = "#FFFFFFFF";
                else if (attestStateColors.Count == 1)
                    dto.AttestStateColor = attestStateColors[0];
                else
                    dto.AttestStateColor = "GreenToRedGradientBrush";
            }

            if (includeDeliveryAddress)
            {
                string deliveryAddress = String.Empty;
                if (!String.IsNullOrEmpty(dto.InvoiceHeadText))
                {
                    deliveryAddress = dto.InvoiceHeadText.Replace('\r', ' ').Replace('\n', ' ').Trim();
                }
                else if (String.IsNullOrEmpty(deliveryAddress) && dto.DeliveryAddressId.GetValueOrDefault() > 0)
                {
                    ContactAddress address = ContactManager.GetContactAddress(entities, dto.DeliveryAddressId.GetValueOrDefault(), false, true);
                    if (address != null && address.ContactAddressRow.Count > 0)
                    {
                        ContactAddressRow row = address.ContactAddressRow.FirstOrDefault(r => r.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address);
                        if (row != null)
                            deliveryAddress += row.Text;

                        row = address.ContactAddressRow.FirstOrDefault(r => r.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode);
                        if (row != null)
                        {
                            if (!String.IsNullOrEmpty(deliveryAddress))
                                deliveryAddress += ", ";
                            deliveryAddress += row.Text;
                        }

                        row = address.ContactAddressRow.FirstOrDefault(r => r.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress);
                        if (row != null)
                        {
                            deliveryAddress += " " + row.Text;
                        }
                    }
                }

                dto.DeliveryAddress = deliveryAddress;
            }
        }

        private OrderListDTO CreateOrderListDTO(CompEntities entities, int orderId, int actorCompanyId, bool includeAttestStates, bool includeDeliveryAddress)
        {
            CustomerInvoice order = (from c in entities.Invoice.OfType<CustomerInvoice>()
                                         .Include("Origin")
                                         .Include("Actor.Customer")
                                         .Include("Project")
                                         .Include("ShiftType")
                                     where c.Origin.ActorCompanyId == actorCompanyId &&
                                     c.InvoiceId == orderId &&
                                     c.State == (int)SoeEntityState.Active
                                     select c).FirstOrDefault();

            return CreateOrderListDTO(entities, order, actorCompanyId, includeAttestStates, includeDeliveryAddress);
        }

        public List<OrderShiftDTO> GetOrderShifts(int actorCompanyId, int orderId)
        {
            List<OrderShiftDTO> dtos = new List<OrderShiftDTO>();

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            var list = (from tb in entities.TimeScheduleTemplateBlock.Include("Employee.ContactPerson").Include("ShiftType").Include("TimeDeviationCause")
                        where !tb.TimeScheduleScenarioHeadId.HasValue &&
                        tb.CustomerInvoiceId == orderId &&
                        tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId &&
                        tb.Employee.State != (int)SoeEntityState.Deleted &&
                        tb.State == (int)SoeEntityState.Active
                        select tb).ToList();

            foreach (TimeScheduleTemplateBlock block in list)
            {
                dtos.Add(ConvertToOrderShiftDTO(block));
            }

            return dtos.OrderByDescending(s => s.Date).ThenByDescending(s => s.From).ThenByDescending(s => s.To).ThenBy(s => s.EmployeeName).ToList();
        }

        public OrderShiftDTO ConvertToOrderShiftDTO(TimeScheduleTemplateBlock block)
        {
            if (!block.EmployeeReference.IsLoaded)
            {
                block.EmployeeReference.Load();

                if (block.Employee != null && !block.Employee.ContactPersonReference.IsLoaded)
                    block.Employee.ContactPersonReference.Load();
            }

            if (!block.ShiftTypeReference.IsLoaded)
                block.ShiftTypeReference.Load();

            return new OrderShiftDTO()
            {
                TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId,
                Date = (DateTime)block.Date,
                From = block.StartTime.ToShortTimeString(),
                To = block.StopTime.ToShortTimeString(),
                EmployeeName = block.Employee != null && block.Employee.ContactPerson != null ? block.Employee.ContactPerson.Name : String.Empty,
                ShiftTypeName = block.ShiftType != null ? block.ShiftType.Name : String.Empty,
                TimeDeviationCauseId = block.TimeDeviationCauseId,
                TimeDeviationCauseName = block.TimeDeviationCause != null ? block.TimeDeviationCause.Name : String.Empty,
            };
        }

        #endregion

        #region Recurrence

        public string GetRecurrenceDescription(string pattern, List<SysHolidayTypeDTO> sysHolidays)
        {
            if (String.IsNullOrEmpty(pattern))
                return String.Empty;

            List<GenericType> terms = base.GetTermGroupContent(TermGroup.RecurrencePattern);
            return DailyRecurrencePatternDTO.GetRecurrenceDescription(pattern, terms, base.GetLangId(), sysHolidays);
        }

        public string GetRecurrenceStartsOnDescription(DateTime? startDate)
        {
            return DailyRecurrenceRangeDTO.GetRecurrenceRangeStartsOnDescription(startDate);
        }

        public string GetRecurrenceEndsOnDescription(DateTime? endDate, int? numberOfOccurrences)
        {
            return DailyRecurrenceRangeDTO.GetRecurrenceRangeEndsOnDescription(endDate, numberOfOccurrences, base.GetTermGroupContent(TermGroup.RecurrencePattern), base.GetLangId());
        }

        #endregion

        #region ScheduleCycle

        public Dictionary<int, string> GetScheduleCyclesDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetScheduleCyclesDict(entities, actorCompanyId, addEmptyRow);
        }

        public Dictionary<int, string> GetScheduleCyclesDict(CompEntities entities, int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            List<ScheduleCycle> items = GetScheduleCycles(entities, actorCompanyId);
            foreach (ScheduleCycle item in items)
            {
                dict.Add(item.ScheduleCycleId, item.Name);
            }

            return dict;
        }

        public List<ScheduleCycle> GetScheduleCycleWithRulesAndRuleTypesFromCompany(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycle.NoTracking();
            return GetScheduleCycleWithRulesAndRuleTypesFromCompany(entities, actorCompanyId);
        }

        public List<ScheduleCycle> GetScheduleCycleWithRulesAndRuleTypesFromCompany(CompEntities entities, int actorCompanyId)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            IQueryable<ScheduleCycle> query = (from s in entities.ScheduleCycle
                                               where s.ActorCompanyId == actorCompanyId && s.State == (int)SoeEntityState.Active
                                               select s);
            query = query.Include("ScheduleCycleRule.ScheduleCycleRuleType");
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }
            return query.ToList();
        }

        public List<ScheduleCycle> GetScheduleCycles(int actorcompanyId, int? scheduleCycleId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycle.NoTracking();
            return GetScheduleCycles(entities, actorcompanyId, scheduleCycleId);
        }

        public List<ScheduleCycle> GetScheduleCycles(CompEntities entities, int actorcompanyId, int? scheduleCycleId = null)
        {
            IQueryable<ScheduleCycle> query = (from s in entities.ScheduleCycle
                                               where s.ActorCompanyId == actorcompanyId && s.State == (int)SoeEntityState.Active
                                               orderby s.Name
                                               select s);

            if (scheduleCycleId.HasValue)
            {
                query = query.Where(s => s.ScheduleCycleId == scheduleCycleId.Value);
            }

            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorcompanyId);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");

                List<int> accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorcompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);
                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.ToList();
        }

        public ScheduleCycle GetScheduleCycleWithRules(int scheduleCycleId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycle.NoTracking();
            return GetScheduleCycleWithRules(entities, scheduleCycleId);
        }

        public ScheduleCycle GetScheduleCycleWithRules(CompEntities entities, int scheduleCycleId)
        {
            IQueryable<ScheduleCycle> query = (from s in entities.ScheduleCycle.Include("ScheduleCycleRule")
                                               where s.ScheduleCycleId == scheduleCycleId && s.State == (int)SoeEntityState.Active
                                               select s);

            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");

                List<int> accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, base.ActorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);
                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.FirstOrDefault();
        }

        public ScheduleCycle GetScheduleCycleWithRulesAndRuleTypes(int scheduleCycleId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycle.NoTracking();
            return GetScheduleCycleWithRulesAndRuleTypes(entities, scheduleCycleId);
        }

        public ScheduleCycle GetScheduleCycleWithRulesAndRuleTypes(CompEntities entities, int scheduleCycleId)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);
            IQueryable<ScheduleCycle> query = (from s in entities.ScheduleCycle.Include("ScheduleCycleRule.ScheduleCycleRuleType")
                                               where s.ScheduleCycleId == scheduleCycleId && s.State == (int)SoeEntityState.Active
                                               select s);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, base.ActorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.FirstOrDefault();
        }

        public ActionResult SaveScheduleCycle(ScheduleCycleDTO scheduleCycleInput, int actorCompanyId)
        {
            if (scheduleCycleInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ScheduleCycle");

            foreach (var rule in scheduleCycleInput.ScheduleCycleRuleDTOs.Where(x => x.State == SoeEntityState.Active))
            {
                if (rule.MinOccurrences > rule.MaxOccurrences)
                    return new ActionResult((int)ActionResultSave.NothingSaved, GetText(8765, "Min antal får inte vara större än max antal"));
            }


            // Default result is successful
            ActionResult result = new ActionResult();

            int scheduleCycleId = scheduleCycleInput.ScheduleCycleId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region ScheduleCycle

                        // Get existing
                        ScheduleCycle scheduleCycle = GetScheduleCycleWithRules(entities, scheduleCycleId);
                        if (scheduleCycle == null)
                        {
                            #region Add

                            scheduleCycle = new ScheduleCycle()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(scheduleCycle);
                            entities.ScheduleCycle.AddObject(scheduleCycle);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(scheduleCycle);

                            #endregion
                        }

                        scheduleCycle.Name = scheduleCycleInput.Name;
                        scheduleCycle.Description = scheduleCycleInput.Description;
                        scheduleCycle.NbrOfWeeks = scheduleCycleInput.NbrOfWeeks;
                        scheduleCycle.AccountId = scheduleCycleInput.AccountId;

                        #endregion

                        #region ScheduleCycleRules

                        List<ScheduleCycleRule> existingRules = scheduleCycle.ScheduleCycleId > 0 ? scheduleCycle.ScheduleCycleRule.Where(x => x.State == (int)SoeEntityState.Active).ToList() : new List<ScheduleCycleRule>();

                        #region Delete rules that exists in db but not in input.

                        foreach (var existingRule in existingRules)
                        {
                            if (!scheduleCycleInput.ScheduleCycleRuleDTOs.Any(x => x.State == SoeEntityState.Active && x.ScheduleCycleRuleId == existingRule.ScheduleCycleRuleId))
                                ChangeEntityState(existingRule, SoeEntityState.Deleted);
                        }

                        #endregion

                        #region Add/update rows

                        foreach (var scheduleCycleRuleInput in scheduleCycleInput.ScheduleCycleRuleDTOs)
                        {
                            if (scheduleCycleRuleInput.ScheduleCycleRuleTypeId == 0)
                                return new ActionResult((int)ActionResultSave.EntityIsNull, GetText(8763, "Regel måste anges"));

                            ScheduleCycleRule existingScheduleCycleRule = existingRules.FirstOrDefault(x => x.ScheduleCycleRuleId == scheduleCycleRuleInput.ScheduleCycleRuleId);
                            if (existingScheduleCycleRule == null)
                            {
                                existingScheduleCycleRule = new ScheduleCycleRule()
                                {
                                    ScheduleCycle = scheduleCycle,
                                    State = (int)SoeEntityState.Active,
                                };
                                SetCreatedProperties(existingScheduleCycleRule);
                                entities.ScheduleCycleRule.AddObject(existingScheduleCycleRule);
                            }
                            else
                            {
                                SetModifiedProperties(existingScheduleCycleRule);
                            }

                            #region Common

                            existingScheduleCycleRule.ScheduleCycleRuleTypeId = scheduleCycleRuleInput.ScheduleCycleRuleTypeId;
                            existingScheduleCycleRule.MinOccurrences = scheduleCycleRuleInput.MinOccurrences;
                            existingScheduleCycleRule.MaxOccurrences = scheduleCycleRuleInput.MaxOccurrences;


                            #endregion
                        }

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            scheduleCycleId = scheduleCycle.ScheduleCycleId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = scheduleCycleId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteScheduleCycle(int scheduleCycleId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                #endregion

                ScheduleCycle scheduleCycle = GetScheduleCycleWithRules(entities, scheduleCycleId);
                if (scheduleCycle == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "ScheduleCycle");

                ActionResult result = ChangeEntityState(entities, scheduleCycle, SoeEntityState.Deleted, false);
                if (!result.Success)
                    return result;

                foreach (var rule in scheduleCycle.ScheduleCycleRule)
                {
                    result = ChangeEntityState(entities, rule, SoeEntityState.Deleted, false);
                    if (!result.Success)
                        return result;
                }

                result = SaveChanges(entities);
                return result;
            }
        }

        #endregion

        #region ScheduleCycleRuleType

        public Dictionary<int, string> GetScheduleCycleRuleTypesDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetScheduleCycleRuleTypesDict(entities, actorCompanyId, addEmptyRow);
        }

        public Dictionary<int, string> GetScheduleCycleRuleTypesDict(CompEntities entities, int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            List<ScheduleCycleRuleType> items = GetScheduleCycleRuleTypes(entities, actorCompanyId);
            foreach (ScheduleCycleRuleType item in items)
            {
                dict.Add(item.ScheduleCycleRuleTypeId, item.Name);
            }

            return dict;
        }

        public ScheduleCycleRuleType GetScheduleCycleRuleType(int scheduleCycleRuleTypeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycleRuleType.NoTracking();
            return GetScheduleCycleRuleType(entities, scheduleCycleRuleTypeId);
        }

        public ScheduleCycleRuleType GetScheduleCycleRuleType(CompEntities entities, int scheduleCycleRuleTypeId)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);
            IQueryable<ScheduleCycleRuleType> query = (from s in entities.ScheduleCycleRuleType
                                                       where s.ScheduleCycleRuleTypeId == scheduleCycleRuleTypeId && s.State == (int)SoeEntityState.Active
                                                       select s);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, base.ActorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }
            var item = query.FirstOrDefault();

            SetDayOfWeeks(item);

            return item;
        }

        public List<ScheduleCycleRuleType> GetScheduleCycleRuleTypes(int actorcompanyId, int? scheduleCycleRuleTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycleRuleType.NoTracking();
            return GetScheduleCycleRuleTypes(entities, actorcompanyId, scheduleCycleRuleTypeId);
        }

        public List<ScheduleCycleRuleType> GetScheduleCycleRuleTypes(CompEntities entities, int actorcompanyId, int? scheduleCycleRuleTypeId = null)
        {

            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorcompanyId);
            IQueryable<ScheduleCycleRuleType> query = (from s in entities.ScheduleCycleRuleType
                                                       where s.ActorCompanyId == actorcompanyId && s.State == (int)SoeEntityState.Active
                                                       select s);
            if (scheduleCycleRuleTypeId.HasValue)
                query = query.Where(s => s.ScheduleCycleRuleTypeId == scheduleCycleRuleTypeId.Value);

            query = query.Include("Account");

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorcompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }
            var items = query.ToList();


            foreach (var item in items)
            {
                SetDayOfWeeks(item);
            }

            return items;
        }

        private void SetDayOfWeeks(ScheduleCycleRuleType item)
        {
            if (item == null)
                return;

            item.DayOfWeekIds = new List<int>();
            List<SmallGenericType> dayOfWeeksGenericType = new List<SmallGenericType>();
            if (!String.IsNullOrEmpty(item.DayOfWeeks))
            {
                foreach (string dayOfWeek in item.DayOfWeeks.Split(','))
                {
                    if (Int32.TryParse(dayOfWeek, out int dayOfWeekId))
                    {
                        string name = "";
                        switch ((DayOfWeek)dayOfWeekId)
                        {
                            case DayOfWeek.Monday:
                                name = GetText(2, (int)TermGroup.StandardDayOfWeek, "Måndag");
                                break;
                            case DayOfWeek.Tuesday:
                                name = GetText(3, (int)TermGroup.StandardDayOfWeek, "Tisdag");
                                break;
                            case DayOfWeek.Wednesday:
                                name = GetText(4, (int)TermGroup.StandardDayOfWeek, "Onsdag");
                                break;
                            case DayOfWeek.Thursday:
                                name = GetText(5, (int)TermGroup.StandardDayOfWeek, "Torsdag");
                                break;
                            case DayOfWeek.Friday:
                                name = GetText(6, (int)TermGroup.StandardDayOfWeek, "Fredag");
                                break;
                            case DayOfWeek.Saturday:
                                name = GetText(7, (int)TermGroup.StandardDayOfWeek, "Lördag");
                                break;
                            case DayOfWeek.Sunday:
                                name = GetText(1, (int)TermGroup.StandardDayOfWeek, "Söndag");
                                break;
                        }
                        dayOfWeeksGenericType.Add(new SmallGenericType() { Id = dayOfWeekId, Name = name });
                    }
                }
            }


            int count = 1;
            foreach (var day in dayOfWeeksGenericType)
            {
                item.DayOfWeekIds.Add(day.Id);
                item.DayOfWeeksGridString += day.Name;
                if (count < dayOfWeeksGenericType.Count)
                    item.DayOfWeeksGridString += ", ";

                count++;
            }

        }

        public bool ScheduleCycleRuleTypeExists(string name, int excludeId, int actorCompanyId, int? accountId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ScheduleCycleRuleType.NoTracking();
            IQueryable<ScheduleCycleRuleType> query = (from eg in entities.ScheduleCycleRuleType
                                                       where eg.Name == name &&
                                                       eg.ActorCompanyId == actorCompanyId &&
                                                       eg.ScheduleCycleRuleTypeId != excludeId &&
                                                       eg.State == (int)SoeEntityState.Active
                                                       select eg);

            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            if (useAccountHierarchy)
                query = query.Where(t => t.AccountId == accountId);

            return query.Any();
        }

        public ActionResult SaveScheduleCycleRuleType(ScheduleCycleRuleTypeDTO scheduleCycleRuleTypeInput, int actorCompanyId)
        {
            if (scheduleCycleRuleTypeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ScheduleCycleRuleType");

            if (ScheduleCycleRuleTypeExists(scheduleCycleRuleTypeInput.Name, scheduleCycleRuleTypeInput.ScheduleCycleRuleTypeId, actorCompanyId, scheduleCycleRuleTypeInput.AccountId))
                return new ActionResult((int)ActionResultSave.EntityExists, GetText(8764, "En regel med samma namn finns redan"));

            // Default result is successful
            ActionResult result = null;

            int scheduleCycleRuleTypeId = scheduleCycleRuleTypeInput.ScheduleCycleRuleTypeId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region ScheduleCycleRuleType

                        // Get existing
                        ScheduleCycleRuleType scheduleCycleRuleType = GetScheduleCycleRuleType(entities, scheduleCycleRuleTypeId);
                        if (scheduleCycleRuleType == null)
                        {
                            #region Add

                            scheduleCycleRuleType = new ScheduleCycleRuleType()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(scheduleCycleRuleType);
                            entities.ScheduleCycleRuleType.AddObject(scheduleCycleRuleType);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(scheduleCycleRuleType);

                            #endregion
                        }

                        scheduleCycleRuleType.Name = scheduleCycleRuleTypeInput.Name;
                        scheduleCycleRuleType.StartTime = scheduleCycleRuleTypeInput.StartTime;
                        scheduleCycleRuleType.StopTime = scheduleCycleRuleTypeInput.StopTime;
                        scheduleCycleRuleType.State = (int)scheduleCycleRuleTypeInput.State;
                        scheduleCycleRuleType.AccountId = scheduleCycleRuleTypeInput.AccountId;

                        scheduleCycleRuleType.DayOfWeeks = "";
                        foreach (int id in scheduleCycleRuleTypeInput.DayOfWeekIds)
                        {
                            if (!String.IsNullOrEmpty(scheduleCycleRuleType.DayOfWeeks))
                                scheduleCycleRuleType.DayOfWeeks += ",";
                            scheduleCycleRuleType.DayOfWeeks += id;
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            scheduleCycleRuleTypeId = scheduleCycleRuleType.ScheduleCycleRuleTypeId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = scheduleCycleRuleTypeId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteScheduleCycleRuleType(int scheduleCycleRuleTypeId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                #endregion

                ScheduleCycleRuleType scheduleCycleRuleType = GetScheduleCycleRuleType(entities, scheduleCycleRuleTypeId);
                if (scheduleCycleRuleType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "ScheduleCycleRuleType");

                return ChangeEntityState(entities, scheduleCycleRuleType, SoeEntityState.Deleted, true);
            }
        }

        #endregion        

        #region ShiftHistoryDTO

        private List<ShiftHistoryDTO> ConvertToDto(CompEntities entities, List<TimeScheduleTemplateBlockHistory> blocks, int actorCompanyId)
        {
            #region Prereq

            // Get all required terms            
            List<GenericType> types = base.GetTermGroupContent(TermGroup.ShiftHistoryType);
            List<GenericType> answers = base.GetTermGroupContent(TermGroup.YesNo);
            List<GenericType> shiftStatuses = base.GetTermGroupContent(TermGroup.TimeScheduleEmployeePeriodStatus);
            List<GenericType> shiftUserStatuses = base.GetTermGroupContent(TermGroup.TimeScheduleEmployeePeriodUserStatus);
            string noReplacementEmployeeName = GetText(8262, 1);
            GenericType answerYes = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.Yes);
            GenericType answerNo = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.No);


            // Internal employee cache            
            List<Employee> employees = new List<Employee>();
            Employee hiddenEmployee = EmployeeManager.GetHiddenEmployee(entities, actorCompanyId, true);

            // Get all shift types
            Dictionary<int, string> shiftTypes = GetShiftTypesDict(entities, actorCompanyId, false);

            // Get all deviation causes
            Dictionary<int, string> timeDeviationCausesDict = TimeDeviationCauseManager.GetTimeDeviationCausesDict(entities, actorCompanyId, false);

            #endregion

            List<ShiftHistoryDTO> dtos = new List<ShiftHistoryDTO>();
            foreach (var block in blocks)
            {
                ShiftHistoryDTO dto = new ShiftHistoryDTO()
                {
                    TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId,
                    Created = block.Created,
                    CreatedBy = block.CreatedBy,
                    FromEmployeeId = block.FromEmployeeId,
                    ToEmployeeId = block.ToEmployeeId,
                };

                // Change type description
                GenericType term = types.FirstOrDefault(t => t.Id == block.Type);
                if (term == null)
                    term = types.FirstOrDefault(t => t.Id == (int)TermGroup_ShiftHistoryType.Unknown);
                dto.TypeName = term != null ? term.Name : String.Empty;

                // Shift statuses
                if (block.FromShiftStatus.HasValue)
                {
                    term = shiftStatuses.FirstOrDefault(s => s.Id == block.FromShiftStatus.Value);
                    dto.FromShiftStatus = term != null ? term.Name : String.Empty;
                }
                if (block.ToShiftStatus.HasValue)
                {
                    term = shiftStatuses.FirstOrDefault(s => s.Id == block.ToShiftStatus.Value);
                    dto.ToShiftStatus = term != null ? term.Name : String.Empty;
                }
                dto.ShiftStatusChanged = (dto.FromShiftStatus != dto.ToShiftStatus);
                if (block.FromShiftUserStatus.HasValue)
                {
                    term = shiftUserStatuses.FirstOrDefault(s => s.Id == block.FromShiftUserStatus.Value);
                    dto.FromShiftUserStatus = term != null ? term.Name : String.Empty;
                }
                if (block.ToShiftUserStatus.HasValue)
                {
                    term = shiftUserStatuses.FirstOrDefault(s => s.Id == block.ToShiftUserStatus.Value);
                    dto.ToShiftUserStatus = term != null ? term.Name : String.Empty;
                }
                dto.ShiftUserStatusChanged = (dto.FromShiftUserStatus != dto.ToShiftUserStatus);

                // Employee
                if (block.FromEmployeeId.HasValue)
                {
                    Employee employee = employees.FirstOrDefault(x => x.EmployeeId == block.FromEmployeeId.Value);
                    if (employee != null)
                    {
                        dto.FromEmployeeNr = employee.EmployeeNr;
                        dto.FromEmployeeName = employee.Name;
                    }
                    else
                    {
                        employee = EmployeeManager.GetEmployee(entities, block.FromEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                        if (employee != null)
                        {
                            dto.FromEmployeeNr = employee.EmployeeNr;
                            dto.FromEmployeeName = employee.Name;
                            employees.Add(employee);
                        }
                    }
                }
                if (block.ToEmployeeId.HasValue)
                {
                    Employee employee = employees.FirstOrDefault(x => x.EmployeeId == block.ToEmployeeId.Value);
                    if (employee != null)
                    {
                        dto.ToEmployeeNr = employee.EmployeeNr;
                        dto.ToEmployeeName = employee.Name;
                    }
                    else
                    {
                        employee = EmployeeManager.GetEmployee(entities, block.ToEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                        if (employee != null)
                        {
                            dto.ToEmployeeNr = employee.EmployeeNr;
                            dto.ToEmployeeName = employee.Name;
                            employees.Add(employee);
                        }
                    }
                }
                if (block.OriginEmployeeId.HasValue)
                {
                    Employee employee = employees.FirstOrDefault(x => x.EmployeeId == block.OriginEmployeeId.Value);
                    if (employee != null)
                    {
                        dto.OriginEmployeeNr = employee.EmployeeNr;
                        dto.OriginEmployeeName = employee.Name;
                    }
                    else
                    {
                        employee = EmployeeManager.GetEmployee(entities, block.OriginEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                        if (employee != null)
                        {
                            dto.OriginEmployeeNr = employee.EmployeeNr;
                            dto.OriginEmployeeName = employee.Name;
                            employees.Add(employee);
                        }
                    }
                }

                if (block.OriginEmployeeId.HasValue && !block.FromEmployeeId.HasValue)
                {
                    dto.FromEmployeeNr = dto.OriginEmployeeNr;
                    dto.FromEmployeeName = dto.OriginEmployeeName;
                }

                dto.EmployeeChanged = (dto.FromEmployeeNr != dto.ToEmployeeNr);

                //Start/Stop
                if (block.FromStart.HasValue)
                    dto.FromStart = block.FromStart.Value.ToShortDateShortTimeString();
                if (block.FromStop.HasValue)
                    dto.FromStop = block.FromStop.Value.ToShortDateShortTimeString();

                if (block.ToStart.HasValue)
                    dto.ToStart = block.ToStart.Value.ToShortDateShortTimeString();
                if (block.ToStop.HasValue)
                    dto.ToStop = block.ToStop.Value.ToShortDateShortTimeString();

                // Time
                if (block.FromStart.HasValue || block.FromStop.HasValue)
                    dto.FromTime = String.Format("{0} - {1}", block.FromStart.HasValue ? block.FromStart.Value.ToShortTimeString() : String.Empty, block.FromStop.HasValue ? block.FromStop.Value.ToShortTimeString() : String.Empty);
                if (block.ToStart.HasValue || block.ToStop.HasValue)
                    dto.ToTime = String.Format("{0} - {1}", block.ToStart.HasValue ? block.ToStart.Value.ToShortTimeString() : String.Empty, block.ToStop.HasValue ? block.ToStop.Value.ToShortTimeString() : String.Empty);
                dto.TimeChanged = (dto.FromTime != dto.ToTime);

                if (block.FromStart.HasValue || block.FromStop.HasValue)
                    dto.FromDateAndTime = String.Format("{0} - {1}", block.FromStart.HasValue ? block.FromStart.Value.ToShortDateShortTimeString() : String.Empty, block.FromStop.HasValue ? block.FromStop.Value.ToShortDateShortTimeString() : String.Empty);
                if (block.ToStart.HasValue || block.ToStop.HasValue)
                    dto.ToDateAndTime = String.Format("{0} - {1}", block.ToStart.HasValue ? block.ToStart.Value.ToShortDateShortTimeString() : String.Empty, block.ToStop.HasValue ? block.ToStop.Value.ToShortDateShortTimeString() : String.Empty);
                dto.DateAndTimeChanged = (dto.FromDateAndTime != dto.ToDateAndTime);

                // Shift type
                if (block.FromShiftTypeId.HasValue && shiftTypes.ContainsKey(block.FromShiftTypeId.Value))
                    dto.FromShiftType = shiftTypes[block.FromShiftTypeId.Value];
                if (block.ToShiftTypeId.HasValue && shiftTypes.ContainsKey(block.ToShiftTypeId.Value))
                    dto.ToShiftType = shiftTypes[block.ToShiftTypeId.Value];
                dto.ShiftTypeChanged = (dto.FromShiftType != dto.ToShiftType);

                // Deviation causes
                if (block.FromTimeDeviationCauseId.HasValue && timeDeviationCausesDict.ContainsKey(block.FromTimeDeviationCauseId.Value))
                    dto.FromTimeDeviationCause = timeDeviationCausesDict[block.FromTimeDeviationCauseId.Value];
                if (block.ToTimeDeviationCauseId.HasValue && timeDeviationCausesDict.ContainsKey(block.ToTimeDeviationCauseId.Value))
                    dto.ToTimeDeviationCause = timeDeviationCausesDict[block.ToTimeDeviationCauseId.Value];
                dto.TimeDeviationCauseChanged = (dto.FromTimeDeviationCause != dto.ToTimeDeviationCause);

                //ExtraShift
                if (answerYes != null && answerNo != null)
                {
                    if (block.FromExtraShift.HasValue)
                        dto.FromExtraShift = block.FromExtraShift.Value ? answerYes.Name : answerNo.Name;
                    if (block.ToExtraShift.HasValue)
                        dto.ToExtraShift = block.ToExtraShift.Value ? answerYes.Name : answerNo.Name;
                }
                dto.ExtraShiftChanged = block.FromExtraShift != block.ToExtraShift;

                //AbsenceRequest Specifik

                if (block.Type == (int)TermGroup_ShiftHistoryType.AbsenceRequestPlanning)
                {
                    //Shift has not been approved
                    if (!dto.EmployeeChanged && dto.ShiftUserStatusChanged && block.FromShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested && block.ToShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Accepted)
                    {
                        GenericType no = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.No);
                        if (no != null)
                        {
                            dto.AbsenceRequestApprovedText = no != null ? no.Name : String.Empty;
                            dto.ToEmployeeName = string.Empty;
                            dto.FromEmployeeName = string.Empty;
                        }
                    }
                    else
                    {
                        GenericType yes = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.Yes);
                        if (yes != null)
                            dto.AbsenceRequestApprovedText = yes != null ? yes.Name : String.Empty;
                    }
                }

                dtos.Add(dto);
            }
            return dtos;
        }

        public List<ShiftHistoryDTO> GetAbsenceRequestHistory(CompEntities entities, int actorCompanyId, int absenceRequestId, bool filter = true)
        {
            List<ShiftHistoryDTO> filteredDtos = new List<ShiftHistoryDTO>();

            var request = (from x in entities.EmployeeRequest
                           where x.EmployeeRequestId == absenceRequestId
                           select x).FirstOrDefault();

            if (request == null)
                return filteredDtos;


            var blocks = (from x in entities.TimeScheduleTemplateBlockHistory
                          where x.RecordId == absenceRequestId &&
                          x.Type == (int)TermGroup_ShiftHistoryType.AbsenceRequestPlanning &&
                          !x.IsBreak
                          select x).ToList();

            List<ShiftHistoryDTO> dtos = ConvertToDto(entities, blocks, actorCompanyId);

            foreach (var item in dtos)
            {
                if (filter) //if gui
                {
                    if (item.ToEmployeeId.HasValue && item.ToEmployeeId.Value != request.EmployeeId)
                        filteredDtos.Add(item);
                }
                else //restore
                {
                    if (item.TimeDeviationCauseChanged && item.ToEmployeeId.HasValue && item.FromEmployeeId.HasValue && item.ToEmployeeId.Value == request.EmployeeId && item.FromEmployeeId.Value == request.EmployeeId)
                        filteredDtos.Add(item);
                }
            }

            return filteredDtos;
        }

        public List<ShiftHistoryDTO> GetAbsenceRequestHistory(int actorCompanyId, int absenceRequestId, bool filter = true)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlockHistory.NoTracking();
            return GetAbsenceRequestHistory(entities, actorCompanyId, absenceRequestId, filter);
        }

        #endregion

        #region ShiftType

        #region General

        public List<ShiftType> GetShiftTypes(int actorCompanyId, bool loadAccountInternals = false, bool loadAccounts = false, bool loadSkills = false, bool loadEmployeeStatisticsTargets = false, bool setTimeScheduleTemplateBlockTypeName = false, bool setCategoryNames = false, bool setAccountingString = false, bool setSkillNames = false, bool setTimeScheduleTypeName = false, bool loadHierarchyAccounts = false, List<int> shiftTypeIds = null, int? shiftTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftType.NoTracking();
            return GetShiftTypes(entities, actorCompanyId, loadAccountInternals, loadAccounts, loadSkills, loadEmployeeStatisticsTargets, setTimeScheduleTemplateBlockTypeName, setCategoryNames, setAccountingString, setSkillNames, setTimeScheduleTypeName, loadHierarchyAccounts, shiftTypeIds: shiftTypeIds, shiftTypeId: shiftTypeId);
        }

        public List<ShiftType> GetShiftTypes(CompEntities entities, int actorCompanyId, bool loadAccountInternals = false, bool loadAccounts = false, bool loadSkills = false, bool loadEmployeeStatisticsTargets = false, bool setTimeScheduleTemplateBlockTypeName = false, bool setCategoryNames = false, bool setAccountingString = false, bool setSkillNames = false, bool setTimeScheduleTypeName = false, bool loadHierarchyAccounts = false, bool loadTimeScheduleTypes = false, List<int> shiftTypeIds = null, int? shiftTypeId = null)
        {
            IQueryable<ShiftType> query = entities.ShiftType;
            if (loadAccounts || setAccountingString)
            {
                query = query.Include("AccountInternal.Account.AccountDim");
                query = query.Include("Account");
            }
            else if (loadAccountInternals)
            {
                query = query.Include("AccountInternal");
                query = query.Include("Account");
            }
            if (loadSkills || setSkillNames)
                query = query.Include("ShiftTypeSkill.Skill.SkillType");
            if (loadEmployeeStatisticsTargets)
                query = query.Include("ShiftTypeEmployeeStatisticsTarget");
            if (loadHierarchyAccounts)
                query = query.Include("ShiftTypeHierarchyAccount");
            if (loadTimeScheduleTypes)
                query = query.Include("TimeScheduleType");

            if (shiftTypeId != null)
            {
                query = query.Where(s => s.ShiftTypeId == shiftTypeId.Value);
            }

            List<ShiftType> shiftTypes = (from s in query
                                          where s.ActorCompanyId == actorCompanyId &&
                                          s.State == (int)SoeEntityState.Active
                                          orderby s.Name
                                          select s).ToList();

            if (!shiftTypeIds.IsNullOrEmpty())
                shiftTypes = shiftTypes.Where(w => shiftTypeIds.Contains(w.ShiftTypeId)).ToList();

            if (setTimeScheduleTemplateBlockTypeName || setCategoryNames || setAccountingString || setSkillNames || setTimeScheduleTypeName || loadHierarchyAccounts)
            {
                Dictionary<int, string> scheduleTypes = setTimeScheduleTypeName ? GetTimeScheduleTypesDict(entities, actorCompanyId) : null;
                Dictionary<int, string> blockTypes = setTimeScheduleTemplateBlockTypeName ? base.GetTermGroupDict(TermGroup.TimeScheduleTemplateBlockType) : null;
                List<CompanyCategoryRecord> categoryRecords = setCategoryNames ? CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Employee, SoeCategoryRecordEntity.ShiftType, actorCompanyId) : null;
                List<AccountDimDTO> accountDims = setAccountingString ? GetAccountDimsFromCache(entities, CacheConfig.Company(actorCompanyId)).ToList() : null;

                int employeeAccountDimId = 0;
                List<Tuple<int, int>> accounts = null;
                if (loadHierarchyAccounts)
                {
                    employeeAccountDimId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimEmployee, 0, actorCompanyId, 0);

                    var acc = (from a in entities.Account where a.ActorCompanyId == actorCompanyId && a.ParentAccountId != null select new { a.AccountId, ParentAccountId = a.ParentAccountId.Value }).ToList();
                    accounts = new List<Tuple<int, int>>();
                    acc.ForEach(a => accounts.Add(new Tuple<int, int>(a.AccountId, a.ParentAccountId)));
                }

                foreach (ShiftType shiftType in shiftTypes)
                {
                    shiftType.TimeScheduleTypeName = scheduleTypes != null && shiftType.TimeScheduleTypeId.HasValue ? scheduleTypes.GetValue(shiftType.TimeScheduleTypeId.Value) : string.Empty;
                    shiftType.TimeScheduleTemplateBlockTypeName = blockTypes != null && shiftType.TimeScheduleTemplateBlockType.HasValue ? blockTypes.GetValue(shiftType.TimeScheduleTemplateBlockType.Value) : string.Empty;

                    if (categoryRecords != null)
                    {
                        shiftType.CategoryNames = categoryRecords.GetCategoryRecords(shiftType.ShiftTypeId)
                            .OrderByDescending(c => c.Default)
                            .ThenBy(c => c.Category.Name)
                            .Select(c => c.Category.Name)
                            .ToCommaSeparated(addWhiteSpace: true);
                    }
                    if (shiftType.ShiftTypeSkill != null)
                    {
                        shiftType.SkillNames = shiftType.ShiftTypeSkill
                            .Where(s => s.Skill != null)
                            .OrderBy(s => s.Skill.Name)
                            .Select(s => s.Skill.Name + " (" + s.SkillLevel + ")")
                            .ToCommaSeparated(addWhiteSpace: true);
                    }
                    if (accountDims != null)
                    {
                        List<string> accountNames = new List<string>();
                        foreach (AccountDimDTO dim in accountDims.Where(a => a.IsInternal).OrderBy(a => a.AccountDimNr))
                        {
                            AccountInternal accountInternal = shiftType.AccountInternal.FirstOrDefault(a => a.Account?.AccountDimId == dim.AccountDimId);
                            if (accountInternal != null)
                                accountNames.Add(accountInternal.Account.Name);
                        }
                        shiftType.AccountingStringAccountNames = accountNames.ToCommaSeparated(addWhiteSpace: true);
                    }
                    if (shiftType.ShiftTypeHierarchyAccount != null)
                    {
                        shiftType.ChildHierarchyAccountIds = new List<int>();
                        foreach (ShiftTypeHierarchyAccount account in shiftType.ShiftTypeHierarchyAccount)
                        {
                            if (accounts != null && employeeAccountDimId != 0 && base.GetAccountDimIdOnAccountFromCache(entities, actorCompanyId, account.AccountId) != employeeAccountDimId)
                            {
                                List<int> accountIds = (from a in accounts where a.Item2 == account.AccountId select a.Item1).ToList();
                                if (!accountIds.IsNullOrEmpty())
                                    shiftType.ChildHierarchyAccountIds.AddRange(accountIds);
                            }
                        }
                    }
                }
            }

            return shiftTypes;
        }

        public Dictionary<int, string> GetShiftTypesDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftTypesDict(entities, actorCompanyId, addEmptyRow);
        }

        public Dictionary<int, string> GetShiftTypesDict(CompEntities entities, int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            List<ShiftType> shiftTypes = GetShiftTypes(entities, actorCompanyId);
            foreach (ShiftType shiftType in shiftTypes)
            {
                dict.Add(shiftType.ShiftTypeId, shiftType.Name);
            }

            return dict;
        }

        #endregion

        #region By Account hierarchy

        public List<int> GetShiftTypeIdsForUser(int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, bool onlyDefaultAccounts, DateTime? dateFrom = null, DateTime? dateTo = null, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftTypeIdsForUser(entities, actorCompanyId, roleId, userId, employeeId, isAdmin, onlyDefaultAccounts, dateFrom, dateTo, blockTypes);
        }

        public List<int> GetShiftTypeIdsForUser(CompEntities entities, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, bool onlyDefaultAccounts, DateTime? dateFrom = null, DateTime? dateTo = null, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null)
        {
            return GetShiftTypesForUser(entities, actorCompanyId, roleId, userId, employeeId, isAdmin, onlyDefaultAccounts, dateFrom, dateTo, blockTypes).Select(s => s.ShiftTypeId).ToList();
        }

        public Dictionary<int, string> GetShiftTypesDictForUser(int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, bool onlyDefaultAccounts, DateTime? dateFrom = null, DateTime? dateTo = null, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> validAccountIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftTypesDictForUser(entities, actorCompanyId, roleId, userId, employeeId, isAdmin, onlyDefaultAccounts, dateFrom, dateTo, blockTypes, validAccountIds);
        }

        public Dictionary<int, string> GetShiftTypesDictForUser(CompEntities entities, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, bool onlyDefaultAccounts, DateTime? dateFrom = null, DateTime? dateTo = null, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> validAccountIds = null)
        {
            List<ShiftType> shiftTypes = GetShiftTypesForUser(entities, actorCompanyId, roleId, userId, employeeId, isAdmin, onlyDefaultAccounts, dateFrom, dateTo, blockTypes, validAccountIds);
            Dictionary<int, string> dict = new Dictionary<int, string>();
            foreach (ShiftType shiftType in shiftTypes)
            {
                dict.Add(shiftType.ShiftTypeId, shiftType.Name);
            }

            return dict;
        }

        public List<ShiftType> GetShiftTypesForUser(int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, bool onlyDefaultAccounts, DateTime? dateFrom = null, DateTime? dateTo = null, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.AccountDim.AsNoTracking();
            entities.ShiftType.NoTracking();
            return GetShiftTypesForUser(entities, actorCompanyId, roleId, userId, employeeId, isAdmin, onlyDefaultAccounts, dateFrom, dateTo, blockTypes);
        }

        public List<ShiftType> GetShiftTypesForUser(CompEntities entities, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, bool onlyDefaultAccounts, DateTime? dateFrom = null, DateTime? dateTo = null, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> validAccountIds = null)
        {
            var blockTypesString = blockTypes == null ? null : string.Join("|", blockTypes);
            var validAccountIdsString = validAccountIds == null ? null : string.Join("|", validAccountIds);
            string key = $"GetShiftTypesForUser{actorCompanyId}#{roleId}#{employeeId}#{isAdmin}#{onlyDefaultAccounts}#{dateFrom}#{dateTo}#{blockTypesString}#{validAccountIdsString}";
            List<ShiftType> cache = BusinessMemoryCache<List<ShiftType>>.Get(key);

            if (cache != null)
                return cache;

            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            // Get all shift types
            List<ShiftType> allShiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadAccounts: true, loadHierarchyAccounts: useAccountHierarchy);
            // Only return shift types with specified TimeScheduleTemplateBlockType
            if (blockTypes != null && blockTypes.Count > 0)
            {
                foreach (ShiftType shiftType in allShiftTypes.ToList())
                {
                    if (shiftType.TimeScheduleTemplateBlockType.HasValue && !blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)shiftType.TimeScheduleTemplateBlockType.Value))
                        allShiftTypes.Remove(shiftType);
                }
            }

            // Check if any account dim is linked to shift type
            AccountDimDTO dim = base.GetShiftTypeAccountDimFromCache(entities, actorCompanyId);

            //Maybe these should be companysettings?
            bool filterOnShiftTypeHierarchyAccounts = useAccountHierarchy && allShiftTypes.Any(s => s.ShiftTypeHierarchyAccount.Any(a => a.State == (int)SoeEntityState.Active));
            bool filterOnAccounting = allShiftTypes.Any(s => s.AccountInternal.Any());

            if (dim != null || filterOnShiftTypeHierarchyAccounts || filterOnAccounting)
            {
                // Get accounts available for user
                List<int> accountIds = null;
                List<int> additionalAccountIds = null;
                if (useAccountHierarchy)
                {
                    accountIds = new List<int>();
                    additionalAccountIds = new List<int>();

                    if (validAccountIds.IsNullOrEmpty())
                    {
                        List<AccountDTO> validAccounts;
                        if (isAdmin)
                        {
                            AccountHierarchyInput input = AccountHierarchyInput.GetInstance(AccountHierarchyParamType.IncludeVirtualParented);
                            input.AddParamValue(AccountHierarchyParamType.OnlyDefaultAccounts, onlyDefaultAccounts);
                            validAccounts = AccountManager.GetAccountsFromHierarchyByUser(entities, actorCompanyId, userId, dateFrom, dateTo, input);
                        }
                        else
                        {
                            validAccounts = AccountManager.GetValidAccountsForEmployee(entities, actorCompanyId, employeeId, roleId, userId, dateFrom ?? DateTime.Today, dateTo ?? DateTime.Today, onlyDefaultAccounts, false);
                        }
                        accountIds = validAccounts.Select(a => a.AccountId).ToList();

                        // Check accounts up in chain
                        foreach (AccountDTO account in validAccounts)
                        {
                            if (!string.IsNullOrEmpty(account.HierachyId))
                            {
                                additionalAccountIds.AddRange(account.HierachyId.Split('-').Select(Int32.Parse).ToList());
                            }
                            else if (account.ParentAccountId.HasValue && account.ParentAccountId.Value != 0)
                            {
                                // Seems account.HierachyId is not set when isAdmin if false (for employees).
                                // Therefore we add parent account at least. We should add all grandparents as well but we don't want to load them now.
                                // This solves the problem for MatHem that specifies ShiftTypeHierarchyAccount on some ShiftTypes to one level above employee account.
                                additionalAccountIds.Add(account.ParentAccountId.Value);
                            }
                        }

                        additionalAccountIds = additionalAccountIds.Distinct().ToList();
                    }
                    else
                    {
                        accountIds.AddRange(validAccountIds);
                    }
                }

                // Get shift types linked to user accounts
                List<ShiftType> shiftTypes = new List<ShiftType>();
                foreach (ShiftType shiftType in allShiftTypes)
                {
                    bool valid = false;

                    if (accountIds == null)
                        valid = true;
                    else
                    {
                        if (dim != null || filterOnShiftTypeHierarchyAccounts)
                        {
                            // Linked to account dim
                            if (dim != null && shiftType.AccountId.HasValue && accountIds.Contains(shiftType.AccountId.Value))
                                valid = true;

                            if (filterOnShiftTypeHierarchyAccounts)
                            {
                                // Hierarcy accounts, none selected
                                if (!valid && dim == null && !shiftType.ShiftTypeHierarchyAccount.Any(a => a.State == (int)SoeEntityState.Active))
                                    valid = true;
                                // Hierarcy accounts, at least one valid account selected
                                if (!valid)
                                {
                                    if (shiftType.ShiftTypeHierarchyAccount.Where(a => a.State == (int)SoeEntityState.Active).Select(a => a.AccountId).Intersect(accountIds).Any())
                                        valid = true;
                                    else if (additionalAccountIds.Any() && shiftType.ShiftTypeHierarchyAccount.Where(a => a.State == (int)SoeEntityState.Active).Select(a => a.AccountId).Intersect(additionalAccountIds).Any())
                                        valid = true;
                                }
                            }
                        }
                        else
                        {
                            // Accounting settings, none selected or at least one valid account selected
                            if (filterOnAccounting && (!shiftType.AccountInternal.Any() || shiftType.AccountInternal.Select(a => a.AccountId).Intersect(accountIds).Any()))
                                valid = true;
                        }
                    }

                    if (valid)
                        shiftTypes.Add(shiftType);
                }
                BusinessMemoryCache<List<ShiftType>>.Set(key, shiftTypes);
                return shiftTypes;
            }
            else
            {
                // If no dim linked or no account mapping specified, return all shift types
                BusinessMemoryCache<List<ShiftType>>.Set(key, allShiftTypes);
                return allShiftTypes;
            }
        }

        #endregion

        #region By Category

        public Dictionary<int, string> GetShiftTypesDictForUsersCategories(int actorCompanyId, int userId, int employeeId, bool isAdmin, bool includeSecondaryCategories, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredCategoryIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftType.NoTracking();
            return GetShiftTypesDictForUsersCategories(entities, actorCompanyId, userId, employeeId, isAdmin, includeSecondaryCategories, blockTypes, filteredCategoryIds);
        }

        public Dictionary<int, string> GetShiftTypesDictForUsersCategories(CompEntities entities, int actorCompanyId, int userId, int employeeId, bool isAdmin, bool includeSecondaryCategories, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredCategoryIds = null)
        {
            List<ShiftType> shiftTypes = GetShiftTypesForUsersCategories(entities, actorCompanyId, userId, employeeId, isAdmin, includeSecondaryCategories, blockTypes, filteredCategoryIds);
            Dictionary<int, string> dict = new Dictionary<int, string>();
            foreach (ShiftType shiftType in shiftTypes)
            {
                dict.Add(shiftType.ShiftTypeId, shiftType.Name);
            }

            return dict;
        }

        public List<ShiftType> GetShiftTypesForUsersCategories(int actorCompanyId, int userId, int employeeId, bool isAdmin, bool includeSecondaryCategories, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredCategoryIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftType.NoTracking();
            return GetShiftTypesForUsersCategories(entities, actorCompanyId, userId, employeeId, isAdmin, includeSecondaryCategories, blockTypes, filteredCategoryIds);
        }

        public List<ShiftType> GetShiftTypesForUsersCategories(CompEntities entities, int actorCompanyId, int userId, int employeeId, bool isAdmin, bool includeSecondaryCategories, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredCategoryIds = null)
        {
            List<ShiftType> shiftTypes = new List<ShiftType>();

            // Get all ShiftType categories
            List<CompanyCategoryRecord> categoryRecords = (from c in entities.CompanyCategoryRecord
                                                           where c.ActorCompanyId == actorCompanyId &&
                                                           c.Entity == (int)SoeCategoryRecordEntity.ShiftType
                                                           select c).ToList();

            if (filteredCategoryIds == null || filteredCategoryIds.Count == 0)
            {
                if (userId == 0 && employeeId == 0)
                {
                    // Get all shift type categories
                    filteredCategoryIds = categoryRecords.Select(c => c.CategoryId).ToList();
                }
                else
                {
                    // Only get shift types connected to the users categories
                    filteredCategoryIds = CategoryManager.GetCategoriesForRoleFromTypeDict(entities, actorCompanyId, userId, employeeId, SoeCategoryType.Employee, isAdmin, includeSecondaryCategories, false).Select(c => c.Key).ToList();
                }
            }

            // Get actual shift types
            List<int> categoryShiftTypeIds = categoryRecords.Where(c => filteredCategoryIds.Contains(c.CategoryId)).Select(c => c.RecordId).Distinct().ToList();
            List<ShiftType> categoryShiftTypes = (from s in entities.ShiftType
                                                  where s.ActorCompanyId == actorCompanyId &&
                                                  categoryShiftTypeIds.Contains(s.ShiftTypeId) &&
                                                  s.State == (int)SoeEntityState.Active
                                                  select s).ToList();

            // Get all shift types not connected to any category
            List<int> allCategoryShiftTypeIds = categoryRecords.Select(c => c.RecordId).Distinct().ToList();
            List<ShiftType> noCategoryShiftTypes = (from s in entities.ShiftType
                                                    where s.ActorCompanyId == actorCompanyId &&
                                                    !allCategoryShiftTypeIds.Contains(s.ShiftTypeId) &&
                                                    s.State == (int)SoeEntityState.Active
                                                    select s).ToList();

            foreach (int categoryId in filteredCategoryIds)
            {
                foreach (ShiftType type in categoryShiftTypes)
                {
                    if (!shiftTypes.Any(s => s.ShiftTypeId == type.ShiftTypeId))
                        shiftTypes.Add(type);
                }
            }

            // Also add shift types not connected to any category
            foreach (ShiftType type in noCategoryShiftTypes)
            {
                if (!shiftTypes.Any(s => s.ShiftTypeId == type.ShiftTypeId))
                    shiftTypes.Add(type);
            }

            // Only return shift types with specified TimeScheduleTemplateBlockType
            if (blockTypes != null && blockTypes.Count > 0)
            {
                foreach (ShiftType shiftType in shiftTypes.ToList())
                {
                    if (shiftType.TimeScheduleTemplateBlockType.HasValue && !blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)shiftType.TimeScheduleTemplateBlockType.Value))
                        shiftTypes.Remove(shiftType);
                }
            }

            shiftTypes = shiftTypes.Distinct().OrderBy(s => s.Name).ToList();

            return shiftTypes;
        }

        public List<int> GetShiftTypeIdsForUsersCategories(CompEntities entities, int actorCompanyId, int userId, int employeeId, bool isAdmin, bool includeSecondaryCategories, List<int> filteredCategoryIds = null)
        {
            // Get all ShiftType categories
            List<CompanyCategoryRecord> categoryRecords = (from c in entities.CompanyCategoryRecord
                                                           where c.ActorCompanyId == actorCompanyId &&
                                                           c.Entity == (int)SoeCategoryRecordEntity.ShiftType
                                                           select c).ToList();

            if (filteredCategoryIds.IsNullOrEmpty())
            {
                if (userId == 0 && employeeId == 0)
                {
                    // Get all shift type categories
                    filteredCategoryIds = categoryRecords.Select(c => c.CategoryId).ToList();
                }
                else
                {
                    // Only get shift types connected to the users categories
                    filteredCategoryIds = CategoryManager.GetCategoriesForRoleFromTypeDict(entities, actorCompanyId, userId, employeeId, SoeCategoryType.Employee, isAdmin, includeSecondaryCategories, false).Select(c => c.Key).ToList();
                }
            }

            // Get shift types connected to categories
            List<int> categoryShiftTypeIds = categoryRecords.Where(c => filteredCategoryIds.Contains(c.CategoryId)).Select(c => c.RecordId).Distinct().ToList();

            // Get all shift types not connected to any category
            List<int> allCategoryShiftTypeIds = categoryRecords.Select(c => c.RecordId).Distinct().ToList();
            List<int> noCategoryShiftTypes = (from s in entities.ShiftType
                                              where s.ActorCompanyId == actorCompanyId &&
                                              !allCategoryShiftTypeIds.Contains(s.ShiftTypeId) &&
                                              s.State == (int)SoeEntityState.Active
                                              select s.ShiftTypeId).ToList();

            List<int> shiftTypeIds = new List<int>();
            shiftTypeIds.AddRange(categoryShiftTypeIds);
            shiftTypeIds.AddRange(noCategoryShiftTypes);

            return shiftTypeIds.Distinct().ToList();
        }

        #endregion

        #region Combined

        public List<int> GetShiftTypeIdsForUser(bool? useAccountHierarchy, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, DateTime? dateFrom = null, DateTime? dateTo = null, bool includeSecondaryCategories = true, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredShiftTypeIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftTypeIdsForUser(entities, useAccountHierarchy, actorCompanyId, roleId, userId, employeeId, isAdmin, dateFrom, dateTo, includeSecondaryCategories, blockTypes, filteredShiftTypeIds);
        }

        public List<int> GetShiftTypeIdsForUser(CompEntities entities, bool? useAccountHierarchy, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, DateTime? dateFrom = null, DateTime? dateTo = null, bool includeSecondaryCategories = true, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredShiftTypeIds = null)
        {
            if (!useAccountHierarchy.HasValue)
                useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            List<int> shiftTypeIds;
            if (useAccountHierarchy.Value)
            {
                // Only get shift types connected to the users account hierarchy
                shiftTypeIds = GetShiftTypeIdsForUser(entities, actorCompanyId, roleId, userId, employeeId, isAdmin, !includeSecondaryCategories, dateFrom, dateTo, blockTypes);
            }
            else
            {
                // Only get shift types connected to the users categories
                shiftTypeIds = GetShiftTypeIdsForUsersCategories(entities, actorCompanyId, userId, employeeId, isAdmin, includeSecondaryCategories);
            }

            if (filteredShiftTypeIds != null && filteredShiftTypeIds.Any() && shiftTypeIds.Any())
            {
                // Remove shift types not in passed filter
                foreach (int shiftTypeId in shiftTypeIds.ToList())
                {
                    if (!filteredShiftTypeIds.Contains(shiftTypeId))
                        shiftTypeIds.Remove(shiftTypeId);
                }
            }

            return shiftTypeIds;
        }

        public Dictionary<int, string> GetShiftTypesDictForUser(bool? useAccountHierarchy, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, DateTime? dateFrom = null, DateTime? dateTo = null, bool includeSecondaryCategories = true, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> validAccountIds = null)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            if (!useAccountHierarchy.HasValue)
                useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadOnly, actorCompanyId);

            if (useAccountHierarchy.Value)
                return GetShiftTypesDictForUser(actorCompanyId, roleId, userId, employeeId, isAdmin, !includeSecondaryCategories, dateFrom, dateTo, blockTypes, validAccountIds);
            else
                return GetShiftTypesDictForUsersCategories(actorCompanyId, userId, employeeId, isAdmin, includeSecondaryCategories, blockTypes);
        }

        public List<ShiftType> GetShiftTypesForUser(bool? useAccountHierarchy, int actorCompanyId, int roleId, int userId, int employeeId, bool isAdmin, DateTime? dateFrom = null, DateTime? dateTo = null, bool includeSecondaryCategories = true, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            if (!useAccountHierarchy.HasValue)
                useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadOnly, actorCompanyId);

            if (useAccountHierarchy.Value)
                return GetShiftTypesForUser(actorCompanyId, roleId, userId, employeeId, isAdmin, !includeSecondaryCategories, dateFrom, dateTo, blockTypes);
            else
                return GetShiftTypesForUsersCategories(actorCompanyId, userId, employeeId, isAdmin, includeSecondaryCategories, blockTypes);
        }

        #endregion

        /// <summary>
        /// Get which shift types that are scheduled for an employee
        /// </summary>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="startDate">Date range start</param>
        /// <param name="stopDate">Date range stop</param>
        /// <returns>List of ShiftType ID's per date</returns>
        public Dictionary<DateTime, List<int>> GetScheduledShiftTypeIds(int employeeId, DateTime startDate, DateTime stopDate)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            var results = (from tb in entities.TimeScheduleTemplateBlock
                           where !tb.TimeScheduleScenarioHeadId.HasValue &&
                           (tb.EmployeeId.HasValue && tb.EmployeeId.Value == employeeId) &&
                           (tb.Date.HasValue && tb.Date.Value >= startDate && tb.Date.Value <= stopDate) &&
                           tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                           tb.ShiftTypeId.HasValue &&
                           tb.State == (int)SoeEntityState.Active
                           orderby tb.StartTime
                           group tb by tb.Date.Value into g
                           select new { Date = g.Key, ShiftTypeIds = g.Select(g2 => g2.ShiftTypeId.Value).Distinct().ToList() });

            Dictionary<DateTime, List<int>> dict = new Dictionary<DateTime, List<int>>();
            foreach (var result in results)
            {
                dict.Add(result.Date, result.ShiftTypeIds);
            }

            return dict;
        }

        public List<int> GetEmployeesScheduledForShiftType(int shiftTypeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return (from tb in entities.TimeScheduleTemplateBlock
                    where !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.EmployeeId.HasValue &&
                    (tb.Date.HasValue && tb.Date.Value == date) &&
                    tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                    (tb.ShiftTypeId.HasValue && tb.ShiftTypeId == shiftTypeId) &&
                    tb.State == (int)SoeEntityState.Active
                    select tb.EmployeeId.Value).Distinct().ToList();
        }
        public ShiftType GetShiftType(int shiftTypeId, int actorCompanyId, bool loadAccounts = false, bool loadSkills = false, bool loadEmployeeStatisticsTargets = false, bool setEmployeeStatisticsTargetsTypeName = false, bool loadCategories = false, bool loadTimeScheduleType = false, bool loadHierarchyAccounts = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftType.NoTracking();
            entities.ShiftTypeSkill.NoTracking();
            entities.ShiftTypeEmployeeStatisticsTarget.NoTracking();
            entities.AccountInternal.NoTracking();
            entities.Account.NoTracking();
            entities.AccountDim.NoTracking();
            return GetShiftType(entities, shiftTypeId, actorCompanyId, loadAccounts, loadSkills, loadEmployeeStatisticsTargets, setEmployeeStatisticsTargetsTypeName, loadCategories, loadTimeScheduleType, loadHierarchyAccounts);
        }
        public ShiftType GetShiftType(CompEntities entities, int shiftTypeId, int actorCompanyId, bool loadAccounts = false, bool loadSkills = false, bool loadEmployeeStatisticsTargets = false, bool setEmployeeStatisticsTargetsTypeName = false, bool loadCategories = false, bool loadTimeScheduleType = false, bool loadHierarchyAccounts = false)
        {
            IQueryable<ShiftType> query = entities.ShiftType;
            if (loadAccounts)
                query = query.Include("AccountInternal.Account.AccountDim");
            if (loadSkills)
                query = query.Include("ShiftTypeSkill.Skill.SkillType");
            if (loadEmployeeStatisticsTargets)
                query = query.Include("ShiftTypeEmployeeStatisticsTarget");
            if (loadTimeScheduleType)
                query = query.Include("TimeScheduleType");
            if (loadHierarchyAccounts)
                query = query.Include("ShiftTypeHierarchyAccount");

            ShiftType shiftType = (from s in query
                                   where s.ShiftTypeId == shiftTypeId
                                   select s).FirstOrDefault();

            // Set EmployeeStatisticsTypeName on target values
            if (setEmployeeStatisticsTargetsTypeName && loadEmployeeStatisticsTargets && shiftType != null && shiftType.ShiftTypeEmployeeStatisticsTarget != null && shiftType.ShiftTypeEmployeeStatisticsTarget.Count > 0)
            {
                var types = base.GetTermGroupContent(TermGroup.EmployeeStatisticsType, skipUnknown: true);

                foreach (var target in shiftType.ShiftTypeEmployeeStatisticsTarget)
                {
                    var type = types.FirstOrDefault(t => t.Id == target.EmployeeStatisticsType);
                    if (type != null)
                        target.EmployeeStatisticsTypeName = type.Name;
                }
            }

            if (loadCategories)
            {

                shiftType.CategoryIds = (from c in entities.CompanyCategoryRecord
                                         where c.RecordId == shiftType.ShiftTypeId &&
                                         c.Entity == (int)SoeCategoryRecordEntity.ShiftType &&
                                         c.Category.Type == (int)SoeCategoryType.Employee &&
                                         c.Category.ActorCompanyId == ActorCompanyId &&
                                         c.Category.State == (int)SoeEntityState.Active
                                         select c.CategoryId).ToList();

            }

            if (shiftType != null && shiftType.AccountInternal != null)
            {
                var dims = AccountManager.GetAccountDimsByCompany(
                    entities,
                    actorCompanyId,
                    onlyStandard: false,
                    onlyInternal: true,
                    active: true,
                    loadAccounts: true,
                    loadInternalAccounts: true,
                    loadParentOrCalculateLevels: true
                    )
                .ToSmallDTOs(true, true, false)
                .ToList();

                int position = 1;
                foreach (AccountDimSmallDTO dim in dims)
                {
                    position++;
                    foreach (AccountInternal accountInternal in shiftType.AccountInternal.Where(a => a.Account != null && a.Account.AccountDim != null && a.Account.AccountDim.AccountDimNr != Constants.ACCOUNTDIM_STANDARD).OrderBy(a => a.Account.AccountDim.AccountDimNr))
                    {

                        if (dim.AccountDimNr == accountInternal.Account.AccountDim.AccountDimNr)
                        {
                            switch (position)
                            {
                                case 2:
                                    shiftType.AccountSetting2Id = accountInternal.Account.AccountId;
                                    shiftType.AccountSetting2Name = accountInternal.Account.Name;
                                    shiftType.AccountSettingDim2Nr = dim.AccountDimNr;
                                    shiftType.AccountSetting2Nr = accountInternal.Account.AccountNr;
                                    break;
                                case 3:
                                    shiftType.AccountSetting3Id = accountInternal.Account.AccountId;
                                    shiftType.AccountSetting3Name = accountInternal.Account.Name;
                                    shiftType.AccountSettingDim3Nr = dim.AccountDimNr;
                                    shiftType.AccountSetting3Nr = accountInternal.Account.AccountNr;
                                    break;
                                case 4:
                                    shiftType.AccountSetting4Id = accountInternal.Account.AccountId;
                                    shiftType.AccountSetting4Name = accountInternal.Account.Name;
                                    shiftType.AccountSettingDim4Nr = dim.AccountDimNr;
                                    shiftType.AccountSetting4Nr = accountInternal.Account.AccountNr;
                                    break;
                                case 5:
                                    shiftType.AccountSetting5Id = accountInternal.Account.AccountId;
                                    shiftType.AccountSetting5Name = accountInternal.Account.Name;
                                    shiftType.AccountSettingDim5Nr = dim.AccountDimNr;
                                    shiftType.AccountSetting5Nr = accountInternal.Account.AccountNr;
                                    break;
                                case 6:
                                    shiftType.AccountSetting6Id = accountInternal.Account.AccountId;
                                    shiftType.AccountSetting6Name = accountInternal.Account.Name;
                                    shiftType.AccountSettingDim6Nr = dim.AccountDimNr;
                                    shiftType.AccountSetting6Nr = accountInternal.Account.AccountNr;
                                    break;
                            }
                        }
                    }
                }
            }

            return shiftType;
        }

        public ShiftType GetShiftType(int shiftTypeId, bool loadAccounts = false, bool loadSkills = false, bool loadEmployeeStatisticsTargets = false, bool setEmployeeStatisticsTargetsTypeName = false, bool loadCategories = false, bool loadTimeScheduleType = false, bool loadHierarchyAccounts = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftType.NoTracking();
            entities.ShiftTypeSkill.NoTracking();
            entities.ShiftTypeEmployeeStatisticsTarget.NoTracking();
            entities.AccountInternal.NoTracking();
            entities.Account.NoTracking();
            entities.AccountDim.NoTracking();
            return GetShiftType(entities, shiftTypeId, loadAccounts, loadSkills, loadEmployeeStatisticsTargets, setEmployeeStatisticsTargetsTypeName, loadCategories, loadTimeScheduleType, loadHierarchyAccounts);
        }

        public ShiftType GetShiftType(CompEntities entities, int shiftTypeId, bool loadAccounts = false, bool loadSkills = false, bool loadEmployeeStatisticsTargets = false, bool setEmployeeStatisticsTargetsTypeName = false, bool loadCategories = false, bool loadTimeScheduleType = false, bool loadHierarchyAccounts = false)
        {
            IQueryable<ShiftType> query = entities.ShiftType;
            if (loadAccounts)
                query = query.Include("AccountInternal.Account.AccountDim");
            if (loadSkills)
                query = query.Include("ShiftTypeSkill.Skill.SkillType");
            if (loadEmployeeStatisticsTargets)
                query = query.Include("ShiftTypeEmployeeStatisticsTarget");
            if (loadTimeScheduleType)
                query = query.Include("TimeScheduleType");
            if (loadHierarchyAccounts)
                query = query.Include("ShiftTypeHierarchyAccount");

            ShiftType shiftType = (from s in query
                                   where s.ShiftTypeId == shiftTypeId
                                   select s).FirstOrDefault();

            // Set EmployeeStatisticsTypeName on target values
            if (setEmployeeStatisticsTargetsTypeName && loadEmployeeStatisticsTargets && shiftType != null && shiftType.ShiftTypeEmployeeStatisticsTarget != null && shiftType.ShiftTypeEmployeeStatisticsTarget.Count > 0)
            {
                var types = base.GetTermGroupContent(TermGroup.EmployeeStatisticsType, skipUnknown: true);

                foreach (var target in shiftType.ShiftTypeEmployeeStatisticsTarget)
                {
                    var type = types.FirstOrDefault(t => t.Id == target.EmployeeStatisticsType);
                    if (type != null)
                        target.EmployeeStatisticsTypeName = type.Name;
                }
            }

            if (loadCategories)
            {

                shiftType.CategoryIds = (from c in entities.CompanyCategoryRecord
                                         where c.RecordId == shiftType.ShiftTypeId &&
                                         c.Entity == (int)SoeCategoryRecordEntity.ShiftType &&
                                         c.Category.Type == (int)SoeCategoryType.Employee &&
                                         c.Category.ActorCompanyId == ActorCompanyId &&
                                         c.Category.State == (int)SoeEntityState.Active
                                         select c.CategoryId).ToList();

            }

            return shiftType;
        }

        public ShiftType GetShiftType(CompEntities entities, int shiftTypeId, List<ShiftType> shiftTypes)
        {
            return shiftTypes?.FirstOrDefault(i => i.ShiftTypeId == shiftTypeId) ?? GetShiftType(entities, shiftTypeId);
        }

        public ShiftType GetShiftTypeFromAccountId(CompEntities entities, int accountId, int actorCompanyId, bool loadAccounts = false)
        {
            IQueryable<ShiftType> query = entities.ShiftType;
            if (loadAccounts)
                query = query.Include("AccountInternal.Account.AccountDim");

            return (from s in query
                    where s.AccountId == accountId &&
                    s.ActorCompanyId == actorCompanyId
                    select s).FirstOrDefault();
        }

        public Tuple<int?, int?> GetShiftTypeTupleFromLinkedAccountId(CompEntities entities, int accountId, int actorCompanyId)
        {
            string key = $"GetShiftTypeIdFromLinkedAccountId{accountId}Actorcompanyid{actorCompanyId}";
            Tuple<int?, int?> tuple = BusinessMemoryCache<Tuple<int?, int?>>.Get(key);

            if (tuple != null)
                return tuple;

            ShiftType shiftType = GetShiftTypeFromLinkedAccountId(entities, accountId, actorCompanyId);
            if (shiftType != null)
                tuple = Tuple.Create(shiftType.ShiftTypeId.ToNullable(), shiftType.TimeScheduleTypeId);

            if (tuple == null)
                tuple = Tuple.Create((int?)null, (int?)null);

            BusinessMemoryCache<Tuple<int?, int?>>.Set(key, tuple, 60 * 60);

            return tuple;
        }

        public ShiftType GetShiftTypeFromLinkedAccountId(CompEntities entities, int accountId, int actorCompanyId)
        {
            return (from s in entities.ShiftType
                    where s.AccountInternal.Any(a => a.AccountId == accountId) &&
                    s.ActorCompanyId == actorCompanyId
                    select s).FirstOrDefault();
        }

        public List<ShiftType> GetShiftTypesFromAccountIds(List<int> accountIds, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftTypesFromAccountIds(entities, accountIds, actorCompanyId);
        }

        public List<ShiftType> GetShiftTypesFromAccountIds(CompEntities entities, List<int> accountIds, int actorCompanyId)
        {
            return (from s in entities.ShiftType
                    where s.ActorCompanyId == actorCompanyId &&
                    s.AccountId.HasValue && accountIds.Any(x => x == s.AccountId.Value) &&
                    s.State == (int)SoeEntityState.Active
                    select s).ToList();
        }

        public ShiftType GetShiftTypeFromExtCode(CompEntities entities, string extCode, int actorCompanyId)
        {
            return (from s in entities.ShiftType
                    where s.ExternalCode == extCode &&
                    s.ActorCompanyId == actorCompanyId
                    select s).FirstOrDefault();
        }

        /// <summary>
        /// Insert or update a shift type
        /// </summary>
        /// <param name="shiftTypeInput">ShiftType entity</param>
        /// <param name="categoryRecords">Categories</param>
        /// <param name="accountSettings">Account settings</param>
        /// <param name="shiftTypeSkills">Skills</param>
        /// <param name="employeeStatisticsTargets">EmployeeStatistics target values</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveShiftType(ShiftTypeDTO shiftTypeInput, List<CompanyCategoryRecordDTO> categoryRecords, List<AccountingSettingDTO> accountSettings, List<ShiftTypeSkillDTO> shiftTypeSkills, List<ShiftTypeEmployeeStatisticsTargetDTO> employeeStatisticsTargets, int actorCompanyId)
        {
            if (shiftTypeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ShiftType");

            // Default result is successful
            ActionResult result = new ActionResult();

            int shiftTypeId = shiftTypeInput.ShiftTypeId;
            if (shiftTypeInput.TimeScheduleTemplateBlockType.HasValue && (int)shiftTypeInput.TimeScheduleTemplateBlockType.Value == -1)
                shiftTypeInput.TimeScheduleTemplateBlockType = null;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Prereq

                        shiftTypeInput.NeedsCode = StringUtility.NullToEmpty(shiftTypeInput.NeedsCode).Trim();

                        if (shiftTypeInput.TimeScheduleTemplateBlockType == TermGroup_TimeScheduleTemplateBlockType.Schedule && !String.IsNullOrEmpty(shiftTypeInput.NeedsCode))
                        {
                            List<ShiftType> shiftTypes = GetShiftTypes(entities, actorCompanyId);

                            //Check if needscode is present
                            ShiftType preShiftType = shiftTypes.FirstOrDefault(s => s.ShiftTypeId != shiftTypeInput.ShiftTypeId && !string.IsNullOrEmpty(s.NeedsCode) && s.NeedsCode == shiftTypeInput.NeedsCode);
                            if (preShiftType != null)
                                return new ActionResult((int)ActionResultSave.ShiftTypeNeedsCodeInUse, String.Format(GetText(11967, "Det finns redan en passtyp med koden '{0}', välj en annan kod"), shiftTypeInput.NeedsCode));
                        }

                        // Check if any account dim is linked to shift type
                        AccountDimDTO dim = base.GetShiftTypeAccountDimFromCache(entities, actorCompanyId);

                        #endregion

                        #region ShiftType

                        ShiftType shiftType = GetShiftType(entities, shiftTypeId, true, true, true, loadHierarchyAccounts: true);
                        if (shiftType == null)
                        {
                            #region Add

                            shiftType = new ShiftType()
                            {
                                ActorCompanyId = actorCompanyId,
                                TimeScheduleTemplateBlockType = (int?)shiftTypeInput.TimeScheduleTemplateBlockType,
                                Name = shiftTypeInput.Name,
                                Description = shiftTypeInput.Description,
                                TimeScheduleTypeId = shiftTypeInput.TimeScheduleTypeId,
                                Color = StringUtility.NullToEmpty(shiftTypeInput.Color),
                                DefaultLength = shiftTypeInput.DefaultLength,
                                State = (int)shiftTypeInput.State,
                                NeedsCode = shiftTypeInput.NeedsCode,
                                ExternalCode = shiftTypeInput.ExternalCode,
                                HandlingMoney = shiftTypeInput.HandlingMoney
                            };
                            SetCreatedProperties(shiftType);
                            entities.ShiftType.AddObject(shiftType);

                            #region Accounts

                            if (accountSettings != null)
                            {
                                // Silverlight
                                AddShiftTypeAccounts(entities, actorCompanyId, shiftType, accountSettings);
                            }
                            else if (shiftTypeInput.AccountingSettings != null)
                            {
                                // Angular
                                AddShiftTypeAccountsFromSettingsRow(entities, actorCompanyId, shiftType, shiftTypeInput.AccountingSettings);
                            }
                            #endregion

                            #region HierarchyAccount

                            if (shiftTypeInput.HierarchyAccounts != null)
                            {
                                AddShiftTypeHierarchyAccounts(actorCompanyId, shiftType, shiftTypeInput.HierarchyAccounts);
                            }

                            #endregion

                            #region Skills

                            if (shiftTypeSkills != null)
                            {
                                // Silverlight
                                AddShiftTypeSkills(shiftType, shiftTypeSkills);
                            }
                            else if (shiftTypeInput.ShiftTypeSkills != null)
                            {
                                // Angular
                                AddShiftTypeSkills(shiftType, shiftTypeInput.ShiftTypeSkills);
                            }

                            #endregion

                            #region EmployeeStatisticsTargets

                            if (employeeStatisticsTargets != null)
                            {
                                // Silverlight
                                AddShiftTypeEmployeeStatisticsTargets(shiftType, employeeStatisticsTargets);
                            }
                            else if (shiftTypeInput.EmployeeStatisticsTargets != null)
                            {
                                // Angular
                                AddShiftTypeEmployeeStatisticsTargets(shiftType, shiftTypeInput.EmployeeStatisticsTargets);
                            }

                            #endregion

                            #region Linked Account

                            result = HandleShiftTypeLinkedAccount(entities, shiftTypeInput, shiftType, dim, actorCompanyId);
                            if (!result.Success)
                                return result;

                            #endregion

                            #endregion
                        }
                        else
                        {
                            #region Update

                            // Update ShiftType
                            shiftType.TimeScheduleTemplateBlockType = (int?)shiftTypeInput.TimeScheduleTemplateBlockType;
                            shiftType.Name = shiftTypeInput.Name;
                            shiftType.Description = shiftTypeInput.Description;
                            shiftType.TimeScheduleTypeId = shiftTypeInput.TimeScheduleTypeId.ToNullable();
                            shiftType.Color = shiftTypeInput.Color;
                            shiftType.DefaultLength = shiftTypeInput.DefaultLength;
                            shiftType.State = (int)shiftTypeInput.State;
                            shiftType.NeedsCode = shiftTypeInput.NeedsCode;
                            shiftType.ExternalCode = shiftTypeInput.ExternalCode;
                            shiftType.HandlingMoney = shiftTypeInput.HandlingMoney;

                            SetModifiedProperties(shiftType);

                            #region Accounts

                            if (accountSettings != null)
                            {
                                // Silverlight
                                UpdateShiftTypeAccounts(entities, actorCompanyId, shiftType, accountSettings);
                            }
                            else if (shiftTypeInput.AccountingSettings != null)
                            {
                                // Angular
                                UpdateShiftTypeAccountsFromSettingsRow(entities, actorCompanyId, shiftType, shiftTypeInput.AccountingSettings);
                            }
                            #endregion

                            #region HierarchyAccount

                            if (shiftTypeInput.HierarchyAccounts != null)
                            {
                                UpdateShiftTypeHierarchyAccounts(entities, actorCompanyId, shiftType, shiftTypeInput.HierarchyAccounts);
                            }

                            #endregion

                            #region Skills

                            if (shiftTypeSkills != null)
                            {
                                // Silverlight
                                UpdateShiftTypeSkills(entities, shiftType, shiftTypeSkills);
                            }
                            else if (shiftTypeInput.ShiftTypeSkills != null)
                            {
                                // Angular
                                UpdateShiftTypeSkills(entities, shiftType, shiftTypeInput.ShiftTypeSkills);
                            }

                            #endregion

                            #region EmployeeStatisticsTargets

                            if (employeeStatisticsTargets != null)
                            {
                                // Silverlight
                                UpdateShiftTypeEmployeeStatisticsTargets(shiftType, employeeStatisticsTargets);
                            }
                            else if (shiftTypeInput.EmployeeStatisticsTargets != null)
                            {
                                // Angular
                                UpdateShiftTypeEmployeeStatisticsTargets(shiftType, shiftTypeInput.EmployeeStatisticsTargets);
                            }

                            #endregion

                            #region Linked Account

                            result = HandleShiftTypeLinkedAccount(entities, shiftTypeInput, shiftType, dim, actorCompanyId);
                            if (!result.Success)
                                return result;

                            #endregion

                            #endregion
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (!result.Success)
                            return result;

                        // If adding a new linked account to the shift type, also set it in the accounting settings
                        if (shiftTypeInput.AccountId == -1)
                        {
                            // First remove existing one for shift type dim
                            AccountDimDTO shiftTypeDim = base.GetShiftTypeAccountDimFromCache(entities, actorCompanyId);

                            if (shiftTypeDim != null)
                            {
                                foreach (AccountInternal accInt in shiftType.AccountInternal.ToList())
                                {
                                    if (!accInt.AccountReference.IsLoaded)
                                        accInt.AccountReference.Load();
                                    if (accInt.Account != null && accInt.Account.AccountDimId == shiftTypeDim.AccountDimId)
                                        shiftType.AccountInternal.Remove(accInt);
                                }
                            }
                            if (shiftType.AccountId != null)
                            {
                                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, shiftType.AccountId.Value, actorCompanyId);
                                if (accountInt != null)
                                {
                                    shiftType.AccountInternal.Add(accountInt);
                                    result = SaveChanges(entities, transaction);
                                    if (!result.Success)
                                        return result;
                                }
                            }
                        }

                        shiftTypeId = shiftType.ShiftTypeId;

                        #region Categories

                        if (categoryRecords != null)
                        {
                            // Silverlight
                            result = CategoryManager.SaveCompanyCategoryRecords(entities, transaction, categoryRecords, actorCompanyId, SoeCategoryType.Employee, SoeCategoryRecordEntity.ShiftType, shiftTypeId);
                            if (!result.Success)
                            {
                                result.ErrorNumber = (int)ActionResultSave.ShiftTypeCompanyCategoryNotSaved;
                                return result;
                            }
                        }
                        else if (shiftTypeInput.CategoryIds != null)
                        {
                            // Angular
                            result = CategoryManager.SaveCompanyCategoryRecords(entities, transaction, shiftTypeInput.CategoryIds, actorCompanyId, SoeCategoryType.Employee, SoeCategoryRecordEntity.ShiftType, shiftTypeId);
                            if (!result.Success)
                            {
                                result.ErrorNumber = (int)ActionResultSave.ShiftTypeCompanyCategoryNotSaved;
                                result.ErrorMessage = GetText(11012, "Alla kategorier kunde inte sparas");
                                return result;
                            }
                        }

                        #endregion

                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            shiftTypeId = shiftType.ShiftTypeId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = shiftTypeId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        private ActionResult HandleShiftTypeLinkedAccount(CompEntities entities, ShiftTypeDTO shiftTypeInput, ShiftType shiftType, AccountDimDTO dim, int actorCompanyId)
        {
            if (dim == null)
                return new ActionResult();

            if (shiftTypeInput.AccountId.HasValue)
            {
                if (shiftTypeInput.AccountId.Value == -1)
                {
                    // Add new account
                    Account newAccount = new Account
                    {
                        AccountDimId = dim.AccountDimId,
                        Name = shiftTypeInput.Name,
                        AccountNr = shiftTypeInput.NeedsCode,
                        ActorCompanyId = actorCompanyId,
                    };

                    SetCreatedProperties(newAccount);
                    entities.Account.AddObject(newAccount);

                    AccountInternal accountInternal = new AccountInternal
                    {
                        Account = newAccount,
                    };

                    SetCreatedProperties(accountInternal);
                    entities.AccountInternal.AddObject(accountInternal);

                    shiftType.Account = newAccount;
                }
                else if (shiftTypeInput.AccountId.Value == 0)
                {
                    // Remove link
                    shiftType.AccountId = null;
                }
                else
                {
                    // Link to existing account

                    Account existingAccount = AccountManager.GetAccount(entities, actorCompanyId, shiftTypeInput.AccountId.Value);
                    if (existingAccount == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, "Account");

                    // Check that account is not linked to another shift type
                    ShiftType linkedShiftType = GetShiftTypeFromAccountId(entities, shiftTypeInput.AccountId.Value, actorCompanyId);
                    if (linkedShiftType != null && linkedShiftType.ShiftTypeId != shiftType.ShiftTypeId)
                        return new ActionResult((int)ActionResultSave.Duplicate, String.Format(GetText(3669, "Passtyp {0} är redan länkad till detta konto, välj ett annat konto eller välj att skapa ett nytt"), linkedShiftType.Name));

                    shiftType.AccountId = shiftTypeInput.AccountId.Value;

                    // Update existing account
                    if (existingAccount.AccountNr != shiftTypeInput.NeedsCode || existingAccount.Name != shiftTypeInput.Name || existingAccount.State != (int)shiftTypeInput.State)
                    {
                        existingAccount.AccountNr = shiftTypeInput.NeedsCode;
                        existingAccount.Name = shiftTypeInput.Name;
                        existingAccount.State = (int)shiftTypeInput.State;
                        SetModifiedProperties(existingAccount);
                    }
                }
            }

            return new ActionResult();
        }

        public ActionResult DeleteShiftTypes(List<int> shiftTypeIds, int actorCompanyId)
        {
            ActionResult totalResult = new ActionResult();
            int nbrOfSuccessful = 0;
            int nbrOfUnsuccessful = 0;
            List<string> unsuccessful = new List<string>();
            List<string> inUse = new List<string>();

            foreach (int shiftTypeId in shiftTypeIds)
            {
                ActionResult result = DeleteShiftType(shiftTypeId, actorCompanyId, true);
                if (result.Success)
                {
                    nbrOfSuccessful++;
                }
                else
                {
                    if (result.ErrorNumber == (int)ActionResultDelete.ShiftTypeInUse)
                        inUse.Add(result.StringValue);
                    else if (!String.IsNullOrEmpty(result.StringValue))
                        unsuccessful.Add(result.StringValue);
                    else
                        nbrOfUnsuccessful++;
                }
            }

            // Build result message
            string msg = String.Empty;
            if (nbrOfSuccessful > 0)
                msg += String.Format(GetText(11944, "{0} passtyp(er) togs bort."), nbrOfSuccessful) + "\n\n";

            if (inUse.Any())
                msg += String.Format(GetText(11945, "Följande {0} passtyp(er) kunde inte tas bort p.g.a. att de används:"), inUse.Count) + "\n" + inUse.JoinToString("\n") + "\n\n";

            if (unsuccessful.Any())
                msg += String.Format(GetText(11946, "Följande {0} passtyp(er) kunde inte tas bort av okänd anledning."), unsuccessful.Count) + "\n" + unsuccessful.JoinToString("\n") + "\n\n";

            if (nbrOfUnsuccessful > 0)
                msg += String.Format(GetText(11947, "{0} passtyp(er) kunde inte tas bort av okänd anledning."), nbrOfUnsuccessful);

            totalResult.Success = !inUse.Any() && !unsuccessful.Any() && nbrOfUnsuccessful == 0;
            totalResult.ErrorMessage = msg;
            totalResult.BooleanValue = nbrOfSuccessful > 0; // Will reload grid

            return totalResult;
        }

        public ActionResult DeleteShiftType(int shiftTypeId, int actorCompanyId, bool setShiftTypeNameInError = false)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            string shiftTypeName = setShiftTypeNameInError ? GetShiftType(entitiesReadOnly, shiftTypeId)?.Name : String.Empty;

            ActionResult result = new ActionResult();

            if (ShiftTypeInUse(shiftTypeId))
                return new ActionResult((int)ActionResultDelete.ShiftTypeInUse, GetText(11003, "Passtypen används och kan därför inte tas bort"), shiftTypeName);

            using (CompEntities entities = new CompEntities())
            {
                ShiftType shiftType = GetShiftType(entities, shiftTypeId);
                if (shiftType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "ShiftType");

                // Check if any account dim is linked to shift type
                AccountDimDTO dim = base.GetShiftTypeAccountDimFromCache(entities, actorCompanyId);
                if (dim != null)
                {
                    // Get account linked to current shift type
                    Account account = AccountManager.GetAccountByDimNr(entities, shiftType.NeedsCode, dim.AccountDimNr, actorCompanyId, onlyActive: false);
                    if (account != null)
                        result = ChangeEntityState(entities, account, SoeEntityState.Deleted, true);
                }

                if (result.Success)
                    result = ChangeEntityState(entities, shiftType, SoeEntityState.Deleted, true);
            }

            if (setShiftTypeNameInError && !String.IsNullOrEmpty(shiftTypeName))
                result.StringValue = shiftTypeName;

            if (result.Success)
                result.BooleanValue = true; // Will reload grid, in case of just selecting one in the grid

            return result;
        }

        #region Help-methods      

        private bool ShiftTypeInUse(int shiftTypeId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            int counter = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                           where tb.ShiftTypeId == shiftTypeId &&
                           tb.State == (int)SoeEntityState.Active
                           select tb.TimeScheduleTemplateBlockId).Count();

            if (counter > 0)
                return true;

            counter = (from i in entitiesReadOnly.Invoice.OfType<CustomerInvoice>()
                       where i.ShiftTypeId == shiftTypeId &&
                       i.State == (int)SoeEntityState.Active
                       select i.InvoiceId).Count();

            if (counter > 0)
                return true;

            counter = (from g in entitiesReadOnly.StaffingNeedsLocationGroup
                       where g.ShiftType.Select(s => s.ShiftTypeId).Contains(shiftTypeId) &&
                       g.State == (int)SoeEntityState.Active
                       select g.StaffingNeedsLocationGroupId).Count();

            if (counter > 0)
                return true;

            return false;
        }

        private void AddShiftTypeAccounts(CompEntities entities, int actorCompanyId, ShiftType shiftType, List<AccountingSettingDTO> accountItems)
        {
            // Add internal accounts
            foreach (AccountingSettingDTO item in accountItems)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, item.Account1Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
        }

        private void AddShiftTypeAccountsFromSettingsRow(CompEntities entities, int actorCompanyId, ShiftType shiftType, AccountingSettingsRowDTO accountItemRow)
        {
            // Add internal accounts
            if (accountItemRow.Account1Id > 0)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, accountItemRow.Account1Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
            if (accountItemRow.Account2Id > 0)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, accountItemRow.Account2Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
            if (accountItemRow.Account3Id > 0)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, accountItemRow.Account3Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
            if (accountItemRow.Account4Id > 0)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, accountItemRow.Account4Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
            if (accountItemRow.Account5Id > 0)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, accountItemRow.Account5Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
            if (accountItemRow.Account6Id > 0)
            {
                AccountInternal accountInt = AccountManager.GetAccountInternal(entities, accountItemRow.Account6Id, actorCompanyId);
                if (accountInt != null)
                    shiftType.AccountInternal.Add(accountInt);
            }
        }

        private void UpdateShiftTypeAccounts(CompEntities entities, int actorCompanyId, ShiftType shiftType, List<AccountingSettingDTO> accountItems)
        {
            // Always remove and add internal accounts
            shiftType.AccountInternal.Clear();
            AddShiftTypeAccounts(entities, actorCompanyId, shiftType, accountItems);
        }

        private void UpdateShiftTypeAccountsFromSettingsRow(CompEntities entities, int actorCompanyId, ShiftType shiftType, AccountingSettingsRowDTO accountItem)
        {
            // Always remove and add internal accounts
            shiftType.AccountInternal.Clear();
            AddShiftTypeAccountsFromSettingsRow(entities, actorCompanyId, shiftType, accountItem);
        }

        private void AddShiftTypeHierarchyAccounts(int actorCompanyId, ShiftType shiftType, List<ShiftTypeHierarchyAccountDTO> inputShiftTypeHierarchyAccounts)
        {
            foreach (ShiftTypeHierarchyAccountDTO inputShiftTypeHierarchyAccount in inputShiftTypeHierarchyAccounts)
            {
                ShiftTypeHierarchyAccount shiftTypeHierarchyAccount = new ShiftTypeHierarchyAccount()
                {
                    ActorCompanyId = actorCompanyId,
                    AccountId = inputShiftTypeHierarchyAccount.AccountId,
                    AccountPermissionType = (int)inputShiftTypeHierarchyAccount.AccountPermissionType
                };
                SetCreatedProperties(shiftTypeHierarchyAccount);
                shiftType.ShiftTypeHierarchyAccount.Add(shiftTypeHierarchyAccount);
            }
        }

        private void UpdateShiftTypeHierarchyAccounts(CompEntities entities, int actorCompanyId, ShiftType shiftType, List<ShiftTypeHierarchyAccountDTO> inputShiftTypeHierarchyAccounts)
        {
            // Loop through existing
            foreach (ShiftTypeHierarchyAccount shiftTypeHierarchyAccount in shiftType.ShiftTypeHierarchyAccount.ToList())
            {
                bool hasChanges = false;
                ShiftTypeHierarchyAccountDTO inputShiftTypeHierarchyAccount = inputShiftTypeHierarchyAccounts.FirstOrDefault(s => s.ShiftTypeHierarchyAccountId == shiftTypeHierarchyAccount.ShiftTypeHierarchyAccountId);
                if (inputShiftTypeHierarchyAccount != null)
                {
                    // Account still exists in input, update it and remove from input
                    if (shiftTypeHierarchyAccount.AccountId != inputShiftTypeHierarchyAccount.AccountId)
                    {
                        shiftTypeHierarchyAccount.AccountId = inputShiftTypeHierarchyAccount.AccountId;
                        hasChanges = true;
                    }
                    if (shiftTypeHierarchyAccount.AccountPermissionType != (int)inputShiftTypeHierarchyAccount.AccountPermissionType)
                    {
                        shiftTypeHierarchyAccount.AccountPermissionType = (int)inputShiftTypeHierarchyAccount.AccountPermissionType;
                        hasChanges = true;
                    }

                    inputShiftTypeHierarchyAccounts.Remove(inputShiftTypeHierarchyAccount);
                }
                else
                {
                    // Account does not exist in input, remove from shift type
                    ChangeEntityState(entities, shiftTypeHierarchyAccount, SoeEntityState.Deleted, false);
                    hasChanges = true;
                }
                if (hasChanges)
                    SetModifiedProperties(shiftTypeHierarchyAccount);
            }

            // Add new accounts (remaining in input)
            AddShiftTypeHierarchyAccounts(actorCompanyId, shiftType, inputShiftTypeHierarchyAccounts);
        }

        private void AddShiftTypeSkills(ShiftType shiftType, List<ShiftTypeSkillDTO> shiftTypeSkills)
        {
            foreach (ShiftTypeSkillDTO shiftTypeSkill in shiftTypeSkills)
            {
                shiftType.ShiftTypeSkill.Add(new ShiftTypeSkill()
                {
                    SkillId = shiftTypeSkill.SkillId,
                    SkillLevel = shiftTypeSkill.SkillLevel
                });
            }
        }

        private void UpdateShiftTypeSkills(CompEntities entities, ShiftType shiftType, List<ShiftTypeSkillDTO> inputShiftTypeSkills)
        {
            // Loop through existing skills
            foreach (ShiftTypeSkill shiftTypeSkill in shiftType.ShiftTypeSkill.ToList())
            {
                ShiftTypeSkillDTO inputShiftTypeSkill = inputShiftTypeSkills.FirstOrDefault(s => s.SkillId == shiftTypeSkill.SkillId);
                if (inputShiftTypeSkill != null)
                {
                    // Skill still exists in input, update it and remove from input
                    shiftTypeSkill.SkillLevel = inputShiftTypeSkill.SkillLevel;
                    inputShiftTypeSkills.Remove(inputShiftTypeSkill);
                }
                else
                {
                    // Skill does not exist in input, remove from shift type
                    shiftType.ShiftTypeSkill.Remove(shiftTypeSkill);
                    entities.DeleteObject(shiftTypeSkill);
                }
            }

            // Add new skills (remaining in input)
            AddShiftTypeSkills(shiftType, inputShiftTypeSkills);
        }

        private void AddShiftTypeEmployeeStatisticsTargets(ShiftType shiftType, List<ShiftTypeEmployeeStatisticsTargetDTO> inputTargets)
        {
            foreach (ShiftTypeEmployeeStatisticsTargetDTO inputTarget in inputTargets)
            {
                ShiftTypeEmployeeStatisticsTarget target = new ShiftTypeEmployeeStatisticsTarget()
                {
                    EmployeeStatisticsType = (int)inputTarget.EmployeeStatisticsType,
                    TargetValue = inputTarget.TargetValue,
                    FromDate = inputTarget.FromDate
                };
                SetCreatedProperties(target);
                shiftType.ShiftTypeEmployeeStatisticsTarget.Add(target);
            }
        }

        private void UpdateShiftTypeEmployeeStatisticsTargets(ShiftType shiftType, List<ShiftTypeEmployeeStatisticsTargetDTO> inputTargets)
        {
            // Loop through existing target values
            foreach (ShiftTypeEmployeeStatisticsTarget target in shiftType.ShiftTypeEmployeeStatisticsTarget.Where(s => s.State == (int)SoeEntityState.Active).ToList())
            {
                ShiftTypeEmployeeStatisticsTargetDTO inputTarget = inputTargets.FirstOrDefault(t => t.ShiftTypeEmployeeStatisticsTargetId == target.ShiftTypeEmployeeStatisticsTargetId);
                if (inputTarget != null)
                {
                    // Target value still exists in input, update it and remove from input
                    if (target.EmployeeStatisticsType != (int)inputTarget.EmployeeStatisticsType ||
                       target.TargetValue != inputTarget.TargetValue ||
                       target.FromDate != inputTarget.FromDate ||
                       target.State != (int)inputTarget.State)
                    {
                        // Only update if actually modified
                        target.EmployeeStatisticsType = (int)inputTarget.EmployeeStatisticsType;
                        target.TargetValue = inputTarget.TargetValue;
                        target.FromDate = inputTarget.FromDate;
                        target.State = (int)inputTarget.State;
                        SetModifiedProperties(target);
                    }
                    inputTargets.Remove(inputTarget);
                }
                else
                {
                    // Target value does not exist in input, set as deleted
                    target.State = (int)SoeEntityState.Deleted;
                    SetModifiedProperties(target);
                }
            }

            // Add new target values (remaining in input)
            AddShiftTypeEmployeeStatisticsTargets(shiftType, inputTargets);
        }

        #endregion

        #endregion

        #region ShiftTypeLink

        public List<ShiftTypeLinkDTO> GetShiftTypeLinkDTOs(int actorCompanyId)
        {
            List<ShiftTypeLinkDTO> dtos = new List<ShiftTypeLinkDTO>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<ShiftTypeLink> allShiftTypeLinks = (from stl in entitiesReadOnly.ShiftTypeLink
                                                        .Include("ShiftType")
                                                     where stl.ActorCompanyId == actorCompanyId
                                                     select stl).ToList();

            foreach (var shiftTypeLinksGrouping in allShiftTypeLinks.GroupBy(i => i.Guid))
            {
                ShiftTypeLinkDTO dto = new ShiftTypeLinkDTO
                {
                    Guid = shiftTypeLinksGrouping.Key.ToString(),
                    ShiftTypes = shiftTypeLinksGrouping.Select(i => i.ShiftType).Distinct().ToDTOs().ToList()
                };
                dtos.Add(dto);
            }

            return dtos;
        }

        public List<ShiftTypeLink> GetShiftTypeLinks(string guid, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftTypeLinks(entities, guid, actorCompanyId);
        }

        public List<ShiftTypeLink> GetShiftTypeLinks(CompEntities entities, string guid, int actorCompanyId)
        {
            Guid parsedGuid = Guid.Parse(guid);

            return (from stl in entities.ShiftTypeLink
                    where stl.Guid == parsedGuid &&
                    stl.ActorCompanyId == actorCompanyId
                    select stl).ToList();
        }

        public ActionResult SaveShiftTypeLinks(List<ShiftTypeLinkDTO> inputShiftTypeLinks, int actorCompanyId)
        {
            if (inputShiftTypeLinks == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "ShiftTypeLink");

            ActionResult result = null;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        foreach (ShiftTypeLinkDTO inputShiftTypeLink in inputShiftTypeLinks)
                        {
                            #region Update/Delete

                            if (inputShiftTypeLink.Guid == null)
                            {
                                //Add new guid
                                Guid guid = Guid.NewGuid();
                                foreach (ShiftTypeDTO shiftTypeDTO in inputShiftTypeLink.ShiftTypes)
                                {
                                    ShiftTypeLink shiftTypeLink = new ShiftTypeLink()
                                    {
                                        ActorCompanyId = actorCompanyId,
                                        Guid = guid,
                                        ShiftTypeId = shiftTypeDTO.ShiftTypeId,
                                    };
                                    entities.ShiftTypeLink.AddObject(shiftTypeLink);
                                }
                            }
                            else
                            {
                                List<ShiftTypeLink> existingShiftTypeLinks = GetShiftTypeLinks(entities, inputShiftTypeLink.Guid, actorCompanyId);

                                //Update to guid
                                foreach (ShiftTypeDTO shiftTypeDTO in inputShiftTypeLink.ShiftTypes)
                                {
                                    if (!existingShiftTypeLinks.Any(i => i.ShiftTypeId == shiftTypeDTO.ShiftTypeId))
                                    {
                                        ShiftTypeLink shiftTypeLink = new ShiftTypeLink()
                                        {
                                            ActorCompanyId = actorCompanyId,
                                            Guid = Guid.Parse(inputShiftTypeLink.Guid),
                                            ShiftTypeId = shiftTypeDTO.ShiftTypeId,
                                        };
                                        entities.ShiftTypeLink.AddObject(shiftTypeLink);
                                    }
                                }

                                //Delete form guid
                                foreach (ShiftTypeLink existingShiftTypeLink in existingShiftTypeLinks)
                                {
                                    if (!inputShiftTypeLink.ShiftTypes.Any(i => i.ShiftTypeId == existingShiftTypeLink.ShiftTypeId))
                                        entities.DeleteObject(existingShiftTypeLink);
                                }
                            }

                            #endregion
                        }

                        result = SaveChanges(entities, transaction);
                        if (!result.Success)
                            return result;

                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties

                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }
            return result;
        }

        #endregion

        #region ShiftTypeEmployeeStatisticsTarget

        public decimal GetShiftTypeEmployeeStatisticsTargetValue(int shiftTypeId, TermGroup_EmployeeStatisticsType type, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftTypeEmployeeStatisticsTarget.NoTracking();
            var target = (from s in entities.ShiftTypeEmployeeStatisticsTarget
                          where s.ShiftTypeId == shiftTypeId &&
                          s.EmployeeStatisticsType == (int)type &&
                          (s.FromDate == null || s.FromDate <= date) &&
                          s.State == (int)SoeEntityState.Active
                          select s).OrderByDescending(s => s.FromDate).FirstOrDefault();

            return target != null ? target.TargetValue : 0;
        }

        #endregion

        #region Skill

        public List<ShiftTypeSkill> GetShiftTypeSkills(int shiftTypeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.ShiftTypeSkill.NoTracking();
            return GetShiftTypeSkills(entities, shiftTypeId);
        }

        public List<ShiftTypeSkill> GetShiftTypeSkills(CompEntities entities, int shiftTypeId)
        {
            return (from e in entities.ShiftTypeSkill.Include("Skill.SkillType")
                    where e.ShiftTypeId == shiftTypeId &&
                    e.Skill.State == (int)SoeEntityState.Active
                    orderby e.Skill.SkillType.Name, e.Skill.Name
                    select e).ToList();
        }

        public List<EmployeeSkill> GetEmployeeSkillsForCompany(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSkill.NoTracking();
            return GetEmployeeSkillsForCompany(entities, actorCompanyId);
        }

        public List<EmployeeSkill> GetEmployeeSkillsForCompany(CompEntities entities, int actorCompanyId)
        {
            return (from e in entities.EmployeeSkill.Include("Skill.SkillType")
                    where e.Skill.ActorCompanyId == actorCompanyId &&
                    e.Skill.State == (int)SoeEntityState.Active
                    orderby e.Skill.SkillType.Name, e.Skill.Name
                    select e).ToList();
        }

        public IQueryable<EmployeeSkill> GetEmployeeSkillsQuery(CompEntities entities, int employeeId, bool includeSkillType = false)
        {
            var query = entities.EmployeeSkill.Where(e => e.EmployeeId == employeeId && e.Skill.State == (int)SoeEntityState.Active);
            if (includeSkillType)
                query = query.Include("Skill.SkillType");
            return query;
        }

        public List<EmployeeSkill> GetEmployeeSkills(int employeeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSkill.NoTracking();
            return GetEmployeeSkills(entities, employeeId);
        }

        public List<EmployeeSkill> GetEmployeeSkills(CompEntities entities, int employeeId)
        {
            return GetEmployeeSkillsQuery(entities, employeeId, includeSkillType: true)
                .OrderBy(dto => dto.Skill.SkillType.Name)
                .ThenBy(dto => dto.Skill.Name)
                .ToList();
        }

        public List<EmployeeSkillDTO> GetEmployeeSkillsDTOs(int employeeId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var query = GetEmployeeSkillsQuery(entitiesReadOnly, employeeId, includeSkillType: true);
            var dtos = query.Select(EntityExtensions.GetEmployeeSkillDTO).ToList();

            return dtos
                .OrderBy(dto => dto.SkillTypeName)
                .ThenBy(dto => dto.SkillName)
                .ToList();
        }

        public List<Skill> GetEmployeeSkills(int actorCompanyId, int employeeId, bool loadTypeNames = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Skill.NoTracking();
            entities.SkillType.NoTracking();
            return GetEmployeeSkills(entities, actorCompanyId, employeeId, loadTypeNames);
        }

        public List<Skill> GetEmployeeSkills(CompEntities entities, int actorCompanyId, int employeeId, bool loadTypeNames = false)
        {
            List<Skill> skills = (from s in entities.Skill
                                  where s.ActorCompanyId == actorCompanyId &&
                                  s.EmployeeSkill.Any(t => t.EmployeeId == employeeId) &&
                                  s.State == (int)SoeEntityState.Active
                                  orderby s.SkillType.Name, s.Name
                                  select s).ToList();

            if (loadTypeNames)
            {
                foreach (Skill skill in skills)
                {
                    skill.SkillTypeName = GetSkillType(skill.SkillTypeId).Name;
                }
            }

            return skills;
        }

        public List<Skill> GetSkills(int actorCompanyId, bool loadTypeNames = false, int? skillId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Skill.NoTracking();
            return GetSkills(entities, actorCompanyId, loadTypeNames, skillId);
        }

        public List<Skill> GetSkills(CompEntities entities, int actorCompanyId, bool loadTypeNames = false, int? skillId = null)
        {
            IQueryable<Skill> query = entities.Skill;
            if (loadTypeNames)
                query = query.Include("SkillType");

            if (skillId.HasValue)
                query = query.Where(t => t.SkillId == skillId);

            List<Skill> skills = (from s in query
                                  where s.ActorCompanyId == actorCompanyId &&
                                  s.State == (int)SoeEntityState.Active
                                  select s).ToList();

            if (loadTypeNames)
            {
                foreach (Skill skill in skills)
                {
                    skill.SkillTypeName = skill.SkillType != null ? skill.SkillType.Name : String.Empty;
                }
            }

            if (loadTypeNames)
                return skills.OrderBy(s => s.SkillTypeName).ThenBy(s => s.Name).ToList();
            else
                return skills.OrderBy(s => s.Name).ToList();
        }

        public Dictionary<int, string> GetSkillsDict(int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            IEnumerable<Skill> skills = GetSkills(actorCompanyId).OrderBy(s => s.Name).ToList();
            foreach (Skill skill in skills)
            {
                dict.Add(skill.SkillId, skill.Name);
            }

            return dict;
        }

        public Skill GetSkill(int skillId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.Skill.NoTracking();
            return GetSkill(entities, skillId);
        }

        public Skill GetSkill(CompEntities entities, int skillId)
        {
            return (from s in entities.Skill
                    where s.SkillId == skillId
                    select s).FirstOrDefault();
        }

        public Skill GetSkill(CompEntities entities, int actorCompanyId, string name)
        {
            return (from s in entities.Skill
                    where s.Name == name &&
                    s.ActorCompanyId == actorCompanyId
                    select s).FirstOrDefault();
        }

        /// <summary>
        /// Insert or update a skill
        /// </summary>
        /// <param name="skillInput">Skill entity</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveSkill(SkillDTO skillInput, int actorCompanyId)
        {
            if (skillInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "Skill");

            // Default result is successful
            ActionResult result = null;

            int skillId = skillInput.SkillId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Skill

                        // Get existing skill
                        Skill skill = GetSkill(entities, skillId);
                        if (skill == null)
                        {
                            #region Skill Add

                            skill = new Skill()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(skill);
                            entities.Skill.AddObject(skill);

                            #endregion
                        }
                        else
                        {
                            #region Skill Update

                            SetModifiedProperties(skill);

                            #endregion
                        }

                        skill.SkillTypeId = skillInput.SkillTypeId;
                        skill.Name = skillInput.Name;
                        skill.Description = skillInput.Description;
                        skill.State = (int)skillInput.State;

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            skillId = skill.SkillId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = skillId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        /// <summary>
        /// Sets a skills state to Deleted
        /// </summary>
        /// <param name="skillId">Skill to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteSkill(int skillId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                // Check relations
                if (SkillHasShiftTypes(skillId))
                    return new ActionResult((int)ActionResultDelete.SkillHasShiftTypes);
                if (SkillHasEmployees(skillId))
                    return new ActionResult((int)ActionResultDelete.SkillHasEmployees);
                if (SkillHasPositions(skillId))
                    return new ActionResult((int)ActionResultDelete.SkillHasPositions);

                #endregion

                Skill skill = GetSkill(entities, skillId);
                if (skill == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "Skill");

                return ChangeEntityState(entities, skill, SoeEntityState.Deleted, true);
            }
        }

        private bool SkillHasEmployees(int skillId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from s in entitiesReadOnly.EmployeeSkill
                    where s.SkillId == skillId
                    select s).Any();
        }

        private bool SkillHasPositions(int skillId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from s in entitiesReadOnly.PositionSkill
                    where s.SkillId == skillId
                    select s).Any();
        }

        private bool SkillHasShiftTypes(int skillId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from s in entitiesReadOnly.ShiftTypeSkill
                    where s.SkillId == skillId
                    select s).Any();
        }

        public bool EmployeeHasShiftTypeSkills(int employeeId, int shiftTypeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSkill.NoTracking();
            entities.ShiftTypeSkill.NoTracking();
            return EmployeeHasShiftTypeSkills(entities, employeeId, shiftTypeId, date);
        }

        public bool EmployeeHasShiftTypeSkills(CompEntities entities, int employeeId, int shiftTypeId, DateTime date)
        {
            List<EmployeeSkill> employeeSkills = GetEmployeeSkills(entities, employeeId);
            List<ShiftTypeSkill> shiftTypeSkills = GetShiftTypeSkills(entities, shiftTypeId);
            return shiftTypeSkills.IsValid(employeeSkills, date);
        }

        public bool EmployeeHasEmployeePostSkills(CompEntities entities, int employeeId, int employeePostId, DateTime date)
        {
            List<EmployeeSkill> employeeSkills = GetEmployeeSkills(entities, employeeId);
            List<EmployeePostSkill> employeePostSkills = GetEmployeePostSkills(entities, employeePostId);
            return employeePostSkills.IsValid(employeeSkills, date);
        }

        public bool EmployeePostHasShiftTypeSkills(int employeePostId, int shiftTypeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSkill.NoTracking();
            entities.ShiftTypeSkill.NoTracking();
            return EmployeePostHasShiftTypeSkills(entities, employeePostId, shiftTypeId, date);
        }

        public bool EmployeePostHasShiftTypeSkills(CompEntities entities, int employeePostId, int shiftTypeId, DateTime date)
        {
            List<EmployeePostSkill> employeePostSkills = GetEmployeePostSkills(entities, employeePostId);
            List<ShiftTypeSkill> shiftTypeSkills = GetShiftTypeSkills(entities, shiftTypeId);
            return shiftTypeSkills.IsValid(employeePostSkills);
        }

        // TODO: This method should also match levels on skills
        public List<int> MatchEmployeesByShiftTypeSkills(int shiftTypeId, int actorCompanyId, List<Employee> employeesWithSkills = null)
        {
            List<int> employeeIds = new List<int>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.EmployeeSkill.NoTracking();
            entitiesReadOnly.Employee.NoTracking();
            // Get shift type
            ShiftType shiftType = GetShiftType(shiftTypeId, loadSkills: true);
            if (shiftType != null)
            {
                // Get skills
                List<int> skillIds = new List<int>();
                foreach (ShiftTypeSkill shiftTypeSkill in shiftType.ShiftTypeSkill)
                {
                    skillIds.Add(shiftTypeSkill.SkillId);
                }

                // Get employees with all skills from shift type
                if (employeesWithSkills == null)
                {
                    entitiesReadOnly.Employee.NoTracking();
                    employeesWithSkills = (from e in entitiesReadOnly.Employee.Include("EmployeeSkill")
                                           where e.ActorCompanyId == actorCompanyId
                                           select e).ToList();
                }

                foreach (Employee employee in employeesWithSkills)
                {
                    bool match = true;
                    foreach (int skillId in skillIds)
                    {
                        if (!employee.EmployeeSkill.Any(e => e.SkillId == skillId))
                        {
                            match = false;
                            break;
                        }
                    }
                    if (match)
                        employeeIds.Add(employee.EmployeeId);
                }
            }

            return employeeIds;
        }

        public List<SearchEmployeeSkillDTO> SearchEmployeeSkills(int actorCompanyId, string employeeNrFrom, string employeeNrTo, int categoryId, int positionId, int skillId, DateTime? endDate, bool getMissingSkill, bool getMissingPosition, int? accountId = 0)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSkill.NoTracking();
            return SearchEmployeeSkills(entities, actorCompanyId, employeeNrFrom, employeeNrTo, categoryId, positionId, skillId, endDate, getMissingSkill, getMissingPosition, accountId);
        }

        protected List<SearchEmployeeSkillDTO> SearchEmployeeSkills(CompEntities entities, int actorCompanyId, string employeeNrFrom, string employeeNrTo, int categoryId, int positionId, int skillId, DateTime? endDate, bool getMissingSkill, bool getMissingPosition, int? accountId = 0)
        {
            List<SearchEmployeeSkillDTO> dtos = new List<SearchEmployeeSkillDTO>();
            int accountDimId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimEmployee, 0, actorCompanyId, 0);
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
            var validEmployeeIds = EmployeeManager.GetEmployeesForUsersAttestRoles(entities, out _, actorCompanyId, base.UserId, base.RoleId).Select(e => e.EmployeeId).ToList();
            var noAccount = false;

            IQueryable<Employee> query = entities.Employee.Include("ContactPerson").Include("EmployeeSkill.Skill").Include("EmployeePosition.Position.PositionSkill.Skill");
            if (!accountId.IsNullOrEmpty())
            {
                query = query.Include("EmployeeAccount.Account");
                var account = AccountManager.GetAccount(entities, actorCompanyId, accountId.Value);
                if (account != null && account.AccountDimId != accountDimId)
                {
                    var accountIds = AccountManager.GetAllChildrenAccounts(entities, actorCompanyId, accountId.Value).Select(a => a.AccountId).ToList();
                    var employeeAccounts = EmployeeManager.GetEmployeeAccounts(entities, actorCompanyId, validEmployeeIds, DateTime.Today, DateTime.Today).Where(e => e.AccountId.HasValue && accountIds.Contains(e.AccountId.Value) && !e.ParentEmployeeAccountId.HasValue).Select(e => e.EmployeeAccountId).ToList();
                    if (!employeeAccounts.IsNullOrEmpty())
                        query.Where(e => e.EmployeeAccount.Any(a => employeeAccounts.Contains(a.EmployeeAccountId)));

                }
                else
                    noAccount = true;

            }
            query = query.Where(e => e.ActorCompanyId == actorCompanyId && e.State == (int)SoeEntityState.Active && e.EmployeeId != hiddenEmployeeId && validEmployeeIds.Contains(e.EmployeeId));

            if (employeeNrFrom != null && employeeNrFrom != String.Empty)
                query = query.Where(e => e.EmployeeNr.Length != employeeNrFrom.Length || e.EmployeeNr.CompareTo(employeeNrFrom) >= 0);

            if (employeeNrTo != null && employeeNrFrom != String.Empty)
                query = query.Where(e => e.EmployeeNr.Length != employeeNrTo.Length || e.EmployeeNr.CompareTo(employeeNrTo) <= 0);

            if (positionId > 0)
            {
                if (getMissingPosition)
                    query = query.Where(e => !e.EmployeePosition.Select(s => s.PositionId).Contains(positionId));
                else
                    query = query.Where(e => e.EmployeePosition.Select(s => s.PositionId).Contains(positionId));
            }
            else
            {
                if (getMissingPosition)
                    query = query.Where(e => !e.EmployeePosition.Any());
            }

            if (skillId > 0)
            {
                if (getMissingSkill)
                    query = query.Where(e => !e.EmployeeSkill.Select(s => s.SkillId).Contains(skillId));
                else
                    query = query.Where(e => e.EmployeeSkill.Select(s => s.SkillId).Contains(skillId));
            }
            else
            {
                if (getMissingSkill)
                    query = query.Where(e => !e.EmployeeSkill.Any());
            }

            if (endDate != null)
                query = query.Where(e => e.EmployeeSkill.Where(s => s.DateTo != null).Select(s => ((DateTime)s.DateTo).ToShortDateString()).Contains(((DateTime)endDate).ToShortDateString()));

            var employees = query.ToList();

            List<SearchEmployeeSkillDTO> tempList = new List<SearchEmployeeSkillDTO>();

            foreach (Employee employee in employees)
            {

                #region Employee number


                bool isInInterval = true; //Used for both employeeId and Category
                string accountName = "";

                if (!String.IsNullOrEmpty(employeeNrFrom))
                {
                    if (!String.IsNullOrEmpty(employeeNrTo))
                        isInInterval = (Validator.ValidateStringInterval(employeeNrFrom, employee.EmployeeNr) && Validator.ValidateStringInterval(employee.EmployeeNr, employeeNrTo)); //both
                    else
                        isInInterval = (Validator.ValidateStringInterval(employeeNrFrom, employee.EmployeeNr)); //from
                }
                else if (!String.IsNullOrEmpty(employeeNrTo))
                {
                    isInInterval = (Validator.ValidateStringInterval(employee.EmployeeNr, employeeNrTo)); //to
                }

                if (!isInInterval)
                    continue;

                #endregion

                #region Category

                if (categoryId != 0)
                {
                    List<CompanyCategoryRecord> categoryRecords = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Employee, SoeCategoryRecordEntity.Employee, employee.EmployeeId, actorCompanyId, dateTo: endDate);
                    if (!categoryRecords.Any(r => r.CategoryId == categoryId))
                        isInInterval = false;
                }
                if (accountId != 0)
                {

                    var accountNames = employee.EmployeeAccount?.Where(a => !a.ParentEmployeeAccountId.HasValue && a.Account.AccountDimId == accountDimId).ToList();
                    if (accountNames == null)
                        continue;

                    foreach (var acc in accountNames)
                    {
                        if (!noAccount || (noAccount && acc.Account.AccountId == accountId))
                        {
                            if (accountName != "") accountName += $", {acc.Account.AccountNrPlusName}";
                            else accountName = acc.Account.AccountNrPlusName;
                        }
                    }
                    if (accountName == "")
                        continue;

                }

                if (!isInInterval)
                    continue;

                #endregion

                #region Employee skills

                if (employee.EmployeeSkill.Count > 0)
                {
                    if (skillId != 0)
                    {
                        // Skill specified
                        EmployeeSkill employeeSkill = employee.EmployeeSkill.FirstOrDefault(s => s.SkillId == skillId);
                        if ((!getMissingSkill && employeeSkill != null) || (getMissingSkill && employeeSkill == null))
                            dtos.Add(CreateSearchEmployeeSkillDTO(employee, employeeSkill, accountName));
                    }
                    else
                    {
                        // All skills
                        foreach (EmployeeSkill employeeSkill in employee.EmployeeSkill)
                        {
                            if (!getMissingSkill)
                                dtos.Add(CreateSearchEmployeeSkillDTO(employee, employeeSkill, accountName));
                        }
                    }
                }
                else
                {
                    // Employee has no skills
                    if (getMissingSkill && skillId != 0)
                    {
                        SearchEmployeeSkillDTO dto = CreateSearchEmployeeSkillDTO(employee, null, accountName);
                        dto.SkillId = skillId;
                        dto.AccountName = accountName;
                        dtos.Add(dto);
                    }
                }

                #endregion

                List<PositionSkill> positionSkills = new List<PositionSkill>();

                if (employee.EmployeePosition.Count > 0 && !getMissingSkill)
                {
                    if (!getMissingPosition)
                    {
                        foreach (EmployeePosition employeePosition in employee.EmployeePosition)
                        {
                            Position position = employeePosition.Position;
                            if (position != null)
                            {
                                foreach (PositionSkill ps in position.PositionSkill)
                                {
                                    SearchEmployeeSkillDTO dto = dtos.FirstOrDefault(d => d.EmployeeId == employee.EmployeeId && d.SkillId == ps.SkillId);
                                    if (dto != null)
                                    {
                                        dto.SkillLevelPosition = dto.SkillLevelPosition > ps.SkillLevel ? dto.SkillLevelPosition : ps.SkillLevel;
                                        dto.Positions += !String.IsNullOrEmpty(dto.Positions) ? ", " + position.Name : position.Name;
                                        dto.SkillLevelDifference = (dto.SkillLevelPosition - dto.SkillLevel);
                                    }
                                    else if (skillId == 0)
                                    {
                                        // Employee is missing skill
                                        dto = CreateSearchEmployeeSkillDTO(employee);
                                        dto.SkillId = ps.SkillId;
                                        dto.SkillLevelPosition = ps.SkillLevel;
                                        dto.SkillName = ps.Skill.Name;
                                        dto.Positions = position.Name;
                                        dto.SkillLevelDifference = ps.SkillLevel;
                                        dto.AccountName = accountName;
                                        dtos.Add(dto);
                                    }
                                }
                            }
                        }
                    }
                    else
                    {
                        // Missing position
                        if (!employee.EmployeePosition.Select(p => p.PositionId).Contains(positionId) && !dtos.Select(em => em.EmployeeId).Contains(employee.EmployeeId))
                            dtos.Add(CreateSearchEmployeeSkillDTO(employee, null, accountName));
                    }
                }
                else
                {
                    // Employee has no positions

                    Position position = EmployeeManager.GetPositionIncludingSkill(entities, positionId);
                    if (position != null)
                    {
                        if (getMissingPosition)
                        {
                            if (!dtos.Any(em => em.EmployeeId == employee.EmployeeId))
                            {
                                SearchEmployeeSkillDTO dto = CreateSearchEmployeeSkillDTO(employee, null, accountName);
                                dto.SkillId = skillId;
                                dtos.Add(dto);
                            }
                        }
                        else
                        {
                            if (getMissingSkill && skillId == 0)
                            {
                                // Add all missing skills for selected position
                                foreach (PositionSkill positionSkill in position.PositionSkill)
                                {
                                    if (!employee.EmployeeSkill.Any(s => s.SkillId == positionSkill.SkillId))
                                    {
                                        //Missing
                                        SearchEmployeeSkillDTO dto = CreateSearchEmployeeSkillDTO(employee, null, accountName);
                                        dto.SkillId = positionSkill.SkillId;
                                        dto.SkillLevelPosition = positionSkill.SkillLevel;
                                        dto.SkillName = positionSkill.Skill.Name;
                                        dto.Positions = position.Name;
                                        dto.SkillLevelDifference = positionSkill.SkillLevel;

                                        dtos.Add(dto);
                                    }
                                }
                            }
                            else if (skillId != 0)
                            {
                                SearchEmployeeSkillDTO dto = dtos.FirstOrDefault(em => em.EmployeeId == employee.EmployeeId);
                                if (dto != null)
                                {
                                    PositionSkill positionSkill = position.PositionSkill.FirstOrDefault(s => s.SkillId == skillId);
                                    if (positionSkill != null)
                                    {
                                        dto.SkillLevelPosition = dto.SkillLevelPosition > positionSkill.SkillLevel ? dto.SkillLevelPosition : positionSkill.SkillLevel;
                                        dto.Positions += !String.IsNullOrEmpty(dto.Positions) ? ", " + position.Name : position.Name;
                                        dto.SkillName = positionSkill.Skill.Name;
                                        dto.SkillLevelDifference = (dto.SkillLevelPosition - dto.SkillLevel);
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return dtos;
        }

        private SearchEmployeeSkillDTO CreateSearchEmployeeSkillDTO(Employee employee, EmployeeSkill employeeSkill = null, string accountName = "")
        {
            SearchEmployeeSkillDTO dto = new SearchEmployeeSkillDTO()
            {
                EmployeeId = employee.EmployeeId,
                EmployeeName = String.Format("({0}) {1} {2}", employee.EmployeeNr, employee.ContactPerson.FirstName, employee.ContactPerson.LastName)

            };

            if (employeeSkill != null)
            {
                dto.SkillId = employeeSkill.SkillId;
                dto.SkillLevel = employeeSkill.SkillLevel;
                dto.SkillName = employeeSkill.Skill.Name;
                dto.EndDate = employeeSkill.DateTo;
                dto.AccountName = accountName;
            }

            return dto;
        }

        #endregion

        #region SkillType

        public List<SkillType> GetSkillTypes(int actorCompanyId, bool? active = null, int? skillTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.SkillType.NoTracking();
            return GetSkillTypes(entities, actorCompanyId, active, skillTypeId);
        }

        public List<SkillType> GetSkillTypes(CompEntities entities, int actorCompanyId, bool? active = null, int? skillTypeId = null)
        {
            IQueryable<SkillType> query = (from s in entities.SkillType
                                           where s.ActorCompanyId == actorCompanyId &&
                                           s.State != (int)SoeEntityState.Deleted
                                           select s);

            if (active == true)
                query = query.Where(a => a.State == (int)SoeEntityState.Active);
            else if (active == false)
                query = query.Where(a => a.State == (int)SoeEntityState.Inactive);

            if (skillTypeId.HasValue)
                query = query.Where(t => t.SkillTypeId == skillTypeId);

            return query.OrderBy(s => s.Name).ToList();
        }

        public Dictionary<int, string> GetSkillTypesDict(int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            IEnumerable<SkillType> skills = GetSkillTypes(actorCompanyId, true);
            foreach (SkillType skill in skills)
            {
                dict.Add(skill.SkillTypeId, skill.Name);
            }

            return dict;
        }

        public SkillType GetSkillType(int skillTypeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.SkillType.NoTracking();
            return GetSkillType(entities, skillTypeId);
        }

        public SkillType GetSkillType(CompEntities entities, int skillTypeId)
        {
            return (from s in entities.SkillType
                    where s.SkillTypeId == skillTypeId
                    select s).FirstOrDefault();
        }

        /// <summary>
        /// Insert or update a skill type
        /// </summary>
        /// <param name="skillTypeInput">SkillType entity</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveSkillType(SkillTypeDTO skillTypeInput, int actorCompanyId)
        {
            if (skillTypeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "SkillType");

            // Default result is successful
            ActionResult result = null;

            int skillTypeId = skillTypeInput.SkillTypeId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region SkillType

                        // Get existing skill type
                        SkillType skillType = GetSkillType(entities, skillTypeId);
                        if (skillType == null)
                        {
                            #region SkillType Add

                            skillType = new SkillType()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(skillType);
                            entities.SkillType.AddObject(skillType);

                            #endregion
                        }
                        else
                        {
                            #region SkillType Update

                            SetModifiedProperties(skillType);

                            #endregion
                        }

                        skillType.Name = skillTypeInput.Name;
                        skillType.Description = skillTypeInput.Description;
                        skillType.State = (int)skillTypeInput.State;

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            skillTypeId = skillType.SkillTypeId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = skillTypeId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        /// <summary>
        /// Sets a skill types state to Deleted
        /// </summary>
        /// <param name="skillTypeId">Skill type to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteSkillType(int skillTypeId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                // Check relations
                if (SkillTypeHasSkills(skillTypeId))
                    return new ActionResult((int)ActionResultDelete.SkillTypeHasSkills, GetText(3361, "Det finns kompetenser kopplade till denna typ, dessa måste tas bort först"));

                #endregion

                SkillType skillType = GetSkillType(entities, skillTypeId);
                if (skillType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "SkillType");

                return ChangeEntityState(entities, skillType, SoeEntityState.Deleted, true);
            }
        }

        public ActionResult UpdateSkillTypesState(Dictionary<int, bool> skillTypes)
        {
            using (CompEntities entities = new CompEntities())
            {
                foreach (KeyValuePair<int, bool> skillType in skillTypes)
                {
                    SkillType originalSkillType = GetSkillType(entities, skillType.Key);
                    if (originalSkillType == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, "SkillType");

                    ChangeEntityState(originalSkillType, skillType.Value ? SoeEntityState.Active : SoeEntityState.Inactive);
                }

                return SaveChanges(entities);
            }
        }

        private bool SkillTypeHasSkills(int skillTypeId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return entitiesReadOnly.Skill.Any(s => s.SkillTypeId == skillTypeId && s.State == (int)SoeEntityState.Active);
        }

        #endregion

        #region StaffingNeeds

        public List<StaffingNeedsTaskDTO> GetUnscheduledStaffingNeedsTasks(int actorCompanyId, List<int> shiftTypeIds, DateTime dateFrom, DateTime dateTo, SoeStaffingNeedType type, bool previewByDate = false)
        {
            List<StaffingNeedsTaskDTO> allRemainingTasks = new List<StaffingNeedsTaskDTO>();

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetBeginningOfDay(dateTo);

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            base.HasStaffingNeedsFromCache(entitiesReadOnly, actorCompanyId);

            StaffingNeedsCalculationEngine staffingNeedsCalculationEngine = new StaffingNeedsCalculationEngine(new List<TimeBreakTemplateDTO>(), parameterObject);
            TermGroup_StaffingNeedHeadsFilterType filterType = type == SoeStaffingNeedType.Employee ? TermGroup_StaffingNeedHeadsFilterType.ActualNeed : TermGroup_StaffingNeedHeadsFilterType.BaseNeed;

            //Interval
            int intervalMinutes = GetStaffingNeedsIntervalMinutes(actorCompanyId);

            //TimeScheduleTemplateHead
            List<TimeScheduleTemplateHead> templateHeads = GetTimeScheduleTemplateHeads(actorCompanyId, true, false, type);

            //ShiftType
            List<ShiftTypeDTO> shiftTypes = base.GetShiftTypesFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId), loadSkills: true).ToDTOs().ToList();
            bool hasShiftTypes = shiftTypeIds != null && shiftTypeIds.Count > 0;
            bool loadShiftType = !previewByDate;

            //TimeScheduleTask
            List<TimeScheduleTask> timeScheduleTasks = base.GetTimeScheduleTasksFromCache(entitiesReadOnly, actorCompanyId, dateFrom, dateTo);
            timeScheduleTasks = timeScheduleTasks.Where(i => i.RecurringDates != null && i.RecurringDates.HasRecurringDates()).ToList();
            LoadAndConnectBlockTasksToTimeScheduleTasks(timeScheduleTasks, dateFrom, dateTo);
            List<TimeScheduleTaskDTO> tasks = timeScheduleTasks.ToDTOs(false).ToList();
            List<TimeScheduleTask> timeScheduleTasksFrequency = timeScheduleTasks.Where(i => i.IsStaffingNeedsFrequency).ToList();

            //IncomingDeliveryHead
            List<IncomingDeliveryHead> incomingDeliveryHeads = base.GetIncomingDeliveryHeadsFromCache(entitiesReadOnly, actorCompanyId, dateFrom, dateTo);
            incomingDeliveryHeads = incomingDeliveryHeads.Where(i => i.RecurringDates != null && i.RecurringDates.HasRecurringDates()).ToList();
            LoadAndConnectBlockTasksToIncomingDeliveryRows(incomingDeliveryHeads, dateFrom, dateTo);
            List<IncomingDeliveryHeadDTO> deliveries = incomingDeliveryHeads.ToDTOs(true, false).ToList();

            //StaffingNeedsHead
            List<StaffingNeedsHead> staffingNeedsHeadsCharts = timeScheduleTasksFrequency.Count > 0 ? GetStaffingNeedsHeads(actorCompanyId, StaffingNeedsHeadType.NeedsPlanning) : new List<StaffingNeedsHead>();

            if (useAccountHierarchy)
            {
                List<int> accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entitiesReadOnly, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);
                if (!accountIds.IsNullOrEmpty())
                    staffingNeedsHeadsCharts = staffingNeedsHeadsCharts.Where(sn => sn.AccountId.HasValue && accountIds.Contains(sn.AccountId.Value)).ToList();
                else
                    staffingNeedsHeadsCharts = new List<StaffingNeedsHead>();
            }

            List<DateTime> dates = CalendarUtility.GetDates(dateFrom, dateTo);
            List<int> taskIds = timeScheduleTasks.Where(i => dates.Any(a => i.RecurringDates.DoRecurOnDate(a))).Select(s => s.TimeScheduleTaskId).Distinct().ToList();
            Dictionary<int?, List<TimeScheduleTemplateBlockTask>> blockTasks;
            if (type != SoeStaffingNeedType.Employee)
                blockTasks = entitiesReadOnly.TimeScheduleTemplateBlockTask.Include("TimeScheduleTemplateBlock").Where(w => w.State == (int)SoeEntityState.Active && w.TimeScheduleTemplateBlock.State == (int)SoeEntityState.Active && w.TimeScheduleTaskId.HasValue && taskIds.Contains(w.TimeScheduleTaskId.Value)).ToList().GroupBy(g => g.TimeScheduleTaskId).ToDictionary(k => k.Key, v => v.ToList()); //NOSONAR
            else
                blockTasks = timeScheduleTasks.Where(w => w.ConnectedTimeScheduleTemplateBlockTasks != null).SelectMany(sm => sm.ConnectedTimeScheduleTemplateBlockTasks).Where(w => w.State == (int)SoeEntityState.Active && w.TimeScheduleTemplateBlock.State == (int)SoeEntityState.Active && w.TimeScheduleTaskId.HasValue && taskIds.Contains(w.TimeScheduleTaskId.Value) && w.TimeScheduleTemplateBlock.Date.HasValue && w.TimeScheduleTemplateBlock.EmployeeId.HasValue && w.TimeScheduleTemplateBlock.Date >= dateFrom && w.TimeScheduleTemplateBlock.Date <= dateTo).GroupBy(g => g.TimeScheduleTaskId).ToDictionary(k => k.Key, v => v.ToList()); //NOSONAR

            List<int> rowIds = incomingDeliveryHeads.Where(i => dates.Any(a => i.RecurringDates.DoRecurOnDate(a))).SelectMany(s => s.IncomingDeliveryRow.Select(ss => ss.IncomingDeliveryRowId)).Distinct().ToList();
            Dictionary<int?, List<TimeScheduleTemplateBlockTask>> blockRows;
            if (type != SoeStaffingNeedType.Employee)
                blockRows = entitiesReadOnly.TimeScheduleTemplateBlockTask.Include("TimeScheduleTemplateBlock").Where(w => w.State == (int)SoeEntityState.Active && w.TimeScheduleTemplateBlock.State == (int)SoeEntityState.Active && w.IncomingDeliveryRowId.HasValue && rowIds.Contains(w.IncomingDeliveryRowId.Value)).ToList().GroupBy(g => g.IncomingDeliveryRowId).ToDictionary(k => k.Key, v => v.ToList()); //NOSONAR
            else
                blockRows = incomingDeliveryHeads.SelectMany(sm => sm.IncomingDeliveryRow.Where(w => w.ConnectedTimeScheduleTemplateBlockTasks != null).SelectMany(s => s.ConnectedTimeScheduleTemplateBlockTasks)).Where(w => w.State == (int)SoeEntityState.Active && w.TimeScheduleTemplateBlock.State == (int)SoeEntityState.Active && w.IncomingDeliveryRowId.HasValue && rowIds.Contains(w.IncomingDeliveryRowId.Value) && w.TimeScheduleTemplateBlock.Date.HasValue && w.TimeScheduleTemplateBlock.EmployeeId.HasValue && w.TimeScheduleTemplateBlock.Date >= dateFrom && w.TimeScheduleTemplateBlock.Date <= dateTo).GroupBy(g => g.IncomingDeliveryRowId).ToDictionary(k => k.Key, v => v.ToList()); //NOSONAR

            DateTime currentDate = dateFrom;
            while (currentDate <= dateTo)
            {
                #region TimeScheduleTask

                List<TimeScheduleTask> timeScheduleTasksForDay = timeScheduleTasks.Where(i => i.RecurringDates.DoRecurOnDate(currentDate)).ToList();

                foreach (TimeScheduleTask timeScheduleTask in timeScheduleTasksForDay.Where(i => i.State == (int)SoeEntityState.Active))
                {
                    if (timeScheduleTask.IsStaffingNeedsFrequency)
                        continue;
                    if (hasShiftTypes && (!timeScheduleTask.ShiftTypeId.HasValue || !shiftTypeIds.Contains(timeScheduleTask.ShiftTypeId.Value)))
                        continue;
                    List<TimeScheduleTemplateBlockTask> scheduleBlockTasks = new List<TimeScheduleTemplateBlockTask>();
                    if (blockTasks.TryGetValue(timeScheduleTask.TimeScheduleTaskId, out List<TimeScheduleTemplateBlockTask> blockTasksOnTask))
                        scheduleBlockTasks = blockTasksOnTask.GetScheduledBlockTasks(currentDate, type, templateHeads);

                    List<StaffingNeedsTaskDTO> remainingTasks = scheduleBlockTasks.GetRemainingBlockTasks(timeScheduleTask, currentDate, type, loadShiftType);
                    if (remainingTasks != null && remainingTasks.Count > 0)
                    {
                        allRemainingTasks.AddRange(remainingTasks);
                        if (previewByDate)
                            break; //break to next day
                    }

                }

                #endregion

                #region IncomingDeliveryHead

                List<IncomingDeliveryHead> incomingDeliveryHeadsForDay = incomingDeliveryHeads.Where(i => i.RecurringDates.DoRecurOnDate(currentDate)).ToList();

                foreach (IncomingDeliveryHead incomingDeliveryHead in incomingDeliveryHeadsForDay)
                {
                    foreach (IncomingDeliveryRow incomingDeliveryRow in incomingDeliveryHead.IncomingDeliveryRow.Where(i => i.State == (int)SoeEntityState.Active))
                    {
                        if (hasShiftTypes && (!incomingDeliveryRow.ShiftTypeId.HasValue || !shiftTypeIds.Contains(incomingDeliveryRow.ShiftTypeId.Value)))
                            continue;
                        List<TimeScheduleTemplateBlockTask> scheduleBlockTasks = new List<TimeScheduleTemplateBlockTask>();
                        if (blockRows.TryGetValue(incomingDeliveryRow.IncomingDeliveryRowId, out List<TimeScheduleTemplateBlockTask> blockRowsOnTask))
                            scheduleBlockTasks = blockRowsOnTask.GetScheduledBlockTasks(currentDate, type, templateHeads);

                        List<StaffingNeedsTaskDTO> remainingTasks = scheduleBlockTasks.GetRemainingBlockTasks(incomingDeliveryRow, currentDate, type, loadShiftType);
                        if (remainingTasks != null && remainingTasks.Count > 0)
                        {
                            allRemainingTasks.AddRange(remainingTasks);
                            if (previewByDate)
                                break; //break to next day
                        }
                    }
                }

                #endregion

                #region TimeScheduleStaffingNeed

                if (timeScheduleTasksFrequency.Count > 0)
                {
                    List<StaffingNeedsHead> staffingNeedsHeadsChartForDate = type == SoeStaffingNeedType.Employee ? staffingNeedsHeadsCharts.GetStaffingNeedsHeadsForDate(currentDate) : null;
                    List<StaffingNeedsHead> staffingNeedsHeadsChartForDayOfWeek = staffingNeedsHeadsCharts.GetStaffingNeedsHeadsForDayOfWeek(currentDate, staffingNeedsHeadsChartForDate);
                    if (staffingNeedsHeadsChartForDate != null || staffingNeedsHeadsChartForDayOfWeek != null)
                    {
                        //Need from frequency
                        List<StaffingNeedsRowDTO> chartRows = new List<StaffingNeedsRowDTO>();
                        if (staffingNeedsHeadsChartForDate != null)
                        {
                            foreach (var item in staffingNeedsHeadsChartForDate)
                                chartRows.AddRange(item.ToDTO(true, true, true, true).GetValidRows(filterType, tasks, deliveries, currentDate, true));
                        }
                        if (staffingNeedsHeadsChartForDayOfWeek != null)
                        {
                            foreach (var item in staffingNeedsHeadsChartForDayOfWeek)
                                chartRows.AddRange(item.ToDTO(true, true, true, true).GetValidRows(filterType, tasks, deliveries, currentDate, true));
                        }
                        List<StaffingNeedsRowDTO> chartRowsMerged = staffingNeedsCalculationEngine.MergeShiftFromChartData(timeScheduleTasksFrequency, chartRows, shiftTypes, tasks, currentDate);

                        //Filled need
                        foreach (TimeScheduleTask timeScheduleTask in timeScheduleTasksFrequency)
                        {
                            if (hasShiftTypes && (!timeScheduleTask.ShiftTypeId.HasValue || !shiftTypeIds.Contains(timeScheduleTask.ShiftTypeId.Value)))
                                continue;

                            List<TimeScheduleTemplateBlockTask> scheduleBlockTasks;
                            if (timeScheduleTask.ConnectedTimeScheduleTemplateBlockTasks != null)
                                scheduleBlockTasks = timeScheduleTask.ConnectedTimeScheduleTemplateBlockTasks.GetScheduledBlockTasks(currentDate, type, templateHeads);
                            else
                            {
                                if (!timeScheduleTask.TimeScheduleTemplateBlockTask.IsLoaded)
                                    timeScheduleTask.TimeScheduleTemplateBlockTask.Load();
                                scheduleBlockTasks = timeScheduleTask.TimeScheduleTemplateBlockTask.GetScheduledBlockTasks(currentDate, type, templateHeads);
                            }
                            List<StaffingNeedsRowPeriodDTO> chartPeriods = chartRowsMerged.GetPeriods(timeScheduleTask.TimeScheduleTaskId);

                            //Remaining need
                            List<StaffingNeedsTaskDTO> remainingTasks = scheduleBlockTasks.GetRemainingBlockTasks(timeScheduleTask, chartPeriods, currentDate, type, loadShiftType, intervalMinutes);
                            if (remainingTasks != null && remainingTasks.Count > 0)
                            {
                                allRemainingTasks.AddRange(remainingTasks);
                                if (previewByDate)
                                    break; //break to next day
                            }
                        }
                    }
                }

                #endregion

                currentDate = currentDate.AddDays(1);
            }

            return allRemainingTasks;
        }

        public List<DateTime> GetUnscheduledStaffingNeedsTaskDates(int actorCompanyId, List<int> shiftTypeIds, DateTime dateFrom, DateTime dateTo, SoeStaffingNeedType type, bool getPreviewDistinct = false)
        {

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<TimeScheduleTask> timeScheduleTasks = base.GetTimeScheduleTasksFromCache(entitiesReadOnly, actorCompanyId, dateFrom, dateTo);
            List<IncomingDeliveryHead> incomingDeliveryHeads = base.GetIncomingDeliveryHeadsFromCache(entitiesReadOnly, actorCompanyId, dateFrom, dateTo);

            if (!shiftTypeIds.IsNullOrEmpty())
            {
                timeScheduleTasks = timeScheduleTasks.Where(i => i.ShiftTypeId.HasValue && shiftTypeIds.Contains(i.ShiftTypeId.Value)).ToList();
                incomingDeliveryHeads = incomingDeliveryHeads.Where(i => i.IncomingDeliveryRow != null && i.IncomingDeliveryRow.Any(a => a.ShiftTypeId.HasValue && shiftTypeIds.Contains(a.ShiftTypeId.Value))).ToList();
            }

            if (timeScheduleTasks.Any() || incomingDeliveryHeads.Any())
            {
                List<DateTime> dates = new List<DateTime>();

                foreach (var task in timeScheduleTasks)
                {
                    if (task.RecurringDates?.RecurrenceDates != null)
                        dates.AddRange(task.RecurringDates.RecurrenceDates);
                }

                foreach (var row in incomingDeliveryHeads)
                {
                    if (row.RecurringDates?.RecurrenceDates != null)
                        dates.AddRange(row.RecurringDates.RecurrenceDates);
                }

                return dates.Distinct().ToList();
            }

            return new List<DateTime>();
        }

        #region StaffingNeedsFrequency

        public List<StaffingNeedsFrequency> GetStaffingNeedsFrequencys(int actorCompanyId, DateTime timeFrom, DateTime timeTo, List<StaffingNeedsFrequency> staffingNeedsFrequency = null, bool removeDuplicates = true, List<int> validAccountIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsFrequency.NoTracking();
            return GetStaffingNeedsFrequencys(entities, actorCompanyId, timeFrom, timeTo, staffingNeedsFrequency, removeDuplicates, validAccountIds);
        }

        public List<StaffingNeedsFrequency> GetStaffingNeedsFrequencys(CompEntities entities, int actorCompanyId, DateTime timeFrom, DateTime timeTo, List<StaffingNeedsFrequency> staffingNeedsFrequency = null, bool removeDuplicates = true, List<int> validAccountIds = null)
        {
            List<StaffingNeedsFrequency> frequencys = null;
            if (staffingNeedsFrequency == null)
            {
                var query = (from s in entities.StaffingNeedsFrequency
                             where s.ActorCompanyId == actorCompanyId &&
                             s.TimeFrom >= timeFrom && s.TimeTo <= timeTo
                             orderby s.TimeFrom, s.TimeTo
                             select s);

                if (!validAccountIds.IsNullOrEmpty())
                    frequencys = query.Where(w => w.ParentAccountId.HasValue && validAccountIds.Contains(w.ParentAccountId.Value)).ToList();
                else
                    frequencys = query.ToList();
            }
            else
            {
                frequencys = (from s in staffingNeedsFrequency
                              where s.ActorCompanyId == actorCompanyId &&
                              s.TimeFrom >= timeFrom && s.TimeTo <= timeTo
                              orderby s.TimeFrom, s.TimeTo
                              select s).ToList();

                if (!validAccountIds.IsNullOrEmpty())
                    frequencys = frequencys.Where(w => w.ParentAccountId.HasValue && validAccountIds.Contains(w.ParentAccountId.Value)).ToList();
            }

            if (removeDuplicates)
            {
                var filteredFrequencys = new List<StaffingNeedsFrequency>();

                foreach (var frequencysGroupedByTime in frequencys.GroupBy(i => i.CompareKey)) //only use latest
                {
                    StaffingNeedsFrequency latestFrequency = frequencysGroupedByTime.OrderByDescending(o => o.StaffingNeedsFrequencyId).FirstOrDefault();
                    if (latestFrequency != null)
                        filteredFrequencys.Add(latestFrequency);
                }

                return filteredFrequencys;
            }

            return frequencys;
        }

        public StaffingNeedsFrequency GetStaffingNeedsFrequency(CompEntities entities, int actorCompanyId, int staffingNeedsFrequencyId)
        {
            return (from s in entities.StaffingNeedsFrequency
                    where s.ActorCompanyId == actorCompanyId &&
                    s.StaffingNeedsFrequencyId == staffingNeedsFrequencyId
                    select s).FirstOrDefault();
        }

        #endregion

        #region StaffingNeedsHead

        public List<StaffingNeedsHead> GetStaffingNeedsHeadsForUser(int actorCompanyId, bool loadRows, bool loadPeriods, bool loadRowFrequencys = false, StaffingNeedsHeadType? type = null, TermGroup_StaffingNeedsHeadStatus? status = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsHead.NoTracking();
            return GetStaffingNeedsHeadsForUser(entities, actorCompanyId, loadRows, loadPeriods, loadRowFrequencys, type, status);
        }

        public List<StaffingNeedsHead> GetStaffingNeedsHeadsForUser(CompEntities entities, int actorCompanyId, bool loadRows, bool loadPeriods, bool loadRowFrequencys = false, StaffingNeedsHeadType? type = null, TermGroup_StaffingNeedsHeadStatus? status = null)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            var query = (from sn in entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser")
                         where sn.ActorCompanyId == actorCompanyId &&
                         sn.State == (int)SoeEntityState.Active
                         select sn);

            if (loadRows)
                query = query.Include("StaffingNeedsRow.ShiftType");
            if (loadPeriods)
                query = query.Include("StaffingNeedsRow.StaffingNeedsRowPeriod.ShiftType");
            if (loadRowFrequencys)
                query = query.Include("StaffingNeedsRow.StaffingNeedsRowFrequency.ShiftType");

            if (type.HasValue)
                query = query.Where(sn => sn.Type == (int)type);

            if (status.HasValue)
                query = query.Where(sn => sn.Status == (int)status);

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(sn => !sn.AccountId.HasValue || accountIds.Contains(sn.AccountId.Value));
                else
                    query = query.Where(sn => !sn.AccountId.HasValue);
            }

            return query.OrderBy(sn => sn.Name).ToList();
        }

        public List<StaffingNeedsHead> GetStaffingNeedsHeads(int actorCompanyId, StaffingNeedsHeadType? type = null, TermGroup_StaffingNeedsHeadStatus? status = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsHead.NoTracking();
            return GetStaffingNeedsHeads(entities, actorCompanyId, type, status);
        }

        public List<StaffingNeedsHead> GetStaffingNeedsHeads(CompEntities entities, int actorCompanyId, StaffingNeedsHeadType? type = null, TermGroup_StaffingNeedsHeadStatus? status = null)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            var query = (from sn in entities.StaffingNeedsHead
                         .Include("StaffingNeedsRow.StaffingNeedsRowPeriod.ShiftType")
                         where sn.ActorCompanyId == actorCompanyId &&
                         sn.State == (int)SoeEntityState.Active
                         select sn);

            if (type.HasValue)
                query = query.Where(sn => sn.Type == (int)type);

            if (status.HasValue)
                query = query.Where(sn => sn.Status == (int)status);

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(sn => !sn.AccountId.HasValue || accountIds.Contains(sn.AccountId.Value));
                else
                    query = query.Where(sn => !sn.AccountId.HasValue);
            }

            return query.OrderBy(sn => sn.Name).ToList();
        }

        public class StaffingStatisticsGroupItem
        {
            public StaffingStatisticsGroupItem()
            {
                StaffingStatisticsRows = new List<StaffingStatisticsRow>();
                StaffingStatisticsRowsDict = new Dictionary<string, StaffingStatisticsRow>();
            }
            public List<StaffingStatisticsRow> StaffingStatisticsRows { get; set; }

            public Dictionary<string, StaffingStatisticsRow> StaffingStatisticsRowsDict { get; set; }
            public Dictionary<int, List<TimePayrollTransactionDTO>> EmployeeTimePayrollTransactionDict { get; set; }
        }

        public class StaffingStatisticsRow
        {
            public StaffingStatisticsRow()
            {
                TransactionsDict = new Dictionary<int, List<TimePayrollTransactionDTO>>();
                TimeScheduleBlocksDict = new Dictionary<int, List<TimeScheduleTemplateBlock>>();
                Templates = new Dictionary<int, List<TimeSchedulePlanningDayDTO>>();
                StaffingNeedsFrequencies = new List<StaffingNeedsFrequencyDTO>();
                TimeStampEntries = new List<TimeStampEntryDTO>();
            }
            public string Key { get; set; }
            public Dictionary<int, List<TimePayrollTransactionDTO>> TransactionsDict { get; set; }
            public Dictionary<int, List<TimeScheduleTemplateBlock>> TimeScheduleBlocksDict { get; set; }
            public Dictionary<int, List<TimeSchedulePlanningDayDTO>> Templates { get; set; }
            public List<StaffingNeedsFrequencyDTO> StaffingNeedsFrequencies { get; set; }
            public List<StaffingNeedsFrequencyDTO> LastYearStaffingNeedsFrequencies { get; set; }
            public StaffingStatisticsGroup StaffingStatisticsGroup { get; set; }
            public List<TimeStampEntryDTO> TimeStampEntries { get; set; }

            public bool HasData
            {
                get
                {
                    return TransactionsDict.Any() || TimeScheduleBlocksDict.Any() || Templates.Any() || StaffingNeedsFrequencies.Any() || TimeStampEntries.Any();
                }
            }

            public Dictionary<int, List<TimePayrollTransactionDTO>> AllTransactionsDict { get; internal set; }
            public Dictionary<int, List<TimePayrollTransactionDTO>> FakedAllTransactionsDict { get; internal set; }
        }

        public StaffingStatisticsGroupItem GetStaffingStatisticsGroupItem(List<StaffingStatisticsGroup> staffingStatisticsGroups, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, bool loadSchedule, bool loadTemplateSchedule, bool loadStaffingNeedFrequencys, bool loadTransactions, List<AccountDTO> accounts = null, List<PayrollProductSettingDTO> payrollProductSettings = null, List<int> shiftTypeIds = null, List<Employee> employees = null, string cacheKey = null, bool loadLastYearStaffingNeedFrequencys = false, bool loadTimeStampEntries = false, bool addEmptyAccounts = false, bool allAccountsMustbeOnEntity = false)
        {
            bool usePayroll = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UsePayroll, 0, base.ActorCompanyId, 0);

            DateTime selectionDateFrom = dateFrom;
            DateTime selectionDateTo = dateTo;

            if (usePayroll)
            {
                selectionDateFrom = CalendarUtility.GetBeginningOfMonth(selectionDateFrom);
                selectionDateTo = CalendarUtility.GetEndOfMonth(selectionDateTo);
            }

            int intervalMinutes = GetStaffingNeedsIntervalMinutes(base.ActorCompanyId);
            var allTransactions = loadTransactions ? TimeTransactionManager.GetTimePayrollTransactionDTOForReport(selectionDateFrom, selectionDateTo, employeeIds, base.ActorCompanyId) : new Dictionary<int, List<TimePayrollTransactionDTO>>();
            var allUntouchedTransactions = allTransactions.ToDictionary(k => k.Key, v => v.Value.ToList());
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var scheduleAbsenceTransactions = loadTransactions && base.UsePayroll(entitiesReadOnly, base.ActorCompanyId) ? TimeTransactionManager.GetTimePayrollScheduleTransactionDTOForReport(selectionDateFrom, selectionDateTo, employeeIds, base.ActorCompanyId) : new Dictionary<int, List<TimePayrollTransactionDTO>>();
            var timeStampDTOs = loadTimeStampEntries ? TimeStampManager.GetTimeStampEntriesDTO(selectionDateFrom, selectionDateTo, employees, base.ActorCompanyId) : new List<TimeStampEntryDTO>();

            Dictionary<int, List<TimePayrollTransactionDTO>> allTransactionsClones = new Dictionary<int, List<TimePayrollTransactionDTO>>();

            if (scheduleAbsenceTransactions.Any())
            {
                foreach (var transItem in scheduleAbsenceTransactions.Where(w => !w.Value.IsNullOrEmpty()))
                {
                    //add to allTransactions
                    if (allTransactions.ContainsKey(transItem.Key))
                    {
                        allTransactions[transItem.Key] = allTransactions[transItem.Key].Union(transItem.Value).ToList();
                    }
                    else
                        allTransactions.Add(transItem.Key, transItem.Value);
                }
            }

            foreach (var transItem in allTransactions.Where(w => !w.Value.IsNullOrEmpty()))
                allTransactionsClones.Add(transItem.Key, transItem.Value);

            if (employeeIds.Count > 100)
                LogCollector.LogInfo($"GetStaffingStatisticsGroupItem allTransactions done count {allTransactions.Count} ActorCompanyId {base.ActorCompanyId}");

            var allScheduleBlocks = loadSchedule ? GetTimeScheduleTemplateBlocksForAccounts(employeeIds, selectionDateFrom, selectionDateTo, null, null) : new List<TimeScheduleTemplateBlock>();
            var fakedTransactionsBasedOnTimeStamp = new List<TimePayrollTransactionDTO>();
            bool hasFakedTransactions = false;

            if (!timeStampDTOs.IsNullOrEmpty() && !allScheduleBlocks.IsNullOrEmpty())
            {
                var standardTimeDeviationCause = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeDefaultTimeDeviationCause, 0, base.ActorCompanyId, 0);
                List<TimeStampEntryDTO> addTimeStampEntries = new List<TimeStampEntryDTO>();
                foreach (var timeStampEmployeeGroup in timeStampDTOs.GroupBy(g => g.EmployeeId))
                {
                    var schedulesOnEmployee = allScheduleBlocks.Where(w => w.EmployeeId == timeStampEmployeeGroup.Key).ToList();

                    if (schedulesOnEmployee.IsNullOrEmpty())
                        continue;

                    foreach (var timeStamp in timeStampEmployeeGroup.GroupBy(g => (g.DateFromTimeBlockDate ?? g.Date.Date)))
                    {
                        var schedulesOnDate = schedulesOnEmployee.Where(w => !w.IsBreak && w.Date == timeStamp.Key && w.Date.HasValue).ToList();

                        if (schedulesOnDate.IsNullOrEmpty())
                            continue;

                        foreach (var timeStampEntry in timeStamp)
                        {
                            var matchingSchedule = schedulesOnDate.Where(w => w.ActualStartTime.HasValue && w.ActualStopTime.HasValue && timeStampEntry.Time >= w.ActualStartTime.Value && timeStampEntry.Time <= w.ActualStopTime.Value).FirstOrDefault();

                            if (matchingSchedule == null)
                            {
                                matchingSchedule = schedulesOnDate
                                    .Where(w => w.ActualStartTime.HasValue && w.ActualStopTime.HasValue)
                                    .OrderBy(w => Math.Min(
                                        Math.Abs((timeStampEntry.Time - w.ActualStartTime.Value).TotalSeconds),
                                        Math.Abs((timeStampEntry.Time - w.ActualStopTime.Value).TotalSeconds)
                                    ))
                                    .FirstOrDefault();
                            }

                            if (matchingSchedule == null)
                            {
                                matchingSchedule = schedulesOnEmployee
                                    .Where(w => w.ActualStartTime.HasValue && w.ActualStopTime.HasValue)
                                    .OrderBy(w => Math.Min(
                                        Math.Abs((timeStampEntry.Time - w.ActualStartTime.Value).TotalSeconds),
                                        Math.Abs((timeStampEntry.Time - w.ActualStopTime.Value).TotalSeconds)
                                    ))
                                    .FirstOrDefault();
                            }

                            if (matchingSchedule != null)
                            {
                                var accountIdsOnBlock = matchingSchedule.GetAccountIdsIncludingAccountIdOnBlock();

                                if (accountIdsOnBlock.IsNullOrEmpty())
                                    continue;

                                if (timeStampEntry.AccountId.HasValue)
                                {
                                    accountIdsOnBlock = accountIdsOnBlock.Where(w => w != timeStampEntry.AccountId.Value).ToList();
                                }

                                if (accountIdsOnBlock.IsNullOrEmpty())
                                    continue;

                                if (timeStampEntry.Extended == null)
                                    timeStampEntry.Extended = new List<TimeStampEntryExtendedDTO>();

                                var ext = timeStampEntry.Extended.Where(w => w.AccountId.HasValue).ToList();

                                var existingAccountsOnExtended = accounts.Where(w => ext.Select(s => s.AccountId.Value).Contains(w.AccountId)).ToList();
                                existingAccountsOnExtended.AddRange(accounts.Where(w => timeStampEntry.AccountId.HasValue && w.AccountId == timeStampEntry.AccountId.Value));

                                foreach (var accountId in accountIdsOnBlock)
                                {
                                    var extended = timeStampEntry.Extended.FirstOrDefault(f => f.AccountId == accountId);

                                    if (extended != null)
                                        continue;

                                    var account = accounts.FirstOrDefault(f => f.AccountId == accountId);

                                    if (account != null)
                                    {
                                        if (existingAccountsOnExtended.Any(a => a.AccountDimId == account.AccountDimId))
                                            continue;

                                        timeStampEntry.Extended.Add(new TimeStampEntryExtendedDTO
                                        {
                                            AccountId = accountId,
                                        });
                                        existingAccountsOnExtended.Add(account);
                                    }
                                }

                                if (standardTimeDeviationCause != 0 && timeStampEntry.Time < matchingSchedule.ActualStartTime && matchingSchedule == schedulesOnDate.OrderBy(o => o.StartTime).FirstOrDefault())
                                {
                                    if (standardTimeDeviationCause != 0 && timeStampEntry.TimeDeviationCauseId.HasValue && timeStampEntry.TimeDeviationCauseId != standardTimeDeviationCause)
                                        timeStampEntry.ScheduleStartTime = matchingSchedule.ActualStartTime;
                                    else
                                        timeStampEntry.Time = matchingSchedule.ActualStartTime.Value;
                                }

                                if (!timeStampEntry.AccountId.HasValue && timeStampEntry.Extended.Any())
                                {
                                    var firstExtended = timeStampEntry.Extended.FirstOrDefault(f => f.AccountId.HasValue);

                                    if (firstExtended != null)
                                    {
                                        timeStampEntry.AccountId = firstExtended.AccountId;
                                        timeStampEntry.Extended.Remove(firstExtended);
                                    }
                                }
                            }
                        }
                    }
                }



                if (!timeStampDTOs.IsNullOrEmpty())
                {

                    foreach (var employeeTimeStampsOnEmployee in timeStampDTOs.Where(w => w.Time > DateTime.Today.AddDays(-1) && w.Time < DateTime.Today.AddDays(1)).GroupBy(g => g.EmployeeId))
                    {

                        List<TimeStampEntryDTO> allTimeStampsOnEmployee = employeeTimeStampsOnEmployee.ToList();
                        foreach (var employeeTimeStamps in employeeTimeStampsOnEmployee.GroupBy(g => g.DateFromTimeBlockDate ?? DateTime.Today))
                        {
                            foreach (var timeStampBeforeScheduleStart in employeeTimeStamps.Where(w => w.ScheduleStartTime.HasValue))
                            {
                                if (timeStampBeforeScheduleStart.Type == TimeStampEntryType.Out)
                                    continue;

                                var next = employeeTimeStamps.OrderBy(o => o.Sort).FirstOrDefault(f => f.Time > timeStampBeforeScheduleStart.Time);

                                if (next != null && next.Type == TimeStampEntryType.Out)
                                    continue;

                                DateTime newTime;
                                if (next?.Time != null && next.Time < timeStampBeforeScheduleStart.ScheduleStartTime)
                                    newTime = next.Time;
                                else
                                    newTime = timeStampBeforeScheduleStart.ScheduleStartTime.Value;

                                var clone = timeStampBeforeScheduleStart.CloneDTO();
                                clone.Time = newTime;
                                var outClone = timeStampBeforeScheduleStart.CloneDTO();
                                outClone.Time = newTime;
                                outClone.Type = TimeStampEntryType.Out;
                                if (!employeeTimeStamps.Any(a => a.Time == newTime))
                                    allTimeStampsOnEmployee.Add(outClone);
                                allTimeStampsOnEmployee.Add(clone);
                            }
                        }

                        foreach (var employeeTimeStamps in allTimeStampsOnEmployee.GroupBy(g => g.DateFromTimeBlockDate ?? DateTime.Today))
                        {
                            var sortedTimeStamps = employeeTimeStamps.OrderBy(o => o.Sort).ToList();

                            foreach (var timeStamp in sortedTimeStamps.Where(w => w.Type == TimeStampEntryType.In))
                            {
                                var nextTimeStamp = sortedTimeStamps.FirstOrDefault(f => f.Sort > timeStamp.Sort);

                                if (nextTimeStamp == null)
                                    nextTimeStamp = sortedTimeStamps.FirstOrDefault(f => f.Sort > timeStamp.Sort);

                                var accountIds = timeStamp.GetAccountIds();
                                var accountsFromAccountIds = accounts.Where(w => accountIds.Contains(w.AccountId)).ToList();
                                var accountInternalFromAccountIds = accountsFromAccountIds.Select(s => new AccountInternalDTO { AccountId = s.AccountId, Account = s, AccountDimId = s.AccountDimId, AccountDimNr = s.AccountDimNr, SysSieDimNr = s.AccountDimNr, AccountNr = s.AccountNr, Name = s.Name }).ToList();
                                var stopTime = (DateTime?)null;
                                if (nextTimeStamp == null)
                                    stopTime = CalendarUtility.ClearSeconds(DateTime.Now);
                                else
                                    stopTime = nextTimeStamp.Time;

                                if (stopTime > DateTime.Now)
                                    stopTime = CalendarUtility.ClearSeconds(DateTime.Now);

                                // Add faked transactions only when it overlaps with today
                                if (stopTime > timeStamp.Time && (timeStamp.Time.Date == DateTime.Today || stopTime.Value.Date == DateTime.Today.Date))
                                    fakedTransactionsBasedOnTimeStamp.Add(new TimePayrollTransactionDTO()
                                    {
                                        AccountInternals = accountInternalFromAccountIds,
                                        StartTime = timeStamp.Time,
                                        StopTime = stopTime,
                                        EmployeeId = timeStamp.EmployeeId,
                                        Date = timeStamp.DateFromTimeBlockDate
                                    });
                            }
                            hasFakedTransactions = true;
                        }
                    }
                }
            }


            if (employeeIds.Count > 100)
                LogCollector.LogInfo($"GetStaffingStatisticsGroupItem allScheduleBlocks done count {allScheduleBlocks.Count} ActorCompanyId {base.ActorCompanyId}");

            var staffingNeedsFrequencies = loadStaffingNeedFrequencys ? base.GetStaffingNeedsFrequencyFromCache(entitiesReadOnly, base.ActorCompanyId, dateFrom, dateTo).ToDTOs(false).ToList() : new List<StaffingNeedsFrequencyDTO>();
            var lastYearStaffingNeedFrequencys = loadLastYearStaffingNeedFrequencys ? base.GetStaffingNeedsFrequencyFromCache(entitiesReadOnly, base.ActorCompanyId, dateFrom.AddYears(-1), dateTo.AddYears(-1)).ToDTOs(false).ToList() : new List<StaffingNeedsFrequencyDTO>();

            var templates = loadTemplateSchedule ? GetTimeSchedulePlanningDaysFromTemplate(base.ActorCompanyId, base.RoleId, base.UserId, dateFrom, dateTo, null, employeeIds, loadAccounts: true, loadTimeDeviationCause: false, loadEmployees: false, loadStaffingNeeds: false, employees: employees) : new List<TimeSchedulePlanningDayDTO>();
            var item = new StaffingStatisticsGroupItem();
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var accountDims = base.GetAccountDimsFromCache(entities, CacheConfig.Company(base.ActorCompanyId));
            int iteration = 0;
            var hinput = AccountHierarchyInput.GetInstance(AccountHierarchyParamType.IncludeVirtualParented);
            var accountInternals = allTransactions.SelectMany(sm => sm.Value).SelectMany(s => s.AccountInternals).ToList();
            var accountInternalIds = accountInternals.Select(s => s.AccountId).ToList();
            accountInternalIds.AddRange(allScheduleBlocks.SelectMany(sm => sm.GetAccountIdsIncludingAccountIdOnBlock()));
            var frequenyAccountIds = staffingNeedsFrequencies.Where(w => w.AccountId.HasValue).Select(s => s.AccountId.Value).Distinct().ToList();
            frequenyAccountIds.AddRange(staffingNeedsFrequencies.Where(w => w.ParentAccountId.HasValue).Select(s => s.ParentAccountId.Value).Distinct());
            frequenyAccountIds = frequenyAccountIds.Distinct().ToList();
            accountInternalIds.AddRange(frequenyAccountIds);
            accountInternalIds.AddRange(templates.Where(w => w.AccountIds != null).SelectMany(s => s.AccountIds).Distinct());
            var grouped = accountInternalIds.GroupBy(g => g).ToDictionary(f => f.Key, v => v.Count());
            var accountInternalsOnMainAccount = staffingStatisticsGroups.Select(s => s.AccountId);
            accountInternalIds = accountInternalIds.Distinct().Where(w => accountInternalsOnMainAccount.Contains(w)).ToList();
            var orderGroups = staffingStatisticsGroups.OrderByDescending(o => grouped.GetValue(o.AccountId)).ToList();
            var frequencyFilterAccounts = new List<AccountDTO>();
            var groupedallScheduleBlocks = allScheduleBlocks.GroupBy(g => g.GetAccountIdsIncludingAccountIdOnBlockString()).ToDictionary(k => k.Key, v => v.ToList());
            var groupedallTransactions = allTransactions.SelectMany(sm => sm.Value).GroupBy(g => g.GetAccountInternalIdsString()).ToDictionary(k => k.Key, v => v.ToList());


            foreach (var group in orderGroups)
            {
                iteration++;
                var mainAccount = accounts.FirstOrDefault(f => f.AccountId == group.AccountId);

                List<AccountDTO> filterAccounts = GetFilterAccountsForStaffingStatisticsGroup(mainAccount, shiftTypeIds, group.ConnectedAccountIds, accounts, addEmptyAccounts: false);

                if (group.AccountId < 0 && group.ConnectedAccountIds.IsNullOrEmpty() && orderGroups.Any(a => a.AccountId > 0))
                    continue;

                if (loadStaffingNeedFrequencys)
                {
                    var accountsOnFreqs = accounts.Where(w => frequenyAccountIds.Contains(w.AccountId)).ToList();
                    var accountDimIdsOnAccountsOnFreqs = accountsOnFreqs.Select(s => s.AccountDimId).Distinct().ToList();
                    var dimOnFreqs = accountDims.Where(w => accountDimIdsOnAccountsOnFreqs.Contains(w.AccountDimId)).ToList();
                    frequencyFilterAccounts = filterAccounts.ToList();
                    var accountsFromHierarchy = AccountManager.GetAccountsFromHierarchyById(base.ActorCompanyId, group.AccountId, hinput);
                    var topDim = accountDims.FirstOrDefault(f => frequencyFilterAccounts.Any(a => a.AccountDimId == f.AccountDimId));

                    foreach (var acc in accountsFromHierarchy.GroupBy(g => dimOnFreqs.FirstOrDefault(f => f.Level > topDim.Level && f.AccountDimId == g.AccountDimId)?.Level ?? 0))
                    {
                        if (acc.Key == 0)
                            continue;

                        if (!frequencyFilterAccounts.Any(a => a.AccountDimId == acc.First().AccountDimId))
                        {
                            frequencyFilterAccounts.AddRange(acc.ToList());
                        }
                    }
                }


                StaffingStatisticsInput input = new StaffingStatisticsInput(TermGroup_TimeSchedulePlanningFollowUpCalculationType.All, base.ActorCompanyId, dateFrom, dateTo, selectionDateFrom, selectionDateTo, intervalMinutes, group.AccountId, accounts, filterAccounts, frequencyFilterAccounts, false, false, false, false, false, calculateTemplate: true, calculateSchedule: true, calculateTime: true, addSummaryRow: false, calculateTemplateForEmployeePost: false);

                input.AllAccountsMustbeOnEntity = allAccountsMustbeOnEntity;

                var transactionsOnGroup = new List<TimePayrollTransactionDTO>();
                var schedulesOnGroup = new List<TimeScheduleTemplateBlock>();
                var frequencysOnGroup = new List<StaffingNeedsFrequencyDTO>();
                var lastYearFrequencysOnGroup = new List<StaffingNeedsFrequencyDTO>();
                var templatesOnGroup = new List<TimeSchedulePlanningDayDTO>();
                var timeStampEntriesOnGroup = new List<TimeStampEntryDTO>();
                var fakedTransactionsOnGroupsBasedOnTimeStampOnGroup = new List<TimePayrollTransactionDTO>();


                List<TimePayrollTransactionDTO> transactionDTOs = new List<TimePayrollTransactionDTO>();
                Parallel.Invoke(() =>
                    {
                        //Transactions
                        transactionDTOs = allTransactions.SelectMany(sm => sm.Value).ToList();
                        var filteredAllTransactions = new Dictionary<int, List<TimePayrollTransactionDTO>>();
                        var transOnGroup = input.FilterTransactionsByAccount(groupedallTransactions);
                        transOnGroup.ForEach(f => f.TempUsed = true);
                        transactionsOnGroup.AddRange(transOnGroup);
                    },
                    () =>
                    {
                        //Schedules
                        schedulesOnGroup = input.FilterTimeScheduleTemplateBlocksByAccount(groupedallScheduleBlocks);
                        schedulesOnGroup.Where(w => !w.IsBreak).ToList().ForEach(f => f.TempUsed = true);
                    },
                    () =>
                    {
                        //Templates
                        templatesOnGroup = input.FilterTemplateByAccount(templates);
                    },
                    () =>
                    {
                        //timeStampEntries
                        if (timeStampDTOs != null)
                            timeStampEntriesOnGroup = input.FilterTimeStampEntriesByAccount(timeStampDTOs);

                        if (hasFakedTransactions)
                            fakedTransactionsOnGroupsBasedOnTimeStampOnGroup = input.FilterTransactionsByAccount(fakedTransactionsBasedOnTimeStamp);
                    },
                    () =>
                    {
                        //frequencies
                        frequencysOnGroup = input.FilterFrequencyByAccount(staffingNeedsFrequencies);
                        frequencysOnGroup.ForEach(f => f.TempUsed = true);

                        if (!lastYearStaffingNeedFrequencys.IsNullOrEmpty())
                        {
                            lastYearFrequencysOnGroup = input.FilterFrequencyByAccount(lastYearStaffingNeedFrequencys);
                            lastYearFrequencysOnGroup.ForEach(f => f.TempUsed = true);
                        }
                    });

                if (iteration % 500 == 0 && employeeIds.Count > 300)
                    LogCollector.LogInfo($"GetStaffingStatisticsGroupItem loop interaction {iteration} ActorCompanyId {base.ActorCompanyId}");

                if (iteration % 10 == 0)
                {
                    Parallel.Invoke(() =>
                    {
                        foreach (var blocksOnEmployee in allScheduleBlocks.GroupBy(g => g.EmployeeId))
                        {
                            if (blocksOnEmployee.All(a => a.IsBreak))
                                blocksOnEmployee.ToList().ForEach(f => f.TempUsed = true);
                        }
                        ;
                        allScheduleBlocks = allScheduleBlocks.Where(w => !w.TempUsed).ToList();
                        groupedallScheduleBlocks = allScheduleBlocks.GroupBy(g => g.GetAccountIdsIncludingAccountIdOnBlockString()).ToDictionary(k => k.Key, v => v.ToList());
                    },
                    () =>
                    {
                        staffingNeedsFrequencies = staffingNeedsFrequencies.Where(w => !w.TempUsed).ToList();
                    },
                    () =>
                    {
                        allTransactions = transactionDTOs.Where(w => !w.TempUsed).GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList());
                        groupedallTransactions = allTransactions.SelectMany(sm => sm.Value).GroupBy(g => g.GetAccountInternalIdsString()).ToDictionary(k => k.Key, v => v.ToList());
                    });
                }
                else
                {
                    allTransactions = transactionDTOs.GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList());
                }

                StaffingStatisticsRow row = new StaffingStatisticsRow()
                {
                    Key = group.Group,
                    TransactionsDict = transactionsOnGroup.GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList()),
                    AllTransactionsDict = allTransactionsClones,
                    TimeScheduleBlocksDict = schedulesOnGroup.GroupBy(g => g.EmployeeId.Value).ToDictionary(k => k.Key, v => v.ToList()),
                    Templates = templatesOnGroup.GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList()),
                    StaffingNeedsFrequencies = frequencysOnGroup,
                    LastYearStaffingNeedsFrequencies = lastYearFrequencysOnGroup,
                    StaffingStatisticsGroup = group,
                    TimeStampEntries = timeStampEntriesOnGroup ?? new List<TimeStampEntryDTO>(),
                    FakedAllTransactionsDict = fakedTransactionsOnGroupsBasedOnTimeStampOnGroup?.GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList()) ?? new Dictionary<int, List<TimePayrollTransactionDTO>>()
                };

                item.StaffingStatisticsRows.Add(row);
            }

            foreach (var row in item.StaffingStatisticsRows)
            {
                foreach (var dic in row.TransactionsDict)
                {
                    foreach (var trans in dic.Value)
                    {
                        trans.TempUsed = false;
                    }
                }
                foreach (var dic in row.TimeScheduleBlocksDict)
                {
                    foreach (var block in dic.Value)
                    {
                        block.TempUsed = false;
                    }
                }
            }
            item.EmployeeTimePayrollTransactionDict = allUntouchedTransactions;
            item.StaffingStatisticsRowsDict = item.StaffingStatisticsRows.GroupBy(g => g.Key).ToDictionary(k => k.Key, v => v.First());
            return item;
        }

        public List<AccountDTO> GetFilterAccountsForStaffingStatisticsGroup(AccountDTO mainAccount, List<int> shiftTypeIds = null, List<int> filterAccountIds = null, List<AccountDTO> accounts = null, bool addEmptyAccounts = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            accounts = accounts ?? base.GetAccountInternalsFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId));
            List<AccountDTO> filterAccounts = new List<AccountDTO>();
            filterAccounts.Add(mainAccount);
            if (!shiftTypeIds.IsNullOrEmpty())
            {
                var dim = base.GetShiftTypeAccountDimFromCache(entities, base.ActorCompanyId, false);

                if (dim != null)
                {
                    var shiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(base.ActorCompanyId)).Where(w => shiftTypeIds.Contains(w.ShiftTypeId));

                    foreach (var st in shiftTypes)
                    {
                        var matchingsAccount = accounts.FirstOrDefault(f => f.AccountId == st.AccountId);
                        if (matchingsAccount != null)
                            filterAccounts.Add(matchingsAccount);
                    }
                }
            }

            if (!filterAccountIds.IsNullOrEmpty())
                filterAccounts.AddRange(accounts.Where(w => filterAccountIds.Contains(w.AccountId)));

            if (useAccountHierarchy && accounts != null)
            {
                int? parentId = accounts.FirstOrDefault(f => f.AccountId == mainAccount.AccountId)?.ParentAccountId;
                if (parentId.HasValue)
                {
                    int defaultEmployeeAccountDimEmployeeAccountDimId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimEmployee, 0, base.ActorCompanyId, 0);

                    var matchingParent = accounts.FirstOrDefault(f => f.AccountId == parentId.Value && f.AccountDimId == defaultEmployeeAccountDimEmployeeAccountDimId);
                    if (matchingParent != null)
                        filterAccounts.Add(matchingParent);
                }
            }

            if (addEmptyAccounts)
            {
                var groupOnDim = accounts.GroupBy(g => g.AccountDimId);
                List<AccountDTO> emptyAccounts = new List<AccountDTO>();

                foreach (var dim in groupOnDim)
                {
                    if (!filterAccounts.Any(a => a.AccountDimId == dim.Key))
                        emptyAccounts.Add(new AccountDTO() { AccountDimId = dim.Key, Name = "", AccountNr = "0", AccountId = -1 * dim.Key });
                }

                filterAccounts.AddRange(emptyAccounts);
            }

            return filterAccounts;
        }

        public EvaluatePayrollPriceFormulaInputDTO SetupEvaluatePayrollPriceFormulaInputDTO(List<int> employeeIds, List<EmployeeGroup> employeeGroups, List<PayrollGroup> payrollGroups, string cacheKey, int cacheTTLFactor = 1, int? reportId = null)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            Dictionary<int, List<EmployeeFactor>> employeeFactorsDict = new Dictionary<int, List<EmployeeFactor>>();
            string employeeFactorsKey = cacheKey + "EmployeeFactors";
            Dictionary<int, List<EmployeeFactor>> EmployeeFactorsDictFromCache = BusinessMemoryCache<Dictionary<int, List<EmployeeFactor>>>.Get(employeeFactorsKey);

            if (EmployeeFactorsDictFromCache != null && EmployeeFactorsDictFromCache.Any())
            {
                EmployeeFactorsDictFromCache.ToList().ForEach(f => employeeFactorsDict.Add(f.Key, f.Value));
                BusinessMemoryCache<Dictionary<int, List<EmployeeFactor>>>.Set(employeeFactorsKey, employeeFactorsDict, 60);
            }


            var employeeFactors = EmployeeManager.GetEmployeesFactorsForCompany(entitiesReadOnly, this.ActorCompanyId).GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList());
            BusinessMemoryCache<Dictionary<int, List<EmployeeFactor>>>.Set(employeeFactorsKey, employeeFactorsDict, 60 * cacheTTLFactor);

            var iDTO = new EvaluatePayrollPriceFormulaInputDTO()
            {
                SysCountryId = base.GetCompanySysCountryIdFromCache(entitiesReadOnly, this.ActorCompanyId),
                EmployeeGroups = employeeGroups ?? base.GetEmployeeGroupsFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                PayrollGroups = payrollGroups ?? base.GetPayrollGroupsFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                PayrollPriceTypes = base.GetPayrollPriceTypesFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                EmploymentPriceTypesDict = base.GetEmploymentPriceTypeFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId), employeeIds).GroupBy(k => k.EmploymentId).ToDictionary(k => k.Key, v => v.ToList()),
                PayrollGroupPriceTypes = base.GetPayrollGroupPriceTypesForCompanyFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                PayrollProductPriceTypes = base.GetPayrollProductPriceTypesForCompanyFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                PayrollProductPriceFormulas = ProductManager.GetPayrollProductPriceFormulas(entitiesReadOnly, this.ActorCompanyId),
                PayrollPriceFormulas = base.GetPayrollPriceFormulasFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                SysPayrollPriceViews = SysDbCache.Instance.SysPayrollPriceViewDTOs,
                TimePeriods = TimePeriodManager.GetTimePeriods(entitiesReadOnly, TermGroup_TimePeriodType.Payroll, this.ActorCompanyId, addTimePeriodHeadName: false),
                EmployeeFactorsDict = employeeFactors,
                PayrollProducts = base.GetPayrollProductsFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                PayrollProductReportSettings = base.GetPayrollProductReportSettingsForCompanyFromCache(entitiesReadOnly, CacheConfig.Company(this.ActorCompanyId)),
                ReportId = reportId,
            };

            return iDTO;
        }

        public List<StaffingStatisticsInterval> GenerateStaffingNeedsHeadsForInterval(TermGroup_StaffingNeedHeadsFilterType needFilterType, TermGroup_TimeSchedulePlanningFollowUpCalculationType calculationType, DateTime dateFrom, DateTime dateTo, int accountDimId, int accountId, bool calculateNeed = false, bool calculateFrequency = false, bool calculateRowFrequency = false, bool calculateBudget = false, bool calculateForecast = false, bool calculateTemplate = false, bool calculateSchedule = false, bool calculateTime = false, bool calculateTemplateForEmployeePost = false, List<int> employeeIds = null, List<int> employeePostIds = null, bool addSummaryRow = true, int? timeScheduleScenarioHeadId = null, bool includeEmpTaxAndSuppCharge = false, List<int> filterAccountIds = null, List<AccountDTO> accounts = null, bool trustBoolOverCalculationTypeAll = false, List<PayrollProductSettingDTO> payrollProductSettings = null, List<int> shiftTypeIds = null, List<Employee> employees = null, List<EmployeeDTO> employeeDTOs = null, string cacheKey = null, StaffingStatisticsRow row = null, StaffingStatisticsEngine engine = null,
            List<EmployeeGroup> employeeGroups = null, List<PayrollGroup> payrollGroups = null, List<PayrollPriceType> payrollPriceTypes = null, List<VacationGroup> vacationGroups = null, List<ShiftTypeDTO> shiftTypeDTOs = null, List<AccountDimDTO> accountDims = null, List<FixedPayrollRowDTO> fixedPayrollRows = null, int? reportId = null, List<PayrollProductReportSetting> payrollProductReportSettings = null, bool noInterval = false, bool tryToGroupOnEmployee = false, List<AnnualLeaveGroup> annualLeaveGroups = null, bool forceWeekView = false)
        {
            #region Prereq

            List<FrequencyType> frequencyTypes = new List<FrequencyType>();
            frequencyTypes.Add(FrequencyType.Budget);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, base.ActorCompanyId);
            AccountHierarchyInput hinput = AccountHierarchyInput.GetInstance(AccountHierarchyParamType.IncludeVirtualParented);
            accountDims = accountDims ?? base.GetAccountDimsFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId));
            payrollProductReportSettings = payrollProductReportSettings ?? base.GetPayrollProductReportSettingsForCompanyFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId));
            accountDims.CalculateLevels();
            int intervalMinutes = GetStaffingNeedsIntervalMinutes(base.ActorCompanyId);
            accounts = accounts ?? base.GetAccountInternalsFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId));
            var mainAccount = accounts.FirstOrDefault(f => f.AccountId == accountId);
            List<AccountDTO> filterAccounts = GetFilterAccountsForStaffingStatisticsGroup(mainAccount, shiftTypeIds, filterAccountIds, accounts);
            List<AccountDTO> frequencyFilterAccounts = new List<AccountDTO>();
            int cacheTTLFactor = cacheKey != null && !employeeIds.IsNullOrEmpty() ? employeeIds.Count / 60 : 1;

            if (cacheTTLFactor < 1)
                cacheTTLFactor = 1;

            if (cacheTTLFactor > 10)
                cacheTTLFactor = 10;

            if (mainAccount == null)
                return new List<StaffingStatisticsInterval>();

            bool usePayroll = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UsePayroll, 0, base.ActorCompanyId, 0);

            DateTime selectionDateFrom = dateFrom;
            DateTime selectionDateTo = dateTo;

            if (usePayroll)
            {
                selectionDateFrom = CalendarUtility.GetBeginningOfMonth(selectionDateFrom);
                selectionDateTo = CalendarUtility.GetEndOfMonth(selectionDateTo);
            }

            List<StaffingNeedsFrequencyDTO> staffingNeedsFrequencies = new List<StaffingNeedsFrequencyDTO>();
            if (calculateFrequency)
            {
                staffingNeedsFrequencies = row != null ? row.StaffingNeedsFrequencies : base.GetStaffingNeedsFrequencyFromCache(entitiesReadOnly, base.ActorCompanyId, dateFrom, dateTo).ToDTOs(false).ToList();

                var accountsOnFreqs = accounts.Where(w => staffingNeedsFrequencies.Where(ww => ww.AccountId.HasValue).Select(s => s.AccountId).Contains(w.AccountId)).ToList();
                accountsOnFreqs.AddRange(accounts.Where(w => staffingNeedsFrequencies.Where(ww => ww.ParentAccountId.HasValue).Select(s => s.ParentAccountId).Contains(w.AccountId)));
                var dimOnFreqs = accountDims.Where(w => accountsOnFreqs.Select(s => s.AccountDimId).Distinct().Contains(w.AccountDimId)).ToList();
                frequencyFilterAccounts = filterAccounts.ToList();
                var accountsFromHierarchy = AccountManager.GetAccountsFromHierarchyById(base.ActorCompanyId, accountId, hinput);
                var topDim = accountDims.FirstOrDefault(f => frequencyFilterAccounts.Any(a => a.AccountDimId == f.AccountDimId));

                foreach (var acc in accountsFromHierarchy.GroupBy(g => dimOnFreqs.FirstOrDefault(f => f.Level > topDim.Level && f.AccountDimId == g.AccountDimId)?.Level ?? 0))
                {
                    if (acc.Key == 0)
                        continue;

                    if (!frequencyFilterAccounts.Any(a => a.AccountDimId == acc.First().AccountDimId))
                    {
                        frequencyFilterAccounts.AddRange(acc.ToList());
                    }
                }
            }

            List<StaffingNeedsRowFrequencyDTO> staffingNeedsRowFrequencys = new List<StaffingNeedsRowFrequencyDTO>();
            employeeGroups = employeeGroups ?? base.GetEmployeeGroupsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId));
            payrollGroups = payrollGroups ?? base.GetPayrollGroupsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId), loadSettings: true);
            payrollPriceTypes = payrollPriceTypes ?? base.GetPayrollPriceTypesFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId));
            vacationGroups = vacationGroups ?? base.GetVacationGroupsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId));
            payrollProductSettings = payrollProductSettings ?? base.GetPayrollProductDTOsWithSettingsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId)).SelectMany(sm => sm.Settings).ToList();
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entitiesReadonly, CacheConfig.Company(base.ActorCompanyId));
            string dateIntervalKey = $"d{dateFrom.ToString("yyMMdd")}|{dateTo.ToString("yyMMdd")}up{usePayroll}";
            string employeeIdsKey = $"e{string.Join(",", employeeIds ?? new List<int>())}".GetHashCode().ToString();
            string userKey = $"u{base.ActorCompanyId}*{base.RoleId}*{base.UserId}";
            string baseKey = dateIntervalKey + employeeIdsKey + userKey + (cacheKey ?? "");
            var shiftTypeDim = base.GetShiftTypeAccountDimFromCache(entitiesReadonly, ActorCompanyId, false);

            #endregion

            #region Input

            StaffingStatisticsInput input = new StaffingStatisticsInput(calculationType, base.ActorCompanyId, dateFrom, dateTo, selectionDateFrom, selectionDateTo, intervalMinutes, accountId, accounts, filterAccounts, frequencyFilterAccounts, calculateNeed, calculateFrequency, calculateRowFrequency, calculateBudget, calculateForecast, calculateTemplate, calculateSchedule, calculateTime, addSummaryRow, calculateTemplateForEmployeePost, employeeGroups, payrollGroups, payrollPriceTypes, includeEmpTaxAndSuppCharge, trustBoolOverCalculationTypeAll, payrollProductSettings, reportId: reportId, payrollProductReportSettings: payrollProductReportSettings, noInterval: noInterval, employeeIds: tryToGroupOnEmployee ? employeeIds : null, forceWeekView: forceWeekView);
            input.SetTemplateCostPerHour(SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.StaffingTemplateCost, 0, base.ActorCompanyId, 0));

            DateTime validTo = DateTime.UtcNow.AddSeconds(60);
            if (employeeDTOs == null) ExtensionCache.Instance.AddToEmployeePayrollGroupExtensionCaches(base.ActorCompanyId, employeeGroups, payrollGroups, payrollPriceTypes, annualLeaveGroups, validTo);
            shiftTypeDTOs = shiftTypeDTOs ?? base.GetShiftTypesFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId), loadSkills: true, loadAccounts: true).ToDTOs(includeSkills: true, setAccountInternalIds: true).ToList();
            input.FilterAccounts = filterAccounts;
            input.Accounts = accounts;
            input.FixedPayrollRows = fixedPayrollRows;

            if (employees.IsNullOrEmpty() && (input.LoadSchedule || input.LoadTransactions || input.LoadTemplate))
            {
                string employeeKey = $"employees{baseKey}";
                var employeesFromCache = BusinessMemoryCache<List<Employee>>.Get(employeeKey);

                if (!employeesFromCache.IsNullOrEmpty())
                {
                    employees = new List<Employee>();
                    employeesFromCache.ForEach(f => employees.Add(f));
                    BusinessMemoryCache<List<Employee>>.Set(employeeKey, employees, 60 * cacheTTLFactor);
                }
                else
                {
                    employees = EmployeeManager.GetAllEmployeesByIds(base.ActorCompanyId, employeeIds, loadEmployment: true, loadContact: true, loadEmploymentVacactionGroup: true);
                    BusinessMemoryCache<List<Employee>>.Set(employeeKey, employees, 120 * cacheTTLFactor);
                }
            }

            EvaluatePayrollPriceFormulaInputDTO iDTO = null;
            if (employeeIds != null && (input.LoadTemplate || input.LoadTransactions || input.LoadSchedule))
            {
                string iDTOKey = $"IdTO{baseKey}";
                iDTO = BusinessMemoryCache<EvaluatePayrollPriceFormulaInputDTO>.Get(iDTOKey);
                if (iDTO == null)
                {
                    iDTO = SetupEvaluatePayrollPriceFormulaInputDTO(employeeIds, employeeGroups, payrollGroups, baseKey, cacheTTLFactor);
                    BusinessMemoryCache<EvaluatePayrollPriceFormulaInputDTO>.Set(iDTOKey, iDTO, 120 * cacheTTLFactor);
                }
                input.EvaluatePayrollPriceFormulaInputDTO = iDTO;
                List<Employee> employeesFromCache = new List<Employee>();
                fixedPayrollRows = input.LoadTransactions ? fixedPayrollRows ?? EmployeeManager.GetEmployeeFixedPayrollRows(entitiesReadOnly, base.ActorCompanyId, employees, dateFrom, dateTo, iDTO) : null;
            }

            List<StaffingNeedsHeadDTO> heads = new List<StaffingNeedsHeadDTO>();
            if (input.LoadNeed || input.LoadFrequency || input.LoadRowFrequency || input.LoadBudget)
            {
                input.SetShiftTypes(shiftTypeDTOs);
                string budgetKey = $"StaffingNeedsHeads{baseKey}";
                var budgetsFromCache = BusinessMemoryCache<List<StaffingNeedsHeadDTO>>.Get(budgetKey);

                if (budgetsFromCache != null)
                {
                    budgetsFromCache.ForEach(f => heads.Add(f.CloneDTO()));
                    BusinessMemoryCache<List<StaffingNeedsHeadDTO>>.Set(budgetKey, heads, 60 * cacheTTLFactor);
                }
                else
                {
                    heads = GenerateStaffingNeedsHeads(needFilterType, StaffingNeedsHeadType.NeedsPlanning, dateFrom, dateTo, shiftTypes: input.GetShiftTypes());
                    BusinessMemoryCache<List<StaffingNeedsHeadDTO>>.Set(budgetKey, heads, 60 * cacheTTLFactor);
                }
                foreach (var head in heads)
                {
                    staffingNeedsRowFrequencys.AddRange(head.GetRowFrequencys());
                }
            }

            //Need
            if (input.LoadNeed)
            {
                input.SetNeeds(heads);
            }

            //Frequency
            if (input.LoadFrequency)
            {
                input.SetFrequencys(staffingNeedsFrequencies);
            }

            //RowFrequency
            if (input.LoadRowFrequency)
            {
                input.SetRowFrequencys(staffingNeedsRowFrequencys);
            }

            //Budget
            if (input.LoadBudget)
            {
                string budgetHeadKey = $"BudgetHeads{baseKey}";
                var budgetHeadCache = BusinessMemoryCache<List<BudgetHeadDTO>>.Get(budgetHeadKey);
                List<BudgetHeadDTO> budgetHeads = new List<BudgetHeadDTO>();

                if (budgetHeadCache != null)
                    budgetHeads = budgetHeadCache;
                else
                {
                    budgetHeads = BudgetManager.GetBudgetHeads(base.ActorCompanyId, new List<int>() { (int)DistributionCodeBudgetType.SalesBudget, (int)DistributionCodeBudgetType.SalesBudgetTime, (int)DistributionCodeBudgetType.SalesBudgetSalaryCost }, loadRows: true, onlyActive: true, fromDate: dateFrom, toDate: dateTo).ToDTOs().ToList();
                    BusinessMemoryCache<List<BudgetHeadDTO>>.Set(budgetHeadKey, budgetHeads, 60 * cacheTTLFactor);
                }

                input.SetBudgets(budgetHeads);
                input.SetRowBudgetFrequencys(staffingNeedsRowFrequencys);

                if (staffingNeedsFrequencies != null)
                    input.SetBudgetOrForecastFrequencys(staffingNeedsFrequencies, frequencyType: FrequencyType.Budget);
            }

            //Forecast
            if (input.LoadForecast)
            {
                input.SetRowForecastFrequencys(staffingNeedsRowFrequencys);

                if (staffingNeedsFrequencies != null)
                    input.SetBudgetOrForecastFrequencys(staffingNeedsFrequencies, frequencyType: FrequencyType.Forecast);
            }

            //Template
            List<GrossNetCostDTO> templateGrossNetCosts = null;
            if (input.LoadTemplate)
            {
                string templateKey = $"Templates{baseKey}";
                var templatesFromCache = BusinessMemoryCache<List<TimeSchedulePlanningDayDTO>>.Get(templateKey);

                List<TimeSchedulePlanningDayDTO> templates = new List<TimeSchedulePlanningDayDTO>();

                if (row != null)
                {
                    templates = row.Templates.SelectMany(s => s.Value).ToList();
                }
                else if (!templatesFromCache.IsNullOrEmpty())
                {
                    templatesFromCache.ForEach(f => templates.Add(f.CloneDTO()));
                    BusinessMemoryCache<List<TimeSchedulePlanningDayDTO>>.Set(templateKey, templates, 60 * cacheTTLFactor);
                }
                else
                {
                    templates = GetTimeSchedulePlanningDaysFromTemplate(base.ActorCompanyId, base.RoleId, base.UserId, dateFrom, dateTo, null, employeeIds, loadAccounts: true, loadTimeDeviationCause: false, loadEmployees: false, loadStaffingNeeds: false, employees: employees);
                    BusinessMemoryCache<List<TimeSchedulePlanningDayDTO>>.Set(templateKey, templates, 60 * cacheTTLFactor);
                }

                var filteredTemplates = input.FilterTemplateByAccount(templates);

                List<WorkIntervalDTO> templateWorkIntervals = filteredTemplates.GetWorkIntervals(loadGrossNetCost: true);
                templateGrossNetCosts = templateWorkIntervals.GetGrossNetCosts();
                if (templateGrossNetCosts.Count > 0)
                {
                    if (employees == null)
                        employees = EmployeeManager.GetAllEmployeesByIds(base.ActorCompanyId, employeeIds, loadEmployment: true, loadContact: true);

                    //TimeScheduleManager.CalculateGrossNetAndCost(templateGrossNetCosts, base.ActorCompanyId, base.UserId, base.RoleId, true, includeEmpTaxAndSuppCharge, employeeGroups: employeeGroups, payrollGroups: payrollGroups, employees: employees, iDTO: iDTO);

                    TimeScheduleManager.CalculateGrossNetAndCost(templateGrossNetCosts, base.ActorCompanyId, base.UserId, base.RoleId, true, includeEmpTaxAndSuppCharge, employeeGroups: employeeGroups, payrollGroups: payrollGroups, employees: employees, iDTO: iDTO,
                        timepayrollTransactions: (row?.AllTransactionsDict == null ? null : row?.AllTransactionsDict));
                }
                input.SetTemplate(templateWorkIntervals);
            }

            //Template For EmployeePost
            if (input.LoadTemplateForEmployeePost)
            {
                string templateKey = $"TemplateForEmployeePost{baseKey}" + string.Join(",", employeePostIds ?? new List<int>());
                var templatesFromCache = BusinessMemoryCache<List<TimeSchedulePlanningDayDTO>>.Get(templateKey);

                List<TimeSchedulePlanningDayDTO> templates = new List<TimeSchedulePlanningDayDTO>();

                if (!templatesFromCache.IsNullOrEmpty())
                {
                    templatesFromCache.ForEach(f => templates.Add(f.CloneDTO()));
                    BusinessMemoryCache<List<TimeSchedulePlanningDayDTO>>.Set(templateKey, templates, 60 * cacheTTLFactor);
                }
                else
                {
                    templates = GetTimeSchedulePlanningDaysFromTemplate(base.ActorCompanyId, base.RoleId, base.UserId, dateFrom, dateTo, null, null, employeePostIds: employeePostIds, loadAccounts: true, loadTimeDeviationCause: false, loadEmployees: false, loadStaffingNeeds: false);
                    BusinessMemoryCache<List<TimeSchedulePlanningDayDTO>>.Set(templateKey, templates, 60 * cacheTTLFactor);
                }

                templates = input.FilterTemplateByAccount(templates);
                List<WorkIntervalDTO> templateWorkIntervals = templates.GetWorkIntervals(loadGrossNetCost: true);
                input.SetTemplateForEmployeePost(templateWorkIntervals);
            }

            //By Employee
            if ((input.LoadSchedule || input.LoadTransactions) && employeeIds.Any())
            {
                var timeScheduleTypeIdsToExclude = TimeScheduleManager.GetTimeScheduleTypes(ActorCompanyId).Where(t => t.IsNotScheduleTime).Select(t => t.TimeScheduleTypeId).ToList();
                var payrollGroupSettings = base.GetPayrollGroupsFromCache(entitiesReadonly, CacheConfig.Company(ActorCompanyId, 60), loadSettings: true).SelectMany(f => f.PayrollGroupSetting).ToList();
                var payrollGroupPriceTypes = !iDTO.PayrollGroupPriceTypes.IsNullOrEmpty() ? iDTO.PayrollGroupPriceTypes.ToDTOs(true).ToList() : input.PayrollGroupPriceTypes.IsNullOrEmpty() ? PayrollManager.GetPayrollGroupPriceTypesForCompany(ActorCompanyId).ToDTOs(true).ToList() : input.PayrollGroupPriceTypes;
                var employmentPriceTypes = !iDTO.EmploymentPriceTypesDict.IsNullOrEmpty() ? iDTO.EmploymentPriceTypesDict.SelectMany(s => s.Value).ToDTOs(true, false).ToList() :

                (input.EmploymentPriceTypes.IsNullOrEmpty() ? base.GetEmploymentPriceTypeFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId, 60), employeeIds)?.ToDTOs(true, false).ToList() : input.EmploymentPriceTypes);
                input.SetSettings(payrollGroupSettings, payrollGroupPriceTypes, employmentPriceTypes);

                employeeIds = employeeIds.Distinct().ToList();

                input.SetSysPayrollPriceViews(PayrollManager.GetSysPayrollPriceView(base.GetCompanySysCountryIdFromCache(entitiesReadOnly, base.ActorCompanyId)));

                string transKey = $"Transactions{baseKey}";
                var transactionsFromCache = BusinessMemoryCache<Dictionary<int, List<TimePayrollTransactionDTO>>>.Get(transKey);

                Dictionary<int, List<TimePayrollTransactionDTO>> allTransactions = new Dictionary<int, List<TimePayrollTransactionDTO>>();

                if (row != null)
                {
                    allTransactions = row.TransactionsDict;
                    input.AllTransactionsDict = row.AllTransactionsDict;
                }
                else if (!transactionsFromCache.IsNullOrEmpty())
                {
                    allTransactions = new Dictionary<int, List<TimePayrollTransactionDTO>>();
                    foreach (var b in transactionsFromCache)
                        allTransactions.Add(b.Key, b.Value);

                    BusinessMemoryCache<Dictionary<int, List<TimePayrollTransactionDTO>>>.Set(transKey, allTransactions, 60 * cacheTTLFactor);
                }
                else
                {
                    allTransactions = TimeTransactionManager.GetTimePayrollTransactionDTOForReport(selectionDateFrom, selectionDateTo, employeeIds, base.ActorCompanyId);

                    if (base.UsePayroll(entitiesReadOnly, ActorCompanyId))
                    {
                        var scheduleTransactionsDict = TimeTransactionManager.GetTimePayrollScheduleTransactionDTOForReport(selectionDateFrom, selectionDateTo, employeeIds, base.ActorCompanyId);

                        foreach (var schedule in scheduleTransactionsDict)
                        {
                            if (allTransactions.ContainsKey(schedule.Key))
                            {
                                allTransactions[schedule.Key].AddRange(schedule.Value);
                            }
                            else
                            {
                                allTransactions.Add(schedule.Key, schedule.Value);
                            }
                        }
                    }

                    input.AllTransactionsDict = allTransactions;
                    BusinessMemoryCache<Dictionary<int, List<TimePayrollTransactionDTO>>>.Set(transKey, allTransactions, 60 * cacheTTLFactor);
                }

                string scheduleKey = $"Schedules{baseKey}";
                var templatesFromCache = BusinessMemoryCache<Dictionary<int, List<TimeScheduleTemplateBlock>>>.Get(scheduleKey);

                Dictionary<int, List<TimeScheduleTemplateBlock>> allScheduleBlocksDict = new Dictionary<int, List<TimeScheduleTemplateBlock>>();
                if (row != null)
                {
                    allScheduleBlocksDict = row.TimeScheduleBlocksDict;
                }
                else if (!templatesFromCache.IsNullOrEmpty())
                {
                    var blocksFromCache = templatesFromCache.SelectMany(s => s.Value).ToList();
                    var filteredBlocksFromCache = blocksFromCache.Where(i => !i.TempUsed && !i.TimeDeviationCauseId.HasValue).ToList();
                    allScheduleBlocksDict = new Dictionary<int, List<TimeScheduleTemplateBlock>>();
                    foreach (var b in filteredBlocksFromCache.GroupBy(g => g.EmployeeId))
                    {
                        if (b.All(s => s.IsBreak))
                            continue;

                        allScheduleBlocksDict.Add(b.Key.Value, b.ToList());
                    }
                    BusinessMemoryCache<Dictionary<int, List<TimeScheduleTemplateBlock>>>.Set(scheduleKey, allScheduleBlocksDict, 60 * cacheTTLFactor);
                }
                else
                {
                    var allScheduleBlocks = GetTimeScheduleTemplateBlocksForAccounts(employeeIds, selectionDateFrom, selectionDateTo, input.FilterAccounts.Select(s => s.AccountId).ToList(), timeScheduleScenarioHeadId);
                    allScheduleBlocksDict = allScheduleBlocks.GroupBy(g => g.EmployeeId.Value).ToDictionary(k => k.Key, v => v.ToList());
                    BusinessMemoryCache<Dictionary<int, List<TimeScheduleTemplateBlock>>>.Set(scheduleKey, allScheduleBlocksDict, 60 * cacheTTLFactor);
                }

                var blocks = allScheduleBlocksDict.SelectMany(s => s.Value).ToList();
                // var filteredBlocks = input.FilterTimeScheduleTemplateBlocksByAccount(blocks.Where(i => !i.TempUsed && !i.TimeDeviationCauseId.HasValue).ToList());
                var filteredBlocks = input.FilterTimeScheduleTemplateBlocksByAccount(blocks.Where(i => !i.TempUsed).ToList());
                var plannedAbsenceBlocks = input.FilterTimeScheduleTemplateBlocksByAccount(blocks.Where(i => !i.TempUsed && i.TimeDeviationCauseId.HasValue).ToList());
                var filteredScheduleBlocksDict = filteredBlocks.GroupBy(g => g.EmployeeId.Value).Where(w => !w.All(a => a.IsBreak())).ToDictionary(k => k.Key, v => v.ToList());

                var trans = allTransactions.SelectMany(s => s.Value).ToList();
                var filteredTrans = input.FilterTransactionsByAccount(trans);
                var filteredTransDict = filteredTrans.GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList());

                foreach (int employeeId in employeeIds)
                {
                    filteredTransDict.TryGetValue(employeeId, out List<TimePayrollTransactionDTO> employeeTransactions);

                    //Transactions
                    if (input.LoadTransactions && employeeTransactions != null)
                        input.SetTransactionsForEmployee(employeeId, employeeTransactions);

                    //Schedule
                    if (input.LoadSchedule)
                    {
                        if (filteredScheduleBlocksDict.TryGetValue(employeeId, out var schedule) && schedule != null)
                        {
                            if (schedule.All(a => a.IsBreak))
                                continue;

                            var scheduleBlocks = input.FilterTimeScheduleTemplateBlocksByAccount(schedule);
                            //var scheduleBlocks = input.FilterTimeScheduleTemplateBlocksByAccount(schedule.Where(i => !i.TimeDeviationCauseId.HasValue).ToList());

                            if (scheduleBlocks.All(a => a.IsBreak))
                                continue;

                            scheduleBlocks = scheduleBlocks.Where(w => w.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Schedule || w.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Standby).ToList();

                            // scheduleBlocks.Where(w => !w.IsBreak).ToList().ForEach(f => f.TempUsed = true);

                            if (timeScheduleTypeIdsToExclude.Any())
                                scheduleBlocks = scheduleBlocks.Where(s => !timeScheduleTypeIdsToExclude.Contains(s.TimeScheduleTypeId ?? 0)).ToList();

                            List<WorkIntervalDTO> scheduleWorkIntervals = scheduleBlocks.GetWorkIntervals(hiddenEmployeeId, loadGrossNetCost: true);
                            List<GrossNetCostDTO> scheduleGrossNetCosts = scheduleWorkIntervals.GetGrossNetCosts();

                            if (scheduleGrossNetCosts.Count > 0)
                            {
                                if (employees == null)
                                    employees = EmployeeManager.GetAllEmployeesByIds(base.ActorCompanyId, employeeIds, loadEmployment: true, loadContact: true);

                                List<GrossNetCostDTO> templateGrossNetCostsForEmployee = templateGrossNetCosts != null ? templateGrossNetCosts.Where(i => i.EmployeeId == employeeId).ToList() : new List<GrossNetCostDTO>();
                                TimeScheduleManager.CalculateGrossNetAndCost(scheduleGrossNetCosts, base.ActorCompanyId, base.UserId, base.RoleId, true, includeEmpTaxAndSuppCharge, prevCalculatedGrossNetCosts: templateGrossNetCostsForEmployee, employeeGroups: employeeGroups, payrollGroups: payrollGroups, employees: employees, iDTO: iDTO, timepayrollTransactions: allTransactions);
                            }
                            input.SetSchedule(scheduleWorkIntervals);
                        }
                    }
                }

                if (input.LoadTransactions)
                {
                    if (employees == null)
                        employees = EmployeeManager.GetAllEmployeesByIds(base.ActorCompanyId, employeeIds, loadEmployment: true, loadContact: true);
                    input.SetEmployees(employeeDTOs ?? employees.ToDTOs(includeEmployments: true,
         employeeGroups: base.GetEmployeeGroupsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId)),
         payrollGroups: base.GetPayrollGroupsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId)),
         vacationGroups: base.GetVacationGroupsFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId)),
         payrollPriceTypes: base.GetPayrollPriceTypesFromCache(entitiesReadOnly, CacheConfig.Company(ActorCompanyId))));
                }
            }

            #endregion

            #region  Calculation

            engine = engine == null ? new StaffingStatisticsEngine(input, this.parameterObject) : engine.ReInitiate(input);
            engine.Calculate();

            #endregion

            return engine.GetIntervals();
        }

        public StaffingStatisticsIntervalRow RecalculateStaffingNeedsSummary(StaffingStatisticsIntervalRow row)
        {
            StaffingStatisticsEngine staffingStatisticsEngine = new StaffingStatisticsEngine();
            staffingStatisticsEngine.ReCalculateKPIs(row);
            return row;
        }

        public List<StaffingNeedsHeadDTO> GenerateStaffingNeedsHeads(TermGroup_StaffingNeedHeadsFilterType filterType, StaffingNeedsHeadType type, DateTime dateFrom, DateTime dateTo, List<ShiftTypeDTO> shiftTypes = null, bool buildMountain = false)
        {
            List<StaffingNeedsHeadDTO> heads = new List<StaffingNeedsHeadDTO>();

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetBeginningOfDay(dateTo);

            List<StaffingNeedsHead> staffingNeedsHeadsCharts = GetStaffingNeedsHeadsForUser(base.ActorCompanyId, true, true, true, type);
            List<TimeScheduleTaskDTO> timeScheduleTasks = GetTimeScheduleTasks(base.ActorCompanyId, dateFrom, dateTo, doIncludeRemovedDates: true, loadAccounting: true).ToDTOs(true).ToList();
            List<IncomingDeliveryHeadDTO> incomingDeliveryHeads = GetIncomingDeliveries(base.ActorCompanyId, dateFrom, dateTo, doIncludeRemovedDates: true, loadAccounting: true).ToDTOs(true, true).ToList();
            if (shiftTypes == null)
                shiftTypes = GetShiftTypes(base.ActorCompanyId, loadSkills: true).ToDTOs(includeSkills: true).ToList();
            int interval = GetStaffingNeedsIntervalMinutes(base.ActorCompanyId);

            int day = 1;
            DateTime currentDate = dateFrom;
            while (currentDate <= dateTo)
            {
                StaffingNeedsCalculationEngine staffingNeedsCalculationEngine = new StaffingNeedsCalculationEngine(new List<TimeBreakTemplateDTO>(), parameterObject);
                staffingNeedsCalculationEngine.ShiftTypes = shiftTypes;
                List<StaffingNeedsHead> staffingNeedsHeadsChartForDate = staffingNeedsHeadsCharts.GetStaffingNeedsHeadsForDate(currentDate);
                List<StaffingNeedsHead> staffingNeedsHeadsChartForDayOfWeek = staffingNeedsHeadsCharts.GetStaffingNeedsHeadsForDayOfWeek(currentDate, staffingNeedsHeadsChartForDate);
                List<TimeScheduleTaskDTO> timeScheduleTasksForDate = timeScheduleTasks.Where(i => i.RecurringDates != null && i.RecurringDates.DoRecurOnDate(currentDate, doIncludeRemovedDates: true)).ToList();
                List<IncomingDeliveryHeadDTO> incomingDeliveryHeadsForDate = incomingDeliveryHeads.Where(i => i.RecurringDates != null && i.RecurringDates.DoRecurOnDate(currentDate, doIncludeRemovedDates: true)).ToList();

                StaffingNeedsHeadDTO headTaskAndDelivery = CreateStaffingNeedsHeadDTO(base.ActorCompanyId, interval, null, timeScheduleTasksForDate.ToList(), incomingDeliveryHeadsForDate, "", currentDate, 0, currentDate.DayOfWeek, dateTo > dateFrom, 0);
                List<StaffingNeedsHeadDTO> headChartsForDate = staffingNeedsHeadsChartForDate?.ToDTOs(true, true, true, true).ToList();
                List<StaffingNeedsHeadDTO> headChartForDayOfWeek = staffingNeedsHeadsChartForDayOfWeek?.ToDTOs(true, true, true, true).ToList();

                if (headTaskAndDelivery != null || headChartsForDate != null || headChartForDayOfWeek != null)
                {
                    StaffingNeedsHeadDTO copyFrom = null;
                    if (headTaskAndDelivery != null)
                        copyFrom = headTaskAndDelivery;
                    else if (!headChartsForDate.IsNullOrEmpty())
                        copyFrom = headChartsForDate.First();
                    else if (!headChartForDayOfWeek.IsNullOrEmpty())
                        copyFrom = headChartForDayOfWeek.FirstOrDefault();

                    StaffingNeedsHeadDTO head = new StaffingNeedsHeadDTO()
                    {
                        //NA
                        StaffingNeedsHeadId = 0,
                        ParentId = null,
                        Interval = interval,
                        DayTypeId = null,

                        //Known
                        Type = StaffingNeedsHeadType.NeedsPlanning,
                        Weekday = currentDate.DayOfWeek,
                        Date = currentDate.Date,
                    };

                    if (copyFrom != null)
                    {
                        head.Status = copyFrom.Status;
                        head.Name = copyFrom.Name;
                        head.Description = copyFrom.Description;
                        head.FromDate = copyFrom.FromDate;
                        head.PeriodGuid = copyFrom.PeriodGuid;
                    }

                    head.Rows = new List<StaffingNeedsRowDTO>();

                    if (headTaskAndDelivery != null && (headChartsForDate != null || headChartForDayOfWeek != null))
                    {
                        List<StaffingNeedsRowDTO> headTaskAndDeliveryRows = headTaskAndDelivery.GetValidRows(filterType, timeScheduleTasks, incomingDeliveryHeads, currentDate, false);

                        List<StaffingNeedsRowDTO> chartRows = new List<StaffingNeedsRowDTO>();
                        if (headChartForDayOfWeek != null)
                        {
                            foreach (var item in headChartForDayOfWeek)
                                chartRows.AddRange(item.GetValidRows(filterType, timeScheduleTasks, incomingDeliveryHeads, currentDate, true));
                        }

                        if (headChartsForDate != null)
                        {
                            foreach (var item in headChartsForDate)
                                chartRows.AddRange(item.GetValidRows(filterType, timeScheduleTasks, incomingDeliveryHeads, currentDate, true));
                        }

                        head.Rows = staffingNeedsCalculationEngine.MergeShiftFromChartData(headTaskAndDeliveryRows, chartRows, shiftTypes, timeScheduleTasks, buildMountain);
                    }
                    else
                    {
                        if (headTaskAndDelivery != null)
                            head.Rows.AddRange(headTaskAndDelivery.GetValidRows(filterType, timeScheduleTasks, incomingDeliveryHeads, currentDate, false));
                        if (headChartsForDate != null)
                        {
                            foreach (var item in headChartsForDate)
                                head.Rows.AddRange(item.GetValidRows(filterType, timeScheduleTasks, incomingDeliveryHeads, currentDate, true));
                        }
                        if (headChartForDayOfWeek != null)
                        {
                            foreach (var item in headChartForDayOfWeek)
                                head.Rows.AddRange(item.GetValidRows(filterType, timeScheduleTasks, incomingDeliveryHeads, currentDate, true));
                        }
                    }

                    foreach (StaffingNeedsRowDTO row in head.Rows)
                    {
                        foreach (StaffingNeedsRowPeriodDTO period in row.Periods)
                        {
                            period.Date = row.Date;
                        }
                    }

                    heads.Add(head);
                }

                currentDate = currentDate.AddDays(1);
                day++;
            }

            heads.SetDateOnRowFrequencys();
            return heads;
        }

        public StaffingNeedsHead GetStaffingNeedsHead(int staffingNeedsHeadId, int actorCompanyId, bool loadUser, bool loadRows, bool loadPeriods, bool loadRowFrequencys)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsHead.NoTracking();
            entities.StaffingNeedsRow.NoTracking();
            entities.StaffingNeedsRowPeriod.NoTracking();
            return GetStaffingNeedsHead(entities, staffingNeedsHeadId, actorCompanyId, loadUser, loadRows, loadPeriods, loadRowFrequencys);
        }

        public StaffingNeedsHead GetStaffingNeedsHead(CompEntities entities, int staffingNeedsHeadId, int actorCompanyId, bool loadUser, bool loadRows, bool loadPeriods, bool loadRowFrequencys)
        {
            IQueryable<StaffingNeedsHead> query = entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser");

            if (loadUser)
                entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser.User");
            if (loadRows)
                query = query.Include("StaffingNeedsRow.ShiftType");
            if (loadPeriods)
                query = query.Include("StaffingNeedsRow.StaffingNeedsRowPeriod.ShiftType");
            if (loadPeriods)
                query = query.Include("StaffingNeedsRow.StaffingNeedsRowFrequency.ShiftType");

            query = query.Where(sn =>
                sn.StaffingNeedsHeadId == staffingNeedsHeadId &&
                sn.ActorCompanyId == actorCompanyId);

            return query.Select(sn => sn).FirstOrDefault();
        }

        public StaffingNeedsHead GetStaffingNeedsHead(CompEntities entities, StaffingNeedsHeadType type, DayOfWeek? dayOfWeek, string name, int actorCompanyId, bool loadUser, bool loadRows, bool loadPeriods)
        {
            IQueryable<StaffingNeedsHead> query = entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser");

            if (loadUser)
                entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser.User");
            if (loadRows)
                query = query.Include("StaffingNeedsRow.ShiftType");
            if (loadPeriods)
                query = query.Include("StaffingNeedsRow.StaffingNeedsRowPeriod.ShiftType");

            query = query.Where(sn =>
                sn.Type == (int)type &&
                (!dayOfWeek.HasValue || sn.Weekday == (int)dayOfWeek.Value) &&
                sn.Name.Equals(name) &&
                sn.ActorCompanyId == actorCompanyId);

            return query.Select(sn => sn).FirstOrDefault();
        }

        public StaffingNeedsHead GetStaffingNeedsHead(StaffingNeedsHeadType type, DayOfWeek? dayOfWeek, string name, int actorCompanyId, bool loadUser, bool loadRows, bool loadPeriods, DateTime? fromDate)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsHead.NoTracking();
            entities.StaffingNeedsRow.NoTracking();
            entities.StaffingNeedsRowPeriod.NoTracking();
            return GetStaffingNeedsHead(entities, type, dayOfWeek, name, actorCompanyId, loadUser, loadRows, loadPeriods, fromDate);
        }

        public StaffingNeedsHead GetStaffingNeedsHead(CompEntities entities, StaffingNeedsHeadType type, DayOfWeek? dayOfWeek, string name, int actorCompanyId, bool loadUser, bool loadRows, bool loadPeriods, DateTime? fromDate)
        {
            IQueryable<StaffingNeedsHead> query = entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser");

            if (loadUser)
                entities.StaffingNeedsHead.Include("StaffingNeedsHeadUser.User");
            if (loadRows)
                query = query.Include("StaffingNeedsRow.ShiftType");
            if (loadPeriods)
                query = query.Include("StaffingNeedsRow.StaffingNeedsRowPeriod.ShiftType");

            query = query.Where(sn =>
                sn.Type == (int)type &&
                (!dayOfWeek.HasValue || sn.Weekday == (int)dayOfWeek.Value) &&
                sn.Name.Equals(name) &&
                sn.FromDate == fromDate &&
                sn.ActorCompanyId == actorCompanyId);


            return query.Select(sn => sn).FirstOrDefault();
        }

        public StaffingNeedsHeadDTO CreateStaffingNeedsHeadDTO(int interval, List<TimeScheduleTaskDTO> timeScheduleTasks, string name, DateTime date, int dayTypeId, DayOfWeek? dayOfWeek)
        {
            StaffingNeedsHeadDTO headDTO = new StaffingNeedsHeadDTO()
            {
                Date = date,
                DayTypeId = dayTypeId,
                Weekday = dayOfWeek,
                Name = name
            };

            headDTO.Rows = CreateStaffingNeedsRowsAndPeriodsFromScheduleTasks(interval, timeScheduleTasks);

            return headDTO;
        }

        public StaffingNeedsHeadDTO CreateStaffingNeedsHeadDTO(int interval, List<IncomingDeliveryHeadDTO> incomingDeliverys, string name, DateTime date, int dayTypeId, DayOfWeek? dayOfWeek)
        {
            StaffingNeedsHeadDTO headDTO = new StaffingNeedsHeadDTO()
            {
                Date = date,
                DayTypeId = dayTypeId,
                Weekday = dayOfWeek,
                Name = name
            };

            headDTO.Rows = CreateStaffingNeedsRowsAndPeriodsFromIncomingDeliveryHeads(interval, incomingDeliverys);

            return headDTO;
        }

        public StaffingNeedsHeadDTO CreateStaffingNeedsHeadDTO(int actorCompanyId, int interval, List<StaffingNeedsAnalysisChartData> chartData, List<TimeScheduleTaskDTO> timeScheduleTasks, List<IncomingDeliveryHeadDTO> incomingDeliveryHeads, string name, DateTime? date, int dayTypeId, DayOfWeek? dayOfWeek, bool wholeWeek, decimal adjustPercent, int? shiftTypeId = null, int? timeScheduleTaskId = null, List<TimeBreakTemplateDTO> timeBreakTemplates = null)
        {
            StaffingNeedsHeadDTO headDTO = new StaffingNeedsHeadDTO()
            {
                Date = date,
                DayTypeId = dayTypeId,
                Weekday = dayOfWeek,
                Name = name,
                Interval = interval
            };

            //Filter Tasks and deliveries 
            if (headDTO.Weekday.HasValue)
            {
                timeScheduleTasks = timeScheduleTasks?.Where(x => x.IsBaseNeed(headDTO.Weekday.Value)).ToList();
                incomingDeliveryHeads = incomingDeliveryHeads?.Where(x => x.IsBaseNeed(headDTO.Weekday.Value)).ToList();
            }

            if (timeBreakTemplates == null)
                timeBreakTemplates = GetTimeBreakTemplates(base.ActorCompanyId).ToDTOs().ToList();

            headDTO.Rows = CreateStaffingeNeedsRowsAndPeriods(actorCompanyId, interval, timeScheduleTasks, incomingDeliveryHeads, chartData, out List<StaffingNeedsRowFrequencyDTO> staffingNeedsRowFrequencyDTOs, shiftTypeId, timeScheduleTaskId, timeBreakTemplates: timeBreakTemplates);

            if (staffingNeedsRowFrequencyDTOs.Any())
            {
                if (!shiftTypeId.HasValue && staffingNeedsRowFrequencyDTOs.FirstOrDefault(f => f.ShiftTypeId.HasValue) != null)
                    shiftTypeId = staffingNeedsRowFrequencyDTOs.FirstOrDefault(f => f.ShiftTypeId.HasValue).ShiftTypeId;

                var row = new StaffingNeedsRowDTO()
                {
                    ShiftTypeId = shiftTypeId,
                    StaffingNeedsLocationGroupId = null,
                    Periods = new List<StaffingNeedsRowPeriodDTO>(),
                    State = SoeEntityState.Active,
                };

                row.RowFrequencys = staffingNeedsRowFrequencyDTOs;
                headDTO.Rows.Add(row);
            }
            return headDTO;
        }

        public StaffingNeedsHeadDTO CreateShiftsFromStaffingNeeds(DateTime dateFrom, DateTime dateTo)
        {
            List<StaffingNeedsHeadDTO> needHeads = GenerateStaffingNeedsHeads(TermGroup_StaffingNeedHeadsFilterType.BaseNeed, StaffingNeedsHeadType.NeedsPlanning, dateFrom, dateTo);
            if (needHeads.IsNullOrEmpty())
                return null;

            List<StaffingNeedsRowDTO> rows = new List<StaffingNeedsRowDTO>();
            foreach (StaffingNeedsHeadDTO needHead in needHeads)
            {
                if (needHead.Rows != null)
                    rows.AddRange(needHead.Rows);
            }

            StaffingNeedsHeadDTO firstHead = needHeads.First();
            DateTime? date = firstHead.Date;
            int? dayTypeId = firstHead.DayTypeId;
            DayOfWeek? dayOfWeek = firstHead.Weekday;
            string name = firstHead.Name;

            List<ShiftTypeDTO> shiftTypes = GetShiftTypes(base.ActorCompanyId, loadAccounts: false, loadSkills: true, loadEmployeeStatisticsTargets: false, setTimeScheduleTemplateBlockTypeName: false, setCategoryNames: false).ToDTOs(includeSkills: true, includeShiftTypeLinkIds: true).ToList();
            List<EmployeePostDTO> employeePosts = GetEmployeePosts(base.ActorCompanyId, true, loadRelations: true).ToDTOs(true).ToList();
            List<TimeScheduleTaskDTO> timeScheduleTasks = GetTimeScheduleTasks(base.ActorCompanyId, dateFrom, dateTo, loadType: true, loadShiftType: true).ToDTOs(true).ToList();
            List<IncomingDeliveryHeadDTO> incomingDeliveryHeads = GetIncomingDeliveries(base.ActorCompanyId, dateFrom, dateTo, loadRows: true, loadAccounting: true).ToDTOs(true, true).ToList();
            List<TimeBreakTemplateDTO> breakTemplates = GetTimeBreakTemplates(base.ActorCompanyId).ToDTOs().ToList();
            int interval = GetStaffingNeedsIntervalMinutes(base.ActorCompanyId);

            StaffingNeedsCalculationInput input = new StaffingNeedsCalculationInput(date, dayTypeId, dayOfWeek, name, rows, incomingDeliveryHeads, timeScheduleTasks, shiftTypes, employeePosts, interval, true);
            StaffingNeedsCalculationEngine staffingNeedsCalculationEngine = new StaffingNeedsCalculationEngine(breakTemplates, parameterObject);
            return staffingNeedsCalculationEngine.GenerateStaffingNeedsShifts(input);
        }

        public ActionResult CreateFakeStaffingneedsFrequancy(int actorCompanyId, DateTime dateFrom, DateTime dateTo)
        {
            try
            {
                List<string> register = new List<string>() { "kassa", "själv", "förbutik" };
                List<string> admin = new List<string>() { "admin", "kontor", "chef", "trän" };
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                var accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId);
                var accountDimShop = accountDims.FirstOrDefault(f => f.SysSieDimNr == (int)TermGroup_SieAccountDim.Shop);
                var accountDimDepartment = accountDims.FirstOrDefault(f => f.SysSieDimNr == (int)TermGroup_SieAccountDim.Department);
                if (accountDimShop == null || accountDimDepartment == null)
                    return new ActionResult(false);

                var shiftTypes = GetShiftTypes(actorCompanyId, loadAccountInternals: true);

                var departments = AccountManager.GetAccounts(actorCompanyId).Where(w => w.AccountDimId == accountDimDepartment.AccountDimId).ToList();
                var stores = AccountManager.GetAccounts(actorCompanyId).Where(w => w.AccountDimId == accountDimShop.AccountDimId).ToList();
                var registerAccounts = new List<Account>();
                var departmentAccounts = new List<Account>();
                var salesAccounts = new List<Account>();


                foreach (var r in admin)
                    foreach (var a in departments)
                        if (a.Name.ToLower().Contains(r))
                            departmentAccounts.Add(a);

                foreach (var r in register)
                    foreach (var a in departments)
                        if (a.Name.ToLower().Contains(r) && !departmentAccounts.Any(w => w.AccountId == a.AccountId))
                            registerAccounts.Add(a);

                foreach (var a in departments)
                    if (!registerAccounts.Any(w => a.AccountId == w.AccountId) && !departmentAccounts.Any(w => a.AccountId == w.AccountId))
                        salesAccounts.Add(a);

                Random random = new Random();

                foreach (var item in CalendarUtility.GetDatesInInterval(dateFrom, dateTo))
                {
                    var endOfDay = CalendarUtility.GetEndOfDay(item);
                    var hasFrequency = entitiesReadOnly.StaffingNeedsFrequency.Any(a => a.FrequencyType == (int)FrequencyType.Actual && a.ActorCompanyId == actorCompanyId && a.TimeFrom > item && a.TimeFrom < endOfDay);

                    if (hasFrequency)
                        continue;

                    // Sales per hour

                    using (CompEntities entities = new CompEntities())
                    {
                        List<StaffingNeedsFrequency> freqs = new List<StaffingNeedsFrequency>();

                        foreach (var store in stores)
                        {
                            var startTime = item.Date.AddHours(7);
                            var stopTime = item.Date.AddHours(22);
                            var currentTime = startTime;

                            while (currentTime < stopTime)
                            {
                                decimal factor = 3;

                                if (currentTime.Hour >= 11 && currentTime.Hour <= 15)
                                    factor = new decimal(1.3);

                                if (currentTime.Hour > 15 && currentTime.Hour <= 19)
                                    factor = new decimal(1.8);

                                if (currentTime.Hour < 11 || currentTime.Hour > 19)
                                    factor = new decimal(0.8);

                                foreach (var salesAccount in salesAccounts)
                                {
                                    decimal amount = random.Next(200, 1000) * factor;

                                    StaffingNeedsFrequency snfSales = new StaffingNeedsFrequency()
                                    {
                                        ActorCompanyId = actorCompanyId,
                                        TimeFrom = currentTime,
                                        TimeTo = currentTime.AddMinutes(60),
                                        Amount = amount,
                                        ExternalCode = salesAccount.AccountNr,
                                        AccountId = salesAccount.AccountId,
                                        ParentAccountId = store.AccountId,
                                        ParentExternalCode = store.AccountNr,
                                    };
                                    freqs.Add(snfSales);
                                }

                                foreach (var registerAccount in registerAccounts)
                                {
                                    decimal nbrOfItems = random.Next(100, 400);
                                    decimal nbrOfCustomers = random.Next(Convert.ToInt32(decimal.Divide(nbrOfItems, 14)), Convert.ToInt32(decimal.Divide(nbrOfItems, 8))) * 4;

                                    StaffingNeedsFrequency snfRegister = new StaffingNeedsFrequency()
                                    {
                                        ActorCompanyId = actorCompanyId,
                                        TimeFrom = currentTime,
                                        TimeTo = currentTime.AddMinutes(60),
                                        NbrOfItems = nbrOfItems,
                                        NbrOfCustomers = nbrOfCustomers,
                                        ExternalCode = registerAccount.AccountNr,
                                        AccountId = registerAccount.AccountId,
                                        ParentAccountId = store.AccountId,
                                        ParentExternalCode = store.AccountNr,
                                        NbrOfMinutes = Convert.ToInt32(nbrOfItems),
                                        Cost = (nbrOfItems * 99)
                                    };
                                    freqs.Add(snfRegister);
                                }

                                currentTime = currentTime.AddMinutes(60);
                            }
                        }

                        var saveResult = BulkInsert(entities, freqs);
                        if (!saveResult.Success)
                            LogError(saveResult.ErrorMessage);
                    }
                }

                var beginnigOfYear = CalendarUtility.GetBeginningOfYear(dateTo);
                var endOfYear = CalendarUtility.GetEndOfYear(dateTo);
                var freqBudgetAndForecastInYear = entitiesReadOnly.StaffingNeedsFrequency.Where(a => (a.FrequencyType == (int)FrequencyType.Budget || a.FrequencyType == (int)FrequencyType.Forecast) && a.ActorCompanyId == actorCompanyId && a.TimeFrom > beginnigOfYear && a.TimeFrom < endOfYear).ToList();

                var numberOfBudgetsThisYear = freqBudgetAndForecastInYear.Where(w => w.FrequencyType == (int)FrequencyType.Budget).Select(s => s.TimeFrom.Date).Distinct().Count();
                var addFakeDataBudget = numberOfBudgetsThisYear < 365;
                var numberOfForecastsThisYear = freqBudgetAndForecastInYear.Where(w => w.FrequencyType == (int)FrequencyType.Forecast).Select(s => s.TimeFrom.Date).Distinct().Count();
                var addFakeDataForecast = numberOfForecastsThisYear < 365;

                if (addFakeDataBudget || addFakeDataForecast)
                {
                    foreach (var item in CalendarUtility.GetDatesInInterval(CalendarUtility.GetBeginningOfYear(dateTo), CalendarUtility.GetEndOfYear(dateTo)))
                    {
                        var endOfDay = CalendarUtility.GetEndOfDay(item);
                        var freqOnDateBudget = addFakeDataBudget ? freqBudgetAndForecastInYear.Any(a => a.FrequencyType == (int)FrequencyType.Budget && a.TimeFrom > item && a.TimeFrom < endOfDay) : true;
                        var freqOnDateForcast = addFakeDataForecast ? freqBudgetAndForecastInYear.Any(a => a.FrequencyType == (int)FrequencyType.Forecast && a.TimeFrom > item && a.TimeFrom < endOfDay) : true;

                        // Budget per day
                        using (CompEntities entities = new CompEntities())
                        {
                            List<StaffingNeedsFrequency> freqs = new List<StaffingNeedsFrequency>();

                            foreach (var store in stores)
                            {
                                foreach (var salesAccount in salesAccounts)
                                {
                                    decimal amount = random.Next(250, 600);
                                    var costChangeBudget = random.Next(-50, 60);
                                    var costChangeForcast = random.Next(-50, 60);
                                    var nbrOfItemsChangeBudget = random.Next(-2, 2);
                                    var nbrOfItemsChangeForcast = random.Next(-2, 2);
                                    if (!freqOnDateBudget)
                                    {
                                        StaffingNeedsFrequency budgetSales = new StaffingNeedsFrequency()
                                        {
                                            ActorCompanyId = actorCompanyId,
                                            TimeFrom = item.Date,
                                            TimeTo = CalendarUtility.GetEndOfDay(item),
                                            Amount = amount,
                                            ExternalCode = salesAccount.AccountNr,
                                            AccountId = salesAccount.AccountId,
                                            ParentAccountId = store.AccountId,
                                            ParentExternalCode = store.AccountNr,
                                            FrequencyType = (int)FrequencyType.Budget,
                                            Cost = decimal.Divide(amount, 9) + costChangeBudget,
                                            NbrOfMinutes = Convert.ToInt32(decimal.Divide(decimal.Divide(amount, 9) + costChangeBudget, new decimal(1.8))) + nbrOfItemsChangeBudget
                                        };

                                        if (budgetSales.Cost < 0)
                                            budgetSales.Cost = 0;

                                        freqs.Add(budgetSales);
                                    }

                                    if (addFakeDataForecast)
                                    {
                                        StaffingNeedsFrequency forcastSales = new StaffingNeedsFrequency()
                                        {
                                            ActorCompanyId = actorCompanyId,
                                            TimeFrom = item.Date,
                                            TimeTo = CalendarUtility.GetEndOfDay(item),
                                            Amount = amount + random.Next(-50, 60),
                                            ExternalCode = salesAccount.AccountNr,
                                            AccountId = salesAccount.AccountId,
                                            ParentAccountId = store.AccountId,
                                            ParentExternalCode = store.AccountNr,
                                            FrequencyType = (int)FrequencyType.Forecast,
                                            Cost = decimal.Divide(amount, new decimal(9)) + costChangeForcast,
                                            NbrOfMinutes = Convert.ToInt32(decimal.Divide(decimal.Divide(amount, 9) + costChangeForcast, new decimal(1.8))) + nbrOfItemsChangeBudget
                                        };

                                        if (forcastSales.Cost < 0)
                                            forcastSales.Cost = 0;

                                        if (!freqOnDateForcast)
                                            freqs.Add(forcastSales);
                                    }

                                }
                            }

                            var saveResult = BulkInsert(entities, freqs);
                            if (!saveResult.Success)
                                LogError(saveResult.ErrorMessage);
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                return new ActionResult(ex, "fake failed");
            }

            return new ActionResult();
        }

        public int GetStaffingNeedsIntervalMinutes(int actorCompanyId, int defaultLength = 1)
        {
            int interval = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningDayViewMinorTickLength, 0, actorCompanyId, 0);
            if (interval < defaultLength)
                interval = defaultLength;
            return interval;
        }

        private void SetStaffingNeedsPeriodOnShift(List<TimeSchedulePlanningDayDTO> shifts, List<Tuple<Guid, StaffingNeedsRowPeriod>> periodTuples)
        {
            if (shifts == null || periodTuples == null)
                return;

            foreach (var period in periodTuples)
            {
                if (period.Item1 == Guid.Empty)
                    continue;

                foreach (TimeSchedulePlanningDayDTO shift in shifts.Where(w => w.PeriodGuid == period.Item1).ToList())
                {
                    if (shift != null)
                    {
                        shift.StaffingNeedsRowPeriodId = period.Item2.StaffingNeedsRowPeriodId;
                        shift.StaffingNeedsRowId = period.Item2.StaffingNeedsRowId;
                    }
                }
            }
        }

        private ActionResult SaveStaffingNeedsHead(List<CalculationPeriodItem> periodItems, List<TimeSchedulePlanningDayDTO> shifts, int actorCompanyId)
        {
            ActionResult result = new ActionResult(true);

            //Use only from CreateTimeSchedulePlanningDayDTOsFromEmployeePost
            //The rows should always be new rows, is exist than we add rows

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Grouping per EmployeePostId and WeekDay

                        foreach (var grouping in periodItems.GroupBy(g => $"{g.EmployeePostId}#{g.Weekday}#{g.ScheduleDate}").ToList())
                        {
                            #region Grouping per day

                            CalculationPeriodItem periodItem = grouping.First();
                            StaffingNeedsHeadDTO staffingNeedsHeadDTO = null;
                            List<Tuple<Guid, StaffingNeedsRowPeriod>> periodTuples = new List<Tuple<Guid, StaffingNeedsRowPeriod>>();

                            #region StaffingNeedsHead

                            StaffingNeedsHead staffingNeedsHead = GetStaffingNeedsHead(entities, StaffingNeedsHeadType.NeedsShifts, periodItem.Weekday, grouping.Key, actorCompanyId, false, true, true);
                            if (staffingNeedsHead != null)
                            {
                                staffingNeedsHead.Date = periodItem.ScheduleDate;
                                staffingNeedsHead.DayTypeId = periodItem.DayTypeId;
                                staffingNeedsHead.Weekday = (int)periodItem.Weekday;
                                staffingNeedsHead.Name = grouping.Key;
                                staffingNeedsHead.Type = (int)StaffingNeedsHeadType.NeedsShifts;
                                staffingNeedsHead.State = (int)SoeEntityState.Active;
                                staffingNeedsHeadDTO = staffingNeedsHead.ToDTO(true, true, true, true);

                            }
                            else
                            {
                                staffingNeedsHeadDTO = new StaffingNeedsHeadDTO()
                                {
                                    Date = periodItem.ScheduleDate,
                                    DayTypeId = periodItem.DayTypeId,
                                    Weekday = periodItem.Weekday,
                                    Name = grouping.Key,
                                    Type = StaffingNeedsHeadType.NeedsShifts,
                                    Rows = new List<StaffingNeedsRowDTO>()
                                };
                            }

                            result = SaveStaffingNeedsHead(entities, transaction, ref staffingNeedsHead, staffingNeedsHeadDTO, actorCompanyId, out _);
                            if (!result.Success)
                                return result;

                            #endregion

                            #region StaffingNeedsUser

                            result = SaveStaffingNeedsHeadUsers(entities, transaction, ref staffingNeedsHead, staffingNeedsHeadDTO.StaffingNeedsHeadUsers);
                            if (!result.Success)
                                return result;

                            #endregion

                            #region StaffingNeedsRow / StaffingNeedsRowPeriod

                            staffingNeedsHeadDTO.Rows.AddRange(StaffingNeedsCalculationExtensions.ToStaffingNeedsRowDTOs(grouping.ToList()));

                            result = SaveStaffingNeedsHeadRows(entities, transaction, ref staffingNeedsHead, staffingNeedsHeadDTO, ref periodTuples);
                            if (!result.Success)
                                return result;

                            #endregion

                            #region Set StaffingNeedsRowPeriodId on shift

                            SetStaffingNeedsPeriodOnShift(shifts, periodTuples);

                            #endregion
                        }

                        #endregion

                        #endregion

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult SaveStaffingNeedsHead(StaffingNeedsHeadDTO staffingNeedsHeadDTO, int actorCompanyId, List<TimeSchedulePlanningDayDTO> shifts = null)
        {
            if (staffingNeedsHeadDTO == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "StaffingNeedsHead");

            ActionResult result = null;

            int staffingNeedsHeadId = staffingNeedsHeadDTO.StaffingNeedsHeadId;
            List<Tuple<Guid, StaffingNeedsRowPeriod>> periodTuples = new List<Tuple<Guid, StaffingNeedsRowPeriod>>();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region StaffingNeedsHead

                        StaffingNeedsHead existingStaffingNeedsHead = GetStaffingNeedsHead(entities, staffingNeedsHeadId, actorCompanyId, false, true, true, true);

                        result = SaveStaffingNeedsHead(entities, transaction, ref existingStaffingNeedsHead, staffingNeedsHeadDTO, actorCompanyId, out staffingNeedsHeadId);
                        if (!result.Success)
                            return result;

                        #endregion

                        #region StaffingNeedsUser

                        result = SaveStaffingNeedsHeadUsers(entities, transaction, ref existingStaffingNeedsHead, staffingNeedsHeadDTO.StaffingNeedsHeadUsers);
                        if (!result.Success)
                            return result;

                        #endregion

                        #region StaffingNeedsRow / StaffingNeedsRowPeriod

                        result = SaveStaffingNeedsHeadRows(entities, transaction, ref existingStaffingNeedsHead, staffingNeedsHeadDTO, ref periodTuples);
                        if (!result.Success)
                            return result;

                        #endregion

                        #region Set StaffingNeedsRowPeriodId on shift

                        SetStaffingNeedsPeriodOnShift(shifts, periodTuples);

                        #endregion

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = staffingNeedsHeadId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        private ActionResult SaveStaffingNeedsHead(CompEntities entities, TransactionScope transaction, ref StaffingNeedsHead staffingNeedsHead, StaffingNeedsHeadDTO staffingNeedsHeadDTO, int actorCompanyId, out int staffingNeedsHeadId)
        {
            staffingNeedsHeadId = 0;

            if (staffingNeedsHead == null)
            {
                #region Add

                staffingNeedsHead = new StaffingNeedsHead()
                {
                    State = (int)SoeEntityState.Active,

                    //Set FK
                    ActorCompanyId = actorCompanyId,
                };

                SetCreatedProperties(staffingNeedsHead);
                entities.StaffingNeedsHead.AddObject(staffingNeedsHead);

                #endregion
            }
            else
            {
                #region Update

                SetModifiedProperties(staffingNeedsHead);

                #endregion
            }

            #region Common

            staffingNeedsHead.ParentId = staffingNeedsHeadDTO.ParentId;
            staffingNeedsHead.Type = (int)staffingNeedsHeadDTO.Type;
            staffingNeedsHead.Interval = staffingNeedsHeadDTO.Interval;
            staffingNeedsHead.Name = staffingNeedsHeadDTO.Name;
            staffingNeedsHead.Description = staffingNeedsHeadDTO.Description;
            staffingNeedsHead.DayTypeId = staffingNeedsHeadDTO.DayTypeId != 0 ? staffingNeedsHeadDTO.DayTypeId : null;
            staffingNeedsHead.Weekday = staffingNeedsHeadDTO.Weekday.HasValue ? (int?)staffingNeedsHeadDTO.Weekday.Value : (int?)null;
            staffingNeedsHead.Date = staffingNeedsHeadDTO.Date == DateTime.MinValue || !staffingNeedsHeadDTO.Date.HasValue ? null : staffingNeedsHeadDTO.Date;
            staffingNeedsHead.Status = (int)staffingNeedsHeadDTO.Status;
            staffingNeedsHead.FromDate = staffingNeedsHeadDTO.FromDate == DateTime.MinValue || !staffingNeedsHeadDTO.FromDate.HasValue ? (DateTime?)null : staffingNeedsHeadDTO.FromDate.Value.Date;
            staffingNeedsHead.AccountId = staffingNeedsHeadDTO.AccountId;
            #endregion

            ActionResult result = SaveChanges(entities, transaction);
            if (!result.Success)
                return result;

            staffingNeedsHeadId = staffingNeedsHead.StaffingNeedsHeadId;

            return result;
        }

        private ActionResult SaveStaffingNeedsHeadUsers(CompEntities entities, TransactionScope transaction, ref StaffingNeedsHead staffingNeedsHead, List<StaffingNeedsHeadUserDTO> staffingNeedsHeadUserDTOs)
        {
            //Make sure users are loaded
            if (!staffingNeedsHead.StaffingNeedsHeadUser.IsLoaded)
                staffingNeedsHead.StaffingNeedsHeadUser.Load();

            if (staffingNeedsHeadUserDTOs == null)
                staffingNeedsHeadUserDTOs = new List<StaffingNeedsHeadUserDTO>();
            if (staffingNeedsHead.StaffingNeedsHeadUser == null)
                staffingNeedsHead.StaffingNeedsHeadUser = new EntityCollection<StaffingNeedsHeadUser>();

            foreach (StaffingNeedsHeadUserDTO staffingNeedsHeadUser in staffingNeedsHeadUserDTOs)
            {
                StaffingNeedsHeadUser existingStaffingNeedsHeadUser = staffingNeedsHead.StaffingNeedsHeadUser.FirstOrDefault(u => u.UserId == staffingNeedsHeadUser.UserId);
                if (existingStaffingNeedsHeadUser != null)
                {
                    #region Update

                    if (existingStaffingNeedsHeadUser.State != (int)SoeEntityState.Active)
                    {
                        // User is deleted or inactive, reactivate it
                        existingStaffingNeedsHeadUser.State = (int)SoeEntityState.Active;
                        SetModifiedProperties(existingStaffingNeedsHeadUser);
                    }
                    if (existingStaffingNeedsHeadUser.Main != staffingNeedsHeadUser.Main)
                    {
                        // Main is changed
                        existingStaffingNeedsHeadUser.Main = staffingNeedsHeadUser.Main;
                        SetModifiedProperties(existingStaffingNeedsHeadUser);
                    }

                    #endregion
                }
                else
                {
                    #region Add

                    StaffingNeedsHeadUser newStaffingNeedsHeadUser = new StaffingNeedsHeadUser()
                    {
                        Main = staffingNeedsHeadUser.Main,

                        // Set FK
                        UserId = staffingNeedsHeadUser.UserId,

                        // Set references
                        StaffingNeedsHead = staffingNeedsHead,
                    };
                    staffingNeedsHead.StaffingNeedsHeadUser.Add(newStaffingNeedsHeadUser);
                    SetCreatedProperties(newStaffingNeedsHeadUser);

                    #endregion
                }
            }

            #region Delete

            // Remove deleted users
            foreach (StaffingNeedsHeadUser existingStaffingNeedsHeadUser in staffingNeedsHead.StaffingNeedsHeadUser.Where(o => o.State == (int)SoeEntityState.Active))
            {
                if (existingStaffingNeedsHeadUser.User == null || !staffingNeedsHeadUserDTOs.Any(u => u.UserId == existingStaffingNeedsHeadUser.User.UserId && u.State == (int)SoeEntityState.Active))
                    ChangeEntityState(existingStaffingNeedsHeadUser, SoeEntityState.Deleted);
            }

            #endregion

            return SaveChanges(entities, transaction);
        }

        private ActionResult SaveStaffingNeedsHeadRows(CompEntities entities, TransactionScope transaction, ref StaffingNeedsHead staffingNeedsHead, StaffingNeedsHeadDTO staffingNeedsHeadDTO, ref List<Tuple<Guid, StaffingNeedsRowPeriod>> periodTuples)
        {
            ActionResult result = null;

            List<StaffingNeedsRow> existingStaffingNeedsRows = staffingNeedsHead.StaffingNeedsRow.Where(r => r.State == (int)SoeEntityState.Active).ToList();

            #region Delete

            foreach (StaffingNeedsRow existingStaffingNeedsRow in existingStaffingNeedsRows)
            {
                if (!staffingNeedsHeadDTO.Rows.Any(r => r.StaffingNeedsRowId == existingStaffingNeedsRow.StaffingNeedsRowId))
                {
                    result = DeleteStaffingNeedsRow(entities, existingStaffingNeedsRow, saveChanges: false);
                    if (!result.Success)
                        return result;
                }
            }

            #endregion

            #region Add/update

            foreach (StaffingNeedsRowDTO rowDTO in staffingNeedsHeadDTO.Rows)
            {
                #region StaffingNeedsRow

                StaffingNeedsRow existingStaffingNeedsRow = existingStaffingNeedsRows.FirstOrDefault(x => x.StaffingNeedsRowId == rowDTO.StaffingNeedsRowId);
                if (existingStaffingNeedsRow == null)
                {
                    existingStaffingNeedsRow = new StaffingNeedsRow()
                    {
                        State = (int)SoeEntityState.Active,

                        //Set FK
                        StaffingNeedsHead = staffingNeedsHead,
                    };
                    SetCreatedProperties(existingStaffingNeedsRow);
                    entities.StaffingNeedsRow.AddObject(existingStaffingNeedsRow);
                }
                else
                {
                    SetModifiedProperties(existingStaffingNeedsRow);
                }

                #region Common

                existingStaffingNeedsRow.Type = (int)rowDTO.Type;
                existingStaffingNeedsRow.Name = rowDTO.Name;

                // If only one shift type exists on all periods, set that shift type on the row, otherwise null
                int? shiftTypeId = rowDTO.ShiftTypeId;
                if (staffingNeedsHeadDTO.Type == StaffingNeedsHeadType.NeedsShifts && rowDTO.Periods.Any() && !rowDTO.Periods.Any(p => !p.ShiftTypeId.HasValue) && rowDTO.Periods.Select(p => p.ShiftTypeId).Distinct().Count() == 1)
                    shiftTypeId = rowDTO.Periods.First().ShiftTypeId;
                existingStaffingNeedsRow.ShiftTypeId = shiftTypeId;

                #endregion

                #endregion

                #region Periods

                List<StaffingNeedsRowPeriod> existingRowPeriods = existingStaffingNeedsRow.StaffingNeedsRowPeriod.Where(x => x.State == (int)SoeEntityState.Active).ToList();

                #region Delete

                foreach (StaffingNeedsRowPeriod existingRowPeriod in existingRowPeriods)
                {
                    if (!rowDTO.Periods.Any(x => x.StaffingNeedsRowPeriodId == existingRowPeriod.StaffingNeedsRowPeriodId))
                    {
                        result = DeleteStaffingNeedsRowPeriod(entities, existingRowPeriod, saveChanges: false);
                        if (!result.Success)
                            return result;
                    }
                }

                #endregion

                #region Add/Update

                foreach (var rowPeriodDTO in rowDTO.Periods)
                {
                    #region StaffingNeedsRowPeriod

                    StaffingNeedsRowPeriod existingStaffingNeedsRowPeriod = existingRowPeriods.FirstOrDefault(x => x.StaffingNeedsRowPeriodId == rowPeriodDTO.StaffingNeedsRowPeriodId);
                    if (existingStaffingNeedsRowPeriod == null)
                    {
                        existingStaffingNeedsRowPeriod = new StaffingNeedsRowPeriod()
                        {
                            State = (int)SoeEntityState.Active,

                            //Set FK
                            StaffingNeedsRow = existingStaffingNeedsRow,
                            ShiftTypeId = rowPeriodDTO.ShiftTypeId.HasValue ? (int)rowPeriodDTO.ShiftTypeId : (int?)null,
                        };

                        SetCreatedProperties(existingStaffingNeedsRowPeriod);
                        entities.StaffingNeedsRowPeriod.AddObject(existingStaffingNeedsRowPeriod);
                    }
                    else
                    {
                        SetModifiedProperties(existingStaffingNeedsRowPeriod);
                    }

                    #region Common

                    existingStaffingNeedsRowPeriod.ShiftTypeId = rowPeriodDTO.ShiftTypeId.HasValue ? (int)rowPeriodDTO.ShiftTypeId : (int?)null;
                    existingStaffingNeedsRowPeriod.Interval = staffingNeedsHeadDTO.Interval;
                    existingStaffingNeedsRowPeriod.Lenght = rowPeriodDTO.Length;
                    existingStaffingNeedsRowPeriod.StartTime = rowPeriodDTO.StartTime;
                    existingStaffingNeedsRowPeriod.IsBreak = rowPeriodDTO.IsBreak;
                    existingStaffingNeedsRowPeriod.Value = rowPeriodDTO.Value;
                    existingStaffingNeedsRowPeriod.IncomingDeliveryRowId = rowPeriodDTO.IncomingDeliveryRowId;
                    existingStaffingNeedsRowPeriod.TimeScheduleTaskId = rowPeriodDTO.TimeScheduleTaskId;
                    existingStaffingNeedsRow.StaffingNeedsRowPeriod.Add(existingStaffingNeedsRowPeriod);

                    #endregion

                    if (rowPeriodDTO.PeriodGuid != Guid.Empty)
                        periodTuples.Add(Tuple.Create(rowPeriodDTO.PeriodGuid, existingStaffingNeedsRowPeriod));

                    #endregion
                }

                #endregion

                #endregion

                #region Frequencys

                List<StaffingNeedsRowFrequency> existingRowFrequencys = existingStaffingNeedsRow.StaffingNeedsRowFrequency.Where(x => x.State == (int)SoeEntityState.Active).ToList();

                #region Delete

                foreach (StaffingNeedsRowFrequency existingRowFrequency in existingRowFrequencys)
                {
                    if (!rowDTO.RowFrequencys.Any(x => x.StaffingNeedsRowFrequencyId == existingRowFrequency.StaffingNeedsRowFrequencyId))
                    {
                        result = DeleteStaffingNeedsRowFrequency(entities, existingRowFrequency, saveChanges: false);
                        if (!result.Success)
                            return result;
                    }
                }

                #endregion

                #region Add/Update

                if (rowDTO.RowFrequencys != null)
                {

                    foreach (var rowFrequencyDTO in rowDTO.RowFrequencys)
                    {
                        #region StaffingNeedsRowFrequency

                        StaffingNeedsRowFrequency existingStaffingNeedsRowFrequency = existingRowFrequencys.FirstOrDefault(x => x.StaffingNeedsRowFrequencyId == rowFrequencyDTO.StaffingNeedsRowFrequencyId);
                        if (existingStaffingNeedsRowFrequency == null)
                        {
                            existingStaffingNeedsRowFrequency = new StaffingNeedsRowFrequency()
                            {
                                State = (int)SoeEntityState.Active,
                                StartTime = CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, rowFrequencyDTO.StartTime),

                                //Set FK
                                StaffingNeedsRow = existingStaffingNeedsRow,
                                ShiftTypeId = rowFrequencyDTO.ShiftTypeId.HasValue ? (int)rowFrequencyDTO.ShiftTypeId : (int?)null,
                            };
                            SetCreatedProperties(existingStaffingNeedsRowFrequency);
                            entities.StaffingNeedsRowFrequency.AddObject(existingStaffingNeedsRowFrequency);
                        }
                        else
                        {
                            SetModifiedProperties(existingStaffingNeedsRowFrequency);
                        }

                        #region Common

                        existingStaffingNeedsRowFrequency.ShiftTypeId = rowFrequencyDTO.ShiftTypeId.HasValue ? (int)rowFrequencyDTO.ShiftTypeId : (int?)null;
                        existingStaffingNeedsRowFrequency.Interval = staffingNeedsHeadDTO.Interval;
                        existingStaffingNeedsRowFrequency.StartTime = CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, rowFrequencyDTO.StartTime);
                        existingStaffingNeedsRowFrequency.Value = rowFrequencyDTO.Value;

                        existingStaffingNeedsRow.StaffingNeedsRowFrequency.Add(existingStaffingNeedsRowFrequency);

                        #endregion
                        #endregion
                    }
                }

                #endregion

                #endregion
            }

            result = SaveChanges(entities, transaction, useBulkSaveChanges: true);
            if (!result.Success)
                return result;

            #endregion

            return result;
        }

        public ActionResult DeleteStaffingNeedsHead(int staffingNeedsHeadId, int actorCompanyId)
        {
            ActionResult result = null;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        result = DeleteStaffingNeedsHead(entities, staffingNeedsHeadId, actorCompanyId, false);
                        if (!result.Success)
                            return result;

                        result = SaveChanges(entities, transaction);

                        //Commit transaction
                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result.Exception = ex;
                    result.IntegerValue = 0;
                }
                finally
                {
                    if (result.Success)
                    {
                        //Set success properties                       
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        private ActionResult DeleteStaffingNeedsHead(CompEntities entities, int staffingNeedsHeadId, int actorCompanyId, bool saveChanges)
        {
            StaffingNeedsHead head = GetStaffingNeedsHead(entities, staffingNeedsHeadId, actorCompanyId, false, true, true, true);
            if (head == null)
                return new ActionResult((int)ActionResultSave.EntityNotFound, "StaffingNeedsHead");

            ActionResult result = ChangeEntityState(head, SoeEntityState.Deleted);
            if (!result.Success)
                return result;

            if (saveChanges)
            {
                result = SaveChanges(entities);
                if (!result.Success)
                    return result;
            }

            foreach (StaffingNeedsRow staffingNeedsRow in head.StaffingNeedsRow)
            {
                result = DeleteStaffingNeedsRow(entities, staffingNeedsRow, saveChanges);
                if (!result.Success)
                    return result;
            }

            return result;
        }

        #endregion

        #region StaffingNeedsRow / StaffingNeedsRowPeriod

        public List<StaffingNeedsRowDTO> CreateStaffingNeedsRowsAndPeriodsFromScheduleTasks(int interval, List<TimeScheduleTaskDTO> timeScheduleTaskDTOs)
        {
            StaffingNeedsCalculationEngine staffingNeedsCalculationEngine = new StaffingNeedsCalculationEngine(GetTimeBreakTemplates(base.ActorCompanyId).ToDTOs().ToList(), parameterObject);
            StaffingNeedsCalculationInput input = new StaffingNeedsCalculationInput(interval, timeScheduleTaskDTOs: timeScheduleTaskDTOs);
            staffingNeedsCalculationEngine.GenerateStaffingNeedsRows(input);

            return staffingNeedsCalculationEngine.StaffingNeedsRowDTOs;
        }

        public List<StaffingNeedsRowDTO> CreateStaffingNeedsRowsAndPeriodsFromIncomingDeliveryHeads(int interval, List<IncomingDeliveryHeadDTO> incomingDeliveryHeadDTOs)
        {
            StaffingNeedsCalculationEngine staffingNeedsCalculationEngine = new StaffingNeedsCalculationEngine(GetTimeBreakTemplates(base.ActorCompanyId).ToDTOs().ToList(), parameterObject);
            StaffingNeedsCalculationInput input = new StaffingNeedsCalculationInput(interval, incomingDeliveryHeadDTOs: incomingDeliveryHeadDTOs);
            staffingNeedsCalculationEngine.GenerateStaffingNeedsRows(input);

            return staffingNeedsCalculationEngine.StaffingNeedsRowDTOs;
        }

        public List<StaffingNeedsRowDTO> CreateStaffingeNeedsRowsAndPeriods(int actorCompanyId, int interval, List<TimeScheduleTaskDTO> timeScheduleTaskDTOs, List<IncomingDeliveryHeadDTO> incomingDeliveryHeadDTOs, List<StaffingNeedsAnalysisChartData> staffingNeedsAnalysisChartData, out List<StaffingNeedsRowFrequencyDTO> staffingNeedsRowFrequencyDTOs, int? shiftTypeId = null, int? timeScheduleTaskId = null, List<TimeBreakTemplateDTO> timeBreakTemplates = null)
        {
            List<StaffingNeedsLocationGroupDTO> staffingNeedsLocationGroupDTOs = null;
            staffingNeedsRowFrequencyDTOs = new List<StaffingNeedsRowFrequencyDTO>();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<ShiftTypeDTO> shiftTypes = base.GetShiftTypesFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId), loadSkills: true).ToDTOs(includeSkills: true, includeShiftTypeLinkIds: true, links: base.GetShiftTypeLinksFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId))).ToList();

            if (staffingNeedsAnalysisChartData != null)
            {
                if (timeScheduleTaskId.HasValue)
                    staffingNeedsLocationGroupDTOs = GetStaffingNeedsGroupFromTimeScheduleTask(timeScheduleTaskId.Value, actorCompanyId).ToDTOs(false).ToList();
                else
                    staffingNeedsLocationGroupDTOs = GetStaffingNeedsLocationGroups(actorCompanyId).ToDTOs(false).ToList();
            }

            if (timeScheduleTaskDTOs == null)
            {
                if (timeScheduleTaskId.HasValue)
                    timeScheduleTaskDTOs = GetTimeScheduleTasks(actorCompanyId).ToDTOs(false).Where(f => f.TimeScheduleTaskId == timeScheduleTaskId).ToList();
                else
                    timeScheduleTaskDTOs = GetTimeScheduleTasks(actorCompanyId).ToDTOs(false).ToList();
            }

            StaffingNeedsCalculationInput input = new StaffingNeedsCalculationInput(interval, timeScheduleTaskDTOs: timeScheduleTaskDTOs, incomingDeliveryHeadDTOs: incomingDeliveryHeadDTOs, staffingNeedsAnalysisChartData: staffingNeedsAnalysisChartData, shiftTypeDTOs: shiftTypes.ToList(), staffingNeedsLocationGroupDTOs: staffingNeedsLocationGroupDTOs, shiftTypeId: shiftTypeId);
            input.ForceIncludeTimeScheduleTaskItems = true;
            StaffingNeedsCalculationEngine staffingNeedsCalculationEngine = new StaffingNeedsCalculationEngine(timeBreakTemplates ?? GetTimeBreakTemplates(base.ActorCompanyId).ToDTOs().ToList(), parameterObject);
            staffingNeedsCalculationEngine.GenerateStaffingNeedsRows(input);
            staffingNeedsRowFrequencyDTOs = staffingNeedsCalculationEngine.StaffingNeedsRowFrequencyDTOs;

            return staffingNeedsCalculationEngine.StaffingNeedsRowDTOs;
        }

        public List<TimeScheduleTaskGeneratedNeedDTO> GetTimeScheduleTaskGeneratedNeeds(int timeScheduleTaskId)
        {
            //date is not used for now

            TimeScheduleTaskDTO task = GetTimeScheduleTask(timeScheduleTaskId, base.ActorCompanyId).ToDTO(false);
            if (task == null)
                return new List<TimeScheduleTaskGeneratedNeedDTO>();

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.StaffingNeedsRowPeriod.NoTracking();
            entitiesReadOnly.StaffingNeedsRow.NoTracking();
            entitiesReadOnly.StaffingNeedsHead.NoTracking();

            List<TimeScheduleTaskGeneratedNeedDTO> generatedNeedDTOs = new List<TimeScheduleTaskGeneratedNeedDTO>();
            List<StaffingNeedsRowPeriod> staffingNeedsRowPeriods = (from p in entitiesReadOnly.StaffingNeedsRowPeriod
                                                                                  .Include("StaffingNeedsRow.StaffingNeedsHead")
                                                                    where p.TimeScheduleTaskId == timeScheduleTaskId &&
                                                                    p.State == (int)SoeEntityState.Active
                                                                    select p).ToList();

            foreach (var period in staffingNeedsRowPeriods)
            {
                if (period.StaffingNeedsRow.State == (int)SoeEntityState.Active && period.StaffingNeedsRow.StaffingNeedsHead.State == (int)SoeEntityState.Active)
                {
                    var dto = new TimeScheduleTaskGeneratedNeedDTO();
                    dto.StaffingNeedsRowPeriodId = period.StaffingNeedsRowPeriodId;
                    dto.StaffingNeedsRowId = period.StaffingNeedsRowId;
                    dto.StartTime = period.StartTime;
                    dto.StopTime = dto.StartTime.AddMinutes(period.Lenght);
                    dto.Date = period.StaffingNeedsRow.StaffingNeedsHead.Date;
                    dto.WeekDay = period.StaffingNeedsRow.StaffingNeedsHead.Weekday.HasValue ? (DayOfWeek)period.StaffingNeedsRow.StaffingNeedsHead.Weekday.Value : (DayOfWeek?)null;

                    if (dto.Date.HasValue)
                        dto.Occurs = dto.Date.Value.ToShortDateString();
                    else if (dto.WeekDay.HasValue)
                        dto.Occurs = CalendarManager.GetDayOfWeek(dto.WeekDay.Value);

                    if (task.IsSpecificNeed())
                        dto.Type = GetText(9986, "Förändrat behov");
                    else
                        dto.Type = GetText(9985, "Grundbehov");

                    generatedNeedDTOs.Add(dto);
                }
            }

            return generatedNeedDTOs;
        }

        public ActionResult DeleteGeneratedNeeds(List<int> staffingNeedsRowPeriodIds)
        {
            ActionResult result;
            using (CompEntities entities = new CompEntities())
            {
                List<StaffingNeedsRowPeriod> staffingNeedsRowPeriods = (from p in entities.StaffingNeedsRowPeriod
                                                                        where staffingNeedsRowPeriodIds.Contains(p.StaffingNeedsRowPeriodId) &&
                                                                        p.State == (int)SoeEntityState.Active
                                                                        select p).ToList();

                foreach (var staffingNeedsRowPeriod in staffingNeedsRowPeriods)
                {
                    result = ChangeEntityState(staffingNeedsRowPeriod, SoeEntityState.Deleted);
                    if (!result.Success)
                        return result;

                    StaffingNeedsRow staffingNeedsRow = (from r in entities.StaffingNeedsRow
                                                                            .Include("StaffingNeedsRowPeriod")
                                                         where r.StaffingNeedsRowId == staffingNeedsRowPeriod.StaffingNeedsRowId &&
                                                         r.State == (int)SoeEntityState.Active
                                                         select r).FirstOrDefault();

                    if (staffingNeedsRow != null && !staffingNeedsRow.StaffingNeedsRowPeriod.Any(x => x.State == (int)SoeEntityState.Active && x.StaffingNeedsRowPeriodId != staffingNeedsRowPeriod.StaffingNeedsRowPeriodId))
                    {
                        result = ChangeEntityState(staffingNeedsRow, SoeEntityState.Deleted);
                        if (!result.Success)
                            return result;

                        StaffingNeedsHead staffingNeedsHead = (from h in entities.StaffingNeedsHead
                                                                           .Include("StaffingNeedsRow")
                                                               where h.StaffingNeedsHeadId == staffingNeedsRow.StaffingNeedsHeadId &&
                                                               h.State == (int)SoeEntityState.Active
                                                               select h).FirstOrDefault();

                        if (staffingNeedsHead != null && !staffingNeedsHead.StaffingNeedsRow.Any(x => x.State == (int)SoeEntityState.Active && x.StaffingNeedsRowId != staffingNeedsRow.StaffingNeedsRowId))
                        {
                            result = ChangeEntityState(staffingNeedsHead, SoeEntityState.Deleted);
                            if (!result.Success)
                                return result;
                        }
                    }
                }

                result = SaveChanges(entities);
                if (!result.Success)
                    return result;
            }
            return new ActionResult(true);
        }

        private ActionResult DeleteStaffingNeedsRow(CompEntities entities, StaffingNeedsRow staffingNeedsRow, bool saveChanges)
        {
            ActionResult result = ChangeEntityState(staffingNeedsRow, SoeEntityState.Deleted);
            if (!result.Success)
                return result;

            if (saveChanges)
            {
                result = SaveChanges(entities);
                if (!result.Success)
                    return result;
            }

            foreach (StaffingNeedsRowPeriod staffingNeedsRowPeriod in staffingNeedsRow.StaffingNeedsRowPeriod)
            {
                result = DeleteStaffingNeedsRowPeriod(entities, staffingNeedsRowPeriod, saveChanges);
                if (!result.Success)
                    return result;
            }

            return result;
        }

        private ActionResult DeleteStaffingNeedsRowPeriod(CompEntities entities, StaffingNeedsRowPeriod staffingNeedsRowPeriod, bool saveChanges)
        {
            ActionResult result = ChangeEntityState(staffingNeedsRowPeriod, SoeEntityState.Deleted);
            if (!result.Success)
                return result;

            if (saveChanges)
            {
                result = SaveChanges(entities);
                if (!result.Success)
                    return result;
            }

            return result;
        }

        private ActionResult DeleteStaffingNeedsRowFrequency(CompEntities entities, StaffingNeedsRowFrequency staffingNeedsRowFrequency, bool saveChanges)
        {
            ActionResult result = ChangeEntityState(staffingNeedsRowFrequency, SoeEntityState.Deleted);
            if (!result.Success)
                return result;

            if (saveChanges)
            {
                result = SaveChanges(entities);
                if (!result.Success)
                    return result;
            }

            return result;
        }

        #endregion

        #region EmployeePost

        public ActionResult CreateEmptyScheduleForEmployeePost(int actorCompanyId, int employeePostId, DateTime fromDate)
        {
            return CreateEmptyScheduleForEmployeePosts(actorCompanyId, new List<int>() { employeePostId }, fromDate);
        }

        public ActionResult CreateEmptyScheduleForEmployeePosts(int actorCompanyId, List<int> employeePostIds, DateTime fromDate)
        {
            ActionResult result = new ActionResult(true)
            {
                Keys = new List<int>()
            };

            try
            {
                #region Prereq

                // Get all employee posts to be able to calculate least common number of weeks
                List<EmployeePostDTO> allEmployeePosts = GetEmployeePosts(actorCompanyId, true, loadRelations: true).ToDTOs(true).ToList();

                int firstCommonNumberOfWeeks = StaffingNeedsCalculationEngine.GetFirstCommonNumberOfWeeks(allEmployeePosts);
                int days = (int)Decimal.Multiply(firstCommonNumberOfWeeks, 7);

                #endregion

                #region Create templates

                TimeEngineManager tem = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);
                foreach (int employeePostId in employeePostIds)
                {
                    ActionResult res = tem.SaveTimeScheduleTemplateAndPlacement(true, false, null, new List<TimeSchedulePlanningDayDTO>(), 0, days, fromDate, null, fromDate, null, null, fromDate, employeePostId: employeePostId);
                    // Add successful ids to list
                    if (res.Success)
                        result.Keys.Add(employeePostId);
                    else
                        result.Success = false;
                }

                #endregion
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Success = false;
                result.ErrorMessage = ex.Message;
            }

            return result;
        }

        public List<TimeSchedulePlanningDayDTO> CreateScheduleFromEmployeePost(int actorCompanyId, int employeePostId, DateTime fromDate)
        {
            SoeProgressInfo info = new SoeProgressInfo(Guid.NewGuid());
            return CreateScheduleFromEmployeePosts(actorCompanyId, new List<int>() { employeePostId }, fromDate, ref info);
        }

        public PreAnalysisInformation GetPreAnalysisInformation(int actorCompanyId, int employeePostId, DateTime fromDate, ref SoeProgressInfo info)
        {
            #region Prereq

            info.Message = GetText(11649, "Hämtar förutsättningar");
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            List<EmployeePostDTO> allEmployeePosts = GetEmployeePosts(actorCompanyId, true, loadRelations: true).ToDTOs(true).ToList();

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);
                if (!accountIds.IsNullOrEmpty())
                    allEmployeePosts = allEmployeePosts.Where(t => t.AccountId.HasValue && accountIds.Contains(t.AccountId.Value)).ToList();
                else
                    return new PreAnalysisInformation();
            }

            EmployeePostDTO selectedEmployeePost = allEmployeePosts.FirstOrDefault(e => e.Status != SoeEmployeePostStatus.Locked && employeePostId == e.EmployeePostId);
            if (selectedEmployeePost == null)
                return new PreAnalysisInformation();

            List<TimeBreakTemplateDTO> breakTemplates = GetTimeBreakTemplates(actorCompanyId).ToDTOs().ToList();
            List<TimeCodeBreakDTO> timeCodeBreaks = TimeCodeManager.GetTimeCodes(actorCompanyId, SoeTimeCodeType.Break, loadPayrollProducts: false).OfType<TimeCode>().ToList().ToBreakDTOs();
            var ruleDTOs = TimeScheduleManager.GetScheduleCycleWithRulesAndRuleTypesFromCompany(actorCompanyId).ToDTOs().SelectMany(s => s.ScheduleCycleRuleDTOs).Distinct().ToList();
            StaffingNeedsCalculationStartEngine staffingNeedsCalculationStartEngine = new StaffingNeedsCalculationStartEngine(breakTemplates, timeCodeBreaks, ruleDTOs);
            int firstCommonNumberOfWeeks = StaffingNeedsCalculationEngine.GetFirstCommonNumberOfWeeks(allEmployeePosts);
            int daysForward = firstCommonNumberOfWeeks * 7;

            List<TimeScheduleTaskDTO> timeScheduleTasks = GetTimeScheduleTasks(actorCompanyId, fromDate, fromDate.AddDays(daysForward), loadType: true, loadShiftType: true, doIncludeRemovedDates: true, loadAccounting: true).ToDTOs(true).ToList();
            List<OpeningHoursDTO> openingHours = CalendarManager.GetOpeningHoursForCompany(actorCompanyId).ToDTOs();
            List<IncomingDeliveryHeadDTO> incomingDeliveryHeads = GetIncomingDeliveries(actorCompanyId, fromDate, fromDate.AddDays(daysForward), doIncludeRemovedDates: true, loadRows: true, loadAccounting: true).ToDTOs(true, true).ToList();
            List<int> shiftTypeIds = timeScheduleTasks.Where(w => w.ShiftTypeId.HasValue).Select(s => s.ShiftTypeId.Value).ToList();
            shiftTypeIds.AddRange(incomingDeliveryHeads.SelectMany(s => s.Rows.Where(w => w.ShiftTypeId.HasValue).Select(ss => ss.ShiftTypeId.Value)));
            shiftTypeIds = shiftTypeIds.Distinct().ToList();
            List<TimeSchedulePlanningDayDTO> shifts = GetTemplateShiftsForEmployeePost(actorCompanyId, 0, 0, fromDate, fromDate.AddDays(daysForward), false, allEmployeePosts.Select(i => i.EmployeePostId).ToList(), false);
            List<ShiftTypeDTO> shiftTypes = GetShiftTypes(actorCompanyId, loadAccounts: false, loadSkills: true, loadEmployeeStatisticsTargets: false, setTimeScheduleTemplateBlockTypeName: false, setCategoryNames: false, shiftTypeIds: shiftTypeIds).ToDTOs(includeAccounts: true, includeSkills: true, includeShiftTypeLinkIds: true).ToList();
            int timeCodeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeDefaultTimeCode, 0, actorCompanyId, 0);
            int interval = GetStaffingNeedsIntervalMinutes(actorCompanyId, 1);

            #endregion

            #region Get StaffingNeedsHead for all WeekDays

            List<StaffingNeedsHeadDTO> staffingneedsFromTasksAndDeliveries = GenerateStaffingNeedsHeads(TermGroup_StaffingNeedHeadsFilterType.BaseNeed, StaffingNeedsHeadType.NeedsPlanning, fromDate, fromDate.AddDays(6));
            List<StaffingNeedsHead> staffingNeedsFromShift = GetStaffingNeedsHeads(actorCompanyId, StaffingNeedsHeadType.NeedsShifts);

            // Will pick all StaffingNeedsHeads for every day of the week.
            List<StaffingNeedsHeadDTO> validStaffingNeedsFromShift = new List<StaffingNeedsHeadDTO>();
            foreach (DayOfWeek dayOfWeek in EnumUtility.GetValues<DayOfWeek>())
                validStaffingNeedsFromShift.AddRange(staffingNeedsFromShift.Filter(dayOfWeek, fromDate).OrderBy(h => h.FromDate).ToDTOs(true, true, true, false));

            #endregion

            #region Calculate

            EmployeePostCalculationOutput calculationOutput = staffingNeedsCalculationStartEngine.GeneratePreAnalysisInformation(actorCompanyId, staffingneedsFromTasksAndDeliveries, validStaffingNeedsFromShift, shifts, selectedEmployeePost, allEmployeePosts, shiftTypes, timeCodeId, fromDate, interval, ref info, timeScheduleTasks: timeScheduleTasks, incomingDeliverys: incomingDeliveryHeads, parameterObject: parameterObject, openingHours: openingHours);

            return calculationOutput.PreAnalysisInformation;

            #endregion
        }

        public List<TimeSchedulePlanningDayDTO> CreateScheduleFromEmployeePosts(int actorCompanyId, List<int> employeePostIds, DateTime fromDate, ref SoeProgressInfo info, SoeMonitor monitor = null, Guid? threadGuid = null)
        {
            List<TimeSchedulePlanningDayDTO> schedule = new List<TimeSchedulePlanningDayDTO>();

            try
            {
                #region Prereq

                info.Message = GetText(11649, "Hämtar förutsättningar");

                if (employeePostIds == null || employeePostIds.Count == 0)
                    return schedule;

                employeePostIds = employeePostIds.Where(employeePostId => employeePostId > 0).ToList();
                DateTime StartTime = DateTime.Now;
                LogInfo($"CreateScheduleFromEmployeePosts actorCompanyId {actorCompanyId} employeeids {employeePostIds.JoinToString(",")} fromdate {fromDate} started {StartTime}");

                List<EmployeePostDTO> allEmployeePosts = GetEmployeePosts(actorCompanyId, true, loadRelations: true).ToDTOs(true).ToList();
                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
                int? accountId = null;
                if (useAccountHierarchy)
                {
                    var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);
                    if (!accountIds.IsNullOrEmpty())
                    {
                        if (accountIds.Count > 1)
                            new List<TimeSchedulePlanningDayDTO>();

                        accountId = accountIds.First();
                        allEmployeePosts = allEmployeePosts.Where(t => t.AccountId.HasValue && accountIds.Contains(t.AccountId.Value)).ToList();
                    }
                    else
                        return new List<TimeSchedulePlanningDayDTO>();
                }

                List<EmployeePostDTO> selectedEmployeePosts = allEmployeePosts.Where(e => e.Status != SoeEmployeePostStatus.Locked && employeePostIds.Contains(e.EmployeePostId)).ToList();
                if (selectedEmployeePosts.Count == 0)
                    return schedule;

                List<TimeBreakTemplateDTO> breakTemplates = GetTimeBreakTemplates(actorCompanyId).ToDTOs().ToList();
                List<TimeCodeBreakDTO> timeCodeBreaks = TimeCodeManager.GetTimeCodes(actorCompanyId, SoeTimeCodeType.Break, loadPayrollProducts: false).OfType<TimeCode>().ToList().ToBreakDTOs();
                var ruleDTOs = TimeScheduleManager.GetScheduleCycleWithRulesAndRuleTypesFromCompany(actorCompanyId).ToDTOs().SelectMany(s => s.ScheduleCycleRuleDTOs).Distinct().ToList();
                StaffingNeedsCalculationStartEngine staffingNeedsCalculationStartEngine = new StaffingNeedsCalculationStartEngine(breakTemplates, timeCodeBreaks, ruleDTOs);
                int firstCommonNumberOfWeeks = StaffingNeedsCalculationEngine.GetFirstCommonNumberOfWeeks(allEmployeePosts);
                int daysForward = firstCommonNumberOfWeeks * 7;

                // Delete existing schedule for EmployeePost
                ActionResult result = DeleteShiftsFromEmployeePosts(actorCompanyId, selectedEmployeePosts.Select(i => i.EmployeePostId).ToList());
                if (!result.Success)
                    return schedule;

                int currentEmployeeId = EmployeeManager.GetEmployeeIdForUser(parameterObject.UserId, actorCompanyId);

                List<TimeScheduleTaskDTO> timeScheduleTasks = GetTimeScheduleTasks(actorCompanyId, fromDate, fromDate.AddDays(daysForward), loadType: true, loadShiftType: true, doIncludeRemovedDates: true, loadAccounting: true).ToDTOs(true).ToList();
                List<OpeningHoursDTO> openingHours = CalendarManager.GetOpeningHoursForCompany(actorCompanyId).ToDTOs();
                List<IncomingDeliveryHeadDTO> incomingDeliveryHeads = GetIncomingDeliveries(actorCompanyId, fromDate, fromDate.AddDays(daysForward), doIncludeRemovedDates: true, loadRows: true, loadAccounting: true).ToDTOs(true, true).ToList();
                List<int> shiftTypeIds = timeScheduleTasks.Where(w => w.ShiftTypeId.HasValue).Select(s => s.ShiftTypeId.Value).ToList();
                shiftTypeIds.AddRange(incomingDeliveryHeads.SelectMany(s => s.Rows.Where(w => w.ShiftTypeId.HasValue).Select(ss => ss.ShiftTypeId.Value)));
                shiftTypeIds = shiftTypeIds.Distinct().ToList();
                List<ShiftTypeDTO> shiftTypes = GetShiftTypes(actorCompanyId, loadAccounts: true, loadSkills: true, loadEmployeeStatisticsTargets: false, setTimeScheduleTemplateBlockTypeName: false, setCategoryNames: false, shiftTypeIds: shiftTypeIds).ToDTOs(includeAccounts: true, includeSkills: true, includeShiftTypeLinkIds: true).ToList();
                List<TimeSchedulePlanningDayDTO> shifts = GetTemplateShiftsForEmployeePost(actorCompanyId, 0, 0, fromDate, fromDate.AddDays(daysForward), false, allEmployeePosts.Select(i => i.EmployeePostId).ToList(), false);
                int timeCodeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeDefaultTimeCode, 0, actorCompanyId, 0);
                int interval = GetStaffingNeedsIntervalMinutes(actorCompanyId, 1);

                #endregion

                #region Get StaffingNeedsHead for all WeekDays

                List<StaffingNeedsHeadDTO> staffingneedsFromTasksAndDeliveries = GenerateStaffingNeedsHeads(TermGroup_StaffingNeedHeadsFilterType.BaseNeed, StaffingNeedsHeadType.NeedsPlanning, fromDate, fromDate.AddDays(6));
                List<StaffingNeedsHead> staffingNeedsFromShift = GetStaffingNeedsHeads(actorCompanyId, StaffingNeedsHeadType.NeedsShifts);

                // Will pick all StaffingNeedsHeads for every day of the week.
                List<StaffingNeedsHeadDTO> validStaffingNeedsFromShift = new List<StaffingNeedsHeadDTO>();
                foreach (DayOfWeek dayOfWeek in EnumUtility.GetValues<DayOfWeek>())
                    validStaffingNeedsFromShift.AddRange(staffingNeedsFromShift.Filter(dayOfWeek, fromDate).OrderBy(h => h.FromDate).ToDTOs(true, true, true, false));

                #endregion

                #region Calculate

                info.Message = GetText(11650, "Beräkning påbörjad");

                EmployeePostCalculationOutput calculationOutput = staffingNeedsCalculationStartEngine.GenerateScheduleForEmployeePosts(actorCompanyId, staffingneedsFromTasksAndDeliveries, validStaffingNeedsFromShift, shifts, selectedEmployeePosts, allEmployeePosts, shiftTypes, timeCodeId, fromDate, interval, ref info, timeScheduleTasks: timeScheduleTasks, incomingDeliverys: incomingDeliveryHeads, parameterObject: parameterObject, openingHours: openingHours);
                if (calculationOutput != null && calculationOutput.EmployeePostCycles != null && !info.Abort)
                {
                    List<CalculationPeriodItem> calculatedPeriodItems = new List<CalculationPeriodItem>();
                    foreach (EmployeePostCycle employeePostCycle in calculationOutput.EmployeePostCycles)
                    {
                        foreach (EmployeePostWeek employeePostWeeks in employeePostCycle.EmployeePostWeeks.Where(i => !i.IsCopy))
                        {
                            foreach (EmployeePostDay employeePostDay in employeePostWeeks.EmployeePostDays)
                            {
                                calculatedPeriodItems.AddRange(employeePostDay.SelectedItemsHead.CalculationPeriodItems);
                            }
                        }
                    }

                    info.Message = GetText(11651, "Generering pågår");

                    LogInfo($"Save ScheduleFromEmployeePosts actorCompanyId {actorCompanyId} employeeids {employeePostIds.JoinToString()} fromdate {fromDate} started {StartTime}");

                    if (calculatedPeriodItems.Count > 0)
                    {
                        List<TimeSchedulePlanningDayDTO> calculatedShifts = new List<TimeSchedulePlanningDayDTO>();
                        foreach (EmployeePostCycle employeePostCycle in calculationOutput.EmployeePostCycles)
                        {
                            if (accountId.HasValue)
                                employeePostCycle.Shifts.ForEach(f => f.AccountId = accountId);
                            calculatedShifts.AddRange(employeePostCycle.Shifts);
                        }

                        LogInfo($"SaveStaffingNeedsHead begin ScheduleFromEmployeePosts actorCompanyId {actorCompanyId} employeeids {employeePostIds.JoinToString()} fromdate {fromDate} started {StartTime}");
                        result = SaveStaffingNeedsHead(calculatedPeriodItems, calculatedShifts, actorCompanyId);
                        LogInfo($"SaveStaffingNeedsHead done ScheduleFromEmployeePosts actorCompanyId {actorCompanyId} employeeids {employeePostIds.JoinToString()} fromdate {fromDate} started {StartTime}");

                        if (result.Success)
                        {
                            TimeEngineManager tem = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);

                            var employeePostIdInShifts = calculatedShifts.Select(s => s.EmployeePostId).Distinct().ToList();
                            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                            var existingHeads = entitiesReadOnly.TimeScheduleTemplateHead.Where(w => employeePostIdInShifts.Contains(w.EmployeePostId) && w.StartDate == fromDate && w.State == (int)SoeEntityState.Active);

                            foreach (var shiftsGroupedByEmployeePost in calculatedShifts.Where(i => i.EmployeePostId.HasValue).GroupBy(i => i.EmployeePostId))
                            {
                                if (shiftsGroupedByEmployeePost.All(a => a.TimeScheduleTemplateHeadId == 0) && existingHeads.Any(a => a.EmployeePostId == shiftsGroupedByEmployeePost.Key))
                                {
                                    var exc = new Exception("CreateScheduleFromEmployeePosts Multiple simultaneous Runs - Check results - Duplicates possible EmployeeId " + shiftsGroupedByEmployeePost.Key.ToString() + " fromDate " + fromDate.ToString());
                                    LogError(exc, log);
                                    throw exc;
                                }
                            }

                            foreach (var shiftsGroupedByEmployeePost in calculatedShifts.Where(i => i.EmployeePostId.HasValue).GroupBy(i => i.EmployeePostId))
                            {
                                EmployeePostDTO employeePost = selectedEmployeePosts.FirstOrDefault(p => p.EmployeePostId == shiftsGroupedByEmployeePost.Key);
                                if (employeePost != null)
                                {
                                    int days = employeePost.ScheduleCycleDTO != null ? (int)decimal.Multiply(employeePost.ScheduleCycleDTO.NbrOfWeeks, 7) : 7;
                                    result = tem.SaveTimeScheduleTemplateAndPlacement(true, false, null, shiftsGroupedByEmployeePost.ToList(), 0, days, fromDate, null, fromDate, null, null, fromDate, employeePostId: employeePost.EmployeePostId);
                                    if (result.Success)
                                    {
                                        List<TimeSchedulePlanningDayDTO> scheduleForEmployeePost = GetTimeSchedulePlanningTemplate(actorCompanyId, parameterObject.RoleId, parameterObject.UserId, currentEmployeeId, result.IntegerValue, fromDate, fromDate.AddDays(6), loadTasksAndDelivery: true).ToList();
                                        if (scheduleForEmployeePost != null)
                                            schedule.AddRange(scheduleForEmployeePost);
                                    }
                                }
                            }
                        }

                        LogInfo($"SaveTimeScheduleTemplateAndPlacement done ScheduleFromEmployeePosts actorCompanyId {actorCompanyId} employeeids {employeePostIds.JoinToString()} fromdate {fromDate} started {StartTime}");
                    }
                }

                #endregion
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                schedule = new List<TimeSchedulePlanningDayDTO>();
                info.Abort = true;
                info.Error = true;
                info.ErrorMessage = "Failed";
            }

            info.Done = true;
            return employeePostIds.Count == 1 ? schedule : new List<TimeSchedulePlanningDayDTO>();
        }

        public ActionResult ChangeEmployeePostStatus(int employeePostId, SoeEmployeePostStatus status)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                EmployeePost employeePost = GetEmployeePost(entities, employeePostId);
                if (employeePost == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "EmployeePost");

                if (employeePost.Status != (int)status)
                {
                    employeePost.Status = (int)status;
                    SetModifiedProperties(employeePost);
                    result = SaveChanges(entities);
                }
            }

            return result;
        }

        public ActionResult DeleteShiftsFromEmployeePost(int actorCompanyId, int employeePostId)
        {
            return DeleteShiftsFromEmployeePosts(actorCompanyId, new List<int> { employeePostId });
        }

        public ActionResult DeleteShiftsFromEmployeePosts(int actorCompanyId, List<int> employeePostIds)
        {
            ActionResult result = new ActionResult();

            List<int> handledEmployeePostIds = new List<int>();

            try
            {
                using (CompEntities entities = new CompEntities())
                {
                    entities.CommandTimeout = 300;

                    foreach (int employeePostId in employeePostIds)
                    {
                        List<int> staffingNeedsRowPeriodIds = new List<int>();

                        #region EmployeePost

                        EmployeePost employeePost = GetEmployeePost(entities, employeePostId);
                        if (employeePost == null)
                            return new ActionResult((int)ActionResultDelete.EntityNotFound, "EmployeePost");

                        if (employeePost.Status == (int)SoeEmployeePostStatus.Locked)
                            continue;

                        #region TimeScheduleTemplateHead / TimeScheduleTemplatePeriod / TimeScheduleTemplateBlock

                        List<TimeScheduleTemplateHead> templateHeads = (from t in entities.TimeScheduleTemplateHead
                                                                            .Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateBlock.TimeScheduleTemplateBlockTask")
                                                                        where t.ActorCompanyId == actorCompanyId &&
                                                                        t.EmployeePostId == employeePostId &&
                                                                        !t.EmployeeId.HasValue &&
                                                                        t.State == (int)SoeEntityState.Active
                                                                        select t).ToList();

                        if (templateHeads.Count == 0)
                            continue;

                        foreach (TimeScheduleTemplateHead templateHead in templateHeads)
                        {
                            foreach (TimeScheduleTemplatePeriod templatePeriod in templateHead.TimeScheduleTemplatePeriod)
                            {
                                foreach (TimeScheduleTemplateBlock templateBlock in templatePeriod.TimeScheduleTemplateBlock)
                                {
                                    result = ChangeEntityState(entities, templateBlock, SoeEntityState.Deleted, saveChanges: false);
                                    if (!result.Success)
                                        return result;

                                    if (templateBlock.StaffingNeedsRowPeriodId.HasValue)
                                        staffingNeedsRowPeriodIds.Add(templateBlock.StaffingNeedsRowPeriodId.Value);

                                    foreach (TimeScheduleTemplateBlockTask timeScheduleTemplateBlockTask in templateBlock.TimeScheduleTemplateBlockTask)
                                    {
                                        result = ChangeEntityState(entities, timeScheduleTemplateBlockTask, SoeEntityState.Deleted, saveChanges: false);
                                        if (!result.Success)
                                            return result;
                                    }
                                }
                                result = ChangeEntityState(entities, templatePeriod, SoeEntityState.Deleted, saveChanges: false);
                                if (!result.Success)
                                    return result;
                            }
                            result = ChangeEntityState(entities, templateHead, SoeEntityState.Deleted, saveChanges: false);
                            if (!result.Success)
                                return result;
                        }

                        #endregion

                        #region StaffingNeedsRowPeriod

                        List<StaffingNeedsRowPeriod> staffingNeedsRowPeriods = (from s in entities.StaffingNeedsRowPeriod
                                                                                    .Include("StaffingNeedsRow.StaffingNeedsHead")
                                                                                where staffingNeedsRowPeriodIds.Contains(s.StaffingNeedsRowPeriodId)
                                                                                select s).ToList();

                        foreach (StaffingNeedsRowPeriod staffingNeedsRowPeriod in staffingNeedsRowPeriods)
                        {
                            result = ChangeEntityState(entities, staffingNeedsRowPeriod, SoeEntityState.Deleted, saveChanges: false);
                            if (!result.Success)
                                return result;

                            result = ChangeEntityState(entities, staffingNeedsRowPeriod.StaffingNeedsRow, SoeEntityState.Deleted, saveChanges: false);
                            if (!result.Success)
                                return result;

                            result = ChangeEntityState(entities, staffingNeedsRowPeriod.StaffingNeedsRow.StaffingNeedsHead, SoeEntityState.Deleted, saveChanges: false);
                            if (!result.Success)
                                return result;
                        }

                        #endregion

                        if (result.Success)
                            handledEmployeePostIds.Add(employeePost.EmployeePostId);

                        #endregion
                    }

                    result = SaveChanges(entities, null, useBulkSaveChanges: true);
                    if (result.Success)
                        result.Keys = handledEmployeePostIds;
                }
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                result.Exception = ex;
                result.IntegerValue = 0;
            }

            return result;
        }

        #endregion

        #region StaffingNeedsLocation

        public List<StaffingNeedsLocation> GetStaffingNeedsLocations(int actorCompanyId, int? groupId, int? locationId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsLocation.NoTracking();
            return GetStaffingNeedsLocations(entities, actorCompanyId, groupId, null, locationId);
        }

        public List<StaffingNeedsLocation> GetStaffingNeedsLocations(CompEntities entities, int actorCompanyId, int? groupId, List<StaffingNeedsLocation> staffingNeedsLocations = null, int? locationId = null)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            if (staffingNeedsLocations == null)
            {
                IQueryable<StaffingNeedsLocation> query = (from s in entities.StaffingNeedsLocation.Include("StaffingNeedsLocationGroup")
                                                           where s.StaffingNeedsLocationGroup.ActorCompanyId == actorCompanyId &&
                                                           s.State == (int)SoeEntityState.Active
                                                           select s);
                if (useAccountHierarchy)
                {
                    var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                    if (!accountIds.IsNullOrEmpty())
                        query = query.Where(t => t.StaffingNeedsLocationGroup.AccountId.HasValue && accountIds.Contains(t.StaffingNeedsLocationGroup.AccountId.Value));
                    else
                        query = query.Where(t => !t.StaffingNeedsLocationGroup.AccountId.HasValue);
                }
                if (groupId.HasValue)
                    query = query.Where(s => s.StaffingNeedsLocationGroupId == groupId.Value);

                if (locationId.HasValue)
                    query = query.Where(s => s.StaffingNeedsLocationId == locationId.Value);

                return query.OrderBy(s => s.Name).ToList();
            }
            else
            {
                var query = (from s in staffingNeedsLocations
                             where s.StaffingNeedsLocationGroup.ActorCompanyId == actorCompanyId &&
                             s.State == (int)SoeEntityState.Active
                             select s);

                if (groupId.HasValue)
                    query = query.Where(s => s.StaffingNeedsLocationGroupId == groupId.Value);

                return query.OrderBy(s => s.Name).ToList();

            }
        }

        public StaffingNeedsLocation GetStaffingNeedsLocation(int locationId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsLocation.NoTracking();
            return GetStaffingNeedsLocation(entities, locationId);
        }

        public StaffingNeedsLocation GetStaffingNeedsLocation(CompEntities entities, int locationId)
        {
            return (from s in entities.StaffingNeedsLocation
                    where s.StaffingNeedsLocationId == locationId
                    select s).FirstOrDefault();
        }

        public List<StaffingNeedsLocation> GetStaffingNeedsLocationsFromTimeScheduleTask(int timeScheduleTaskId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsLocation.NoTracking();
            return GetStaffingNeedsLocationsFromTimeScheduleTask(entities, timeScheduleTaskId, actorCompanyId);
        }

        public List<StaffingNeedsLocation> GetStaffingNeedsLocationsFromTimeScheduleTask(CompEntities entities, int timeScheduleTaskId, int actorCompanyId)
        {
            List<StaffingNeedsLocationGroup> groups = (from s in entities.StaffingNeedsLocationGroup
                                                       where s.TimeScheduleTaskId == timeScheduleTaskId &&
                                                       s.ActorCompanyId == actorCompanyId
                                                       select s).ToList();

            if (groups.Any())
            {
                List<int> groupIds = groups.Select(s => s.StaffingNeedsLocationGroupId).ToList();

                return (from s in entities.StaffingNeedsLocation
                        where groupIds.Contains(s.StaffingNeedsLocationGroupId) &&
                        s.StaffingNeedsLocationGroup.ActorCompanyId == actorCompanyId
                        select s).ToList();
            }

            return new List<StaffingNeedsLocation>();
        }

        public List<StaffingNeedsLocationGroup> GetStaffingNeedsGroupFromTimeScheduleTask(int timeScheduleTaskId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsLocation.NoTracking();
            return GetStaffingNeedsGroupFromTimeScheduleTask(entities, timeScheduleTaskId, actorCompanyId);
        }

        public List<StaffingNeedsLocationGroup> GetStaffingNeedsGroupFromTimeScheduleTask(CompEntities entities, int timeScheduleTaskId, int actorCompanyId)
        {
            return (from s in entities.StaffingNeedsLocationGroup
                                        .Include("ShiftType")
                    .Include("StaffingNeedsLocation")
                    where s.TimeScheduleTaskId == timeScheduleTaskId &&
                          s.ActorCompanyId == actorCompanyId
                    select s).ToList();
        }

        /// <summary>
        /// Insert or update a location
        /// </summary>
        /// <param name="locationInput">StaffingNeedsLocation entity</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveStaffingNeedsLocation(StaffingNeedsLocationDTO locationInput)
        {
            if (locationInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "StaffingNeedsLocation");

            // Default result is successful
            ActionResult result = null;

            int locationId = locationInput.StaffingNeedsLocationId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Location

                        // Get existing location
                        StaffingNeedsLocation location = GetStaffingNeedsLocation(entities, locationId);
                        if (location == null)
                        {
                            #region Location Add

                            location = new StaffingNeedsLocation()
                            {
                                StaffingNeedsLocationGroupId = locationInput.StaffingNeedsLocationGroupId,
                                Name = locationInput.Name,
                                Description = locationInput.Description,
                                ExternalCode = locationInput.ExternalCode,
                                State = (int)locationInput.State
                            };

                            SetCreatedProperties(location);

                            entities.StaffingNeedsLocation.AddObject(location);

                            #endregion
                        }
                        else
                        {
                            #region Location Update

                            location.StaffingNeedsLocationGroupId = locationInput.StaffingNeedsLocationGroupId;
                            location.Name = locationInput.Name;
                            location.Description = locationInput.Description;
                            location.ExternalCode = locationInput.ExternalCode;
                            location.State = (int)locationInput.State;

                            SetModifiedProperties(location);

                            result = SaveChanges(entities, transaction);
                            if (!result.Success)
                                return result;

                            #endregion
                        }

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            locationId = location.StaffingNeedsLocationId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = locationId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        /// <summary>
        /// Sets a locations state to Deleted
        /// </summary>
        /// <param name="locationId">Location to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteStaffingNeedsLocation(int locationId)
        {
            using (CompEntities entities = new CompEntities())
            {
                StaffingNeedsLocation location = GetStaffingNeedsLocation(entities, locationId);
                if (location == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "StaffingNeedsLocation");

                return ChangeEntityState(entities, location, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region StaffingNeedsLocationGroup

        public List<StaffingNeedsLocationGroup> GetStaffingNeedsLocationGroups(int actorCompanyId, bool includeTimeScheduleTask = false, bool includeStaffingNeedsLocation = false, bool includeShiftTypes = false, int? locationGroupId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsLocationGroup.NoTracking();
            return GetStaffingNeedsLocationGroups(entities, actorCompanyId, includeTimeScheduleTask, includeStaffingNeedsLocation, includeShiftTypes, locationGroupId);
        }

        public List<StaffingNeedsLocationGroup> GetStaffingNeedsLocationGroups(CompEntities entities, int actorCompanyId, bool includeTimeScheduleTask = false, bool includeStaffingNeedsLocation = false, bool includeShiftTypes = false, int? locationGroupId = null)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            IQueryable<StaffingNeedsLocationGroup> query = (from s in entities.StaffingNeedsLocationGroup
                                                            where s.ActorCompanyId == actorCompanyId &&
                                                            s.State == (int)SoeEntityState.Active
                                                            orderby s.Name
                                                            select s);

            if (includeTimeScheduleTask)
                query = query.Include("TimeScheduleTask");

            if (includeStaffingNeedsLocation)
                query = query.Include("StaffingNeedsLocation");

            if (includeShiftTypes)
                query = query.Include("ShiftType");

            if (useAccountHierarchy)
            {
                query = query.Include("Account");

                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            if (locationGroupId.HasValue)
                query = query.Where(t => t.StaffingNeedsLocationGroupId == locationGroupId.Value);

            return query.ToList();
        }

        public Dictionary<int, string> GetStaffingNeedsLocationGroupsDict(int actorCompanyId, bool addEmptyRow, bool includeAccountName = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetStaffingNeedsLocationGroupsDict(entities, actorCompanyId, addEmptyRow, includeAccountName);
        }

        public Dictionary<int, string> GetStaffingNeedsLocationGroupsDict(CompEntities entities, int actorCompanyId, bool addEmptyRow, bool includeAccountName = false)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            List<StaffingNeedsLocationGroup> groups = GetStaffingNeedsLocationGroups(entities, actorCompanyId);
            foreach (StaffingNeedsLocationGroup group in groups)
            {
                if (includeAccountName && group.Account != null)
                    dict.Add(group.StaffingNeedsLocationGroupId, group.Name + " (" + group.Account.Name + ")");
                else
                    dict.Add(group.StaffingNeedsLocationGroupId, group.Name);
            }

            return dict;
        }

        public StaffingNeedsLocationGroup GetStaffingNeedsLocationGroup(int groupId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsLocationGroup.NoTracking();
            return GetStaffingNeedsLocationGroup(entities, groupId);
        }

        public StaffingNeedsLocationGroup GetStaffingNeedsLocationGroup(CompEntities entities, int groupId)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);

            IQueryable<StaffingNeedsLocationGroup> query = (from s in entities.StaffingNeedsLocationGroup.Include("ShiftType")
                                                            .Include("Account")
                                                            where s.StaffingNeedsLocationGroupId == groupId
                                                            select s);

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, base.ActorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.FirstOrDefault();
        }

        /// <summary>
        /// Insert or update a location group
        /// </summary>
        /// <param name="groupInput">StaffingNeedsLocationGroup entity</param>
        /// <param name="shiftTypeIds">Shift type IDs</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveStaffingNeedsLocationGroup(StaffingNeedsLocationGroupDTO groupInput, List<int> shiftTypeIds, int actorCompanyId)
        {
            if (groupInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "StaffingNeedsLocationGroup");

            // Default result is successful
            ActionResult result = null;

            int groupId = groupInput.StaffingNeedsLocationGroupId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Group

                        // Get existing group
                        StaffingNeedsLocationGroup group = GetStaffingNeedsLocationGroup(entities, groupId);
                        if (group == null)
                        {
                            #region Group Add

                            group = new StaffingNeedsLocationGroup()
                            {
                                ActorCompanyId = actorCompanyId,
                                Name = groupInput.Name,
                                Description = groupInput.Description,
                                State = (int)groupInput.State,
                                TimeScheduleTaskId = groupInput.TimeScheduleTaskId

                            };

                            SetCreatedProperties(group);

                            entities.StaffingNeedsLocationGroup.AddObject(group);

                            #endregion
                        }
                        else
                        {
                            #region Group Update

                            group.Name = groupInput.Name;
                            group.Description = groupInput.Description;
                            group.State = (int)groupInput.State;
                            group.TimeScheduleTaskId = groupInput.TimeScheduleTaskId;

                            SetModifiedProperties(group);

                            result = SaveChanges(entities, transaction);
                            if (!result.Success)
                                return result;

                            #endregion
                        }
                        group.AccountId = groupInput.accountId;

                        #region Shift types

                        // Always remove and add shift types
                        group.ShiftType.Clear();
                        if (shiftTypeIds != null)
                        {
                            foreach (int shiftTypeId in shiftTypeIds)
                            {
                                ShiftType shiftType = GetShiftType(entities, shiftTypeId);
                                if (shiftType != null)
                                    group.ShiftType.Add(shiftType);
                            }
                        }

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            groupId = group.StaffingNeedsLocationGroupId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = groupId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        /// <summary>
        /// Sets a location groups state to Deleted
        /// </summary>
        /// <param name="locationId">Location group to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteStaffingNeedsLocationGroup(int groupId)
        {
            using (CompEntities entities = new CompEntities())
            {
                StaffingNeedsLocationGroup group = GetStaffingNeedsLocationGroup(entities, groupId);
                if (group == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "StaffingNeedsLocationGroup");

                // Check relations
                if (!group.StaffingNeedsLocation.IsLoaded)
                    group.StaffingNeedsLocation.Load();
                if (group.StaffingNeedsLocation.Any(l => l.State != (int)SoeEntityState.Deleted))
                    return new ActionResult((int)ActionResultDelete.StaffingNeedsLocationGroupHasLocations, GetText(3172, "Det finns bemanningsplatser kopplade mot denna grupp, dessa måste tas bort först"));

                if (!group.StaffingNeedsRule.IsLoaded)
                    group.StaffingNeedsRule.Load();
                if (group.StaffingNeedsRule.Any(r => r.State != (int)SoeEntityState.Deleted))
                    return new ActionResult((int)ActionResultDelete.StaffingNeedsLocationGroupHasRules, GetText(3173, "Det finns regler kopplade mot denna grupp, dessa måste tas bort först"));

                return ChangeEntityState(entities, group, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region StaffingNeedsRule

        public List<StaffingNeedsRule> GetStaffingNeedsRules(int actorCompanyId, int? groupId = null, int? ruleId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsRule.NoTracking();
            return GetStaffingNeedsRules(entities, actorCompanyId, groupId, ruleId);
        }

        public List<StaffingNeedsRule> GetStaffingNeedsRules(CompEntities entities, int actorCompanyId, int? groupId = null, int? ruleId = null)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            var query = (from s in entities.StaffingNeedsRule.Include("StaffingNeedsLocationGroup.StaffingNeedsLocation").Include("Account")
                         where s.StaffingNeedsLocationGroup.ActorCompanyId == actorCompanyId &&
                         s.State == (int)SoeEntityState.Active
                         select s);

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            if (groupId.HasValue)
                query = query.Where(s => s.StaffingNeedsLocationGroupId == groupId.Value);

            if (ruleId.HasValue)
                query = query.Where(t => t.StaffingNeedsRuleId == ruleId.Value);

            return query.OrderBy(s => s.Name).ToList();
        }

        public StaffingNeedsRule GetStaffingNeedsRule(int ruleId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsRule.NoTracking();
            return GetStaffingNeedsRule(entities, ruleId);
        }

        public StaffingNeedsRule GetStaffingNeedsRule(CompEntities entities, int ruleId)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, base.ActorCompanyId);

            var query = (from s in entities.StaffingNeedsRule.Include("StaffingNeedsRuleRow").Include("Account")
                         where s.StaffingNeedsRuleId == ruleId
                         select s);

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, base.ActorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.FirstOrDefault();
        }

        public StaffingNeedsRule GetStaffingNeedsRule(int actorCompanyId, TermGroup_StaffingNeedsRuleUnit unit)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.StaffingNeedsRule.NoTracking();
            return (from s in entities.StaffingNeedsRule.Include("StaffingNeedsRuleRow")
                    where s.StaffingNeedsLocationGroup.ActorCompanyId == actorCompanyId &&
                    s.Unit == (int)unit
                    select s).FirstOrDefault();
        }

        public decimal GetStaffingNeedsRuleRowValue(StaffingNeedsRule rule, int actorCompanyId, DateTime targetDate)
        {
            decimal value = 0;
            if (rule == null)
                return value;

            // Get rule row (day type)
            foreach (StaffingNeedsRuleRow row in rule.StaffingNeedsRuleRow.OrderBy(r => r.Sort))
            {
                bool foundRow = false;
                if (row.DayTypeId.HasValue)
                {
                    #region DayType

                    DayType dayType = CalendarManager.GetDayType(row.DayTypeId.Value, actorCompanyId);
                    if (dayType != null)
                    {
                        int? weekdayFrom = null;
                        int? weekdayTo = null;

                        if (dayType.StandardWeekdayFrom.HasValue && dayType.StandardWeekdayTo.HasValue)
                        {
                            weekdayFrom = dayType.StandardWeekdayFrom.Value;
                            weekdayTo = dayType.StandardWeekdayTo.Value;
                        }
                        else if (dayType.SysDayTypeId.HasValue)
                        {
                            // Get SysDayType
                            SysDayType sysDayType = CalendarManager.GetSysDayType(dayType.SysDayTypeId.Value);
                            if (sysDayType != null)
                            {
                                weekdayFrom = sysDayType.StandardWeekdayFrom;
                                weekdayTo = sysDayType.StandardWeekdayTo;
                            }
                        }

                        if (weekdayFrom.HasValue && weekdayTo.HasValue)
                        {
                            for (int i = weekdayFrom.Value; i <= weekdayTo.Value; i++)
                            {
                                if (i > (int)DayOfWeek.Saturday)
                                    i = (int)DayOfWeek.Sunday;

                                if (i == (int)targetDate.DayOfWeek)
                                {
                                    foundRow = true;
                                    break;
                                }
                            }
                        }
                    }

                    #endregion
                }
                else if (row.Weekday.HasValue)
                {
                    #region DayOfWeek

                    if (row.Weekday.Value == (int)targetDate.DayOfWeek)
                        foundRow = true;

                    #endregion
                }
                else if (!row.Weekday.HasValue && !row.DayTypeId.HasValue)
                {
                    foundRow = true;
                }

                if (foundRow)
                {
                    value = row.Value;
                    break;
                }
            }

            return value;

        }

        /// <summary>
        /// Insert or update a rule
        /// </summary>
        /// <param name="ruleInput">StaffingNeedsRule entity</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveStaffingNeedsRule(StaffingNeedsRuleDTO ruleInput)
        {
            if (ruleInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "StaffingNeedsRule");

            // Default result is successful
            ActionResult result = null;

            int ruleId = ruleInput.StaffingNeedsRuleId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region Rule

                        // Get existing rule
                        StaffingNeedsRule rule = GetStaffingNeedsRule(entities, ruleId);
                        if (rule == null)
                        {
                            #region Rule Add

                            rule = new StaffingNeedsRule();
                            SetCreatedProperties(rule);

                            entities.StaffingNeedsRule.AddObject(rule);

                            #endregion
                        }
                        else
                        {
                            #region Rule Update

                            SetModifiedProperties(rule);

                            #endregion
                        }

                        // Comon
                        rule.StaffingNeedsLocationGroupId = ruleInput.StaffingNeedsLocationGroupId;
                        rule.Name = ruleInput.Name;
                        rule.Unit = (int)ruleInput.Unit;
                        rule.MaxQuantity = ruleInput.MaxQuantity;
                        rule.AccountId = ruleInput.AccountId;
                        rule.State = (int)ruleInput.State;

                        result = SaveChanges(entities, transaction);
                        if (!result.Success)
                            return result;

                        #endregion

                        #region Rows

                        #region Row Update/Delete

                        // Update or Delete existing rows
                        foreach (StaffingNeedsRuleRow row in rule.StaffingNeedsRuleRow.ToList())
                        {
                            // Try get row from input
                            StaffingNeedsRuleRowDTO rowInput = (from r in ruleInput.Rows
                                                                where r.StaffingNeedsRuleRowId == row.StaffingNeedsRuleRowId
                                                                select r).FirstOrDefault();

                            if (rowInput != null)
                            {
                                #region Row Update

                                // Update existing row
                                row.Sort = rowInput.Sort;
                                row.DayTypeId = rowInput.DayTypeId;
                                row.Weekday = (int?)rowInput.Weekday;
                                row.Value = rowInput.Value;

                                #endregion
                            }
                            else
                            {
                                #region Row Delete

                                // Delete existing row
                                entities.DeleteObject(row);

                                #endregion
                            }
                        }

                        #endregion

                        #region Row Add

                        // Get new rows
                        IEnumerable<StaffingNeedsRuleRowDTO> rowsToAdd = (from r in ruleInput.Rows
                                                                          where r.StaffingNeedsRuleRowId == 0 && (r.DayTypeId.HasValue || r.Weekday.HasValue)
                                                                          select r).ToList();

                        foreach (StaffingNeedsRuleRowDTO rowToAdd in rowsToAdd)
                        {
                            if (rowToAdd.DayTypeId.HasValue && rowToAdd.DayTypeId.Value == 0)
                                rowToAdd.DayTypeId = null;

                            // Add row to rule
                            rule.StaffingNeedsRuleRow.Add(new StaffingNeedsRuleRow()
                            {
                                StaffingNeedsRuleId = rule.StaffingNeedsRuleId,
                                Sort = rowToAdd.Sort,
                                DayTypeId = rowToAdd.DayTypeId,
                                Weekday = (int?)rowToAdd.Weekday,
                                Value = rowToAdd.Value
                            });
                        }

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            //Commit transaction
                            transaction.Complete();

                            ruleId = rule.StaffingNeedsRuleId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        //Set success properties
                        result.IntegerValue = ruleId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        /// <summary>
        /// Sets a rules state to Deleted
        /// </summary>
        /// <param name="ruleId">Rule to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteStaffingNeedsRule(int ruleId)
        {
            using (CompEntities entities = new CompEntities())
            {
                StaffingNeedsRule rule = GetStaffingNeedsRule(entities, ruleId);
                if (rule == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, "StaffingNeedsRule");

                return ChangeEntityState(entities, rule, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region Charts

        public List<StaffingNeedsAnalysisChartData> GetStaffingNeedsChartData(int actorCompanyId, DateTime fromDate, DateTime toDate, List<int> dayOfWeeks, DateTime targetDate, int interval, int refType, bool includePreliminary, int nbrOfDecimals, List<int> shiftTypeIds, bool? open, decimal adjustPercent, List<StaffingNeedsLocation> locations = null, int? accountId = null)
        {
            List<StaffingNeedsAnalysisChartData> staffingNeedsAnalysisChartData = new List<StaffingNeedsAnalysisChartData>();
            decimal staffingNeedRoundUp = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.StaffingNeedRoundUp, base.UserId, actorCompanyId, 0);

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            List<int> validAccountIds = !useAccountHierarchy ? null : AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, targetDate, targetDate, null);
            List<DateTime> dates = new List<DateTime>();

            while (fromDate <= toDate)
            {
                if (dayOfWeeks == null || dayOfWeeks.Count == 0)
                    dates.Add(fromDate);
                else
                {
                    if (dayOfWeeks.Contains((int)fromDate.DayOfWeek))
                        dates.Add(fromDate);
                }
                fromDate = fromDate.AddDays(1);
            }

            if (refType == (int)TermGroup_StaffingNeedsAnalysisRefType.Unknown)
            {
                var rules = GetStaffingNeedsRules(actorCompanyId);
                List<StaffingNeedsAnalysisChartData> ruleStaffingNeedsAnalysisChartData = new List<StaffingNeedsAnalysisChartData>();

                //Get only rules connected to locations

                foreach (var rule in rules)
                {
                    if (locations == null || (rule.StaffingNeedsLocationGroup.StaffingNeedsLocation != null && rule.StaffingNeedsLocationGroup.StaffingNeedsLocation.Any(a => locations.Select(s => s.StaffingNeedsLocationId).Contains(a.StaffingNeedsLocationId))))
                    {
                        ruleStaffingNeedsAnalysisChartData.AddRange(GetStaffingNeedsChartData(actorCompanyId, dates, targetDate, interval, rule.StaffingNeedsRuleId, includePreliminary, nbrOfDecimals, shiftTypeIds, open, adjustPercent, locations, validAccountIds: validAccountIds));
                    }
                }


                var groups = ruleStaffingNeedsAnalysisChartData.GroupBy(g => g.Date.ToString() + g.StaffingNeedsLocationGroupId);

                foreach (var group in groups)
                {
                    var first = group.First();
                    var groupId = first.StaffingNeedsLocationGroupId;
                    decimal maxQuantity = group.Max(m => Convert.ToDecimal(m.MaxQuantity));

                    StaffingNeedsAnalysisChartData chartData = new StaffingNeedsAnalysisChartData()
                    {
                        Date = first.Date,
                        Value = group.Sum(s => s.Value),
                        ShiftStatus = first.ShiftStatus,
                        StaffingNeedsLocationGroupId = first.StaffingNeedsLocationGroupId
                    };

                    var prev = groups.FirstOrDefault(w => w.Key == first.Date.AddMinutes(-interval).ToString() + first.StaffingNeedsLocationGroupId);
                    var next = groups.FirstOrDefault(w => w.Key == first.Date.AddMinutes(interval).ToString() + first.StaffingNeedsLocationGroupId);

                    var secondPrev = groups.FirstOrDefault(w => w.Key == first.Date.AddMinutes(-interval * 2).ToString() + first.StaffingNeedsLocationGroupId);
                    var secondNext = groups.FirstOrDefault(w => w.Key == first.Date.AddMinutes(interval * 2).ToString() + first.StaffingNeedsLocationGroupId);

                    List<decimal> values = new List<decimal>() { chartData.Value };

                    if (prev != null)
                        values.Add(prev.Sum(s => s.Value));

                    if (next != null)
                        values.Add(next.Sum(s => s.Value));

                    if (secondPrev != null)
                        values.Add(secondPrev.Sum(s => s.Value));

                    if (secondNext != null)
                        values.Add(secondNext.Sum(s => s.Value));

                    var value = decimal.Divide(values.Sum(), Convert.ToDecimal(values.Count));

                    if (maxQuantity > 0 && value > maxQuantity)
                    {
                        chartData.OrginalValue = chartData.Value;
                        chartData.Value = first.MaxQuantity;
                    }
                    else
                    {
                        decimal decimalpart = value - Math.Truncate(value);
                        chartData.OrginalValue = chartData.Value;

                        if (staffingNeedRoundUp < decimalpart)
                            chartData.Value = value - decimalpart + 1;
                        else
                            chartData.Value = Math.Truncate(value);
                    }

                    staffingNeedsAnalysisChartData.Add(chartData);
                }
            }
            else
            {
                staffingNeedsAnalysisChartData = GetStaffingNeedsChartData(actorCompanyId, dates, targetDate, interval, refType, includePreliminary, nbrOfDecimals, shiftTypeIds, open, adjustPercent, locations, validAccountIds: validAccountIds);
            }

            return staffingNeedsAnalysisChartData;
        }

        /// <summary>
        /// Get data for StaffingNeedsChart
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="date">Date to get data from</param>
        /// <param name="targetDate">Date to compare against</param>
        /// <param name="interval">Number of minutes between records</param>
        /// <param name="refType">Reference type, compare with schedule or presence time</param>
        /// <param name="includePreliminary">Include preliminary shifts or not</param>
        /// <param name="nbrOfDecimals">Number of decimals in return values</param>
        /// <param name="shiftTypeIds">List of ShiftType IDs to filter on</param>
        /// <param name="open">If true, only open shifts are returned
        ///                    If false, only assigned shifts are returned
        ///                    If null, both open and assigned shifts are returned</param>
        /// <returns>List of StaffingNeedsChartData</returns>
        public List<StaffingNeedsAnalysisChartData> GetStaffingNeedsChartData(int actorCompanyId, List<DateTime> dates, DateTime targetDate, int interval, int refType, bool includePreliminary, int nbrOfDecimals, List<int> shiftTypeIds, bool? open, decimal adjustPercent, List<StaffingNeedsLocation> locations = null, List<int> validAccountIds = null)
        {
            List<StaffingNeedsAnalysisChartData> result = new List<StaffingNeedsAnalysisChartData>();
            List<StaffingNeedsAnalysisChartData> chartDataForDates = new List<StaffingNeedsAnalysisChartData>();

            //Get all Freqs
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<StaffingNeedsFrequency> allFreqs = base.GetStaffingNeedsFrequencyFromCache(entitiesReadOnly, actorCompanyId, dates.OrderBy(o => o).FirstOrDefault(), CalendarUtility.GetEndOfDay(dates.OrderBy(o => o).LastOrDefault()), validAccountIds: validAccountIds);
            //Get locations
            var allLocations = GetStaffingNeedsLocations(actorCompanyId, null);

            if (locations == null)
                locations = allLocations;
            //Get rule
            StaffingNeedsRule rule = GetStaffingNeedsRule(refType);
            int maxQuantity = rule.MaxQuantity;

            locations = locations.Where(i => i.StaffingNeedsLocationGroupId == rule.StaffingNeedsLocationGroupId).ToList();
            if (!locations.Any())
                return new List<StaffingNeedsAnalysisChartData>();

            foreach (var date in dates)
            {
                List<StaffingNeedsAnalysisChartData> chartDataForDate = new List<StaffingNeedsAnalysisChartData>();

                #region Prereq

                DateTime dateTimeFrom = CalendarUtility.GetBeginningOfDay(date);
                DateTime dateTimeTo = CalendarUtility.GetEndOfDay(date);
                decimal adjust = 1 + (adjustPercent / 100);

                #endregion

                switch (refType)
                {
                    case (int)TermGroup_StaffingNeedsAnalysisRefType.Unknown:
                        break;
                    case (int)TermGroup_StaffingNeedsAnalysisRefType.Schedule:
                        #region ReferenceType = Schedule

                        List<TimeScheduleTemplateBlock> sBlocks = GetStaffingNeedsChartScheduleQuery(actorCompanyId, dateTimeFrom, dateTimeTo, includePreliminary, shiftTypeIds, open);
                        if (sBlocks.Count > 0)
                        {
                            // Get block range
                            DateTime firstStart = CalendarUtility.MergeDateAndTime(dateTimeFrom, sBlocks.Min(b => b.StartTime));
                            DateTime lastStop = CalendarUtility.MergeDateAndTime(dateTimeTo, sBlocks.Max(b => b.StopTime));
                            // Check over midnight
                            if (lastStop < firstStart)
                                lastStop = lastStop.AddDays(1);

                            double minutes = (firstStart - firstStart.Date).TotalMinutes;
                            minutes = minutes - (minutes % interval);
                            firstStart = firstStart.Date.AddMinutes(minutes);

                            // Make sure firstStart is on a whole hour
                            // E.g. 05:45 will be 05:00
                            // The reason is to get whole hours in the chart
                            if (firstStart.Minute != 0)
                                firstStart = firstStart.AddMinutes(-firstStart.Minute);

                            // Create empty result list
                            DateTime currentTime = firstStart;
                            while (currentTime < lastStop)
                            {
                                if (!open.HasValue || (open.HasValue && open.Value))
                                    chartDataForDate.Add(new StaffingNeedsAnalysisChartData() { ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Open, Date = currentTime, Value = 0 });

                                if (!open.HasValue || (open.HasValue && !open.Value))
                                    chartDataForDate.Add(new StaffingNeedsAnalysisChartData() { ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned, Date = currentTime, Value = 0 });

                                currentTime = currentTime.AddMinutes(interval);
                            }

                            foreach (var sBlock in sBlocks)
                            {
                                DateTime blockStart = CalendarUtility.MergeDateAndTime(sBlock.Date.Value, sBlock.StartTime);
                                DateTime blockStop = CalendarUtility.MergeDateAndTime(sBlock.Date.Value, sBlock.StopTime);

                                // Get time rounded to nearest interval before block start.
                                // E.g. 12:35 with interval 30 minutes will start currentTime as 12:30.
                                minutes = (blockStart - blockStart.Date).TotalMinutes;
                                minutes = minutes - (minutes % interval);
                                currentTime = blockStart.Date.AddMinutes(minutes);
                                while (currentTime < blockStop)
                                {
                                    if (blockStart <= currentTime && blockStop > currentTime)
                                    {
                                        StaffingNeedsAnalysisChartData data = chartDataForDate.FirstOrDefault(d => d.ShiftStatus == (TermGroup_TimeScheduleTemplateBlockShiftStatus)sBlock.ShiftStatus && d.Date >= currentTime);
                                        if (data != null)
                                            data.Value++;
                                    }
                                    currentTime = currentTime.AddMinutes(interval);
                                }
                            }
                        }

                        #endregion
                        break;
                    case (int)TermGroup_StaffingNeedsAnalysisRefType.Presence:
                        #region ReferenceType = Presence

                        List<TimeBlock> pBlocks = GetStaffingNeedsChartPresenceQuery(actorCompanyId, dateTimeFrom, dateTimeTo, includePreliminary);
                        if (pBlocks.Count > 0)
                        {
                            DateTime minStartTime = pBlocks.Min(b => b.StartTime);
                            DateTime maxStopTime = pBlocks.Max(b => b.StopTime);

                            if (minStartTime < CalendarUtility.DATETIME_DEFAULT)
                                minStartTime = CalendarUtility.DATETIME_DEFAULT;

                            if (maxStopTime > (CalendarUtility.DATETIME_DEFAULT.AddDays(1)))
                                maxStopTime = CalendarUtility.DATETIME_DEFAULT.AddDays(1).AddSeconds(-1);

                            // Get block range
                            DateTime firstStart = CalendarUtility.MergeDateAndTime(dateTimeFrom, minStartTime);
                            DateTime lastStop = CalendarUtility.MergeDateAndTime(dateTimeTo, maxStopTime);
                            // Check over midnight
                            if (lastStop < firstStart)
                                lastStop = lastStop.AddDays(1);

                            double minutes = (firstStart - firstStart.Date).TotalMinutes;
                            minutes = minutes - (minutes % interval);
                            firstStart = firstStart.Date.AddMinutes(minutes);

                            // Create empty result list
                            DateTime currentTime = firstStart;
                            while (currentTime < lastStop)
                            {
                                chartDataForDate.Add(new StaffingNeedsAnalysisChartData() { ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned, Date = currentTime, Value = 0 });

                                currentTime = currentTime.AddMinutes(interval);
                            }

                            foreach (var wBlock in pBlocks)
                            {
                                DateTime blockStart = CalendarUtility.MergeDateAndTime(wBlock.TimeBlockDate.Date, wBlock.StartTime);
                                DateTime blockStop = CalendarUtility.MergeDateAndTime(wBlock.TimeBlockDate.Date, wBlock.StopTime);

                                // Get time rounded to nearest interval before block start.
                                // E.g. 12:35 with interval 30 minutes will start currentTime as 12:30.
                                minutes = (blockStart - blockStart.Date).TotalMinutes;
                                minutes = minutes - (minutes % interval);
                                currentTime = blockStart.Date.AddMinutes(minutes);
                                while (currentTime < blockStop)
                                {
                                    if (blockStart <= currentTime && blockStop > currentTime)
                                    {
                                        StaffingNeedsAnalysisChartData data = chartDataForDate.FirstOrDefault(d => d.Date >= currentTime);
                                        if (data != null)
                                            data.Value++;
                                    }
                                    currentTime = currentTime.AddMinutes(interval);
                                }
                            }
                        }

                        #endregion
                        break;
                    default:
                        #region ReferenceType = StaffingNeedsRule

                        #region Query

                        #region Rule

                        // Get rule
                        decimal ruleValue = GetStaffingNeedsRuleRowValue(rule, actorCompanyId, targetDate);
                        if (ruleValue == 0)
                            continue;

                        #endregion

                        #region Frequency

                        // Get frequency records
                        List<StaffingNeedsFrequency> freqs = new List<StaffingNeedsFrequency>();
                        List<StaffingNeedsFrequency> unFilteredFreqs = GetStaffingNeedsFrequencys(actorCompanyId, dateTimeFrom, dateTimeTo, allFreqs);
                        if (unFilteredFreqs.Count == 0)
                            continue;

                        //Only use latest
                        var groups = unFilteredFreqs.GroupBy(i => i.CompareKey);

                        foreach (var group in groups)
                        {
                            var valid = group.OrderByDescending(o => o.StaffingNeedsFrequencyId).FirstOrDefault();

                            if (valid != null)
                                freqs.Add(valid);
                        }

                        // Check interval type
                        KeyValuePair<bool, int> intervalInfo = GetFrequencyInterval(freqs);
                        bool freqIntervalTypeFixed = intervalInfo.Key;
                        int freqInterval = intervalInfo.Value;

                        // Split frequencies into minutes
                        List<StaffingNeedsFrequency> minuteFreqs = new List<StaffingNeedsFrequency>();
                        foreach (var freq in freqs)
                        {
                            if (!freq.GetGroupId(locations, allLocations).HasValue)
                                continue;

                            if (!freqIntervalTypeFixed)
                            {
                                // Calculate frequency interval for each record
                                freqInterval = (int)(freq.TimeTo - freq.TimeFrom).TotalMinutes;
                                if (freqInterval <= 0)
                                    freqInterval = 1;
                            }

                            // Get items per minute based on frequence type
                            decimal itemsPerMinute = freq.ItemsPerMinute(rule.FrequencyType, freqInterval);

                            if (itemsPerMinute != 0)
                            {
                                for (int i = 0; i < freqInterval; i++)
                                {
                                    minuteFreqs.Add(new StaffingNeedsFrequency()
                                    {
                                        TimeFrom = freq.TimeFrom.AddMinutes(i),
                                        TimeTo = freq.TimeFrom.AddMinutes(i),
                                        ExternalCode = freq.ExternalCode,
                                        NbrOfItems = rule.FrequencyType == StaffingNeedsFrequencyType.NbrOfItems ? itemsPerMinute : 0,
                                        NbrOfCustomers = rule.FrequencyType == StaffingNeedsFrequencyType.NbrOfCustomers ? itemsPerMinute : 0,
                                        Amount = rule.FrequencyType == StaffingNeedsFrequencyType.Amount ? itemsPerMinute : 0,
                                    });
                                }
                            }
                        }

                        #endregion

                        #endregion

                        #region Create result

                        if (minuteFreqs.Count > 0)
                        {
                            // Get block range
                            DateTime firstStart = minuteFreqs.Min(f => f.TimeFrom);
                            DateTime lastStop = minuteFreqs.Max(f => f.TimeTo);

                            double minutes = (firstStart - firstStart.Date).TotalMinutes;
                            minutes = minutes - (minutes % interval);
                            firstStart = firstStart.Date.AddMinutes(minutes);

                            // Make sure firstStart is on a whole hour
                            // E.g. 05:45 will be 05:00
                            // The reason is to get whole hours in the chart
                            if (firstStart.Minute != 0)
                                firstStart = firstStart.AddMinutes(-firstStart.Minute);

                            // Create empty result list
                            DateTime currentTime = firstStart;
                            while (currentTime < lastStop)
                            {
                                chartDataForDate.Add(new StaffingNeedsAnalysisChartData() { ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned, Date = currentTime, Value = 0 });
                                currentTime = currentTime.AddMinutes(interval);
                            }

                            foreach (var freq in minuteFreqs)
                            {
                                DateTime freqStart = freq.TimeFrom;
                                // Get time rounded to nearest interval before frequency start.
                                // E.g. 12:35 with interval 30 minutes will start currentTime as 12:30.
                                minutes = (freqStart - freqStart.Date).TotalMinutes;
                                minutes = minutes - (minutes % interval);
                                currentTime = freqStart.Date.AddMinutes(minutes);
                                StaffingNeedsAnalysisChartData data = chartDataForDate.FirstOrDefault(d => d.Date == currentTime && d.StaffingNeedsLocationGroupId == freq.GetGroupId(locations, allLocations));
                                if (data == null)
                                    data = chartDataForDate.FirstOrDefault(d => d.Date == currentTime);
                                if (data != null)
                                {
                                    switch (rule.FrequencyType)
                                    {
                                        case StaffingNeedsFrequencyType.NbrOfItems:
                                            data.Value += freq.NbrOfItems * adjust;
                                            break;
                                        case StaffingNeedsFrequencyType.NbrOfCustomers:
                                            data.Value += freq.NbrOfCustomers * adjust;
                                            break;
                                        case StaffingNeedsFrequencyType.Amount:
                                            data.Value += freq.Amount * adjust;
                                            break;
                                    }
                                }

                                //Set Group
                                data.StaffingNeedsLocationGroupId = freq.GetGroupId(locations, allLocations);
                            }
                        }

                        foreach (var data in chartDataForDate)
                        {
                            if (nbrOfDecimals == 0)
                                data.Value = Math.Ceiling(Decimal.Divide(Decimal.Divide(data.Value, interval), ruleValue));
                            else
                                data.Value = Decimal.Round(Decimal.Divide(Decimal.Divide(data.Value, interval), ruleValue), nbrOfDecimals);
                        }

                        chartDataForDate = chartDataForDate.Where(d => d.StaffingNeedsLocationGroupId.HasValue).ToList();

                        #endregion

                        #endregion
                        break;
                }

                // Modify date on result to match target date
                // otherwite the charts will not align
                TimeSpan targetDiff = (targetDate.Date - date.Date);
                if (targetDiff.TotalMinutes != 0)
                {
                    foreach (var data in chartDataForDate)
                    {
                        data.MaxQuantity = maxQuantity;
                        data.Date = data.Date.AddMinutes(targetDiff.TotalMinutes);
                    }
                }

                chartDataForDates.AddRange(chartDataForDate);
            }

            #region Calculate average

            if (dates.Count > 1)
            {
                List<DateTime> distinctChartDates = chartDataForDates.Select(x => x.Date).Distinct().ToList();
                foreach (var chartDate in distinctChartDates)
                {
                    foreach (var group in chartDataForDates.GroupBy(g => g.StaffingNeedsLocationGroupId))
                    {
                        var chartsForDate = group.Where(x => x.Date == chartDate).ToList();

                        var newChart = new StaffingNeedsAnalysisChartData()
                        {
                            ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Open, //just choose one, it doesnt matter
                            Date = chartDate,
                            Value = chartsForDate.Sum(x => x.Value) / dates.Count,
                            StaffingNeedsLocationGroupId = group.Key,
                            MaxQuantity = group.First().MaxQuantity
                        };

                        newChart.Value = Decimal.Round(newChart.Value, nbrOfDecimals);

                        result.Add(newChart);
                    }

                }
            }
            else
            {
                result = chartDataForDates;
            }

            #endregion

            return result.OrderBy(x => x.Date).ToList();
        }

        private List<TimeScheduleTemplateBlock> GetStaffingNeedsChartScheduleQuery(int actorCompanyId, DateTime dateTimeFrom, DateTime dateTimeTo, bool includePreliminary, List<int> shiftTypeIds, bool? open)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            var query = (from tb in entities.TimeScheduleTemplateBlock
                         where !tb.TimeScheduleScenarioHeadId.HasValue &&
                         tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId &&
                         tb.Employee.State != (int)SoeEntityState.Deleted &&
                         tb.TimeScheduleEmployeePeriod != null &&
                         (tb.Date.HasValue && tb.Date >= dateTimeFrom && tb.Date <= dateTimeTo) &&
                         (tb.StartTime != tb.StopTime) &&
                         !tb.TimeDeviationCauseId.HasValue &&
                         tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                         tb.State == (int)SoeEntityState.Active
                         select tb);

            if (!includePreliminary)
                query = query.Where(b => !b.IsPreliminary);

            if (!shiftTypeIds.IsNullOrEmpty())
                query = query.Where(b => shiftTypeIds.Contains(b.ShiftTypeId.Value));

            if (open.HasValue)
                query = query.Where(b => b.ShiftStatus == (int)(open.Value ? TermGroup_TimeScheduleTemplateBlockShiftStatus.Open : TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned));

            query = query.OrderBy(b => b.Date).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime);

            return query.ToList();
        }

        private List<TimeBlock> GetStaffingNeedsChartPresenceQuery(int actorCompanyId, DateTime dateTimeFrom, DateTime dateTimeTo, bool includePreliminary)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeBlock.NoTracking();
            var query = (from b in entities.TimeBlock.Include("TimeBlockDate").Include("TimeDeviationCauseStart")
                         where b.Employee != null && b.Employee.ActorCompanyId == actorCompanyId &&
                         b.Employee.State != (int)SoeEntityState.Deleted &&
                         (b.TimeBlockDate.Date >= dateTimeFrom && b.TimeBlockDate.Date <= dateTimeTo) &&
                         (b.StartTime != b.StopTime) &&
                         (b.TimeDeviationCauseStart == null ||
                           b.TimeDeviationCauseStart.Type == (int)TermGroup_TimeDeviationCauseType.Presence ||
                           b.TimeDeviationCauseStart.Type == (int)TermGroup_TimeDeviationCauseType.PresenceAndAbsence) &&
                         !b.IsBreak &&
                         b.State == (int)SoeEntityState.Active
                         select b);

            if (!includePreliminary)
                query = query.Where(b => !b.IsPreliminary);

            query = query.OrderBy(b => b.TimeBlockDate.Date).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime);

            return query.ToList();
        }

        private KeyValuePair<bool, int> GetFrequencyInterval(List<StaffingNeedsFrequency> freqs)
        {
            // Check interval type
            int freqInterval = 0;
            bool freqIntervalTypeFixed = false;
            StaffingNeedsFrequency first = freqs.First();
            if (first.TimeFrom == first.TimeTo)
            {
                // Same from and to time, calculate interval
                if (freqs.Count == 1)
                {
                    // Only one record and no times specified, use whole day
                    first.TimeFrom = CalendarUtility.GetBeginningOfDay(first.TimeFrom);
                    first.TimeTo = CalendarUtility.GetEndOfDay(first.TimeTo);
                }
                else
                {
                    // Check difference between first and second record
                    freqInterval = (int)(freqs[1].TimeFrom - first.TimeFrom).TotalMinutes;
                    freqIntervalTypeFixed = true;
                }
            }

            return new KeyValuePair<bool, int>(freqIntervalTypeFixed, freqInterval);
        }

        #endregion

        #endregion

        #region Period

        public List<EmployeePeriodTimeSummary> GetEmployeePeriodTimeSummaries(int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, int timePeriodHeadId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetEmployeePeriodTimeSummaries(entities, actorCompanyId, employeeIds, dateFrom, dateTo, timePeriodHeadId);
        }

        public List<EmployeePeriodTimeSummary> GetEmployeePeriodTimeSummaries(CompEntities entities, int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, int timePeriodHeadId)
        {

            TimeEngineManager tem = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId, entities);
            return tem.GetEmployeePeriodTimeSummariesForEmployees(employeeIds, dateFrom, dateTo, timePeriodHeadId);
        }

        #endregion

        #region RecalculateTimeHead

        public List<RecalculateTimeHead> GetRecalculateTimeHeads(int actorCompanyId, int userId, int roleId, SoeRecalculateTimeHeadAction recalculateAction, bool loadRecords, bool showHistory, bool setExtensionNames, DateTime? dateFrom, DateTime? dateTo, int? limitNbrOfHeads)
        {
            if (dateFrom.HasValue)
                dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            if (dateTo.HasValue)
                dateTo = CalendarUtility.GetEndOfDay(dateTo);

            List<RecalculateTimeHead> heads = new List<RecalculateTimeHead>();

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, userId, roleId);
                    if (employees.IsNullOrEmpty())
                        return heads;

                    List<int> employeeIds = employees.Select(i => i.EmployeeId).ToList();

                    // Read uncommited to be able to see records being generated/modified
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_READUNCOMMITED))
                    {
                        IQueryable<RecalculateTimeHead> query = (from h in entities.RecalculateTimeHead
                                                                 where h.ActorCompanyId == actorCompanyId &&
                                                                 h.Action == (int)recalculateAction &&
                                                                 h.State == (int)SoeEntityState.Active &&
                                                                 (!dateFrom.HasValue || h.Created >= dateFrom.Value) &&
                                                                 (!dateTo.HasValue || h.Created <= dateTo.Value)
                                                                 orderby h.Created descending
                                                                 select h);

                        if (loadRecords)
                        {
                            query = query.Include("RecalculateTimeRecord");
                            if (setExtensionNames)
                                query = query.Include("RecalculateTimeRecord.Employee.ContactPerson");
                        }

                        if (!showHistory)
                        {
                            DateTime errorDateLimit = DateTime.Today.AddDays(-1);
                            query = query.Where(h =>
                                (h.Status == (int)TermGroup_RecalculateTimeHeadStatus.Started ||
                                h.Status == (int)TermGroup_RecalculateTimeHeadStatus.Unprocessed ||
                                h.Status == (int)TermGroup_RecalculateTimeHeadStatus.UnderProcessing) ||
                                (h.Status == (int)TermGroup_RecalculateTimeHeadStatus.Error && h.Created > errorDateLimit));
                        }

                        if (limitNbrOfHeads.HasValue)
                            query = query.Take(limitNbrOfHeads.Value);

                        heads = query.ToList();

                        heads.ForEach(head => head.RecalculateTimeRecord.RemoveRange(head.RecalculateTimeRecord.Where(record => !employeeIds.Contains(record.EmployeeId))));
                        heads = heads.Where(head => head.RecalculateTimeRecord.Any()).ToList();

                        if (setExtensionNames)
                            SetRecalculateTimeHeadExtensionNames(heads);
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
            }

            return heads;
        }

        public RecalculateTimeHead GetRecalculateTimeHead(int actorCompanyId, int recalculateTimeHeadId, bool loadRecords, bool setExtensionNames)
        {
            RecalculateTimeHead head = null;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    // Read uncommited to be able to see records being generated/modified
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_READUNCOMMITED))
                    {
                        IQueryable<RecalculateTimeHead> query = (from h in entities.RecalculateTimeHead
                                                                 where h.ActorCompanyId == actorCompanyId &&
                                                                 h.RecalculateTimeHeadId == recalculateTimeHeadId &&
                                                                 h.State == (int)SoeEntityState.Active
                                                                 select h);

                        if (loadRecords)
                        {
                            query = query.Include("RecalculateTimeRecord");

                            if (setExtensionNames)
                                query = query.Include("RecalculateTimeRecord.Employee.ContactPerson");
                        }

                        head = query.FirstOrDefault();

                        if (setExtensionNames)
                            SetRecalculateTimeHeadExtensionNames(new List<RecalculateTimeHead>() { head });
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
            }

            return head;
        }

        public int GetRecalculateTimeHeadId(int actorCompanyId, int userId, Guid guid)
        {
            if (guid == Guid.Empty)
                return 0;

            int headId = 0;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    // Read uncommited to be able to see records being generated/modified
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_READUNCOMMITED))
                    {
                        headId = (from h in entities.RecalculateTimeHead
                                  where h.ActorCompanyId == actorCompanyId &&
                                  h.UserId == userId &&
                                  h.Guid == guid
                                  orderby h.Created
                                  select h.RecalculateTimeHeadId).FirstOrDefault();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
            }

            return headId;
        }

        private void SetRecalculateTimeHeadExtensionNames(List<RecalculateTimeHead> heads)
        {
            List<GenericType> headStatuses = GetTermGroupContent(TermGroup.RecalculateTimeHeadStatus);
            List<GenericType> recordStatuses = GetTermGroupContent(TermGroup.RecalculateTimeRecordStatus);

            foreach (RecalculateTimeHead head in heads)
            {
                if (head == null)
                    continue;

                head.StatusName = headStatuses.FirstOrDefault(s => s.Id == head.Status)?.Name ?? String.Empty;

                foreach (RecalculateTimeRecord record in head.RecalculateTimeRecord)
                {
                    record.StatusName = recordStatuses.FirstOrDefault(s => s.Id == record.Status)?.Name ?? String.Empty;
                }
            }
        }

        public List<RecalculateTimeHead> GetRecalculateTimeHeadsToProcess(SoeRecalculateTimeHeadAction action, List<DateTime> dates, int? actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.RecalculateTimeHead.NoTracking();
            return GetRecalculateTimeHeadsToProcess(entities, action, dates, actorCompanyId);
        }

        public List<RecalculateTimeHead> GetRecalculateTimeHeadsToProcess(CompEntities entities, SoeRecalculateTimeHeadAction action, List<DateTime> dates, int? actorCompanyId)
        {
            if (!dates.Any())
                return new List<RecalculateTimeHead>();

            DateTime executeDateStart = dates.Min().Date.AddDays(-30); //Check backwards because job may been down for days
            DateTime executeDateStop = dates.Max().Date.AddDays(1).AddMinutes(-1);

            return (from rt in entities.RecalculateTimeHead
                    where rt.Action == (int)action &&
                    (rt.Status == (int)TermGroup_RecalculateTimeHeadStatus.Unprocessed || rt.Status == (int)TermGroup_RecalculateTimeHeadStatus.UnderProcessing) &&
                    (rt.ExcecutedStartTime >= executeDateStart && rt.ExcecutedStartTime <= executeDateStop) &&
                    (!actorCompanyId.HasValue || actorCompanyId.Value == rt.ActorCompanyId) &&
                    rt.State == (int)SoeEntityState.Active
                    select rt).ToList();
        }

        public List<RecalculateTimeHead> GetHangingRecalculateTimeHeadsToProcess(SoeRecalculateTimeHeadAction action, List<DateTime> dates, int? actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.RecalculateTimeHead.NoTracking();
            return GetRecalculateTimeHeadsToProcess(entities, action, dates, actorCompanyId);
        }

        public List<RecalculateTimeHead> GetHangingRecalculateTimeHeadsToProcess(CompEntities entities, SoeRecalculateTimeHeadAction action, List<DateTime> dates, int? actorCompanyId)
        {
            if (!dates.Any())
                return new List<RecalculateTimeHead>();

            DateTime executeDateStart = dates.Min().Date.AddDays(-30); //Check backwards because job may been down for days
            DateTime executeDateStop = dates.Max().Date.AddDays(1).AddMinutes(-1);

            var heads = (from rt in entities.RecalculateTimeHead
                    .Include("RecalculateTimeRecord")
                         where rt.Action == (int)action &&
                         rt.Status == (int)TermGroup_RecalculateTimeHeadStatus.Started &&
                         (rt.ExcecutedStartTime >= executeDateStart && rt.ExcecutedStartTime <= executeDateStop) &&
                         (!actorCompanyId.HasValue || actorCompanyId.Value == rt.ActorCompanyId) &&
                         rt.State == (int)SoeEntityState.Active
                         select rt).ToList();

            return heads.Where(h => h.RecalculateTimeRecord.Any(r => r.Status == (int)TermGroup_RecalculateTimeRecordStatus.Unprocessed)).ToList();
        }


        #endregion

        #region RecalculateTimeRecord

        public List<RecalculateTimeRecord> GetScheduledPlacements(int employeeId, DateTime? startDate = null, DateTime? stopDate = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.RecalculateTimeRecord.NoTracking();
            return GetScheduledPlacements(entities, employeeId, startDate, stopDate);
        }

        public List<RecalculateTimeRecord> GetScheduledPlacements(CompEntities entities, int employeeId, DateTime? startDate = null, DateTime? stopDate = null)
        {
            List<RecalculateTimeRecord> recalculateTimeRecords = (from rtr in entities.RecalculateTimeRecord
                                                                  where rtr.Status == (int)TermGroup_RecalculateTimeRecordStatus.Unprocessed &&
                                                                  rtr.EmployeeId == employeeId &&
                                                                  rtr.RecalculateTimeHead.State == (int)SoeEntityState.Active
                                                                  select rtr).ToList();

            return recalculateTimeRecords.Filter(startDate, stopDate);
        }

        public List<RecalculateTimeRecord> GetScheduledPlacements(CompEntities entities, List<int> employeeIds, DateTime? startDate = null, DateTime? stopDate = null)
        {
            List<RecalculateTimeRecord> recalculateTimeRecords = (from rtr in entities.RecalculateTimeRecord
                                                                  where rtr.Status == (int)TermGroup_RecalculateTimeRecordStatus.Unprocessed &&
                                                                  employeeIds.Contains(rtr.EmployeeId) &&
                                                                  rtr.RecalculateTimeHead.State == (int)SoeEntityState.Active
                                                                  select rtr).ToList();

            return recalculateTimeRecords.Filter(startDate, stopDate);
        }

        public List<RecalculateTimeRecord> GetScheduledPlacementsForCompany(int actorCompanyId, List<int> employeeIds, DateTime? startDate = null, DateTime? stopDate = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.RecalculateTimeRecord.NoTracking();
            return GetScheduledPlacementsForCompany(entities, actorCompanyId, employeeIds, startDate, stopDate);
        }

        public List<RecalculateTimeRecord> GetScheduledPlacementsForCompany(CompEntities entities, int actorCompanyId, List<int> employeeIds, DateTime? startDate = null, DateTime? stopDate = null)
        {
            IQueryable<RecalculateTimeRecord> query = entities.RecalculateTimeRecord;

            if (!employeeIds.IsNullOrEmpty())
                query = query.Where(e => employeeIds.Contains(e.EmployeeId));

            var schedulePlacements = query
                .Where(r =>
                    r.Status == (int)TermGroup_RecalculateTimeRecordStatus.Unprocessed &&
                    r.RecalculateTimeHead.ActorCompanyId == actorCompanyId &&
                    r.RecalculateTimeHead.State == (int)SoeEntityState.Active)
                .ToList();

            return schedulePlacements.Filter(startDate, stopDate);
        }

        public List<int> GetEmployeeIdsWithScheduledPlacements(int actorCompanyId, List<int> employeeIds, DateTime? startDate = null, DateTime? stopDate = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.RecalculateTimeRecord.NoTracking();
            return GetEmployeeIdsWithScheduledPlacements(entities, actorCompanyId, employeeIds, startDate, stopDate);
        }

        public List<int> GetEmployeeIdsWithScheduledPlacements(CompEntities entities, int actorCompanyId, List<int> employeeIds, DateTime? startDate = null, DateTime? stopDate = null)
        {
            return GetScheduledPlacementsForCompany(entities, actorCompanyId, employeeIds, startDate, stopDate).Select(r => r.EmployeeId).Distinct().ToList();
        }

        public RecalculateTimeRecord GetRecalculateTimeRecordWithHead(CompEntities entities, int actorCompanyId, int recalculateTimeRecordId)
        {
            return entities.RecalculateTimeRecord.Include("RecalculateTimeHead").FirstOrDefault(r => r.RecalculateTimeRecordId == recalculateTimeRecordId && r.RecalculateTimeHead.ActorCompanyId == actorCompanyId);
        }

        public bool HasEmployeeAnySchedulePlacements(CompEntities entities, int employeeId)
        {
            //When placement is deleted, all TimeScheduleTemplateBlock's is set to deleted, therefore must check that schedule placement has active TimeScheduleTemplateBlock's
            return (from r in entities.RecalculateTimeRecord
                    where r.EmployeeId == employeeId &&
                    r.Status == (int)TermGroup_RecalculateTimeRecordStatus.Unprocessed &&
                    r.RecalculateTimeHead.State == (int)SoeEntityState.Active &&
                    r.TimeScheduleTemplateBlock.Any(tb => tb.State == (int)SoeEntityState.Active)
                    select r).Any();
        }

        public ActionResult CancelRecalculateTimeHead(int actorCompanyId, int userId, bool isSupportAdmin, int recalculateTimeHeadId)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    // Read uncommited to be able to see records being modified
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_READUNCOMMITED))
                    {
                        RecalculateTimeHead head = (from h in entities.RecalculateTimeHead.Include("RecalculateTimeRecord")
                                                    where h.ActorCompanyId == actorCompanyId &&
                                                    h.RecalculateTimeHeadId == recalculateTimeHeadId &&
                                                    h.State == (int)SoeEntityState.Active
                                                    select h).FirstOrDefault();

                        if (head != null && head.Status == (int)TermGroup_RecalculateTimeHeadStatus.Started)
                        {
                            if (head.UserId.HasValue && head.UserId.Value != userId && !isSupportAdmin)
                                return new ActionResult(0, GetText(11112, 1004, "Du kan inte avbryta en aktivering du själv inte startat"));

                            head.Status = (int)TermGroup_RecalculateTimeHeadStatus.Unprocessed;

                            foreach (RecalculateTimeRecord record in head.RecalculateTimeRecord.Where(r => r.Status == (int)TermGroup_RecalculateTimeRecordStatus.Waiting).ToList())
                            {
                                record.Status = (int)TermGroup_RecalculateTimeRecordStatus.Cancelled;
                                record.ErrorMsg = String.Format(GetText(11110, 1004, "Avbruten av {0} {1}"), GetUserDetails(), CalendarUtility.ToShortDateTimeString(DateTime.Now));
                            }
                        }

                        result = SaveChanges(entities);

                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (entities.Connection.State != ConnectionState.Closed)
                        entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult SetRecalculateTimeHeadToProcessed(int actorCompanyId, int userId, bool isSupportAdmin, int recalculateTimeHeadId)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    // Read uncommited to be able to see records being modified
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_READUNCOMMITED))
                    {
                        RecalculateTimeHead head = (from h in entities.RecalculateTimeHead.Include("RecalculateTimeRecord")
                                                    where h.ActorCompanyId == actorCompanyId &&
                                                    h.RecalculateTimeHeadId == recalculateTimeHeadId &&
                                                    h.State == (int)SoeEntityState.Active
                                                    select h).FirstOrDefault();

                        if (head != null && head.Status != (int)TermGroup_RecalculateTimeHeadStatus.Processed &&
                            head.RecalculateTimeRecord.Count(r => r.Status != (int)TermGroup_RecalculateTimeRecordStatus.Processed && r.Status != (int)TermGroup_RecalculateTimeRecordStatus.Error && r.Status != (int)TermGroup_RecalculateTimeRecordStatus.Cancelled) == 0)
                        {
                            head.Status = (int)TermGroup_RecalculateTimeHeadStatus.Processed;
                        }

                        result = SaveChanges(entities);

                        if (result.Success)
                            transaction.Complete();
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (entities.Connection.State != ConnectionState.Closed)
                        entities.Connection.Close();
                }
            }

            return result;
        }

        public ActionResult CancelRecalculateTimeRecord(int actorCompanyId, int userId, bool isSupportAdmin, int recalculateTimeRecordId)
        {
            ActionResult result = new ActionResult(true);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    if (entities.Connection.State != ConnectionState.Open)
                        entities.Connection.Open();

                    // Read uncommited to be able to see records being modified
                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_READUNCOMMITED))
                    {
                        RecalculateTimeRecord record = GetRecalculateTimeRecordWithHead(entities, actorCompanyId, recalculateTimeRecordId);
                        if (record?.RecalculateTimeHead != null)
                        {
                            if (record.Status != (int)TermGroup_RecalculateTimeRecordStatus.Waiting || (record.RecalculateTimeHead.Status != (int)TermGroup_RecalculateTimeHeadStatus.Processed && record.RecalculateTimeHead.Status != (int)TermGroup_RecalculateTimeHeadStatus.Error))
                                return new ActionResult(0, GetText(11111, 1004, "Felaktig status för att kunna avbryta"));
                            if (record.RecalculateTimeHead.UserId.HasValue && record.RecalculateTimeHead.UserId.Value != userId && !isSupportAdmin)
                                return new ActionResult(0, GetText(11112, 1004, "Du kan inte avbryta en aktivering du själv inte startat"));

                            record.Status = (int)TermGroup_RecalculateTimeRecordStatus.Cancelled;
                            record.ErrorMsg = String.Format(GetText(11110, 1004, "Avbruten av {0} {1}"), GetUserDetails(), CalendarUtility.ToShortDateTimeString(DateTime.Now));
                            result = SaveChanges(entities);

                            if (result.Success)
                                transaction.Complete();
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                }
                finally
                {
                    if (entities.Connection.State != ConnectionState.Closed)
                        entities.Connection.Close();
                }
            }

            return result;
        }

        #endregion

        #region GrossNetCostDTO

        #region Convert to GrossNetCostDTO

        public void CalculateGrossNetAndCost(IEnumerable<TimeSchedulePlanningDayDTO> dtos, int actorCompanyId, int userId, int roleId, bool onlyActive, bool includeEmploymentTaxAndSupplementChargeCost, bool doNotCheckHoliday = false, List<Employee> employees = null)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            CalculateGrossNetAndCost(entitiesReadOnly, dtos, actorCompanyId, userId, roleId, onlyActive, includeEmploymentTaxAndSupplementChargeCost, doNotCheckHoliday, employees);
        }

        public void CalculateGrossNetAndCost(CompEntities entities, IEnumerable<TimeSchedulePlanningDayDTO> dtos, int actorCompanyId, int userId, int roleId, bool onlyActive, bool includeEmploymentTaxAndSupplementChargeCost, bool doNotCheckHoliday = false, List<Employee> employees = null)
        {
            bool byTransactions = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.PayrollAgreementUseGrossNetTimeInStaffing_ByTransactions, 0, actorCompanyId, 0);
            if (byTransactions)
            {
                CalculateGrossNetAndCost_ByTransactions(entities, dtos, actorCompanyId);
            }
            else
            {
                //Convert to GrossNetPriceDTO
                var grossNetCosts = new List<GrossNetCostDTO>();
                foreach (var dto in dtos.Where(d => !d.IsOnDuty()))
                {
                    grossNetCosts.Add(GrossNetCostDTO.Create(dto));
                }

                //Calculate Gross/Net/Cost
                CalculateGrossNetAndCost(entities, grossNetCosts, actorCompanyId, userId, roleId, onlyActive, includeEmploymentTaxAndSupplementChargeCost, doNotCheckHoliday, employees: employees);

                //Synch TimeSchedulePlanningDayDTO with GrossNetCostDTO
                foreach (var grossNetCost in grossNetCosts)
                {
                    grossNetCost.SynchTimeAndCost(dtos);
                }
            }
        }

        #endregion

        #region Cached properties

        private bool? gncHasShowCostsPermission = null;
        private bool? gncUseTemplateCost = null;
        private decimal? gncTemplateCost = null;
        private int? gncSysCountryId = null;

        private List<EmploymentPriceTypeView> gncPriceTypeItemsCompany = null;
        private List<TimeRule> gncTimeRulesCompany = null;
        private List<HolidayDTO> gncHolidaysCompany = null;
        private List<DayType> gncDayTypesCompany = null;
        private List<PayrollGroupAccountStd> gncPayrollGroupAccountStds = null;
        private List<TimeScheduleType> gncTimeScheduleTypes = null;

        #endregion

        public void CalculateGrossNetAndCost(List<GrossNetCostDTO> grossNetCosts, int actorCompanyId, int userId, int roleId, bool onlyActive, bool includeEmploymentTaxAndSupplementChargeCost, bool doNotCheckHoliday = false, List<GrossNetCostDTO> prevCalculatedGrossNetCosts = null, List<EmployeeGroup> employeeGroups = null, List<PayrollGroup> payrollGroups = null, List<Employee> employees = null, EvaluatePayrollPriceFormulaInputDTO iDTO = null, Dictionary<int, List<TimePayrollTransactionDTO>> timepayrollTransactions = null)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            CalculateGrossNetAndCost(entitiesReadOnly, grossNetCosts, actorCompanyId, userId, roleId, onlyActive, includeEmploymentTaxAndSupplementChargeCost, doNotCheckHoliday, prevCalculatedGrossNetCosts, employeeGroups, payrollGroups, employees, iDTO, timepayrollTransactions);
        }

        public void CalculateGrossNetAndCost(CompEntities entities, List<GrossNetCostDTO> grossNetCosts, int actorCompanyId, int userId, int roleId, bool onlyActive, bool includeEmploymentTaxAndSupplementChargeCost, bool doNotCheckHoliday = false, List<GrossNetCostDTO> prevCalculatedGrossNetCosts = null, List<EmployeeGroup> employeeGroups = null, List<PayrollGroup> payrollGroups = null, List<Employee> employees = null, EvaluatePayrollPriceFormulaInputDTO iDTO = null, Dictionary<int, List<TimePayrollTransactionDTO>> timepayrollTransactionsDict = null)
        {
            #region Prereq

            if (grossNetCosts.IsNullOrEmpty())
                return;

            bool useGrossNetTimeInStaffing = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.PayrollAgreementUseGrossNetTimeInStaffing, 0, actorCompanyId, 0);
            if (!useGrossNetTimeInStaffing)
                return;

            if (!this.gncHasShowCostsPermission.HasValue)
                this.gncHasShowCostsPermission = FeatureManager.HasRolePermission(Feature.Time_Schedule_SchedulePlanning_ShowCosts, Permission.Readonly, roleId, actorCompanyId, entities: entities);
            if (!this.gncUseTemplateCost.HasValue)
                this.gncUseTemplateCost = this.gncHasShowCostsPermission.Value && SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.StaffingUseTemplateCost, 0, actorCompanyId, 0);
            if (!this.gncTemplateCost.HasValue)
                this.gncTemplateCost = this.gncUseTemplateCost.Value ? SettingManager.GetDecimalSetting(entities, SettingMainType.Company, (int)CompanySettingType.StaffingTemplateCost, 0, actorCompanyId, 0) : 0;
            if (!this.gncSysCountryId.HasValue)
                this.gncSysCountryId = base.GetCompanySysCountryIdFromCache(entities, actorCompanyId);
            if (this.gncPriceTypeItemsCompany == null)
                this.gncPriceTypeItemsCompany = this.gncHasShowCostsPermission.Value && !this.gncUseTemplateCost.Value ? EmployeeManager.GetEmploymentPriceTypeViews(entities, actorCompanyId) : new List<EmploymentPriceTypeView>();
            if (this.gncTimeRulesCompany == null)
                this.gncTimeRulesCompany = TimeRuleManager.GetAllTimeRulesRecursive(entities, actorCompanyId, onlyIwh: true);
            if (this.gncHolidaysCompany == null)
                this.gncHolidaysCompany = CalendarManager.GetHolidaysByCompanyWithDayTypeAndHalfDay(entities, actorCompanyId);
            if (this.gncDayTypesCompany == null)
                this.gncDayTypesCompany = CalendarManager.GetDayTypesWithStandardWeekDay(entities, actorCompanyId);
            if (this.gncPayrollGroupAccountStds == null)
                this.gncPayrollGroupAccountStds = PayrollManager.GetPayrollGroupAccountStdsForCompany(entities, actorCompanyId);
            if (this.gncTimeScheduleTypes == null)
                this.gncTimeScheduleTypes = TimeScheduleManager.GetTimeScheduleTypes(entities, actorCompanyId, loadFactors: true);

            List<SysPayrollPriceViewDTO> sysPayrollPriceView = PayrollManager.GetSysPayrollPriceView(gncSysCountryId.Value);

            bool dayTypesSet = false;
            if (grossNetCosts.GroupBy(g => g.EmployeeId).Count() == 1)
            {
                var employee = employees?.FirstOrDefault(f => f.EmployeeId == grossNetCosts.FirstOrDefault()?.EmployeeId);
                if (employee != null)
                {
                    TimeEngineManager(actorCompanyId, userId, entities).CalculateDayTypeForEmployees(grossNetCosts, doNotCheckHoliday, gncHolidaysCompany, gncDayTypesCompany, employee);
                    dayTypesSet = true;
                }
            }

            if (!dayTypesSet)
                TimeEngineManager(actorCompanyId, userId, entities).CalculateDayTypeForEmployees(grossNetCosts, doNotCheckHoliday, gncHolidaysCompany, gncDayTypesCompany);

            Dictionary<int, decimal> settingPayrollGroupMonthlyWorkTimeDict = new Dictionary<int, decimal>();
            Dictionary<int, int> settingPayrollGroupMonthlyWorkCalcTypeDict = new Dictionary<int, int>();

            if (iDTO == null && grossNetCosts.Any())
            {
                iDTO = new EvaluatePayrollPriceFormulaInputDTO()
                {
                    SysCountryId = base.GetCompanySysCountryIdFromCache(entities, actorCompanyId),
                    EmployeeGroups = employeeGroups ?? base.GetEmployeeGroupsFromCache(entities, CacheConfig.Company(actorCompanyId)),
                    PayrollGroups = payrollGroups ?? base.GetPayrollGroupsFromCache(entities, CacheConfig.Company(actorCompanyId), loadSettings: true),
                    PayrollPriceTypes = base.GetPayrollPriceTypesFromCache(entities, CacheConfig.Company(actorCompanyId)),
                    EmploymentPriceTypesDict = EmployeeManager.GetEmploymentPriceTypesForCompany(entities, actorCompanyId, grossNetCosts.Select(s => s.EmployeeId).Distinct().ToList()).GroupBy(k => k.EmploymentId).ToDictionary(k => k.Key, v => v.ToList()),
                    PayrollGroupPriceTypes = base.GetPayrollGroupPriceTypesForCompanyFromCache(entities, CacheConfig.Company(actorCompanyId)),
                    PayrollProductPriceTypes = base.GetPayrollProductPriceTypesForCompanyFromCache(entities, CacheConfig.Company(actorCompanyId)),
                    PayrollProductPriceFormulas = ProductManager.GetPayrollProductPriceFormulas(entities, actorCompanyId),
                    PayrollPriceFormulas = base.GetPayrollPriceFormulasFromCache(entities, CacheConfig.Company(actorCompanyId)),
                    SysPayrollPriceViews = SysDbCache.Instance.SysPayrollPriceViewDTOs,
                    TimePeriods = TimePeriodManager.GetTimePeriods(entities, TermGroup_TimePeriodType.Payroll, actorCompanyId, addTimePeriodHeadName: false),
                    EmployeeFactorsDict = base.GetEmployeeFactorsFromCache(entities, CacheConfig.Company(actorCompanyId)).GroupBy(g => g.EmployeeId).ToDictionary(k => k.Key, v => v.ToList()),
                    PayrollProducts = base.GetPayrollProductsFromCache(entities, CacheConfig.Company(actorCompanyId))
                };
            }

            var payrollProductIdSettingsWithDontIncludeInAbsenceCost = iDTO?.PayrollProducts?.SelectMany(s => s.PayrollProductSetting.Where(w => w.DontIncludeInAbsenceCost)).Select(s => s.ProductId).ToList() ?? new List<int>();
            bool hasAnyDontIncludeInAbsenceCostSetting = payrollProductIdSettingsWithDontIncludeInAbsenceCost.Any();

            #endregion

            foreach (var grossNetCostsForEmployee in grossNetCosts.GroupBy(i => i.EmployeeId))
            {
                Employee employee = employees?.FirstOrDefault(f => f.EmployeeId == grossNetCostsForEmployee.Key) ?? EmployeeManager.GetEmployee(entities, grossNetCostsForEmployee.Key, actorCompanyId, onlyActive: onlyActive, loadEmployment: true, loadContactPerson: true);
                if (employee == null)
                    continue;

                List<Employment> employments = employee.GetActiveEmployments();
                if (employments.IsNullOrEmpty())
                    continue;

                DateTime? birthDate = includeEmploymentTaxAndSupplementChargeCost ? EmployeeManager.GetEmployeeBirthDate(employee) : (DateTime?)null;
                Dictionary<int, List<EmploymentPriceTypeDTO>> employmentPriceTypesDict = new Dictionary<int, List<EmploymentPriceTypeDTO>>();
                Dictionary<int, List<PayrollGroupPriceTypeDTO>> payrollGroupPriceTypesDict = new Dictionary<int, List<PayrollGroupPriceTypeDTO>>();
                Dictionary<DateTime, decimal> sysPayrollPriceIntervalAmountDict = new Dictionary<DateTime, decimal>();
                Dictionary<DateTime, SysPayrollPriceViewDTO> sysPayrollPriceViewDict = new Dictionary<DateTime, SysPayrollPriceViewDTO>();
                List<TimeEmployeeScheduleDataSmallDTO> schedules = new List<TimeEmployeeScheduleDataSmallDTO>();
                bool schedulesLoaded = false;
                Dictionary<DateTime, decimal> monthDevisorDict = new Dictionary<DateTime, decimal>();
                payrollGroups = !payrollGroups.IsNullOrEmpty() ? base.GetPayrollGroupsFromCache(entities, CacheConfig.Company(actorCompanyId)) : payrollGroups;

                List<GrossNetCostDTO> grossNetCostsForEmployeeSorted = grossNetCostsForEmployee.OrderBy(i => i.StartTime).ThenBy(i => i.StopTime).ToList();
                Dictionary<int, List<TimePayrollTransactionDTO>> transactionsForEmployee = null;
                if (grossNetCostsForEmployeeSorted.Any(a => a.TimeDeviationCauseId.HasValue) && this.gncHasShowCostsPermission.Value && SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UsePayroll, 0, base.ActorCompanyId, 0))
                {
                    if (timepayrollTransactionsDict == null)
                        transactionsForEmployee = TimeTransactionManager.GetTimePayrollTransactionDTOForReport(entities, grossNetCostsForEmployeeSorted.Min(m => m.StartTime.Date), CalendarUtility.GetBeginningOfDay(grossNetCostsForEmployeeSorted.Max(m => m.StopTime.Date)), employee.EmployeeId.ObjToList(), base.ActorCompanyId);
                    else
                        transactionsForEmployee = timepayrollTransactionsDict.Where(w => w.Key == employee.EmployeeId).Select(s => s.Value).ToDictionary(k => employee.EmployeeId, v => v.ToList());
                }

                foreach (GrossNetCostDTO grossNetCost in grossNetCostsForEmployeeSorted)
                {
                    #region Prereq

                    if (grossNetCost.TimeDeviationCauseId.HasValue && this.gncHasShowCostsPermission.Value)
                    {
                        if (!transactionsForEmployee.IsNullOrEmpty() && transactionsForEmployee.ContainsKey(employee.EmployeeId))
                        {
                            var absenceTransactionsForEmployee = transactionsForEmployee[employee.EmployeeId].Where(w => w.IsAbsenceCost() && w.Amount != 0 && w.TimeDeviationCauseStartId == grossNetCost.TimeDeviationCauseId.Value && w.Date == grossNetCost.StartTime.Date).ToList();

                            if (!absenceTransactionsForEmployee.IsNullOrEmpty())
                            {
                                if (grossNetCostsForEmployeeSorted.Count(f => f.StartTime.Date == grossNetCost.StartTime.Date) > 1)
                                    absenceTransactionsForEmployee = absenceTransactionsForEmployee.Where(w => (!w.StartTime.HasValue || w.StartTime == CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, grossNetCost.StartTime))).ToList();

                                if (hasAnyDontIncludeInAbsenceCostSetting)
                                    absenceTransactionsForEmployee = absenceTransactionsForEmployee.Where(w => !payrollProductIdSettingsWithDontIncludeInAbsenceCost.Contains(w.PayrollProductId)).ToList();
                                var matchedTransactions = absenceTransactionsForEmployee.Where(w => w.Quantity != 0 && w.Date == grossNetCost.StartTime.Date).ToList();

                                if (matchedTransactions.Any() && matchedTransactions.Sum(s => s.Quantity) != 0)
                                {
                                    grossNetCost.TotalCost = matchedTransactions.Sum(s => s.Amount);
                                    grossNetCost.CostPerHour = (matchedTransactions.Sum(s => s.Amount) / matchedTransactions.Sum(s => s.Quantity)) * 60;
                                    grossNetCost.IsAbsenceCost = true;
                                }
                                else
                                    continue;
                            }
                            else
                                continue;
                        }
                        else
                            continue;
                    }

                    Employment employment = employments.GetEmployment(grossNetCost.StartTime.Date);
                    if (employment == null)
                        continue;

                    EmployeeGroup employeeGroup = employment.GetEmployeeGroup(grossNetCost.StartTime.Date, employeeGroups);
                    if (employeeGroup == null)
                        continue;

                    grossNetCost.EmployeeGroupId = employeeGroup.EmployeeGroupId;

                    int? payrollGroupId = employment.GetPayrollGroupId(grossNetCost.StartTime.Date);
                    grossNetCost.PayrollGroupId = payrollGroupId;

                    #region Check previous calculations

                    if (prevCalculatedGrossNetCosts != null)
                    {
                        GrossNetCostDTO prevCalculatedGrossNetCost = GrossNetCostDTO.FindIdentical(grossNetCost, prevCalculatedGrossNetCosts.Where(i => i.StartTime.Date == grossNetCost.StartTime.Date).ToList());
                        if (prevCalculatedGrossNetCost != null)
                        {
                            grossNetCost.Update(prevCalculatedGrossNetCost);
                            continue;
                        }
                    }

                    #endregion

                    if (payrollGroupId.HasValue && !settingPayrollGroupMonthlyWorkTimeDict.ContainsKey(payrollGroupId.Value))
                    {
                        PayrollGroupSetting settingMonthlyWorkTime = null;

                        payrollGroups = base.GetPayrollGroupsFromCache(entities, CacheConfig.Company(actorCompanyId), loadSettings: true);

                        if (payrollGroups != null)
                            settingMonthlyWorkTime = payrollGroups?.FirstOrDefault(pg => pg.PayrollGroupId == payrollGroupId.Value)?.PayrollGroupSetting?.FirstOrDefault(s => s.Type == (int)PayrollGroupSettingType.MonthlyWorkTime);
                        else
                            settingMonthlyWorkTime = PayrollManager.GetPayrollGroupSetting(entities, payrollGroupId.Value, PayrollGroupSettingType.MonthlyWorkTime, payrollGroups: iDTO?.PayrollGroups);

                        if (settingMonthlyWorkTime != null && settingMonthlyWorkTime.DecimalData.HasValue)
                            settingPayrollGroupMonthlyWorkTimeDict.Add(payrollGroupId.Value, settingMonthlyWorkTime.DecimalData.Value);
                    }

                    if (payrollGroupId.HasValue && !settingPayrollGroupMonthlyWorkCalcTypeDict.ContainsKey(payrollGroupId.Value))
                    {
                        PayrollGroupSetting settingMonthlyWorkTimeCalc = null;

                        payrollGroups = base.GetPayrollGroupsFromCache(entities, CacheConfig.Company(actorCompanyId), loadSettings: true);

                        if (payrollGroups != null)
                            settingMonthlyWorkTimeCalc = payrollGroups?.FirstOrDefault(pg => pg.PayrollGroupId == payrollGroupId.Value)?.PayrollGroupSetting?.FirstOrDefault(s => s.Type == (int)PayrollGroupSettingType.MonthlyWorkTimeCalculationType);
                        else
                            settingMonthlyWorkTimeCalc = PayrollManager.GetPayrollGroupSetting(entities, payrollGroupId.Value, PayrollGroupSettingType.MonthlyWorkTimeCalculationType, payrollGroups: iDTO?.PayrollGroups);

                        if (settingMonthlyWorkTimeCalc != null && settingMonthlyWorkTimeCalc.IntData.HasValue)
                            settingPayrollGroupMonthlyWorkCalcTypeDict.Add(payrollGroupId.Value, settingMonthlyWorkTimeCalc.IntData.Value);
                    }

                    int timeDeviationCauseId = TimeDeviationCauseManager.GetTimeDeviationCauseIdFromPrio(employment.Employee.TimeDeviationCauseId, employeeGroup.TimeDeviationCauseId);

                    #endregion

                    #region Calculate time

                    //Schedule
                    DateTime scheduleStart = grossNetCost.StartTime;
                    DateTime scheduleStop = grossNetCost.StopTime;

                    //Breaks
                    DateTime break1Start = grossNetCost.Break1StartTime;
                    DateTime break1Stop = grossNetCost.Break1StartTime.AddMinutes(grossNetCost.Break1Minutes);
                    DateTime break2Start = grossNetCost.Break2StartTime;
                    DateTime break2Stop = grossNetCost.Break2StartTime.AddMinutes(grossNetCost.Break2Minutes);
                    DateTime break3Start = grossNetCost.Break3StartTime;
                    DateTime break3Stop = grossNetCost.Break3StartTime.AddMinutes(grossNetCost.Break3Minutes);
                    DateTime break4Start = grossNetCost.Break4StartTime;
                    DateTime break4Stop = grossNetCost.Break4StartTime.AddMinutes(grossNetCost.Break4Minutes);

                    #region Net time (schedule)

                    if (!grossNetCost.IsAbsenceCost)
                    {
                        //Add total schedule time (included breaks)
                        grossNetCost.NetTime = (scheduleStart - scheduleStop).Duration();

                        //Get break 1 time in schedule
                        grossNetCost.BreakTime = grossNetCost.BreakTime.Add(CalendarUtility.GetNewTimeInCurrent(scheduleStart, scheduleStop, break1Start, break1Stop));
                        //Get break 2 time in schedule
                        grossNetCost.BreakTime = grossNetCost.BreakTime.Add(CalendarUtility.GetNewTimeInCurrent(scheduleStart, scheduleStop, break2Start, break2Stop));
                        //Get break 3 time in schedule
                        grossNetCost.BreakTime = grossNetCost.BreakTime.Add(CalendarUtility.GetNewTimeInCurrent(scheduleStart, scheduleStop, break3Start, break3Stop));
                        //Get break 4 time in schedule
                        grossNetCost.BreakTime = grossNetCost.BreakTime.Add(CalendarUtility.GetNewTimeInCurrent(scheduleStart, scheduleStop, break4Start, break4Stop));

                        //Subtract break time
                        grossNetCost.NetTime = grossNetCost.NetTime.Subtract(grossNetCost.BreakTime);

                        //Continue if no net time
                        if (grossNetCost.NetTime.TotalMinutes <= 0)
                            continue;
                    }

                    #endregion

                    #region Gross (net + inconvinient working hours)

                    //Gross
                    grossNetCost.GrossTime = new TimeSpan(grossNetCost.NetTime.Hours, grossNetCost.NetTime.Minutes, grossNetCost.NetTime.Seconds);

                    //Filter TimeRules
                    List<TimeRule> currentTimeRules = gncTimeRulesCompany.Filter(true, grossNetCost.StartTime.Date, timeDeviationCauseId, grossNetCost.CalculatedDayTypeId, employeeGroup.EmployeeGroupId, grossNetCost.TimeScheduleTypeId);

                    //Convert to IWH DTO
                    List<TimeRuleIwhDTO> timeRulesIwh = currentTimeRules.ToIwhDTOs().ToList();

                    bool factorOnPayrollProducts = true;

                    if (!grossNetCost.IsAbsenceCost)
                    {
                        foreach (TimeRuleIwhDTO timeRuleIwh in timeRulesIwh)
                        {
                            #region TimeRuleIwh

                            //Calculation not needed if factor is 1
                            if (timeRuleIwh.PayrollProductFactor <= 1)
                            {
                                factorOnPayrollProducts = false;
                                continue;
                            }

                            //IWH
                            DateTime ruleStart = CalendarUtility.GetDateTime(scheduleStart, timeRuleIwh.StartTime).AddDays((timeRuleIwh.StartTime.Date - CalendarUtility.DATETIME_DEFAULT).Days);
                            DateTime ruleStop = CalendarUtility.GetDateTime(scheduleStart, timeRuleIwh.StopTime).AddDays((timeRuleIwh.StopTime.Date - CalendarUtility.DATETIME_DEFAULT).Days);

                            //Get IWH time in schedule
                            TimeSpan iwhTime = CalendarUtility.GetNewTimeInCurrent(scheduleStart, scheduleStop, ruleStart, ruleStop);

                            TimeSpan iwhBreakTime = new TimeSpan();

                            //Get breaks time in IWH time
                            iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break1Start, break1Stop));
                            iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break2Start, break2Stop));
                            iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break3Start, break3Stop));
                            iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break4Start, break4Stop));

                            //Subtract break time
                            iwhTime = iwhTime.Subtract(iwhBreakTime);

                            //Continue if no IWH time
                            if (iwhTime.TotalMinutes <= 0)
                                continue;

                            //Subtract IWH time
                            grossNetCost.GrossTime = grossNetCost.GrossTime.Subtract(iwhTime);

                            //Add IWH time * factor
                            decimal iwhMinutes = (decimal)iwhTime.TotalMinutes * timeRuleIwh.PayrollProductFactor;
                            int iwhMinutesFloored = (int)Math.Floor(iwhMinutes);
                            int iwhSeconds = (int)((iwhMinutes - iwhMinutesFloored) * 60);
                            iwhTime = new TimeSpan(0, iwhMinutesFloored, iwhSeconds);
                            grossNetCost.GrossTime = grossNetCost.GrossTime.Add(iwhTime);

                            //Accumulate IWH time
                            grossNetCost.IwhTime += grossNetCost.IwhTime.Add(iwhTime);

                            #endregion
                        }
                    }

                    #endregion

                    #region Gross/net diff

                    grossNetCost.GrossNetDiff = grossNetCost.GrossTime.Subtract(grossNetCost.NetTime);

                    #endregion

                    #endregion

                    #region Calculate cost

                    if (this.gncHasShowCostsPermission.Value)
                    {
                        decimal iwhAmount = 0;
                        if (!grossNetCost.IsAbsenceCost)
                        {
                            if (this.gncUseTemplateCost.Value && this.gncTemplateCost.HasValue)
                            {
                                #region Template

                                grossNetCost.CostPerHour = this.gncTemplateCost.Value;

                                #endregion
                            }
                            else
                            {
                                #region Hourly/Fulltime

                                grossNetCost.CostPerHour = 0;

                                if (payrollGroupId.HasValue)
                                {
                                    decimal? devisor = null;
                                    var payrollGroup = payrollGroups.FirstOrDefault(f => f.PayrollGroupId == payrollGroupId);
                                    if (payrollGroup != null && settingPayrollGroupMonthlyWorkCalcTypeDict.TryGetValue(payrollGroup.PayrollGroupId, out int calcType) && calcType == (int)TermGroup_MonthlyWorkTimeCalculationType.ScheduledHoursPerMonth)
                                    {
                                        var dateFrom = grossNetCosts.OrderBy(o => o.StartTime.Date).First().StartTime.Date;
                                        var dateTo = grossNetCosts.OrderBy(o => o.StartTime.Date).Last().StopTime.Date;
                                        schedules = schedulesLoaded ? schedules : TimeScheduleManager.GetTimeEmployeeScheduleSmallDTOForReport(CalendarUtility.GetBeginningOfMonth(dateFrom), CalendarUtility.GetEndOfMonth(dateTo), employee.ObjToList(), actorCompanyId, base.RoleId, addAmounts: false, removeBreaks: true, forceSkipAccount: true); // Get all schedules independent of AccountId
                                        schedulesLoaded = true;
                                        var currentMonthStart = CalendarUtility.GetBeginningOfMonth(grossNetCost.StartTime.Date);
                                        var currentMonthEnd = CalendarUtility.GetEndOfMonth(grossNetCost.StartTime.Date);
                                        if (monthDevisorDict.ContainsKey(currentMonthStart) && monthDevisorDict.TryGetValue(currentMonthStart, out decimal currentDevisor))
                                            devisor = currentDevisor;
                                        else
                                        {
                                            int scheduledDays = schedules.Where(w => w.Date >= currentMonthStart && w.Date <= currentMonthEnd).Select(s => s.Date).Distinct().Count();
                                            int daysInMonth = currentMonthEnd.Day - currentMonthStart.Day + 1;
                                            decimal currentMonthDevisor = 0;
                                            // If scheduled days is less than there are days in the month, use devisor from payroll product setting instead
                                            if (scheduledDays >= daysInMonth)
                                            {
                                                currentMonthDevisor = schedules.Where(w => w.Date >= currentMonthStart && w.Date <= currentMonthEnd).Sum(s => s.QuantityHours);
                                            }
                                            monthDevisorDict.Add(currentMonthStart, currentMonthDevisor);
                                            devisor = currentMonthDevisor;
                                        }
                                        if (devisor == 0)
                                            devisor = null;
                                    }

                                    if (!employmentPriceTypesDict.ContainsKey(employment.EmploymentId))
                                    {
                                        if (iDTO?.EmploymentPriceTypesDict != null && iDTO.EmploymentPriceTypesDict.ContainsKey(employment.EmploymentId) && iDTO.EmploymentPriceTypesDict.TryGetValue(employment.EmploymentId, out List<EmploymentPriceType> value) && !value.IsNullOrEmpty())
                                            employmentPriceTypesDict.Add(employment.EmploymentId, value.ToDTOs(true, false).ToList());
                                        else
                                            employmentPriceTypesDict.Add(employment.EmploymentId, EmployeeManager.GetEmploymentPriceTypes(entities, employment.EmploymentId).ToDTOs(true, false).ToList());
                                    }
                                    if (payrollGroupId.HasValue && !payrollGroupPriceTypesDict.ContainsKey(payrollGroupId.Value))
                                    {
                                        if (iDTO?.PayrollGroupPriceTypes != null)
                                        {
                                            var matches = iDTO.PayrollGroupPriceTypes.Where(a => a.PayrollGroupId == payrollGroupId.Value);
                                            payrollGroupPriceTypesDict.Add(payrollGroupId.Value, matches.ToDTOs(true).ToList());
                                        }

                                        if (!payrollGroupPriceTypesDict.ContainsKey(payrollGroupId.Value))
                                            payrollGroupPriceTypesDict.Add(payrollGroupId.Value, PayrollManager.GetPayrollGroupPriceTypes(entities, payrollGroupId.Value).ToDTOs(true).ToList());
                                    }

                                    List<EmploymentPriceTypeDTO> priceTypes = EmployeeManager.GetEmploymentPriceTypes(entities, employment.EmploymentId, payrollGroupId, grossNetCost.StartTime.Date, employmentPriceTypes: payrollGroupId.HasValue ? employmentPriceTypesDict[employment.EmploymentId] : null, payrollGroupPriceTypes: payrollGroupPriceTypesDict[payrollGroupId.Value]);
                                    foreach (EmploymentPriceTypeDTO priceType in priceTypes)
                                    {
                                        // If amount exists on employee (CurrentAmount) use it, otherwise check if amount exists on payroll group (PayrollGroupAmount)
                                        decimal amount = 0;
                                        decimal? priceTypeItemAmount = priceType.GetAmount(grossNetCost.StartTime.Date);
                                        if (priceTypeItemAmount.HasValue && priceTypeItemAmount.Value != 0)
                                            amount = priceTypeItemAmount.Value;
                                        else if (priceType.PayrollGroupAmount.HasValue && priceType.PayrollGroupAmount.Value != 0)
                                            amount = priceType.PayrollGroupAmount.Value;

                                        switch (priceType.PayrollPriceType)
                                        {
                                            case TermGroup_SoePayrollPriceType.Hourly:
                                                break;
                                            case TermGroup_SoePayrollPriceType.Fulltime:
                                            case TermGroup_SoePayrollPriceType.Monthly:
                                                if (devisor.HasValue)
                                                    amount /= devisor.Value;
                                                else if (settingPayrollGroupMonthlyWorkTimeDict.ContainsKey(payrollGroupId.Value) && settingPayrollGroupMonthlyWorkTimeDict[payrollGroupId.Value] > 0)
                                                    amount /= settingPayrollGroupMonthlyWorkTimeDict[payrollGroupId.Value];
                                                else
                                                    amount = 0;

                                                if (priceType.PayrollPriceType == TermGroup_SoePayrollPriceType.Monthly && amount != 0)
                                                {
                                                    var employmentFactor = employment.GetPercent(grossNetCost.StartTime.Date);
                                                    if (employmentFactor > 0)
                                                        amount = decimal.Divide(amount, Decimal.Divide(employmentFactor, 100));
                                                }

                                                break;
                                            default:
                                                // TODO: Add support for Monthly and Misc?
                                                amount = 0;
                                                break;
                                        }
                                        grossNetCost.CostPerHour += amount;
                                    }

                                    if (!grossNetCost.TimeScheduleTypeId.IsNullOrEmpty())
                                    {
                                        TimeScheduleType scheduleType = gncTimeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == grossNetCost.TimeScheduleTypeId.Value);
                                        if (scheduleType != null && scheduleType.UseScheduleTimeFactor && !scheduleType.TimeScheduleTypeFactor.IsNullOrEmpty())
                                        {
                                            TimeScheduleTypeFactor typeFactor = scheduleType.TimeScheduleTypeFactor.FirstOrDefault(i => i.State == (int)SoeEntityState.Active);
                                            if (typeFactor != null && typeFactor.Factor != 1)
                                                grossNetCost.CostPerHour = decimal.Multiply(grossNetCost.CostPerHour, typeFactor.Factor);
                                        }
                                    }
                                }

                                #endregion

                                #region  Fix price on payrollProduct

                                if (!factorOnPayrollProducts && !grossNetCost.IsAbsenceCost)
                                {
                                    foreach (TimeRuleIwhDTO timeRuleIwh in timeRulesIwh)
                                    {
                                        #region TimeRuleIwh

                                        //Calculation not needed if factor is not 1
                                        if (timeRuleIwh.PayrollProductFactor != 1 || timeRuleIwh.PayrollProductId == 0)
                                            continue;

                                        //IWH
                                        DateTime ruleStart = CalendarUtility.GetDateTime(scheduleStart, timeRuleIwh.StartTime).AddDays((timeRuleIwh.StartTime.Date - CalendarUtility.DATETIME_DEFAULT).Days);
                                        DateTime ruleStop = CalendarUtility.GetDateTime(scheduleStart, timeRuleIwh.StopTime).AddDays((timeRuleIwh.StopTime.Date - CalendarUtility.DATETIME_DEFAULT).Days);

                                        //Get IWH time in schedule
                                        TimeSpan iwhTime = CalendarUtility.GetNewTimeInCurrent(scheduleStart, scheduleStop, ruleStart, ruleStop);

                                        DateTime ruleValidStart = ruleStart;
                                        DateTime ruleValidStop = ruleStop;

                                        if (scheduleStart > ruleValidStart)
                                        {
                                            ruleValidStart = scheduleStart;
                                            ruleValidStop = ruleValidStart.Add(iwhTime);
                                        }
                                        else if (scheduleStop < ruleValidStop)
                                        {
                                            ruleValidStop = scheduleStop;
                                            ruleValidStart = ruleValidStop.Add(-iwhTime);
                                        }

                                        TimeSpan iwhBreakTime = new TimeSpan();

                                        //Get breaks time in IWH time
                                        iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break1Start, break1Stop));
                                        iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break2Start, break2Stop));
                                        iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break3Start, break3Stop));
                                        iwhBreakTime = iwhBreakTime.Add(CalendarUtility.GetNewTimeInCurrentAndRule(scheduleStart, scheduleStop, ruleStart, ruleStop, break4Start, break4Stop));

                                        //Subtract break time
                                        iwhTime = iwhTime.Subtract(iwhBreakTime);

                                        //Continue if no IWH time
                                        if (iwhTime.TotalMinutes <= 0)
                                            continue;

                                        decimal priceTypeItemAmountMinute = 0;
                                        decimal amountOnRule = 0;

                                        string key = $"PayrollProductPriceTypeDTOs#{timeRuleIwh.PayrollProductId}#{payrollGroupId}";
                                        List<PayrollProductPriceTypeDTO> priceTypes = BusinessMemoryCache<List<PayrollProductPriceTypeDTO>>.Get(key);
                                        if (priceTypes == null)
                                        {
                                            priceTypes = ProductManager.GetPayrollProductPriceTypes(entities, timeRuleIwh.PayrollProductId, payrollGroupId).ToDTOs(true).ToList();
                                            if (priceTypes != null)
                                                BusinessMemoryCache<List<PayrollProductPriceTypeDTO>>.Set(key, priceTypes);
                                        }

                                        if (priceTypes.IsNullOrEmpty() && payrollGroupId.HasValue)
                                        {
                                            string keyFormula = $"PayrollProductPriceFormulesDTO#{timeRuleIwh.PayrollProductId}#{payrollGroupId}";
                                            PayrollProductPriceFormulaDTO payrollProductPriceFormulaDTO = BusinessMemoryCache<PayrollProductPriceFormulaDTO>.Get(keyFormula);

                                            if (payrollProductPriceFormulaDTO == null)
                                            {
                                                payrollProductPriceFormulaDTO = ProductManager.GetPayrollProductPriceFormulas(entities, timeRuleIwh.PayrollProductId, payrollGroupId.Value).FirstOrDefault()?.ToDTO();

                                                if (payrollProductPriceFormulaDTO != null)
                                                    BusinessMemoryCache<PayrollProductPriceFormulaDTO>.Set(keyFormula, payrollProductPriceFormulaDTO);
                                            }

                                            if (payrollProductPriceFormulaDTO != null)
                                            {
                                                PayrollPriceFormulaResultDTO result = PayrollManager.EvaluatePayrollPriceFormula(entities, actorCompanyId, employee, employment, null, grossNetCost.StartTime.Date, null, null, payrollProductPriceFormulaDTO.PayrollPriceFormulaId, null, iDTO);
                                                if (result != null)
                                                {
                                                    decimal? priceTypeItemAmountHour = result.Amount;

                                                    if (priceTypeItemAmountHour.HasValue && priceTypeItemAmountHour.Value != 0)
                                                        priceTypeItemAmountMinute = decimal.Divide(priceTypeItemAmountHour.Value, 60);

                                                    if (priceTypeItemAmountMinute != 0)
                                                        amountOnRule = decimal.Multiply(priceTypeItemAmountMinute, Convert.ToDecimal(iwhTime.TotalMinutes));
                                                }
                                            }
                                        }
                                        else
                                        {
                                            foreach (var priceType in priceTypes)
                                            {
                                                decimal? priceTypeItemAmountHour = priceType.GetAmount(grossNetCost.StartTime.Date);

                                                if (priceTypeItemAmountHour.HasValue && priceTypeItemAmountHour.Value != 0)
                                                    priceTypeItemAmountMinute = decimal.Divide(priceTypeItemAmountHour.Value, 60);

                                                if (priceTypeItemAmountMinute != 0)
                                                    amountOnRule = decimal.Multiply(priceTypeItemAmountMinute, Convert.ToDecimal(iwhTime.TotalMinutes));
                                            }
                                        }

                                        decimal factorOnAmount = 0;
                                        if (amountOnRule != 0 && !timeRuleIwh.TimeScheduleTypeIds.IsNullOrEmpty())
                                        {
                                            string keyTimeScheduleTypeDTOs = "TimeScheduleTypeIds#" + actorCompanyId.ToString();
                                            List<TimeScheduleTypeDTO> timeScheduleTypes = BusinessMemoryCache<List<TimeScheduleTypeDTO>>.Get(keyTimeScheduleTypeDTOs);
                                            if (timeScheduleTypes == null)
                                            {
                                                timeScheduleTypes = GetTimeScheduleTypes(entities, actorCompanyId, loadFactors: true).ToDTOs(true).ToList();
                                                if (timeScheduleTypes != null)
                                                    BusinessMemoryCache<List<TimeScheduleTypeDTO>>.Set(keyTimeScheduleTypeDTOs, timeScheduleTypes);
                                            }

                                            if (!timeScheduleTypes.IsNullOrEmpty())
                                            {
                                                var filtered = timeScheduleTypes.Where(s => s.State == SoeEntityState.Active && timeRuleIwh.TimeScheduleTypeIds.Where(w => w.HasValue).Select(se => se.Value).Contains(s.TimeScheduleTypeId));

                                                if (!filtered.IsNullOrEmpty())
                                                {
                                                    foreach (var item in filtered.Where(w => w.UseScheduleTimeFactor))
                                                    {
                                                        if (factorOnAmount != 0)
                                                            continue;

                                                        var withFactor = item.Factors.FirstOrDefault(f => f.Factor != 1 && f.Factor != 0);

                                                        if (withFactor != null)
                                                        {
                                                            var minutes = CalendarUtility.GetOverlappingMinutes(
                                                                CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, withFactor.FromTime),
                                                                CalendarUtility.MergeDateAndTime((withFactor.ToTime - withFactor.FromTime).TotalMinutes > 1438 ? CalendarUtility.DATETIME_DEFAULT.AddDays(1) : CalendarUtility.DATETIME_DEFAULT, withFactor.ToTime),
                                                                CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, ruleValidStart),
                                                                CalendarUtility.MergeDateAndTime(ruleValidStart.Date < ruleValidStop.Date ? CalendarUtility.DATETIME_DEFAULT.AddDays(-1) : CalendarUtility.DATETIME_DEFAULT, ruleValidStop));

                                                            if (minutes > iwhTime.TotalMinutes)
                                                                minutes = Convert.ToInt32(iwhTime.TotalMinutes);

                                                            factorOnAmount = decimal.Multiply(decimal.Divide(minutes, Convert.ToDecimal(iwhTime.TotalMinutes)), withFactor.Factor);
                                                        }
                                                    }
                                                }
                                            }
                                        }

                                        if (factorOnAmount != 0)
                                            amountOnRule = decimal.Multiply(amountOnRule, factorOnAmount);

                                        iwhAmount += amountOnRule;

                                        #endregion
                                    }
                                }

                                #endregion
                            }
                        }

                        decimal hours = Convert.ToDecimal(grossNetCost.GrossTime.TotalHours);
                        grossNetCost.TotalCost = grossNetCost.IsAbsenceCost ? grossNetCost.TotalCost : (hours * grossNetCost.CostPerHour) + iwhAmount;

                        #region Tax

                        if (includeEmploymentTaxAndSupplementChargeCost)
                        {
                            var taxDate = grossNetCost.StartTime.Date;
                            var payrollGroup = payrollGroupId.HasValue && payrollGroups != null ? payrollGroups.FirstOrDefault(f => f.PayrollGroupId == payrollGroupId.Value) : null;
                            if (payrollGroupId.HasValue)
                            {
                                DateTime? paymentDate = PayrollManager.GetPaymentDate(payrollGroup, taxDate);
                                if (paymentDate.HasValue && paymentDate.Value != DateTime.MinValue)
                                    taxDate = paymentDate.Value;
                            }
                            if (!sysPayrollPriceViewDict.ContainsKey(taxDate))
                                sysPayrollPriceViewDict.Add(taxDate, birthDate.HasValue ? PayrollManager.GetSysPayrollPriceInterval(entities, actorCompanyId, (int)TermGroup_SysPayrollPrice.SE_EmploymentTax, birthDate.Value.Year, taxDate, (int)TermGroup_Languages.Swedish, sysPayrollPriceView) : null);
                            if (!sysPayrollPriceIntervalAmountDict.ContainsKey(taxDate))
                                sysPayrollPriceIntervalAmountDict.Add(taxDate, PayrollManager.GetTaxRate(entities, actorCompanyId, taxDate, birthDate, (int)TermGroup_Languages.Swedish, sysPayrollPrice: sysPayrollPriceViewDict[taxDate]));

                            grossNetCost.EmploymentTaxCost = PayrollManager.CalculateEmploymentTaxSimple(entities, actorCompanyId, taxDate, grossNetCost.TotalCost, birthDate, taxRate: sysPayrollPriceIntervalAmountDict[taxDate]);
                            grossNetCost.SupplementChargeCost = PayrollManager.CalculateSupplementChargeSE(entities, actorCompanyId, taxDate, grossNetCost.TotalCost, payrollGroupId, birthDate, sysPayrollPrice: sysPayrollPriceViewDict[taxDate], payrollGroupAccountStds: this.gncPayrollGroupAccountStds, setDefaultAge: true);
                        }

                        grossNetCost.TotalCostIncEmpTaxAndSuppCharge = grossNetCost.TotalCost + grossNetCost.EmploymentTaxCost + grossNetCost.SupplementChargeCost;

                        #endregion
                    }

                    #endregion
                }
            }
        }

        public void CalculateGrossNetAndCost_ByTransactions(CompEntities entities, IEnumerable<TimeSchedulePlanningDayDTO> dtos, int actorCompanyId)
        {
            bool useGrossNetTimeInStaffing = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.PayrollAgreementUseGrossNetTimeInStaffing, 0, actorCompanyId, 0);
            if (!useGrossNetTimeInStaffing)
                return;

            List<TimePayrollScheduleTransaction> timePayrollScheduleTransactions = TimeTransactionManager.GetTimePayrollScheduleTransactions(entities, dtos.Select(d => d.TimeScheduleTemplateBlockId).ToList());

            foreach (TimeSchedulePlanningDayDTO dto in dtos)
            {
                decimal quantity = 0;
                decimal amount = 0;
                foreach (TimePayrollScheduleTransaction timePayrollScheduleTransaction in timePayrollScheduleTransactions.Where(t => t.TimeScheduleTemplateBlockId == dto.TimeScheduleTemplateBlockId))
                {
                    decimal factor = timePayrollScheduleTransaction.PayrollProduct.SysPayrollTypeLevel2 == (int)TermGroup_SysPayrollType.SE_GrossSalary_OBAddition ? timePayrollScheduleTransaction.PayrollProduct.Factor - 1 : 1;
                    quantity += Decimal.Multiply(timePayrollScheduleTransaction.Quantity, factor);
                    amount += timePayrollScheduleTransaction.AmountCurrency ?? 0;
                }

                dto.GrossTime = (int)quantity;
                dto.TotalCost = amount;
            }
        }

        #endregion

        #region TimeBreakTemplate

        public List<TimeBreakTemplateGridDTO> GetTimeBreakTemplateGrids(int actorCompanyId, DateTime? date = null)
        {
            List<TimeBreakTemplateGridDTO> dtos = new List<TimeBreakTemplateGridDTO>();

            List<TimeBreakTemplate> breakTemplates = GetTimeBreakTemplates(actorCompanyId, date);
            foreach (TimeBreakTemplate breakTemplate in breakTemplates)
            {
                TimeBreakTemplateGridDTO dto = new TimeBreakTemplateGridDTO()
                {
                    TimeBreakTemplateId = breakTemplate.TimeBreakTemplateId,
                    ActorCompanyId = breakTemplate.ActorCompanyId,
                    StartDate = breakTemplate.StartDate,
                    StopDate = breakTemplate.StopDate,
                    UseMaxWorkTimeBetweenBreaks = breakTemplate.UseMaxWorkTimeBetweenBreaks,
                    ShiftLength = breakTemplate.ShiftLength,
                    ShiftStartFromTimeMinutes = breakTemplate.ShiftStartFromTime.HasValue ? CalendarUtility.TimeToMinutes(breakTemplate.ShiftStartFromTime.Value, breakTemplate.ShiftStartFromTime.Value.Date) : 0,
                    MajorNbrOfBreaks = 0,
                    MajorTimeCodeBreakGroupId = null,
                    MajorMinTimeAfterStart = 0,
                    MajorMinTimeBeforeEnd = 0,
                    MinorNbrOfBreaks = 0,
                    MinorTimeCodeBreakGroupId = null,
                    MinorMinTimeAfterStart = 0,
                    MinorMinTimeBeforeEnd = 0,
                    MinTimeBetweenBreaks = breakTemplate.MinTimeBetweenBreaks,
                    State = SoeEntityState.Active,
                };

                #region ShiftTypes

                dto.ShiftTypes = new List<ShiftTypeDTO>();
                foreach (ShiftType shiftType in breakTemplate.ShiftTypes)
                {
                    dto.ShiftTypes.Add(shiftType.ToDTO(false, false, false, false, false, null, false));
                }

                #endregion

                #region DayTypes

                dto.DayTypes = new List<DayTypeDTO>();
                foreach (DayType dayType in breakTemplate.DayTypes)
                {
                    dto.DayTypes.Add(dayType.ToDTO());
                }

                #endregion

                #region DayOfWeeks

                dto.DayOfWeeks = new List<SmallGenericType>();
                if (!String.IsNullOrEmpty(breakTemplate.DayOfWeeks))
                {
                    foreach (string dayOfWeek in breakTemplate.DayOfWeeks.Split(','))
                    {
                        if (Int32.TryParse(dayOfWeek, out int dayOfWeekId))
                        {
                            string name = "";
                            switch ((DayOfWeek)dayOfWeekId)
                            {
                                case DayOfWeek.Monday:
                                    name = GetText(2, (int)TermGroup.StandardDayOfWeek, "Måndag");
                                    break;
                                case DayOfWeek.Tuesday:
                                    name = GetText(3, (int)TermGroup.StandardDayOfWeek, "Tisdag");
                                    break;
                                case DayOfWeek.Wednesday:
                                    name = GetText(4, (int)TermGroup.StandardDayOfWeek, "Onsdag");
                                    break;
                                case DayOfWeek.Thursday:
                                    name = GetText(5, (int)TermGroup.StandardDayOfWeek, "Torsdag");
                                    break;
                                case DayOfWeek.Friday:
                                    name = GetText(6, (int)TermGroup.StandardDayOfWeek, "Fredag");
                                    break;
                                case DayOfWeek.Saturday:
                                    name = GetText(7, (int)TermGroup.StandardDayOfWeek, "Lördag");
                                    break;
                                case DayOfWeek.Sunday:
                                    name = GetText(1, (int)TermGroup.StandardDayOfWeek, "Söndag");
                                    break;
                            }
                            dto.DayOfWeeks.Add(new SmallGenericType() { Id = dayOfWeekId, Name = name });
                        }
                    }
                }

                #endregion

                #region Major rows

                List<TimeBreakTemplateRow> templateRowsMajor = breakTemplate.GetRows(SoeTimeBreakTemplateType.Major);
                if (templateRowsMajor.Count > 0)
                {
                    TimeBreakTemplateRow templateRowMajor = templateRowsMajor.First();
                    dto.MajorNbrOfBreaks = templateRowsMajor.Count;
                    dto.MajorTimeCodeBreakGroupId = templateRowMajor.TimeCodeBreakGroupId;
                    dto.MajorMinTimeAfterStart = templateRowMajor.MinTimeAfterStart;
                    dto.MajorMinTimeBeforeEnd = templateRowMajor.MinTimeBeforeEnd;

                    if (templateRowMajor.TimeCodeBreakGroupId.HasValue && !templateRowMajor.TimeCodeBreakGroupReference.IsLoaded)
                        templateRowMajor.TimeCodeBreakGroupReference.Load();
                    if (templateRowMajor.TimeCodeBreakGroup != null)
                        dto.MajorTimeCodeBreakGroupName = templateRowMajor.TimeCodeBreakGroup.Name;
                }

                #endregion

                #region Minor rows

                List<TimeBreakTemplateRow> templateRowsMinor = breakTemplate.GetRows(SoeTimeBreakTemplateType.Minor);
                if (templateRowsMinor.Count > 0)
                {
                    TimeBreakTemplateRow templateRowMinor = templateRowsMinor.First();
                    dto.MinorNbrOfBreaks = templateRowsMinor.Count;
                    dto.MinorTimeCodeBreakGroupId = templateRowMinor.TimeCodeBreakGroupId;
                    dto.MinorMinTimeAfterStart = templateRowMinor.MinTimeAfterStart;
                    dto.MinorMinTimeBeforeEnd = templateRowMinor.MinTimeBeforeEnd;

                    if (templateRowMinor.TimeCodeBreakGroupId.HasValue && !templateRowMinor.TimeCodeBreakGroupReference.IsLoaded)
                        templateRowMinor.TimeCodeBreakGroupReference.Load();
                    if (templateRowMinor.TimeCodeBreakGroup != null)
                        dto.MinorTimeCodeBreakGroupName = templateRowMinor.TimeCodeBreakGroup.Name;
                }

                #endregion

                dtos.Add(dto);
            }

            return dtos.OrderBy(i => i.ShiftStartFromTimeMinutes).ThenBy(i => i.ShiftLength).ToList();
        }

        public List<TimeBreakTemplate> GetTimeBreakTemplates(int actorCompanyId, DateTime? date = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeBreakTemplate.NoTracking();
            return GetTimeBreakTemplates(entities, actorCompanyId, date);
        }

        public List<TimeBreakTemplate> GetTimeBreakTemplates(CompEntities entities, int actorCompanyId, DateTime? date = null)
        {
            List<TimeBreakTemplate> breakTemplates = (from bt in entities.TimeBreakTemplate
                                                        .Include("ShiftTypes")
                                                        .Include("DayTypes")
                                                        .Include("TimeBreakTemplateRow.TimeCodeBreakGroup")
                                                      where bt.ActorCompanyId == actorCompanyId &&
                                                      bt.State == (int)SoeEntityState.Active
                                                      select bt).ToList();

            if (date.HasValue)
                breakTemplates = breakTemplates.Where(i => (!i.StartDate.HasValue || i.StartDate.Value <= date) && (!i.StopDate.HasValue || i.StopDate.Value >= date)).ToList();

            return breakTemplates;
        }

        public bool HasTimeBreakTemplates(int actorCompanyId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from bt in entitiesReadOnly.TimeBreakTemplate
                    where bt.ActorCompanyId == actorCompanyId &&
                    bt.State == (int)SoeEntityState.Active
                    select bt).Any();
        }

        public TimeBreakTemplate GetTimeBreakTemplate(int timeBreakTemplateId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeBreakTemplate.NoTracking();
            return GetTimeBreakTemplate(entities, timeBreakTemplateId, actorCompanyId);
        }

        public TimeBreakTemplate GetTimeBreakTemplate(CompEntities entities, int timeBreakTemplateId, int actorCompanyId)
        {
            return (from bt in entities.TimeBreakTemplate
                        .Include("ShiftTypes")
                        .Include("DayTypes")
                        .Include("TimeBreakTemplateRow")
                    where bt.TimeBreakTemplateId == timeBreakTemplateId &&
                    bt.ActorCompanyId == actorCompanyId &&
                    bt.State == (int)SoeEntityState.Active
                    select bt).FirstOrDefault();
        }

        public ActionResult SaveTimeBreakTemplates(List<TimeBreakTemplateGridDTO> inputBreakTemplates)
        {
            ActionResult result = null;

            using (CompEntities entities = new CompEntities())
            {
                #region Validation

                inputBreakTemplates = inputBreakTemplates.OrderBy(i => i.ShiftStartFromTimeMinutes).ToList();

                for (int i = 0; i < inputBreakTemplates.Count; i++)
                {
                    TimeBreakTemplateGridDTO inputBreakTemplate = inputBreakTemplates[i];
                    result = ValidateBreakTemplate(entities, inputBreakTemplate);
                    if (!result.Success)
                        return result;
                }

                #endregion

                #region Prereq

                List<TimeBreakTemplate> breakTemplates = GetTimeBreakTemplates(entities, ActorCompanyId);

                #endregion

                #region Delete

                foreach (TimeBreakTemplate breakTemplate in breakTemplates)
                {
                    if (!breakTemplate.TimeBreakTemplateRow.IsLoaded)
                        breakTemplate.TimeBreakTemplateRow.Load();

                    TimeBreakTemplateGridDTO inputBreakTemplate = inputBreakTemplates.FirstOrDefault(i => i.TimeBreakTemplateId == breakTemplate.TimeBreakTemplateId);
                    if (inputBreakTemplate == null || inputBreakTemplate.State == SoeEntityState.Active)
                    {
                        if (!breakTemplate.TimeScheduleTemplateBlock.IsLoaded)
                            breakTemplate.TimeScheduleTemplateBlock.Load();

                        if (breakTemplate.TimeScheduleTemplateBlock.Any(i => i.State == (int)SoeEntityState.Active))
                            return new ActionResult((int)ActionResultSave.TimeBreakTemplateCannotDeleteUsed, GetText(8749, "Rastmall kan inte tas bort, den används på ett pass"));

                        ChangeEntityState(breakTemplate, SoeEntityState.Deleted);

                        foreach (TimeBreakTemplateRow breakTemplateRow in breakTemplate.TimeBreakTemplateRow)
                        {
                            ChangeEntityState(breakTemplateRow, SoeEntityState.Deleted);
                        }
                    }
                }

                #endregion

                #region Add/Update

                foreach (TimeBreakTemplateGridDTO inputBreakTemplate in inputBreakTemplates.Where(i => i.State == SoeEntityState.Active))
                {
                    TimeBreakTemplate breakTemplate = inputBreakTemplate.TimeBreakTemplateId > 0 ? GetTimeBreakTemplate(entities, inputBreakTemplate.TimeBreakTemplateId, ActorCompanyId) : null;
                    if (breakTemplate == null)
                    {
                        //Add
                        breakTemplate = new TimeBreakTemplate()
                        {
                            ActorCompanyId = ActorCompanyId,
                        };
                        SetCreatedProperties(breakTemplate);
                        entities.TimeBreakTemplate.AddObject(breakTemplate);
                    }
                    else
                    {
                        //Update
                        SetModifiedProperties(breakTemplate);
                    }

                    //Common
                    breakTemplate.StartDate = inputBreakTemplate.StartDate;
                    breakTemplate.StopDate = inputBreakTemplate.StopDate;
                    breakTemplate.UseMaxWorkTimeBetweenBreaks = inputBreakTemplate.UseMaxWorkTimeBetweenBreaks;
                    breakTemplate.ShiftLength = inputBreakTemplate.ShiftLength;
                    breakTemplate.ShiftStartFromTime = inputBreakTemplate.ShiftStartFromTimeMinutes >= 0 ? CalendarUtility.DATETIME_DEFAULT.AddMinutes(inputBreakTemplate.ShiftStartFromTimeMinutes) : CalendarUtility.DATETIME_DEFAULT;
                    breakTemplate.MinTimeBetweenBreaks = inputBreakTemplate.MinTimeBetweenBreaks;
                    breakTemplate.State = (int)SoeEntityState.Active;

                    if (!inputBreakTemplate.ShiftTypes.IsNullOrEmpty())
                    {
                        breakTemplate.ShiftTypes.Clear();
                        foreach (ShiftTypeDTO inputShiftType in inputBreakTemplate.ShiftTypes.Where(shiftType => shiftType != null))
                        {
                            ShiftType shiftType = GetShiftType(entities, inputShiftType.ShiftTypeId);
                            if (shiftType != null)
                                breakTemplate.ShiftTypes.Add(shiftType);
                        }
                    }

                    if (!inputBreakTemplate.DayTypes.IsNullOrEmpty())
                    {
                        breakTemplate.DayTypes.Clear();
                        foreach (DayTypeDTO inputDayType in inputBreakTemplate.DayTypes.Where(dayType => dayType != null))
                        {
                            DayType dayType = CalendarManager.GetDayType(entities, inputDayType.DayTypeId, base.ActorCompanyId);
                            if (dayType != null)
                                breakTemplate.DayTypes.Add(dayType);
                        }
                    }

                    if (!inputBreakTemplate.DayOfWeeks.IsNullOrEmpty())
                    {
                        breakTemplate.DayOfWeeks = inputBreakTemplate.DayOfWeeks.Where(dayOfWeek => dayOfWeek != null).Select(dayOfWeek => dayOfWeek.Id).ToCommaSeparated();
                    }

                    result = SaveTimeBreakTemplateRows(inputBreakTemplate, breakTemplate);
                    if (!result.Success)
                        return result;
                }

                #endregion

                result = SaveChanges(entities);
            }

            return result;
        }

        public List<TimeBreakTemplateGridDTO> ValidateBreakTemplates(List<TimeBreakTemplateGridDTO> inputBreakTemplates)
        {
            TimeBreakTemplateEvaluation breakEvaluation = new TimeBreakTemplateEvaluation();

            foreach (TimeBreakTemplateGridDTO inputBreakTemplate in inputBreakTemplates)
            {
                inputBreakTemplate.ValidationResult = ValidateBreakTemplate(inputBreakTemplate);
                if (inputBreakTemplate.ValidationResult.Success)
                {
                    DateTime startTime = CalendarUtility.GetDateFromMinutes(CalendarUtility.DATETIME_DEFAULT, inputBreakTemplate.ShiftStartFromTimeMinutes);
                    DateTime stopTime = startTime.AddMinutes(inputBreakTemplate.ShiftLength);
                    TimeBreakTemplateEvaluationInput input = new TimeBreakTemplateEvaluationInput(SoeTimeBreakTemplateEvaluation.RegisterEvaluation, startTime, stopTime);
                    TimeBreakTemplateEvaluationOutput output = breakEvaluation.Evaluate(input, new List<TimeBreakTemplateDTO> { inputBreakTemplate.ToDTO() });
                    bool valid = output.Success && output.BreakSlots != null;
                    inputBreakTemplate.ValidationResult = valid ? new ActionResult(true) : new ActionResult((int)ActionResultSave.TimeBreakTemplateNotValid, GetText(11525, "Rastmallen är inte korrekt. Inga raster kan falla ut"));
                }
            }

            return inputBreakTemplates;
        }

        public ActionResult ValidateBreakTemplate(TimeBreakTemplateGridDTO inputBreakTemplate)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return ValidateBreakTemplate(entities, inputBreakTemplate);
        }

        public ActionResult ValidateBreakTemplate(CompEntities entities, TimeBreakTemplateGridDTO inputBreakTemplate)
        {
            if (inputBreakTemplate == null)
                return new ActionResult(false, (int)ActionResultSave.EntityIsNull, "TimeBreakTemplate");

            if (inputBreakTemplate.MajorNbrOfBreaks > 0 && inputBreakTemplate.MajorTimeCodeBreakGroupId == 0)
                return new ActionResult(false, (int)ActionResultSave.TimeBreakTemplateMajorBreaksMissing, String.Format(GetText(11519, "Måste ange rasttyp när antal raster är större än 0")), inputBreakTemplate.RowNr);

            if (inputBreakTemplate.MinorNbrOfBreaks > 0 && inputBreakTemplate.MinorTimeCodeBreakGroupId == 0)
                return new ActionResult(false, (int)ActionResultSave.TimeBreakTemplateMinorBreaksMissing, String.Format(GetText(11519, "Måste ange rasttyp när antal raster är större än 0")), inputBreakTemplate.RowNr);

            if (inputBreakTemplate.MajorNbrOfBreaks > Constants.STAFFING_MAXBREAKSMAJOR)
                return new ActionResult(false, (int)ActionResultSave.TimeBreakTemplateMoreBreaksThanAllowedMajor, String.Format(GetText(11513, "Får max ha {0} måltidsraster"), Constants.STAFFING_MAXBREAKSMAJOR), inputBreakTemplate.RowNr);

            if (inputBreakTemplate.MinorNbrOfBreaks > Constants.STAFFING_MAXBREAKSMINOR)
                return new ActionResult(false, (int)ActionResultSave.TimeBreakTemplateMoreBreaksThanAllowedMajor, String.Format(GetText(11514, "Får max ha {0} raster"), Constants.STAFFING_MAXBREAKSMINOR), inputBreakTemplate.RowNr);

            if (inputBreakTemplate.MajorNbrOfBreaks + inputBreakTemplate.MinorNbrOfBreaks > Constants.STAFFING_MAXBREAKS)
                return new ActionResult(false, (int)ActionResultSave.TimeBreakTemplateMoreBreaksThanAllowedMajor, String.Format(GetText(11520, "Får max ha totalt {0} raster"), Constants.STAFFING_MAXBREAKS), inputBreakTemplate.RowNr);

            int companySettingNbrOfBreaks = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.TimeMaxNoOfBrakes, 0, base.ActorCompanyId, 0);
            if (inputBreakTemplate.MajorNbrOfBreaks + inputBreakTemplate.MinorNbrOfBreaks > companySettingNbrOfBreaks)
                return new ActionResult(false, (int)ActionResultSave.TimeBreakTemplateMoreBreaksThanAllowedMajor, String.Format(GetText(11512, "Får max ha totalt {0} raster enligt företagsinställning (kan sättas till max {1})"), companySettingNbrOfBreaks, Constants.STAFFING_MAXBREAKS), inputBreakTemplate.RowNr);

            return new ActionResult(true);
        }

        #region New methods for Angular 19

        public List<TimeBreakTemplateGridDTONew> GetTimeBreakTemplateGridsNew(int actorCompanyId, int? timeBreakTemplateId = null)
        {
            List<TimeBreakTemplate> allTemplates = GetTimeBreakTemplates(actorCompanyId);
            List<TimeBreakTemplate> templatesToReturn;

            var sortedTemplateIds = allTemplates.OrderBy(t => t.TimeBreakTemplateId).Select(t => t.TimeBreakTemplateId).ToList();

            if (timeBreakTemplateId.HasValue)
            {
                templatesToReturn = allTemplates.Where(t => t.TimeBreakTemplateId == timeBreakTemplateId.Value).ToList();
            }
            else
            {
                templatesToReturn = allTemplates;
            }

            foreach (var template in templatesToReturn)
            {
                if (!template.ShiftTypes.IsLoaded)
                    template.ShiftTypes.Load();

                if (!template.DayTypes.IsLoaded)
                    template.DayTypes.Load();

                if (!template.TimeBreakTemplateRow.IsLoaded)
                    template.TimeBreakTemplateRow.Load();

                foreach (var row in template.TimeBreakTemplateRow)
                {
                    if (!row.TimeCodeBreakGroupReference.IsLoaded)
                        row.TimeCodeBreakGroupReference.Load();
                }
            }

            var dtos = new List<TimeBreakTemplateGridDTONew>();
            foreach (var template in templatesToReturn.OrderBy(t => t.TimeBreakTemplateId))
            {
                int rowNr = sortedTemplateIds.IndexOf(template.TimeBreakTemplateId) + 1;
                dtos.Add(template.ToGridDTONew(rowNr));
            }
            return dtos;
        }

        public ActionResult DeleteTimeBreakTemplate(int timeBreakTemplateId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeBreakTemplate template = GetTimeBreakTemplate(entities, timeBreakTemplateId, actorCompanyId);
                if (template == null)
                    return new ActionResult(false, (int)ActionResultSave.EntityNotFound, "TimeBreakTemplate");

                if (!template.TimeScheduleTemplateBlock.IsLoaded)
                    template.TimeScheduleTemplateBlock.Load();

                if (template.TimeScheduleTemplateBlock.Any(b => b.State == (int)SoeEntityState.Active))
                    return new ActionResult((int)ActionResultSave.TimeBreakTemplateCannotDeleteUsed,
                        GetText(8749, "Rastmall kan inte tas bort, den används på ett pass"));

                ChangeEntityState(template, SoeEntityState.Deleted);

                if (!template.TimeBreakTemplateRow.IsLoaded)
                    template.TimeBreakTemplateRow.Load();

                foreach (var row in template.TimeBreakTemplateRow.ToList())
                {
                    ChangeEntityState(row, SoeEntityState.Deleted);
                }

                entities.SaveChanges();

                return new ActionResult(true);
            }
        }

        public ActionResult ValidateBreakTemplateDTONew(TimeBreakTemplateDTONew inputTemplate)
        {
            if (inputTemplate == null)
                return new ActionResult(false, (int)ActionResultSave.EntityIsNull, "TimeBreakTemplate");

            TimeBreakTemplateGridDTO gridDTO = inputTemplate.ToGridDTO();

            List<TimeBreakTemplateGridDTO> validatedTemplates = ValidateBreakTemplates(new List<TimeBreakTemplateGridDTO> { gridDTO });

            return validatedTemplates.FirstOrDefault()?.ValidationResult ?? new ActionResult(false);
        }

        public ActionResult SaveTimeBreakTemplateNew(TimeBreakTemplateDTONew inputTemplate)
        {
            if (inputTemplate == null)
                return new ActionResult(false, (int)ActionResultSave.EntityIsNull, "TimeBreakTemplate");

            ActionResult validationResult = ValidateBreakTemplateDTONew(inputTemplate);
            if (!validationResult.Success)
                return validationResult;

            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                TimeBreakTemplate template = inputTemplate.TimeBreakTemplateId > 0
                    ? GetTimeBreakTemplate(entities, inputTemplate.TimeBreakTemplateId, ActorCompanyId)
                    : null;

                bool isNewEntity = template == null;

                if (isNewEntity)
                {
                    template = new TimeBreakTemplate()
                    {
                        ActorCompanyId = ActorCompanyId,
                    };
                    SetCreatedProperties(template);
                    entities.TimeBreakTemplate.AddObject(template);
                }
                else
                {
                    SetModifiedProperties(template);
                }

                template.StartDate = inputTemplate.StartDate;
                template.StopDate = inputTemplate.StopDate;
                template.UseMaxWorkTimeBetweenBreaks = inputTemplate.UseMaxWorkTimeBetweenBreaks;
                template.ShiftLength = inputTemplate.ShiftLength;
                template.ShiftStartFromTime = inputTemplate.ShiftStartFromTime >= 0 ? CalendarUtility.DATETIME_DEFAULT.AddMinutes(inputTemplate.ShiftStartFromTime) : CalendarUtility.DATETIME_DEFAULT;
                template.MinTimeBetweenBreaks = inputTemplate.MinTimeBetweenBreaks;
                template.State = (int)SoeEntityState.Active;

                if (!inputTemplate.DayOfWeeks.IsNullOrEmpty())
                {
                    template.DayOfWeeks = string.Join(",", inputTemplate.DayOfWeeks.Select(d => (int)d));
                }
                else
                {
                    template.DayOfWeeks = null;
                }

                if (isNewEntity)
                {
                    entities.SaveChanges();
                    template = GetTimeBreakTemplate(entities, template.TimeBreakTemplateId, ActorCompanyId);
                }

                template.ShiftTypes.Clear();
                if (!inputTemplate.ShiftTypeIds.IsNullOrEmpty())
                {
                    foreach (int shiftTypeId in inputTemplate.ShiftTypeIds)
                    {
                        ShiftType shiftType = GetShiftType(entities, shiftTypeId);
                        if (shiftType != null)
                            template.ShiftTypes.Add(shiftType);
                    }
                }

                template.DayTypes.Clear();
                if (!inputTemplate.DayTypeIds.IsNullOrEmpty())
                {
                    foreach (int dayTypeId in inputTemplate.DayTypeIds)
                    {
                        DayType dayType = CalendarManager.GetDayType(entities, dayTypeId, ActorCompanyId);
                        if (dayType != null)
                            template.DayTypes.Add(dayType);
                    }
                }

                if (!template.TimeBreakTemplateRow.IsLoaded)
                    template.TimeBreakTemplateRow.Load();

                foreach (var existingRow in template.TimeBreakTemplateRow.ToList())
                {
                    ChangeEntityState(existingRow, SoeEntityState.Deleted);
                }

                for (int i = 0; i < inputTemplate.MajorNbrOfBreaks; i++)
                {
                    TimeBreakTemplateRow row = new TimeBreakTemplateRow()
                    {
                        TimeCodeBreakGroupId = inputTemplate.MajorTimeCodeBreakGroupId,
                        Type = (int)SoeTimeBreakTemplateType.Major,
                        MinTimeAfterStart = inputTemplate.MajorMinTimeAfterStart,
                        MinTimeBeforeEnd = inputTemplate.MajorMinTimeBeforeEnd
                    };
                    SetCreatedProperties(row);
                    template.TimeBreakTemplateRow.Add(row);
                }

                for (int i = 0; i < inputTemplate.MinorNbrOfBreaks; i++)
                {
                    TimeBreakTemplateRow row = new TimeBreakTemplateRow()
                    {
                        TimeCodeBreakGroupId = inputTemplate.MinorTimeCodeBreakGroupId,
                        Type = (int)SoeTimeBreakTemplateType.Minor,
                        MinTimeAfterStart = inputTemplate.MinorMinTimeAfterStart,
                        MinTimeBeforeEnd = inputTemplate.MinorMinTimeBeforeEnd
                    };
                    SetCreatedProperties(row);
                    template.TimeBreakTemplateRow.Add(row);
                }

                result = SaveChanges(entities);

                if (result.Success)
                    result.IntegerValue = template.TimeBreakTemplateId;

                return result;
            }
        }

        public TimeBreakTemplateDTONew GetTimeBreakTemplateForEditNew(int timeBreakTemplateId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeBreakTemplate template = GetTimeBreakTemplate(entities, timeBreakTemplateId, actorCompanyId);
                if (template == null)
                    return null;
                if (!template.ShiftTypes.IsLoaded)
                    template.ShiftTypes.Load();
                if (!template.DayTypes.IsLoaded)
                    template.DayTypes.Load();
                if (!template.TimeBreakTemplateRow.IsLoaded)
                    template.TimeBreakTemplateRow.Load();

                return template.ToDTONew();
            }
        }

        #endregion

        public ActionResult CreateAndSaveBreaksFromTemplatesForEmployees(DateTime dateFrom, DateTime dateTo, List<int> employeeIds, int actorCompanyId)
        {
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();

            foreach (var day in CalendarUtility.GetDatesInInterval(dateFrom, dateTo))
                dtos.AddRange(CreateBreaksFromTemplatesForEmployees(day, employeeIds, actorCompanyId));

            TimeEngineManager tem = new TimeEngineManager(parameterObject, actorCompanyId, parameterObject.UserId);

            return tem.SaveTimeScheduleShift("createbreaksjob", dtos, true, true, true, 0, null);
        }

        public List<TimeSchedulePlanningDayDTO> CreateBreaksFromTemplatesForEmployees(DateTime date, List<int> employeeIds, int actorCompanyId, int? timeScheduleScenarioHeadId = null)
        {
            List<TimeSchedulePlanningDayDTO> shifts = new List<TimeSchedulePlanningDayDTO>();

            foreach (int employeeId in employeeIds)
            {
                List<TimeScheduleTemplateBlock> templateBlocks = GetTimeScheduleTemplateBlocksForDay(employeeId, date, timeScheduleScenarioHeadId: timeScheduleScenarioHeadId);
                if (templateBlocks.IsNullOrEmpty())
                    continue;

                shifts.AddRange(CreateBreaksFromTemplatesForEmployee(templateBlocks.ToTimeSchedulePlanningDayDTOs(), employeeId, actorCompanyId));
            }

            return shifts;
        }

        public List<TimeSchedulePlanningDayDTO> CreateBreaksFromTemplatesForEmployee(List<TimeSchedulePlanningDayDTO> shifts, int employeeId, int actorCompanyId)
        {
            Employee employee = EmployeeManager.GetEmployee(employeeId, actorCompanyId, loadEmployment: true, getHidden: true);
            if (employee == null)
                return shifts;

            List<TimeBreakTemplateDTO> breakTemplates = GetTimeBreakTemplates(actorCompanyId).ToDTOs().ToList();
            if (breakTemplates.IsNullOrEmpty())
                return shifts;

            List<WorkIntervalDTO> workIntervals = new List<WorkIntervalDTO>();
            TimeBreakTemplateEvaluation breakEvaluation = new TimeBreakTemplateEvaluation();

            #region Merge adjacent shifts

            foreach (TimeSchedulePlanningDayDTO shift in shifts.OrderBy(i => i.StartTime))
            {
                if (shift == null)
                    continue;

                WorkIntervalDTO prevAdjacentWorkInterval = workIntervals.FirstOrDefault(i => i.StopTime == shift.StartTime);
                if (prevAdjacentWorkInterval != null)
                {
                    prevAdjacentWorkInterval.StopTime = shift.StopTime;
                    if (shift.ShiftTypeId > 0)
                    {
                        if (prevAdjacentWorkInterval.ShiftTypeIds == null)
                            prevAdjacentWorkInterval.ShiftTypeIds = new List<int>();

                        if (!prevAdjacentWorkInterval.ShiftTypeIds.Contains(shift.ShiftTypeId))
                            prevAdjacentWorkInterval.ShiftTypeIds.Add(shift.ShiftTypeId);
                    }
                    else
                    {
                        prevAdjacentWorkInterval.ShiftTypeIds = null;
                    }
                }
                else
                {
                    workIntervals.Add(new WorkIntervalDTO(shift.TimeScheduleTemplateBlockId, shift.StartTime, shift.StopTime, null, shift.ShiftTypeId));
                }
            }

            #endregion

            #region Evaluate breaks for shifts

            foreach (WorkIntervalDTO workInterval in workIntervals)
            {
                TimeBreakTemplateEvaluationInput breakEvaluationInput = new TimeBreakTemplateEvaluationInput(SoeTimeBreakTemplateEvaluation.Manual, workInterval.StartTime, workInterval.StopTime, workInterval.Date, workInterval.ShiftTypeIds, null, CalendarUtility.GetDayOfWeek(workInterval.Date));
                TimeBreakTemplateEvaluationOutput breakEvaluationOutput = breakEvaluation.Evaluate(breakEvaluationInput, breakTemplates);
                if (!breakEvaluationOutput.Success)
                    continue;

                int breakNr = 1;
                foreach (TimeBreakTemplateBreakSlot breakSlot in breakEvaluationOutput.BreakSlots)
                {
                    int timeCodeId = breakSlot.TimeCodeBreakGroupId.HasValue ? TimeCodeManager.GetTimeCodeBreakForEmployeeGroup(employee.GetEmployeeGroupId(workInterval.Date), breakSlot.TimeCodeBreakGroupId.Value)?.TimeCodeId ?? 0 : 0;
                    shifts.ForEach(shift => shift.SetBreakData(breakNr, timeCodeId, workInterval.Date, breakSlot.StartTime, breakSlot.Length));
                    breakNr++;
                }
            }

            #endregion

            return shifts;
        }

        #endregion

        #region TimeBreakTemplateRow

        private ActionResult SaveTimeBreakTemplateRows(TimeBreakTemplateGridDTO inputBreakTemplate, TimeBreakTemplate breakTemplate)
        {
            ActionResult result = SaveTimeBreakTemplateRows(inputBreakTemplate, breakTemplate, SoeTimeBreakTemplateType.Major);
            if (!result.Success)
                return result;

            result = SaveTimeBreakTemplateRows(inputBreakTemplate, breakTemplate, SoeTimeBreakTemplateType.Minor);
            if (!result.Success)
                return result;

            return result;
        }

        private ActionResult SaveTimeBreakTemplateRows(TimeBreakTemplateGridDTO inputBreakTemplate, TimeBreakTemplate breakTemplate, SoeTimeBreakTemplateType type)
        {
            ActionResult result = new ActionResult(true);

            if (breakTemplate == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeBreakTemplate");
            if (inputBreakTemplate == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeBreakTemplateGridDTO");

            //Add/Update
            List<TimeBreakTemplateRow> breakTemplateRows = breakTemplate.GetRows(type);
            int nbrOfBreaks = type == SoeTimeBreakTemplateType.Major ? inputBreakTemplate.MajorNbrOfBreaks : inputBreakTemplate.MinorNbrOfBreaks;
            for (int breakNr = 1; breakNr <= nbrOfBreaks; breakNr++)
            {
                TimeBreakTemplateRow breakTemplaterRow = breakTemplateRows.Count >= breakNr ? breakTemplateRows[breakNr - 1] : null;
                result = SaveTimeBreakTemplateRow(breakTemplate, inputBreakTemplate, type, breakTemplaterRow);
                if (!result.Success)
                    return result;
            }

            //Delete (when shortened number of breaks in for type)
            for (int breakNr = nbrOfBreaks + 1; breakNr <= breakTemplateRows.Count; breakNr++)
            {
                TimeBreakTemplateRow breakTemplaterRow = breakTemplateRows[breakNr];
                ChangeEntityState(breakTemplaterRow, SoeEntityState.Deleted);
            }

            return result;
        }

        private ActionResult SaveTimeBreakTemplateRow(TimeBreakTemplate breakTemplate, TimeBreakTemplateGridDTO inputBreakTemplate, SoeTimeBreakTemplateType type, TimeBreakTemplateRow breakTemplateRow)
        {
            ActionResult result = new ActionResult(true);

            if (breakTemplate == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeBreakTemplate");
            if (inputBreakTemplate == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeBreakTemplateGridDTO");

            if (breakTemplateRow == null)
            {
                //Add
                breakTemplateRow = new TimeBreakTemplateRow();
                SetCreatedProperties(breakTemplateRow);
            }
            else
            {
                //Update
                SetModifiedProperties(breakTemplateRow);
            }

            //Common
            breakTemplateRow.TimeBreakTemplate = breakTemplate;
            breakTemplateRow.Type = (int)type;
            breakTemplateRow.TimeCodeBreakGroupId = (type == SoeTimeBreakTemplateType.Major ? inputBreakTemplate.MajorTimeCodeBreakGroupId : inputBreakTemplate.MinorTimeCodeBreakGroupId).ToNullable();
            breakTemplateRow.MinTimeAfterStart = type == SoeTimeBreakTemplateType.Major ? inputBreakTemplate.MajorMinTimeAfterStart : inputBreakTemplate.MinorMinTimeAfterStart;
            breakTemplateRow.MinTimeBeforeEnd = type == SoeTimeBreakTemplateType.Major ? inputBreakTemplate.MajorMinTimeBeforeEnd : inputBreakTemplate.MinorMinTimeBeforeEnd;

            return result;
        }

        #endregion

        #region TimeScheduleCopy

        public Dictionary<int, string> GetTimeScheduleCopyHeadsDict(int actorCompanyId, TermGroup_TimeScheduleCopyHeadType type)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleCopyHead.NoTracking();
            return (from t in entitiesReadOnly.TimeScheduleCopyHead
                    where t.ActorCompanyId == actorCompanyId &&
                    t.Type == (int)type &&
                    t.State == (int)SoeEntityState.Active
                    orderby t.DateFrom descending, t.DateTo descending, t.Created descending
                    select t).ToDictionary(k => k.TimeScheduleCopyHeadId, v => String.Format("{0} - {1}, {2} {3} {4}",
                        v.DateFrom.ToShortDateString(),
                        v.DateTo.ToShortDateString(),
                        v.CreatedBy,
                        v.Created.ToShortDateString(),
                        v.Created.ToShortTimeString()));
        }

        public Dictionary<int, string> GetTimeScheduleCopyRowEmployeesDict(int actorCompanyId, int timeScheduleCopyHeadId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from t in entitiesReadOnly.TimeScheduleCopyRow.Include("Employee.ContactPerson")
                    where t.TimeScheduleCopyHeadId == timeScheduleCopyHeadId &&
                    t.TimeScheduleCopyHead.ActorCompanyId == actorCompanyId &&
                    t.TimeScheduleCopyHead.State == (int)SoeEntityState.Active &&
                    t.State == (int)SoeEntityState.Active
                    orderby t.Employee.EmployeeNr
                    select t).ToDictionary(k => k.EmployeeId, v => v.Employee.EmployeeNrAndName);
        }

        public TimeScheduleCopyHeadDTO GetScheduleCopyHead(int actorCompanyId, int timeScheduleCopyHeadId, List<int> employeeIds = null)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleCopyHead.NoTracking();
            entitiesReadOnly.TimeScheduleCopyRow.NoTracking();
            IQueryable<TimeScheduleCopyHead> query = (from sch in entitiesReadOnly.TimeScheduleCopyHead.Include("TimeScheduleCopyRow")
                                                      where sch.ActorCompanyId == actorCompanyId &&
                                                      sch.State == (int)SoeEntityState.Active &&
                                                      timeScheduleCopyHeadId == sch.TimeScheduleCopyHeadId
                                                      select sch);

            TimeScheduleCopyHead copyHead = query.FirstOrDefault();

            return copyHead.ToDTO();
        }

        #endregion

        #region TimeScheduledTimeSummary

        public int GetScheduledTimeSummaryTotalWithinEmployments(int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, TimeScheduledTimeSummaryType type)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetScheduledTimeSummaryTotalWithinEmployments(entities, actorCompanyId, employeeId, startDate, stopDate, type);
        }

        public int GetScheduledTimeSummaryTotalWithinEmployments(CompEntities entities, int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, TimeScheduledTimeSummaryType type)
        {
            Employee employee = EmployeeManager.GetEmployeeWithEmploymentAndEmploymentChangeBatch(entities, employeeId, actorCompanyId);
            return GetScheduledTimeSummaryTotalWithinEmployments(entities, actorCompanyId, employee, startDate, stopDate, type);
        }

        public int GetScheduledTimeSummaryTotalWithinEmployments(CompEntities entities, int actorCompanyId, Employee employee, DateTime startDate, DateTime stopDate, TimeScheduledTimeSummaryType type, List<Employment> employments = null)
        {
            int minutes = 0;

            if (employee == null)
                return minutes;

            List<DateRangeDTO> empRanges = new List<DateRangeDTO>();

            // First we need to get all employments for specified employee
            // Then we will loop over the employments and get TimeScheduleTemplateBlocks within each employment date range
            if (employments == null)
                employments = employee.GetEmployments(startDate, stopDate);

            foreach (Employment employment in employments.SortByDate())
            {
                // Get employment date range
                DateTime dateFrom = (employment.DateFrom.HasValue && employment.DateFrom.Value > startDate ? employment.DateFrom.Value : startDate).Date;
                DateTime dateTo = (employment.DateTo.HasValue && employment.DateTo.Value < stopDate ? employment.DateTo.Value : stopDate).Date;

                empRanges.Add(new DateRangeDTO(dateFrom, dateTo));
            }

            List<DateRangeDTO> ranges = empRanges.AsEnumerable().MergeOverlapping().ToList();
            foreach (DateRangeDTO range in ranges)
            {
                minutes += GetScheduledTimeSummaryTotal(entities, actorCompanyId, employee.EmployeeId, range.Start, range.Stop, type);
            }

            return minutes;
        }

        private int GetScheduledTimeSummaryTotal(CompEntities entities, int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, TimeScheduledTimeSummaryType type)
        {
            return (from t in entities.TimeScheduledTimeSummary
                    where t.ActorCompanyId == actorCompanyId &&
                    t.EmployeeId == employeeId &&
                    t.Date >= startDate && t.Date <= stopDate &&
                    (type == TimeScheduledTimeSummaryType.Both || t.Type == (int)type) &&
                    t.State == (int)SoeEntityState.Active
                    select t).Sum(s => (int?)s.Minutes) ?? 0;
        }

        public List<TimeScheduledTimeSummary> GetScheduledTimeSummaries(CompEntities entities, int actorCompanyId, List<int> employeeIds, DateTime startDate, DateTime stopDate)
        {
            List<TimeScheduledTimeSummary> timeScheduledTimeSummaries = (from t in entities.TimeScheduledTimeSummary
                                                                         where t.ActorCompanyId == actorCompanyId &&
                                                                         employeeIds.Contains(t.EmployeeId) &&
                                                                         t.Date >= startDate && t.Date <= stopDate &&
                                                                         t.State == (int)SoeEntityState.Active
                                                                         select t).ToList();

            return timeScheduledTimeSummaries;
        }

        public ActionResult UpdateScheduledTimeSummary(int actorCompanyId, List<int> employeeIds, DateTime startDate, DateTime stopDate, bool returnResult = false, bool deleteRecords = false)
        {
            ActionResult result = new ActionResult();

            // Update scheduled time summary for a list of employees within one transaction
            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    foreach (int employeeId in employeeIds)
                    {
                        using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                        {
                            if (entities.Connection.State != ConnectionState.Open)
                                entities.Connection.Open();

                            UpdateScheduledTimeSummary(entities, actorCompanyId, employeeId, startDate, stopDate, returnResult, deleteRecords);
                            transaction.Complete();
                        }
                    }
                }
                catch (Exception ex)
                {
                    result.Success = false;
                    result.Exception = ex;
                }
                finally
                {
                    entities.Connection.Close();
                }
            }

            return result;
        }

        public int UpdateScheduledTimeSummary(int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, bool returnResult = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return UpdateScheduledTimeSummary(entities, actorCompanyId, employeeId, startDate, stopDate, returnResult);
        }

        public int UpdateScheduledTimeSummary(CompEntities entities, int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, bool returnResult = false, bool deleteRecords = false)
        {
            int minutes = 0;
            try
            {
                if (!base.HasTimeValidRuleWorkTimeSettingsFromCache(entities, actorCompanyId, stopDate))
                    return minutes;

                if (employeeId == base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId)))
                    return minutes;

                bool reduceTime = false;
                bool includeExtraShift = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.TimeCalculatePlanningPeriodScheduledTimeIncludeExtraShift, 0, actorCompanyId, 0);
                List<TimeScheduleType> timeScheduleTypes = base.GetTimeScheduleTypesFromCache(entities, CacheConfig.Company(actorCompanyId), true);
                if (!timeScheduleTypes.IsNullOrEmpty() || !includeExtraShift)
                    reduceTime = true;

                // Save entities timeout setting
                int? timeout = entities.CommandTimeout;

                // Set entities timeout to 10 seconds
                entities.CommandTimeout = (stopDate - startDate).TotalDays > 7 ? entities.CommandTimeout : 10;

                List<ShiftType> shiftTypes = reduceTime ? base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId, 100)) : null;
                List<int?> shiftTypeIdsWithScheduleType = reduceTime ? shiftTypes.Where(w => w.TimeScheduleTypeId.HasValue).Select(s => (int?)s.ShiftTypeId).Distinct().ToList() : new List<int?>();
                // Get all shifts within specified period that has a schedule type or is an extra shift
                List<TimeScheduleTemplateBlock> blocks = (from tb in entities.TimeScheduleTemplateBlock
                                                          where tb.Employee.ActorCompanyId == actorCompanyId &&
                                                          tb.EmployeeId == employeeId &&
                                                          tb.StartTime != tb.StopTime &&
                                                          tb.Date >= startDate && tb.Date <= stopDate &&
                                                          tb.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Schedule &&
                                                          tb.State == (int)SoeEntityState.Active
                                                          select tb).ToList();

                // Reset to previous entities timeout
                entities.CommandTimeout = timeout;

                blocks = blocks.Where(w => !w.TimeScheduleScenarioHeadId.HasValue && w.TimeScheduleEmployeePeriodId.HasValue).ToList();

                List<int> calculatedBlockIds = new List<int>();

                List<DateTime> blockDates = blocks.Select(s => s.Date.Value).Distinct().ToList();

                List<TimeScheduleTemplateBlock> allbreaks = blocks.Any() ? (from tb in blocks
                                                                            where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                                            tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                                            tb.Date.HasValue &&
                                                                            blockDates.Contains(tb.Date.Value) &&
                                                                            tb.EmployeeId == employeeId &&
                                                                            tb.State == (int)SoeEntityState.Active
                                                                            orderby tb.StartTime
                                                                            select tb).ToList() : new List<TimeScheduleTemplateBlock>();

                blocks = blocks.Any() ? blocks.Where(w => !w.IsBreak).ToList() : blocks;

                List<DateTime> unActivatedDatesInInterval = UnActivatedDatesInInterval(entities, employeeId, startDate, stopDate, actorCompanyId);
                List<TimeSchedulePlanningDayDTO> templateTime = unActivatedDatesInInterval.Any() ? GetTimeSchedulePlanningTemplate(entities, actorCompanyId, base.RoleId, base.UserId, employeeId, startDate, stopDate) : new List<TimeSchedulePlanningDayDTO>();

                // Delete or set state depending on parameter
                // Normally set state, but nightly job will delete
                // This is because we sometimes get deadlocks for when deleting
                string sql;
                if (deleteRecords)
                    sql = $"DELETE FROM TimeScheduledTimeSummary";
                else
                    sql = $"UPDATE TimeScheduledTimeSummary SET State = 2";
                sql += $" WHERE EmployeeId = {employeeId} AND [Date] >= '{CalendarUtility.ToSqlFriendlyDateTime(startDate)}' AND [Date] <= '{CalendarUtility.ToSqlFriendlyDateTime(stopDate.Date)}'";
                if (!deleteRecords)
                    sql += $" AND State = 0";
                FrownedUponSQLClient.ExecuteSql(entities, sql);

                List<TimeScheduledTimeSummary> newSummaries = new List<TimeScheduledTimeSummary>();
                StringBuilder sb = new StringBuilder();
                foreach (var onDate in blocks.GroupBy(g => g.Date))
                {
                    TimeScheduledTimeSummary summary = new TimeScheduledTimeSummary()
                    {
                        EmployeeId = employeeId,
                        Date = onDate.Key.Value,
                        Type = (int)TimeScheduledTimeSummaryType.ScheduledTime,
                        Minutes = 0,
                        ActorCompanyId = actorCompanyId,
                        State = (int)SoeEntityState.Active
                    };

                    foreach (TimeScheduleTemplateBlock block in onDate)
                    {
                        // Get breaks for current shift
                        List<TimeScheduleTemplateBlock> breaks = (from tb in allbreaks
                                                                  where tb.TimeScheduleEmployeePeriodId == block.TimeScheduleEmployeePeriodId &&
                                                                  tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                                  tb.Date == block.Date &&
                                                                  tb.EmployeeId == block.EmployeeId &&
                                                                  tb.State == (int)SoeEntityState.Active
                                                                  orderby tb.StartTime
                                                                  select tb).ToList();

                        // Check which breaks that actually overlap the shift
                        // Reduce time with the break time that overlaps
                        List<TimeScheduleTemplateBlock> overlappedBreaks = block.GetOverlappedBreaks(breaks, includeBreaksThatCouldBothStartAndEndInScheduleBlock: true, includeBreaksThatCouldBothStartAndEndOutsideScheduleBlock: true);

                        summary.Minutes += (int)(block.StopTime - block.StartTime).TotalMinutes;
                        foreach (TimeScheduleTemplateBlock brk in overlappedBreaks)
                            summary.Minutes -= (int)CalendarUtility.GetNewTimeInCurrent(block.StartTime, block.StopTime, brk.StartTime, brk.StopTime).TotalMinutes;

                        if (reduceTime)
                        {

                            TimeScheduleType timeScheduleType = block.TimeScheduleTypeId.HasValue ? timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == block.TimeScheduleTypeId) : null;
                            if (timeScheduleType == null && block.ShiftTypeId.HasValue)
                            {
                                ShiftType matchingShiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == block.ShiftTypeId.Value && f.TimeScheduleTypeId.HasValue);
                                if (matchingShiftType != null)
                                    timeScheduleType = timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == matchingShiftType.TimeScheduleTypeId.Value);
                            }

                            if (timeScheduleType == null && !block.ExtraShift)
                                continue;

                            if (calculatedBlockIds.Contains(block.TimeScheduleTemplateBlockId))
                                continue;

                            calculatedBlockIds.Add(block.TimeScheduleTemplateBlockId);

                            int minutesReduce = 0;
                            List<TimeScheduleTemplateBlock> overlappedBreaksOnReduceTime = block.GetOverlappedBreaks(breaks, includeBreaksThatCouldBothStartAndEndInScheduleBlock: true);

                            if ((timeScheduleType != null && timeScheduleType.IsNotScheduleTime) || (block.ExtraShift && !includeExtraShift))
                            {
                                minutesReduce += (int)(block.StopTime - block.StartTime).TotalMinutes;
                                foreach (TimeScheduleTemplateBlock brk in overlappedBreaksOnReduceTime)
                                    minutesReduce -= (int)CalendarUtility.GetNewTimeInCurrent(block.StartTime, block.StopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                            }
                            else if (timeScheduleType != null && timeScheduleType.UseScheduleTimeFactor)
                            {
                                minutesReduce -= CalculateFactorMinutes(block.StartTime, block.StopTime, timeScheduleType.TimeScheduleTypeFactor.ToList(), overlappedBreaks);
                            }

                            summary.Minutes = summary.Minutes - minutesReduce;
                        }
                    }

                    if (summary.Minutes != 0)
                    {
                        newSummaries.Add(summary);
                        sb.Append($"INSERT INTO TimeScheduledTimeSummary (ActorCompanyId, EmployeeId, Date, Type, Minutes, State) VALUES ({actorCompanyId}, {summary.EmployeeId}, '{CalendarUtility.ToSqlFriendlyDateTime(summary.Date)}', {summary.Type}, {summary.Minutes}, {summary.State})").Append(Environment.NewLine);
                    }
                }

                foreach (var onDate in templateTime.GroupBy(g => g.ActualDate))
                {
                    if (!unActivatedDatesInInterval.Contains(onDate.Key))
                        continue;

                    TimeScheduledTimeSummary summary = new TimeScheduledTimeSummary()
                    {
                        EmployeeId = employeeId,
                        Date = onDate.Key,
                        Type = (int)TimeScheduledTimeSummaryType.TemplateScheduledTime,
                        Minutes = 0,
                        ActorCompanyId = actorCompanyId,
                        State = (int)SoeEntityState.Active
                    };

                    foreach (var block in onDate)
                    {
                        // Check which breaks that actually overlap the shift
                        // Reduce time with the break time that overlaps
                        List<BreakDTO> overlappedBreaks = block.GetOverlappedBreaks(block.GetBreaks(), true);

                        summary.Minutes += (int)(block.StopTime - block.StartTime).TotalMinutes;
                        foreach (var brk in overlappedBreaks)
                            summary.Minutes -= (int)CalendarUtility.GetNewTimeInCurrent(block.StartTime, block.StopTime, brk.StartTime, brk.StopTime).TotalMinutes;

                        if (reduceTime)
                        {
                            TimeScheduleType timeScheduleType = block.TimeScheduleTypeId != 0 ? timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == block.TimeScheduleTypeId) : null;

                            if (timeScheduleType == null && block.ShiftTypeId != 0)
                            {
                                ShiftType matchingShiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == block.ShiftTypeId && f.TimeScheduleTypeId.HasValue);
                                if (matchingShiftType != null)
                                    timeScheduleType = timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == matchingShiftType.TimeScheduleTypeId.Value);
                            }

                            if (timeScheduleType == null && !block.ExtraShift)
                                continue;

                            if (calculatedBlockIds.Contains(block.TimeScheduleTemplateBlockId))
                                continue;

                            calculatedBlockIds.Add(block.TimeScheduleTemplateBlockId);

                            int minutesReduce = 0;
                            List<BreakDTO> overlappedBreaksOnReduceTime = block.GetOverlappedBreaks(block.GetBreaks(), true);

                            if ((timeScheduleType != null && timeScheduleType.IsNotScheduleTime) || (block.ExtraShift && !includeExtraShift))
                            {
                                minutesReduce += (int)(block.StopTime - block.StartTime).TotalMinutes;
                                foreach (var brk in overlappedBreaksOnReduceTime)
                                    minutesReduce -= (int)CalendarUtility.GetNewTimeInCurrent(block.StartTime, block.StopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                            }
                            else if (timeScheduleType != null && timeScheduleType.UseScheduleTimeFactor)
                            {
                                minutesReduce -= CalculateFactorMinutes(block.StartTime, block.StopTime, timeScheduleType.TimeScheduleTypeFactor.ToList(), null, overlappedBreaksOnReduceTime);
                            }

                            summary.Minutes = summary.Minutes - minutesReduce;
                        }
                    }

                    if (summary.Minutes != 0)
                    {
                        newSummaries.Add(summary);
                        sb.Append($"INSERT INTO TimeScheduledTimeSummary (ActorCompanyId, EmployeeId, Date, Type, Minutes, State) VALUES ({actorCompanyId}, {summary.EmployeeId}, '{CalendarUtility.ToSqlFriendlyDateTime(summary.Date)}', {summary.Type}, {summary.Minutes}, {summary.State})").Append(Environment.NewLine);
                    }
                }

                if (!string.IsNullOrEmpty(sb.ToString()))
                    FrownedUponSQLClient.ExecuteSql(entities, sb.ToString());

                if (returnResult)
                    minutes = newSummaries.Sum(s => s.Minutes);

            }
            catch (Exception ex)
            {
                LogError(ex, log);
            }

            return minutes;
        }

        public int GetTimeToExcludeInSummary(CompEntities entities, int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, bool includeExtraShift)
        {
            int minutes = 0;

            if (employeeId == base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId)))
                return minutes;

            List<TimeScheduleType> timeScheduleTypes = base.GetTimeScheduleTypesFromCache(entities, CacheConfig.Company(actorCompanyId), true);

            if (!timeScheduleTypes.IsNullOrEmpty() || !includeExtraShift)
            {
                List<ShiftType> shiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId, 100));
                List<int?> shiftTypeIdsWithScheduleType = shiftTypes.Where(w => w.TimeScheduleTypeId.HasValue).Select(s => (int?)s.ShiftTypeId).Distinct().ToList();
                // Get all shifts within specified period that has a schedule type or is an extra shift
                List<TimeScheduleTemplateBlock> blocks = (from tb in entities.TimeScheduleTemplateBlock
                                                          where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                          tb.TimeScheduleEmployeePeriod.ActorCompanyId == actorCompanyId &&
                                                          tb.EmployeeId == employeeId &&
                                                          tb.TimeScheduleEmployeePeriodId.HasValue &&
                                                          tb.StartTime != tb.StopTime &&
                                                          tb.Date >= startDate && tb.Date <= stopDate &&
                                                          tb.State == (int)SoeEntityState.Active &&
                                                          (tb.TimeScheduleTypeId.HasValue || tb.ExtraShift || (shiftTypeIdsWithScheduleType.Contains(tb.ShiftTypeId)))
                                                          select tb).ToList();

                List<int> calculatedBlockIds = new List<int>();

                List<DateTime> blockDates = blocks.Select(s => s.Date.Value).Distinct().ToList();

                List<TimeScheduleTemplateBlock> allbreaks = blocks.Any() ? (from tb in entities.TimeScheduleTemplateBlock
                                                                            where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                                            tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                                            tb.Date.HasValue &&
                                                                            blockDates.Contains(tb.Date.Value) &&
                                                                            tb.EmployeeId == employeeId &&
                                                                            tb.State == (int)SoeEntityState.Active
                                                                            orderby tb.StartTime
                                                                            select tb).ToList() : new List<TimeScheduleTemplateBlock>();

                // Loop over all shifts
                foreach (var block in blocks)
                {
                    TimeScheduleType timeScheduleType = block.TimeScheduleTypeId.HasValue ? timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == block.TimeScheduleTypeId) : null;

                    if (timeScheduleType == null && block.ShiftTypeId.HasValue)
                    {
                        var matchingShiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == block.ShiftTypeId.Value && f.TimeScheduleTypeId.HasValue);

                        if (matchingShiftType != null)
                            timeScheduleType = timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == matchingShiftType.TimeScheduleTypeId.Value);
                    }

                    if (timeScheduleType == null && !block.ExtraShift)
                        continue;

                    if (calculatedBlockIds.Contains(block.TimeScheduleTemplateBlockId))
                        continue;
                    calculatedBlockIds.Add(block.TimeScheduleTemplateBlockId);

                    // Get breaks for current shift
                    List<TimeScheduleTemplateBlock> breaks = (from tb in allbreaks
                                                              where tb.TimeScheduleEmployeePeriodId == block.TimeScheduleEmployeePeriodId &&
                                                              tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                              tb.Date == block.Date &&
                                                              tb.EmployeeId == block.EmployeeId &&
                                                              tb.State == (int)SoeEntityState.Active
                                                              orderby tb.StartTime
                                                              select tb).ToList();

                    // Check which breaks that actually overlap the shift
                    // Reduce time with the break time that overlaps
                    List<TimeScheduleTemplateBlock> overlappedBreaks = block.GetOverlappedBreaks(breaks, includeBreaksThatCouldBothStartAndEndInScheduleBlock: true);

                    if ((timeScheduleType != null && timeScheduleType.IsNotScheduleTime) || (block.ExtraShift && !includeExtraShift))
                    {
                        minutes += (int)(block.StopTime - block.StartTime).TotalMinutes;
                        foreach (TimeScheduleTemplateBlock brk in overlappedBreaks)
                            minutes -= (int)CalendarUtility.GetNewTimeInCurrent(block.StartTime, block.StopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                    }
                    else if (timeScheduleType != null && timeScheduleType.UseScheduleTimeFactor)
                        minutes -= CalculateFactorMinutes(block.StartTime, block.StopTime, timeScheduleType.TimeScheduleTypeFactor.ToList(), overlappedBreaks);
                }

            }

            return minutes;
        }

        private int CalculateFactorMinutes(DateTime startTime, DateTime stopTime, List<TimeScheduleTypeFactor> factors, IEnumerable<IScheduleBlockObject> overlappedBreaks, List<BreakDTO> breakDTOs = null)
        {
            int minutes = 0;

            if (factors.IsNullOrEmpty())
                return minutes;

            foreach (TimeScheduleTypeFactor factor in factors.Where(w => w.State == (int)SoeEntityState.Active))
            {
                TimeSpan factorTime = new TimeSpan();
                double factorMinutes = 0;

                if (CalendarUtility.IsCurrentOverlappedByNew(factor.FromTime, factor.ToTime, startTime, stopTime))
                {
                    // Presence shift is completely overlapped by factor
                    factorMinutes = (stopTime - startTime).TotalMinutes;
                    // Reduce time with the break time that overlaps
                    if (breakDTOs != null)
                        foreach (var brk in breakDTOs)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(startTime, stopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                    else
                        foreach (var brk in overlappedBreaks)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(startTime, stopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                }
                else if (CalendarUtility.IsNewOverlappedByCurrent(factor.FromTime, factor.ToTime, startTime, stopTime))
                {
                    // Factor is completely overlapped by a presence shift
                    factorMinutes = (factor.ToTime - factor.FromTime).TotalMinutes;
                    // Reduce time with the break time that overlaps
                    if (breakDTOs != null)
                        foreach (var brk in breakDTOs)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(factor.FromTime, factor.ToTime, brk.StartTime, brk.StopTime).TotalMinutes;
                    else
                        foreach (var brk in overlappedBreaks)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(factor.FromTime, factor.ToTime, brk.StartTime, brk.StopTime).TotalMinutes;
                }
                else if (CalendarUtility.IsNewOverlappingCurrentStart(factor.FromTime, factor.ToTime, startTime, stopTime))
                {
                    // Factor end intersects with a presence shift
                    factorMinutes = (factor.ToTime - startTime).TotalMinutes;
                    // Reduce time with the break time that overlaps
                    if (breakDTOs != null)
                        foreach (var brk in breakDTOs)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(startTime, factor.ToTime, brk.StartTime, brk.StopTime).TotalMinutes;
                    else
                        foreach (var brk in overlappedBreaks)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(startTime, factor.ToTime, brk.StartTime, brk.StopTime).TotalMinutes;
                }
                else if (CalendarUtility.IsNewOverlappingCurrentStop(factor.FromTime, factor.ToTime, startTime, stopTime))
                {
                    // Factor start intersects with a presence shift
                    factorMinutes = (stopTime - factor.FromTime).TotalMinutes;
                    // Reduce time with the break time that overlaps
                    if (breakDTOs != null)
                        foreach (var brk in breakDTOs)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(factor.FromTime, stopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                    else
                        foreach (var brk in overlappedBreaks)
                            factorMinutes -= (int)CalendarUtility.GetNewTimeInCurrent(factor.FromTime, stopTime, brk.StartTime, brk.StopTime).TotalMinutes;
                }

                factorTime = factorTime.Add(TimeSpan.FromMinutes(factorMinutes * (double)(factor.Factor - 1)));
                minutes += (int)factorTime.TotalMinutes;
            }

            return minutes;
        }

        public decimal GetAverageDaysPerWeek(int actorCompanyId, int employeeId, DateTime date, out bool isWorkDay)
        {
            decimal average = 0;
            isWorkDay = false;

            var templateHead = GetTimeScheduleTemplateHeadForEmployee(actorCompanyId, employeeId, date);
            if (templateHead != null)
            {
                DateTime dateFrom = templateHead.GetCycleStartFromGivenDate(date);
                DateTime dateTo = dateFrom.AddDays(templateHead.NoOfDays - 1);

                List<TimeSchedulePlanningDayDTO> rows = GetTimeSchedulePlanningTemplate(actorCompanyId, 0, 0, 0, templateHead.TimeScheduleTemplateHeadId, dateFrom, dateTo, useNbrOfDaysFromTemplate: false).ToList();
                List<DateTime> dates = rows.Select(r => r.StartTime.Date).Distinct().ToList();

                average = Decimal.Round((Decimal.Divide(dates.Count, templateHead.NoOfDays) * 7), 2);

                List<TimeSchedulePlanningDayDTO> workdays = rows.Where(r => r.StartTime.Date == date).ToList();
                if (workdays.Any(t => t.StartTime != t.StopTime))
                    isWorkDay = true;
            }

            return average;
        }

        public Dictionary<DateTime, int> GetTimeScheduleTypeFactorsWithinShiftsDict(CompEntities entities, int actorCompanyId, int employeeId, DateTime startDate, DateTime stopDate, IEnumerable<IScheduleBlockObject> scheduleBlocks = null, List<TimeScheduleType> timeScheduleTypes = null)
        {
            Dictionary<DateTime, int> dict = new Dictionary<DateTime, int>();

            if (timeScheduleTypes != null && timeScheduleTypes.All(tst => tst.TimeScheduleTypeFactor.IsLoaded))
                timeScheduleTypes = timeScheduleTypes.Where(tst => tst.UseScheduleTimeFactor).ToList();
            else
                timeScheduleTypes = GetTimeScheduleTypes(entities, actorCompanyId, onlyActive: true, onlyUseScheduleTimeFactor: true, loadFactors: true);
            if (timeScheduleTypes.IsNullOrEmpty())
                return dict;

            if (scheduleBlocks.IsNullOrEmpty())
            {
                var scheduleBlocksForEmployee = (from b in entities.TimeScheduleTemplateBlock
                                                 where !b.TimeScheduleScenarioHeadId.HasValue &&
                                                 b.EmployeeId == employeeId &&
                                                 b.Date.HasValue &&
                                                 b.Date >= startDate &&
                                                 b.Date <= stopDate &&
                                                 b.State == (int)SoeEntityState.Active
                                                 select b).ToList();

                //Post db-exec filtering
                scheduleBlocks = scheduleBlocksForEmployee.Where(b => b.TimeScheduleEmployeePeriodId.HasValue && b.StartTime != b.StopTime);
            }
            else
            {
                scheduleBlocks = (from b in scheduleBlocks
                                  where b.EmployeeId == employeeId &&
                                  b.Date.HasValue &&
                                  b.Date >= startDate &&
                                  b.Date <= stopDate
                                  select b).ToList();
            }

            List<int> timeScheduleTypeIds = timeScheduleTypes.Select(i => i.TimeScheduleTypeId).ToList();
            List<IScheduleBlockObject> workScheduleBlocks = scheduleBlocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None && b.TimeScheduleTypeId.HasValue && timeScheduleTypeIds.Contains(b.TimeScheduleTypeId.Value)).ToList();
            foreach (IGrouping<DateTime, IScheduleBlockObject> workScheduleBlocksByDate in workScheduleBlocks.GroupBy(i => i.Date.Value))
            {
                int minutes = 0;

                foreach (IScheduleBlockObject workScheduleBlock in workScheduleBlocksByDate)
                {
                    TimeScheduleType timeScheduleType = timeScheduleTypes.FirstOrDefault(i => i.TimeScheduleTypeId == workScheduleBlock.TimeScheduleTypeId);
                    if (timeScheduleType == null)
                        continue;

                    List<TimeScheduleTypeFactor> factors = timeScheduleType.TimeScheduleTypeFactor?.ToList();
                    if (factors.IsNullOrEmpty())
                        continue;

                    // Get breaks for current shift
                    var breakScheduleBlocks = (from tb in scheduleBlocks
                                               where tb.Date == workScheduleBlock.Date &&
                                               tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None
                                               orderby tb.StartTime
                                               select tb).ToList();

                    // Check which breaks that actually overlap the shift
                    minutes += CalculateFactorMinutes(workScheduleBlock.StartTime, workScheduleBlock.StopTime, factors, workScheduleBlock.GetOverlappedBreaks(breakScheduleBlocks, includeBreaksThatCouldBothStartAndEndInScheduleBlock: true));
                }

                dict.Add(workScheduleBlocksByDate.Key, minutes);
            }

            return dict;
        }

        #endregion

        #region TimeScheduleEmployeePeriod

        private TimeScheduleEmployeePeriod CreateTimeScheduleEmployeePeriodIfNotExist(CompEntities entities, int actorCompanyId, DateTime date, int employeeId, List<TimeScheduleEmployeePeriod> employeePeriods = null)
        {
            TimeScheduleEmployeePeriod employeePeriod = null;
            if (employeePeriods != null)
                employeePeriod = employeePeriods.FirstOrDefault(i => i.EmployeeId == employeeId && i.Date == date);
            if (employeePeriod == null)
                employeePeriod = GetTimeScheduleEmployeePeriod(entities, actorCompanyId, employeeId, date);

            if (employeePeriod == null)
            {
                employeePeriod = new TimeScheduleEmployeePeriod()
                {
                    Date = date.Date,

                    //Set FK
                    ActorCompanyId = actorCompanyId,
                    EmployeeId = employeeId,

                };
                entities.TimeScheduleEmployeePeriod.AddObject(employeePeriod);
                SetCreatedProperties(employeePeriod);
            }

            return employeePeriod;
        }

        public TimeScheduleEmployeePeriod GetTimeScheduleEmployeePeriod(CompEntities entities, int timeScheduleEmployeePeriodId, bool loadTimeScheduleTemplateBlocks = false)
        {
            if (loadTimeScheduleTemplateBlocks)
            {
                return (from per in entities.TimeScheduleEmployeePeriod
                                            .Include("TimeScheduleTemplateBlock")
                        where per.TimeScheduleEmployeePeriodId == timeScheduleEmployeePeriodId &&
                        per.State == (int)SoeEntityState.Active
                        select per).FirstOrDefault();
            }
            else
            {
                return (from per in entities.TimeScheduleEmployeePeriod
                        where per.TimeScheduleEmployeePeriodId == timeScheduleEmployeePeriodId &&
                        per.State == (int)SoeEntityState.Active
                        select per).FirstOrDefault();
            }
        }

        public TimeScheduleEmployeePeriod GetTimeScheduleEmployeePeriod(CompEntities entities, int actorCompanyId, int employeeId, DateTime date)
        {
            TimeScheduleEmployeePeriod period = (from t in entities.TimeScheduleEmployeePeriod
                                                 where t.ActorCompanyId == actorCompanyId &&
                                                 t.EmployeeId == employeeId &&
                                                 DbFunctions.TruncateTime(t.Date) == date.Date && //fixes date with time fraction problem, new data should not have a time fraction                                                                                                  
                                                 t.State == (int)SoeEntityState.Active
                                                 select t).FirstOrDefault();
            return period;
        }

        public int GetTimeScheduleEmployeePeriodId(int actorCompanyId, int employeeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleEmployeePeriod.NoTracking();
            TimeScheduleEmployeePeriod period = (from t in entities.TimeScheduleEmployeePeriod
                                                 where t.ActorCompanyId == actorCompanyId &&
                                                 t.EmployeeId == employeeId &&
                                                 DbFunctions.TruncateTime(t.Date) == date.Date && //fixes date with time fraction problem, new data should not have a time fraction                                                                                                  
                                                 t.State == (int)SoeEntityState.Active
                                                 select t).FirstOrDefault();

            return period != null ? period.TimeScheduleEmployeePeriodId : 0;
        }

        public List<int> GetTimeScheduleEmployeePeriodIds(int actorCompanyId, int employeeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleEmployeePeriod.NoTracking();
            List<int> periodIds = (from t in entities.TimeScheduleEmployeePeriod
                                   where t.ActorCompanyId == actorCompanyId &&
                                   t.EmployeeId == employeeId &&
                                   DbFunctions.TruncateTime(t.Date) == date.Date &&//fix date with time fraction problem, new data should not have a time fraction                                                                       
                                   t.State == (int)SoeEntityState.Active
                                   select t.TimeScheduleEmployeePeriodId).ToList();

            return periodIds;
        }

        public List<int> GetTimeScheduleEmployeePeriodIds(int actorCompanyId, int employeeId, DateTime dateFrom, DateTime dateTo)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleEmployeePeriod.NoTracking();
            List<int> periodIds = (from t in entities.TimeScheduleEmployeePeriod
                                   where t.ActorCompanyId == actorCompanyId &&
                                   t.EmployeeId == employeeId &&
                                   DbFunctions.TruncateTime(t.Date) >= dateFrom.Date &&
                                   DbFunctions.TruncateTime(t.Date) <= dateTo.Date &&
                                   t.State == (int)SoeEntityState.Active
                                   select t.TimeScheduleEmployeePeriodId).ToList();

            return periodIds;
        }

        public List<int> GetEmployeeIdsWithPreliminarySchedule(DateTime startDate, DateTime stopDate, int actorCompanyId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                    where !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.TimeScheduleEmployeePeriod.ActorCompanyId == actorCompanyId &&
                    tb.IsPreliminary &&
                    tb.Date.HasValue && tb.Date >= startDate && tb.Date <= stopDate &&
                    tb.State == (int)SoeEntityState.Active &&
                    tb.EmployeeId.HasValue &&
                    tb.Employee.State == (int)SoeEntityState.Active
                    select tb.EmployeeId.Value).Distinct().ToList();
        }

        #endregion

        #region TimeScheduleEmployeePeriodDetail

        public TimeScheduleEmployeePeriodDetail GetTimeScheduleEmployeePeriodDetail(CompEntities entities, int timeScheduleEmployeePeriodDetailId, int actorCompanyId)
        {
            return (from t in entities.TimeScheduleEmployeePeriodDetail
                    where t.TimeScheduleEmployeePeriodDetailId == timeScheduleEmployeePeriodDetailId &&
                    t.TimeScheduleEmployeePeriod.ActorCompanyId == actorCompanyId &&
                    t.State == (int)SoeEntityState.Active
                    select t).FirstOrDefault();
        }

        public TimeScheduleEmployeePeriodDetail GetTimeScheduleEmployeePeriodDetail(CompEntities entities, int employeeId, DateTime date, int actorCompanyId, SoeTimeScheduleEmployeePeriodDetailType type)
        {
            return (from t in entities.TimeScheduleEmployeePeriodDetail
                    where t.TimeScheduleEmployeePeriod.Date == date &&
                    t.TimeScheduleEmployeePeriod.EmployeeId == employeeId &&
                    t.TimeScheduleEmployeePeriod.ActorCompanyId == actorCompanyId &&
                    t.Type == (int)type &&
                    t.State == (int)SoeEntityState.Active
                    select t).FirstOrDefault();
        }

        public List<TimeScheduleEmployeePeriodDetail> GetTimeScheduleEmployeePeriodDetails(CompEntities entities, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, int actorCompanyId, SoeTimeScheduleEmployeePeriodDetailType type)
        {
            return (from t in entities.TimeScheduleEmployeePeriodDetail
                    where t.TimeScheduleEmployeePeriod.Date >= dateFrom.Date &&
                    t.TimeScheduleEmployeePeriod.Date <= dateTo.Date &&
                    employeeIds.Contains(t.TimeScheduleEmployeePeriod.EmployeeId) &&
                    t.TimeScheduleEmployeePeriod.ActorCompanyId == actorCompanyId &&
                    t.Type == (int)type &&
                    t.State == (int)SoeEntityState.Active
                    select t).ToList();
        }

        public ActionResult ResetTimeScheduleEmployeePeriodDetailsValue(List<int> employeeIds, DateTime dateFrom, DateTime dateTo, int actorCompanyId, SoeTimeScheduleEmployeePeriodDetailType type)
        {
            ActionResult result = new ActionResult();
            using (CompEntities entities = new CompEntities())
            {
                var details = GetTimeScheduleEmployeePeriodDetails(entities, employeeIds, dateFrom, dateTo, actorCompanyId, type);
                foreach (var detail in details)
                {
                    if (detail.Type == (int)SoeTimeScheduleEmployeePeriodDetailType.LeisureCode)
                    {
                        result = ChangeEntityState(entities, detail, SoeEntityState.Deleted, false);
                        if (!result.Success)
                            return result;
                    }
                }
                return SaveChanges(entities);
            }
        }

        public ActionResult SaveTimeScheduleEmployeePeriodDetail(TimeScheduleEmployeePeriodDetailDTO input, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                TimeScheduleEmployeePeriodDetail detail = GetTimeScheduleEmployeePeriodDetail(entities, input.TimeScheduleEmployeePeriodDetailId, actorCompanyId);
                if (detail == null)
                {
                    TimeScheduleEmployeePeriod period = CreateTimeScheduleEmployeePeriodIfNotExist(entities, actorCompanyId, input.Date, input.EmployeeId);
                    detail = new TimeScheduleEmployeePeriodDetail()
                    {
                        TimeScheduleEmployeePeriod = period,
                        TimeScheduleScenarioHeadId = input.TimeScheduleScenarioHeadId,
                        Type = (int)input.Type
                    };
                    SetCreatedProperties(detail);
                    entities.TimeScheduleEmployeePeriodDetail.AddObject(detail);
                }
                else
                {
                    SetModifiedProperties(detail);
                }

                detail.TimeLeisureCodeId = input.TimeLeisureCodeId;

                ActionResult result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = detail.TimeScheduleEmployeePeriodDetailId;

                return result;
            }
        }

        public ActionResult DeleteTimeScheduleEmployeePeriodDetail(List<int> timeScheduleEmployeePeriodDetailIds, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                foreach (int detailId in timeScheduleEmployeePeriodDetailIds)
                {
                    TimeScheduleEmployeePeriodDetail detail = GetTimeScheduleEmployeePeriodDetail(entities, detailId, actorCompanyId);
                    if (detail != null)
                    {
                        ActionResult result = ChangeEntityState(entities, detail, SoeEntityState.Deleted, false);
                        if (!result.Success)
                            return result;
                    }
                }

                return SaveChanges(entities);
            }
        }

        #endregion

        #region TimeScheduleEvent

        public List<TimeScheduleEvent> GetTimeScheduleEvents(int actorCompanyId, int? timeScheduleEventId = null)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleEvent.NoTracking();
            entitiesReadOnly.TimeScheduleEventMessageGroup.NoTracking();
            entitiesReadOnly.MessageGroup.NoTracking();
            entitiesReadOnly.MessageGroupMapping.NoTracking();

            IQueryable<TimeScheduleEvent> query = (from t in entitiesReadOnly.TimeScheduleEvent.Include("TimeScheduleEventMessageGroup.MessageGroup.MessageGroupMapping")
                                                   where t.ActorCompanyId == actorCompanyId &&
                                                   t.State == (int)SoeEntityState.Active
                                                   select t);

            if (timeScheduleEventId.HasValue)
                query = query.Where(t => t.TimeScheduleEventId == timeScheduleEventId.Value);


            return query.OrderBy(t => t.Name).ToList();
        }

        public List<DateTime> GetTimeScheduleEventDatesForPlanning(int actorCompanyId, int userId, DateTime dateFrom, DateTime dateTo)
        {
            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            // Get opening hours with specific date, within specified interval
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.OpeningHours.NoTracking();
            List<DateTime> dates = (from o in entities.OpeningHours
                                    where o.ActorCompanyId == actorCompanyId &&
                                    o.State == (int)SoeEntityState.Active &&
                                    o.SpecificDate.HasValue && o.SpecificDate >= dateFrom && o.SpecificDate <= dateTo
                                    select o.SpecificDate.Value).ToList();

            // Get events within specified interval
            entities.TimeScheduleEvent.NoTracking();
            List<TimeScheduleEvent> events = (from t in entities.TimeScheduleEvent.Include("TimeScheduleEventMessageGroup.MessageGroup.MessageGroupMapping")
                                              where t.ActorCompanyId == actorCompanyId &&
                                              t.State == (int)SoeEntityState.Active &&
                                              t.Date >= dateFrom && t.Date <= dateTo
                                              orderby t.Date, t.Name
                                              select t).ToList();

            foreach (TimeScheduleEvent evnt in events)
            {
                // If current date is already added, don't bother to check message groups
                if (dates.Contains(evnt.Date))
                    continue;

                bool allowedToSeeEvent = false;

                // Loop through all message groups to see if specified user is included in any and therefore allowed to see the event
                foreach (TimeScheduleEventMessageGroup eventGroup in evnt.TimeScheduleEventMessageGroup)
                {
                    allowedToSeeEvent = CommunicationManager.IsUserInMessageGroup(eventGroup.MessageGroup, actorCompanyId, userId, dateFrom: dateFrom, dateTo: dateTo);
                    if (allowedToSeeEvent)
                        break;
                }

                if (allowedToSeeEvent)
                    dates.Add(evnt.Date);
            }

            return dates.Distinct().ToList();
        }

        public List<TimeScheduleEventForPlanningDTO> GetTimeScheduleEventsForPlanning(int actorCompanyId, int userId, DateTime date)
        {
            List<TimeScheduleEventForPlanningDTO> dtos = new List<TimeScheduleEventForPlanningDTO>();

            DateTime dateFrom = CalendarUtility.GetBeginningOfDay(date);
            DateTime dateTo = CalendarUtility.GetEndOfDay(date);

            // Get opening hours with specific date, within specified interval
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.OpeningHours.NoTracking();
            List<OpeningHours> hours = (from o in entities.OpeningHours
                                        where o.ActorCompanyId == actorCompanyId &&
                                        o.State == (int)SoeEntityState.Active &&
                                        o.SpecificDate.HasValue && o.SpecificDate >= dateFrom && o.SpecificDate <= dateTo
                                        orderby o.SpecificDate, o.Name
                                        select o).ToList();

            foreach (OpeningHours hour in hours)
            {
                dtos.Add(new TimeScheduleEventForPlanningDTO()
                {
                    OpeningHoursId = hour.OpeningHoursId,
                    Date = hour.SpecificDate.Value,
                    OpeningTime = hour.OpeningTime,
                    ClosingTime = hour.ClosingTime,
                    Name = hour.Name,
                    Description = hour.Description
                });
            }

            // Get events within specified interval
            entities.TimeScheduleEvent.NoTracking();
            List<TimeScheduleEvent> events = (from t in entities.TimeScheduleEvent.Include("TimeScheduleEventMessageGroup.MessageGroup.MessageGroupMapping")
                                              where t.ActorCompanyId == actorCompanyId &&
                                              t.State == (int)SoeEntityState.Active &&
                                              t.Date >= dateFrom && t.Date <= dateTo
                                              orderby t.Date, t.Name
                                              select t).ToList();

            foreach (TimeScheduleEvent evnt in events)
            {
                bool allowedToSeeEvent = false;

                // Loop through all message groups to see if specified user is included in any and therefore allowed to see the event
                foreach (TimeScheduleEventMessageGroup eventGroup in evnt.TimeScheduleEventMessageGroup)
                {
                    allowedToSeeEvent = CommunicationManager.IsUserInMessageGroup(eventGroup.MessageGroup, actorCompanyId, userId, dateFrom: dateFrom, dateTo: dateTo);
                    if (allowedToSeeEvent)
                        break;
                }

                if (allowedToSeeEvent)
                {
                    dtos.Add(new TimeScheduleEventForPlanningDTO()
                    {
                        TimeScheduleEventId = evnt.TimeScheduleEventId,
                        Date = evnt.Date,
                        Name = evnt.Name,
                        Description = evnt.Description
                    });
                }
            }

            return dtos;
        }

        public Dictionary<int, string> GetTimeScheduleEventsDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleEvent.NoTracking();
            List<TimeScheduleEvent> events = (from t in entities.TimeScheduleEvent
                                              where t.ActorCompanyId == actorCompanyId &&
                                              t.State == (int)SoeEntityState.Active
                                              orderby t.Name
                                              select t).ToList();

            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            foreach (TimeScheduleEvent even in events)
            {
                dict.Add(even.TimeScheduleEventId, even.Name);
            }

            return dict;
        }

        public TimeScheduleEvent GetTimeScheduleEvent(int timeScheduleEventId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleEvent.NoTracking();
            return GetTimeScheduleEvent(entities, timeScheduleEventId, actorCompanyId);
        }

        public TimeScheduleEvent GetTimeScheduleEvent(CompEntities entities, int timeScheduleEventId, int actorCompanyId)
        {
            return (from t in entities.TimeScheduleEvent
                    .Include("TimeScheduleEventMessageGroup")
                    where t.ActorCompanyId == actorCompanyId &&
                    t.TimeScheduleEventId == timeScheduleEventId &&
                    t.State == (int)SoeEntityState.Active
                    select t).FirstOrDefault();
        }

        public ActionResult SaveTimeScheduleEvent(TimeScheduleEventDTO timeScheduleEventInput, int actorCompanyId)
        {
            if (timeScheduleEventInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeScheduleEvent");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                TimeScheduleEvent timeScheduleEvent = GetTimeScheduleEvent(entities, timeScheduleEventInput.TimeScheduleEventId, actorCompanyId);
                if (timeScheduleEvent == null)
                {
                    timeScheduleEvent = new TimeScheduleEvent()
                    {
                        Company = company,
                        Name = timeScheduleEventInput.Name,
                        Description = timeScheduleEventInput.Description,
                        Date = timeScheduleEventInput.Date
                    };
                    SetCreatedProperties(timeScheduleEvent);
                    entities.TimeScheduleEvent.AddObject(timeScheduleEvent);
                }
                else
                {
                    timeScheduleEvent.Name = timeScheduleEventInput.Name;
                    timeScheduleEvent.Description = timeScheduleEventInput.Description;
                    timeScheduleEvent.Date = timeScheduleEventInput.Date;
                    SetModifiedProperties(timeScheduleEvent);
                }

                List<TimeScheduleEventMessageGroup> existingGroups = timeScheduleEventInput.TimeScheduleEventId > 0 ? GetTimeScheduleEventMessageGroups(entities, timeScheduleEventInput.TimeScheduleEventId) : new List<TimeScheduleEventMessageGroup>();

                #region Delete rows that exists in db but not in input.

                foreach (var existingGroup in existingGroups)
                {
                    if (!timeScheduleEventInput.TimeScheduleEventMessageGroups.Any(x => x.MessageGroupId == existingGroup.MessageGroupId))
                        DeleteEntityItem(entities, existingGroup);
                }

                #endregion

                #region Add/update messageGroups
                if (timeScheduleEventInput.TimeScheduleEventMessageGroups != null)
                {
                    foreach (var incomingGroup in timeScheduleEventInput.TimeScheduleEventMessageGroups)
                    {
                        TimeScheduleEventMessageGroup existingGroup = GetTimeScheduleEventMessageGroup(entities, timeScheduleEventInput.TimeScheduleEventId, incomingGroup.MessageGroupId);
                        if (existingGroup == null)
                        {
                            existingGroup = new TimeScheduleEventMessageGroup()
                            {
                                TimeScheduleEvent = timeScheduleEvent,
                                MessageGroupId = incomingGroup.MessageGroupId,
                            };
                            entities.TimeScheduleEventMessageGroup.AddObject(existingGroup);
                        }
                    }
                }

                #endregion

                ActionResult result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = timeScheduleEvent.TimeScheduleEventId;

                return result;
            }
        }

        public List<TimeScheduleEventMessageGroup> GetTimeScheduleEventMessageGroups(CompEntities entities, int timeScheduleEventId)
        {
            return (from t in entities.TimeScheduleEventMessageGroup
                    where t.TimeScheduleEventId == timeScheduleEventId
                    select t).ToList();
        }

        public TimeScheduleEventMessageGroup GetTimeScheduleEventMessageGroup(CompEntities entities, int timeScheduleEventId, int messageGroupId)
        {
            return (from t in entities.TimeScheduleEventMessageGroup
                    where t.TimeScheduleEventId == timeScheduleEventId && t.MessageGroupId == messageGroupId
                    select t).FirstOrDefault();
        }

        public ActionResult DeleteTimeScheduleEvent(int timeScheduleEventId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeScheduleEvent timeScheduleEvent = GetTimeScheduleEvent(entities, timeScheduleEventId, actorCompanyId);
                if (timeScheduleEvent == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeScheduleEvent");

                return ChangeEntityState(entities, timeScheduleEvent, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region TimeScheduleScenarioEmployee

        public List<int> GetTimeScheduleScenarioEmployeeIds(int timeScheduleScenarioHeadId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleScenarioEmployee.NoTracking();
            return (from e in entities.TimeScheduleScenarioEmployee
                    where e.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId &&
                    e.TimeScheduleScenarioHead.ActorCompanyId == actorCompanyId
                    select e.EmployeeId).ToList();
        }

        #endregion

        #region TimeScheduleScenarioHead

        public List<TimeScheduleScenarioHead> GetTimeScheduleScenarioHeads(int actorCompanyId, List<int> validAccountIds)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleScenarioHead.NoTracking();
            IQueryable<TimeScheduleScenarioHead> query = entitiesReadOnly.TimeScheduleScenarioHead;
            if (validAccountIds != null)
                query = query.Include("TimeScheduleScenarioAccount");

            List<TimeScheduleScenarioHead> heads = (from t in query
                                                    where t.ActorCompanyId == actorCompanyId &&
                                                    t.State == (int)SoeEntityState.Active
                                                    select t).ToList();
            if (validAccountIds != null)
            {
                foreach (TimeScheduleScenarioHead head in heads.ToList())
                {
                    if (head.TimeScheduleScenarioAccount.Any() && !head.TimeScheduleScenarioAccount.Any(a => validAccountIds.Contains(a.AccountId)))
                        heads.Remove(head);
                }
            }

            return heads.OrderBy(h => h.Name).ToList();
        }

        public Dictionary<int, string> GetTimeScheduleScenarioHeadsDict(int actorCompanyId, List<int> validAccountIds, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, String.Empty);

            List<TimeScheduleScenarioHead> heads = GetTimeScheduleScenarioHeads(actorCompanyId, validAccountIds);
            foreach (TimeScheduleScenarioHead head in heads)
            {
                dict.Add(head.TimeScheduleScenarioHeadId, head.Name);
            }

            return dict;
        }

        public TimeScheduleScenarioHead GetTimeScheduleScenarioHead(int timeScheduleScenarioHeadId, int actorCompanyId, bool loadEmployees = false, bool loadAccounts = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleScenarioHead.NoTracking();
            return GetTimeScheduleScenarioHead(entities, timeScheduleScenarioHeadId, actorCompanyId, loadEmployees, loadAccounts);
        }

        public TimeScheduleScenarioHead GetTimeScheduleScenarioHead(CompEntities entities, int timeScheduleScenarioHeadId, int actorCompanyId, bool loadEmployees = false, bool loadAccounts = false)
        {
            IQueryable<TimeScheduleScenarioHead> query = entities.TimeScheduleScenarioHead;
            if (loadEmployees)
                query = query.Include("TimeScheduleScenarioEmployee");
            if (loadAccounts)
                query = query.Include("TimeScheduleScenarioAccount");

            TimeScheduleScenarioHead head = (from t in query
                                             where t.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId &&
                                             t.ActorCompanyId == actorCompanyId &&
                                             t.State == (int)SoeEntityState.Active
                                             select t).FirstOrDefault();
            return head;
        }

        public ActionResult SaveTimeScheduleScenarioHead(int actorCompanyId, TimeScheduleScenarioHeadDTO scenarioHeadInput, int? timeScheduleScenarioHeadId)
        {
            if (scenarioHeadInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeScheduleScenarioHead");

            Employee hiddenEmployee = EmployeeManager.GetHiddenEmployee(actorCompanyId);
            using (CompEntities entities = new CompEntities())
            {
                #region ScenarioHead

                TimeScheduleScenarioHead scenarioHead = GetTimeScheduleScenarioHead(entities, scenarioHeadInput.TimeScheduleScenarioHeadId, actorCompanyId, true, true);
                if (scenarioHead == null)
                {
                    scenarioHead = new TimeScheduleScenarioHead()
                    {
                        ActorCompanyId = actorCompanyId,
                        SourceType = (int)scenarioHeadInput.SourceType,
                        SourceDateFrom = scenarioHeadInput.SourceDateFrom,
                        SourceDateTo = scenarioHeadInput.SourceDateTo
                    };
                    SetCreatedProperties(scenarioHead);
                    entities.TimeScheduleScenarioHead.AddObject(scenarioHead);
                }
                else
                {
                    SetModifiedProperties(scenarioHead);
                }

                scenarioHead.Name = scenarioHeadInput.Name;
                scenarioHead.DateFrom = scenarioHeadInput.DateFrom;
                scenarioHead.DateTo = scenarioHeadInput.DateTo;

                #endregion

                #region Accounts
                List<int> inputAccountIds = new List<int>();
                if (scenarioHeadInput.Accounts != null)
                {
                    inputAccountIds = scenarioHeadInput.Accounts.Select(e => e.AccountId).ToList();

                    // Check if existing accounts still exists in input
                    if (scenarioHead.TimeScheduleScenarioAccount.Any())
                    {
                        foreach (TimeScheduleScenarioAccount acc in scenarioHead.TimeScheduleScenarioAccount.ToList())
                        {
                            if (inputAccountIds.Contains(acc.AccountId))
                                inputAccountIds.Remove(acc.AccountId);
                            else
                                entities.DeleteObject(acc);
                        }
                    }

                    // Add new from input
                    foreach (int accountId in inputAccountIds)
                    {
                        scenarioHead.TimeScheduleScenarioAccount.Add(new TimeScheduleScenarioAccount() { AccountId = accountId });
                    }
                }

                #endregion

                #region Employees

                List<int> inputEmployeeIds = new List<int>();
                Dictionary<int, int> replacementEmployeeIds = new Dictionary<int, int>();

                if (scenarioHeadInput.Employees != null)
                {
                    inputEmployeeIds = scenarioHeadInput.Employees.Select(e => e.EmployeeId).ToList();
                    foreach (TimeScheduleScenarioEmployeeDTO employee in scenarioHeadInput.Employees.Where(e => e.ReplacementEmployeeId.HasValue && e.ReplacementEmployeeId.Value != 0))
                    {
                        replacementEmployeeIds.Add(employee.EmployeeId, employee.ReplacementEmployeeId.Value);
                    }

                    // Check if existing employees still exists in input
                    if (scenarioHead.TimeScheduleScenarioEmployee.Any())
                    {
                        foreach (TimeScheduleScenarioEmployee emp in scenarioHead.TimeScheduleScenarioEmployee.ToList())
                        {
                            if (inputEmployeeIds.Contains(emp.EmployeeId))
                            {
                                // Still exists, so remove from input to prevent adding below
                                inputEmployeeIds.Remove(emp.EmployeeId);
                            }
                            else
                            {
                                // Remove shifts linked to employee
                                List<TimeScheduleTemplateBlock> shifts = (from b in entities.TimeScheduleTemplateBlock
                                                                          where b.TimeScheduleScenarioHeadId == scenarioHeadInput.TimeScheduleScenarioHeadId &&
                                                                          b.EmployeeId == emp.EmployeeId &&
                                                                          b.State != (int)SoeEntityState.Deleted
                                                                          select b).ToList();

                                foreach (TimeScheduleTemplateBlock shift in shifts)
                                {
                                    ChangeEntityState(shift, SoeEntityState.Deleted);
                                }

                                // TODO: Remove scenario absence linked to employee

                                // Remove employee from scenario
                                entities.DeleteObject(emp);
                            }
                        }
                    }

                    // Add new from input
                    foreach (int employeeId in inputEmployeeIds)
                    {
                        scenarioHead.TimeScheduleScenarioEmployee.Add(new TimeScheduleScenarioEmployee() { EmployeeId = replacementEmployeeIds.ContainsKey(employeeId) ? replacementEmployeeIds[employeeId] : employeeId });
                    }
                }

                #endregion

                #region Shifts

                if (scenarioHeadInput.TimeScheduleScenarioHeadId == 0)
                {
                    int offsetDays = 0;
                    if (!scenarioHeadInput.SourceDateFrom.HasValue)
                        scenarioHeadInput.SourceDateFrom = scenarioHeadInput.DateFrom;
                    if (!scenarioHeadInput.SourceDateTo.HasValue)
                        scenarioHeadInput.SourceDateTo = scenarioHeadInput.DateTo;
                    offsetDays = (int)((scenarioHeadInput.DateFrom - scenarioHeadInput.SourceDateFrom.Value).TotalDays);

                    switch (scenarioHeadInput.SourceType)
                    {
                        case TermGroup_TimeScheduleScenarioHeadSourceType.Schedule:
                        case TermGroup_TimeScheduleScenarioHeadSourceType.Scenario:
                            {
                                List<TimeScheduleTemplateBlock> allBlocks = GetTimeScheduleTemplateBlocksForEmployees(entities, inputEmployeeIds, scenarioHeadInput.SourceDateFrom.Value, scenarioHeadInput.SourceDateTo.Value, true, scenarioHeadInput.SourceType == TermGroup_TimeScheduleScenarioHeadSourceType.Schedule ? (int?)null : timeScheduleScenarioHeadId).Where(b => b.StartTime != b.StopTime).ToList();
                                if (inputAccountIds.Any())
                                    allBlocks = allBlocks.Where(x => x.IsBreak || (!x.IsBreak && x.AccountId.HasValue && inputAccountIds.Contains(x.AccountId.Value))).ToList();

                                Dictionary<int, List<TimeScheduleTemplateBlock>> scheduleBlocksGrouped = allBlocks.GroupBy(g => g.EmployeeId.Value).ToDictionary(x => x.Key, x => x.ToList());

                                if (allBlocks.Any())
                                {
                                    foreach (var employeeId in inputEmployeeIds)
                                    {
                                        List<TimeScheduleTemplateBlock> currentEmployeeScheduleBlocks = scheduleBlocksGrouped.ContainsKey(employeeId) ? scheduleBlocksGrouped[employeeId] : new List<TimeScheduleTemplateBlock>();

                                        foreach (var scheduleBlocksByDate in currentEmployeeScheduleBlocks.GroupBy(x => x.Date.Value.Date))
                                        {
                                            List<TimeScheduleTemplateBlock> blocksToCopyCurrentEmployeeCurrentDate = new List<TimeScheduleTemplateBlock>();

                                            #region Decide which breaks to include (breaks dont have accountid set)

                                            foreach (var shift in scheduleBlocksByDate.Where(x => !x.IsBreak))
                                            {
                                                blocksToCopyCurrentEmployeeCurrentDate.Add(shift);
                                                var breaks = shift.GetOverlappedBreaks(scheduleBlocksByDate.Where(x => x.IsBreak)).ToList();
                                                if (hiddenEmployee != null && hiddenEmployee.EmployeeId == employeeId)
                                                    breaks = breaks.Where(x => x.Link == shift.Link).ToList();

                                                blocksToCopyCurrentEmployeeCurrentDate.AddRange(breaks);
                                            }

                                            #endregion

                                            if (!blocksToCopyCurrentEmployeeCurrentDate.Any())
                                                continue;

                                            int? newEmployeeId = null;
                                            if (replacementEmployeeIds.ContainsKey(scheduleBlocksByDate.First().EmployeeId.Value))
                                                newEmployeeId = replacementEmployeeIds[scheduleBlocksByDate.First().EmployeeId.Value];

                                            DateTime? newDate = null;
                                            if (offsetDays != 0)
                                                newDate = scheduleBlocksByDate.Key.AddDays(offsetDays);

                                            TimeScheduleEmployeePeriod newTimeScheduleEmployeePeriod = null;
                                            if (newEmployeeId.HasValue || newDate.HasValue)
                                            {
                                                newTimeScheduleEmployeePeriod = CreateTimeScheduleEmployeePeriodIfNotExist(entities, actorCompanyId, newDate ?? scheduleBlocksByDate.Key, newEmployeeId ?? scheduleBlocksByDate.First().EmployeeId.Value);
                                                if (newTimeScheduleEmployeePeriod == null)
                                                    continue;
                                            }

                                            List<TimeScheduleTemplateBlock> newBlocks = new List<TimeScheduleTemplateBlock>();

                                            #region Create a clone and update values

                                            foreach (var shiftToCopy in blocksToCopyCurrentEmployeeCurrentDate)
                                            {
                                                TimeScheduleTemplateBlock clone = shiftToCopy.Clone(base.FullName);
                                                clone.TimeScheduleScenarioHead = scenarioHead;
                                                clone.TimeScheduleTemplatePeriodId = null;
                                                clone.EmployeeScheduleId = null;

                                                // Replaced by another employee
                                                if (newEmployeeId.HasValue)
                                                    clone.EmployeeId = newEmployeeId.Value;

                                                // Moved to another date
                                                if (newDate.HasValue)
                                                    clone.Date = newDate.Value;

                                                //Set new TimeScheduleEmployeePeriod
                                                if (newEmployeeId.HasValue || newDate.HasValue)
                                                    clone.TimeScheduleEmployeePeriod = newTimeScheduleEmployeePeriod;

                                                SetCreatedProperties(clone);
                                                entities.TimeScheduleTemplateBlock.AddObject(clone);
                                                newBlocks.Add(clone);
                                            }

                                            #endregion

                                            #region Set new Link

                                            if (newBlocks.Any())
                                            {
                                                foreach (var blockGroup in newBlocks.Where(b => b.Link.HasValue()).GroupBy(g => g.Link))
                                                {
                                                    if (!string.IsNullOrEmpty(blockGroup.Key))
                                                    {
                                                        string link = Guid.NewGuid().ToString();
                                                        blockGroup.ToList().ForEach(f => f.Link = link);
                                                    }
                                                }
                                            }

                                            #endregion
                                        }
                                    }
                                }

                                break;
                            }
                        case TermGroup_TimeScheduleScenarioHeadSourceType.Template:
                            {
                                List<TimeSchedulePlanningDayDTO> planningDays = GetTimeSchedulePlanningDaysFromTemplate(actorCompanyId, 0, UserId, scenarioHeadInput.SourceDateFrom.Value, scenarioHeadInput.SourceDateTo.Value, null, inputEmployeeIds, loadAccounts: true);
                                if (planningDays.Any())
                                {
                                    List<int> timeScheduleTemplateBlockIds = planningDays.Select(s => s.TimeScheduleTemplateBlockId).Distinct().ToList();
                                    timeScheduleTemplateBlockIds.AddRange(planningDays.Where(w => w.Break1Id != 0).Select(s => s.Break1Id).Distinct().ToList());
                                    timeScheduleTemplateBlockIds.AddRange(planningDays.Where(w => w.Break2Id != 0).Select(s => s.Break2Id).Distinct().ToList());
                                    timeScheduleTemplateBlockIds.AddRange(planningDays.Where(w => w.Break3Id != 0).Select(s => s.Break3Id).Distinct().ToList());
                                    timeScheduleTemplateBlockIds.AddRange(planningDays.Where(w => w.Break4Id != 0).Select(s => s.Break4Id).Distinct().ToList());
                                    timeScheduleTemplateBlockIds = timeScheduleTemplateBlockIds.Where(w => w != 0).Distinct().ToList();
                                    var blocks = entities.TimeScheduleTemplateBlock.Include("AccountInternal").Where(w => timeScheduleTemplateBlockIds.Contains(w.TimeScheduleTemplateBlockId)).ToList();

                                    if (blocks.Any())
                                    {
                                        List<TimeScheduleTemplateBlock> newBlocks = new List<TimeScheduleTemplateBlock>();
                                        blocks.ForEach(f => newBlocks.Add(f.Clone(base.FullName)));
                                        newBlocks = newBlocks.Where(w => w.EmployeeId.HasValue).ToList();

                                        foreach (var block in newBlocks)
                                        {
                                            var match = planningDays.FirstOrDefault(t => t.TimeScheduleTemplateBlockId == block.OldTimeScheduleTemplateBlockId ||
                                                t.Break1Id == block.OldTimeScheduleTemplateBlockId ||
                                                t.Break2Id == block.OldTimeScheduleTemplateBlockId ||
                                                t.Break3Id == block.OldTimeScheduleTemplateBlockId ||
                                                t.Break4Id == block.OldTimeScheduleTemplateBlockId);

                                            if (match != null)
                                                block.Date = match.ActualDate;
                                            else
                                                continue;
                                        }

                                        newBlocks.ForEach(f => f.TimeScheduleTemplatePeriodId = null);
                                        newBlocks.ForEach(f => f.TimeScheduleScenarioHead = scenarioHead);
                                        newBlocks.ForEach(f => f.EmployeeScheduleId = null);
                                        newBlocks.ForEach(f => entities.TimeScheduleTemplateBlock.AddObject(f));

                                        foreach (var block in newBlocks.Where(b => b.Link.HasValue()).GroupBy(g => g.Link))
                                        {
                                            if (!string.IsNullOrEmpty(block.Key))
                                            {
                                                string link = Guid.NewGuid().ToString();
                                                block.ToList().ForEach(f => f.Link = link);
                                            }
                                        }

                                        var timeScheduleTemplatePeriods = new List<TimeScheduleTemplatePeriod>();

                                        foreach (var blocksOnDay in newBlocks.GroupBy(g => $" {g.EmployeeId}#{g.Date}"))
                                        {
                                            var first = blocksOnDay.FirstOrDefault();
                                            if (first != null)
                                            {
                                                TimeScheduleEmployeePeriod existingTimeScheduleEmployeePeriod = GetTimeScheduleEmployeePeriod(entities, actorCompanyId, first.EmployeeId.Value, first.Date.Value);

                                                if (existingTimeScheduleEmployeePeriod == null)
                                                {
                                                    existingTimeScheduleEmployeePeriod = new TimeScheduleEmployeePeriod() { EmployeeId = first.EmployeeId.Value, ActorCompanyId = actorCompanyId, Date = first.Date.Value };
                                                    SetCreatedProperties(existingTimeScheduleEmployeePeriod);
                                                    entities.TimeScheduleEmployeePeriod.AddObject(existingTimeScheduleEmployeePeriod);
                                                }
                                                foreach (var block in blocksOnDay)
                                                    block.TimeScheduleEmployeePeriod = existingTimeScheduleEmployeePeriod;
                                            }
                                        }
                                    }
                                }
                                break;
                            }
                    }
                }

                #endregion

                ActionResult result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = scenarioHead.TimeScheduleScenarioHeadId;

                return result;
            }
        }

        public ActionResult DeleteTimeScheduleScenarioHead(int timeScheduleScenarioHeadId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeScheduleScenarioHead head = (from t in entities.TimeScheduleScenarioHead.Include("TimeScheduleEmployeePeriod").Include("TimeScheduleTemplateBlock")
                                                 where t.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId &&
                                                 t.ActorCompanyId == actorCompanyId &&
                                                 t.State == (int)SoeEntityState.Active
                                                 select t).FirstOrDefault();
                if (head == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeScheduleScenarioHead");

                foreach (TimeScheduleEmployeePeriod period in head.TimeScheduleEmployeePeriod)
                {
                    ChangeEntityState(entities, period, SoeEntityState.Deleted, false);
                }

                foreach (TimeScheduleTemplateBlock block in head.TimeScheduleTemplateBlock)
                {
                    ChangeEntityState(entities, block, SoeEntityState.Deleted, false);
                }

                return ChangeEntityState(entities, head, SoeEntityState.Deleted, true);
            }
        }

        public List<PreviewActivateScenarioDTO> PreviewActivateScenario(int timeScheduleScenarioHeadId, int actorCompanyId, int roleId, int userId, DateTime? preliminaryDateFrom)
        {
            List<PreviewActivateScenarioDTO> dtos = new List<PreviewActivateScenarioDTO>();

            #region Prereq

            // Get scenario head
            TimeScheduleScenarioHead head = GetTimeScheduleScenarioHead(timeScheduleScenarioHeadId, actorCompanyId, true);
            if (head == null)
                return dtos;

            List<int> employeeIds = head.TimeScheduleScenarioEmployee.Select(e => e.EmployeeId).ToList();
            List<TimeSchedulePlanningDayDTO> allShifts = new List<TimeSchedulePlanningDayDTO>();

            // Get schedule shifts
            allShifts.AddRange(GetTimeSchedulePlanningShifts_ByProcedure(actorCompanyId, userId, 0, roleId, head.DateFrom, head.DateTo, employeeIds, TimeSchedulePlanningMode.SchedulePlanning, TimeSchedulePlanningDisplayMode.Admin, false, true, false, includePreliminary: true, includeAbsenceRequest: false, checkToIncludeDeliveryAdress: false, includeOnDuty: true));

            // Add scenario shifts
            allShifts.AddRange(GetTimeSchedulePlanningShifts_ByProcedure(actorCompanyId, userId, 0, roleId, head.DateFrom, head.DateTo, employeeIds, TimeSchedulePlanningMode.SchedulePlanning, TimeSchedulePlanningDisplayMode.Admin, false, true, false, includePreliminary: true, includeAbsenceRequest: false, checkToIncludeDeliveryAdress: false, timeScheduleScenarioHeadId: timeScheduleScenarioHeadId, includeOnDuty: true));

            if (allShifts.IsNullOrEmpty())
                return dtos;

            List<TimeCodeBreak> timeCodeBreaks = TimeCodeManager.GetTimeCodeBreaks(actorCompanyId);

            #endregion

            #region Work rules

            TimeEngineManager tem = new TimeEngineManager(this.parameterObject, actorCompanyId, base.UserId);
            EvaluateWorkRulesActionResult workRulesResult = tem.EvaluateActivateScenarioAgainstWorkRules(head.TimeScheduleScenarioHeadId, null, preliminaryDateFrom);
            List<GenericType> workRuleTerms = base.GetTermGroupContent(TermGroup.SoeScheduleWorkRules);
            List<GenericType> statusTerms = base.GetTermGroupContent(TermGroup.TimeScheduleScenarioEmployeeStatus);

            #endregion

            foreach (var groupByEmployeeAndDate in allShifts.GroupBy(g => $"{g.EmployeeId}#{g.ActualDate}"))
            {
                List<TimeSchedulePlanningDayDTO> scheduleShifts = groupByEmployeeAndDate.Select(s => s).Where(s => !s.TimeScheduleScenarioHeadId.HasValue).ToList();
                List<TimeSchedulePlanningDayDTO> scenarioShifts = groupByEmployeeAndDate.Select(s => s).Where(s => s.TimeScheduleScenarioHeadId.HasValue).ToList();

                int employeeId = groupByEmployeeAndDate.First().EmployeeId;
                DateTime date = groupByEmployeeAndDate.First().ActualDate;
                TimeScheduleScenarioEmployee scenarioEmployee = head.TimeScheduleScenarioEmployee.FirstOrDefault(x => x.EmployeeId == employeeId);
                if (scenarioEmployee == null)
                    continue;

                GenericType statusTerm = statusTerms.FirstOrDefault(x => x.Id == scenarioEmployee.Status);

                if (preliminaryDateFrom.HasValue && preliminaryDateFrom.Value <= date)
                    scenarioShifts.ForEach(s => s.IsPreliminary = true);

                List<EvaluateWorkRuleResultDTO> failedRuleResults = workRulesResult?.EvaluatedRuleResults.Where(i => i.EmployeeId.HasValue && i.Date.HasValue && i.EmployeeId == employeeId && i.Date == date && !i.Success).ToList() ?? new List<EvaluateWorkRuleResultDTO>();

                if (failedRuleResults.IsNullOrEmpty())
                {
                    PreviewActivateScenarioDTO dto = new PreviewActivateScenarioDTO()
                    {
                        EmployeeId = employeeId,
                        Name = groupByEmployeeAndDate.First().EmployeeInfo,
                        Date = date,
                        ShiftTextSchedule = CreateStringFromShifts(scheduleShifts, timeCodeBreaks, true),
                        ShiftTextScenario = CreateStringFromShifts(scenarioShifts, timeCodeBreaks, true),
                    };

                    dto.StatusName = statusTerm?.Name;
                    dto.StatusMessage = scenarioEmployee.Message;

                    dtos.Add(dto);
                }
                else
                {
                    foreach (var ruleResultsByRule in failedRuleResults.GroupBy(x => x.EvaluatedWorkRule))
                    {
                        foreach (var ruleResult in ruleResultsByRule)
                        {
                            PreviewActivateScenarioDTO dto = new PreviewActivateScenarioDTO()
                            {
                                EmployeeId = employeeId,
                                Name = groupByEmployeeAndDate.First().EmployeeInfo,
                                Date = date,
                                ShiftTextSchedule = CreateStringFromShifts(scheduleShifts, timeCodeBreaks, true),
                                ShiftTextScenario = CreateStringFromShifts(scenarioShifts, timeCodeBreaks, true),
                                WorkRule = ruleResultsByRule.Key,
                                WorkRuleName = workRuleTerms.FirstOrDefault(x => x.Id == (int)ruleResultsByRule.Key)?.Name,
                                WorkRuleText = ruleResult.ErrorMessage,
                                WorkRuleCanOverride = ruleResult.CanUserOverrideRuleViolation,
                                StatusName = statusTerm?.Name,
                                StatusMessage = scenarioEmployee.Message,
                            };
                            dtos.Add(dto);
                        }
                    }
                }
            }

            return dtos.OrderBy(d => d.Name).ThenBy(d => d.Date).ToList();
        }

        public List<PreviewActivateScenarioDTO> GetActivateScenarioEmployeeStatus(int timeScheduleScenarioHeadId, int actorCompanyId)
        {
            List<PreviewActivateScenarioDTO> dtos = new List<PreviewActivateScenarioDTO>();

            // Get scenario head
            TimeScheduleScenarioHead head = GetTimeScheduleScenarioHead(timeScheduleScenarioHeadId, actorCompanyId, true);
            if (head == null)
                return dtos;

            List<GenericType> statusTerms = base.GetTermGroupContent(TermGroup.TimeScheduleScenarioEmployeeStatus);

            foreach (var scenarioEmployee in head.TimeScheduleScenarioEmployee)
            {
                GenericType statusTerm = statusTerms.FirstOrDefault(x => x.Id == scenarioEmployee.Status);
                PreviewActivateScenarioDTO dto = new PreviewActivateScenarioDTO()
                {
                    EmployeeId = scenarioEmployee.EmployeeId,
                    StatusName = statusTerm?.Name,
                    StatusMessage = scenarioEmployee.Message,
                };
                dtos.Add(dto);
            }

            return dtos;
        }

        public List<PreviewCreateTemplateFromScenarioDTO> PreviewCreateTemplateFromScenario(int timeScheduleScenarioHeadId, int actorCompanyId, int roleId, int userId, DateTime dateFrom, int weekInCycle, DateTime? dateTo)
        {
            List<PreviewCreateTemplateFromScenarioDTO> dtos = new List<PreviewCreateTemplateFromScenarioDTO>();
            #region Prereq

            // Get scenario head
            TimeScheduleScenarioHead head = GetTimeScheduleScenarioHead(timeScheduleScenarioHeadId, actorCompanyId, true);
            if (head == null)
                return dtos;

            List<int> employeeIds = head.TimeScheduleScenarioEmployee.Select(e => e.EmployeeId).ToList();
            List<TimeSchedulePlanningDayDTO> allShifts = new List<TimeSchedulePlanningDayDTO>();
            int numberOfDays = Convert.ToInt32((head.DateTo - head.DateFrom).TotalDays);
            DateTime startDate = weekInCycle == 1 ? dateFrom : head.DateFrom.AddDays(7 * (weekInCycle - 1));

            // Add scenario shifts
            allShifts.AddRange(GetTimeSchedulePlanningShifts_ByProcedure(actorCompanyId, userId, 0, roleId, head.DateFrom, head.DateTo, employeeIds, TimeSchedulePlanningMode.SchedulePlanning, TimeSchedulePlanningDisplayMode.Admin, false, true, false, includePreliminary: true, includeAbsenceRequest: false, checkToIncludeDeliveryAdress: false, timeScheduleScenarioHeadId: timeScheduleScenarioHeadId));

            if (allShifts.IsNullOrEmpty())
                return dtos;

            List<TimeCodeBreak> timeCodeBreaks = TimeCodeManager.GetTimeCodeBreaks(actorCompanyId);

            int numberOfMovedDays = head.DateFrom == dateFrom ? 0 : Convert.ToInt32((dateFrom - head.DateFrom).TotalDays);
            if (weekInCycle != 1)
            {
                allShifts.Where(w => w.StartTime < startDate && w.Break1Minutes > 0).ToList().ForEach(f => f.Break1StartTime = f.Break1StartTime.AddDays(numberOfDays));
                allShifts.Where(w => w.StartTime < startDate && w.Break2Minutes > 0).ToList().ForEach(f => f.Break2StartTime = f.Break2StartTime.AddDays(numberOfDays));
                allShifts.Where(w => w.StartTime < startDate && w.Break3Minutes > 0).ToList().ForEach(f => f.Break3StartTime = f.Break3StartTime.AddDays(numberOfDays));
                allShifts.Where(w => w.StartTime < startDate && w.Break4Minutes > 0).ToList().ForEach(f => f.Break4StartTime = f.Break4StartTime.AddDays(numberOfDays));
                allShifts.Where(w => w.StartTime < startDate).ToList().ForEach(f => { f.StartTime = f.StartTime.AddDays(numberOfDays); f.StopTime = f.StopTime.AddDays(numberOfDays); });
                numberOfMovedDays = startDate == dateFrom || Convert.ToInt32((dateFrom - startDate).TotalDays) <= 0 ? 0 : Convert.ToInt32((dateFrom - startDate).TotalDays);
            }

            if (numberOfMovedDays != 0 || weekInCycle != 1)
            {
                allShifts.ForEach(f => f.StartTime = f.StartTime.AddDays(numberOfMovedDays));
                allShifts.ForEach(f => f.StopTime = f.StopTime.AddDays(numberOfMovedDays));
                allShifts.Where(w => w.Break1Minutes > 0).ToList().ForEach(f => f.Break1StartTime = f.Break1StartTime.AddDays(numberOfMovedDays));
                allShifts.Where(w => w.Break2Minutes > 0).ToList().ForEach(f => f.Break2StartTime = f.Break2StartTime.AddDays(numberOfMovedDays));
                allShifts.Where(w => w.Break3Minutes > 0).ToList().ForEach(f => f.Break3StartTime = f.Break3StartTime.AddDays(numberOfMovedDays));
                allShifts.Where(w => w.Break4Minutes > 0).ToList().ForEach(f => f.Break4StartTime = f.Break4StartTime.AddDays(numberOfMovedDays));

            }

            #endregion

            #region Work rules

            TimeEngineManager tem = new TimeEngineManager(this.parameterObject, actorCompanyId, base.UserId);
            var workRulesResult = tem.EvaluateScenarioToTemplateAgainstWorkRules(timeScheduleScenarioHeadId, null, allShifts, numberOfMovedDays);
            List<GenericType> workRuleTerms = base.GetTermGroupContent(TermGroup.SoeScheduleWorkRules);

            #endregion

            // Remove hidden employee from result
            // TODO: Should be done in original query, but since that is now using PreviewActivateScenario we do it afterwards
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            int hiddenEmployeeId = GetHiddenEmployeeIdFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId));
            dtos = dtos.Where(d => d.EmployeeId != hiddenEmployeeId).ToList();

            Dictionary<int, Tuple<DateTime?, DateTime?>> templateDates = new Dictionary<int, Tuple<DateTime?, DateTime?>>();
            List<PreviewCreateTemplateFromScenarioDTO> result = new List<PreviewCreateTemplateFromScenarioDTO>();

            foreach (var groupByEmployee in allShifts.GroupBy(g => g.EmployeeId))
            {
                DateTime? templateDateFrom = null;
                DateTime? templateDateTo = null;
                List<TimeScheduleTemplateHead> heads = GetTimeScheduleTemplateHeadsForEmployee(entitiesReadOnly, actorCompanyId, groupByEmployee.Key, dateFrom, dateTo, true, includePublicTemplates: true);

                if (heads.Any())
                {
                    templateDateFrom = heads.First().StartDate;
                    templateDateTo = heads.First().StopDate;
                }

                if (templateDateFrom == dateFrom)
                {

                    PreviewCreateTemplateFromScenarioDTO tDto = new PreviewCreateTemplateFromScenarioDTO
                    {
                        EmployeeId = groupByEmployee.Key,
                        Name = groupByEmployee.First().EmployeeInfo,
                        Date = dateFrom,
                        TemplateDateFrom = templateDateFrom,
                        TemplateDateTo = templateDateTo,
                        ShiftTextScenario = "...",
                        WorkRuleName = GetText(4441, "Grundschema"),
                        WorkRuleText = GetText(3396, "Den anställde har redan ett grundschema med samma starttdatum"),
                        WorkRuleCanOverride = false
                    };

                    dtos.Add(tDto);
                }
                else
                {
                    foreach (var groupByEmployeeAndDate in groupByEmployee.GroupBy(g => $"{g.EmployeeId}#{g.ActualDate}"))
                    {
                        List<TimeSchedulePlanningDayDTO> scenarioShifts = groupByEmployeeAndDate.Select(s => s).Where(s => s.TimeScheduleScenarioHeadId.HasValue).ToList();

                        int employeeId = groupByEmployeeAndDate.First().EmployeeId;
                        DateTime date = groupByEmployeeAndDate.First().ActualDate;

                        List<EvaluateWorkRuleResultDTO> failedRuleResults = workRulesResult.EvaluatedRuleResults.Where(i => i.EmployeeId.HasValue && i.Date.HasValue && i.EmployeeId == employeeId && i.Date == date && !i.Success).ToList() ?? new List<EvaluateWorkRuleResultDTO>();

                        if (!failedRuleResults.IsNullOrEmpty())
                        {
                            foreach (var ruleResultsByRule in failedRuleResults.GroupBy(x => x.EvaluatedWorkRule))
                            {
                                foreach (var ruleResult in ruleResultsByRule)
                                {
                                    GenericType term = workRuleTerms.FirstOrDefault(x => x.Id == (int)ruleResultsByRule.Key);
                                    PreviewCreateTemplateFromScenarioDTO tDto = new PreviewCreateTemplateFromScenarioDTO
                                    {
                                        EmployeeId = employeeId,
                                        Name = groupByEmployeeAndDate.First().EmployeeInfo,
                                        Date = date,
                                        TemplateDateFrom = templateDateFrom,
                                        TemplateDateTo = templateDateTo,
                                        ShiftTextScenario = CreateStringFromShifts(scenarioShifts, timeCodeBreaks, true),
                                        WorkRuleName = term?.Name,
                                        WorkRuleText = ruleResult.ErrorMessage,
                                        WorkRuleCanOverride = ruleResult.CanUserOverrideRuleViolation
                                    };

                                    dtos.Add(tDto);
                                }
                            }
                        }
                        else
                        {
                            PreviewCreateTemplateFromScenarioDTO tDto = new PreviewCreateTemplateFromScenarioDTO
                            {
                                EmployeeId = employeeId,
                                Name = groupByEmployeeAndDate.First().EmployeeInfo,
                                Date = date,
                                TemplateDateFrom = templateDateFrom,
                                TemplateDateTo = templateDateTo,
                            };

                            dtos.Add(tDto);
                        }
                    }
                }
            }

            return dtos;
        }

        #endregion

        #region TimeScheduleSwap

        private List<TimeScheduleTemplateBlock> GetTemplateScheduleBlocks(CompEntities entities, int? timeScheduleScenarioHeadId, int employeeId, DateTime dateFrom, DateTime dateTo, bool loadStaffingIfUsed = true, bool includeStandBy = false, bool loadShiftType = false, bool loadScheduleType = false, bool loadDeviationCause = false, bool includeOnDuty = false)
        {

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            IQueryable<TimeScheduleTemplateBlock> query = entities.TimeScheduleTemplateBlock;
            if (loadStaffingIfUsed)
                query = query.Include("TimeScheduleEmployeePeriod");
            if (loadShiftType)
                query = query.Include("ShiftType");
            if (loadScheduleType)
                query = query.Include("TimeScheduleType");
            if (loadDeviationCause)
                query = query.Include("TimeDeviationCause");

            List<TimeScheduleTemplateBlock> templateBlocks = null;

            templateBlocks = (from tb in query
                              where (tb.Date.HasValue && tb.Date.Value >= dateFrom && tb.Date.Value <= dateTo) &&
                              (tb.EmployeeId.HasValue && tb.EmployeeId.Value == employeeId) &&
                              tb.State == (int)SoeEntityState.Active
                              select tb).ToList();


            templateBlocks = templateBlocks.FilterScenario(timeScheduleScenarioHeadId);
            templateBlocks = templateBlocks.FilterScheduleType(includeStandBy, includeOnDuty);
            return templateBlocks;
        }

        public TimeScheduleSwapApproveViewDTO GetScheduleSwapApproveView(int actorCompanyId, int timeScheduleSwapRequestId, int userId, int employeeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleSwapRequest.NoTracking();
            TimeScheduleSwapRequest requests = (from t in entities.TimeScheduleSwapRequest.Include("TimeScheduleSwapRequestRow")
                                                where t.ActorCompanyId == actorCompanyId &&
                                                  t.TimeScheduleSwapRequestId == timeScheduleSwapRequestId &&
                                                  t.Status == (int)TermGroup_TimeScheduleSwapRequestStatus.Initiated &&
                                                  t.State == (int)SoeEntityState.Active
                                                select t).FirstOrDefault();

            if (requests == null)
                return null;

            List<TimeScheduleSwapRequestRow> timeScheduleSwapRequestRowActive = requests.TimeScheduleSwapRequestRow.Where(w => w.State == (int)SoeEntityState.Active).ToList();

            if (timeScheduleSwapRequestRowActive.IsNullOrEmpty())
                return null;

            DateTime firstDate = timeScheduleSwapRequestRowActive.Min(w => w.Date).Date;
            DateTime lastDate = timeScheduleSwapRequestRowActive.Max(w => w.Date).Date;
            int initiatorEmployeeId = requests.InitiatorEmployeeId ?? timeScheduleSwapRequestRowActive.FirstOrDefault()?.EmployeeId ?? 0;
            bool skillsMatch = true;
            bool admin = false;
            Employee initiatorEmployee = EmployeeManager.GetEmployee(initiatorEmployeeId, actorCompanyId, loadContactPerson: true, loadUser: true);
            if (!timeScheduleSwapRequestRowActive.Any(w => w.EmployeeId != initiatorEmployee.EmployeeId))
                return null;

            Employee swapWithEmployee = initiatorEmployee != null ? EmployeeManager.GetEmployee(timeScheduleSwapRequestRowActive.FirstOrDefault(w => w.EmployeeId != initiatorEmployee.EmployeeId)?.EmployeeId ?? 0, actorCompanyId, loadContactPerson: true, loadUser: true) : null;
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<UserDTO> initiatorExecutives = UserManager.GetEmployeeNearestExecutives(entitiesReadOnly, initiatorEmployee, firstDate, lastDate, actorCompanyId);
            List<UserDTO> swapWithExecutives = UserManager.GetEmployeeNearestExecutives(entitiesReadOnly, swapWithEmployee, firstDate, lastDate, actorCompanyId);

            if (initiatorExecutives.Any(w => w.UserId == userId) || swapWithExecutives.Any(w => w.UserId == userId))
                admin = true;
            bool validateShifts = admin;

            StringBuilder sbI = new StringBuilder();
            StringBuilder sbS = new StringBuilder();
            StringBuilder sbICurrent = new StringBuilder();
            StringBuilder sbSCurrent = new StringBuilder();
            TimeScheduleSwapApproveViewDTO result = new TimeScheduleSwapApproveViewDTO()
            {
                InitiatorEmployeeId = initiatorEmployee.EmployeeId,
                InitiatorEmployeeName = initiatorEmployee.Name,
                InitiatorEmployeeNumber = initiatorEmployee.EmployeeNr,
                SwapWithEmployeeId = swapWithEmployee.EmployeeId,
                SwapWithEmployeeName = swapWithEmployee.Name,
                SwapWithEmployeeNumber = swapWithEmployee.EmployeeNr,
                ValidSkills = true,
                ValidSkillsMessage = "",
                InitiatorUserId = requests.InitiatorUserId,
                Comment = requests.Comment,
                Status = (TermGroup_TimeScheduleSwapRequestStatus)requests.Status,
                State = (SoeEntityState)requests.State,
                Admin = admin
            };

            DateTime? inititatorEmployeeDate = timeScheduleSwapRequestRowActive.FirstOrDefault(w => w.EmployeeId == initiatorEmployee.EmployeeId)?.Date;
            DateTime? swapWithEmployeeDate = timeScheduleSwapRequestRowActive.FirstOrDefault(w => w.EmployeeId == swapWithEmployee.EmployeeId)?.Date;
            List<TimeSchedulePlanningDayDTO> currentInitiatorShiftsForDay = inititatorEmployeeDate.HasValue ? GetTemplateScheduleBlocks(entitiesReadOnly, null, initiatorEmployee.EmployeeId, inititatorEmployeeDate.Value, inititatorEmployeeDate.Value, includeStandBy: true, loadShiftType: true, loadScheduleType: true, loadDeviationCause: true).ToTimeSchedulePlanningDayDTOs(initiatorEmployee.Hidden) : new List<TimeSchedulePlanningDayDTO>();

            List<TimeSchedulePlanningDayDTO> curentSwapWithShiftsForDay = swapWithEmployeeDate.HasValue ? GetTemplateScheduleBlocks(entitiesReadOnly, null, swapWithEmployee.EmployeeId, swapWithEmployeeDate.Value, swapWithEmployeeDate.Value, includeStandBy: true, loadShiftType: true, loadScheduleType: true, loadDeviationCause: true).ToTimeSchedulePlanningDayDTOs(initiatorEmployee.Hidden) : new List<TimeSchedulePlanningDayDTO>();
            List<TimeSchedulePlanningDayDTO> currentInitiatorShifts = new List<TimeSchedulePlanningDayDTO>();
            List<TimeSchedulePlanningDayDTO> currentSwapWithShifts = new List<TimeSchedulePlanningDayDTO>();

            foreach (TimeScheduleSwapRequestRow row in timeScheduleSwapRequestRowActive)
            {
                TimeScheduleSwapRequestRowDTO newRow = new TimeScheduleSwapRequestRowDTO()
                {
                    TimeScheduleSwapRequestRowId = row.TimeScheduleSwapRequestRowId,
                    TimeScheduleSwapRequestId = row.TimeScheduleSwapRequestId,
                    EmployeeId = row.EmployeeId,
                    Date = row.Date,
                    ShiftsInfo = row.ShiftsInfo,
                    ScheduleStart = row.ScheduleStart,
                    ScheduleStop = row.ScheduleStop,
                    Status = (TermGroup_TimeScheduleSwapRequestRowStatus)row.Status,
                    State = (SoeEntityState)row.State,
                    SkillsMatch = true
                };
                if (row.EmployeeId == initiatorEmployee.EmployeeId)
                {
                    sbI.Append(row.ShiftsInfo);
                    currentInitiatorShifts.AddRange(currentInitiatorShiftsForDay.Where(w => CalendarUtility.IsDatesOverlapping(w.StartTime, w.StopTime, row.ScheduleStart, row.ScheduleStop)).ToList());
                    result.InitiatorEmployeeRows.Add(newRow);
                }
                else
                {
                    sbS.Append(row.ShiftsInfo);
                    currentSwapWithShifts.AddRange(curentSwapWithShiftsForDay.Where(w => CalendarUtility.IsDatesOverlapping(w.StartTime, w.StopTime, row.ScheduleStart, row.ScheduleStop)).ToList());
                    result.SwapWithEmployeeRows.Add(newRow);
                }

            }

            TimeScheduleManager.SetSwapShiftInfo(currentInitiatorShifts);
            TimeScheduleManager.SetSwapShiftInfo(currentSwapWithShifts);
            foreach (TimeSchedulePlanningDayDTO row in currentInitiatorShifts)
            {
                sbICurrent.Append(row.SwapShiftInfo);
            }
            foreach (TimeSchedulePlanningDayDTO row in currentSwapWithShifts)
            {
                sbSCurrent.Append(row.SwapShiftInfo);
            }
            string swapShiftInfo = sbS.ToString();
            string initiatorShiftInfo = sbI.ToString();
            string swapCurrentShiftInfo = sbSCurrent.ToString();
            string initiatorCurrentShiftInfo = sbICurrent.ToString();

            if (swapCurrentShiftInfo == swapShiftInfo && initiatorShiftInfo == initiatorCurrentShiftInfo)
                result.ShiftsHasChanged = false;
            else
                result.ShiftsHasChanged = true;

            foreach (TimeSchedulePlanningDayDTO row in currentInitiatorShiftsForDay)
            {
                skillsMatch = true;
                if (row.SwapShiftInfo != null)
                {
                    if (validateShifts && row.ShiftTypeId != 0)
                    {
                        List<int> empIds = TimeScheduleManager.MatchEmployeesByShiftTypeSkills(row.ShiftTypeId, actorCompanyId);
                        skillsMatch = empIds.Contains(swapWithEmployee.EmployeeId);
                        if (!skillsMatch)
                        {
                            result.ValidSkills = false;
                            result.InitiatorEmployeeRows.Where(w => w.ShiftsInfo == row.SwapShiftInfo).ToList().ForEach(f => f.SkillsMatch = false);
                        }
                    }

                    TimeScheduleSwapRequestRowDTO newRow = new TimeScheduleSwapRequestRowDTO()
                    {
                        EmployeeId = row.EmployeeId,
                        Date = row.ActualDate,
                        ShiftsInfo = row.SwapShiftInfo,
                        ScheduleStart = row.StartTime,
                        ScheduleStop = row.StopTime,
                        SkillsMatch = skillsMatch
                    };
                    result.CurrentInitiatorEmployeeRows.Add(newRow);

                }
            }
            if (!skillsMatch)
            {
                result.ValidSkillsMessage += $"{result.SwapWithEmployeeName}: {GetText(8481, "Den anställde uppfyller inte kompetenskraven för ett eller flera pass.")}\n";
                skillsMatch = true;
            }
            foreach (TimeSchedulePlanningDayDTO row in currentSwapWithShifts)
            {
                skillsMatch = true;
                if (row.SwapShiftInfo != null)
                {
                    if (validateShifts && row.ShiftTypeId != 0)
                    {
                        List<int> empIds = TimeScheduleManager.MatchEmployeesByShiftTypeSkills(row.ShiftTypeId, actorCompanyId);
                        skillsMatch = empIds.Contains(initiatorEmployeeId);
                        if (!skillsMatch)
                        {
                            result.ValidSkills = false;
                            result.SwapWithEmployeeRows.Where(w => w.ShiftsInfo == row.SwapShiftInfo).ToList().ForEach(f => f.SkillsMatch = false);
                        }
                    }

                    TimeScheduleSwapRequestRowDTO newRow = new TimeScheduleSwapRequestRowDTO()
                    {
                        EmployeeId = row.EmployeeId,
                        Date = row.ActualDate,
                        ShiftsInfo = row.SwapShiftInfo,
                        ScheduleStart = row.StartTime,
                        ScheduleStop = row.StopTime,
                        SkillsMatch = skillsMatch
                    };
                    result.CurrentSwapWithEmployeeRows.Add(newRow);

                }
            }
            if (!skillsMatch)
            {
                string tempStr = $"{result.InitiatorEmployeeName}: {GetText(8481, "Den anställde uppfyller inte kompetenskraven för ett eller flera pass.")}\n";
                if (!result.ValidSkillsMessage.Contains(tempStr))
                    result.ValidSkillsMessage += tempStr;
            }

            return result;

        }

        public List<TimeScheduleSwapRequestDTO> GetEmployeeSwapRequestInititatedRows(int actorCompanyId, int employeeId, DateTime dateFrom, DateTime dateTo, bool onlyInitiated = true)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleSwapRequest.NoTracking();
            entitiesReadOnly.TimeScheduleSwapRequestRow.NoTracking();
            List<TimeScheduleSwapRequest> requests = (from e in entitiesReadOnly.TimeScheduleSwapRequest.Include("TimeScheduleSwapRequestRow")
                                                      where e.ActorCompanyId == actorCompanyId &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => x.EmployeeId == employeeId) &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => x.Date >= dateFrom && x.Date <= dateTo) &&
                                                      (!onlyInitiated || e.Status == (int)TermGroup_TimeScheduleSwapRequestStatus.Initiated) &&
                                                      e.State == (int)SoeEntityState.Active
                                                      select e).ToList();

            return requests.ToDTOs(true).ToList();
        }

        public List<TimeScheduleSwapRequestDTO> GetEmployeesSwapRequestApprovedRows(int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, bool onlyInitiated = true)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleSwapRequest.NoTracking();
            entitiesReadOnly.TimeScheduleSwapRequestRow.NoTracking();
            List<TimeScheduleSwapRequest> requests = (from e in entitiesReadOnly.TimeScheduleSwapRequest.Include("TimeScheduleSwapRequestRow")
                                                      where e.ActorCompanyId == actorCompanyId &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => employeeIds.Contains(x.EmployeeId)) &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => x.Date >= dateFrom && x.Date <= dateTo) &&
                                                      (!onlyInitiated || e.Status == (int)TermGroup_TimeScheduleSwapRequestStatus.Initiated) &&
                                                      e.State == (int)SoeEntityState.Active &&
                                                      e.TimeScheduleSwapRequestRow.All(x => x.Status == (int)TermGroup_TimeScheduleSwapRequestRowStatus.ApprovedByEmployee || x.Status == (int)TermGroup_TimeScheduleSwapRequestRowStatus.ApprovedByAdmin)
                                                      select e).ToList();

            return requests.ToDTOs(true).ToList();
        }

        public bool EmployeesSwapRequestExistsOnAnyShift(CompEntities entities, int actorCompanyId, List<int> employeeIds, List<TimeSchedulePlanningDayDTO> shifts)
        {
            bool requestExists = false;
            DateTime dateFrom = shifts.Min(w => w.ActualDate);
            DateTime dateTo = shifts.Max(w => w.ActualDate);

            List<TimeScheduleSwapRequest> requests = (from e in entities.TimeScheduleSwapRequest.Include("TimeScheduleSwapRequestRow")
                                                      where e.ActorCompanyId == actorCompanyId &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => employeeIds.Contains(x.EmployeeId)) &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => x.Date >= dateFrom && x.Date <= dateTo) &&
                                                      e.Status == (int)TermGroup_TimeScheduleSwapRequestStatus.Initiated &&
                                                      e.State == (int)SoeEntityState.Active
                                                      select e).ToList();

            List<TimeScheduleSwapRequestDTO> swapRequests = requests.ToDTOs(true).ToList();

            if (swapRequests.Count > 0)
            {
                foreach (TimeSchedulePlanningDayDTO shift in shifts)
                {
                    if (!requestExists)
                        requestExists = swapRequests.Any(w => w.IsShiftAffectedBySwap(shift));
                }
            }

            return requestExists;
        }

        public TimeScheduleSwapRequest GetTimeScheduleSwapRequestById(CompEntities entities, int actorCompanyId, int timeScheduleSwapRequestId, bool includeRows = false)
        {
            IQueryable<TimeScheduleSwapRequest> query = entities.TimeScheduleSwapRequest;

            if (includeRows)
                query = query.Include("TimeScheduleSwapRequestRow");

            return (from e in query
                    where e.ActorCompanyId == actorCompanyId &&
                    e.TimeScheduleSwapRequestId == timeScheduleSwapRequestId &&
                    e.State == (int)SoeEntityState.Active
                    select e).FirstOrDefault();
        }

        public TimeScheduleSwapRequestDTO GetEmployeeSwapRequestRowById(int actorCompanyId, int timeScheduleSwapRequestId, bool includeRows = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetEmployeeSwapRequestRowById(entities, actorCompanyId, timeScheduleSwapRequestId, includeRows);
        }

        public TimeScheduleSwapRequestDTO GetEmployeeSwapRequestRowById(CompEntities entities, int actorCompanyId, int timeScheduleSwapRequestId, bool includeRows = false)
        {
            TimeScheduleSwapRequest requests = GetTimeScheduleSwapRequestById(entities, actorCompanyId, timeScheduleSwapRequestId, includeRows);
            return requests.ToDTO(includeRows);
        }

        public bool GetEmployeeSwapRequestRowWithShifts(CompEntities entities, int actorCompanyId, int timeScheduleSwapRequestId, out List<TimeScheduleTemplateBlock> initiatorShifts, out List<TimeScheduleTemplateBlock> swapWithShifts)
        {
            TimeScheduleSwapRequestDTO rDTO = GetEmployeeSwapRequestRowById(entities, actorCompanyId, timeScheduleSwapRequestId, true);
            initiatorShifts = new List<TimeScheduleTemplateBlock>();
            swapWithShifts = new List<TimeScheduleTemplateBlock>();

            int? initiatorEmployeeId = rDTO.InitiatorEmployeeId;
            int? swapWithEmployeeId = rDTO.Rows.FirstOrDefault(w => w.EmployeeId != initiatorEmployeeId)?.EmployeeId;

            DateTime inititatorEmployeeDateFrom = rDTO.Rows.Where(w => w.EmployeeId == initiatorEmployeeId).Min(w => w.Date);
            DateTime inititatorEmployeeDateTo = rDTO.Rows.Where(w => w.EmployeeId == initiatorEmployeeId).Max(w => w.Date);
            DateTime swapWithEmployeeDateFrom = rDTO.Rows.Where(w => w.EmployeeId == swapWithEmployeeId).Min(w => w.Date);
            DateTime swapWithEmployeeDateTo = rDTO.Rows.Where(w => w.EmployeeId == swapWithEmployeeId).Max(w => w.Date);

            List<TimeScheduleTemplateBlock> currentInitiatorShiftsForDay = GetTemplateScheduleBlocks(entities, null, initiatorEmployeeId.Value, inititatorEmployeeDateFrom, inititatorEmployeeDateTo, includeStandBy: false, loadShiftType: true, loadScheduleType: true, loadDeviationCause: true);
            List<TimeScheduleTemplateBlock> curentSwapWithShiftsForDay = GetTemplateScheduleBlocks(entities, null, swapWithEmployeeId.Value, swapWithEmployeeDateFrom, swapWithEmployeeDateTo, includeStandBy: false, loadShiftType: true, loadScheduleType: true, loadDeviationCause: true);

            if (initiatorEmployeeId.IsNullOrEmpty() || swapWithEmployeeId.IsNullOrEmpty() || rDTO.Rows.IsNullOrEmpty())
                return false;

            foreach (TimeScheduleSwapRequestRowDTO row in rDTO.Rows)
            {
                if (row.EmployeeId == initiatorEmployeeId)
                    initiatorShifts.AddRange(currentInitiatorShiftsForDay.Where(w => CalendarUtility.IsDatesOverlapping(w.ActualStartTime.Value, w.ActualStopTime.Value, row.ScheduleStart, row.ScheduleStop)).ToList());

                else if (row.EmployeeId == swapWithEmployeeId)
                    swapWithShifts.AddRange(curentSwapWithShiftsForDay.Where(w => CalendarUtility.IsDatesOverlapping(w.ActualStartTime.Value, w.ActualStopTime.Value, row.ScheduleStart, row.ScheduleStop)).ToList());
            }


            return true;

        }

        public bool ValidateEmployeeSwapRequestRowAdmin(CompEntities entities, int actorCompanyId, int employeeId, int userId, DateTime date)
        {
            Employee employee = EmployeeManager.GetEmployee(entities, employeeId, actorCompanyId, loadContactPerson: true, loadUser: true);
            List<UserDTO> Executives = UserManager.GetEmployeeNearestExecutives(entities, employee, date, date, actorCompanyId);

            return Executives.Any(w => w.UserId == userId);
        }

        public TimeScheduleSwapLengthComparisonDTO GetScheduleSwapLengthComparisonInfo(CompEntities entities, int actorCompanyId, List<int> sourceScheduleBlockIds, List<int> targetScheduleBlockIds)
        {
            // Note: source is concidered "my" schedule blocks

            List<TimeScheduleTemplateBlock> allBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                                         where (sourceScheduleBlockIds.Contains(tb.TimeScheduleTemplateBlockId) || targetScheduleBlockIds.Contains(tb.TimeScheduleTemplateBlockId)) &&
                                                         tb.State == (int)SoeEntityState.Active
                                                         select tb).ToList();

            List<TimeScheduleTemplateBlock> myBlocks = allBlocks.Where(w => sourceScheduleBlockIds.Contains(w.TimeScheduleTemplateBlockId)).ToList();
            List<TimeScheduleTemplateBlock> otherBlocks = allBlocks.Where(w => targetScheduleBlockIds.Contains(w.TimeScheduleTemplateBlockId)).ToList();

            if (myBlocks.IsNullOrEmpty() || otherBlocks.IsNullOrEmpty())
                return null;

            List<TimeScheduleTemplateBlock> myBreaks = TimeScheduleManager.GetTimeScheduleTemplateBlocksForDay(entities, myBlocks.First().EmployeeId.Value, myBlocks.First().Date.Value).Where(b => b.IsBreak).ToList();
            List<TimeScheduleTemplateBlock> otherBreaks = TimeScheduleManager.GetTimeScheduleTemplateBlocksForDay(entities, otherBlocks.First().EmployeeId.Value, otherBlocks.First().Date.Value).Where(b => b.IsBreak).ToList();

            int myTotalMinutes = myBlocks.Sum(s => CalendarUtility.GetLength(s.StartTime, s.StopTime));
            foreach (TimeScheduleTemplateBlock myBlock in myBlocks)
            {
                foreach (TimeScheduleTemplateBlock myBreak in myBreaks)
                {
                    myTotalMinutes -= CalendarUtility.GetOverlappingMinutes(myBlock.StartTime, myBlock.StopTime, myBreak.StartTime, myBreak.StopTime);
                }
            }

            int otherTotalMinutes = otherBlocks.Sum(s => CalendarUtility.GetLength(s.StartTime, s.StopTime));
            foreach (TimeScheduleTemplateBlock otherBlock in otherBlocks)
            {
                foreach (TimeScheduleTemplateBlock otherBreak in otherBreaks)
                {
                    otherTotalMinutes -= CalendarUtility.GetOverlappingMinutes(otherBlock.StartTime, otherBlock.StopTime, otherBreak.StartTime, otherBreak.StopTime);
                }
            }

            return CreateScheduleSwapLengthComparisonInfo(entities, actorCompanyId, myBlocks.First().EmployeeId.Value, myBlocks.First().Date, myTotalMinutes, otherTotalMinutes);
        }

        public TimeScheduleSwapLengthComparisonDTO GetScheduleSwapLengthComparisonInfoFromRequest(CompEntities entities, int actorCompanyId, int timeScheduleSwapRequestId, int employeeId)
        {
            TimeScheduleSwapRequest swapRequest = GetTimeScheduleSwapRequestById(entities, actorCompanyId, timeScheduleSwapRequestId, true);
            if (swapRequest == null || swapRequest.TimeScheduleSwapRequestRow.IsNullOrEmpty())
                return null;

            List<TimeScheduleSwapRequestRow> mySwapRequestRows = swapRequest.TimeScheduleSwapRequestRow.Where(w => w.EmployeeId == employeeId).ToList();

            if (mySwapRequestRows.Count == 0)
                return null;

            int myShiftLength = mySwapRequestRows.Sum(s => s.ShiftLength);
            int otherShiftLength = swapRequest.TimeScheduleSwapRequestRow.Where(w => w.EmployeeId != employeeId).Sum(s => s.ShiftLength);

            return CreateScheduleSwapLengthComparisonInfo(entities, actorCompanyId, employeeId, mySwapRequestRows.First().Date, myShiftLength, otherShiftLength);
        }

        private TimeScheduleSwapLengthComparisonDTO CreateScheduleSwapLengthComparisonInfo(CompEntities entities, int actorCompanyId, int employeeId, DateTime? date, int myShiftLength, int otherShiftLength)
        {
            if (date == null)
                return null;

            bool myIsLonger = myShiftLength > otherShiftLength;
            bool isEqual = myShiftLength == otherShiftLength;
            string messageShorter = string.Empty;
            string messageLonger = string.Empty;
            string titleShorter = GetText(110701, "Du byter nu till ett kortare pass");
            string titleLonger = GetText(110702, "Du byter nu till ett längre pass");
            ScheduleSwapLengthComparisonType typeShorter = ScheduleSwapLengthComparisonType.Shorter;
            ScheduleSwapLengthComparisonType typeLonger = ScheduleSwapLengthComparisonType.Longer;

            List<EmployeeGroup> employeeGroups = EmployeeManager.GetEmployeeGroups(actorCompanyId);
            Employee employee = EmployeeManager.GetEmployee(entities, employeeId, actorCompanyId, loadEmployment: true);
            if (employee != null)
            {
                messageShorter = GetText(12884, 1004, "Observera att du tar ett kortare pass på eget initiativ. Du riskerar därmed att hamna under din kontrakterade tid för perioden. Vill du fortsätta?");
                messageLonger = GetText(12885, 1004, "Observera att du tar ett längre pass på eget initiativ. Detta innebär att du kanske inte får mertidsersättning. Vill du fortsätta?");

                string employeeGroupMessageShorter = employee.GetEmployeeGroup(date.Value, employeeGroups)?.SwapShiftToShorterText ?? string.Empty;
                if (!string.IsNullOrEmpty(employeeGroupMessageShorter))
                    messageShorter = employeeGroupMessageShorter;

                string employeeGroupMessageLonger = employee.GetEmployeeGroup(date.Value, employeeGroups)?.SwapShiftToLongerText ?? string.Empty;
                if (!string.IsNullOrEmpty(employeeGroupMessageLonger))
                    messageLonger = employeeGroupMessageLonger;
            }

            if (isEqual)
            {
                messageShorter = string.Empty;
                titleShorter = string.Empty;
                typeShorter = ScheduleSwapLengthComparisonType.Equal;
            }

            return new TimeScheduleSwapLengthComparisonDTO
            {
                Title = myIsLonger ? titleShorter : titleLonger,
                Message = myIsLonger ? messageShorter : messageLonger,
                Type = myIsLonger ? typeShorter : typeLonger
            };
        }

        public List<TimeScheduleSwapRequestDTO> GetEmployeeSwapRequestsForPeriod(int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, TermGroup_TimeScheduleSwapRequestStatus? status = null)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleSwapRequest.NoTracking();
            entitiesReadOnly.TimeScheduleSwapRequestRow.NoTracking();
            List<TimeScheduleSwapRequest> requests = (from e in entitiesReadOnly.TimeScheduleSwapRequest.Include("TimeScheduleSwapRequestRow")
                                                      .Include("User")
                                                      where e.ActorCompanyId == actorCompanyId &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => employeeIds.Contains(x.EmployeeId)) &&
                                                      e.TimeScheduleSwapRequestRow.Any(x => x.Date >= dateFrom && x.Date <= dateTo) &&
                                                      (!status.HasValue || e.Status == (int)status.Value) &&
                                                      e.State == (int)SoeEntityState.Active
                                                      select e).ToList();
            return requests.ToDTOs(true).ToList();
        }

        #endregion

        #region TimeScheduleSwapRequestRow

        public List<TimeScheduleSwapRequestRow> GetTimeScheduleSwapRequestRows(CompEntities entities, int employeeId, DateTime dateFrom, DateTime dateTo)
        {
            return (from s in entities.TimeScheduleSwapRequestRow
                    where s.EmployeeId == employeeId &&
                    s.Date >= dateFrom &&
                    s.Date <= dateTo &&
                    s.State == (int)SoeEntityState.Active
                    select s).ToList();
        }

        public List<TimeScheduleSwapRequestRow> GetTimeScheduleSwapRequestRows(CompEntities entities, int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo)
        {
            if (!employeeIds.IsNullOrEmpty())
                return GetEmployeeDataInBatches(GetDataInBatchesModel.Create(entities, base.ActorCompanyId, employeeIds, dateFrom, dateTo), TimeScheduleManager.GetTimeScheduleSwapRequestRows);

            return (from s in entities.TimeScheduleSwapRequestRow
                    where s.TimeScheduleSwapRequest.ActorCompanyId == actorCompanyId &&
                    s.Date >= dateFrom &&
                    s.Date <= dateTo &&
                    s.State == (int)SoeEntityState.Active
                    select s).ToList();
        }

        public List<TimeScheduleSwapRequestRow> GetTimeScheduleSwapRequestRows(GetDataInBatchesModel model)
        {
            if (!model.IsValid(requireDates: true))
                return new List<TimeScheduleSwapRequestRow>();

            return (from s in model.Entities.TimeScheduleSwapRequestRow
                    where model.BatchIds.Contains(s.EmployeeId) &&
                    s.Date >= model.StartDate &&
                    s.Date <= model.StopDate &&
                    s.State == (int)SoeEntityState.Active
                    select s).ToList();
        }

        #endregion

        #region TimeScheduleTask

        public List<TimeScheduleTask> GetTimeScheduleTasks(int actorCompanyId, bool setTypeNames = false, bool setRecurringDescription = false, bool loadAccountHierarchyAccount = false, bool onlyActive = true, int? timeScheduleTaskId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTask.NoTracking();
            IQueryable<TimeScheduleTask> query = entitiesReadOnly.TimeScheduleTask;
            if (loadAccountHierarchyAccount)
                query = query.Include("Account");
            if (setTypeNames)
                query = query.Include("TimeScheduleTaskType").Include("ShiftType");

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            if (timeScheduleTaskId.HasValue)
                query = query.Where(t => t.TimeScheduleTaskId == timeScheduleTaskId.Value);

            List<TimeScheduleTask> timeScheduleTasks = (from t in query
                                                        where t.ActorCompanyId == actorCompanyId &&
                                                        (onlyActive ? t.State == (int)SoeEntityState.Active : t.State != (int)SoeEntityState.Deleted)
                                                        orderby t.Name
                                                        select t).ToList();

            if (setRecurringDescription)
            {
                List<SysHolidayTypeDTO> sysHolidays = CalendarManager.GetSysHolidayTypeDTOs();

                foreach (TimeScheduleTask timeScheduleTask in timeScheduleTasks)
                {
                    timeScheduleTask.RecurrencePatternDescription = GetRecurrenceDescription(timeScheduleTask.RecurrencePattern, sysHolidays);
                    timeScheduleTask.RecurrenceStartsOnDescription = GetRecurrenceStartsOnDescription(timeScheduleTask.StartDate);
                    timeScheduleTask.RecurrenceEndsOnDescription = GetRecurrenceEndsOnDescription(timeScheduleTask.StopDate, timeScheduleTask.NbrOfOccurrences);
                }
            }

            return timeScheduleTasks;
        }

        public Dictionary<int, string> GetTimeScheduleTasksForFrequency(int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, String.Empty);

            var tasks = GetTimeScheduleTasks(actorCompanyId).Where(w => w.IsStaffingNeedsFrequency);

            foreach (TimeScheduleTask task in tasks)
            {
                dict.Add(task.TimeScheduleTaskId, task.Name);
            }

            return dict;
        }

        public bool TimeScheduleTaskExists(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            IQueryable<TimeScheduleTask> query = (from t in entitiesReadOnly.TimeScheduleTask
                                                  where t.State == (int)SoeEntityState.Active &&
                                                  t.ActorCompanyId == ActorCompanyId
                                                  select t);

            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                query = query.Include("TimeScheduleTaskType").Include("ShiftType");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            return query.Any();
        }

        public List<TimeScheduleTask> GetTimeScheduleTasks(int actorCompanyId, DateTime dateFrom, DateTime dateTo, List<int> ids = null, bool loadType = false, bool loadShiftType = false, bool setRecurringDescription = false, bool doIncludeRemovedDates = false, bool loadAccounting = false, bool loadTimeScheduleTemplateBlockTask = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            dateFrom = dateFrom.Date;
            dateTo = dateTo.Date;

            entities.TimeScheduleTask.NoTracking();
            IQueryable<TimeScheduleTask> query = (from t in entities.TimeScheduleTask
                                                    .Include("TimeScheduleTaskExcludedDate")
                                                  where t.ActorCompanyId == actorCompanyId &&
                                                  t.StartDate <= dateTo &&
                                                  (!t.StopDate.HasValue || t.StopDate.Value >= dateFrom) &&
                                                  t.State == (int)SoeEntityState.Active
                                                  select t);

            if (loadType)
                query = query.Include("TimeScheduleTaskType");
            if (loadShiftType)
                query = query.Include("ShiftType");
            if (loadAccounting)
                query = query.Include("AccountInternal.Account.AccountDim");
            if (ids != null && ids.Count > 0)
                query = query.Where(t => ids.Contains(t.TimeScheduleTaskId));

            if (useAccountHierarchy)
            {
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, dateFrom, dateTo, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            List<TimeScheduleTask> timeScheduleTasks = query.ToList();
            List<SysHolidayTypeDTO> sysHolidays = null;
            if (setRecurringDescription)
                sysHolidays = CalendarManager.GetSysHolidayTypeDTOs();

            List<TimeScheduleTask> validTimeScheduleTasks = GetValidatedTimeScheduleTasks(actorCompanyId, timeScheduleTasks, dateFrom, dateTo, setRecurringDescription, doIncludeRemovedDates);
            if (loadTimeScheduleTemplateBlockTask)
                LoadAndConnectBlockTasksToTimeScheduleTasks(validTimeScheduleTasks, dateFrom, dateTo);

            return validTimeScheduleTasks;
        }

        public List<TimeScheduleTask> GetValidatedTimeScheduleTasks(int actorCompanyId, List<TimeScheduleTask> timeScheduleTasks, DateTime dateFrom, DateTime dateTo, bool setRecurringDescription = false, bool doIncludeRemovedDates = false)
        {
            List<SysHolidayTypeDTO> sysHolidays = null;
            if (setRecurringDescription)
                sysHolidays = CalendarManager.GetSysHolidayTypeDTOs();

            List<TimeScheduleTask> validTimeScheduleTasks = new List<TimeScheduleTask>();
            foreach (TimeScheduleTask timeScheduleTask in timeScheduleTasks)
            {
                bool isSysHolidayTypePattern = DailyRecurrencePatternDTO.IsSysHolidayTypePattern(timeScheduleTask.RecurrencePattern);
                timeScheduleTask.RecurringDates = DailyRecurrencePatternDTO.GetDatesFromPattern(timeScheduleTask.RecurrencePattern, timeScheduleTask.StartDate, dateFrom, CalendarUtility.GetEarliestDate(dateTo, timeScheduleTask.StopDate), timeScheduleTask.NbrOfOccurrences, timeScheduleTask.TimeScheduleTaskExcludedDate.Select(i => i.Date).ToList(), isSysHolidayTypePattern ? CalendarManager.GetHolidaysByCompany(actorCompanyId, dateFrom, dateTo) : null);
                if (setRecurringDescription)
                {
                    timeScheduleTask.RecurrencePatternDescription = GetRecurrenceDescription(timeScheduleTask.RecurrencePattern, sysHolidays);
                    timeScheduleTask.RecurrenceStartsOnDescription = GetRecurrenceStartsOnDescription(timeScheduleTask.StartDate);
                    timeScheduleTask.RecurrenceEndsOnDescription = GetRecurrenceEndsOnDescription(timeScheduleTask.StopDate, timeScheduleTask.NbrOfOccurrences);
                }

                // No recurrence, just add the tasks start date if inside interval
                if (timeScheduleTask.HasNoRecurrencePattern() && !timeScheduleTask.RecurringDates.HasRecurringDates(doIncludeRemovedDates) && timeScheduleTask.StartDate >= dateFrom && timeScheduleTask.StartDate <= dateTo)
                    timeScheduleTask.RecurringDates.AddRecurringDate(timeScheduleTask.StartDate);
                if (timeScheduleTask.RecurringDates.HasRecurringDates(doIncludeRemovedDates))
                    validTimeScheduleTasks.Add(timeScheduleTask);
            }

            return validTimeScheduleTasks;
        }

        private void LoadAndConnectBlockTasksToTimeScheduleTasks(List<TimeScheduleTask> timeScheduleTasks, DateTime dateFrom, DateTime dateTo)
        {
            List<int> timeScheduleTaskIds = timeScheduleTasks.Select(t => t.TimeScheduleTaskId).ToList();
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var blockTasks = GetTimeScheduleTemplateBlockTasks(entitiesReadOnly, timeScheduleTaskIds, dateFrom, dateTo);

            foreach (var timeScheduleTask in timeScheduleTasks)
            {
                timeScheduleTask.ConnectedTimeScheduleTemplateBlockTasks = blockTasks.Where(w => w.TimeScheduleTaskId == timeScheduleTask.TimeScheduleTaskId).ToList();
            }
        }

        private List<TimeScheduleTemplateBlockTask> GetTimeScheduleTemplateBlockTasks(CompEntities entities, List<int> timeScheduleTaskIds, DateTime dateFrom, DateTime dateTo)
        {
            return entities.TimeScheduleTemplateBlockTask.Include("TimeScheduleTemplateBlock").Where(w => w.TimeScheduleTemplateBlock.Date.HasValue && w.TimeScheduleTemplateBlock.Date.Value >= dateFrom && w.TimeScheduleTemplateBlock.Date.Value <= dateTo && w.State == (int)SoeEntityState.Active && w.TimeScheduleTaskId.HasValue && timeScheduleTaskIds.Contains(w.TimeScheduleTaskId.Value)).ToList();
        }

        public Dictionary<int, string> GetTimeScheduleTasksDict(int actorCompanyId, bool addEmptyRow)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            IQueryable<TimeScheduleTask> query = (from t in entitiesReadOnly.TimeScheduleTask
                                                  where t.ActorCompanyId == actorCompanyId &&
                                                  t.State == (int)SoeEntityState.Active
                                                  orderby t.Name
                                                  select t);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }

            entitiesReadOnly.TimeScheduleTask.NoTracking();
            List<TimeScheduleTask> tasks = query.ToList();

            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            foreach (TimeScheduleTask task in tasks)
            {
                dict.Add(task.TimeScheduleTaskId, task.Name);
            }

            return dict;
        }

        public TimeScheduleTask GetTimeScheduleTask(int timeScheduleTaskId, int actorCompanyId, bool loadAccounts = false, bool loadTimeScheduleTemplateBlockTasks = false, bool loadTimeScheduleTemplateBlocks = false, bool loadStaffingNeedsRowPeriod = false, bool loadExcludedDates = false, bool loadAccountHierarchyAccount = false, bool onlyActive = true)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTask.NoTracking();
            return GetTimeScheduleTask(entities, timeScheduleTaskId, actorCompanyId, loadAccounts, loadTimeScheduleTemplateBlockTasks, loadTimeScheduleTemplateBlocks, loadStaffingNeedsRowPeriod, loadExcludedDates, loadAccountHierarchyAccount, onlyActive);
        }

        public TimeScheduleTask GetTimeScheduleTask(CompEntities entities, int timeScheduleTaskId, int actorCompanyId, bool loadAccounts = false, bool loadTimeScheduleTemplateBlockTasks = false, bool loadTimeScheduleTemplateBlocks = false, bool loadStaffingNeedsRowPeriod = false, bool loadExcludedDates = false, bool loadAccountHierarchyAccount = false, bool onlyActive = true)
        {
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);

            IQueryable<TimeScheduleTask> query = (from tst in entities.TimeScheduleTask
                                                  where tst.ActorCompanyId == actorCompanyId &&
                                                 tst.TimeScheduleTaskId == timeScheduleTaskId &&
                                                 (onlyActive ? tst.State == (int)SoeEntityState.Active : tst.State != (int)SoeEntityState.Deleted)
                                                  select tst);
            if (loadAccountHierarchyAccount)
                query = query.Include("Account");
            if (loadAccounts)
                query = query.Include("AccountInternal.Account.AccountDim");
            if (loadTimeScheduleTemplateBlockTasks)
                query = query.Include("TimeScheduleTemplateBlockTask");
            if (loadStaffingNeedsRowPeriod)
                query = query.Include("StaffingNeedsRowPeriod.StaffingNeedsRow");
            if (loadExcludedDates)
                query = query.Include("TimeScheduleTaskExcludedDate");

            return query.FirstOrDefault();
        }

        public ActionResult SaveTimeScheduleTask(TimeScheduleTaskDTO timeScheduleTaskInput, int actorCompanyId)
        {
            if (timeScheduleTaskInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeScheduleTask");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                TimeScheduleTask timeScheduleTask = GetTimeScheduleTask(entities, timeScheduleTaskInput.TimeScheduleTaskId, actorCompanyId, loadExcludedDates: true, onlyActive: false);
                if (timeScheduleTask == null)
                {
                    timeScheduleTask = new TimeScheduleTask()
                    {
                        Company = company,
                    };
                    SetCreatedProperties(timeScheduleTask);
                    entities.TimeScheduleTask.AddObject(timeScheduleTask);
                }
                else
                {
                    SetModifiedProperties(timeScheduleTask);
                }

                timeScheduleTask.Name = timeScheduleTaskInput.Name;
                timeScheduleTask.Description = timeScheduleTaskInput.Description;
                timeScheduleTask.TimeScheduleTaskTypeId = timeScheduleTaskInput.TimeScheduleTaskTypeId;
                timeScheduleTask.ShiftType = timeScheduleTaskInput.ShiftTypeId.HasValue && timeScheduleTaskInput.ShiftTypeId.Value > 0 ? GetShiftType(entities, timeScheduleTaskInput.ShiftTypeId.Value) : null;
                timeScheduleTask.StartTime = timeScheduleTaskInput.StartTime.HasValue ? CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT, CalendarUtility.ClearSeconds(timeScheduleTaskInput.StartTime.Value)) : (DateTime?)null;
                timeScheduleTask.StopTime = timeScheduleTaskInput.StopTime.HasValue && timeScheduleTaskInput.StartTime.HasValue ? CalendarUtility.MergeDateAndTime(CalendarUtility.DATETIME_DEFAULT.AddDays((timeScheduleTaskInput.StopTime.Value.Date - timeScheduleTaskInput.StartTime.Value.Date).TotalDays), CalendarUtility.ClearSeconds(timeScheduleTaskInput.StopTime.Value)) : (DateTime?)null;
                timeScheduleTask.Length = timeScheduleTaskInput.Length > 0 ? timeScheduleTaskInput.Length : 0;
                timeScheduleTask.StartDate = timeScheduleTaskInput.StartDate > CalendarUtility.DATETIME_DEFAULT ? timeScheduleTaskInput.StartDate.Date : DateTime.Today;
                timeScheduleTask.StopDate = timeScheduleTaskInput.StopDate.HasValue && timeScheduleTaskInput.StopDate.Value > CalendarUtility.DATETIME_DEFAULT ? timeScheduleTaskInput.StopDate.Value.Date : (DateTime?)null;
                timeScheduleTask.NbrOfOccurrences = timeScheduleTaskInput.NbrOfOccurrences;
                timeScheduleTask.RecurrencePattern = timeScheduleTaskInput.RecurrencePattern;
                timeScheduleTask.OnlyOneEmployee = timeScheduleTaskInput.OnlyOneEmployee;
                timeScheduleTask.AllowOverlapping = timeScheduleTaskInput.AllowOverlapping;
                timeScheduleTask.MinSplitLength = timeScheduleTaskInput.MinSplitLength;
                timeScheduleTask.NbrOfPersons = timeScheduleTaskInput.NbrOfPersons;
                timeScheduleTask.IsStaffingNeedsFrequency = timeScheduleTaskInput.IsStaffingNeedsFrequency;
                timeScheduleTask.DontAssignBreakLeftovers = timeScheduleTaskInput.DontAssignBreakLeftovers;
                timeScheduleTask.AccountId = timeScheduleTaskInput.AccountId.HasValue && timeScheduleTaskInput.AccountId != 0 ? timeScheduleTaskInput.AccountId : (int?)null;
                timeScheduleTask.State = (int)timeScheduleTaskInput.State;

                if (String.IsNullOrEmpty(timeScheduleTask.RecurrencePattern))
                    timeScheduleTask.RecurrencePattern = new DailyRecurrencePatternDTO().ToString();

                if (timeScheduleTask.StartTime.HasValue)
                    timeScheduleTask.StartTime = CalendarUtility.ClearSeconds(timeScheduleTask.StartTime.Value);
                if (timeScheduleTask.StopTime.HasValue)
                    timeScheduleTask.StopTime = CalendarUtility.ClearSeconds(timeScheduleTask.StopTime.Value);

                // Excluded dates
                if (timeScheduleTask.TimeScheduleTaskExcludedDate != null)
                {
                    foreach (TimeScheduleTaskExcludedDate excludeDate in timeScheduleTask.TimeScheduleTaskExcludedDate.ToList())
                    {
                        entities.DeleteObject(excludeDate);
                    }
                    timeScheduleTask.TimeScheduleTaskExcludedDate.Clear();
                }
                else
                {
                    timeScheduleTask.TimeScheduleTaskExcludedDate = new EntityCollection<TimeScheduleTaskExcludedDate>();
                }

                foreach (DateTime date in timeScheduleTaskInput.ExcludedDates.Distinct().ToList())
                {
                    timeScheduleTask.TimeScheduleTaskExcludedDate.Add(new TimeScheduleTaskExcludedDate(date));
                }

                ActionResult result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = timeScheduleTask.TimeScheduleTaskId;

                return result;
            }
        }

        public ActionResult DeleteTimeScheduleTask(int timeScheduleTaskId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeScheduleTask timeScheduleTask = GetTimeScheduleTask(entities, timeScheduleTaskId, actorCompanyId, loadTimeScheduleTemplateBlockTasks: true, loadTimeScheduleTemplateBlocks: true, loadStaffingNeedsRowPeriod: true, onlyActive: false);
                if (timeScheduleTask == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeScheduleTask");
                if (timeScheduleTask.StaffingNeedsRowPeriod != null && timeScheduleTask.StaffingNeedsRowPeriod.Any(i => i.State == (int)SoeEntityState.Active))
                {
                    // Period may be active even if row is deleted, so we need to check the row
                    foreach (StaffingNeedsRowPeriod period in timeScheduleTask.StaffingNeedsRowPeriod.Where(i => i.State == (int)SoeEntityState.Active))
                    {
                        if (period.StaffingNeedsRow != null && period.StaffingNeedsRow.State == (int)SoeEntityState.Active)
                            return new ActionResult((int)ActionResultDelete.TimeScheduleTaskIsUsed, GetText(11522, "Kan inte tas bort, den används i ett behov"));
                    }
                }
                if (timeScheduleTask.TimeScheduleTemplateBlockTask != null && timeScheduleTask.TimeScheduleTemplateBlockTask.Any(i => i.IsTaskActive()))
                    return new ActionResult((int)ActionResultDelete.TimeScheduleTaskIsUsed, GetText(11521, "Kan inte tas bort, den används i ett aktivt schema"));
                return ChangeEntityState(entities, timeScheduleTask, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region TimeScheduleTaskType

        public List<TimeScheduleTaskType> GetTimeScheduleTaskTypes(int actorCompanyId, int? timeScheduleTaskTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTaskType.NoTracking();
            IQueryable<TimeScheduleTaskType> query = (from t in entities.TimeScheduleTaskType
                                                      where t.ActorCompanyId == actorCompanyId &&
                                                      t.State == (int)SoeEntityState.Active
                                                      orderby t.Name
                                                      select t);

            if (timeScheduleTaskTypeId.HasValue)
                query = query.Where(t => t.TimeScheduleTaskTypeId == timeScheduleTaskTypeId.Value);

            bool useAccountHierarchy = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseAccountHierarchy, 0, actorCompanyId, 0);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }


            return query.ToList();
        }

        public Dictionary<int, string> GetTimeScheduleTaskTypesDict(int actorCompanyId, bool addEmptyRow)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTaskType.NoTracking();
            List<TimeScheduleTaskType> types = GetTimeScheduleTaskTypes(actorCompanyId);

            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            foreach (TimeScheduleTaskType type in types)
            {
                dict.Add(type.TimeScheduleTaskTypeId, type.Name);
            }

            return dict;
        }

        public TimeScheduleTaskType GetTimeScheduleTaskType(int timeScheduleTaskTypeId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTaskType.NoTracking();
            return GetTimeScheduleTaskType(entities, timeScheduleTaskTypeId, actorCompanyId);
        }

        public TimeScheduleTaskType GetTimeScheduleTaskType(CompEntities entities, int timeScheduleTaskTypeId, int actorCompanyId)
        {
            IQueryable<TimeScheduleTaskType> query = (from t in entities.TimeScheduleTaskType
                                                      where t.ActorCompanyId == actorCompanyId &&
                                                      t.TimeScheduleTaskTypeId == timeScheduleTaskTypeId &&
                                                      t.State == (int)SoeEntityState.Active
                                                      select t);
            bool useAccountHierarchy = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseAccountHierarchy, 0, actorCompanyId, 0);
            if (useAccountHierarchy)
            {
                query = query.Include("Account");
                var accountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, base.RoleId, base.UserId, DateTime.Today, DateTime.Today, null);

                if (!accountIds.IsNullOrEmpty())
                    query = query.Where(t => !t.AccountId.HasValue || accountIds.Contains(t.AccountId.Value));
                else
                    query = query.Where(t => !t.AccountId.HasValue);
            }
            return query.FirstOrDefault();
        }

        public ActionResult SaveTimeScheduleTaskType(TimeScheduleTaskTypeDTO timeScheduleTaskTypeInput, int actorCompanyId)
        {
            if (timeScheduleTaskTypeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeScheduleTaskType");

            using (CompEntities entities = new CompEntities())
            {
                Company company = CompanyManager.GetCompany(entities, actorCompanyId);
                if (company == null)
                    return new ActionResult((int)ActionResultSave.EntityNotFound, GetText(11888, "Företaget hittades inte"));

                TimeScheduleTaskType timeScheduleTaskType = GetTimeScheduleTaskType(entities, timeScheduleTaskTypeInput.TimeScheduleTaskTypeId, actorCompanyId);
                if (timeScheduleTaskType == null)
                {
                    timeScheduleTaskType = new TimeScheduleTaskType()
                    {
                        Company = company,
                    };
                    SetCreatedProperties(timeScheduleTaskType);
                    entities.TimeScheduleTaskType.AddObject(timeScheduleTaskType);
                }
                else
                {
                    SetModifiedProperties(timeScheduleTaskType);
                }

                timeScheduleTaskType.Name = timeScheduleTaskTypeInput.Name;
                timeScheduleTaskType.Description = timeScheduleTaskTypeInput.Description;
                timeScheduleTaskType.AccountId = timeScheduleTaskTypeInput.AccountId;

                ActionResult result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = timeScheduleTaskType.TimeScheduleTaskTypeId;

                return result;
            }
        }

        public ActionResult DeleteTimeScheduleTaskType(int timeScheduleTaskTypeId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeScheduleTaskType timeScheduleTaskType = GetTimeScheduleTaskType(entities, timeScheduleTaskTypeId, actorCompanyId);
                if (timeScheduleTaskType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeScheduleTaskType");

                return DeleteEntityItem(entities, timeScheduleTaskType);
            }
        }

        #endregion

        #region TimeScheduleTemplateGroup

        public List<TimeScheduleTemplateGroup> GetTimeScheduleTemplateGroups(int actorCompanyId, bool includeRows, bool includeEmployees)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeScheduleTemplateGroups(entities, actorCompanyId, includeRows, includeEmployees);
        }

        public List<TimeScheduleTemplateGroup> GetTimeScheduleTemplateGroups(CompEntities entities, int actorCompanyId, bool includeRows, bool includeEmployees)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTemplateGroup.NoTracking();
            IQueryable<TimeScheduleTemplateGroup> query = (from t in entities.TimeScheduleTemplateGroup
                                                           where t.ActorCompanyId == actorCompanyId &&
                                                           t.State == (int)SoeEntityState.Active
                                                           select t);

            if (includeRows)
                query = query.Include("TimeScheduleTemplateGroupRow");
            if (includeEmployees)
                query = query.Include("TimeScheduleTemplateGroupEmployee");

            return (from t in query
                    orderby t.Name
                    select t).ToList();
        }

        public Dictionary<int, string> GetTimeScheduleTemplateGroupsDict(int actorCompanyId, bool addEmptyRow)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTaskType.NoTracking();
            List<TimeScheduleTemplateGroup> groups = GetTimeScheduleTemplateGroups(actorCompanyId, false, false);

            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            foreach (TimeScheduleTemplateGroup group in groups)
            {
                dict.Add(group.TimeScheduleTemplateGroupId, group.Name);
            }

            return dict;
        }

        public List<TimeScheduleTemplateGroupEmployee> GetTimeScheduleTemplateGroupsForEmployee(int actorCompanyId, int employeeId, bool includeGroup, bool includeRows)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateGroupEmployee.NoTracking();
            IQueryable<TimeScheduleTemplateGroupEmployee> query = (from t in entities.TimeScheduleTemplateGroupEmployee
                                                                   where t.TimeScheduleTemplateGroup.ActorCompanyId == actorCompanyId &&
                                                                   t.EmployeeId == employeeId &&
                                                                   t.State == (int)SoeEntityState.Active &&
                                                                   t.TimeScheduleTemplateGroup.State == (int)SoeEntityState.Active
                                                                   select t);


            if (includeRows)
                query = query.Include("TimeScheduleTemplateGroup.TimeScheduleTemplateGroupRow.TimeScheduleTemplateHead");
            else if (includeGroup)
                query = query.Include("TimeScheduleTemplateGroup");


            return (from t in query
                    orderby t.FromDate descending
                    select t).ToList();
        }

        public List<TimeScheduleTemplateGroupEmployee> GetTimeScheduleTemplateGroupsForEmployees(CompEntities entities, int actorCompanyId, List<int> employeeIds, bool includeGroup, bool includeRows)
        {
            IQueryable<TimeScheduleTemplateGroupEmployee> query = (from t in entities.TimeScheduleTemplateGroupEmployee
                                                                   where t.TimeScheduleTemplateGroup.ActorCompanyId == actorCompanyId &&
                                                                  employeeIds.Contains(t.EmployeeId) &&
                                                                   t.State == (int)SoeEntityState.Active &&
                                                                   t.TimeScheduleTemplateGroup.State == (int)SoeEntityState.Active
                                                                   select t);


            if (includeRows)
                query = query.Include("TimeScheduleTemplateGroup.TimeScheduleTemplateGroupRow.TimeScheduleTemplateHead");
            else if (includeGroup)
                query = query.Include("TimeScheduleTemplateGroup");


            return (from t in query
                    orderby t.FromDate descending
                    select t).ToList();
        }

        public TimeScheduleTemplateGroup GetTimeScheduleTemplateGroup(int timeScheduleTemplateGroupId, int actorCompanyId, bool includeRows, bool includeEmployees, bool setNextStartDateOnRows = false, bool setEmployeeInfo = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeScheduleTemplateGroup(entities, timeScheduleTemplateGroupId, actorCompanyId, includeRows, includeEmployees, setNextStartDateOnRows, setEmployeeInfo);
        }

        public TimeScheduleTemplateGroupDTO GetTimeScheduleTemplateGroupDTO(CompEntities entities, int timeScheduleTemplateGroupId, int actorCompanyId, bool includeRows, bool includeEmployees, bool setNextStartDateOnRows = false, bool setEmployeeInfo = false)
        {
            var key = $"GetTimeScheduleTemplateGroupDTO{timeScheduleTemplateGroupId}#{actorCompanyId}#{includeRows}#{includeEmployees}#{setNextStartDateOnRows}#{setEmployeeInfo}";
            var fromCache = BusinessMemoryCache<TimeScheduleTemplateGroupDTO>.Get(key);

            if (fromCache != null)
                return fromCache;

            var group = GetTimeScheduleTemplateGroup(entities, timeScheduleTemplateGroupId, actorCompanyId, includeRows, includeEmployees, setNextStartDateOnRows, setEmployeeInfo).ToDTO();

            if (group != null)
                BusinessMemoryCache<TimeScheduleTemplateGroupDTO>.Set(key, group, 30);

            return group;
        }

        public TimeScheduleTemplateGroup GetTimeScheduleTemplateGroup(CompEntities entities, int timeScheduleTemplateGroupId, int actorCompanyId, bool includeRows, bool includeEmployees, bool setNextStartDateOnRows = false, bool setEmployeeInfo = false)
        {
            IQueryable<TimeScheduleTemplateGroup> query = (from t in entities.TimeScheduleTemplateGroup
                                                           where t.ActorCompanyId == actorCompanyId &&
                                                           t.TimeScheduleTemplateGroupId == timeScheduleTemplateGroupId &&
                                                           t.State == (int)SoeEntityState.Active
                                                           select t);

            if (includeRows)
                query = query.Include("TimeScheduleTemplateGroupRow");

            if (includeEmployees)
            {
                query = query.Include("TimeScheduleTemplateGroupEmployee");
                if (setEmployeeInfo)
                    query = query.Include("TimeScheduleTemplateGroupEmployee.Employee.ContactPerson");
            }

            TimeScheduleTemplateGroup group = query.FirstOrDefault();

            if (includeRows && setNextStartDateOnRows && group.TimeScheduleTemplateGroupRow != null)
            {
                foreach (TimeScheduleTemplateGroupRow row in group.TimeScheduleTemplateGroupRow)
                {
                    // First check one year. If nothing found check one more year
                    row.SetNextStartDate(row.StartDate, row.StartDate.AddYears(1));
                }
            }

            return group;
        }

        public TimeScheduleTemplateHeadsRangeDTO GetTimeScheduleTemplateHeadsRange(int timeScheduleTemplateGroupId, int actorCompanyId, DateTime dateFrom, DateTime dateTo)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeScheduleTemplateHeadsRange(entities, timeScheduleTemplateGroupId, actorCompanyId, dateFrom, dateTo);
        }

        public TimeScheduleTemplateHeadsRangeDTO GetTimeScheduleTemplateHeadsRange(CompEntities entities, int timeScheduleTemplateGroupId, int actorCompanyId, DateTime dateFrom, DateTime dateTo)
        {

            var key = $"GetTimeScheduleTemplateHeadsRange{timeScheduleTemplateGroupId}#{actorCompanyId}#{dateFrom}#{dateTo}";
            var fromCache = BusinessMemoryCache<TimeScheduleTemplateHeadsRangeDTO>.Get(key);

            if (fromCache != null)
                return fromCache;

            TimeScheduleTemplateGroupDTO group = GetTimeScheduleTemplateGroupDTO(entities, timeScheduleTemplateGroupId, actorCompanyId, true, false);
            if (group == null || group.Rows.IsNullOrEmpty())
                return null;

            TimeScheduleTemplateHeadsRangeDTO dto = new TimeScheduleTemplateHeadsRangeDTO()
            {
                Heads = new List<TimeScheduleTemplateHeadRangeDTO>()
            };

            foreach (TimeScheduleTemplateGroupRowDTO row in group.Rows.Where(w => w.State == (int)SoeEntityState.Active))
            {
                var head = GetTimeScheduleTemplateHeadDTO(entities, actorCompanyId, row.TimeScheduleTemplateHeadId);

                if (head == null)
                    continue;

                DateTime visibleDateFrom = dateFrom;
                DateTime visibleDateTo = dateTo;

                if (row.StopDate.HasValue && visibleDateTo > row.StopDate.Value)
                    visibleDateTo = row.StopDate.Value;

                DailyRecurrenceDatesOutput output = DailyRecurrencePatternDTO.GetDatesFromPattern(row.RecurrencePattern, row.StartDate, visibleDateFrom.AddYears(-2), visibleDateTo.AddYears(1), null);
                if (output.RecurrenceDates.Any())
                {
                    foreach (DateTime date in output.RecurrenceDates.Where(r => r <= visibleDateTo))
                    {
                        TimeScheduleTemplateHeadRangeDTO hDTO = new TimeScheduleTemplateHeadRangeDTO()
                        {
                            TimeScheduleTemplateHeadId = row.TimeScheduleTemplateHeadId,
                            StartDate = date,
                            StopDate = row.StopDate,
                            NoOfDays = head.NoOfDays,
                            TemplateName = head.Name,
                            FirstMondayOfCycle = head.FirstMondayOfCycle,
                            TimeScheduleTemplateGroupId = timeScheduleTemplateGroupId,
                            TimeScheduleTemplateGroupName = group.Name,
                        };
                        dto.Heads.Add(hDTO);
                    }
                }
            }

            List<int> headIds = dto.Heads.Select(h => h.TimeScheduleTemplateHeadId).Distinct().ToList();
            Dictionary<int, string> headDict = (from t in entities.TimeScheduleTemplateHead
                                                where headIds.Contains(t.TimeScheduleTemplateHeadId)
                                                select t).ToDictionary(t => t.TimeScheduleTemplateHeadId, t => t.Name);

            TimeScheduleTemplateHeadRangeDTO prevHead = null;
            foreach (TimeScheduleTemplateHeadRangeDTO head in dto.Heads.OrderBy(h => h.StartDate).ToList())
            {
                if (headDict.ContainsKey(head.TimeScheduleTemplateHeadId))
                    head.TemplateName = headDict[head.TimeScheduleTemplateHeadId];

                if (prevHead != null)
                {
                    if (prevHead.TimeScheduleTemplateHeadId == head.TimeScheduleTemplateHeadId)
                        dto.Heads.Remove(head);
                    else
                    {
                        if (!prevHead.StopDate.HasValue || prevHead.StopDate.Value > head.StartDate.AddDays(-1))
                            prevHead.StopDate = head.StartDate.AddDays(-1);
                    }
                }

                prevHead = head;
            }

            dto.Heads = dto.Heads.OrderBy(h => h.StartDate).ToList();


            if (dto != null)
                BusinessMemoryCache<TimeScheduleTemplateHeadsRangeDTO>.Set(key, dto, 30);

            return dto;
        }

        private TimeScheduleTemplateHeadDTO GetTimeScheduleTemplateHeadDTO(CompEntities entities, int actorCompanyId, int timeScheduleTemplateHeadId)
        {
            var key = $"GetTimeScheduleTemplateHeadDTO{timeScheduleTemplateHeadId}#{actorCompanyId}";
            var fromCache = BusinessMemoryCache<TimeScheduleTemplateHeadDTO>.Get(key);

            if (fromCache != null)
                return fromCache;

            var head = entities.TimeScheduleTemplateHead.FirstOrDefault(f => f.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId);

            if (head != null)
            {
                var dto = head.ToDTO(false, false, false, false, false, false);
                BusinessMemoryCache<TimeScheduleTemplateHeadDTO>.Set(key, dto, 30);
                return dto;
            }

            return null;
        }

        public TimeScheduleTemplateHeadsRangeDTO GetTimeScheduleTemplateHeadsRangeForEmployee(CompEntities entities, int employeeId, int actorCompanyId, DateTime dateFrom, DateTime dateTo, bool checkPlacements = false, int templateTimeScheduleTemplateHeadId = 0, List<TimeScheduleTemplateHead> timeScheduleTemplateHeads = null)
        {
            return GetTimeScheduleTemplateHeadsRangeForEmployees(entities, employeeId.ObjToList(), actorCompanyId, dateFrom, dateTo, checkPlacements, templateTimeScheduleTemplateHeadId, timeScheduleTemplateHeads);

        }
        public TimeScheduleTemplateHeadsRangeDTO GetTimeScheduleTemplateHeadsRangeForEmployee(int employeeId, int actorCompanyId, DateTime dateFrom, DateTime dateTo, bool checkPlacements = false, int templateTimeScheduleTemplateHeadId = 0, List<TimeScheduleTemplateHead> timeScheduleTemplateHeads = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeScheduleTemplateHeadsRangeForEmployee(entities, employeeId, actorCompanyId, dateFrom, dateTo, checkPlacements, templateTimeScheduleTemplateHeadId, timeScheduleTemplateHeads);
        }

        public TimeScheduleTemplateHeadRangeDTO GetTimeScheduleTemplateHeadsRangeForEmployees(CompEntities entities, int timeScheduleTemplateHeadId)
        {
            return (from t in entities.TimeScheduleTemplateHead
                    where t.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId &&
                     t.State == (int)SoeEntityState.Active
                    select new TimeScheduleTemplateHeadRangeDTO()
                    {
                        EmployeeId = t.EmployeeId ?? 0,
                        TimeScheduleTemplateHeadId = t.TimeScheduleTemplateHeadId,
                        StartDate = t.StartDate ?? CalendarUtility.DATETIME_DEFAULT,
                        StopDate = t.StopDate,
                        NoOfDays = t.NoOfDays,
                        FirstMondayOfCycle = t.FirstMondayOfCycle,
                        TemplateName = t.Name
                    }).FirstOrDefault();
        }

        public TimeScheduleTemplateHeadsRangeDTO GetTimeScheduleTemplateHeadsRangeForEmployees(CompEntities entities, List<int> employeeIds, int actorCompanyId, DateTime dateFrom, DateTime dateTo, bool checkPlacements = false, int templateTimeScheduleTemplateHeadId = 0, List<TimeScheduleTemplateHead> timeScheduleTemplateHeads = null)
        {
            TimeScheduleTemplateHeadsRangeDTO dto = new TimeScheduleTemplateHeadsRangeDTO()
            {
                Heads = new List<TimeScheduleTemplateHeadRangeDTO>()
            };

            List<TimeScheduleTemplateHeadRangeDTO> allTemplates;

            if (templateTimeScheduleTemplateHeadId != 0)
            {
                var firstMondayOfCycle = CalendarUtility.GetBeginningOfWeek(dateFrom);
                var heads = (from t in entities.TimeScheduleTemplateHead
                             where t.TimeScheduleTemplateHeadId == templateTimeScheduleTemplateHeadId &&
                             t.State == (int)SoeEntityState.Active
                             select new TimeScheduleTemplateHeadRangeDTO()
                             {
                                 EmployeeId = t.EmployeeId.Value,
                                 TimeScheduleTemplateHeadId = t.TimeScheduleTemplateHeadId,
                                 StartDate = dateFrom,
                                 StopDate = dateTo,
                                 NoOfDays = t.NoOfDays,
                                 TemplateName = t.Name,
                                 FirstMondayOfCycle = firstMondayOfCycle
                             }).ToList();

                if (heads.Any())
                {
                    dto.Heads.AddRange(heads);
                    return dto;
                }
            }

            if (timeScheduleTemplateHeads == null)
            {
                allTemplates = (from t in entities.TimeScheduleTemplateHead
                                where t.EmployeeId.HasValue && employeeIds.Contains(t.EmployeeId.Value) &&
                                t.State == (int)SoeEntityState.Active &&
                                (t.StartDate != null && t.StartDate <= dateTo) &&
                                (t.StopDate == null || t.StopDate >= dateFrom)
                                select new TimeScheduleTemplateHeadRangeDTO()
                                {
                                    EmployeeId = t.EmployeeId.Value,
                                    TimeScheduleTemplateHeadId = t.TimeScheduleTemplateHeadId,
                                    StartDate = t.StartDate.Value,
                                    StopDate = t.StopDate,
                                    NoOfDays = t.NoOfDays,
                                    TemplateName = t.Name,
                                    FirstMondayOfCycle = t.FirstMondayOfCycle
                                }).ToList();
            }
            else
            {
                allTemplates = (from t in timeScheduleTemplateHeads
                                where t.EmployeeId.HasValue && employeeIds.Contains(t.EmployeeId.Value) &&
                                t.State == (int)SoeEntityState.Active &&
                                (t.StartDate != null && t.StartDate <= dateTo) &&
                                (t.StopDate == null || t.StopDate >= dateFrom)
                                select new TimeScheduleTemplateHeadRangeDTO()
                                {
                                    EmployeeId = t.EmployeeId.Value,
                                    TimeScheduleTemplateHeadId = t.TimeScheduleTemplateHeadId,
                                    StartDate = t.StartDate.Value,
                                    StopDate = t.StopDate,
                                    NoOfDays = t.NoOfDays,
                                    TemplateName = t.Name,
                                    FirstMondayOfCycle = t.FirstMondayOfCycle
                                }).ToList();
            }

            foreach (var employeeTemplates in allTemplates.GroupBy(g => g.EmployeeId))
            {
                List<TimeScheduleTemplateHeadRangeDTO> empTemplates = employeeTemplates.OrderBy(o => o.StartDate).ToList();
                List<DateTime> startDates = empTemplates.Select(t => t.StartDate).ToList();
                foreach (TimeScheduleTemplateHeadRangeDTO empTemplateHead in empTemplates)
                {
                    DateTime? nextStartDate = startDates.OrderBy(d => d).FirstOrDefault(d => d > empTemplateHead.StartDate);
                    if (nextStartDate.HasValue && nextStartDate.Value > empTemplateHead.StartDate && (!empTemplateHead.StopDate.HasValue || empTemplateHead.StopDate.Value > nextStartDate.Value.AddDays(-1)))
                        empTemplateHead.StopDate = nextStartDate.Value.AddDays(-1);
                }

                dto.Heads.AddRange(employeeTemplates);
            }

            List<TimeScheduleTemplateGroupEmployee> empGroups = base.HasTimeScheduleTemplateGroupsFromCache(entities, actorCompanyId) ? GetTimeScheduleTemplateGroupsForEmployees(entities, actorCompanyId, employeeIds, false, false) : new List<TimeScheduleTemplateGroupEmployee>();
            foreach (var empGroupEmployee in empGroups.GroupBy(g => g.EmployeeId))
            {
                List<TimeScheduleTemplateHeadRangeDTO> templatesFromGroupsOnEmployee = new List<TimeScheduleTemplateHeadRangeDTO>();
                List<TimeScheduleTemplateHeadRangeDTO> templatesOnEmployee = dto.Heads.Where(w => w.EmployeeId == empGroupEmployee.Key).ToList();
                foreach (TimeScheduleTemplateGroupEmployee empGroup in empGroupEmployee.OrderBy(g => g.FromDate))
                {
                    DateTime visibleDateFrom = dateFrom;
                    if (empGroup.FromDate > visibleDateFrom)
                        visibleDateFrom = empGroup.FromDate;

                    DateTime visibleDateTo = dateTo;
                    if (empGroup.ToDate.HasValue && empGroup.ToDate < visibleDateTo)
                        visibleDateTo = empGroup.ToDate.Value;

                    TimeScheduleTemplateHeadsRangeDTO rangeDTO = GetTimeScheduleTemplateHeadsRange(entities, empGroup.TimeScheduleTemplateGroupId, actorCompanyId, visibleDateFrom, visibleDateTo);
                    if (rangeDTO != null && rangeDTO.Heads.Any())
                    {
                        if (templatesFromGroupsOnEmployee.Any())
                        {
                            foreach (var item in templatesFromGroupsOnEmployee)
                            {
                                if (item.StopDate >= rangeDTO.Heads[0].StartDate || item.StartDate >= rangeDTO.Heads[0].StartDate)
                                    item.StartDate = CalendarUtility.DATETIME_DEFAULT;
                                else if (!item.StopDate.HasValue)
                                    item.StopDate = rangeDTO.Heads[0].StartDate.AddDays(-1);
                            }
                        }
                        templatesFromGroupsOnEmployee = templatesFromGroupsOnEmployee.Where(w => w.StartDate != CalendarUtility.DATETIME_DEFAULT).ToList();
                        rangeDTO.Heads = rangeDTO.Heads.Where(w => w.StartDate != CalendarUtility.DATETIME_DEFAULT).ToList();
                        rangeDTO.Heads.ForEach(f => { f.EmployeeId = empGroupEmployee.Key; f.TimeScheduleTemplateGroupId = empGroup.TimeScheduleTemplateGroupId; });
                        templatesFromGroupsOnEmployee.AddRange(rangeDTO.Heads);
                    }
                }

                templatesOnEmployee.Where(w => !w.StopDate.HasValue).ToList().ForEach(f => f.StopDate = DateTime.MaxValue);
                templatesFromGroupsOnEmployee.Where(w => !w.StopDate.HasValue).ToList().ForEach(f => f.StopDate = DateTime.MaxValue);
                if (templatesOnEmployee.Any())
                {
                    DateTime currentDate = dateFrom;
                    Dictionary<DateTime, TimeScheduleTemplateHeadRangeDTO> dict = new Dictionary<DateTime, TimeScheduleTemplateHeadRangeDTO>();
                    dto.Heads = dto.Heads.Where(w => w.EmployeeId != empGroupEmployee.Key).ToList();
                    while (currentDate <= dateTo)
                    {
                        TimeScheduleTemplateHeadRangeDTO matching = templatesOnEmployee.OrderByDescending(o => o.StartDate).FirstOrDefault(f => f.StartDate <= currentDate && f.StopDate >= currentDate);
                        if (matching != null)
                        {
                            dict.Add(currentDate, matching);
                        }
                        else
                        {
                            matching = templatesFromGroupsOnEmployee.OrderByDescending(o => o.StartDate).FirstOrDefault(f => f.StartDate <= currentDate && f.StopDate >= currentDate);
                            dict.Add(currentDate, matching ?? null);
                        }
                        currentDate = currentDate.AddDays(1);
                    }

                    TimeScheduleTemplateHeadRangeDTO rangeDTO = null;

                    foreach (var pair in dict)
                    {
                        if (pair.Value == null)
                            continue;

                        if (rangeDTO == null)
                            rangeDTO = new TimeScheduleTemplateHeadRangeDTO()
                            {
                                EmployeeId = empGroupEmployee.Key,
                                StartDate = pair.Key,
                                TimeScheduleTemplateHeadId = pair.Value.TimeScheduleTemplateHeadId,
                                TimeScheduleTemplateGroupId = pair.Value.TimeScheduleTemplateGroupId,
                                TimeScheduleTemplateGroupName = pair.Value.TimeScheduleTemplateGroupName,
                                NoOfDays = pair.Value.NoOfDays,
                                TemplateName = pair.Value.TemplateName,
                                FirstMondayOfCycle = pair.Value.FirstMondayOfCycle
                            };

                        if (rangeDTO.TimeScheduleTemplateHeadId == pair.Value.TimeScheduleTemplateHeadId)
                        {
                            rangeDTO.StopDate = pair.Key;
                        }
                        else
                        {
                            if (rangeDTO.TimeScheduleTemplateHeadId != 0)
                                dto.Heads.Add(rangeDTO.CloneDTO());

                            rangeDTO = new TimeScheduleTemplateHeadRangeDTO()
                            {
                                EmployeeId = empGroupEmployee.Key,
                                StartDate = pair.Key,
                                TimeScheduleTemplateHeadId = pair.Value.TimeScheduleTemplateHeadId,
                                TimeScheduleTemplateGroupId = pair.Value.TimeScheduleTemplateGroupId,
                                TimeScheduleTemplateGroupName = pair.Value.TimeScheduleTemplateGroupName,
                                NoOfDays = pair.Value.NoOfDays,
                                TemplateName = pair.Value.TemplateName,
                                FirstMondayOfCycle = pair.Value.FirstMondayOfCycle
                            };
                        }
                    }

                    if (rangeDTO != null)
                        dto.Heads.Add(rangeDTO.CloneDTO());
                }
                else
                {
                    dto.Heads.AddRange(templatesFromGroupsOnEmployee);
                }
            }

            if (checkPlacements)
            {
                List<EmployeeSchedule> placements = GetEmployeeSchedulesForEmployees(entities, employeeIds);
                placements = placements.Where(w => w.StopDate >= dateFrom.AddDays(-1)).ToList();
                List<TimeScheduleTemplateHeadRangeDTO> createdHeads = new List<TimeScheduleTemplateHeadRangeDTO>();
                foreach (var headsOnEmployee in dto.Heads.GroupBy(g => g.EmployeeId))
                {
                    DateTime? employmentEndDate = EmployeeManager.GetEmployee(entities, headsOnEmployee.Key, actorCompanyId, loadEmployeeAccount: true)?.GetEmployment(dateFrom, dateTo, false)?.GetEndDate();
                    DateTime endDate = dateTo;
                    if (employmentEndDate.HasValue && employmentEndDate.Value.Date < dateTo && employmentEndDate > dateFrom)
                        endDate = employmentEndDate.Value;

                    foreach (TimeScheduleTemplateHeadRangeDTO head in headsOnEmployee)
                    {
                        DateTime daybefore = head.StartDate.AddDays(-1);
                        List<EmployeeSchedule> overlappingPlacements = placements.Where(w => w.TimeScheduleTemplateHeadId == head.TimeScheduleTemplateHeadId && w.EmployeeId == head.EmployeeId && CalendarUtility.IsDatesOverlapping(daybefore, head.StopDate ?? endDate, w.StartDate, w.StopDate, validateDatesAreTouching: true)).ToList();

                        if (overlappingPlacements.Count == 1)
                        {
                            head.EmployeeScheduleId = overlappingPlacements[0].EmployeeScheduleId;
                            head.EmployeeScheduleStartDate = overlappingPlacements[0].StartDate;
                            head.EmployeeScheduleStopDate = overlappingPlacements[0].StopDate;
                        }
                        else if (overlappingPlacements.Any()) // need to split head into multiple heads
                        {
                            foreach (EmployeeSchedule placement in overlappingPlacements.OrderBy(o => o.StartDate))
                            {
                                head.EmployeeScheduleStartDate = placement.StartDate;
                                head.EmployeeScheduleStopDate = placement.StopDate;
                                head.EmployeeScheduleId = placement.EmployeeScheduleId;
                                var clone = head.CloneDTO();
                                head.StopDate = placement.StopDate;
                                clone.StartDate = head.StopDate.Value.AddDays(1);
                                clone.StopDate = endDate;
                                createdHeads.Add(clone);
                            }
                        }
                    }
                }

                dto.Heads.AddRange(createdHeads);
            }

            dto.Heads = dto.Heads.OrderBy(h => h.EmployeeId).ThenBy(h => h.StartDate).ToList();
            dto.Heads.Where(w => w.StopDate == DateTime.MaxValue).ToList().ForEach(f => f.StopDate = null);

            return dto;
        }

        public DateTime? GetTimeScheduleTemplateGroupRowNextStartDate(DateTime startDate, string recurrencePattern, DateTime visibleDateFrom, DateTime visibleDateTo)
        {
            DailyRecurrenceDatesOutput output = DailyRecurrencePatternDTO.GetDatesFromPattern(recurrencePattern, startDate, visibleDateFrom, visibleDateTo, null);
            return output.RecurrenceDates.Any() ? output.RecurrenceDates.First() : (DateTime?)null;
        }


        public ActionResult SaveTimeScheduleTemplateGroup(TimeScheduleTemplateGroupDTO groupInput, int actorCompanyId)
        {
            if (groupInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeScheduleTemplateGroup");

            using (CompEntities entities = new CompEntities())
            {
                #region TimeScheduleTemplateGroup

                TimeScheduleTemplateGroup group = GetTimeScheduleTemplateGroup(entities, groupInput.TimeScheduleTemplateGroupId, actorCompanyId, true, true);
                if (group == null)
                {
                    group = new TimeScheduleTemplateGroup()
                    {
                        ActorCompanyId = actorCompanyId,
                    };
                    SetCreatedProperties(group);
                    entities.AddObject("TimeScheduleTemplateGroup", group);
                }
                else
                {
                    SetModifiedProperties(group);
                }

                group.Name = groupInput.Name;
                group.Description = StringUtility.EmptyToNull(groupInput.Description);

                #endregion

                #region TimeScheduleTemplateGroupRow

                List<TimeScheduleTemplateGroupRow> existingRows = group.TimeScheduleTemplateGroupId > 0 ? group.TimeScheduleTemplateGroupRow.Where(r => r.State == (int)SoeEntityState.Active).ToList() : new List<TimeScheduleTemplateGroupRow>();

                #region Delete rows that exists in db but not in input.

                foreach (TimeScheduleTemplateGroupRow existingRow in existingRows)
                {
                    if (!groupInput.Rows.Any(r => r.TimeScheduleTemplateGroupRowId == existingRow.TimeScheduleTemplateGroupRowId))
                        ChangeEntityState(existingRow, SoeEntityState.Deleted);
                }

                #endregion

                #region Add/update rows

                if (groupInput.Rows != null)
                {
                    foreach (TimeScheduleTemplateGroupRowDTO rowInput in groupInput.Rows)
                    {
                        TimeScheduleTemplateGroupRow existingRow = existingRows.FirstOrDefault(r => r.TimeScheduleTemplateGroupRowId == rowInput.TimeScheduleTemplateGroupRowId);
                        if (existingRow == null)
                        {
                            existingRow = new TimeScheduleTemplateGroupRow();
                            SetCreatedProperties(existingRow);
                            group.TimeScheduleTemplateGroupRow.Add(existingRow);
                        }
                        else
                        {
                            SetModifiedProperties(existingRow);
                        }

                        #region Common

                        existingRow.TimeScheduleTemplateHeadId = rowInput.TimeScheduleTemplateHeadId;
                        existingRow.StartDate = rowInput.StartDate;
                        existingRow.StopDate = rowInput.StopDate;
                        existingRow.RecurrencePattern = rowInput.RecurrencePattern;

                        #endregion
                    }
                }

                #endregion

                #endregion

                #region TimeScheduleTemplateGroupEmployee

                List<TimeScheduleTemplateGroupEmployee> existingEmployees = group.TimeScheduleTemplateGroupId > 0 ? group.TimeScheduleTemplateGroupEmployee.Where(e => e.State == (int)SoeEntityState.Active).ToList() : new List<TimeScheduleTemplateGroupEmployee>();

                #region Delete rows that exists in db but not in input.

                foreach (TimeScheduleTemplateGroupEmployee existingEmployee in existingEmployees)
                {
                    if (!groupInput.Employees.Any(e => e.TimeScheduleTemplateGroupEmployeeId == existingEmployee.TimeScheduleTemplateGroupEmployeeId))
                        ChangeEntityState(existingEmployee, SoeEntityState.Deleted);
                }

                #endregion

                #region Add/update rows

                if (groupInput.Employees != null)
                {
                    foreach (TimeScheduleTemplateGroupEmployeeDTO employeeInput in groupInput.Employees)
                    {
                        TimeScheduleTemplateGroupEmployee existingEmployee = existingEmployees.FirstOrDefault(e => e.TimeScheduleTemplateGroupEmployeeId == employeeInput.TimeScheduleTemplateGroupEmployeeId);
                        if (existingEmployee == null)
                        {
                            existingEmployee = new TimeScheduleTemplateGroupEmployee();
                            SetCreatedProperties(existingEmployee);
                            group.TimeScheduleTemplateGroupEmployee.Add(existingEmployee);
                        }
                        else
                        {
                            SetModifiedProperties(existingEmployee);
                        }

                        #region Common

                        existingEmployee.EmployeeId = employeeInput.EmployeeId;
                        existingEmployee.FromDate = employeeInput.FromDate;
                        existingEmployee.ToDate = employeeInput.ToDate;

                        #endregion
                    }
                }

                #endregion

                #endregion

                ActionResult result = SaveChanges(entities);
                if (result.Success)
                    result.IntegerValue = group.TimeScheduleTemplateGroupId;

                return result;
            }
        }

        public ActionResult DeleteTimeScheduleTemplateGroup(int timeScheduleTemplateGroupId, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                TimeScheduleTemplateGroup group = GetTimeScheduleTemplateGroup(entities, timeScheduleTemplateGroupId, actorCompanyId, true, true);
                if (group == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeScheduleTemplateGroup");

                return ChangeEntityState(entities, group, SoeEntityState.Deleted, true);
            }
        }

        #endregion

        #region TimeScheduleTemplateHead

        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeads(int actorCompanyId, bool loadTemplatePeriods, bool loadTemplateBlocks, bool excludePersonalTemplate, bool excludeNameless)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            IQueryable<TimeScheduleTemplateHead> query = (from h in entities.TimeScheduleTemplateHead
                                                          where h.ActorCompanyId == actorCompanyId &&
                                                          h.State == (int)SoeEntityState.Active
                                                          select h);

            if (loadTemplatePeriods)
            {
                entities.TimeScheduleTemplatePeriod.NoTracking();
                if (loadTemplateBlocks)
                {
                    entities.TimeScheduleTemplateBlock.NoTracking();
                    query = query.Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateBlock");
                }
                else
                {
                    query = query.Include("TimeScheduleTemplatePeriod");
                }
            }

            if (excludePersonalTemplate)
                query = query.Where(h => !h.EmployeeId.HasValue);

            if (excludeNameless)
                query = query.Where(h => h.Name.Length > 0);

            List<TimeScheduleTemplateHead> templateHeads = query.OrderBy(h => h.Name).ToList();

            return templateHeads;
        }

        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeads(int actorCompanyId, bool loadTemplatePeriods, bool loadTemplateBlocks, SoeStaffingNeedType type)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            IQueryable<TimeScheduleTemplateHead> query = (from h in entities.TimeScheduleTemplateHead
                                                          where h.ActorCompanyId == actorCompanyId &&
                                                          h.State == (int)SoeEntityState.Active
                                                          select h);

            if (loadTemplatePeriods)
            {
                entities.TimeScheduleTemplatePeriod.NoTracking();
                if (loadTemplateBlocks)
                {
                    entities.TimeScheduleTemplateBlock.NoTracking();
                    query = query.Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateBlock");
                }
                else
                {
                    query = query.Include("TimeScheduleTemplatePeriod");
                }
            }

            if (type == SoeStaffingNeedType.EmployeePost)
                query = query.Where(h => h.EmployeePostId.HasValue && !h.EmployeeId.HasValue && h.EmployeePost.State == (int)SoeEntityState.Active);
            else if (type == SoeStaffingNeedType.Template || type == SoeStaffingNeedType.Employee)
                query = query.Where(h => h.EmployeeId.HasValue && h.Employee.State == (int)SoeEntityState.Active);

            return query.OrderBy(h => h.Name).ToList();
        }

        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeads(CompEntities entities, List<int> timeScheduleTemplateHeadIds, int actorCompanyId, bool onlyActive)
        {
            return (from th in entities.TimeScheduleTemplateHead
                    where th.ActorCompanyId == actorCompanyId &&
                    timeScheduleTemplateHeadIds.Contains(th.TimeScheduleTemplateHeadId) &&
                    ((onlyActive && th.State == (int)SoeEntityState.Active) || th.State != (int)SoeEntityState.Deleted)
                    select th).ToList();
        }

        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeadsIncludingEmployeeNames(int actorCompanyId, bool loadPeriods, bool loadBlocks, bool includeLastPlacement, bool? active = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            var templateHeads = (from h in entities.TimeScheduleTemplateHead.Include("Employee.ContactPerson")
                                 where h.Company.ActorCompanyId == actorCompanyId &&
                                 h.State != (int)SoeEntityState.Deleted
                                 orderby h.Name
                                 select h).ToList();

            if (active == true)
                templateHeads = templateHeads.Where(i => i.State == (int)SoeEntityState.Active).ToList();
            else if (active == false)
                templateHeads = templateHeads.Where(i => i.State == (int)SoeEntityState.Inactive).ToList();

            if (includeLastPlacement)
            {
                var placements = GetEmployeeSchedules(actorCompanyId);
                foreach (var templateHead in templateHeads)
                {
                    var lastPlacement = placements.Where(i => i.TimeScheduleTemplateHeadId == templateHead.TimeScheduleTemplateHeadId).OrderByDescending(i => i.StartDate).FirstOrDefault();
                    if (lastPlacement != null)
                    {
                        templateHead.LastPlacementStartDate = lastPlacement.StartDate;
                        templateHead.LastPlacementStopDate = lastPlacement.StopDate;
                    }
                }
            }

            return templateHeads;
        }

        /// <summary>
        /// Get list of TimeScheduleTemplateHeads for specified employee
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="dateLimitFrom">If specified, limits the start date to be more or equal to specified date</param>
        /// <param name="dateLimitTo">If specified, limits the start date to be less or equal to specified date</param>
        /// <param name="intersecting">If true, the template starting before date range and ends within is also returned</param>
        /// <param name="loadBlocks">If true, periods and blocks are included</param>
        /// <returns>Collection of TimeScheduleTemplateHeads</returns>
        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeadsForEmployee(int actorCompanyId, int employeeId, DateTime? dateLimitFrom, DateTime? dateLimitTo, bool intersecting = false, bool loadBlocks = false, bool excludeMultipleAccounts = false, bool includePublicTemplates = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            return GetTimeScheduleTemplateHeadsForEmployee(entities, actorCompanyId, employeeId, dateLimitFrom, dateLimitTo, intersecting, loadBlocks, excludeMultipleAccounts, includePublicTemplates);
        }

        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeadsForEmployee(CompEntities entities, int actorCompanyId, int employeeId, DateTime? dateLimitFrom, DateTime? dateLimitTo, bool intersecting = false, bool loadBlocks = false, bool excludeMultipleAccounts = false, bool includePublicTemplates = false)
        {
            List<TimeScheduleTemplateHead> result;

            #region Prereq

            List<int> headIds = null;
            if (includePublicTemplates)
            {
                headIds = (from e in entities.EmployeeSchedule
                           where e.EmployeeId == employeeId &&
                           e.State == (int)SoeEntityState.Active
                           select e.TimeScheduleTemplateHeadId).Distinct().ToList();
            }

            #endregion

            #region Create query

            IQueryable<TimeScheduleTemplateHead> query = (from h in entities.TimeScheduleTemplateHead.Include("TimeScheduleTemplatePeriod")
                                                          where h.ActorCompanyId == actorCompanyId &&
                                                          h.State == (int)SoeEntityState.Active &&
                                                          h.NoOfDays > 0
                                                          orderby h.StartDate descending
                                                          select h);

            if (loadBlocks)
                query = query.Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateBlock");
            else if (excludeMultipleAccounts)
                query = query.Include("TimeScheduleTemplatePeriod");

            if (includePublicTemplates && headIds != null)
                query = query.Where(h => h.EmployeeId == employeeId || headIds.Contains(h.TimeScheduleTemplateHeadId));
            else
                query = query.Where(h => h.EmployeeId == employeeId && h.StartDate.HasValue);

            if (dateLimitFrom.HasValue)
                query = query.Where(h => h.StartDate.Value >= dateLimitFrom.Value);

            if (dateLimitTo.HasValue)
                query = query.Where(h => h.StartDate.Value <= dateLimitTo.Value);

            #endregion

            if (excludeMultipleAccounts)
            {
                result = query.ToList();

                List<int> periodIds = result.SelectMany(h => h.TimeScheduleTemplatePeriodIds).ToList();

                List<TimeScheduleTemplateBlock> blocks = (from b in entities.TimeScheduleTemplateBlock
                                                          where b.Date == null &&
                                                          b.State == (int)SoeEntityState.Active &&
                                                          b.EmployeeId == employeeId &&
                                                          b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                          b.AccountId.HasValue &&
                                                          b.StartTime != b.StopTime &&
                                                          b.TimeScheduleTemplatePeriodId.HasValue &&
                                                          periodIds.Contains(b.TimeScheduleTemplatePeriodId.Value)
                                                          select b).ToList();

                // Remove all templates with multiple accounts on blocks
                foreach (TimeScheduleTemplateHead head in result.ToList())
                {
                    List<int?> accountIds = new List<int?>();
                    foreach (TimeScheduleTemplatePeriod period in head.TimeScheduleTemplatePeriod)
                    {
                        accountIds.AddRange(blocks.Where(b => b.TimeScheduleTemplatePeriodId == period.TimeScheduleTemplatePeriodId).Select(b => b.AccountId).Distinct().ToList());
                    }
                    accountIds = accountIds.Distinct().ToList();
                    if (accountIds.Count > 1)
                        result.Remove(head);
                    else if (accountIds.Count == 1)
                        head.AccountId = accountIds[0];
                }

                // Set account names
                List<int> allAccountIds = result.Where(h => h.AccountId.HasValue).Select(h => h.AccountId.Value).Distinct().ToList();
                if (allAccountIds.Any())
                {
                    List<Account> accounts = entities.Account.Where(a => allAccountIds.Contains(a.AccountId)).Select(a => a).ToList();
                    foreach (TimeScheduleTemplateHead head in result.Where(h => h.AccountId.HasValue))
                    {
                        Account account = accounts.FirstOrDefault(a => a.AccountId == head.AccountId.Value);
                        if (account != null)
                        {
                            head.AccountId = account.AccountId;
                            head.AccountName = account.Name;
                        }
                    }
                }
            }
            else
            {
                result = query.OrderByDescending(h => h.StartDate).ToList();

                if (intersecting && dateLimitFrom.HasValue && dateLimitTo.HasValue && (!result.Any() || (result.Any() && result.First().StartDate.Value.Date > dateLimitFrom.Value.Date)))
                {
                    // If no template starts within specified interval or
                    // first returned template starts after specified start date,
                    // get the template before the specified start date

                    IQueryable<TimeScheduleTemplateHead> newQuery = entities.TimeScheduleTemplateHead;
                    if (loadBlocks)
                        newQuery = newQuery.Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateBlock");

                    TimeScheduleTemplateHead head = (from h in newQuery
                                                     where h.ActorCompanyId == actorCompanyId &&
                                                     h.EmployeeId == employeeId &&
                                                     h.StartDate.HasValue && h.StartDate.Value < dateLimitFrom.Value &&
                                                     h.State == (int)SoeEntityState.Active
                                                     orderby h.StartDate.Value descending
                                                     select h).FirstOrDefault();

                    if (head != null)
                        result.Insert(0, head);
                }
            }

            return result;
        }

        public List<TimeScheduleTemplateHead> GetTimeScheduleTemplateHeadsForEmployee(CompEntities entities, int actorCompanyId, int employeeId, DateTime dateLimit)
        {
            return (from h in entities.TimeScheduleTemplateHead
                    where h.ActorCompanyId == actorCompanyId &&
                    h.EmployeeId == employeeId &&
                    h.StartDate.HasValue && h.StartDate <= dateLimit &&
                    h.State == (int)SoeEntityState.Active
                    orderby h.StartDate descending
                    select h).ToList();
        }

        public List<string> GetOverlappingTemplates(int actorCompanyId, int employeeId, DateTime date)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<TimeScheduleTemplateHead> templates = (from t in entitiesReadOnly.TimeScheduleTemplateHead
                                                        where t.ActorCompanyId == actorCompanyId &&
                                                        t.EmployeeId == employeeId &&
                                                        t.StartDate.HasValue && t.StartDate.Value <= date &&
                                                        (!t.StopDate.HasValue || t.StopDate.Value >= date) &&
                                                        t.State == (int)SoeEntityState.Active
                                                        orderby t.StartDate descending
                                                        select t).ToList();

            string week = GetText(86, 1002, "v");

            List<string> strings = new List<string>();
            foreach (var template in templates)
            {
                strings.Add(String.Format("{0}, {1} {2}, {3}", template.StartDate.ToShortDateString(), (template.NoOfDays / 7), week, template.Name));
            }

            return strings;
        }

        /// <summary>
        /// Get TimeScheduleTemplateHead with latest start date for specified employee
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="dateLimit">Limits the start date to be less or equal to specified date</param>
        /// <returns></returns>
        public TimeScheduleTemplateHead GetTimeScheduleTemplateHeadForEmployee(int actorCompanyId, int employeeId, DateTime dateLimit, bool onlyOngoing = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            return GetTimeScheduleTemplateHeadForEmployee(entities, actorCompanyId, employeeId, dateLimit, onlyOngoing);
        }

        public TimeScheduleTemplateHead GetTimeScheduleTemplateHeadForEmployee(CompEntities entities, int actorCompanyId, int employeeId, DateTime dateLimit, bool onlyOngoing = false)
        {
            IQueryable<TimeScheduleTemplateHead> query = (from h in entities.TimeScheduleTemplateHead
                                                          where h.ActorCompanyId == actorCompanyId &&
                                                          h.EmployeeId == employeeId &&
                                                          h.StartDate.HasValue && h.StartDate <= dateLimit &&
                                                          h.State == (int)SoeEntityState.Active
                                                          orderby h.StartDate descending
                                                          select h);


            if (onlyOngoing)
                query = query.Where(h => !h.StopDate.HasValue || h.StopDate.Value >= dateLimit);

            TimeScheduleTemplateHead head = query.FirstOrDefault();

            return head;
        }

        public TimeScheduleTemplateHead GetEmployeeTimeScheduleTemplateHeadForEmployeePost(int employeePostId, bool onlyWithEmployee, bool loadReferences)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            return GetEmployeeTimeScheduleTemplateHeadForEmployeePost(entities, employeePostId, onlyWithEmployee, loadReferences);
        }

        public TimeScheduleTemplateHead GetEmployeeTimeScheduleTemplateHeadForEmployeePost(CompEntities entities, int employeePostId, bool onlyWithEmployee, bool loadReferences)
        {
            if (loadReferences)
            {
                return (from th in entities.TimeScheduleTemplateHead
                        .Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateBlock.TimeScheduleTemplateBlockTask")
                        where th.EmployeePostId == employeePostId &&
                        (!onlyWithEmployee || th.EmployeeId.HasValue) &&
                        th.State == (int)SoeEntityState.Active
                        select th).FirstOrDefault();
            }
            else
            {
                return (from th in entities.TimeScheduleTemplateHead
                        where th.EmployeePostId == employeePostId &&
                        (!onlyWithEmployee || th.EmployeeId.HasValue) &&
                        th.State == (int)SoeEntityState.Active
                        select th).FirstOrDefault();
            }
        }

        public TimeScheduleTemplateHead GetTimeScheduleTemplateHead(int timeScheduleTemplateHeadId, int actorCompanyId, bool onlyActive)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            return GetTimeScheduleTemplateHead(entities, timeScheduleTemplateHeadId, actorCompanyId, onlyActive);
        }

        public TimeScheduleTemplateHead GetTimeScheduleTemplateHead(CompEntities entities, int timeScheduleTemplateHeadId, int actorCompanyId, bool onlyActive)
        {
            return (from th in entities.TimeScheduleTemplateHead
                    where th.ActorCompanyId == actorCompanyId &&
                    th.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId &&
                    ((onlyActive && th.State == (int)SoeEntityState.Active) || th.State != (int)SoeEntityState.Deleted)
                    select th).FirstOrDefault();
        }

        public bool TimeScheduleTemplateHeadsExists(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateHead.NoTracking();
            return (from t in entities.TimeScheduleTemplateHead
                    where t.Company.ActorCompanyId == actorCompanyId &&
                    t.State == (int)SoeEntityState.Active
                    select t).Any();
        }

        public ActionResult UpdateTimeScheduleTemplateHeadsState(Dictionary<int, bool> heads, int actorCompanyId)
        {
            using (CompEntities entities = new CompEntities())
            {
                foreach (KeyValuePair<int, bool> head in heads)
                {
                    TimeScheduleTemplateHead originalTimeRule = GetTimeScheduleTemplateHead(entities, head.Key, actorCompanyId, false);
                    if (originalTimeRule == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, "TimeScheduleTemplateHead");

                    ChangeEntityState(originalTimeRule, head.Value ? SoeEntityState.Active : SoeEntityState.Inactive);
                }

                return SaveChanges(entities);
            }
        }

        public List<TimeScheduleTemplateHeadSmallDTO> GetOngoingTimeScheduleTemplateHeads(int actorCompanyId, Dictionary<int, DateTime> input)
        {
            List<TimeScheduleTemplateHeadSmallDTO> heads = new List<TimeScheduleTemplateHeadSmallDTO>();

            foreach (KeyValuePair<int, DateTime> item in input)
            {
                TimeScheduleTemplateHead head = GetTimeScheduleTemplateHeadForEmployee(actorCompanyId, item.Key, item.Value, true);
                if (head != null)
                    heads.Add(head.ToSmallDTO());
            }

            return heads;
        }

        public ActionResult SetStopDateOnTimeScheduleTemplateHeads(int actorCompanyId, Dictionary<int, DateTime> input)
        {
            using (CompEntities entities = new CompEntities())
            {
                foreach (KeyValuePair<int, DateTime> item in input)
                {
                    TimeScheduleTemplateHead head = GetTimeScheduleTemplateHeadForEmployee(entities, actorCompanyId, item.Key, item.Value, true);
                    if (head != null && head.StartDate < item.Value)
                        head.StopDate = item.Value.AddDays(-1).Date;
                }

                return SaveChanges(entities);
            }
        }

        public TimeScheduleTemplateHead GetCompanyZeroTemplateHead(CompEntities entities, int actorCompanyId)
        {
            var heads = entities.TimeScheduleTemplateHead.Where(w => w.ActorCompanyId == actorCompanyId && !w.EmployeeId.HasValue && w.State == (int)SoeEntityState.Active).ToList();

            foreach (var head in heads)
            {
                head.TimeScheduleTemplatePeriod.Load();
                bool onlyZeroDays = true;
                foreach (var period in head.TimeScheduleTemplatePeriod.Where(w => w.State == (int)SoeEntityState.Active))
                {
                    if (!onlyZeroDays)
                        continue;

                    period.TimeScheduleTemplateBlock.Load();
                    foreach (var block in period.TimeScheduleTemplateBlock.Where(w => !w.EmployeeId.HasValue))
                    {
                        if (onlyZeroDays && block.StartTime != block.StopTime)
                            onlyZeroDays = false;
                    }
                }

                if (onlyZeroDays)
                    return head;
            }

            return null;
        }

        #endregion

        #region TimeScheduleTemplatePeriod

        public List<TimeScheduleTemplatePeriod> GetTimeScheduleTemplatePeriodsForCompany(int actorCompanyId, bool loadBlocksAndHeadAndSchedule)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplatePeriod.NoTracking();
            return GetTimeScheduleTemplatePeriodsForCompany(entities, actorCompanyId, loadBlocksAndHeadAndSchedule);
        }

        public List<TimeScheduleTemplatePeriod> GetTimeScheduleTemplatePeriodsForCompany(CompEntities entities, int actorCompanyId, bool loadBlocksAndHeadAndSchedule)
        {
            if (loadBlocksAndHeadAndSchedule)
            {
                return (from t in entities.TimeScheduleTemplatePeriod
                            .Include("TimeScheduleTemplateBlock")
                            .Include("TimeScheduleTemplateHead")
                            .Include("TimeScheduleTemplateHead.EmployeeSchedule")
                        where t.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                        t.State == (int)SoeEntityState.Active
                        orderby t.DayNumber
                        select t).ToList();
            }
            else
            {
                return (from t in entities.TimeScheduleTemplatePeriod
                        where t.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId
                        orderby t.DayNumber
                        select t).ToList();
            }
        }

        public List<TimeScheduleTemplatePeriod> GetTimeScheduleTemplatePeriods(int timeScheduleTemplateHeadId, bool loadBlocks)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplatePeriod.NoTracking();
            return GetTimeScheduleTemplatePeriods(entities, timeScheduleTemplateHeadId, loadBlocks);
        }

        public List<TimeScheduleTemplatePeriod> GetTimeScheduleTemplatePeriods(CompEntities entities, int timeScheduleTemplateHeadId, bool loadBlocks)
        {
            if (loadBlocks)
            {
                return (from t in entities.TimeScheduleTemplatePeriod
                            .Include("TimeScheduleTemplateBlock")
                        where t.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId &&
                        t.State == (int)SoeEntityState.Active
                        orderby t.DayNumber
                        select t).ToList();
            }
            else
            {
                return (from t in entities.TimeScheduleTemplatePeriod
                        where t.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId &&
                        t.State == (int)SoeEntityState.Active
                        orderby t.DayNumber
                        select t).ToList();
            }
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod(int timeScheduleTemplatePeriodId, bool onlyActive, bool loadBlocks)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplatePeriod.NoTracking();
            return GetTimeScheduleTemplatePeriod(entities, timeScheduleTemplatePeriodId, onlyActive, loadBlocks);
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod(CompEntities entities, int timeScheduleTemplatePeriodId, bool onlyActive, bool loadBlocks)
        {
            TimeScheduleTemplatePeriod templatePeriod = (from t in entities.TimeScheduleTemplatePeriod
                                                         where t.TimeScheduleTemplatePeriodId == timeScheduleTemplatePeriodId
                                                         select t).FirstOrDefault();

            if (templatePeriod == null || (onlyActive && templatePeriod.State != (int)SoeEntityState.Active))
                return null;

            if (loadBlocks && !templatePeriod.TimeScheduleTemplateBlock.IsLoaded)
                templatePeriod.TimeScheduleTemplateBlock.Load();

            return templatePeriod;
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod(int employeeId, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplatePeriod.NoTracking();
            return GetTimeScheduleTemplatePeriod(entities, employeeId, date);
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod(CompEntities entities, int employeeId, DateTime date, EmployeeSchedule employeeSchedule = null)
        {
            TimeScheduleTemplatePeriod templatePeriod = null;

            // Get employee schedule for specified employee and date
            if (employeeSchedule == null)
                employeeSchedule = GetEmployeeSchedule(entities, date, employeeId, true);
            if (employeeSchedule != null)
                templatePeriod = GetTimeScheduleTemplatePeriod(entities, employeeSchedule, date);

            return templatePeriod;
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod(EmployeeSchedule employeeSchedule, DateTime date)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplatePeriod.NoTracking();
            return GetTimeScheduleTemplatePeriod(entities, employeeSchedule, date);
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod(CompEntities entities, EmployeeSchedule employeeSchedule, DateTime date)
        {
            TimeScheduleTemplatePeriod templatePeriodTemplate = null;
            if (employeeSchedule == null || employeeSchedule.TimeScheduleTemplateHead == null)
                return templatePeriodTemplate;

            //Make sure TimeScheduleTemplatePeriod is loaded
            if (!employeeSchedule.TimeScheduleTemplateHead.TimeScheduleTemplatePeriod.IsLoaded)
                employeeSchedule.TimeScheduleTemplateHead.TimeScheduleTemplatePeriod.Load();

            int dayNumber = CalendarUtility.GetScheduleDayNumber(date, employeeSchedule.StartDate, employeeSchedule.StartDayNumber, employeeSchedule.TimeScheduleTemplateHead.NoOfDays);

            //Get all TimeScheduleTemplatePeriod's for daynumber
            List<TimeScheduleTemplatePeriod> templatePeriods = (from p in employeeSchedule.TimeScheduleTemplateHead.TimeScheduleTemplatePeriod
                                                                where p.DayNumber == dayNumber &&
                                                                p.State == (int)SoeEntityState.Active
                                                                select p).ToList();

            //Find the TimeScheduleTemplatePeriod that is template
            foreach (TimeScheduleTemplatePeriod templatePeriod in templatePeriods)
            {
                var scheduleTemplateBlock = (from tb in entities.TimeScheduleTemplateBlock
                                             where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                             tb.TimeScheduleTemplatePeriodId == templatePeriod.TimeScheduleTemplatePeriodId &&
                                             !tb.EmployeeId.HasValue &&
                                             tb.State == (int)SoeEntityState.Active
                                             select tb).FirstOrDefault();

                if (scheduleTemplateBlock != null)
                {
                    //Found the TimeScheduleTemplatePeriod thas is template
                    templatePeriodTemplate = templatePeriod;
                    break;
                }
            }

            return templatePeriodTemplate;
        }

        public TimeScheduleTemplatePeriod GetTimeScheduleTemplatePeriod<T>(DateTime date, EmployeeSchedule employeeSchedule, IEnumerable<T> scheduleItems) where T : IScheduleBlockObject
        {
            if (employeeSchedule == null)
                return null;

            List<TimeScheduleTemplatePeriod> templatePeriods = employeeSchedule.TimeScheduleTemplateHead?.TimeScheduleTemplatePeriod.Where(i => i.State == (int)SoeEntityState.Active).ToList();
            if (templatePeriods.IsNullOrEmpty())
                return null;

            TimeScheduleTemplatePeriod templatePeriod = null;

            int templatePeriodId = scheduleItems?.FirstOrDefault(i => i.TimeScheduleTemplatePeriodId.HasValue)?.TimeScheduleTemplatePeriodId ?? 0;
            if (templatePeriodId > 0)
            {
                templatePeriod = templatePeriods.FirstOrDefault(i => i.TimeScheduleTemplatePeriodId == templatePeriodId);
            }
            else
            {
                int dayNumber = CalendarUtility.GetScheduleDayNumber(date, employeeSchedule.StartDate, employeeSchedule.StartDayNumber, employeeSchedule.TimeScheduleTemplateHead.NoOfDays);
                templatePeriod = templatePeriods.FirstOrDefault(i => i.DayNumber == dayNumber);
            }

            return templatePeriod;
        }

        public bool AllScheduleTemplatesHasPeriods(int actorCompanyId)
        {
            var scheduleTemplates = GetTimeScheduleTemplateHeads(actorCompanyId, false, false, false, false);
            if (scheduleTemplates.IsNullOrEmpty())
                return false;

            foreach (var scheduleTemplate in scheduleTemplates)
            {
                bool periodsExists = TimeScheduleTemplatePeriodExists(scheduleTemplate.TimeScheduleTemplateHeadId);
                if (!periodsExists)
                    return false;
            }

            return true;
        }

        public bool TimeScheduleTemplatePeriodExists(int timeScheduleTemplateHeadId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplatePeriod.NoTracking();
            return (from t in entities.TimeScheduleTemplatePeriod
                    where t.TimeScheduleTemplateHeadId == timeScheduleTemplateHeadId &&
                    t.State == (int)SoeEntityState.Active
                    select t).Any();

        }

        #endregion

        #region TimeScheduleTemplateBlock

        public List<TimeScheduleTemplateBlock> GetShifts(int employeeId, List<DateTime> dates)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                    where !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.EmployeeId.HasValue && tb.EmployeeId == employeeId &&
                    tb.Date.HasValue && dates.Contains(tb.Date.Value) &&
                    tb.StartTime != tb.StopTime &&
                    tb.State == (int)SoeEntityState.Active
                    select tb).ToList();
        }

        public List<TimeSchedulePlanningDayDTO> GetShifts(int actorCompanyId, int employeeId, int shiftId, int? timeScheduleScenarioHeadId, bool includeLinkedShifts, bool getAllshifts, int timeDeviationCauseId)
        {
            TimeDeviationCause deviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(timeDeviationCauseId, actorCompanyId);
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            List<TimeScheduleTemplateBlock> shifts = new List<TimeScheduleTemplateBlock>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTemplateBlock.NoTracking();
            entitiesReadOnly.ShiftType.NoTracking();
            entitiesReadOnly.Employee.NoTracking();
            entitiesReadOnly.ContactPerson.NoTracking();

            TimeScheduleTemplateBlock shift = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                    .Include("ShiftType")
                                    .Include("Employee.ContactPerson")
                                               where (tb.TimeScheduleTemplateBlockId == shiftId)
                                               select tb).FirstOrDefault();

            if (shift != null)
            {
                if (getAllshifts)
                {
                    shifts = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                .Include("ShiftType")
                                .Include("Employee.ContactPerson")
                              where (tb.EmployeeId == employeeId &&
                              tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                              tb.TimeScheduleEmployeePeriod != null &&
                              tb.Date.HasValue && DbFunctions.TruncateTime(tb.Date.Value) == shift.Date.Value &&
                              tb.StartTime != tb.StopTime &&
                              tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                              tb.State == (int)SoeEntityState.Active &&
                              !tb.TimeDeviationCauseId.HasValue
                              select tb).ToList();

                    shifts = shifts.FilterScenario(timeScheduleScenarioHeadId);

                }
                else
                {
                    if (includeLinkedShifts && !shift.TimeDeviationCauseId.HasValue)
                    {
                        List<TimeScheduleTemplateBlock> allShifts = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                                                        .Include("ShiftType")
                                                                        .Include("Employee.ContactPerson")
                                                                     where (tb.EmployeeId == employeeId &&
                                                                     tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                                                                     tb.TimeScheduleEmployeePeriod != null &&
                                                                     tb.Date.HasValue && DbFunctions.TruncateTime(tb.Date.Value) == shift.Date.Value &&
                                                                     tb.StartTime != tb.StopTime &&
                                                                     tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                                     tb.State == (int)SoeEntityState.Active &&
                                                                     !tb.TimeDeviationCauseId.HasValue
                                                                     select tb).ToList();

                        allShifts = allShifts.FilterScenario(timeScheduleScenarioHeadId);

                        List<TimeScheduleTemplateBlock> linkedShifts = allShifts.Where(x => x.Link == shift.Link).ToList();
                        if (deviationCause != null && deviationCause.HasAttachZeroDaysNbrOfDaySetting && linkedShifts.Count == allShifts.Count)
                        {
                            shifts.AddRange(GetShiftsAffectedByIntervall(entitiesReadOnly, actorCompanyId, employeeId, timeScheduleScenarioHeadId, shift.Date.Value, CalendarUtility.GetEndOfDay(shift.Date.Value), false, deviationCause.ShowZeroDaysInAbsencePlanning, false, out _, out _, deviationCause.TimeDeviationCauseId));
                        }
                        else
                        {
                            shifts.AddRange(linkedShifts);
                        }
                    }
                    else
                    {
                        if (!shift.TimeDeviationCauseId.HasValue)
                            shifts.Add(shift);
                    }
                }
            }

            // Convert to DTO
            foreach (var block in shifts.OrderBy(b => b.EmployeeId).ThenBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                dtos.Add(CreateTimeSchedulePlanningDayDTO(block, actorCompanyId, 0, dontChangeTimeOnZeroDays: true));
            }

            foreach (var item in dtos)
            {
                item.AbsenceStartTime = item.StartTime;
                item.AbsenceStopTime = item.StopTime;
            }

            return dtos;
        }

        public List<TimeSchedulePlanningDayDTO> GetShiftsForAbsence(int actorCompanyId, int employeeId, List<int> shiftIds, bool includeLinkedShifts, int? timeScheduleScenarioHeadId)
        {
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            List<TimeScheduleTemplateBlock> shifts = new List<TimeScheduleTemplateBlock>();

            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            List<TimeScheduleTemplateBlock> selectedShifts = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                                                        .Include("ShiftType")
                                                                        .Include("Employee.ContactPerson")
                                                                         where (tb.EmployeeId == employeeId &&
                                                                         tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                                                                         tb.TimeScheduleEmployeePeriod != null &&
                                                                         //tb.Date.HasValue && DbFunctions.TruncateTime(tb.Date.Value) == firstShift.Date.Value &&
                                                                         tb.StartTime != tb.StopTime &&
                                                                         tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                                         tb.State == (int)SoeEntityState.Active &&
                                                                         !tb.TimeDeviationCauseId.HasValue &&
                                                                         shiftIds.Contains(tb.TimeScheduleTemplateBlockId)
                                                                         select tb).ToList();


            TimeScheduleTemplateBlock firstShift = selectedShifts.FirstOrDefault();

            if (firstShift == null || !firstShift.Date.HasValue)
                return dtos;

            var baseDate = firstShift.Date.Value.Date;
            var selectedShiftsSameDay = selectedShifts
                .Where(tb => tb.Date.HasValue && tb.Date.Value.Date == baseDate)
                .ToList();

            //List<TimeScheduleTemplateBlock> selectedShiftsSameDay = selectedShifts.Where(tb => tb.Date.HasValue && DbFunctions.TruncateTime(tb.Date.Value) == firstShift.Date.Value).ToList();

    
            if (selectedShiftsSameDay.Count > 0)
            {
                if (includeLinkedShifts && firstShift.Link != null)
                {
                      var linkedShifts = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                                .Include("ShiftType")
                                                .Include("Employee.ContactPerson")
                                        where tb.EmployeeId == employeeId
                                              && tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId
                                              && tb.TimeScheduleEmployeePeriod != null
                                              && tb.Date.HasValue && DbFunctions.TruncateTime(tb.Date.Value) == baseDate
                                              && tb.StartTime != tb.StopTime
                                              && tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None
                                              && tb.State == (int)SoeEntityState.Active
                                              && !tb.TimeDeviationCauseId.HasValue
                                              && tb.Link == firstShift.Link
                                        select tb).ToList().FilterScenario(timeScheduleScenarioHeadId);

                    shifts.AddRange(linkedShifts);

                    //if (deviationCause != null && deviationCause.HasAttachZeroDaysNbrOfDaySetting && linkedShifts.Count == allShifts.Count)
                    //{
                    //    shifts.AddRange(GetShiftsAffectedByIntervall(CompEntitiesReadOnly, actorCompanyId, employeeId, timeScheduleScenarioHeadId, shift.Date.Value, CalendarUtility.GetEndOfDay(shift.Date.Value), false, deviationCause.ShowZeroDaysInAbsencePlanning, false, out _, out _, deviationCause.TimeDeviationCauseId));
                    //}
                    //else
                    //{
                    //    shifts.AddRange(linkedShifts);
                    //}

                }
                else
                {
                    selectedShiftsSameDay = selectedShiftsSameDay.FilterScenario(timeScheduleScenarioHeadId);
                    shifts.AddRange(selectedShiftsSameDay);
                }
            }


            // Convert to DTO
            foreach (var block in shifts.OrderBy(b => b.EmployeeId).ThenBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                dtos.Add(CreateTimeSchedulePlanningDayDTO(block, actorCompanyId, 0, dontChangeTimeOnZeroDays: true));
            }

            foreach (var item in dtos)
            {
                item.AbsenceStartTime = item.StartTime;
                item.AbsenceStopTime = item.StopTime;
            }

            return dtos;

        }

        public List<TimeSchedulePlanningDayDTO> GetTemplateShiftsForEmployeePost(int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, bool loadYesterdayAlso, List<int> employeePostIds, bool loadTasksAndDelivery)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTemplateShiftsForEmployeePost(entities, actorCompanyId, roleId, userId, dateFrom, dateTo, loadYesterdayAlso, employeePostIds, loadTasksAndDelivery);
        }

        public List<TimeSchedulePlanningDayDTO> GetTemplateShiftsForEmployeePost(CompEntities entities, int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, bool loadYesterdayAlso, List<int> employeePostIds, bool loadTasksAndDelivery)
        {
            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            ConcurrentBag<TimeSchedulePlanningDayDTO> result = new ConcurrentBag<TimeSchedulePlanningDayDTO>();

            int currentEmployeeId = EmployeeManager.GetEmployeeIdForUser(entities, userId, actorCompanyId);

            // If not filtered on employee post, get all employee posts
            if (employeePostIds == null)
                employeePostIds = GetEmployeePosts(entities, actorCompanyId, true, false, false, false).Select(s => s.EmployeePostId).ToList();

            // Get latest template that starts before current interval ends, for each employee
            List<GetLatestScheduleTemplateForEmployeePosts_Result> heads = entities.GetLatestScheduleTemplateForEmployeePosts(actorCompanyId, dateTo).ToList();

            Parallel.ForEach(employeePostIds, GetDefaultParallelOptions(), employeePostId =>
            {
                using (CompEntities pEntities = new CompEntities())
                {
                    GetLatestScheduleTemplateForEmployeePosts_Result head = heads.FirstOrDefault(h => h.EmployeePostId == employeePostId);
                    if (head != null)
                    {
                        List<TimeSchedulePlanningDayDTO> templates = GetTimeSchedulePlanningTemplate(pEntities, actorCompanyId, roleId, userId, currentEmployeeId, head.TimeScheduleTemplateHeadId, dateFrom, dateTo, false, loadYesterdayAlso, loadTasksAndDelivery);
                        foreach (TimeSchedulePlanningDayDTO template in templates)
                        {
                            result.Add(template);
                        }
                    }
                }
            });

            return result.ToList();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleShiftBreaks(int timeScheduleEmployeePeriodId, int? timeScheduleScenarioHeadId, string link = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            var shifts = (from tb in entities.TimeScheduleTemplateBlock
                          where tb.TimeScheduleEmployeePeriodId == timeScheduleEmployeePeriodId &&
                          tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                          tb.Date.HasValue &&
                          tb.State == (int)SoeEntityState.Active &&
                          (String.IsNullOrEmpty(link) || tb.Link == link)
                          select tb).ToList();

            shifts = shifts.FilterScenario(timeScheduleScenarioHeadId);
            return shifts.OrderBy(o => o.StartTime).ToList();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocks(CompEntities entities, int employeeId, DateTime dateFrom, DateTime? dateTo = null, bool includeBreaks = false, bool includePrel = true)
        {
            List<TimeScheduleTemplateBlock> scheduleBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                                              where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                              tb.EmployeeId == employeeId &&
                                                              tb.Date >= dateFrom.Date &&
                                                              (!dateTo.HasValue || tb.Date <= dateTo.Value) &&
                                                              tb.State == (int)SoeEntityState.Active &&
                                                              (includeBreaks || tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None)
                                                              select tb).ToList();

            if (!includePrel)
                scheduleBlocks = scheduleBlocks.Where(i => i.IsBreak || !i.IsPreliminary).ToList();

            return scheduleBlocks;
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForPeriod(CompEntities entities, int employeeId, DateTime date, int? timeScheduleScenarioHeadId = null)
        {
            IQueryable<TimeScheduleTemplateBlock> query = (from tb in entities.TimeScheduleTemplateBlock.Include("ShiftType")
                                                           where tb.EmployeeId == employeeId &&
                                                           tb.Date == date &&
                                                           tb.State == (int)SoeEntityState.Active
                                                           select tb);

            List<TimeScheduleTemplateBlock> templateBlocks = query.ToList();
            templateBlocks = templateBlocks.FilterScenario(timeScheduleScenarioHeadId);
            return templateBlocks;
        }
        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksFromPeriods(CompEntities entities, int employeeId, List<int> periodIds, bool loadZeroDays = false)
        {
            IQueryable<TimeScheduleTemplateBlock> query = (from tb in entities.TimeScheduleTemplateBlock
                                                           where tb.EmployeeId == employeeId &&
                                                           tb.TimeScheduleTemplatePeriodId.HasValue && periodIds.Contains(tb.TimeScheduleTemplatePeriodId.Value) &&
                                                           tb.Date == null &&
                                                           (loadZeroDays || tb.StartTime != tb.StopTime) &&
                                                           tb.State == (int)SoeEntityState.Active
                                                           select tb);

            return query.ToList();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForAccounts(List<int> employeeIds, DateTime dateFrom, DateTime dateTo, List<int> accountIds, int? timeScheduleScenarioHeadId = null)
        {
            if (employeeIds.IsNullOrEmpty())
                return new List<TimeScheduleTemplateBlock>();

            dateFrom = dateFrom.Date;
            dateTo = dateTo.Date;

            if (timeScheduleScenarioHeadId == 0)
                timeScheduleScenarioHeadId = null;

            int batchSize = 800;
            int numberOfDays = (dateTo - dateFrom).Days + 1;

            if (numberOfDays > 100)
                batchSize = 200;
            else if (numberOfDays > 50)
                batchSize = 400;
            else if (numberOfDays > 20)
                batchSize = 600;
            else if (numberOfDays > 10)
                batchSize = 700;

            BatchHelper batchHelper = BatchHelper.Create(employeeIds, batchSize);
            List<TimeScheduleTemplateBlock> templateBlocks = new List<TimeScheduleTemplateBlock>();
            while (batchHelper.HasMoreBatches())
            {
                var employeesInBatch = batchHelper.GetCurrentBatchIds();
                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                entities.TimeScheduleTemplateBlock.NoTracking();
                IQueryable<TimeScheduleTemplateBlock> query = (from tb in entities.TimeScheduleTemplateBlock
                                                               .Include("AccountInternal")
                                                               where tb.EmployeeId.HasValue &&
                                                               employeesInBatch.Contains(tb.EmployeeId.Value) &&
                                                               tb.Date >= dateFrom && tb.Date <= dateTo &&
                                                               tb.State == (int)SoeEntityState.Active
                                                               select tb);

                List<TimeScheduleTemplateBlock> templateBlocksInBatch = query.ToList();
                templateBlocksInBatch = templateBlocksInBatch.FilterScenario(timeScheduleScenarioHeadId);
                templateBlocks.AddRange(templateBlocksInBatch);
                batchHelper.MoveToNextBatch();
            }
            return templateBlocks;
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForDay(int employeeId, DateTime date, bool excludeBreaks = false, int? timeScheduleScenarioHeadId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return GetTimeScheduleTemplateBlocksForDay(entities, employeeId, date, excludeBreaks, timeScheduleScenarioHeadId);
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForDay(CompEntities entities, int employeeId, DateTime date, bool excludeBreaks = false, int? timeScheduleScenarioHeadId = null)
        {
            IQueryable<TimeScheduleTemplateBlock> query = (from tb in entities.TimeScheduleTemplateBlock
                                                           where tb.EmployeeId == employeeId &&
                                                           tb.Date == date &&
                                                           tb.State == (int)SoeEntityState.Active
                                                           select tb);

            if (excludeBreaks)
                query = query.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None);

            List<TimeScheduleTemplateBlock> templateBlocks = query.ToList();
            templateBlocks = templateBlocks.FilterScenario(timeScheduleScenarioHeadId);
            return templateBlocks;
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForEmployees(CompEntities entities, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, bool includeBlockAccount = false, int? timeScheduleScenarioHeadId = null)
        {
            GetDataInBatchesModel model = GetDataInBatchesModel.Create(entities, base.ActorCompanyId, employeeIds, dateFrom, dateTo);
            int? forceLength = Constants.LINQMAXCOUNTCONTAINS;

            List<TimeScheduleTemplateBlock> templateBlocks = null;
            if (includeBlockAccount)
                templateBlocks = base.GetEmployeeDataInBatches(model, GetTimeScheduleTemplateBlocksForEmployeesWithAccountInternal, forceLength);
            else
                templateBlocks = base.GetEmployeeDataInBatches(model, GetTimeScheduleTemplateBlocksForEmployees, forceLength);

            templateBlocks = templateBlocks.FilterScenario(timeScheduleScenarioHeadId);

            return templateBlocks;
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForEmployees(GetDataInBatchesModel model)
        {
            if (!model.IsValid())
                return new List<TimeScheduleTemplateBlock>();

            return GetTimeScheduleTemplateBlocksQuery(model).ToList();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForEmployeesWithAccountInternal(GetDataInBatchesModel model)
        {
            if (!model.IsValid())
                return new List<TimeScheduleTemplateBlock>();

            return GetTimeScheduleTemplateBlocksQuery(model).Include("AccountInternal").ToList();
        }

        public IQueryable<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksQuery(GetDataInBatchesModel model)
        {
            return from tb in model.Entities.TimeScheduleTemplateBlock
                   where (tb.EmployeeId.HasValue && model.BatchIds.Contains(tb.EmployeeId.Value)) &&
                   tb.Date >= model.StartDate && tb.Date <= model.StopDate &&
                   tb.State == (int)SoeEntityState.Active
                   select tb;
        }

        public List<TimeScheduleTemplateBlockSmallDTO> GetTimeScheduleTemplateBlocksSmall(GetDataInBatchesModel model)
        {
            if (!model.IsValid())
                return new List<TimeScheduleTemplateBlockSmallDTO>();

            return (from tb in model.Entities.TimeScheduleTemplateBlock
                    where tb.EmployeeId.HasValue &&
                    model.BatchIds.Contains(tb.EmployeeId.Value) &&
                    tb.Date.HasValue &&
                    tb.Date.Value >= model.StartDate &&
                    tb.Date.Value <= model.StopDate &&
                    tb.StartTime < tb.StopTime &&
                    tb.State == (int)SoeEntityState.Active
                    select new TimeScheduleTemplateBlockSmallDTO
                    {
                        EmployeeId = tb.EmployeeId,
                        Date = tb.Date,
                        StartTime = tb.StartTime,
                        StopTime = tb.StopTime,
                        IsBreak = tb.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None,
                        AccountId = tb.AccountId,
                        TimeCodeId = tb.TimeCodeId,
                        TimeScheduleScenarioHeadId = tb.TimeScheduleScenarioHeadId,
                        Type = tb.Type,
                    }).ToList();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForEmployees(CompEntities entities, List<int> employeeIds, bool excludeBreaks = false)
        {
            var scheduleBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                  where (tb.EmployeeId.HasValue && employeeIds.Contains(tb.EmployeeId.Value)) &&
                                  (excludeBreaks || tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None) &&
                                  tb.State == (int)SoeEntityState.Active
                                  select tb).ToList();

            return scheduleBlocks.Where(w => !w.TimeScheduleScenarioHeadId.HasValue).ToList();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocks(List<int> timeScheduleTemplateBlockIds, int employeeId, bool includeShiftType)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTemplateBlock.NoTracking();
            IQueryable<TimeScheduleTemplateBlock> query = entitiesReadOnly.TimeScheduleTemplateBlock;
            if (includeShiftType)
                query = query.Include("ShiftType");

            return (from b in query
                    where timeScheduleTemplateBlockIds.Contains(b.TimeScheduleTemplateBlockId) &&
                    b.EmployeeId.HasValue && b.EmployeeId == employeeId &&
                    b.State == (int)SoeEntityState.Active
                    select b).ToList();
        }

        public List<TimeScheduleTemplateBlock> GetAllActiveTimeScheduleTemplateBlocks(int employeeId, DateTime dateFrom, DateTime dateTo)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return (from tb in entities.TimeScheduleTemplateBlock
                    where !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.EmployeeId == employeeId &&
                    tb.Date >= dateFrom.Date && tb.Date <= dateTo.Date &&
                    tb.StartTime != tb.StopTime &&
                    tb.State == (int)SoeEntityState.Active
                    select tb).ToList();
        }

        public List<TimeScheduleTemplateBlock> GetAllActiveTimeScheduleTemplateBlocks(List<int> employeeIds, DateTime dateFrom, DateTime dateTo)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            var scheduleBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                  where tb.EmployeeId.HasValue && employeeIds.Contains(tb.EmployeeId.Value) &&
                                  tb.Date >= dateFrom.Date && tb.Date <= dateTo.Date &&
                                  tb.StartTime != tb.StopTime &&
                                  tb.State == (int)SoeEntityState.Active
                                  select tb).ToList();

            scheduleBlocks = scheduleBlocks.FilterScenario(null);
            return scheduleBlocks;
        }

        public List<TimeScheduleTemplateBlock> GetLinkedTimeScheduleTemplateBlocks(int? timeScheduleScenarioHeadId, int actorCompanyId, int timeScheduleTemplateBlockId, bool includeShiftTypes = false)
        {
            TimeScheduleTemplateBlock scheduleBlock = GetTimeScheduleTemplateBlock(timeScheduleTemplateBlockId);
            if (scheduleBlock == null)
                return new List<TimeScheduleTemplateBlock>();

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTemplateBlock.NoTracking();
            IQueryable<TimeScheduleTemplateBlock> query = entitiesReadOnly.TimeScheduleTemplateBlock;
            if (includeShiftTypes)
                query = query.Include("ShiftType");

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            if (useAccountHierarchy)
                query = query.Include("Account");

            List<TimeScheduleTemplateBlock> linkedScheduleBlocks = (from tb in query
                                                                    where (tb.EmployeeId == scheduleBlock.EmployeeId &&
                                                                    tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                                                                    tb.TimeScheduleEmployeePeriod != null &&
                                                                    tb.StartTime != tb.StopTime &&
                                                                    tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                                                    tb.State == (int)SoeEntityState.Active &&
                                                                    tb.Link == scheduleBlock.Link &&
                                                                    !tb.TimeDeviationCauseId.HasValue
                                                                    select tb).ToList();

            linkedScheduleBlocks = linkedScheduleBlocks.FilterScenario(timeScheduleScenarioHeadId);

            // Set actual dates
            foreach (var block in linkedScheduleBlocks)
            {
                block.StartTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((block.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), block.StartTime);
                block.StopTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((block.StopTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), block.StopTime);
            }

            return linkedScheduleBlocks;
        }

        /// <summary>
        /// Get all schedule blocks during a period to be shown on TimeSpot Terminal
        /// </summary>
        /// <param name="entities">CompEntities</param>
        /// <param name="employeeId">The employee having the schedule</param>
        /// <param name="startDate">Inclusive start date</param>
        /// <param name="stopDate">Inclusive stop date</param>
        /// <param name="SyncDate">DateTime of last sync on Terminal</param>
        /// <returns>Enumerable of schedule blocks</returns>
        public List<TimeScheduleTemplateBlock> GetEmployeeScheduleDaysforTerminal(int? employeeId, DateTime startDate, DateTime stopDate, DateTime syncTime, int actorCompanyId)
        {
            // Get all unique blocks
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTemplateBlock.NoTracking();
            List<TimeScheduleTemplateBlock> templateBlocks =
                employeeId.HasValue ?
                    (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                     where !tb.TimeScheduleScenarioHeadId.HasValue &&
                     tb.Employee.ActorCompanyId == actorCompanyId &&
                     tb.EmployeeId.HasValue &&
                     tb.EmployeeId == employeeId &&
                     tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                     (tb.Created >= syncTime || tb.Modified >= syncTime) &&
                     tb.Date.HasValue && tb.Date.Value >= startDate &&
                     tb.Date.Value <= stopDate && tb.StartTime != tb.StopTime
                     select tb).ToList()
                     :
                    (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                     where !tb.TimeScheduleScenarioHeadId.HasValue &&
                     tb.Employee.ActorCompanyId == actorCompanyId &&
                     tb.EmployeeId.HasValue &&
                     tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                     (tb.Created >= syncTime || tb.Modified >= syncTime) &&
                     tb.Date.HasValue && tb.Date.Value >= startDate &&
                     tb.Date.Value <= stopDate && tb.StartTime != tb.StopTime
                     select tb).ToList();

            // AutogenTimeblocks
            if (!employeeId.HasValue && entitiesReadOnly.EmployeeGroup.Any(a => a.ActorCompanyId == actorCompanyId && a.State == (int)SoeEntityState.Active && !a.AutogenBreakOnStamping))
            {
                var employees = EmployeeManager.GetAllEmployees(actorCompanyId, loadEmployment: true);
                var employeeIds = employees.Where(w => !w.CurrentEmployeeGroupAutogenTimeblocks == true).Select(s => s.EmployeeId).ToList();
                templateBlocks = templateBlocks.Where(b => employeeIds.Contains(b.EmployeeId.Value)).ToList();
            }

            // Employee
            if (employeeId.HasValue)
                templateBlocks = templateBlocks.Where(b => b.EmployeeId == employeeId.Value).ToList();

            // Unique
            templateBlocks.ForEach(b => b.Unique = true);

            // Sort all blocks by date and start time
            templateBlocks.Sort(new Comparison<TimeScheduleTemplateBlock>((first, second) =>
            {
                int comparison = first.Date.Value.CompareTo(second.Date.Value);
                if (comparison == 0)
                    comparison = first.StartTime.CompareTo(second.StartTime);
                return comparison;
            }));

            return templateBlocks;
        }

        public List<TimeScheduleTemplateBlock> GetClosePreliminarySchedules(int actorCompanyId, DateTime endDate)
        {
            List<TimeScheduleTemplateBlock> closePreliminaryScheduleBlocks = new List<TimeScheduleTemplateBlock>();

            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entitiesReadonly, CacheConfig.Company(actorCompanyId));

            using (CompEntities entities = new CompEntities())
            {
                List<TimeScheduleTemplateBlock> timeScheduleTemplateBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                                                                .Include("Employee.ContactPerson")
                                                                              where tb.Employee.ActorCompanyId == actorCompanyId &&
                                                                              tb.EmployeeId != hiddenEmployeeId &&
                                                                              tb.EmployeeId != null &&
                                                                              tb.IsPreliminary &&
                                                                              tb.BreakType == 0 &&
                                                                              tb.Date > DateTime.Now &&
                                                                              tb.Date < endDate &&
                                                                              tb.State == (int)SoeEntityState.Active
                                                                              orderby tb.EmployeeId, tb.Date
                                                                              select tb).ToList();

                timeScheduleTemplateBlocks = timeScheduleTemplateBlocks.Where(w => !w.TimeScheduleScenarioHeadId.HasValue).ToList();

                foreach (TimeScheduleTemplateBlock timeScheduleTemplateBlock in timeScheduleTemplateBlocks)
                {
                    closePreliminaryScheduleBlocks.Add(timeScheduleTemplateBlock);
                }
            }

            return closePreliminaryScheduleBlocks;
        }

        public List<int> GetTimeScheduleTemplateBlocksWithoutAccounting(int actorCompanyId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<TimeScheduleTemplateBlock> blocks = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock.Include("AccountInternal")
                                                      where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                      tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                                                      !tb.Date.HasValue &&
                                                      tb.ShiftTypeId.HasValue &&
                                                      tb.State == (int)SoeEntityState.Active
                                                      select tb).ToList();

            List<int> ids = new List<int>();

            foreach (TimeScheduleTemplateBlock block in blocks)
            {
                if (block.AccountInternal.IsNullOrEmpty())
                    ids.Add(block.TimeScheduleTemplateBlockId);
            }

            return ids;
        }

        public TimeScheduleTemplateBlock GetTimeScheduleTemplateBlock(int timeScheduleTemplateBlockId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return GetTimeScheduleTemplateBlock(entities, timeScheduleTemplateBlockId);
        }

        public TimeScheduleTemplateBlock GetTimeScheduleTemplateBlock(CompEntities entities, int timeScheduleTemplateBlockId)
        {
            return (from t in entities.TimeScheduleTemplateBlock
                    where t.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId &&
                    t.State == (int)SoeEntityState.Active
                    select t).FirstOrDefault();
        }

        public TimeScheduleTemplateBlock GetTimeScheduleTemplateBlock(int timeScheduleTemplateBlockId, int employeeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return GetTimeScheduleTemplateBlock(entities, timeScheduleTemplateBlockId, employeeId);
        }

        public TimeScheduleTemplateBlock GetTimeScheduleTemplateBlock(CompEntities entities, int timeScheduleTemplateBlockId, int employeeId)
        {
            return (from t in entities.TimeScheduleTemplateBlock
                    where t.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId &&
                    t.EmployeeId.HasValue && t.EmployeeId == employeeId &&
                    t.State == (int)SoeEntityState.Active
                    select t).FirstOrDefault();
        }

        public TimeScheduleTemplateBlock GetTimeScheduleTemplateBlock(int timeScheduleTemplateBlockId, bool loadPeriod, bool onlyActive)
        {
            if (timeScheduleTemplateBlockId == 0)
                return null;

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            entitiesReadOnly.TimeScheduleTemplateBlock.NoTracking();
            IQueryable<TimeScheduleTemplateBlock> query = entitiesReadOnly.TimeScheduleTemplateBlock.Include("Employee").Include("ShiftType");
            if (loadPeriod)
                query = query.Include("TimeScheduleTemplatePeriod");

            return (from b in query
                    where b.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId &&
                    (!onlyActive || b.State == (int)SoeEntityState.Active)
                    select b).FirstOrDefault();
        }

        public TimeScheduleTemplateBlock GetTimeScheduleTemplateBlock(CompEntities entities, int employeeId, DateTime date)
        {
            return (from tb in entities.TimeScheduleTemplateBlock
                    where tb.EmployeeId == employeeId &&
                    !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.Date == date.Date &&
                    tb.State == (int)SoeEntityState.Active &&
                    tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None
                    select tb).FirstOrDefault();
        }

        public List<TimeScheduleTemplateBlock> GetTimeScheduleTemplateBlocksForOrder(CompEntities entities, int customerInvoiceId)
        {
            return (from tb in entities.TimeScheduleTemplateBlock
                    where tb.CustomerInvoiceId == customerInvoiceId &&
                    tb.State == (int)SoeEntityState.Active
                    select tb).ToList();
        }

        public List<TimeScheduleTemplateChangeDTO> GetTimeScheduleTemplateChanges(int actorCompanyId, int employeeId, int timeScheduleTemplateHeadId, DateTime date, DateTime dateFrom, DateTime dateTo, List<TimeSchedulePlanningDayDTO> shifts)
        {
            List<TimeScheduleTemplateChangeDTO> changes = new List<TimeScheduleTemplateChangeDTO>();

            #region Prereq

            Employee employee = EmployeeManager.GetEmployee(employeeId, actorCompanyId, loadEmployment: true);
            if (employee == null)
                return changes;

            TimeScheduleTemplateHead template = GetTimeScheduleTemplateHead(timeScheduleTemplateHeadId, actorCompanyId, true);
            if (template == null)
                return changes;

            List<DayType> dayTypes = CalendarManager.GetDayTypesByCompany(actorCompanyId, includeEmployeeGroups: true);
            List<HolidayDTO> companyHolidays = CalendarManager.GetHolidaysByCompany(actorCompanyId, loadDayType: true);
            List<EmployeeGroup> employeeGroups = EmployeeManager.GetEmployeeGroups(actorCompanyId, loadDayTypes: true);
            List<TimeCodeBreak> timeCodeBreaks = TimeCodeManager.GetTimeCodeBreaks(actorCompanyId);

            // Set DayNumber
            int dayNumber = 0;
            if (template.FirstMondayOfCycle.HasValue || template.StartDate.HasValue)
            {
                DateTime currentDate = template.FirstMondayOfCycle ?? template.StartDate.Value.Date;
                if (!template.StopDate.HasValue || template.StopDate.Value > date)
                {
                    while (currentDate.AddDays(template.NoOfDays) <= date)
                    {
                        currentDate = currentDate.AddDays(template.NoOfDays);
                    }
                }
                dayNumber = Convert.ToInt32((date - currentDate).TotalDays) + 1;
            }

            string shiftsAfterUpdate = CreateStringFromShifts(shifts, timeCodeBreaks);

            #endregion

            #region Load shifts

            List<TimeSchedulePlanningDayDTO> existingShifts = GetTimeSchedulePlanningShifts_ByProcedure(actorCompanyId, base.UserId, 0, base.RoleId, dateFrom, dateTo, new List<int>() { employeeId }, TimeSchedulePlanningMode.SchedulePlanning, TimeSchedulePlanningDisplayMode.Admin, true, true, false, includePreliminary: true, includeShiftRequest: true, includeAbsenceRequest: false, checkToIncludeDeliveryAdress: false, loadZeroDays: true);
            existingShifts = existingShifts.Where(s => s.DayNumber == dayNumber).ToList();

            List<TimeSchedulePlanningDayDTO> existingTemplateShifts = GetTimeSchedulePlanningTemplate(actorCompanyId, base.RoleId, base.UserId, 0, timeScheduleTemplateHeadId, date, date, useNbrOfDaysFromTemplate: false, loadTimeDeviationCause: false, loadEmployees: false, loadStaffingNeeds: false);
            string templateShiftsBeforeUpdate = CreateStringFromShifts(existingTemplateShifts, timeCodeBreaks);

            #endregion

            #region Generate result

            List<DateTime> allDates = CalendarUtility.GetDates(dateFrom, dateTo);
            foreach (DateTime currentDate in allDates)
            {
                List<TimeSchedulePlanningDayDTO> dateShifts = existingShifts.Where(s => s.ActualDate == currentDate).ToList();
                if (!dateShifts.Any())
                    continue;

                EmployeeGroup employeeGroup = employee.GetEmployeeGroup(currentDate, employeeGroups);
                bool hasInvalidDayType = false;
                DayType dayType = CalendarManager.GetDayType(currentDate, employeeGroup, companyHolidays, dayTypes);
                if (dayType == null)
                {
                    List<DayType> dayTypesForDate = CalendarManager.FilterCompanyDayTypes(companyHolidays, dayTypes, currentDate);
                    if (dayTypesForDate.Count > 0)
                    {
                        dayType = dayTypesForDate.First();
                        hasInvalidDayType = true;
                    }
                }
                string shiftsBeforeUpdate = CreateStringFromShifts(dateShifts, timeCodeBreaks);

                TimeScheduleTemplateChangeDTO change = new TimeScheduleTemplateChangeDTO()
                {
                    Date = currentDate,
                    DayTypeName = dayType != null ? dayType.Name : String.Empty,
                    HasAbsence = dateShifts.Any(s => s.TimeDeviationCauseId.HasValue),
                    HasInvalidDayType = hasInvalidDayType,
                    ShiftsBeforeUpdate = shiftsBeforeUpdate,
                    HasManualChanges = !shiftsBeforeUpdate.Equals(templateShiftsBeforeUpdate),
                };

                #region Warnings

                string warnings = String.Empty;

                // Extra shift
                if (dateShifts.Any(s => s.ExtraShift))
                {
                    if (!String.IsNullOrEmpty(warnings))
                        warnings += "\n";
                    warnings += GetText(4893, 1, "Ett eller flera pass på dagen är markerat som extrapass.");
                }

                // Substitute
                if (dateShifts.Any(s => s.SubstituteShift))
                {
                    if (!String.IsNullOrEmpty(warnings))
                        warnings += "\n";
                    warnings += GetText(4894, 1, "Ett eller flera pass på dagen är markerat som vikariat.");
                }

                // Shift request
                if (dateShifts.Any(s => s.HasShiftRequest))
                {
                    if (!String.IsNullOrEmpty(warnings))
                        warnings += "\n";
                    warnings += GetText(4895, 1, "Passförfrågan har skickats för ett eller flera pass på dagen.");
                }

                // Queue
                if (dateShifts.Any(s => s.NbrOfWantedInQueue > 0))
                {
                    if (!String.IsNullOrEmpty(warnings))
                        warnings += "\n";
                    warnings += GetText(4896, 1, "Anställda står i kö för ett eller flera pass på dagen.");
                }

                if (!String.IsNullOrEmpty(warnings))
                    change.Warnings = warnings;

                #endregion

                changes.Add(change);
            }

            #endregion

            #region Work rules

            List<SoeScheduleWorkRules> rulesToSkip = new List<SoeScheduleWorkRules>()
            {
                SoeScheduleWorkRules.OverlappingShifts
            };

            List<DateTime> dates = existingShifts.Select(i => i.StartTime.Date).Distinct().ToList();

            foreach (var existingShift in existingShifts)
            {
                existingShift.ClearTime();
            }

            List<TimeSchedulePlanningDayDTO> shiftsToEvaluate = new List<TimeSchedulePlanningDayDTO>();
            shiftsToEvaluate.AddRange(shifts);
            shiftsToEvaluate.AddRange(existingShifts);

            TimeEngineManager tem = new TimeEngineManager(this.parameterObject, actorCompanyId, base.UserId);
            EvaluateWorkRulesActionResult workRulesResult = tem.EvaluatePlannedShiftsAgainstWorkRules(shiftsToEvaluate, false, null, dates: dates, rulesToSkip: rulesToSkip);
            if (workRulesResult != null && !workRulesResult.EvaluatedRuleResults.IsNullOrEmpty())
            {
                foreach (TimeScheduleTemplateChangeDTO change in changes)
                {
                    change.WorkRulesResults = workRulesResult.EvaluatedRuleResults.Where(i => i.Date == change.Date && !i.Success).ToList();
                }
            }

            #endregion

            return changes;
        }

        public void SetSwapShiftInfo(List<TimeSchedulePlanningDayDTO> dtos)
        {
            foreach (var dto in dtos)
                dto.SwapShiftInfo = CreateSwapShiftInfo(dto);
        }

        private string CreateSwapShiftInfo(TimeSchedulePlanningDayDTO shift)
        {
            //08:00 - 12:30 (15) Avdelning 3, Övertid

            string result = String.Empty;

            TimeScheduleTemplateChangeDiffDTO diff = new TimeScheduleTemplateChangeDiffDTO()
            {
                Date = shift.ActualDate,
                StartTime = shift.StartTime,
                StopTime = shift.StopTime,
                ShiftTypeName = shift.ShiftTypeName,
                ScheduleTypeName = shift.TimeScheduleTypeName,
                DeviationCauseName = shift.EmployeeChildName.IsNullOrEmpty() ? shift.TimeDeviationCauseName : shift.TimeDeviationCauseName + " (" + shift.EmployeeChildName + ")",
                IsPreliminary = shift.IsPreliminary
            };

            int breakMinutes = shift.GetMyBreaks().Sum(x => x.BreakMinutes);

            if (shift.StartTime != CalendarUtility.GetBeginningOfDay(shift.StartTime) && shift.StopTime != CalendarUtility.GetEndOfDay(shift.StopTime))
                result += String.Format("{0}-{1} ({2}) {3}", shift.StartTime.GetSwedishFormattedTime(), shift.StopTime.GetSwedishFormattedTime(), breakMinutes, diff.ShiftTypeName);
            else
                result += "";
            if (!String.IsNullOrEmpty(diff.ScheduleTypeName))
                result += ", " + diff.ScheduleTypeName;
            if (!String.IsNullOrEmpty(diff.DeviationCauseName))
                result += ", " + diff.DeviationCauseName;

            return result;
        }

        private string CreateStringFromShifts(List<TimeSchedulePlanningDayDTO> shifts, List<TimeCodeBreak> timeCodeBreaks, bool includePreliminary = false, bool includeAllBreaks = true)
        {
            string result = String.Empty;
            string freeDay = GetText(11863, 1, "Ledig dag");
            string breakPrefix = GetText(5990, 1, "Rast");
            string prel = String.Format(" ({0})", GetText(3795, 1, "prel"));
            string onDuty = String.Format(" ({0})", GetText(385, 1, "Jour"));
            List<TimeScheduleTemplateChangeDiffDTO> diffs = new List<TimeScheduleTemplateChangeDiffDTO>();

            bool breaksCreated = false;

            foreach (TimeSchedulePlanningDayDTO shift in shifts)
            {
                diffs.Add(new TimeScheduleTemplateChangeDiffDTO()
                {
                    Date = shift.ActualDate,
                    StartTime = shift.StartTime,
                    StopTime = shift.StopTime,
                    ShiftTypeName = shift.ShiftTypeName,
                    ScheduleTypeName = shift.TimeScheduleTypeName,
                    DeviationCauseName = shift.EmployeeChildName.IsNullOrEmpty() ? shift.TimeDeviationCauseName : shift.TimeDeviationCauseName + " (" + shift.EmployeeChildName + ")",
                    IsPreliminary = shift.IsPreliminary,
                    IsOnDuty = shift.Type == TermGroup_TimeScheduleTemplateBlockType.OnDuty
                });

                if (!breaksCreated)
                {
                    // includeAllBreaks: true -> All shifts contains all breaks so we only need to create breaks from the first shift
                    // includeAllBreaks: false -> Include only breaks for current shift

                    List<BreakDTO> breaks = includeAllBreaks ? shift.GetBreaks() : shift.GetMyBreaks();
                    foreach (BreakDTO brk in breaks)
                    {
                        string timeCodeName = timeCodeBreaks.FirstOrDefault(t => t.TimeCodeId == brk.TimeCodeId)?.Name;
                        if (!string.IsNullOrEmpty(timeCodeName) && !timeCodeName.StartsWith(breakPrefix))
                            timeCodeName = String.Format("{0} {1}", breakPrefix, timeCodeName);

                        diffs.Add(new TimeScheduleTemplateChangeDiffDTO()
                        {
                            Date = shift.ActualDate,
                            StartTime = brk.StartTime,
                            StopTime = brk.StartTime.AddMinutes(brk.BreakMinutes),
                            ShiftTypeName = timeCodeName
                        });
                    }

                    if (includeAllBreaks)
                        breaksCreated = true;
                }
            }

            diffs = diffs.OrderBy(d => d.Date).ThenBy(d => d.StartTime).ThenBy(d => d.StopTime).ToList();
            foreach (TimeScheduleTemplateChangeDiffDTO diff in diffs)
            {
                string item = String.Empty;
                if (!String.IsNullOrEmpty(result))
                    item += " | ";
                if (diff.StartTime != CalendarUtility.GetBeginningOfDay(diff.StartTime) && diff.StopTime != CalendarUtility.GetEndOfDay(diff.StopTime))
                    item += String.Format("{0}-{1} {2}", diff.StartTime.GetSwedishFormattedTime(), diff.StopTime.GetSwedishFormattedTime(), diff.ShiftTypeName);
                else
                    item += freeDay;
                if (!String.IsNullOrEmpty(diff.ScheduleTypeName))
                    item += ", " + diff.ScheduleTypeName;
                if (!String.IsNullOrEmpty(diff.DeviationCauseName))
                    item += ", " + diff.DeviationCauseName;

                if (includePreliminary && diff.IsPreliminary)
                    item += prel;

                if (diff.IsOnDuty)
                    item += onDuty;

                result += item;
            }

            return result;
        }

        public string CreateStringFromShifts(int actorCompanyId, List<TimeSchedulePlanningDayDTO> shifts)
        {
            List<TimeCodeBreak> timeCodeBreaks = TimeCodeManager.GetTimeCodeBreaks(actorCompanyId);
            return CreateStringFromShifts(shifts, timeCodeBreaks);
        }

        public Dictionary<DateTime, DateTime> GetScheduleIn(CompEntities entities, int employeeId, DateTime startDate, DateTime stopDate)
        {
            var results = (from tb in entities.TimeScheduleTemplateBlock
                           where !tb.TimeScheduleScenarioHeadId.HasValue &&
                           (tb.EmployeeId.HasValue && tb.EmployeeId.Value == employeeId) &&
                           (tb.Date.HasValue && tb.Date.Value >= startDate && tb.Date.Value <= stopDate) &&
                           tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                           tb.State == (int)SoeEntityState.Active
                           group tb by tb.Date.Value into g
                           select new { Date = g.Key, StartTime = g.Select(g2 => g2.StartTime).OrderBy(g3 => g3).FirstOrDefault() });

            Dictionary<DateTime, DateTime> dict = new Dictionary<DateTime, DateTime>();
            foreach (var result in results)
            {
                dict.Add(result.Date, result.StartTime);
            }

            return dict;
        }

        public Dictionary<DateTime, DateTime> GetScheduleOut(CompEntities entities, int employeeId, DateTime startDate, DateTime stopDate)
        {
            var results = (from tb in entities.TimeScheduleTemplateBlock
                           where !tb.TimeScheduleScenarioHeadId.HasValue &&
                           (tb.EmployeeId.HasValue && tb.EmployeeId.Value == employeeId) &&
                           (tb.Date.HasValue && tb.Date.Value >= startDate && tb.Date.Value <= stopDate) &&
                           tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                           tb.State == (int)SoeEntityState.Active
                           group tb by tb.Date.Value into g
                           select new { Date = g.Key, StopTime = g.Select(g2 => g2.StopTime).OrderByDescending(g3 => g3).FirstOrDefault() });

            Dictionary<DateTime, DateTime> dict = new Dictionary<DateTime, DateTime>();
            foreach (var result in results)
            {
                dict.Add(result.Date, result.StopTime);
            }

            return dict;
        }

        public List<DateTime> GetScheduledDays(int employeeId, DateTime dateFrom, int dayCount)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                    where !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.EmployeeId.HasValue && tb.EmployeeId == employeeId &&
                    tb.Date.HasValue && tb.Date >= dateFrom &&
                    tb.StartTime != tb.StopTime &&
                    tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                    tb.TimeScheduleEmployeePeriod != null && !tb.IsPreliminary &&
                    tb.State == (int)SoeEntityState.Active
                    select tb.Date.Value).OrderBy(x => x).Distinct().Take(dayCount).ToList();
        }

        public List<Tuple<int, DateTime>> GetEmployeesWithinSchedule(CompEntities entities, int actorCompanyId, List<Employee> employees, DateTime time, ref Account account, int? dimNr = null, bool checkMobileIn = false, List<int> employeeIdsIn = null)
        {
            List<Tuple<int, DateTime>> employeesWithinSchedule = new List<Tuple<int, DateTime>>();
            List<EmployeeGroup> employeeGroups = GetEmployeeGroupsFromCache(entities, CacheConfig.Company(actorCompanyId));

            foreach (var employee in employees)
            {
                EmployeeGroup employeeGroup = employee.GetEmployeeGroup(time, employeeGroups);
                if (employeeGroup == null)
                    continue;

                int minutesAfterMidnight = employeeGroup.BreakDayMinutesAfterMidnight;
                DateTime date = time.AddMinutes(-minutesAfterMidnight).Date;

                IQueryable<TimeScheduleTemplateBlock> query = entities.TimeScheduleTemplateBlock;
                if (dimNr > 0)
                    query = query.Include("AccountInternal.Account");

                List<TimeScheduleTemplateBlock> templateBlocks = (from tb in query
                                                                  where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                                  tb.EmployeeId == employee.EmployeeId &&
                                                                  tb.Date.HasValue &&
                                                                  tb.Date.Value == date &&
                                                                  tb.State == (int)SoeEntityState.Active
                                                                  select tb).ToList();

                if (!templateBlocks.IsNullOrEmpty())
                {
                    templateBlocks = templateBlocks.OrderBy(b => b.StartTime).ToList();

                    foreach (var block in templateBlocks)
                    {
                        if (block.StartTime == CalendarUtility.DATETIME_DEFAULT || block.TimeDeviationCauseId.HasValue)
                            continue;

                        if ((CalendarUtility.IsDateInRange(time, block.ActualStartTime, block.ActualStopTime)) ||
                            (checkMobileIn && employeeIdsIn != null && employeeIdsIn.Contains(employee.EmployeeId))
                           )
                        {
                            if (dimNr > 0)
                            {
                                account = block.AccountInternal.Where(a => a.Account.AccountDimId == dimNr).Select(a => a.Account).FirstOrDefault();
                            }

                            TimeScheduleTemplateBlock first = templateBlocks.FirstOrDefault();
                            if (first == null)
                                continue;

                            Tuple<int, DateTime> employeeWithinSchedule = new Tuple<int, DateTime>(employee.EmployeeId, (DateTime)first.ActualStartTime);
                            employeesWithinSchedule.Add(employeeWithinSchedule);
                            break;
                        }
                    }
                }
            }

            return employeesWithinSchedule;
        }

        public bool HasScheduleTemplatePeriodsHasTemplateBlocks(int actorCompanyId)
        {
            var templatePeriods = GetTimeScheduleTemplatePeriodsForCompany(actorCompanyId, false);
            if (templatePeriods.IsNullOrEmpty())
                return false;

            foreach (var templatePeriod in templatePeriods)
            {
                if (!HasScheduleTemplatePeriodBlocks(templatePeriod.TimeScheduleTemplatePeriodId))
                    return false;
            }

            return true;
        }

        public bool HasScheduleTemplatePeriodBlocks(int templatePeriodId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return (from tb in entities.TimeScheduleTemplateBlock
                    where !tb.TimeScheduleScenarioHeadId.HasValue &&
                    tb.TimeScheduleTemplatePeriodId == templatePeriodId &&
                    !tb.EmployeeId.HasValue && !tb.Date.HasValue &&   //Only template blocks
                    tb.State == (int)SoeEntityState.Active
                    select tb).Any();
        }

        public bool IsEmployeeWithinSchedule(CompEntities entities, Employee employee, DateTime time)
        {
            Account dummy = null;
            return this.IsEmployeeWithinSchedule(entities, employee, time, ref dummy);
        }

        public bool IsEmployeeWithinSchedule(CompEntities entities, Employee employee, DateTime time, ref Account account, int? dimNr = null)
        {
            EmployeeGroup employeeGroup = employee.GetEmployeeGroup(time, GetEmployeeGroupsFromCache(entities, CacheConfig.Company(employee.ActorCompanyId)));
            if (employeeGroup == null)
                return false;

            int minutesAfterMidnight = employeeGroup.BreakDayMinutesAfterMidnight;
            DateTime date = time.AddMinutes(-minutesAfterMidnight).Date;
            bool withinSchedule = false;

            IQueryable<TimeScheduleTemplateBlock> query = entities.TimeScheduleTemplateBlock;
            if (dimNr > 0)
                query = query.Include("AccountInternal.Account");

            List<TimeScheduleTemplateBlock> templateBlocks = (from tb in query
                                                              where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                              tb.EmployeeId == employee.EmployeeId &&
                                                              tb.Date.HasValue &&
                                                              tb.Date.Value == date &&
                                                              tb.State == (int)SoeEntityState.Active
                                                              select tb).ToList();

            foreach (var block in templateBlocks.OrderBy(b => b.StartTime))
            {
                if (block.StartTime == CalendarUtility.DATETIME_DEFAULT)
                    return false;

                if (CalendarUtility.IsDateInRange(time, block.ActualStartTime, block.ActualStopTime))
                {
                    if (dimNr > 0)
                    {
                        account = block.AccountInternal.Where(a => a.Account.AccountDimId == dimNr).Select(a => a.Account).FirstOrDefault();
                    }

                    return true;
                }
            }

            return withinSchedule;
        }

        public TimeScheduleTemplateBlock GetClosestSchedule(CompEntities entities, int employeeId, DateTime time)
        {
            TimeScheduleTemplateBlock closestSchedule = null;

            // Get schedule range from day before yesterday to day after tomorrow
            // We need to have this broad range to support shifts over midnight
            DateTime startDate = new DateTime(time.Year, time.Month, time.Day, 0, 0, 0).AddDays(-2);
            DateTime stopDate = new DateTime(time.Year, time.Month, time.Day, 23, 59, 59).AddDays(2);

            List<TimeScheduleTemplateBlock> templateBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                                              where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                              tb.EmployeeId == employeeId &&
                                                              tb.Date.HasValue &&
                                                              tb.Date.Value >= startDate &&
                                                              tb.Date.Value <= stopDate &&
                                                              tb.BreakType == 0 &&
                                                              tb.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Schedule &&
                                                              tb.State == (int)SoeEntityState.Active
                                                              orderby tb.Date, tb.StartTime
                                                              select tb).ToList();

            if (templateBlocks.Any())
            {
                // If only one schedule, use it
                if (templateBlocks.Count == 1)
                    closestSchedule = templateBlocks.First();

                // Check if we are inside a schedule
                if (closestSchedule == null)
                    closestSchedule = templateBlocks.FirstOrDefault(s => s.ActualStartTime <= time && s.ActualStopTime > time);

                if (closestSchedule == null)
                {
                    TimeScheduleTemplateBlock previousSchedule = templateBlocks.LastOrDefault(s => s.ActualStartTime <= time);
                    TimeScheduleTemplateBlock nextSchedule = templateBlocks.FirstOrDefault(s => s.ActualStartTime > time);

                    int diffToPrevious = previousSchedule != null ? (int)(time - previousSchedule.ActualStopTime.Value).TotalMinutes : Int32.MaxValue;
                    int diffToNext = nextSchedule != null ? (int)(nextSchedule.ActualStartTime.Value - time).TotalMinutes : Int32.MaxValue;
                    closestSchedule = diffToPrevious < diffToNext ? previousSchedule : nextSchedule;
                }
            }

            return closestSchedule;
        }

        public decimal GetScheduleMinutes(CompEntities entities, int actorCompanyId, int employeeId, DateTime date)
        {
            TimeSpan scheduleTime = new TimeSpan();

            DateTime startDate = CalendarUtility.GetBeginningOfDay(date);
            DateTime stopDate = CalendarUtility.GetEndOfDay(date);

            var templateBlockItemsForDay = entities.GetTimeScheduleTemplateBlocksForEmployee(employeeId, startDate, stopDate).Where(b => b.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Schedule).ToList();
            var timeScheduleTypeFactorsEmployee = TimeScheduleManager.GetTimeScheduleTypeFactorsWithinShiftsDict(entities, actorCompanyId, employeeId, startDate, stopDate);

            foreach (var templateBlockItemWork in templateBlockItemsForDay.GetWork())
            {
                TimeSpan time = templateBlockItemWork.StopTime.Subtract(templateBlockItemWork.StartTime);
                if (time.TotalSeconds == 0)
                    continue;

                //ScheduleTime (count schedule time even if it is flagged as 'IsNotScheduleTime')
                scheduleTime = scheduleTime.Add(time);
            }

            //TimeScheduleTypeFactorTime
            if (timeScheduleTypeFactorsEmployee.ContainsKey(date))
                scheduleTime = scheduleTime.Add(new TimeSpan(0, timeScheduleTypeFactorsEmployee[date], 0));

            //Breaks
            int scheduleBreakTime = 0;
            foreach (var templateBlockItemBreak in templateBlockItemsForDay.GetBreaks())
            {
                scheduleBreakTime += templateBlockItemBreak.DefaultMinutes;
            }

            //Adjust ScheduleTime
            scheduleTime = scheduleTime.Subtract(new TimeSpan(0, scheduleBreakTime, 0));

            return (decimal)scheduleTime.TotalMinutes;
        }

        public void MoveScheduleBlocksToEmployeeSchedule(CompEntities entities, EmployeeSchedule employeeSchedule, List<TimeScheduleTemplateBlock> scheduleBlocks, DateTime? modified = null)
        {
            if (employeeSchedule == null || scheduleBlocks.IsNullOrEmpty())
                return;

            foreach (TimeScheduleTemplateBlock scheduleBlock in scheduleBlocks)
            {
                scheduleBlock.EmployeeSchedule = employeeSchedule;
                SetModifiedProperties(scheduleBlock, modified: modified);
            }
        }

        public void SetAccountingFromShiftType(List<int> blockIds, int actorCompanyId)
        {
            ResetAccountingAccordingToShiftType(actorCompanyId, CalendarUtility.DATETIME_DEFAULT, DateTime.Now.AddYears(10), null, blockIds);
        }

        public ActionResult ResetAccountingAccordingToShiftType(int actorCompanyId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds = null, List<int> blockIds = null, bool updateTemplates = true)
        {
            using (CompEntities entities = new CompEntities())
            {
                return ResetAccountingAccordingToShiftType(entities, actorCompanyId, dateFrom, dateTo, employeeIds, blockIds, updateTemplates: updateTemplates);
            }
        }

        public void ValidateShiftTypeAccountInternalForHierachy(int actorCompanyId, int shiftTypeAccountDimId)
        {
            int? accountDim = shiftTypeAccountDimId;
            var shiftTypes = GetShiftTypes(actorCompanyId, loadAccountInternals: true, loadAccounts: true).ToDTOs(includeAccounts: true, includeAccountingSettings: true, setAccountInternalIds: true);
            var accounts = AccountManager.GetAccountsByCompany(actorCompanyId, loadAccount: true, loadAccountDim: true, loadAccountMapping: true);
            var accountDims = AccountManager.GetAccountDimsByCompany(actorCompanyId);

            if (accountDim.HasValue)
            {
                foreach (var shift in shiftTypes)
                {
                    foreach (var item in shift.AccountInternals)
                    {
                        if (item.Value.AccountDimId == 0)
                        {
                            var acc = accounts.FirstOrDefault(f => f.AccountId == item.Value.AccountId);

                            if (acc != null)
                                item.Value.AccountDimId = acc.AccountDimId;
                        }
                    }

                    var account = shift.AccountInternals.FirstOrDefault(f => f.Value != null && f.Value.AccountDimId == accountDim);

                    List<AccountSmallDTO> internalAndParents = null;

                    if (account.Value != null)
                    {
                        internalAndParents = GetAccountParents(account.Value.AccountId);
                    }
                    else if (shift.AccountId.HasValue)
                    {
                        var acco = accounts.FirstOrDefault(f => f.AccountId == shift.AccountId.Value);

                        if (acco != null && acco.AccountDimId == accountDim)
                        {
                            internalAndParents = GetAccountParents(shift.AccountId.Value);
                            internalAndParents.Add(new AccountSmallDTO() { AccountId = acco.AccountId, AccountDimId = acco.AccountDimId });
                        }
                        else
                        {
                            DebugWrite($"No matching accountinternal {shift.Name}");
                            continue;
                        }
                    }
                    else
                    {
                        continue;
                    }

                    while (internalAndParents.Any())
                    {
                        var first = internalAndParents.First();
                        var accountDimOnAcc = accountDims.First(f => f.AccountDimId == first.AccountDimId);
                        if (shift.AccountInternals.Any(a => a.Value != null && a.Value.AccountDimId == first.AccountDimId && a.Value.AccountId != first.AccountId))
                        {
                            var accountOnDim = shift.AccountInternals.First(a => a.Value != null && a.Value.AccountDimId == first.AccountDimId);
                            var correctOnDim = accounts.First(f => f.AccountId == first.AccountId);

                            DebugWrite($"incorrect ParentAccount shifttype:{shift.Name} accountDimension: {accountDimOnAcc.Name} incorrect account: {accountOnDim.Value.Number} {accountOnDim.Value.Name} correct account: {correctOnDim.AccountNr} {correctOnDim.Name}");
                        }
                        else if (!shift.AccountInternals.Any(a => a.Value != null && a.Value.AccountDimId == first.AccountDimId))
                        {
                            if (!shift.Name.ToLower().Contains("anv ej") && !shift.Name.ToLower().Contains("ta bort"))
                                DebugWrite($"missing account {shift.Name} accountDim: {accountDimOnAcc.Name}");
                        }

                        internalAndParents.Remove(first);
                    }
                }
            }

            List<AccountSmallDTO> GetAccountParents(int accountId)
            {
                List<AccountSmallDTO> parentAccounts = new List<AccountSmallDTO>();
                var currentAccount = accounts.FirstOrDefault(w => w.AccountId == accountId);
                if (currentAccount == null)
                    return parentAccounts;

                while (currentAccount != null && currentAccount.ParentAccountId != null && currentAccount.ParentAccountId.HasValue)
                {
                    var parentAccount = accounts.FirstOrDefault(w => w.AccountId == currentAccount.ParentAccountId);
                    if (parentAccount != null)
                        parentAccounts.Add(new AccountSmallDTO() { AccountId = parentAccount.AccountId, AccountDimId = parentAccount.AccountDimId });
                    currentAccount = parentAccount;
                }
                return parentAccounts;
            }


        }

        public class AccountParentDTO
        {
            public int AccountDimNr { get; set; }
            public string AccountNr { get; set; }
            public int ParentAccountDimNr { get; set; }
            public string ParentAccountNr { get; set; }
            public string OldParentAccountNr { get; set; }
            public bool UpdateHierarchy { get; set; }
        }
        public ActionResult ChangeParentAccounsAfterHierarchyChange(CompEntities entities, List<AccountParentDTO> accountParents, int actorCompanyId, DateTime dateFrom, DateTime? dateTo, bool includeTemplateSchedule = true, bool extendedFunction = false)
        {
            var useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            if (!useAccountHierarchy)
                return new ActionResult($"useAccountHierarchy == false");

            var accounts = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId));
            var dims = base.GetAccountDimsFromCache(entities, CacheConfig.Company(actorCompanyId));
            var now = DateTime.Now;

            foreach (var accountParent in accountParents)
            {
                if (!accountParent.UpdateHierarchy)
                    continue;

                var accountDim = dims.FirstOrDefault(f => f.AccountDimNr == accountParent.AccountDimNr);

                if (accountDim == null)
                    return new ActionResult($"{accountParent.AccountDimNr} does not exist");

                var parentAccountDim = dims.FirstOrDefault(f => f.AccountDimNr == accountParent.ParentAccountDimNr);

                if (parentAccountDim == null)
                    return new ActionResult($"{accountParent.ParentAccountDimNr} does not exist");

                var account = accounts.FirstOrDefault(f => f.AccountNr == accountParent.AccountNr && f.AccountDimId == accountDim.AccountDimId);
                if (account == null)
                    return new ActionResult($"{accountParent.AccountNr} does not exist");

                var parentAccount = accounts.FirstOrDefault(f => f.AccountNr == accountParent.ParentAccountNr && f.AccountDimId == parentAccountDim.AccountDimId);

                if (parentAccount == null)
                    return new ActionResult($"{accountParent.ParentAccountNr} does not exist");

                if (account.ParentAccountId != parentAccount.AccountId)
                {
                    var accountFromDb = entities.Account.FirstOrDefault(f => f.AccountId == account.AccountId);
                    accountFromDb.ParentAccountId = parentAccount.AccountId;
                    accountFromDb.Modified = now;
                }
            }

            entities.SaveChanges();

            List<Tuple<int, int, List<int>>> mappedAccounts = new List<Tuple<int, int, List<int>>>();

            foreach (var groupedByParent in accountParents.GroupBy(g => g.ParentAccountNr))
            {
                var accountParent = groupedByParent.First();

                var parentAccountDim = dims.FirstOrDefault(f => f.AccountDimNr == accountParent.ParentAccountDimNr);

                if (parentAccountDim == null)
                    return new ActionResult($"{accountParent.ParentAccountDimNr} does not exist");
                var parentAccount = accounts.FirstOrDefault(f => f.AccountNr == accountParent.ParentAccountNr && f.AccountDimId == parentAccountDim.AccountDimId);
                var oldParentAccountNrLists = groupedByParent.Select(s => s.OldParentAccountNr).Distinct().ToList();

                foreach (var item in oldParentAccountNrLists)
                {
                    var oldParentAccount = accounts.FirstOrDefault(f => f.AccountNr == item && f.AccountDimId == parentAccountDim.AccountDimId);

                    var tuple = new Tuple<int, int, List<int>>(parentAccount.AccountId, oldParentAccount.AccountId, new List<int>());

                    foreach (var child in groupedByParent)
                    {
                        var accountDim = dims.FirstOrDefault(f => f.AccountDimNr == accountParent.AccountDimNr);

                        if (accountDim == null)
                            return new ActionResult($"{accountParent.AccountDimNr} does not exist");

                        var childAccount = accounts.FirstOrDefault(f => f.AccountNr == child.AccountNr && f.AccountDimId == accountDim.AccountDimId);

                        if (childAccount == null)
                            return new ActionResult($"{childAccount.AccountNr} does not exist");

                        tuple.Item3.Add(childAccount.AccountId);
                    }

                    mappedAccounts.Add(tuple);
                }
            }

            foreach (var tuple in mappedAccounts)
            {
                var parentAccount = tuple.Item1;
                var oldParentAccount = tuple.Item2;
                var childAccounts = tuple.Item3;
                var sqlBuilder = new StringBuilder();
                var childAccountIds = string.Join(",", childAccounts);

                sqlBuilder.AppendLine($"Update TimeScheduleTemplateBlockAccount set accountid = {tuple.Item1}");
                sqlBuilder.AppendLine($"where accountid = {oldParentAccount} and timescheduletemplateblockid in (");
                sqlBuilder.AppendLine($"Select timescheduletemplateblockid from timescheduletemplateblock where ");
                if (includeTemplateSchedule)
                    sqlBuilder.AppendLine($"(Date is null or date >= '{CalendarUtility.ToSqlFriendlyDateTime(dateFrom)}')");
                else
                    sqlBuilder.AppendLine($"date >= '{CalendarUtility.ToSqlFriendlyDateTime(dateFrom)}' ");
                sqlBuilder.AppendLine("and timescheduletemplateblockid in (select ba.timescheduletemplateblockid from timescheduletemplateblockaccount ba ");
                sqlBuilder.AppendLine("inner join TimeScheduleTemplateBlock b on b.TimeScheduleTemplateBlockId = ba.TimeScheduleTemplateBlockId ");
                sqlBuilder.AppendLine("inner join TimeScheduleTemplatePeriod p on p.TimeScheduleTemplatePeriodId = b.TimeScheduleTemplatePeriodId ");
                sqlBuilder.AppendLine("inner join TimeScheduleTemplateHead h on h.TimeScheduleTemplateHeadId = p.TimeScheduleTemplateHeadId ");
                sqlBuilder.AppendLine("inner join employee e on e.EmployeeId = b.EmployeeId ");
                sqlBuilder.AppendLine($"where e.ActorCompanyId = {actorCompanyId} ");
                sqlBuilder.AppendLine("and b.state = 0 ");
                sqlBuilder.AppendLine("and h.state = 0 ");
                sqlBuilder.AppendLine("and p.State = 0 ");
                sqlBuilder.AppendLine("AND E.STATE = 0 ");

                sqlBuilder.AppendLine($"and ba.accountid in ({childAccountIds})");
                sqlBuilder.AppendLine("))");

                LogCollector.LogInfo("ChangeParentAccounsAfterHierarchyChange schedule  " + sqlBuilder.ToString());
                if (extendedFunction)
                    FrownedUponSQLClient.ExecuteSql(entities, sqlBuilder.ToString(), 60 * 120);

                // Update TimePayrollTransactionAccount
                sqlBuilder.Clear();
                sqlBuilder.AppendLine($"Update TimePayrollTransactionAccount set accountid = {tuple.Item1}");
                sqlBuilder.AppendLine($"where accountid = {oldParentAccount}  and TimePayrollTransactionid in (");
                sqlBuilder.AppendLine("Select TimePayrollTransactionid from TimePayrollTransaction tpt");
                sqlBuilder.AppendLine($"inner join TimeBlockdate tbd on tpt.TimeBlockDateId = tbd.TimeBlockDateId where date >= '{CalendarUtility.ToSqlFriendlyDateTime(dateFrom)}' and");
                sqlBuilder.AppendLine("TimePayrollTransactionid in (select ta.TimePayrollTransactionid from TimePayrollTransactionAccount ta");
                sqlBuilder.AppendLine("inner join TimePayrollTransaction tpti on tpti.TimePayrollTransactionId = ta.TimePayrollTransactionId");
                sqlBuilder.AppendLine("inner join employee e on e.EmployeeId = tpti.EmployeeId");
                sqlBuilder.AppendLine($"where e.ActorCompanyId = {actorCompanyId}");
                sqlBuilder.AppendLine("and tpti.state = 0");
                sqlBuilder.AppendLine("AND E.STATE = 0");
                sqlBuilder.AppendLine($"and ta.accountid in ({childAccountIds})");
                sqlBuilder.AppendLine("))");

                LogCollector.LogInfo("ChangeParentAccounsAfterHierarchyChange transactions  " + sqlBuilder.ToString());
                if (extendedFunction)
                    FrownedUponSQLClient.ExecuteSql(entities, sqlBuilder.ToString(), 60 * 120);
            }

            entities.CommandTimeout = 60 * 60;

            return new ActionResult("Success");
        }

        public ActionResult ResetAccountingAccordingToShiftType(CompEntities entities, int actorCompanyId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds = null, List<int> blockIds = null, List<Account> accounts = null, List<ShiftType> shiftTypes = null, List<AccountDim> accountDims = null, bool updateTemplates = true)
        {
            var useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            int accountDimId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimEmployee, 0, actorCompanyId, 0);

            entities.CommandTimeout = 60 * 60;
            try
            {
                accounts = accounts ?? entities.Account.Include("AccountInternal").Where(w => w.ActorCompanyId == actorCompanyId).ToList();
                shiftTypes = shiftTypes ?? entities.ShiftType.Include("AccountInternal.Account").Where(w => w.ActorCompanyId == actorCompanyId).ToList();
                accountDims = accountDims ?? entities.AccountDim.Where(w => w.ActorCompanyId == actorCompanyId).ToList();

                List<TimeScheduleTemplateBlock> templateBlockblocks = new List<TimeScheduleTemplateBlock>();

                if (blockIds == null && updateTemplates)
                {
                    if (!employeeIds.IsNullOrEmpty() && employeeIds.Count < 100)
                    {
                        templateBlockblocks = (from tb in entities.TimeScheduleTemplateBlock.Include("AccountInternal")
                                               where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                               tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                                               !tb.Date.HasValue &&
                                               tb.ShiftTypeId.HasValue &&
                                               tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.EmployeeId.HasValue &&
                                               employeeIds.Contains(tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.EmployeeId.Value) &&
                                               tb.State == (int)SoeEntityState.Active
                                               select tb).ToList();
                    }
                    else
                    {
                        templateBlockblocks = (from tb in entities.TimeScheduleTemplateBlock.Include("AccountInternal")
                                               where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                               tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                                               !tb.Date.HasValue &&
                                               tb.ShiftTypeId.HasValue &&
                                               tb.State == (int)SoeEntityState.Active
                                               select tb).ToList();
                    }

                }

                List<TimeScheduleTemplateBlock> blocks = new List<TimeScheduleTemplateBlock>();

                if (blockIds == null)
                {
                    if (!employeeIds.IsNullOrEmpty() && employeeIds.Count < 100)
                    {
                        blocks = (from tb in entities.TimeScheduleTemplateBlock.Include("AccountInternal")
                                  where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                  tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                                  tb.Date.HasValue &&
                                  tb.Date.Value >= dateFrom &&
                                  tb.Date.Value <= dateTo &&
                                  tb.ShiftTypeId.HasValue &&
                                  tb.EmployeeId.HasValue &&
                                  employeeIds.Contains(tb.EmployeeId.Value) &&
                                  tb.State == (int)SoeEntityState.Active
                                  select tb).ToList();
                    }
                    else
                    {

                        blocks = (from tb in entities.TimeScheduleTemplateBlock.Include("AccountInternal")
                                  where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                  tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                                  tb.Date.HasValue &&
                                  tb.Date.Value >= dateFrom &&
                                  tb.Date.Value <= dateTo &&
                                  tb.ShiftTypeId.HasValue &&
                                  tb.State == (int)SoeEntityState.Active
                                  select tb).ToList();
                    }
                }

                if (employeeIds != null)
                {
                    templateBlockblocks = templateBlockblocks.Where(w => w.EmployeeId.HasValue && employeeIds.Contains(w.EmployeeId.Value)).ToList();
                    blocks = blocks.Where(w => w.EmployeeId.HasValue && employeeIds.Contains(w.EmployeeId.Value)).ToList();
                }

                if (blockIds != null)
                {
                    templateBlockblocks = (from t in entities.TimeScheduleTemplateBlock.Include("AccountInternal")
                                           where blockIds.Contains(t.TimeScheduleTemplateBlockId) && !t.Date.HasValue
                                           select t).ToList();

                    blocks = (from t in entities.TimeScheduleTemplateBlock.Include("AccountInternal")
                              where blockIds.Contains(t.TimeScheduleTemplateBlockId) && t.Date.HasValue
                              select t).ToList();
                }

                Dictionary<int, int> dict = new Dictionary<int, int>();

                LogInfo($"templateblocks  {templateBlockblocks.Count} blocks {blocks.Count}");
                int count = 0;
                using (SqlConnection connection = new SqlConnection(FrownedUponSQLClient.GetADOConnectionString()))
                {
                    foreach (var groupByEmployee in templateBlockblocks.GroupBy(i => i.EmployeeId))
                    {
                        List<EmployeeAccount> employeeAccounts = null;

                        if (useAccountHierarchy)
                        {
                            int employeeId = groupByEmployee.First().EmployeeId.Value;
                            employeeAccounts = EmployeeManager.GetEmployeeAccounts(entities, actorCompanyId, employeeId);
                        }

                        foreach (TimeScheduleTemplateBlock block in groupByEmployee.ToList())
                        {
                            var shiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == block.ShiftTypeId);

                            if (shiftType == null || shiftType.AccountInternal.IsNullOrEmpty())
                                continue;

                            List<int> accountIds = block.GetAccountIdForResetingAccounting(employeeAccounts, shiftType, accountDimId, accounts, accountDims);

                            var existingIds = new List<int>();
                            var incorrectExistingIds = new List<int>();

                            if (!block.AccountInternal.IsNullOrEmpty())
                            {
                                existingIds = block.AccountInternal.Select(s => s.AccountId).ToList();
                                incorrectExistingIds = block.AccountInternal.Select(s => s.AccountId).Where(w => !accountIds.Contains(w)).ToList();
                            }
                            accountIds = accountIds.Where(w => !existingIds.Contains(w)).ToList();

                            foreach (var item in incorrectExistingIds)
                            {
                                if (accountIds.Any())
                                {
                                    int accountId = accountIds.First();
                                    var sql = $"update TimeScheduleTemplateBlockAccount set AccountId = {accountId} where TimeScheduleTemplateBlockId = {block.TimeScheduleTemplateBlockId} and AccountId = {item}";
                                    FrownedUponSQLClient.ExcuteQuery(connection, sql);
                                    accountIds.Remove(accountId);
                                }
                                else
                                {
                                    var sql = $"Delete from TimeScheduleTemplateBlockAccount where TimeScheduleTemplateBlockId = {block.TimeScheduleTemplateBlockId} and AccountId = {item}";
                                    FrownedUponSQLClient.ExcuteQuery(connection, sql);
                                }
                            }

                            foreach (var item in accountIds)
                            {
                                var sql = $"INSERT INTO TimeScheduleTemplateBlockAccount (TimeScheduleTemplateBlockId, AccountId) VALUES ({block.TimeScheduleTemplateBlockId}, {item})";
                                FrownedUponSQLClient.ExcuteQuery(connection, sql);
                                count++;
                            }
                        }
                    }

                    LogInfo($"templateblocks done " + count.ToString());
                    count = 0;
                    foreach (var groupByEmployee in blocks.GroupBy(i => i.EmployeeId))
                    {
                        List<EmployeeAccount> employeeAccounts = null;

                        if (useAccountHierarchy)
                        {
                            int employeeId = groupByEmployee.First().EmployeeId.Value;
                            employeeAccounts = EmployeeManager.GetEmployeeAccounts(entities, actorCompanyId, employeeId);
                        }

                        foreach (TimeScheduleTemplateBlock block in groupByEmployee.ToList())
                        {
                            var shiftType = shiftTypes.FirstOrDefault(f => f.ShiftTypeId == block.ShiftTypeId);

                            if (shiftType == null || shiftType.AccountInternal.IsNullOrEmpty())
                                continue;

                            var accountIds = block.GetAccountIdForResetingAccounting(employeeAccounts, shiftType, accountDimId, accounts, accountDims);
                            var existingIds = new List<int>();
                            var incorrectExistingIds = new List<int>();

                            if (!block.AccountInternal.IsNullOrEmpty())
                            {
                                existingIds = block.AccountInternal.Select(s => s.AccountId).ToList();
                                incorrectExistingIds = block.AccountInternal.Select(s => s.AccountId).Where(w => !accountIds.Contains(w)).ToList();
                            }
                            accountIds = accountIds.Where(w => !existingIds.Contains(w)).ToList();

                            foreach (var item in incorrectExistingIds)
                            {
                                if (accountIds.Any())
                                {
                                    int accountId = accountIds.First();
                                    var sql = $"update TimeScheduleTemplateBlockAccount set AccountId = {accountId} where TimeScheduleTemplateBlockId = {block.TimeScheduleTemplateBlockId} and AccountId = {item}";
                                    FrownedUponSQLClient.ExcuteQuery(connection, sql);
                                    accountIds.Remove(accountId);
                                }
                                else
                                {
                                    var sql = $"Delete from TimeScheduleTemplateBlockAccount where TimeScheduleTemplateBlockId = {block.TimeScheduleTemplateBlockId} and AccountId = {item}";
                                    FrownedUponSQLClient.ExcuteQuery(connection, sql);
                                }
                            }

                            foreach (var item in accountIds)
                            {
                                var sql = $"INSERT INTO TimeScheduleTemplateBlockAccount (TimeScheduleTemplateBlockId, AccountId) VALUES ({block.TimeScheduleTemplateBlockId}, {item})";
                                FrownedUponSQLClient.ExcuteQuery(connection, sql);
                                count++;
                            }
                        }
                    }

                    LogInfo($"blocks done " + count.ToString());
                }

            }
            catch (Exception ex)
            {
                return new ActionResult(ex, $"failed on actorcompanyId {actorCompanyId}");
            }

            return new ActionResult();
        }

        #endregion

        #region TimeScheduleTemplateBlockTask

        public List<TimeScheduleTemplateBlockTask> GetShiftTasks(int actorCompanyId, List<int> shiftIds)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlockTask.NoTracking();
            return (from t in entities.TimeScheduleTemplateBlockTask
                                .Include("TimeScheduleTask")
                                .Include("IncomingDeliveryRow")
                    where t.ActorCompanyId == actorCompanyId &&
                    t.TimeScheduleTemplateBlockId.HasValue && shiftIds.Contains(t.TimeScheduleTemplateBlockId.Value) &&
                    t.State == (int)SoeEntityState.Active
                    select t).ToList();
        }

        #endregion

        #region TimeScheduleTemplateBlock substitute

        public List<EmploymentContractShortSubstituteEmployee> GetEmployeesWithSubstituteShifts(int actorCompanyId, List<int> employeeIds, List<DateTime> dates, bool includeSubstituteShiftWithAbsence = false, bool loadAndFilterOnTimeScheduleType = false)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<SubstituteShiftDTO> substituteShifts = GetSubstituteShifts(entitiesReadOnly, actorCompanyId, employeeIds, dates, includeSubstituteShiftWithAbsence, loadAndFilterOnTimeScheduleType);
            List<int> employeesWithSubstituteShifts = substituteShifts.Select(x => x.EmployeeId).Distinct().ToList();
            List<EmploymentContractShortSubstituteEmployee> dtos = new List<EmploymentContractShortSubstituteEmployee>();
            employeesWithSubstituteShifts.ForEach(x => dtos.Add(new EmploymentContractShortSubstituteEmployee() { EmployeeId = x }));
            return dtos;
        }

        public List<SubstituteShiftDTO> GetSubstituteShifts(CompEntities entities, int actorCompanyId, int employeeId, DateTime from, DateTime to, bool includeSubstituteShiftWithAbsence = false, bool loadAndFilterOnTimeScheduleType = false)
        {
            List<DateTime> dates = CalendarUtility.GetDatesInInterval(from, to);
            return GetSubstituteShifts(entities, actorCompanyId, employeeId, dates, includeSubstituteShiftWithAbsence, loadAndFilterOnTimeScheduleType);
        }

        public List<SubstituteShiftDTO> GetSubstituteShifts(CompEntities entities, int actorCompanyId, int employeeId, List<DateTime> dates, bool includeSubstituteShiftWithAbsence = false, bool loadAndFilterOnTimeScheduleType = false)
        {
            return GetSubstituteShifts(entities, actorCompanyId, new List<int> { employeeId }, dates, includeSubstituteShiftWithAbsence, loadAndFilterOnTimeScheduleType);
        }

        public List<SubstituteShiftDTO> GetSubstituteShifts(CompEntities entities, int actorCompanyId, List<int> employeeIds, List<DateTime> dates, bool includeSubstituteShiftWithAbsence = false, bool loadAndFilterOnTimeScheduleType = false)
        {
            List<SubstituteShiftDTO> substituteShiftDTOs = new List<SubstituteShiftDTO>();
            bool dontIncludeCopiedOrMoved = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.SubstituteShiftDontIncludeCopiedOrMovedShifts, 0, actorCompanyId, 0);

            var employeeBatchSize = 500;

            if (dates.Count > 50)
                employeeBatchSize = 300;

            var handleEmployeIds = employeeIds;
            List<TimeScheduleTemplateBlock> shiftsAndBreaksAllEmployees = new List<TimeScheduleTemplateBlock>();

            while (handleEmployeIds.Any())
            {
                var currentBatch = handleEmployeIds.Take(employeeBatchSize).ToList();

                IQueryable<TimeScheduleTemplateBlock> query = (from tb in entities.TimeScheduleTemplateBlock
                                                               where !tb.TimeScheduleScenarioHeadId.HasValue &&
                                                               currentBatch.Contains(tb.EmployeeId.Value) &&
                                                               tb.Date.HasValue &&
                                                               dates.Contains(tb.Date.Value) &&
                                                               tb.StartTime != tb.StopTime &&
                                                               tb.State == (int)SoeEntityState.Active
                                                               select tb);
                if (loadAndFilterOnTimeScheduleType)
                    query = query.Include("TimeScheduleType");

                var shiftsAndBreaks = query.ToList();

                shiftsAndBreaksAllEmployees.AddRange(shiftsAndBreaks);
                handleEmployeIds = handleEmployeIds.Where(w => !currentBatch.Contains(w)).ToList();
            }

            List<int> allShiftIds = shiftsAndBreaksAllEmployees.Select(x => x.TimeScheduleTemplateBlockId).ToList();
            int batchSize = 2000;
            List<TimeScheduleTemplateBlockHistory> shiftsHistoryAllEmployees = new List<TimeScheduleTemplateBlockHistory>();

            while (allShiftIds.Count > 0)
            {
                // Take a batch from the beginning of the list
                var currentBatch = allShiftIds.Take(batchSize).ToList();

                // Perform the query with the current batch of shift IDs
                var shiftsHistoryBatch = (from t in entities.TimeScheduleTemplateBlockHistory
                                          where currentBatch.Contains(t.TimeScheduleTemplateBlockId)
                                          select t).ToList();

                // Add the results from this batch to the main list
                shiftsHistoryAllEmployees.AddRange(shiftsHistoryBatch);

                // Remove the handled batch of shift IDs from the list
                allShiftIds = allShiftIds.Where(w => !currentBatch.Contains(w)).ToList();
            }

            // After collecting all histories, order them by the 'Created' property
            shiftsHistoryAllEmployees = shiftsHistoryAllEmployees.OrderByDescending(t => t.Created).ToList();

            foreach (var employeeId in employeeIds)
            {
                List<TimeScheduleTemplateBlock> shiftsAndBreaks = shiftsAndBreaksAllEmployees.Where(x => x.EmployeeId == employeeId).ToList();
                List<TimeScheduleTemplateBlock> shifts = shiftsAndBreaks.Where(x => x.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                List<TimeScheduleTemplateBlock> breaks = shiftsAndBreaks.Where(x => x.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();

                foreach (var shift in shifts)
                {
                    if (!shift.Date.HasValue)
                        continue;

                    if (!shift.TimeScheduleType?.IgnoreIfExtraShift ?? true)
                    {
                        int totalBreakMinutes = 0;
                        if (shift.TimeScheduleEmployeePeriodId.HasValue)
                        {
                            List<TimeScheduleTemplateBlock> employeePeriodbreaks = shiftsAndBreaks.Where(x => x.IsBreak && x.TimeScheduleEmployeePeriodId == shift.TimeScheduleEmployeePeriodId.Value).ToList();

                            foreach (var employeePeriodbreak in employeePeriodbreaks)
                            {
                                totalBreakMinutes += (int)CalendarUtility.GetNewTimeInCurrent(shift.StartTime, shift.StopTime, employeePeriodbreak.StartTime, employeePeriodbreak.StopTime).TotalMinutes;
                            }
                        }

                        List<TimeScheduleTemplateBlockHistory> allShiftHistory = shiftsHistoryAllEmployees.Where(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId).ToList();

                        #region First: Look for absence

                        // look if it has an IsOriginatedFromAnotherShift history
                        if (allShiftHistory.Any(x => x.IsNew()) && allShiftHistory.Any(x => x.IsOriginatedFromAnotherShift()))
                        {
                            TimeScheduleTemplateBlockHistory originatedFromAnotherShiftHistoryRecord = allShiftHistory.FirstOrDefault(x => x.IsOriginatedFromAnotherShift());
                            TimeScheduleTemplateBlockHistory originShiftAbsenceHistoryRecord = GetTimeScheduleTemplateBlockAbsenceHistoryRecord(entities, actorCompanyId, originatedFromAnotherShiftHistoryRecord);
                            if (originShiftAbsenceHistoryRecord != null)
                            {
                                #region Shift is originated from absence

                                if ((!shift.TimeDeviationCauseId.HasValue || includeSubstituteShiftWithAbsence) && originShiftAbsenceHistoryRecord.CurrentEmployeeId.HasValue && originShiftAbsenceHistoryRecord.ToTimeDeviationCauseId.HasValue && originShiftAbsenceHistoryRecord.CurrentEmployeeId.Value != employeeId)
                                {
                                    Employee originEmployee = EmployeeManager.GetEmployee(originShiftAbsenceHistoryRecord.CurrentEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                                    TimeDeviationCause deviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(originShiftAbsenceHistoryRecord.ToTimeDeviationCauseId.Value, actorCompanyId, false);
                                    substituteShiftDTOs.Add(
                                        new SubstituteShiftDTO
                                        {
                                            EmployeeId = employeeId,
                                            Date = shift.ActualStartTime.Value.Date,
                                            StartTime = shift.StartTime,
                                            StopTime = shift.StopTime,
                                            TotalBreakMinutes = totalBreakMinutes,
                                            IsAssignedDueToAbsence = true,
                                            OriginEmployeeName = originEmployee != null ? originEmployee.Name : string.Empty,
                                            AbsenceName = deviationCause != null ? deviationCause.Name : string.Empty,
                                            Link = shift.Link
                                        });
                                }

                                #endregion

                                continue;
                            }
                        }

                        #endregion

                        #region Second: Shift is marked as an extra shift

                        if (shift.ExtraShift)
                        {
                            substituteShiftDTOs.Add(
                                 new SubstituteShiftDTO
                                 {
                                     EmployeeId = employeeId,
                                     Date = shift.ActualStartTime.Value.Date,
                                     StartTime = shift.StartTime,
                                     StopTime = shift.StopTime,
                                     TotalBreakMinutes = totalBreakMinutes,
                                     IsExtraShift = true,
                                     Link = shift.Link
                                 });

                            continue;
                        }

                        #endregion

                        #region Third: Moved/Copied
                        if (dontIncludeCopiedOrMoved)
                            continue;

                        foreach (var shiftHistory in allShiftHistory)
                        {
                            if (shiftHistory.HasChangedEmployee())
                            {
                                #region Shift has been moved (Employee has changed)

                                if (shiftHistory.FromEmployeeId.HasValue)
                                {
                                    Employee originEmployee = EmployeeManager.GetEmployee(shiftHistory.FromEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                                    substituteShiftDTOs.Add(
                                     new SubstituteShiftDTO
                                     {
                                         EmployeeId = employeeId,
                                         Date = shift.ActualStartTime.Value.Date,
                                         StartTime = shift.StartTime,
                                         StopTime = shift.StopTime,
                                         TotalBreakMinutes = totalBreakMinutes,
                                         IsMoved = true,
                                         OriginEmployeeName = originEmployee != null ? originEmployee.Name : string.Empty,
                                         Link = shift.Link
                                     });
                                }

                                #endregion
                                break;
                            }

                            if (shiftHistory.IsNew() && shiftHistory.IsOriginatedFromAnotherShift())
                            {
                                #region Shift has been copied from another shift

                                if (shiftHistory.OriginEmployeeId.HasValue)
                                {
                                    Employee originEmployee = EmployeeManager.GetEmployee(shiftHistory.OriginEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                                    substituteShiftDTOs.Add(
                                     new SubstituteShiftDTO
                                     {
                                         EmployeeId = employeeId,
                                         Date = shift.ActualStartTime.Value.Date,
                                         StartTime = shift.StartTime,
                                         StopTime = shift.StopTime,
                                         TotalBreakMinutes = totalBreakMinutes,
                                         IsCopied = true,
                                         OriginEmployeeName = originEmployee != null ? originEmployee.Name : string.Empty,
                                         Link = shift.Link
                                     });
                                }

                                #endregion
                                break;
                            }
                        }

                        #endregion
                    }
                }
            }
            return substituteShiftDTOs;
        }

        #endregion

        #region TimeScheduleTemplateBlockHistory

        public TimeScheduleTemplateBlockHistory GetTimeScheduleTemplateBlockAbsenceHistoryRecord(CompEntities entities, int actorCompanyId, TimeScheduleTemplateBlockHistory newShiftHistoryRecord)
        {
            TimeScheduleTemplateBlockHistory originShiftAbsenceHistoryRecord = null;
            List<TimeScheduleTemplateBlockHistory> originShiftHistoryRecords = (from t in entities.TimeScheduleTemplateBlockHistory
                                                                                where t.TimeScheduleTemplateBlockId == newShiftHistoryRecord.OriginTimeScheduleTemplateBlockId
                                                                                orderby t.Created
                                                                                select t).ToList();

            #region Check if newshift if created because of absence

            if (originShiftHistoryRecords.Any(x => x.IsTimeDeviationCauseChanged()))
            {
                originShiftAbsenceHistoryRecord = originShiftHistoryRecords.Where(x => x.IsTimeDeviationCauseChanged()).OrderByDescending(x => x.Created).FirstOrDefault();
                if (originShiftAbsenceHistoryRecord != null && newShiftHistoryRecord.OriginEmployeeId.HasValue && originShiftAbsenceHistoryRecord.FromEmployeeId.HasValue && originShiftAbsenceHistoryRecord.ToEmployeeId.HasValue && originShiftAbsenceHistoryRecord.FromEmployeeId.Value == originShiftAbsenceHistoryRecord.ToEmployeeId.Value && newShiftHistoryRecord.OriginEmployeeId.Value == originShiftAbsenceHistoryRecord.ToEmployeeId.Value)
                {
                    var previousOrigin = originShiftHistoryRecords.FirstOrDefault(x => x.IsOriginatedFromAnotherShift());
                    //Fix for 74304. If a employee has a shift that is created because of absence, se if the absence was on the same employee as the employee that recieved the shift
                    //If yes look if the shift that I originate from is created because of absence and return that history record
                    if (previousOrigin != null && previousOrigin.CurrentEmployeeId.HasValue && newShiftHistoryRecord.CurrentEmployeeId.HasValue && previousOrigin.CurrentEmployeeId == newShiftHistoryRecord.CurrentEmployeeId)
                    {
                        return GetTimeScheduleTemplateBlockAbsenceHistoryRecord(entities, actorCompanyId, previousOrigin);
                    }
                }
            }


            #endregion

            if (originShiftAbsenceHistoryRecord != null && SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.SubstituteShiftIsAssignedDueToAbsenceOnlyIfSameBatch, 0, actorCompanyId, 0) && originShiftAbsenceHistoryRecord.BatchId != newShiftHistoryRecord.BatchId)
                return null;

            return originShiftAbsenceHistoryRecord;//null is returned if newShiftHistoryRecord is not originated from absence
        }

        public List<ShiftHistoryDTO> GetTimeScheduleTemplateBlockHistory(int actorCompanyId, int timeScheduleTemplateBlockId)
        {
            #region Load history records

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlockHistory.NoTracking();
            List<TimeScheduleTemplateBlockHistory> blocks = (from t in entities.TimeScheduleTemplateBlockHistory
                                                             where t.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId
                                                             orderby t.Created
                                                             select t).ToList();

            #endregion

            #region Convert to DTOs

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<ShiftHistoryDTO> dtos = ConvertToDto(entitiesReadOnly, blocks, actorCompanyId);

            #endregion

            return dtos;
        }

        public List<ShiftHistoryDTO> GetTimeScheduleTemplateBlockHistory(int actorCompanyId, List<int> timeScheduleTemplateBlockIds)
        {
            #region Load history records

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlockHistory.NoTracking();
            List<TimeScheduleTemplateBlockHistory> blocks = (from t in entities.TimeScheduleTemplateBlockHistory
                                                             where timeScheduleTemplateBlockIds.Contains(t.TimeScheduleTemplateBlockId)
                                                             orderby t.Created
                                                             select t).ToList();

            #endregion

            #region Convert to DTOs

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<ShiftHistoryDTO> dtos = ConvertToDto(entitiesReadOnly, blocks, actorCompanyId);

            #endregion

            return dtos;

        }

        public List<TrackChangesLogDTO> GetTimeScheduleTemplateBlockHistoryChanges(int actorCompanyId, List<int> timeScheduleTemplateBlockIds)
        {
            #region Load history records

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlockHistory.NoTracking();
            List<TimeScheduleTemplateBlock> blocks = (from t in entities.TimeScheduleTemplateBlock.Include("TimeScheduleTemplateBlockHistory")
                                                      where timeScheduleTemplateBlockIds.Contains(t.TimeScheduleTemplateBlockId)
                                                      orderby t.Created
                                                      select t).ToList();

            #endregion

            #region Convert to DTOs

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<TrackChangesLogDTO> dtos = ConvertToTrackChangesLogDto(entitiesReadOnly, blocks, actorCompanyId);

            #endregion

            return dtos;

        }

        #endregion

        #region TimeScheduleTemplateBlockQueue

        public IEnumerable<TimeScheduleShiftQueueDTO> GetShiftQueue(int timeScheduleTemplateBlockId, TermGroup_TimeScheduleTemplateBlockQueueType type, int actorCompanyId)
        {
            List<TimeScheduleShiftQueueDTO> list = new List<TimeScheduleShiftQueueDTO>();

            DateTime date = DateTime.Today;

            bool sortByLas = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningSortQueueByLas, 0, actorCompanyId, 0);
            if (sortByLas)
            {
                TimeScheduleTemplateBlock block = GetTimeScheduleTemplateBlock(timeScheduleTemplateBlockId);
                if (block.Date.HasValue)
                    date = block.Date.Value;
            }

            List<TimeScheduleTemplateBlockQueue> queues = GetShiftQueue(timeScheduleTemplateBlockId, type, true);
            if (queues.Any())
            {
                var terms = base.GetTermGroupDict(TermGroup.TimeScheduleTemplateBlockQueueType);

                foreach (TimeScheduleTemplateBlockQueue queue in queues.Where(q => q.Employee != null))
                {
                    // If employee is not active anymore, don't even add it to the list
                    if (queue.Employee == null || queue.Employee.State != (int)SoeEntityState.Active)
                        continue;

                    TimeScheduleShiftQueueDTO dto = new TimeScheduleShiftQueueDTO()
                    {
                        TimeScheduleTemplateBlockId = queue.TimeScheduleTemplateBlockId,
                        Type = queue.Type,
                        TypeName = terms.ContainsKey(queue.Type) ? terms[queue.Type] : String.Empty,
                        Date = queue.Date,
                        EmployeeId = queue.Employee.EmployeeId,
                        EmployeeName = queue.Employee.EmployeeNrAndName,
                        Sort = queue.Sort,
                        WantExtraShifts = queue.Employee.WantsExtraShifts
                    };

                    if (sortByLas)
                    {
                        using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                        dto.EmploymentDays = EmployeeManager.GetLasDays(entitiesReadOnly, actorCompanyId, queue.Employee, DateTime.Today);
                        DateTime? birthDate = CalendarUtility.GetBirthDateFromSecurityNumber(queue.Employee.SocialSec);
                        if (birthDate.HasValue)
                            dto.EmployeeAgeDays = (int)(date - birthDate.Value).TotalDays;
                    }

                    list.Add(dto);
                }
            }

            if (sortByLas)
                return list.OrderByDescending(l => l.WantExtraShifts).ThenByDescending(l => l.EmploymentDays).ThenByDescending(l => l.EmployeeAgeDays).ToList();
            else
                return list.OrderByDescending(l => l.WantExtraShifts).ThenBy(l => l.Sort);
        }

        public List<TimeScheduleTemplateBlockQueue> GetShiftQueue(int timeScheduleTemplateBlockId, TermGroup_TimeScheduleTemplateBlockQueueType type, bool loadEmployee = false, bool loadEmployments = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlockQueue.NoTracking();
            return GetShiftQueue(entities, timeScheduleTemplateBlockId, type, loadEmployee, loadEmployments);
        }

        public List<TimeScheduleTemplateBlockQueue> GetShiftQueue(CompEntities entities, int timeScheduleTemplateBlockId, TermGroup_TimeScheduleTemplateBlockQueueType type, bool loadEmployee = false, bool loadEmployments = false)
        {
            IQueryable<TimeScheduleTemplateBlockQueue> query = (from q in entities.TimeScheduleTemplateBlockQueue
                                                                where q.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId
                                                                select q);

            if (loadEmployee)
                query = query.Include("Employee.ContactPerson");
            if (loadEmployments)
                query = query.Include("Employee.Employment.EmploymentChangeBatch.EmploymentChange");

            if (type != TermGroup_TimeScheduleTemplateBlockQueueType.Unspecified)
                query = query.Where(q => q.Type == (int)type);

            return query.Where(w => w.State == (int)SoeEntityState.Active).OrderBy(q => q.Type).ThenBy(q => q.Sort).ToList();
        }

        public List<TimeScheduleTemplateBlockQueue> GetShiftQueuesForEmployeesForReport(CompEntities entities, List<int> employeeIds, DateTime fromDate, DateTime toDate)
        {
            return (from q in entities.TimeScheduleTemplateBlockQueue.Include("TimeScheduleTemplateBlock")
                    where q.TimeScheduleTemplateBlock.Date >= fromDate &&
                    q.TimeScheduleTemplateBlock.Date <= toDate &&
                   employeeIds.Contains(q.EmployeeId)
                    select q).ToList();
        }

        public List<TimeScheduleShiftQueueDTO> GetShiftQueuesForEmployee(CompEntities entities, int employeeId, DateTime date)
        {
            List<TimeScheduleTemplateBlockQueue> employeeQueue = (from q in entities.TimeScheduleTemplateBlockQueue.Include("TimeScheduleTemplateBlock")
                                                                  where q.TimeScheduleTemplateBlock.Date == date &&
                                                                  q.EmployeeId == employeeId &&
                                                                  q.State == (int)SoeEntityState.Active &&
                                                                  q.TimeScheduleTemplateBlock.State == (int)SoeEntityState.Active
                                                                  select q).ToList();


            List<TimeScheduleShiftQueueDTO> list = new List<TimeScheduleShiftQueueDTO>();
            if (!employeeQueue.IsNullOrEmpty())
            {
                var terms = base.GetTermGroupDict(TermGroup.TimeScheduleTemplateBlockQueueType);

                foreach (TimeScheduleTemplateBlockQueue queue in employeeQueue.Where(w => w.State == (int)SoeEntityState.Active))
                {
                    list.Add(new TimeScheduleShiftQueueDTO()
                    {
                        TimeScheduleTemplateBlockId = queue.TimeScheduleTemplateBlockId,
                        Type = queue.Type,
                        TypeName = terms.ContainsKey(queue.Type) ? terms[queue.Type] : String.Empty,
                        Date = queue.Date,
                        EmployeeId = queue.EmployeeId,
                        EmployeeName = queue.Employee.EmployeeNrAndName,
                        Sort = queue.Sort
                    });
                }
            }

            return list;
        }

        public bool HasQueue(int timeScheduleTemplateBlockId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return (from q in entities.TimeScheduleTemplateBlockQueue
                    where q.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId
                    select q).Any();
        }

        #endregion

        #region TimeScheduleType

        public List<TimeScheduleType> GetTimeScheduleTypes(int actorCompanyId, bool getAll = true, bool onlyActive = true, bool onlyUseScheduleTimeFactor = false, bool loadFactors = false, bool loadTimeDeviationCauses = false, int? timeScheduleTypeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleType.NoTracking();
            return GetTimeScheduleTypes(entities, actorCompanyId, getAll, onlyActive, onlyUseScheduleTimeFactor, loadFactors, loadTimeDeviationCauses, timeScheduleTypeId);
        }

        public List<TimeScheduleType> GetTimeScheduleTypes(CompEntities entities, int actorCompanyId, bool getAll = true, bool onlyActive = true, bool onlyUseScheduleTimeFactor = false, bool loadFactors = false, bool loadTimeDeviationCauses = false, int? timeScheduleTypeId = null)
        {
            IQueryable<TimeScheduleType> query = entities.TimeScheduleType;
            if (loadFactors)
                query = query.Include("TimeScheduleTypeFactor");
            if (loadTimeDeviationCauses)
                query = query.Include("TimeDeviationCause");

            if (timeScheduleTypeId.HasValidValue())
                query = query.Where(w => w.TimeScheduleTypeId == timeScheduleTypeId.Value);

            List<TimeScheduleType> timeScheduleTypes = (from t in query
                                                        where t.ActorCompanyId == actorCompanyId &&
                                                        (onlyActive ? t.State == (int)SoeEntityState.Active : t.State != (int)SoeEntityState.Deleted)
                                                        select t).ToList();

            //Post db-exec filtering
            timeScheduleTypes = timeScheduleTypes.Where(t => (getAll || !t.IsAll)).ToList();
            if (onlyUseScheduleTimeFactor)
                timeScheduleTypes = timeScheduleTypes.Where(t => t.UseScheduleTimeFactor).ToList();

            return timeScheduleTypes.OrderBy(t => t.Name).ToList();
        }

        public List<TimeScheduleType> GetTimeScheduleTypesIgnoreState(CompEntities entities, int actorCompanyId, bool loadFactors = false)
        {
            IQueryable<TimeScheduleType> query = entities.TimeScheduleType;
            if (loadFactors)
                query = query.Include("TimeScheduleTypeFactor");

            return (from t in query
                    where t.ActorCompanyId == actorCompanyId
                    select t).ToList();
        }

        public Dictionary<int, string> GetTimeScheduleTypesDict(int actorCompanyId, bool getAll = false, bool addEmptyRow = true)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeScheduleTypesDict(entities, actorCompanyId, getAll, addEmptyRow);
        }

        public Dictionary<int, string> GetTimeScheduleTypesDict(CompEntities entities, int actorCompanyId, bool getAll = false, bool addEmptyRow = true)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, " ");

            List<TimeScheduleType> timeScheduleTypes = GetTimeScheduleTypes(entities, actorCompanyId, getAll: getAll);
            foreach (TimeScheduleType timeScheduleType in timeScheduleTypes)
            {
                dict.Add(timeScheduleType.TimeScheduleTypeId, timeScheduleType.Name);
            }

            return dict;
        }

        public TimeScheduleType GetTimeScheduleType(int timeScheduleTypeId, bool loadFactors)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleType.NoTracking();
            return GetTimeScheduleType(entities, timeScheduleTypeId, loadFactors);
        }

        public TimeScheduleType GetTimeScheduleType(CompEntities entities, int timeScheduleTypeId, bool loadFactors)
        {
            IQueryable<TimeScheduleType> query = entities.TimeScheduleType;
            if (loadFactors)
                query = query.Include("TimeScheduleTypeFactor");

            return (from t in query
                    where t.TimeScheduleTypeId == timeScheduleTypeId
                    select t).FirstOrDefault();
        }

        public bool ExistsUseScheduleTimeTimeScheduleType(CompEntities entities, int actorCompanyId)
        {
            return (from t in entities.TimeScheduleType
                    where t.ActorCompanyId == actorCompanyId &&
                    t.UseScheduleTimeFactor &&
                    t.State == (int)SoeEntityState.Active
                    select t).Any();
        }

        private bool ExistsAllTimeScheduleType(CompEntities entities, int actorCompanyId, int? excludeTimeScheduleTypeId = null)
        {
            return (from t in entities.TimeScheduleType
                    where t.ActorCompanyId == actorCompanyId &&
                    t.IsAll &&
                    (!excludeTimeScheduleTypeId.HasValue || excludeTimeScheduleTypeId.Value != t.TimeScheduleTypeId) &&
                    t.State == (int)SoeEntityState.Active
                    select t).Any();
        }

        private bool HasTimeScheduleTypeRules(int timeScheduleTypeId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from r in entitiesReadOnly.TimeRuleRow
                    where r.TimeScheduleTypeId == timeScheduleTypeId &&
                    r.TimeRule.State == (int)SoeEntityState.Active
                    select r).Any();
        }

        private bool HasTimeScheduleTypeBlocks(int timeScheduleTypeId)
        {
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            return (from r in entitiesReadOnly.TimeScheduleTemplateBlock
                    where r.TimeScheduleTypeId == timeScheduleTypeId &&
                    r.State == (int)SoeEntityState.Active
                    select r).Any();
        }

        /// <summary>
        /// Insert or update a schedule type
        /// </summary>
        /// <param name="timeScheduleTypeInput">TimeScheduleType entity</param>
        /// <param name="actorCompanyId">Company Id</param>
        /// <returns>ActionResult</returns>
        public ActionResult SaveTimeScheduleType(TimeScheduleTypeDTO timeScheduleTypeInput, int actorCompanyId)
        {
            if (timeScheduleTypeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeScheduleType");

            ActionResult result = null;

            int timeScheduleTypeId = timeScheduleTypeInput.TimeScheduleTypeId;

            base.FlushFromCache<List<TimeScheduleType>>(CacheConfig.Company(actorCompanyId), BusinessCacheType.TimeScheduleType);

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region TimeScheduleType

                        if (timeScheduleTypeInput.IsAll && ExistsAllTimeScheduleType(entities, actorCompanyId, timeScheduleTypeInput.TimeScheduleTypeId.ToNullable()))
                            return new ActionResult((int)ActionResultSave.TimeScheduleTypeAllAlreadyExists, GetText(10032, "Det finns redan en schematyp markerad som 'Alla'"));

                        if (!timeScheduleTypeInput.UseScheduleTimeFactor && timeScheduleTypeInput.Factors != null && timeScheduleTypeInput.Factors.Count > 0)
                            timeScheduleTypeInput.Factors.Clear();

                        bool changeAffectTerminal = false;
                        WebPubSubMessageAction action = WebPubSubMessageAction.Undefined;

                        // Get existing skill type
                        TimeScheduleType timeScheduleType = GetTimeScheduleType(entities, timeScheduleTypeId, true);
                        if (timeScheduleType == null)
                        {
                            #region Add

                            timeScheduleType = new TimeScheduleType()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(timeScheduleType);
                            entities.TimeScheduleType.AddObject(timeScheduleType);

                            if (timeScheduleTypeInput.ShowInTerminal)
                            {
                                changeAffectTerminal = true;
                                action = WebPubSubMessageAction.Insert;
                            }

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(timeScheduleType);

                            if (timeScheduleTypeInput.ShowInTerminal || timeScheduleType.ShowInTerminal)
                            {
                                // Only Name or showInTerminal is a relevant change for the terminal
                                if (timeScheduleType.Name != timeScheduleTypeInput.Name || timeScheduleType.ShowInTerminal != timeScheduleTypeInput.ShowInTerminal)
                                {
                                    changeAffectTerminal = true;
                                    action = WebPubSubMessageAction.Update;
                                }
                            }

                            #endregion
                        }

                        #region Set fields

                        timeScheduleType.IsBilagaJ = timeScheduleTypeInput.IsBilagaJ;
                        timeScheduleType.IgnoreIfExtraShift = timeScheduleTypeInput.IgnoreIfExtraShift;
                        timeScheduleType.Code = timeScheduleTypeInput.Code;
                        timeScheduleType.Name = timeScheduleTypeInput.Name;
                        timeScheduleType.Description = timeScheduleTypeInput.Description;
                        timeScheduleType.IsAll = timeScheduleTypeInput.IsAll;
                        timeScheduleType.IsNotScheduleTime = timeScheduleTypeInput.IsNotScheduleTime;
                        timeScheduleType.UseScheduleTimeFactor = timeScheduleTypeInput.UseScheduleTimeFactor;
                        timeScheduleType.State = (int)timeScheduleTypeInput.State;
                        timeScheduleType.ShowInTerminal = timeScheduleTypeInput.ShowInTerminal;
                        timeScheduleType.TimeDeviationCauseId = timeScheduleTypeInput.TimeDeviationCauseId > 0 ? timeScheduleTypeInput.TimeDeviationCauseId : null;

                        #endregion

                        #endregion

                        #region TimeScheduleTypeFactor

                        #region Update/Delete

                        // Update or Delete existing TimeScheduleTypeFactor
                        if (timeScheduleType.TimeScheduleTypeFactor != null)
                        {
                            foreach (TimeScheduleTypeFactor factor in timeScheduleType.TimeScheduleTypeFactor.Where(s => s.State == (int)SoeEntityState.Active).ToList())
                            {
                                // Try get factor from input
                                TimeScheduleTypeFactorDTO factorInput = (from s in timeScheduleTypeInput.Factors
                                                                         where s.TimeScheduleTypeFactorId == factor.TimeScheduleTypeFactorId
                                                                         select s).FirstOrDefault();

                                if (factorInput != null)
                                {
                                    #region Update

                                    SetTimeScheduleTypeFactorValues(factor, factorInput);

                                    #endregion
                                }
                                else
                                {
                                    #region Delete

                                    factor.State = (int)SoeEntityState.Deleted;

                                    #endregion
                                }

                                SetModifiedProperties(factor);
                            }
                        }

                        #endregion

                        #region Add

                        if (timeScheduleTypeInput.Factors != null)
                        {
                            // Add all factors that is left in the input
                            foreach (TimeScheduleTypeFactorDTO factorInput in timeScheduleTypeInput.Factors.Where(s => s.TimeScheduleTypeFactorId == 0).ToList())
                            {
                                TimeScheduleTypeFactor factor = new TimeScheduleTypeFactor();
                                SetTimeScheduleTypeFactorValues(factor, factorInput);

                                timeScheduleType.TimeScheduleTypeFactor.Add(factor);
                                SetCreatedProperties(factor);
                            }
                        }

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            #region WebPubSub

                            if (changeAffectTerminal)
                                SendWebPubSubMessage(entities, base.ActorCompanyId, timeScheduleType, action);

                            #endregion

                            // Commit transaction
                            transaction.Complete();

                            timeScheduleTypeId = timeScheduleType.TimeScheduleTypeId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        // Set success properties
                        result.IntegerValue = timeScheduleTypeId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        private void SetTimeScheduleTypeFactorValues(TimeScheduleTypeFactor factor, TimeScheduleTypeFactorDTO factorInput)
        {
            factor.Factor = factorInput.Factor;
            factor.FromTime = factorInput.FromTime;
            factor.ToTime = factorInput.ToTime;
            if (factor.ToTime > CalendarUtility.DATETIME_DEFAULT.AddDays(1))
                factor.ToTime = CalendarUtility.DATETIME_DEFAULT.AddDays(1);
        }

        /// <summary>
        /// Sets a schedule types state to Deleted
        /// </summary>
        /// <param name="timeScheduleTypeId">Skill type to delete</param>
        /// <returns>ActionResult</returns>
        public ActionResult DeleteTimeScheduleType(int timeScheduleTypeId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                // Check relations
                if (HasTimeScheduleTypeRules(timeScheduleTypeId))
                    return new ActionResult((int)ActionResultDelete.TimeScheduleTypeHasRules);
                if (HasTimeScheduleTypeBlocks(timeScheduleTypeId))
                    return new ActionResult((int)ActionResultDelete.TimeScheduleTypeHasBlocks);

                #endregion

                TimeScheduleType timeScheduleType = GetTimeScheduleType(entities, timeScheduleTypeId, false);
                if (timeScheduleType == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeScheduleType");

                ActionResult result = ChangeEntityState(entities, timeScheduleType, SoeEntityState.Deleted, true);
                if (result.Success && timeScheduleType.ShowInTerminal)
                    SendWebPubSubMessage(entities, timeScheduleType.ActorCompanyId, timeScheduleType, WebPubSubMessageAction.Delete);

                return result;
            }
        }

        public ActionResult UpdateTimeScheduleTypesState(Dictionary<int, bool> scheduleTypes)
        {
            ActionResult result = null;

            using (CompEntities entities = new CompEntities())
            {
                foreach (KeyValuePair<int, bool> scheduleType in scheduleTypes)
                {
                    TimeScheduleType originalTimeScheduleType = GetTimeScheduleType(entities, scheduleType.Key, false);
                    if (originalTimeScheduleType == null)
                        return new ActionResult((int)ActionResultSave.EntityNotFound, "TimeScheduleType");

                    ChangeEntityState(originalTimeScheduleType, scheduleType.Value ? SoeEntityState.Active : SoeEntityState.Inactive);
                }

                result = SaveChanges(entities);
            }

            return result;
        }

        private void SendWebPubSubMessage(CompEntities entities, int actorCompanyId, TimeScheduleType timeScheduleType, WebPubSubMessageAction action)
        {
            List<int> terminalIds = TimeStampManager.GetTimeTerminalIdsForPubSub(entities, actorCompanyId);
            foreach (int terminalId in terminalIds)
            {
                base.WebPubSubSendMessage(GoTimeStampExtensions.GetTerminalPubSubKey(actorCompanyId, terminalId), timeScheduleType.GetUpdateMessage(action));
            }
        }

        #endregion

        #region TimeSchedulePlanning

        #region Month view       

        /// <summary>
        /// Get month schedule for one employee
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="userId">User ID</param>
        /// <param name="dateFrom">Date range from</param>
        /// <param name="dateTo">Date range to</param>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="displayMode">TimeSchedulePlanning display mode</param>
        /// <param name="blockTypes">List of selected block types</param>
        /// <param name="filteredShiftTypeIds">Filtered shift types</param>
        /// <param name="absence">Filtered absence/prescense</param>
        /// <param name="deviationCauseIds">Filtered deviation causes</param>
        /// <returns>Collection of TimeSchedulePlanningMonthDTOs</returns>
        public IEnumerable<TimeSchedulePlanningMonthDTO> GetTimeSchedulePlanningPeriods_ByProcedure(int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, int employeeId, TimeSchedulePlanningDisplayMode displayMode, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredShiftTypeIds = null, bool? absence = null, List<int> deviationCauseIds = null, bool isMobile = false, int? timeScheduleScenarioHeadId = null)
        {
            #region Prereq
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            bool showSummary = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningCalendarViewShowDaySummary, 0, actorCompanyId, 0);
            bool shiftTypesFilteredByUser = filteredShiftTypeIds != null;
            List<TimeScheduleTypeDTO> scheduleTypes = (showSummary || isMobile) ? GetTimeScheduleTypes(actorCompanyId, getAll: true, onlyActive: true, loadFactors: true).ToDTOs(true).ToList() : new List<TimeScheduleTypeDTO>();

            // Get holidays
            List<HolidayDTO> holidays = CalendarManager.GetHolidaysByCompany(actorCompanyId, dateFrom, dateTo);

            filteredShiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, displayMode == TimeSchedulePlanningDisplayMode.Admin, dateFrom, dateTo, true, blockTypes, filteredShiftTypeIds);

            List<int> validAccountIds = null;
            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);
            if (useAccountHierarchy)
            {
                if (displayMode == TimeSchedulePlanningDisplayMode.Admin)
                    validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, dateFrom, dateTo);
                else
                    validAccountIds = AccountManager.GetValidAccountIdsForEmployee(actorCompanyId, employeeId, dateFrom, dateTo, false, true, false);
            }

            #endregion        

            #region Open shifts

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<GetTimeSchedulePlanningPeriods_Result> openBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
                dateFrom,
                dateTo,
                hiddenEmployeeId.ToString(),
                !filteredShiftTypeIds.IsNullOrEmpty() ? String.Join(",", filteredShiftTypeIds) : null,
                false,
                false,
                absence,
                !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
                (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Open,
                null,
                timeScheduleScenarioHeadId).ToList();

            #endregion            

            #region Assigned shifts for specified employee
            List<GetTimeSchedulePlanningPeriods_Result> empBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
    dateFrom,
    dateTo,
    employeeId.ToString(),
    shiftTypesFilteredByUser && !filteredShiftTypeIds.IsNullOrEmpty() ? String.Join(",", filteredShiftTypeIds) : null,
    false,
    (showSummary || isMobile),
    absence,
    !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
    (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned,
    null,
    timeScheduleScenarioHeadId).ToList();

            List<GetTimeSchedulePlanningPeriods_Result> empBreakBlocks = empBlocks.Where(b => b.BreakType > 0).ToList();
            empBlocks = empBlocks.Where(b => b.BreakType == 0).ToList();

            #endregion            

            #region Wanted shifts for specified employee
            List<GetTimeSchedulePlanningPeriods_Result> wantedBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
                dateFrom,
                dateTo,
                null,
                !filteredShiftTypeIds.IsNullOrEmpty() ? String.Join(",", filteredShiftTypeIds) : null,
                false,
                false,
                absence,
                !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
                null,
                employeeId,
                timeScheduleScenarioHeadId).ToList();

            #endregion

            #region Convert to DTOs

            // One record for each date in range and type
            List<TimeSchedulePlanningMonthDTO> result = new List<TimeSchedulePlanningMonthDTO>();
            DateTime currentDate = dateFrom;
            while (currentDate <= dateTo)
            {
                // Get blocks for current date
                DateTime currentDateFrom = CalendarUtility.GetBeginningOfDay(currentDate);
                DateTime currentDateTo = CalendarUtility.GetEndOfDay(currentDate);

                TimeSchedulePlanningMonthDTO dto = new TimeSchedulePlanningMonthDTO()
                {
                    Date = currentDate
                };

                HolidayDTO holiday = holidays.FirstOrDefault(h => h.Date == currentDate);
                dto.DayDescription = holiday != null ? holiday.Name : String.Empty;

                // Create separate list for each type
                var openCurrentBlocks = openBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo && (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();
                if (useAccountHierarchy)
                    openCurrentBlocks = openCurrentBlocks.Where(x => x.AccountId.HasValue && validAccountIds.Contains(x.AccountId.Value)).ToList();

                if (openCurrentBlocks.Any())
                {
                    // Open
                    dto.Open = openCurrentBlocks.Count;
                    dto.OpenToolTip = CreateTimeSchedulePlanningPeriodToolTip(openCurrentBlocks, TimeSchedulePlanningMonthDTOStatusType.Open, false, true, false);
                }

                List<GetTimeSchedulePlanningPeriods_Result> assignedShifts = null;
                List<GetTimeSchedulePlanningPeriods_Result> empCurrentBreakBlocks = empBreakBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo).ToList();
                var empCurrentBlocks = empBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo && (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();
                if (empCurrentBlocks.Any())
                {
                    // Assigned
                    assignedShifts = empCurrentBlocks.Where(b => b.TimeDeviationCauseId == null).OrderBy(b => b.Type).ToList();
                    dto.Assigned = assignedShifts.Count;
                    dto.AssignedToolTip = CreateTimeSchedulePlanningPeriodToolTip(assignedShifts, TimeSchedulePlanningMonthDTOStatusType.Assigned, false, false, true);
                    if (isMobile)
                    {
                        dto.AssignedScheduleIn = empCurrentBlocks.GetScheduleIn();
                        dto.AssignedScheduleOut = empCurrentBlocks.GetScheduleOut();
                        dto.IsPartTimeAbsence = empCurrentBlocks.IsPartTimeAbsence();
                        dto.IsWholeDayAbsence = empCurrentBlocks.IsWholeDayAbsence();
                        dto.HasDescription = empCurrentBlocks.HasDescription();
                    }
                }

                var wantedCurrentBlocks = wantedBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo && (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();
                if (wantedCurrentBlocks.Any())
                {
                    // Wanted
                    dto.Wanted = wantedCurrentBlocks.Count;
                    dto.WantedToolTip = CreateTimeSchedulePlanningPeriodToolTip(wantedCurrentBlocks, TimeSchedulePlanningMonthDTOStatusType.Wanted, false, true, true);
                }

                if (empCurrentBlocks.Any())
                {
                    // Unwanted
                    List<GetTimeSchedulePlanningPeriods_Result> unwantedShifts = empCurrentBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Unwanted).ToList();
                    dto.Unwanted = unwantedShifts.Count;
                    dto.UnwantedToolTip = CreateTimeSchedulePlanningPeriodToolTip(unwantedShifts, TimeSchedulePlanningMonthDTOStatusType.Unwanted, false, false, true);

                    // AbsenceRequested
                    List<GetTimeSchedulePlanningPeriods_Result> absenceRequestedShifts = empCurrentBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested).ToList();
                    dto.AbsenceRequested = absenceRequestedShifts.Count;
                    dto.AbsenceRequestedToolTip = CreateTimeSchedulePlanningPeriodToolTip(absenceRequestedShifts, TimeSchedulePlanningMonthDTOStatusType.AbsenceRequested, false, false, true);

                    // AbsenceApproved
                    List<GetTimeSchedulePlanningPeriods_Result> absenceApprovedShifts = empCurrentBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceApproved).ToList();
                    dto.AbsenceApproved = absenceApprovedShifts.Count;
                    dto.AbsenceApprovedToolTip = CreateTimeSchedulePlanningPeriodToolTip(absenceApprovedShifts, TimeSchedulePlanningMonthDTOStatusType.AbsenceApproved, false, false, true);
                }

                // Summaries
                if ((showSummary || isMobile) && empCurrentBlocks != null && empCurrentBreakBlocks != null)
                {
                    List<GetTimeSchedulePlanningPeriods_Result> shiftsAndBreaks = new List<GetTimeSchedulePlanningPeriods_Result>();
                    shiftsAndBreaks.AddRange(empCurrentBlocks);
                    shiftsAndBreaks.AddRange(empCurrentBreakBlocks);

                    var dayDtos = CreateTimeSchedulePlanningDayDTOsForGrossNetCost(shiftsAndBreaks, true);
                    // Planned time
                    dto.PlannedMinutes = dayDtos.GetWorkMinutes(scheduleTypes);

                    // Work time (specified on employee group)
                    dto.WorkTimeMinutes = 0;
                }

                result.Add(dto);

                currentDate = currentDate.AddDays(1);
            }

            #endregion

            return result;
        }
        /// <summary>
        /// Get month schedule for one employee
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="userId">User ID</param>
        /// <param name="dateFrom">Date range from</param>
        /// <param name="dateTo">Date range to</param>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="displayMode">TimeSchedulePlanning display mode</param>
        /// <param name="blockTypes">List of selected block types</param>
        /// <param name="filteredShiftTypeIds">Filtered shift types</param>
        /// <param name="absence">Filtered absence/prescense</param>
        /// <param name="deviationCauseIds">Filtered deviation causes</param>
        /// <returns>Collection of TimeSchedulePlanningMonthDTOs</returns>
        public IEnumerable<TimeSchedulePlanningMonthSmallDTO> GetTimeSchedulePlanningPeriods_ByProcedureForEmployee(int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, int employeeId, TimeSchedulePlanningDisplayMode displayMode, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> filteredShiftTypeIds = null, bool? absence = null, List<int> deviationCauseIds = null, int? timeScheduleScenarioHeadId = null, bool includeOnDuty = false)
        {
            #region Prereq

            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entitiesReadonly, CacheConfig.Company(actorCompanyId));

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            List<TimeScheduleTypeDTO> scheduleTypes = GetTimeScheduleTypes(actorCompanyId, getAll: true, onlyActive: true, loadFactors: true).ToDTOs(true).ToList();

            filteredShiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, displayMode == TimeSchedulePlanningDisplayMode.Admin, dateFrom, dateTo, true, blockTypes, filteredShiftTypeIds);

            List<int> validAccountIds = null;
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);
            if (useAccountHierarchy)
            {
                if (displayMode == TimeSchedulePlanningDisplayMode.Admin)
                    validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, dateFrom, dateTo);
                else
                    validAccountIds = AccountManager.GetValidAccountIdsForEmployee(actorCompanyId, employeeId, dateFrom, dateTo, false, true, false);
            }

            #endregion

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<GetTimeSchedulePlanningPeriods_Result> allBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
                dateFrom,
                dateTo,
                String.Join(",", new List<int>() { hiddenEmployeeId, employeeId }),
                null,
                false,
                true,
                absence,
                !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
                null,
                null,
                timeScheduleScenarioHeadId).ToList();

            // On duty
            if (!includeOnDuty)
                allBlocks = allBlocks.Where(b => b.Type != (int)TermGroup_TimeScheduleTemplateBlockType.OnDuty).ToList();

            if (!filteredShiftTypeIds.IsNullOrEmpty())
            {
                var myShifts = allBlocks.Where(x => x.EmployeeId == employeeId).ToList();
                var othersShifts = allBlocks.Where(x => x.EmployeeId != employeeId && (!x.ShiftTypeId.HasValue || filteredShiftTypeIds.Contains(x.ShiftTypeId.Value))).ToList();
                allBlocks.Clear();
                allBlocks.AddRange(myShifts);
                allBlocks.AddRange(othersShifts);
            }

            List<GetTimeSchedulePlanningPeriods_Result> empBlocks = allBlocks.Where(b => b.EmployeeId == employeeId && b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned && (b.IsPreliminary == false)).ToList();
            List<GetTimeSchedulePlanningPeriods_Result> openBlocks = allBlocks.Where(b => b.EmployeeId == hiddenEmployeeId && b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Open && b.IsPreliminary == false).ToList();
            List<GetTimeSchedulePlanningPeriods_Result> empBreakBlocks = empBlocks.Where(b => b.BreakType > 0).ToList();
            empBlocks = empBlocks.Where(b => b.BreakType == 0).ToList();

            #region Convert to DTOs

            // One record for each date in range and type
            List<TimeSchedulePlanningMonthSmallDTO> result = new List<TimeSchedulePlanningMonthSmallDTO>();
            DateTime currentDate = dateFrom;
            while (currentDate <= dateTo)
            {
                // Get blocks for current date
                DateTime currentDateFrom = CalendarUtility.GetBeginningOfDay(currentDate);
                DateTime currentDateTo = CalendarUtility.GetEndOfDay(currentDate);

                TimeSchedulePlanningMonthSmallDTO dto = new TimeSchedulePlanningMonthSmallDTO()
                {
                    Date = currentDate
                };

                // Create separate list for each type
                var openCurrentBlocks = openBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo && (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();
                if (useAccountHierarchy)
                    openCurrentBlocks = openCurrentBlocks.Where(x => x.AccountId.HasValue && validAccountIds.Contains(x.AccountId.Value)).ToList();

                if (openCurrentBlocks.Any())
                {
                    // Open
                    dto.Open = openCurrentBlocks.Count;
                }

                List<GetTimeSchedulePlanningPeriods_Result> empCurrentBreakBlocks = empBreakBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo).ToList();
                var empCurrentBlocks = empBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo && (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();
                if (empCurrentBlocks.Any())
                {
                    dto.AssignedScheduleIn = empCurrentBlocks.GetScheduleIn();
                    dto.AssignedScheduleOut = empCurrentBlocks.GetScheduleOut();
                    dto.IsPartTimeAbsence = empCurrentBlocks.IsPartTimeAbsence();
                    dto.IsWholeDayAbsence = empCurrentBlocks.IsWholeDayAbsence();
                    dto.HasDescription = empCurrentBlocks.HasDescription();
                    dto.HasOnDuty = empCurrentBlocks.HasOnDuty();
                }

                if (empCurrentBlocks.Any())
                {
                    // Unwanted
                    List<GetTimeSchedulePlanningPeriods_Result> unwantedShifts = empCurrentBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Unwanted).ToList();
                    dto.Unwanted = unwantedShifts.Count;

                    // AbsenceRequested
                    List<GetTimeSchedulePlanningPeriods_Result> absenceRequestedShifts = empCurrentBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested).ToList();
                    dto.AbsenceRequested = absenceRequestedShifts.Count;

                    // Order type
                    List<GetTimeSchedulePlanningPeriods_Result> orderShifts = empCurrentBlocks.Where(b => b.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Order).ToList();
                    var orderShiftsCount = orderShifts.Count;
                    dto.HasTypeOrder = orderShiftsCount > 0;
                    dto.TypeOrderColor = orderShiftsCount == 1 ? orderShifts.First().ShiftTypeColor : "";
                }

                // Summaries
                if (empCurrentBlocks != null && empCurrentBreakBlocks != null)
                {
                    List<GetTimeSchedulePlanningPeriods_Result> shiftsAndBreaks = new List<GetTimeSchedulePlanningPeriods_Result>();
                    shiftsAndBreaks.AddRange(empCurrentBlocks);
                    shiftsAndBreaks.AddRange(empCurrentBreakBlocks);

                    var dayDtos = CreateTimeSchedulePlanningDayDTOsForGrossNetCost(shiftsAndBreaks, true);
                    // Planned time
                    dto.PlannedMinutes = dayDtos.GetWorkMinutes(scheduleTypes);
                }

                result.Add(dto);

                currentDate = currentDate.AddDays(1);
            }

            #endregion

            return result;
        }

        /// <summary>
        /// Get month schedule for list of employees
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="userId">User ID</param>
        /// <param name="roleId">Role ID</param>
        /// <param name="dateFrom">Date range from</param>
        /// <param name="dateTo">Date range to</param>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="displayMode">TimeSchedulePlanning display mode</param>
        /// <param name="blockTypes">List of selected block types</param>
        /// <param name="employeeIds">List of employee ID's</param>
        /// <param name="filteredShiftTypeIds">List of ShiftType ID's to filter on, or null if no filter</param>
        /// <param name="preliminary">True = only preliminary shifts, false = no preliminary shifts, null = no filter</param>
        /// <param name="absence">True = only absence shifts, false = only presence shifts, null = no filter</param>
        /// <param name="deviationCauseIds">List of TimeDeviationCause ID's to filter on, or null if no filter</param>
        /// <param name="includeGrossNetAndCost">True if gross, net and costs should be included</param>
        /// <param name="includeToolTip">True if tooltip should be created for the 'plupps'</param>
        /// <param name="preliminaryPermission">If user has permission to see preliminary shifts</param>
        /// <returns>Collection of TimeSchedulePlanningMonthDTOs</returns>
        public IEnumerable<TimeSchedulePlanningMonthDTO> GetTimeSchedulePlanningPeriods_ByProcedure(int actorCompanyId, int userId, int roleId, DateTime dateFrom, DateTime dateTo, int employeeId, TimeSchedulePlanningDisplayMode displayMode, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> employeeIds = null, List<int> filteredShiftTypeIds = null, bool? preliminary = null, bool? absence = null, List<int> deviationCauseIds = null, bool includeGrossNetAndCost = false, bool includeToolTip = false, bool preliminaryPermission = true, bool includeEmploymentTaxAndSupplementChargeCost = false, int? timeScheduleScenarioHeadId = null, bool includeHolidaySalary = false)
        {
            #region Prereq

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            // Company setting overrides init parameter if company setting is false
            if (includeGrossNetAndCost)
                includeGrossNetAndCost = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.PayrollAgreementUseGrossNetTimeInStaffing, 0, actorCompanyId, 0);

            bool showSummary = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningCalendarViewShowDaySummary, 0, actorCompanyId, 0);
            bool countEmployees = SettingManager.GetBoolSetting(SettingMainType.User, (int)UserSettingType.TimeSchedulePlanningCalendarViewCountType, userId, actorCompanyId, 0);

            filteredShiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, displayMode == TimeSchedulePlanningDisplayMode.Admin, dateFrom, dateTo, true, blockTypes, filteredShiftTypeIds);

            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);
            List<int> validAccountIds = null;
            if (useAccountHierarchy)
            {
                if (displayMode == TimeSchedulePlanningDisplayMode.Admin)
                    validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, dateFrom, dateTo);
                else
                    validAccountIds = AccountManager.GetValidAccountsForEmployee(actorCompanyId, employeeId, 0, 0, dateFrom, dateTo, onlyParents: true).Select(x => x.AccountId).ToList();
            }

            // If no permission to see preliminary shifts, always pass false to procedure
            if (!preliminaryPermission)
                preliminary = false;

            #endregion        

            #region Shifts

            // Get work blocks
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<GetTimeSchedulePlanningPeriods_Result> allBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
                dateFrom,
                dateTo,
                String.Join(",", employeeIds),
                !filteredShiftTypeIds.IsNullOrEmpty() ? String.Join(",", filteredShiftTypeIds) : null,
                preliminary,
                showSummary,
                absence,
                !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
                null,
                null,
                timeScheduleScenarioHeadId).Where(p => (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();

            if (useAccountHierarchy && validAccountIds != null)
                allBlocks = allBlocks.Where(b => b.AccountId.HasValue && validAccountIds.Contains(b.AccountId.Value)).ToList();

            #endregion

            #region Convert to DTOs

            // Get breaks
            List<GetTimeSchedulePlanningPeriods_Result> breakBlocks = null;
            if (showSummary)
                breakBlocks = allBlocks.Where(b => b.BreakType > 0).ToList();

            // One record for each date in range and type
            List<TimeSchedulePlanningMonthDTO> result = new List<TimeSchedulePlanningMonthDTO>();
            DateTime currentDate = dateFrom;
            while (currentDate <= dateTo)
            {
                TimeSchedulePlanningMonthDTO dto = new TimeSchedulePlanningMonthDTO()
                {
                    Date = currentDate
                };

                // Get blocks for current date
                DateTime currentDateFrom = CalendarUtility.GetBeginningOfDay(currentDate);
                DateTime currentDateTo = CalendarUtility.GetEndOfDay(currentDate);
                List<GetTimeSchedulePlanningPeriods_Result> assignedShifts = null;
                List<GetTimeSchedulePlanningPeriods_Result> currentWorkBlocks = new List<GetTimeSchedulePlanningPeriods_Result>();
                if (showSummary)
                    currentWorkBlocks.AddRange(allBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo && p.BreakType == 0));
                else
                    currentWorkBlocks.AddRange(allBlocks.Where(p => p.Date >= currentDateFrom && p.Date <= currentDateTo)); // No breaks loaded

                if (currentWorkBlocks.Any())
                {
                    using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                    int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
                    // Create separate list for each type
                    // Open
                    List<GetTimeSchedulePlanningPeriods_Result> openShifts = currentWorkBlocks.Where(b => b.EmployeeId == hiddenEmployeeId && b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Open && b.IsPreliminary == false).ToList();
                    dto.Open = openShifts.Count;
                    dto.OpenToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(openShifts, TimeSchedulePlanningMonthDTOStatusType.Open, countEmployees, true, false) : String.Empty;

                    // Assigned
                    assignedShifts = currentWorkBlocks.Where(b => b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned && (b.IsPreliminary == false) && b.TimeDeviationCauseId == null).ToList();
                    dto.Assigned = countEmployees ? assignedShifts.Select(s => s.EmployeeId).Distinct().Count() : assignedShifts.Count;
                    dto.AssignedToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(assignedShifts, TimeSchedulePlanningMonthDTOStatusType.Assigned, countEmployees, true, false) : String.Empty;

                    // Wanted
                    List<GetTimeSchedulePlanningPeriods_Result> wantedShifts = currentWorkBlocks.Where(b => b.NbrOfWantedInQueue > 0).ToList();
                    dto.Wanted = countEmployees ? wantedShifts.Select(s => s.EmployeeId).Distinct().Count() : wantedShifts.Count;
                    dto.WantedToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(wantedShifts, TimeSchedulePlanningMonthDTOStatusType.Wanted, countEmployees, true, false) : String.Empty;

                    // Unwanted
                    List<GetTimeSchedulePlanningPeriods_Result> unwantedShifts = currentWorkBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Unwanted).ToList();
                    dto.Unwanted = countEmployees ? unwantedShifts.Select(s => s.EmployeeId).Distinct().Count() : unwantedShifts.Count;
                    dto.UnwantedToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(unwantedShifts, TimeSchedulePlanningMonthDTOStatusType.Unwanted, countEmployees, true, false) : String.Empty;

                    // AbsenceRequested
                    List<GetTimeSchedulePlanningPeriods_Result> absenceRequestedShifts = currentWorkBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested).ToList();
                    dto.AbsenceRequested = countEmployees ? absenceRequestedShifts.Select(s => s.EmployeeId).Distinct().Count() : absenceRequestedShifts.Count;
                    dto.AbsenceRequestedToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(absenceRequestedShifts, TimeSchedulePlanningMonthDTOStatusType.AbsenceRequested, countEmployees, true, false) : String.Empty;

                    // AbsenceApproved
                    List<GetTimeSchedulePlanningPeriods_Result> absenceApprovedShifts = currentWorkBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceApproved).ToList();
                    dto.AbsenceApproved = countEmployees ? absenceApprovedShifts.Select(s => s.EmployeeId).Distinct().Count() : absenceApprovedShifts.Count;
                    dto.AbsenceApprovedToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(absenceApprovedShifts, TimeSchedulePlanningMonthDTOStatusType.AbsenceApproved, countEmployees, true, false) : String.Empty;

                    // Preliminary
                    if (preliminaryPermission)
                    {
                        List<GetTimeSchedulePlanningPeriods_Result> preliminaryShifts = currentWorkBlocks.Where(b => b.IsPreliminary == true).ToList();
                        dto.Preliminary = countEmployees ? preliminaryShifts.Select(s => s.EmployeeId).Distinct().Count() : preliminaryShifts.Count;
                        dto.PreliminaryToolTip = includeToolTip ? CreateTimeSchedulePlanningPeriodToolTip(preliminaryShifts, TimeSchedulePlanningMonthDTOStatusType.Preliminary, countEmployees, true, false) : String.Empty;
                    }
                }

                // Summaries
                if (showSummary && assignedShifts != null)
                {
                    // Planned time
                    dto.PlannedMinutes = (int)assignedShifts.Sum(b => (b.ActualStopTime.Value - b.ActualStartTime.Value).TotalMinutes);
                    // Subtract breaks
                    dto.PlannedMinutes -= (int)breakBlocks.Where(b => b.Date == currentDate).Sum(b => (b.ActualStopTime.Value - b.ActualStartTime.Value).TotalMinutes);

                    // Net-/gross time and cost
                    if (includeGrossNetAndCost)
                    {
                        List<TimeSchedulePlanningDayDTO> dayDtos = CreateTimeSchedulePlanningDayDTOsForGrossNetCost(assignedShifts);
                        CalculateGrossNetAndCost(dayDtos, actorCompanyId, userId, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost);
                        foreach (TimeSchedulePlanningDayDTO dayDto in dayDtos)
                        {
                            dto.GrossTime += dayDto.GrossTime;
                            dto.TotalCost += dayDto.TotalCost;
                            dto.TotalCostIncEmpTaxAndSuppCharge += dayDto.TotalCostIncEmpTaxAndSuppCharge;
                        }
                    }

                    // Work time (specified on employee group)
                    dto.WorkTimeMinutes = 0;
                }

                result.Add(dto);

                currentDate = currentDate.AddDays(1);
            }

            if (includeHolidaySalary)
            {
                List<TimeSchedulePlanningDayDTO> holidaySalaryDtos = new List<TimeSchedulePlanningDayDTO>();
                AddHolidaySalaryGrossNetAndCost(entitiesReadOnly, holidaySalaryDtos, actorCompanyId, employeeIds, dateFrom, dateTo, includeEmploymentTaxAndSupplementChargeCost);
                foreach (var holidaySalaryDto in holidaySalaryDtos)
                {
                    var monthDto = result.FirstOrDefault(x => x.Date == holidaySalaryDto.ActualDate);
                    if (monthDto != null)
                    {
                        monthDto.TotalCost += holidaySalaryDto.TotalCost;
                    }
                    else
                    {
                        TimeSchedulePlanningMonthDTO dto = new TimeSchedulePlanningMonthDTO()
                        {
                            Date = currentDate,
                            TotalCost = holidaySalaryDto.TotalCost
                        };

                        result.Add(dto);
                    }
                }
            }


            #endregion

            return result;
        }

        public IEnumerable<TimeSchedulePlanningMonthDTO> GetTimeSchedulePlanningPeriodsGrossNetAndCost(int actorCompanyId, int userId, int roleId, DateTime dateFrom, DateTime dateTo, int employeeId, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> employeeIds = null, List<int> filteredShiftTypeIds = null, bool? preliminary = null, bool? absence = null, List<int> deviationCauseIds = null, bool preliminaryPermission = true, bool includeEmploymentTaxAndSupplementChargeCost = false, int? timeScheduleScenarioHeadId = null)
        {
            #region Prereq

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            filteredShiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, true, dateFrom, dateTo, true, blockTypes, filteredShiftTypeIds);

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            List<int> validAccountIds = null;
            if (useAccountHierarchy)
                validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, dateFrom, dateTo);

            // If no permission to see preliminary shifts, always pass false to procedure
            if (!preliminaryPermission)
                preliminary = false;

            #endregion

            #region Shifts

            // Get work blocks
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<GetTimeSchedulePlanningPeriods_Result> allBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
                dateFrom,
                dateTo,
                String.Join(",", employeeIds),
                !filteredShiftTypeIds.IsNullOrEmpty() ? String.Join(",", filteredShiftTypeIds) : null,
                preliminary,
                true,
                absence,
                !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
                null,
                null,
                timeScheduleScenarioHeadId).Where(p => (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();

            if (useAccountHierarchy && validAccountIds != null)
                allBlocks = allBlocks.Where(b => b.AccountId.HasValue && validAccountIds.Contains(b.AccountId.Value)).ToList();

            #endregion

            #region Convert to DTOs

            // Get breaks
            List<GetTimeSchedulePlanningPeriods_Result> breakBlocks = allBlocks.Where(b => b.BreakType > 0).ToList();

            // One record for each date in range and type
            List<TimeSchedulePlanningMonthDTO> result = new List<TimeSchedulePlanningMonthDTO>();
            DateTime currentDate = dateFrom;
            while (currentDate <= dateTo)
            {
                TimeSchedulePlanningMonthDTO dto = new TimeSchedulePlanningMonthDTO()
                {
                    Date = currentDate
                };

                // Get assigned shifts for current date
                List<GetTimeSchedulePlanningPeriods_Result> assignedShifts = allBlocks.Where(b =>
                    b.Date >= CalendarUtility.GetBeginningOfDay(currentDate) &&
                    b.Date <= CalendarUtility.GetEndOfDay(currentDate) &&
                    b.BreakType == 0 &&
                    b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned &&
                    b.IsPreliminary == false &&
                    b.TimeDeviationCauseId == null).ToList();

                // Planned time
                dto.PlannedMinutes = (int)assignedShifts.Sum(b => (b.ActualStopTime.Value - b.ActualStartTime.Value).TotalMinutes);
                // Subtract breaks
                dto.PlannedMinutes -= (int)breakBlocks.Where(b => b.Date == currentDate).Sum(b => (b.ActualStopTime.Value - b.ActualStartTime.Value).TotalMinutes);

                // Net-/gross time and cost
                List<TimeSchedulePlanningDayDTO> dayDtos = CreateTimeSchedulePlanningDayDTOsForGrossNetCost(assignedShifts);
                CalculateGrossNetAndCost(dayDtos, actorCompanyId, userId, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost);
                foreach (TimeSchedulePlanningDayDTO dayDto in dayDtos)
                {
                    dto.GrossTime += dayDto.GrossTime;
                    dto.TotalCost += dayDto.TotalCost;
                    dto.TotalCostIncEmpTaxAndSuppCharge += dayDto.TotalCostIncEmpTaxAndSuppCharge;
                }

                // Work time (specified on employee group)
                dto.WorkTimeMinutes = 0;

                result.Add(dto);

                currentDate = currentDate.AddDays(1);
            }

            #endregion

            return result;
        }

        public TimeSchedulePlanningMonthDetailDTO GetTimeSchedulePlanningPeriodDetails(int actorCompanyId, int userId, int roleId, DateTime date, int employeeId, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes = null, List<int> employeeIds = null, List<int> filteredShiftTypeIds = null, bool? preliminary = null, bool? absence = null, List<int> deviationCauseIds = null, bool preliminaryPermission = true, int? timeScheduleScenarioHeadId = null)
        {
            #region Prereq

            filteredShiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, true, CalendarUtility.GetBeginningOfDay(date), CalendarUtility.GetEndOfDay(date), true, blockTypes, filteredShiftTypeIds);

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            List<int> validAccountIds = null;
            if (useAccountHierarchy)
                validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, CalendarUtility.GetBeginningOfDay(date), CalendarUtility.GetEndOfDay(date));

            // If no permission to see preliminary shifts, always pass false to procedure
            if (!preliminaryPermission)
                preliminary = false;

            #endregion

            #region Shifts

            // Get work blocks
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<GetTimeSchedulePlanningPeriods_Result> allBlocks = entitiesReadOnly.GetTimeSchedulePlanningPeriods(actorCompanyId,
                CalendarUtility.GetBeginningOfDay(date),
                CalendarUtility.GetEndOfDay(date),
                String.Join(",", employeeIds),
                !filteredShiftTypeIds.IsNullOrEmpty() ? String.Join(",", filteredShiftTypeIds) : null,
                preliminary,
                false,
                absence,
                !deviationCauseIds.IsNullOrEmpty() ? String.Join(",", deviationCauseIds) : null,
                null,
                null,
                timeScheduleScenarioHeadId).Where(p => (blockTypes == null || blockTypes.Count == 0 || blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)p.Type))).ToList();

            if (useAccountHierarchy && validAccountIds != null)
                allBlocks = allBlocks.Where(b => b.AccountId.HasValue && validAccountIds.Contains(b.AccountId.Value)).ToList();

            #endregion

            #region Convert to DTOs

            TimeSchedulePlanningMonthDetailDTO dto = new TimeSchedulePlanningMonthDetailDTO()
            {
                Date = date
            };

            // Get blocks
            List<GetTimeSchedulePlanningPeriods_Result> assignedShifts = null;
            List<GetTimeSchedulePlanningPeriods_Result> currentWorkBlocks = new List<GetTimeSchedulePlanningPeriods_Result>();
            currentWorkBlocks.AddRange(allBlocks.Where(p => p.Date == date));

            if (currentWorkBlocks.Any())
            {
                // Create separate list for each type
                // Open
                List<GetTimeSchedulePlanningPeriods_Result> openShifts = currentWorkBlocks.Where(b => b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Open && b.IsPreliminary == false).ToList();
                dto.Open = CreateTimeSchedulePlanningMonthDetailShifts(openShifts, TimeSchedulePlanningMonthDTOStatusType.Open);

                // Assigned
                assignedShifts = currentWorkBlocks.Where(b => b.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned && (b.IsPreliminary == false) && b.TimeDeviationCauseId == null).ToList();
                dto.Assigned = CreateTimeSchedulePlanningMonthDetailShifts(assignedShifts, TimeSchedulePlanningMonthDTOStatusType.Assigned);

                // Wanted
                List<GetTimeSchedulePlanningPeriods_Result> wantedShifts = currentWorkBlocks.Where(b => b.NbrOfWantedInQueue > 0).ToList();
                dto.Wanted = CreateTimeSchedulePlanningMonthDetailShifts(wantedShifts, TimeSchedulePlanningMonthDTOStatusType.Wanted);

                // Unwanted
                List<GetTimeSchedulePlanningPeriods_Result> unwantedShifts = currentWorkBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Unwanted).ToList();
                dto.Unwanted = CreateTimeSchedulePlanningMonthDetailShifts(unwantedShifts, TimeSchedulePlanningMonthDTOStatusType.Unwanted);

                // AbsenceRequested
                List<GetTimeSchedulePlanningPeriods_Result> absenceRequestedShifts = currentWorkBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested).ToList();
                dto.AbsenceRequested = CreateTimeSchedulePlanningMonthDetailShifts(absenceRequestedShifts, TimeSchedulePlanningMonthDTOStatusType.AbsenceRequested);

                // AbsenceApproved
                List<GetTimeSchedulePlanningPeriods_Result> absenceApprovedShifts = currentWorkBlocks.Where(b => b.ShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceApproved).ToList();
                dto.AbsenceApproved = CreateTimeSchedulePlanningMonthDetailShifts(absenceApprovedShifts, TimeSchedulePlanningMonthDTOStatusType.AbsenceApproved);

                // Preliminary
                if (preliminaryPermission)
                {
                    List<GetTimeSchedulePlanningPeriods_Result> preliminaryShifts = currentWorkBlocks.Where(b => b.IsPreliminary == true).ToList();
                    dto.Preliminary = CreateTimeSchedulePlanningMonthDetailShifts(preliminaryShifts, TimeSchedulePlanningMonthDTOStatusType.Preliminary);
                }
                else
                    dto.Preliminary = new List<TimeSchedulePlanningMonthDetailShiftDTO>();
            }

            #endregion

            return dto;
        }

        private List<TimeSchedulePlanningMonthDetailShiftDTO> CreateTimeSchedulePlanningMonthDetailShifts(List<GetTimeSchedulePlanningPeriods_Result> blocks, TimeSchedulePlanningMonthDTOStatusType statusType)
        {
            List<TimeSchedulePlanningMonthDetailShiftDTO> dtos = new List<TimeSchedulePlanningMonthDetailShiftDTO>();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            blocks = blocks.OrderBy(b => b.EmployeeName).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime).ToList();

            foreach (var block in blocks)
            {
                TimeSchedulePlanningMonthDetailShiftDTO dto = new TimeSchedulePlanningMonthDetailShiftDTO();

                // Employee
                dto.EmployeeId = block.EmployeeId.Value;
                dto.EmployeeName = block.EmployeeName;

                // Time range
                if (block.StartTime == block.StopTime)
                    dto.ShiftTimeRange = GetText(296, (int)TermGroup.TimeSchedulePlanning, "Heldag");
                else
                    dto.ShiftTimeRange = String.Format("{0}-{1}", block.StartTime.ToShortTimeString(), block.StopTime.ToShortTimeString());

                // Shift type
                if (!String.IsNullOrEmpty(block.ShiftTypeName))
                    dto.ShiftTypeName = block.ShiftTypeName;
                else if (block.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Booking && !String.IsNullOrEmpty(block.Description))
                    dto.ShiftTypeName = block.Description;

                // Absence
                if (!String.IsNullOrEmpty(block.TimeDeviationCauseName))
                    dto.DeviationCauseName = block.TimeDeviationCauseName;

                // Preliminary
                dto.IsPreliminary = block.IsPreliminary == true;

                // Wanted by
                if (statusType == TimeSchedulePlanningMonthDTOStatusType.Wanted && block.NbrOfWantedInQueue > 0)
                {
                    // Get queue
                    List<TimeScheduleTemplateBlockQueue> queues = (from q in entitiesReadOnly.TimeScheduleTemplateBlockQueue.Include("Employee.ContactPerson")
                                                                   where q.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId &&
                                                                   q.Type == (int)TermGroup_TimeScheduleTemplateBlockQueueType.Wanted
                                                                   orderby q.Sort
                                                                   select q).ToList();

                    dto.Queue = String.Empty;
                    foreach (var queue in queues)
                    {
                        if (!String.IsNullOrEmpty(dto.Queue))
                            dto.Queue += ", ";
                        dto.Queue += queue.Employee.Name;
                    }
                }

                dtos.Add(dto);
            }

            return dtos;
        }

        private string CreateTimeSchedulePlanningPeriodToolTip(List<GetTimeSchedulePlanningPeriods_Result> blocks, TimeSchedulePlanningMonthDTOStatusType statusType, bool perEmployee, bool includeEmployeeName, bool oneShiftPerLine)
        {
            string toolTip = String.Empty;

            if (perEmployee)
                blocks = blocks.OrderBy(b => b.EmployeeName).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime).ToList();
            else
                blocks = blocks.OrderBy(b => b.StartTime).ThenBy(b => b.StopTime).ToList();

            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            int prevEmployeeId = 0;
            foreach (var block in blocks)
            {
                // Always put hidden employee on separate lines
                if (oneShiftPerLine || prevEmployeeId != block.EmployeeId.Value || block.Hidden)
                {
                    if (prevEmployeeId != 0)
                        toolTip += "\r\n";

                    // Employee
                    if (includeEmployeeName)
                        toolTip += block.EmployeeName;
                }
                else
                    toolTip += " |";

                // Time range
                if (block.StartTime == block.StopTime)
                    toolTip += String.Format(" {0}", GetText(296, (int)TermGroup.TimeSchedulePlanning, "Heldag"));
                else
                    toolTip += String.Format(" {0}-{1}", block.StartTime.ToShortTimeString(), block.StopTime.ToShortTimeString());

                // Shift type
                if (!String.IsNullOrEmpty(block.ShiftTypeName))
                    toolTip += String.Format(" {0}", block.ShiftTypeName);
                else if (block.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Booking && !String.IsNullOrEmpty(block.Description))
                    toolTip += String.Format(" {0}", block.Description);

                // Absence
                if (!String.IsNullOrEmpty(block.TimeDeviationCauseName))
                    toolTip += String.Format(", {0}", block.TimeDeviationCauseName);

                // Preliminary
                if (block.IsPreliminary == true)
                    toolTip += String.Format(" ({0})", GetText(3795, "prel"));

                // Wanted by
                if (statusType == TimeSchedulePlanningMonthDTOStatusType.Wanted && block.NbrOfWantedInQueue > 0)
                {
                    // Get queue
                    List<TimeScheduleTemplateBlockQueue> queues = (from q in entitiesReadOnly.TimeScheduleTemplateBlockQueue.Include("Employee.ContactPerson")
                                                                   where q.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId &&
                                                                   q.Type == (int)TermGroup_TimeScheduleTemplateBlockQueueType.Wanted
                                                                   orderby q.Sort
                                                                   select q).ToList();

                    int i = 1;
                    foreach (var queue in queues)
                    {
                        toolTip += (i == 1 ? String.Format(", {0}: ", GetText(3880, "önskat av")) : ", ");
                        toolTip += queue.Employee.Name;
                        i++;
                    }
                }

                prevEmployeeId = block.EmployeeId.Value;
            }

            return toolTip;
        }

        #endregion

        #region Day/schedule view

        /// <summary>
        /// Get schedule for one employee
        /// </summary>
        /// <param name="actorCompanyId">Company ID</param>
        /// <param name="userId">User ID</param>
        /// <param name="employeeId">Employee ID</param>
        /// <param name="dateFrom">Date range from</param>
        /// <param name="dateTo">Date range to</param>
        /// <param name="displayMode">TimeSchedulePlanning display mode</param>
        /// <param name="includeBreaks">True if breaks should be included</param>
        /// <returns></returns>
        public IEnumerable<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningShifts(int actorCompanyId, int roleId, int userId, int employeeId, DateTime dateFrom, DateTime dateTo, TimeSchedulePlanningDisplayMode displayMode, bool includeBreaks, int? timeScheduleScenarioHeadId = null, bool includeFreeShifts = true, bool includeWantedShifts = true, bool includeEmployeeRequests = true)
        {
            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool includeAttestStates = false;
            bool includeDeliveryAddress = false;

            // Get free shifts
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleEmployeePeriod.NoTracking();
            var openBlocksQuery = (from tb in entities.TimeScheduleTemplateBlock
                                                         .Include("TimeScheduleEmployeePeriod")
                                                         .Include("Employee.ContactPerson")
                                                         .Include("TimeScheduleType.TimeScheduleTypeFactor")
                                                         .Include("ShiftType.TimeScheduleType")
                                                         .Include("TimeDeviationCause")
                                   where tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId &&
                                   tb.Employee.State == (int)SoeEntityState.Active &&
                                   tb.TimeScheduleEmployeePeriod != null &&
                                   !tb.IsPreliminary &&
                                   (tb.Date.HasValue && tb.Date.Value <= dateTo && DbFunctions.AddDays(tb.Date.Value, DbFunctions.DiffDays(tb.StartTime, tb.StopTime)) >= dateFrom) &&
                                   (tb.StartTime != tb.StopTime) &&
                                   tb.ShiftStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Open &&
                                   tb.State == (int)SoeEntityState.Active
                                   select tb);

            // Get assigned shifts for specified employee
            var empBlocksQuery = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                                        .Include("TimeScheduleEmployeePeriod")
                                                        .Include("Employee.ContactPerson")
                                                        .Include("TimeScheduleType.TimeScheduleTypeFactor")
                                                        .Include("ShiftType.TimeScheduleType")
                                                        .Include("TimeDeviationCause")
                                  where tb.EmployeeId == employeeId &&
                                  tb.TimeScheduleEmployeePeriod != null &&
                                  !tb.IsPreliminary &&
                                  (tb.Date.HasValue && tb.Date.Value <= dateTo && DbFunctions.AddDays(tb.Date.Value, DbFunctions.DiffDays(tb.StartTime, tb.StopTime)) >= dateFrom) &&
                                  ((tb.StartTime != tb.StopTime && !tb.TimeDeviationCauseId.HasValue) || tb.TimeDeviationCauseId.HasValue) &&
                                  tb.State == (int)SoeEntityState.Active
                                  select tb);

            // Get wanted shifts for specified employee
            var wantedBlocksQuery = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                                            .Include("TimeScheduleEmployeePeriod")
                                                            .Include("Employee.ContactPerson")
                                                            .Include("TimeScheduleType.TimeScheduleTypeFactor")
                                                            .Include("ShiftType.TimeScheduleType")
                                                            .Include("TimeDeviationCause")
                                     where tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId &&
                                     tb.Employee.State == (int)SoeEntityState.Active &&
                                     tb.TimeScheduleEmployeePeriod != null &&
                                     !tb.IsPreliminary &&
                                     (tb.Date.HasValue && tb.Date.Value <= dateTo && DbFunctions.AddDays(tb.Date.Value, DbFunctions.DiffDays(tb.StartTime, tb.StopTime)) >= dateFrom) &&
                                     (tb.StartTime != tb.StopTime) &&
                                     tb.TimeScheduleTemplateBlockQueue.Any(q => q.State == (int)SoeEntityState.Active && q.EmployeeId == employeeId && q.Type == (int)TermGroup_TimeScheduleTemplateBlockQueueType.Wanted) &&
                                     tb.State == (int)SoeEntityState.Active
                                     select tb);

            List<int> shiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, displayMode == TimeSchedulePlanningDisplayMode.Admin, dateFrom, dateTo, true);

            // Filter on breaks
            if (!includeBreaks)
            {
                openBlocksQuery = openBlocksQuery.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None);
                empBlocksQuery = empBlocksQuery.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None);
                wantedBlocksQuery = wantedBlocksQuery.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None);
            }

            openBlocksQuery = openBlocksQuery.OrderBy(b => b.Date).ThenBy(b => b.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Schedule).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime);
            empBlocksQuery = empBlocksQuery.OrderBy(b => b.Date).ThenBy(b => b.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Schedule).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime);
            wantedBlocksQuery = wantedBlocksQuery.OrderBy(b => b.Date).ThenBy(b => b.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Schedule).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime);

            // Execute query
            List<TimeScheduleTemplateBlock> openBlocks = includeFreeShifts ? openBlocksQuery.ToList().Where(tb => timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue).ToList() : new List<TimeScheduleTemplateBlock>(); //NOSONAR
            List<TimeScheduleTemplateBlock> empBlocks = empBlocksQuery.ToList().Where(tb => timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue).ToList(); //NOSONAR
            List<TimeScheduleTemplateBlock> wantedBlocks = includeWantedShifts ? wantedBlocksQuery.ToList().Where(tb => timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue).ToList() : new List<TimeScheduleTemplateBlock>(); //NOSONAR

            // Filter on shift types
            if (shiftTypeIds.Any())
            {
                // This filter is performed after the actual SQL query.
                // The reason is that if there are a lot of shift types, the query will be too complex and will crash.
                openBlocks = openBlocks.Where(b => (b.ShiftTypeId.HasValue && shiftTypeIds.Contains(b.ShiftTypeId.Value)) || !b.ShiftTypeId.HasValue || b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
            }

            // Convert to DTO
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            dtos.AddRange(CreateTimeSchedulePlanningDayDTOs(openBlocks, actorCompanyId, employeeId, includeBreaks, true, includeAttestStates, includeDeliveryAddress, displayMode != TimeSchedulePlanningDisplayMode.User));
            dtos.AddRange(CreateTimeSchedulePlanningDayDTOs(empBlocks, actorCompanyId, employeeId, includeBreaks, true, includeAttestStates, includeDeliveryAddress, displayMode != TimeSchedulePlanningDisplayMode.User));
            List<TimeSchedulePlanningDayDTO> wanted = CreateTimeSchedulePlanningDayDTOs(wantedBlocks, actorCompanyId, employeeId, includeBreaks, true, includeAttestStates, includeDeliveryAddress, displayMode != TimeSchedulePlanningDisplayMode.User);
            foreach (var dto in wanted)
            {
                if (!dtos.Select(r => r.TimeScheduleTemplateBlockId).Contains(dto.TimeScheduleTemplateBlockId))
                    dtos.Add(dto);
            }

            // Absence requests (not approved yet)

            if (includeEmployeeRequests)
            {
                entities.EmployeeRequest.NoTracking();
                var reqs = (from r in entities.EmployeeRequest.Include("TimeDeviationCause")
                            where r.EmployeeId == employeeId &&
                            r.Type == (int)TermGroup_EmployeeRequestType.AbsenceRequest &&
                            (r.Start <= dateTo && r.Stop >= dateFrom) &&
                            r.Status == (int)TermGroup_EmployeeRequestStatus.RequestPending &&
                            r.State == (int)SoeEntityState.Active
                            select r);

                foreach (var req in reqs)
                {
                    dtos.Add(CreateTimeSchedulePlanningDayDTO(req, employeeId, displayMode != TimeSchedulePlanningDisplayMode.User));
                }
            }

            return dtos;
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningShifts_ByProcedure(int actorCompanyId, int userId, int employeeId, int roleId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds, TimeSchedulePlanningMode planningMode, TimeSchedulePlanningDisplayMode displayMode, bool includeSecondaryCategories, bool includeBreaks, bool includeGrossNetAndCost, bool includePreliminary = true, bool includeEmploymentTaxAndSupplementChargeCost = false, bool includeShiftRequest = false, bool includeAbsenceRequest = true, bool checkToIncludeDeliveryAdress = true, int? timeScheduleScenarioHeadId = null, bool loadZeroDays = false, bool dontChangeTimeOnZeroDays = false, bool setSwapShiftInfo = false, bool includeHolidaySalary = false, bool setIsLended = false, bool includeOnDuty = false, bool forceFilterOnAccounts = false, bool includeLeisureCodes = false)
        {
            using (CompEntities entities = new CompEntities())
            {
                entities.TimeScheduleTemplateBlock.NoTracking();
                entities.TimeScheduleTemplateBlock.NoTracking();
                return GetTimeSchedulePlanningShifts_ByProcedure(entities, actorCompanyId, userId, employeeId, roleId, dateFrom, dateTo, employeeIds, planningMode, displayMode, includeSecondaryCategories, includeBreaks, includeGrossNetAndCost, includePreliminary, includeEmploymentTaxAndSupplementChargeCost, includeShiftRequest, includeAbsenceRequest, checkToIncludeDeliveryAdress, timeScheduleScenarioHeadId, loadZeroDays, dontChangeTimeOnZeroDays, setSwapShiftInfo, includeHolidaySalary, setIsLended, includeOnDuty, forceFilterOnAccounts: forceFilterOnAccounts, includeLeisureCodes: includeLeisureCodes);
            }
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningShifts_ByProcedure(CompEntities entities, int actorCompanyId, int userId, int employeeId, int roleId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds, TimeSchedulePlanningMode planningMode, TimeSchedulePlanningDisplayMode displayMode, bool includeSecondaryCategories, bool includeBreaks, bool includeGrossNetAndCost, bool includePreliminary = true, bool includeEmploymentTaxAndSupplementChargeCost = false, bool includeShiftRequest = false, bool includeAbsenceRequest = true, bool checkToIncludeDeliveryAdress = true, int? timeScheduleScenarioHeadId = null, bool loadZeroDays = false, bool dontChangeTimeOnZeroDays = false, bool setSwapShiftInfo = false, bool includeHolidaySalary = false, bool setIsLended = false, bool includeOnDuty = false, bool forceFilterOnAccounts = false, List<Employee> employees = null, bool includeLeisureCodes = false)
        {
            #region Prereq

            double hours = (dateTo - dateFrom).TotalHours;
            bool isDayView = hours < 25;
            if (!isDayView || hours == 0)
            {
                dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
                dateTo = CalendarUtility.GetEndOfDay(dateTo);
            }

            // Company setting overrides init parameter if company setting is false
            if (includeGrossNetAndCost)
                includeGrossNetAndCost = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.PayrollAgreementUseGrossNetTimeInStaffing, 0, actorCompanyId, 0);

            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));

            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            bool loadingMySchedule = (employeeIds != null && employeeIds.Count == 1 && employeeIds[0] == employeeId);
            bool loadingOpenShifts = (employeeIds != null && employeeIds.Count == 1 && employeeIds[0] == hiddenEmployeeId);

            List<int> shiftTypeIds = null;
            if (loadingOpenShifts || (!loadingMySchedule && !useAccountHierarchy))
                shiftTypeIds = GetShiftTypeIdsForUser(entities, null, actorCompanyId, roleId, userId, employeeId, displayMode == TimeSchedulePlanningDisplayMode.Admin, dateFrom, dateTo, includeSecondaryCategories);

            List<int> validAccountIds = null;
            if (useAccountHierarchy)
            {
                bool useValidAccountsFromEmployee = false;

                if (displayMode == TimeSchedulePlanningDisplayMode.Admin)
                {
                    AccountHierarchyInput input = AccountHierarchyInput.GetInstance();
                    input.AddParamValue(AccountHierarchyParamType.IncludeAbstract, true);
                    validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, roleId, userId, dateFrom, dateTo, input);
                    if (!validAccountIds.Any())
                    {
                        // Admin has no valid accounts, check if the attest role has ended,
                        // in that case get valid accounts for normal employee
                        List<AttestRoleUser> attestRoleUsers = AttestManager.GetAttestRoleUsers(entities, actorCompanyId, userId, dateFrom, dateTo);
                        if (attestRoleUsers.IsNullOrEmpty())
                            useValidAccountsFromEmployee = true;
                    }
                }
                else
                    useValidAccountsFromEmployee = true;

                if (useValidAccountsFromEmployee)
                    validAccountIds = AccountManager.GetValidAccountsForEmployee(entities, actorCompanyId, employeeId, 0, 0, dateFrom, dateTo, onlyParents: true).Select(x => x.AccountId).ToList();
            }

            bool includeAttestStates = true;
            bool includeDeliveryAddress = checkToIncludeDeliveryAdress && includeDeliveryAddressOnOrder(entities, userId, actorCompanyId);

            // Cached data
            List<TimeDeviationCause> timeDeviationCauses = base.GetTimeDeviationCausesFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<ShiftType> shiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadTimeScheduleTypes: true);
            List<TimeScheduleType> timeScheduleTypes = base.GetTimeScheduleTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadFactors: true);
            List<EmployeeChild> employeeChilds = base.GetEmployeeChildsFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<AccountDTO> accounts = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId));

            #endregion

            entities.CommandTimeout = 300;
            var dayBeforeStart = dateFrom.AddDays(-1);
            var dayAfterEnd = dateTo.AddDays(1);

            List<GetTimeSchedulePlanningShifts_Result> allBlocks = GetGetTimeSchedulePlanningShifts_Result(entities, dayBeforeStart, dayAfterEnd, dateFrom, dateTo, employeeIds, shiftTypeIds, includeBreaks, loadZeroDays, timeScheduleScenarioHeadId, useAccountHierarchy, includePreliminary, loadingOpenShifts, planningMode, isDayView, accounts, validAccountIds, includeOnDuty, forceFilterOnAccounts: forceFilterOnAccounts);

            // Convert to DTOs
            List<TimeSchedulePlanningDayDTO> dtos = CreateTimeSchedulePlanningDayDTOs(entities, allBlocks, shiftTypes, timeScheduleTypes, timeDeviationCauses, employeeChilds, actorCompanyId, hiddenEmployeeId, employeeId, includeBreaks, false, includeAttestStates, includeDeliveryAddress, displayMode != TimeSchedulePlanningDisplayMode.User, validAccountIds: validAccountIds, dontChangeTimeOnZeroDays: dontChangeTimeOnZeroDays);

            // Add gross, net and cost
            if (includeGrossNetAndCost)
            {
                if (employees == null && employeeIds.IsNullOrEmpty())
                    employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, userId, roleId, dateFrom, dateTo, employeeIds, loadEmployment: true).ToList();

                CalculateGrossNetAndCost(dtos, actorCompanyId, 0, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost, employees: employees);
                if (includeHolidaySalary)
                    AddHolidaySalaryGrossNetAndCost(entities, dtos, actorCompanyId, employeeIds, dateFrom, dateTo, includeEmploymentTaxAndSupplementChargeCost);
            }

            if (includeShiftRequest)
            {
                SetHasShiftRequest(entities, actorCompanyId, allBlocks, dtos);
            }

            // Absence requests (not approved yet)
            if (includeAbsenceRequest)
            {
                entities.EmployeeRequest.NoTracking();
                List<EmployeeRequest> reqs = (from r in entities.EmployeeRequest.Include("TimeDeviationCause")
                                              where employeeIds.Contains(r.EmployeeId) &&
                                              r.Type == (int)TermGroup_EmployeeRequestType.AbsenceRequest &&
                                              (r.Start <= dateTo && r.Stop >= dateFrom) &&
                                              r.Status == (int)TermGroup_EmployeeRequestStatus.RequestPending &&
                                              r.State == (int)SoeEntityState.Active
                                              select r).ToList();

                foreach (EmployeeRequest req in reqs)
                {
                    dtos.Add(CreateTimeSchedulePlanningDayDTO(req, employeeId, displayMode != TimeSchedulePlanningDisplayMode.User));
                }
            }

            // Leisure codes
            if (includeLeisureCodes)
            {
                List<TimeScheduleEmployeePeriodDetail> details = GetTimeSchedulePlanningLeisureCodes(entities, dateFrom, dateTo, employeeIds);

                foreach (TimeScheduleEmployeePeriodDetail detail in details)
                {
                    dtos.Add(CreateTimeSchedulePlanningDayDTO(detail));
                }
            }

            if (setSwapShiftInfo)
            {
                SetSwapShiftInfo(dtos);
                List<TimeScheduleSwapRequestDTO> swapRequests = TimeScheduleManager.GetEmployeesSwapRequestApprovedRows(actorCompanyId, dtos.Select(d => d.EmployeeId).Distinct().ToList(), dateFrom, dateTo);
                foreach (TimeScheduleSwapRequestDTO swapRequest in swapRequests)
                {
                    foreach (TimeScheduleSwapRequestRowDTO row in swapRequest.Rows)
                    {
                        // Get intersecting shifts
                        foreach (TimeSchedulePlanningDayDTO dto in dtos.Where(d => d.EmployeeId == row.EmployeeId && d.StartTime <= row.ScheduleStop && d.StopTime >= row.ScheduleStart).ToList())
                        {
                            dto.HasSwapRequest = true;
                        }
                    }
                }
            }

            if (setIsLended)
                SetShiftIsLended(entities, actorCompanyId, userId, dtos);

            return dtos;
        }

        public List<TimeScheduleEmployeePeriodDetail> GetTimeSchedulePlanningLeisureCodes(CompEntities entities, DateTime dateFrom, DateTime dateTo, List<int> employeeIds)
        {
            DateTime dateFromBeginning = CalendarUtility.GetBeginningOfDay(dateFrom);
            DateTime dateToEnd = CalendarUtility.GetEndOfDay(dateTo);

            entities.TimeScheduleEmployeePeriod.NoTracking();
            entities.TimeScheduleEmployeePeriodDetail.NoTracking();

            return (from d in entities.TimeScheduleEmployeePeriodDetail
                    .Include("TimeScheduleEmployeePeriod")
                    .Include("TimeLeisureCode")
                    where d.Type == (int)SoeTimeScheduleEmployeePeriodDetailType.LeisureCode &&
                    employeeIds.Contains(d.TimeScheduleEmployeePeriod.EmployeeId) &&
                    d.TimeScheduleEmployeePeriod.Date >= dateFromBeginning &&
                    d.TimeScheduleEmployeePeriod.Date <= dateToEnd &&
                    d.TimeScheduleEmployeePeriod.State == (int)SoeEntityState.Active &&
                    d.State == (int)SoeEntityState.Active
                    select d).ToList();
        }

        private void AddHolidaySalaryGrossNetAndCost(CompEntities entities, List<TimeSchedulePlanningDayDTO> dtos, int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo, bool includeEmploymentTaxAndSupplementChargeCost)
        {
            var holidaySalryHolidays = GetHolidaySalaryHolidaysFromCache(entities, dateFrom.Date, dateTo.Date, CacheConfig.Company(actorCompanyId));
            if (!holidaySalryHolidays.Any())
                return;

            foreach (var employeeId in employeeIds)
            {
                var employee = EmployeeManager.GetEmployeeWithEmploymentAndEmploymentChangeBatch(employeeId, actorCompanyId);
                if (employee == null)
                    continue;

                foreach (var holiday in holidaySalryHolidays)
                {
                    int employeeGroupId = employee.GetEmployeeGroupId(holiday.Date);
                    EmployeeGroup employeeGroup = GetEmployeeGroupsWithDayTypesFromCache(entities, CacheConfig.Company(actorCompanyId)).FirstOrDefault(x => x.EmployeeGroupId == employeeGroupId);
                    if (employeeGroup == null)
                        continue;

                    if (!employeeGroup.EmployeeGroupDayType.Any(x => x.IsHolidaySalary && x.DayTypeId == holiday.DayTypeId && x.State == (int)SoeEntityState.Active))
                        continue;

                    List<TimeBlock> timeBlocksForDay = TimeBlockManager.GetTimeBlocks(entities, employeeId, holiday.Date, holiday.Date);
                    int? wholedayDeviationTimeDeviationCauseId = timeBlocksForDay.GetWholedayDeviationTimeDeviationCauseId();
                    if (wholedayDeviationTimeDeviationCauseId.HasValue)
                        continue;

                    var newDtos = GetHolidaySalaryGrossNetAndCostFromTemplateSchedule(entities, actorCompanyId, employeeId, holiday.Date, includeEmploymentTaxAndSupplementChargeCost);
                    foreach (var newDto in newDtos)
                    {
                        newDto.StartTime = newDto.StartTime.Date;
                        newDto.StopTime = newDto.StartTime;
                        newDto.TimeScheduleTemplateBlockId = 0;
                        var dto = dtos.FirstOrDefault(x => x.EmployeeId == employeeId && x.ActualDate == holiday.Date);
                        if (dto != null)
                            dto.TotalCost += dto.TotalCost;
                        else
                            dtos.Add(newDto);
                    }
                }
            }

        }

        private List<TimeSchedulePlanningDayDTO> GetHolidaySalaryGrossNetAndCostFromTemplateSchedule(CompEntities entities, int actorCompanyId, int employeeId, DateTime date, bool includeEmploymentTaxAndSupplementChargeCost)
        {
            return TimeScheduleManager.GetTimeSchedulePlanningDaysFromTemplate(entities, actorCompanyId, base.RoleId, base.UserId, date, date, null, new List<int>() { employeeId }, null, includeGrossNetAndCost: true, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost, loadTasksAndDelivery: false, doNotCheckHoliday: true);
        }

        public List<GetTimeSchedulePlanningShifts_Result> GetGetTimeSchedulePlanningShifts_Result(CompEntities entities, DateTime dayBeforeStart, DateTime dayAfterEnd, DateTime dateFrom, DateTime dateTo, List<int> employeeIds, List<int> shiftTypeIds, bool includeBreaks, bool loadZeroDays, int? timeScheduleScenarioHeadId, bool useAccountHierarchy, bool includePreliminary, bool loadingOpenShifts, TimeSchedulePlanningMode planningMode, bool isDayView, List<AccountDTO> accounts, List<int> validAccountIds = null, bool includeOnDuty = false, bool forceFilterOnAccounts = false)
        {
            IQueryable<TimeScheduleTemplateBlock> query = entities.TimeScheduleTemplateBlock
                                                                .Where(w => w.EmployeeId.HasValue && employeeIds.Contains(w.EmployeeId.Value)
                                                                && w.State == (int)SoeEntityState.Active && w.TimeScheduleEmployeePeriodId.HasValue);

            //shiftTypeIds.Any() looks weird, but it was this way when we called the procedure GetTimeSchedulePlanningShifts
            if (shiftTypeIds != null && shiftTypeIds.Any())
                query = query.Where(w => (!w.ShiftTypeId.HasValue || shiftTypeIds.Contains(w.ShiftTypeId.Value)));

            if (!includeBreaks)
                query = query.Where(w => w.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.NormalBreak);

            if (!loadZeroDays)
                query = query.Where(w => (w.StartTime != w.StopTime || (w.StartTime == w.StopTime && w.TimeDeviationCauseId.HasValue)));

            if (planningMode == TimeSchedulePlanningMode.OrderPlanning)
            {
                //"new" booking should be saved with real dates in start and stoptime to handle multiple days bookings correctly
                query = query.Where(w => (w.Date <= dayAfterEnd && w.Date >= dayBeforeStart.Date) ||
                                         (
                                            w.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Booking &&
                                            (dateFrom.Date >= w.StartTime && dateTo.Date <= w.StopTime) || // Fully within range
                                            (dateFrom.Date < w.StartTime && dateTo.Date > w.StartTime) || // Overlaps at the start
                                            (dateFrom.Date < w.StopTime && dateTo.Date > w.StopTime)      // Overlaps at the end
                                         )
                                    );
            }
            else
            {
                query = query.Where(w => w.Date <= dayAfterEnd && w.Date >= dayBeforeStart.Date);
            }

            var blocks = query.ToList();
            List<TimeScheduleTemplatePeriod> periods = new List<TimeScheduleTemplatePeriod>();

            if (!timeScheduleScenarioHeadId.HasValue)
            {
                blocks = blocks.Where(w => !w.TimeScheduleScenarioHeadId.HasValue).ToList();
                var periodIds = blocks.Select(s => s.TimeScheduleTemplatePeriodId).Distinct().ToList();
                periods = entities.TimeScheduleTemplatePeriod.Include("TimeScheduleTemplateHead").Where(w => periodIds.Contains(w.TimeScheduleTemplatePeriodId)).ToList();
            }
            else
            {
                blocks = blocks.Where(w => w.TimeScheduleScenarioHeadId.HasValue && w.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId).ToList();
            }

            var allBlocks = new List<GetTimeSchedulePlanningShifts_Result>();

            foreach (var group in blocks.GroupBy(g => g.TimeScheduleTemplatePeriodId))
            {
                TimeScheduleTemplatePeriod period = !timeScheduleScenarioHeadId.HasValue ? periods.FirstOrDefault(f => f.TimeScheduleTemplatePeriodId == group.Key && f.TimeScheduleTemplateHead != null) : null;

                allBlocks.AddRange(group.Select(b => new GetTimeSchedulePlanningShifts_Result()
                {
                    TimeScheduleTemplateBlockId = b.TimeScheduleTemplateBlockId,
                    TimeScheduleEmployeePeriodId = b.TimeScheduleEmployeePeriodId,
                    TimeScheduleScenarioHeadId = b.TimeScheduleScenarioHeadId,
                    TimeCodeId = b.TimeCodeId,
                    EmployeeId = b.EmployeeId,
                    ShiftTypeId = b.ShiftTypeId,
                    StartTime = b.StartTime,
                    StopTime = b.StopTime,
                    Date = b.Date,
                    Description = b.Description,
                    ShiftStatus = b.ShiftStatus,
                    ShiftUserStatus = b.ShiftUserStatus,
                    NbrOfWantedInQueue = b.NbrOfWantedInQueue,
                    TimeDeviationCauseId = b.TimeDeviationCauseId,
                    AbsenceType = b.AbsenceType,
                    EmployeeChildId = b.EmployeeChildId,
                    AccountId = b.AccountId,
                    BreakType = b.BreakType,
                    Link = b.Link,
                    ExtraShift = b.ExtraShift,
                    SubstituteShift = b.SubstituteShift,
                    StaffingNeedsRowId = b.StaffingNeedsRowId,
                    StaffingNeedsRowPeriodId = b.StaffingNeedsRowPeriodId,
                    TimeScheduleTypeId = b.TimeScheduleTypeId,
                    PlannedTime = b.PlannedTime,
                    IsPreliminary = b.IsPreliminary,
                    CustomerInvoiceId = b.CustomerInvoiceId,
                    TimeScheduleTemplatePeriodId = b.TimeScheduleTemplatePeriodId ?? 0,
                    TimeScheduleTemplateHeadId = !timeScheduleScenarioHeadId.HasValue && period != null ? period.TimeScheduleTemplateHeadId : 0,
                    DayNumber = !timeScheduleScenarioHeadId.HasValue && period != null ? period.DayNumber : 0,
                    TemplateNbrOfWeeks = !timeScheduleScenarioHeadId.HasValue && period != null && period.TimeScheduleTemplateHead.NoOfDays != 0 ? period.TimeScheduleTemplateHead.NoOfDays / 7 : 0,
                    Type = b.Type,
                    IsSchedule = b.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Schedule ? 1 : 0,
                }));
            }

            if (planningMode == TimeSchedulePlanningMode.OrderPlanning)
            {
                allBlocks.Where(w => w.Type == (int)TermGroup_TimeScheduleTemplateBlockType.Booking && w.StartTime.Year != 1900).ToList().ForEach(x =>
                {
                    var stopTime = CalendarUtility.GetScheduleTime(x.StopTime, x.StartTime.Date, x.StopTime.Date);
                    x.StartTime = CalendarUtility.GetScheduleTime(x.StartTime);
                    x.StopTime = stopTime;
                });
            }

            var employees = entities.Employee.Include("ContactPerson").Where(w => employeeIds.Contains(w.EmployeeId)).ToList();

            foreach (var employee in employees)
            {
                foreach (var b in allBlocks.Where(w => w.EmployeeId == employee.EmployeeId))
                {
                    b.UserId = employee.UserId;
                    b.Hidden = employee.Hidden;
                    b.Vacant = employee.Vacant;
                    b.EmployeeName = employee.Name;
                    b.EmployeeInfo = employee.EmployeeNrAndName;
                }
            }

            if (useAccountHierarchy && allBlocks.Any(a => a.AccountId.HasValue))
                allBlocks.Where(w => w.AccountId.HasValue).ToList().ForEach(f => f.AccountName = accounts.FirstOrDefault(fd => fd.AccountId == f.AccountId.Value)?.Name ?? "");

            //Preliminary            
            if (!includePreliminary)
                allBlocks = allBlocks.Where(x => !x.IsPreliminary).ToList();

            // On duty
            if (!includeOnDuty)
                allBlocks = allBlocks.Where(b => b.Type != (int)TermGroup_TimeScheduleTemplateBlockType.OnDuty).ToList();

            // Only show order assignments in order planing
            if (planningMode != TimeSchedulePlanningMode.OrderPlanning)
                allBlocks = allBlocks.Where(b => b.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Order).ToList();

            if ((loadingOpenShifts || forceFilterOnAccounts) && useAccountHierarchy && !validAccountIds.IsNullOrEmpty())
            {
                // Due to a bug where account is not always set on breaks,
                // we need to keep the breaks here for the code in CreateTimeSchedulePlanningDayDTOs to be able to find linked breks on hidden shift
                allBlocks = allBlocks.Where(b => (b.AccountId.HasValue && validAccountIds.Contains(b.AccountId.Value)) || b.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
            }

            if (isDayView && !loadZeroDays)
            {
                // In day view we also get yesterdays and tomorrows shifts to be able to handle shifts over midnight.
                // Keep only shifts that belongs to today or if time intersects with today.
                allBlocks = allBlocks.Where(b => b.Date.Value == dateFrom.Date ||
                    CalendarUtility.MergeDateAndTime(b.Date.Value.AddDays((b.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), b.StartTime) < dateTo ||
                    CalendarUtility.MergeDateAndTime(b.Date.Value.AddDays((b.StopTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), b.StopTime) > dateFrom).ToList();
            }

            return allBlocks.OrderBy(b => b.Date).ThenByDescending(b => b.Hidden).ThenByDescending(b => b.Vacant).ThenByDescending(b => b.IsSchedule).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime).ToList();
        }

        public IEnumerable<TimeSchedulePlanningAggregatedDayDTO> GetTimeSchedulePlanningShiftsAggregated_ByProcedure(int actorCompanyId, int userId, int employeeId, int roleId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds, List<int> filteredShiftTypeIds, TimeSchedulePlanningDisplayMode displayMode, bool includeSecondaryCategories, bool includeBreaks, bool includePreliminary = false, int hiddenEmployeeId = 0, List<int> filteredAccountIds = null, int? timeScheduleScenarioHeadId = null, bool loadZeroDays = false, bool includeShiftRequest = false, TimeSchedulePlanningMode planningMode = TimeSchedulePlanningMode.SchedulePlanning, bool includeOnDuty = false)
        {
            bool isAdminMode = displayMode == TimeSchedulePlanningDisplayMode.Admin;

            #region Prereq

            bool isDayView = (dateFrom.Date == dateTo.Date);

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);
            bool loadingOpenShifts = (employeeIds != null && employeeIds.Count == 1 && employeeIds[0] == hiddenEmployeeId);

            if (filteredShiftTypeIds != null)
            {
                List<int> validShiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, isAdminMode, dateFrom, dateTo, includeSecondaryCategories);
                foreach (var filteredShiftTypeId in filteredShiftTypeIds.ToList())
                {
                    if (!validShiftTypeIds.Contains(filteredShiftTypeId))
                        filteredShiftTypeIds.Remove(filteredShiftTypeId);
                }
                if (!filteredShiftTypeIds.Any())
                    filteredShiftTypeIds = validShiftTypeIds;
            }

            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);
            if (useAccountHierarchy)
            {
                List<int> validAccountIds = null;
                if (isAdminMode)
                {
                    AccountHierarchyInput input = AccountHierarchyInput.GetInstance();
                    input.AddParamValue(AccountHierarchyParamType.IncludeAbstract, true);
                    validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, dateFrom, dateTo, input);
                }
                else
                {
                    validAccountIds = AccountManager.GetValidAccountIdsForEmployee(actorCompanyId, employeeId, dateFrom, dateTo, false, true, false);
                }

                if (filteredAccountIds != null && filteredAccountIds.Any())
                {
                    foreach (var validAccountId in validAccountIds.ToList())
                    {
                        if (!filteredAccountIds.Contains(validAccountId))
                            validAccountIds.Remove(validAccountId);
                    }
                }

                filteredAccountIds = validAccountIds;
            }

            #endregion

            //New Entities with new extended timeout
            using (CompEntities entities = new CompEntities())
            {
                if (hiddenEmployeeId == 0)
                    hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));

                List<TimeDeviationCause> timeDeviationCauses = base.GetTimeDeviationCausesFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<ShiftType> shiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadTimeScheduleTypes: true);
                List<TimeScheduleType> timeScheduleTypes = base.GetTimeScheduleTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadFactors: true);
                List<EmployeeChild> employeeChilds = base.GetEmployeeChildsFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<AccountDTO> accounts = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId));

                entities.CommandTimeout = 300;
                List<GetTimeSchedulePlanningShifts_Result> allBlocks = GetGetTimeSchedulePlanningShifts_Result(entities, dateFrom, dateTo, dateFrom, dateTo, employeeIds, (isAdminMode ? filteredShiftTypeIds : null), includeBreaks, loadZeroDays, timeScheduleScenarioHeadId, useAccountHierarchy, includePreliminary, loadingOpenShifts: loadingOpenShifts, planningMode, isDayView, accounts, filteredAccountIds, includeOnDuty);

                //Shifttypes (only user mode)
                if (!isAdminMode)
                {
                    if (filteredShiftTypeIds != null && filteredShiftTypeIds.Count > 0 && employeeIds != null && employeeIds.Contains(employeeId))
                    {
                        var myShifts = allBlocks.Where(x => x.EmployeeId == employeeId).ToList();
                        var othersShifts = allBlocks.Where(x => x.EmployeeId != employeeId && (!x.ShiftTypeId.HasValue || filteredShiftTypeIds.Contains(x.ShiftTypeId.Value))).ToList();
                        allBlocks.Clear();
                        allBlocks.AddRange(myShifts);
                        allBlocks.AddRange(othersShifts);
                    }
                }

                // Convert to DTOs
                List<TimeSchedulePlanningDayDTO> dtos = CreateTimeSchedulePlanningDayDTOs(allBlocks, shiftTypes, timeScheduleTypes, timeDeviationCauses, employeeChilds, actorCompanyId, hiddenEmployeeId, employeeId, includeBreaks, true, false, false, displayMode != TimeSchedulePlanningDisplayMode.User, validAccountIds: filteredAccountIds);

                if (includeShiftRequest)
                {
                    SetHasShiftRequest(entities, actorCompanyId, allBlocks, dtos);
                }

                List<TimeSchedulePlanningAggregatedDayDTO> aggregatedDays = new List<TimeSchedulePlanningAggregatedDayDTO>();

                foreach (var dayByEmployee in dtos.GroupBy(x => x.EmployeeId).ToList())
                {
                    foreach (var day in dayByEmployee.GroupBy(x => x.ActualDate).ToList())
                    {
                        aggregatedDays.Add(new TimeSchedulePlanningAggregatedDayDTO(day.ToList()));
                    }
                }

                return aggregatedDays;
            }
        }

        public IEnumerable<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningShiftsGrossNetAndCost(int actorCompanyId, int userId, int employeeId, int roleId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds, bool includeSecondaryCategories, bool includeBreaks, bool includePreliminary = true, bool includeEmploymentTaxAndSupplementChargeCost = false, int? timeScheduleScenarioHeadId = null, bool loadZeroDays = false)
        {
            #region Prereq

            bool isDayView = (dateFrom.Date == dateTo.Date);

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            List<int> shiftTypeIds = GetShiftTypeIdsForUser(null, actorCompanyId, roleId, userId, employeeId, true, dateFrom, dateTo, includeSecondaryCategories);

            using var entitiesReadonly = CompEntitiesProvider.LeaseReadOnlyContext();
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entitiesReadonly, actorCompanyId);
            List<int> validAccountIds = useAccountHierarchy ? AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, userId, dateFrom, dateTo) : null;

            #endregion

            #region Shifts

            using (CompEntities entities = new CompEntities())
            {
                entities.CommandTimeout = 300;
                int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<TimeDeviationCause> timeDeviationCauses = base.GetTimeDeviationCausesFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<ShiftType> shiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadTimeScheduleTypes: true);
                List<TimeScheduleType> timeScheduleTypes = base.GetTimeScheduleTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadFactors: true);
                List<EmployeeChild> employeeChilds = base.GetEmployeeChildsFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<AccountDTO> accounts = base.GetAccountInternalsFromCache(entities, CacheConfig.Company(actorCompanyId));
                List<GetTimeSchedulePlanningShifts_Result> allBlocks = GetGetTimeSchedulePlanningShifts_Result(entities, dateFrom, dateTo, dateFrom, dateTo, employeeIds, shiftTypeIds, includeBreaks, loadZeroDays, timeScheduleScenarioHeadId, useAccountHierarchy, includePreliminary, true, TimeSchedulePlanningMode.SchedulePlanning, isDayView, accounts, validAccountIds).Where(w => w.StartTime != w.StopTime).ToList();

                // Convert to DTOs
                List<TimeSchedulePlanningDayDTO> dtos = CreateTimeSchedulePlanningDayDTOs(allBlocks, shiftTypes, timeScheduleTypes, timeDeviationCauses, employeeChilds, actorCompanyId, hiddenEmployeeId, employeeId, includeBreaks, false, false, false, validAccountIds: validAccountIds);

                // Add gross, net and cost
                CalculateGrossNetAndCost(dtos, actorCompanyId, 0, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost);
                return dtos;
            }

            #endregion
        }

        #region Help-methods

        #region TimeScheduleTemplateBlock

        private List<TimeSchedulePlanningDayDTO> CreateTimeSchedulePlanningDayDTOs(List<TimeScheduleTemplateBlock> blocks, int actorCompanyId, int currentEmployeeId, bool includeBreaks = true, bool includeStatusNames = false, bool includeAttestStates = false, bool includeDeliveryAddress = false, bool showDeviationCauseNames = true)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return CreateTimeSchedulePlanningDayDTOs(entities, blocks, actorCompanyId, currentEmployeeId, includeBreaks, includeStatusNames, includeAttestStates, includeDeliveryAddress, showDeviationCauseNames);
        }

        private List<TimeSchedulePlanningDayDTO> CreateTimeSchedulePlanningDayDTOs(CompEntities entities, List<TimeScheduleTemplateBlock> blocks, int actorCompanyId, int currentEmployeeId, bool includeBreaks = true, bool includeStatusNames = false, bool includeAttestStates = false, bool includeDeliveryAddress = false, bool showDeviationCauseNames = true, List<int> validAccountIds = null)
        {
            List<TimeSchedulePlanningDayDTO> result = new List<TimeSchedulePlanningDayDTO>();

            foreach (var block in blocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None))
            {
                // Check if block has already been added due to linking below
                if (result.Any(b => b.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId))
                    continue;

                // If hidden employee, only return shifts valid for current user
                bool isHidden = block.Employee != null && block.Employee.Hidden;
                if (isHidden && validAccountIds != null && (!block.AccountId.HasValue || !validAccountIds.Contains(block.AccountId.Value)))
                    continue;

                // If hidden employee, only add breaks with the same link as the shift itself
                string linkStr = null;
                if (isHidden && !String.IsNullOrEmpty(block.Link))
                    linkStr = block.Link;

                TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(entities, block, actorCompanyId, currentEmployeeId, includeStatusNames: includeStatusNames, includeAttestStates: includeAttestStates, includeDeliveryAddress: includeDeliveryAddress, showDeviationCauseNames: showDeviationCauseNames);
                if (includeBreaks)
                {
                    List<TimeScheduleTemplateBlock> breaks = blocks.Where(b => b.TimeScheduleEmployeePeriodId == block.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    if (!String.IsNullOrEmpty(linkStr))
                        breaks = breaks.Where(b => b.Link == linkStr).ToList();
                    AddBreaksToTimeSchedulePlanningDayDTO(breaks, null, ref dto);
                }

                result.Add(dto);

                // Check if shift is linked together with any other shifts
                // If so, add them now to keep them sorted together
                if (dto.Link.HasValue && blocks.Count(b => b.Link == dto.Link.ToString() && b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None) > 1)
                {
                    List<TimeScheduleTemplateBlock> linkedBlocks = blocks.Where(b => b.TimeScheduleTemplateBlockId != dto.TimeScheduleTemplateBlockId && b.Link == dto.Link.ToString() && b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    foreach (var linkedBlock in linkedBlocks.OrderBy(b => b.StartTime))
                    {
                        TimeSchedulePlanningDayDTO linkedDto = CreateTimeSchedulePlanningDayDTO(entities, linkedBlock, actorCompanyId, currentEmployeeId, includeStatusNames: true, includeAttestStates: includeAttestStates, includeDeliveryAddress: includeDeliveryAddress, showDeviationCauseNames: showDeviationCauseNames);
                        if (includeBreaks)
                        {
                            List<TimeScheduleTemplateBlock> breaks = blocks.Where(b => b.TimeScheduleEmployeePeriodId == linkedBlock.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                            if (!String.IsNullOrEmpty(linkStr))
                                breaks = breaks.Where(b => b.Link == linkStr).ToList();
                            AddBreaksToTimeSchedulePlanningDayDTO(breaks, null, ref linkedDto);
                        }
                        result.Add(linkedDto);
                    }
                }
            }

            return result;
        }

        public TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(TimeScheduleTemplateBlock block, int actorCompanyId, int currentEmployeeId, bool includeStatusNames = false, bool dontChangeTimeOnZeroDays = false, bool showDeviationCauseNames = true, int? hiddenEmployeeId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return CreateTimeSchedulePlanningDayDTO(entities, block, actorCompanyId, currentEmployeeId, includeStatusNames, dontChangeTimeOnZeroDays: dontChangeTimeOnZeroDays, showDeviationCauseNames: showDeviationCauseNames, hiddenEmployeeId: hiddenEmployeeId);
        }

        private TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(CompEntities entities, TimeScheduleTemplateBlock block, int actorCompanyId, int currentEmployeeId, bool includeStatusNames = false, bool includeAttestStates = false, bool includeDeliveryAddress = false, bool dontChangeTimeOnZeroDays = false, bool showDeviationCauseNames = true, int? hiddenEmployeeId = null)
        {
            bool zeroDay = block.StartTime == block.StopTime;

            string deviationCauseName = String.Empty;
            if (block.TimeDeviationCauseId.HasValue)
                deviationCauseName = block.TimeDeviationCause != null && (showDeviationCauseNames || block.TimeDeviationCause.IsVacation || block.EmployeeId == currentEmployeeId) ? block.TimeDeviationCause.Name : GetText(3360, "Frånvaro");

            TimeSchedulePlanningDayDTO dayDTO = new TimeSchedulePlanningDayDTO();
            dayDTO.Type = (TermGroup_TimeScheduleTemplateBlockType)block.Type;
            dayDTO.Link = !String.IsNullOrEmpty(block.Link) ? new Guid(block.Link) : (Guid?)null;
            dayDTO.Description = block.Description.NullToEmpty();

            // Time and status
            dayDTO.ShiftStatus = (TermGroup_TimeScheduleTemplateBlockShiftStatus)block.ShiftStatus;
            dayDTO.ShiftUserStatus = (TermGroup_TimeScheduleTemplateBlockShiftUserStatus)block.ShiftUserStatus;
            var (startTime, stopTime) = block.GetStartAndStopTime();
            dayDTO.StartTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((startTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), startTime);
            dayDTO.StopTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((stopTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), stopTime);
            if (zeroDay)
            {
                dayDTO.StartTime = CalendarUtility.GetBeginningOfDay(dayDTO.StartTime);
                dayDTO.StopTime = dontChangeTimeOnZeroDays ? CalendarUtility.GetBeginningOfDay(dayDTO.StopTime) : CalendarUtility.GetEndOfDay(dayDTO.StopTime);
                dayDTO.ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
            }
            dayDTO.ShiftStatusName = includeStatusNames ? GetText((int)dayDTO.ShiftStatus, (int)TermGroup.TimeScheduleEmployeePeriodStatus) : String.Empty;
            dayDTO.ShiftUserStatusName = includeStatusNames ? GetText((int)dayDTO.ShiftUserStatus, (int)TermGroup.TimeScheduleEmployeePeriodUserStatus) : String.Empty;
            dayDTO.WeekNr = CalendarUtility.GetWeekNr(dayDTO.StartTime);
            dayDTO.ExtraShift = block.ExtraShift;
            dayDTO.SubstituteShift = block.SubstituteShift;

            // Flags
            dayDTO.BelongsToPreviousDay = block.BelongsToPreviousDay;
            dayDTO.BelongsToNextDay = block.BelongsToNextDay;
            dayDTO.IsPreliminary = block.IsPreliminary;
            dayDTO.NbrOfWantedInQueue = block.NbrOfWantedInQueue;
            dayDTO.IamInQueue = (block.TimeScheduleTemplateBlockQueue != null && block.TimeScheduleTemplateBlockQueue.Where(w => w.State == (int)SoeEntityState.Active).Any(q => q.EmployeeId == currentEmployeeId));

            // Employee
            dayDTO.EmployeeId = block.EmployeeId ?? 0;
            dayDTO.EmployeeName = block.Employee?.ContactPerson?.Name ?? string.Empty;
            dayDTO.EmployeeInfo = block.Employee != null && block.Employee.ContactPerson != null ? String.Format("({0}) {1}", block.Employee.EmployeeNr, block.Employee.ContactPerson.Name) : String.Empty;
            dayDTO.IsHiddenEmployee = (hiddenEmployeeId.HasValue && hiddenEmployeeId.Value == block.EmployeeId) || (block.Employee != null && block.Employee.Hidden);
            dayDTO.IsVacant = block.Employee != null && block.Employee.Vacant;
            dayDTO.UserId = block.Employee?.UserId; //Currently it is only used from mobilemanager

            // TimeScheduleTemplate
            dayDTO.TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId;
            dayDTO.TimeScheduleTemplatePeriodId = block.TimeScheduleTemplatePeriodId;
            dayDTO.TimeScheduleEmployeePeriodId = block.TimeScheduleEmployeePeriodId ?? 0;
            dayDTO.TimeScheduleTemplateHeadId = block.TimeScheduleTemplatePeriod?.TimeScheduleTemplateHeadId ?? 0;
            dayDTO.TimeScheduleScenarioHeadId = block.TimeScheduleScenarioHeadId;
            dayDTO.DayNumber = block.TimeScheduleTemplatePeriod?.DayNumber ?? 0;
            dayDTO.NbrOfWeeks = block.TimeScheduleTemplatePeriod != null && block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead != null ? block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.NoOfDays / 7 : 0;

            // TimeDeviationCause
            dayDTO.TimeDeviationCauseId = block.TimeDeviationCauseId;
            dayDTO.TimeDeviationCauseName = deviationCauseName;
            dayDTO.AbsenceType = (TermGroup_TimeScheduleTemplateBlockAbsenceType)block.AbsenceType;

            //EmployeeChild
            dayDTO.EmployeeChildId = block.EmployeeChildId;

            // TimeCode
            dayDTO.TimeCodeId = block.TimeCodeId;

            // TimeScheduleType
            dayDTO.TimeScheduleTypeId = block.TimeScheduleTypeId ?? 0;
            dayDTO.TimeScheduleTypeCode = block.TimeScheduleType?.Code ?? String.Empty;
            dayDTO.TimeScheduleTypeName = block.TimeScheduleType?.Name ?? String.Empty;
            dayDTO.TimeScheduleTypeIsNotScheduleTime = block.TimeScheduleType != null && block.TimeScheduleType.IsNotScheduleTime;
            dayDTO.TimeScheduleTypeFactors = block.TimeScheduleType?.TimeScheduleTypeFactor.Where(f => f.State == (int)SoeEntityState.Active).ToSmallDTOs().ToList();

            // ShiftType
            dayDTO.ShiftTypeId = block.ShiftTypeId ?? 0;
            dayDTO.ShiftTypeName = block.ShiftType?.Name ?? string.Empty;
            dayDTO.ShiftTypeDesc = block.ShiftType?.Description ?? string.Empty;
            dayDTO.ShiftTypeColor = block.ShiftType?.Color ?? string.Empty;

            // ShiftTypeTimeScheduleType
            dayDTO.ShiftTypeTimeScheduleTypeId = block.ShiftType?.TimeScheduleType?.TimeScheduleTypeId ?? 0;
            dayDTO.ShiftTypeTimeScheduleTypeCode = block.ShiftType?.TimeScheduleType?.Code ?? String.Empty;
            dayDTO.ShiftTypeTimeScheduleTypeName = block.ShiftType?.TimeScheduleType?.Name ?? String.Empty;

            // Accounts
            dayDTO.AccountId = block.AccountId;
            if (block.Account != null)
                dayDTO.AccountName = block.Account.Name;
            dayDTO.AccountIds = new List<int>();
            if (block.AccountInternal != null && block.AccountInternal.Count > 0)
                dayDTO.AccountIds = block.AccountInternal.Select(a => a.AccountId).ToList();

            // EmployeePost
            if (block.TimeScheduleTemplatePeriod != null && block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead != null && block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.EmployeePostId.HasValue)
                dayDTO.EmployeePostId = block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.EmployeePostId;

            // Tasks
            if (!block.TimeScheduleTemplateBlockTask.IsNullOrEmpty())
                dayDTO.Tasks = block.TimeScheduleTemplateBlockTask.Where(x => x.State == (int)SoeEntityState.Active).ToDTOs().ToList();

            // Staffing needs
            dayDTO.StaffingNeedsRowId = block.StaffingNeedsRowId;
            dayDTO.StaffingNeedsRowPeriodId = block.StaffingNeedsRowPeriodId;
            if (dayDTO.StaffingNeedsRowId.HasValue && block.StaffingNeedsRow != null && block.StaffingNeedsRow.StaffingNeedsHead != null)
            {
                dayDTO.StaffingNeedsOrigin = block.StaffingNeedsRow != null && block.StaffingNeedsRow.StaffingNeedsHead != null ? String.Format("{0} - {1}", block.StaffingNeedsRow.StaffingNeedsHead.Name, block.StaffingNeedsRow.Name) : String.Empty;
                dayDTO.StaffingNeedsWeekday = block.StaffingNeedsRow != null && block.StaffingNeedsRow.StaffingNeedsHead != null && block.StaffingNeedsRow.StaffingNeedsHead.Weekday.HasValue ? (DayOfWeek)block.StaffingNeedsRow.StaffingNeedsHead.Weekday : (DayOfWeek?)null;
                dayDTO.StaffingNeedsDayTypeId = block.StaffingNeedsRow.StaffingNeedsHead.DayTypeId;
                dayDTO.StaffingNeedsDate = block.StaffingNeedsRow.StaffingNeedsHead.Date;
            }

            // Order planning
            if (block.CustomerInvoiceId.HasValue)
                dayDTO.Order = CreateOrderListDTO(entities, block.CustomerInvoiceId.Value, actorCompanyId, includeAttestStates, includeDeliveryAddress);

            if (block.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Schedule && block.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Standby && block.Type != (int)TermGroup_TimeScheduleTemplateBlockType.OnDuty)
                dayDTO.NbrOfWeeks = 0;  // Clear this to prevent week number to be displayed

            return dayDTO;
        }

        public TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(TimeScheduleCopyRowJsonDataShiftDTO block, int actorCompanyId, int currentEmployeeId, bool includeStatusNames = false, bool dontChangeTimeOnZeroDays = false, bool showDeviationCauseNames = true, int? hiddenEmployeeId = null, List<TimeDeviationCause> timeDeviationCauses = null, List<ShiftType> shiftTypes = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return CreateTimeSchedulePlanningDayDTO(entities, block, actorCompanyId, currentEmployeeId, includeStatusNames, dontChangeTimeOnZeroDays: dontChangeTimeOnZeroDays, showDeviationCauseNames: showDeviationCauseNames, hiddenEmployeeId: hiddenEmployeeId, timeDeviationCauses: timeDeviationCauses, shiftTypes: shiftTypes);
        }

        private TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(CompEntities entities, TimeScheduleCopyRowJsonDataShiftDTO block, int actorCompanyId, int currentEmployeeId, bool includeStatusNames = false, bool includeAttestStates = false, bool includeDeliveryAddress = false, bool dontChangeTimeOnZeroDays = false, bool showDeviationCauseNames = true, int? hiddenEmployeeId = null, List<TimeDeviationCause> timeDeviationCauses = null, List<ShiftType> shiftTypes = null)
        {
            bool zeroDay = block.StartTime == block.StopTime;

            if (showDeviationCauseNames && timeDeviationCauses == null)
            {
                // Load TimeDeviationCause from cache
                timeDeviationCauses = base.GetTimeDeviationCausesFromCache(entities, CacheConfig.Company(actorCompanyId));
            }

            if (shiftTypes == null)
            {
                // Load ShiftTypes from cache
                shiftTypes = base.GetShiftTypesFromCache(entities, CacheConfig.Company(actorCompanyId), loadTimeScheduleTypes: true);
            }

            string deviationCauseName = String.Empty;
            if (block.TimeDeviationCauseId.HasValue)
            {
                var timeDeviationCause = timeDeviationCauses.FirstOrDefault(x => x.TimeDeviationCauseId == block.TimeDeviationCauseId);
                if (timeDeviationCause != null)
                    deviationCauseName = (showDeviationCauseNames || timeDeviationCause.IsVacation) ? timeDeviationCause.Name : GetText(3360, "Frånvaro");
            }

            TimeSchedulePlanningDayDTO dayDTO = new TimeSchedulePlanningDayDTO();
            dayDTO.Type = (TermGroup_TimeScheduleTemplateBlockType)block.Type;
            dayDTO.Link = (Guid?)null;
            dayDTO.Description = string.Empty;

            // Time and status
            dayDTO.ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned; // TODO: maybe map this from block
            dayDTO.ShiftUserStatus = TermGroup_TimeScheduleTemplateBlockShiftUserStatus.None; // TODO: maybe map this from block
            dayDTO.StartTime = CalendarUtility.MergeDateAndTime(block.Date.Value, block.StartTime);
            dayDTO.StopTime = CalendarUtility.MergeDateAndTime(block.Date.Value, block.StopTime);
            if (zeroDay || block.TimeLeisureCodeId.HasValidValue() || block.AbsenceType == TermGroup_TimeScheduleTemplateBlockAbsenceType.AnnualLeave)
            {
                dayDTO.StartTime = CalendarUtility.GetBeginningOfDay(dayDTO.StartTime);
                dayDTO.StopTime = dontChangeTimeOnZeroDays ? CalendarUtility.GetBeginningOfDay(dayDTO.StopTime) : CalendarUtility.GetEndOfDay(dayDTO.StopTime);
                dayDTO.NetTime = 0;
                dayDTO.GrossTime = 0;
                dayDTO.ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                dayDTO.Description = "zeroDay";
            }
            dayDTO.ShiftStatusName = includeStatusNames ? GetText((int)dayDTO.ShiftStatus, (int)TermGroup.TimeScheduleEmployeePeriodStatus) : String.Empty;
            dayDTO.ShiftUserStatusName = includeStatusNames ? GetText((int)dayDTO.ShiftUserStatus, (int)TermGroup.TimeScheduleEmployeePeriodUserStatus) : String.Empty;
            dayDTO.WeekNr = CalendarUtility.GetWeekNr(dayDTO.StartTime);
            dayDTO.ExtraShift = false; // TODO: maybe map this from block
            dayDTO.SubstituteShift = false; // TODO: maybe map this from block

            // Flags
            dayDTO.BelongsToPreviousDay = false; // TODO: maybe map this from block
            dayDTO.BelongsToNextDay = false; // TODO: maybe map this from block
            dayDTO.IsPreliminary = false;
            dayDTO.NbrOfWantedInQueue = 0;
            dayDTO.IamInQueue = false;

            // Employee
            dayDTO.EmployeeId = currentEmployeeId;

            // TimeScheduleTemplate
            dayDTO.TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId;

            // TimeDeviationCause
            dayDTO.TimeDeviationCauseId = block.TimeDeviationCauseId;
            dayDTO.TimeDeviationCauseName = deviationCauseName;
            dayDTO.AbsenceType = block.AbsenceType;

            // TimeLeisureCode
            dayDTO.TimeLeisureCodeId = block.TimeLeisureCodeId;

            // ShiftType
            if (block.ShiftTypeId.HasValue)
            {
                var shiftType = shiftTypes.FirstOrDefault(x => x.ShiftTypeId == block.ShiftTypeId.Value);
                dayDTO.ShiftTypeId = block.ShiftTypeId.Value;
                dayDTO.ShiftTypeName = shiftType?.Name ?? string.Empty;
                dayDTO.ShiftTypeDesc = shiftType?.Description ?? string.Empty;
                dayDTO.ShiftTypeColor = shiftType?.Color ?? string.Empty;

                // ShiftTypeTimeScheduleType
                dayDTO.ShiftTypeTimeScheduleTypeId = shiftType?.TimeScheduleType?.TimeScheduleTypeId ?? 0;
                dayDTO.ShiftTypeTimeScheduleTypeCode = shiftType?.TimeScheduleType?.Code ?? String.Empty;
                dayDTO.ShiftTypeTimeScheduleTypeName = shiftType?.TimeScheduleType?.Name ?? String.Empty;
            }

            // annual leave - set shift type name/desc to deviation cause name
            if (block.AbsenceType == TermGroup_TimeScheduleTemplateBlockAbsenceType.AnnualLeave)
            {
                dayDTO.ShiftTypeName = deviationCauseName;
                dayDTO.ShiftTypeDesc = deviationCauseName;
            }

            // Accounts
            dayDTO.AccountId = block.AccountId;
            //if (block.Account != null)
            //    dayDTO.AccountName = block.Account.Name;
            //dayDTO.AccountIds = new List<int>();
            //if (block.AccountInternal != null && block.AccountInternal.Count > 0)
            //    dayDTO.AccountIds = block.AccountInternal.Select(a => a.AccountId).ToList();

            if (block.Type != TimeScheduleBlockType.Schedule && block.Type != TimeScheduleBlockType.Standby && block.Type != TimeScheduleBlockType.OnDuty)
                dayDTO.NbrOfWeeks = 0;  // Clear this to prevent week number to be displayed

            return dayDTO;
        }

        private void AddBreaksToTimeSchedulePlanningDayDTO(IEnumerable<TimeScheduleTemplateBlock> breakBlocks, DateTime? templateScheduleDate, ref TimeSchedulePlanningDayDTO dto, List<TimeScheduleTemplateBlock> noneBreakBlocks = null)
        {
            //Bug fix 25162. Move/Copy shift to hidden employee didnt get Link correct, so it appeared on every shift on that day. Now, only use Link to separate breaks from other shifts if we think this new logic has been applied
            bool useLinked = false;
            string link = dto.Link?.ToString();
            if (link != null && noneBreakBlocks != null)
            {
                bool hasAlBreaksLinkedShift = true;
                foreach (TimeScheduleTemplateBlock breakBlock in breakBlocks)
                {
                    if (breakBlock.Link == null || !noneBreakBlocks.Any(x => x.Link != null && x.Link == breakBlock.Link))
                        hasAlBreaksLinkedShift = false;
                }
                if (hasAlBreaksLinkedShift)
                    useLinked = true;
            }

            int i = 0;
            var breaks = (useLinked ? breakBlocks.Where(x => x.Link == link.ToString()) : breakBlocks).OrderBy(b => b.Date).ThenBy(b => b.StartTime).ToList();
            foreach (var breakBlock in breaks)
            {
                DateTime? breakBlockDate = null;
                if (templateScheduleDate.HasValue)
                    breakBlockDate = templateScheduleDate.Value.AddDays((breakBlock.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days);
                else if (breakBlock.Date.HasValue)
                    breakBlockDate = breakBlock.Date.Value.AddDays((breakBlock.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days);

                if (!breakBlockDate.HasValue)
                    continue;

                if (dto.BelongsToPreviousDay && CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StopTime) < dto.StartTime)
                    continue;

                if (dto.BelongsToNextDay && CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime) > dto.StopTime)
                    continue;

                i++;
                switch (i)
                {
                    case 1:
                        dto.Break1Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break1TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break1StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break1Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break1Link = (!String.IsNullOrEmpty(breakBlock.Link)) ? new Guid(breakBlock.Link) : (Guid?)null;
                        dto.Break1IsPreliminary = breakBlock.IsPreliminary;
                        break;
                    case 2:
                        dto.Break2Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break2TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break2StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break2Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break2Link = (!String.IsNullOrEmpty(breakBlock.Link)) ? new Guid(breakBlock.Link) : (Guid?)null;
                        dto.Break2IsPreliminary = breakBlock.IsPreliminary;
                        break;
                    case 3:
                        dto.Break3Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break3TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break3StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break3Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break3Link = (!String.IsNullOrEmpty(breakBlock.Link)) ? new Guid(breakBlock.Link) : (Guid?)null;
                        dto.Break3IsPreliminary = breakBlock.IsPreliminary;
                        break;
                    case 4:
                        dto.Break4Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break4TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break4StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break4Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break4Link = (!String.IsNullOrEmpty(breakBlock.Link)) ? new Guid(breakBlock.Link) : (Guid?)null;
                        dto.Break4IsPreliminary = breakBlock.IsPreliminary;
                        break;
                }
            }
        }

        public void AddBreaksToTimeSchedulePlanningDayDTO(IEnumerable<TimeScheduleCopyRowJsonDataShiftDTO> breakBlocks, DateTime? templateScheduleDate, ref TimeSchedulePlanningDayDTO dto, List<TimeScheduleCopyRowJsonDataShiftDTO> noneBreakBlocks = null)
        {

            int i = 0;
            var breaks = breakBlocks.OrderBy(b => b.Date).ThenBy(b => b.StartTime).ToList();
            foreach (var breakBlock in breaks)
            {
                DateTime? breakBlockDate = null;
                if (templateScheduleDate.HasValue)
                    breakBlockDate = templateScheduleDate.Value.AddDays((breakBlock.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days);
                else if (breakBlock.Date.HasValue)
                    breakBlockDate = breakBlock.Date.Value.AddDays((breakBlock.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days);

                if (!breakBlockDate.HasValue)
                    continue;

                if (dto.BelongsToPreviousDay && CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StopTime) < dto.StartTime)
                    continue;

                if (dto.BelongsToNextDay && CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime) > dto.StopTime)
                    continue;

                i++;
                switch (i)
                {
                    case 1:
                        dto.Break1Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break1StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break1Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break1Link = (Guid?)null;
                        break;
                    case 2:
                        dto.Break2Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break2StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break2Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break2Link = (Guid?)null;
                        break;
                    case 3:
                        dto.Break3Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break3StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break3Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break3Link = (Guid?)null;
                        break;
                    case 4:
                        dto.Break4Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break4StartTime = CalendarUtility.MergeDateAndTime(breakBlockDate.Value, breakBlock.StartTime);
                        dto.Break4Minutes = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                        dto.Break4Link = (Guid?)null;
                        break;
                }
            }
        }

        #endregion

        #region EmployeeRequest

        public List<EmployeeRequest> GetEmployeeRequests(CompEntities entities, int actorCompanyId, DateTime lastStopDate)
        {
            return (from er in entities.EmployeeRequest
                    where er.Type == (int)TermGroup_EmployeeRequestType.AbsenceRequest &&
                    er.ActorCompanyId == actorCompanyId &&
                    er.State == (int)SoeEntityState.Active && er.Stop <= lastStopDate
                    select er).ToList();
        }

        private TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(EmployeeRequest request, int currentEmployeeId, bool showDeviationCauseNames = true)
        {
            string deviationCauseName = String.Empty;
            if (request.TimeDeviationCause != null)
                deviationCauseName = showDeviationCauseNames || request.TimeDeviationCause.IsVacation || request.EmployeeId == currentEmployeeId ? request.TimeDeviationCause.Name : GetText(3360, "Frånvaro");

            TimeSchedulePlanningDayDTO dayDTO = new TimeSchedulePlanningDayDTO();
            dayDTO.Type = TermGroup_TimeScheduleTemplateBlockType.Schedule;
            dayDTO.IsAbsenceRequest = true;
            dayDTO.TimeScheduleTemplateBlockId = request.EmployeeRequestId;
            dayDTO.TimeDeviationCauseId = request.TimeDeviationCauseId;
            dayDTO.TimeDeviationCauseName = deviationCauseName;
            dayDTO.AbsenceType = TermGroup_TimeScheduleTemplateBlockAbsenceType.Standard;
            dayDTO.EmployeeChildId = request.EmployeeChildId;

            if (request.ExtendedAbsenceSettingId.HasValue)
                dayDTO.TimeDeviationCauseName += ", " + GetText(8477, "del av dag");
            else
                dayDTO.TimeDeviationCauseName += ", " + GetText(8478, "heldag");

            dayDTO.EmployeeId = request.EmployeeId;
            dayDTO.StartTime = request.Start;
            dayDTO.StopTime = request.Stop;
            dayDTO.WeekNr = CalendarUtility.GetWeekNr(dayDTO.StartTime);
            dayDTO.Description = GetText(3965, "Ledighetsansökan");
            dayDTO.ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
            dayDTO.ShiftUserStatus = TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested;
            dayDTO.IsPreliminary = true;

            return dayDTO;
        }

        #endregion

        #region TimeScheduleEmployeePeriodDetail

        private TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(TimeScheduleEmployeePeriodDetail detail)
        {
            TimeSchedulePlanningDayDTO dayDTO = new TimeSchedulePlanningDayDTO();
            dayDTO.Type = TermGroup_TimeScheduleTemplateBlockType.Schedule;
            dayDTO.TimeScheduleEmployeePeriodDetailId = detail.TimeScheduleEmployeePeriodDetailId;
            dayDTO.TimeLeisureCodeId = detail.TimeLeisureCodeId;

            dayDTO.EmployeeId = detail.TimeScheduleEmployeePeriod.EmployeeId;
            dayDTO.StartTime = detail.TimeScheduleEmployeePeriod.Date;
            dayDTO.StopTime = CalendarUtility.GetEndOfDay(detail.TimeScheduleEmployeePeriod.Date);
            dayDTO.Description = detail.TimeLeisureCode?.Code;
            dayDTO.ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
            dayDTO.ShiftUserStatus = TermGroup_TimeScheduleTemplateBlockShiftUserStatus.None;

            return dayDTO;
        }

        #endregion

        #region GetTimeSchedulePlanningPeriods_Result

        private List<TimeSchedulePlanningDayDTO> CreateTimeSchedulePlanningDayDTOsForGrossNetCost(List<GetTimeSchedulePlanningPeriods_Result> blocks, bool setActualStartTimeOnBreaks = false)
        {
            List<TimeSchedulePlanningDayDTO> result = new List<TimeSchedulePlanningDayDTO>();

            foreach (var block in blocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None))
            {
                // If hidden employee, only add breaks with the same link as the shift itself
                string linkStr = null;
                if (block.Hidden && !String.IsNullOrEmpty(block.Link))
                    linkStr = block.Link;

                // Create DTO
                TimeSchedulePlanningDayDTO dto = new TimeSchedulePlanningDayDTO();
                dto.Type = (TermGroup_TimeScheduleTemplateBlockType)block.Type;
                dto.EmployeeId = block.EmployeeId.Value;
                dto.TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId;
                dto.TimeScheduleTypeId = block.TimeScheduleTypeId ?? 0;
                dto.TimeDeviationCauseId = block.TimeDeviationCauseId;
                dto.StartTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((block.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), block.StartTime);
                dto.StopTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((block.StopTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), block.StopTime);
                dto.Link = !String.IsNullOrEmpty(block.Link) ? new Guid(block.Link) : (Guid?)null;

                // Add breaks
                List<GetTimeSchedulePlanningPeriods_Result> breaks = blocks.Where(b => b.TimeScheduleEmployeePeriodId == block.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                if (!String.IsNullOrEmpty(linkStr))
                    breaks = breaks.Where(b => b.Link == linkStr).ToList();
                if (breaks.Count > 0)
                {
                    int i = 0;
                    foreach (var brk in breaks.OrderBy(b => b.Date).ThenBy(b => b.StartTime))
                    {
                        DateTime startTime;
                        if (setActualStartTimeOnBreaks)
                            startTime = brk.Date.HasValue ? CalendarUtility.GetDateTime(brk.Date.Value, brk.StartTime).AddDays((brk.StartTime - CalendarUtility.DATETIME_DEFAULT).Days) : brk.StartTime;
                        else
                            startTime = brk.StartTime;

                        i++;
                        switch (i)
                        {
                            case 1:
                                dto.Break1StartTime = startTime;
                                dto.Break1Minutes = (int)(brk.StopTime - brk.StartTime).TotalMinutes;
                                break;
                            case 2:
                                dto.Break2StartTime = startTime;
                                dto.Break2Minutes = (int)(brk.StopTime - brk.StartTime).TotalMinutes;
                                break;
                            case 3:
                                dto.Break3StartTime = startTime;
                                dto.Break3Minutes = (int)(brk.StopTime - brk.StartTime).TotalMinutes;
                                break;
                            case 4:
                                dto.Break4StartTime = startTime;
                                dto.Break4Minutes = (int)(brk.StopTime - brk.StartTime).TotalMinutes;
                                break;
                        }
                    }
                }

                result.Add(dto);
            }

            return result;
        }

        #endregion

        #region GetTimeSchedulePlanningShifts_Result

        private List<TimeSchedulePlanningDayDTO> CreateTimeSchedulePlanningDayDTOs(List<GetTimeSchedulePlanningShifts_Result> blocks, List<ShiftType> shiftTypes, List<TimeScheduleType> timeScheduleTypes, List<TimeDeviationCause> timeDeviationCauses, List<EmployeeChild> employeeChilds, int actorCompanyId, int hiddenEmployeeId, int currentEmployeeId, bool includeBreaks, bool includeStatusNames, bool includeAttestStates, bool includeDeliveryAddress, bool showDeviationCauseNames = true, List<int> validAccountIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return CreateTimeSchedulePlanningDayDTOs(entities, blocks, shiftTypes, timeScheduleTypes, timeDeviationCauses, employeeChilds, actorCompanyId, hiddenEmployeeId, currentEmployeeId, includeBreaks, includeStatusNames, includeAttestStates, includeDeliveryAddress, showDeviationCauseNames, validAccountIds);
        }

        private List<TimeSchedulePlanningDayDTO> CreateTimeSchedulePlanningDayDTOs(CompEntities entities, List<GetTimeSchedulePlanningShifts_Result> blocks, List<ShiftType> shiftTypes, List<TimeScheduleType> timeScheduleTypes, List<TimeDeviationCause> timeDeviationCauses, List<EmployeeChild> employeeChilds, int actorCompanyId, int hiddenEmployeeId, int currentEmployeeId, bool includeBreaks, bool includeStatusNames, bool includeAttestStates, bool includeDeliveryAddress, bool showDeviationCauseNames = true, List<int> validAccountIds = null, bool dontChangeTimeOnZeroDays = false)
        {
            List<TimeSchedulePlanningDayDTO> result = new List<TimeSchedulePlanningDayDTO>();

            foreach (var block in blocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None))
            {
                // Check if block has already been added due to linking below
                if (result.Any(b => b.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId))
                    continue;

                // If hidden employee, only return shifts valid for current user
                if (validAccountIds != null && block.Hidden && (!block.AccountId.HasValue || !validAccountIds.Contains(block.AccountId.Value)))
                    continue;

                // If hidden employee, only add breaks with the same link as the shift itself
                string linkStr = null;
                if (block.Hidden && !String.IsNullOrEmpty(block.Link))
                    linkStr = block.Link;

                if (block.CustomerInvoiceId.HasValue)
                {
                    //kolla
                    var status = OriginManager.GetOriginStatus(entities, block.CustomerInvoiceId.Value);
                    if (status == SoeOriginStatus.None || status == SoeOriginStatus.Cancel)
                        continue;
                }

                TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(entities, block, shiftTypes, timeScheduleTypes, timeDeviationCauses, employeeChilds, actorCompanyId, currentEmployeeId, includeStatusNames, includeAttestStates, includeDeliveryAddress, dontChangeTimeOnZeroDays: dontChangeTimeOnZeroDays, showDeviationCauseNames: showDeviationCauseNames);
                if (includeBreaks)
                {
                    List<GetTimeSchedulePlanningShifts_Result> breaks = blocks.Where(b => b.TimeScheduleEmployeePeriodId == block.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    if (!String.IsNullOrEmpty(linkStr))
                        breaks = breaks.Where(b => b.Link == linkStr).ToList();
                    AddBreaksToTimeSchedulePlanningDayDTO(breaks, ref dto);
                }

                result.Add(dto);

                // Check if shift is linked together with any other shifts
                // If so, add them now to keep them sorted together
                // Only for hidden employee
                if (dto.EmployeeId == hiddenEmployeeId && dto.Link.HasValue && blocks.Count(b => b.Link == dto.Link.ToString() && b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None) > 1)
                {
                    List<GetTimeSchedulePlanningShifts_Result> linkedBlocks = blocks.Where(b => b.TimeScheduleTemplateBlockId != dto.TimeScheduleTemplateBlockId && b.Link == dto.Link.ToString() && b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    foreach (var linkedBlock in linkedBlocks.OrderBy(b => b.StartTime))
                    {
                        TimeSchedulePlanningDayDTO linkedDto = CreateTimeSchedulePlanningDayDTO(entities, linkedBlock, shiftTypes, timeScheduleTypes, timeDeviationCauses, employeeChilds, actorCompanyId, currentEmployeeId, true, false, false, showDeviationCauseNames: showDeviationCauseNames);
                        if (includeBreaks)
                        {
                            List<GetTimeSchedulePlanningShifts_Result> breaks = blocks.Where(b => b.TimeScheduleEmployeePeriodId == linkedBlock.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                            if (!String.IsNullOrEmpty(linkStr))
                                breaks = breaks.Where(b => b.Link == linkStr).ToList();
                            AddBreaksToTimeSchedulePlanningDayDTO(breaks, ref linkedDto);
                        }
                        result.Add(linkedDto);
                    }
                }
            }

            return result;
        }

        private TimeSchedulePlanningDayDTO CreateTimeSchedulePlanningDayDTO(CompEntities entities, GetTimeSchedulePlanningShifts_Result block, List<ShiftType> shiftTypes, List<TimeScheduleType> timeScheduleTypes, List<TimeDeviationCause> timeDeviationCauses, List<EmployeeChild> employeeChilds, int actorCompanyId, int currentEmployeeId, bool includeStatusNames, bool includeAttestStates, bool includeDeliveryAddress, bool dontChangeTimeOnZeroDays = false, bool showDeviationCauseNames = true)
        {
            bool zeroDay = block.StartTime == block.StopTime;

            TimeSchedulePlanningDayDTO dayDTO = new TimeSchedulePlanningDayDTO();

            // Shift type
            if (!block.ShiftTypeId.IsNullOrEmpty())
            {
                ShiftType shiftType = shiftTypes.FirstOrDefault(s => s.ShiftTypeId == block.ShiftTypeId.Value);
                if (shiftType != null)
                {
                    dayDTO.ShiftTypeCode = shiftType.NeedsCode;
                    dayDTO.ShiftTypeName = shiftType.Name;
                    dayDTO.ShiftTypeDesc = shiftType.Description;
                    dayDTO.ShiftTypeColor = shiftType.Color;

                    if (shiftType.TimeScheduleType != null)
                    {
                        dayDTO.ShiftTypeTimeScheduleTypeId = shiftType.TimeScheduleType.TimeScheduleTypeId;
                        dayDTO.ShiftTypeTimeScheduleTypeCode = shiftType.TimeScheduleType.Code;
                        dayDTO.ShiftTypeTimeScheduleTypeName = shiftType.TimeScheduleType.Name;
                    }
                }
            }

            // Time schedule type
            if (!block.TimeScheduleTypeId.IsNullOrEmpty())
            {
                TimeScheduleType timeScheduleType = timeScheduleTypes.FirstOrDefault(t => t.TimeScheduleTypeId == block.TimeScheduleTypeId.Value);
                if (timeScheduleType != null)
                {
                    dayDTO.TimeScheduleTypeId = timeScheduleType.TimeScheduleTypeId;
                    dayDTO.TimeScheduleTypeCode = timeScheduleType.Code;
                    dayDTO.TimeScheduleTypeName = timeScheduleType.Name;
                    dayDTO.TimeScheduleTypeIsNotScheduleTime = timeScheduleType.IsNotScheduleTime;

                    if (!timeScheduleType.TimeScheduleTypeFactor.IsNullOrEmpty())
                        dayDTO.TimeScheduleTypeFactors = timeScheduleType.TimeScheduleTypeFactor.Where(f => f.State == (int)SoeEntityState.Active).ToSmallDTOs().ToList();
                }
            }

            // Deviation cause
            string deviationCauseName = string.Empty;
            if (!block.TimeDeviationCauseId.IsNullOrEmpty())
            {
                TimeDeviationCause timeDeviationCause = timeDeviationCauses.FirstOrDefault(t => t.TimeDeviationCauseId == block.TimeDeviationCauseId.Value);
                if (timeDeviationCause != null && (showDeviationCauseNames || timeDeviationCause.IsVacation || block.EmployeeId == currentEmployeeId))
                    deviationCauseName = timeDeviationCause.Name;
                else
                    deviationCauseName = GetText(3360, "Frånvaro");
            }

            string employeeChildName = string.Empty;
            if (!block.EmployeeChildId.IsNullOrEmpty())
            {
                EmployeeChild employeeChild = employeeChilds.FirstOrDefault(t => t.EmployeeChildId == block.EmployeeChildId.Value);
                if (employeeChild != null && (showDeviationCauseNames || block.EmployeeId == currentEmployeeId))
                    employeeChildName = employeeChild.Name;
            }

            dayDTO.Type = (TermGroup_TimeScheduleTemplateBlockType)block.Type;
            dayDTO.TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId;
            dayDTO.TimeScheduleTemplateHeadId = block.TimeScheduleTemplateHeadId;
            dayDTO.TimeScheduleTemplatePeriodId = block.TimeScheduleTemplatePeriodId;
            dayDTO.TimeScheduleEmployeePeriodId = block.TimeScheduleEmployeePeriodId ?? 0;
            dayDTO.TimeScheduleScenarioHeadId = block.TimeScheduleScenarioHeadId;
            dayDTO.TimeDeviationCauseId = block.TimeDeviationCauseId;
            dayDTO.TimeDeviationCauseName = deviationCauseName;
            dayDTO.AbsenceType = (TermGroup_TimeScheduleTemplateBlockAbsenceType)block.AbsenceType;
            dayDTO.TimeCodeId = block.TimeCodeId;
            dayDTO.AccountId = block.AccountId;
            dayDTO.AccountName = block.AccountName;
            dayDTO.ShiftTypeId = block.ShiftTypeId ?? 0;
            dayDTO.EmployeeId = block.EmployeeId.Value;
            dayDTO.UserId = block.UserId; //Currently it is only used from mobilemanager
            dayDTO.EmployeeName = block.EmployeeName;
            dayDTO.EmployeeInfo = block.EmployeeInfo;
            dayDTO.EmployeeChildId = block.EmployeeChildId;
            dayDTO.EmployeeChildName = employeeChildName;
            dayDTO.IsHiddenEmployee = block.Hidden;
            dayDTO.IsVacant = block.Vacant;
            dayDTO.StartTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((block.StartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), block.StartTime);
            dayDTO.StopTime = CalendarUtility.MergeDateAndTime(block.Date.Value.AddDays((block.StopTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), block.StopTime);
            dayDTO.WeekNr = CalendarUtility.GetWeekNr(dayDTO.StartTime);
            dayDTO.BelongsToPreviousDay = block.BelongsToPreviousDay;
            dayDTO.BelongsToNextDay = block.BelongsToNextDay;
            dayDTO.Description = block.Description ?? "";
            dayDTO.ShiftStatus = (TermGroup_TimeScheduleTemplateBlockShiftStatus)block.ShiftStatus;
            dayDTO.ShiftUserStatus = (TermGroup_TimeScheduleTemplateBlockShiftUserStatus)block.ShiftUserStatus;
            dayDTO.IsPreliminary = block.IsPreliminary;
            dayDTO.NbrOfWantedInQueue = block.NbrOfWantedInQueue;
            dayDTO.DayNumber = block.DayNumber ?? 0;
            dayDTO.NbrOfWeeks = block.TemplateNbrOfWeeks ?? 0;
            dayDTO.Link = !string.IsNullOrEmpty(block.Link) ? new Guid(block.Link) : (Guid?)null;
            dayDTO.ExtraShift = block.ExtraShift;
            dayDTO.SubstituteShift = block.SubstituteShift;

            if (block.NbrOfWantedInQueue > 0)
                dayDTO.IamInQueue = (from q in entities.TimeScheduleTemplateBlockQueue where q.State == (int)SoeEntityState.Active && q.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId && q.EmployeeId == currentEmployeeId && q.Type == (int)TermGroup_TimeScheduleTemplateBlockQueueType.Wanted select q.TimeScheduleTemplateBlockQueueId).Any();

            if (zeroDay)
            {
                dayDTO.StartTime = CalendarUtility.GetBeginningOfDay(dayDTO.StartTime);

                if (dontChangeTimeOnZeroDays)
                    dayDTO.StopTime = CalendarUtility.GetBeginningOfDay(dayDTO.StopTime);
                else
                    dayDTO.StopTime = CalendarUtility.GetEndOfDay(dayDTO.StopTime);

                dayDTO.ShiftStatus = TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
            }

            if (includeStatusNames)
            {
                dayDTO.ShiftStatusName = GetText((int)dayDTO.ShiftStatus, (int)TermGroup.TimeScheduleEmployeePeriodStatus);
                dayDTO.ShiftUserStatusName = GetText((int)dayDTO.ShiftUserStatus, (int)TermGroup.TimeScheduleEmployeePeriodUserStatus);
            }

            // Staffing needs
            dayDTO.StaffingNeedsRowId = block.StaffingNeedsRowId;
            dayDTO.StaffingNeedsRowPeriodId = block.StaffingNeedsRowPeriodId;

            // Order planning
            if (block.CustomerInvoiceId.HasValue)
            {
                dayDTO.Order = CreateOrderListDTO(entities, block.CustomerInvoiceId.Value, actorCompanyId, includeAttestStates, includeDeliveryAddress);
                dayDTO.PlannedTime = block.PlannedTime;
            }

            if (block.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Schedule && block.Type != (int)TermGroup_TimeScheduleTemplateBlockType.Standby)
                dayDTO.NbrOfWeeks = 0;  // Clear this to prevent week number to be displayed

            return dayDTO;
        }

        private void AddBreaksToTimeSchedulePlanningDayDTO(IEnumerable<GetTimeSchedulePlanningShifts_Result> breakBlocks, ref TimeSchedulePlanningDayDTO dto)
        {
            int i = 0;
            foreach (var breakBlock in breakBlocks.OrderBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                DateTime startTime = breakBlock.Date.HasValue ? CalendarUtility.GetDateTime(breakBlock.Date.Value, breakBlock.StartTime).AddDays((breakBlock.StartTime - CalendarUtility.DATETIME_DEFAULT).Days) : breakBlock.StartTime;
                int length = (int)(breakBlock.StopTime - breakBlock.StartTime).TotalMinutes;
                Guid? link = (!String.IsNullOrEmpty(breakBlock.Link)) ? new Guid(breakBlock.Link) : (Guid?)null;

                i++;
                switch (i)
                {
                    case 1:
                        dto.Break1Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break1TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break1StartTime = startTime;
                        dto.Break1Minutes = length;
                        dto.Break1Link = link;
                        dto.Break1IsPreliminary = breakBlock.IsPreliminary;
                        break;
                    case 2:
                        dto.Break2Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break2TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break2StartTime = startTime;
                        dto.Break2Minutes = length;
                        dto.Break2Link = link;
                        dto.Break2IsPreliminary = breakBlock.IsPreliminary;
                        break;
                    case 3:
                        dto.Break3Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break3TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break3StartTime = startTime;
                        dto.Break3Minutes = length;
                        dto.Break3Link = link;
                        dto.Break3IsPreliminary = breakBlock.IsPreliminary;
                        break;
                    case 4:
                        dto.Break4Id = breakBlock.TimeScheduleTemplateBlockId;
                        dto.Break4TimeCodeId = breakBlock.TimeCodeId;
                        dto.Break4StartTime = startTime;
                        dto.Break4Minutes = length;
                        dto.Break4Link = link;
                        dto.Break4IsPreliminary = breakBlock.IsPreliminary;
                        break;
                }
            }
        }

        private static void SetHasShiftRequest(CompEntities entities, int actorCompanyId, List<GetTimeSchedulePlanningShifts_Result> allBlocks, List<TimeSchedulePlanningDayDTO> dtos)
        {
            List<int> allBlockIds = allBlocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None).Select(b => b.TimeScheduleTemplateBlockId).ToList();

            // Get all shift requests for loaded blocks (RecordId = TimeScheduleTemplateBlockId)
            List<int> shiftRequestIds = (from m in entities.Message
                                         where m.ActorCompanyId == actorCompanyId &&
                                         m.Type == (int)TermGroup_MessageType.ShiftRequest &&
                                         m.State != (int)SoeEntityState.Deleted &&
                                         allBlockIds.Contains(m.RecordId)
                                         select m.RecordId).ToList();

            // Get all recipients that has answered
            var recipients = (from r in entities.MessageRecipient
                              where r.State != (int)SoeEntityState.Deleted &&
                              r.AnswerType != 0 &&
                              shiftRequestIds.Contains(r.Message.RecordId)
                              select new { r.MessageId, TimeScheduleTemplateBlockId = r.Message.RecordId, r.Message.Created, r.AnswerType }).ToList();


            // Check if shift has a request
            foreach (var block in allBlocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None && shiftRequestIds.Contains(b.TimeScheduleTemplateBlockId)))
            {
                // Get last shift request (if sent before)
                int lastRequestId = (from r in recipients
                                     where r.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId
                                     orderby r.Created descending
                                     select r.MessageId).FirstOrDefault();

                // Get created DTO
                var dto = dtos.FirstOrDefault(d => d.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId);
                if (dto != null)
                {
                    dto.HasShiftRequest = true;
                    if (recipients.Any(r => r.MessageId == lastRequestId && r.AnswerType == (int)XEMailAnswerType.Yes))
                        dto.ShiftRequestAnswerType = XEMailAnswerType.Yes;
                    else if (recipients.Any(r => r.MessageId == lastRequestId && r.AnswerType == (int)XEMailAnswerType.No))
                        dto.ShiftRequestAnswerType = XEMailAnswerType.No;
                    else
                        dto.ShiftRequestAnswerType = XEMailAnswerType.None;

                    if (dto.Link.HasValue)
                    {
                        // Get linked shifts
                        foreach (var linkedDto in dtos.Where(d => d.Link == dto.Link).ToList())
                        {
                            linkedDto.HasShiftRequest = dto.HasShiftRequest;
                            linkedDto.ShiftRequestAnswerType = dto.ShiftRequestAnswerType;
                        }
                    }
                }
            }
        }

        #endregion

        #endregion

        #endregion

        #region Template schedule

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningDaysFromTemplate(int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, Guid? link, List<int> employeeIds, List<int> employeePostIds = null, bool includeGrossNetAndCost = false, bool includeEmploymentTaxAndSupplementChargeCost = false, bool loadYesterdayAlso = false, bool loadTasksAndDelivery = false, bool loadAccounts = false, bool loadTimeDeviationCause = true, bool loadEmployees = true, bool loadStaffingNeeds = true, bool doNotCheckHoliday = false, List<Employee> employees = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeSchedulePlanningDaysFromTemplate(entities, actorCompanyId, roleId, userId, dateFrom, dateTo, link, employeeIds, employeePostIds, includeGrossNetAndCost, includeEmploymentTaxAndSupplementChargeCost, loadYesterdayAlso, loadTasksAndDelivery, loadAccounts, loadTimeDeviationCause, loadEmployees, loadStaffingNeeds, doNotCheckHoliday, employees);
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningDaysFromTemplate(CompEntities entities, int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, Guid? link, List<int> employeeIds, List<int> employeePostIds = null, bool includeGrossNetAndCost = false, bool includeEmploymentTaxAndSupplementChargeCost = false, bool loadYesterdayAlso = false, bool loadTasksAndDelivery = false, bool loadAccounts = false, bool loadTimeDeviationCause = true, bool loadEmployees = true, bool loadStaffingNeeds = true, bool doNotCheckHoliday = false, List<Employee> employees = null)
        {
            List<TimeSchedulePlanningDayDTO> result = new List<TimeSchedulePlanningDayDTO>();

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            List<TimeScheduleTemplateHeadRangeDTO> timeScheduleTemplateHeadRanges;

            bool isEmployeePosts = !employeePostIds.IsNullOrEmpty();
            if (isEmployeePosts)
            {
                timeScheduleTemplateHeadRanges = (from t in entities.TimeScheduleTemplateHead
                                                  where t.EmployeePostId.HasValue && employeePostIds.Contains(t.EmployeePostId.Value) &&
                                                  t.EmployeeId == null &&
                                                  t.State == (int)SoeEntityState.Active &&
                                                  (t.StartDate != null && t.StartDate <= dateTo) &&
                                                  (t.StopDate == null || t.StopDate > dateFrom)
                                                  select new TimeScheduleTemplateHeadRangeDTO()
                                                  {
                                                      EmployeeId = t.EmployeePostId.Value,
                                                      TimeScheduleTemplateHeadId = t.TimeScheduleTemplateHeadId,
                                                      StartDate = t.StartDate.Value,
                                                      StopDate = t.StopDate,
                                                      NoOfDays = t.NoOfDays,
                                                  }).ToList();

                foreach (var employeeTemplates in timeScheduleTemplateHeadRanges.GroupBy(g => g.EmployeeId))
                {
                    var empTemplates = employeeTemplates.OrderBy(o => o.StartDate).ToList();
                    List<DateTime> startDates = empTemplates.Select(t => t.StartDate).ToList();
                    foreach (var empTemplateHead in empTemplates)
                    {
                        if (!empTemplateHead.StopDate.HasValue)
                        {
                            DateTime? nextStartDate = startDates.OrderBy(d => d).FirstOrDefault(d => d > empTemplateHead.StartDate);
                            if (nextStartDate.HasValue && nextStartDate.Value > empTemplateHead.StartDate)
                                empTemplateHead.StopDate = nextStartDate.Value.AddDays(-1);
                        }
                    }
                }
            }
            else
            {
                if (employeeIds == null)
                {
                    // If not filtered on employee, get all employees
                    employeeIds = (from e in entities.Employee
                                   where e.ActorCompanyId == actorCompanyId &&
                                   e.State == (int)SoeEntityState.Active &&
                                   !e.Hidden
                                   select e.EmployeeId).ToList();
                }

                timeScheduleTemplateHeadRanges = GetTimeScheduleTemplateHeadsRangeForEmployees(entities, employeeIds, actorCompanyId, dateFrom, dateTo)?.Heads;
            }

            int currentEmployeeId = EmployeeManager.GetEmployeeIdForUser(entities, userId, actorCompanyId);
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
            List<int> shiftTypeIds = GetShiftTypeIdsForUser(entities, null, actorCompanyId, roleId, userId, currentEmployeeId, true, dateFrom, dateTo);

            if (timeScheduleTemplateHeadRanges.Any())
            {
                List<TimeSchedulePlanningDayDTO> templates = GetTimeSchedulePlanningTemplates(entities, actorCompanyId, roleId, userId, currentEmployeeId, timeScheduleTemplateHeadRanges, dateFrom, dateTo, link, loadYesterdayAlso: loadYesterdayAlso, loadTasksAndDelivery: loadTasksAndDelivery, loadAccounts: loadAccounts, loadTimeDeviationCause: loadTimeDeviationCause, loadEmployees: !isEmployeePosts, loadStaffingNeeds: isEmployeePosts, hiddenEmployeeId: hiddenEmployeeId, shiftTypeIds: shiftTypeIds);
                result.AddRange(templates);
            }

            // Add gross, net and cost
            if (includeGrossNetAndCost)
                CalculateGrossNetAndCost(entities, result, actorCompanyId, 0, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost, doNotCheckHoliday: doNotCheckHoliday, employees: employees);

            return result.OrderByDescending(b => b.IsHiddenEmployee).ThenByDescending(b => b.IsVacant).ThenBy(b => b.StartTime).ThenBy(b => b.StopTime).ThenBy(b => b.ShiftTypeName).ToList();
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningTemplates(CompEntities entities, int actorCompanyId, int roleId, int userId, int currentEmployeeId, List<TimeScheduleTemplateHeadRangeDTO> timeScheduleTemplateHeadRanges, DateTime dateFrom, DateTime dateTo, Guid? link, bool loadYesterdayAlso = false, bool loadTasksAndDelivery = false, bool loadAccounts = false, bool loadTimeDeviationCause = true, bool loadEmployees = true, bool loadStaffingNeeds = true, int? hiddenEmployeeId = null, List<int> shiftTypeIds = null, bool includeZeroDays = false)
        {
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            entities.CommandTimeout = 60 * 2;
            bool isDayView = (dateFrom.Date == dateTo.Date);
            int batchsize = timeScheduleTemplateHeadRanges.Count > 1000 ? 20 : 40;
            List<int> timeScheduleTemplateHeadIds = timeScheduleTemplateHeadRanges.Select(s => s.TimeScheduleTemplateHeadId).Distinct().ToList();
            List<TimeScheduleTemplateHeadDTO> heads = entities.TimeScheduleTemplateHead.Where(w => timeScheduleTemplateHeadIds.Contains(w.TimeScheduleTemplateHeadId)).ToDTOs(false, false, false, false, false, false);

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            if (!hiddenEmployeeId.HasValue)
                hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));

            bool loadTimeScheduleType = true;
            string loadTimeScheduleTypeKey = $"loadTimeScheduleType#{actorCompanyId}";
            var loadTimeScheduleTypeFromCache = BusinessMemoryCache<bool?>.Get(loadTimeScheduleTypeKey);
            if (!loadTimeScheduleTypeFromCache.HasValue && !entities.TimeScheduleType.Any(a => a.ActorCompanyId == actorCompanyId && a.State == (int)SoeEntityState.Active))
            {
                loadTimeScheduleType = false;
                BusinessMemoryCache<bool?>.Set(loadTimeScheduleTypeKey, false, 60 * 10);
            }
            else if (loadTimeScheduleTypeFromCache.HasValue)
            {
                loadTimeScheduleType = loadTimeScheduleTypeFromCache.Value;
            }
            else
            {
                loadTimeScheduleType = true;
                BusinessMemoryCache<bool?>.Set(loadTimeScheduleTypeKey, true, 60 * 10);
            }

            List<TimeScheduleType> timeScheduleTypes = null;
            if (loadTimeScheduleType)
                timeScheduleTypes = entities.TimeScheduleType.Include("TimeScheduleTypeFactor").Where(a => a.State == (int)SoeEntityState.Active).AsNoTracking().ToList();

            if (loadTasksAndDelivery)
            {
                string key = $"loadTasksAndDelivery#{actorCompanyId}";
                bool? fromCache = BusinessMemoryCache<bool?>.Get(key);
                if (!fromCache.HasValue && !entities.TimeScheduleTask.Any(a => a.ActorCompanyId == actorCompanyId && a.State == (int)SoeEntityState.Active) && !entities.IncomingDeliveryHead.Any(a => a.ActorCompanyId == actorCompanyId && a.State == (int)SoeEntityState.Active))
                {
                    loadTasksAndDelivery = false;
                    BusinessMemoryCache<bool?>.Set(key, false, 60 * 10);
                }
                else if (fromCache.HasValue)
                {
                    loadTasksAndDelivery = fromCache.Value;
                }
                else
                {
                    loadTasksAndDelivery = true;
                    BusinessMemoryCache<bool?>.Set(key, true, 60 * 10);
                }
            }

            if (loadStaffingNeeds)
            {
                string key = $"loadStaffingNeeds#{actorCompanyId}";
                bool? fromCache = BusinessMemoryCache<bool?>.Get(key);
                if (!fromCache.HasValue && !entities.StaffingNeedsHead.Any(a => a.ActorCompanyId == actorCompanyId && a.State == (int)SoeEntityState.Active))
                {
                    loadStaffingNeeds = false;
                    BusinessMemoryCache<bool?>.Set(key, false, 60 * 10);
                }
                else if (fromCache.HasValue)
                {
                    loadStaffingNeeds = fromCache.Value;
                }
                else
                {
                    loadStaffingNeeds = true;
                    BusinessMemoryCache<bool?>.Set(key, true, 60 * 10);
                }
            }

            if (!timeScheduleTemplateHeadRanges.IsNullOrEmpty())
            {
                foreach (var headGroup in timeScheduleTemplateHeadRanges.Where(w => (w.StopDate >= dateFrom || !w.StopDate.HasValue) && w.StartDate <= dateTo).GroupBy(g => $"{(g.StartDate > dateFrom ? g.StartDate : dateFrom)}#{g.NoOfDays}"))
                {
                    List<int> templateHeadIds = headGroup.Select(s => s.TimeScheduleTemplateHeadId).ToList();

                    // Get template blocks for current template
                    IQueryable<TimeScheduleTemplateBlock> query = entities.TimeScheduleTemplateBlock
                                                                .Include("ShiftType")
                                                                .Include("TimeScheduleTemplatePeriod.TimeScheduleTemplateHead");


                    if (loadTasksAndDelivery)
                    {
                        query = query.Include("TimeScheduleTemplateBlockTask.TimeScheduleTask");
                        query = query.Include("TimeScheduleTemplateBlockTask.IncomingDeliveryRow");
                    }
                    if (loadAccounts)
                        query = query.Include("AccountInternal");
                    if (loadTimeDeviationCause)
                        query = query.Include("TimeDeviationCause");
                    if (loadEmployees)
                        query = query.Include("Employee.ContactPerson");
                    if (loadStaffingNeeds)
                        query = query.Include("StaffingNeedsRow.StaffingNeedsHead");

                    if (link.HasValue)
                    {
                        string linkStr = link.Value.ToString();
                        query = query.Where(b => b.Link.Equals(linkStr));
                    }

                    List<TimeScheduleTemplateBlock> templateBlocksOnGroup = new List<TimeScheduleTemplateBlock>();

                    while (templateHeadIds.Any())
                    {
                        List<int> batchIds = templateHeadIds.Take(batchsize).ToList();

                        List<int> blocksIds = (from tb in entities.TimeScheduleTemplateBlock
                                               where
                                                tb.TimeScheduleTemplatePeriodId.HasValue &&
                                                batchIds.Contains(tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHeadId) &&
                                                !tb.Date.HasValue &&
                                                (includeZeroDays || tb.StartTime != tb.StopTime) &&
                                                tb.State == (int)SoeEntityState.Active &&
                                                tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId
                                               select tb.TimeScheduleTemplateBlockId).ToList();

                        templateHeadIds = templateHeadIds.Where(w => !batchIds.Contains(w)).ToList();

                        while (blocksIds.Any())
                        {
                            List<int> batchBlocksIds = blocksIds.Take(batchsize * 1000).ToList();
                            templateBlocksOnGroup.AddRange((from tb in query
                                                            where batchBlocksIds.Contains(tb.TimeScheduleTemplateBlockId)
                                                            select tb).AsNoTracking().ToList());

                            blocksIds = blocksIds.Where(w => !batchBlocksIds.Contains(w)).ToList();
                        }
                    }

                    templateBlocksOnGroup = templateBlocksOnGroup.Where(tb => !tb.TimeScheduleScenarioHeadId.HasValue).ToList();
                    if (templateBlocksOnGroup.Any())
                    {
                        if (timeScheduleTypes != null)
                        {
                            foreach (var timeScheduleTypeGroup in templateBlocksOnGroup.Where(w => w.TimeScheduleTypeId.HasValue).GroupBy(g => g.TimeScheduleTypeId.Value))
                            {
                                TimeScheduleType timeScheduleType = timeScheduleTypes.FirstOrDefault(f => f.TimeScheduleTypeId == timeScheduleTypeGroup.Key);
                                timeScheduleTypeGroup.ToList().ForEach(f => f.TimeScheduleType = timeScheduleType);
                            }
                        }

                        foreach (TimeScheduleTemplateHeadRangeDTO templateHead in headGroup)
                        {
                            // If multiple employees has the same template, Date must be reset for every employee.
                            // Otherwise templateBlocks query below will ignore them on second employee.
                            foreach (TimeScheduleTemplateBlock tb in templateBlocksOnGroup.Where(t => t.DateHasBeenAltered).ToList())
                            {
                                tb.Date = null;
                                tb.DateHasBeenAltered = false;
                            }

                            TimeScheduleTemplateHeadDTO head = heads.FirstOrDefault(f => f.TimeScheduleTemplateHeadId == templateHead.TimeScheduleTemplateHeadId);
                            DateTime templateHeadStartDate = head.StartDate.HasValue ? head.StartDate.Value.Date : dateFrom;
                            DateTime templateHeadFirstMondayOfCycle = head.FirstMondayOfCycle.HasValue ? head.FirstMondayOfCycle.Value.Date : templateHeadStartDate;
                            int diffStartDays = 0;
                            if (head.FirstMondayOfCycle.HasValue && head.StartDate.HasValue && head.FirstMondayOfCycle.Value != head.StartDate.Value)
                                diffStartDays = (int)(head.StartDate.Value - head.FirstMondayOfCycle.Value).TotalDays;

                            List<TimeScheduleTemplateBlock> templateBlocks = templateBlocksOnGroup.Where(w => !w.Date.HasValue && w.TimeScheduleTemplatePeriod != null && w.TimeScheduleTemplatePeriod.TimeScheduleTemplateHeadId == templateHead.TimeScheduleTemplateHeadId).ToList();
                            if (templateBlocks.Any())
                            {
                                int offsetBackwards = 0;
                                if (shiftTypeIds == null)
                                    shiftTypeIds = GetShiftTypeIdsForUser(entities, null, actorCompanyId, roleId, userId, currentEmployeeId, true, dateFrom, dateTo);
                                if (shiftTypeIds.Count > 0)
                                    templateBlocks = templateBlocks.Where(b => b.EmployeeId == currentEmployeeId || (b.ShiftTypeId.HasValue && shiftTypeIds.Contains(b.ShiftTypeId.Value)) || !b.ShiftTypeId.HasValue || b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();

                                while (templateHeadStartDate.AddDays(-offsetBackwards) > templateHead.StartDate)
                                {
                                    offsetBackwards += head.NoOfDays;
                                }

                                // Set initial dates on template blocks
                                foreach (TimeScheduleTemplateBlock block in templateBlocks)
                                {
                                    // Initially block.Date is null, set it to template start date + day number
                                    block.DateHasBeenAltered = true;
                                    block.Date = templateHeadStartDate.AddDays(-offsetBackwards + block.TimeScheduleTemplatePeriod.DayNumber - 1 - diffStartDays);
                                }

                                int firstDayNumber = 0;

                                // Loop through all days in current period and create blocks
                                // If no blocks found for a specific day, create zero schedule blocks
                                DateTime visibleStartDate = templateHead.StartDate > dateFrom ? templateHead.StartDate : dateFrom;
                                DateTime currentDate = visibleStartDate;
                                DateTime endDate = templateHead.StopDate.HasValue && templateHead.StopDate < dateTo ? templateHead.StopDate.Value : dateTo;
                                while (currentDate <= endDate)
                                {
                                    // Check template stop date
                                    if (templateHead.StopDate.HasValue && currentDate > templateHead.StopDate.Value)
                                        break;

                                    List<TimeScheduleTemplateBlock> blocks = new List<TimeScheduleTemplateBlock>();
                                    DateTime currentDateInner = currentDate;

                                    // Decrease current date by number of days in template until blocks are found
                                    while (!blocks.Any() && currentDateInner >= templateHeadFirstMondayOfCycle.AddDays(-offsetBackwards))
                                    {
                                        if (isDayView && loadYesterdayAlso)
                                            blocks = templateBlocks.Where(b => b.Date.Value == currentDateInner || b.ActualStartTime.Value.Date == currentDateInner || b.ActualStopTime.Value.Date == currentDateInner).ToList();
                                        else
                                            blocks = templateBlocks.Where(b => b.Date.Value == currentDateInner).ToList();

                                        currentDateInner = currentDateInner.AddDays(-head.NoOfDays);
                                    }

                                    // Convert to DTO
                                    foreach (TimeScheduleTemplateBlock block in blocks.OrderBy(b => b.Date).ThenBy(b => b.StartTime))
                                    {
                                        block.EmployeeId = templateHead.EmployeeId;
                                        block.ShiftStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftStatus.Assigned;
                                        block.ShiftUserStatus = (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Accepted;

                                        if (block.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None)
                                        {
                                            int nbrOfDays = block.TimeScheduleTemplatePeriod != null && block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead != null ? block.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.NoOfDays : 0;
                                            if (nbrOfDays > 0)
                                            {
                                                while (block.Date < visibleStartDate)
                                                {
                                                    block.Date = block.Date.Value.AddDays(nbrOfDays);
                                                }

                                                // Repeating weeks
                                                int weekCounter = dtos.Count(b => b.TimeScheduleTemplateBlockId == block.TimeScheduleTemplateBlockId && b.EmployeeId == block.EmployeeId);
                                                if (weekCounter > 0)
                                                    block.Date = block.Date.Value.AddDays(nbrOfDays * weekCounter);
                                            }

                                            TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(block, actorCompanyId, 0, dontChangeTimeOnZeroDays: includeZeroDays);

                                            if (firstDayNumber == 0)
                                                firstDayNumber = dto.DayNumber;

                                            List<TimeScheduleTemplateBlock> breakBlocks = templateBlocks.Where(b => b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None && (b.TimeScheduleTemplatePeriod.DayNumber == block.TimeScheduleTemplatePeriod.DayNumber)).ToList();
                                            List<TimeScheduleTemplateBlock> noneBreakBlocks = blocks.Where(b => b.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None && (b.TimeScheduleTemplatePeriod.DayNumber == block.TimeScheduleTemplatePeriod.DayNumber)).ToList();

                                            if (breakBlocks.Any())
                                                AddBreaksToTimeSchedulePlanningDayDTO(breakBlocks, currentDate, ref dto, (hiddenEmployeeId == templateHead.EmployeeId ? noneBreakBlocks : null));

                                            if (block.Date > visibleStartDate.AddDays(7 * dto.NbrOfWeeks).AddSeconds(-1))
                                            {
                                                dto.OriginalBlockId = block.TimeScheduleTemplateBlockId;
                                                dto.TimeScheduleTemplateBlockId = 0;
                                            }

                                            dtos.Add(dto);
                                        }
                                    }

                                    // Merge breaks into first DTO of the day
                                    // Sometimes they can differ eg:
                                    //   Shift 1: 18:00-22:00 (BelongsToNextDay)
                                    //   Shift 2: 22:00-06:00
                                    //   Break 1: 03:00-03:30 (will only be set on shift 2 in method AddBreaksToTimeSchedulePlanningDayDTO)
                                    List<TimeSchedulePlanningDayDTO> dayDTOs = dtos.Where(d => d.TimeScheduleTemplateHeadId == templateHead.TimeScheduleTemplateHeadId && d.ActualDate == currentDate && !d.IsHiddenEmployee).ToList();
                                    if (dayDTOs.Count > 1)
                                    {
                                        TimeSchedulePlanningDayDTO firstDayDTO = dayDTOs[0];
                                        List<BreakDTO> firstDayBreaks = firstDayDTO.GetBreaks();

                                        foreach (TimeSchedulePlanningDayDTO dayDTO in dayDTOs.Where(d => d.TimeScheduleTemplateBlockId != firstDayDTO.TimeScheduleTemplateBlockId))
                                        {
                                            foreach (BreakDTO dtoBreak in dayDTO.GetBreaks())
                                            {
                                                if (!firstDayBreaks.Select(b => b.Id).Contains(dtoBreak.Id))
                                                    firstDayDTO.AddBreak(dtoBreak, false, dtoBreak.Link, null);
                                            }
                                        }
                                    }

                                    currentDate = currentDate.AddDays(1);
                                }
                            }
                        }
                    }
                }
            }

            return dtos;
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningTemplate(int actorCompanyId, int roleId, int userId, int currentEmployeeId, int timeScheduleTemplateHeadId, DateTime dateFrom, DateTime dateTo, bool useNbrOfDaysFromTemplate = true, bool loadYesterdayAlso = false, bool loadTasksAndDelivery = false, bool loadAccounts = false, bool loadTimeDeviationCause = true, bool loadEmployees = true, bool loadStaffingNeeds = true, int? hiddenEmployeeId = null, List<int> shiftTypeIds = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeSchedulePlanningTemplate(entities, actorCompanyId, roleId, userId, currentEmployeeId, timeScheduleTemplateHeadId, dateFrom, dateTo, useNbrOfDaysFromTemplate, loadYesterdayAlso, loadTasksAndDelivery, loadAccounts, loadTimeDeviationCause, loadEmployees, loadStaffingNeeds, hiddenEmployeeId, shiftTypeIds);
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningTemplate(CompEntities entities, int actorCompanyId, int roleId, int userId, int currentEmployeeId, int timeScheduleTemplateHeadId, DateTime dateFrom, DateTime dateTo, bool useNbrOfDaysFromTemplate = true, bool loadYesterdayAlso = false, bool loadTasksAndDelivery = false, bool loadAccounts = false, bool loadTimeDeviationCause = true, bool loadEmployees = true, bool loadStaffingNeeds = true, int? hiddenEmployeeId = null, List<int> shiftTypeIds = null, bool includeZeroDays = false)
        {
            TimeScheduleTemplateHeadRangeDTO timeScheduleTemplateHeadRange = GetTimeScheduleTemplateHeadsRangeForEmployees(entities, timeScheduleTemplateHeadId);
            if (timeScheduleTemplateHeadRange != null)
            {
                if (useNbrOfDaysFromTemplate)
                {
                    if (timeScheduleTemplateHeadRange.StartDate != CalendarUtility.DATETIME_DEFAULT)
                        dateFrom = timeScheduleTemplateHeadRange.StartDate;
                    dateTo = dateFrom.AddDays(timeScheduleTemplateHeadRange.NoOfDays - 1);
                }
                return GetTimeSchedulePlanningTemplates(entities, actorCompanyId, roleId, userId, currentEmployeeId, new List<TimeScheduleTemplateHeadRangeDTO>() { timeScheduleTemplateHeadRange }, dateFrom, dateTo, null, loadYesterdayAlso, loadTasksAndDelivery, loadAccounts, loadTimeDeviationCause, loadEmployees, loadStaffingNeeds, hiddenEmployeeId, shiftTypeIds, includeZeroDays: includeZeroDays);
            }

            return new List<TimeSchedulePlanningDayDTO>();
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningTemplate(CompEntities entities, int actorCompanyId, int roleId, int userId, int employeeId, DateTime dateFrom, DateTime dateTo, bool loadYesterdayAlso = false, bool loadTasksAndDelivery = false, bool loadAccounts = false, bool loadTimeDeviationCause = true, bool loadEmployees = true, bool loadStaffingNeeds = true, int? hiddenEmployeeId = null, List<int> shiftTypeIds = null)
        {
            List<TimeSchedulePlanningDayDTO> planningDayDTOs = new List<TimeSchedulePlanningDayDTO>();
            var timeScheduleTemplateHeadsRange = GetTimeScheduleTemplateHeadsRangeForEmployees(entities, new List<int>() { employeeId }, actorCompanyId, dateFrom, dateTo);
            if (timeScheduleTemplateHeadsRange?.Heads != null)
            {
                foreach (var timeScheduleTemplateHeadRange in timeScheduleTemplateHeadsRange.Heads.Where(h => h.StartDate <= dateTo && (!h.StopDate.HasValue || h.StopDate >= dateFrom)).ToList())
                {
                    DateTime currentDateFrom = timeScheduleTemplateHeadRange.StartDate != CalendarUtility.DATETIME_DEFAULT ? timeScheduleTemplateHeadRange.StartDate : dateFrom;
                    if (currentDateFrom < dateFrom)
                        currentDateFrom = dateFrom;
                    DateTime currentDateTo = timeScheduleTemplateHeadRange.StopDate ?? dateTo;
                    if (currentDateTo > dateTo)
                        currentDateTo = dateTo;

                    planningDayDTOs.AddRange(GetTimeSchedulePlanningTemplates(entities, actorCompanyId, roleId, userId, employeeId, new List<TimeScheduleTemplateHeadRangeDTO>() { timeScheduleTemplateHeadRange }, currentDateFrom, currentDateTo, null, loadYesterdayAlso: loadYesterdayAlso, loadTasksAndDelivery: loadTasksAndDelivery, loadAccounts: loadAccounts, loadTimeDeviationCause: loadTimeDeviationCause, loadEmployees: loadEmployees, loadStaffingNeeds: loadStaffingNeeds, hiddenEmployeeId: hiddenEmployeeId, shiftTypeIds: shiftTypeIds));
                }
            }

            return planningDayDTOs;
        }

        public IEnumerable<TimeSchedulePlanningDayDTO> GetTimeSchedulePlanningTemplateShiftsGrossNetAndCost(int actorCompanyId, int roleId, int userId, DateTime dateFrom, DateTime dateTo, List<int> employeeIds, bool includeEmploymentTaxAndSupplementChargeCost, bool doNotCheckHoliday)
        {
            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            ConcurrentBag<TimeSchedulePlanningDayDTO> result = new ConcurrentBag<TimeSchedulePlanningDayDTO>();

            int currentEmployeeId = EmployeeManager.GetEmployeeIdForUser(userId, actorCompanyId);

            // If not filtered on employee, get all employees
            if (employeeIds == null)
            {
                employeeIds = (from e in entitiesReadOnly.Employee
                               where e.ActorCompanyId == actorCompanyId &&
                               e.State == (int)SoeEntityState.Active &&
                               !e.Hidden
                               select e.EmployeeId).ToList();
            }

            // Get latest template that starts before current interval ends, for each employee
            List<GetLatestScheduleTemplateForEmployeesResult> heads = entitiesReadOnly.GetLatestScheduleTemplateForEmployees(actorCompanyId, dateTo).ToList();

            Parallel.ForEach(employeeIds, GetDefaultParallelOptions(), employeeId =>
            {
                using (CompEntities pEntities = new CompEntities())
                {
                    GetLatestScheduleTemplateForEmployeesResult head = heads.FirstOrDefault(h => h.EmployeeId == employeeId);
                    if (head != null)
                    {
                        List<TimeSchedulePlanningDayDTO> templates = GetTimeSchedulePlanningTemplate(actorCompanyId, roleId, userId, currentEmployeeId, head.TimeScheduleTemplateHeadId, dateFrom, dateTo, useNbrOfDaysFromTemplate: false);
                        foreach (TimeSchedulePlanningDayDTO template in templates)
                        {
                            result.Add(template);
                        }
                    }
                }
            });

            // Add gross, net and cost
            CalculateGrossNetAndCost(result, actorCompanyId, 0, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: includeEmploymentTaxAndSupplementChargeCost, doNotCheckHoliday: doNotCheckHoliday);

            return result;
        }

        public List<TimeSchedulePlanningAggregatedDayDTO> GetTimeSchedulePlanningTemplateAggregated(int actorCompanyId, int roleId, int userId, int employeeId, DateTime dateFrom, DateTime dateTo, bool loadTasksAndDelivery = false, bool includeOnDuty = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeSchedulePlanningTemplateAggregated(entities, actorCompanyId, roleId, userId, employeeId, dateFrom, dateTo, loadTasksAndDelivery, includeOnDuty);
        }

        public List<TimeSchedulePlanningAggregatedDayDTO> GetTimeSchedulePlanningTemplateAggregated(CompEntities entities, int actorCompanyId, int roleId, int userId, int employeeId, DateTime dateFrom, DateTime dateTo, bool loadTasksAndDelivery, bool includeOnDuty)
        {
            List<TimeSchedulePlanningAggregatedDayDTO> aggregatedDays = new List<TimeSchedulePlanningAggregatedDayDTO>();

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            int currentEmployeeId = EmployeeManager.GetEmployeeIdForUser(entities, userId, actorCompanyId);

            List<TimeScheduleTemplateHeadDTO> templateHeads = (from th in entities.TimeScheduleTemplateHead
                                                               .Include("EmployeeSchedule")
                                                               where th.ActorCompanyId == actorCompanyId &&
                                                               th.EmployeeId == employeeId &&
                                                               th.StartDate.HasValue &&
                                                               th.State == (int)SoeEntityState.Active
                                                               select th).ToDTOs(false, false, true, false, false, false);

            templateHeads = templateHeads.Where(x => x.EmployeeSchedules.Any(y => y.State == SoeEntityState.Active)).ToList();

            #region Decide stopdate

            templateHeads = templateHeads.OrderBy(x => x.StartDate).ToList();
            TimeScheduleTemplateHeadDTO previousTemplateHead = null;
            for (int i = templateHeads.Count - 1; i >= 0; i--)
            {
                var personalTemplateHead = templateHeads[i];

                if (previousTemplateHead != null && personalTemplateHead.StopDate.HasValue && previousTemplateHead.StartDate.Value <= personalTemplateHead.StopDate.Value && personalTemplateHead.StartDate <= previousTemplateHead.StartDate.Value.AddDays(-1))
                    personalTemplateHead.StopDate = previousTemplateHead.StartDate.Value.AddDays(-1); // StartDate on next schedule (previousTemplateHead) has precedence over stopdate on current.
                else if (personalTemplateHead.StopDate.HasValue)
                    personalTemplateHead.StopDate = personalTemplateHead.StopDate.Value;
                else if (previousTemplateHead != null)
                    personalTemplateHead.StopDate = previousTemplateHead.StartDate.Value.AddDays(-1);
                else
                    personalTemplateHead.StopDate = DateTime.MaxValue;

                previousTemplateHead = personalTemplateHead;
            }

            #endregion

            templateHeads = templateHeads.Where(x => x.StartDate <= dateTo && x.StopDate >= dateFrom).ToList();
            //timescheduletemplateheadid/datefrom/dateto
            List<Tuple<int, DateTime, DateTime>> templates = new List<Tuple<int, DateTime, DateTime>>();
            DateTime currentDateFrom = dateFrom;

            foreach (var head in templateHeads)
            {
                if (head.StartDate > dateTo)
                    break;

                if (!head.StartDate.HasValue)
                    continue;

                if (!head.StopDate.HasValue) //should be decided above
                    continue;

                if (head.StartDate > currentDateFrom)
                    currentDateFrom = head.StartDate.Value;

                DateTime currentDateTo = head.StopDate.Value > dateTo ? dateTo : head.StopDate.Value;
                templates.Add(Tuple.Create(head.TimeScheduleTemplateHeadId, currentDateFrom, currentDateTo));
            }

            List<TimeSchedulePlanningDayDTO> dayDtos = new List<TimeSchedulePlanningDayDTO>();
            foreach (var template in templates)
            {
                dayDtos.AddRange(GetTimeSchedulePlanningTemplate(entities, actorCompanyId, roleId, userId, currentEmployeeId, template.Item1, template.Item2, template.Item3, useNbrOfDaysFromTemplate: false, loadTasksAndDelivery: loadTasksAndDelivery));
            }

            // On duty
            if (!includeOnDuty)
                dayDtos = dayDtos.Where(b => b.Type != TermGroup_TimeScheduleTemplateBlockType.OnDuty).ToList();

            foreach (var day in dayDtos.GroupBy(x => x.StartTime.Date).ToList())
            {
                aggregatedDays.Add(new TimeSchedulePlanningAggregatedDayDTO(day.ToList()));
            }

            return aggregatedDays;
        }

        #endregion

        #region Employee request

        public ActionResult GetShiftsIsIncludedInAbsenceRequestWarningMessage(int employeeId, List<TimeSchedulePlanningDayDTO> shifts)
        {
            ActionResult result = new ActionResult();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            string warningMsg = string.Empty;
            List<EmployeeRequest> requests = new List<EmployeeRequest>();

            foreach (var shift in shifts)
            {
                EmployeeRequest request = (from er in entitiesReadOnly.EmployeeRequest.Include("TimeDeviationCause")
                                           where er.EmployeeId == employeeId &&
                                           er.Type == (int)TermGroup_EmployeeRequestType.AbsenceRequest &&
                                           er.Status != (int)TermGroup_EmployeeRequestStatus.Restored
                                           && (er.Start <= shift.StartTime && er.Stop >= shift.StartTime) &&
                                           er.State == (int)SoeEntityState.Active
                                           select er).FirstOrDefault();

                if (request != null && !requests.Any(x => x.EmployeeRequestId == request.EmployeeRequestId))
                    requests.Add(request);
            }

            if (requests.Any())
                result.Success = false;

            foreach (EmployeeRequest request in requests)
            {
                List<TimeSchedulePlanningDayDTO> includedShifts = shifts.Where(x => request.Start <= x.StartTime && request.Stop >= x.StartTime).ToList();
                if (includedShifts.Count > 0)
                {
                    warningMsg += GetText(8442, "Följande pass ingår i ledighetsansökan") + ", " + request.TimeDeviationCause.Name + ": " + request.Start.Date.ToShortDateString() + " - " + request.Stop.Date.ToShortDateString() + ":" + "\n";

                    foreach (var includedShift in includedShifts)
                    {
                        warningMsg += includedShift.StartTime.ToShortTimeString() + " - " + includedShift.StopTime.ToShortTimeString() + " " + includedShift.ShiftTypeName + "\n";
                    }
                }

                warningMsg += "\n";
                shifts.RemoveRange(includedShifts);
            }

            result.ErrorMessage = warningMsg;
            return result;
        }

        public IEnumerable<TimeSchedulePlanningDayDTO> GetAbsenceAffectedShifts(int actorCompanyId, int userId, int employeeId, int? timeScheduleScenarioHeadId, DateTime dateFrom, DateTime dateTo, int timeDeviationCauseId, ExtendedAbsenceSetting extendedAbsenceSettings, bool includeAlreadyAbsence)
        {
            bool includeZeroDays = false;
            var timdeDeviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(timeDeviationCauseId, actorCompanyId, false);
            if (timdeDeviationCause != null)
                includeZeroDays = timdeDeviationCause.ShowZeroDaysInAbsencePlanning;

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<TimeScheduleTemplateBlock> shifts = GetShiftsAffectedByIntervall(entitiesReadOnly, actorCompanyId, employeeId, timeScheduleScenarioHeadId, dateFrom, dateTo, true, includeZeroDays, includeAlreadyAbsence, out DateTime fetchStartTime, out DateTime fetchStopTime, timeDeviationCauseId: timeDeviationCauseId, includeMidnightShifts: (extendedAbsenceSettings != null && !extendedAbsenceSettings.IsWholeDay)).ToList();

            // Convert to DTO
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            foreach (TimeScheduleTemplateBlock shift in shifts.OrderBy(b => b.EmployeeId).ThenBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                if (shift.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.None)
                    continue;

                TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(shift, actorCompanyId, 0, dontChangeTimeOnZeroDays: includeZeroDays);
                if (dto != null)
                {
                    List<TimeScheduleTemplateBlock> breaks = shifts.Where(b => b.TimeScheduleEmployeePeriodId == shift.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    AddBreaksToTimeSchedulePlanningDayDTO(breaks, null, ref dto);

                    if (dto.Type != TermGroup_TimeScheduleTemplateBlockType.Order && dto.Type != TermGroup_TimeScheduleTemplateBlockType.Booking)
                        dtos.Add(dto);
                }
            }
            if (includeZeroDays && timeScheduleScenarioHeadId.HasValue)
            {
                FillGapsWithZeroShifts(fetchStartTime, fetchStopTime, employeeId, timeScheduleScenarioHeadId, dtos);
                dtos = dtos.OrderBy(o => o.ActualDate).ToList();
            }

            dtos = ApplyExtendedAbsenceSettings(dateFrom, dateTo, dtos, extendedAbsenceSettings);
            SetHasMultipleEmployeeAccounts(entitiesReadOnly, actorCompanyId, employeeId, dtos);
            SetShiftIsLended(entitiesReadOnly, actorCompanyId, userId, dtos);
            return dtos;
        }

        public IEnumerable<TimeSchedulePlanningDayDTO> GetAbsenceAffectedShifts(int actorCompanyId, int userId, int employeeId, int? timeScheduleScenarioHeadId, int? timeDeviationCauseId, List<DateTime> dates)
        {
            bool includeZeroDays = false;
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            if (timeDeviationCauseId.HasValue)
            {
                dates = AdjustDatesAccordingToAttachedDays(entitiesReadOnly, timeScheduleScenarioHeadId, timeDeviationCauseId.Value, actorCompanyId, employeeId, dates);
                var timdeDeviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(timeDeviationCauseId.Value, actorCompanyId, false);
                if (timdeDeviationCause != null)
                    includeZeroDays = timdeDeviationCause.ShowZeroDaysInAbsencePlanning;
            }

            var shifts = (from tb in entitiesReadOnly.TimeScheduleTemplateBlock
                                                                         .Include("ShiftType")
                                                                         .Include("TimeDeviationCause")
                                                                         .Include("Employee.ContactPerson")
                                                                         .Include("Account")
                          where (timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue) &&
                          (tb.EmployeeId == employeeId &&
                          tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                          (tb.Date.HasValue && dates.Contains(tb.Date.Value)) &&
                          tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                          tb.State == (int)SoeEntityState.Active
                          select tb).ToList();


            // Convert to DTO
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            foreach (TimeScheduleTemplateBlock shift in shifts.OrderBy(b => b.EmployeeId).ThenBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                if (shift.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.None)
                    continue;

                TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(shift, actorCompanyId, 0, dontChangeTimeOnZeroDays: true);
                if (dto != null)
                {
                    List<TimeScheduleTemplateBlock> breaks = shifts.Where(b => b.TimeScheduleEmployeePeriodId == shift.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    AddBreaksToTimeSchedulePlanningDayDTO(breaks, null, ref dto);

                    dtos.Add(dto);
                }
            }

            if (includeZeroDays && timeScheduleScenarioHeadId.HasValue)
                FillGapsWithZeroShifts(dates, employeeId, timeScheduleScenarioHeadId, dtos);

            foreach (var dto in dtos)
            {
                dto.AbsenceStartTime = dto.StartTime;
                dto.AbsenceStopTime = dto.StopTime;
            }

            SetHasMultipleEmployeeAccounts(entitiesReadOnly, actorCompanyId, employeeId, dtos);
            SetShiftIsLended(entitiesReadOnly, actorCompanyId, userId, dtos);
            return dtos;
        }

        public IEnumerable<TimeSchedulePlanningDayDTO> GetAbsenceRequestAffectedShifts(int actorCompanyId, int userId, int? timeScheduleScenarioHeadId, EmployeeRequestDTO request, TermGroup_TimeScheduleTemplateBlockShiftUserStatus shiftUserStatus, ExtendedAbsenceSetting extendedSettings)
        {
            bool includeZeroDays = false;

            if (request.TimeDeviationCauseId.HasValue)
            {
                var timdeDeviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(request.TimeDeviationCauseId.Value, actorCompanyId, false);
                if (timdeDeviationCause != null)
                    includeZeroDays = timdeDeviationCause.ShowZeroDaysInAbsencePlanning;
            }

            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var dtos = GetAbsenceRequestAffectedShifts(entitiesReadOnly, actorCompanyId, request.EmployeeId, timeScheduleScenarioHeadId, request.Start, request.Stop, shiftUserStatus, extendedSettings, includeZeroDays, timeDeviationCauseId: request.TimeDeviationCauseId).ToList();
            SetHasMultipleEmployeeAccounts(entitiesReadOnly, actorCompanyId, request.EmployeeId, dtos);
            SetShiftIsLended(entitiesReadOnly, actorCompanyId, userId, dtos);
            return dtos;
        }

        public IEnumerable<TimeSchedulePlanningDayDTO> GetAbsenceRequestAffectedShifts(CompEntities entities, int actorCompanyId, int employeeId, int? timeScheduleScenarioHeadId, DateTime dateFrom, DateTime dateTo, TermGroup_TimeScheduleTemplateBlockShiftUserStatus shiftUserStatus, ExtendedAbsenceSetting extendedSettings, bool includeZeroDays, int? timeDeviationCauseId = null)
        {
            List<TimeScheduleTemplateBlock> shifts = GetShiftsAffectedByIntervall(entities, actorCompanyId, employeeId, timeScheduleScenarioHeadId, dateFrom, dateTo, true, includeZeroDays, includeAlreadyAbsence: false, out _, out _, timeDeviationCauseId: timeDeviationCauseId, includeMidnightShifts: (extendedSettings != null && !extendedSettings.IsWholeDay)).ToList();

            // Convert to DTO
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            foreach (TimeScheduleTemplateBlock shift in shifts.OrderBy(b => b.EmployeeId).ThenBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                if (shift.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.None)
                    continue;

                TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(entities, shift, actorCompanyId, 0, dontChangeTimeOnZeroDays: includeZeroDays);
                if (dto != null)
                {
                    List<TimeScheduleTemplateBlock> breaks = shifts.Where(b => b.TimeScheduleEmployeePeriodId == shift.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    AddBreaksToTimeSchedulePlanningDayDTO(breaks, null, ref dto);

                    dtos.Add(dto);
                }
            }

            dtos = ApplyExtendedAbsenceSettings(dateFrom, dateTo, dtos, extendedSettings);

            //GetAbsenceRequestAffectedShifts is called to get shifts with a certain shiftUserStatus, but ApplyExtendedAbsenceSettings needs all shifts per day so we need to make the exclusion here
            dtos = dtos.Where(b => b.ShiftUserStatus == shiftUserStatus).ToList();
            return dtos;
        }

        public void FillGapsWithZeroShifts(List<DateTime> dates, int employeeId, int? timeScheduleScenarioHeadId, List<TimeSchedulePlanningDayDTO> currentShifts)
        {
            foreach (var date in dates)
            {
                FillGapsWithZeroShifts(date, date, employeeId, timeScheduleScenarioHeadId, currentShifts);
            }
        }

        public void FillGapsWithZeroShifts(DateTime dateFrom, DateTime dateTo, int employeeId, int? timeScheduleScenarioHeadId, List<TimeSchedulePlanningDayDTO> currentShifts)
        {
            DateTime currentDate = dateFrom.Date;
            while (currentDate <= dateTo)
            {
                if (!currentShifts.Any(x => x.ActualDate == currentDate))
                {
                    currentShifts.Add(TimeSchedulePlanningDayDTO.CreateZeroShift(employeeId, currentDate, timeScheduleScenarioHeadId));
                }
                currentDate = currentDate.AddDays(1);
            }
        }

        public void SetHasMultipleEmployeeAccounts(CompEntities entities, int actorCompanyId, int employeeId, List<TimeSchedulePlanningDayDTO> dtos)
        {
            List<EmployeeAccount> employeeAccounts = EmployeeManager.GetHighestEmployeeAccounts(entities, actorCompanyId, employeeId);
            foreach (var item in dtos)
            {
                item.HasMultipleEmployeeAccountsOnDate = EmployeeManager.HasMultipelEmployeeAccounts(entities, actorCompanyId, employeeId, item.ActualDate, item.ActualDate, employeeAccounts);
            }
        }

        public void SetShiftIsLended(CompEntities entities, int actorCompanyId, int userId, List<TimeSchedulePlanningDayDTO> shifts)
        {
            bool doInactivateLending = SettingManager.GetBoolSetting(entities, SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningInactivateLending, 0, actorCompanyId, 0);
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
            if (!useAccountHierarchy || !shifts.Any() || doInactivateLending)
                return;

            List<AttestRoleUser> attestRolesForUsers = AttestManager.GetAttestRoleUsers(entities, actorCompanyId, userId, shifts.OrderBy(x => x.ActualDate).First().ActualDate, shifts.OrderBy(x => x.ActualDate).Last().ActualDate, includeAttestRole: true, ignoreDates: false, onlyDefaultAccounts: true);
            if (!attestRolesForUsers.Any(x => x.AttestRole.StaffingByEmployeeAccount))
            {
                int defaultDimId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.DefaultEmployeeAccountDimEmployee, 0, actorCompanyId, 0);
                var accounts = AccountManager.GetAccountsInternalsByCompany(entities, actorCompanyId).ToDTOs();
                var accountDims = AccountManager.GetAccountDimsByCompany(entities, actorCompanyId, onlyInternal: true, loadParentOrCalculateLevels: true).ToDTOs().ToList();
                AccountHierarchyInput input = AccountHierarchyInput.GetInstance(AccountHierarchyParamType.UseDefaultEmployeeAccountDimEmployee);
                input.AddParamValue(AccountHierarchyParamType.IncludeAbstract, true);
                List<AccountDTO> userSelectableAccountsByDefaultDimSetting = AccountManager.GetAccountsFromHierarchyByUser(entities, actorCompanyId, userId, shifts.OrderBy(x => x.ActualDate).First().ActualDate, shifts.OrderBy(x => x.ActualDate).Last().ActualDate, input, accounts, accountDims).Where(x => x.AccountDimId == defaultDimId).ToList();
                foreach (var shiftsByEmployee in shifts.GroupBy(x => x.EmployeeId))
                {
                    var employee = entities.Employee.FirstOrDefault(f => f.EmployeeId == shiftsByEmployee.Key);
                    bool isSelf = employee != null && employee.UserId == userId;
                    if (isSelf)
                        continue;

                    foreach (var shift in shiftsByEmployee)
                    {
                        if (!shift.AccountId.HasValue || shift.IsZeroShift())
                            continue; //dont set as lended

                        shift.IsLended = !userSelectableAccountsByDefaultDimSetting.Any(x => x.AccountId == shift.AccountId.Value);
                    }
                }
            }
        }


        #region ExtendedAbsenceSetting

        public List<TimeSchedulePlanningDayDTO> ApplyExtendedAbsenceSettings(CompEntities entities, DateTime intervalStart, DateTime intervalStop, List<TimeScheduleTemplateBlock> shifts, ExtendedAbsenceSetting extendedSettings, int actorCompanyId)
        {
            // Convert to DTO
            List<TimeSchedulePlanningDayDTO> dtos = new List<TimeSchedulePlanningDayDTO>();
            foreach (TimeScheduleTemplateBlock shift in shifts.OrderBy(b => b.EmployeeId).ThenBy(b => b.Date).ThenBy(b => b.StartTime))
            {
                if (shift.BreakType != (int)SoeTimeScheduleTemplateBlockBreakType.None)
                    continue;

                TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(entities, shift, actorCompanyId, 0);
                if (dto != null)
                {
                    List<TimeScheduleTemplateBlock> breaks = shifts.Where(b => b.TimeScheduleEmployeePeriodId == shift.TimeScheduleEmployeePeriodId && b.BreakType > (int)SoeTimeScheduleTemplateBlockBreakType.None).ToList();
                    AddBreaksToTimeSchedulePlanningDayDTO(breaks, null, ref dto);
                    dtos.Add(dto);
                }
            }

            dtos = ApplyExtendedAbsenceSettings(intervalStart, intervalStop, dtos, extendedSettings);

            return dtos;
        }

        public List<TimeSchedulePlanningDayDTO> ApplyExtendedAbsenceSettingsForLeaveRequestEndpoint(DateTime intervalStart, DateTime intervalStop, List<TimeSchedulePlanningDayDTO> shifts, ExtendedAbsenceSetting extendedAbsenceSetting)
        {
            return ApplyExtendedAbsenceSettings(intervalStart, intervalStop, shifts, extendedAbsenceSetting);
        }

        private List<TimeSchedulePlanningDayDTO> ApplyExtendedAbsenceSettings(DateTime intervalStart, DateTime intervalStop, List<TimeSchedulePlanningDayDTO> shifts, ExtendedAbsenceSetting extendedAbsenceSetting)
        {
            #region Prereq
            if (extendedAbsenceSetting == null || (!extendedAbsenceSetting.AbsenceFirstAndLastDay && !extendedAbsenceSetting.AdjustAbsencePerWeekDay && !extendedAbsenceSetting.PercentalAbsence))
            {
                foreach (var shift in shifts)
                {
                    shift.AbsenceStartTime = shift.StartTime;
                    shift.AbsenceStopTime = shift.StopTime;
                }
                return shifts;
            }
            #endregion

            ApplyMidnightFix(extendedAbsenceSetting);

            List<TimeSchedulePlanningDayDTO> affectedShifts = new List<TimeSchedulePlanningDayDTO>();

            #region Hanle zero days
            var zeroShifts = shifts.Where(x => x.StartTime == x.StopTime).ToList();
            foreach (var zeroShift in zeroShifts)
            {
                zeroShift.AbsenceStartTime = zeroShift.StartTime;
                zeroShift.AbsenceStopTime = zeroShift.StopTime;
            }

            affectedShifts.AddRange(zeroShifts);
            shifts = shifts.Where(x => x.StartTime != x.StopTime).ToList();
            #endregion

            if (!shifts.Any())
                return affectedShifts;

            shifts = shifts.OrderBy(x => x.StartTime).ToList();

            if (extendedAbsenceSetting.AbsenceFirstAndLastDay)
            {
                DateTime firstDate = intervalStart.Date;
                DateTime lastDate = intervalStop.Date;

                List<TimeSchedulePlanningDayDTO> shiftsFirstDay = null;
                List<TimeSchedulePlanningDayDTO> shiftsLastDay = null;

                //absence starts after midnight fix
                shiftsFirstDay = shifts.Where(x => x.StartTime.Date == firstDate || x.StopTime.Date == firstDate).ToList();
                foreach (var shift in shiftsFirstDay)
                {
                    var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                    shifts.Remove(removeShift);
                }

                shiftsLastDay = shifts.Where(x => x.StartTime.Date == lastDate || x.StopTime.Date == lastDate).ToList();
                foreach (var shift in shiftsLastDay)
                {
                    var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                    shifts.Remove(removeShift);
                }

                if (firstDate == lastDate)
                {
                    if (extendedAbsenceSetting.AbsenceWholeFirstDay || extendedAbsenceSetting.AbsenceWholeLastDay)
                    {
                        //Set absence on whole day
                        affectedShifts.AddRange(ApplyAbsenceOnShifts(shiftsFirstDay));
                    }
                    else if (extendedAbsenceSetting.AbsenceFirstDayStart.HasValue && extendedAbsenceSetting.AbsenceLastDayStart.HasValue)
                    {
                        DateTime absenceStartime = CalendarUtility.MergeDateAndTime(firstDate, extendedAbsenceSetting.AbsenceFirstDayStart.Value);
                        DateTime absenceStoptime = CalendarUtility.MergeDateAndTime(lastDate, extendedAbsenceSetting.AbsenceLastDayStart.Value);
                        if (absenceStoptime < absenceStartime)
                            absenceStoptime = absenceStoptime.AddDays(1);

                        affectedShifts.AddRange(ApplyAbsenceOnShifts(absenceStartime, absenceStoptime, shiftsFirstDay, absenceTimesAreActualDates: true));
                    }

                }
                else
                {
                    DateTime? absenceStartime = null;
                    DateTime? absenceStoptime = null;
                    List<TimeSchedulePlanningDayDTO> tempShifts = new List<TimeSchedulePlanningDayDTO>();

                    if (extendedAbsenceSetting.AbsenceWholeFirstDay)
                    {
                        //Set absence on whole days
                        absenceStartime = firstDate.Date;
                    }
                    else if (extendedAbsenceSetting.AbsenceFirstDayStart.HasValue)
                    {
                        //Set absence from specified time
                        absenceStartime = CalendarUtility.MergeDateAndTime(firstDate, extendedAbsenceSetting.AbsenceFirstDayStart.Value);
                    }

                    if (extendedAbsenceSetting.AbsenceWholeLastDay)
                    {
                        //Set absence on whole days
                        //lastDate = 2021-01-24 => 2021-01-25 00:00
                        absenceStoptime = lastDate.AddDays(1).Date;
                    }
                    else if (extendedAbsenceSetting.AbsenceLastDayStart.HasValue)
                    {
                        //Set absence to specified time
                        absenceStoptime = CalendarUtility.MergeDateAndTime(lastDate, extendedAbsenceSetting.AbsenceLastDayStart.Value);
                    }

                    tempShifts.AddRange(shiftsFirstDay);
                    tempShifts.AddRange(shiftsLastDay);

                    //if no more settings apply absence on whole day on remaining shifts
                    if (!extendedAbsenceSetting.PercentalAbsence && !extendedAbsenceSetting.AdjustAbsencePerWeekDay)
                        //Set absence on whole days                        
                        tempShifts.AddRange(shifts);


                    if (absenceStartime.HasValue && absenceStoptime.HasValue)
                    {
                        affectedShifts.AddRange(ApplyAbsenceOnShifts(absenceStartime.Value, absenceStoptime.Value, tempShifts, absenceTimesAreActualDates: true));
                    }
                }

            }

            if (extendedAbsenceSetting.PercentalAbsence)
            {
                if (extendedAbsenceSetting.PercentalValue.HasValue)
                {
                    List<IGrouping<DateTime, TimeSchedulePlanningDayDTO>> shiftsGroupedByDates = shifts.GroupBy(g => g.StartTime.Date).OrderBy(x => x.Key).ToList();

                    foreach (var shiftsGroupedByDate in shiftsGroupedByDates)
                    {
                        if (extendedAbsenceSetting.PercentalAbsenceOccursStartOfDay.HasValue && extendedAbsenceSetting.PercentalAbsenceOccursStartOfDay.Value)
                        {
                            var returnshifts = ApplyAbsenceOnStartOfDayFromPercentage(shiftsGroupedByDate.ToList(), extendedAbsenceSetting.PercentalValue.Value);
                            affectedShifts.AddRange(returnshifts);
                        }
                        else if (extendedAbsenceSetting.PercentalAbsenceOccursEndOfDay.HasValue && extendedAbsenceSetting.PercentalAbsenceOccursEndOfDay.Value)
                        {
                            var returnshifts = ApplyAbsenceOnEndOfDayFromPercentage(shiftsGroupedByDate.ToList(), extendedAbsenceSetting.PercentalValue.Value);
                            affectedShifts.AddRange(returnshifts);
                        }
                    }
                }
            }
            else if (extendedAbsenceSetting.AdjustAbsencePerWeekDay)
            {
                #region FIX: If no day has been adjusted return all shifts

                if (
                    //Mon
                    (extendedAbsenceSetting.AdjustAbsenceMonStart.HasValue && extendedAbsenceSetting.AdjustAbsenceMonStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceMonStop.Value == extendedAbsenceSetting.AdjustAbsenceMonStart.Value) &&

                    //Tue
                    (extendedAbsenceSetting.AdjustAbsenceTueStart.HasValue && extendedAbsenceSetting.AdjustAbsenceTueStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceTueStop.Value == extendedAbsenceSetting.AdjustAbsenceTueStart.Value) &&

                    //Wed
                    (extendedAbsenceSetting.AdjustAbsenceWedStart.HasValue && extendedAbsenceSetting.AdjustAbsenceWedStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceWedStop.Value == extendedAbsenceSetting.AdjustAbsenceWedStart.Value) &&

                    //Thu
                    (extendedAbsenceSetting.AdjustAbsenceThuStart.HasValue && extendedAbsenceSetting.AdjustAbsenceThuStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceThuStop.Value == extendedAbsenceSetting.AdjustAbsenceThuStart.Value) &&

                    //Fri
                    (extendedAbsenceSetting.AdjustAbsenceFriStart.HasValue && extendedAbsenceSetting.AdjustAbsenceFriStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceFriStop.Value == extendedAbsenceSetting.AdjustAbsenceFriStart.Value) &&

                    //Sat
                    (extendedAbsenceSetting.AdjustAbsenceSatStart.HasValue && extendedAbsenceSetting.AdjustAbsenceSatStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceSatStop.Value == extendedAbsenceSetting.AdjustAbsenceSatStart.Value) &&

                    //Sun
                    (extendedAbsenceSetting.AdjustAbsenceSunStart.HasValue && extendedAbsenceSetting.AdjustAbsenceSunStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceSunStop.Value == extendedAbsenceSetting.AdjustAbsenceSunStart.Value) &&

                    //All days
                    (extendedAbsenceSetting.AdjustAbsenceAllDaysStart.HasValue && extendedAbsenceSetting.AdjustAbsenceAllDaysStop.HasValue
                    && extendedAbsenceSetting.AdjustAbsenceAllDaysStop.Value == extendedAbsenceSetting.AdjustAbsenceAllDaysStart.Value)

                    )
                {
                    foreach (var shift in shifts)
                    {
                        shift.AbsenceStartTime = shift.StartTime;
                        shift.AbsenceStopTime = shift.StopTime;
                    }
                    affectedShifts.AddRange(shifts);
                }

                #endregion

                #region Absence mon

                if (extendedAbsenceSetting.AdjustAbsenceMonStart.HasValue && extendedAbsenceSetting.AdjustAbsenceMonStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceMonStop.Value != extendedAbsenceSetting.AdjustAbsenceMonStart.Value)
                {

                    var monShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Monday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceMonStart.Value, extendedAbsenceSetting.AdjustAbsenceMonStop.Value, monShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);

                }

                #endregion

                #region Absence Tue

                if (extendedAbsenceSetting.AdjustAbsenceTueStart.HasValue && extendedAbsenceSetting.AdjustAbsenceTueStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceTueStop.Value != extendedAbsenceSetting.AdjustAbsenceTueStart.Value)
                {

                    var tueShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Tuesday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceTueStart.Value, extendedAbsenceSetting.AdjustAbsenceTueStop.Value, tueShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);

                }

                #endregion

                #region Absence Wed

                if (extendedAbsenceSetting.AdjustAbsenceWedStart.HasValue && extendedAbsenceSetting.AdjustAbsenceWedStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceWedStop.Value != extendedAbsenceSetting.AdjustAbsenceWedStart.Value)
                {

                    var wedShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Wednesday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceWedStart.Value, extendedAbsenceSetting.AdjustAbsenceWedStop.Value, wedShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);

                }

                #endregion

                #region Absence Thu

                if (extendedAbsenceSetting.AdjustAbsenceThuStart.HasValue && extendedAbsenceSetting.AdjustAbsenceThuStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceThuStop.Value != extendedAbsenceSetting.AdjustAbsenceThuStart.Value)
                {

                    var thuShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Thursday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceThuStart.Value, extendedAbsenceSetting.AdjustAbsenceThuStop.Value, thuShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);

                }

                #endregion

                #region Absence Fri

                if (extendedAbsenceSetting.AdjustAbsenceFriStart.HasValue && extendedAbsenceSetting.AdjustAbsenceFriStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceFriStop.Value != extendedAbsenceSetting.AdjustAbsenceFriStart.Value)
                {


                    var friShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Friday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceFriStart.Value, extendedAbsenceSetting.AdjustAbsenceFriStop.Value, friShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);
                }

                #endregion

                #region Absence Sat

                if (extendedAbsenceSetting.AdjustAbsenceSatStart.HasValue && extendedAbsenceSetting.AdjustAbsenceSatStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceSatStop.Value != extendedAbsenceSetting.AdjustAbsenceSatStart.Value)
                {

                    var satShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Saturday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceSatStart.Value, extendedAbsenceSetting.AdjustAbsenceSatStop.Value, satShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);

                }

                #endregion

                #region Absence Sun

                if (extendedAbsenceSetting.AdjustAbsenceSunStart.HasValue && extendedAbsenceSetting.AdjustAbsenceSunStop.HasValue
                     && extendedAbsenceSetting.AdjustAbsenceSunStop.Value != extendedAbsenceSetting.AdjustAbsenceSunStart.Value)
                {

                    var sunShifts = shifts.Where(x => x.StartTime.Date.DayOfWeek == DayOfWeek.Sunday).ToList();
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceSunStart.Value, extendedAbsenceSetting.AdjustAbsenceSunStop.Value, sunShifts);
                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);
                }

                #endregion

                #region Absence all days start/and stop

                if (extendedAbsenceSetting.AdjustAbsenceAllDaysStart.HasValue && extendedAbsenceSetting.AdjustAbsenceAllDaysStop.HasValue
                    && extendedAbsenceSetting.AdjustAbsenceAllDaysStop.Value != extendedAbsenceSetting.AdjustAbsenceAllDaysStart.Value)
                {
                    var returnshifts = ApplyAbsenceOnShifts(extendedAbsenceSetting.AdjustAbsenceAllDaysStart.Value, extendedAbsenceSetting.AdjustAbsenceAllDaysStop.Value, shifts);

                    foreach (var shift in returnshifts)
                    {
                        var removeShift = shifts.FirstOrDefault(x => x.TimeScheduleTemplateBlockId == shift.TimeScheduleTemplateBlockId);
                        if (removeShift != null)
                            shifts.Remove(removeShift);
                    }
                    affectedShifts.AddRange(returnshifts);

                }

                #endregion

            }

            return affectedShifts.OrderBy(x => x.StartTime).ToList();
        }

        private void ApplyMidnightFix(ExtendedAbsenceSetting extendedAbsenceSetting)
        {
            #region AbsenceFirstAndLastDay

            if (extendedAbsenceSetting.AbsenceFirstDayStart.HasValue && extendedAbsenceSetting.AbsenceLastDayStart.HasValue && extendedAbsenceSetting.AbsenceLastDayStart.Value < extendedAbsenceSetting.AbsenceFirstDayStart.Value)
                extendedAbsenceSetting.AbsenceLastDayStart = extendedAbsenceSetting.AbsenceLastDayStart.Value.AddDays(1);

            #endregion

            #region AdjustAbsencePerWeekDay

            if (extendedAbsenceSetting.AdjustAbsenceAllDaysStart.HasValue && extendedAbsenceSetting.AdjustAbsenceAllDaysStop.HasValue && extendedAbsenceSetting.AdjustAbsenceAllDaysStop.Value < extendedAbsenceSetting.AdjustAbsenceAllDaysStart.Value)
                extendedAbsenceSetting.AdjustAbsenceAllDaysStop = extendedAbsenceSetting.AdjustAbsenceAllDaysStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceMonStart.HasValue && extendedAbsenceSetting.AdjustAbsenceMonStop.HasValue && extendedAbsenceSetting.AdjustAbsenceMonStop.Value < extendedAbsenceSetting.AdjustAbsenceMonStart.Value)
                extendedAbsenceSetting.AdjustAbsenceMonStop = extendedAbsenceSetting.AdjustAbsenceMonStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceTueStart.HasValue && extendedAbsenceSetting.AdjustAbsenceTueStop.HasValue && extendedAbsenceSetting.AdjustAbsenceTueStop.Value < extendedAbsenceSetting.AdjustAbsenceTueStart.Value)
                extendedAbsenceSetting.AdjustAbsenceTueStop = extendedAbsenceSetting.AdjustAbsenceTueStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceWedStart.HasValue && extendedAbsenceSetting.AdjustAbsenceWedStop.HasValue && extendedAbsenceSetting.AdjustAbsenceWedStop.Value < extendedAbsenceSetting.AdjustAbsenceWedStart.Value)
                extendedAbsenceSetting.AdjustAbsenceWedStop = extendedAbsenceSetting.AdjustAbsenceWedStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceThuStart.HasValue && extendedAbsenceSetting.AdjustAbsenceThuStop.HasValue && extendedAbsenceSetting.AdjustAbsenceThuStop.Value < extendedAbsenceSetting.AdjustAbsenceThuStart.Value)
                extendedAbsenceSetting.AdjustAbsenceThuStop = extendedAbsenceSetting.AdjustAbsenceThuStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceFriStart.HasValue && extendedAbsenceSetting.AdjustAbsenceFriStop.HasValue && extendedAbsenceSetting.AdjustAbsenceFriStop.Value < extendedAbsenceSetting.AdjustAbsenceFriStart.Value)
                extendedAbsenceSetting.AdjustAbsenceFriStop = extendedAbsenceSetting.AdjustAbsenceFriStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceSatStart.HasValue && extendedAbsenceSetting.AdjustAbsenceSatStop.HasValue && extendedAbsenceSetting.AdjustAbsenceSatStop.Value < extendedAbsenceSetting.AdjustAbsenceSatStart.Value)
                extendedAbsenceSetting.AdjustAbsenceSatStop = extendedAbsenceSetting.AdjustAbsenceSatStop.Value.AddDays(1);

            if (extendedAbsenceSetting.AdjustAbsenceSunStart.HasValue && extendedAbsenceSetting.AdjustAbsenceSunStop.HasValue && extendedAbsenceSetting.AdjustAbsenceSunStop.Value < extendedAbsenceSetting.AdjustAbsenceSunStart.Value)
                extendedAbsenceSetting.AdjustAbsenceSunStop = extendedAbsenceSetting.AdjustAbsenceSunStop.Value.AddDays(1);

            #endregion
        }

        private List<TimeSchedulePlanningDayDTO> ApplyAbsenceOnStartOfDayFromPercentage(List<TimeSchedulePlanningDayDTO> shifts, decimal absenceInPercentage)
        {
            List<TimeSchedulePlanningDayDTO> affectedShifts = new List<TimeSchedulePlanningDayDTO>();

            int actualWorkMinutes = 0;
            int actualWorkMinutesCoveredByAbsence = 0;
            var onDutyShifts = shifts.Where(x => x.IsOnDuty()).ToList();
            shifts = shifts.Where(x => !x.IsOnDuty()).ToList();

            foreach (var shift in shifts)
            {
                actualWorkMinutes += (int)(shift.StopTime - shift.StartTime).TotalMinutes;
                actualWorkMinutes -= shift.GetBreakTimeWithinShift(shift.StartTime, shift.StopTime);
            }

            actualWorkMinutesCoveredByAbsence = (int)Math.Ceiling(Convert.ToDouble(actualWorkMinutes * absenceInPercentage / 100));

            shifts = shifts.OrderBy(x => x.StartTime).ToList();
            var firstShift = shifts.FirstOrDefault();

            List<int> alreadyUsedBreaks = new List<int>();
            while (true)
            {
                int breakMinutesCoveredByAbsence = firstShift.GetBreaksTotalMinutesThatStartInInterval(firstShift.StartTime, firstShift.StartTime.AddMinutes(actualWorkMinutesCoveredByAbsence), ref alreadyUsedBreaks);
                if (breakMinutesCoveredByAbsence == 0)
                    break;
                actualWorkMinutesCoveredByAbsence += breakMinutesCoveredByAbsence; // increase absence, now we need to check GetBreaksTotalMinutesThatStartInInterval again with new stoptime
            }

            DateTime? lastStopTime = null;

            foreach (var shift in shifts)
            {
                shift.AbsenceStartTime = shift.StartTime;
                if ((shift.StopTime - shift.StartTime).TotalMinutes > actualWorkMinutesCoveredByAbsence)
                {
                    //not whole shift is covered by absence

                    //add what is left of totalWorkMinutesAfterAbsence
                    shift.AbsenceStopTime = shift.StartTime.AddMinutes(actualWorkMinutesCoveredByAbsence);
                    affectedShifts.Add(shift);
                    lastStopTime = shift.AbsenceStopTime;
                    break;
                }
                else
                {
                    //the whole shift is covered by absence
                    shift.AbsenceStopTime = shift.StopTime;
                    affectedShifts.Add(shift);
                    actualWorkMinutesCoveredByAbsence -= (int)(shift.StopTime - shift.StartTime).TotalMinutes;
                    lastStopTime = shift.AbsenceStopTime;
                }

                if (actualWorkMinutesCoveredByAbsence == 0)
                    break;
            }

            if (lastStopTime.HasValue)
            {
                foreach (var shift in onDutyShifts.Where(x => x.StopTime <= lastStopTime.Value || (x.StartTime <= lastStopTime.Value && x.StopTime >= lastStopTime.Value)).OrderBy(x => x.StartTime).ToList())
                {
                    if (shift.StopTime > lastStopTime.Value)
                    {
                        //not whole shift is covered by absence

                        shift.AbsenceStartTime = shift.StartTime;
                        shift.AbsenceStopTime = lastStopTime.Value;
                        affectedShifts.Add(shift);
                        break;
                    }
                    else
                    {
                        //the whole shift is covered by absence
                        shift.AbsenceStartTime = shift.StartTime;
                        shift.AbsenceStopTime = shift.StopTime;
                        affectedShifts.Add(shift);
                    }
                }
            }

            return affectedShifts;
        }

        private List<TimeSchedulePlanningDayDTO> ApplyAbsenceOnEndOfDayFromPercentage(List<TimeSchedulePlanningDayDTO> shifts, decimal absenceInPercentage)
        {
            List<TimeSchedulePlanningDayDTO> affectedShifts = new List<TimeSchedulePlanningDayDTO>();
            var onDutyShifts = shifts.Where(x => x.IsOnDuty()).ToList();
            shifts = shifts.Where(x => !x.IsOnDuty()).ToList();

            int actualWorkMinutes = 0;
            int actualWorkMinutesCoveredByAbsence = 0;

            foreach (var shift in shifts)
            {
                actualWorkMinutes += (int)(shift.StopTime - shift.StartTime).TotalMinutes;
                actualWorkMinutes -= shift.GetBreakTimeWithinShift(shift.StartTime, shift.StopTime);
            }

            actualWorkMinutesCoveredByAbsence = (int)Math.Floor(Convert.ToDouble(actualWorkMinutes * absenceInPercentage / 100));

            shifts = shifts.OrderByDescending(x => x.StopTime).ToList();
            var firstShift = shifts.FirstOrDefault();

            List<int> alreadyUsedBreaks = new List<int>();
            while (true)
            {
                int breakMinutesCoveredByAbsence = firstShift.GetBreaksTotalMinutesThatEndInInterval(firstShift.StopTime.AddMinutes(-actualWorkMinutesCoveredByAbsence), firstShift.StopTime, ref alreadyUsedBreaks);
                if (breakMinutesCoveredByAbsence == 0)
                    break;
                actualWorkMinutesCoveredByAbsence += breakMinutesCoveredByAbsence; // increase absence, now we need to check GetBreaksTotalMinutesThatStartInInterval again with new starttime
            }

            DateTime? earliestStartTime = null;

            foreach (var shift in shifts)
            {
                shift.AbsenceStopTime = shift.StopTime;
                if ((shift.StopTime - shift.StartTime).TotalMinutes > actualWorkMinutesCoveredByAbsence)
                {
                    //not whole shift is covered by absence

                    //subtract what is left of totalWorkMinutesAfterAbsence
                    shift.AbsenceStartTime = shift.StopTime.AddMinutes(-actualWorkMinutesCoveredByAbsence);
                    affectedShifts.Add(shift);
                    earliestStartTime = shift.AbsenceStartTime;
                    break;
                }
                else
                {
                    //the whole shift is covered by absence
                    shift.AbsenceStartTime = shift.StartTime;
                    affectedShifts.Add(shift);
                    actualWorkMinutesCoveredByAbsence -= (int)(shift.StopTime - shift.StartTime).TotalMinutes;
                    earliestStartTime = shift.AbsenceStartTime;
                }

                if (actualWorkMinutesCoveredByAbsence == 0)
                    break;
            }

            if (earliestStartTime.HasValue)
            {
                foreach (var shift in onDutyShifts.Where(x => x.StartTime >= earliestStartTime.Value || (x.StartTime <= earliestStartTime.Value && x.StopTime >= earliestStartTime.Value)).OrderByDescending(x => x.StopTime).ToList())
                {
                    if (shift.StartTime > earliestStartTime.Value)
                    {
                        //the whole shift is covered by absence
                        shift.AbsenceStartTime = shift.StartTime;
                        shift.AbsenceStopTime = shift.StopTime;
                        affectedShifts.Add(shift);

                    }
                    else
                    {
                        //not whole shift is covered by absence
                        shift.AbsenceStartTime = earliestStartTime.Value;
                        shift.AbsenceStopTime = shift.StopTime;
                        affectedShifts.Add(shift);
                        break;

                    }
                }
            }

            return affectedShifts;
        }

        private List<TimeSchedulePlanningDayDTO> ApplyAbsenceOnShifts(DateTime absenceStartTime, DateTime absenceStopTime, List<TimeSchedulePlanningDayDTO> shifts, bool absenceTimesAreActualDates = false)
        {
            List<TimeSchedulePlanningDayDTO> affectedShifts = new List<TimeSchedulePlanningDayDTO>();
            apply();

            if (!absenceTimesAreActualDates && absenceStartTime.Date == absenceStopTime.Date && shifts.Any(s => s.IsOverMidnight() || s.BelongsToNextDay))
            {
                absenceStartTime = absenceStartTime.AddDays(1);
                absenceStopTime = absenceStopTime.AddDays(1);
                apply();
            }

            void apply()
            {
                foreach (var shift in shifts)
                {
                    DateTime shiftScheduleStartime = absenceTimesAreActualDates ? shift.StartTime : CalendarUtility.GetScheduleTime(shift.StartTime);
                    DateTime shiftScheduleStoptime = absenceTimesAreActualDates ? shift.StopTime : CalendarUtility.GetScheduleTime(shift.StopTime, shift.StartTime.Date, shift.StopTime.Date);

                    if (CalendarUtility.IsNewStartInCurrent(absenceStartTime, absenceStopTime, shiftScheduleStartime, shiftScheduleStoptime))
                    {
                        shift.AbsenceStartTime = absenceTimesAreActualDates ? absenceStartTime : CalendarUtility.MergeDateAndTime(shift.StartTime.AddDays((absenceStartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), absenceStartTime);
                        shift.AbsenceStopTime = shift.StopTime;
                        affectedShifts.Add(shift);
                        continue;
                    }

                    if (CalendarUtility.IsNewStopInCurrent(absenceStartTime, absenceStopTime, shiftScheduleStartime, shiftScheduleStoptime))
                    {
                        shift.AbsenceStartTime = shift.StartTime;
                        shift.AbsenceStopTime = shift.AbsenceStartTime.AddMinutes((absenceStopTime - shiftScheduleStartime).TotalMinutes);
                        affectedShifts.Add(shift);
                        continue;
                    }

                    if (CalendarUtility.IsNewOverlappedByCurrent(absenceStartTime, absenceStopTime, shiftScheduleStartime, shiftScheduleStoptime))
                    {
                        shift.AbsenceStartTime = absenceTimesAreActualDates ? absenceStartTime : CalendarUtility.MergeDateAndTime(shift.StartTime.AddDays((absenceStartTime.Date - CalendarUtility.DATETIME_DEFAULT.Date).Days), absenceStartTime);
                        shift.AbsenceStopTime = shift.AbsenceStartTime.AddMinutes((absenceStopTime - absenceStartTime).TotalMinutes);
                        affectedShifts.Add(shift);
                        continue;
                    }

                    if (CalendarUtility.IsCurrentOverlappedByNew(absenceStartTime, absenceStopTime, shiftScheduleStartime, shiftScheduleStoptime))
                    {
                        shift.AbsenceStartTime = shift.StartTime;
                        shift.AbsenceStopTime = shift.StopTime;
                        affectedShifts.Add(shift);
                        continue;
                    }

                }
            }
            return affectedShifts;
        }

        private List<TimeSchedulePlanningDayDTO> ApplyAbsenceOnShifts(List<TimeSchedulePlanningDayDTO> shifts)
        {
            List<TimeSchedulePlanningDayDTO> returnShifts = new List<TimeSchedulePlanningDayDTO>();

            //Set absence on whole shift
            foreach (var shift in shifts)
            {
                shift.AbsenceStartTime = shift.StartTime;
                shift.AbsenceStopTime = shift.StopTime;

                returnShifts.Add(shift);
            }
            return returnShifts;
        }

        #endregion

        #endregion

        #region Work rules

        public List<WorkRuleBypassLogDTO> GetWorkRulebypassLog(int actorCompanyId, int userId, int roleId, TermGroup_ChangeStatusGridAllItemsSelection? allItemsSelection, bool setActionText, int? workRuleBypassLogId = null)
        {
            DateTime? selectionDate = null;
            if (allItemsSelection.HasValue)
            {
                switch (allItemsSelection)
                {
                    case TermGroup_ChangeStatusGridAllItemsSelection.One_Month:
                        selectionDate = DateTime.Today.AddMonths(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Tree_Months:
                        selectionDate = DateTime.Today.AddMonths(-3);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Six_Months:
                        selectionDate = DateTime.Today.AddMonths(-6);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.Twelve_Months:
                        selectionDate = DateTime.Today.AddYears(-1);
                        break;
                    case TermGroup_ChangeStatusGridAllItemsSelection.TwentyFour_Months:
                        selectionDate = DateTime.Today.AddYears(-2);
                        break;
                }
            }
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            IQueryable<WorkRuleBypassLog> query = (from b in entitiesReadOnly.WorkRuleBypassLog
                                                   where b.ActorCompanyId == actorCompanyId &&
                                                   b.State == (int)SoeEntityState.Active
                                                   select b);

            if (workRuleBypassLogId.HasValue)
                query = query.Where(i => i.WorkRuleBypassLogId == workRuleBypassLogId.Value);

            if (selectionDate.HasValue)
                query = query.Where(i => i.Date >= selectionDate.Value);

            List<WorkRuleBypassLog> logs = query.ToList();
            if (!logs.Any())
                return new List<WorkRuleBypassLogDTO>();

            List<Employee> employees = EmployeeManager.GetEmployeesForUsersAttestRoles(out _, actorCompanyId, userId, roleId, getHidden: true);
            if (!employees.Any())
                return new List<WorkRuleBypassLogDTO>();

            List<int> employeeIds = employees.Select(e => e.EmployeeId).ToList();
            logs = logs.Where(i => employeeIds.Contains(i.EmployeeId)).ToList();
            if (!logs.Any())
                return new List<WorkRuleBypassLogDTO>();

            if (setActionText)
            {
                List<GenericType> actions = base.GetTermGroupContent(TermGroup.ShiftHistoryType);
                logs.ForEach(l => l.ActionText = actions.FirstOrDefault(a => a.Id == l.Action)?.Name ?? string.Empty);
            }

            var dtos = new List<WorkRuleBypassLogDTO>();
            foreach (var logsByEmployee in logs.GroupBy(e => e.EmployeeId))
            {
                Employee employee = employees.FirstOrDefault(e => e.EmployeeId == logsByEmployee.Key);
                foreach (var e in logsByEmployee)
                {
                    dtos.Add(new WorkRuleBypassLogDTO
                    {
                        WorkRuleBypassLogId = e.WorkRuleBypassLogId,
                        ActorCompanyId = e.ActorCompanyId,
                        UserId = e.UserId,
                        EmployeeId = e.EmployeeId,
                        EmployeeName = employee?.Name ?? string.Empty,
                        EmployeeNrAndName = employee?.NumberAndName ?? string.Empty,
                        WorkRule = (SoeScheduleWorkRules)e.WorkRule,
                        Action = (TermGroup_ShiftHistoryType)e.Action,
                        Date = e.Date,
                        Message = employee != null && !employee.Name.IsNullOrEmpty() ? e.Message.Replace("[EmployeeName]", employee.Name) : e.Message,
                        ActionText = e.ActionText,
                        Created = e.Created,
                        CreatedBy = e.CreatedBy,
                        Modified = e.Modified,
                        ModifiedBy = e.ModifiedBy,
                        State = (SoeEntityState)e.State,
                    });
                }
            }

            return dtos.OrderByDescending(x => x.Date).ToList();
        }

        public IEnumerable<TimeScheduleTemplateBlock> GetShiftsAffectedByIntervall(int? timeScheduleScenarioHeadId, int actorCompanyId, int employeeId, DateTime startTime, DateTime stopTime, bool includeZeroDays, bool includeAlreadyAbsence, int? timeDeviationCauseId = null)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return GetShiftsAffectedByIntervall(entities, actorCompanyId, employeeId, timeScheduleScenarioHeadId, startTime, stopTime, false, includeZeroDays, includeAlreadyAbsence, out _, out _, timeDeviationCauseId: timeDeviationCauseId);
        }

        public List<DateTime> AdjustDatesAccordingToAttachedDays(CompEntities entities, int? timeScheduleScenarioHeadId, int timeDeviationCauseId, int actorCompanyId, int employeeId, List<DateTime> dates)
        {
            List<DateTime> dateTimes = dates;

            if (!dates.Any())
                return dates;

            if (timeDeviationCauseId != 0)
            {
                var deviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(entities, timeDeviationCauseId, actorCompanyId, false);

                if (deviationCause != null && deviationCause.HasAttachZeroDaysNbrOfDaySetting)
                {
                    List<DateTime> zeroDates = new List<DateTime>();
                    dates = dates.OrderBy(o => o).ToList();
                    var currentDate = dates.First();
                    var lastDate = dates.Last();

                    var scheduleBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                          where (timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue) &&
                                          (tb.EmployeeId == employeeId &&
                                          tb.Employee.ActorCompanyId == actorCompanyId) &&
                                          tb.TimeScheduleEmployeePeriod != null &&
                                          (tb.Date.HasValue && tb.Date.Value >= currentDate && tb.Date.Value <= lastDate) &&
                                          tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                          tb.State == (int)SoeEntityState.Active
                                          select tb).OrderBy(o => o.Date).ToList();

                    while (currentDate <= lastDate)
                    {
                        if (scheduleBlocks.Any(a => a.Date == currentDate && a.IsZero))
                            zeroDates.Add(currentDate);

                        if (dates.Any(a => a == currentDate))
                        {
                            var adjustedStartTime = currentDate;
                            var adjustedStopTime = currentDate;
                            AdjustDatesAccordingToAttachedDays(entities, timeDeviationCauseId, actorCompanyId, employeeId, timeScheduleScenarioHeadId, ref adjustedStartTime, ref adjustedStopTime);
                            dateTimes.AddRange(CalendarUtility.GetDatesInInterval(adjustedStartTime, adjustedStopTime));
                        }

                        currentDate = currentDate.AddDays(1);
                    }

                    if (zeroDates.Any())
                    {
                        dateTimes = dateTimes.Distinct().OrderBy(o => o).ToList();
                        currentDate = dates.First();

                        while (currentDate <= lastDate)
                        {
                            if (dateTimes.Any(a => a > currentDate) && zeroDates.Any(a => a == currentDate) && (zeroDates.Any(a => a == currentDate.AddDays(1)) || dateTimes.Any(a => a == currentDate.AddDays(1))))
                            {
                                DateTime prevPlannedScheduleDay = dateTimes.LastOrDefault(f => f < currentDate);
                                DateTime nextPlannedScheduleDay = dateTimes.FirstOrDefault(f => f > currentDate);
                                int zeroDaysInGap = zeroDates.Count(c => c > prevPlannedScheduleDay && c < nextPlannedScheduleDay);

                                if (zeroDaysInGap == 1 || zeroDaysInGap == Convert.ToInt32((nextPlannedScheduleDay - prevPlannedScheduleDay).TotalDays) - 1)
                                    dateTimes.Add(currentDate);
                            }

                            currentDate = currentDate.AddDays(1);
                        }
                    }
                }
            }

            return dateTimes.Distinct().ToList();
        }

        private void AdjustDatesAccordingToAttachedDays(CompEntities entities, int timeDeviationCauseId, int actorCompanyId, int employeeId, int? timeScheduleScenarioHeadId, ref DateTime startTime, ref DateTime stopTime, bool includeZeroDays = false)
        {
            DateTime adjustedStartTime = startTime;
            DateTime adjustedStopTime = stopTime;

            if (timeDeviationCauseId != 0)
            {
                var deviationCause = TimeDeviationCauseManager.GetTimeDeviationCause(entities, timeDeviationCauseId, actorCompanyId, false);

                if (deviationCause != null && deviationCause.HasAttachZeroDaysNbrOfDaySetting)
                {
                    int addDaysInBeginning = deviationCause.AttachZeroDaysNbrOfDaysBefore;
                    int addDaysInEnd = deviationCause.AttachZeroDaysNbrOfDaysAfter;

                    var start = startTime.Date.AddDays(-addDaysInBeginning);
                    var end = stopTime.Date.AddDays(addDaysInEnd);

                    var scheduleBlocks = (from tb in entities.TimeScheduleTemplateBlock
                                          where (timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue) &&
                                          (tb.EmployeeId == employeeId &&
                                          tb.Employee.ActorCompanyId == actorCompanyId) &&
                                          tb.TimeScheduleEmployeePeriod != null &&
                                          (tb.Date.HasValue && tb.Date.Value >= start && tb.Date.Value <= end) &&
                                          tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                                          tb.State == (int)SoeEntityState.Active
                                          select tb).OrderBy(o => o.Date).ToList();

                    var scheduleBlocksWithTimeDeviationCode = scheduleBlocks.Where(w => w.TimeDeviationCauseId.HasValue && w.TimeDeviationCauseId == timeDeviationCauseId);

                    var timeBlocks = (from b in entities.TimeBlock
                                      .Include("TimeBlockDate")
                                      where (b.EmployeeId == employeeId &&
                                      b.Employee.ActorCompanyId == actorCompanyId) &&
                                     (b.TimeBlockDate.Date >= start && b.TimeBlockDate.Date <= end) &&
                                     (b.TimeDeviationCauseStartId == timeDeviationCauseId || b.TimeDeviationCauseStopId == timeDeviationCauseId) &&
                                     b.State == (int)SoeEntityState.Active
                                      select b).OrderBy(o => o.TimeBlockDate.Date).ToList();

                    DateTime startDateAccordingToScheduleBlocks = scheduleBlocksWithTimeDeviationCode.LastOrDefault(f => f.Date < adjustedStartTime) != null ? scheduleBlocksWithTimeDeviationCode.Last(f => f.Date < adjustedStartTime).Date.Value.AddDays(1) : startTime;
                    DateTime stopDateAccordingToScheduleBlocks = scheduleBlocksWithTimeDeviationCode.FirstOrDefault(f => f.Date > adjustedStopTime) != null ? scheduleBlocksWithTimeDeviationCode.First(f => f.Date > adjustedStopTime).Date.Value.AddDays(-1) : stopTime;
                    DateTime startDateAccordingToTimeBlocks = timeBlocks.LastOrDefault(f => f.TimeBlockDate.Date < adjustedStartTime) != null ? timeBlocks.Last(f => f.TimeBlockDate.Date < adjustedStartTime).TimeBlockDate.Date.AddDays(1) : startTime;
                    DateTime stopDateAccordingToTimeBlocks = timeBlocks.FirstOrDefault(f => f.TimeBlockDate.Date > adjustedStopTime) != null ? timeBlocks.First(f => f.TimeBlockDate.Date > adjustedStopTime).TimeBlockDate.Date.AddDays(-1) : stopTime;

                    if (scheduleBlocks.Any(a => !a.IsZero && a.Date >= startDateAccordingToScheduleBlocks && a.Date < adjustedStartTime.Date))
                        startDateAccordingToScheduleBlocks = startTime;

                    if (scheduleBlocks.Any(a => !a.IsZero && a.Date <= stopDateAccordingToScheduleBlocks && a.Date > adjustedStopTime.Date))
                        stopDateAccordingToScheduleBlocks = stopTime;

                    DateTime currentDate = adjustedStartTime.Date.AddDays(-1);

                    if (startDateAccordingToScheduleBlocks < adjustedStartTime.Date || startDateAccordingToTimeBlocks < adjustedStartTime.Date || stopDateAccordingToScheduleBlocks > adjustedStopTime.Date || stopDateAccordingToTimeBlocks > adjustedStopTime.Date)
                    {
                        if (startDateAccordingToScheduleBlocks < adjustedStartTime.Date || startDateAccordingToTimeBlocks < adjustedStartTime.Date)
                        {
                            while (currentDate > adjustedStartTime.AddDays(-addDaysInBeginning))
                            {
                                if ((scheduleBlocks.Any(a => a.IsZero && a.Date.HasValue && a.Date == currentDate) || (includeZeroDays && timeScheduleScenarioHeadId.HasValue))
                                    && startDateAccordingToScheduleBlocks <= currentDate &&
                                    !timeBlocks.Any(a => a.TimeBlockDate.Date == currentDate))
                                {
                                    adjustedStartTime = currentDate;
                                }
                                else if (scheduleBlocks.Any(a => a.IsZero && a.Date.HasValue && a.Date == currentDate) && startDateAccordingToTimeBlocks <= currentDate)
                                {
                                    if (!timeBlocks.Any(a => a.TimeBlockDate.Date == currentDate.AddDays(-1)) && timeBlocks.Any(a => a.TimeBlockDate.Date <= currentDate.AddDays(-1)))
                                    {
                                        currentDate = currentDate.AddDays(-1);
                                        continue;
                                    }

                                    var lastBlockOnDay = timeBlocks.Where(a => a.TimeBlockDate.Date == currentDate.AddDays(-1)).OrderBy(o => o.StopTime).Last();
                                    var lastScheduleBlockOnday = scheduleBlocks.Where(a => a.Date == currentDate.AddDays(-1)).OrderBy(o => o.StopTime).LastOrDefault();
                                    if (lastScheduleBlockOnday != null && lastBlockOnDay.StopTime == lastScheduleBlockOnday.StopTime)
                                        adjustedStartTime = currentDate;
                                    else
                                        break;

                                }
                                else
                                    break;
                                currentDate = currentDate.AddDays(-1);
                            }
                        }

                        if (stopDateAccordingToScheduleBlocks > adjustedStopTime.Date || stopDateAccordingToTimeBlocks > adjustedStopTime.Date)
                        {
                            currentDate = adjustedStopTime.Date.AddDays(1);

                            while (currentDate < adjustedStopTime.Date.AddDays(addDaysInEnd))
                            {
                                if (scheduleBlocks.Any(a => a.IsZero && a.Date.HasValue && a.Date == currentDate) && stopDateAccordingToScheduleBlocks.Date >= currentDate &&
                                    !timeBlocks.Any(a => a.TimeBlockDate.Date == currentDate))
                                {
                                    adjustedStopTime = currentDate;
                                }
                                else if (scheduleBlocks.Any(a => a.IsZero && a.Date.HasValue && a.Date == currentDate) && stopDateAccordingToTimeBlocks.Date >= currentDate)
                                {
                                    if (!timeBlocks.Any(a => a.TimeBlockDate.Date == currentDate.AddDays(1)) && timeBlocks.Any(a => a.TimeBlockDate.Date <= currentDate.AddDays(1)))
                                    {
                                        currentDate = currentDate.AddDays(1);
                                        continue;
                                    }

                                    var firstBlockOnDay = timeBlocks.Where(a => a.TimeBlockDate.Date == currentDate.AddDays(1)).OrderBy(o => o.StopTime).FirstOrDefault();
                                    var firstScheduleBlockOnday = scheduleBlocks.Where(a => a.Date == currentDate.AddDays(1)).OrderBy(o => o.StopTime).FirstOrDefault();
                                    if (firstScheduleBlockOnday != null && firstBlockOnDay != null && firstBlockOnDay.StartTime == firstScheduleBlockOnday.StartTime)
                                        adjustedStopTime = currentDate;
                                }
                                else
                                    break;
                                currentDate = currentDate.AddDays(1);
                            }
                        }
                    }
                }
            }

            startTime = adjustedStartTime;
            stopTime = adjustedStopTime;
        }

        public IEnumerable<TimeScheduleTemplateBlock> GetShiftsAffectedByIntervall(CompEntities entities, int actorCompanyId, int employeeId, int? timeScheduleScenarioHeadId, DateTime startTime, DateTime stopTime, bool includeBreaks, bool includeZeroDays, bool includeAlreadyAbsence, out DateTime outFetchStartTime, out DateTime outFetchStopTime, int? timeDeviationCauseId = null, bool includeMidnightShifts = false)
        {
            List<TimeScheduleTemplateBlock> affectedShifts = new List<TimeScheduleTemplateBlock>();
            IEnumerable<TimeScheduleTemplateBlock> result = null;

            DateTime adjustedStartTime = startTime;
            DateTime adjustedStopTime = stopTime;

            if (timeDeviationCauseId.HasValue)
                AdjustDatesAccordingToAttachedDays(entities, timeDeviationCauseId.Value, actorCompanyId, employeeId, timeScheduleScenarioHeadId, ref adjustedStartTime, ref adjustedStopTime, includeZeroDays);

            DateTime fetchStartTime = adjustedStartTime;
            DateTime fetchStopTime = adjustedStopTime;
            if (includeMidnightShifts)
            {
                fetchStartTime = fetchStartTime.AddDays(-1);
                fetchStopTime = fetchStopTime.AddDays(1);
            }
            outFetchStartTime = adjustedStartTime;
            outFetchStopTime = adjustedStopTime;

            if (includeBreaks)
            {
                result = (from tb in entities.TimeScheduleTemplateBlock
                            .Include("ShiftType")
                            .Include("TimeDeviationCause")
                            .Include("Employee.ContactPerson")
                            .Include("Account")
                          where (timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue) &&
                          (tb.EmployeeId == employeeId &&
                          tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                          //tb.TimeScheduleEmployeePeriod != null &&
                          (tb.Date.HasValue && tb.Date.Value >= fetchStartTime.Date && tb.Date.Value <= fetchStopTime.Date) && //Date (startdate) should be in intervall                                                                                                                                                                                                                                                                                                                              
                          tb.State == (int)SoeEntityState.Active &&
                          (includeAlreadyAbsence || !tb.TimeDeviationCauseId.HasValue)
                          select tb).ToList();
            }
            else
            {
                result = (from tb in entities.TimeScheduleTemplateBlock
                            .Include("ShiftType")
                            .Include("TimeDeviationCause")
                            .Include("Employee.ContactPerson")
                            .Include("Account")
                          where (timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue) &&
                          (tb.EmployeeId == employeeId &&
                          tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                          //tb.TimeScheduleEmployeePeriod != null &&
                          (tb.Date.HasValue && tb.Date.Value >= fetchStartTime.Date && tb.Date.Value <= fetchStopTime.Date) && //Date (startdate) should be in intervall                                                                                                                                                                                             
                          tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                          tb.State == (int)SoeEntityState.Active &&
                          (includeAlreadyAbsence || !tb.TimeDeviationCauseId.HasValue)
                          select tb).ToList();
            }

            if (!includeZeroDays)
                result = result.Where(x => x.StartTime != x.StopTime);

            bool affected = false;

            foreach (var item in result)
            {
                affected = false;

                if (item.ActualStartTime.Value <= adjustedStartTime && adjustedStartTime < item.ActualStopTime.Value)
                {
                    //intervall starttime conflicts with scheduled block
                    affected = true;
                }
                else if (item.ActualStartTime.Value < adjustedStopTime && adjustedStopTime <= item.ActualStopTime.Value)
                {
                    //intervall stoptime conflicts with scheduled block
                    affected = true;
                }
                else if (CalendarUtility.IsCurrentOverlappedByNew(adjustedStartTime, adjustedStopTime, item.ActualStartTime.Value, item.ActualStopTime.Value))
                {
                    //scheduled block is overlapped by intervall 
                    affected = true;
                }
                else if (CalendarUtility.IsNewOverlappedByCurrent(adjustedStartTime, adjustedStopTime, item.ActualStartTime.Value, item.ActualStopTime.Value))
                {
                    //intervall is overlapped by scheduled block
                    affected = true;
                }

                if (affected)
                    affectedShifts.Add(item);
            }

            return affectedShifts;
        }

        #endregion

        #region ShiftAccounting

        public ShiftAccountingDTO GetShiftAccounting(int timeScheduleTemplateBlockId, int actorCompanyId)
        {
            ShiftAccountingDTO dto = new ShiftAccountingDTO();
            using var entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            List<AccountInternal> accInts = (from ai in entitiesReadOnly.AccountInternal.Include("Account.AccountDim")
                                             where ai.Account.ActorCompanyId == actorCompanyId &&
                                             ai.TimeScheduleTemplateBlock.Any(b => b.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId)
                                             select ai).ToList();

            int counter = 1;
            foreach (AccountInternal accInt in accInts.OrderBy(ai => ai.Account.AccountDim.AccountDimNr))
            {
                counter++;
                Account account = accInt.Account;
                if (account != null)
                {
                    dto.GetType().GetProperty(String.Format("Dim{0}Id", counter)).SetValue(dto, account.AccountId, null);
                    dto.GetType().GetProperty(String.Format("Dim{0}Nr", counter)).SetValue(dto, account.AccountNr, null);
                    dto.GetType().GetProperty(String.Format("Dim{0}Name", counter)).SetValue(dto, account.Name, null);
                    dto.GetType().GetProperty(String.Format("Dim{0}DimName", counter)).SetValue(dto, account.AccountDim.Name, null);
                }
            }

            return dto;
        }

        public List<ShiftAccountingRowDTO> GetShiftAccountingRows(int actorCompanyId, List<int> timeScheduleTemplateBlockIds)
        {
            List<ShiftAccountingRowDTO> dtos = new List<ShiftAccountingRowDTO>();
            // Get all shift types
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            Dictionary<int, string> shiftTypes = GetShiftTypesDict(entitiesReadOnly, actorCompanyId, false);

            List<TimeScheduleTemplateBlock> templateBlocks = (from t in entitiesReadOnly.TimeScheduleTemplateBlock
                                                              where timeScheduleTemplateBlockIds.Contains(t.TimeScheduleTemplateBlockId) &&
                                                              t.State == (int)SoeEntityState.Active
                                                              select t).ToList();

            List<AccountInternal> accInts = (from ai in entitiesReadOnly.AccountInternal.Include("Account.AccountDim")
                                             where ai.Account.ActorCompanyId == actorCompanyId &&
                                             ai.TimeScheduleTemplateBlock.Any(b => timeScheduleTemplateBlockIds.Contains(b.TimeScheduleTemplateBlockId))
                                             select ai).ToList();


            foreach (TimeScheduleTemplateBlock block in templateBlocks.OrderBy(b => b.StartTime))
            {
                ShiftAccountingRowDTO dto = new ShiftAccountingRowDTO();

                // Shift identity string
                string shiftIdentity = ((block.ShiftTypeId.HasValue && shiftTypes.ContainsKey(block.ShiftTypeId.Value)) ? shiftTypes[block.ShiftTypeId.Value] : (block.IsBreak ? GetText(5990, "Rast") : "--"))
                    + " " + block.StartTime.ToShortTimeString() + " - " + block.StopTime.ToShortTimeString();

                dto.TimeScheduleTemplateBlockId = block.TimeScheduleTemplateBlockId;
                dto.IdentityName = shiftIdentity;

                int counter = 1;
                foreach (AccountInternal accInt in accInts.OrderBy(ai => ai.Account.AccountDim.AccountDimNr))
                {
                    counter++;
                    Account account = accInt.Account;
                    if (account != null)
                    {
                        dto.GetType().GetProperty(String.Format("Dim{0}Id", counter)).SetValue(dto, account.AccountId, null);
                        dto.GetType().GetProperty(String.Format("Dim{0}Name", counter)).SetValue(dto, string.Concat(account.AccountNr, " - ", account.Name, null));
                    }
                }
                dtos.Add(dto);
            }
            return dtos;
        }

        #endregion

        #region ShiftRequest

        public ShiftRequestStatusDTO GetShiftRequestStatus(int timeScheduleTemplateBlockId, int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftRequestStatus(entities, timeScheduleTemplateBlockId, actorCompanyId);
        }

        public ShiftRequestStatusDTO GetShiftRequestStatus(CompEntities entities, int timeScheduleTemplateBlockId, int actorCompanyId)
        {
            ShiftRequestStatusDTO dto = null;
            List<int> linked = GetLinkedTimeScheduleTemplateBlocks(null, actorCompanyId, timeScheduleTemplateBlockId, false).Select(w => w.TimeScheduleTemplateBlockId).ToList();

            // Check if shift has a shift request
            Message message = (from m in entities.Message.Include("MessageText").Include("MessageRecipient")
                               where m.ActorCompanyId == actorCompanyId &&
                               m.Type == (int)TermGroup_MessageType.ShiftRequest &&
                               linked.Contains(m.RecordId) &&
                               m.State != (int)SoeEntityState.Deleted
                               orderby m.Created descending
                               select m).FirstOrDefault();

            if (message != null)
            {
                dto = new ShiftRequestStatusDTO()
                {
                    MessageId = message.MessageId,
                    SenderName = message.SenderName,
                    SentDate = message.SentDate.Value,
                    Text = message.Subject + (message.MessageText != null && message.MessageText.Text.Length > 0 ? "\n" + message.MessageText.Text : ""),
                    Recipients = new List<ShiftRequestStatusRecipientDTO>()
                };

                if (message.MessageRecipient != null && message.MessageRecipient.Any())
                {
                    foreach (MessageRecipient recipient in message.MessageRecipient.OrderByDescending(r => (XEMailAnswerType)r.AnswerType == XEMailAnswerType.Yes).ThenByDescending(r => (XEMailAnswerType)r.AnswerType == XEMailAnswerType.No).ThenByDescending(r => r.AnswerDate.HasValue).ThenBy(r => r.AnswerDate).ThenByDescending(r => r.ReadDate.HasValue).ThenBy(r => r.ReadDate).ThenBy(r => r.State == (int)SoeEntityState.Deleted))
                    {
                        Employee employee = EmployeeManager.GetEmployeeByUser(entities, actorCompanyId, recipient.UserId, false, true);
                        if (employee != null)
                        {
                            dto.Recipients.Add(new ShiftRequestStatusRecipientDTO()
                            {
                                UserId = recipient.UserId,
                                EmployeeId = employee.EmployeeId,
                                EmployeeNr = employee.EmployeeNr,
                                EmployeeName = employee.Name,
                                ReadDate = recipient.ReadDate,
                                AnswerDate = recipient.AnswerDate,
                                AnswerType = (XEMailAnswerType)recipient.AnswerType,
                                Modified = recipient.Modified,
                                ModifiedBy = recipient.ModifiedBy,
                                State = (SoeEntityState)recipient.State
                            });
                        }
                    }
                }
            }

            return dto;
        }

        public List<ShiftRequestStatusForReportDTO> GetShiftRequestStatusForReport(int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetShiftRequestStatusForReport(entities, actorCompanyId, employeeIds, dateFrom, dateTo);
        }

        public List<ShiftRequestStatusForReportDTO> GetShiftRequestStatusForReport(CompEntities entities, int actorCompanyId, List<int> employeeIds, DateTime dateFrom, DateTime dateTo)
        {
            List<ShiftRequestStatusForReportDTO> dtos = new List<ShiftRequestStatusForReportDTO>();
            if (!employeeIds.IsNullOrEmpty())
            {
                List<Employee> employees = EmployeeManager.GetAllEmployeesByIds(actorCompanyId, employeeIds, active: true, loadUser: true, loadEmployment: true);
                List<int> employeeUserIds = employees.Select(e => e.UserId ?? 0).Distinct().ToList();

                List<Message> messages = (from m in entities.Message.Include("MessageText").Include("MessageRecipient")
                                          where m.ActorCompanyId == actorCompanyId &&
                                          m.Type == (int)TermGroup_MessageType.ShiftRequest &&
                                          m.State != (int)SoeEntityState.Deleted &&
                                          m.Created >= dateFrom && m.Created <= dateTo &&
                                          m.MessageRecipient.Any(r => employeeUserIds.Contains(r.UserId))
                                          orderby m.Created descending
                                          select m).ToList();

                if (!messages.IsNullOrEmpty())
                {
                    foreach (Message message in messages)
                    {
                        List<TimeScheduleTemplateBlock> linkedShifts = GetLinkedTimeScheduleTemplateBlocks(null, actorCompanyId, message.RecordId, true); //.Select(w => w.TimeScheduleTemplateBlockId).ToList();

                        foreach (TimeScheduleTemplateBlock linkedShift in linkedShifts)
                        {
                            foreach (MessageRecipient messageRecipient in message.MessageRecipient)
                            {
                                ShiftRequestStatusForReportDTO dto = new ShiftRequestStatusForReportDTO()
                                {
                                    MessageId = message.MessageId,
                                    SenderName = message.SenderName,
                                    SentDate = message.SentDate,
                                    Subject = message.Subject,
                                    Text = message.MessageText.Text,
                                    UserId = messageRecipient.UserId,
                                    EmployeeId = employees.Where(e => e.UserId == messageRecipient.UserId).Select(e => e.EmployeeId).FirstOrDefault(),
                                    EmployeeNr = employees.Where(e => e.UserId == messageRecipient.UserId).Select(e => e.EmployeeNr).FirstOrDefault(),
                                    EmployeeName = employees.Where(e => e.UserId == messageRecipient.UserId).Select(e => e.ContactPerson.Name).FirstOrDefault(),
                                    ReadDate = messageRecipient.ReadDate,
                                    AnswerDate = messageRecipient.AnswerDate,
                                    AnswerType = (XEMailAnswerType)messageRecipient.AnswerType,
                                    Created = messageRecipient.Created,
                                    CreatedBy = messageRecipient.CreatedBy,
                                    Modified = messageRecipient.Modified,
                                    ModifiedBy = messageRecipient.ModifiedBy,
                                    State = (SoeEntityState)messageRecipient.State,
                                    ShiftDate = linkedShift.Date,
                                    ShiftStartTime = linkedShift.StartTime,
                                    ShiftStopTime = linkedShift.StopTime,
                                    ShiftTypeId = linkedShift.ShiftTypeId,
                                    ShiftTypeName = linkedShift.ShiftType.Name,
                                    ShiftCreated = linkedShift.Created,
                                    ShiftCreatedBy = linkedShift.CreatedBy,
                                    ShiftModified = linkedShift.Modified,
                                    ShiftModifiedBy = linkedShift.ModifiedBy,
                                    ShiftState = (SoeEntityState)linkedShift.State,
                                    ShiftAccountNr = linkedShift.Account?.AccountNr,
                                    ShiftAccountName = linkedShift.Account?.Name
                                };

                                dtos.Add(dto);
                            }
                        }
                    }
                }
            }

            return dtos;
        }

        public EvaluateWorkRulesActionResult ShiftRequestCheckIfTooEarlyToSend(DateTime startTime, int actorCompanyId)
        {
            EvaluateWorkRulesActionResult result = new EvaluateWorkRulesActionResult()
            {
                Result = new ActionResult(true),
                EvaluatedRuleResults = new List<EvaluateWorkRuleResultDTO>()
            };

            bool shiftRequestPreventTooEarly = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningShiftRequestPreventTooEarly, 0, actorCompanyId, 0);
            if (shiftRequestPreventTooEarly)
            {
                // Setting used, check times
                int shiftRequestPreventTooEarlyWarnHoursBefore = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningShiftRequestPreventTooEarlyWarnHoursBefore, 0, actorCompanyId, 0);
                int shiftRequestPreventTooEarlyStopHoursBefore = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.TimeSchedulePlanningShiftRequestPreventTooEarlyStopHoursBefore, 0, actorCompanyId, 0);

                double hoursUntilStart = (startTime - DateTime.Now).TotalHours;
                if (shiftRequestPreventTooEarlyStopHoursBefore > 0 && hoursUntilStart > shiftRequestPreventTooEarlyStopHoursBefore)
                {
                    // This is a stopping error, success is set to false to prevent client of overriding the error.
                    result.Result.Success = false;
                    result.Result.ErrorNumber = (int)ActionResultSave.RuleShiftRequestPreventTooEarlyStop;
                    result.Result.ErrorMessage = string.Format(GetText(12523, "Enligt inställning ska passförfrågan inte skickas förrän det är mindre än {0} timmar kvar innan passet startar."), shiftRequestPreventTooEarlyWarnHoursBefore);
                }
                else if (shiftRequestPreventTooEarlyWarnHoursBefore > 0 && hoursUntilStart > shiftRequestPreventTooEarlyWarnHoursBefore)
                {
                    // This is just a warning, success is set to true to enable client of overriding the error.
                    result.Result.Success = true;
                    result.Result.ErrorNumber = (int)ActionResultSave.RuleShiftRequestPreventTooEarlyWarn;
                    result.Result.ErrorMessage = string.Format(GetText(12523, "Enligt inställning ska passförfrågan inte skickas förrän det är mindre än {0} timmar kvar innan passet startar."), shiftRequestPreventTooEarlyWarnHoursBefore);

                    // But we also need to add a record in "EvaluatedRuleResults", otherwise "allRulesSucceded" will be set to true and error is not caught on client.
                    // EvaluatedWorkRule is needed for the logging of user override to work.
                    EvaluateWorkRuleResultDTO ruleResult = new EvaluateWorkRuleResultDTO(result.Result.ErrorNumber, result.Result.ErrorMessage);
                    ruleResult.EvaluatedWorkRule = SoeScheduleWorkRules.HoursBeforeShiftRequest;
                    result.EvaluatedRuleResults.Add(ruleResult);
                }
            }

            return result;
        }

        public ActionResult RemoveRecipientFromShiftRequest(int timeScheduleTemplateBlockId, int actorCompanyId, int userId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                MessageRecipient recipient = (from r in entities.MessageRecipient
                                              where r.Message.ActorCompanyId == actorCompanyId &&
                                              r.Message.Type == (int)TermGroup_MessageType.ShiftRequest &&
                                              r.Message.RecordId == timeScheduleTemplateBlockId &&
                                              r.Message.State != (int)SoeEntityState.Deleted &&
                                              r.UserId == userId &&
                                              r.State == (int)SoeEntityState.Active
                                              select r).FirstOrDefault();

                if (recipient != null)
                    result = ChangeEntityState(entities, recipient, SoeEntityState.Deleted, true);

                // If this was the only employee left on this shift request, also remove the whole request.
                bool recipientsLeft = (from r in entities.MessageRecipient
                                       where r.Message.ActorCompanyId == actorCompanyId &&
                                       r.Message.Type == (int)TermGroup_MessageType.ShiftRequest &&
                                       r.Message.RecordId == timeScheduleTemplateBlockId &&
                                       r.Message.State != (int)SoeEntityState.Deleted &&
                                       r.State == (int)SoeEntityState.Active
                                       select r).Any();

                if (!recipientsLeft)
                    UndoShiftRequest(timeScheduleTemplateBlockId, actorCompanyId);
            }

            return result;
        }

        public ActionResult UndoShiftRequest(int timeScheduleTemplateBlockId, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            using (CompEntities entities = new CompEntities())
            {
                Message message = (from m in entities.Message.Include("MessageRecipient")
                                   where m.ActorCompanyId == actorCompanyId &&
                                   m.Type == (int)TermGroup_MessageType.ShiftRequest &&
                                   m.RecordId == timeScheduleTemplateBlockId &&
                                   m.State != (int)SoeEntityState.Deleted
                                   select m).FirstOrDefault();

                if (message != null)
                {
                    ChangeEntityState(entities, message, SoeEntityState.Deleted, false);
                    foreach (MessageRecipient recipient in message.MessageRecipient.Where(r => r.State != (int)SoeEntityState.Deleted).ToList())
                    {
                        ChangeEntityState(entities, recipient, SoeEntityState.Deleted, false);
                    }

                    result = SaveChanges(entities);
                }
            }

            return result;
        }

        #endregion

        public List<int> GetEmployeeIdsWithShifts(int actorCompanyId, DateTime dateFrom, DateTime dateTo, bool? preliminary = null, bool isTemplate = false, bool includeZeroSchedule = false, List<int> filteredEmployeeIds = null)
        {
            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            var query = (from tb in entities.TimeScheduleTemplateBlock
                         where !tb.TimeScheduleScenarioHeadId.HasValue &&
                         (tb.Employee != null && tb.Employee.ActorCompanyId == actorCompanyId) &&
                         (tb.Date.HasValue && tb.Date.Value >= dateFrom && tb.Date.Value <= dateTo) &&
                         (tb.StartTime != tb.StopTime || tb.TimeDeviationCauseId.HasValue || includeZeroSchedule) &&
                         tb.BreakType == (int)SoeTimeScheduleTemplateBlockBreakType.None &&
                         tb.State == (int)SoeEntityState.Active
                         select tb);

            // Pre filtered employees
            if (!filteredEmployeeIds.IsNullOrEmpty())
                query = query.Where(tb => filteredEmployeeIds.Contains(tb.EmployeeId.Value));

            // Check preliminary flag
            if (preliminary.HasValue)
                query = query.Where(tb => tb.IsPreliminary == preliminary.Value);

            // Check template flag (Grundschema)
            if (isTemplate)
            {
                query = query.Where(tb => tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.ActorCompanyId == actorCompanyId &&
                    tb.TimeScheduleTemplatePeriod.TimeScheduleTemplateHead.EmployeeId != null);
            }

            return query.Select(b => b.EmployeeId.Value).Distinct().ToList();
        }

        public List<int> GetEmployeeIdsWithPlacements(int actorCompanyId, DateTime dateFrom, DateTime dateTo)
        {
            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeSchedule.NoTracking();
            var query = (from es in entities.EmployeeSchedule
                         where (es.Employee != null && es.Employee.ActorCompanyId == actorCompanyId) &&
                         es.StartDate <= dateFrom &&
                         es.StopDate >= dateTo &&
                         es.State == (int)SoeEntityState.Active
                         select es);

            return query.Select(es => es.EmployeeId).ToList();
        }

        public List<int> GetAvailableEmployeeIds(int actorCompanyId, DateTime dateFrom, DateTime dateTo, bool? preliminary = null, bool isTemplate = false)
        {
            // Get all active employees
            List<int> employeeIds = EmployeeManager.GetAllEmployeeIds(actorCompanyId, getHidden: true);

            // Remove employees with shifts
            List<int> shiftEmployeeIds = GetEmployeeIdsWithShifts(actorCompanyId, dateFrom, dateTo, preliminary, isTemplate);
            employeeIds.RemoveItems(shiftEmployeeIds);

            // Remove employees that has no placements
            List<int> placedEmployeeIds = GetEmployeeIdsWithPlacements(actorCompanyId, dateFrom, dateTo);

            employeeIds = employeeIds.Where(emp => placedEmployeeIds.Contains(emp)).ToList();

            return employeeIds;
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeScheduleShifts(int actorCompanyId, int userId, int roleId, int employeeId, DateTime dateFrom, DateTime dateTo, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes, bool includeBreaks, bool includeGrossNetAndCost, Guid? link = null, int currentEmployeeId = 0, bool loadQueue = false, bool loadDeviationCause = false, bool loadTasksAndDelivery = false, bool includePreliminary = true, int? timeScheduleScenarioHeadId = null, bool setShiftIsLended = false, bool setSwapShiftInfo = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            return GetTimeScheduleShifts(entities, actorCompanyId, userId, roleId, employeeId, dateFrom, dateTo, blockTypes, includeBreaks, includeGrossNetAndCost, link, currentEmployeeId, loadQueue, loadDeviationCause, loadTasksAndDelivery, includePreliminary, timeScheduleScenarioHeadId, setShiftIsLended, setSwapShiftInfo);
        }

        public List<TimeSchedulePlanningDayDTO> GetTimeScheduleShifts(CompEntities entities, int actorCompanyId, int userId, int roleId, int employeeId, DateTime dateFrom, DateTime dateTo, List<TermGroup_TimeScheduleTemplateBlockType> blockTypes, bool includeBreaks, bool includeGrossNetAndCost, Guid? link = null, int currentEmployeeId = 0, bool loadQueue = false, bool loadDeviationCause = false, bool loadTasksAndDelivery = false, bool includePreliminary = true, int? timeScheduleScenarioHeadId = null, bool setShiftIsLended = false, bool setSwapShiftInfo = false)
        {
            bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);

            dateFrom = CalendarUtility.GetBeginningOfDay(dateFrom);
            dateTo = CalendarUtility.GetEndOfDay(dateTo);

            IQueryable<TimeScheduleTemplateBlock> query = entities.TimeScheduleTemplateBlock
                                                            .Include("TimeScheduleType.TimeScheduleTypeFactor")
                                                            .Include("ShiftType.TimeScheduleType")
                                                            .Include("Employee.ContactPerson")
                                                            .Include("TimeScheduleEmployeePeriod");
            if (useAccountHierarchy)
                query = query.Include("Account");

            if (loadQueue)
                query = query.Include("TimeScheduleTemplateBlockQueue");
            if (loadDeviationCause)
                query = query.Include("TimeDeviationCause");
            if (loadTasksAndDelivery)
            {
                query = query.Include("TimeScheduleTemplateBlockTask.TimeScheduleTask");
                query = query.Include("TimeScheduleTemplateBlockTask.IncomingDeliveryRow");
            }

            query = query.Where(tb => (timeScheduleScenarioHeadId.HasValue ? tb.TimeScheduleScenarioHeadId == timeScheduleScenarioHeadId.Value : !tb.TimeScheduleScenarioHeadId.HasValue) &&
                                                                        tb.EmployeeId == employeeId &&
                                                                        (tb.Date >= dateFrom && tb.Date <= dateTo) &&
                                                                        (tb.StartTime != tb.StopTime || tb.TimeDeviationCauseId.HasValue) &&
                                                                        tb.State == (int)SoeEntityState.Active);

            // Filter on block types
            if (blockTypes != null && blockTypes.Count > 0)
                query = query.Where(b => blockTypes.Contains((TermGroup_TimeScheduleTemplateBlockType)b.Type));

            if (link.HasValue)
            {
                string linkStr = link.Value.ToString();
                query = query.Where(b => b.Link.Equals(linkStr));
            }

            if (!includePreliminary)
                query = query.Where(b => !b.IsPreliminary);

            query = query.OrderBy(b => b.StartTime);

            // Execute query
            List<TimeScheduleTemplateBlock> blocks = query.ToList();

            if (currentEmployeeId == 0)
                currentEmployeeId = EmployeeManager.GetEmployeeIdForUser(entities, userId, actorCompanyId);

            // Get valid accounts to be able to filter shifts in CreateTimeSchedulePlanningDayDTOs
            List<int> validAccountIds = null;
            if (useAccountHierarchy && blocks.Any() && blocks.First().Employee.Hidden)
            {
                List<AttestRoleUser> attestRoleUsers = AttestManager.GetAttestRoleUsers(entities, actorCompanyId, userId, dateFrom, dateTo);
                if (!attestRoleUsers.IsNullOrEmpty())
                {
                    AccountHierarchyInput input = AccountHierarchyInput.GetInstance();
                    input.AddParamValue(AccountHierarchyParamType.IncludeAbstract, true);
                    validAccountIds = AccountManager.GetAccountIdsFromHierarchyByUserSetting(entities, actorCompanyId, roleId, userId, dateFrom, dateTo, input);
                }
                else
                    validAccountIds = AccountManager.GetValidAccountsForEmployee(entities, actorCompanyId, currentEmployeeId, 0, 0, dateFrom, dateTo, onlyParents: true).Select(x => x.AccountId).ToList();
            }

            // Convert to DTOs
            List<TimeSchedulePlanningDayDTO> dtos = CreateTimeSchedulePlanningDayDTOs(entities, blocks, actorCompanyId, currentEmployeeId, includeBreaks, includeStatusNames: true, validAccountIds: validAccountIds);

            if (setShiftIsLended)
                SetShiftIsLended(entities, actorCompanyId, userId, dtos);

            // Add gross, net and cost
            if (includeGrossNetAndCost)
                CalculateGrossNetAndCost(dtos, actorCompanyId, userId, roleId, onlyActive: false, includeEmploymentTaxAndSupplementChargeCost: false);

            if (setSwapShiftInfo)
            {
                SetSwapShiftInfo(dtos);
                List<TimeScheduleSwapRequestDTO> swapRequests = TimeScheduleManager.GetEmployeesSwapRequestApprovedRows(actorCompanyId, dtos.Select(d => d.EmployeeId).Distinct().ToList(), dateFrom, dateTo);
                foreach (TimeScheduleSwapRequestDTO swapRequest in swapRequests)
                {
                    foreach (TimeScheduleSwapRequestRowDTO row in swapRequest.Rows)
                    {
                        // Get intersecting shifts
                        foreach (TimeSchedulePlanningDayDTO dto in dtos.Where(d => d.EmployeeId == row.EmployeeId && d.StartTime <= row.ScheduleStop && d.StopTime >= row.ScheduleStart).ToList())
                        {
                            dto.HasSwapRequest = true;
                        }
                    }
                }
            }

            return dtos;
        }

        public TimeSchedulePlanningDayDTO GetTimeScheduleShift(int timeScheduleTemplateBlockId, int actorCompanyId, int userId, bool includeBreaks)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeScheduleTemplateBlock.NoTracking();
            TimeScheduleTemplateBlock block = (from tb in entities.TimeScheduleTemplateBlock
                                                        .Include("ShiftType")
                                                        .Include("Employee.ContactPerson")
                                                        .Include("TimeScheduleEmployeePeriod")
                                                        .Include("TimeScheduleTemplateBlockQueue")
                                               where tb.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId &&
                                               tb.TimeScheduleEmployeePeriod != null &&
                                               tb.State == (int)SoeEntityState.Active
                                               select tb).FirstOrDefault();
            if (block == null)
                return null;

            // Get employee from user
            int employeeId = EmployeeManager.GetEmployeeIdForUser(userId, actorCompanyId);
            // Check if shift belongs to hidden employee
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
            bool isHidden = (block.EmployeeId.HasValue && block.EmployeeId.Value == hiddenEmployeeId);

            // Convert to DTO
            TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(block, actorCompanyId, employeeId, includeStatusNames: true);
            if (dto != null && includeBreaks)
            {
                // Get break blocks with same TimeScheduleEmployeePeriodId as precense block
                AddBreaksToTimeSchedulePlanningDayDTO(GetTimeScheduleShiftBreaks(block.TimeScheduleEmployeePeriodId.Value, block.TimeScheduleScenarioHeadId, isHidden ? block.Link : null), null, ref dto);
            }

            return dto;
        }

        public TimeSchedulePlanningDayDTO GetTimeScheduleShift(CompEntities entities, int timeScheduleTemplateBlockId, int actorCompanyId, bool includeBreaks)
        {
            TimeScheduleTemplateBlock block = (from tb in entities.TimeScheduleTemplateBlock
                                                .Include("ShiftType")
                                                .Include("Employee.ContactPerson")
                                                .Include("TimeScheduleEmployeePeriod")
                                               where tb.TimeScheduleTemplateBlockId == timeScheduleTemplateBlockId &&
                                               tb.TimeScheduleEmployeePeriod != null &&
                                               tb.State == (int)SoeEntityState.Active
                                               select tb).FirstOrDefault();
            if (block == null)
                return null;

            // Check if shift belongs to hidden employee
            int hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
            bool isHidden = (block.EmployeeId.HasValue && block.EmployeeId.Value == hiddenEmployeeId);

            // Convert to DTO
            TimeSchedulePlanningDayDTO dto = CreateTimeSchedulePlanningDayDTO(entities, block, actorCompanyId, 0, includeStatusNames: true);
            if (dto != null && includeBreaks)
            {
                // Get break blocks with same TimeScheduleEmployeePeriodId as precense block
                AddBreaksToTimeSchedulePlanningDayDTO(GetTimeScheduleShiftBreaks(block.TimeScheduleEmployeePeriodId.Value, block.TimeScheduleScenarioHeadId, isHidden ? block.Link : null), null, ref dto);
            }

            return dto;
        }

        public int GetTimeStaffingShiftAccountDimId(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return GetTimeStaffingShiftAccountDimId(entities, actorCompanyId);
        }

        public int GetTimeStaffingShiftAccountDimId(CompEntities entities, int actorCompanyId)
        {
            // Get company setting that defines the AccountDimId
            return SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.TimeStaffingShiftAccountDimId, 0, actorCompanyId, 0);
        }

        #endregion

        #region TimeEmployeeSchedule

        public List<TimeEmployeeScheduleDataSmallDTO> GetTimeEmployeeScheduleSmallDTOForReport(DateTime dateFrom, DateTime dateTo, List<Employee> employees, int actorCompanyId, int roleId, List<int> shiftTypeIds = null, bool splitOnBreaks = true, bool addAmounts = true, bool removeBreaks = false, int? timeScheduleScenarioHeadId = null, bool includeEmpTaxAndSuppCharge = false, bool forceSkipAccount = false)
        {
            List<TimeEmployeeScheduleDataSmallDTO> result = new List<TimeEmployeeScheduleDataSmallDTO>();

            var dict = GetTimeEmployeeScheduleSmallDTODictForReport(dateFrom, dateTo, employees, actorCompanyId, roleId, shiftTypeIds, splitOnBreaks, addAmounts, removeBreaks, timeScheduleScenarioHeadId, includeEmpTaxAndSuppCharge: includeEmpTaxAndSuppCharge, forceSkipAccount: forceSkipAccount);
            if (!dict.IsNullOrEmpty())
                dict.ToList().ForEach(f => result.AddRange(f.Value));

            return result.OrderBy(o => o.EmployeeNrSort).ThenBy(t => t.Date).ThenBy(t => t.StartTime).ToList();
        }

        public Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> GetTimeEmployeeScheduleSmallDTODictForReport(DateTime dateFrom, DateTime dateTo, List<Employee> employees, int actorCompanyId, int roleId, List<int> shiftTypeIds = null, bool splitOnBreaks = true, bool addAmounts = true, bool removeBreaks = false, int? timeScheduleScenarioHeadId = null, bool forceSkipAccount = false, bool addGrossTimeAndAmount = true, bool includeOnDuty = false, bool includeEmpTaxAndSuppCharge = false)
        {
            Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> result = new Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>>();

            List<TimeEmployeeScheduleDataSmallDTO> dtos = new List<TimeEmployeeScheduleDataSmallDTO>();
            bool isMartinServera = base.IsMartinServera();

            if (dateTo.Date == DateTime.MinValue)
                dateTo = CalendarUtility.GetEndOfDay(dateFrom);

            try
            {
                string separator = ",";
                string shiftTypeWhere = " ";
                if (!shiftTypeIds.IsNullOrEmpty())
                    shiftTypeWhere = $" (tsb.BreakType = 1 OR tsb.ShiftTypeId in ({string.Join(separator, shiftTypeIds.ToArray())})) AND";

                string timeScheduleScenarioHead = !timeScheduleScenarioHeadId.HasValue || (timeScheduleScenarioHeadId.HasValue && timeScheduleScenarioHeadId.Value == 0) ? " tsb.timeScheduleScenarioHeadId is null AND" : $" tsb.timeScheduleScenarioHeadId={timeScheduleScenarioHeadId} AND";
                using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
                bool useAccountHierarchy = base.UseAccountHierarchyOnCompanyFromCache(entities, actorCompanyId);
                // Hardcoded for Martin Servera for now..
                AccountHierarchyInput input = isMartinServera ? AccountHierarchyInput.GetInstance(AccountHierarchyParamType.IncludeVirtualParented) : null;
                Dictionary<int, int> accountIds = useAccountHierarchy ? AccountManager.GetAccountIdsFromHierarchyByUserSetting(actorCompanyId, roleId, UserId, dateFrom, dateTo, input).ToDictionary(k => k, v => v) : null;
                List<int> employeeIds = employees.Select(s => s.EmployeeId).ToList();
                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                List<AccountDimDTO> accountDims = base.GetAccountDimsFromCache(entitiesReadOnly, CacheConfig.Company(actorCompanyId));
                var employeeDict = employees.ToDictionary(k => k.EmployeeId, v => v);

                List<int> filteredEmployeeIds = new List<int>();
                if (employeeIds.Count > 3000)
                {
                    var fromTrans = dateFrom.AddDays(-30);
                    var toTrans = dateTo.AddDays(30);
                    var employeeIdsWithTransactions = entitiesReadOnly.TimeScheduleEmployeePeriod.Where(w => w.ActorCompanyId == actorCompanyId && w.State == (int)SoeEntityState.Active && w.Date >= fromTrans && w.Date <= toTrans).Select(s => s.EmployeeId).Distinct().ToList();
                    filteredEmployeeIds = employeeIds.Where(w => employeeIdsWithTransactions.Contains(w)).ToList();
                }
                else
                    filteredEmployeeIds.AddRange(employeeIds);

                using (SqlConnection connection = new SqlConnection(FrownedUponSQLClient.GetADOConnectionString()))
                {
                    var sql = $@"	
                            CREATE TABLE #employeeIdTemp (spid int PRIMARY KEY)
                            Insert into #employeeIdTemp  (spid) (Select id from dbo.Split('{string.Join(separator, filteredEmployeeIds.ToArray())}',','))
	                        SELECT 
                               LEFT(o.list,LEN(o.list) - 1) AS AccountInternalsStr, 
							   tsb.TimeScheduleTemplateBlockId,
							   tsb.StartTime,
							   tsb.StopTime,
							   tsb.EmployeeId,
							   tsb.ShiftTypeId,
							   tsb.TimeDeviationCauseId,
							   tsb.Date,
                               tsb.BreakType,
							   tsb.SubstituteShift,
							   tsb.ExtraShift,
                               tsb.TimeCodeId,
                               tsb.TimeScheduleTypeId,
                               tsb.TimeScheduleScenarioHeadId,
                               tsb.Link,
							   tsb.AccountId,
                               tsb.IsPreliminary,
                               tsb.Description,
                               tsb.Created,
                               tsb.CreatedBy,
                               tsb.Modified,
                               tsb.ModifiedBy,
                               tsb.Type
	                                FROM 
		                                dbo.TimeScheduleTemplateBlock AS tsb WITH (NOLOCK) inner join
	                                    #employeeIdTemp as e on e.spid = tsb.EmployeeId inner join
										--dbo.TimeScheduleTemplatePeriod AS tsp WITH (NOLOCK) ON tsp.TimeScheduleTemplatePeriodId = tsb.TimeScheduleTemplatePeriodId inner join
										--dbo.TimeScheduleTemplateHead AS tsh WITH (NOLOCK) ON tsh.TimeScheduleTemplateHeadId = tsp.TimeScheduleTemplateHeadId inner join
										dbo.TimeScheduleEmployeePeriod AS tep  WITH (NOLOCK) ON tep.TimeScheduleEmployeePeriodId = tsb.TimeScheduleEmployeePeriodId CROSS APPLY 
		                                 (
			                                SELECT   
				                                CONVERT(VARCHAR(100),tptad.AccountDimNr) + '|' + CONVERT(VARCHAR(100),tacc.AccountId) + '|' + CONVERT(VARCHAR(100),tacc.AccountNr) + '|' + CONVERT(VARCHAR(100),tacc.Name) + ',' AS [text()]
			                                FROM
				                                dbo.TimeScheduleTemplateBlockAccount AS ta WITH (NOLOCK) INNER JOIN 
				                                dbo.Account AS tacc WITH (NOLOCK) ON tacc.AccountId = ta.AccountId INNER JOIN 
				                                dbo.AccountDim AS tptad WITH (NOLOCK) ON tptad.AccountDimId = tacc.AccountDimId
			                                WHERE    
				                                ta.TimeScheduleTemplateBlockId = tsb.TimeScheduleTemplateBlockId and tptad.AccountDimNr > 1
			                                ORDER BY
				                                tptad.AccountDimNr
			                                FOR XML PATH('')
		                                 ) o(list)	
	                                WHERE
                                        (tsb.Date BETWEEN '{CalendarUtility.ToSqlFriendlyDateTime(dateFrom)}' AND '{CalendarUtility.ToSqlFriendlyDateTime(dateTo)}') AND
                                        {shiftTypeWhere}
                                        {timeScheduleScenarioHead}
		                                tep.ActorCompanyId = {actorCompanyId} and
		                                tsb.[State] = 0
	                                ORDER BY
		                               tsb.EmployeeId, tsb.date	

                                    drop table #employeeIdTemp
	                              ";

                    var magnitud = CalendarUtility.GetTotalDays(dateFrom, dateTo) + employeeIds.Count;
                    var queryResult = FrownedUponSQLClient.ExcuteQueryNew(connection, sql, magnitud < 30 ? (int?)null : magnitud > 1000 ? 1000 : magnitud);
                    var reader = queryResult.SqlDataReader;

                    if (!queryResult.Result.Success)
                        LogError($"{queryResult.Result.Exception} {queryResult.Result.ErrorMessage}");

                    if (reader != null)
                    {
                        int prevEmployeeId = 0;

                        while (reader.Read())
                        {
                            int currentEmployeeId = (int)reader["employeeid"];
                            if (currentEmployeeId != prevEmployeeId)
                            {
                                if (useAccountHierarchy && employeeDict.TryGetValue(prevEmployeeId, out Employee prevEmployee))
                                {
                                    if (prevEmployee != null && prevEmployee.Hidden && !dtos.IsNullOrEmpty() && dtos.Any(a => !a.AccountId.HasValue))
                                    {
                                        foreach (var item in dtos.Where(w => w.IsBreak && !w.AccountId.HasValue))
                                        {
                                            var withLink = dtos.FirstOrDefault(f => f.Date == item.Date && !f.IsBreak && !string.IsNullOrEmpty(f.Link) && f.Link == item.Link);

                                            if (withLink != null)
                                                item.AccountId = withLink.AccountId;
                                            else
                                                item.AccountId = -1;
                                        }

                                        dtos = dtos.Where(w => w.AccountId != -1).ToList();
                                    }
                                }

                                result.Add(prevEmployeeId, dtos);
                                dtos = new List<TimeEmployeeScheduleDataSmallDTO>();
                                prevEmployeeId = currentEmployeeId;
                            }

                            var dto = new TimeEmployeeScheduleDataSmallDTO();
                            dto.TimeScheduleTemplateBlockId = (int)reader["timescheduletemplateblockid"];
                            dto.TimeScheduleScenarioHeadId = reader["timeschedulescenarioheadid"].ToString() != "" ? (int?)reader["timeschedulescenarioheadid"] : null;
                            dto.EmployeeId = (int)reader["employeeId"];
                            dto.TimeCodeId = (int)reader["timecodeid"];
                            dto.ShiftTypeId = reader["shifttypeid"].ToString() != "" ? (int?)reader["shifttypeid"] : null;
                            dto.TimeDeviationCauseId = reader["timedeviationcauseid"].ToString() != "" ? (int?)reader["timedeviationcauseid"] : null;
                            dto.ScheduleTypeId = reader["timescheduletypeId"].ToString() != "" ? (int?)reader["timescheduletypeId"] : null;
                            dto.Date = (DateTime)reader["date"];
                            dto.StartTime = (DateTime)reader["starttime"];
                            dto.StopTime = (DateTime)reader["stoptime"];
                            dto.IsBreak = (int)reader["breaktype"] > 0;
                            dto.SubstituteShift = (bool)reader["substituteshift"];
                            dto.ExtraShift = (bool)reader["extrashift"];
                            dto.IsPreliminary = (bool)reader["ispreliminary"];
                            dto.AccountId = reader["accountid"].ToString() != "" ? (int?)reader["accountid"] : null;
                            dto.AccountInternals = reader["accountinternalsstr"].ToString() != "" ? TimeTransactionManager.GetAccountInternalDTOs(reader["accountinternalsstr"].ToString(), accountDims: accountDims) : new List<AccountInternalDTO>();
                            dto.Link = reader["link"].ToString();
                            dto.Description = reader["description"].ToString();
                            dto.Created = reader["created"].ToString() != "" ? (DateTime)reader["created"] : (DateTime?)null;
                            dto.CreatedBy = reader["createdby"].ToString();
                            dto.Modified = reader["modified"].ToString() != "" ? (DateTime)reader["modified"] : (DateTime?)null;
                            dto.ModifiedBy = reader["modifiedby"].ToString();
                            int type = reader["type"].ToString() != "" ? (int)reader["type"] : 0;
                            dto.Type = (TermGroup_TimeScheduleTemplateBlockType)type;
                            if (!forceSkipAccount && useAccountHierarchy && dto.AccountId.HasValue && !accountIds.ContainsKey(dto.AccountId.Value))
                                continue;

                            dtos.Add(dto);
                        }

                        if (dtos.Any())
                        {
                            dtos = dtos.Where(w => includeOnDuty ? (w.Type == TermGroup_TimeScheduleTemplateBlockType.Schedule || w.Type == TermGroup_TimeScheduleTemplateBlockType.OnDuty) : w.Type == TermGroup_TimeScheduleTemplateBlockType.Schedule).ToList();
                            if (employeeDict.TryGetValue(dtos.First().EmployeeId, out Employee employee2))
                            {
                                if (employee2 != null && employee2.Hidden && useAccountHierarchy && !dtos.IsNullOrEmpty() && dtos.Any(a => !a.AccountId.HasValue))
                                {
                                    foreach (TimeEmployeeScheduleDataSmallDTO item in dtos.Where(w => w.IsBreak && !w.AccountId.HasValue))
                                    {
                                        var dtoLinked = dtos.FirstOrDefault(f => f.Date == item.Date && !f.IsBreak && !string.IsNullOrEmpty(f.Link) && f.Link == item.Link);
                                        if (dtoLinked != null)
                                            item.AccountId = dtoLinked.AccountId;
                                        else
                                            item.AccountId = -1;
                                    }
                                    dtos = dtos.Where(w => w.AccountId != -1).ToList();
                                }
                            }
                            result.Add(prevEmployeeId, dtos);
                        }
                    }
                }

                foreach (var pair in result.Where(w => w.Key != 0))
                {
                    if (employeeDict.TryGetValue(pair.Key, out Employee employee3))
                    {
                        if (employee3 != null)
                        {
                            foreach (var transactionGroup in pair.Value.GroupBy(g => g.Date))
                            {
                                var date = transactionGroup.Key;
                                var employeeGroupId = employee3.GetEmployeeGroupId(date);

                                if (employeeGroupId != 0)
                                {
                                    foreach (var trans in transactionGroup.ToList())
                                    {
                                        if (trans.EmployeeId == employee3.EmployeeId)
                                            trans.EmployeeGroupId = employeeGroupId;
                                    }
                                }
                            }
                        }
                    }
                }

                if (splitOnBreaks)
                {
                    result = SplitOnBreaks(actorCompanyId, result, removeBreaks: removeBreaks);
                    if (addAmounts)
                    {
                        AddAmounts(actorCompanyId, result, employees, includeEmpTaxAndSuppCharge);
                        if (addGrossTimeAndAmount)
                        {
                            result = AddGrossTimeAndAmount(result, new GrossTimeInput() { ActorCompanyId = actorCompanyId, EmployeeGroupIds = EmployeeManager.GetEmployeeGroups(actorCompanyId).Select(s => s.EmployeeGroupId).ToList(), StartDate = dateFrom, StopDate = dateTo });
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                LogError(ex, log);
                throw new Exception("GetTimeEmployeeScheduleSmallDTODictForReport", ex);
            }

            return result;
        }


        public Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> SplitOnBreaks(int actorCompanyId, Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> dict, bool removeBreaks = false)
        {
            Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> splitted = new Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>>();
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var hiddenEmployeeId = base.GetHiddenEmployeeIdFromCache(entities, CacheConfig.Company(actorCompanyId));
            Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> hiddenDict = new Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>>();
            if (hiddenEmployeeId != 0 && dict.TryGetValue(hiddenEmployeeId, out List<TimeEmployeeScheduleDataSmallDTO> hiddenDTOs))
            {
                dict.Remove(hiddenEmployeeId);
                int seedId = int.MinValue + hiddenEmployeeId;
                foreach (var item in hiddenDTOs.GroupBy(g => $"L{g.Link}#{g.Date}"))
                {
                    hiddenDict.Add(seedId, item.ToList());
                    seedId++;
                }
                if (hiddenDict.Any())
                    dict.AddRange(hiddenDict);
            }

            foreach (var pair in dict)
            {
                var overlappingSchedule = pair.Value.GroupBy(x => x.Date.ToString() + x.StartTime.ToString() + x.StopTime.ToString()).Where(x => x.Count() > 1);
                if (overlappingSchedule.Any())
                {
                    foreach (var item in overlappingSchedule)
                    {
                        var scheduleBreaks = item.Where(x => x.IsBreak).ToList();
                        var schedules = item.Where(x => !x.IsBreak).ToList();
                        foreach (var schedule in schedules)
                        {
                            foreach (var scheduleBreak in scheduleBreaks)
                            {
                                var breakMinutes = CalendarUtility.GetOverlappingMinutes(schedule.StartTime, schedule.StopTime, scheduleBreak.StartTime, scheduleBreak.StopTime);
                                if (breakMinutes == schedule.Quantity)
                                    pair.Value.Remove(schedule); //remove schedule if it is totaly overlapped by a break
                            }
                        }
                    }
                }

                var breaks = pair.Value.Where(w => w.IsBreak).ToList();
                if (breaks.Any())
                {
                    var blocks = pair.Value.Where(w => !w.IsBreak).ToList();

                    foreach (var breakBlock in breaks)
                    {
                        var overlappningBlocks = blocks.Where(w => w.Date == breakBlock.Date && CalendarUtility.GetOverlappingMinutes(w.StartTime, w.StopTime, breakBlock.StartTime, breakBlock.StopTime) > 0).ToList();

                        for (int i = 0; i < overlappningBlocks.Count; i++)
                        {
                            var block = overlappningBlocks[i];
                            var clone = block.CloneDTO();

                            if (breakBlock.StartTime > block.StartTime)
                            {
                                block.StopTime = breakBlock.StartTime;

                                if (clone.StopTime > breakBlock.StopTime)
                                {
                                    clone.StartTime = breakBlock.StopTime;
                                    blocks.Add(clone);
                                }
                            }
                            else if (breakBlock.StopTime < block.StopTime)
                            {
                                block.StartTime = breakBlock.StopTime;
                            }

                        }

                    }

                    pair.Value.Clear();
                    pair.Value.AddRange(blocks);
                    pair.Value.AddRange(breaks);
                }

                if (removeBreaks)
                {
                    var values = pair.Value.Where(w => !w.IsBreak).ToList();
                    pair.Value.Clear();
                    pair.Value.AddRange(values);
                }

                splitted.Add(pair.Key, pair.Value);
            }

            //Merge hidden employee back to one key
            if (hiddenDict.Any())
            {
                List<TimeEmployeeScheduleDataSmallDTO> dtos = new List<TimeEmployeeScheduleDataSmallDTO>();

                foreach (var hidden in hiddenDict)
                {
                    if (splitted.TryGetValue(hidden.Key, out List<TimeEmployeeScheduleDataSmallDTO> value))
                    {
                        dtos.AddRange(value);
                        splitted.Remove(hidden.Key);
                    }
                }

                splitted.Add(hiddenEmployeeId, dtos);
            }

            return splitted;
        }
        public Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> AddAmounts(int actorCompanyId, Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> dict, List<Employee> employees, bool includeEmpTaxAndSuppCharge = false)
        {
            var payrollGroupSettings = PayrollManager.GetPayrollGroupSettingsForCompany(actorCompanyId);
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            var payrollGroupPriceTypes = base.GetPayrollGroupPriceTypesForCompanyFromCache(entities, CacheConfig.Company(actorCompanyId)).ToDTOs(true).ToList();
            List<int> employeeIds = employees != null && employees.Count < 100 ? employees.Select(s => s.EmployeeId).ToList() : null;
            var payrollGroups = PayrollManager.GetPayrollGroups(base.ActorCompanyId, loadPriceTypes: true, loadSettings: true);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            Dictionary<int, List<EmploymentPriceTypeDTO>> employmentPriceTypesForCompanyDict = EmployeeManager.GetEmploymentPriceTypesForCompany(entitiesReadOnly, actorCompanyId, employeeIds).ToDTOs(true, false).GroupBy(g => g.EmployeeId).ToDictionary(x => x.Key, v => v.ToList());
            decimal fallBackHourCost = 0;
            Dictionary<int, decimal> settingPayrollGroupMonthlyWorkTimeDict = new Dictionary<int, decimal>();
            var employeeDict = employees.ToDictionary(x => x.EmployeeId, x => x);
            var payrollGroupAccountStds = includeEmpTaxAndSuppCharge ? base.GetPayrollGroupAccountStdFromCache(entitiesReadOnly, actorCompanyId) : null;


            var firstDate = dict.SelectMany(s => s.Value).Where(w => w.Date != null).OrderBy(o => o.Date).FirstOrDefault()?.Date;
            var lastDate = dict.SelectMany(s => s.Value).Where(w => w.Date != null).OrderByDescending(o => o.Date).FirstOrDefault()?.Date;
            var fixedPayrollRows = EmployeeManager.GetEmployeeFixedPayrollRows(actorCompanyId, employees, firstDate ?? DateTime.Today.AddYears(-20), lastDate ?? DateTime.Today.AddYears(10));
            var fixedPayrollRowsDict = fixedPayrollRows.GroupBy(g => g.EmployeeId).ToDictionary(x => x.Key, v => v.ToList());


            foreach (var pair in dict)
            {
                if (!employeeDict.TryGetValue(pair.Key, out Employee employee))
                    continue;

                if (employee != null && !pair.Value.IsNullOrEmpty())
                {
                    DateTime? start = pair.Value.OrderBy(i => i.Date).First().Date;
                    DateTime? stop = pair.Value.OrderBy(i => i.Date).Last().Date;

                    if (!start.HasValue || !stop.HasValue)
                        continue;

                    var fixedPayrollRowsForEmployee = fixedPayrollRowsDict.ContainsKey(employee.EmployeeId) ? fixedPayrollRowsDict[employee.EmployeeId] : new List<FixedPayrollRowDTO>();


                    DateTime? birthDate = null;
                    if (includeEmpTaxAndSuppCharge && employee != null && employee.ContactPerson != null && !String.IsNullOrEmpty(employee.ContactPerson.SocialSec))
                        birthDate = CalendarUtility.GetBirthDateFromSecurityNumber(employee.ContactPerson.SocialSec);

                    Dictionary<DateTime, decimal> paymentDict = PayrollManager.GetEmployeeHourlyPays(actorCompanyId, employee, start.Value, stop.Value, payrollGroupSettings: payrollGroupSettings, payrollGroupPriceTypes: payrollGroupPriceTypes, employmentPriceTypesForCompanyDict: employmentPriceTypesForCompanyDict, fixedPayrollRows: fixedPayrollRowsForEmployee);
                    foreach (var transOnDateGroup in pair.Value.GroupBy(g => g.Date))
                    {
                        var employment = includeEmpTaxAndSuppCharge ? employee.GetEmployment(transOnDateGroup.Key) : null;
                        paymentDict.TryGetValue(transOnDateGroup.Key, out decimal hourlyPay);
                        if (hourlyPay != 0)
                        {
                            decimal minuteSalary = hourlyPay != 0 ? decimal.Divide(hourlyPay, 60) : decimal.Divide(fallBackHourCost, 60);
                            foreach (var item in transOnDateGroup.Where(w => w.Amount == 0 && w.Quantity != 0))
                            {
                                item.Amount = decimal.Round(decimal.Multiply(item.Quantity, minuteSalary), 2);

                                if (includeEmpTaxAndSuppCharge && item.Amount != 0)
                                {
                                    if (employee != null)
                                    {
                                        if (employment != null)
                                        {
                                            int? payrollGroupId = employment.GetPayrollGroupId(item.Date);
                                            var payrollGroup = payrollGroupId.HasValue ? payrollGroups.FirstOrDefault(f => f.PayrollGroupId == payrollGroupId.Value) : null;
                                            var taxDate = payrollGroupId.HasValue ? PayrollManager.GetPaymentDate(payrollGroup, item.Date) ?? item.Date : item.Date;
                                            birthDate = birthDate ?? DateTime.Today.AddYears(-40);
                                            var taxRate = PayrollManager.GetTaxRate(actorCompanyId, taxDate, birthDate, (int)TermGroup_Languages.Swedish, PayrollManager.GetSysPayrollPriceInterval(actorCompanyId, (int)TermGroup_SysPayrollPrice.SE_EmploymentTax, birthDate.Value.Year, taxDate, (int)TermGroup_Languages.Swedish));
                                            var payrollPrice = PayrollManager.GetSysPayrollPriceInterval(actorCompanyId, (int)TermGroup_SysPayrollPrice.SE_EmploymentTax, birthDate.Value.Year, taxDate, (int)TermGroup_Languages.Swedish);
                                            decimal employmentTaxCost = PayrollManager.CalculateEmploymentTaxSimple(actorCompanyId, taxDate, item.Amount, birthDate, taxRate: taxRate, payrollPrice);
                                            decimal supplementChargeCost = PayrollManager.CalculateSupplementChargeSE(actorCompanyId, taxDate, item.Amount, payrollGroupId, birthDate, payrollPrice, payrollGroupAccountStds);
                                            item.Amount += (employmentTaxCost + supplementChargeCost);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            return dict;
        }
        public Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> AddGrossTimeAndAmount(Dictionary<int, List<TimeEmployeeScheduleDataSmallDTO>> dict, GrossTimeInput input)
        {
            List<GrossTimeRule> grossTimeRules = CreateGrossTimeRules(input);
            if (grossTimeRules.IsNullOrEmpty())
                return dict;

            foreach (var item in dict.Where(i => i.Value != null))
            {
                foreach (var blocksOnDate in item.Value.GroupBy(g => g.Date))
                {
                    foreach (var block in blocksOnDate.Where(w => !w.IsBreak))
                    {
                        var grossTimeRulesOnDate = grossTimeRules.Where(f => f.EmployeeeGroupId == block.EmployeeGroupId && f.Date == block.Date && CalendarUtility.GetOverlappingMinutes(f.StartTime, f.StopTime, CalendarUtility.MergeDateAndTime(block.Date, block.StartTime), CalendarUtility.MergeDateAndTime(block.Date, block.StopTime)) > 0);
                        decimal roundings = 0;
                        decimal grossQuantity = 0;
                        decimal grossAmount = 0;

                        foreach (var grossTimeRuleOnDate in grossTimeRulesOnDate)
                        {
                            if (grossTimeRuleOnDate != null && grossTimeRuleOnDate.ValidForScheduleType(block.ScheduleTypeId))
                            {
                                var overlappingMinutes = CalendarUtility.GetOverlappingMinutes(grossTimeRuleOnDate.StartTime, grossTimeRuleOnDate.StopTime, CalendarUtility.MergeDateAndTime(block.Date, block.StartTime), CalendarUtility.MergeDateAndTime(block.Date, block.StopTime));
                                var addedGrossQuantity = grossTimeRuleOnDate.GetAddedGrossMinutes(CalendarUtility.MergeDateAndTime(block.Date, block.StartTime), CalendarUtility.MergeDateAndTime(block.Date, block.StopTime));
                                var addedGrossAmount = grossTimeRuleOnDate.GetAddedGrossQuantity(CalendarUtility.MergeDateAndTime(block.Date, block.StartTime), CalendarUtility.MergeDateAndTime(block.Date, block.StopTime), block.Amount);
                                block.GrossAmount = (block.GrossAmount != 0 ? block.GrossAmount : block.Amount) + addedGrossAmount;
                                block.GrossQuantity = (block.GrossQuantity != 0 ? block.GrossQuantity : block.Quantity) + addedGrossQuantity;
                                block.GrossTimeRules = block.GrossTimeRules ?? new List<GrossTimeRule>();
                                block.GrossTimeRules.Add(grossTimeRuleOnDate);

                                block.GrossTimeCalcs.Add(new GrossTimeCalc()
                                {
                                    AddedOverlappingMinutes = overlappingMinutes,
                                    AddedGrossQuantity = addedGrossQuantity,
                                    AddedGrossAmount = addedGrossAmount,
                                    Rule = grossTimeRuleOnDate
                                });
                            }

                            grossQuantity += block.GrossQuantity;
                            grossAmount += block.GrossAmount;
                        }

                        roundings += Math.Round(block.GrossQuantity - Math.Round(Math.Round(block.GrossQuantity, 2), 0), 2);
                        block.GrossQuantity = Math.Round(block.GrossQuantity, 0);

                        if (block.GrossQuantity == 0 && block.Quantity != 0)
                            block.GrossQuantity = block.Quantity;

                        if (block.GrossAmount == 0 && block.Amount != 0)
                            block.GrossAmount = block.Amount;

                        if (roundings != 0 && grossAmount != 0 && grossQuantity != 0)
                        {
                            block.GrossAmount = block.GrossAmount + (decimal.Multiply(grossAmount, decimal.Divide(roundings, grossQuantity))); //Adjusting amount if Quantity has been rounded.
                        }
                    }
                }
            }

            return dict;
        }

        private List<GrossTimeRule> CreateGrossTimeRules(GrossTimeInput input)
        {
            if (input.StartDate > input.StopDate)
                return new List<GrossTimeRule>();

            List<TimeRuleIwhDTO> timeRulesIwh = TimeRuleManager.GetAllTimeRulesRecursive(input.ActorCompanyId, onlyIwh: true).ToIwhDTOs().ToList();
            if (timeRulesIwh.IsNullOrEmpty())
                return new List<GrossTimeRule>();

            List<GrossTimeRule> grossTimeRules = new List<GrossTimeRule>();

            List<DayType> dayTypes = CalendarManager.GetDayTypesByCompany(input.ActorCompanyId);
            List<HolidayDTO> companyHolidays = CalendarManager.GetHolidaysByCompany(input.ActorCompanyId, loadDayType: true);
            List<EmployeeGroup> employeeGroups = EmployeeManager.GetEmployeeGroups(input.ActorCompanyId, loadTimeDeviationCauseMappings: true, loadTimeDeviationCauses: true, loadDayTypes: true);

            foreach (var timeRuleGroupOnEmployeeGroupId in timeRulesIwh.GroupBy(g => g.EmployeeGroupIds.ToList()))
            {
                foreach (var employeeGroupId in timeRuleGroupOnEmployeeGroupId.Key)
                {
                    EmployeeGroup employeeGroup = employeeGroups.FirstOrDefault(f => f.EmployeeGroupId == employeeGroupId);
                    if (employeeGroup == null)
                        continue;

                    List<TimeRuleIwhDTO> iwhRules = timeRuleGroupOnEmployeeGroupId.ToList();
                    if (iwhRules.IsNullOrEmpty())
                        continue;

                    foreach (TimeRuleIwhDTO iwhRule in iwhRules)
                    {
                        DateTime currentDate = input.StartDate.Date;
                        while (currentDate < input.StopDate)
                        {
                            DayType dayType = CalendarManager.GetDayType(currentDate, employeeGroup, companyHolidays, dayTypes);
                            if (dayType != null && iwhRule.DayTypeIds.Contains(dayType.DayTypeId) && iwhRule.IsDateValid(currentDate))
                            {
                                DateTime currentstopDateAdjusted = currentDate;
                                if (iwhRule.StopTime.Date == CalendarUtility.DATETIME_DEFAULT.AddDays(1))
                                    currentstopDateAdjusted = currentDate.AddDays(1);

                                DateTime currentstartDateAdjusted = currentDate;
                                if (iwhRule.StartTime.Date == CalendarUtility.DATETIME_DEFAULT.AddDays(-1))
                                    currentstartDateAdjusted = currentDate.AddDays(-1);

                                GrossTimeRule grossTimeRule = new GrossTimeRule()
                                {
                                    TimeRuleId = iwhRule.TimeRuleId,
                                    EmployeeeGroupId = employeeGroupId.Value,
                                    TimeScheduleTypeIds = iwhRule.TimeScheduleTypeIds,

                                    Date = currentDate,
                                    StartTime = CalendarUtility.MergeDateAndTime(currentstartDateAdjusted, iwhRule.StartTime),
                                    StopTime = CalendarUtility.MergeDateAndTime(currentstopDateAdjusted, iwhRule.StopTime),
                                    Factor = iwhRule.PayrollProductFactor,
                                    ExternalCode = iwhRule.PayrollProductExternalCode,
                                };

                                if (!grossTimeRules.Any(a => a.Equals(grossTimeRule)))
                                    grossTimeRules.Add(grossTimeRule);
                            }

                            currentDate = currentDate.AddDays(1);
                        }
                    }
                }
            }

            return grossTimeRules;
        }

        public ActionResult ValidatePossibleDeleteOfEmployeeAccount(DateTime fromDate, DateTime? toDate, int employeeAccountId, int employeeId)
        {
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            EmployeeAccount employeeAccount = entitiesReadOnly.EmployeeAccount.FirstOrDefault(f => f.EmployeeAccountId == employeeAccountId); //Fetch no matter state or date
            if (!toDate.HasValue)
            {
                EmployeeSchedule lastActivation = entitiesReadOnly.EmployeeSchedule.Where(e => e.EmployeeId == employeeId && e.State == (int)SoeEntityState.Active).OrderByDescending(e => e.StopDate).FirstOrDefault();
                if (lastActivation != null)
                    toDate = lastActivation.StopDate;
                else
                    toDate = DateTime.MaxValue;

                if (fromDate > toDate.Value)
                    fromDate = toDate.Value;
            }

            if (employeeAccount == null)
                return new ActionResult(false, 2213, "Employee account not found");

            //Validate if fromDate and toDate is within the interval of the employee account, DateTo on employeeAccount could be null
            // This might happen if the user change the date multiple times
            if (CalendarUtility.GetOverlappingMinutes(fromDate, toDate.Value, employeeAccount.DateFrom, employeeAccount.DateTo ?? DateTime.MaxValue) == 0)
                return new ActionResult(true);
            //return new ActionResult(false, 2219, "Incorrect Request, EmployeeAccount is not in interval");

            if (employeeAccount.EmployeeId != employeeId)
                return new ActionResult(false, 2214, "Employee account does not belong to employee");

            AccountDim defaultAccountDim = AccountManager.GetDefaultEmployeeAccountDim(base.ActorCompanyId);

            if (defaultAccountDim == null)
                return new ActionResult(false, 2215, "Default account dim not found");

            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            int dimOnAccountId = base.GetAccountDimIdOnAccountFromCache(entities, base.ActorCompanyId, employeeAccount.AccountId.Value);
            if (dimOnAccountId == 0)
                return new ActionResult(false, 2216, "Account dim not found on account");

            if (dimOnAccountId == defaultAccountDim.AccountDimId)
            {
                List<TimeScheduleTemplateBlock> blocks = GetShifts(employeeId, CalendarUtility.GetDates(fromDate, toDate == DateTime.MaxValue ? DateTime.Today.AddYears(1) : toDate));

                if (blocks.Any(a => a.AccountId.HasValue && a.AccountId.Value == employeeAccount.AccountId))
                    return new ActionResult(false, 2217, "Employee account is used in time schedule template blocks");
            }

            return new ActionResult(true);
            //return new ActionResult(false, 2218, $"Validation could not be done in interval {CalendarUtility.ToShortDateString(fromDate)}-{CalendarUtility.ToShortDateString(toDate)}");
        }

        #endregion

        #region TimeLeisureCode

        public List<TimeLeisureCode> GetTimeLeisureCodes(int actorCompanyId, int? timeLeisureCodeId = null, bool setTypeNames = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeLeisureCode.NoTracking();
            return GetTimeLeisureCodes(entities, actorCompanyId, timeLeisureCodeId, setTypeNames);
        }

        public List<TimeLeisureCode> GetTimeLeisureCodes(CompEntities entities, int actorCompanyId, int? timeLeisureCodeId = null, bool setTypeNames = false)
        {
            IQueryable<TimeLeisureCode> query = entities.TimeLeisureCode;

            List<TimeLeisureCode> timeLeisureCodes = (from t in query
                                                      where t.ActorCompanyId == actorCompanyId &&
                                                      t.State == (int)SoeEntityState.Active
                                                      select t).ToList();

            if (timeLeisureCodeId.HasValue)
                timeLeisureCodes = timeLeisureCodes.Where(t => t.TimeLeisureCodeId == timeLeisureCodeId).ToList();

            if (setTypeNames)
                SetTimeLeisureCodeTypeName(timeLeisureCodes);

            return timeLeisureCodes.OrderBy(t => t.Name).ToList();
        }

        public Dictionary<int, string> GetTimeLeisureCodesDict(int actorCompanyId, bool addEmptyRow)
        {
            Dictionary<int, string> dict = new Dictionary<int, string>();
            if (addEmptyRow)
                dict.Add(0, String.Empty);

            List<TimeLeisureCode> codes = GetTimeLeisureCodes(actorCompanyId);
            foreach (TimeLeisureCode code in codes)
            {
                dict.Add(code.TimeLeisureCodeId, code.Name);
            }

            return dict;
        }

        public TimeLeisureCode GetTimeLeisureCode(int timeLeisureCodeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.TimeLeisureCode.NoTracking();
            return GetTimeLeisureCode(entities, timeLeisureCodeId);
        }

        public TimeLeisureCode GetTimeLeisureCode(CompEntities entities, int timeLeisureCodeId)
        {
            IQueryable<TimeLeisureCode> query = entities.TimeLeisureCode;

            return (from t in query
                    where t.TimeLeisureCodeId == timeLeisureCodeId
                    select t).FirstOrDefault();
        }

        public ActionResult SaveTimeLeisureCode(TimeLeisureCodeDTO timeLeisureCodeInput, int actorCompanyId)
        {
            if (timeLeisureCodeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "TimeLeisureCode");

            ActionResult result = null;

            int timeLeisureCodeId = timeLeisureCodeInput.TimeLeisureCodeId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region TimeLeisureCode

                        // Get existing leisure code
                        TimeLeisureCode timeLeisureCode = GetTimeLeisureCode(entities, timeLeisureCodeId);
                        if (timeLeisureCode == null)
                        {
                            #region Add

                            timeLeisureCode = new TimeLeisureCode()
                            {
                                ActorCompanyId = actorCompanyId,
                            };
                            SetCreatedProperties(timeLeisureCode);
                            entities.TimeLeisureCode.AddObject(timeLeisureCode);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(timeLeisureCode);

                            #endregion
                        }

                        #region Set fields

                        timeLeisureCode.Type = (int)timeLeisureCodeInput.Type;
                        timeLeisureCode.Code = timeLeisureCodeInput.Code;
                        timeLeisureCode.Name = timeLeisureCodeInput.Name;
                        timeLeisureCode.Description = timeLeisureCodeInput.Description;
                        timeLeisureCode.State = (int)timeLeisureCodeInput.State;

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            // Commit transaction
                            transaction.Complete();

                            timeLeisureCodeId = timeLeisureCode.TimeLeisureCodeId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        // Set success properties
                        result.IntegerValue = timeLeisureCodeId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteTimeLeisureCode(int timeLeisureCodeId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                // Check relations

                #endregion

                TimeLeisureCode timeLeisureCode = GetTimeLeisureCode(entities, timeLeisureCodeId);
                if (timeLeisureCode == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "TimeLeisureCode");

                ActionResult result = ChangeEntityState(entities, timeLeisureCode, SoeEntityState.Deleted, true);

                return result;
            }
        }

        private void SetTimeLeisureCodeTypeName(List<TimeLeisureCode> timeLeisureCodes)
        {
            List<GenericType> terms = base.GetTermGroupContent(TermGroup.TimeLeisureCodeType, skipUnknown: true);
            foreach (TimeLeisureCode timeLeisureCode in timeLeisureCodes)
            {
                GenericType term = terms.FirstOrDefault(i => i.Id == timeLeisureCode.Type);
                if (term != null)
                    timeLeisureCode.TypeName = term.Name;
            }
        }

        #region EmployeeGroupTimeLeisureCode

        public List<EmployeeGroupTimeLeisureCode> GetEmployeeGroupTimeLeisureCodes(int actorCompanyId, int? employeeGroupTimeLeisureCodeId = null, bool includeSettings = false)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeGroupTimeLeisureCode.NoTracking();
            return GetEmployeeGroupTimeLeisureCodes(entities, actorCompanyId, employeeGroupTimeLeisureCodeId, includeSettings);
        }

        public List<EmployeeGroupTimeLeisureCode> GetEmployeeGroupTimeLeisureCodes(CompEntities entities, int actorCompanyId, int? employeeGroupTimeLeisureCodeId = null, bool includeSettings = false)
        {
            IQueryable<EmployeeGroupTimeLeisureCode> query = entities.EmployeeGroupTimeLeisureCode;

            if (includeSettings)
                query = query.Include("EmployeeGroupTimeLeisureCodeSetting");

            List<EmployeeGroupTimeLeisureCode> employeeGroupTimeLeisureCodes = (from t in query
                                                                                .Include("EmployeeGroup")
                                                                                .Include("TimeLeisureCode")
                                                                                where t.State == (int)SoeEntityState.Active
                                                                                select t).ToList();

            employeeGroupTimeLeisureCodes = employeeGroupTimeLeisureCodes.Where(c => c.TimeLeisureCode?.ActorCompanyId == actorCompanyId).ToList();

            if (employeeGroupTimeLeisureCodeId.HasValue)
                employeeGroupTimeLeisureCodes = employeeGroupTimeLeisureCodes.Where(t => t.EmployeeGroupTimeLeisureCodeId == employeeGroupTimeLeisureCodeId).ToList();

            return employeeGroupTimeLeisureCodes.OrderBy(t => t.TimeLeisureCode?.Name).ToList();
        }

        public EmployeeGroupTimeLeisureCode GetEmployeeGroupTimeLeisureCode(int employeeGroupTimeLeisureCodeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeGroupTimeLeisureCode.NoTracking();
            return GetEmployeeGroupTimeLeisureCode(entities, employeeGroupTimeLeisureCodeId);
        }

        public EmployeeGroupTimeLeisureCode GetEmployeeGroupTimeLeisureCode(CompEntities entities, int employeeGroupTimeLeisureCodeId)
        {
            EmployeeGroupTimeLeisureCode employeeGroupTimeLeisureCode = (from t in entities.EmployeeGroupTimeLeisureCode
                                                                                .Include("EmployeeGroup")
                                                                                .Include("TimeLeisureCode")
                                                                                .Include("EmployeeGroupTimeLeisureCodeSetting")
                                                                         where t.EmployeeGroupTimeLeisureCodeId == employeeGroupTimeLeisureCodeId
                                                                         select t).FirstOrDefault();

            if (employeeGroupTimeLeisureCode != null)
                SetEmployeeGroupTimeLeisureCodeSettingTypeName(employeeGroupTimeLeisureCode);

            return employeeGroupTimeLeisureCode;
        }

        public ActionResult SaveEmployeeGroupTimeLeisureCode(EmployeeGroupTimeLeisureCodeDTO employeeGroupTimeLeisureCodeInput)
        {
            if (employeeGroupTimeLeisureCodeInput == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EmployeeGroupTimeLeisureCode");

            ActionResult result = null;

            int employeeGroupTimeLeisureCodeId = employeeGroupTimeLeisureCodeInput.EmployeeGroupTimeLeisureCodeId;

            using (CompEntities entities = new CompEntities())
            {
                try
                {
                    entities.Connection.Open();

                    using (TransactionScope transaction = new TransactionScope(ConfigSettings.TRANSACTIONSCOPEOPTION_DEFAULT, ConfigSettings.TRANSACTIONOPTION_DEFAULT))
                    {
                        #region EmployeeGroupTimeLeisureCode

                        // Get existing leisure code mapping
                        EmployeeGroupTimeLeisureCode employeeGroupTimeLeisureCode = GetEmployeeGroupTimeLeisureCode(entities, employeeGroupTimeLeisureCodeId);
                        if (employeeGroupTimeLeisureCode == null)
                        {
                            #region Add

                            employeeGroupTimeLeisureCode = new EmployeeGroupTimeLeisureCode();
                            SetCreatedProperties(employeeGroupTimeLeisureCode);
                            entities.EmployeeGroupTimeLeisureCode.AddObject(employeeGroupTimeLeisureCode);

                            #endregion
                        }
                        else
                        {
                            #region Update

                            SetModifiedProperties(employeeGroupTimeLeisureCode);

                            #endregion
                        }

                        #region Set fields

                        employeeGroupTimeLeisureCode.EmployeeGroupId = employeeGroupTimeLeisureCodeInput.EmployeeGroupId == 0 ? null : employeeGroupTimeLeisureCodeInput.EmployeeGroupId;
                        employeeGroupTimeLeisureCode.TimeLeisureCodeId = employeeGroupTimeLeisureCodeInput.TimeLeisureCodeId;
                        employeeGroupTimeLeisureCode.DateFrom = employeeGroupTimeLeisureCodeInput.DateFrom;
                        employeeGroupTimeLeisureCode.State = (int)employeeGroupTimeLeisureCodeInput.State;

                        #endregion

                        #region EmployeeGroupTimeLeisureCodeSetting

                        List<EmployeeGroupTimeLeisureCodeSetting> existingSettings = employeeGroupTimeLeisureCode.EmployeeGroupTimeLeisureCodeId > 0 ? employeeGroupTimeLeisureCode.EmployeeGroupTimeLeisureCodeSetting.Where(r => r.State == (int)SoeEntityState.Active).ToList() : new List<EmployeeGroupTimeLeisureCodeSetting>();

                        #region Delete settings that exists in db but not in input.

                        if (existingSettings != null)
                        {
                            foreach (EmployeeGroupTimeLeisureCodeSetting existingSetting in existingSettings)
                            {
                                if (!employeeGroupTimeLeisureCodeInput.Settings.Any(r => r.EmployeeGroupTimeLeisureCodeSettingId == existingSetting.EmployeeGroupTimeLeisureCodeSettingId))
                                    ChangeEntityState(existingSetting, SoeEntityState.Deleted);
                            }
                        }

                        #endregion

                        #region Add/update settings

                        foreach (EmployeeGroupTimeLeisureCodeSettingDTO settingInput in employeeGroupTimeLeisureCodeInput.Settings ?? new List<EmployeeGroupTimeLeisureCodeSettingDTO>())
                        {
                            EmployeeGroupTimeLeisureCodeSetting existingSetting = existingSettings != null ? existingSettings.FirstOrDefault(r => r.EmployeeGroupTimeLeisureCodeSettingId != 0 && r.EmployeeGroupTimeLeisureCodeSettingId == settingInput.EmployeeGroupTimeLeisureCodeSettingId) : null;
                            if (existingSetting == null)
                            {
                                existingSetting = new EmployeeGroupTimeLeisureCodeSetting()
                                {
                                    EmployeeGroupTimeLeisureCode = employeeGroupTimeLeisureCode,
                                    State = (int)SoeEntityState.Active,
                                };
                                SetCreatedProperties(existingSetting);
                                entities.AddObject("EmployeeGroupTimeLeisureCodeSetting", existingSetting);
                                existingSettings.Add(existingSetting);
                            }
                            else
                            {
                                SetModifiedProperties(existingSetting);
                            }

                            #region Common

                            existingSetting.Type = (int)settingInput.Type;
                            existingSetting.DataType = (int)settingInput.DataType;
                            existingSetting.Name = settingInput.Name;
                            existingSetting.StrData = settingInput.StrData;
                            existingSetting.IntData = settingInput.IntData;
                            existingSetting.DecimalData = settingInput.DecimalData;
                            existingSetting.BoolData = settingInput.BoolData;
                            existingSetting.DateData = settingInput.DateData;
                            existingSetting.TimeData = settingInput.TimeData;

                            #endregion
                        }

                        #endregion

                        #endregion

                        #endregion

                        result = SaveChanges(entities, transaction);
                        if (result.Success)
                        {
                            // Commit transaction
                            transaction.Complete();

                            employeeGroupTimeLeisureCodeId = employeeGroupTimeLeisureCode.EmployeeGroupTimeLeisureCodeId;
                        }
                    }
                }
                catch (Exception ex)
                {
                    base.LogError(ex, this.log);
                    result = new ActionResult(ex);
                }
                finally
                {
                    if (result != null && result.Success)
                    {
                        // Set success properties
                        result.IntegerValue = employeeGroupTimeLeisureCodeId;
                    }
                    else
                        base.LogTransactionFailed(this.ToString(), this.log);

                    entities.Connection.Close();
                }

                return result;
            }
        }

        public ActionResult DeleteEmployeeGroupTimeLeisureCode(int employeeGroupTimeLeisureCodeId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                // Check relations

                #endregion

                EmployeeGroupTimeLeisureCode employeeGroupTimeLeisureCode = GetEmployeeGroupTimeLeisureCode(entities, employeeGroupTimeLeisureCodeId);
                if (employeeGroupTimeLeisureCode == null)
                    return new ActionResult((int)ActionResultDelete.EntityNotFound, "EmployeeGroupTimeLeisureCode");

                ActionResult result = ChangeEntityState(entities, employeeGroupTimeLeisureCode, SoeEntityState.Deleted, true);

                return result;
            }
        }

        private void SetEmployeeGroupTimeLeisureCodeSettingTypeName(EmployeeGroupTimeLeisureCode employeeGroupTimeLeisureCode)
        {
            List<GenericType> terms = base.GetTermGroupContent(TermGroup.TimeLeisureCodeSettingType, skipUnknown: true);
            foreach (EmployeeGroupTimeLeisureCodeSetting employeeGroupTimeLeisureCodeSetting in employeeGroupTimeLeisureCode.EmployeeGroupTimeLeisureCodeSetting)
            {
                GenericType term = terms.FirstOrDefault(i => i.Id == employeeGroupTimeLeisureCodeSetting.Type);
                if (term != null)
                    employeeGroupTimeLeisureCodeSetting.TypeName = term.Name;
            }
        }

        #endregion

        #region EmployeeGroupTimeLeisureCodeSetting

        public List<EmployeeGroupTimeLeisureCodeSetting> GetEmployeeGroupTimeLeisureCodeSettings(int employeeGroupTimeLeisureCodeId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            entities.EmployeeGroupTimeLeisureCode.NoTracking();
            return GetEmployeeGroupTimeLeisureCodeSettings(entities, employeeGroupTimeLeisureCodeId);
        }

        List<EmployeeGroupTimeLeisureCodeSetting> GetEmployeeGroupTimeLeisureCodeSettings(CompEntities entities, int employeeGroupTimeLeisureCodeId)
        {
            int langId = GetLangId();
            Dictionary<int, string> settingTypeDict = base.GetTermGroupDict(TermGroup.TimeLeisureCodeSettingType, langId);
            List<EmployeeGroupTimeLeisureCodeSetting> settingsList;

            settingsList = (from t in entities.EmployeeGroupTimeLeisureCodeSetting
                            where t.EmployeeGroupTimeLeisureCodeId == employeeGroupTimeLeisureCodeId &&
                            t.State == (int)SoeEntityState.Active
                            select t).ToList();


            foreach (EmployeeGroupTimeLeisureCodeSetting setting in settingsList)
            {
                setting.Name = GetValueFromDict(setting.Type, settingTypeDict);
            }

            return settingsList;
        }

        #endregion

        #region Automatic Allocation

        public ActionResult AllocateLeisureDaysDelete(int actorCompanyId, List<int> employeeIds, DateTime startDate, DateTime stopDate)
        {
            // Delete existing Leisure Codes
            return ResetTimeScheduleEmployeePeriodDetailsValue(employeeIds, startDate, stopDate, actorCompanyId, SoeTimeScheduleEmployeePeriodDetailType.LeisureCode);
        }

        public AutomaticAllocationResultDTO AllocateLeisureDays(int actorCompanyId, List<int> employeeIds, DateTime startDate, DateTime stopDate)
        {
            AutomaticAllocationResultDTO result = new AutomaticAllocationResultDTO();
            var employees = EmployeeManager.GetEmployees(actorCompanyId, employeeIds, loadEmployment: true, loadContactPerson: true);
            var shifts = GetTimeEmployeeScheduleSmallDTODictForReport(startDate, stopDate, employees, actorCompanyId, RoleId);
            var employeeGroupLeisureCodes = GetEmployeeGroupTimeLeisureCodes(actorCompanyId, includeSettings: true);
            var employeeGroups = EmployeeManager.GetEmployeeGroups(actorCompanyId);
            List<AutomaticAllocationEmployee> automaticAllocationEmployees = new List<AutomaticAllocationEmployee>();
            List<AutomaticAllocationLeisureCode> automaticAllocationLeisureCodes = new List<AutomaticAllocationLeisureCode>();

            // Delete existing Leisure Codes
            ActionResult deleteResult = AllocateLeisureDaysDelete(actorCompanyId, employeeIds, startDate, stopDate);
            if (!deleteResult.Success)
            {
                result.Success = false;
                result.Message = "Delete failed";
                return result;
            }

            // make sure to pick the latest valid for each type and employeeGroup according to startDate
            var validEmployeeGroupLeisureCodes = employeeGroupLeisureCodes
            .Where(x => x.DateFrom <= startDate)
            .GroupBy(x => $"{x.TimeLeisureCode.Type}-{x.EmployeeGroupId}")
            .Select(group => group
                .OrderByDescending(x => x.DateFrom)
                .First())
            .ToList();

            foreach (var leisureCode in validEmployeeGroupLeisureCodes.Where(w => w.ActiveSettings != null))
            {
                foreach (var employeeGroup in employeeGroups)
                {
                    if ((!leisureCode.EmployeeGroupId.HasValue || leisureCode.EmployeeGroupId == employeeGroup.EmployeeGroupId) && !automaticAllocationLeisureCodes.Any(c => c.EmployeeGroupId == leisureCode.EmployeeGroupId && (int)c.Type == leisureCode.TimeLeisureCode.Type))
                    {
                        var preferredWeekDay = leisureCode.ActiveSettings.FirstOrDefault(f => f.Type == (int)TermGroup_TimeLeisureCodeSettingType.PreferredWeekDay)?.IntData;
                        var leisureHours = leisureCode.ActiveSettings.FirstOrDefault(f => f.Type == (int)TermGroup_TimeLeisureCodeSettingType.LeisureHours)?.DecimalData;
                        var type = (TermGroup_TimeLeisureCodeType)leisureCode.TimeLeisureCode.Type;
                        AutomaticAllocationLeisureCode automaticAllocationLeisureCode = new AutomaticAllocationLeisureCode()
                        {
                            TimeLeisureCodeId = leisureCode.TimeLeisureCodeId,
                            ActorCompanyId = actorCompanyId,
                            EmployeeGroupId = leisureCode.EmployeeGroupId,
                            Code = leisureCode.TimeLeisureCode.Code,
                            Type = type == TermGroup_TimeLeisureCodeType.V ? LeisureCodeType.V : LeisureCodeType.X
                        };

                        if (preferredWeekDay.HasValue)
                            automaticAllocationLeisureCode.PreferredDay = (DayOfWeek)preferredWeekDay;

                        if (leisureHours.HasValue)
                            automaticAllocationLeisureCode.LeisureHour = leisureHours.Value;

                        automaticAllocationLeisureCodes.Add(automaticAllocationLeisureCode);
                    }
                }
            }

            foreach (var employee in employees)
            {
                if (!shifts.TryGetValue(employee.EmployeeId, out List<TimeEmployeeScheduleDataSmallDTO> employeeShifts))
                    continue;

                var employeeGroupId = employee.GetEmployeeGroupId(startDate);

                AutomaticAllocationEmployee automaticAllocationEmployee = new AutomaticAllocationEmployee()
                {
                    EmployeeName = employee.NumberAndName,
                    EmployeeId = employee.EmployeeId,
                    EmployeeGroupId = employeeGroupId
                };

                foreach (var weekGroup in employeeShifts.GroupBy(g => CalendarUtility.GetFirstDateOfWeek(g.Date, offset: DayOfWeek.Monday)))
                {
                    AutomaticAllocationEmployeeWeek week = new AutomaticAllocationEmployeeWeek() { Monday = weekGroup.Key, };

                    foreach (var shift in weekGroup.GroupBy(g => g.Date))
                    {
                        var date = shift.First().Date;
                        var firstStart = CalendarUtility.MergeDateAndDefaultTime(date, shift.Min(m => m.StartTime), true);
                        var lastStop = CalendarUtility.MergeDateAndDefaultTime(date, shift.Max(m => m.StopTime), true);
                        AutomaticAllocationEmployeeDay automaticAllocationEmployeeDay = new AutomaticAllocationEmployeeDay()
                        {
                            Date = date,
                            StartTime = firstStart,
                            StopTime = lastStop,
                            HasOtherAbsence = shift.Where(w => !w.IsBreak).All(a => a.TimeDeviationCauseId.HasValue)
                        };

                        week.EmployeeDays.Add(automaticAllocationEmployeeDay);
                    }
                    automaticAllocationEmployee.AllocationEmployeeWeeks.Add(week);
                }

                automaticAllocationEmployees.Add(automaticAllocationEmployee);
            }

            AutomaticAllocationRunner runner = new AutomaticAllocationRunner(automaticAllocationEmployees, automaticAllocationLeisureCodes);
            var output = runner.Run();

            using (CompEntities entities = new CompEntities())
            {
                foreach (var e in output.Employees)
                {
                    List<LeisureCodeAllocationWeekInvalidation> weekInvalidations = new List<LeisureCodeAllocationWeekInvalidation>();
                    AutomaticAllocationEmployeeResultDTO automaticAllocationEmployeeResultDTO = new AutomaticAllocationEmployeeResultDTO()
                    {
                        EmployeeId = e.EmployeeId
                    };

                    var employee = employees.FirstOrDefault(f => f.EmployeeId == e.EmployeeId);
                    if (employee != null)
                    {
                        foreach (var weekOutput in e.AllocationEmployeeWeekOutputs)
                        {
                            if (weekOutput.WeekInvalidations.Any())
                                weekInvalidations.AddRange(weekOutput.WeekInvalidations);

                            foreach (var dayOutput in weekOutput.EmployeeDays)
                            {
                                if (dayOutput != null)
                                {
                                    AutomaticAllocationEmployeeDayResultDTO dayResult = new AutomaticAllocationEmployeeDayResultDTO()
                                    {
                                        Date = dayOutput.Date,
                                        Success = true,
                                    };
                                    automaticAllocationEmployeeResultDTO.DayResults.Add(dayResult);

                                    var detail = GetTimeScheduleEmployeePeriodDetail(entities, e.EmployeeId, dayOutput.Date, actorCompanyId, SoeTimeScheduleEmployeePeriodDetailType.LeisureCode);

                                    if (detail == null)
                                    {
                                        TimeScheduleEmployeePeriod period = CreateTimeScheduleEmployeePeriodIfNotExist(entities, actorCompanyId, dayOutput.Date, e.EmployeeId);
                                        detail = new TimeScheduleEmployeePeriodDetail()
                                        {
                                            TimeScheduleEmployeePeriod = period,
                                            Type = (int)SoeTimeScheduleEmployeePeriodDetailType.LeisureCode,
                                            TimeLeisureCodeId = dayOutput.LeisureCode.TimeLeisureCodeId,
                                        };
                                        SetCreatedProperties(detail);
                                        entities.TimeScheduleEmployeePeriodDetail.AddObject(detail);
                                    }
                                    else
                                    {
                                        detail.TimeLeisureCodeId = dayOutput.LeisureCode.TimeLeisureCodeId;
                                        SetModifiedProperties(detail);
                                    }
                                }
                            }
                        }

                        // no days needed to allocate - return information
                        if (e.AllocationEmployeeWeekOutputs.All(w => w.WeekInvalidations.Contains(LeisureCodeAllocationWeekInvalidation.WeekHasToFewWorkDays)))
                        {
                            automaticAllocationEmployeeResultDTO.Status = LeisureCodeAllocationEmployeeStatus.ProcessedWithInformation;
                            automaticAllocationEmployeeResultDTO.Message = GetText(13120, "Inga fridagar behöver placeras");
                        }
                        else
                        {
                            var allSuccess = e.AllocationEmployeeWeekOutputs.All(a => a.Success);
                            var partialSuccess = e.AllocationEmployeeWeekOutputs.Any(a => a.Success);

                            if (allSuccess)
                                automaticAllocationEmployeeResultDTO.Status = LeisureCodeAllocationEmployeeStatus.AllSuccess;
                            else if (partialSuccess)
                                automaticAllocationEmployeeResultDTO.Status = LeisureCodeAllocationEmployeeStatus.PartialSuccess;
                            else
                                automaticAllocationEmployeeResultDTO.Status = LeisureCodeAllocationEmployeeStatus.AllFailed;

                            var sb = new StringBuilder();

                            if (e.AllocationEmployeeWeekOutputs.Any(w => w.WeekInvalidations.Contains(LeisureCodeAllocationWeekInvalidation.WeekHasToFewWorkDays)))
                                sb.AppendLine(GetText(13121, "Veckan har för få arbetsdagar och berättigar ej till någon fridag"));

                            if (e.AllocationEmployeeWeekOutputs.Any(w => w.WeekInvalidations.Contains(LeisureCodeAllocationWeekInvalidation.WeekHasNoDaysToAllocateTo)))
                                sb.AppendLine(GetText(13122, "Veckan saknar dag att placera fridag på"));

                            if (e.AllocationEmployeeWeekOutputs.Any(w => w.WeekInvalidations.Contains(LeisureCodeAllocationWeekInvalidation.UnassignedAllocationsLeft)))
                                sb.AppendLine(GetText(13123, "Det finns berättigade fridagar på perioden som ej får plats"));

                            automaticAllocationEmployeeResultDTO.Message = sb.ToString();
                        }
                    }
                    SaveChanges(entities);
                    result.EmployeeResults.Add(automaticAllocationEmployeeResultDTO);
                }
            }

            return result;
        }

        #endregion

        #endregion

        #region TrackChangesLogDTO

        private List<TrackChangesLogDTO> ConvertToTrackChangesLogDto(CompEntities entities, List<TimeScheduleTemplateBlock> scheduleblocks, int actorCompanyId)
        {
            #region Prereq

            // Get all required terms            
            List<GenericType> types = base.GetTermGroupContent(TermGroup.ShiftHistoryType);
            List<GenericType> answers = base.GetTermGroupContent(TermGroup.YesNo);
            List<GenericType> shiftStatuses = base.GetTermGroupContent(TermGroup.TimeScheduleEmployeePeriodStatus);
            List<GenericType> shiftUserStatuses = base.GetTermGroupContent(TermGroup.TimeScheduleEmployeePeriodUserStatus);
            List<GenericType> columnTypes = base.GetTermGroupContent(TermGroup.TrackChangesColumnType);
            string noReplacementEmployeeName = GetText(8262, 1);
            GenericType answerYes = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.Yes);
            GenericType answerNo = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.No);


            // Internal employee cache            
            List<Employee> employees = new List<Employee>();
            Employee hiddenEmployee = EmployeeManager.GetHiddenEmployee(entities, actorCompanyId, true);

            // Get all shift types
            Dictionary<int, string> shiftTypes = GetShiftTypesDict(entities, actorCompanyId, false);

            // Get all deviation causes
            Dictionary<int, string> timeDeviationCausesDict = TimeDeviationCauseManager.GetTimeDeviationCausesDict(entities, actorCompanyId, false);

            #endregion

            List<TrackChangesLogDTO> dtos = new List<TrackChangesLogDTO>();

            string shiftIdentity = string.Empty;
            string lastBatch = string.Empty;
            int batchNr = 0;

            foreach (var scheduleblock in scheduleblocks)
            {
                // Shift identity string
                string breakString = scheduleblock.IsBreak ? GetText(5990, "Rast") : "--";
                shiftIdentity = ((scheduleblock.ShiftTypeId.HasValue && shiftTypes.ContainsKey(scheduleblock.ShiftTypeId.Value)) ? shiftTypes[scheduleblock.ShiftTypeId.Value] : breakString)
                    + " " + scheduleblock.StartTime.ToShortTimeString() + " - " + scheduleblock.StopTime.ToShortTimeString();

                foreach (var block in scheduleblock.TimeScheduleTemplateBlockHistory)
                {
                    if (lastBatch != block.BatchId)
                        batchNr++;

                    // Change type description
                    GenericType term = types.FirstOrDefault(t => t.Id == block.Type);
                    if (term == null)
                        term = types.FirstOrDefault(t => t.Id == (int)TermGroup_ShiftHistoryType.Unknown);
                    string actionMethodText = term != null ? term.Name : String.Empty;

                    // Shift statuses
                    string strFromShiftStatus = string.Empty;
                    string strToShiftStatus = string.Empty;

                    if (block.FromShiftStatus.HasValue)
                    {
                        term = shiftStatuses.FirstOrDefault(s => s.Id == block.FromShiftStatus.Value);
                        strFromShiftStatus = term != null ? term.Name : String.Empty;
                    }
                    if (block.ToShiftStatus.HasValue)
                    {
                        term = shiftStatuses.FirstOrDefault(s => s.Id == block.ToShiftStatus.Value);
                        strToShiftStatus = term != null ? term.Name : String.Empty;
                    }
                    if (strFromShiftStatus != strToShiftStatus)
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_ShiftStatus).Name, strFromShiftStatus, strToShiftStatus));
                    }
                    strFromShiftStatus = string.Empty;
                    strToShiftStatus = string.Empty;
                    if (block.FromShiftUserStatus.HasValue)
                    {
                        term = shiftUserStatuses.FirstOrDefault(s => s.Id == block.FromShiftUserStatus.Value);
                        strFromShiftStatus = term != null ? term.Name : String.Empty;
                    }
                    if (block.ToShiftUserStatus.HasValue)
                    {
                        term = shiftUserStatuses.FirstOrDefault(s => s.Id == block.ToShiftUserStatus.Value);
                        strToShiftStatus = term != null ? term.Name : String.Empty;
                    }
                    if (strFromShiftStatus != strToShiftStatus)
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_ShiftUserStatus).Name, strFromShiftStatus, strToShiftStatus));
                    }

                    // Employee
                    string strFromEmployeeNr = string.Empty, strFromEmployeeName = string.Empty, strToEmployeeNr = string.Empty, strToEmployeeName = string.Empty, strOriginEmployeeNr = string.Empty, strOriginEmployeeName = string.Empty;

                    if (block.FromEmployeeId.HasValue)
                    {
                        Employee employee = employees.FirstOrDefault(x => x.EmployeeId == block.FromEmployeeId.Value);
                        if (employee != null)
                        {
                            strFromEmployeeNr = employee.EmployeeNr;
                            strFromEmployeeName = employee.Name;
                        }
                        else
                        {
                            employee = EmployeeManager.GetEmployee(entities, block.FromEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                            if (employee != null)
                            {
                                strFromEmployeeNr = employee.EmployeeNr;
                                strFromEmployeeName = employee.Name;
                                employees.Add(employee);
                            }
                        }
                    }
                    if (block.ToEmployeeId.HasValue)
                    {
                        Employee employee = employees.FirstOrDefault(x => x.EmployeeId == block.ToEmployeeId.Value);
                        if (employee != null)
                        {
                            strToEmployeeNr = employee.EmployeeNr;
                            strToEmployeeName = employee.Name;
                        }
                        else
                        {
                            employee = EmployeeManager.GetEmployee(entities, block.ToEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                            if (employee != null)
                            {
                                strToEmployeeNr = employee.EmployeeNr;
                                strToEmployeeName = employee.Name;
                                employees.Add(employee);
                            }
                        }
                    }
                    if (block.OriginEmployeeId.HasValue)
                    {
                        Employee employee = employees.FirstOrDefault(x => x.EmployeeId == block.OriginEmployeeId.Value);
                        if (employee != null)
                        {
                            strOriginEmployeeNr = employee.EmployeeNr;
                            strOriginEmployeeName = employee.Name;
                        }
                        else
                        {
                            employee = EmployeeManager.GetEmployee(entities, block.OriginEmployeeId.Value, actorCompanyId, loadContactPerson: true, getHidden: true);
                            if (employee != null)
                            {
                                strOriginEmployeeNr = employee.EmployeeNr;
                                strOriginEmployeeName = employee.Name;
                                employees.Add(employee);
                            }
                        }
                    }

                    if (block.OriginEmployeeId.HasValue && !block.FromEmployeeId.HasValue)
                    {
                        strFromEmployeeNr = strOriginEmployeeNr;
                        strFromEmployeeName = strOriginEmployeeName;
                    }

                    if (strFromEmployeeNr != strToEmployeeNr && !strFromEmployeeNr.IsNullOrEmpty())
                    {
                        string strFromEmployeeNrAndName = !strFromEmployeeNr.IsNullOrEmpty() && !strFromEmployeeName.IsNullOrEmpty() ? "(" + strFromEmployeeNr + ") " + strFromEmployeeName : string.Empty;
                        string strToEmployeeNrAndName = !strToEmployeeNr.IsNullOrEmpty() && !strToEmployeeName.IsNullOrEmpty() ? "(" + strToEmployeeNr + ") " + strToEmployeeName : string.Empty;
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_Employee).Name, strFromEmployeeNrAndName, strToEmployeeNrAndName));
                    }

                    // StartTime
                    string strFromStartDateAndTime = string.Empty, strToStartDateAndTime = string.Empty;

                    if (block.FromStart.HasValue)
                        strFromStartDateAndTime = block.FromStart.HasValue ? block.FromStart.Value.ToShortDateShortTimeString() : String.Empty;
                    if (block.ToStart.HasValue)
                        strToStartDateAndTime = block.ToStart.HasValue ? block.ToStart.Value.ToShortDateShortTimeString() : String.Empty;

                    if (strFromStartDateAndTime != strToStartDateAndTime && !strFromStartDateAndTime.IsNullOrEmpty())
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_StartTime).Name, strFromStartDateAndTime, strToStartDateAndTime));
                    }

                    // StopTime
                    string strFromStopDateAndTime = string.Empty, strToStopDateAndTime = string.Empty;

                    if (block.FromStop.HasValue)
                        strFromStopDateAndTime = block.FromStop.HasValue ? block.FromStop.Value.ToShortDateShortTimeString() : String.Empty;
                    if (block.ToStop.HasValue)
                        strToStopDateAndTime = block.ToStop.HasValue ? block.ToStop.Value.ToShortDateShortTimeString() : String.Empty;

                    if (strFromStopDateAndTime != strToStopDateAndTime && !strFromStopDateAndTime.IsNullOrEmpty())
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_StopTime).Name, strFromStopDateAndTime, strToStopDateAndTime));
                    }

                    // Shift type
                    string strFromShiftType = string.Empty, strToShiftType = string.Empty;

                    if (block.FromShiftTypeId.HasValue && shiftTypes.ContainsKey(block.FromShiftTypeId.Value))
                        strFromShiftType = shiftTypes[block.FromShiftTypeId.Value];
                    if (block.ToShiftTypeId.HasValue && shiftTypes.ContainsKey(block.ToShiftTypeId.Value))
                        strToShiftType = shiftTypes[block.ToShiftTypeId.Value];
                    if (strFromShiftType != strToShiftType)
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_ShiftType).Name, strFromShiftType, strToShiftType));
                    }

                    // Deviation causes
                    string strFromTimeDeviationCause = string.Empty, strToTimeDeviationCause = string.Empty;

                    if (block.FromTimeDeviationCauseId.HasValue && timeDeviationCausesDict.ContainsKey(block.FromTimeDeviationCauseId.Value))
                        strFromTimeDeviationCause = timeDeviationCausesDict[block.FromTimeDeviationCauseId.Value];
                    if (block.ToTimeDeviationCauseId.HasValue && timeDeviationCausesDict.ContainsKey(block.ToTimeDeviationCauseId.Value))
                        strToTimeDeviationCause = timeDeviationCausesDict[block.ToTimeDeviationCauseId.Value];
                    if (strFromTimeDeviationCause != strToTimeDeviationCause)
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_TimeDeviationCause).Name, strFromTimeDeviationCause, strToTimeDeviationCause));
                    }

                    //ExtraShift
                    string strFromExtraShift = string.Empty, strToExtraShift = string.Empty;

                    if (answerYes != null && answerNo != null)
                    {
                        if (block.FromExtraShift.HasValue)
                            strFromExtraShift = block.FromExtraShift.Value ? answerYes.Name : answerNo.Name;
                        if (block.ToExtraShift.HasValue)
                            strToExtraShift = block.ToExtraShift.Value ? answerYes.Name : answerNo.Name;
                    }
                    if (block.FromExtraShift != block.ToExtraShift)
                    {
                        dtos.Add(getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(block, actionMethodText, columnTypes.FirstOrDefault(t => t.Id == (int)TermGroup_TrackChangesColumnType.TimeScheduleTemplateBlock_ExtraShift).Name, strFromExtraShift, strToExtraShift));
                    }

                    //AbsenceRequest Specifik

                    //if (block.Type == (int)TermGroup_ShiftHistoryType.AbsenceRequestPlanning)
                    //{
                    //    //Shift has not been approved
                    //    if (!dto.EmployeeChanged && dto.ShiftUserStatusChanged && block.FromShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.AbsenceRequested && block.ToShiftUserStatus == (int)TermGroup_TimeScheduleTemplateBlockShiftUserStatus.Accepted)
                    //    {
                    //        GenericType no = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.No);
                    //        if (no != null)
                    //        {
                    //            dto.AbsenceRequestApprovedText = no != null ? no.Name : String.Empty;
                    //            dto.ToEmployeeName = string.Empty;
                    //            dto.FromEmployeeName = string.Empty;
                    //        }
                    //    }
                    //    else
                    //    {
                    //        GenericType yes = answers.FirstOrDefault(t => t.Id == (int)TermGroup_YesNo.Yes);
                    //        if (yes != null)
                    //            dto.AbsenceRequestApprovedText = yes != null ? yes.Name : String.Empty;
                    //    }
                    //}


                    lastBatch = block.BatchId;
                }
            }

            TrackChangesLogDTO getNewTrackChangesLogDTOFromTimeScheduleTemplateBlock(TimeScheduleTemplateBlockHistory block, string actionMethod, string columnName, string fromValue, string toValue)
            {
                TrackChangesLogDTO dto = new TrackChangesLogDTO()
                {
                    ActionMethodText = actionMethod,
                    Batch = !block.BatchId.IsNullOrEmpty() ? new Guid(block.BatchId) : Guid.Empty,
                    BatchNbr = batchNr,
                    Entity = SoeEntityType.TimeScheduleTemplateBlock,
                    RecordId = block.TimeScheduleTemplateBlockId,
                    ColumnText = columnName,
                    FromValueText = fromValue,
                    ToValueText = toValue,
                    RecordName = shiftIdentity,
                    Created = block.Created,
                    CreatedBy = block.CreatedBy,

                };

                return dto;
            }

            return dtos;
        }

        #endregion

        #region Misc
        public bool UsesWeekendSalary(int actorCompanyId)
        {
            using var entities = CompEntitiesProvider.LeaseReadOnlyContext();
            return UsesWeekendSalary(entities, actorCompanyId);
        }

        protected bool UsesWeekendSalary(CompEntities entities, int actorCompanyId)
        {
            return base.UsesWeekendSalaryFromCache(entities, actorCompanyId);
        }

        private string GetValueFromDict(int? key, Dictionary<int, string> dict)
        {
            if (!key.HasValue || dict.IsNullOrEmpty())
                return string.Empty;

            dict.TryGetValue(key.Value, out string value);
            return value ?? string.Empty;
        }
        #endregion
    }
}


