using CrystalDecisions.Shared;
using Newtonsoft.Json;
using Newtonsoft.Json.Serialization;
using SoftOne.Soe.Business.Core.Reporting;
using SoftOne.Soe.Business.Core.Reporting.Matrix;
using SoftOne.Soe.Business.Core.Reporting.Matrix.Models;
using SoftOne.Soe.Business.Core.RptGen;
using SoftOne.Soe.Business.DataCache;
using SoftOne.Soe.Business.DTO;
using SoftOne.Soe.Business.Util;
using SoftOne.Soe.Business.Util.Config;
using SoftOne.Soe.Business.Util.ExportFiles;
using SoftOne.Soe.Business.Util.Finvoice;
using SoftOne.Soe.Business.Util.LogCollector;
using SoftOne.Soe.Business.Util.QR;
using SoftOne.Soe.Business.Util.WebApiInternal;
using SoftOne.Soe.Common.DTO;
using SoftOne.Soe.Common.DTO.ApiExternal;
using SoftOne.Soe.Common.Util;
using SoftOne.Soe.Data;
using SoftOne.Soe.Util;
using System;
using System.Collections.Generic;
using System.Data;
using System.Globalization;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Xml.Linq;

namespace SoftOne.Soe.Business.Core
{
    public class ReportDataManager : BaseReportDataManager
    {
        #region Manager lazy loader properties

        private BillingReportDataManager billingReportDataManager;
        protected BillingReportDataManager BillingReportDataManager
        {
            get
            {
                return billingReportDataManager ?? (billingReportDataManager = new BillingReportDataManager(parameterObject));
            }
        }

        private EconomyReportDataManager economyReportDataManager;
        protected EconomyReportDataManager EconomyReportDataManager
        {
            get
            {
                return economyReportDataManager ?? (economyReportDataManager = new EconomyReportDataManager(parameterObject));
            }
        }

        #endregion

        #region Ctor

        public ReportDataManager(ParameterObject parameterObject) : base(parameterObject)
        {

        }

        #endregion

        #region Entry point

        public ReportPrintoutDTO PrintEmploymentContractShortSubstitute(int reportId, List<int> employeeIds, List<DateTime> substituteDates)
        {

            ReportJobDefinitionDTO reportJobDefinitionDTO = new ReportJobDefinitionDTO(reportId, SoeReportTemplateType.TimeEmploymentContract, TermGroup_ReportExportType.Pdf);

            EmployeeSelectionDTO employeeSelection = new EmployeeSelectionDTO();
            employeeSelection.Key = "employees";
            employeeSelection.EmployeeIds = employeeIds;
            employeeSelection.IncludeVacant = false;
            employeeSelection.IncludeHidden = false;
            reportJobDefinitionDTO.Selections.Add(employeeSelection);

            DatesSelectionDTO datesSelectionDTO = new DatesSelectionDTO();
            datesSelectionDTO.Dates = substituteDates;
            reportJobDefinitionDTO.Selections.Add(datesSelectionDTO);

            BoolSelectionDTO boolSelectionDTO = new BoolSelectionDTO();
            boolSelectionDTO.Key = "isPrintedFromSchedulePlanning";
            boolSelectionDTO.Value = true;
            reportJobDefinitionDTO.Selections.Add(boolSelectionDTO);

            return ReportDataManager.PrintMigratedReportDTO(reportJobDefinitionDTO, base.ActorCompanyId, base.UserId, base.RoleId, forcePrint: true, skipApiInternal: true);
        }

        public ReportPrintoutDTO PrintTimeEmploymentDynamicContract(int reportId, int employeeId, int employmentId, int employeeTemplateId, List<DateTime> substituteDates, bool isPrintedFromSchedulePlanning)
        {
            ReportJobDefinitionDTO reportJobDefinitionDTO = new ReportJobDefinitionDTO(reportId, SoeReportTemplateType.TimeEmploymentDynamicContract, TermGroup_ReportExportType.Pdf);
            reportJobDefinitionDTO.SetLang(GetLangId());
            reportJobDefinitionDTO.LangId = GetLangId();

            EmployeeSelectionDTO employeeSelection = new EmployeeSelectionDTO();
            employeeSelection.Key = "employees";
            employeeSelection.IncludeHidden = false;
            employeeSelection.IncludeVacant = false;
            employeeSelection.EmployeeIds = new List<int> { employeeId };
            reportJobDefinitionDTO.Selections.Add(employeeSelection);

            IdSelectionDTO employmentIdSelection = new IdSelectionDTO(employmentId, "employmentId");
            reportJobDefinitionDTO.Selections.Add(employmentIdSelection);

            DateSelectionDTO dateSelectionDTO = new DateSelectionDTO();
            dateSelectionDTO.Date = substituteDates.FirstOrDefault();
            reportJobDefinitionDTO.Selections.Add(dateSelectionDTO);

            DatesSelectionDTO datesSelectionDTO = new DatesSelectionDTO();
            datesSelectionDTO.Dates = substituteDates;
            reportJobDefinitionDTO.Selections.Add(datesSelectionDTO);

            BoolSelectionDTO boolSelectionDTO = new BoolSelectionDTO();
            boolSelectionDTO.Key = "isPrintedFromSchedulePlanning";
            boolSelectionDTO.Value = isPrintedFromSchedulePlanning;
            reportJobDefinitionDTO.Selections.Add(boolSelectionDTO);

            IdSelectionDTO employeeTemplateIdSelection = new IdSelectionDTO(employeeTemplateId, "employeeTemplateId");
            reportJobDefinitionDTO.Selections.Add(employeeTemplateIdSelection);

            return ReportDataManager.PrintMigratedReportDTO(reportJobDefinitionDTO, base.ActorCompanyId, base.UserId, base.RoleId, forcePrint: true, skipApiInternal: true);
        }

        public ReportPrintoutDTO PrintPayrollSlipData(int reportId, int employeeId, int timePeriodId, bool isPreliminary)
        {
            ReportJobDefinitionDTO jobdefinition = TimeReportDataManager.CreateReportJobDefinitionDTO(reportId, SoeReportTemplateType.PayrollSlip, TermGroup_ReportExportType.Pdf, new List<int>() { timePeriodId }, new List<int>() { employeeId });
            return ReportDataManager.PrintMigratedReportDTO(jobdefinition, base.ActorCompanyId, base.UserId, base.RoleId, forcePrint: true, skipApiInternal: true, isPreliminary: isPreliminary);
        }

        #region Report

        public int PrintReportId(EvaluatedSelection es)
        {
            ReportPrintoutDTO dto = PrintReportDTO(es);
            return dto?.ReportPrintoutId ?? 0;
        }

        public ReportPrintout PrintReport(EvaluatedSelection es)
        {
            ReportPrintoutDTO dto = PrintReportDTO(es);
            return dto != null ? ReportManager.GetReportPrintout(dto.ReportPrintoutId, dto.ActorCompanyId) : null;
        }

        public ReportPrintoutDTO PrintReportDTO(EvaluatedSelection es, bool internalPrintout = false)
        {
            CreateReportResult reportResult = InitReportResult(es);

            if (reportResult.ReportTemplateType == SoeReportTemplateType.PayrollSlip)
            {
                return ReportDataManager.PrintPayrollSlipData(es.ReportId, es.ST_EmployeeId, es.ST_TimePeriodId.Value, es.ST_Preliminary);
            }
            else
            {
                return PrintReportDTO(reportResult, true, internalPrintout);
            }
        }

        public ReportPrintoutDTO PrintMigratedReportDTO(int reportPrintoutId, int actorCompanyId, int userId, int roleId)
        {
            ReportPrintoutDTO dto = GetReportPrintout(actorCompanyId, userId, roleId, reportPrintoutId);
            if (dto == null || !dto.UserId.HasValue)
                return null;

            ActionResult result = TryStartPrintReportDTO(dto, dto.ActorCompanyId, dto.UserId.Value, null);
            if (!result.Success)
                return null;

            return dto;
        }

        public ReportPrintoutDTO PrintMigratedReportDTO(ReportJobDefinitionDTO job, int actorCompanyId, int userId, int roleId, bool forcePrint = false, bool skipApiInternal = false, bool isPreliminary = false, bool internalPrint = false)
        {
            if (skipApiInternal)
                SetLanguage(job.GetLang());
            else
                job.SetLang(GetLangId());

            CreateReportResult reportResult = InitReportResult(job, actorCompanyId, userId, roleId);
            if (reportResult != null && reportResult.Input != null)
                reportResult.Input.IsPreliminary = isPreliminary;//Currently only used for payrollslip

            if (!skipApiInternal && UseWebApiInternal)
            {
                ReportPrintoutDTO dto = InitReportPrintout(reportResult);
                if (dto == null || dto.ResultMessage == (int)TermGroup_ReportPrintoutStatus.Warning)
                    return dto;

                if (SaveReportPrintoutStarted(dto).Success && dto.UserId.HasValue)
                {
                    var connector = new ReportConnector();
                    var reportPrintout = connector.PrintMigratedReportDTO(dto.ReportPrintoutId, actorCompanyId, userId, roleId);
                    if (reportPrintout != null)
                        return reportPrintout;
                }
            }

            //Fallback
            return PrintReportDTO(reportResult, forcePrint, internalPrint);
        }

        public ActionResult StartMatrixGeneric(MatrixResult matrix, int actorCompanyId, int userId, int roleId, string reportName, List<ReportDataSelectionDTO> selections = null)
        {
            ActionResult result = new ActionResult();

            ReportJobDefinitionDTO job = new ReportJobDefinitionDTO();
            List<Report> templates = ReportManager.GetReportsByTemplateType(actorCompanyId, null, SoeReportTemplateType.Generic);
            if (templates.IsNullOrEmpty())
                return new ActionResult(GetText(12131, "Ingen rapport av typen 'Generisk' hittad"));

            job.ReportId = templates.First().ReportId;
            job.SysReportTemplateTypeId = SoeReportTemplateType.Generic;
            if (!selections.IsNullOrEmpty())
                job.Selections.AddRange(selections);
            job.ExportType = TermGroup_ReportExportType.MatrixExcel;
            CreateReportResult reportResult = InitReportResult(job, actorCompanyId, userId, roleId);
            reportResult.MatrixResult = matrix;
            reportResult.SetReportName(reportName);
            ReportPrintoutDTO dto = InitReportPrintout(reportResult);
            dto.Status = (int)TermGroup_ReportPrintoutStatus.Ordered;
            SaveReportPrintoutStarted(dto);
            result.IntegerValue = dto.ReportPrintoutId;
            StartPrintReportDTO(dto, reportResult, continueWithNext: false);

            if (reportResult.Success)
                return result;
            else
            {
                result.Success = false;
                result.ErrorMessage = reportResult.ResultMessageDetails;
                return result;
            }
        }

        public ReportPrintoutDTO CreateInsight(ReportJobDefinitionDTO job, int actorCompanyId, int userId, int roleId)
        {
            job.SetLang(GetLangId());
            CreateReportResult reportResult = InitReportResult(job, actorCompanyId, userId, roleId);

            ReportPrintoutDTO dto = InitReportPrintout(reportResult);
            if (dto == null || dto.ResultMessage == (int)TermGroup_ReportPrintoutStatus.Warning || !dto.UserId.HasValue)
                return dto;

            StartPrintReportDTO(dto, reportResult, continueWithNext: false);
            if (dto.Data != null)
            {
                dto.Json = JsonConvert.DeserializeObject(Encoding.UTF8.GetString(dto.Data)).ToString();
                dto.Data = null;
            }

            return dto;
        }

        public string TEMPPayrollSlipPrintouts()
        {
            StringBuilder sb = new StringBuilder();
            var date = DateTime.Now.AddYears(-1);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var reports = (from e in entitiesReadOnly.ReportPrintout
                           where e.SysReportTemplateTypeId == 49 &&
                           e.Created > date
                           select new ReportPrintoutDTO()
                           {
                               ReportPrintoutId = e.ReportPrintoutId,
                               ActorCompanyId = e.ActorCompanyId,
                               ReportId = e.ReportId,
                               ReportPackageId = e.ReportPackageId,
                               ReportUrlId = e.ReportUrlId,
                               ReportTemplateId = e.ReportTemplateId,
                               SysReportTemplateTypeId = e.SysReportTemplateTypeId,
                               ExportType = (TermGroup_ReportExportType)e.ExportType,
                               ExportFormat = (SoeExportFormat)e.ExportFormat,
                               DeliveryType = (TermGroup_ReportPrintoutDeliveryType)e.DeliveryType,
                               Status = e.Status,
                               ResultMessage = e.ResultMessage,
                               EmailMessage = e.EmailMessage,
                               ReportName = e.ReportName,
                               Selection = e.Selection,
                               OrderedDeliveryTime = e.OrderedDeliveryTime,
                               DeliveredTime = e.DeliveredTime,
                               CleanedTime = e.CleanedTime,
                               XML = null,
                               Data = null,
                               Created = e.Created,
                               CreatedBy = e.CreatedBy,
                               Modified = e.Modified,
                               ModifiedBy = e.ModifiedBy,
                               UserId = e.UserId,
                               RoleId = e.RoleId
                           }).OrderByDescending(a => a.Created).ToList();

            foreach (var rep in reports.GroupBy(g => g.ActorCompanyId))
            {   
                var company = entitiesReadOnly.Company.Include("Role").FirstOrDefault(f => f.ActorCompanyId == rep.Key);

                foreach (var item in rep)
                {

                    var selection = ReportDataSelectionDTO.FromJSON(item.Selection);
                    var selectionE = selection?.GetSelection<EmployeeSelectionDTO>("employees");
                    if (selectionE != null)
                    {
                        var employeeIds = selectionE.EmployeeIds?.ToList() ?? new List<int>();
                        if (employeeIds.Count > 1)
                        {
                            var role = company.Role.First(f => f.RoleId == item.RoleId);
                            sb.Append($"Company: {company.Name} User:{item.CreatedBy} Role:{role.Name} Count:{employeeIds.Count} Time:{item.Created}");
                            sb.Append(Environment.NewLine);
                        }
                    }
                }
            }
            var res = sb.ToString();
            return sb.ToString();
        }

        public ActionResult TryStartPrintReportDTO(ReportPrintoutDTO dto, int actorCompanyId, int userId, CreateReportResult reportResult, int notReportprintoutId = 0, bool forcePrint = false, bool internalPrintout = false)
            {
            ActionResult result = new ActionResult(true);

            try
            {
                if (dto == null)
                {
                    dto = GetNextQueuedReportPrintoutForUser(actorCompanyId, userId, notReportprintoutId);

                    if (dto != null)
                    {
                        base.parameterObject = parameterObject.Clone(thread: THREAD, activeRoleId: dto.RoleId);
                    }
                }

                if (dto != null && dto.UserId.HasValue && dto.RoleId.HasValue)
                {
                    base.parameterObject.SetActiveRoleId(dto.RoleId.Value);

                    if (forcePrint || ValidateMigratedReportDTO(dto.ActorCompanyId, dto.UserId.Value, JsonConvert.DeserializeObject<List<ReportDataSelectionDTO>>(dto.Selection), dto.ExportType).Success)
                    {
                        if (dto.Status == (int)TermGroup_ReportPrintoutStatus.Queued)
                        {
                            result = ChangeStatusOnReportPrintout(dto, TermGroup_ReportPrintoutStatus.Ordered);
                            if (!result.Success)
                                return result;
                        }

                        if (!forcePrint)
                            Task.Run(() => CompEntitiesProvider.RunWithTaskScopedReadOnlyEntities(() => StartPrintReportDTO(dto)));
                        else
                            StartPrintReportDTO(dto, reportResult, continueWithNext: false, internalPrintout: internalPrintout);
                    }
                    else
                        ChangeStatusOnReportPrintout(dto, TermGroup_ReportPrintoutStatus.Queued);
                }
            }
            catch (Exception ex)
            {
                result = new ActionResult(ex);
                base.LogError(ex, this.log);
                ChangeStatusOnReportPrintout(dto, TermGroup_ReportPrintoutStatus.Error);
            }

            return result;
        }

        public ActionResult TryStartFileExportDTO(ReportPrintoutDTO dto, int actorCompanyId, int userId, List<CreateReportResult> reportResults, int notReportprintoutId = 0, bool forcePrint = false)
        {
            ActionResult result = new ActionResult(true);

            try
            {
                var fileResult = TryCreateExportFileResult(reportResults);

                if (fileResult.Success)
                    dto.Data = fileResult.Data;
            }
            catch (Exception ex)
            {
                result = new ActionResult(ex);
                base.LogError(ex, this.log);
                ChangeStatusOnReportPrintout(dto, TermGroup_ReportPrintoutStatus.Error);
            }

            return result;
        }

        public FileExportResult CreateFileForExportFileFromReportUserSelectionDTO(ReportUserSelection reportUserSelection, int actorCompanyId, int? sysTimeInterval, string fileName, int exportId, ExportDefinition exportDefinition, bool forceNoColumnHeaders = false, string eventInfo = null)
        {
            if (reportUserSelection.ActorCompanyId != actorCompanyId)
            {
                reportUserSelection.ActorCompanyId = actorCompanyId;
                reportUserSelection.UserId = base.UserId;
            }
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();

            var orginalReport = entitiesReadOnly.Report.FirstOrDefault(f => f.ReportId == reportUserSelection.ReportId);

            if (orginalReport != null && orginalReport.ActorCompanyId != actorCompanyId)
            {
                var reportOnCurrentCompany = entitiesReadOnly.Report.FirstOrDefault(f => f.ReportTemplateId == orginalReport.ReportTemplateId && f.ActorCompanyId == actorCompanyId);

                if (reportOnCurrentCompany != null)
                {
                    reportUserSelection.Report = null;
                    reportUserSelection.ReportId = reportOnCurrentCompany.ReportId;
                }
            }

            List<ReportPrintoutDTO> reportPrintoutDTOs = new List<ReportPrintoutDTO>();
            List<CreateReportResult> reportResults = new List<CreateReportResult>();
            ReportPrintoutDTO dto = base.InitReportPrintout(reportUserSelection);
            string cleanSelection = reportUserSelection.Selection;
            foreach (var exportDefinitionLevel in exportDefinition.ExportDefinitionLevel)
            {
                var report = ReportManager.GetReport(reportUserSelection.ReportId, actorCompanyId, loadSysReportTemplateType: true);
                reportUserSelection.Selection = TimeMatrixDataManager.ReportDataSelectionDTOFromMatrix(actorCompanyId, cleanSelection, (SoeReportTemplateType)(report?.SysReportTemplateTypeId ?? 0), exportDefinition, exportDefinitionLevel, eventInfo);
                dto.Selection = reportUserSelection.Selection;
                CreateReportResult reportResult = InitReportResult(dto);
                reportResult.Input.SoeReportType = SoeReportType.ExportFile;
                reportResult.Input.ExportId = exportId;
                reportResult.Input.ExportDefinitionLevelId = exportDefinitionLevel.ExportDefinitionLevelId;
                reportResult.Input.ForceNoColumnHeaders = forceNoColumnHeaders;
                reportResult.Input.ExportType = TermGroup_ReportExportType.File;
                reportResults.Add(reportResult);
                var saveResult = SaveReportPrintoutStarted(dto);
                if (!saveResult.Success)
                    return new FileExportResult();
            }

            var result = TryStartFileExportDTO(dto, dto.ActorCompanyId, dto.UserId.Value, reportResults, forcePrint: true);

            var fileExportResult = new FileExportResult();
            fileExportResult.Result = result;

            if (dto.Data != null)
            {
                fileExportResult.Base64Data = Convert.ToBase64String(dto.Data);
                fileExportResult.Data = dto.Data;
            }
            var parsedfileName = BridgeManager.ParseFileName(base.ActorCompanyId, fileName);

            if (string.IsNullOrEmpty(parsedfileName))
                parsedfileName = reportUserSelection.Name + CalendarUtility.ToFileFriendlyDateTime(DateTime.Now) + ".txt";

            fileExportResult.FileName = parsedfileName;
            dto.ReportFileName = parsedfileName;
            dto.ExportType = TermGroup_ReportExportType.File;
            dto.ExportFormat = SoeExportFormat.CharacterSeparatedValues;
            SaveReportPrintoutFinished(ref dto, reportResult);
            return fileExportResult;
        }

        public ApiMatrixDataResult CreateApiMatrixDataResult(ApiMatrixDataSelection apiMatrixDataSelection, int actorCompanyId, Guid trackGuid)
        {
            try
            {
                ReportJobDefinitionDTO job = new ReportJobDefinitionDTO();
                job.ReportId = apiMatrixDataSelection.ReportId ?? 0;
                job.Selections = apiMatrixDataSelection.ToReportSelectionDefinitionDTO()?.Selections;

                if (apiMatrixDataSelection.ReportId != 0)
                {
                    CreateReportResult reportResult = InitReportResult(job, actorCompanyId, base.UserId, base.RoleId);
                    return CreateApiMatrixDataResult(new List<CreateReportResult>() { reportResult });
                }
                base.LogError($"CreateApiMatrixDataResult trackGuid {trackGuid} ReportId is 0 json:{JsonConvert.SerializeObject(apiMatrixDataSelection)}");

                return new ApiMatrixDataResult() { ResultMessage = "ReportId is 0 " };

            }
            catch (Exception ex)
            {
                base.LogError($"CreateApiMatrixDataResult trackGuid {trackGuid} exception {ex} 0 json:{JsonConvert.SerializeObject(apiMatrixDataSelection)}");
                base.LogError(ex, this.log);
            }

            return new ApiMatrixDataResult() { ResultMessage = "Exception in request. trackGuid " + trackGuid.ToString() };
        }

        public ActionResult RePrintMigratedReportUserSelectionDTO(int reportUserSelectionId, int userId, int? sysTimeInterval)
        {
            var userSelection = ReportManager.GetReportUserSelection(reportUserSelectionId, loadReport: true);
            ReportPrintoutDTO dto = base.InitReportPrintout(userSelection);

            if (dto == null || userSelection.UserId != userId)
                return new ActionResult(GetText(11874, "Utskrift kunde inte skrivas ut igen"));

            CreateReportResult reportResult = InitReportResult(dto);

            if (TryGetDatesFromSysTimeIntervalSelection(reportResult, sysTimeInterval, out DateTime? _, out DateTime? _))
            {
                dto.Selection = ReportDataSelectionDTO.ToJSON(reportResult.Input.GetSelections());
                var saveResult = SaveReportPrintoutStarted(dto);
                if (saveResult.Success)
                    return TryStartPrintReportDTO(dto, dto.ActorCompanyId, dto.UserId.Value, null);
            }

            return new ActionResult(GetText(11874, "Utskrift kunde inte skrivas ut igen"));
        }

        public ActionResult RePrintMigratedReportDTO(int reportPrintoutId, int actorCompanyId, int userId, int roleId, bool forceValidation = false)
        {
            ReportPrintoutDTO dto = GetReportPrintout(actorCompanyId, userId, roleId, reportPrintoutId);
            if (dto == null)
                return new ActionResult(GetText(11874, "Utskrift kunde inte skrivas ut igen"));

            dto.ForceValidation = forceValidation;
            CreateReportResult reportResult = InitReportResult(dto);

            ActionResult result = ValidateTemplateTypeSpecifics(reportResult);
            if (!result.Success)
            {
                result.CanUserOverride = (result.ErrorNumber == (int)ActionResultSave.ReportPrintoutWarning);
                return result;
            }

            dto.ReportPrintoutId = 0;
            dto.Status = (int)TermGroup_ReportPrintoutStatus.Queued;
            dto.Created = DateTime.Now;
            dto.ResultMessageDetails = $"reprinted:{reportPrintoutId}";
            result = SaveReportPrintoutStarted(dto);
            if (!result.Success)
                return result;

            if (dto.UserId.HasValue)
            {
                if (UseWebApiInternal)
                {
                    var connector = new ReportConnector();
                    var newDTO = connector.PrintMigratedReportDTO(dto.ReportPrintoutId, actorCompanyId, userId, roleId);

                    if (newDTO == null)
                        result = TryStartPrintReportDTO(dto, dto.ActorCompanyId, dto.UserId.Value, null);
                    else
                        result.Success = true;
                }
                else
                    result = TryStartPrintReportDTO(dto, dto.ActorCompanyId, dto.UserId.Value, null);
            }


            return result;
        }

        public ActionResult GenerateReportForEdi(List<int> ediEntryIds, int actorCompanyId)
        {
            var result = new ActionResult();

            #region Prereq

            if (ediEntryIds == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EdiEntryIds");

            SoeReportType reportType = SoeReportType.CrystalReport;
            SoeReportTemplateType templateType = SoeReportTemplateType.SymbrioEdiSupplierInvoice;
            TermGroup_ReportExportType exportType = TermGroup_ReportExportType.Pdf;

            Report report = ReportManager.GetStandardReport(actorCompanyId, templateType, reportType);
            if (report == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "Report");

            TermGroup_Country syscountry = (TermGroup_Country)base.GetCompanySysCountryIdFromCache(actorCompanyId);
            SetLanguageFromSysCountry(syscountry);

            var es = new EvaluatedSelection
            {
                ActorCompanyId = actorCompanyId,
                ReportName = report.Name,
                IsReportStandard = report.Standard,
                ReportTemplateId = report.ReportTemplateId,
                ReportTemplateType = templateType,
                ExportType = exportType,
                ReportId = report.ReportId
            };

            CreateReportResult reportResult = InitReportResult(es);

            #endregion

            foreach (int ediEntryId in ediEntryIds)
            {
                #region Perform

                using (var entities = new CompEntities())
                {
                    try
                    {
                        EdiEntry ediEntry = EdiManager.GetEdiEntry(entities, ediEntryId, actorCompanyId, ignoreState: true);
                        if (ediEntry == null)
                        {
                            reportResult.SetErrorMessage(SoeReportDataResultMessage.EdiEntryNotFound);
                            continue;
                        }

                        SymbrioEdiItem item = SymbrioEdiItem.CreateItem(ediEntry.XML, ediEntry.FileName, ediEntry.Type, true, false);
                        if (item == null)
                        {
                            reportResult.SetErrorMessage(SoeReportDataResultMessage.EdiEntryCouldNotParseXML);
                            continue;
                        }

                        //Data
                        reportResult.Document = item.ToXDocument();

                        var crConnector = RptGenConnector.GetConnector(this.parameterObject, reportResult.SoeReportType);
                        var dto = crConnector.GenerateReport(exportType, reportResult.Template, reportResult.Document, reportResult.DataSet, this.CrGenRequestPictures, GetCulture(GetLangId()), ReportGenManager.GetXsdFileString(SoeReportTemplateType.SymbrioEdiSupplierInvoice), "edientryid =" + ediEntryId.ToString());

                        //Update EdiEntry
                        if (dto?.GeneratedReport != null)
                        {
                            ediEntry.PDF = dto.GeneratedReport;
                            if (ediEntry.Type == (int)TermGroup_EDISourceType.EDI)
                                ediEntry.Status = (int)TermGroup_EDIStatus.Processed;
                            SetModifiedProperties(ediEntry);

                            if (!SaveChanges(entities).Success)
                                reportResult.SetErrorMessage(SoeReportDataResultMessage.EdiEntryCouldNotSavePDF);
                        }

                    }
                    catch (Exception ex)
                    {
                        base.LogError(ex, this.log);
                        reportResult.SetErrorMessage(SoeReportDataResultMessage.Error, ex);
                    }
                    finally
                    {
                        ReportGenManager.DisposeReportDocument(reportResult);

                        if (!reportResult.Success)
                            result.Success = false;
                    }
                }

                #endregion
            }

            return result;
        }

        public ActionResult GenerateReportForFinvoice(List<int> ediEntryIds, int actorCompanyId)
        {
            ActionResult result = new ActionResult();

            #region Prereq

            if (ediEntryIds == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, GetText(4888, "Inga poster valda."));

            SoeReportType reportType = SoeReportType.CrystalReport;
            SoeReportTemplateType templateType = SoeReportTemplateType.FinvoiceEdiSupplierInvoice;
            TermGroup_ReportExportType exportType = TermGroup_ReportExportType.Pdf;

            Report report = ReportManager.GetStandardReport(actorCompanyId, templateType, reportType);
            if (report == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, GetText(4889, "Rapport för Finvoice lev.faktura saknas från rapporter."));

            var es = new EvaluatedSelection
            {
                ActorCompanyId = actorCompanyId,
                ReportName = report.Name,
                IsReportStandard = report.Standard,
                ReportTemplateId = report.ReportTemplateId,
                ReportTemplateType = templateType,
                ExportType = exportType,
                ReportId = report.ReportId
            };

            CreateReportResult reportResult = InitReportResult(es);

            #endregion

            foreach (int ediEntryId in ediEntryIds)
            {
                #region Perform

                using (var entities = new CompEntities())
                {
                    EdiEntry ediEntry = EdiManager.GetEdiEntry(entities, ediEntryId, actorCompanyId, ignoreState: true);

                    if (ediEntry == null)
                    {
                        reportResult.SetErrorMessage(SoeReportDataResultMessage.EdiEntryNotFound);
                        continue;
                    }

                    if (ediEntry.PDF != null)
                        continue;

                    ReportPrintoutDTO dto = InitReportPrintoutForEdi(reportResult);

                    if (dto == null)
                        continue;

                    result = SaveReportPrintoutStarted(dto);
                    if (!result.Success)
                        continue;

                    try
                    {
                        var item = FinvoiceEdiItem.CreateItem(ediEntry.XML, ediEntry.FileName, ediEntry.Type, parameterObject);
                        if (item == null)
                        {
                            reportResult.SetErrorMessage(SoeReportDataResultMessage.EdiEntryCouldNotParseXML);
                            continue;
                        }

                        //Data
                        reportResult.Document = item.ToXDocument();

                        //Export
                        ExportData(dto, reportResult);

                        //Update EdiEntry
                        if (dto.Data != null)
                        {
                            ediEntry.PDF = dto.Data;
                            SetModifiedProperties(ediEntry);

                            if (!SaveChanges(entities).Success)
                                reportResult.SetErrorMessage(SoeReportDataResultMessage.EdiEntryCouldNotSavePDF);
                        }
                    }
                    catch (Exception ex)
                    {
                        base.LogError(ex, this.log);
                        reportResult.SetErrorMessage(SoeReportDataResultMessage.Error, ex);
                    }
                    finally
                    {
                        ReportGenManager.DisposeReportDocument(reportResult);

                        SaveReportPrintoutFinished(ref dto, reportResult);
                        if (!reportResult.Success)
                        {
                            result.ErrorMessage = reportResult.ResultMessage.ToString();
                            result.Success = false;
                        }
                    }
                }

                #endregion
            }

            return result;
        }

        public ActionResult ValidateMigratedReportDTO(int actorCompanyId, int userId, ReportJobDefinitionDTO job)
        {
            return ValidateMigratedReportDTO(actorCompanyId, userId, job.Selections, job.ExportType);
        }

        public ActionResult ValidateMigratedReportDTO(int actorCompanyId, int userId, ICollection<ReportDataSelectionDTO> selections, TermGroup_ReportExportType exportType)
        {
            ActionResult result;

            int maxAllowedSimultaneousPrintJobs = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.MaxAllowedSimultaneousPrintJobsPerUser, 0, actorCompanyId, 0);
            if (maxAllowedSimultaneousPrintJobs < 1)
                maxAllowedSimultaneousPrintJobs = 1;

            //Allowing more jobs during more idle hours
            if (maxAllowedSimultaneousPrintJobs == 1 && (DateTime.Now.Hour > 16 || DateTime.Now.Hour < 8 || DateTime.Now.IsWeekendDay()))
            {
                maxAllowedSimultaneousPrintJobs = 2;

                if (DateTime.Now.Hour > 21 || DateTime.Now.Hour < 6)
                    maxAllowedSimultaneousPrintJobs = 3;
            }

            if (maxAllowedSimultaneousPrintJobs > 1)
            {
                // Only need to check for duplicate print if user is allowed to print more than one report at a time
                result = ValidateDuplicatePrintJobs(actorCompanyId, userId, selections, exportType);
                if (!result.Success)
                    return result;
            }

            result = ValidateSimultaneousPrintJobs(actorCompanyId, userId, exportType, maxAllowedSimultaneousPrintJobs);
            if (!result.Success)
                return result;

            return result;
        }

        #region Help-methods

        private ReportPrintoutDTO PrintReportDTO(CreateReportResult reportResult, bool forcePrint = false, bool internalPrintout = false)
        {
            ReportPrintoutDTO dto = InitReportPrintout(reportResult);
            if (dto == null || dto.ResultMessage == (int)TermGroup_ReportPrintoutStatus.Warning)
                return dto;

            if (SaveReportPrintoutStarted(dto).Success && dto.UserId.HasValue)
                TryStartPrintReportDTO(dto, dto.ActorCompanyId, dto.UserId.Value, reportResult: reportResult, forcePrint: forcePrint, internalPrintout: internalPrintout);

            return dto;
        }

        private void StartPrintReportDTO(ReportPrintoutDTO dto, CreateReportResult reportResult = null, bool continueWithNext = true, bool internalPrintout = false)
        {
            if (dto == null)
                return;

            try
            {
                bool skipExportData = false;
                //ReportResult
                reportResult = reportResult ?? InitReportResult(dto);
                if (!reportResult.Success)
                    return;

                //Data
                if (reportResult.SoeReportType == SoeReportType.Analysis && reportResult.ReportTemplateType == SoeReportTemplateType.Generic)
                {
                    if (!TryCreateGenericMatrixResult(reportResult))
                        return;

                    dto.Data = reportResult.Data;
                }
                else if (reportResult.SoeReportType == SoeReportType.Analysis)
                {
                    if (!TryCreateMatrixResult(reportResult))
                        return;
                }
                else if (reportResult.SoeReportType == SoeReportType.ExportFile)
                {
                    if (!(TryCreateExportFileResult(new List<CreateReportResult>() { reportResult }).Success))
                        return;
                }
                else if (reportResult.ExportType == TermGroup_ReportExportType.File)
                {
                    if (!TryCreateExportFile(reportResult))
                        return;

                    dto.Data = reportResult.Data;
                }
                else if (reportResult.ExportType == TermGroup_ReportExportType.MatrixExcel)
                {
                    if (!TryCreateExportFile(reportResult, forceExcelExport: true))
                        return;

                    skipExportData = true;
                    dto.Data = reportResult.Data;
                }
                else
                {
                    if (!TryCreateDocument(reportResult))
                        return;
                }

                SetReportName(dto, reportResult);

                //Export
                if (!skipExportData && (reportResult.SoeReportType == SoeReportType.CrystalReport || reportResult.SoeReportType == SoeReportType.DevExpressReport))
                {
                    ExportData(dto, reportResult);
                    SaveReportPrintoutElsewhere(dto, reportResult);
                }

                //Handle attachments
                bool mergePdfs = false;
                this.TryGetBoolFromSelection(reportResult, out mergePdfs, "mergePdfs");
                if (mergePdfs)
                {
                    List<KeyValuePair<string, byte[]>> attachments = null;
                    if (this.TryGetAttachmentsFromSelection(reportResult, out attachments, "attachments") && !attachments.IsNullOrEmpty())
                    {
                        var allDocuments = new List<KeyValuePair<string, byte[]>>();
                        allDocuments.Add(new KeyValuePair<string, byte[]>(dto.ReportFileName, dto.Data));
                        allDocuments.AddRange(attachments);
                        allDocuments = PDFUtility.MergeDictionary(dto.ReportFileName, allDocuments);
                        var merged = allDocuments.First(a => a.Key == dto.ReportFileName);
                        if(merged.Value != null)
                            dto.Data = merged.Value;
                    }
                }
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                if (reportResult != null)
                    reportResult.SetErrorMessage(SoeReportDataResultMessage.Error, ex);
                using (CompEntities entities = new CompEntities())
                {
                    ReportPrintout reportPrintout = ReportManager.GetReportPrintout(entities, dto.ReportPrintoutId, dto.ActorCompanyId);

                    if (reportPrintout != null)
                    {
                        reportPrintout.Status = (int)TermGroup_ReportPrintoutStatus.Error;
                        reportPrintout.ResultMessageDetails = "Init failed";
                        SaveChanges(entities);
                    }
                }
            }
            finally
            {
                if (reportResult != null)
                {
                    ReportGenManager.DisposeReportDocument(reportResult);

                    var result = SaveReportPrintoutFinished(ref dto, reportResult, internalPrintout);
                    if (!result.Success)
                        LogError(result.ErrorMessage);
                }
            }

            if (continueWithNext)
                TryStartPrintReportDTO(null, dto.ActorCompanyId, dto.UserId.Value, null, dto.ReportPrintoutId);
        }

        #endregion

        #endregion

        #region ReportPackage

        public int PrintReportPackageId(List<EvaluatedSelection> evaluatedSelections)
        {
            ReportPrintoutDTO dto = PerformPrintReportPackageDTO(evaluatedSelections);
            return dto != null ? dto.ReportPrintoutId : 0;
        }

        private ReportPrintoutDTO PerformPrintReportPackageDTO(List<EvaluatedSelection> esc)
        {
            #region Prereq

            esc = esc.OrderByDescending(x => x.IsMainReport).ToList();
            CreateReportResult reportPackageResult = null;
            ReportPrintoutDTO dto = null;

            #endregion

            #region Perform

            try
            {
                DirectoryInfo directory = Directory.CreateDirectory(ConfigSettings.SOE_SERVER_DIR_TEMP_REPORT_PHYSICAL + Guid.NewGuid().ToString());

                int reportCounter = 1;
                foreach (EvaluatedSelection es in esc)
                {
                    CreateReportResult reportResult = InitReportResult(es);
                    if (!reportResult.Success)
                    {
                        if (reportPackageResult != null)
                            reportPackageResult.SetErrorMessage(reportResult.ResultMessage);
                        break;
                    }

                    try
                    {
                        if (reportPackageResult == null)
                        {
                            reportPackageResult = reportResult;
                            dto = InitReportPrintout(reportPackageResult);

                            ActionResult result = SaveReportPrintoutStarted(dto);
                            if (!result.Success)
                                continue;

                            SetReportPackageExportSettings(dto, reportPackageResult);
                        }

                        //Data
                        if (es.ExportType == TermGroup_ReportExportType.File)
                        {
                            if (!TryCreateExportFile(reportResult))
                            {
                                reportPackageResult.SetErrorMessage(reportResult.ResultMessage);
                                break;
                            }

                            dto.Data = reportResult.Data;
                        }
                        else
                        {
                            //Fix for now (don´t print timeprojectreports if more then one invoiceid exists in evaluatedSelections)
                            if (es.ReportTemplateType == SoeReportTemplateType.TimeProjectReport && es.SB_InvoiceIds.Count > 1)
                                continue;

                            if (!TryCreateDocument(reportResult))
                            {
                                reportPackageResult.SetErrorMessage(reportResult.ResultMessage);
                                break;
                            }
                        }

                        //Export
                        string fileName = StringUtility.GetValidFilePath(directory.FullName) + dto.ReportFileName + reportCounter + dto.ReportFileType;

                        if (reportResult.ReportDocument != null)
                        {
                            ExportFormatType crystalExportFormatType = ReportGenManager.GetCrystalExportFormatType(dto.ExportFormat);
                            reportResult.ReportDocument.ExportToDisk(crystalExportFormatType, fileName);
                        }
                        else
                        {
                            RptGenConnector crgen = RptGenConnector.GetConnector(parameterObject, reportType: es.ReportType);
                            CultureInfo culture = GetCulture(GetLangId());

                            RptGenResultDTO crGenResult = crgen.GenerateReport(dto.ExportType, es.Template, reportResult.Document, reportResult.DataSet, this.CrGenRequestPictures, culture, ReportGenManager.GetXsdFileString(es.ReportTemplateType), $"es reportid:{es.ReportId} actorcompanyid: {es.ActorCompanyId}");
                            if (crGenResult != null)
                            {
                                dto.Data = crGenResult.GeneratedReport;
                                File.WriteAllBytes(fileName, dto.Data);
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        base.LogError(ex, this.log);
                        reportResult.SetErrorMessage(SoeReportDataResultMessage.Error, ex);
                        if (reportPackageResult != null)
                            reportPackageResult.SetErrorMessage(SoeReportDataResultMessage.Error, ex);
                    }
                    finally
                    {
                        if (reportResult.ReportDocument != null)
                            ReportGenManager.DisposeReportDocument(reportResult);

                        reportCounter++;
                    }
                }

                //ReportPrintoutDTO
                SetReportName(dto, reportPackageResult);
                MergeReportPackage(dto, directory);
            }
            catch (Exception ex)
            {
                base.LogError(ex, this.log);
                if (reportPackageResult != null)
                    reportPackageResult.SetErrorMessage(SoeReportDataResultMessage.Error, ex);
            }

            #endregion

            #region Save ReportPrintout

            //Handle MergedPDF that not is ReportPackage
            if (dto != null && reportPackageResult != null && reportPackageResult.ReportPackageId == 0)
                dto.SysReportTemplateTypeId = (int)reportPackageResult.ReportTemplateType;

            SaveReportPrintoutFinished(ref dto, reportPackageResult);

            #endregion

            return dto;
        }

        #endregion

        public bool TryCreateDocument(CreateReportResult reportResult)
        {
            if (reportResult == null)
                return false;

            if (!ReportManager.HasReportRolePermission(reportResult.ReportId, base.RoleId, reportTemplateType: reportResult.ReportTemplateType))
                reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportsNotAuthorized);

            else
            {
                if (reportResult.Success && reportResult.HasValidSelection)
                {
                    if (reportResult.Document == null)
                    {
                        base.Company = reportResult.Input?.Company ?? CompanyManager.GetCompany(reportResult.ActorCompanyId);
                        base.DoInlcudeInactiveAccounts();

                        bool authorized;
                        string errorMessage;
                        switch (reportResult.ReportTemplateType)
                        {
                            #region Economy

                            case SoeReportTemplateType.VoucherList:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateVoucherListData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateVoucherListData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.GeneralLedger:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateGeneralLedgerData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateGeneralLedgerData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.BalanceReport:
                                if (ReportManager.HasReportGroupsAndHeaders(reportResult.ActorCompanyId, reportResult.ReportId, reportResult.ReportTemplateId, reportResult.IsReportStandard))
                                {
                                    if (reportResult.IsMigrated)
                                    {
                                        reportResult.Document = EconomyReportDataManager.CreateBalanceReportData(reportResult);
                                    }
                                    else
                                    {
                                        reportResult.Document = CreateBalanceReportData(reportResult.EvaluatedSelection);
                                    }
                                }
                                else
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.BalanceReportHasNoGroupsOrHeaders);
                                break;
                            case SoeReportTemplateType.ResultReport:
                                if (ReportManager.HasReportGroupsAndHeaders(reportResult.ActorCompanyId, reportResult.ReportId, reportResult.ReportTemplateId, reportResult.IsReportStandard))
                                    if (reportResult.IsMigrated)
                                    {
                                        reportResult.Document = EconomyReportDataManager.CreateResultReportData(reportResult);
                                    }
                                    else
                                    {
                                        reportResult.Document = CreateResultReportData(reportResult.EvaluatedSelection);
                                    }
                                else
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ResultReportHasNoGroupsOrHeaders);
                                break;
                            case SoeReportTemplateType.ResultReportV2:
                                if (ReportManager.HasReportGroupsAndHeaders(reportResult.ActorCompanyId, reportResult.ReportId, reportResult.ReportTemplateId, reportResult.IsReportStandard))
                                {
                                    if (reportResult.IsMigrated)
                                    {
                                        reportResult.Document = EconomyReportDataManager.CreateResultReportDataV2(reportResult);
                                    }
                                    else
                                    {
                                        reportResult.Document = EconomyReportDataManager.CreateResultReportDataV2(reportResult.EvaluatedSelection);
                                    }
                                }
                                else
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ResultReportHasNoGroupsOrHeaders);
                                break;
                            case SoeReportTemplateType.TaxAudit:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateTaxAuditData(reportResult, out errorMessage);
                                    if (!string.IsNullOrEmpty(errorMessage))
                                    {
                                        reportResult.SetErrorMessage(SoeReportDataResultMessage.CreateVoucherFailed, errorMessage);
                                    }
                                }
                                else
                                {
                                    reportResult.Document = CreateTaxAuditData(reportResult.EvaluatedSelection);
                                }

                                break;
                            case SoeReportTemplateType.TaxAudit_FI:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateTaxAudit_FI_Data(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateTaxAudit_FI_Data(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.SruReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateSruReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateSruReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.SupplierBalanceList:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateSupplierBalanceListData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateSupplierBalanceListData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.SupplierInvoiceJournal:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateSupplierInvoiceJournalData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateSupplierInvoiceJournalData(reportResult.EvaluatedSelection);
                                }

                                break;
                            case SoeReportTemplateType.PeriodAccountingRegulationsReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreatePeriodAccountingRegulationsReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreatePeriodAccountingRegulationsReportData(reportResult.EvaluatedSelection);
                                }

                                break;
                            case SoeReportTemplateType.PeriodAccountingForecastReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreatePeriodAccountingForecastReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreatePeriodAccountingForecastReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.FixedAssets:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateFixedAssetsData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateFixedAssetsData(reportResult.EvaluatedSelection);
                                }

                                break;
                            case SoeReportTemplateType.CustomerBalanceList:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateCustomerBalanceListData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateCustomerBalanceListData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.InterestRateCalculation:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateInterestRateCalculationData(reportResult, reportResult.EvaluatedSelection);
                                }
                                else
                                {
                                    reportResult.Document = CreateInterestRateCalculationData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.CustomerInvoiceJournal:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateCustomerInvoiceJournalData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateCustomerInvoiceJournalData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.CustomerPaymentJournal:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateCustomerPaymentJournalData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateCustomerPaymentJournalData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.SupplierPaymentJournal:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateSupplierPaymentJournalData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateSupplierPaymentJournalData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.SupplierListReport:
                                reportResult.Document = CreateSupplierReportData(reportResult.EvaluatedSelection);
                                break;
                            case SoeReportTemplateType.SEPAPaymentImportReport:
                                reportResult.Document = CreateSEPAPaymentImportData(reportResult.EvaluatedSelection);
                                break;
                            case SoeReportTemplateType.ConstructionEmployeesReport:
                                reportResult.Document = CreateConstructionEmployeesReportData(reportResult.EvaluatedSelection);
                                break;
                            #endregion

                            #region Billing

                            case SoeReportTemplateType.BillingContract:
                            case SoeReportTemplateType.BillingOffer:
                            case SoeReportTemplateType.BillingOrder:
                            case SoeReportTemplateType.BillingInvoice:
                            case SoeReportTemplateType.BillingInvoiceInterest:
                            case SoeReportTemplateType.BillingInvoiceReminder:
                            case SoeReportTemplateType.OriginStatisticsReport:
                            case SoeReportTemplateType.BillingOrderOverview:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateBillingInvoiceData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateBillingInvoiceData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.BillingStatisticsReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateBillingStatisticsData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateBillingStatisticsData(reportResult.EvaluatedSelection);
                                }

                                break;
                            case SoeReportTemplateType.ProjectStatisticsReport:

                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateProjectStatisticsData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateProjectStatisticsData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.ProjectTimeReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateProjectTimeReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateProjectTimeReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.OrderContractChange:
                                reportResult.Document = BillingReportDataManager.CreateOrderContractChangeReportData(reportResult);
                                break;
                            case SoeReportTemplateType.HousholdTaxDeduction:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateHousholdTaxDeductionData(reportResult, reportResult.EvaluatedSelection);
                                }
                                else
                                {
                                    reportResult.Document = CreateHousholdTaxDeductionData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.HouseholdTaxDeductionFile:
                                reportResult.Document = CreateHousholdTaxDeductionDataXML(reportResult.EvaluatedSelection);
                                break;
                            case SoeReportTemplateType.OrderChecklistReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateChecklistsReportData(reportResult, reportResult.EvaluatedSelection);
                                }
                                else
                                {
                                    reportResult.Document = CreateChecklistsReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.ProjectTransactionsReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateProjectTransactionsData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateProjectTransactionsData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.CustomerListReport:
                                reportResult.Document = CreateCustomerReportData(reportResult.EvaluatedSelection);
                                break;
                            case SoeReportTemplateType.ProductListReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateProductReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateProductReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.StockSaldoListReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateStockSaldoListReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateStockSaldoListReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.StockTransactionListReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateStockTransactionListReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateStockTransactionListReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.StockInventoryReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateStockInventoryReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateStockInventoryReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.PurchaseOrder:
                                reportResult.Document = BillingReportDataManager.CreatePurchaseOrderData(reportResult);
                                break;
                            case SoeReportTemplateType.TaxReductionBalanceListReport:
                                    reportResult.Document = billingReportDataManager.CreateTaxReductionBalanceListData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeProjectReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateTimeProjectReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateTimeProjectReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.ExpenseReport:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager.CreateExpenseReportData(reportResult);
                                }
                                else
                                {
                                    reportResult.Document = CreateExpenseReportData(reportResult.EvaluatedSelection);
                                }
                                break;
                            #endregion

                            #region Time

                            case SoeReportTemplateType.TimeMonthlyReport:
                                reportResult.Document = TimeReportDataManager.CreateTimeMonthlyReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimePayrollTransactionSmallReport:
                                reportResult.Document = TimeReportDataManager.CreateTimePayrollTransactionSmallReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimePayrollTransactionReport:
                                reportResult.Document = TimeReportDataManager.CreateTimePayrollTransactionReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeEmployeeSchedule:
                            case SoeReportTemplateType.TimeEmployeeTemplateSchedule:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeScheduleData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeEmployeeLineSchedule:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeLineScheduleData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeCategorySchedule:
                                reportResult.Document = TimeReportDataManager.CreateTimeCategoryScheduleData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeAccumulatorReport:
                                reportResult.Document = TimeReportDataManager.CreateTimeAccumulatorReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeAccumulatorDetailedReport:
                                reportResult.Document = TimeReportDataManager.CreateTimeAccumulatorDetailedReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeCategoryStatistics:
                                reportResult.Document = TimeReportDataManager.CreateTimeCategoryStatisticsData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeStampEntryReport:
                                reportResult.Document = TimeReportDataManager.CreateTimeStampEntryReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeSalarySpecificationReport:
                                reportResult.Document = CreateTimeSalarySpecificationReportData(reportResult.EvaluatedSelection, out authorized);
                                if (!authorized)
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportsNotAuthorized);
                                break;
                            case SoeReportTemplateType.TimeSalaryControlInfoReport:
                                reportResult.Document = CreateTimeSalaryControlInfoReportData(reportResult.EvaluatedSelection, out authorized);
                                if (!authorized)
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportsNotAuthorized);
                                break;
                            case SoeReportTemplateType.EmployeeListReport:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeListReportData(reportResult);
                                break;
                            case SoeReportTemplateType.UserListReport:
                                reportResult.Document = CreateUserListReportData(reportResult.EvaluatedSelection);
                                break;
                            case SoeReportTemplateType.TimeEmploymentContract:
                                reportResult.Document = TimeReportDataManager.CreateEmploymentContractData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeEmploymentDynamicContract:
                                reportResult.Document = TimeReportDataManager.CreateEmploymentDynamicContractData(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollSlip:
                                reportResult.Outputs = TimeReportDataManager.CreatePayrollSlipData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeScheduleBlockHistory:
                                reportResult.Document = TimeReportDataManager.CreateTimeScheduleBlockHistoryData(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollTransactionStatisticsReport:
                                reportResult.Document = TimeReportDataManager.CreatePayrollTransactionStatisticsReportData(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollAccountingReport:
                                reportResult.Document = TimeReportDataManager.CreatePayrollAccountingReportData(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollVacationAccountingReport:
                                reportResult.Document = TimeReportDataManager.CreatePayrollVacationAccountingReportData(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollProductReport:
                                reportResult.Document = TimeReportDataManager.CreatePayrollProductData(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeVacationInformationReport:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeVacationInformationReportData(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeVacationDebtReport:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeVacationDebtReportData(reportResult);
                                break;
                            case SoeReportTemplateType.KU10Report:
                                reportResult.Document = TimeReportDataManager.Create_KU10_ReportData(reportResult, out _);
                                break;
                            case SoeReportTemplateType.SKDReport:
                                reportResult.Document = TimeReportDataManager.Create_SKD_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.CertificateOfEmploymentReport:
                                reportResult.Document = TimeReportDataManager.CreateCertificateOfEmploymentReportData(reportResult);
                                if (reportResult.Document == null)
                                    return false;
                                break;
                            case SoeReportTemplateType.CollectumReport:
                                reportResult.Document = TimeReportDataManager.Create_Collectum_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeTimePeriodReport:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeTimePeriodReportData(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollPeriodWarningCheck:
                                reportResult.Document = TimeReportDataManager.CreatePayrollPeriodWarningCheckReportData(reportResult);
                                break;
                            case SoeReportTemplateType.SCB_SLPReport:
                                reportResult.Document = TimeReportDataManager.Create_SCB_SN_ReportData(reportResult, true);
                                break;
                            case SoeReportTemplateType.SCB_KLPReport:
                                reportResult.Document = TimeReportDataManager.Create_SCB_KLP_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.SCB_KSPReport:
                                reportResult.Document = TimeReportDataManager.Create_SCB_KSP_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.SCB_KSJUReport:
                                reportResult.Document = TimeReportDataManager.Create_SCB_KSJU_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.SNReport:
                                reportResult.Document = TimeReportDataManager.Create_SCB_SN_ReportData(reportResult, false);
                                break;
                            case SoeReportTemplateType.KPAReport:
                                reportResult.Document = TimeReportDataManager.Create_KPA_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.KPADirektReport:
                                reportResult.Document = TimeReportDataManager.Create_KPADirekt_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.Bygglosen:
                                reportResult.Document = TimeReportDataManager.Create_Bygglosen_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.Kronofogden:
                                reportResult.Document = TimeReportDataManager.Create_Kronofogden_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.ForaReport:
                                reportResult.Document = TimeReportDataManager.Create_Fora_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeScheduleTasksAndDeliverysReport:
                                reportResult.Document = TimeReportDataManager.CreateTimeScheduleTasksAndDeliverysReportData(reportResult);
                                break;
                            case SoeReportTemplateType.AgdEmployeeReport:
                                reportResult.Document = TimeReportDataManager.Create_AGD_ReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeEmployeeScheduleSmallReport:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeScheduleDataSmallReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeAbsenceReport:
                                reportResult.Document = TimeReportDataManager.CreateTimeAbsenceControlReport(reportResult);
                                break;
                            case SoeReportTemplateType.RoleReport:
                                reportResult.Document = TimeReportDataManager.CreateRoleReportData(reportResult);
                                break;
                            case SoeReportTemplateType.TimeScheduleCopyReport:
                                reportResult.Document = TimeReportDataManager.CreateEmployeeScheduleCopyData(reportResult);
                                break;

                            #endregion

                            #region Import

                            case SoeReportTemplateType.IOVoucher:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = EconomyReportDataManager.CreateIOVoucherData(reportResult, reportResult.EvaluatedSelection);
                                }
                                else
                                {
                                    reportResult.Document = CreateIOVoucherData(reportResult.EvaluatedSelection);
                                }
                                break;
                            case SoeReportTemplateType.IOCustomerInvoice:
                                if (reportResult.IsMigrated)
                                {
                                    reportResult.Document = BillingReportDataManager
                                        .CreateIOCustomerInvoiceData(reportResult, reportResult.EvaluatedSelection);
                                }
                                else
                                {
                                    reportResult.Document = CreateIOCustomerInvoiceData(reportResult.EvaluatedSelection);
                                }
                                break;
                                //case SoeReportTemplateType.IOSupplierInvoice:
                                //    reportResult.Document = CreateIOSupplierInvoiceData(reportResult.EvaluatedSelection);
                                //    break;

                                #endregion
                        }
                    }
                }
                else
                {
                    reportResult.SetErrorMessage(SoeReportDataResultMessage.EmptyInput);
                }

                if (CrGenRequestPictures.IsNullOrEmpty() && TimeReportDataManager != null && !TimeReportDataManager.CrGenRequestPictures.IsNullOrEmpty())
                    CrGenRequestPictures = TimeReportDataManager.CrGenRequestPictures;

                if (CrGenRequestPictures.IsNullOrEmpty() && EconomyReportDataManager != null && !EconomyReportDataManager.CrGenRequestPictures.IsNullOrEmpty())
                    CrGenRequestPictures = EconomyReportDataManager.CrGenRequestPictures;

                if (CrGenRequestPictures.IsNullOrEmpty() && BillingReportDataManager != null && !BillingReportDataManager.CrGenRequestPictures.IsNullOrEmpty())
                    CrGenRequestPictures = BillingReportDataManager.CrGenRequestPictures;

                if (reportResult.ResultMessage == SoeReportDataResultMessage.Success || reportResult.ResultMessage == SoeReportDataResultMessage.Error)
                {
                    //do not overwrite existing error message
                    if (!reportResult.Success || !(reportResult.Document != null || reportResult.XmlDocument != null || !reportResult.Outputs.IsNullOrEmpty()))
                        reportResult.SetErrorMessage(SoeReportDataResultMessage.DocumentNotCreated);
                }
            }
            return reportResult.Success;
        }

        public bool TryCreateGenericMatrixResult(CreateReportResult reportResult)
        {
            if (reportResult?.MatrixResult?.MatrixDefinition == null)
                return false;

            if (!ReportManager.HasReportRolePermission(reportResult.ReportId, base.RoleId, reportTemplateType: reportResult.ReportTemplateType))
                reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportsNotAuthorized);

            if (reportResult.ReportTemplateType != SoeReportTemplateType.Generic)
                return false;

            if (reportResult.ExportType == TermGroup_ReportExportType.MatrixExcel)
            {
                reportResult.Data = ExcelMatrix.GetExcelFile(reportResult.MatrixResult, reportResult.ReportName);
            }
            else if (reportResult.ExportType == TermGroup_ReportExportType.MatrixGrid)
            {
                reportResult.MatrixResult.JsonRows = new List<Dictionary<string, object>>();
                foreach (var row in reportResult.MatrixResult.MatrixFields.GroupBy(g => g.RowNumber).OrderBy(o => o.Key))
                    reportResult.MatrixResult.JsonRows.Add(row.ToList().CreateRow(reportResult.MatrixResult.MatrixDefinition.MatrixDefinitionColumns));

                reportResult.MatrixResult.MatrixFields = null;
                reportResult.Data = Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(reportResult.MatrixResult, new JsonSerializerSettings
                {
                    ContractResolver = new DefaultContractResolver
                    {
                        NamingStrategy = new CamelCaseNamingStrategy()
                    },
                    Formatting = Newtonsoft.Json.Formatting.None
                }));
            }

            return reportResult.Data != null;
        }

        public CreateReportResult TryCreateExportFileResult(List<CreateReportResult> reportResults)
        {
            if (reportResults.IsNullOrEmpty())
                return new CreateReportResult();

            reportResult = reportResults.First();
            int exportId = reportResults.First().Input.ExportId;
            var matrixResult = GetMatrixResultFromResults(reportResults);
            int actorCompanyId = reportResults.First().ActorCompanyId;
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            var export = entitiesReadOnly.Export.FirstOrDefault(w => w.ExportId == exportId && w.ActorCompanyId == actorCompanyId);

            if (export != null)
            {
                var definition = entitiesReadOnly.ExportDefinition.Include("ExportDefinitionLevel.ExportDefinitionLevelColumn").FirstOrDefault(f => f.ExportDefinitionId == export.ExportDefinitionId).ToDTO();

                if (definition != null)
                {
                    foreach (var col in definition.ExportDefinitionLevels.SelectMany(s => s.ExportDefinitionLevelColumns).Where(w => !string.IsNullOrEmpty(w.Key)))
                    {
                        if (!string.IsNullOrEmpty(col.Key))
                            col.Key = TimeMatrixDataManager.ExtraFieldAndAccountDims(col.Key, base.ActorCompanyId, base.GetExtraFieldsFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId)), base.GetAccountDimsFromCache(entitiesReadOnly, CacheConfig.Company(base.ActorCompanyId))).Item1;
                    }

                    if (reportResult.Input.ForceNoColumnHeaders)
                        definition.ExportDefinitionLevels.ForEach(f => f.UseColumnHeaders = false);

                    var data = FileExportMatrix.GetExportFile(matrixResult, definition, CompanyManager.GetCompanyDTO(entitiesReadOnly, actorCompanyId));

                    if (data != null)
                        reportResult.Data = data;
                }
            }

            return reportResult;
        }

        public MatrixResult GetMatrixResultFromResults(List<CreateReportResult> reportResults)
        {
            if (reportResults.IsNullOrEmpty())
                return null;

            int exportId = reportResults.First().Input.ExportId;
            List<MatrixResult> matrixResults = new List<MatrixResult>();
            foreach (var reportResult in reportResults)
            {
                reportResult.Input.ExportType = TermGroup_ReportExportType.MatrixExcel;
                if (TryCreateMatrixResult(reportResult))
                {
                    reportResult.MatrixResult.Key = reportResult.Input.ExportDefinitionLevelId;
                    reportResult.Input.ExportType = TermGroup_ReportExportType.File;

                    if (reportResult.MatrixResult.MatrixFields != null)
                    {
                        matrixResults.Add(reportResult.MatrixResult);
                    }
                }
            }

            var matrixResult = matrixResults.MergeMatrixResults();

            return matrixResult;
        }

        public ApiMatrixDataResult CreateApiMatrixDataResult(List<CreateReportResult> reportResults)
        {
            MatrixResult matrixResult = GetMatrixResultFromResults(reportResults);
            ApiMatrixDataResult result = ApiMatrix.GetApiMatrixDataResult(matrixResult);
            return result;
        }

        public bool TryCreateMatrixResult(CreateReportResult reportResult)
        {
            if (reportResult == null)
                return false;

            if (reportResult.Input != null)
                SetTermGroup_ReportExportFileType(reportResult);

            if (reportResult.Success || reportResult.HasValidSelection)
            {
                if (reportResult.Data == null)
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        this.Company = reportResult.Input?.Company ?? CompanyManager.GetCompany(entities, reportResult.ActorCompanyId);

                        switch (reportResult.ReportTemplateType)
                        {
                            case SoeReportTemplateType.TimeTransactionAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateTimeTransactions(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollTransactionAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreatePayrollTransactions(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeList(reportResult);
                                break;
                            case SoeReportTemplateType.ScheduleAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateScheduleTransactions(reportResult);
                                break;
                            case SoeReportTemplateType.TimeScheduledSummary:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateScheduledTimeSummaries(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeDateAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeDates(reportResult);
                                break;
                            case SoeReportTemplateType.TimeStampEntryAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateTimeStampEntriesData(reportResult);
                                break;
                            case SoeReportTemplateType.SupplierAnalysis:
                                reportResult.MatrixResult = EconomyMatrixDataManager.CreateSupplierData(reportResult);
                                break;
                            case SoeReportTemplateType.InvoiceProductAnalysis:
                                reportResult.MatrixResult = BillingMatrixDataManager.CreateInvoiceProductData(reportResult);
                                break;
                            case SoeReportTemplateType.InvoiceProductUnitConvertAnalysis:
                                reportResult.MatrixResult = BillingMatrixDataManager.CreateInvoiceProductUnitConvertData(reportResult);
                                break;
                            case SoeReportTemplateType.OrderAnalysis:
                                reportResult.MatrixResult = BillingMatrixDataManager.CreateOrderData(reportResult);
                                break;
                            case SoeReportTemplateType.InvoiceAnalysis:
                                reportResult.MatrixResult = BillingMatrixDataManager.CreateInvoiceData(reportResult);
                                break;
                            case SoeReportTemplateType.EmploymentHistoryAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmploymentHistoryData(reportResult);
                                break;
                            case SoeReportTemplateType.UserAnalysis:
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateUserData(reportResult);
                                break;
                            case SoeReportTemplateType.StaffingneedsFrequencyAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateStaffingneedsFrequencys(reportResult);
                                break;
                            case SoeReportTemplateType.CustomerAnalysis:
                                reportResult.MatrixResult = EconomyMatrixDataManager.CreateCustomerData(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeSkillAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeSkill(reportResult);
                                break;
                            case SoeReportTemplateType.OrganisationHrAnalysis:
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateOrganisationHrData(reportResult);
                                break;
                            case SoeReportTemplateType.ShiftTypeSkillAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateShiftTypeSkill(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeEndReasonsAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeEndReasons(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeSalaryAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeSalary(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeTimePeriodAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeTimePeriods(reportResult);
                                break;
                            case SoeReportTemplateType.StaffingStatisticsAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateStaffingStatisticss(reportResult);
                                break;
                            case SoeReportTemplateType.AnnualProgressAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateAnnualProgresss(reportResult);
                                break;
                            case SoeReportTemplateType.LongtermAbsenceAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateLongtermAbsence(reportResult);
                                break;
                            case SoeReportTemplateType.AggregatedTimeStatisticsAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateAggregatedTimeStatisticss(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeMeetingAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeMeeting(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeExperienceAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeExperience(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeDocumentAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeDocument(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeAccountAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeAccount(reportResult);
                                break;
                            case SoeReportTemplateType.ReportStatisticsAnalysis:
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateReportStatistics(reportResult);
                                break;
                            case SoeReportTemplateType.SoftOneStatusResultAnalysis:
                                if (!base.IsLicense100())
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportTemplateDataNotFound);
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateSoftOneStatusResult(reportResult);
                                break;
                            case SoeReportTemplateType.LicenseInformationAnalysis:
                                if (!base.IsLicense100())
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportTemplateDataNotFound);
                                else
                                    reportResult.MatrixResult = ManageMatrixDataManager.CreateLicenseInformation(reportResult);
                                break;
                            case SoeReportTemplateType.SoftOneStatusEventAnalysis:
                                if (!base.IsLicense100())
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportTemplateDataNotFound);
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateSoftOneStatusEvent(reportResult);
                                break;
                            case SoeReportTemplateType.SoftOneStatusUpTimeAnalysis:
                                if (!base.IsLicense100())
                                    reportResult.SetErrorMessage(SoeReportDataResultMessage.ReportTemplateDataNotFound);
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateSoftOneStatusUpTime(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeFixedPayLinesAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeFixedPayLines(reportResult);
                                break;
                            case SoeReportTemplateType.PayrollProductsAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreatePayrollProducts(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeSalaryDistressAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeSalaryDistress(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeSalaryUnionFeesAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeSalaryUnionFees(reportResult);
                                break;
                            case SoeReportTemplateType.EmploymentDaysAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmploymentDays(reportResult);
                                break;
                            case SoeReportTemplateType.AccountHierachyAnalysis:
                                reportResult.MatrixResult = ManageMatrixDataManager.CreateAccountHierarchy(reportResult);
                                break;
                            case SoeReportTemplateType.VacationBalanceAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateVacationBalance(reportResult);
                                break;
                            case SoeReportTemplateType.ShiftQueueAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateShiftQueues(reportResult);
                                break;
                            case SoeReportTemplateType.ShiftHistoryAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateShiftHistories(reportResult);
                                break;
                            case SoeReportTemplateType.ShiftRequestAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateShiftRequests(reportResult);
                                break;
                            case SoeReportTemplateType.AbsenceRequestAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateAbsenceRequests(reportResult);
                                break;
                            case SoeReportTemplateType.VismaPayrollChangesAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateVismaPayrollChanges(reportResult);
                                break;
                            case SoeReportTemplateType.TimeStampHistoryAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateTimeStampHistory(reportResult);
                                break;
                            case SoeReportTemplateType.VerticalTimeTrackerAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateVerticalTimeTracker(reportResult);
                                break;
                            case SoeReportTemplateType.HorizontalTimeTrackerAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateHorizontalTimeTracker(reportResult);
                                break;
                            case SoeReportTemplateType.AgiAbsenceAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateAgiAbsence(reportResult);
                                break;
                            case SoeReportTemplateType.InventoryAnalysis:
                                reportResult.MatrixResult = EconomyMatrixDataManager.CreateInventoryData(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeeChildAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeeChild(reportResult);
                                break;
                            case SoeReportTemplateType.EmployeePayrollAdditionsAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateEmployeePayrollAdditions(reportResult);
                                break;
                            case SoeReportTemplateType.AnnualLeaveTransactionAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateAnnualLeaveTransaction(reportResult);
                                break;
							case SoeReportTemplateType.DepreciationAnalysis:
								reportResult.MatrixResult = EconomyMatrixDataManager.CreateDepreciationData(reportResult);
								break;
                            case SoeReportTemplateType.SwapShiftAnalysis:
                                reportResult.MatrixResult = TimeMatrixDataManager.CreateSwapShiftData(reportResult);
                                break;
                        }

                        if (reportResult.MatrixResult != null)
                        {
                            if (reportResult.ExportType == TermGroup_ReportExportType.MatrixExcel)
                            {
                                reportResult.Data = ExcelMatrix.GetExcelFile(reportResult.MatrixResult, "Tab");
                            }
                            else if (reportResult.ExportType == TermGroup_ReportExportType.MatrixText)
                            {
                                reportResult.Data = ExcelMatrix.GetTextFile(reportResult.MatrixResult, ';', 2);
                            }
                            else
                            {
                                var fields = reportResult.MatrixResult.MatrixFields;
                                var handled = false;

                                try
                                {
                                    if (fields.Count() < 5000)
                                    {
                                        reportResult.Data = Encoding.UTF8.GetBytes(JsonConvert.SerializeObject(reportResult.MatrixResult, new JsonSerializerSettings
                                        {
                                            ContractResolver = new DefaultContractResolver
                                            {
                                                NamingStrategy = new CamelCaseNamingStrategy()
                                            },
                                            Formatting = Newtonsoft.Json.Formatting.None
                                        }));
                                        handled = true;
                                    }

                                }
                                catch (Exception ex)
                                {
                                    LogCollector.LogError($"Error when trying to create json for matrix result. fields {fields.Count()}" + ex.ToString());
                                }
                                
                                if (!handled)
                                {
                                    LogCollector.LogInfo("Use filestream for large matrix result. (json)" + reportResult.MatrixResult.MatrixFields.Count + " fields.");
                                    var filePath = ConfigSettings.SOE_SERVER_DIR_TEMP_PHYSICAL + Guid.NewGuid().ToString() + "_FS";
                                    try
                                    {
                                        // Step 1: Stream the JSON directly to a file
                                        using (var fileStream = new FileStream(filePath, FileMode.Create, FileAccess.Write, FileShare.None))
                                        using (var streamWriter = new StreamWriter(fileStream, Encoding.UTF8))
                                        using (var jsonWriter = new JsonTextWriter(streamWriter))
                                        {
                                            // Create JSON serializer
                                            JsonSerializer serializer = new JsonSerializer
                                            {
                                                ContractResolver = new DefaultContractResolver
                                                {
                                                    NamingStrategy = new CamelCaseNamingStrategy()
                                                },
                                                Formatting = Newtonsoft.Json.Formatting.None
                                            };

                                            // Stream the serialized JSON to the file
                                            serializer.Serialize(jsonWriter, reportResult.MatrixResult);
                                        }
                                        LogCollector.LogInfo("Use filestream for large matrix result. (json) file done" + filePath);
                                        // Step 2: (Optional) Read the file back into a byte array if needed
                                        byte[] fileBytes;
                                        using (var fileStream = new FileStream(filePath, FileMode.Open, FileAccess.Read))
                                        {
                                            using (var memoryStream = new MemoryStream())
                                            {
                                                fileStream.CopyTo(memoryStream);
                                                fileBytes = memoryStream.ToArray(); // Convert the file contents to a byte array
                                            }
                                        }
                                        reportResult.Data = fileBytes;
                                    }
                                    catch (Exception ex)
                                    {
                                        LogCollector.LogError("Error when trying to create filestream for large matrix result. (json) " + ex.ToString());
                                    }
                                    finally
                                    {
                                        if (File.Exists(filePath))
                                            File.Delete(filePath);
                                    }
                                }
                            }
                        }
                        else
                            reportResult.SetErrorMessage(SoeReportDataResultMessage.ExportFailed);
                    }
                }
            }
            else
            {
                reportResult.SetErrorMessage(SoeReportDataResultMessage.EmptyInput);
            }

            return reportResult.Success && reportResult.Data != null;
        }

        public bool TryCreateExportFile(CreateReportResult reportResult, bool forceExcelExport = false)
        {
            if (reportResult == null)
                return false;

            if (reportResult.Input != null)
                SetTermGroup_ReportExportFileType(reportResult);

            if (reportResult.Success || reportResult.HasValidSelection)
            {
                if (reportResult.Data == null)
                {
                    using (CompEntities entities = new CompEntities())
                    {
                        this.Company = reportResult.Input?.Company ?? CompanyManager.GetCompany(entities, reportResult.ActorCompanyId);

                        switch (reportResult.ExportFileType)
                        {
                            case TermGroup_ReportExportFileType.Payroll_SIE_Accounting:
                                var sie = new PayrollAccountSIE(parameterObject, reportResult);
                                reportResult.FilePath = sie.CreatePayrollAccountSIEFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_SAP_Accounting:
                                var sap = new PayrollAccountSAP(parameterObject, reportResult);
                                reportResult.FilePath = sap.CreatePayrollAccountSAPFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_SAP_HRL:
                                var sapHrl = new PayrollAccountSAP(parameterObject, reportResult);
                                reportResult.FilePath = sapHrl.CreatePayrollSAPHrlFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_Visma_Accounting:
                                var visma = new PayrollAccountVisma(parameterObject, reportResult);
                                reportResult.FilePath = visma.CreatePayrollAccountVismaFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_SIE_VacationAccounting:
                                var sieVacation = new PayrollAccountSIE(parameterObject, reportResult);
                                reportResult.FilePath = sieVacation.CreatePayrollVacationAccountSIEFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_SAP_VacationAccounting:
                                var sapVacation = new PayrollAccountSAP(parameterObject, reportResult);
                                reportResult.FilePath = sapVacation.CreatePayrollVacationAccountSAPFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_SCB_Statistics:
                                var scb = new SCBStatisticsFiles(parameterObject, reportResult);
                                reportResult.FilePath = scb.CreateSCB_PayrollStatisticsFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_SN_Statistics:
                                var sn = new SCBStatisticsFiles(parameterObject, reportResult);
                                reportResult.FilePath = sn.CreateSN_PayrollStatisticsFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Payroll_Fremia_Statistics:
                                var fremia = new SCBStatisticsFiles(parameterObject, reportResult);
                                reportResult.FilePath = fremia.CreateFremia_PayrollStatisticsFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.KU10:
                                var ku10 = new KU10(parameterObject, reportResult);
                                reportResult.FilePath = ku10.CreateKU10File(entities);
                                break;
                            case TermGroup_ReportExportFileType.eSKD:
                                var eskd = new eSKDUpload(parameterObject, reportResult);
                                reportResult.FilePath = reportResult.ReportTemplateType == SoeReportTemplateType.TaxAudit ? eskd.CreateFileERP(entities, this.Company) : eskd.CreateFileHR(entities, reportResult);
                                break;
                            case TermGroup_ReportExportFileType.QlikViewType1:
                                var qlickview = new QlikviewType1(parameterObject, reportResult);
                                reportResult.FilePath = qlickview.CreateFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Collectum:
                                var collectum = new Collectum(parameterObject, reportResult);
                                reportResult.FilePath = collectum.CreateCollectumFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Fora:
                                var fora = new Fora(parameterObject, reportResult);
                                reportResult.FilePath = fora.CreateFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.KPA:
                                var kpa = new Kpa(parameterObject, reportResult);
                                reportResult.FilePath = kpa.CreateFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.SCB_KSJU:
                                var SCB_KSJU = new SCBStatisticsFiles(parameterObject, reportResult);
                                reportResult.FilePath = SCB_KSJU.CreateSCBKSJUFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.AGD_Franvarouppgift:
                            case TermGroup_ReportExportFileType.AGD:
                                var ku10Agd = new KU10(parameterObject, reportResult);
                                reportResult.FilePath = ku10Agd.CreateAgdEmployeeFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.KPADirekt:
                                var kpadirekt = new Kpa(parameterObject, reportResult);
                                reportResult.FilePath = kpadirekt.CreateKPADirektFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.SCB_KLP:
                                var SCB_KLP = new SCBStatisticsFiles(parameterObject, reportResult);
                                reportResult.FilePath = SCB_KLP.CreateSCBKLPFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Bygglosen:
                                var bygglosen = new Bygglosen(parameterObject, reportResult);
                                reportResult.FilePath = bygglosen.CreateBygglosenFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.Kronofogden:
                                var kronofogden = new Kronofogden(parameterObject, reportResult);
                                reportResult.FilePath = kronofogden.CreateKronofogdenFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.ICACustomerBalance:
                                var icaBalance = new ICACustomerBalance(parameterObject, reportResult);
                                reportResult.FilePath = icaBalance.CreateFile();
                                break;
                            case TermGroup_ReportExportFileType.PIRATVoucher:
                                var piratVoucher = new PIRATVoucher(parameterObject, reportResult);
                                reportResult.FilePath = piratVoucher.CreateFile(entities);
                                break;
                            case TermGroup_ReportExportFileType.FolksamGTP:
                                var folksamGTP = new FolksamGTP(parameterObject, reportResult);
                                reportResult.FilePath = folksamGTP.CreateFolksamGTPFile(entities, forceExcelExport);
                                break;
                            case TermGroup_ReportExportFileType.IFMetall:
                                var iFMetall = new IFMetall(parameterObject, reportResult);
                                reportResult.FilePath = iFMetall.CreateIFMetallFile(entities, forceExcelExport);
                                break;
                            case TermGroup_ReportExportFileType.SkandiaPension:
                                var skandiaPension = new SkandiaPension(parameterObject, reportResult);
                                reportResult.FilePath = skandiaPension.CreateSkandiaPensionFile(entities, forceExcelExport);
                                break;
                            case TermGroup_ReportExportFileType.ForaMonthly:
                                var foraMonthly = new ForaMonthly(parameterObject, reportResult);
                                reportResult.FilePath = foraMonthly.CreateForaMonthlyFile(entities, forceExcelExport);
                                break;
                            case TermGroup_ReportExportFileType.SEF:
                                var sEF = new SEF(parameterObject, reportResult);
                                reportResult.FilePath = sEF.CreateSEFFile(entities, forceExcelExport);
                                break;
                        }

                        if (!string.IsNullOrEmpty(reportResult.FilePath))
                        {
                            reportResult.Data = File.ReadAllBytes(reportResult.FilePath);
                        }
                        //not to hide any error messages set from the export function
                        else if (reportResult.ResultMessage == SoeReportDataResultMessage.Success || reportResult.ResultMessage == SoeReportDataResultMessage.Error)
                        {
                            reportResult.SetErrorMessage(SoeReportDataResultMessage.ExportFailed);
                        }
                    }
                }
            }
            else
            {
                reportResult.SetErrorMessage(SoeReportDataResultMessage.EmptyInput);
            }

            return reportResult.Success && reportResult.Data != null;
        }

        #endregion

        #region Economy

        private XDocument CreateVoucherListData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            //Get AccountDims
            AccountDimDTO accountDimStdDTO = AccountManager.GetAccountDimStd(es.ActorCompanyId).ToDTO();
 //           List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId).ToDTOs();
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();
            List<AccountInternalDTO> accountInternalInIntervalDTOs = new List<AccountInternalDTO>();
            List<AccountPeriod> accountPeriods = AccountManager.GetAccountPeriods(es.ActorCompanyId);
            List<AccountPeriodDTO> accountPeriodDTOs = new List<AccountPeriodDTO>();
            List<AccountYearDTO> accountYearsDTOs = AccountManager.GetAccountYears(es.ActorCompanyId, false, false).ToDTOs().ToList();
            // Get company name for clearer logging
            string companyName_shortName = CompanyManager.GetCompanyName(es.ActorCompanyId, true, false);


            foreach (var period in accountPeriods)
            {
                accountPeriodDTOs.Add(period.ToDTO());
            }

            //Get sysVatAccounts
            List<SysVatAccount> sysVatAccounts = AccountManager.GetSysVatAccounts(true);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "VoucherList");

            //VoucherList
            XElement voucherListElement = new XElement("VoucherList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateLatestVoucherLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherSerieIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            CreateAccountingOrderReportHeaderLabelsElement(reportHeaderLabelsElement);
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            voucherListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(es);
            reportHeaderElement.Add(CreateLatestVoucherElement(es));
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateVoucherIntervalElement(es));
            reportHeaderElement.Add(CreateVoucherSerieIntervalElement(es));
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            reportHeaderElement.Add(new XElement("CompanyShortname", companyName_shortName));
            reportHeaderElement.Add(new XElement("ExportType", es.ExportType));
            voucherListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStdDTO, accountDimInternalsDTOs);
            CreateVoucherListPageHeaderLabelsElement(pageHeaderLabelsElement);
            voucherListElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                bool addYear = false;
                bool addPeriod = false;
                AccountYearDTO accountYearDTO = null;
                DateTime? from = null;
                DateTime? to = null;
                int voucherHeadXmlId = 1;

                List<VoucherHeadDTO> voucherHeads = VoucherManager.GetVoucherHeadDTOsFromSelection(es, accountDimStdDTO, orderByVoucherNr: false);
                List<AccountStd> accounts = AccountManager.GetAccountStdsByCompany(es.ActorCompanyId, null, false, false);

                List<AccountStd> accountStdsInInterval = new List<AccountStd>();
                List<AccountInternal> accountInternalsInInterval = new List<AccountInternal>();
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
                bool validSelection = AccountManager.GetAccountsInInterval(entities, es, accountDimStd, false, ref accountStdsInInterval, ref accountInternalsInInterval);
                if (validSelection && accountInternalsInInterval.Any())
                    accountInternalInIntervalDTOs = accountInternalsInInterval.ToDTOs();

                foreach (VoucherHeadDTO voucherHead in voucherHeads)
                {
                    if (voucherHead.Template)
                        continue;

                    #region Content

                    XElement apEl = reportHeaderElement.Elements("AccountPeriod").FirstOrDefault();
                    if (apEl.Value == String.Empty)
                    {
                        addPeriod = true;

                        if (accountPeriodDTOs.Any(p => p.AccountPeriodId == voucherHead.AccountPeriodId))
                        {
                            var accountPeriod = accountPeriodDTOs.FirstOrDefault(p => p.AccountPeriodId == voucherHead.AccountPeriodId);
                            if (from == null || accountPeriod.From <= from)
                                from = accountPeriod.From;
                            if (to == null || accountPeriod.To <= to)
                                to = accountPeriod.To;
                        }
                    }

                    XElement ayEl = reportHeaderElement.Elements("AccountYear").FirstOrDefault();
                    if (ayEl?.Value == String.Empty && accountYearDTO == null && accountYearsDTOs.Any(y => y.AccountYearId == voucherHead.AccountYearId))
                    {
                        addYear = true;
                        accountYearDTO = accountYearsDTOs.FirstOrDefault(y => y.AccountYearId == voucherHead.AccountYearId);
                    }

                    //VoucherHead
                    XElement voucherHeadElement = new XElement("VoucherHead",
                        new XAttribute("id", voucherHeadXmlId),
                        new XElement("VoucherNr", voucherHead.VoucherNr),
                        new XElement("VoucherSerieNr", voucherHead.VoucherSeriesTypeNr),
                        new XElement("VoucherSerieName", voucherHead.VoucherSeriesTypeName),
                        new XElement("VoucherDate", voucherHead.Date),
                        new XElement("VoucherText", voucherHead.Text),
                        new XElement("IsVatVoucher", voucherHead.VatVoucher.ToInt()),
                        new XElement("IsAccountingOrder", es.SV_IsAccountingOrder.ToInt()));

                    //VoucherRows
                    int voucherRowXmlId = 1;
                    foreach (VoucherRowDTO voucherRowDTO in voucherHead.Rows.OrderBy(r => r.VoucherRowId))
                    {
                        //Skip inactive or deleted rows
                        if (voucherRowDTO.State != (int)SoeEntityState.Active)
                            continue;
                        if (!VoucherManager.VoucherRowDTOContainsAccountInternals(voucherRowDTO, accountInternalInIntervalDTOs))
                            continue;

                        //Debet and credit
                        this.GetDebetCredit(voucherRowDTO.Amount, out decimal debet, out decimal credit);

                        //Date
                        DateTime voucherRowDate = voucherHead.Date;
                        if (voucherRowDTO.Date != null)
                            voucherRowDate = Convert.ToDateTime(voucherRowDTO.Date);

                        //VatAccount
                        string vatAccountName = string.Empty;
                        int vatAccountVatNr1 = 0;
                        int vatAccountVatNr2 = 0;
                        decimal vatAccountPercent = 0;

                        if (sysVatAccounts.Any() && accounts.Any(a => a.AccountId == voucherRowDTO.Dim1Id && a.SysVatAccountId.HasValue))
                        {
                            int? sysVatAccountId = accounts.FirstOrDefault(a => a.AccountId == voucherRowDTO.Dim1Id)?.SysVatAccountId;

                            if (sysVatAccountId.HasValue && sysVatAccountId != 0 && sysVatAccounts.Any(v => v.SysVatAccountId == (int)sysVatAccountId))
                            {
                                SysVatAccount sysVatAccount = sysVatAccounts.FirstOrDefault(v => v.SysVatAccountId == (int)sysVatAccountId);
                                if (sysVatAccount != null)
                                {
                                    vatAccountName = sysVatAccount.Name;
                                    vatAccountVatNr1 = sysVatAccount.VatNr1.HasValue ? (int)sysVatAccount.VatNr1 : 0;
                                    vatAccountVatNr2 = sysVatAccount.VatNr2.HasValue ? (int)sysVatAccount.VatNr2 : 0;
                                    vatAccountPercent = sysVatAccount.SysVatRate != null ? sysVatAccount.SysVatRate.VatRate : 0;
                                }
                            }
                        }


                        //VoucherRow
                        XElement voucherRowElement = new XElement("VoucherRow",
                            new XAttribute("id", voucherRowXmlId),
                            new XElement("VoucherRowDate", voucherRowDate),
                            new XElement("VoucherRowText", voucherRowDTO.Text),
                            new XElement("AccountNr", voucherRowDTO.Dim1Nr),
                            new XElement("AccountName", voucherRowDTO.Dim1Name),
                            new XElement("VatAccountName", vatAccountName),
                            new XElement("VatAccountVatNr1", vatAccountVatNr1),
                            new XElement("VatAccountVatNr2", vatAccountVatNr2),
                            new XElement("VatAccountPercent", vatAccountPercent),
                            new XElement("Debit", debet),
                            new XElement("Credit", credit),
                            new XElement("Quantity", Convert.ToDecimal(voucherRowDTO.Quantity)),
                            new XElement("VoucherRowNr", voucherRowDTO.RowNr.HasValue ? voucherRowDTO.RowNr : voucherRowXmlId)
                            );

                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                        {
                            if (i > accountDimInternalsDTOs.Count)
                            {
                                voucherRowElement.Add(
                                    new XElement("AccountInternalNr" + i, String.Empty),
                                    new XElement("AccountInternalName" + i, String.Empty));
                                continue;
                            }

                            AccountInternalDTO accountInternal = null;
                            var accountDim = accountDimInternalsDTOs.Any() ? accountDimInternalsDTOs.ElementAt(i - 1) : null;
                            if (accountDim != null)
                                accountInternal = voucherRowDTO.AccountInternalDTO_forReports.FirstOrDefault(ai => ai.AccountDimId == accountDim.AccountDimId);

                            voucherRowElement.Add(
                                new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                                new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
                        }

                        voucherHeadElement.Add(voucherRowElement);
                        voucherRowXmlId++;
                    }

                    #region Default element VoucherRow

                    if (voucherRowXmlId == 1)
                        voucherHeadElement.Add(new XElement("VoucherRow", String.Empty));

                    #endregion

                    voucherListElement.Add(voucherHeadElement);
                    voucherHeadXmlId++;

                    #endregion
                }

                if (addPeriod)
                {
                    XElement accountPeriodElement = reportHeaderElement.Elements("AccountPeriod").FirstOrDefault();
                    if (accountPeriodElement != null && from != null && to != null)
                        accountPeriodElement.Value = ((DateTime)from).ToShortDateString() + "-" + ((DateTime)to).ToShortDateString();
                }

                if (addYear)
                {
                    XElement accountYearElement = reportHeaderElement.Elements("AccountYear").FirstOrDefault();
                    if (accountYearElement != null && accountYearDTO != null)
                        accountYearElement.Value = accountYearDTO.From.ToShortDateString() + "-" + accountYearDTO.To.ToShortDateString();
                }

                #region Default element VoucherHead/VoucherRow

                if (voucherHeadXmlId == 1)
                {
                    XElement voucherHeadElement = new XElement("VoucherHead",
                        new XAttribute("id", 1),
                        new XElement("VoucherNr", 0),
                        new XElement("VoucherSerieNr", "-"),
                        new XElement("VoucherSerieName", "-"),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherText", "-"));

                    XElement voucherRowElement = new XElement("VoucherRow",
                        new XAttribute("id", 1));

                    voucherHeadElement.Add(voucherRowElement);
                    voucherListElement.Add(voucherHeadElement);
                }

                #endregion
            }

            #region Close document

            rootElement.Add(voucherListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.VoucherList);

            #endregion
        }

        private XDocument CreateGeneralLedgerData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId).ToDTOs();
            string companyName_shortName = CompanyManager.GetCompanyName(es.ActorCompanyId, true, false);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "GeneralLedger");

            //GeneralLedger
            XElement generalLedgerElement = new XElement("GeneralLedger");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateLatestVoucherLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            generalLedgerElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(es);
            reportHeaderElement.Add(CreateLatestVoucherElement(es));
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            AddEnterpriseCurrencyPageLabelElements(reportHeaderElement);
            reportHeaderElement.Add(new XElement("SeparateAccountDim", es.SSTD_SeparateAccountDim.ToInt()));
            reportHeaderElement.Add(new XElement("CompanyShortname", companyName_shortName));
            reportHeaderElement.Add(new XElement("ExportType", es.ExportType));
            generalLedgerElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            CreateGeneralLedgerPageHeaderLabelsElement(pageHeaderLabelsElement);
            generalLedgerElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                AccountYear accountYear = null;
                List<AccountStd> accountStdsInInterval = new List<AccountStd>();

                List<AccountInternal> accountInternalsInInterval = new List<AccountInternal>();
                List<AccountInternal> reportAccountInternalsInInterval = new List<AccountInternal>();
                List<VoucherRowDTO> voucherRowDTOs = new List<VoucherRowDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalanceDict = new Dictionary<int, BalanceItemDTO>();
                List<AccountDTO> accountStdInIntervalDTOs = new List<AccountDTO>();
                List<AccountInternalDTO> accountInternalInIntervalDTOs = new List<AccountInternalDTO>();
                List<AccountInternalDTO> reportAccountInternalInIntervalDTOs = new List<AccountInternalDTO>();
                AccountYearDTO accountYearDTO = new AccountYearDTO();
                List<AccountDimDTO> accountDimInternalDTOs = new List<AccountDimDTO>();

                //if (es.SSTD_SeparateAccountDim)
                //{
                //    es.OnlyActiveAccounts = true;
                //}

                bool validSelection = AccountManager.GetAccountsInInterval(entities, es, accountDimStd, false, ref accountStdsInInterval, ref reportAccountInternalsInInterval);
                if (validSelection)
                {
                    #region Load data

                    voucherRowDTOs = VoucherManager.GetVoucherRowsDTOFromSelection(entities, es);

                    //AccountYear
                    accountYear = AccountManager.GetAccountYear(entities, es.SSTD_AccountYearId);
                    accountYearDTO = accountYear.ToDTO();


                    if (reportAccountInternalsInInterval.Any())
                        reportAccountInternalInIntervalDTOs = reportAccountInternalsInInterval.ToDTOs();

                    if (accountStdsInInterval.Any())
                    {
                        foreach (var account in accountStdsInInterval)
                        {
                            accountStdInIntervalDTOs.Add(account.ToDTO());
                        }
                    }

                    if (accountDimInternals.Any())
                        accountDimInternalDTOs = accountDimInternals.ToDTOs();

                    if (accountYear != null)
                    {
                        if (accountYear.From != es.DateFrom)
                        {
                            biBalanceChangeToPeriodDict = AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeFromDTO(accountYearDTO, accountYear.From, CalendarUtility.GetEndOfDay(es.UntilDateFrom), accountStdInIntervalDTOs,
                                accountDimInternalDTOs, reportAccountInternalInIntervalDTOs, es.ActorCompanyId);
                        }

                        //Ingående balans för aktuellt år
                        biYearInBalanceDict = AccountBalanceManager(es.ActorCompanyId).GetYearInBalanceFromDTO(entities, accountYearDTO, accountStdInIntervalDTOs, reportAccountInternalInIntervalDTOs, es.ActorCompanyId);
                    }


                    #endregion
                }

                if (accountStdInIntervalDTOs != null)
                {
                    accountStdInIntervalDTOs = AccountManager.TranslateAccountNamesByLang(accountStdInIntervalDTOs); // 2015-04-27 / Jukka - Translate account names for the names for which current translation exists
                }
                #endregion

                #region Content

                bool isAccountSelectionValid = AccountManager.GetAccountsInInterval(entities, es, accountDimStd, false, ref accountStdsInInterval, ref reportAccountInternalsInInterval);

                int reportI = 0;

                while (isAccountSelectionValid)
                {
                    if (reportAccountInternalInIntervalDTOs.Count > 0 && es.SSTD_SeparateAccountDim)
                    {
                        int accountMatchCounter = 0;
                        foreach (var account in reportAccountInternalInIntervalDTOs)
                        {
                            if (account.AccountDimId == es.SSTD_AccountDimId)
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                            else
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                        }
                    }
                    else
                        accountInternalInIntervalDTOs = reportAccountInternalInIntervalDTOs;

                    #region Sheet

                    int sheetId = 1;
                    XElement sheetElement = new XElement("Sheet");
                    if (accountInternalInIntervalDTOs.Count > 0 && es.SSTD_SeparateAccountDim)
                    {
                        AccountInternalDTO accountinternal = null;

                        int accountMatchCounter = 0;
                        foreach (var account in reportAccountInternalInIntervalDTOs)
                        {
                            if (account.AccountDimId == es.SSTD_AccountDimId)
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountinternal = account;
                                }
                                accountMatchCounter++;
                            }
                            else
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountinternal = account;
                                }
                                accountMatchCounter++;
                            }
                        }

                        var accountdiminternal = accountDimInternals.FirstOrDefault(i => i.AccountDimId == accountinternal.AccountDimId);

                        sheetElement.Add(
                            new XAttribute("id", (reportI + 1)),
                            new XElement("DimensionNr", accountinternal?.AccountDimNr.ToString()),
                            new XElement("DimensionName", accountdiminternal?.Name),
                            new XElement("InternalNr", accountinternal?.AccountNr),
                            new XElement("InternalName", accountinternal?.Name)
                        );
                    }
                    else
                    {
                        sheetElement.Add(
                        new XAttribute("id", sheetId),
                        new XElement("DimensionNr", String.Empty),
                        new XElement("DimensionName", String.Empty),
                        new XElement("InternalNr", String.Empty),
                        new XElement("InternalName", String.Empty));
                    }
                    #endregion

                    int accountId = 1;

                    #region ByDTO

                    if (validSelection)
                    {
                        if (es.SSTD_ProjectReport)
                        {
                            XElement accountElement = null;
                            XElement voucherRowElement = null;



                            int projectDimId = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).Where(d => d.LinkedToProject).Select(d => d.AccountDimId).FirstOrDefault();

                            List<AccountInternalDTO> projectsInInterval = accountInternalInIntervalDTOs.Where(a => a.AccountDimId == projectDimId).ToList();

                            //get all projects if user hasn't given any interval
                            if (!projectsInInterval.Any())
                                projectsInInterval = AccountManager.GetAccountInternalsByDim(projectDimId, es.ActorCompanyId).ToDTOs();

                            List<AccountInternalDTO> accountsInInterval2 = null;

                            //project report handles one additional level of internal accounts in addition to project (e.g. costplaces)
                            if (es.SA_AccountIntervals != null)
                            {
                                for (int i = 0; i < es.SA_AccountIntervals.Count; i++)
                                {
                                    if (es.SA_AccountIntervals[i].AccountDimId == accountDimStd.AccountDimId || es.SA_AccountIntervals[i].AccountDimId == projectDimId)
                                        continue;

                                    if (accountsInInterval2 == null)
                                        accountsInInterval2 = accountInternalInIntervalDTOs.Where(a => a.AccountDimId == es.SA_AccountIntervals[i].AccountDimId).ToList();
                                }
                            }

                            foreach (var project in projectsInInterval)
                            {
                                foreach (AccountDTO account in accountStdInIntervalDTOs)
                                {

                                    //VoucherRows for AccountStd
                                    List<VoucherRowDTO> voucherRowDTOForAccount = voucherRowDTOs.Where(vr => vr.Dim1Id == account.AccountId).ToList();

                                    List<VoucherRowDTO> projectRows = voucherRowDTOForAccount.Where(r => r.Dim1Id == account.AccountId && (r.Dim2Id == project.AccountId ||
                                                                r.Dim3Id == project.AccountId || r.Dim4Id == project.AccountId ||
                                                                r.Dim5Id == project.AccountId || r.Dim6Id == project.AccountId)).ToList();

                                    if (accountsInInterval2 == null)
                                    {
                                        if (projectRows.Count > 0)
                                        {
                                            accountElement = CreateAccountElementForProjectReport(accountId, account, projectRows, es.DateFrom);

                                            int voucherRowXmlId = 0;
                                            bool hasTransactions = false;

                                            foreach (var voucherRow in projectRows.Where(r => r.Date >= es.DateFrom && r.Date <= es.DateTo).ToList())
                                            {
                                                voucherRowElement = CreateVoucherRowElementsForProjectReport(voucherRowXmlId, voucherRow, accountDimInternals);

                                                if (voucherRowElement != null)
                                                {
                                                    hasTransactions = true;
                                                    accountElement.Add(voucherRowElement);
                                                    voucherRowXmlId++;
                                                }
                                            }

                                            if (!hasTransactions)
                                            {
                                                voucherRowElement = new XElement("VoucherRow",
                                                    new XAttribute("id", 1));

                                                accountElement.Add(voucherRowElement);
                                            }

                                            if (accountElement != null)
                                            {
                                                sheetElement.Add(accountElement);
                                                accountId++;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        foreach (var accountInternal2 in accountsInInterval2)
                                        {
                                            List<VoucherRowDTO> accountInternal2Rows = projectRows.Where(r => r.Dim2Id == accountInternal2.AccountId ||
                                                                        r.Dim3Id == accountInternal2.AccountId || r.Dim4Id == accountInternal2.AccountId ||
                                                                        r.Dim5Id == accountInternal2.AccountId || r.Dim6Id == accountInternal2.AccountId).ToList();

                                            if (accountInternal2Rows.Count > 0)
                                            {
                                                accountElement = CreateAccountElementForProjectReport(accountId, account, accountInternal2Rows, es.DateFrom);

                                                int voucherRowXmlId = 0;
                                                bool hasTransactions = false;

                                                foreach (var voucherRow in accountInternal2Rows.Where(r => r.Date >= es.DateFrom && r.Date <= es.DateTo).ToList())
                                                {
                                                    voucherRowElement = CreateVoucherRowElementsForProjectReport(voucherRowXmlId, voucherRow, accountDimInternals);

                                                    if (voucherRowElement != null)
                                                    {
                                                        hasTransactions = true;
                                                        accountElement.Add(voucherRowElement);
                                                        voucherRowXmlId++;
                                                    }
                                                }

                                                if (!hasTransactions)
                                                {
                                                    voucherRowElement = new XElement("VoucherRow",
                                                        new XAttribute("id", 1));

                                                    accountElement.Add(voucherRowElement);
                                                }

                                                if (accountElement != null)
                                                {
                                                    sheetElement.Add(accountElement);
                                                    accountId++;
                                                }

                                            }
                                        }
                                    }
                                }
                            }
                        }
                        else
                        {
                            foreach (AccountDTO account in accountStdInIntervalDTOs)
                            {
                                #region AccountStd

                                //VoucherRows for AccountStd
                                List<VoucherRowDTO> voucherRowDTOForAccount = voucherRowDTOs.Where(vr => vr.Dim1Id == account.AccountId).ToList();
                                bool hasVoucherRows = voucherRowDTOForAccount.Count > 0;

                                //Get Balance
                                BalanceItemDTO biYearInBalance = AccountBalanceManager(es.ActorCompanyId).GetAccountBalanceFromDTO(accountYearDTO, account.AccountId, biYearInBalanceDict, biBalanceChangeToPeriodDict);
                                bool hasBalance = biYearInBalance.Balance != 0;

                                if (!hasVoucherRows && !hasBalance)
                                    continue;

                                XElement accountElement = null;
                                bool foundVoucherRows = false;

                                if (hasVoucherRows)
                                {
                                    #region Accounts with transactions

                                    int voucherRowXmlId = 1;
                                    foreach (VoucherRowDTO voucherRowDTO in voucherRowDTOForAccount)
                                    {
                                        #region Prereq VoucherRow

                                        if (!VoucherManager.VoucherRowDTOContainsAccountInternals(voucherRowDTO, accountInternalInIntervalDTOs))
                                            continue;
                                        foundVoucherRows = true;
                                        #endregion

                                        #region Account

                                        if (voucherRowXmlId == 1)
                                        {
                                            accountElement = CreateGeneralLedgerAccountElementFromDTO(es, accountId, account, biYearInBalance, accountDimInternalDTOs);
                                            if (accountElement == null)
                                                return null;
                                        }

                                        #endregion

                                        #region VoucherRow

                                        this.GetDebetCredit(voucherRowDTO.Amount, out decimal debet, out decimal credit);
                                        this.GetDebetCredit(voucherRowDTO.AmountEntCurrency, out decimal debetEntCurrency, out decimal creditEntCurrency);

                                        string voucherRowText = voucherRowDTO.Text;
                                        if (String.IsNullOrEmpty(voucherRowText))
                                            voucherRowText = voucherRowDTO.Text;

                                        XElement voucherRowElement = new XElement("VoucherRow",
                                            new XAttribute("id", voucherRowXmlId),
                                            new XElement("VoucherSerieNr", voucherRowDTO.VoucherSeriesTypeNr),
                                            new XElement("VoucherSerieName", voucherRowDTO.VoucherSeriesTypeName),
                                            new XElement("VoucherNr", voucherRowDTO.VoucherNr),
                                            new XElement("VoucherRowDate", voucherRowDTO.Date), //Cannot use VoucherRow.Date beacuse that data is corrupted in many cases (i.e. set to date when currency was fetched from ws)
                                            new XElement("VoucherRowText", voucherRowText),
                                            new XElement("Debit", debet),
                                            new XElement("DebitEntCurrency", debetEntCurrency),
                                            new XElement("Credit", credit),
                                            new XElement("CreditEntCurrency", creditEntCurrency),
                                            new XElement("Quantity", Convert.ToDecimal(voucherRowDTO.Quantity)));

                                        #region AccountInternal

                                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                                        {
                                            if (i > accountDimInternals.Count)
                                            {
                                                voucherRowElement.Add(
                                                    new XElement("AccountInternalNr" + i, String.Empty),
                                                    new XElement("AccountInternalName" + i, String.Empty));
                                                continue;
                                            }

                                            AccountInternalDTO accountInternal = null;
                                            var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                                            if (accountDim != null)
                                            {
                                                accountInternal = (from ai in voucherRowDTO.AccountInternalDTO_forReports
                                                                   where ai.AccountDimId == accountDim.AccountDimId
                                                                   select ai).FirstOrDefault<AccountInternalDTO>();
                                            }

                                            voucherRowElement.Add(
                                                new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                                                new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
                                        }

                                        #endregion

                                        accountElement.Add(voucherRowElement);
                                        voucherRowXmlId++;

                                        #endregion
                                    }

                                    #endregion
                                }
                                else if (hasBalance)
                                //                   && (!foundVoucherRows && (hasVoucherRows)))
                                {
                                    #region Accounts with no transactions but with Balance

                                    #region Account
                                    accountElement = CreateGeneralLedgerAccountElementFromDTO(es, accountId, account, biYearInBalance, accountDimInternalDTOs);

                                    #endregion

                                    #region VoucherRow

                                    XElement voucherRowElement = new XElement("VoucherRow",
                                        new XAttribute("id", 1));

                                    accountElement.Add(voucherRowElement);

                                    #endregion
                                    #endregion

                                }
                                if ((hasBalance) && (!foundVoucherRows) && (hasVoucherRows) && (accountId == 1))
                                {
                                    #region Accounts with no transactions but with Balance

                                    #region Account
                                    accountElement = CreateGeneralLedgerAccountElementFromDTO(es, accountId, account, biYearInBalance, accountDimInternalDTOs);

                                    #endregion

                                    #region VoucherRow

                                    XElement voucherRowElement = new XElement("VoucherRow",
                                        new XAttribute("id", 1));

                                    accountElement.Add(voucherRowElement);

                                    #endregion
                                    #endregion
                                }
                                //if (!foundVoucherRows && es.SSTD_SeparateAccountDim)
                                //{
                                //    accountElement = null;
                                //}
                                if (accountElement != null)
                                {
                                    sheetElement.Add(accountElement);
                                    accountId++;
                                }

                                #endregion

                            }

                        }
                    }

                    #region Default element Account

                    if (accountId == 1)
                    {
                        XElement accountElement = new XElement("Account",
                            new XAttribute("id", 1),
                            new XElement("AccountNr", "-"),
                            new XElement("AccountName", "-"),
                            new XElement("AccountBalance", 0));

                        XElement voucherRowElement = new XElement("VoucherRow",
                            new XAttribute("id", 1));

                        accountElement.Add(voucherRowElement);
                        sheetElement.Add(accountElement);
                    }

                    #endregion

                    #endregion

                    generalLedgerElement.Add(sheetElement);

                    reportI++;
                    if (reportAccountInternalInIntervalDTOs.Count > 0 && (reportI) < reportAccountInternalInIntervalDTOs.Count && es.SSTD_SeparateAccountDim)
                    {
                        accountInternalInIntervalDTOs.Clear();

                        int accountMatchCounter = 0;
                        foreach (var account in reportAccountInternalInIntervalDTOs)
                        {
                            if (account.AccountDimId == es.SSTD_AccountDimId)
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                            else
                            {
                                if (accountMatchCounter == reportI)
                                {
                                    accountInternalInIntervalDTOs.Add(account);
                                }
                                accountMatchCounter++;
                            }
                        }

                        AccountInternalDTO accountinternal = null;
                        if (es.SSTD_AccountDimId != 0)
                        {
                            accountinternal = accountInternalInIntervalDTOs.FirstOrDefault(i => i.AccountDimId == es.SSTD_AccountDimId);
                            if (accountinternal == null)
                                isAccountSelectionValid = false;
                        }
                        #endregion
                    }
                    else
                    {
                        isAccountSelectionValid = false;
                    }
                }
            }

            #region Close document

            rootElement.Add(generalLedgerElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.GeneralLedger);

            #endregion
        }

        public XDocument CreateBalanceReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "BalanceReport");

            //BalanceReport
            XElement balanceReportElement = new XElement("BalanceReport");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonData(es, balanceReportElement).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(balanceReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.BalanceReport);

            #endregion
        }

        public XDocument CreateResultReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ResultReport");

            //ResultReport
            XElement resultReportElement = new XElement("ResultReport");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonData(es, resultReportElement).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(resultReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ResultReport);

            #endregion
        }

        private XDocument CreateSruReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SruReport");

            //ResultReport
            XElement sruReport = new XElement("SruReport");

            #endregion

            #region Content

            if (!CreateBalanceResultAndSruReportCommonData(es, sruReport).Success)
                return null;

            #endregion

            #region Close document

            rootElement.Add(sruReport);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SruReport);

            #endregion
        }

        private XDocument CreateTaxAuditData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            AccountPeriod nextAccountPeriod = AccountManager.GetNextAccountPeriod(es.DateTo, es.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TaxAudit");

            //TaxAudit
            XElement taxAuditElement = new XElement("TaxAudit");

            #endregion

            #region ReportHeader

            CreateTaxAuditReportHeaderElement(es, taxAuditElement, nextAccountPeriod);

            #endregion

            using (var entities = new CompEntities())
            {
                #region Content

                entities.CommandTimeout = 180; // 3 minutes

                List<SysVatAccount> sysVatAccounts = SysDbCache.Instance.SysVatAccounts;
                List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(es.ActorCompanyId, null, true, false);
                if (accountStds != null)
                {
                    accountStds = AccountManager.TranslateAccountNamesByLang(accountStds); // 2015-03-16 / Jukka - Translate account names for the names for which current translation exists
                }
                List<AccountYear> accountYears = AccountManager.GetAccountYears(es.ActorCompanyId, false, es.DateFrom, es.DateTo);

                taxAuditElement.Add(new XElement("Output02", Company.OrgNr));
                taxAuditElement.Add(new XElement("Output05", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 05, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output06", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 06, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output07", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 07, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output08", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 08, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output10", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 10, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output11", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 11, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output12", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 12, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output20", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 20, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output21", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 21, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output22", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 22, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output23", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 23, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output24", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 24, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output30", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 30, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output31", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 31, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output32", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 32, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output35", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 35, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output36", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 36, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output37", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 37, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output38", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 38, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output39", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 39, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output40", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 40, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output41", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 41, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output42", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 42, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output48", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 48, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, false, true).Balance));
                taxAuditElement.Add(new XElement("Output50", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 50, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output51", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 51, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output52", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 52, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output55", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 55, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output57", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 57, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output59", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 59, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output81", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 81, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output82", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 82, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output83", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 83, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output84", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 84, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output85", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 85, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("Output86", nextAccountPeriod != null ? AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 86, accountYears, nextAccountPeriod.From, nextAccountPeriod.To, sysVatAccounts, accountStds, false, false, true).Balance : Decimal.Zero));
                taxAuditElement.Add(new XElement("OutputI50", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 50, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));
                taxAuditElement.Add(new XElement("OutputI60", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 60, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));
                taxAuditElement.Add(new XElement("OutputI61", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 61, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));
                taxAuditElement.Add(new XElement("OutputI62", AccountBalanceManager(es.ActorCompanyId).GetBalanceChangeForVatAccount(entities, es.ActorCompanyId, 62, accountYears, es.DateFrom, es.DateTo, sysVatAccounts, accountStds, false, true, true).Balance));

                #endregion
            }

            #region Close document

            rootElement.Add(taxAuditElement);
            document.Add(rootElement);

            #endregion

            #region Create Vat Voucher

            if (es.SSTD_CreateVatVoucher)
            {
                VoucherManager.CreateVatVoucher(es.DateFrom, es.DateTo.Date, es.ActorCompanyId);
            }

            #endregion

            return GetValidatedDocument(document, SoeReportTemplateType.TaxAudit);
        }

        private XDocument CreateTaxAudit_FI_Data(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TaxAudit_FI");

            //TaxAudit
            XElement taxAuditElement = new XElement("TaxAudit_FI");

            #endregion

            #region ReportHeader

            DateTimeFormatInfo dtfi = new CultureInfo(Thread.CurrentThread.CurrentCulture.Name, false).DateTimeFormat;

            string taxVatPeriod = dtfi.MonthNames[es.DateFrom.Month - 1] + " " + es.DateFrom.Year.ToString();

            taxAuditElement.Add(
                this.CreateCompanyElement(),
                new XElement("CompanyOrgNr", Company.OrgNr),
                new XElement("TaxVatPeriod", taxVatPeriod));

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                AccountYear accountYear = AccountManager.GetAccountYear(es.DateFrom, es.ActorCompanyId);
                List<SysVatAccount> sysVatAccounts = SysDbCache.Instance.SysVatAccounts;
                List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(es.ActorCompanyId, null, true, false);
                if (accountStds != null)
                {
                    accountStds = AccountManager.TranslateAccountNamesByLang(accountStds);
                }
                BalanceItemDTO balanceItem = new BalanceItemDTO();
                int actorCompanyId = es.ActorCompanyId;
                DateTime dateFrom = es.DateFrom;
                DateTime dateTo = es.DateTo;
                DateTime dateToPrevMonth = es.DateFrom.AddDays(-1);

                //suoritettava 24%:n vero kotimaan myynnistä
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 301),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 1, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 10, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 3, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 30, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 923, 1, reverseSign: true)));

                //suoritettava 14%:n vero kotimaan myynnistä
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 302),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 302, 1, reverseSign: true)));

                //suoritettava 10%:n vero kotimaan myynnistä
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 303),
                     CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 303, 1, reverseSign: true)));

                //vero tavaroiden maahantuonnista EU:n ulkopuolelta
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 304),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 6)));

                //vero tavaraostoista muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 305),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 6)));

                //vero palveluostoista muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 306),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 6)));

                //vero rakentamispalveluiden ostoista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 318),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 10)));

                //kohdekauden vähennettävä vero
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 307),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 307, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 301, 20),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 10)));

                //maksettava/palautettava arvonlisävero
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 308),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 301),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 302),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 303),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 304),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 305),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 306),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 318),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 308, 307)));

                //0-verokannan alainen liikevaihto
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 309),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 309, 1, reverseSign: true)));

                //tavaroiden maahantuonnit EU:n ulkopuolelta
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 310),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 10),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 40),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 304, 6)));

                //tavaroiden myynnit muihin EU-maihin
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 311),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 311, 1, reverseSign: true)));

                //palveluiden myynnit muihin EU-maihin
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 312),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 312, 1, reverseSign: true)));

                //tavaraostot muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 313),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 1),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 10),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 2),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 3),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 4),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 40),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 5),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 305, 6)));

                //palveluostot muista EU-maista
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 314),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 2),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 3),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 4),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 5),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 306, 6)));

                //rakentamispalvelun myynnit
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 319),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 319, 1, reverseSign: true)));

                //rakentamispalvelun ostot
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 320),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 1),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 320, 10)));

                //Käytetyt tavaran kaupan kertymä taseessa (AVL79)
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 920),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, accountYear.From, dateToPrevMonth, sysVatAccounts, accountStds, balanceItem, 920, 1, clearCache: true, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 921, 1, clearCache: true, reverseSign: true),
                    CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 922, 1, reverseSign: true)));

                //Suoritettavat verot
                taxAuditElement.Add(new XElement("TaxType", new XAttribute("id", 900),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 900, 1, reverseSign: true),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 900, 2, reverseSign: true),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 900, 20, reverseSign: true),
                   CreateTaxAuditTypeCodeElement(entities, actorCompanyId, accountYear, dateFrom, dateTo, sysVatAccounts, accountStds, balanceItem, 905, 1, reverseSign: true)));

                #endregion
            }

            #region Close document

            rootElement.Add(taxAuditElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.TaxAudit_FI);

            #endregion
        }

        private XDocument CreatePeriodAccountingRegulationsReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            List<GenericType> calculationTypes = base.GetTermGroupContent(TermGroup.AccountDistributionCalculationType);
            List<GenericType> triggerTypes = base.GetTermGroupContent(TermGroup.AccountDistributionTriggerType);
            List<GenericType> periodTypes = base.GetTermGroupContent(TermGroup.AccountDistributionPeriodType);
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId).ToDTOs();
            List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(es.ActorCompanyId, false);
            List<AccountDistributionHeadDTO> accountDistributionHeads = AccountDistributionManager.GetAccountDistributionHeads(es.ActorCompanyId, SoeAccountDistributionType.Period, false).ToDTOs(true, true, accountDimInternals).ToList();
            List<AccountDistributionHeadDTO> validaccountDistributionHeads = new List<AccountDistributionHeadDTO>();


            #region Validate Accounts

            if (es.SA_HasAccountInterval)
            {

                foreach (AccountDistributionHeadDTO accountDistributionHead in accountDistributionHeads)
                {
                    //Selection AccountInterval: Continue if there is no interval, or no VoucherRow have AccountStd/AccountInternal in interval
                    bool accountsValid = AccountDistributionManager.AccountDistributionHeadContainsAccounts(accountDistributionHead, es.SA_AccountIntervals, accountDimStd.AccountDimId);
                    if (!accountsValid)
                        continue;
                    validaccountDistributionHeads.Add(accountDistributionHead);
                }
                accountDistributionHeads = validaccountDistributionHeads;
            }

            #endregion

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "AccountDistributionHeadList");

            //TaxAudit
            XElement accountDistributionHeadListElement = new XElement("AccountDistributionHeadList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountDistributionHeadListReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            accountDistributionHeadListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(es);
            reportHeaderElement.Add(CreateLatestVoucherElement(es));
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            accountDistributionHeadListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateAccountDistributionHeadListPageHeaderLabelsElement(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            accountDistributionHeadListElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            foreach (var accountDistributionHead in accountDistributionHeads)
            {
                #region AccountDistributionHead

                XElement accountDistributionHeadElement = new XElement("AccountDistributionHead",
                    new XElement("Name", accountDistributionHead.Name),
                    new XElement("Description", accountDistributionHead.Description),
                    new XElement("CalculationType", calculationTypes.Where(i => i.Id == (int)accountDistributionHead.CalculationType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("StartDate", accountDistributionHead.StartDate != null ? accountDistributionHead.StartDate : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("EndDate", accountDistributionHead.EndDate != null ? accountDistributionHead.EndDate : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("DayNumber", accountDistributionHead.DayNumber),
                    new XElement("TriggerType", triggerTypes.Where(i => i.Id == (int)accountDistributionHead.TriggerType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("PeriodType", periodTypes.Where(i => i.Id == (int)accountDistributionHead.PeriodType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("PeriodValue", accountDistributionHead.PeriodValue),
                    new XElement("VoucherSerieName", accountDistributionHead.VoucherSeriesTypeId != null ? voucherSeriesTypes.Where(i => i.VoucherSeriesTypeId == accountDistributionHead.VoucherSeriesTypeId).Select(i => i.Name).FirstOrDefault() : string.Empty),
                    new XElement("UseInVoucher", accountDistributionHead.UseInVoucher.ToString()),
                    new XElement("UseInCustomerInvoice", accountDistributionHead.UseInCustomerInvoice.ToString()),
                    new XElement("UseInSupplierInvoice", accountDistributionHead.UseInSupplierInvoice.ToString()),
                    new XElement("UseInImport", accountDistributionHead.UseInImport.ToString()),
                    new XElement("Sort", accountDistributionHead.Sort),
                    new XElement("AccountDim1Expression", accountDistributionHead.Dim1Expression),
                    new XElement("AccountDim2Expression", accountDistributionHead.Dim2Expression),
                    new XElement("AccountDim3Expression", accountDistributionHead.Dim3Expression),
                    new XElement("AccountDim4Expression", accountDistributionHead.Dim4Expression),
                    new XElement("AccountDim5Expression", accountDistributionHead.Dim5Expression),
                    new XElement("AccountDim6Expression", accountDistributionHead.Dim6Expression),
                    new XElement("KeepRow", accountDistributionHead.KeepRow.ToString()),
                    new XElement("Amount", accountDistributionHead.Amount),
                    new XElement("AmountOperator", accountDistributionHead.AmountOperator));

                #endregion

                #region AccountDistributionRows

                foreach (var accountDistributionRow in accountDistributionHead.Rows)
                {
                    XElement accountDistributionRowElement = new XElement("AccountDistributionRow");

                    if (accountDistributionRow.Dim1Id == null)
                        accountDistributionRowElement.Add(
                            new XElement("AccountInternalStdNr", "*"),
                            new XElement("AccountInternalStdName", ""));
                    else
                        accountDistributionRowElement.Add(
                            new XElement("AccountInternalStdNr", accountDistributionRow.Dim1Nr),
                            new XElement("AccountInternalStdName", accountDistributionRow.Dim1Name));

                    accountDistributionRowElement.Add(
                         new XElement("AccountInternalNr1", accountDistributionRow.Dim2Nr),
                         new XElement("AccountInternalName1", accountDistributionRow.Dim2Name),
                         new XElement("AccountInternalNr2", accountDistributionRow.Dim3Nr),
                         new XElement("AccountInternalName2", accountDistributionRow.Dim3Name),
                         new XElement("AccountInternalNr3", accountDistributionRow.Dim4Nr),
                         new XElement("AccountInternalName3", accountDistributionRow.Dim4Name),
                         new XElement("AccountInternalNr4", accountDistributionRow.Dim5Nr),
                         new XElement("AccountInternalName4", accountDistributionRow.Dim5Name),
                         new XElement("AccountInternalNr5", accountDistributionRow.Dim6Nr),
                         new XElement("AccountInternalName5", accountDistributionRow.Dim6Name)
                        );

                    accountDistributionRowElement.Add(
                    new XElement("RowNumber", accountDistributionRow.RowNbr),
                    new XElement("CalculateRowNbr", accountDistributionRow.CalculateRowNbr),
                    new XElement("SameBalance", accountDistributionRow.SameBalance),
                    new XElement("OppositeBalance", accountDistributionRow.OppositeBalance),
                    new XElement("Description", accountDistributionRow.Description)
                    );

                    accountDistributionHeadElement.Add(accountDistributionRowElement);
                }

                accountDistributionHeadListElement.Add(accountDistributionHeadElement);

                #endregion
            }

            #endregion

            #region Close document

            rootElement.Add(accountDistributionHeadListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.PeriodAccountingRegulationsReport);

            #endregion
        }

        private XDocument CreatePeriodAccountingForecastReportData(EvaluatedSelection es)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                if (es == null)
                    return null;

                List<GenericType> calculationTypes = base.GetTermGroupContent(TermGroup.AccountDistributionCalculationType);
                List<GenericType> triggerTypes = base.GetTermGroupContent(TermGroup.AccountDistributionTriggerType);
                List<GenericType> periodTypes = base.GetTermGroupContent(TermGroup.AccountDistributionPeriodType);
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
                List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);
                List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId).ToDTOs();
                 List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(es.ActorCompanyId, false);

                List<AccountDistributionEntry> accountDistributionEntrys = AccountDistributionManager.GetAccountDistributionEntries(entities, es.ActorCompanyId, es.DateFrom.AddYears(-5), es.DateTo.AddYears(5), true).ToList();
                List<AccountDistributionEntry> validaccountDistributionEntrys = new List<AccountDistributionEntry>();

                #region Validate Accounts

                if (es.SA_HasAccountInterval)
                {

                    foreach (AccountDistributionEntry accountDistributionEntry in accountDistributionEntrys)
                    {
                        //Selection AccountInterval: Continue if there is no interval, or no VoucherRow have AccountStd/AccountInternal in interval
                        bool accountsValid = AccountDistributionManager.AccountDistributionEntryContainsAccounts(accountDistributionEntry, es.SA_AccountIntervals, accountDimStd.AccountDimId);
                        if (!accountsValid)
                            continue;
                        validaccountDistributionEntrys.Add(accountDistributionEntry);
                    }
                    accountDistributionEntrys = validaccountDistributionEntrys;
                }

                #endregion

                #endregion

                #region Init document

                //Document
                XDocument document = XmlUtil.CreateDocument();

                //Root
                XElement rootElement = new XElement(ROOT + "_" + "AccountDistributionEntriesList");

                XElement accountDistributionEntriesListElement = new XElement("AccountDistributionEntriesList");

                #endregion

                #region ReportHeaderLabels

                XElement reportHeaderLabelsElement = CreateAccountDistributionHeadListReportHeaderLabelsElement();
                reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
                accountDistributionEntriesListElement.Add(reportHeaderLabelsElement);

                #endregion

                #region ReportHeader

                XElement reportHeaderElement = CreateAccountingReportHeaderElement(es);
                reportHeaderElement.Add(CreateLatestVoucherElement(es));
                reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
                reportHeaderElement.Add(CreateDateIntervalElement(es));
                accountDistributionEntriesListElement.Add(reportHeaderElement);

                #endregion

                #region PageHeaderLabels

                XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
                CreateAccountDistributionHeadListPageHeaderLabelsElement(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
                accountDistributionEntriesListElement.Add(pageHeaderLabelsElement);

                #endregion

                #region Content

                foreach (var accountDistributionEntry in accountDistributionEntrys)
                {
                    #region accountDistributionEntrys

                    //XElement accountDistributionEntrysElement = new XElement("accountDistributionEntry",
                    XElement accountDistributionEntryElement = new XElement("AccountDistributionEntry",
                        new XElement("HeadId", accountDistributionEntry.AccountDistributionHead.AccountDistributionHeadId),
                    new XElement("Name", accountDistributionEntry.AccountDistributionHead.Name),
                    new XElement("Description", accountDistributionEntry.AccountDistributionHead.Description),
                    new XElement("CalculationType", calculationTypes.Where(i => i.Id == accountDistributionEntry.AccountDistributionHead.CalculationType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("StartDate", accountDistributionEntry.AccountDistributionHead.StartDate != null ? accountDistributionEntry.AccountDistributionHead.StartDate : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("EndDate", accountDistributionEntry.AccountDistributionHead.EndDate != null ? accountDistributionEntry.AccountDistributionHead.EndDate : CalendarUtility.DATETIME_DEFAULT),
                    new XElement("DayNumber", accountDistributionEntry.AccountDistributionHead.DayNumber),
                    new XElement("TriggerType", triggerTypes.Where(i => i.Id == accountDistributionEntry.AccountDistributionHead.TriggerType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("PeriodType", periodTypes.Where(i => i.Id == accountDistributionEntry.AccountDistributionHead.PeriodType).Select(i => i.Name).FirstOrDefault()),
                    new XElement("PeriodValue", accountDistributionEntry.AccountDistributionHead.PeriodValue),
                    new XElement("VoucherSerieName", accountDistributionEntry.AccountDistributionHead.VoucherSeriesTypeId != null ? voucherSeriesTypes.Where(i => i.VoucherSeriesTypeId == accountDistributionEntry.AccountDistributionHead.VoucherSeriesTypeId).Select(i => i.Name).FirstOrDefault() : string.Empty),
                    new XElement("UseInVoucher", accountDistributionEntry.AccountDistributionHead.UseInVoucher.ToString()),
                    new XElement("UseInCustomerInvoice", accountDistributionEntry.AccountDistributionHead.UseInCustomerInvoice.ToString()),
                    new XElement("UseInSupplierInvoice", accountDistributionEntry.AccountDistributionHead.UseInSupplierInvoice.ToString()),
                    new XElement("UseInImport", accountDistributionEntry.AccountDistributionHead.UseInImport.ToString()),
                    new XElement("Sort", accountDistributionEntry.AccountDistributionHead.Sort),
                    new XElement("KeepRow", accountDistributionEntry.AccountDistributionHead.KeepRow.ToString()),
                    new XElement("Amount", accountDistributionEntry.AccountDistributionHead.Amount),
                    new XElement("AmountOperator", accountDistributionEntry.AccountDistributionHead.AmountOperator),
                    new XElement("VoucherNr", accountDistributionEntry.VoucherHeadId != null ? accountDistributionEntry.VoucherHead.VoucherNr : 0),
                    new XElement("Date", accountDistributionEntry.Date)
                    );

                    #endregion

                    #region accountDistributionEntryRows

                    foreach (var accountDistributionEntryRow in accountDistributionEntry.AccountDistributionEntryRow)
                    {
                        if (accountDistributionEntryRow.CreditAmount != 0)
                        {
                            XElement accountDistributionEntryRowElement = new XElement("AccountDistributionEntryRow",
                                new XElement("CreditRowAccountNr", accountDistributionEntryRow.AccountStd.Account.AccountNr),
                                new XElement("CreditRowAccountName", accountDistributionEntryRow.AccountStd.Account.Name),
                                new XElement("CreditAmount", accountDistributionEntryRow.CreditAmount),
                                new XElement("DebitRowAccountNr", string.Empty),
                                new XElement("DebitRowAccountName", string.Empty),
                                new XElement("DebitAmount", 0)
                            );

                            var counter = 1;
                            foreach (var internalAccount in accountDistributionEntryRow.AccountInternal.OrderBy(i => i.Account.AccountDim.AccountDimNr))
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, internalAccount.Account.AccountNr));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, internalAccount.Account.Name));
                                counter++;
                            }

                            while (counter < 7)
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, String.Empty));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, String.Empty));
                                counter++;
                            }

                            accountDistributionEntryElement.Add(accountDistributionEntryRowElement);
                        }
                        else
                        {
                            XElement accountDistributionEntryRowElement = new XElement("AccountDistributionEntryRow",
                                new XElement("CreditRowAccountNr", string.Empty),
                                new XElement("CreditRowAccountName", string.Empty),
                                new XElement("CreditAmount", 0),
                                new XElement("DebitRowAccountNr", accountDistributionEntryRow.AccountStd.Account.AccountNr),
                                new XElement("DebitRowAccountName", accountDistributionEntryRow.AccountStd.Account.Name),
                                new XElement("DebitAmount", accountDistributionEntryRow.DebitAmount)
                            );

                            var counter = 1;
                            foreach (var internalAccount in accountDistributionEntryRow.AccountInternal.OrderBy(i => i.Account.AccountDim.AccountDimNr))
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, internalAccount.Account.AccountNr));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, internalAccount.Account.Name));
                                counter++;
                            }

                            while (counter < 7)
                            {
                                var num = counter.ToString();
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalNr" + num, String.Empty));
                                accountDistributionEntryRowElement.Add(new XElement("AccountInternalName" + num, String.Empty));
                                counter++;
                            }

                            accountDistributionEntryElement.Add(accountDistributionEntryRowElement);
                        }
                    }
                    accountDistributionEntriesListElement.Add(accountDistributionEntryElement);

                    #endregion
                }

                #endregion

                #region Close document

                rootElement.Add(accountDistributionEntriesListElement);
                document.Add(rootElement);

                return GetValidatedDocument(document, SoeReportTemplateType.PeriodAccountingForecastReport);

                #endregion
            }
        }

        private XDocument CreateFixedAssetsData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "FixedAssets");

            //Fixed assets
            XElement fixedAssetsElement = new XElement("FixedAssets");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateFixedAssetsgReportHeaderLabelsElement();
            fixedAssetsElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateFixedAssetsReportHeaderElement(es);
            fixedAssetsElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateFixedAssetsPageHeaderLabelsElement(pageHeaderLabelsElement);
            fixedAssetsElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                int inventoryXmlId = 1;

                List<Inventory> inventories = InventoryManager.GetInventories(entities, es.ActorCompanyId, false, 0, "", false);
                List<VoucherSeriesType> voucherSeriesTypes = VoucherManager.GetVoucherSeriesTypes(entities, es.ActorCompanyId, false);

                foreach (Inventory inventory in inventories)
                {
                    if (es.SFA_HasInventoryInterval)
                    {
                        bool inInterval = false;

                        if (StringUtility.IsInInterval(inventory.InventoryNr, es.SFA_InventoryFrom, es.SFA_InventoryTo))
                            inInterval = true;

                        if (!inInterval)
                            continue;
                    }

                    if (es.SFA_HasCategoryInterval)
                    {
                        bool inInterval = false;
                        List<CompanyCategoryRecord> companyCategoryRecords = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Inventory, SoeCategoryRecordEntity.Inventory, inventory.InventoryId, es.ActorCompanyId).ToList();

                        foreach (var categoryRecord in companyCategoryRecords)
                        {
                            var CategoryNr = CategoryManager.GetCategoryCode(entities, categoryRecord.CategoryId, es.ActorCompanyId);
                            inInterval = StringUtility.IsInInterval(CategoryNr, es.SFA_CategoryFrom, es.SFA_CategoryTo);
                        }

                        if (!inInterval)
                            continue;
                    }

                    if (es.HasDateInterval)
                    {
                        if (es.DateFrom != CalendarUtility.DATETIME_DEFAULT
                            && (!inventory.PurchaseDate.HasValue
                            || es.DateFrom > inventory.PurchaseDate))
                        {
                            continue;
                        }

                        if (es.DateTo != CalendarUtility.DATETIME_DEFAULT
                            && (!inventory.PurchaseDate.HasValue
                            || es.DateTo < inventory.PurchaseDate))
                        {
                            continue;
                        }
                    }

                    #region Content

                    string voucherSerie = voucherSeriesTypes.Where(i => i.VoucherSeriesTypeId == inventory.VoucherSeriesTypeId).Select(i => i.Name).FirstOrDefault();

                    int invoiceSeqNr = 0;
                    string invoiceNr = string.Empty;

                    if (inventory.SupplierInvoiceId != null && inventory.SupplierInvoiceId != 0)
                    {
                        var supplierinvoice = SupplierInvoiceManager.GetSupplierInvoice(entities, (int)inventory.SupplierInvoiceId, false, false, false, false, false, false, false, false);
                        invoiceSeqNr = supplierinvoice.SeqNr != null ? (int)supplierinvoice.SeqNr : 0;
                        invoiceNr = supplierinvoice.InvoiceNr;
                    }
                    else if (inventory.CustomerInvoiceId != null && inventory.CustomerInvoiceId != 0)
                    {
                        var customerinvoice = InvoiceManager.GetCustomerInvoice(entities, (int)inventory.CustomerInvoiceId);
                        invoiceSeqNr = customerinvoice.SeqNr != null ? (int)customerinvoice.SeqNr : 0;
                        invoiceNr = customerinvoice.InvoiceNr;
                    }

                    //Inventory
                    XElement inventoryElement = new XElement("Inventory",
                        new XAttribute("id", inventoryXmlId),
                        new XElement("InventoryId", inventory.InventoryId),
                        new XElement("WriteOffMethodName", inventory.InventoryWriteOffMethod?.Name ?? string.Empty),
                        new XElement("WriteOffMethodType", inventory.InventoryWriteOffMethod != null ? GetText(inventory.InventoryWriteOffMethod.Type, (int)TermGroup.InventoryWriteOffMethodType) : string.Empty),
                        new XElement("VoucherSeries", voucherSerie),
                        new XElement("SupplierInvoiceId", inventory.SupplierInvoiceId ?? 0),
                        new XElement("CustomerInvoiceId", inventory.CustomerInvoiceId ?? 0),
                        new XElement("InvoiceSeqNr", invoiceSeqNr),
                        new XElement("InvoiceNr", invoiceNr),
                        new XElement("InventoryNr", inventory.InventoryNr),
                        new XElement("InventoryName", inventory.Name),
                        new XElement("Description", inventory.Description),
                        new XElement("Notes", inventory.Notes),
                        new XElement("PurchaseDate", inventory.PurchaseDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("WriteOffDate", inventory.WriteOffDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PurchaseAmount", inventory.PurchaseAmount),
                        new XElement("WriteOffAmount", inventory.WriteOffAmount),
                        new XElement("WriteOffSum", inventory.WriteOffSum),
                        new XElement("WriteOffRemainingAmount", inventory.WriteOffRemainingAmount),
                        new XElement("EndAmount", inventory.EndAmount),
                        new XElement("PeriodType", GetText(inventory.PeriodType, (int)TermGroup.InventoryWriteOffMethodPeriodType)),
                        new XElement("PeriodValue", inventory.PeriodValue),
                        new XElement("StatusType", GetText(inventory.Status, (int)TermGroup.InventoryStatus)),
                        new XElement("StatusValue", inventory.Status),
                        new XElement("WriteOffPeriods", inventory.WriteOffPeriods),
                        new XElement("Created", inventory.Created ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("CreatedBy", inventory.CreatedBy),
                        new XElement("Modified", inventory.Modified ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("ModifiedBy", inventory.ModifiedBy)
                        );

                    //InventoryLog
                    int inventoryLogXmlId = 1;

                    List<InventoryTraceViewDTO> traceViews = InventoryManager.GetInventoryTraceViews(inventory.InventoryId)
                       .Where(i => i.Date <= es.DateTo).OrderBy(i => i.Date).ToList();

                    foreach (var inventoryLog in traceViews)
                    {
                        //InventoryLog
                        XElement inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", inventoryLog.VoucherNr),
                            new XElement("InvoiceSeqNr", inventoryLog.InvoiceId ?? 0),
                            new XElement("InvoiceNr", inventoryLog.InvoiceNr),
                            new XElement("User", ""),
                            new XElement("Date", inventoryLog.Date),
                            new XElement("Type", (int)inventoryLog.Type),
                            new XElement("TypeName", inventoryLog.TypeName),
                            new XElement("Amount", inventoryLog.Amount),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 0)
                            );


                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                    }
                    #region Prognose element InventoryLog

                    if (inventoryLogXmlId > 1 && inventory.Status == 2 && inventory.WriteOffPeriods > 0 && inventory.WriteOffAmount > 0 && inventory.WriteOffRemainingAmount > 0)
                    {
                        decimal periodValue = inventory.WriteOffAmount / inventory.PeriodValue;
                        decimal remainingAmount = inventory.WriteOffRemainingAmount;
                        decimal amountInterval1 = 0;
                        decimal remainingAmountInterval1 = 0;
                        decimal amountInterval2 = 0;
                        decimal remainingAmountInterval2 = 0;
                        decimal amountInterval3 = 0;
                        decimal remainingAmountInterval3 = 0;
                        decimal amountInterval4 = 0;
                        decimal remainingAmountInterval4 = 0;
                        decimal amountInterval5 = 0;
                        decimal remainingAmountInterval5 = 0;
                        if (es.SFA_PrognoseType == 1)
                        {
                            amountInterval1 = periodValue;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }
                            amountInterval2 = periodValue;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }
                            amountInterval3 = periodValue;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }
                            amountInterval4 = periodValue;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }
                            amountInterval5 = periodValue;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        if (es.SFA_PrognoseType == 2)
                        {
                            amountInterval1 = periodValue * 3;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }
                            amountInterval2 = periodValue * 3;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }
                            amountInterval3 = periodValue * 3;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }
                            amountInterval4 = periodValue * 3;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }
                            amountInterval5 = periodValue * 3;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        if (es.SFA_PrognoseType == 3)
                        {
                            amountInterval1 = periodValue * 6;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }

                            amountInterval2 = periodValue * 6;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }
                            amountInterval3 = periodValue * 6;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }
                            amountInterval4 = periodValue * 6;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }
                            amountInterval5 = periodValue * 6;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        if (es.SFA_PrognoseType == 4)
                        {
                            amountInterval1 = periodValue * 12;
                            if (amountInterval1 > remainingAmount)
                            {
                                remainingAmountInterval1 = 0;
                                amountInterval1 = remainingAmount;
                            }
                            else
                            {
                                remainingAmountInterval1 = remainingAmount - amountInterval1;
                            }

                            amountInterval2 = periodValue * 12;
                            if (amountInterval2 > remainingAmountInterval1)
                            {
                                remainingAmountInterval2 = 0;
                                amountInterval2 = remainingAmountInterval1;
                            }
                            else
                            {
                                remainingAmountInterval2 = remainingAmountInterval1 - amountInterval2;
                            }

                            amountInterval3 = periodValue * 12;
                            if (amountInterval3 > remainingAmountInterval2)
                            {
                                remainingAmountInterval3 = 0;
                                amountInterval3 = remainingAmountInterval2;
                            }
                            else
                            {
                                remainingAmountInterval3 = remainingAmountInterval2 - amountInterval3;
                            }

                            amountInterval4 = periodValue * 12;
                            if (amountInterval4 > remainingAmountInterval3)
                            {
                                remainingAmountInterval4 = 0;
                                amountInterval4 = remainingAmountInterval3;
                            }
                            else
                            {
                                remainingAmountInterval4 = remainingAmountInterval3 - amountInterval4;
                            }

                            amountInterval5 = periodValue * 12;
                            if (amountInterval5 > remainingAmountInterval4)
                            {
                                remainingAmountInterval5 = 0;
                                amountInterval5 = remainingAmountInterval4;
                            }
                            else
                            {
                                remainingAmountInterval5 = remainingAmountInterval4 - amountInterval5;
                            }
                        }
                        //InventoryLog interval 1
                        XElement inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval1),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 1)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 2
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval2),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 2)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 3
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval3),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 3)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 4
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval4),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 4)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval 5
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", amountInterval5),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 5)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;
                        //InventoryLog interval remaining amount
                        inventoryLogElement = new XElement("InventoryLog",
                            new XAttribute("id", inventoryLogXmlId),
                            new XElement("VoucherNr", 0),
                            new XElement("InvoiceSeqNr", 0),
                            new XElement("InvoiceNr", ""),
                            new XElement("User", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Type", (int)TermGroup_InventoryLogType.Prognose),
                            new XElement("TypeName", TermGroup_InventoryLogType.Prognose),
                            new XElement("Amount", remainingAmountInterval5),
                            new XElement("AmountCurrency", 0),
                            new XElement("AmountEntCurrency", 0),
                            new XElement("AmountLedgerCurrency", 0),
                            new XElement("Interval", 6)
                            );
                        inventoryElement.Add(inventoryLogElement);
                        inventoryLogXmlId++;

                    }
                    #endregion

                    #region Default element InventoryLog

                    if (inventoryLogXmlId == 1)
                        inventoryElement.Add(new XElement("InventoryLog", String.Empty));

                    #endregion

                    fixedAssetsElement.Add(inventoryElement);
                    inventoryXmlId++;

                    #endregion
                }

            }

            #region Close document

            rootElement.Add(fixedAssetsElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.FixedAssets);

            #endregion
        }

        private XDocument CreateSupplierReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierReport");

            //SupplierReport
            XElement supplierReportElement = new XElement("SupplierReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateActorReportHeaderLabelsElement();
            supplierReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(es);
            supplierReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");

            pageHeaderLabelsElement.Add(
                    new XElement("EDISupplierLabel", GetReportText(448, "EDI-leverantör")),
                    new XElement("StopPaymentLabel", GetReportText(449, "Betalning stoppad")),
                    new XElement("BicLabel", GetReportText(450, "BIC")));

            supplierReportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                int supplierXmlId = 1;
                List<Supplier> suppliers = SupplierManager.GetSuppliersByCompany(es.ActorCompanyId, true);
                foreach (Supplier supplier in suppliers)
                {
                    #region Prereq

                    if (es.SL_HasActorNrInterval && !StringUtility.IsInInterval(supplier.SupplierNr, es.SL_ActorNrFrom, es.SL_ActorNrTo))
                        continue;

                    SysCountryDTO sysCountry = (supplier.SysCountryId.HasValue) ? CountryCurrencyManager.GetSysCountry(supplier.SysCountryId.Value) : null;
                    SysCurrency sysCurrency = supplier.CurrencyId > 0 ? CountryCurrencyManager.GetSysCurrencyByCurrency(supplier.CurrencyId, true) : null;
                    PaymentCondition paymentCondition = supplier.PaymentConditionId.HasValue ? PaymentManager.GetPaymentCondition(supplier.PaymentConditionId.Value, es.ActorCompanyId) : null;
                    List<PaymentInformationRow> paymentInformationRows = PaymentManager.GetPaymentInformationRowsForActor(supplier.ActorSupplierId);
                    PaymentInformationRow defaultPaymentInformationRow = paymentInformationRows?.FirstOrDefault(i => i.Default);
                    Supplier factoringSupplier = supplier.FactoringSupplierId.HasValue ? suppliers.FirstOrDefault(i => i.ActorSupplierId == supplier.FactoringSupplierId.Value) : null;
                    Contact contact = ContactManager.GetContactFromActor(supplier.ActorSupplierId, loadActor: true, loadAllContactInfo: true);
                    List<GenericType> sysPaymentTypeTerms = base.GetTermGroupContent(TermGroup.SysPaymentType);

                    #endregion

                    #region ECom

                    string phoneJob = "";
                    string email = "";
                    string web = "";
                    string fax = "";

                    if (contact != null && contact.ContactECom != null)
                    {
                        foreach (ContactECom contactEComItem in contact.ContactECom)
                        {
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneJob)
                                phoneJob = contactEComItem.Text;
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Email)
                                email = contactEComItem.Text;
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Web)
                                web = contactEComItem.Text;
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Fax)
                                fax = contactEComItem.Text;
                        }
                    }

                    #endregion

                    #region Addresses

                    string deliveryAddressStreet = "";
                    string deliveryAddressCO = "";
                    string deliveryAddressPostalCode = "";
                    string deliveryAddressPostalAddress = "";
                    string distributionAddressStreet = "";
                    string distributionAddressCO = "";
                    string distributionAddressPostalCode = "";
                    string distributionAddressPostalAddress = "";
                    string distributionAddressCountry = "";
                    string visitingAddressStreet = "";
                    string visitingAddressCO = "";
                    string visitingAddressPostalCode = "";
                    string visitingAddressPostalAddress = "";
                    string visitingAddressCountry = "";

                    List<ContactAddress> contactAddresses = contact != null ? ContactManager.GetContactAddresses(entities, contact.ContactId) : new List<ContactAddress>();
                    if (!contactAddresses.IsNullOrEmpty())
                    {
                        foreach (ContactAddress contactAddress in contactAddresses)
                        {
                            if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery)
                            {
                                #region Delivery

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        deliveryAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        deliveryAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        deliveryAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        deliveryAddressPostalAddress = contactAddressRow.Text;
                                }

                                #endregion
                            }
                            else if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Distribution)
                            {
                                #region Distribution

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        distributionAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        distributionAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        distributionAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        distributionAddressPostalAddress = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                        distributionAddressCountry = contactAddressRow.Text;
                                }

                                #endregion
                            }
                            else if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Visiting)
                            {
                                #region Visiting

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        visitingAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        visitingAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        visitingAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        visitingAddressPostalAddress = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                        visitingAddressCountry = contactAddressRow.Text;
                                }

                                #endregion
                            }
                        }
                    }

                    #endregion

                    #region Supplier element

                    XElement supplierElement = new XElement("Supplier",
                        new XAttribute("Id", supplierXmlId),
                        new XElement("SupplierNr", supplier.SupplierNr),
                        new XElement("SupplierName", supplier.Name),
                        new XElement("SupplierOrgNr", StringUtility.NullToEmpty(supplier.OrgNr)),
                        new XElement("SupplierVatNr", StringUtility.NullToEmpty(supplier.VatNr)),
                        new XElement("Country", sysCountry?.Name ?? string.Empty),
                        new XElement("Currency", sysCurrency?.Name ?? string.Empty),
                        new XElement("OurCustomerNr", StringUtility.NullToEmpty(supplier.OurCustomerNr)),
                        new XElement("Reference", StringUtility.NullToEmpty(supplier.InvoiceReference)),
                        new XElement("VatType", supplier.VatType),
                        new XElement("PaymentCondition", paymentCondition?.Name ?? string.Empty),
                        new XElement("FactoringSupplier", factoringSupplier?.Name ?? string.Empty),
                        new XElement("BIC", StringUtility.NullToEmpty(supplier.BIC)),
                        new XElement("StopPayment", supplier.BlockPayment.ToInt()),
                        new XElement("EDISupplier", supplier.IsEDISupplier.ToInt()),
                        new XElement("DefaultPaymentInformation", defaultPaymentInformationRow?.PaymentNr ?? string.Empty),
                        new XElement("PhoneJob", phoneJob),
                        new XElement("Email", email),
                        new XElement("Web", web),
                        new XElement("Fax", fax),
                        new XElement("DeliveryAddressStreet", deliveryAddressStreet),
                        new XElement("DeliveryAddressCO", deliveryAddressCO),
                        new XElement("DeliveryAddressPostalCode", deliveryAddressPostalCode),
                        new XElement("DeliveryAddressPostalAddress", deliveryAddressPostalAddress),
                        new XElement("DistributionAddressStreet", distributionAddressStreet),
                        new XElement("DistributionAddressCO", distributionAddressCO),
                        new XElement("DistributionAddressPostalCode", distributionAddressPostalCode),
                        new XElement("DistributionAddressPostalAddress", distributionAddressPostalAddress),
                        new XElement("DistributionAddressCountry", distributionAddressCountry),
                        new XElement("VisitingAddressStreet", visitingAddressStreet),
                        new XElement("VisitingAddressCO", visitingAddressCO),
                        new XElement("VisitingAddressPostalCode", visitingAddressPostalCode),
                        new XElement("VisitingAddressPostalAddress", visitingAddressPostalAddress),
                        new XElement("VisitingAddressCountry", visitingAddressCountry));

                    #endregion

                    #region PaymentType element

                    int paymentInformationXmlId = 1;
                    foreach (PaymentInformationRow paymentInformationRow in paymentInformationRows)
                    {
                        XElement paymentInformationElement = new XElement("PaymentTypes",
                           new XAttribute("Id", paymentInformationXmlId),
                           new XElement("PaymentType", paymentInformationRow.SysPaymentTypeId),
                           new XElement("PaymentName", sysPaymentTypeTerms.FirstOrDefault(i => i.Id == paymentInformationRow.SysPaymentTypeId)?.Name),
                           new XElement("Account", paymentInformationRow.PaymentNr),
                           new XElement("Default", paymentInformationRow.Default.ToInt())
                           );

                        supplierElement.Add(paymentInformationElement);
                        paymentInformationXmlId++;
                    }

                    #endregion

                    #region Categories element

                    int categoryXmlId = 1;
                    List<CompanyCategoryRecord> records = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Supplier, SoeCategoryRecordEntity.Supplier, supplier.ActorSupplierId, Company.ActorCompanyId, false, es.DateFrom, es.DateTo);
                    foreach (CompanyCategoryRecord record in records)
                    {
                        XElement categoryElement = new XElement("Categories",
                            new XAttribute("Id", categoryXmlId),
                            new XElement("CategoryCode", record.Category != null ? StringUtility.NullToEmpty(record.Category.Code) : String.Empty),
                            new XElement("CategoryName", record.Category != null ? StringUtility.NullToEmpty(record.Category.Name) : String.Empty));

                        supplierElement.Add(categoryElement);
                        categoryXmlId++;
                    }

                    #endregion

                    #region SupplierEcom element

                    int contactEComXmlId = 1;
                    if (contact != null && contact.ContactECom != null)
                    {
                        foreach (var contactEComItem in contact.ContactECom)
                        {
                            XElement ecomElement = new XElement("SupplierEcom",
                                new XAttribute("Id", contactEComXmlId),
                                new XElement("EComType", contactEComItem.SysContactEComTypeId),
                                new XElement("EComName", contactEComItem.Name.NullToEmpty()),
                                new XElement("EComText", contactEComItem.IsSecret ? "*" : contactEComItem.Text.NullToEmpty()),
                                new XElement("EComDescription", contactEComItem.IsSecret ? "*" : contactEComItem.Description.NullToEmpty()));

                            supplierElement.Add(ecomElement);
                            contactEComXmlId++;
                        }
                    }

                    #endregion

                    #region SupplierAddresses element

                    int supplierAddressXmlId = 1;
                    foreach (ContactAddress contactAddress in contactAddresses)
                    {
                        #region Prereq

                        string address = "";
                        string addressCo = "";
                        string addressPostalCode = "";
                        string addressPostalAddress = "";
                        string addressCountry = "";
                        string addressStreetAddress = "";
                        string addressEntrenceCode = "";

                        if (contactAddress.ContactAddressRow != null && !contactAddress.IsSecret)
                        {
                            foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                            {
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                    address = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                    addressCo = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                    addressPostalCode = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                    addressPostalAddress = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                    addressCountry = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.StreetAddress)
                                    addressStreetAddress = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.EntranceCode)
                                    addressEntrenceCode = contactAddressRow.Text;
                            }
                        }

                        #endregion

                        XElement addressElement = new XElement("SupplierAddresses",
                            new XAttribute("Id", supplierAddressXmlId),
                            new XElement("AddressType", contactAddress.SysContactAddressTypeId),
                            new XElement("AddressName", contactAddress.Name),
                            new XElement("Address", address),
                            new XElement("AddressCO", addressCo),
                            new XElement("AddressPostalCode", addressPostalCode),
                            new XElement("AddressPostalAddress", addressPostalAddress),
                            new XElement("AddressCountry", addressCountry),
                            new XElement("AddressStreetAddress", addressStreetAddress),
                            new XElement("AddressEntrenceCode", addressEntrenceCode));

                        supplierElement.Add(addressElement);
                        supplierAddressXmlId++;
                    }

                    #endregion

                    supplierReportElement.Add(supplierElement);
                    supplierXmlId++;
                }

                #endregion

                #region Default Supplier Element

                if (supplierXmlId == 1)
                {
                    XElement supplierElement = new XElement("Supplier",
                        new XAttribute("Id", 1),
                        new XElement("SupplierNr", String.Empty),
                        new XElement("SupplierName", String.Empty),
                        new XElement("SupplierOrgNr", String.Empty),
                        new XElement("SupplierVatNr", String.Empty),
                        new XElement("Country", String.Empty),
                        new XElement("Currency", String.Empty),
                        new XElement("OurCustomerNr", String.Empty),
                        new XElement("Reference", String.Empty),
                        new XElement("VatType", 0),
                        new XElement("PaymentCondition", String.Empty),
                        new XElement("FactoringSupplier", String.Empty),
                        new XElement("BIC", String.Empty),
                        new XElement("StopPayment", 0),
                        new XElement("EDISupplier", 0),
                        new XElement("DefaultPaymentInformation", String.Empty),
                        new XElement("PhoneJob", String.Empty),
                        new XElement("Email", String.Empty),
                        new XElement("Web", String.Empty),
                        new XElement("Fax", String.Empty),
                        new XElement("DeliveryAddressStreet", String.Empty),
                        new XElement("DeliveryAddressCO", String.Empty),
                        new XElement("DeliveryAddressPostalCode", String.Empty),
                        new XElement("DeliveryAddressPostalAddress", String.Empty),
                        new XElement("DistributionAddressStreet", String.Empty),
                        new XElement("DistributionAddressCO", String.Empty),
                        new XElement("DistributionAddressPostalCode", String.Empty),
                        new XElement("DistributionAddressPostalAddress", String.Empty),
                        new XElement("DistributionAddressCountry", String.Empty),
                        new XElement("VisitingAddressStreet", String.Empty),
                        new XElement("VisitingAddressCO", String.Empty),
                        new XElement("VisitingAddressPostalCode", String.Empty),
                        new XElement("VisitingAddressPostalAddress", String.Empty),
                        new XElement("VisitingAddressCountry", String.Empty));

                    XElement paymentInformationElement = new XElement("PaymentTypes",
                        new XAttribute("Id", 1),
                        new XElement("PaymentType", String.Empty),
                        new XElement("PaymentName", String.Empty),
                        new XElement("Account", String.Empty),
                        new XElement("Default", 0));

                    supplierElement.Add(paymentInformationElement);

                    XElement categoryElement = new XElement("Categories",
                        new XAttribute("Id", 1),
                        new XElement("CategoryCode", String.Empty),
                        new XElement("CategoryName", String.Empty),
                        new XElement("isDefaultCategory", 0));

                    supplierElement.Add(categoryElement);

                    XElement ecomElement = new XElement("SupplierEcom",
                        new XAttribute("Id", 1),
                        new XElement("EComType", String.Empty),
                        new XElement("EComName", String.Empty),
                        new XElement("EComText", String.Empty),
                        new XElement("EComDescription", String.Empty));

                    supplierElement.Add(ecomElement);

                    XElement addressElement = new XElement("SupplierAddresses",
                        new XAttribute("Id", 1),
                        new XElement("AddressType", String.Empty),
                        new XElement("AddressName", String.Empty),
                        new XElement("Address", String.Empty),
                        new XElement("AddressCO", String.Empty),
                        new XElement("AddressPostalCode", String.Empty),
                        new XElement("AddressPostalAddress", String.Empty),
                        new XElement("AddressCountry", String.Empty),
                        new XElement("AddressStreetAddress", String.Empty),
                        new XElement("AddressEntrenceCode", String.Empty));

                    supplierElement.Add(addressElement);
                    supplierReportElement.Add(supplierElement);
                }

                #endregion
            }

            #region Close document

            rootElement.Add(supplierReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierListReport);

            #endregion
        }

        private XDocument CreateCustomerReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerReport");

            //CustomerBalanceList
            XElement customerReportElement = new XElement("CustomerReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateActorReportHeaderLabelsElement();
            customerReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(es);
            customerReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            customerReportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region AccountDimensions

            List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(Company.ActorCompanyId, false, false, true);
            foreach (AccountDim accountDim in accountDims)
            {
                XElement accountDimElement = new XElement("AccountDims",
                    new XElement("AccountDimNr", accountDim.AccountDimNr),
                    new XElement("AccountSieDimNr", accountDim.SysSieDimNr),
                    new XElement("AccountDimName", accountDim.Name));

                customerReportElement.Add(accountDimElement);
            }

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                int customerXmlId = 1;
                List<Customer> customers = CustomerManager.GetCustomersByCompany(es.ActorCompanyId, true);
                foreach (Customer customer in customers)
                {
                    #region Prereq

                    if (es.SL_HasActorNrInterval && !StringUtility.IsInInterval(customer.CustomerNr, es.SL_ActorNrFrom, es.SL_ActorNrTo))
                        continue;

                    SysCountryDTO sysCountry = (customer.SysCountryId.HasValue) ? CountryCurrencyManager.GetSysCountry(customer.SysCountryId.Value) : null;
                    SysCurrency sysCurrency = customer.CurrencyId > 0 ? CountryCurrencyManager.GetSysCurrencyByCurrency(customer.CurrencyId, true) : null;
                    PaymentCondition paymentCondition = customer.PaymentConditionId.HasValue ? PaymentManager.GetPaymentCondition(customer.PaymentConditionId.Value, es.ActorCompanyId) : null;
                    List<PaymentInformationRow> paymentInformationRows = PaymentManager.GetPaymentInformationRowsForActor(customer.ActorCustomerId);
                    PaymentInformationRow defaultPaymentInformationRow = paymentInformationRows?.FirstOrDefault(i => i.Default);
                    Contact contact = ContactManager.GetContactFromActor(customer.ActorCustomerId, loadActor: true, loadAllContactInfo: true);

                    #endregion

                    #region ECom

                    string phoneJob = "";
                    string email = "";
                    string web = "";
                    string fax = "";

                    if (contact != null && contact.ContactECom != null)
                    {
                        foreach (var contactEComItem in contact.ContactECom)
                        {
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneJob)
                                phoneJob = contactEComItem.Text;
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Email)
                                email = contactEComItem.Text;
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Web)
                                web = contactEComItem.Text;
                            if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.Fax)
                                fax = contactEComItem.Text;
                        }
                    }

                    #endregion

                    #region Addresses

                    string deliveryAddressStreet = "";
                    string deliveryAddressCO = "";
                    string deliveryAddressPostalCode = "";
                    string deliveryAddressPostalAddress = "";
                    string distributionAddressStreet = "";
                    string distributionAddressCO = "";
                    string distributionAddressPostalCode = "";
                    string distributionAddressPostalAddress = "";
                    string distributionAddressCountry = "";
                    string visitingAddressStreet = "";
                    string visitingAddressCO = "";
                    string visitingAddressPostalCode = "";
                    string visitingAddressPostalAddress = "";
                    string visitingAddressCountry = "";
                    string billingAddressStreet = "";
                    string billingAddressCO = "";
                    string billingAddressPostalCode = "";
                    string billingAddressPostalAddress = "";
                    string billingAddressCountry = "";

                    List<ContactAddress> contactAddresses = contact != null ? ContactManager.GetContactAddresses(entities, contact.ContactId) : new List<ContactAddress>();
                    if (!contactAddresses.IsNullOrEmpty())
                    {
                        foreach (ContactAddress contactAddress in contactAddresses)
                        {
                            if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery)
                            {
                                #region Delivery

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        deliveryAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        deliveryAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        deliveryAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        deliveryAddressPostalAddress = contactAddressRow.Text;
                                }

                                #endregion
                            }
                            else if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Distribution)
                            {
                                #region Distribution

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        distributionAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        distributionAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        distributionAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        distributionAddressPostalAddress = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                        distributionAddressCountry = contactAddressRow.Text;
                                }

                                #endregion
                            }
                            else if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Visiting)
                            {
                                #region Visiting

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        visitingAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        visitingAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        visitingAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        visitingAddressPostalAddress = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                        visitingAddressCountry = contactAddressRow.Text;
                                }

                                #endregion
                            }
                            else if (contactAddress.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Billing)
                            {
                                #region Billing

                                foreach (ContactAddressRow contactAddressRow in contactAddress.ContactAddressRow)
                                {
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                        billingAddressStreet = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                        billingAddressCO = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                        billingAddressPostalCode = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                        billingAddressPostalAddress = contactAddressRow.Text;
                                    if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                        billingAddressCountry = contactAddressRow.Text;
                                }

                                #endregion
                            }
                        }
                    }

                    #endregion

                    #region Customer element

                    XElement customerElement = new XElement("Customer",
                        new XAttribute("Id", customerXmlId),
                        new XElement("CustomerNr", customer.CustomerNr),
                        new XElement("CustomerName", customer.Name),
                        new XElement("CustomerOrgNr", StringUtility.NullToEmpty(customer.OrgNr)),
                        new XElement("CustomerVatNr", StringUtility.NullToEmpty(customer.VatNr)),
                        new XElement("Country", sysCountry?.Name ?? string.Empty),
                        new XElement("Currency", sysCurrency?.Name ?? string.Empty),
                        new XElement("Reference", StringUtility.NullToEmpty(customer.InvoiceReference)),
                        new XElement("VatType", customer.VatType),
                        new XElement("PaymentCondition", paymentCondition?.Name ?? string.Empty),
                        new XElement("DefaultPaymentInformation", defaultPaymentInformationRow?.PaymentNr ?? string.Empty),
                        new XElement("PhoneJob", phoneJob),
                        new XElement("Email", email),
                        new XElement("Web", web),
                        new XElement("Fax", fax),
                        new XElement("DeliveryAddressStreet", deliveryAddressStreet),
                        new XElement("DeliveryAddressCO", deliveryAddressCO),
                        new XElement("DeliveryAddressPostalCode", deliveryAddressPostalCode),
                        new XElement("DeliveryAddressPostalAddress", deliveryAddressPostalAddress),
                        new XElement("DistributionAddressStreet", distributionAddressStreet),
                        new XElement("DistributionAddressCO", distributionAddressCO),
                        new XElement("DistributionAddressPostalCode", distributionAddressPostalCode),
                        new XElement("DistributionAddressPostalAddress", distributionAddressPostalAddress),
                        new XElement("DistributionAddressCountry", distributionAddressCountry),
                        new XElement("VisitingAddressStreet", visitingAddressStreet),
                        new XElement("VisitingAddressCO", visitingAddressCO),
                        new XElement("VisitingAddressPostalCode", visitingAddressPostalCode),
                        new XElement("VisitingAddressPostalAddress", visitingAddressPostalAddress),
                        new XElement("VisitingAddressCountry", visitingAddressCountry),
                        new XElement("BillingAddressStreet", billingAddressStreet),
                        new XElement("BillingAddressCO", billingAddressCO),
                        new XElement("BillingAddressPostalCode", billingAddressPostalCode),
                        new XElement("BillingAddressPostalAddress", billingAddressPostalAddress),
                        new XElement("BillingAddressCountry", billingAddressCountry));

                    #endregion

                    #region PaymentType element

                    int paymentInformationXmlId = 1;
                    List<PaymentInformationRow> paymentInformations = PaymentManager.GetPaymentInformationRowsForActor(customer.ActorCustomerId);
                    foreach (PaymentInformationRow paymentInformation in paymentInformations)
                    {
                        XElement paymentInformationElement = new XElement("PaymentTypes",
                           new XAttribute("Id", paymentInformationXmlId),
                           new XElement("PaymentType", paymentInformation.SysPaymentTypeId),
                           new XElement("PaymentName", paymentInformation.SysPaymentTypeName),
                           new XElement("Account", paymentInformation.PaymentNr),
                           new XElement("Default", Convert.ToInt32(paymentInformation.Default))
                           );

                        customerElement.Add(paymentInformationElement);
                        paymentInformationXmlId++;
                    }

                    #endregion

                    #region Categories element

                    int categoryXmlId = 1;
                    List<CompanyCategoryRecord> records = CategoryManager.GetCompanyCategoryRecords(SoeCategoryType.Customer, SoeCategoryRecordEntity.Customer, customer.ActorCustomerId, Company.ActorCompanyId, false, es.DateFrom, es.DateTo);
                    foreach (CompanyCategoryRecord record in records)
                    {
                        XElement categoryElement = new XElement("Categories",
                            new XAttribute("Id", categoryXmlId),
                            new XElement("CategoryCode", record.Category != null ? StringUtility.NullToEmpty(record.Category.Code) : String.Empty),
                            new XElement("CategoryName", record.Category != null ? StringUtility.NullToEmpty(record.Category.Name) : String.Empty));

                        customerElement.Add(categoryElement);
                        categoryXmlId++;
                    }

                    #endregion

                    #region CustomerEcom element

                    int contactEComXmlId = 1;

                    if (contact != null && contact.ContactECom != null)
                    {
                        foreach (var contactEComItem in contact.ContactECom)
                        {
                            XElement ecomElement = new XElement("CustomerEcom",
                                new XAttribute("Id", contactEComXmlId),
                                new XElement("EComType", contactEComItem.SysContactEComTypeId),
                                new XElement("EComName", contactEComItem.Name.NullToEmpty()),
                                new XElement("EComText", contactEComItem.IsSecret ? "*" : contactEComItem.Text.NullToEmpty()),
                                new XElement("EComDescription", contactEComItem.IsSecret ? "*" : contactEComItem.Description.NullToEmpty()));

                            customerElement.Add(ecomElement);
                            contactEComXmlId++;
                        }
                    }

                    #endregion

                    #region CustomerAddresses element

                    int customerAddressXmlId = 1;

                    foreach (var contactAddress in contactAddresses)
                    {
                        #region Prereq

                        string address = "";
                        string addressCo = "";
                        string addressPostalCode = "";
                        string addressPostalAddress = "";
                        string addressCountry = "";
                        string addressStreetAddress = "";
                        string addressEntrenceCode = "";

                        if (contactAddress.ContactAddressRow != null && !contactAddress.IsSecret)
                        {
                            foreach (var contactAddressRow in contactAddress.ContactAddressRow)
                            {
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                    address = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                    addressCo = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                    addressPostalCode = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                    addressPostalAddress = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Country)
                                    addressCountry = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.StreetAddress)
                                    addressStreetAddress = contactAddressRow.Text;
                                if (contactAddressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.EntranceCode)
                                    addressEntrenceCode = contactAddressRow.Text;
                            }
                        }

                        #endregion

                        XElement addressElement = new XElement("CustomerAddresses",
                            new XAttribute("Id", customerAddressXmlId),
                            new XElement("AddressType", contactAddress.SysContactAddressTypeId),
                            new XElement("AddressName", contactAddress.Name),
                            new XElement("Address", address),
                            new XElement("AddressCO", addressCo),
                            new XElement("AddressPostalCode", addressPostalCode),
                            new XElement("AddressPostalAddress", addressPostalAddress),
                            new XElement("AddressCountry", addressCountry),
                            new XElement("AddressStreetAddress", addressStreetAddress),
                            new XElement("AddressEntrenceCode", addressEntrenceCode));

                        customerElement.Add(addressElement);
                        customerAddressXmlId++;
                    }

                    #endregion

                    #region Accounts

                    int accountXmlId = 1;
                    var accounts = CustomerManager.GetCustomerAccounts(customer.ActorCustomerId);
                    if (accounts != null)
                    {
                        foreach (CustomerAccountStd accountStd in accounts)
                        {
                            #region Prereq

                            if (!accountStd.AccountStdReference.IsLoaded)
                                accountStd.AccountStdReference.Load();

                            if (accountStd.AccountStd == null)
                                continue;

                            if (!accountStd.AccountStd.AccountReference.IsLoaded)
                                accountStd.AccountStd.AccountReference.Load();

                            #endregion

                            #region Account element

                            XElement accountElement = new XElement("Account",
                                new XAttribute("Id", accountXmlId),
                                new XElement("AccountNr", accountStd.AccountStd.Account.AccountNr),
                                new XElement("AccountName", accountStd.AccountStd.Account.Name),
                                new XElement("AccountType", accountStd.Type));

                            #endregion

                            #region InternalAccounts element

                            int internalAccountXmlId = 1;
                            foreach (var accountInternal in accountStd.AccountInternal)
                            {
                                #region Prereq

                                if (!accountInternal.AccountReference.IsLoaded)
                                    accountInternal.AccountReference.Load();

                                #endregion

                                XElement internalAccountsElement = new XElement("InternalAccounts",
                                    new XAttribute("Id", internalAccountXmlId),
                                    new XElement("InternalAccountNr", accountInternal.Account.AccountNr),
                                    new XElement("InternalAccountName", accountInternal.Account.Name),
                                    new XElement("InternalAccountDimNr", accountInternal.Account.AccountDim.AccountDimNr),
                                    new XElement("InternalAccountSieDimNr", accountInternal.Account.AccountDim.SysSieDimNr));

                                accountElement.Add(internalAccountsElement);
                                internalAccountXmlId++;
                            }

                            #endregion

                            customerElement.Add(accountElement);
                            accountXmlId++;
                        }
                    }

                    #endregion

                    customerReportElement.Add(customerElement);
                    customerXmlId++;
                }

                #endregion

                #region Default Customer Element

                if (customerXmlId == 1)
                {
                    XElement customerElement = new XElement("Customer",
                        new XAttribute("Id", 1),
                        new XElement("CustomerNr", String.Empty),
                        new XElement("CustomerName", String.Empty),
                         new XElement("CustomerOrgNr", String.Empty),
                         new XElement("CustomerVatNr", String.Empty),
                         new XElement("Country", String.Empty),
                         new XElement("Currency", String.Empty),
                         new XElement("Reference", String.Empty),
                         new XElement("VatType", 0),
                         new XElement("PaymentCondition", String.Empty),
                         new XElement("DefaultPaymentInformation", String.Empty),
                         new XElement("PhoneJob", String.Empty),
                         new XElement("Email", String.Empty),
                         new XElement("Web", String.Empty),
                         new XElement("Fax", String.Empty),
                         new XElement("DeliveryAddressStreet", String.Empty),
                         new XElement("DeliveryAddressCO", String.Empty),
                         new XElement("DeliveryAddressPostalCode", String.Empty),
                         new XElement("DeliveryAddressPostalAddress", String.Empty),
                         new XElement("DistributionAddressStreet", String.Empty),
                         new XElement("DistributionAddressCO", String.Empty),
                         new XElement("DistributionAddressPostalCode", String.Empty),
                         new XElement("DistributionAddressPostalAddress", String.Empty),
                         new XElement("DistributionAddressCountry", String.Empty),
                         new XElement("VisitingAddressStreet", String.Empty),
                         new XElement("VisitingAddressCO", String.Empty),
                         new XElement("VisitingAddressPostalCode", String.Empty),
                         new XElement("VisitingAddressPostalAddress", String.Empty),
                         new XElement("VisitingAddressCountry", String.Empty),
                         new XElement("BillingAddressStreet", String.Empty),
                         new XElement("BillingAddressCO", String.Empty),
                         new XElement("BillingAddressPostalCode", String.Empty),
                         new XElement("BillingAddressPostalAddress", String.Empty),
                         new XElement("BillingAddressCountry", String.Empty));


                    XElement paymentInformationElement = new XElement("PaymentTypes",
                       new XAttribute("Id", 1),
                        new XElement("PaymentType", String.Empty),
                        new XElement("PaymentName", String.Empty),
                        new XElement("Account", String.Empty),
                        new XElement("Default", 0));

                    customerElement.Add(paymentInformationElement);

                    XElement categoryElement = new XElement("Categories",
                        new XAttribute("Id", 1),
                        new XElement("CategoryCode", String.Empty),
                        new XElement("CategoryName", String.Empty),
                        new XElement("isDefaultCategory", 0));

                    customerElement.Add(categoryElement);

                    XElement ecomElement = new XElement("CustomerEcom",
                        new XAttribute("Id", 1),
                        new XElement("EComType", String.Empty),
                        new XElement("EComName", String.Empty),
                        new XElement("EComText", String.Empty),
                        new XElement("EComDescription", String.Empty));

                    customerElement.Add(ecomElement);

                    XElement addressElement = new XElement("CustomerAddresses",
                       new XAttribute("Id", 1),
                       new XElement("AddressType", String.Empty),
                       new XElement("AddressName", String.Empty),
                       new XElement("Address", String.Empty),
                       new XElement("AddressCO", String.Empty),
                       new XElement("AddressPostalCode", String.Empty),
                       new XElement("AddressPostalAddress", String.Empty),
                       new XElement("AddressCountry", String.Empty),
                       new XElement("AddressStreetAddress", String.Empty),
                       new XElement("AddressEntrenceCode", String.Empty));

                    customerElement.Add(addressElement);
                    XElement accountElement = new XElement("Account",
                         new XAttribute("Id", 1),
                         new XElement("AccountNr", String.Empty),
                         new XElement("AccountName", String.Empty),
                         new XElement("AccountType", 0));

                    XElement internalAccountsElement = new XElement("InternalAccounts",
                        new XAttribute("Id", 1),
                        new XElement("InternalAccountNr", String.Empty),
                        new XElement("InternalAccountName", String.Empty),
                        new XElement("InternalAccountDimNr", String.Empty),
                        new XElement("InternalAccountSieDimNr", String.Empty));

                    accountElement.Add(internalAccountsElement);
                    customerElement.Add(accountElement);
                    customerReportElement.Add(customerElement);
                }

                #endregion
            }

            #region Close document

            rootElement.Add(customerReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerListReport);

            #endregion
        }

        private XDocument CreateProductReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ProductReport");

            //ProductList
            XElement productReportElement = new XElement("ProductReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateActorReportHeaderLabelsElement();
            productReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateProductReportHeaderElement(es);
            productReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            productReportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region AccountDimensions

            List<AccountDim> accountDims = AccountManager.GetAccountDimsByCompany(Company.ActorCompanyId, false, false, true);
            foreach (AccountDim accountDim in accountDims)
            {
                XElement accountDimElement = new XElement("AccountDims",
                    new XElement("AccountDimNr", accountDim.AccountDimNr),
                    new XElement("AccountSieDimNr", accountDim.SysSieDimNr),
                    new XElement("AccountDimName", accountDim.Name));

                productReportElement.Add(accountDimElement);
            }

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                int productXmlId = 1;
                var invoiceProducts = ImportExportManager.GetInvoiceProductIODTOs(es.ActorCompanyId, es.SB_ProductNrFrom, es.SB_ProductNrTo, null, null, false, es.SB_ProductIds);
                foreach (var invoiceProduct in invoiceProducts)
                {
                    #region Product element

                    XElement productElement = new XElement("Product",
                        new XAttribute("Id", productXmlId),
                        new XElement("ProductNr", invoiceProduct.Number),
                        new XElement("ProductName", invoiceProduct.Name),
                        new XElement("Unit", invoiceProduct.Unit),
                        new XElement("EAN", invoiceProduct.EAN),
                        new XElement("Description", invoiceProduct.Description),
                        new XElement("Type", invoiceProduct.VatType),
                        new XElement("Weight", invoiceProduct.Weight),
                        new XElement("Purchaseprice", invoiceProduct.PurchasePrice));

                    #endregion

                    #region Salesprices element

                    int salespriceXmlId = 1;
                    if (!invoiceProduct.PriceDTOs.IsNullOrEmpty())
                    {
                        foreach (var priceItem in invoiceProduct.PriceDTOs)
                        {
                            XElement salespriceElement = new XElement("Salesprices",
                                new XAttribute("Id", salespriceXmlId),
                                new XElement("PriceListCode", priceItem.PriceListCode),
                                new XElement("Price", priceItem.Price),
                                new XElement("StartDate", priceItem.StartDate),
                                new XElement("StopDate", priceItem.StopDate));

                            productElement.Add(salespriceElement);
                            salespriceXmlId++;
                        }
                    }

                    #endregion

                    productReportElement.Add(productElement);
                    productXmlId++;
                }

                #endregion

                #region Default Product Element

                if (productXmlId == 1)
                {
                    XElement productElement = new XElement("Product",
                        new XAttribute("Id", 1),
                        new XElement("ProductNr", String.Empty),
                        new XElement("ProductName", String.Empty),
                        new XElement("Unit", String.Empty),
                        new XElement("EAN", String.Empty),
                        new XElement("Description", String.Empty),
                        new XElement("Type", String.Empty),
                        new XElement("Weight", String.Empty),
                        new XElement("Purchaseprice", String.Empty));

                    XElement salespriceElement = new XElement("Salesprices",
                        new XAttribute("Id", 1),
                        new XElement("PriceListCode", String.Empty),
                        new XElement("Price", String.Empty),
                        new XElement("StartDate", String.Empty),
                        new XElement("StopDate", String.Empty));

                    productElement.Add(salespriceElement);
                    productReportElement.Add(productElement);
                }

                #endregion
            }

            #region Close document

            rootElement.Add(productReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ProductListReport);

            #endregion
        }

        private XDocument CreateStockSaldoListReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "StockAndProduct");

            //CustomerBalanceList
            XElement stockAndProductElement = new XElement("StockAndProduct");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateStockAndProjectReportHeaderLabelsElement();
            stockAndProductElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateStockAndProductReportHeaderElement(es);
            stockAndProductElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateStockAndProductReportPageHeaderLabelsElement(pageHeaderLabelsElement);
            stockAndProductElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                List<Stock> stocks = StockManager.GetStocks(es.ActorCompanyId);
                foreach (Stock stock in stocks)
                {
                    #region Stock

                    if ((es.SB_StockLocationIdFrom > 0 && es.SB_StockLocationIdTo > 0) && (stock.StockId < es.SB_StockLocationIdFrom || stock.StockId > es.SB_StockLocationIdTo))
                        continue;

                    XElement stockElement = new XElement("Stock",
                        new XElement("StockId", stock.StockId),
                        new XElement("Code", stock.Code),
                        new XElement("Name", stock.Name),
                        new XElement("State", stock.State)
                     );

                    #endregion

                    #region StockProducts

                    List<StockProductDTO> stockProducts = StockManager.GetStockProductDTOs(es.ActorCompanyId, null, stock.StockId);

                    //Sort stockProducts according to given SortOrder
                    switch (es.SB_SortOrder)
                    {
                        case 1:
                            stockProducts = stockProducts.OrderBy(x => x.StockName).ThenBy(x => x.ProductNumber).ToList();
                            break;
                        case 2:
                            stockProducts = stockProducts.OrderBy(x => x.StockShelfName).ThenBy(x => x.ProductNumber).ToList();
                            break;
                        case 3:
                            stockProducts = stockProducts.OrderBy(x => x.ProductNumber).ToList();
                            break;
                        case 4:
                            stockProducts = stockProducts.OrderBy(x => x.ProductName).ToList();
                            break;
                    }
                    foreach (StockProductDTO stockProduct in stockProducts)
                    {
                        #region StockProduct

                        if ((es.SB_StockShelfIdFrom > 0 && es.SB_StockShelfIdTo > 0) && (stockProduct.StockShelfId < es.SB_StockShelfIdFrom || stockProduct.StockShelfId > es.SB_StockShelfIdTo))
                            continue;

                        if (!string.IsNullOrWhiteSpace(es.SB_ProductNrFrom) && !string.IsNullOrWhiteSpace(es.SB_ProductNrTo) && !StringUtility.IsInInterval(stockProduct.ProductNumber, es.SB_ProductNrFrom, es.SB_ProductNrTo))
                            continue;

                        if (es.HasDateInterval)
                        {
                            List<StockTransactionDTO> stockTransactions = StockManager.GetStockTransactionDTOs(stockProduct.StockProductId, es.DateTo.Date, null).Where(x => x.TransactionDate > es.DateTo.Date).ToList();
                            foreach (StockTransactionDTO stockTransaction in stockTransactions)
                            {

                                switch ((int)stockTransaction.ActionType)
                                {
                                    case ((int)TermGroup_StockTransactionType.Add):
                                    case ((int)TermGroup_StockTransactionType.Correction):
                                        stockProduct.Quantity -= stockTransaction.Quantity;
                                        break;
                                    case ((int)TermGroup_StockTransactionType.Take):
                                    case ((int)TermGroup_StockTransactionType.Loss):
                                    case ((int)TermGroup_StockTransactionType.Reserve):
                                        stockProduct.Quantity += stockTransaction.Quantity;
                                        break;
                                }
                            }
                        }

                        #endregion

                        #region StockProduct element

                        XElement productElement = new XElement("StockProduct",
                            new XElement("StockProductId", stockProduct.StockProductId),
                            new XElement("InvoiceProductId", stockProduct.InvoiceProductId),
                            new XElement("InvoiceProductNr", stockProduct.ProductNumber),
                            new XElement("InvoiceProductName", stockProduct.ProductName),
                            new XElement("InvoiceProductUnitName", stockProduct.ProductUnit),
                            new XElement("Quantity", stockProduct.Quantity),
                            new XElement("OrderedQuantity", stockProduct.OrderedQuantity),
                            new XElement("ReservedQuantity", stockProduct.ReservedQuantity),
                            new XElement("IsInInventory", Convert.ToInt32(stockProduct.IsInInventory)),
                            new XElement("WarningLevel", 0),
                            new XElement("AvgPrice", stockProduct.AvgPrice),
                            new XElement("StockShelfId", stockProduct.StockShelfId.ToInt()),
                            new XElement("StockShelfName", stockProduct.StockShelfName)
                            );


                        stockElement.Add(productElement);

                        #endregion
                    }

                    stockAndProductElement.Add(stockElement);

                    #endregion
                }

                #endregion

                #region Close document

                rootElement.Add(stockAndProductElement);
                document.Add(rootElement);

                return GetValidatedDocument(document, SoeReportTemplateType.StockSaldoListReport);

                #endregion
            }
        }

        private XDocument CreateStockTransactionListReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "StockTransaction");

            XElement stockAndProductElement = new XElement("StockTransactions");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateStockAndProjectReportHeaderLabelsElement();
            stockAndProductElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateStockAndProductReportHeaderElement(es);
            stockAndProductElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateStockTransactionReportPageHeaderLabelsElement(pageHeaderLabelsElement);
            stockAndProductElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                List<Stock> stocks = StockManager.GetStocks(es.ActorCompanyId);
                foreach (Stock stock in stocks)
                {
                    #region Stock

                    if ((es.SB_StockLocationIdFrom > 0 && es.SB_StockLocationIdTo > 0) && (stock.StockId < es.SB_StockLocationIdFrom || stock.StockId > es.SB_StockLocationIdTo))
                        continue;

                    XElement stockElement = new XElement("StockProduct",
                        new XElement("StockId", stock.StockId),
                        new XElement("Code", stock.Code),
                        new XElement("Name", stock.Name),
                        new XElement("State", stock.State)
                     );

                    #endregion

                    #region StockProducts

                    List<StockProductDTO> stockProducts = StockManager.GetStockProductDTOs(es.ActorCompanyId, null, stock.StockId);
                    foreach (StockProductDTO stockProduct in stockProducts)
                    {
                        #region StockProduct

                        if ((es.SB_StockLocationIdFrom > 0 && es.SB_StockLocationIdTo > 0) && (stockProduct.StockId < es.SB_StockLocationIdFrom || stockProduct.StockId > es.SB_StockLocationIdTo))
                            continue;
                        if ((es.SB_StockShelfIdFrom > 0 && es.SB_StockShelfIdTo > 0) && (stockProduct.StockShelfId < es.SB_StockShelfIdFrom || stockProduct.StockShelfId > es.SB_StockShelfIdTo))
                            continue;
                        if (!String.IsNullOrWhiteSpace(es.SB_ProductNrFrom) && !String.IsNullOrWhiteSpace(es.SB_ProductNrTo) && !StringUtility.IsInInterval(stockProduct.ProductNumber, es.SB_ProductNrFrom, es.SB_ProductNrTo))
                            continue;

                        List<GenericType> actionTypes = base.GetTermGroupContent(TermGroup.StockTransactionType).ToList();

                        List<StockTransactionDTO> stockTransactions = StockManager.GetStockTransactionDTOs(stockProduct.StockProductId, es.HasDateInterval ? es.DateFrom : (DateTime?)null, es.HasDateInterval ? es.DateTo : (DateTime?)null);
                        foreach (StockTransactionDTO stockTransaction in stockTransactions)
                        {
                            #region StockTransaction

                            long voucherNr = 0;
                            if (stockTransaction.VoucherId.GetValueOrDefault() > 0)
                                voucherNr = VoucherManager.GetVoucherHead(stockTransaction.VoucherId.Value)?.VoucherNr ?? 0;

                            XElement productElement = new XElement("StockTransaction",
                                new XElement("InvoiceProductId", stockProduct.InvoiceProductId),
                                new XElement("InvoiceProductNr", stockProduct.ProductNumber),
                                new XElement("InvoiceProductName", stockProduct.ProductName),
                                new XElement("InvoiceProductUnitName", stockProduct.ProductUnit),
                                new XElement("ActionType", (int)stockTransaction.ActionType),
                                new XElement("ActionTypeName", actionTypes.FirstOrDefault(x => x.Id == (int)stockTransaction.ActionType)?.Name ?? string.Empty),
                                new XElement("Quantity", stockTransaction.Quantity),
                                new XElement("Price", stockTransaction.Price),
                                new XElement("Note", stockTransaction.Note),
                                new XElement("StockShelfId", stockProduct.StockShelfId.ToInt()),
                                new XElement("StockShelfName", stockProduct.StockShelfName),
                                new XElement("VoucherId", stockTransaction.VoucherId.GetValueOrDefault()),
                                new XElement("VoucherNr", voucherNr),
                                new XElement("Created", stockTransaction.TransactionDate?.ToShortDateString() ?? string.Empty),
                                new XElement("CreatedBy", stockTransaction.CreatedBy)

                                );

                            stockElement.Add(productElement);

                            #endregion
                        }

                        #endregion
                    }

                    stockAndProductElement.Add(stockElement);

                    #endregion
                }

                #endregion

                #region Close document

                rootElement.Add(stockAndProductElement);
                document.Add(rootElement);

                return GetValidatedDocument(document, SoeReportTemplateType.StockTransactionListReport);

                #endregion
            }
        }

        private XDocument CreateStockInventoryReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "StockInventory");

            //
            XElement stockInventoryElement = new XElement("StockInventories");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateStockInventoryReportHeaderLabelsElement();
            stockInventoryElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateStockInventoryReportHeaderElement(es);

            stockInventoryElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateStockInventoryReportPageHeaderLabelsElement(pageHeaderLabelsElement);
            stockInventoryElement.Add(pageHeaderLabelsElement);

            #endregion

            using (var entities = new CompEntities())
            {
                #region Content

                List<StockInventoryHeadDTO> heads;
                if (es.SB_StockInventoryId > 0)
                {
                    heads = new List<StockInventoryHeadDTO>() { StockManager.GetStockInventoryHeadDTO(entities, es.SB_StockInventoryId) };
                }
                else
                {
                    heads = StockManager.GetStockInventoryHeadDTOs(entities, es.ActorCompanyId);
                }

                foreach (var head in heads)
                {
                    #region StockInventoryHead

                    if ((es.SB_StockLocationIdFrom > 0 && es.SB_StockLocationIdTo > 0) && (head.StockId < es.SB_StockLocationIdFrom || head.StockId > es.SB_StockLocationIdTo))
                        continue;

                    XElement stockElement = new XElement("StockInventoryHead",
                        new XElement("StockInventoryHeadId", head.StockInventoryHeadId),
                        new XElement("HeaderText", head.HeaderText),
                        new XElement("StockCode", head.StockCode ?? string.Empty),
                        new XElement("StockName", head.StockName ?? string.Empty),
                        new XElement("StartDate", head.InventoryStart ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("StopDate", head.InventoryStop ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("Created", head.Created ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("CreatedBy", head.CreatedBy),
                        new XElement("Modified", head.Modified ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("ModifiedBy", head.ModifiedBy)
                     );

                    #endregion

                    #region StockInventoryRows

                    List<StockInventoryRowDTO> stockInventoryRows = StockManager.GetStockInventoryRowDTOs(head.StockInventoryHeadId).ToList();
                    foreach (StockInventoryRowDTO stockInventoryRow in stockInventoryRows)
                    {
                        #region StockInventoryRow

                        if ((es.SB_StockShelfIdFrom > 0 && es.SB_StockShelfIdTo > 0) && (stockInventoryRow.ShelfId < es.SB_StockShelfIdFrom || stockInventoryRow.ShelfId > es.SB_StockShelfIdTo))
                            continue;
                        if (!String.IsNullOrWhiteSpace(es.SB_ProductNrFrom) && !String.IsNullOrWhiteSpace(es.SB_ProductNrTo) && !StringUtility.IsInInterval(stockInventoryRow.ProductNumber, es.SB_ProductNrFrom, es.SB_ProductNrTo))
                            continue;
                        if (es.HasDateInterval && stockInventoryRow.Created.HasValue && (String.Compare(stockInventoryRow.Created.Value.ToString("yyyyMMdd"), es.DateFrom.Date.ToString("yyyyMMdd")) < 0 || String.Compare(stockInventoryRow.Created.Value.ToString("yyyyMMdd"), es.DateTo.Date.ToString("yyyyMMdd")) > 0))
                            continue;

                        XElement productElement = new XElement("StockInventoryRow",
                            new XElement("StockInventoryRowId", stockInventoryRow.StockInventoryRowId),
                            new XElement("StockInventoryHeadId", stockInventoryRow.StockInventoryHeadId),
                            new XElement("InvoiceProductNr", stockInventoryRow.ProductNumber),
                            new XElement("InvoiceProductName", stockInventoryRow.ProductName),
                            new XElement("InvoiceProductUnitName", stockInventoryRow.Unit),
                            new XElement("StockShelfCode", stockInventoryRow.ShelfCode),
                            new XElement("StockShelfName", stockInventoryRow.ShelfName),
                            new XElement("StartingSaldo", stockInventoryRow.StartingSaldo),
                            new XElement("InventorySaldo", stockInventoryRow.InventorySaldo),
                            new XElement("OrderedQantity", stockInventoryRow.OrderedQuantity),
                            new XElement("ReservedQantity", stockInventoryRow.ReservedQuantity),
                            new XElement("Difference", stockInventoryRow.Difference),
                            new XElement("Price", stockInventoryRow.AvgPrice),
                            new XElement("RowCreated", stockInventoryRow.Created ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement("RowCreatedBy", stockInventoryRow.CreatedBy),
                            new XElement("RowModified", stockInventoryRow.Modified ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement("RowModifiedBy", stockInventoryRow.ModifiedBy),
                            new XElement("ProductGroupCode", stockInventoryRow.ProductGroupCode ?? string.Empty),
                            new XElement("ProductGroupName", stockInventoryRow.ProductGroupName),
                            new XElement("ValueDateSaldo", 0)
                            );

                        stockElement.Add(productElement);

                        #endregion
                    }

                    stockInventoryElement.Add(stockElement);

                    #endregion
                }

                #endregion

                #region Close document

                rootElement.Add(stockInventoryElement);
                document.Add(rootElement);

                return GetValidatedDocument(document, SoeReportTemplateType.StockInventoryReport);

                #endregion
            }
        }

        #region Help-methods

        private ActionResult CreateBalanceResultAndSruReportCommonData(EvaluatedSelection es, XElement reportElement)
        {
            ActionResult result = new ActionResult(true);

            #region Prereq

            //AccountDim internal
         //   List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId).ToDTOs();
            List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();
            string companyName_shortName = CompanyManager.GetCompanyName(es.ActorCompanyId, true, false);

            //           List<AccountDimDTO> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();
            Report report = ReportManager.GetReport(es.ReportId, es.ActorCompanyId, loadSysReportTemplateType: true);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(new XElement("AccountYearDiffLabel", GetReportText(35, "Jämförelseår:")));
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            reportHeaderLabelsElement.Add(new XElement("SumLabel", GetReportText(34, "Summa")));

            reportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(es);
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternals));
            reportHeaderElement.Add(CreateAccountDim(es, accountDimInternals));
            reportHeaderElement.Add(new XElement("AccountYearDiff", String.Empty));

            if (es.ReportTemplateType != SoeReportTemplateType.SruReport)
            {
                reportHeaderElement.Add(new XElement("IncludeMissingAccountDim", es.SSTD_IncludeMissingAccountDim.ToInt()));
                reportHeaderElement.Add(new XElement("SeparateAccountDim", es.SSTD_SeparateAccountDim.ToInt()));
                // Budget
                int budgetHId = 0;
                string budgetName = string.Empty;
                if (es.SSTD_BudgetId.HasValue)
                    budgetHId = es.SSTD_BudgetId.Value;
                BudgetManager bm = new BudgetManager(null);
                List<BudgetHead> budgetHeads = bm.GetBudgetHeads(es.ActorCompanyId, (int)DistributionCodeBudgetType.AccountingBudget);
                foreach (BudgetHead budgetHead in budgetHeads)
                {
                    if (budgetHead.BudgetHeadId == budgetHId)
                        budgetName = budgetHead.Name;
                }
                reportHeaderElement.Add(new XElement("Budget", budgetName));
                reportHeaderElement.Add(new XElement("ShowRowsByAccount", 0));
                reportHeaderElement.Add(new XElement("NrOfDecimals", report.NrOfDecimals ?? 2));
                reportHeaderElement.Add(new XElement("CompanyShortname", companyName_shortName));
                reportHeaderElement.Add(new XElement("ExportType", es.ExportType));
            }

            reportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    pageHeaderLabelsElement.Add(
                        new XElement("DimensionInternalName" + i + "Label", String.Empty),
                        new XElement("DimensionInternalShortName" + i + "Label", String.Empty));
                    continue;
                }

                var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;

                pageHeaderLabelsElement.Add(
                    new XElement("DimensionInternalName" + i + "Label", accountDim != null ? accountDim.AccountDimNr.ToString() : String.Empty),
                    new XElement("DimensionInternalShortName" + i + "Label", accountDim != null ? accountDim.Name : String.Empty));
            }

            this.AddAccountBalanceChangePeriodPageHeaderLabelElements(pageHeaderLabelsElement);

            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReport)
            {
                #region BalanceReport, ResultReport

                this.AddAccountBalanceChangePageHeaderLabelElements(pageHeaderLabelsElement);

                #endregion

                if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                {
                    #region BalanceReport

                    this.AddAccountBalancePageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
                else if (es.ReportTemplateType == SoeReportTemplateType.ResultReport)
                {
                    #region ResultReport

                    this.AddAccountBalanceChangePreviousPageHeaderLabelElements(pageHeaderLabelsElement);

                    #endregion
                }
            }

            reportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Init

                AccountBalanceManager abm = AccountBalanceManager(es.ActorCompanyId);
                abm.InitBalanceChangeVoucherHeadCache();

                List<AccountDTO> accountStdsInInterval = new List<AccountDTO>();
                List<AccountInternalDTO> accountInternalsInInterval = new List<AccountInternalDTO>();
                List<AccountInternalDTO> reportAccountInternalsInInterval = new List<AccountInternalDTO>();
                List<AccountInternalDTO> reportAccountInternalsSpecificDim = new List<AccountInternalDTO>();

                Dictionary<int, BalanceItemDTO> biBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeIncludingPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalanceDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousThisYearDict = new Dictionary<int, BalanceItemDTO>();

                // Previous Year
                Dictionary<int, BalanceItemDTO> biBalancechangePreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeIncludingPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biYearInBalancePreviousYearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biAccountBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, BalanceItemDTO>();

                //PreviousPeriods
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus1YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus2YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus3YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus4YearDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalancechangePrevoiusPeriodMinus5YearDict = new Dictionary<int, BalanceItemDTO>();

                // Budget TODO BudgetBalanceItemDTO
                Dictionary<int, BalanceItemDTO> biBudgetBalancechangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeIncludingPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetBalanceChangeYearDict = new Dictionary<int, BalanceItemDTO>();

                //Gross profit
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousThisYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit and Budget
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPeriodBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeYearBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalanceBudgetDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //Gross profit Previous Year
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitYearInBalancePreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousToPreviousYearPeriodDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();
                Dictionary<int, List<GrossProfitAccountBalanceItemDTO>> biGrossProfitBalanceChangeAllPreviousPreviousYearDict = new Dictionary<int, List<GrossProfitAccountBalanceItemDTO>>();

                //historical Data
                List<VoucherHeadDTO> voucherHeadsAllPreviousThisYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousPreviousYear = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsAllPreviousToPreviousYearPeriod = new List<VoucherHeadDTO>();

                //VoucherHeads
                List<VoucherHeadDTO> voucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads Budget
                List<VoucherHeadDTO> budgetVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> budgetVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads PreviuousPeriods
                List<VoucherHeadDTO> previousPeriodMinus1YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus2YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus3YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus4YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousPeriodMinus5YearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();

                //VoucherHeads PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsBalancechangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfitBudget
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> voucherHeadsGrossProfitBudgetBalanceChangeYear = new List<VoucherHeadDTO>();

                //VoucherHeads GrossProfit PreviousYear
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangePeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod = new List<VoucherHeadDTO>();
                List<VoucherHeadDTO> previousYearVoucherHeadsGrossProfitBalanceChangeYear = new List<VoucherHeadDTO>();

                #endregion

                #region Prereq

                AccountYearDTO accountYear = AccountManager.GetAccountYear(entities, es.DateFrom, es.ActorCompanyId).ToDTO();
                if (accountYear == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountYear");

                AccountYearDTO accountYearTo = AccountManager.GetAccountYear(entities, es.DateTo, es.ActorCompanyId).ToDTO();
                if (accountYearTo == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountYear");

                AccountDimDTO accountDimStd = AccountManager.GetAccountDimStd(entities, es.ActorCompanyId).ToDTO();
                if (accountDimStd == null)
                    return new ActionResult((int)ActionResultSave.EntityIsNull, "AccountDim");

                List<AccountDimDTO> internalaccountDims = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId, false, true, true).OrderBy(a => a.AccountDimNr).ToDTOs();
                List<AccountDTO> allAccountDTOStds = AccountManager.GetAccountStdsByCompany(es.ActorCompanyId, null).ToDTOs().ToList();
                List<ReportHeaderInterval> grossProfitReportHeaderIntervalsUnfiltered = ReportManager.GetReportHeaderIntervalsForCompany(es.ActorCompanyId, onlyGrossProfit: true).ToList();
                List<ReportGroup> reportGroups = ReportManager.GetReportGroupsByReport(entities, es.ReportId, es.ActorCompanyId);
                List<int> reportGroupIds = reportGroups.Select(g => g.ReportGroupId).ToList();
                List<int> reportHeaderIds = grossProfitReportHeaderIntervalsUnfiltered.Select(i => i.ReportHeader.ReportHeaderId).ToList();
                List<ReportGroupHeaderMapping> reportHeaderGroupMappings = ReportManager.GetReportGroupHeaderMappings(entities, es.ActorCompanyId);
                reportHeaderGroupMappings = reportHeaderGroupMappings.Where(g => reportGroupIds.Contains(g.ReportGroupId)).ToList();

                List<ReportHeaderInterval> test = new List<ReportHeaderInterval>();
                foreach (var mapping in reportHeaderGroupMappings)
                {
                    if (grossProfitReportHeaderIntervalsUnfiltered.Any(i => i.ReportHeader.ReportHeaderId == mapping.ReportHeaderId))
                    {
                        foreach (var interval in mapping.ReportHeader.ReportHeaderInterval)
                            test.Add(interval);
                    }
                }
                var grossProfitReportHeaderIntervals = test.Distinct().Cast<IReportHeaderInterval>().ToList();

                //Get detailed Information - Information is only needed in some reports
                bool detailedInformation = es.GetDetailedInformation;

                DateTime firstMonth = CalendarUtility.GetFirstDateOfMonth(es.DateFrom);
                DateTime prevYearDateFrom = es.DateFrom.AddYears(-es.NoOfYearsBackinPreviousYear);
                DateTime prevYearDateTo = es.DateTo.AddYears(-es.NoOfYearsBackinPreviousYear);
                // back of previous change previous year start
                //int months = 0;
                //int fromPer = 0;
                //int toPer = 0;
                //if (accountYear.To > accountYear.From)
                //{
                //    while (accountYear.From.Date.AddMonths(months) < accountYear.To.Date)
                //    {
                //        if (es.DateFrom.Date == accountYear.From.Date.AddMonths(months))
                //        {
                //            fromPer = months + 1;
                //        }
                //        if (es.DateTo.Date == accountYear.From.Date.AddMonths(months + 1).AddDays(-1))
                //        {
                //            toPer = months + 1;
                //        }
                //        months++;
                //    }
                //}
                // back of previous change previous year end
                prevYearDateTo = CalendarUtility.GetLastDateOfMonth(prevYearDateTo);
                DateTime prevYearUntilDateFrom = es.UntilDateFrom.AddYears(-es.NoOfYearsBackinPreviousYear);
                prevYearUntilDateFrom = CalendarUtility.GetLastDateOfMonth(prevYearUntilDateFrom);

                //Previous year
                // back of previous change previous year start
                AccountYearDTO previousAccountYear = es.NoOfYearsBackinPreviousYear != 0 ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-es.NoOfYearsBackinPreviousYear), es.ActorCompanyId).ToDTO() : null;

                //AccountYearDTO previousAccountYear = AccountManager.GetPreviousAccountYear(entities, accountYear.From, es.ActorCompanyId, true).ToDTO();
                //if (previousAccountYear != null)
                //{
                //    int prevMonths = 0;
                //    int prevFromPer = 0;
                //    int prevToPer = 0;
                //    if (previousAccountYear.To > previousAccountYear.From)
                //    {
                //        while (previousAccountYear.From.Date.AddMonths(prevMonths) < previousAccountYear.To.Date)
                //        {
                //            prevMonths++;
                //        }
                //    }
                //    prevFromPer = fromPer;
                //    if (toPer > prevMonths)
                //    {
                //        prevToPer = prevMonths;
                //    }
                //    else
                //    {
                //        prevToPer = toPer;
                //    }
                //    prevYearDateFrom = previousAccountYear.From.AddMonths(prevFromPer - 1);
                //    prevYearDateTo = previousAccountYear.From.AddMonths(prevToPer).AddDays(-1);
                //    prevYearUntilDateFrom = previousAccountYear.From.AddDays(-1);
                //}
                // back of previous change previous year end

                // Year minus 1
                DateTime prevPeriodMinus1YearDateFrom = es.DateFrom.AddYears(-1);
                DateTime prevPeriodMinus1YearDateTo = es.DateTo.AddYears(-1);
                prevPeriodMinus1YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus1YearDateTo);
                DateTime prevPeriodMinus1YearUntilDateFrom = es.UntilDateFrom.AddYears(-1);

                AccountYearDTO previousPeriodMinus1AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-1), es.ActorCompanyId).ToDTO() : null;

                // Year minus 2
                DateTime prevPeriodMinus2YearDateFrom = es.DateFrom.AddYears(-2);
                DateTime prevPeriodMinus2YearDateTo = es.DateTo.AddYears(-2);
                prevPeriodMinus2YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus2YearDateTo);
                DateTime prevPeriodMinus2YearUntilDateFrom = es.UntilDateFrom.AddYears(-2);
                AccountYearDTO previousPeriodMinus2AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-2), es.ActorCompanyId).ToDTO() : null;

                // Year minus 3
                DateTime prevPeriodMinus3YearDateFrom = es.DateFrom.AddYears(-3);
                DateTime prevPeriodMinus3YearDateTo = es.DateTo.AddYears(-3);
                prevPeriodMinus3YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus3YearDateTo);
                DateTime prevPeriodMinus3YearUntilDateFrom = es.UntilDateFrom.AddYears(-3);
                AccountYearDTO previousPeriodMinus3AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-3), es.ActorCompanyId).ToDTO() : null;


                // Year minus 4
                DateTime prevPeriodMinus4YearDateFrom = es.DateFrom.AddYears(-4);
                DateTime prevPeriodMinus4YearDateTo = es.DateTo.AddYears(-4);
                prevPeriodMinus4YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus4YearDateTo);
                DateTime prevPeriodMinus4YearUntilDateFrom = es.UntilDateFrom.AddYears(-4);
                AccountYearDTO previousPeriodMinus4AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-4), es.ActorCompanyId).ToDTO() : null;

                // Year minus 5
                DateTime prevPeriodMinus5YearDateFrom = es.DateFrom.AddYears(-5);
                DateTime prevPeriodMinus5YearDateTo = es.DateTo.AddYears(-5);
                prevPeriodMinus5YearDateTo = CalendarUtility.GetLastDateOfMonth(prevPeriodMinus5YearDateTo);
                DateTime prevPeriodMinus5YearUntilDateFrom = es.UntilDateFrom.AddYears(-5);
                AccountYearDTO previousPeriodMinus5AccountYear = detailedInformation ? AccountManager.GetAccountYear(entities, es.DateFrom.AddYears(-5), es.ActorCompanyId).ToDTO() : null;

                // Budget
                int budgetHeadId = 0;
                bool getBudget = true;
                if (es.SSTD_BudgetId.HasValue && es.IncludeBudget)
                    budgetHeadId = es.SSTD_BudgetId.Value;
                if (budgetHeadId == 0)
                    getBudget = false;

                List<GrossProfitCode> grossProfCodes = GrossProfitManager.GetGrossProfitCodes(es.ActorCompanyId);
                List<GrossProfitCodeDTO> grossProfitCodes = new List<GrossProfitCodeDTO>();
                foreach (var code in grossProfCodes)
                {
                    grossProfitCodes.Add(code.ToDTO());
                }

                bool hasGrossProfitCodes = grossProfitCodes.Any() && grossProfitReportHeaderIntervals.Any();
                bool isAccountSelectionValid = AccountManager.GetAccountsInInterval(entities, es, accountDimStd, false, ref accountStdsInInterval, ref reportAccountInternalsInInterval);

                if (es.SSTD_SeparateAccountDim)
                {
                    if (es.SSTD_AccountDimId != 0)
                    {
                        reportAccountInternalsSpecificDim = reportAccountInternalsInInterval.Where(a => a.AccountDimId == es.SSTD_AccountDimId).ToList();
                    }
                    else
                    {
                        int firstAccountDimId = es.SA_AccountIntervals?.FirstOrDefault(a => a.AccountDimId != accountDimStd.AccountDimId)?.AccountDimId ?? 0;
                        if (firstAccountDimId > 0)
                            reportAccountInternalsSpecificDim = reportAccountInternalsInInterval.Where(a => a.AccountDimId == firstAccountDimId).ToList();
                    }
                    reportAccountInternalsInInterval.RemoveAll(x => reportAccountInternalsSpecificDim.Exists(y => y.AccountId == x.AccountId));
                    reportAccountInternalsInInterval.Add(reportAccountInternalsSpecificDim.ElementAt(0));
                }

                int reportI = 0;
                int currentAccountIdx = 0;
                bool delaySetAccount = false;
                if (!es.SSTD_IncludeMissingAccountDim)
                    accountInternalsInInterval = reportAccountInternalsInInterval;
                else
                    delaySetAccount = true;

                while (isAccountSelectionValid)
                {
                    //Cache
                    abm.InitBalanceChangeVoucherHeadDTOCache();

                    if (es.IncludeAllHistoricalData)
                        abm.FillVoucherHeadDTOCache(CalendarUtility.DATETIME_DEFAULT, accountYear.To, es.ActorCompanyId);
                    else if (previousAccountYear != null)
                        abm.FillVoucherHeadDTOCache(previousAccountYear.From, accountYear.To, es.ActorCompanyId);
                    else
                        abm.FillVoucherHeadDTOCache(accountYear.From, accountYear.To, es.ActorCompanyId);

                    // Translate Account Names
                    if (accountStdsInInterval != null)
                    {
                        accountStdsInInterval = AccountManager.TranslateAccountNamesByLang(accountStdsInInterval); // 2015-04-27 / Jukka - Translate account names for the names for which current translation exists
                    }
                    // Hela året
                    biBalanceChangeYearDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalanceChangeYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                    // Hela Förra året
                    if (previousAccountYear != null)
                        biBalanceChangePreviousYearDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);

                    //Omsättning  inom period (hela urvalet) 

                    if (accountYear != null && es.DateFrom.Day == 1 && CalendarUtility.GetLastDateOfMonth(es.DateTo.Date) == es.DateTo.Date)
                    {
                        biBalancechangePeriodDict = abm.GetBalanceChangeFromDTO(accountYear, es.DateFrom, es.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                    }
                    else
                    {
                        biBalancechangePeriodDict = abm.GetBalanceChangeFromDTO(es.DateFrom, es.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                    }

                    //Omsättning inom perioden förra året (hela urvalet)
                    if (previousAccountYear != null)
                        biBalancechangePreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);

                    //Omsättning per period i fem tidigare år
                    if (previousAccountYear != null)
                    {
                        if (previousPeriodMinus1AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus1YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus1AccountYear, prevPeriodMinus1YearDateFrom, prevPeriodMinus1YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus1YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus2AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus2YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus2AccountYear, prevPeriodMinus2YearDateFrom, prevPeriodMinus2YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus2YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus3AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus3YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus3AccountYear, prevPeriodMinus3YearDateFrom, prevPeriodMinus3YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus3YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus4AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus4YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus4AccountYear, prevPeriodMinus4YearDateFrom, prevPeriodMinus4YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus4YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        if (previousPeriodMinus5AccountYear != null)
                            biBalancechangePrevoiusPeriodMinus5YearDict = abm.GetBalanceChangeFromDTO(previousPeriodMinus5AccountYear, prevPeriodMinus5YearDateFrom, prevPeriodMinus5YearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousPeriodMinus5YearVoucherHeadsBalancechangePeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                    }

                    //Budget inom perioden
                    if (getBudget)
                    {
                        bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                        biBudgetBalancechangePeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, es.DateFrom, es.DateTo, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalancechangePeriod);

                        if (hasGrossProfitCodes)
                            biGrossProfitBalanceChangePeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, es.DateFrom, es.DateTo, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalancechangePeriod, out voucherHeadsGrossProfitBudgetBalanceChangePeriod, delaySetAccount);
                    }

                    if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReport || es.ReportTemplateType == SoeReportTemplateType.SruReport)
                    {
                        #region BalanceReport and ResultReport

                        #region Load data in order largest range first (to be able to use cache and re-use data)

                        // Budget
                        if (getBudget)
                        {
                            bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                            biBudgetBalanceChangeYearDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalanceChangeYear);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeYearBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, accountYear.To, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalanceChangeYear, out voucherHeadsGrossProfitBudgetBalanceChangeYear, delaySetAccount);
                        }

                        // Från år start till period slut
                        biBalanceChangeIncludingPeriodDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From.Date, es.DateTo.Date, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalanceChangeIncludingPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        // Från förra året start till period slut
                        if (previousAccountYear != null)
                            biBalanceChangeIncludingPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateTo, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeIncludingPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        //Budget
                        if (getBudget)
                        {
                            bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                            biBudgetBalanceChangeIncludingPeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, es.DateTo, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalanceChangeIncludingPeriod);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeIncludingPeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, es.DateTo, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalanceChangeIncludingPeriod, out voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod, delaySetAccount);
                        }

                        //Från år start till period start (Edit 090319: Parameter dateTo, es.SSTD_DateFrom --> SSTD_DateTo) (Edit 090423: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom)(Edit 100322: Parameter dateTo, es.SSTD_DateTo --> SSTD_DateFrom.AddDays(-1))
                        biBalanceChangeToPeriodDict = abm.GetBalanceChangeFromDTO(accountYear, accountYear.From, es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsBalanceChangeToPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                        // Budget
                        if (getBudget)
                        {
                            bool isAccountInternalsSelection = accountInternalsInInterval.Count > 0;
                            biBudgetBalanceChangeToPeriodDict = BudgetManager.GetBudgetForPeriodFromDTO(budgetHeadId, accountYear, accountYear.From, es.UntilDateFrom, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId, isAccountInternalsSelection, out budgetVoucherHeadsBalanceChangeToPeriod);
                            if (hasGrossProfitCodes)
                                biGrossProfitBalanceChangeToPeriodBudgetDict = abm.GetPeriodGrossProfitChangesBudgetFromDTO(budgetHeadId, accountYear, accountYear.From, es.UntilDateFrom, accountStdsInInterval, accountInternalsInInterval, grossProfitCodes, es.ActorCompanyId, budgetVoucherHeadsBalanceChangeToPeriod, out voucherHeadsGrossProfitBudgetBalanceChangeToPeriod, delaySetAccount);
                        }

                        // Förra året
                        if (previousAccountYear != null)
                            biBalanceChangeToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(previousAccountYear, previousAccountYear.From, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out previousYearVoucherHeadsBalanceChangeToPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);

                        #endregion


                        //GrossProfitCode
                        if (hasGrossProfitCodes)
                        {

                            biGrossProfitBalanceChangePeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, es.DateFrom, es.DateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);

                            biGrossProfitBalanceChangeToPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, es.DateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);

                            biGrossProfitBalanceChangeIncludingPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, es.DateTo, accountStdsInInterval, allAccountDTOStds, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                            biGrossProfitBalanceChangeYearDict = abm.GetPeriodGrossProfitChangesFromDTO(accountYear, accountYear.From, accountYear.To, accountStdsInInterval, allAccountDTOStds, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out voucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                            //Förra året
                            if (previousAccountYear != null)
                            {
                                biGrossProfitBalanceChangePreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, prevYearDateFrom, prevYearDateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangePeriod, detailedInformation);

                                biGrossProfitBalanceChangeToPreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateFrom.AddDays(-1), allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod, detailedInformation);

                                biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, prevYearDateTo, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                                biGrossProfitBalanceChangePreviousYearDict = abm.GetPeriodGrossProfitChangesFromDTO(previousAccountYear, previousAccountYear.From, previousAccountYear.To, allAccountDTOStds, accountStdsInInterval, internalaccountDims, accountInternalsInInterval, grossProfitCodes, grossProfitReportHeaderIntervals, es.ActorCompanyId, out previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod, detailedInformation);

                            }
                        }

                        #endregion

                        if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.SruReport)
                        {
                            #region BalanceReport

                            //Ingående balans för aktuellt år
                            biYearInBalanceDict = abm.GetYearInBalanceFromDTO(entities, accountYear, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId);
                            //Ingående balans för förra året
                            if (previousAccountYear != null)
                                biYearInBalancePreviousYearDict = abm.GetYearInBalanceFromDTO(entities, previousAccountYear, accountStdsInInterval, accountInternalsInInterval, es.ActorCompanyId);
                            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport && es.IncludeAllHistoricalData)
                            {
                                //All data fram till dagen innan urval start
                                biAccountBalanceChangeAllPreviousToPeriodDict = abm.GetBalanceChangeFromDTO(null, es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousToPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                                //All data fram till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(null, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousToPreviousYearPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);

                                //All data från 1 jan till dagen innan urval start
                                biAccountBalanceChangeAllPreviousThisYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(es.DateFrom), es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousThisYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                                //All data från 1 jan förra året till dagen innan urval start förra året
                                if (previousAccountYear != null)
                                    biAccountBalanceChangeAllPreviousPreviousYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(prevYearDateFrom), prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousPreviousYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                            }
                            #endregion
                        }
                        else if (es.ReportTemplateType == SoeReportTemplateType.ResultReport && es.IncludeAllHistoricalData)
                        {
                            #region ResultReport

                            //All data fram till dagen innan urval start
                            biAccountBalanceChangeAllPreviousToPeriodDict = abm.GetBalanceChangeFromDTO(null, es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousToPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                            //All data fram till dagen innan urval start förra året
                            if (previousAccountYear != null)
                                biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict = abm.GetBalanceChangeFromDTO(null, prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousToPreviousYearPeriod, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);

                            //All data från 1 jan till dagen innan urval start
                            biAccountBalanceChangeAllPreviousThisYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(es.DateFrom), es.UntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousThisYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);
                            //All data från 1 jan förra året till dagen innan urval start förra året
                            if (previousAccountYear != null)
                                biAccountBalanceChangeAllPreviousPreviousYearDict = abm.GetBalanceChangeFromDTO(CalendarUtility.GetFirstDateOfYear(prevYearDateFrom), prevYearUntilDateFrom, accountStdsInInterval, accountDimInternals, accountInternalsInInterval, es.ActorCompanyId, out voucherHeadsAllPreviousPreviousYear, false, es.SSTD_IncludeYearEndVouchers, es.SSTD_IncludeExternalVouchers, delaySetAccount);

                            #endregion
                        }
                    }
                    #endregion

                    #region Check which accounts that got balance

                    List<int> accountIdsWithBalance = new List<int>();

                    foreach (AccountDTO accountStd in accountStdsInInterval)
                    {
                        if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && biBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeIncludingPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && biBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && biYearInBalanceDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biBalancechangePreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangeIncludingPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biBalanceChangeIncludingPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId) && biBalanceChangePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && biYearInBalancePreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId) && biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && biBudgetBalancechangePeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && biBudgetBalanceChangeToPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId) && biBudgetBalanceChangeIncludingPeriodDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && biBudgetBalanceChangeYearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }

                        if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId) && biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId].Balance != 0)
                        {
                            accountIdsWithBalance.Add(accountStd.AccountId);
                            continue;
                        }
                    }

                    #endregion

                    #region Content

                    #region Sheet

                    int sheetId = 1;
                    XElement sheetElement = new XElement("Sheet");
                    if (accountInternalsInInterval.Count > 0 && es.SSTD_SeparateAccountDim)
                    {
                        AccountInternalDTO accountinternal = reportAccountInternalsSpecificDim.ElementAt(currentAccountIdx);

                        var accountdiminternal = accountDimInternals.FirstOrDefault(i => i.AccountDimId == accountinternal.AccountDimId);
                        sheetElement.Add(
                            new XAttribute("id", (reportI + 1)),
                            new XElement("DimensionNr", accountinternal?.AccountDimNr.ToString()),
                            new XElement("DimensionName", accountdiminternal?.Name),
                            new XElement("InternalNr", accountinternal?.AccountNr),
                            new XElement("InternalName", accountinternal?.Name)
                        );
                    }
                    else
                    {
                        sheetElement.Add(
                        new XAttribute("id", sheetId),
                        new XElement("DimensionNr", String.Empty),
                        new XElement("DimensionName", String.Empty),
                        new XElement("InternalNr", String.Empty),
                        new XElement("InternalName", String.Empty));
                    }
                    #endregion

                    int reportGroupXmlId = 1;
                    foreach (ReportGroup reportGroup in reportGroups)
                    {
                        #region ReportGroup

                        #region Init

                        bool invertRow = reportGroup.InvertRow;

                        //BalanceReport, ResultReport, SRU,
                        decimal groupSumAccountBalancechangePeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriod = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                        //previousYear
                        decimal groupSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                        //PreviousYearPeriodOnly to be able to look at the year for multiple periods
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus1Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus2Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus3Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus4Year = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousPeriodYearMinus5Year = Decimal.Zero;

                        //Budget
                        decimal groupSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                        //BalanceReport, ResultReport
                        decimal groupSumAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;

                        //previousYear
                        decimal groupSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod = Decimal.Zero;
                        decimal groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;

                        //Budget
                        decimal groupSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeYear = Decimal.Zero;
                        decimal groupSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYear = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangePeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal groupSumAccountBalancechangePreviousYear = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYear = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPreviousYearPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriodDiff = Decimal.Zero;
                        decimal groupSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = Decimal.Zero;

                        //Budget
                        decimal groupSumBudgetAccountBalancechangeYear = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangePeriodDiff = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeToPeriodDiff = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                        decimal groupSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                        //BalanceReport
                        decimal groupSumAccountPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountYearInBalance = Decimal.Zero;
                        decimal groupSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYearInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalance = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountPeriodInBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiffEntCurrency = Decimal.Zero;

                        //PreviousYear
                        decimal groupSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountPreviousYearInBalance = Decimal.Zero;
                        decimal groupSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                        decimal groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalancePreviousYear = Decimal.Zero;
                        decimal groupSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountPreviousYearPeriodInBalanceDiff = Decimal.Zero;
                        decimal groupSumAccountPreviousYearPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiffPreviousYear = Decimal.Zero;
                        decimal groupSumAccountOpeningBalanceDiffPreviousYearEntCurrency = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiffPreviousYear = Decimal.Zero;
                        decimal groupSumAccountClosingBalanceDiffPreviousYearEntCurrency = Decimal.Zero;

                        //ResultReport
                        decimal groupSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                        //PreviousYear
                        decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                        decimal groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;

                        //Grossprofit and Budget
                        decimal groupSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitToPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitIncludingPeriod = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitYear = Decimal.Zero;
                        decimal groupSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                        List<XElement> reportHeaderElements = new List<XElement>();

                        #endregion

                        #region ReportHeaderInterval

                        //ReportHeaderIntervals for ReportGroup
                        List<ReportHeaderInterval> reportHeaderIntervalsForReportGroup = ReportManager.GetReportHeaderIntervals(entities, reportGroup.ReportGroupId, es.ActorCompanyId);

                        #endregion

                        #region AccountStds

                        DateTime startAccount = DateTime.UtcNow;


                        //AccountStds for ReportGroup
                        List<AccountDTO> accountStdsForReportGroup = new List<AccountDTO>();
                        foreach (AccountDTO accountStd in accountStdsInInterval)
                        {
                            foreach (ReportHeaderInterval reportHeaderInterval in reportHeaderIntervalsForReportGroup)
                            {
                                if (Validator.IsAccountInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                                {
                                    accountStdsForReportGroup.Add(accountStd);
                                    break;
                                }
                            }
                        }

                        #endregion

                        #endregion

                        List<ReportHeader> reportHeaders = (from rh in reportHeaderGroupMappings
                                                            where rh.ReportGroup.ReportGroupId == reportGroup.ReportGroupId
                                                            select rh.ReportHeader).ToList();

                        int reportHeaderXmlId = 1;
                        foreach (ReportHeader reportHeader in reportHeaders)
                        {
                            #region ReportHeader

                            #region Init

                            //BalanceReport, ResultReport, SRU
                            decimal headerSumAccountBalancechangePeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangePeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriodEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountBalancechangePreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;

                            //PreviousPeriod
                            decimal headerSumAccountBalancechangePreviousPeriodMinus1Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus2Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus3Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus4Year = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousPeriodMinus5Year = Decimal.Zero;

                            //Budget
                            decimal headerSumBudgetAccountBalancechangePeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangePeriodEntCurrency = Decimal.Zero;

                            //BalanceReport, ResultReport
                            decimal headerSumAccountBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeYear = Decimal.Zero;
                            decimal headerSumAccountBalancechangeYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYear = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangePeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountBalancechangePreviousYear = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod = Decimal.Zero;
                            decimal headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff = Decimal.Zero;
                            decimal headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = Decimal.Zero;

                            //Budget
                            decimal headerSumBudgetAccountBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeYear = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeYearEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangePeriodDiff = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeToPeriodDiff = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                            decimal headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                            //BalanceReport
                            decimal headerSumAccountPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountYearInBalance = Decimal.Zero;
                            decimal headerSumAccountYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYearInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalance = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountPeriodInBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiffEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountPreviousYearPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountPreviousYearInBalance = Decimal.Zero;
                            decimal headerSumAccountPreviousYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearInBalance = Decimal.Zero;
                            decimal headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalancePreviousYear = Decimal.Zero;
                            decimal headerSumAccountClosingBalancePreviousYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountPreviousYearPeriodInBalanceDiff = Decimal.Zero;
                            decimal headerSumAccountPreviousYearPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiffPreviousYear = Decimal.Zero;
                            decimal headerSumAccountOpeningBalanceDiffPreviousYearEntCurrency = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiffPreviousYear = Decimal.Zero;
                            decimal headerSumAccountClosingBalanceDiffPreviousYearEntCurrency = Decimal.Zero;

                            //ResultReport
                            decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousThisYearBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = Decimal.Zero;

                            //PreviousYear
                            decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalance = Decimal.Zero;
                            decimal headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency = Decimal.Zero;

                            //GrossProfit and Budget
                            decimal headerSumBudgetAccountGrossProfitPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriodEntCurrency = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitYear = Decimal.Zero;
                            decimal headerSumBudgetAccountGrossProfitYearEntCurrency = Decimal.Zero;

                            List<XElement> accountElementsForHeader = new List<XElement>();

                            #endregion

                            #region AccountStd

                            //AccountStds for ReportHeader
                            List<AccountDTO> accountStdsForReportHeader = new List<AccountDTO>();


                            List<ReportHeaderInterval> reportHeadersIntervalsForReportHeader = (from rh in reportHeaderIntervalsForReportGroup
                                                                                                where rh.ReportHeader.ReportHeaderId == reportHeader.ReportHeaderId
                                                                                                select rh).ToList();

                            foreach (AccountDTO accountStd in accountStdsForReportGroup)
                            {
                                accountStd.GrossProfitCode = new List<int?>();

                                foreach (ReportHeaderInterval reportHeaderInterval in reportHeadersIntervalsForReportHeader)
                                {

                                    if (StringUtility.IsInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                                    {
                                        if (accountStd.GrossProfitCode == null)
                                            accountStd.GrossProfitCode = new List<int?>();

                                        accountStd.GrossProfitCode.Add(reportHeaderInterval.SelectValue);
                                        if (reportHeader.ShowZeroRow || accountIdsWithBalance.Contains(accountStd.AccountId))
                                            accountStdsForReportHeader.Add(accountStd);
                                        break;
                                    }
                                }
                            }

                            #endregion

                            #endregion

                            int accountXmlId = 1;
                            foreach (AccountDTO accountStd in accountStdsForReportHeader)
                            {
                                #region AccountStd

                                #region Init BalanceReport, ResultReport, SRU

                                bool onlyGrossCodesInInterval = false;
                                if (!accountStd.GrossProfitCode.IsNullOrEmpty() && hasGrossProfitCodes)
                                {
                                    bool grossInInterval = false;
                                    bool netInInterval = false;

                                    foreach (ReportHeaderInterval reportHeaderInterval in reportHeadersIntervalsForReportHeader)
                                    {
                                        if (StringUtility.IsInInterval(accountStd.AccountNr, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo))
                                        {
                                            if (!reportHeaderInterval.SelectValue.HasValue)
                                                netInInterval = true;

                                            if (reportHeaderInterval.SelectValue.HasValue)
                                                grossInInterval = true;
                                        }
                                    }

                                    if (grossInInterval)
                                        onlyGrossCodesInInterval = true;

                                    if (netInInterval)
                                        onlyGrossCodesInInterval = false;

                                }

                                BalanceItemDTO biBalancechangePeriod = new BalanceItemDTO();

                                //Previus Year
                                BalanceItemDTO biBalancechangePreviousYearPeriod = new BalanceItemDTO();

                                //Previous Periods
                                BalanceItemDTO biBalancechangePreviousPeriodMinus1YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus2YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus3YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus4YearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousPeriodMinus5YearPeriod = new BalanceItemDTO();

                                //Budget
                                BalanceItemDTO biBudgetBalancechangePeriod = new BalanceItemDTO();

                                #endregion

                                #region Init BalanceReport, ResultReport

                                BalanceItemDTO biBalancechangeToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeIncludingPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeYear = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousYearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeIncludingPreviousYearPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangePreviousYear = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus1Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus2Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus3Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus4Year = new BalanceItemDTO();
                                BalanceItemDTO biBalancechangeToPreviousPeriodMinus5Year = new BalanceItemDTO();
                                BalanceItemDTO biBudgetBalancechangeToPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBudgetBalancechangeIncludingPeriod = new BalanceItemDTO();
                                BalanceItemDTO biBudgetBalancechangeYear = new BalanceItemDTO();

                                decimal accountBalancechangePeriodDiff = Decimal.Zero;
                                decimal accountBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeToPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeIncludingPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPeriod = Decimal.Zero;
                                decimal accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitToPeriod = Decimal.Zero;
                                decimal accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitIncludingPeriod = Decimal.Zero;
                                decimal accountGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitYear = Decimal.Zero;
                                decimal accountGrossProfitYearEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPeriodInBalance = Decimal.Zero;
                                decimal accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                                decimal accountGrossProfitYearOpeningBalance = Decimal.Zero;
                                decimal accountGrossProfitYearEntCurrencyOpeningBalance = Decimal.Zero;

                                //PreviousYear
                                decimal accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                                decimal accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitIncludingPreviousYearPeriod = Decimal.Zero;
                                decimal accountGrossProfitIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPreviousYear = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearOpeningBalance = Decimal.Zero;
                                decimal accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Decimal.Zero;
                                decimal accountBalancechangePreviousYearPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangePreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeToPreviousYearPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeToPreviousYearPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBalancechangeIncludingPreviousYearPeriodDiff = Decimal.Zero;
                                decimal accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = Decimal.Zero;

                                //Budget
                                decimal accountBudgetBalancechangePeriodDiff = Decimal.Zero;
                                decimal accountBudgetBalancechangePeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBudgetBalancechangeToPeriodDiff = Decimal.Zero;
                                decimal accountBudgetBalancechangeToPeriodDiffEntCurrency = Decimal.Zero;
                                decimal accountBudgetBalancechangeIncludingPeriodDiff = Decimal.Zero;
                                decimal accountBudgetBalancechangeIncludingPeriodDiffEntCurrency = Decimal.Zero;

                                //Budget and GrossProfit
                                decimal accountBudgetGrossProfitPeriod = Decimal.Zero;
                                decimal accountBudgetGrossProfitPeriodEntCurrency = Decimal.Zero;
                                decimal accountBudgetGrossProfitToPeriod = Decimal.Zero;
                                decimal accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                decimal accountBudgetGrossProfitIncludingPeriod = Decimal.Zero;
                                decimal accountBudgetGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                decimal accountBudgetGrossProfitYear = Decimal.Zero;
                                decimal accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;

                                //Voucher Period Summery
                                decimal accountQuantity = Decimal.Zero;
                                decimal accountPeriod1 = Decimal.Zero;
                                decimal accountPeriod2 = Decimal.Zero;
                                decimal accountPeriod3 = Decimal.Zero;
                                decimal accountPeriod4 = Decimal.Zero;
                                decimal accountPeriod5 = Decimal.Zero;
                                decimal accountPeriod6 = Decimal.Zero;
                                decimal accountPeriod7 = Decimal.Zero;
                                decimal accountPeriod8 = Decimal.Zero;
                                decimal accountPeriod9 = Decimal.Zero;
                                decimal accountPeriod10 = Decimal.Zero;
                                decimal accountPeriod11 = Decimal.Zero;
                                decimal accountPeriod12 = Decimal.Zero;

                                //PreviousYear Voucher Period Summery
                                decimal previousYearAccountPeriod1 = Decimal.Zero;
                                decimal previousYearAccountPeriod2 = Decimal.Zero;
                                decimal previousYearAccountPeriod3 = Decimal.Zero;
                                decimal previousYearAccountPeriod4 = Decimal.Zero;
                                decimal previousYearAccountPeriod5 = Decimal.Zero;
                                decimal previousYearAccountPeriod6 = Decimal.Zero;
                                decimal previousYearAccountPeriod7 = Decimal.Zero;
                                decimal previousYearAccountPeriod8 = Decimal.Zero;
                                decimal previousYearAccountPeriod9 = Decimal.Zero;
                                decimal previousYearAccountPeriod10 = Decimal.Zero;
                                decimal previousYearAccountPeriod11 = Decimal.Zero;
                                decimal previousYearAccountPeriod12 = Decimal.Zero;

                                //Previous Period
                                decimal previousPeriodMinus1YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus2YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus3YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus4YearAccountPeriod = Decimal.Zero;
                                decimal previousPeriodMinus5YearAccountPeriod = Decimal.Zero;

                                //Budget Voucher Period Summery
                                decimal budgetAccountPeriod1 = Decimal.Zero;
                                decimal budgetAccountPeriod2 = Decimal.Zero;
                                decimal budgetAccountPeriod3 = Decimal.Zero;
                                decimal budgetAccountPeriod4 = Decimal.Zero;
                                decimal budgetAccountPeriod5 = Decimal.Zero;
                                decimal budgetAccountPeriod6 = Decimal.Zero;
                                decimal budgetAccountPeriod7 = Decimal.Zero;
                                decimal budgetAccountPeriod8 = Decimal.Zero;
                                decimal budgetAccountPeriod9 = Decimal.Zero;
                                decimal budgetAccountPeriod10 = Decimal.Zero;
                                decimal budgetAccountPeriod11 = Decimal.Zero;
                                decimal budgetAccountPeriod12 = Decimal.Zero;

                                //Previous Year Voucher Year Summery
                                decimal accountYear0 = Decimal.Zero;
                                decimal accountYearMinus1 = Decimal.Zero;
                                decimal accountYearMinus2 = Decimal.Zero;
                                decimal accountYearMinus3 = Decimal.Zero;
                                decimal accountYearMinus4 = Decimal.Zero;

                                XElement voucherSummeryElement = null;
                                int voucherSummeryXmlId = 0;

                                //Voucher details
                                List<XElement> voucherRowElements = new List<XElement>();

                                #endregion

                                #region Calculate BalanceChangePeriod

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePeriod = biBalancechangePeriodDict[accountStd.AccountId];

                                    if (voucherHeadsBalancechangePeriod.Any())
                                    {
                                        string voucherType = "Selection";

                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount.AddRange(voucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList());
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (voucherRow.Quantity.HasValue)
                                                    accountQuantity += voucherRow.Quantity.Value;

                                                if (voucherHead.Date.Year == es.DateTo.Year)
                                                    accountYear0 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-1).Year)
                                                    accountYearMinus1 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-2).Year)
                                                    accountYearMinus2 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-3).Year)
                                                    accountYearMinus3 += voucherRow.Amount;
                                                if (voucherHead.Date.Year == es.DateTo.AddYears(-4).Year)
                                                    accountYearMinus4 += voucherRow.Amount;
                                                if (firstMonth == voucherHeadMonth)
                                                    accountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    accountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    accountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    accountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    accountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    accountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    accountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    accountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    accountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    accountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    accountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    accountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                            if ((accountVoucherRowAmount != 0 || voucherRowsForAccount.Count != 0) && ((detailedInformation && reportHeader.ShowRow) || es.SSTD_AccountDimId != 0))
                                                AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                    headerSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangePeriod += biBalancechangePeriod.Balance;
                                        groupSumAccountBalancechangePeriodEntCurrency += biBalancechangePeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangePeriod

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitPeriod = Decimal.Zero;
                                        accountGrossProfitPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                accountGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                accountGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBalanceChangePeriod.Any())
                                        {
                                            string voucherType = "GrossProfitCode";

                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    if (voucherRow.Quantity.HasValue)
                                                        accountQuantity += voucherRow.Quantity.Value;

                                                    if (voucherHead.Date.Year == es.DateTo.Year)
                                                        accountYear0 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == es.DateTo.AddYears(-1).Year)
                                                        accountYearMinus1 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == es.DateTo.AddYears(-2).Year)
                                                        accountYearMinus2 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == es.DateTo.AddYears(-3).Year)
                                                        accountYearMinus3 += voucherRow.Amount;
                                                    if (voucherHead.Date.Year == es.DateTo.AddYears(-4).Year)
                                                        accountYearMinus4 += voucherRow.Amount;
                                                    if (firstMonth == voucherHeadMonth)
                                                        accountPeriod1 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                        accountPeriod2 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                        accountPeriod3 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                        accountPeriod4 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                        accountPeriod5 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                        accountPeriod6 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                        accountPeriod7 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                        accountPeriod8 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                        accountPeriod9 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                        accountPeriod10 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                        accountPeriod11 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                        accountPeriod12 += voucherRow.Amount;

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }

                                                if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                    AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                    headerSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPeriod += accountGrossProfitPeriod;
                                        groupSumAccountGrossProfitPeriodEntCurrency += accountGrossProfitPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate GrossProfitChangePeriodBudget

                                if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            var x = pair.Value.Where(a => a.AccountId == accountStd.AccountId).ToList();
                                            foreach (var accountDto in x)
                                            {
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                    accountBudgetGrossProfitPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountBudgetGrossProfitPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        if (voucherHeadsGrossProfitBudgetBalanceChangePeriod.Any())
                                        // && detailedInformation)
                                        {
                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    if (firstMonth == voucherHeadMonth)
                                                        budgetAccountPeriod1 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                        budgetAccountPeriod2 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                        budgetAccountPeriod3 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                        budgetAccountPeriod4 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                        budgetAccountPeriod5 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                        budgetAccountPeriod6 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                        budgetAccountPeriod7 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                        budgetAccountPeriod8 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                        budgetAccountPeriod9 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                        budgetAccountPeriod10 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                        budgetAccountPeriod11 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                        budgetAccountPeriod12 += voucherRow.Amount;

                                                    accountVoucherRowAmount += voucherRow.Amount;
                                                }
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                    headerSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountGrossProfitPeriod += accountBudgetGrossProfitPeriod;
                                        groupSumBudgetAccountGrossProfitPeriodEntCurrency += accountBudgetGrossProfitPeriodEntCurrency;
                                    }
                                }



                                #endregion

                                #region Calculate BalanceChangePreviousYearPeriod

                                if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousYearPeriod = biBalancechangePreviousYearPeriodDict[accountStd.AccountId];

                                    if (previousYearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousYear";

                                        //VoucherHeads
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousYearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (firstMonth == voucherHeadMonth)
                                                    previousYearAccountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    previousYearAccountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    previousYearAccountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    previousYearAccountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    previousYearAccountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    previousYearAccountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    previousYearAccountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    previousYearAccountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    previousYearAccountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    previousYearAccountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    previousYearAccountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    previousYearAccountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }

                                            if (accountVoucherRowAmount != 0)
                                                AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                    headerSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountBalancechangePreviousYearPeriod += biBalancechangePreviousYearPeriod.Balance;
                                        groupSumAccountBalancechangePreviousYearPeriodEntCurrency += biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                    }
                                }
                                #endregion

                                #region Calculate GrossProfitChangePeriod Previous Year

                                if (biBalancechangePreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                {
                                    if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                    {
                                        accountGrossProfitPreviousYearPeriod = Decimal.Zero;
                                        accountGrossProfitPreviousYearPeriodEntCurrency = Decimal.Zero;
                                        List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                        foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangePreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                        {
                                            GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                            if (accountDto != null)
                                            {
                                                List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= prevYearDateFrom && b.PeriodTo <= prevYearDateTo).ToList();
                                                accountGrossProfitPreviousYearPeriod += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                accountGrossProfitPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                            }
                                        }


                                        if (previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "GrossProfitCodePreviousYear";

                                            //VoucherHeads
                                            List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                            {
                                                decimal accountVoucherRowAmount = 0;
                                                DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                {
                                                    #region Accumulate amounts

                                                    if (firstMonth == voucherHeadMonth)
                                                        previousYearAccountPeriod1 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                        previousYearAccountPeriod2 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                        previousYearAccountPeriod3 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                        previousYearAccountPeriod4 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                        previousYearAccountPeriod5 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                        previousYearAccountPeriod6 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                        previousYearAccountPeriod7 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                        previousYearAccountPeriod8 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                        previousYearAccountPeriod9 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                        previousYearAccountPeriod10 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                        previousYearAccountPeriod11 += voucherRow.Amount;
                                                    if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                        previousYearAccountPeriod12 += voucherRow.Amount;

                                                    accountVoucherRowAmount += voucherRow.Amount;

                                                    #endregion
                                                }

                                                if (accountVoucherRowAmount != 0)
                                                    AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                    headerSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumAccountGrossProfitPreviousYearPeriod += accountGrossProfitPreviousYearPeriod;
                                        groupSumAccountGrossProfitPreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrency;
                                    }
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus1Year

                                if (biBalancechangePrevoiusPeriodMinus1YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus1YearPeriod = biBalancechangePrevoiusPeriodMinus1YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus1YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus1Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus1YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();

                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus1Year += biBalancechangePreviousPeriodMinus1YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus2Year

                                if (biBalancechangePrevoiusPeriodMinus2YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus2YearPeriod = biBalancechangePrevoiusPeriodMinus2YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus2YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus2Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus2YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus2Year += biBalancechangePreviousPeriodMinus2YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus3Year

                                if (biBalancechangePrevoiusPeriodMinus3YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus3YearPeriod = biBalancechangePrevoiusPeriodMinus3YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus3YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus3Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus3YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus3Year += biBalancechangePreviousPeriodMinus3YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus4Year

                                if (biBalancechangePrevoiusPeriodMinus4YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus4YearPeriod = biBalancechangePrevoiusPeriodMinus4YearDict[accountStd.AccountId];

                                    //VoucherHeadss
                                    if (previousPeriodMinus4YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus4Year";
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus4YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus4Year += biBalancechangePreviousPeriodMinus4YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceChangePreviousPeriodMinus5Year

                                if (biBalancechangePrevoiusPeriodMinus5YearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBalancechangePreviousPeriodMinus5YearPeriod = biBalancechangePrevoiusPeriodMinus5YearDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (previousPeriodMinus5YearVoucherHeadsBalancechangePeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                    {
                                        string voucherType = "PreviousPeriodMinus5Year";

                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = previousPeriodMinus5YearVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                    }

                                    //Accumulate
                                    headerSumAccountBalancechangePreviousPeriodMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                        groupSumAccountBalancechangePreviousPeriodYearMinus5Year += biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                    //TODO maybe.. Grossprofit
                                }

                                #endregion

                                #region Calculate BalanceBudgetChangePeriod

                                if (biBudgetBalancechangePeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                {
                                    biBudgetBalancechangePeriod = biBudgetBalancechangePeriodDict[accountStd.AccountId];

                                    //VoucherHeads
                                    if (budgetVoucherHeadsBalancechangePeriod.Any())
                                    //&& detailedInformation)
                                    {

                                        //BudgetAccountId is only used for performance
                                        List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                        voucherHeadsForAccount = budgetVoucherHeadsBalancechangePeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList();
                                        foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                        {
                                            decimal accountVoucherRowAmount = 0;
                                            DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                            List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                            {
                                                #region Accumulate amounts

                                                if (firstMonth == voucherHeadMonth)
                                                    budgetAccountPeriod1 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(1) == voucherHeadMonth)
                                                    budgetAccountPeriod2 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(2) == voucherHeadMonth)
                                                    budgetAccountPeriod3 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(3) == voucherHeadMonth)
                                                    budgetAccountPeriod4 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(4) == voucherHeadMonth)
                                                    budgetAccountPeriod5 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(5) == voucherHeadMonth)
                                                    budgetAccountPeriod6 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(6) == voucherHeadMonth)
                                                    budgetAccountPeriod7 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(7) == voucherHeadMonth)
                                                    budgetAccountPeriod8 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(8) == voucherHeadMonth)
                                                    budgetAccountPeriod9 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(9) == voucherHeadMonth)
                                                    budgetAccountPeriod10 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(10) == voucherHeadMonth)
                                                    budgetAccountPeriod11 += voucherRow.Amount;
                                                if (firstMonth.AddMonths(11) == voucherHeadMonth)
                                                    budgetAccountPeriod12 += voucherRow.Amount;

                                                accountVoucherRowAmount += voucherRow.Amount;

                                                #endregion
                                            }
                                        }
                                    }

                                    //Accumulate
                                    headerSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                    headerSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                    if (!reportHeader.DoNotSummarizeOnGroup)
                                    {
                                        groupSumBudgetAccountBalancechangePeriod += biBudgetBalancechangePeriod.Balance;
                                        groupSumBudgetAccountBalancechangePeriodEntCurrency += biBudgetBalancechangePeriod.BalanceEntCurrency;
                                    }
                                }

                                #endregion

                                if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReport || es.ReportTemplateType == SoeReportTemplateType.SruReport)
                                {
                                    #region BalanceReport and ResultReport

                                    #region Init BalanceReport

                                    BalanceItemDTO biYearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPeriodInBalance = new BalanceItemDTO();

                                    //previousYear
                                    BalanceItemDTO biPreviousYearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousYearPeriodInBalance = new BalanceItemDTO();

                                    //Previous Period
                                    BalanceItemDTO biPreviousPeriodMinus1YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus2YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus3YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus4YearInBalance = new BalanceItemDTO();
                                    BalanceItemDTO biPreviousPeriodMinus5YearInBalance = new BalanceItemDTO();

                                    decimal accountClosingBalance = Decimal.Zero;
                                    decimal accountClosingBalanceEntCurrency = Decimal.Zero;
                                    decimal accountPeriodInBalanceDiff = Decimal.Zero;
                                    decimal accountPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                                    decimal accountOpeningBalanceDiff = Decimal.Zero;
                                    decimal accountOpeningBalanceDiffEntCurrency = Decimal.Zero;
                                    decimal accountClosingBalanceDiff = Decimal.Zero;
                                    decimal accountClosingBalanceDiffEntCurrency = Decimal.Zero;

                                    //PreviousYear
                                    decimal accountClosingBalancePreviousYear = Decimal.Zero;
                                    decimal accountClosingBalancePreviousYearEntCurrency = Decimal.Zero;
                                    decimal accountPreviousYearPeriodInBalanceDiff = Decimal.Zero;
                                    decimal accountPreviousYearPeriodInBalanceDiffEntCurrency = Decimal.Zero;
                                    decimal accountOpeningBalanceDiffPreviousYear = Decimal.Zero;
                                    decimal accountOpeningBalanceDiffPreviousYearEntCurrency = Decimal.Zero;
                                    decimal accountClosingBalanceDiffPreviousYear = Decimal.Zero;
                                    decimal accountClosingBalanceDiffPreviousYearEntCurrency = Decimal.Zero;

                                    #endregion

                                    #region Init ResultReport

                                    BalanceItemDTO biAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                    BalanceItemDTO biAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                    //PreviousYear
                                    BalanceItemDTO biAccountBalanceChangeAllPreviousToPreviousYearPeriod = new BalanceItemDTO();
                                    BalanceItemDTO biAccountBalanceChangeAllPreviousPreviousYear = new BalanceItemDTO();

                                    //Budget
                                    BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousToPeriod = new BalanceItemDTO();
                                    BalanceItemDTO biBudgetAccountBalanceChangeAllPreviousThisYear = new BalanceItemDTO();

                                    #endregion

                                    #region Calculate BalanceChangeToPeriod

                                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangeToPeriod = biBalanceChangeToPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (voucherHeadsBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeToSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                        headerSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeToPeriod += biBalancechangeToPeriod.Balance;
                                            groupSumAccountBalancechangeToPeriodEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeToPeriod

                                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitToPeriod = Decimal.Zero;
                                            accountGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                    accountGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "GrossProfitCodeToPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts
                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0)
                                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }


                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeToPeriod += accountGrossProfitToPeriod;
                                        headerSumAccountGrossProfitBalancechangeToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitToPeriod += accountGrossProfitToPeriod;
                                            groupSumAccountBalancechangeGrossProfitToPeriodEntCurrency += accountGrossProfitToPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeToPeriodBudget

                                    if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountBudgetGrossProfitToPeriod = Decimal.Zero;
                                            accountBudgetGrossProfitToPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                    accountBudgetGrossProfitToPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountBudgetGrossProfitToPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "BudgetGrossProfitCodeToPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                                voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts

                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0)
                                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountGrossProfitBalancechangeToPeriod += accountBudgetGrossProfitToPeriod;
                                        headerSumBudgetAccountGrossProfitBalancechangeToPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountGrossProfitToPeriod += accountBudgetGrossProfitToPeriod;
                                            groupSumBudgetAccountGrossProfitToPeriodEntCurrency += accountBudgetGrossProfitToPeriodEntCurrency;
                                        }
                                    }


                                    #endregion

                                    #region Calculate BalanceChangeIncludingPeriod

                                    if (biBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval && biBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        biBalancechangeIncludingPeriod = biBalanceChangeIncludingPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (voucherHeadsBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeIncludingSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeIncludingPeriod += biBalancechangeIncludingPeriod.Balance;
                                        headerSumAccountBalancechangeIncludingPeriodEntCurrency += biBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeIncludingPeriod += biBalancechangeIncludingPeriod.Balance;
                                            groupSumAccountBalancechangeIncludingPeriodEntCurrency += biBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeIncludingPeriod

                                    if (biBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitIncludingPeriod = Decimal.Zero;
                                            accountGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeIncludingPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodTo <= es.DateTo).ToList();
                                                    accountGrossProfitIncludingPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitIncludingPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "GrossProfitCodeIncludingPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts

                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeIncludingPeriod += accountGrossProfitIncludingPeriod;
                                        headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency += accountGrossProfitIncludingPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitIncludingPeriod += accountGrossProfitIncludingPeriod;
                                            groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency += accountGrossProfitIncludingPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeIncludingPeriodBudget

                                    if (biBalancechangePeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountBudgetGrossProfitIncludingPeriod = Decimal.Zero;
                                            accountBudgetGrossProfitIncludingPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeIncludingPeriodBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                var x = pair.Value.Where(a => a.AccountId == accountStd.AccountId).ToList();
                                                foreach (var accountDto in x)
                                                {
                                                    if (accountDto != null)
                                                    {
                                                        List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodTo <= es.DateTo).ToList();
                                                        accountBudgetGrossProfitIncludingPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                        accountBudgetGrossProfitIncludingPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                    }
                                                }
                                            }

                                            if (voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "BudgetGrossProfitCodeIncludingPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts

                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0)
                                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod += accountBudgetGrossProfitIncludingPeriod;
                                        headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriodEntCurrency += accountBudgetGrossProfitIncludingPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountGrossProfitIncludingPeriod += accountBudgetGrossProfitIncludingPeriod;
                                            groupSumBudgetAccountGrossProfitIncludingPeriodEntCurrency += accountBudgetGrossProfitIncludingPeriodEntCurrency;
                                        }
                                    }

                                    #endregion


                                    #region Calculate BalanceChangeToPreviousYearPeriod

                                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangeToPreviousYearPeriod = biBalanceChangeToPreviousYearPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (previousYearVoucherHeadsBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeToPreviousYearSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = previousYearVoucherHeadsBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                        headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeToPreviousYearPeriod += biBalancechangeToPreviousYearPeriod.Balance;
                                            groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeToPreviousYearPeriod

                                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitToPreviousYearPeriod = Decimal.Zero;
                                            accountGrossProfitToPreviousYearPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= es.DateFrom && b.PeriodTo <= es.DateTo).ToList();
                                                    accountGrossProfitToPreviousYearPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitToPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Any())
                                            {
                                                string voucherType = "GrossProfitCodeToPreviousYearPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts



                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                        headerSumAccountGrossProfitBalancechangeToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitToPreviousYearPeriod += accountGrossProfitToPreviousYearPeriod;
                                            groupSumAccountBalancechangeGrossProfitToPreviousYearPeriodEntCurrency += accountGrossProfitToPreviousYearPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BalanceChangeIncludingPreviousYearPeriod

                                    if (biBalanceChangeToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval && biBalanceChangeIncludingPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        biBalancechangeIncludingPreviousYearPeriod = biBalanceChangeIncludingPreviousYearPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (previousYearVoucherHeadsBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeIncludingPreviousYearSelection";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = previousYearVoucherHeadsBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeIncludingPreviousYearPeriod += biBalancechangeIncludingPreviousYearPeriod.Balance;
                                        headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency += biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeIncludingPreviousYearPeriod += biBalancechangeIncludingPreviousYearPeriod.Balance;
                                            groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency += biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitChangeIncludingPreviousYearPeriod

                                    if (biBalanceChangeIncludingPreviousYearPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitIncludingPreviousYearPeriod = Decimal.Zero;
                                            accountGrossProfitIncludingPreviousYearPeriodEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodTo <= es.DateTo).ToList();
                                                    accountGrossProfitIncludingPreviousYearPeriod += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitIncludingPreviousYearPeriodEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }

                                            if (previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                            {
                                                string voucherType = "GrossProfitCodePreviousYearIncludingPeriod";

                                                //VoucherHeads
                                                List<VoucherHeadDTO> voucherHeadsForAccount = previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                                foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
                                                {
                                                    decimal accountVoucherRowAmount = 0;
                                                    DateTime voucherHeadMonth = CalendarUtility.GetFirstDateOfMonth(voucherHead.Date);

                                                    List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.Dim1Id == accountStd.AccountId && r.Amount != 0).ToList();
                                                    foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
                                                    {
                                                        #region Accumulate amounts



                                                        accountVoucherRowAmount += voucherRow.Amount;

                                                        #endregion
                                                    }

                                                    if (accountVoucherRowAmount != 0 && detailedInformation && reportHeader.ShowRow)
                                                        AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, voucherHead.Date, reportHeader.Name);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod += accountGrossProfitIncludingPreviousYearPeriod;
                                        headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriodEntCurrency += accountGrossProfitIncludingPreviousYearPeriodEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod += accountGrossProfitIncludingPreviousYearPeriod;
                                            groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriodEntCurrency += accountGrossProfitIncludingPreviousYearPeriodEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BudgetBalanceChangeToPeriod

                                    if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBudgetBalancechangeToPeriod = biBudgetBalanceChangeToPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (budgetVoucherHeadsBalanceChangeToPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "BudgetToPeriod";

                                            //BudgetAccountId is only used for performance
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = budgetVoucherHeadsBalanceChangeToPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                        headerSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountBalancechangeToPeriod += biBudgetBalancechangeToPeriod.Balance;
                                            groupSumBudgetAccountBalancechangeToPeriodEntCurrency += biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BudgetBalanceChangeIncludingPeriod

                                    if (biBudgetBalanceChangeToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval && biBudgetBalanceChangeIncludingPeriodDict.ContainsKey(accountStd.AccountId))
                                    {
                                        biBudgetBalancechangeIncludingPeriod = biBudgetBalanceChangeIncludingPeriodDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (budgetVoucherHeadsBalanceChangeIncludingPeriod.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "BudgetIncludingPeriod";

                                            //BudgetAccountId is only used for performance
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = budgetVoucherHeadsBalanceChangeIncludingPeriod.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountBalancechangeIncludingPeriod += biBudgetBalancechangeIncludingPeriod.Balance;
                                        headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency += biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountBalancechangeIncludingPeriod += biBudgetBalancechangeIncludingPeriod.Balance;
                                            groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency += biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate BalanceChangeYear

                                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangeYear = biBalanceChangeYearDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (voucherHeadsBalanceChangeYear.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangeYear";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = voucherHeadsBalanceChangeYear.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                        headerSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangeYear += biBalancechangeYear.Balance;
                                            groupSumAccountBalancechangeYearEntCurrency += biBalancechangeYear.BalanceEntCurrency;
                                        }
                                    }

                                    #region Calculate GrossProfitCode BalanceChangeYear

                                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitYear = Decimal.Zero;
                                            accountGrossProfitYearEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (var pair in biGrossProfitBalanceChangeYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime startYear = accountYear.From;
                                                    DateTime endYear = accountYear.To;

                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitYear += accountGrossProfitYear;
                                        headerSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitYear += accountGrossProfitYear;
                                            groupSumAccountGrossProfitYearEntCurrency += accountGrossProfitYearEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate GrossProfitCode BalanceChangeYear Budget

                                    if (biBalanceChangeYearDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountBudgetGrossProfitYear = Decimal.Zero;
                                            accountBudgetGrossProfitYearEntCurrency = Decimal.Zero;
                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                            foreach (var pair in biGrossProfitBalanceChangeYearBudgetDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime startYear = accountYear.From;
                                                    DateTime endYear = accountYear.To;

                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                    accountBudgetGrossProfitYear += Math.Round(grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                    accountBudgetGrossProfitYearEntCurrency += Math.Round(grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                        headerSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountGrossProfitYear += accountBudgetGrossProfitYear;
                                            groupSumBudgetAccountGrossProfitYearEntCurrency += accountBudgetGrossProfitYearEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #endregion

                                    #region Calculate BalanceChangePreviousYear

                                    if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBalancechangePreviousYear = biBalanceChangePreviousYearDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (previousYearVoucherHeadsBalanceChangeYear.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "ChangePreviousYear";

                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount = previousYearVoucherHeadsBalanceChangeYear.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId)).ToList();
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                        headerSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountBalancechangePreviousYear += biBalancechangePreviousYear.Balance;
                                            groupSumAccountBalancechangePreviousYearEntCurrency += biBalancechangePreviousYear.BalanceEntCurrency;
                                        }
                                    }

                                    #region Calculate GrossProfitCode BalanceChangePreviousYear

                                    if (biBalanceChangePreviousYearDict.ContainsKey(accountStd.AccountId))
                                    {
                                        if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                        {
                                            accountGrossProfitPreviousYear = Decimal.Zero;
                                            accountGrossProfitPreviousYearEntCurrency = Decimal.Zero;

                                            List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();
                                            foreach (var pair in biGrossProfitBalanceChangePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                            {
                                                GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                if (accountDto != null)
                                                {
                                                    DateTime startYear = previousAccountYear.From;
                                                    DateTime endYear = previousAccountYear.To;

                                                    List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= startYear && b.PeriodTo <= endYear).ToList();
                                                    accountGrossProfitPreviousYear += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                    accountGrossProfitPreviousYearEntCurrency += Math.Round(grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                                }
                                            }
                                        }

                                        //Accumulate
                                        headerSumAccountGrossProfitBalancechangePreviousYearPeriod += accountGrossProfitPreviousYear;
                                        headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPreviousYear += accountGrossProfitPreviousYear;
                                            groupSumAccountGrossProfitPreviousYearEntCurrency += accountGrossProfitPreviousYearEntCurrency;
                                        }
                                    }

                                    #endregion


                                    #endregion

                                    #region Calculate BudgetBalanceChangeYear

                                    if (biBudgetBalanceChangeYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                    {
                                        biBudgetBalancechangeYear = biBudgetBalanceChangeYearDict[accountStd.AccountId];

                                        //VoucherHeads
                                        if (budgetVoucherHeadsBalanceChangeYear.Any() && detailedInformation && reportHeader.ShowRow)
                                        {
                                            string voucherType = "BudgetChangeYear";

                                            //BudgetAccountId is only used for performance
                                            List<VoucherHeadDTO> voucherHeadsForAccount = new List<VoucherHeadDTO>();
                                            voucherHeadsForAccount.AddRange(budgetVoucherHeadsBalanceChangeYear.Where(i => i.AccountIds != null && i.AccountIds.Contains(accountStd.AccountId) && i.BudgetAccountId == accountStd.AccountId).ToList());
                                            AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherHeadsForAccount, accountStd, accountDimInternals, voucherType, invertRow, accountInternalsInInterval, reportHeader.Name);
                                        }

                                        //Accumulate
                                        headerSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                        headerSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumBudgetAccountBalancechangeYear += biBudgetBalancechangeYear.Balance;
                                            groupSumBudgetAccountBalancechangeYearEntCurrency += biBudgetBalancechangeYear.BalanceEntCurrency;
                                        }
                                    }

                                    #endregion

                                    #region Calculate Diff (TODO)

                                    accountBalancechangePeriodDiff = 0; //TODO
                                    accountBalancechangePeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangePeriodDiff += accountBalancechangePeriodDiff;
                                    headerSumAccountBalancechangePeriodDiffEntCurrency += accountBalancechangePeriodDiffEntCurrency;
                                    groupSumAccountBalancechangePeriodDiff += accountBalancechangePeriodDiff;
                                    groupSumAccountBalancechangePeriodDiffEntCurrency += accountBalancechangePeriodDiffEntCurrency;

                                    accountBalancechangeToPeriodDiff = 0; //TODO
                                    accountBalancechangeToPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeToPeriodDiff += accountBalancechangeToPeriodDiff;
                                    headerSumAccountBalancechangeToPeriodDiffEntCurrency += accountBalancechangeToPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeToPeriodDiff += accountBalancechangeToPeriodDiff;
                                    groupSumAccountBalancechangeToPeriodDiffEntCurrency += accountBalancechangeToPeriodDiffEntCurrency;

                                    accountBalancechangeIncludingPeriodDiff = 0; //TODO
                                    accountBalancechangeIncludingPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeIncludingPeriodDiff += accountBalancechangeIncludingPeriodDiff;
                                    headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBalancechangeIncludingPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeIncludingPeriodDiff += accountBalancechangeIncludingPeriodDiff;
                                    groupSumAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBalancechangeIncludingPeriodDiffEntCurrency;

                                    // PreviousYear
                                    accountBalancechangePreviousYearPeriodDiff = 0; //TODO
                                    accountBalancechangePreviousYearPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangePreviousYearPeriodDiff += accountBalancechangePreviousYearPeriodDiff;
                                    headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency += accountBalancechangePreviousYearPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangePreviousYearPeriodDiff += accountBalancechangePreviousYearPeriodDiff;
                                    groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency += accountBalancechangePreviousYearPeriodDiffEntCurrency;

                                    accountBalancechangeToPreviousYearPeriodDiff = 0; //TODO
                                    accountBalancechangeToPreviousYearPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeToPreviousYearPeriodDiff += accountBalancechangeToPreviousYearPeriodDiff;
                                    headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency += accountBalancechangeToPreviousYearPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeToPreviousYearPeriodDiff += accountBalancechangeToPreviousYearPeriodDiff;
                                    groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency += accountBalancechangeToPreviousYearPeriodDiffEntCurrency;

                                    accountBalancechangeIncludingPreviousYearPeriodDiff = 0; //TODO
                                    accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency = 0; //TODO
                                    headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff += accountBalancechangeIncludingPreviousYearPeriodDiff;
                                    headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency += accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency;
                                    groupSumAccountBalancechangeIncludingPreviousYearPeriodDiff += accountBalancechangeIncludingPreviousYearPeriodDiff;
                                    groupSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency += accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency;


                                    //Budget
                                    accountBudgetBalancechangePeriodDiff = 0; //TODO
                                    accountBudgetBalancechangePeriodDiffEntCurrency = 0; //TODO
                                    headerSumBudgetAccountBalancechangePeriodDiff += accountBudgetBalancechangePeriodDiff;
                                    headerSumBudgetAccountBalancechangePeriodDiffEntCurrency += accountBudgetBalancechangePeriodDiffEntCurrency;
                                    groupSumBudgetAccountBalancechangePeriodDiff += accountBudgetBalancechangePeriodDiff;
                                    groupSumBudgetAccountBalancechangePeriodDiffEntCurrency += accountBudgetBalancechangePeriodDiffEntCurrency;

                                    accountBudgetBalancechangeToPeriodDiff = 0; //TODO
                                    accountBudgetBalancechangeToPeriodDiffEntCurrency = 0; //TODO
                                    headerSumBudgetAccountBalancechangeToPeriodDiff += accountBudgetBalancechangeToPeriodDiff;
                                    headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency += accountBudgetBalancechangeToPeriodDiffEntCurrency;
                                    groupSumBudgetAccountBalancechangeToPeriodDiff += accountBudgetBalancechangeToPeriodDiff;
                                    groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency += accountBudgetBalancechangeToPeriodDiffEntCurrency;

                                    accountBudgetBalancechangeIncludingPeriodDiff = 0; //TODO
                                    accountBudgetBalancechangeIncludingPeriodDiffEntCurrency = 0; //TODO
                                    headerSumBudgetAccountBalancechangeIncludingPeriodDiff += accountBudgetBalancechangeIncludingPeriodDiff;
                                    headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBudgetBalancechangeIncludingPeriodDiffEntCurrency;
                                    groupSumBudgetAccountBalancechangeIncludingPeriodDiff += accountBudgetBalancechangeIncludingPeriodDiff;
                                    groupSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency += accountBudgetBalancechangeIncludingPeriodDiffEntCurrency;

                                    #endregion

                                    if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.SruReport)
                                    {
                                        #region BalanceReport

                                        #region Calculate OpeningYearBalance

                                        if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biYearInBalance = biYearInBalanceDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountYearInBalance += biYearInBalance.Balance;
                                            headerSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountYearInBalance += biYearInBalance.Balance;
                                                groupSumAccountYearInBalanceEntCurrency += biYearInBalance.BalanceEntCurrency;
                                            }
                                            headerSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                            headerSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountGrossProfitYearInBalance += accountGrossProfitYearOpeningBalance;
                                                groupSumAccountGrossProfitYearInBalanceEntCurrency += accountGrossProfitYearEntCurrencyOpeningBalance;
                                            }
                                        }

                                        #region Calculate GrossProfitCode

                                        if (biYearInBalanceDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                        {
                                            GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                            if (grossProfitCode != null)
                                            {
                                                accountGrossProfitYearOpeningBalance = Math.Round((biYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                                accountGrossProfitYearEntCurrencyOpeningBalance = Math.Round((biYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                            }
                                        }

                                        #endregion

                                        #endregion

                                        #region Calculate OpeningYearBalance Previus Year

                                        if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biPreviousYearInBalance = biYearInBalancePreviousYearDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                            headerSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountPreviousYearInBalance += biPreviousYearInBalance.Balance;
                                                groupSumAccountPreviousYearInBalanceEntCurrency += biPreviousYearInBalance.BalanceEntCurrency;
                                            }
                                            headerSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                            headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountGrossProfitPreviousYearInBalance += accountGrossProfitPreviousYearOpeningBalance;
                                                groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency += accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                            }
                                        }

                                        #region Calculate OpeningYearBalance GrossProfitCode PreviousYear

                                        if (biYearInBalancePreviousYearDict.ContainsKey(accountStd.AccountId) && accountStd.GrossProfitCode != null)
                                        {
                                            GrossProfitCodeDTO grossProfitCode = grossProfitCodes.FirstOrDefault(g => accountStd.GrossProfitCode.Contains(g.Code));
                                            if (grossProfitCode != null)
                                            {
                                                accountGrossProfitPreviousYearOpeningBalance = Math.Round((biPreviousYearInBalance.Balance * (grossProfitCode.OpeningBalance / 100)), 2);
                                                accountGrossProfitPreviousYearEntCurrencyOpeningBalance = Math.Round((biPreviousYearInBalance.BalanceEntCurrency * (grossProfitCode.OpeningBalance / 100)), 2);
                                            }
                                        }

                                        #endregion

                                        #endregion

                                        #region Calculate PeriodInBalance

                                        //Ingående saldo för aktuell period. (Ingående balans för aktuellt år + Från år start till period start)
                                        //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                        biPeriodInBalance.Balance = biYearInBalance.Balance;

                                        #region Calculate GrossProfitCode

                                        if (accountYear.From != es.DateFrom)
                                        {
                                            if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                            {
                                                accountGrossProfitPeriodInBalance = Decimal.Zero;
                                                accountGrossProfitPeriodEntCurrencyInBalance = Decimal.Zero;
                                                List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                                foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitBalanceChangeToPeriodDict.Where(d => gpCodeIds.Contains(d.Key)))
                                                {
                                                    GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                    if (accountDto != null)
                                                    {
                                                        DateTime endYear = new DateTime(es.DateFrom.Year, es.DateFrom.Month, DateTime.DaysInMonth(es.DateTo.Year, es.DateFrom.Month)).AddMonths(-1);
                                                        List<GrossProfitBalanceItemDTO> grossProfitBalanceItems = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                        accountGrossProfitPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItems.Sum(g => g.Balance), 2);
                                                        accountGrossProfitPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItems.Sum(g => g.BalanceEntCurrency), 2);

                                                    }
                                                }

                                            }

                                            biPeriodInBalance.Balance += biBalancechangeToPeriod.Balance;
                                            biPeriodInBalance.BalanceEntCurrency += biBalancechangeToPeriod.BalanceEntCurrency;
                                        }
                                        else
                                        {
                                            accountGrossProfitYearEntCurrencyOpeningBalance = accountGrossProfitYearOpeningBalance;
                                        }

                                        #endregion

                                        if (biYearInBalance.Quantity.HasValue)
                                            biPeriodInBalance.Quantity += biYearInBalance.Quantity.Value;
                                        if (biBalancechangeToPeriod.Quantity.HasValue)
                                            biPeriodInBalance.Quantity += biBalancechangeToPeriod.Quantity.Value;

                                        //Accumulate
                                        headerSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                        headerSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountPeriodInBalance += biPeriodInBalance.Balance;
                                            groupSumAccountPeriodInBalanceEntCurrency += biPeriodInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                        headerSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPeriodInBalance += accountGrossProfitPeriodInBalance;
                                            groupSumAccountGrossProfitPeriodInBalanceEntCurrency += accountGrossProfitPeriodEntCurrencyInBalance;
                                        }

                                        #endregion

                                        #region Calculate PeriodInBalance Previus Year

                                        //Ingående saldo för aktuell period förra året. (Ingående balans för förra året + Från år start till period start)
                                        //If AccountYear and selection date from is same, dont calculate with opening balance (ex: 1/1 - 31/12)
                                        biPreviousYearPeriodInBalance.Balance = biPreviousYearInBalance.Balance;

                                        #region Calculate GrossProfitCode Previus Year

                                        if (previousAccountYear != null && previousAccountYear.From != prevYearDateFrom)
                                        {
                                            if (!accountStd.GrossProfitCode.IsNullOrEmpty())
                                            {
                                                accountGrossProfitPreviousYearPeriodInBalance = Decimal.Zero;
                                                accountGrossProfitPreviousYearPeriodEntCurrencyInBalance = Decimal.Zero;
                                                List<int> gpCodeIds = grossProfitCodes.Where(g => accountStd.GrossProfitCode.Contains(g.Code)).Select(g => g.GrossProfitCodeId).ToList();

                                                foreach (KeyValuePair<int, List<GrossProfitAccountBalanceItemDTO>> pair in biGrossProfitYearInBalancePreviousYearDict.Where(d => gpCodeIds.Contains(d.Key)))
                                                {
                                                    GrossProfitAccountBalanceItemDTO accountDto = pair.Value.FirstOrDefault(a => a.AccountId == accountStd.AccountId);
                                                    if (accountDto != null)
                                                    {
                                                        DateTime endYear = new DateTime(prevYearDateFrom.Year, prevYearDateFrom.Month, DateTime.DaysInMonth(prevYearDateTo.Year, prevYearDateFrom.Month)).AddMonths(-1);
                                                        List<GrossProfitBalanceItemDTO> grossProfitBalanceItemsPreviousYear = accountDto.BalanceItems.Where(b => b.PeriodFrom >= accountYear.From && b.PeriodTo <= endYear).ToList();
                                                        accountGrossProfitPreviousYearPeriodInBalance += Math.Round(accountGrossProfitYearOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.Balance), 2);
                                                        accountGrossProfitPreviousYearPeriodEntCurrencyInBalance += Math.Round(accountGrossProfitYearEntCurrencyOpeningBalance + grossProfitBalanceItemsPreviousYear.Sum(g => g.BalanceEntCurrency), 2);
                                                    }
                                                }
                                            }

                                            biPreviousYearPeriodInBalance.Balance += biBalancechangeToPreviousYearPeriod.Balance;
                                            biPreviousYearPeriodInBalance.BalanceEntCurrency += biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                        }
                                        else
                                        {
                                            accountGrossProfitPreviousYearEntCurrencyOpeningBalance = accountGrossProfitPreviousYearOpeningBalance;
                                        }

                                        #endregion

                                        if (biPreviousYearInBalance.Quantity.HasValue)
                                            biPreviousYearPeriodInBalance.Quantity += biPreviousYearInBalance.Quantity.Value;

                                        if (biBalancechangeToPreviousYearPeriod.Quantity.HasValue)
                                            biPreviousYearPeriodInBalance.Quantity += biBalancechangeToPreviousYearPeriod.Quantity.Value;

                                        //Accumulate
                                        headerSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                        headerSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountPreviousYearPeriodInBalance += biPreviousYearPeriodInBalance.Balance;
                                            groupSumAccountPreviousYearPeriodInBalanceEntCurrency += biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                        }
                                        headerSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                        headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountGrossProfitPreviousYearPeriodInBalance += accountGrossProfitPreviousYearPeriodInBalance;
                                            groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency += accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                        }

                                        #endregion

                                        #region Calculate ClosingYearBalance

                                        //Utgående balans för aktuellt år
                                        accountClosingBalance = biPeriodInBalance.Balance + biBalancechangePeriod.Balance;
                                        accountClosingBalanceEntCurrency = biPeriodInBalance.BalanceEntCurrency + biBalancechangePeriod.BalanceEntCurrency;

                                        //Accumulate
                                        headerSumAccountClosingBalance += accountClosingBalance;
                                        headerSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountClosingBalance += accountClosingBalance;
                                            groupSumAccountClosingBalanceEntCurrency += accountClosingBalanceEntCurrency;
                                        }

                                        #endregion

                                        #region Calculate ClosingYearBalance Previus Year

                                        //Utgående balans för aktuellt år
                                        accountClosingBalancePreviousYear = biPreviousYearPeriodInBalance.Balance + biBalancechangePreviousYearPeriod.Balance;
                                        accountClosingBalancePreviousYearEntCurrency = biPreviousYearPeriodInBalance.BalanceEntCurrency + biBalancechangePreviousYearPeriod.BalanceEntCurrency;

                                        //Accumulate
                                        headerSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                        headerSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountClosingBalancePreviousYear += accountClosingBalancePreviousYear;
                                            groupSumAccountClosingBalancePreviousYearEntCurrency += accountClosingBalancePreviousYearEntCurrency;
                                        }

                                        #endregion

                                        #region Calculate Diff

                                        //Ingående saldo för jämförd period
                                        accountPeriodInBalanceDiff = headerSumAccountPeriodInBalance - headerSumAccountPreviousYearInBalance;
                                        if (accountPeriodInBalanceDiff != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountPeriodInBalanceDiff += accountPeriodInBalanceDiff;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountPeriodInBalanceDiff += accountPeriodInBalanceDiff;
                                                groupSumAccountBalancechangePeriodDiff += accountPeriodInBalanceDiff;
                                            }
                                        }

                                        //Ingående saldo för jämförd period - valuta
                                        accountPeriodInBalanceDiffEntCurrency = headerSumAccountPeriodInBalanceEntCurrency - headerSumAccountPreviousYearInBalanceEntCurrency;
                                        if (accountPeriodInBalanceDiffEntCurrency != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountPeriodInBalanceDiffEntCurrency += accountPeriodInBalanceDiffEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountPeriodInBalanceDiffEntCurrency += accountPeriodInBalanceDiffEntCurrency;
                                                groupSumAccountBalancechangePeriodDiffEntCurrency += accountPeriodInBalanceDiffEntCurrency;
                                            }
                                        }

                                        //Ingående balans för jämförd år
                                        accountOpeningBalanceDiff = headerSumAccountYearInBalance - headerSumAccountPreviousYearInBalance;
                                        if (accountOpeningBalanceDiff != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountOpeningBalanceDiff += accountOpeningBalanceDiff;
                                            groupSumAccountOpeningBalanceDiff += accountOpeningBalanceDiff;

                                            groupSumAccountBalancechangeToPeriodDiff += accountOpeningBalanceDiff;
                                        }

                                        //Ingående balans för jämförd år
                                        accountOpeningBalanceDiffEntCurrency = headerSumAccountYearInBalanceEntCurrency - headerSumAccountPreviousYearInBalanceEntCurrency;
                                        if (accountOpeningBalanceDiffEntCurrency != Decimal.Zero)
                                        {
                                            //Accumulate
                                            headerSumAccountOpeningBalanceDiffEntCurrency += accountOpeningBalanceDiffEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountOpeningBalanceDiffEntCurrency += accountOpeningBalanceDiffEntCurrency;
                                                groupSumAccountBalancechangeToPeriodDiffEntCurrency += accountOpeningBalanceDiffEntCurrency;
                                            }
                                        }

                                        //Utgående balans för jämförd år
                                        accountClosingBalanceDiff = accountClosingBalance - accountClosingBalancePreviousYear;
                                        accountClosingBalanceDiffEntCurrency = accountClosingBalanceEntCurrency - accountClosingBalancePreviousYear;

                                        //Accumulate
                                        headerSumAccountClosingBalanceDiff += accountClosingBalanceDiff;
                                        headerSumAccountClosingBalanceDiffEntCurrency += accountClosingBalanceDiffEntCurrency;
                                        if (!reportHeader.DoNotSummarizeOnGroup)
                                        {
                                            groupSumAccountClosingBalanceDiff += accountClosingBalanceDiff;
                                            groupSumAccountClosingBalanceDiffEntCurrency += accountClosingBalanceDiffEntCurrency;
                                        }

                                        #endregion


                                        #endregion
                                    }
                                    else if (es.ReportTemplateType == SoeReportTemplateType.ResultReport)
                                    {
                                        #region ResultReport

                                        #region Calculate AccountBalanceChangeAllPreviousToPeriod

                                        if (biAccountBalanceChangeAllPreviousToPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousToPeriod = biAccountBalanceChangeAllPreviousToPeriodDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                            headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousToPeriodBalance += biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                                groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate AccountBalanceChangeAllPreviousToPreviousYearPeriod

                                        if (biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousToPreviousYearPeriod = biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                            headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                                groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency += biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate AccountBalanceChangeAllPreviousThisYear

                                        if (biAccountBalanceChangeAllPreviousThisYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousThisYear = biAccountBalanceChangeAllPreviousThisYearDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                            headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousThisYearBalance += biAccountBalanceChangeAllPreviousThisYear.Balance;
                                                groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #region Calculate AccountBalanceChangeAllPreviousPreviousYear

                                        if (biAccountBalanceChangeAllPreviousPreviousYearDict.ContainsKey(accountStd.AccountId) && !onlyGrossCodesInInterval)
                                        {
                                            biAccountBalanceChangeAllPreviousPreviousYear = biAccountBalanceChangeAllPreviousPreviousYearDict[accountStd.AccountId];

                                            //Accumulate
                                            headerSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                            headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                            if (!reportHeader.DoNotSummarizeOnGroup)
                                            {
                                                groupSumAccountBalanceChangeAllPreviousPreviousYearBalance += biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                                groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency += biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;
                                            }
                                        }

                                        #endregion

                                        #endregion
                                    }

                                    #endregion

                                    #region XElement Account

                                    XElement accountElement = null;

                                    #region Init

                                    bool isInactive = accountStd.State == SoeEntityState.Inactive;
                                    decimal period = invertRow ? Decimal.Negate(biBalancechangePeriod.Balance) : biBalancechangePeriod.Balance;
                                    decimal periodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePeriod.BalanceEntCurrency) : biBalancechangePeriod.BalanceEntCurrency;
                                    decimal grossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriod) : accountGrossProfitPeriod;
                                    decimal grossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrency) : accountGrossProfitPeriodEntCurrency;
                                    decimal toPeriod = invertRow ? Decimal.Negate(biBalancechangeToPeriod.Balance) : biBalancechangeToPeriod.Balance;
                                    decimal toPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPeriod.BalanceEntCurrency) : biBalancechangeToPeriod.BalanceEntCurrency;
                                    decimal includingPeriod = invertRow ? Decimal.Negate(biBalancechangeIncludingPeriod.Balance) : biBalancechangeIncludingPeriod.Balance;
                                    decimal includingPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeIncludingPeriod.BalanceEntCurrency) : biBalancechangeIncludingPeriod.BalanceEntCurrency;
                                    decimal year = invertRow ? Decimal.Negate(biBalancechangeYear.Balance) : biBalancechangeYear.Balance;
                                    decimal yearEntCurrency = invertRow ? Decimal.Negate(biBalancechangeYear.BalanceEntCurrency) : biBalancechangeYear.BalanceEntCurrency;
                                    decimal grossProfitYear = invertRow ? Decimal.Negate(accountGrossProfitYear) : accountGrossProfitYear;
                                    decimal grossProfitEntCurrencyYear = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrency) : accountGrossProfitYearEntCurrency;
                                    decimal periodDiff = invertRow ? Decimal.Negate(accountBalancechangePeriodDiff) : accountBalancechangePeriodDiff;
                                    decimal periodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangePeriodDiffEntCurrency) : accountBalancechangePeriodDiffEntCurrency;
                                    decimal toPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeToPeriodDiff) : accountBalancechangeToPeriodDiff;
                                    decimal toPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeToPeriodDiffEntCurrency) : accountBalancechangeToPeriodDiffEntCurrency;
                                    decimal includingPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeIncludingPeriodDiff) : accountBalancechangeIncludingPeriodDiff;
                                    decimal includingPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeIncludingPeriodDiffEntCurrency) : accountBalancechangeIncludingPeriodDiffEntCurrency;
                                    //Previous Year
                                    decimal previousYearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.Balance) : biBalancechangePreviousYearPeriod.Balance;
                                    decimal previousYearPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYearPeriod.BalanceEntCurrency) : biBalancechangePreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYearGrossProfitPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriod) : accountGrossProfitPreviousYearPeriod;
                                    decimal previousYearGrossProfitEntCurrencyPeriod = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrency) : accountGrossProfitPreviousYearPeriodEntCurrency;
                                    decimal previousYearToPeriod = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.Balance) : biBalancechangeToPreviousYearPeriod.Balance;
                                    decimal previousYearToPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeToPreviousYearPeriod.BalanceEntCurrency) : biBalancechangeToPreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYearIncludingPeriod = invertRow ? Decimal.Negate(biBalancechangeIncludingPreviousYearPeriod.Balance) : biBalancechangeIncludingPreviousYearPeriod.Balance;
                                    decimal previousYearIncludingPeriodEntCurrency = invertRow ? Decimal.Negate(biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency) : biBalancechangeIncludingPreviousYearPeriod.BalanceEntCurrency;
                                    decimal previousYear = invertRow ? Decimal.Negate(biBalancechangePreviousYear.Balance) : biBalancechangePreviousYear.Balance;
                                    decimal previousYearEntCurrency = invertRow ? Decimal.Negate(biBalancechangePreviousYear.BalanceEntCurrency) : biBalancechangePreviousYear.BalanceEntCurrency;
                                    decimal previousYearGrossProfit = invertRow ? Decimal.Negate(accountGrossProfitPreviousYear) : accountGrossProfitPreviousYear;
                                    decimal previousYearGrossProfitEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearEntCurrency) : accountGrossProfitPreviousYearEntCurrency;
                                    decimal previousYearperiodDiff = invertRow ? Decimal.Negate(accountBalancechangePreviousYearPeriodDiff) : accountBalancechangePreviousYearPeriodDiff;
                                    decimal previousYearperiodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangePreviousYearPeriodDiffEntCurrency) : accountBalancechangePreviousYearPeriodDiffEntCurrency;
                                    decimal previousYearToPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeToPreviousYearPeriodDiff) : accountBalancechangeToPreviousYearPeriodDiff;
                                    decimal previousYearToPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeToPreviousYearPeriodDiffEntCurrency) : accountBalancechangeToPreviousYearPeriodDiffEntCurrency;
                                    decimal previousYearIncludingPeriodDiff = invertRow ? Decimal.Negate(accountBalancechangeIncludingPreviousYearPeriodDiff) : accountBalancechangeIncludingPreviousYearPeriodDiff;
                                    decimal previousYearIncludingPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency) : accountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency;
                                    //Previous Period
                                    decimal previousPeriodMinus1YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus1YearPeriod.Balance) : biBalancechangePreviousPeriodMinus1YearPeriod.Balance;
                                    decimal previousPeriodMinus2YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus2YearPeriod.Balance) : biBalancechangePreviousPeriodMinus2YearPeriod.Balance;
                                    decimal previousPeriodMinus3YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus3YearPeriod.Balance) : biBalancechangePreviousPeriodMinus3YearPeriod.Balance;
                                    decimal previousPeriodMinus4YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus4YearPeriod.Balance) : biBalancechangePreviousPeriodMinus4YearPeriod.Balance;
                                    decimal previousPeriodMinus5YearPeriod = invertRow ? Decimal.Negate(biBalancechangePreviousPeriodMinus5YearPeriod.Balance) : biBalancechangePreviousPeriodMinus5YearPeriod.Balance;

                                    //Budget
                                    decimal budgetPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.Balance) : biBudgetBalancechangePeriod.Balance;
                                    decimal budgetPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangePeriod.BalanceEntCurrency) : biBudgetBalancechangePeriod.BalanceEntCurrency;
                                    decimal budgetToPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.Balance) : biBudgetBalancechangeToPeriod.Balance;
                                    decimal budgetToPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeToPeriod.BalanceEntCurrency) : biBudgetBalancechangeToPeriod.BalanceEntCurrency;
                                    decimal budgetIncludingPeriod = invertRow ? Decimal.Negate(biBudgetBalancechangeIncludingPeriod.Balance) : biBudgetBalancechangeIncludingPeriod.Balance;
                                    decimal budgetIncludingPeriodEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency) : biBudgetBalancechangeIncludingPeriod.BalanceEntCurrency;
                                    decimal budgetYear = invertRow ? Decimal.Negate(biBudgetBalancechangeYear.Balance) : biBudgetBalancechangeYear.Balance;
                                    decimal budgetYearEntCurrency = invertRow ? Decimal.Negate(biBudgetBalancechangeYear.BalanceEntCurrency) : biBudgetBalancechangeYear.BalanceEntCurrency;
                                    decimal budgetPeriodDiff = invertRow ? Decimal.Negate(accountBudgetBalancechangePeriodDiff) : accountBudgetBalancechangePeriodDiff;
                                    decimal budgetPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBudgetBalancechangePeriodDiffEntCurrency) : accountBudgetBalancechangePeriodDiffEntCurrency;
                                    decimal budgetToPeriodDiff = invertRow ? Decimal.Negate(accountBudgetBalancechangeToPeriodDiff) : accountBudgetBalancechangeToPeriodDiff;
                                    decimal budgetToPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBudgetBalancechangeToPeriodDiffEntCurrency) : accountBudgetBalancechangeToPeriodDiffEntCurrency;
                                    decimal budgetIncludingPeriodDiff = invertRow ? Decimal.Negate(accountBudgetBalancechangeIncludingPeriodDiff) : accountBudgetBalancechangeIncludingPeriodDiff;
                                    decimal budgetIncludingPeriodDiffEntCurrency = invertRow ? Decimal.Negate(accountBudgetBalancechangeIncludingPeriodDiffEntCurrency) : accountBudgetBalancechangeIncludingPeriodDiffEntCurrency;

                                    //Do not include inactive accounts that has no balance
                                    //if (es.ReportTemplateType == SoeReportTemplateType.ResultReport || es.ReportTemplateType == SoeReportTemplateType.SruReport)
                                    //{
                                    //    if (isInactive && NumberUtility.IsAllZero(period, toPeriod, includingPeriod, year, periodDiff, toPeriodDiff, includingPeriodDiff, previousPeriodMinus1YearPeriod, previousPeriodMinus2YearPeriod, previousPeriodMinus3YearPeriod, previousPeriodMinus4YearPeriod, previousPeriodMinus5YearPeriod))
                                    //        continue;
                                    //}
                                    #endregion

                                    #region Add elements

                                    accountElement = new XElement("Account",
                                        new XAttribute("id", accountXmlId),
                                        new XElement("AccountNr", accountStd.AccountNr),
                                        new XElement("AccountName", accountStd.Name),
                                        new XElement("AccountInternalNr1", String.Empty), //TODO
                                        new XElement("AccountInternalName1", String.Empty), //TODO
                                        new XElement("AccountInternalNr2", String.Empty), //TODO
                                        new XElement("AccountInternalName2", String.Empty), //TODO
                                        new XElement("AccountInternalNr3", String.Empty), //TODO
                                        new XElement("AccountInternalName3", String.Empty), //TODO
                                        new XElement("AccountInternalNr4", String.Empty), //TODO
                                        new XElement("AccountInternalName4", String.Empty), //TODO
                                        new XElement("AccountInternalNr5", String.Empty), //TODO
                                        new XElement("AccountInternalName5", String.Empty), //TODO
                                        new XElement("AccountInternalNr6", String.Empty), //TODO
                                        new XElement("AccountInternalName6", String.Empty), //TODO
                                        new XElement("AccountBalancechangePeriod", period),
                                        new XElement("AccountBalancechangePeriodEntCurrency", periodEntCurrency),
                                        new XElement("AccountGrossProfitPeriod", grossProfitPeriod),
                                        new XElement("AccountGrossProfitPeriodEntCurrency", grossProfitEntCurrencyPeriod),
                                        new XElement("AccountBalancechangeToPeriod", toPeriod),
                                        new XElement("AccountBalancechangeToPeriodEntCurrency", toPeriodEntCurrency),
                                        new XElement("AccountBalancechangeIncludingPeriod", includingPeriod),
                                        new XElement("AccountBalancechangeIncludingPeriodEntCurrency", includingPeriodEntCurrency),
                                        new XElement("AccountBalancechangeYear", year),
                                        new XElement("AccountBalancechangeYearEntCurrency", yearEntCurrency),
                                        new XElement("AccountGrossProfitYear", grossProfitYear),
                                        new XElement("AccountGrossProfitYearEntCurrency", grossProfitEntCurrencyYear),
                                        new XElement("AccountBalancechangePeriodDiff", periodDiff),
                                        new XElement("AccountBalancechangePeriodDiffEntCurrency", periodDiffEntCurrency),
                                        new XElement("AccountBalancechangeToPeriodDiff", toPeriodDiff),
                                        new XElement("AccountBalancechangeToPeriodDiffEntCurrency", toPeriodDiffEntCurrency),
                                        new XElement("AccountBalancechangeIncludingPeriodDiff", includingPeriodDiff),
                                        new XElement("AccountBalancechangeIncludingPeriodDiffEntCurrency", includingPeriodDiffEntCurrency),
                                        //Previous Year
                                        new XElement("PreviousYearAccountBalancechangePeriod", previousYearPeriod),
                                        new XElement("PreviousYearAccountBalancechangePeriodEntCurrency", previousYearPeriodEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitPeriod", previousYearGrossProfitPeriod),
                                        new XElement("PreviousYearAccountGrossProfitPeriodEntCurrency", previousYearGrossProfitEntCurrencyPeriod),
                                        new XElement("PreviousYearAccountBalancechangeToPeriod", previousYearToPeriod),
                                        new XElement("PreviousYearAccountBalancechangeToPeriodEntCurrency", previousYearToPeriodEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriod", previousYearIncludingPeriod),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriodEntCurrency", previousYearIncludingPeriodEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeYear", previousYear),
                                        new XElement("PreviousYearAccountBalancechangeYearEntCurrency", previousYearEntCurrency),
                                        new XElement("PreviousYearAccountGrossProfitYear", previousYearGrossProfit),
                                        new XElement("PreviousYearAccountGrossProfitYearEntCurrency", previousYearGrossProfitEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangePeriodDiff", previousYearperiodDiff),
                                        new XElement("PreviousYearAccountBalancechangePeriodDiffEntCurrency", previousYearperiodDiffEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeToPeriodDiff", previousYearToPeriodDiff),
                                        new XElement("PreviousYearAccountBalancechangeToPeriodDiffEntCurrency", previousYearToPeriodDiffEntCurrency),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriodDiff", previousYearIncludingPeriodDiff),
                                        new XElement("PreviousYearAccountBalancechangeIncludingPeriodDiffEntCurrency", previousYearIncludingPeriodDiffEntCurrency),
                                        //previous Period
                                        new XElement("PreviousPeriodMinus1YearAccountBalancechangePeriod", previousPeriodMinus1YearPeriod),
                                        new XElement("PreviousPeriodMinus2YearAccountBalancechangePeriod", previousPeriodMinus2YearPeriod),
                                        new XElement("PreviousPeriodMinus3YearAccountBalancechangePeriod", previousPeriodMinus3YearPeriod),
                                        new XElement("PreviousPeriodMinus4YearAccountBalancechangePeriod", previousPeriodMinus4YearPeriod),
                                        new XElement("PreviousPeriodMinus5YearAccountBalancechangePeriod", previousPeriodMinus5YearPeriod),

                                        //Budget
                                        new XElement("BudgetAccountBalancechangePeriod", budgetPeriod),
                                        new XElement("BudgetAccountBalancechangePeriodEntCurrency", budgetPeriodEntCurrency),
                                        new XElement("BudgetAccountBalancechangeToPeriod", budgetToPeriod),
                                        new XElement("BudgetAccountBalancechangeToPeriodEntCurrency", budgetToPeriodEntCurrency),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriod", budgetIncludingPeriod),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriodEntCurrency", budgetIncludingPeriodEntCurrency),
                                        new XElement("BudgetAccountBalancechangeYear", budgetYear),
                                        new XElement("BudgetAccountBalancechangeYearEntCurrency", budgetYearEntCurrency),
                                        new XElement("BudgetAccountGrossProfitPeriod", accountBudgetGrossProfitPeriod),
                                        new XElement("BudgetAccountBalancechangePeriodDiff", budgetPeriodDiff),
                                        new XElement("BudgetAccountBalancechangePeriodDiffEntCurrency", budgetPeriodDiffEntCurrency),
                                        new XElement("BudgetAccountBalancechangeToPeriodDiff", budgetToPeriodDiff),
                                        new XElement("BudgetAccountBalancechangeToPeriodDiffEntCurrency", budgetToPeriodDiffEntCurrency),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriodDiff", budgetIncludingPeriodDiff),
                                        new XElement("BudgetAccountBalancechangeIncludingPeriodDiffEntCurrency", budgetIncludingPeriodDiffEntCurrency));


                                    #endregion

                                    if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                    {
                                        #region BalanceReport

                                        #region Init

                                        decimal periodInBalance = invertRow ? Decimal.Negate(biPeriodInBalance.Balance) : biPeriodInBalance.Balance;
                                        decimal periodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPeriodInBalance.BalanceEntCurrency) : biPeriodInBalance.BalanceEntCurrency;
                                        decimal grossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPeriodInBalance) : accountGrossProfitPeriodInBalance;
                                        decimal grossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPeriodEntCurrencyInBalance) : accountGrossProfitPeriodEntCurrencyInBalance;
                                        decimal periodOpeningBalance = invertRow ? Decimal.Negate(biYearInBalance.Balance) : biYearInBalance.Balance;
                                        decimal periodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biYearInBalance.BalanceEntCurrency) : biYearInBalance.BalanceEntCurrency;
                                        decimal grossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitYearOpeningBalance) : accountGrossProfitYearOpeningBalance;
                                        decimal grossProfitPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitYearEntCurrencyOpeningBalance) : accountGrossProfitYearEntCurrencyOpeningBalance;
                                        decimal periodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalance) : accountClosingBalance;
                                        decimal periodClosingBalanceEntCurrency = invertRow ? Decimal.Negate(accountClosingBalanceEntCurrency) : accountClosingBalanceEntCurrency;
                                        decimal periodInBalanceDiff = invertRow ? Decimal.Negate(accountPeriodInBalanceDiff) : accountPeriodInBalanceDiff;
                                        decimal periodInBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountPeriodInBalanceDiffEntCurrency) : accountPeriodInBalanceDiffEntCurrency;
                                        decimal periodOpeningBalanceDiff = invertRow ? Decimal.Negate(accountOpeningBalanceDiff) : accountOpeningBalanceDiff;
                                        decimal periodOpeningBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountOpeningBalanceDiffEntCurrency) : accountOpeningBalanceDiffEntCurrency;
                                        decimal periodClosingBalanceDiff = invertRow ? Decimal.Negate(accountClosingBalanceDiff) : accountClosingBalanceDiff;
                                        decimal periodClosingBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountClosingBalanceDiffEntCurrency) : accountClosingBalanceDiffEntCurrency;

                                        //PreviousYear
                                        decimal previousYearPeriodInBalance = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.Balance) : biPreviousYearPeriodInBalance.Balance;
                                        decimal previousYearPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearPeriodInBalance.BalanceEntCurrency) : biPreviousYearPeriodInBalance.BalanceEntCurrency;
                                        decimal previousYearGrossProfitPeriodInBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodInBalance) : accountGrossProfitPreviousYearPeriodInBalance;
                                        decimal previousYearGrossProfitPeriodInBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearPeriodEntCurrencyInBalance) : accountGrossProfitPreviousYearPeriodEntCurrencyInBalance;
                                        decimal previousYearPeriodOpeningBalance = invertRow ? Decimal.Negate(biPreviousYearInBalance.Balance) : biPreviousYearInBalance.Balance;
                                        decimal previousYearPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(biPreviousYearInBalance.BalanceEntCurrency) : biPreviousYearInBalance.BalanceEntCurrency;
                                        decimal previousYearGrossProfitPeriodOpeningBalance = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearOpeningBalance) : accountGrossProfitPreviousYearOpeningBalance;
                                        decimal previousYearGrossProfitPeriodOpeningBalanceEntCurrency = invertRow ? Decimal.Negate(accountGrossProfitPreviousYearEntCurrencyOpeningBalance) : accountGrossProfitPreviousYearEntCurrencyOpeningBalance;
                                        decimal previousYearPeriodClosingBalance = invertRow ? Decimal.Negate(accountClosingBalancePreviousYear) : accountClosingBalancePreviousYear;
                                        decimal previousYearPeriodClosingBalanceEntCurrency = invertRow ? Decimal.Negate(accountClosingBalancePreviousYearEntCurrency) : accountClosingBalancePreviousYearEntCurrency;
                                        decimal previousYearPeriodInBalanceDiff = invertRow ? Decimal.Negate(accountPreviousYearPeriodInBalanceDiff) : accountPreviousYearPeriodInBalanceDiff;
                                        decimal previousYearPeriodInBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountPreviousYearPeriodInBalanceDiffEntCurrency) : accountPreviousYearPeriodInBalanceDiffEntCurrency;
                                        decimal previousYearPeriodOpeningBalanceDiff = invertRow ? Decimal.Negate(accountOpeningBalanceDiffPreviousYear) : accountOpeningBalanceDiffPreviousYear;
                                        decimal previousYearPeriodOpeningBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountOpeningBalanceDiffPreviousYearEntCurrency) : accountOpeningBalanceDiffPreviousYearEntCurrency;
                                        decimal previousYearPeriodClosingBalanceDiff = invertRow ? Decimal.Negate(accountClosingBalanceDiffPreviousYear) : accountClosingBalanceDiffPreviousYear;
                                        decimal previousYearPeriodClosingBalanceDiffEntCurrency = invertRow ? Decimal.Negate(accountClosingBalanceDiffPreviousYearEntCurrency) : accountClosingBalanceDiffPreviousYearEntCurrency;

                                        //Do not include inactive accounts that has no balance
                                        //if (isInactive && NumberUtility.IsAllZero(periodInBalance, periodOpeningBalance, periodClosingBalance, periodInBalanceDiff, periodOpeningBalanceDiff, periodClosingBalanceDiff))
                                        //    continue;

                                        #endregion

                                        #region Add elements

                                        accountElement.Add(
                                            new XElement("AccountPeriodInBalance", periodInBalance),
                                            new XElement("AccountPeriodInBalanceEntCurrency", periodInBalanceEntCurrency),
                                            new XElement("AccountGrossProfitPeriodInBalance", grossProfitPeriodInBalance),
                                            new XElement("AccountGrossProfitPeriodInBalanceEntCurrency", grossProfitPeriodInBalanceEntCurrency),
                                            new XElement("AccountOpeningBalance", periodOpeningBalance),
                                            new XElement("AccountOpeningBalanceEntCurrency", periodOpeningBalanceEntCurrency),
                                            new XElement("AccountGrossProfitOpeningBalance", grossProfitPeriodOpeningBalance),
                                            new XElement("AccountGrossProfitOpeningBalanceEntCurrency", grossProfitPeriodOpeningBalanceEntCurrency),
                                            new XElement("AccountClosingBalance", periodClosingBalance),
                                            new XElement("AccountClosingBalanceEntCurrency", periodClosingBalanceEntCurrency),
                                            new XElement("AccountPeriodInBalanceDiff", periodInBalanceDiff),
                                            new XElement("AccountPeriodInBalanceDiffEntCurrency", periodInBalanceDiffEntCurrency),
                                            new XElement("AccountOpeningBalanceDiff", periodOpeningBalanceDiff),
                                            new XElement("AccountOpeningBalanceDiffEntCurrency", periodOpeningBalanceDiffEntCurrency),
                                            new XElement("AccountClosingBalanceDiff", periodClosingBalanceDiff),
                                            new XElement("AccountClosingBalanceDiffEntCurrency", periodClosingBalanceDiffEntCurrency),
                                            //Previous Year
                                            new XElement("PreviousYearAccountPeriodInBalance", previousYearPeriodInBalance),
                                            new XElement("PreviousYearAccountPeriodInBalanceEntCurrency", previousYearPeriodInBalanceEntCurrency),
                                            new XElement("PreviousYearAccountGrossProfitPeriodInBalance", previousYearGrossProfitPeriodInBalance),
                                            new XElement("PreviousYearAccountGrossProfitPeriodInBalanceEntCurrency", previousYearGrossProfitPeriodInBalanceEntCurrency),
                                            new XElement("PreviousYearAccountOpeningBalance", previousYearPeriodOpeningBalance),
                                            new XElement("PreviousYearAccountOpeningBalanceEntCurrency", previousYearPeriodOpeningBalanceEntCurrency),
                                            new XElement("PreviousYearAccountGrossProfitOpeningBalance", previousYearGrossProfitPeriodOpeningBalance),
                                            new XElement("PreviousYearAccountGrossProfitOpeningBalanceEntCurrency", previousYearGrossProfitPeriodOpeningBalanceEntCurrency),
                                            new XElement("PreviousYearAccountClosingBalance", previousYearPeriodClosingBalance),
                                            new XElement("PreviousYearAccountClosingBalanceEntCurrency", previousYearPeriodClosingBalanceEntCurrency),
                                            new XElement("PreviousYearAccountPeriodInBalanceDiff", previousYearPeriodInBalanceDiff),
                                            new XElement("PreviousYearAccountPeriodInBalanceDiffEntCurrency", previousYearPeriodInBalanceDiffEntCurrency),
                                            new XElement("PreviousYearAccountOpeningBalanceDiff", previousYearPeriodOpeningBalanceDiff),
                                            new XElement("PreviousYearAccountOpeningBalanceDiffEntCurrency", previousYearPeriodOpeningBalanceDiffEntCurrency),
                                            new XElement("PreviousYearAccountClosingBalanceDiff", previousYearPeriodClosingBalanceDiff),
                                            new XElement("PreviousYearAccountClosingBalanceDiffEntCurrency", previousYearPeriodClosingBalanceDiffEntCurrency));

                                        #endregion

                                        #endregion
                                    }
                                    else if (es.ReportTemplateType == SoeReportTemplateType.ResultReport)
                                    {
                                        #region ResultReport

                                        #region Init

                                        decimal accountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.Balance) : biAccountBalanceChangeAllPreviousToPeriod.Balance;
                                        decimal accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPeriod.BalanceEntCurrency;
                                        decimal accountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.Balance) : biAccountBalanceChangeAllPreviousThisYear.Balance;
                                        decimal accountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousThisYear.BalanceEntCurrency;
                                        //Previous Year
                                        decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.Balance;
                                        decimal previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousToPreviousYearPeriod.BalanceEntCurrency;
                                        decimal previousYearAccountBalanceChangeAllPreviousThisYearBalance = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.Balance) : biAccountBalanceChangeAllPreviousPreviousYear.Balance;
                                        decimal previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency = invertRow ? Decimal.Negate(biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency) : biAccountBalanceChangeAllPreviousPreviousYear.BalanceEntCurrency;

                                        //Do not include inactive accounts that has no balance
                                        //if (isInactive && es.IncludeAllHistoricalData && NumberUtility.IsAllZero(accountBalanceChangeAllPreviousToPeriodBalance, accountBalanceChangeAllPreviousThisYearBalance))
                                        //    continue;

                                        #endregion

                                        #region Add elements

                                        accountElement.Add(
                                            new XElement("AccountBalanceChangeAllPreviousToPeriodBalance", accountBalanceChangeAllPreviousToPeriodBalance),
                                            new XElement("AccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", accountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                            new XElement("AccountBalanceChangeAllPreviousThisYearBalance", accountBalanceChangeAllPreviousThisYearBalance),
                                            new XElement("AccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", accountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                            //Previous Year
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalance", previousYearAccountBalanceChangeAllPreviousToPeriodBalance),
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalance", previousYearAccountBalanceChangeAllPreviousThisYearBalance),
                                            new XElement("PreviousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", previousYearAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency));

                                        #endregion

                                        #endregion
                                    }

                                    #region VoucherSummery

                                    if (accountQuantity != 0 || accountPeriod1 != 0 || accountPeriod2 != 0 || accountPeriod3 != 0 || accountPeriod4 != 0 || accountPeriod5 != 0 || accountPeriod5 != 0 || accountPeriod6 != 0 || accountPeriod7 != 0 || accountPeriod8 != 0 || accountPeriod9 != 0 || accountPeriod10 != 0 || accountPeriod11 != 0 || accountPeriod12 != 0 ||
                                        budgetAccountPeriod1 != 0 || budgetAccountPeriod2 != 0 || budgetAccountPeriod3 != 0 || budgetAccountPeriod4 != 0 || budgetAccountPeriod5 != 0 || budgetAccountPeriod6 != 0 || budgetAccountPeriod7 != 0 || budgetAccountPeriod8 != 0 || budgetAccountPeriod9 != 0 || budgetAccountPeriod10 != 0 || budgetAccountPeriod11 != 0 || budgetAccountPeriod12 != 0 ||
                                        previousYearAccountPeriod1 != 0)
                                    {
                                        voucherSummeryElement = new XElement("VoucherSummery",
                                            new XAttribute("id", voucherSummeryXmlId),
                                            new XElement("VoucherSummeryAccountNr", accountStd.AccountNr),
                                            new XElement("VoucherSummeryAccountName", accountStd.Name),
                                            new XElement("VoucherSummeryAccountQuantity", accountQuantity),
                                            new XElement("VoucherSummeryYear0", invertRow ? Decimal.Negate(accountYear0) : accountYear0),
                                            new XElement("VoucherSummeryYearMinus1", invertRow ? Decimal.Negate(accountYearMinus1) : accountYearMinus1),
                                            new XElement("VoucherSummeryYearMinus2", invertRow ? Decimal.Negate(accountYearMinus2) : accountYearMinus2),
                                            new XElement("VoucherSummeryYearMinus3", invertRow ? Decimal.Negate(accountYearMinus3) : accountYearMinus3),
                                            new XElement("VoucherSummeryYearMinus4", invertRow ? Decimal.Negate(accountYearMinus4) : accountYearMinus4),
                                            new XElement("VoucherSummeryAccountPeriod1", invertRow ? Decimal.Negate(accountPeriod1) : accountPeriod1),
                                            new XElement("VoucherSummeryAccountPeriod2", invertRow ? Decimal.Negate(accountPeriod2) : accountPeriod2),
                                            new XElement("VoucherSummeryAccountPeriod3", invertRow ? Decimal.Negate(accountPeriod3) : accountPeriod3),
                                            new XElement("VoucherSummeryAccountPeriod4", invertRow ? Decimal.Negate(accountPeriod4) : accountPeriod4),
                                            new XElement("VoucherSummeryAccountPeriod5", invertRow ? Decimal.Negate(accountPeriod5) : accountPeriod5),
                                            new XElement("VoucherSummeryAccountPeriod6", invertRow ? Decimal.Negate(accountPeriod6) : accountPeriod6),
                                            new XElement("VoucherSummeryAccountPeriod7", invertRow ? Decimal.Negate(accountPeriod7) : accountPeriod7),
                                            new XElement("VoucherSummeryAccountPeriod8", invertRow ? Decimal.Negate(accountPeriod8) : accountPeriod8),
                                            new XElement("VoucherSummeryAccountPeriod9", invertRow ? Decimal.Negate(accountPeriod9) : accountPeriod9),
                                            new XElement("VoucherSummeryAccountPeriod10", invertRow ? Decimal.Negate(accountPeriod10) : accountPeriod10),
                                            new XElement("VoucherSummeryAccountPeriod11", invertRow ? Decimal.Negate(accountPeriod11) : accountPeriod11),
                                            new XElement("VoucherSummeryAccountPeriod12", invertRow ? Decimal.Negate(accountPeriod12) : accountPeriod12),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod1", invertRow ? Decimal.Negate(previousYearAccountPeriod1) : previousYearAccountPeriod1),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod2", invertRow ? Decimal.Negate(previousYearAccountPeriod2) : previousYearAccountPeriod2),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod3", invertRow ? Decimal.Negate(previousYearAccountPeriod3) : previousYearAccountPeriod3),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod4", invertRow ? Decimal.Negate(previousYearAccountPeriod4) : previousYearAccountPeriod4),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod5", invertRow ? Decimal.Negate(previousYearAccountPeriod5) : previousYearAccountPeriod5),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod6", invertRow ? Decimal.Negate(previousYearAccountPeriod6) : previousYearAccountPeriod6),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod7", invertRow ? Decimal.Negate(previousYearAccountPeriod7) : previousYearAccountPeriod7),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod8", invertRow ? Decimal.Negate(previousYearAccountPeriod8) : previousYearAccountPeriod8),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod9", invertRow ? Decimal.Negate(previousYearAccountPeriod9) : previousYearAccountPeriod9),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod10", invertRow ? Decimal.Negate(previousYearAccountPeriod10) : previousYearAccountPeriod10),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod11", invertRow ? Decimal.Negate(previousYearAccountPeriod11) : previousYearAccountPeriod11),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod12", invertRow ? Decimal.Negate(previousYearAccountPeriod12) : previousYearAccountPeriod12),
                                            new XElement("VoucherSummeryPreviousPeriodMinus1Year", invertRow ? Decimal.Negate(previousPeriodMinus1YearAccountPeriod) : previousPeriodMinus1YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus2Year", invertRow ? Decimal.Negate(previousPeriodMinus2YearAccountPeriod) : previousPeriodMinus2YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus3Year", invertRow ? Decimal.Negate(previousPeriodMinus3YearAccountPeriod) : previousPeriodMinus3YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus4Year", invertRow ? Decimal.Negate(previousPeriodMinus4YearAccountPeriod) : previousPeriodMinus4YearAccountPeriod),
                                            new XElement("VoucherSummeryPreviousPeriodMinus5Year", invertRow ? Decimal.Negate(previousPeriodMinus5YearAccountPeriod) : previousPeriodMinus5YearAccountPeriod),
                                            new XElement("VoucherSummeryBudgetAccountPeriod1", invertRow ? Decimal.Negate(budgetAccountPeriod1) : budgetAccountPeriod1),
                                            new XElement("VoucherSummeryBudgetAccountPeriod2", invertRow ? Decimal.Negate(budgetAccountPeriod2) : budgetAccountPeriod2),
                                            new XElement("VoucherSummeryBudgetAccountPeriod3", invertRow ? Decimal.Negate(budgetAccountPeriod3) : budgetAccountPeriod3),
                                            new XElement("VoucherSummeryBudgetAccountPeriod4", invertRow ? Decimal.Negate(budgetAccountPeriod4) : budgetAccountPeriod4),
                                            new XElement("VoucherSummeryBudgetAccountPeriod5", invertRow ? Decimal.Negate(budgetAccountPeriod5) : budgetAccountPeriod5),
                                            new XElement("VoucherSummeryBudgetAccountPeriod6", invertRow ? Decimal.Negate(budgetAccountPeriod6) : budgetAccountPeriod6),
                                            new XElement("VoucherSummeryBudgetAccountPeriod7", invertRow ? Decimal.Negate(budgetAccountPeriod7) : budgetAccountPeriod7),
                                            new XElement("VoucherSummeryBudgetAccountPeriod8", invertRow ? Decimal.Negate(budgetAccountPeriod8) : budgetAccountPeriod8),
                                            new XElement("VoucherSummeryBudgetAccountPeriod9", invertRow ? Decimal.Negate(budgetAccountPeriod9) : budgetAccountPeriod9),
                                            new XElement("VoucherSummeryBudgetAccountPeriod10", invertRow ? Decimal.Negate(budgetAccountPeriod10) : budgetAccountPeriod10),
                                            new XElement("VoucherSummeryBudgetAccountPeriod11", invertRow ? Decimal.Negate(budgetAccountPeriod11) : budgetAccountPeriod11),
                                            new XElement("VoucherSummeryBudgetAccountPeriod12", invertRow ? Decimal.Negate(budgetAccountPeriod12) : budgetAccountPeriod12));

                                        voucherSummeryXmlId += 1;
                                        if (!voucherRowElements.Any())
                                        {
                                            XElement voucherRowElement = new XElement("VoucherRow",
                                            new XAttribute("id", 1),
                                            new XElement("AccountInternalNr1"));
                                            voucherRowElements.Add(voucherRowElement);
                                        }
                                        voucherSummeryElement.Add(voucherRowElements);
                                        accountElement.Add(voucherSummeryElement);
                                    }

                                    if (!voucherRowElements.Any() || voucherSummeryXmlId == 0)
                                    {
                                        voucherSummeryElement = new XElement("VoucherSummery",
                                            new XAttribute("id", voucherSummeryXmlId),
                                            new XElement("VoucherSummeryAccountNr", "Empty"),
                                            new XElement("VoucherSummeryAccountName", "Empty Element ONLY available with detailed information"),
                                            new XElement("VoucherSummeryAccountQuantity", 0),
                                            new XElement("VoucherSummeryYear0", 0),
                                            new XElement("VoucherSummeryYearMinus1", 0),
                                            new XElement("VoucherSummeryYearMinus2", 0),
                                            new XElement("VoucherSummeryYearMinus3", 0),
                                            new XElement("VoucherSummeryYearMinus4", 0),
                                            new XElement("VoucherSummeryAccountPeriod1", 0),
                                            new XElement("VoucherSummeryAccountPeriod2", 0),
                                            new XElement("VoucherSummeryAccountPeriod3", 0),
                                            new XElement("VoucherSummeryAccountPeriod4", 0),
                                            new XElement("VoucherSummeryAccountPeriod5", 0),
                                            new XElement("VoucherSummeryAccountPeriod6", 0),
                                            new XElement("VoucherSummeryAccountPeriod7", 0),
                                            new XElement("VoucherSummeryAccountPeriod8", 0),
                                            new XElement("VoucherSummeryAccountPeriod9", 0),
                                            new XElement("VoucherSummeryAccountPeriod10", 0),
                                            new XElement("VoucherSummeryAccountPeriod11", 0),
                                            new XElement("VoucherSummeryAccountPeriod12", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod1", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod2", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod3", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod4", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod5", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod6", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod7", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod8", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod9", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod10", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod11", 0),
                                            new XElement("VoucherSummeryPreviousYearAccountPeriod12", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus1Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus2Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus3Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus4Year", 0),
                                            new XElement("VoucherSummeryPreviousPeriodMinus5Year", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod1", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod2", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod3", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod4", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod5", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod6", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod7", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod8", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod9", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod10", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod11", 0),
                                            new XElement("VoucherSummeryBudgetAccountPeriod12", 0));

                                        voucherSummeryXmlId += 1;

                                        XElement voucherRowElement = new XElement("VoucherRow",
                                            new XAttribute("id", 1),
                                            new XElement("AccountInternalNr1"));

                                        voucherSummeryElement.Add(voucherRowElement);
                                        accountElement.Add(voucherSummeryElement);
                                    }

                                    #endregion

                                    accountElementsForHeader.Add(accountElement);

                                    #endregion
                                }

                                accountXmlId++;

                                #endregion

                                #endregion
                            }

                            #region XElement ReportHeader

                            #region BalanceReport, ResultReport, SRU

                            XElement headerElement = new XElement("Header");
                            if (es.ReportTemplateType == SoeReportTemplateType.SruReport)
                            {
                                headerElement.Add(
                                new XAttribute("id", reportHeaderXmlId),
                                new XElement("HeaderName", reportHeader.Name),
                                new XElement("HeaderShowLabel", reportHeader.ShowLabel.ToInt()),
                                new XElement("HeaderShowRows", reportHeader.ShowRow.ToInt()),
                                new XElement("HeaderShowZeroRows", reportHeader.ShowZeroRow.ToInt()),
                                new XElement("HeaderShowSum", reportHeader.ShowSum.ToInt()),
                                new XElement("HeaderInvertRow", reportHeader.InvertRow.ToInt()),
                                new XElement("HeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriod) : headerSumAccountBalancechangePeriod),
                                new XElement("HeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodEntCurrency) : headerSumAccountBalancechangePeriodEntCurrency),
                                new XElement("HeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountYearInBalance) : headerSumAccountYearInBalance),
                                new XElement("HeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountYearInBalanceEntCurrency) : headerSumAccountYearInBalanceEntCurrency));
                            }
                            else
                            {
                                headerElement.Add(
                                new XAttribute("id", reportHeaderXmlId),
                                new XElement("HeaderName", reportHeader.Name),
                                new XElement("HeaderShowLabel", reportHeader.ShowLabel.ToInt()),
                                new XElement("HeaderShowRows", reportHeader.ShowRow.ToInt()),
                                new XElement("HeaderShowZeroRows", reportHeader.ShowZeroRow.ToInt()),
                                new XElement("HeaderShowSum", reportHeader.ShowSum.ToInt()),
                                new XElement("HeaderInvertRow", reportHeader.InvertRow.ToInt()),
                                new XElement("HeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriod) : headerSumAccountBalancechangePeriod),
                                new XElement("HeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodEntCurrency) : headerSumAccountBalancechangePeriodEntCurrency),
                                new XElement("HeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriod) : headerSumAccountGrossProfitPeriod),
                                new XElement("HeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodEntCurrency) : headerSumAccountGrossProfitPeriodEntCurrency),
                                new XElement("HeaderSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangeIncludingPeriod) : headerSumAccountGrossProfitBalancechangeIncludingPeriod),
                                new XElement("HeaderSumAccountGrossProfitIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency) : headerSumAccountGrossProfitBalancechangeIncludingPeriodEntCurrency),

                                //Previous Year
                                new XElement("PreviousYearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriod) : headerSumAccountBalancechangePreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountBalancechangePreviousYearPeriodEntCurrency),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriod) : headerSumAccountGrossProfitPreviousYearPeriod),
                                new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                                //Previous Period
                                new XElement("PreviousPeriodMinus1YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus1Year) : headerSumAccountBalancechangePreviousPeriodMinus1Year),
                                new XElement("PreviousPeriodMinus2YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus2Year) : headerSumAccountBalancechangePreviousPeriodMinus2Year),
                                new XElement("PreviousPeriodMinus3YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus3Year) : headerSumAccountBalancechangePreviousPeriodMinus3Year),
                                new XElement("PreviousPeriodMinus4YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus4Year) : headerSumAccountBalancechangePreviousPeriodMinus4Year),
                                new XElement("PreviousPeriodMinus5YearHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousPeriodMinus5Year) : headerSumAccountBalancechangePreviousPeriodMinus5Year),
                                //Budget
                                new XElement("BudgetHeaderSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriod) : headerSumBudgetAccountBalancechangePeriod),
                                new XElement("BudgetHeaderSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodEntCurrency) : headerSumBudgetAccountBalancechangePeriodEntCurrency));
                            }
                            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport || es.ReportTemplateType == SoeReportTemplateType.ResultReport)
                            {
                                #region BalanceReport, ResultReport

                                headerElement.Add(
                                    new XElement("HeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriod) : headerSumAccountBalancechangeToPeriod),
                                    new XElement("HeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodEntCurrency) : headerSumAccountBalancechangeToPeriodEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriod) : headerSumAccountBalancechangeIncludingPeriod),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriodEntCurrency) : headerSumAccountBalancechangeIncludingPeriodEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYear) : headerSumAccountBalancechangeYear),
                                    new XElement("HeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeYearEntCurrency) : headerSumAccountBalancechangeYearEntCurrency),
                                    new XElement("HeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYear) : headerSumAccountGrossProfitYear),
                                    new XElement("HeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearEntCurrency) : headerSumAccountGrossProfitYearEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodDiff) : headerSumAccountBalancechangePeriodDiff),
                                    new XElement("HeaderSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePeriodDiffEntCurrency) : headerSumAccountBalancechangePeriodDiffEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodDiff) : headerSumAccountBalancechangeToPeriodDiff),
                                    new XElement("HeaderSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPeriodDiffEntCurrency) : headerSumAccountBalancechangeToPeriodDiffEntCurrency),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriodDiff) : headerSumAccountBalancechangeIncludingPeriodDiff),
                                    new XElement("HeaderSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency) : headerSumAccountBalancechangeIncludingPeriodDiffEntCurrency),
                                    //PreviousYear
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriod) : headerSumAccountBalancechangeToPreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency) : headerSumAccountBalancechangeToPreviousYearPeriodEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriod) : headerSumAccountBalancechangeIncludingPreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency) : headerSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYear) : headerSumAccountBalancechangePreviousYear),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearEntCurrency) : headerSumAccountBalancechangePreviousYearEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriod) : headerSumAccountGrossProfitBalancechangePreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency) : headerSumAccountGrossProfitBalancechangePreviousYearPeriodEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod) : headerSumAccountGrossProfitBalancechangeIncludingPreviousYearPeriod),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodDiff) : headerSumAccountBalancechangePreviousYearPeriodDiff),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency) : headerSumAccountBalancechangePreviousYearPeriodDiffEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriodDiff) : headerSumAccountBalancechangeToPreviousYearPeriodDiff),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency) : headerSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff) : headerSumAccountBalancechangeIncludingPreviousYearPeriodDiff),
                                    new XElement("PreviousYearHeaderSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency) : headerSumAccountBalancechangeIncludingPreviousYearPeriodDiffEntCurrency),

                                    //Budget
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriod) : headerSumBudgetAccountBalancechangeToPeriod),
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodEntCurrency) : headerSumBudgetAccountBalancechangeToPeriodEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriod) : headerSumBudgetAccountBalancechangeIncludingPeriod),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency) : headerSumBudgetAccountBalancechangeIncludingPeriodEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeYear", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYear) : headerSumBudgetAccountBalancechangeYear),
                                    new XElement("BudgetHeaderSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeYearEntCurrency) : headerSumBudgetAccountBalancechangeYearEntCurrency),
                                    new XElement("BudgetHeaderSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitPeriod) : headerSumBudgetAccountGrossProfitPeriod),
                                    new XElement("BudgetHeaderSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod) : headerSumBudgetAccountGrossProfitBalancechangeIncludingPeriod),
                                    new XElement("BudgetHeaderSumAccountGrossProfitYear", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYear) : headerSumBudgetAccountGrossProfitYear),
                                    new XElement("BudgetHeaderSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountGrossProfitYearEntCurrency) : headerSumBudgetAccountGrossProfitYearEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodDiff) : headerSumBudgetAccountBalancechangePeriodDiff),
                                    new XElement("BudgetHeaderSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangePeriodDiffEntCurrency) : headerSumBudgetAccountBalancechangePeriodDiffEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodDiff) : headerSumBudgetAccountBalancechangeToPeriodDiff),
                                    new XElement("BudgetHeaderSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency) : headerSumBudgetAccountBalancechangeToPeriodDiffEntCurrency),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriodDiff) : headerSumBudgetAccountBalancechangeIncludingPeriodDiff),
                                    new XElement("BudgetHeaderSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency) : headerSumBudgetAccountBalancechangeIncludingPeriodDiffEntCurrency));

                                #endregion

                                if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                                {
                                    #region BalanceReport

                                    headerElement.Add(
                                        new XElement("HeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalance) : headerSumAccountPeriodInBalance),
                                        new XElement("HeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceEntCurrency) : headerSumAccountPeriodInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalance) : headerSumAccountGrossProfitPeriodInBalance),
                                        new XElement("HeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountYearInBalance) : headerSumAccountYearInBalance),
                                        new XElement("HeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountYearInBalanceEntCurrency) : headerSumAccountYearInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalance) : headerSumAccountGrossProfitYearInBalance),
                                        new XElement("HeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitYearInBalanceEntCurrency) : headerSumAccountGrossProfitYearInBalanceEntCurrency),
                                        new XElement("HeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalance) : headerSumAccountClosingBalance),
                                        new XElement("HeaderSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceEntCurrency) : headerSumAccountClosingBalanceEntCurrency),
                                        new XElement("HeaderSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceDiff) : headerSumAccountPeriodInBalanceDiff),
                                        new XElement("HeaderSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPeriodInBalanceDiffEntCurrency) : headerSumAccountPeriodInBalanceDiffEntCurrency),
                                        new XElement("HeaderSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiff) : headerSumAccountOpeningBalanceDiff),
                                        new XElement("HeaderSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiffEntCurrency) : headerSumAccountOpeningBalanceDiffEntCurrency),
                                        new XElement("HeaderSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiff) : headerSumAccountClosingBalanceDiff),
                                        new XElement("HeaderSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiffEntCurrency) : headerSumAccountClosingBalanceDiffEntCurrency),
                                        //PreviousYear
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalance) : headerSumAccountPreviousYearPeriodInBalance),
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalance) : headerSumAccountGrossProfitPreviousYearPeriodInBalance),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalance) : headerSumAccountPreviousYearInBalance),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearInBalanceEntCurrency) : headerSumAccountPreviousYearInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalance) : headerSumAccountGrossProfitPreviousYearInBalance),
                                        new XElement("PreviousYearHeaderSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : headerSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalance", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYear) : headerSumAccountClosingBalancePreviousYear),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalancePreviousYearEntCurrency) : headerSumAccountClosingBalancePreviousYearEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceDiff) : headerSumAccountPreviousYearPeriodInBalanceDiff),
                                        new XElement("PreviousYearHeaderSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountPreviousYearPeriodInBalanceDiffEntCurrency) : headerSumAccountPreviousYearPeriodInBalanceDiffEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiffPreviousYear) : headerSumAccountOpeningBalanceDiffPreviousYear),
                                        new XElement("PreviousYearHeaderSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountOpeningBalanceDiffPreviousYearEntCurrency) : headerSumAccountOpeningBalanceDiffPreviousYearEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiffPreviousYear) : headerSumAccountClosingBalanceDiffPreviousYear),
                                        new XElement("PreviousYearHeaderSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(headerSumAccountClosingBalanceDiffPreviousYearEntCurrency) : headerSumAccountClosingBalanceDiffPreviousYearEntCurrency));

                                    headerElement.Add(
                                        new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                    #endregion
                                }
                                else if (es.ReportTemplateType == SoeReportTemplateType.ResultReport)
                                {
                                    #region ResultReport

                                    headerElement.Add(
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalance) : headerSumAccountBalanceChangeAllPreviousThisYearBalance),
                                        new XElement("HeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                        //Previous Year
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency),
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalance) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                        new XElement("PreviousYearHeaderSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : headerSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency));

                                    headerElement.Add(
                                        new XElement("DoNotSummarizeOnGroup", reportHeader.DoNotSummarizeOnGroup.ToInt()));

                                    #endregion
                                }

                                #region BalanceReport, ResultReport

                                foreach (XElement element in accountElementsForHeader)
                                {
                                    headerElement.Add(element);
                                }

                                #endregion
                            }
                            else
                            {
                                #region Sru

                                headerElement.Add(new XElement("Account",
                                    new XAttribute("id", 1),
                                    new XElement("AccountNr", String.Empty),
                                    new XElement("AccountName", String.Empty),
                                    new XElement("AccountInternalNr1", String.Empty),
                                    new XElement("AccountInternalName1", String.Empty),
                                    new XElement("AccountInternalNr2", String.Empty),
                                    new XElement("AccountInternalName2", String.Empty),
                                    new XElement("AccountInternalNr3", String.Empty),
                                    new XElement("AccountInternalName3", String.Empty),
                                    new XElement("AccountInternalNr4", String.Empty),
                                    new XElement("AccountInternalName4", String.Empty),
                                    new XElement("AccountInternalNr5", String.Empty),
                                    new XElement("AccountInternalName5", String.Empty),
                                    new XElement("AccountInternalNr6", String.Empty),
                                    new XElement("AccountInternalName6", String.Empty),
                                    new XElement("AccountBalancechangePeriod", Decimal.Zero)));

                                #endregion
                            }

                            #endregion

                            #endregion

                            reportHeaderElements.Add(headerElement);
                            reportHeaderXmlId++;
                        }

                        #region XElement ReportGroup
                        XElement groupElement = new XElement("Group");
                        if (es.ReportTemplateType == SoeReportTemplateType.SruReport)
                        {
                            //SRU
                            groupElement.Add(
                            new XAttribute("id", reportGroupXmlId),
                            new XElement("GroupName", reportGroup.Name),
                            new XElement("GroupShowLabel", reportGroup.ShowLabel.ToInt()),
                            new XElement("GroupShowSum", reportGroup.ShowSum.ToInt()),
                            new XElement("GroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriod) : groupSumAccountBalancechangePeriod),
                            new XElement("GroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodEntCurrency) : groupSumAccountBalancechangePeriodEntCurrency),
                            new XElement("GroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountYearInBalance) : groupSumAccountYearInBalance),
                            new XElement("GroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountYearInBalanceEntCurrency) : groupSumAccountYearInBalanceEntCurrency));
                        }
                        else
                        {
                            //BalanceReport, ResultReport, SRU
                            groupElement.Add(
                            new XAttribute("id", reportGroupXmlId),
                            new XElement("GroupName", reportGroup.Name),
                            new XElement("GroupShowLabel", reportGroup.ShowLabel.ToInt()),
                            new XElement("GroupShowSum", reportGroup.ShowSum.ToInt()),
                            new XElement("GroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriod) : groupSumAccountBalancechangePeriod),
                            new XElement("GroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodEntCurrency) : groupSumAccountBalancechangePeriodEntCurrency),
                            new XElement("GroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriod) : groupSumAccountGrossProfitPeriod),
                            new XElement("GroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodEntCurrency) : groupSumAccountGrossProfitPeriodEntCurrency),
                            //PreviousYear
                            new XElement("PreviousYearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriod) : groupSumAccountBalancechangePreviousYearPeriod),
                            new XElement("PreviousYearGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodEntCurrency) : groupSumAccountBalancechangePreviousYearPeriodEntCurrency),
                            new XElement("PreviousYearGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriod) : groupSumAccountGrossProfitPreviousYearPeriod),
                            new XElement("PreviousYearGroupSumAccountGrossProfitPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodEntCurrency),
                            //Previous Period
                            new XElement("PreviousPeriodMinus1YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus1Year) : groupSumAccountBalancechangePreviousPeriodYearMinus1Year),
                            new XElement("PreviousPeriodMinus2YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus2Year) : groupSumAccountBalancechangePreviousPeriodYearMinus2Year),
                            new XElement("PreviousPeriodMinus3YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus3Year) : groupSumAccountBalancechangePreviousPeriodYearMinus3Year),
                            new XElement("PreviousPeriodMinus4YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus4Year) : groupSumAccountBalancechangePreviousPeriodYearMinus4Year),
                            new XElement("PreviousPeriodMinus5YearGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousPeriodYearMinus5Year) : groupSumAccountBalancechangePreviousPeriodYearMinus5Year),
                            //Budget
                            new XElement("BudgetGroupSumAccountBalancechangePeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriod) : groupSumBudgetAccountBalancechangePeriod),
                            new XElement("BudgetGroupSumAccountBalancechangePeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodEntCurrency) : groupSumBudgetAccountBalancechangePeriodEntCurrency));
                        }
                        //BalanceReport, ResultReport
                        if (es.ReportTemplateType == SoeReportTemplateType.ResultReport || es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                        {
                            groupElement.Add(
                                new XElement("GroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriod) : groupSumAccountBalancechangeToPeriod),
                                new XElement("GroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodEntCurrency) : groupSumAccountBalancechangeToPeriodEntCurrency),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPeriod) : groupSumAccountBalancechangeIncludingPeriod),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPeriodEntCurrency) : groupSumAccountBalancechangeIncludingPeriodEntCurrency),
                                new XElement("GroupSumAccountBalancechangeGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeGrossProfitIncludingPeriod) : groupSumAccountBalancechangeGrossProfitIncludingPeriod),
                                new XElement("GroupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency) : groupSumAccountBalancechangeGrossProfitIncludingPeriodEntCurrency),
                                new XElement("GroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYear) : groupSumAccountBalancechangeYear),
                                new XElement("GroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeYearEntCurrency) : groupSumAccountBalancechangeYearEntCurrency),
                                new XElement("GroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYear) : groupSumAccountGrossProfitYear),
                                new XElement("GroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearEntCurrency) : groupSumAccountGrossProfitYearEntCurrency),
                                new XElement("GroupSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodDiff) : groupSumAccountBalancechangePeriodDiff),
                                new XElement("GroupSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePeriodDiffEntCurrency) : groupSumAccountBalancechangePeriodDiffEntCurrency),
                                new XElement("GroupSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiff) : groupSumAccountBalancechangeToPeriodDiff),
                                new XElement("GroupSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPeriodDiffEntCurrency),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiff) : groupSumAccountBalancechangeToPeriodDiff),
                                new XElement("GroupSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPeriodDiffEntCurrency),
                                //PreviousYear
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriod) : groupSumAccountBalancechangeToPreviousYearPeriod),
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPreviousYearPeriod) : groupSumAccountBalancechangeIncludingPreviousYearPeriod),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency) : groupSumAccountBalancechangeIncludingPreviousYearPeriodEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYear) : groupSumAccountBalancechangePreviousYear),
                                new XElement("PreviousYearGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearEntCurrency) : groupSumAccountBalancechangePreviousYearEntCurrency),
                                new XElement("PreviousYearGroupSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod) : groupSumAccountBalancechangeGrossProfitIncludingPreviousYearPeriod),

                                new XElement("PreviousYearGroupSumAccountGrossProfitYear", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYear) : groupSumAccountGrossProfitPreviousYear),
                                new XElement("PreviousYearGroupSumAccountGrossProfitYearEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearEntCurrency) : groupSumAccountGrossProfitPreviousYearEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodDiff) : groupSumAccountBalancechangePreviousYearPeriodDiff),
                                new XElement("PreviousYearGroupSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency) : groupSumAccountBalancechangePreviousYearPeriodDiffEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiff) : groupSumAccountBalancechangeToPreviousYearPeriodDiff),
                                new XElement("PreviousYearGroupSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiff) : groupSumAccountBalancechangeToPreviousYearPeriodDiff),
                                new XElement("PreviousYearGroupSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency) : groupSumAccountBalancechangeToPreviousYearPeriodDiffEntCurrency),
                                //Budget
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriod) : groupSumBudgetAccountBalancechangeToPeriod),
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeIncludingPeriod) : groupSumBudgetAccountBalancechangeIncludingPeriod),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriodEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency) : groupSumBudgetAccountBalancechangeIncludingPeriodEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeYear", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYear) : groupSumBudgetAccountBalancechangeYear),
                                new XElement("BudgetGroupSumAccountBalancechangeYearEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeYearEntCurrency) : groupSumBudgetAccountBalancechangeYearEntCurrency),
                                new XElement("BudgetGroupSumAccountGrossProfitPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitPeriod) : groupSumBudgetAccountGrossProfitPeriod),
                                new XElement("BudgetGroupSumAccountGrossProfitToPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitToPeriod) : groupSumBudgetAccountGrossProfitToPeriod),
                                new XElement("BudgetGroupSumAccountGrossProfitIncludingPeriod", invertRow ? Decimal.Negate(groupSumBudgetAccountGrossProfitIncludingPeriod) : groupSumBudgetAccountGrossProfitIncludingPeriod),
                                new XElement("BudgetGroupSumAccountBalancechangePeriodDiff", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodDiff) : groupSumBudgetAccountBalancechangePeriodDiff),
                                new XElement("BudgetGroupSumAccountBalancechangePeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangePeriodDiffEntCurrency) : groupSumBudgetAccountBalancechangePeriodDiffEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriodDiff", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiff) : groupSumBudgetAccountBalancechangeToPeriodDiff),
                                new XElement("BudgetGroupSumAccountBalancechangeToPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriodDiff", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiff) : groupSumBudgetAccountBalancechangeToPeriodDiff),
                                new XElement("BudgetGroupSumAccountBalancechangeIncludingPeriodDiffEntCurrency", invertRow ? Decimal.Negate(groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency) : groupSumBudgetAccountBalancechangeToPeriodDiffEntCurrency));


                            //BalanceReport
                            if (es.ReportTemplateType == SoeReportTemplateType.BalanceReport)
                            {
                                #region BalanceReport

                                groupElement.Add(
                                    new XElement("GroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalance) : groupSumAccountPeriodInBalance),
                                    new XElement("GroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceEntCurrency) : groupSumAccountPeriodInBalanceEntCurrency),
                                    new XElement("GroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalance) : groupSumAccountGrossProfitPeriodInBalance),
                                    new XElement("GroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPeriodInBalanceEntCurrency),
                                    new XElement("GroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountYearInBalance) : groupSumAccountYearInBalance),
                                    new XElement("GroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountYearInBalanceEntCurrency) : groupSumAccountYearInBalanceEntCurrency),
                                    new XElement("GroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                    new XElement("GroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalanceEntCurrency) : groupSumAccountGrossProfitYearInBalanceEntCurrency),
                                    new XElement("GroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalance) : groupSumAccountClosingBalance),
                                    new XElement("GroupSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceEntCurrency) : groupSumAccountClosingBalanceEntCurrency),
                                    new XElement("GroupSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceDiff) : groupSumAccountPeriodInBalanceDiff),
                                    new XElement("GroupSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPeriodInBalanceDiffEntCurrency) : groupSumAccountPeriodInBalanceDiffEntCurrency),
                                    new XElement("GroupSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiff) : groupSumAccountOpeningBalanceDiff),
                                    new XElement("GroupSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiffEntCurrency) : groupSumAccountOpeningBalanceDiffEntCurrency),
                                    new XElement("GroupSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiff) : groupSumAccountClosingBalanceDiff),
                                    new XElement("GroupSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiffEntCurrency) : groupSumAccountClosingBalanceDiffEntCurrency),
                                    //PreviousYear
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalance) : groupSumAccountPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalance) : groupSumAccountGrossProfitPreviousYearPeriodInBalance),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitPeriodInBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearPeriodInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalance) : groupSumAccountPreviousYearInBalance),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearInBalanceEntCurrency) : groupSumAccountPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalance", invertRow ? Decimal.Negate(groupSumAccountGrossProfitYearInBalance) : groupSumAccountGrossProfitYearInBalance),
                                    new XElement("PreviousYearGroupSumAccountGrossProfitOpeningBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency) : groupSumAccountGrossProfitPreviousYearInBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountClosingBalance", invertRow ? Decimal.Negate(groupSumAccountClosingBalancePreviousYear) : groupSumAccountClosingBalancePreviousYear),
                                    new XElement("PreviousYearGroupSumAccountClosingBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalancePreviousYearEntCurrency) : groupSumAccountClosingBalancePreviousYearEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceDiff) : groupSumAccountPreviousYearPeriodInBalanceDiff),
                                    new XElement("PreviousYearGroupSumAccountPeriodInBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountPreviousYearPeriodInBalanceDiffEntCurrency) : groupSumAccountPreviousYearPeriodInBalanceDiffEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiffPreviousYear) : groupSumAccountOpeningBalanceDiffPreviousYear),
                                    new XElement("PreviousYearGroupSumAccountOpeningBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountOpeningBalanceDiffPreviousYearEntCurrency) : groupSumAccountOpeningBalanceDiffPreviousYearEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountClosingBalanceDiff", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiffPreviousYear) : groupSumAccountClosingBalanceDiffPreviousYear),
                                    new XElement("PreviousYearGroupSumAccountClosingBalanceDiffEntCurrency", invertRow ? Decimal.Negate(groupSumAccountClosingBalanceDiffPreviousYearEntCurrency) : groupSumAccountClosingBalanceDiffPreviousYearEntCurrency));

                                #endregion
                            }
                            else if (es.ReportTemplateType == SoeReportTemplateType.ResultReport)
                            {
                                #region ResultReport

                                groupElement.Add(
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalance) : groupSumAccountBalanceChangeAllPreviousThisYearBalance),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPeriodBalance),
                                    new XElement("GroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency),
                                    //PreviousYear
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalance) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalance),
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousThisYearBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousPreviousYearBalanceEntCurrency),
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalance", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalance),
                                    new XElement("PreviousYearGroupSumAccountBalanceChangeAllPreviousToPeriodBalanceEntCurrency", invertRow ? Decimal.Negate(groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency) : groupSumAccountBalanceChangeAllPreviousToPreviousYearPeriodBalanceEntCurrency));


                                #endregion
                            }
                        }

                        //Add ReportHeaders to ReportGroup
                        foreach (XElement element in reportHeaderElements)
                        {
                            groupElement.Add(element);
                        }

                        #endregion

                        sheetElement.Add(groupElement);
                        reportGroupXmlId++;
                    }

                    reportElement.Add(sheetElement);

                    #endregion

                    reportI++;
                    if (reportAccountInternalsSpecificDim.Count > 0 && (reportI) < (es.SSTD_IncludeMissingAccountDim ? reportAccountInternalsSpecificDim.Count + 1 : reportAccountInternalsSpecificDim.Count) && es.SSTD_SeparateAccountDim)
                    {
                        var currentAccount = reportAccountInternalsSpecificDim.ElementAt(currentAccountIdx);
                        accountInternalsInInterval.RemoveAll(i => i.AccountId == currentAccount.AccountId);

                        if (!delaySetAccount)
                        {
                            currentAccountIdx++;
                            accountInternalsInInterval.Add(reportAccountInternalsSpecificDim.ElementAt(currentAccountIdx));
                        }
                        else
                        {
                            accountInternalsInInterval = reportAccountInternalsInInterval;
                            delaySetAccount = false;
                        }

                        AccountInternalDTO accountinternal = null;
                        if (es.SSTD_AccountDimId != 0)
                        {
                            accountinternal = accountInternalsInInterval.FirstOrDefault(i => i.AccountDimId == es.SSTD_AccountDimId);
                            if (accountinternal == null)
                                isAccountSelectionValid = false;
                        }

                        biBalancechangePeriodDict.Clear();
                        biBalanceChangeToPeriodDict.Clear();
                        biBalanceChangeIncludingPeriodDict.Clear();
                        biBalanceChangeYearDict.Clear();
                        biYearInBalanceDict.Clear();
                        biAccountBalanceChangeAllPreviousToPeriodDict.Clear();
                        biAccountBalanceChangeAllPreviousThisYearDict.Clear();
                        // Previous Year
                        biBalancechangePreviousYearPeriodDict.Clear();
                        biBalanceChangeToPreviousYearPeriodDict.Clear();
                        biBalanceChangeIncludingPreviousYearPeriodDict.Clear();
                        biBalanceChangePreviousYearDict.Clear();
                        biYearInBalancePreviousYearDict.Clear();
                        biAccountBalanceChangeAllPreviousToPreviousYearPeriodDict.Clear();
                        biAccountBalanceChangeAllPreviousPreviousYearDict.Clear();
                        //PreviousPeriods
                        biBalancechangePrevoiusPeriodMinus1YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus2YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus3YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus4YearDict.Clear();
                        biBalancechangePrevoiusPeriodMinus5YearDict.Clear();
                        // Budget TODO BudgetBalanceItemDTO
                        biBudgetBalancechangePeriodDict.Clear();
                        biBudgetBalanceChangeToPeriodDict.Clear();
                        biBudgetBalanceChangeIncludingPeriodDict.Clear();
                        biBudgetBalanceChangeYearDict.Clear();
                        //Gross profit
                        biGrossProfitBalanceChangePeriodDict.Clear();
                        biGrossProfitBalanceChangeToPeriodDict.Clear();
                        biGrossProfitBalanceChangeIncludingPeriodDict.Clear();
                        biGrossProfitBalanceChangeYearDict.Clear();
                        biGrossProfitYearInBalanceDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousToPeriodDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousThisYearDict.Clear();
                        //Gross profit and Budget
                        biGrossProfitBalanceChangePeriodBudgetDict.Clear();
                        biGrossProfitBalanceChangeToPeriodBudgetDict.Clear();
                        biGrossProfitBalanceChangeIncludingPeriodBudgetDict.Clear();
                        biGrossProfitBalanceChangeYearBudgetDict.Clear();
                        biGrossProfitYearInBalanceBudgetDict.Clear();
                        //Gross profit Previous Year
                        biGrossProfitBalanceChangePreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangeToPreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangeIncludingPreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangePreviousYearDict.Clear();
                        biGrossProfitYearInBalancePreviousYearDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousToPreviousYearPeriodDict.Clear();
                        biGrossProfitBalanceChangeAllPreviousPreviousYearDict.Clear();
                        //historical Data
                        voucherHeadsAllPreviousThisYear.Clear();
                        voucherHeadsAllPreviousToPeriod.Clear();
                        voucherHeadsAllPreviousPreviousYear.Clear();
                        voucherHeadsAllPreviousToPreviousYearPeriod.Clear();
                        //VoucherHeads
                        voucherHeadsBalancechangePeriod.Clear();
                        voucherHeadsBalanceChangeToPeriod.Clear();
                        voucherHeadsBalanceChangeIncludingPeriod.Clear();
                        voucherHeadsBalanceChangeYear.Clear();
                        //VoucherHeads Budget
                        budgetVoucherHeadsBalancechangePeriod.Clear();
                        budgetVoucherHeadsBalanceChangeToPeriod.Clear();
                        budgetVoucherHeadsBalanceChangeIncludingPeriod.Clear();
                        budgetVoucherHeadsBalanceChangeYear.Clear();
                        //VoucherHeads PreviuousPeriods
                        previousPeriodMinus1YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus2YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus3YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus4YearVoucherHeadsBalancechangePeriod.Clear();
                        previousPeriodMinus5YearVoucherHeadsBalancechangePeriod.Clear();
                        //VoucherHeads PreviousYear
                        previousYearVoucherHeadsBalancechangePeriod.Clear();
                        previousYearVoucherHeadsBalanceChangeToPeriod.Clear();
                        previousYearVoucherHeadsBalanceChangeIncludingPeriod.Clear();
                        previousYearVoucherHeadsBalanceChangeYear.Clear();
                        //VoucherHeads GrossProfit
                        voucherHeadsGrossProfitBalanceChangePeriod.Clear();
                        voucherHeadsGrossProfitBalanceChangeToPeriod.Clear();
                        voucherHeadsGrossProfitBalanceChangeIncludingPeriod.Clear();
                        voucherHeadsGrossProfitBalanceChangeYear.Clear();
                        //VoucherHeads GrossProfitBudget
                        voucherHeadsGrossProfitBudgetBalanceChangePeriod.Clear();
                        voucherHeadsGrossProfitBudgetBalanceChangeToPeriod.Clear();
                        voucherHeadsGrossProfitBudgetBalanceChangeIncludingPeriod.Clear();
                        voucherHeadsGrossProfitBudgetBalanceChangeYear.Clear();
                        //VoucherHeads GrossProfit PreviousYear
                        previousYearVoucherHeadsGrossProfitBalanceChangePeriod.Clear();
                        previousYearVoucherHeadsGrossProfitBalanceChangeToPeriod.Clear();
                        previousYearVoucherHeadsGrossProfitBalanceChangeIncludingPeriod.Clear();
                        previousYearVoucherHeadsGrossProfitBalanceChangeYear.Clear();

                    }
                    else
                    {
                        isAccountSelectionValid = false;

                    }
                }

            }

            return result;
        }

        private XElement CreateGeneralLedgerAccountElementFromDTO(EvaluatedSelection es, int accountXmlId, AccountDTO account, BalanceItemDTO biAccountBalance, List<AccountDimDTO> accountDimInternals)
        {
            if (es == null || account == null || biAccountBalance == null || accountDimInternals == null)
                return null;

            XElement accountElement = new XElement("Account",
                new XAttribute("id", accountXmlId),
                new XElement("AccountNr", account.AccountNr),
                new XElement("AccountName", account.Name),
                new XElement("AccountBalance", biAccountBalance.Balance),
                new XElement("AccountQuantity", Convert.ToDecimal(biAccountBalance.Quantity)));

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    accountElement.Add(
                        new XElement("InternalNr" + i, String.Empty),
                        new XElement("InternalName" + i, String.Empty));
                    continue;
                }
            }

            return accountElement;
        }

        private XElement CreateAccountElementForProjectReport(int accountId, AccountDTO account, List<VoucherRowDTO> accountInternalRows, DateTime dateFrom)
        {
            decimal ib = 0;
            decimal quantity = 0;

            foreach (var row in accountInternalRows)
            {
                if (row.Date < dateFrom)
                {
                    ib += row.Amount;
                    quantity += row.Quantity != null ? (decimal)row.Quantity : 0;
                }
            }

            XElement accountElement = new XElement("Account",
                    new XAttribute("id", accountId),
                    new XElement("AccountNr", account.AccountNr),
                    new XElement("AccountName", account.Name),
                    new XElement("AccountBalance", ib),
                    new XElement("AccountQuantity", Convert.ToDecimal(quantity)),
                    new XElement("InternalNr1", accountInternalRows[0].Dim2Nr),
                    new XElement("InternalName1", accountInternalRows[0].Dim2Name),
                    new XElement("InternalNr2", accountInternalRows[0].Dim3Nr),
                    new XElement("InternalName2", accountInternalRows[0].Dim3Name),
                    new XElement("InternalNr3", accountInternalRows[0].Dim4Nr),
                    new XElement("InternalName3", accountInternalRows[0].Dim4Name),
                    new XElement("InternalNr4", accountInternalRows[0].Dim5Nr),
                    new XElement("InternalName4", accountInternalRows[0].Dim5Name),
                    new XElement("InternalNr5", accountInternalRows[0].Dim6Nr),
                    new XElement("InternalName5", accountInternalRows[0].Dim6Name));

            return accountElement;
        }

        private XElement CreateVoucherRowElementsForProjectReport(int voucherRowXmlId, VoucherRowDTO voucherRow, List<AccountDim> accountDimInternals)
        {
            this.GetDebetCredit(voucherRow.Amount, out decimal debet, out decimal credit);
            this.GetDebetCredit(voucherRow.AmountEntCurrency, out decimal debetEntCurrency, out decimal creditEntCurrency);

            string voucherRowText = voucherRow.Text;
            if (String.IsNullOrEmpty(voucherRowText))
                voucherRowText = voucherRow.Text;

            XElement voucherRowElement = new XElement("VoucherRow",
                new XAttribute("id", voucherRowXmlId),
                new XElement("VoucherSerieNr", voucherRow.VoucherSeriesTypeNr),
                new XElement("VoucherSerieName", voucherRow.VoucherSeriesTypeName),
                new XElement("VoucherNr", voucherRow.VoucherNr),
                new XElement("VoucherRowDate", voucherRow.Date), //Cannot use VoucherRow.Date beacuse that data is corrupted in many cases (i.e. set to date when currency was fetched from ws)
                new XElement("VoucherRowText", voucherRowText),
                new XElement("Debit", debet),
                new XElement("DebitEntCurrency", debetEntCurrency),
                new XElement("Credit", credit),
                new XElement("CreditEntCurrency", creditEntCurrency),
                new XElement("Quantity", Convert.ToDecimal(voucherRow.Quantity)));

            #region AccountInternal

            for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
            {
                if (i > accountDimInternals.Count)
                {
                    voucherRowElement.Add(
                        new XElement("AccountInternalNr" + i, String.Empty),
                        new XElement("AccountInternalName" + i, String.Empty));
                    continue;
                }

                AccountInternalDTO accountInternal = null;
                var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                if (accountDim != null)
                {
                    accountInternal = (from ai in voucherRow.AccountInternalDTO_forReports
                                       where ai.AccountDimId == accountDim.AccountDimId
                                       select ai).FirstOrDefault();
                }

                voucherRowElement.Add(
                    new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                    new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
            }

            #endregion AccountInternal

            return voucherRowElement;
        }

        public DrilldownReportGridDTO CreateDrilldownReportData(int reportId, int periodFrom, int periodTo, int actorCompanyId, int budgetHeadId)
        {
            using (CompEntities entities = new CompEntities())
            {
                #region prereq

                Report report = ReportManager.GetReport(entities, reportId, actorCompanyId, loadSysReportTemplateType: true);
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(ActorCompanyId);

                DateTime dateFrom = AccountManager.GetAccountPeriod(entities, periodFrom, false).From;
                DateTime dateTo = AccountManager.GetAccountPeriod(entities, periodTo, false).To;
                DateTime prevYearDateFrom = dateFrom.AddYears(-1);
                DateTime prevYearDateTo = dateTo.AddYears(-1);
                AccountYear accountYear = AccountManager.GetAccountYear(entities, dateFrom, actorCompanyId);
                AccountYear prevAccountYear = AccountManager.GetAccountYear(entities, prevYearDateFrom, ActorCompanyId);

                int factor = 1;
                int periodNrFrom = 0;
                int periodNrTo = 0;

                List<ReportGroupsDrilldownDTO> reportGroupsDrilldown = new List<ReportGroupsDrilldownDTO>();
                List<AccountYearBalanceHead> accountYearBalanceHeads = new List<AccountYearBalanceHead>();
                List<BudgetRow> budgetRows = new List<BudgetRow>();

                Dictionary<int, BalanceItemDTO> biBalanceChangePeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodEndDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearToPeriodEndDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biOpeningBalanceDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetToPeriodEndDict = new Dictionary<int, BalanceItemDTO>();

                BalanceItemDTO biBalanceChangePeriod = null;
                BalanceItemDTO biBalanceChangeToPeriod = null;
                BalanceItemDTO biBalanceChangeToPeriodEnd = null;
                BalanceItemDTO biBalanceChangePreviousYearPeriod = null;
                BalanceItemDTO biBalanceChangePreviousYearToPeriodEnd = null;
                BalanceItemDTO biOpeningBalance = null;
                BalanceItemDTO biBudgetPeriod = null;
                BalanceItemDTO biBudgetToPeriodEnd = null;

                List<VoucherRow> voucherRowsCurrentYear = VoucherManager.GetVoucherRows(entities, actorCompanyId, accountYear.From, dateTo);
                List<VoucherRow> voucherRowsPrevYear = new List<VoucherRow>();

                if (budgetHeadId == 0 && prevAccountYear != null)
                    voucherRowsPrevYear = VoucherManager.GetVoucherRows(entities, actorCompanyId, prevAccountYear.From, prevYearDateTo);

                if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport)
                    accountYearBalanceHeads = AccountBalanceManager(actorCompanyId).GetAccountYearBalanceHeads(accountYear.AccountYearId, actorCompanyId);

                if (budgetHeadId != 0)
                {
                    budgetRows = BudgetManager.GetBudgetRowsAndPeriod(entities, budgetHeadId);
                    periodNrFrom = ((dateFrom.Year - accountYear.From.Year) * 12) + dateFrom.Month - accountYear.From.Month + 1;
                    periodNrTo = ((dateTo.Year - accountYear.From.Year) * 12) + dateTo.Month - accountYear.From.Month + 1;
                }

                #endregion

                #region reportgroups
                List<ReportGroupDTO> reportGroups = ReportManager.GetReportGroupsForReport(actorCompanyId, report);
                foreach (var reportGroup in reportGroups)
                {
                    #region init
                    decimal groupPeriodAmount = Decimal.Zero;
                    decimal groupYearAmount = Decimal.Zero;
                    decimal groupPrevPeriodAmount = Decimal.Zero;
                    decimal groupPrevYearAmount = Decimal.Zero;
                    decimal groupOpeningBalanceAmount = Decimal.Zero;
                    decimal groupBudgetPeriodAmount = Decimal.Zero;
                    decimal groupBudgetYearAmount = Decimal.Zero;


                    if (reportGroup.InvertRow)
                        factor = -1;
                    else
                        factor = 1;
                    #endregion

                    #region ReportHeaders

                    List<ReportHeadersDrilldownDTO> reportHeadersDrilldown = new List<ReportHeadersDrilldownDTO>();
                    foreach (var reportHeader in reportGroup.ReportHeaders)
                    {
                        #region init
                        decimal headerPeriodAmount = Decimal.Zero;
                        decimal headerYearAmount = Decimal.Zero;
                        decimal headerPrevPeriodAmount = Decimal.Zero;
                        decimal headerPrevYearAmount = Decimal.Zero;
                        decimal headerOpeningBalanceAmount = Decimal.Zero;
                        decimal headerBudgetPeriodAmount = Decimal.Zero;
                        decimal headerBudgetYearAmount = Decimal.Zero;
                        #endregion

                        #region Accounts

                        //get accounts for report header
                        List<AccountsDrilldownDTO> accountsDrilldown = new List<AccountsDrilldownDTO>();
                        foreach (var reportHeaderInterval in reportHeader.ReportHeaderIntervals)
                        {
                            List<Account> accountsInInterval = AccountManager.GetAccountsByDimAndInterval(entities, accountDimStd.AccountDimId, ActorCompanyId, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo);

                            foreach (var account in accountsInInterval)
                            {
                                #region init
                                decimal accountPeriodAmount = Decimal.Zero;
                                decimal accountYearAmount = Decimal.Zero;
                                decimal accountPrevPeriodAmount = Decimal.Zero;
                                decimal accountPrevYearAmount = Decimal.Zero;
                                decimal accountOpeningBalanceAmount = Decimal.Zero;
                                decimal accountBudgetPeriodAmount = Decimal.Zero;
                                decimal accountBudgetYearAmount = Decimal.Zero;

                                #endregion

                                #region current year's balances

                                if (!biBalanceChangePeriodDict.ContainsKey(account.AccountId) && !biBalanceChangeToPeriodEndDict.ContainsKey(account.AccountId))
                                {
                                    biBalanceChangePeriod = new BalanceItemDTO();
                                    biBalanceChangeToPeriod = new BalanceItemDTO();
                                    biBalanceChangeToPeriodEnd = new BalanceItemDTO();
                                    List<VoucherRow> voucherRows = voucherRowsCurrentYear.Where(i => i.AccountId == account.AccountId && !i.VoucherHead.Template).ToList();

                                    //current accountyear's amounts                                
                                    foreach (var voucherRow in voucherRows)
                                    {
                                        biBalanceChangeToPeriodEnd.Balance += voucherRow.Amount;
                                        if (voucherRow.VoucherHead.Date >= dateFrom)
                                            biBalanceChangePeriod.Balance += voucherRow.Amount;
                                        if (voucherRow.VoucherHead.Date < dateFrom)
                                            biBalanceChangeToPeriod.Balance += voucherRow.Amount;
                                    }

                                    biBalanceChangePeriodDict.Add(account.AccountId, biBalanceChangePeriod);
                                    biBalanceChangeToPeriodEndDict.Add(account.AccountId, biBalanceChangeToPeriodEnd);
                                    biBalanceChangeToPeriodDict.Add(account.AccountId, biBalanceChangeToPeriod);
                                }

                                #region Opening balance
                                if (!biOpeningBalanceDict.ContainsKey(account.AccountId) && report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport)
                                {
                                    decimal openingBalance = Decimal.Zero;
                                    foreach (var accountYearBalanceHead in accountYearBalanceHeads.Where(i => i.AccountStd.AccountId == account.AccountId))
                                    {
                                        openingBalance += accountYearBalanceHead.Balance;
                                    }

                                    biOpeningBalanceDict.Add(account.AccountId, new BalanceItemDTO() { AccountId = account.AccountId, Balance = openingBalance });
                                }
                                #endregion

                                #region Budget
                                if (!biBudgetToPeriodEndDict.ContainsKey(account.AccountId) && budgetHeadId != 0)
                                {
                                    decimal periodAmount = Decimal.Zero;
                                    decimal yearAmount = Decimal.Zero;

                                    foreach (BudgetRow accountbudgetrow in budgetRows.Where(i => i.AccountId == account.AccountId))
                                    {
                                        List<BudgetRowPeriod> budgetRowPeriods = accountbudgetrow.BudgetRowPeriod.Where(i => i.PeriodNr <= periodNrTo).ToList();
                                        foreach (var period in budgetRowPeriods)
                                        {
                                            yearAmount += period.Amount;
                                            if (period.PeriodNr >= periodNrFrom && period.PeriodNr <= periodNrTo)
                                                periodAmount += period.Amount;
                                        }
                                    }

                                    biBudgetToPeriodEndDict.Add(account.AccountId, new BalanceItemDTO() { AccountId = account.AccountId, Balance = yearAmount });
                                    biBudgetPeriodDict.Add(account.AccountId, new BalanceItemDTO() { AccountId = account.AccountId, Balance = periodAmount });
                                }
                                #endregion

                                //kausi
                                biBalanceChangePeriod = biBalanceChangePeriodDict[account.AccountId];
                                accountPeriodAmount += biBalanceChangePeriod.Balance;
                                headerPeriodAmount += biBalanceChangePeriod.Balance;
                                groupPeriodAmount += biBalanceChangePeriod.Balance;

                                //kumulatiivinen
                                biBalanceChangeToPeriodEnd = biBalanceChangeToPeriodEndDict[account.AccountId];
                                accountYearAmount += biBalanceChangeToPeriodEnd.Balance;
                                headerYearAmount += biBalanceChangeToPeriodEnd.Balance;
                                groupYearAmount += biBalanceChangeToPeriodEnd.Balance;

                                if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport)
                                {
                                    biOpeningBalance = biOpeningBalanceDict[account.AccountId];
                                    biBalanceChangeToPeriod = biBalanceChangeToPeriodDict[account.AccountId];

                                    //alkusaldo (tilik. alkusaldo + tapahtumat kauden alkuun asti)
                                    accountOpeningBalanceAmount += biOpeningBalance.Balance + biBalanceChangeToPeriod.Balance;
                                    headerOpeningBalanceAmount += biOpeningBalance.Balance + biBalanceChangeToPeriod.Balance;
                                    groupOpeningBalanceAmount += biOpeningBalance.Balance + biBalanceChangeToPeriod.Balance;

                                    //lisätään alkusaldo kumulatiiviseen saldoon
                                    accountYearAmount += biOpeningBalance.Balance;
                                    headerYearAmount += biOpeningBalance.Balance;
                                    groupYearAmount += biOpeningBalance.Balance;
                                }

                                if (budgetHeadId != 0)
                                {
                                    biBudgetPeriod = biBudgetPeriodDict[account.AccountId];
                                    accountBudgetPeriodAmount += biBudgetPeriod.Balance;
                                    headerBudgetPeriodAmount += biBudgetPeriod.Balance;
                                    groupBudgetPeriodAmount += biBudgetPeriod.Balance;

                                    biBudgetToPeriodEnd = biBudgetToPeriodEndDict[account.AccountId];
                                    accountBudgetYearAmount += biBudgetToPeriodEnd.Balance;
                                    headerBudgetYearAmount += biBudgetToPeriodEnd.Balance;
                                    groupBudgetYearAmount += biBudgetToPeriodEnd.Balance;
                                }

                                #endregion

                                #region previous year's balances 
                                if (!biBalanceChangePreviousYearPeriodDict.ContainsKey(account.AccountId) && !biBalanceChangePreviousYearToPeriodEndDict.ContainsKey(account.AccountId))
                                {
                                    biBalanceChangePreviousYearPeriod = new BalanceItemDTO();
                                    biBalanceChangePreviousYearToPeriodEnd = new BalanceItemDTO();
                                    List<VoucherRow> voucherRows = voucherRowsPrevYear.Where(i => i.AccountId == account.AccountId && !i.VoucherHead.Template).ToList();

                                    foreach (var voucherRow in voucherRows)
                                    {
                                        biBalanceChangePreviousYearToPeriodEnd.Balance += voucherRow.Amount;
                                        if (voucherRow.VoucherHead.Date >= prevYearDateFrom)
                                            biBalanceChangePreviousYearPeriod.Balance += voucherRow.Amount;
                                    }

                                    biBalanceChangePreviousYearPeriodDict.Add(account.AccountId, biBalanceChangePreviousYearPeriod);
                                    biBalanceChangePreviousYearToPeriodEndDict.Add(account.AccountId, biBalanceChangePreviousYearToPeriodEnd);
                                }

                                biBalanceChangePreviousYearPeriod = biBalanceChangePreviousYearPeriodDict[account.AccountId];
                                accountPrevPeriodAmount += biBalanceChangePreviousYearPeriod.Balance;
                                headerPrevPeriodAmount += biBalanceChangePreviousYearPeriod.Balance;
                                groupPrevPeriodAmount += biBalanceChangePreviousYearPeriod.Balance;

                                biBalanceChangePreviousYearToPeriodEnd = biBalanceChangePreviousYearToPeriodEndDict[account.AccountId];
                                accountPrevYearAmount += biBalanceChangePreviousYearToPeriodEnd.Balance;
                                headerPrevYearAmount += biBalanceChangePreviousYearToPeriodEnd.Balance;
                                groupPrevYearAmount += biBalanceChangePreviousYearToPeriodEnd.Balance;
                                #endregion

                                //get amounts for account
                                AccountsDrilldownDTO accountDrilldown = new AccountsDrilldownDTO()
                                {
                                    AccountNr = account.AccountNr,
                                    AccountName = account.Name,
                                    PeriodAmount = accountPeriodAmount * factor,
                                    YearAmount = accountYearAmount * factor,
                                    PrevPeriodAmount = accountPrevPeriodAmount * factor,
                                    PrevYearAmount = accountPrevYearAmount * factor,
                                    OpeningBalance = accountOpeningBalanceAmount * factor,
                                    BudgetPeriodAmount = accountBudgetPeriodAmount * factor,
                                    BudgetToPeriodEndAmount = accountBudgetYearAmount * factor,
                                    PeriodPrevPeriodDiff = (accountPeriodAmount - accountPrevPeriodAmount) * factor,
                                    YearPrevYearDiff = (accountYearAmount - accountPrevYearAmount) * factor,
                                    PeriodBudgetDiff = (accountPeriodAmount - accountBudgetPeriodAmount) * factor,
                                    YearBudgetDiff = (accountYearAmount - accountBudgetYearAmount) * factor
                                };

                                if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.ResultReport && budgetHeadId == 0 &&
                                    (accountPeriodAmount != 0 || accountYearAmount != 0 || accountPrevPeriodAmount != 0 || accountPrevYearAmount != 0))
                                    accountsDrilldown.Add(accountDrilldown);
                                else if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.ResultReport && budgetHeadId != 0 &&
                                    (accountPeriodAmount != 0 || accountYearAmount != 0 || accountBudgetPeriodAmount != 0 || accountBudgetYearAmount != 0))
                                    accountsDrilldown.Add(accountDrilldown);
                                else if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport &&
                                    (accountPeriodAmount != 0 || accountYearAmount != 0 || accountOpeningBalanceAmount != 0))
                                    accountsDrilldown.Add(accountDrilldown);
                            }
                        }
                        #endregion

                        ReportHeadersDrilldownDTO reportHeaderDrilldown = new ReportHeadersDrilldownDTO()
                        {
                            ReportHeaderName = reportHeader.Name,
                            PeriodAmount = headerPeriodAmount * factor,
                            YearAmount = headerYearAmount * factor,
                            PrevPeriodAmount = headerPrevPeriodAmount * factor,
                            PrevYearAmount = headerPrevYearAmount * factor,
                            OpeningBalance = headerOpeningBalanceAmount * factor,
                            BudgetPeriodAmount = headerBudgetPeriodAmount * factor,
                            BudgetToPeriodEndAmount = headerBudgetYearAmount * factor,
                            PeriodPrevPeriodDiff = (headerPeriodAmount - headerPrevPeriodAmount) * factor,
                            YearPrevYearDiff = (headerYearAmount - headerPrevYearAmount) * factor,
                            PeriodBudgetDiff = (headerPeriodAmount - headerBudgetPeriodAmount) * factor,
                            YearBudgetDiff = (headerYearAmount - headerBudgetYearAmount) * factor,
                            Accounts = accountsDrilldown
                        };

                        reportHeadersDrilldown.Add(reportHeaderDrilldown);
                    }
                    #endregion

                    ReportGroupsDrilldownDTO reportGroupDrilldown = new ReportGroupsDrilldownDTO()
                    {
                        ReportGroupName = reportGroup.Name,
                        PeriodAmount = groupPeriodAmount * factor,
                        YearAmount = groupYearAmount * factor,
                        PrevPeriodAmount = groupPrevPeriodAmount * factor,
                        PrevYearAmount = groupPrevYearAmount * factor,
                        OpeningBalance = groupOpeningBalanceAmount * factor,
                        BudgetPeriodAmount = groupBudgetPeriodAmount * factor,
                        BudgetToPeriodEndAmount = groupBudgetYearAmount * factor,
                        PeriodPrevPeriodDiff = (groupPeriodAmount - groupPrevPeriodAmount) * factor,
                        YearPrevYearDiff = (groupYearAmount - groupPrevYearAmount) * factor,
                        PeriodBudgetDiff = (groupPeriodAmount - groupBudgetPeriodAmount) * factor,
                        YearBudgetDiff = (groupYearAmount - groupBudgetYearAmount) * factor,
                        ReportHeaders = reportHeadersDrilldown
                    };

                    reportGroupsDrilldown.Add(reportGroupDrilldown);
                }
                #endregion

                DrilldownReportGridDTO drilldownReport = new DrilldownReportGridDTO()
                {
                    ReportId = reportId,
                    ReportNr = report.ReportNr,
                    ReportName = report.Name,
                    ReportGroups = reportGroupsDrilldown,
                    sysReportTemplateTypeId = report.SysReportTemplateTypeId,
                };

                return drilldownReport;
            }
        }

        public List<DrilldownReportGridFlattenedDTO> CreateDrilldownReportDataFlattened(int reportId, int periodFrom, int periodTo, int actorCompanyId, int budgetHeadId)
        {
            using (CompEntities entities = new CompEntities())
            {
                List<DrilldownReportGridFlattenedDTO> dtos = new List<DrilldownReportGridFlattenedDTO>();

                #region prereq

                Report report = ReportManager.GetReport(entities, reportId, actorCompanyId, loadSysReportTemplateType: true);
                AccountDim accountDimStd = AccountManager.GetAccountDimStd(ActorCompanyId);
                List<Account> accounts = AccountManager.GetAccountsByDim(entities, accountDimStd.AccountDimId, actorCompanyId, true, true, true).ToList();

                DateTime dateFrom = AccountManager.GetAccountPeriod(entities, periodFrom, false).From;
                DateTime dateTo = AccountManager.GetAccountPeriod(entities, periodTo, false).To;
                DateTime prevYearDateFrom = dateFrom.AddYears(-1);
                DateTime prevYearDateTo = dateTo.AddYears(-1);
                AccountYear accountYear = AccountManager.GetAccountYear(entities, dateFrom, actorCompanyId);
                AccountYear prevAccountYear = AccountManager.GetAccountYear(entities, prevYearDateFrom, ActorCompanyId);

                int factor = 1;
                int periodNrFrom = 0;
                int periodNrTo = 0;

                List<AccountYearBalanceHead> accountYearBalanceHeads = new List<AccountYearBalanceHead>();
                List<BudgetRow> budgetRows = new List<BudgetRow>();

                List<Tuple<int, BalanceItemDTO, int>> biBalanceChangePeriodDict = new List<Tuple<int, BalanceItemDTO, int>>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangeToPeriodEndDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBalanceChangePreviousYearToPeriodEndDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biOpeningBalanceDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetPeriodDict = new Dictionary<int, BalanceItemDTO>();
                Dictionary<int, BalanceItemDTO> biBudgetToPeriodEndDict = new Dictionary<int, BalanceItemDTO>();

                BalanceItemDTO biBalanceChangePeriod = null;
                BalanceItemDTO biBalanceChangeToPeriod = null;
                BalanceItemDTO biBalanceChangeToPeriodEnd = null;
                BalanceItemDTO biBalanceChangePreviousYearPeriod = null;
                BalanceItemDTO biBalanceChangePreviousYearToPeriodEnd = null;
                BalanceItemDTO biOpeningBalance = null;
                BalanceItemDTO biBudgetPeriod = null;
                BalanceItemDTO biBudgetToPeriodEnd = null;

                List<AccountDateBalanceDTO> accountBalancesCurrentYear = VoucherManager.GetAccountDateBalances(entities, actorCompanyId, accountYear.From, dateTo);
                List<AccountDateBalanceDTO> accountBalancesPrevYear = new List<AccountDateBalanceDTO>();

                if (budgetHeadId == 0 && prevAccountYear != null)
                    accountBalancesPrevYear = VoucherManager.GetAccountDateBalances(entities, actorCompanyId, prevAccountYear.From, prevYearDateTo);

                if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport)
                    accountYearBalanceHeads = AccountBalanceManager(actorCompanyId).GetAccountYearBalanceHeads(accountYear.AccountYearId, actorCompanyId);

                if (budgetHeadId != 0)
                {
                    budgetRows = BudgetManager.GetBudgetRowsAndPeriod(entities, budgetHeadId);
                    periodNrFrom = ((dateFrom.Year - accountYear.From.Year) * 12) + dateFrom.Month - accountYear.From.Month + 1;
                    periodNrTo = ((dateTo.Year - accountYear.From.Year) * 12) + dateTo.Month - accountYear.From.Month + 1;
                }

                #endregion

                #region reportgroups
                List<ReportGroupDTO> reportGroups = ReportManager.GetReportGroupsForReport(actorCompanyId, report);
                foreach (var reportGroup in reportGroups)
                {
                    #region init
                    if (reportGroup.InvertRow)
                        factor = -1;
                    else
                        factor = 1;
                    #endregion

                    #region ReportHeaders

                    foreach (var reportHeader in reportGroup.ReportHeaders)
                    {
                        #region Accounts

                        //get accounts for report header

                        foreach (var reportHeaderInterval in reportHeader.ReportHeaderIntervals)
                        {
                            List<Account> accountsInInterval = AccountManager.FilterAccountsByDimAndInterval(accounts, accountDimStd.AccountDimId, reportHeaderInterval.IntervalFrom, reportHeaderInterval.IntervalTo);

                            foreach (var account in accountsInInterval)
                            {
                                #region init
                                decimal accountPeriodAmount = Decimal.Zero;
                                decimal accountYearAmount = Decimal.Zero;
                                decimal accountPrevPeriodAmount = Decimal.Zero;
                                decimal accountPrevYearAmount = Decimal.Zero;
                                decimal accountOpeningBalanceAmount = Decimal.Zero;
                                decimal accountBudgetPeriodAmount = Decimal.Zero;
                                decimal accountBudgetYearAmount = Decimal.Zero;

                                #endregion

                                #region current year's balances

                                if (!biBalanceChangePeriodDict.Any(x => x.Item1 == account.AccountId) && !biBalanceChangeToPeriodEndDict.ContainsKey(account.AccountId))
                                {
                                    biBalanceChangePeriod = new BalanceItemDTO();
                                    biBalanceChangeToPeriod = new BalanceItemDTO();
                                    biBalanceChangeToPeriodEnd = new BalanceItemDTO();
                                    var accountBalances = accountBalancesCurrentYear.Where(i => i.AccountId == account.AccountId).ToList();

                                    //current accountyear's amounts                                
                                    foreach (var accountBalance in accountBalances)
                                    {
                                        biBalanceChangeToPeriodEnd.Balance += accountBalance.Amount;
                                        if (accountBalance.Date >= dateFrom)
                                            biBalanceChangePeriod.Balance += accountBalance.Amount;
                                        if (accountBalance.Date < dateFrom)
                                            biBalanceChangeToPeriod.Balance += accountBalance.Amount;
                                    }

                                    biBalanceChangePeriodDict.Add(new Tuple<int, BalanceItemDTO, int>(account.AccountId, biBalanceChangePeriod, accountBalances.Sum(g => g.RowCount)));
                                    biBalanceChangeToPeriodEndDict.Add(account.AccountId, biBalanceChangeToPeriodEnd);
                                    biBalanceChangeToPeriodDict.Add(account.AccountId, biBalanceChangeToPeriod);
                                }

                                #region Opening balance
                                if (!biOpeningBalanceDict.ContainsKey(account.AccountId) && report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport)
                                {
                                    decimal openingBalance = Decimal.Zero;
                                    foreach (var accountYearBalanceHead in accountYearBalanceHeads.Where(i => i.AccountStd.AccountId == account.AccountId))
                                    {
                                        openingBalance += accountYearBalanceHead.Balance;
                                    }

                                    biOpeningBalanceDict.Add(account.AccountId, new BalanceItemDTO() { AccountId = account.AccountId, Balance = openingBalance });
                                }
                                #endregion

                                #region Budget
                                if (!biBudgetToPeriodEndDict.ContainsKey(account.AccountId) && budgetHeadId != 0)
                                {
                                    decimal periodAmount = Decimal.Zero;
                                    decimal yearAmount = Decimal.Zero;

                                    foreach (BudgetRow accountbudgetrow in budgetRows.Where(i => i.AccountId == account.AccountId))
                                    {
                                        List<BudgetRowPeriod> budgetRowPeriods = accountbudgetrow.BudgetRowPeriod.Where(i => i.PeriodNr <= periodNrTo).ToList();
                                        foreach (var period in budgetRowPeriods)
                                        {
                                            yearAmount += period.Amount;
                                            if (period.PeriodNr >= periodNrFrom && period.PeriodNr <= periodNrTo)
                                                periodAmount += period.Amount;
                                        }
                                    }

                                    biBudgetToPeriodEndDict.Add(account.AccountId, new BalanceItemDTO() { AccountId = account.AccountId, Balance = yearAmount });
                                    biBudgetPeriodDict.Add(account.AccountId, new BalanceItemDTO() { AccountId = account.AccountId, Balance = periodAmount });
                                }
                                #endregion

                                //kausi
                                var tuple = biBalanceChangePeriodDict.FirstOrDefault(x => x.Item1 == account.AccountId);
                                if (tuple == null)
                                    continue;
                                biBalanceChangePeriod = tuple.Item2;
                                accountPeriodAmount += biBalanceChangePeriod.Balance;

                                //kumulatiivinen
                                biBalanceChangeToPeriodEnd = biBalanceChangeToPeriodEndDict[account.AccountId];
                                accountYearAmount += biBalanceChangeToPeriodEnd.Balance;

                                if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport)
                                {
                                    biOpeningBalance = biOpeningBalanceDict[account.AccountId];
                                    biBalanceChangeToPeriod = biBalanceChangeToPeriodDict[account.AccountId];

                                    //alkusaldo (tilik. alkusaldo + tapahtumat kauden alkuun asti)
                                    accountOpeningBalanceAmount += biOpeningBalance.Balance + biBalanceChangeToPeriod.Balance;

                                    //lisätään alkusaldo kumulatiiviseen saldoon
                                    accountYearAmount += biOpeningBalance.Balance;
                                }

                                if (budgetHeadId != 0)
                                {
                                    biBudgetPeriod = biBudgetPeriodDict[account.AccountId];
                                    accountBudgetPeriodAmount += biBudgetPeriod.Balance;

                                    biBudgetToPeriodEnd = biBudgetToPeriodEndDict[account.AccountId];
                                    accountBudgetYearAmount += biBudgetToPeriodEnd.Balance;
                                }

                                #endregion

                                #region previous year's balances 
                                if (!biBalanceChangePreviousYearPeriodDict.ContainsKey(account.AccountId) && !biBalanceChangePreviousYearToPeriodEndDict.ContainsKey(account.AccountId))
                                {
                                    biBalanceChangePreviousYearPeriod = new BalanceItemDTO();
                                    biBalanceChangePreviousYearToPeriodEnd = new BalanceItemDTO();
                                    var accountBalances = accountBalancesPrevYear.Where(i => i.AccountId == account.AccountId).ToList();

                                    foreach (var accountBalance in accountBalances)
                                    {
                                        biBalanceChangePreviousYearToPeriodEnd.Balance += accountBalance.Amount;
                                        if (accountBalance.Date >= prevYearDateFrom)
                                            biBalanceChangePreviousYearPeriod.Balance += accountBalance.Amount;
                                    }

                                    biBalanceChangePreviousYearPeriodDict.Add(account.AccountId, biBalanceChangePreviousYearPeriod);
                                    biBalanceChangePreviousYearToPeriodEndDict.Add(account.AccountId, biBalanceChangePreviousYearToPeriodEnd);
                                }

                                biBalanceChangePreviousYearPeriod = biBalanceChangePreviousYearPeriodDict[account.AccountId];
                                accountPrevPeriodAmount += biBalanceChangePreviousYearPeriod.Balance;

                                biBalanceChangePreviousYearToPeriodEnd = biBalanceChangePreviousYearToPeriodEndDict[account.AccountId];
                                accountPrevYearAmount += biBalanceChangePreviousYearToPeriodEnd.Balance;
                                #endregion

                                //get amounts for account
                                DrilldownReportGridFlattenedDTO drillDownDTO = new DrilldownReportGridFlattenedDTO()
                                {
                                    AccountNr = account.AccountNr,
                                    AccountNrCount = account.AccountNr + " (" + tuple.Item3 + ")",
                                    AccountName = account.Name,
                                    PeriodAmount = accountPeriodAmount * factor,
                                    YearAmount = accountYearAmount * factor,
                                    PrevPeriodAmount = accountPrevPeriodAmount * factor,
                                    PrevYearAmount = accountPrevYearAmount * factor,
                                    OpeningBalance = accountOpeningBalanceAmount * factor,
                                    BudgetPeriodAmount = accountBudgetPeriodAmount * factor,
                                    BudgetToPeriodEndAmount = accountBudgetYearAmount * factor,
                                    PeriodPrevPeriodDiff = (accountPeriodAmount - accountPrevPeriodAmount) * factor,
                                    YearPrevYearDiff = (accountYearAmount - accountPrevYearAmount) * factor,
                                    PeriodBudgetDiff = (accountPeriodAmount - accountBudgetPeriodAmount) * factor,
                                    YearBudgetDiff = (accountYearAmount - accountBudgetYearAmount) * factor,
                                    ReportHeaderName = reportHeader.Name,
                                    ReportGroupName = reportGroup.Name
                                };

                                if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.ResultReport && budgetHeadId == 0 &&
                                    (accountPeriodAmount != 0 || accountYearAmount != 0 || accountPrevPeriodAmount != 0 || accountPrevYearAmount != 0))
                                    dtos.Add(drillDownDTO);
                                else if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.ResultReport && budgetHeadId != 0 &&
                                    (accountPeriodAmount != 0 || accountYearAmount != 0 || accountBudgetPeriodAmount != 0 || accountBudgetYearAmount != 0))
                                    dtos.Add(drillDownDTO);
                                else if (report.SysReportTemplateTypeId == (int)SoeReportTemplateType.BalanceReport &&
                                    (accountPeriodAmount != 0 || accountYearAmount != 0 || accountOpeningBalanceAmount != 0))
                                    dtos.Add(drillDownDTO);
                            }
                        }
                        #endregion
                    }
                    #endregion
                }

                #endregion

                return dtos;
            }
        }

        private void AddBalanceResultListVoucherRowElement(EvaluatedSelection es, List<XElement> voucherRowElements, List<VoucherHeadDTO> voucherHeadsForAccount, AccountDTO accountStd, List<AccountDimDTO> accountDimInternals, string voucherType, bool invertRow, List<AccountInternalDTO> accountInternalsInInterval, string reportHeaderName)
        {
            if (voucherHeadsForAccount == null || accountStd == null)
                return;

            if (voucherRowElements == null)
                voucherRowElements = new List<XElement>();
            if (accountDimInternals == null)
                accountDimInternals = new List<AccountDimDTO>();

            foreach (VoucherHeadDTO voucherHead in voucherHeadsForAccount)
            {
                List<VoucherRowDTO> voucherRowsForAccount = voucherHead.Rows.Where(r => r.State == (int)SoeEntityState.Active && r.Dim1Id == accountStd.AccountId && r.Amount != 0 && AccountManager.IsAccountInternalDTOInIntervalRange(accountDimInternals, accountInternalsInInterval, r.AccountInternalDTO_forReports)).ToList();

                decimal accountVoucherRowAmount = voucherRowsForAccount.Sum(i => i.Amount);
                if (accountVoucherRowAmount != 0)
                    AddBalanceResultListVoucherRowElement(es, voucherRowElements, voucherRowsForAccount, accountStd, accountDimInternals, voucherType, invertRow, reportHeaderName);
            }
        }

        private void AddBalanceResultListVoucherRowElement(EvaluatedSelection es, List<XElement> voucherRowElements, List<VoucherRowDTO> voucherRowsForAccount, AccountDTO accountStd, List<AccountDimDTO> accountDimInternals, string voucherType, bool invertRow, string reportHeaderName)
        {
            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
            {
                //if (es.SSTD_IncludeMissingAccountDim)
                //{
                //    int? accountDimNr = accountDimInternals.FirstOrDefault((x) => x.AccountDimId == es.SSTD_AccountDimId)?.AccountDimNr;
                //    if (accountDimNr == 2 && voucherRow.Dim2Nr != null)
                //    {
                //        continue;
                //    }
                //    if (accountDimNr == 3 && voucherRow.Dim3Nr != null)
                //    {
                //        continue;
                //    }
                //}
                XElement voucherRowElement = new XElement("VoucherRow",
                    new XAttribute("id", voucherRowElements.Count + 1),
                    new XElement("VoucherRowAccountNr", accountStd.AccountNr),
                    new XElement("VoucherRowAccountName", accountStd.Name),
                    new XElement("VoucherRowVoucherSerie", voucherRow.VoucherSeriesTypeNr),
                    new XElement("VoucherRowVoucherNr", voucherRow.VoucherNr),
                    new XElement("VoucherRowAccountAmount", invertRow ? Decimal.Negate(voucherRow.Amount) : voucherRow.Amount),
                    new XElement("VoucherRowText", voucherRow.Text),
                    new XElement("VoucherRowAccountDate", voucherRow.Date ?? voucherRow.Date),
                    new XElement("VoucherRowType", voucherType));

                for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                {
                    if (i > accountDimInternals.Count)
                    {
                        voucherRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                        continue;
                    }

                    AccountInternalDTO accountInternal = null;
                    AccountDimDTO accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;

                    if (accountDim != null)
                    {
                        if ((es.SSTD_AccountDimId != 0 && accountDim.AccountDimId == es.SSTD_AccountDimId) || es.SSTD_AccountDimId == 0)

                        {
                            accountInternal = (from ai in voucherRow.AccountInternalDTO_forReports
                                               where ai.AccountDimId == accountDim.AccountDimId
                                               select ai).FirstOrDefault<AccountInternalDTO>();
                        }
                    }
                    voucherRowElement.Add(
                        new XElement("AccountInternalNr" + i, accountInternal != null ? accountInternal.AccountNr : String.Empty),
                        new XElement("AccountInternalName" + i, accountInternal != null ? accountInternal.Name : String.Empty));
                }
                voucherRowElement.Add(
                        new XElement("VoucherRowReportHeaderName", reportHeaderName));
                voucherRowElements.Add(voucherRowElement);
            }

        }

        private void AddBalanceResultListVoucherRowElement(EvaluatedSelection es, List<XElement> voucherRowElements, List<VoucherRowDTO> voucherRowsForAccount, AccountDTO accountStd, List<AccountDimDTO> accountDimInternals, string voucherType, bool invertRow, DateTime voucherHeadDate, string reportHeaderName)
        {
            foreach (VoucherRowDTO voucherRow in voucherRowsForAccount)
            {
                //if (es.SSTD_IncludeMissingAccountDim && (es.SSTD_AccountDimId == voucherRow.Dim2Id || es.SSTD_AccountDimId == voucherRow.Dim3Id))
                //{
                //    continue;
                //}

                XElement voucherRowElement = new XElement("VoucherRow",
                    new XAttribute("id", voucherRowElements.Count + 1),
                    new XElement("VoucherRowAccountNr", accountStd.AccountNr),
                    new XElement("VoucherRowAccountName", accountStd.Name),
                    new XElement("VoucherRowVoucherSerie", voucherRow.VoucherSeriesTypeNr),
                    new XElement("VoucherRowVoucherNr", voucherRow.VoucherNr),
                    new XElement("VoucherRowAccountAmount", invertRow ? Decimal.Negate(voucherRow.Amount) : voucherRow.Amount),
                    new XElement("VoucherRowText", voucherRow.Text),
                    new XElement("VoucherRowAccountDate", voucherRow.Date ?? voucherHeadDate),
                    new XElement("VoucherRowType", voucherType));

                for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                {
                    if (i > accountDimInternals.Count)
                    {
                        voucherRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                        continue;
                    }

                    string accountNr = String.Empty;
                    string accountName = String.Empty;
                    switch (i)
                    {
                        case 1:
                            accountNr = voucherRow.Dim2Nr;
                            accountName = voucherRow.Dim2Name;
                            break;
                        case 2:
                            accountNr = voucherRow.Dim3Nr;
                            accountName = voucherRow.Dim3Name;
                            break;
                        case 3:
                            accountNr = voucherRow.Dim4Nr;
                            accountName = voucherRow.Dim4Name;
                            break;
                        case 4:
                            accountNr = voucherRow.Dim5Nr;
                            accountName = voucherRow.Dim5Name;
                            break;
                        case 5:
                            accountNr = voucherRow.Dim6Nr;
                            accountName = voucherRow.Dim6Name;
                            break;
                    }

                    voucherRowElement.Add(
                        new XElement("AccountInternalNr" + i, accountNr),
                        new XElement("AccountInternalName" + i, accountName));
                }
                voucherRowElement.Add(
                        new XElement("VoucherRowReportHeaderName", reportHeaderName));

                voucherRowElements.Add(voucherRowElement);
            }
        }

        #endregion

        #endregion

        #region BalanceList

        private XDocument CreateSupplierBalanceListData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierBalanceList");

            //SupplierBalanceList
            XElement supplierBalanceListElement = new XElement("SupplierBalanceList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSupplierReportHeaderLabelsElement();
            supplierBalanceListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(es);
            supplierBalanceListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSupplierBalanceListPageHeaderLabelsElement(pageHeaderLabelsElement);
            supplierBalanceListElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                if (!CreateBalanceListCommonContent(entities, es, supplierBalanceListElement, SoeOriginType.SupplierInvoice, SoeOriginType.SupplierPayment, false, false).Success)
                    return null;

                #endregion
            }

            #region Close document

            rootElement.Add(supplierBalanceListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierBalanceList);

            #endregion
        }

        private XDocument CreateCustomerBalanceListData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerBalanceList");

            //CustomerBalanceList
            XElement customerBalanceListElement = new XElement("CustomerBalanceList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateCustomerReportHeaderLabelsElement();
            customerBalanceListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(es);

            customerBalanceListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateCustomerBalanceListPageHeaderLabelsElement(pageHeaderLabelsElement);
            customerBalanceListElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                if (!CreateBalanceListCommonContent(entities, es, customerBalanceListElement, SoeOriginType.CustomerInvoice, SoeOriginType.CustomerPayment, true, false).Success)
                    return null;

                #endregion
            }

            #region Close document

            rootElement.Add(customerBalanceListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerBalanceList);

            #endregion
        }

        private XDocument CreateInterestRateCalculationData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerInterestRateCalculation");

            //CustomerBalanceList
            XElement interestRateCalculationElement = new XElement("CustomerInterestRateCalculation");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateInterestRateCalculationReportHeaderLabelsElement();
            interestRateCalculationElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, es.ActorCompanyId, 0);
            XElement reportHeaderElement = CreateInterestRateCalculationPageHeaderElement(es, interestPercent);
            interestRateCalculationElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateInterestRateCalculationPageHeaderLabelsElement(pageHeaderLabelsElement);
            interestRateCalculationElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content
                // muuta
                if (!CreateInterestRateCalculationCommonContent(entities, es, interestRateCalculationElement).Success)
                    return null;

                #endregion
            }

            #region Close document

            rootElement.Add(interestRateCalculationElement); // muuta
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.InterestRateCalculation);

            #endregion
        }

        #region Help-methods

        private ActionResult CreateBalanceListCommonContent(CompEntities entities, EvaluatedSelection es, XElement balanceListElement, SoeOriginType soeOriginTypeInvoice, SoeOriginType soeOriginTypePayment, bool includeHouseholdTaxDeduction, bool journal)
        {
            ActionResult result = new ActionResult(true);

            if (es == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EvaluatedSelection");
            if (balanceListElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #region Content

            // Increase the command timeout
            entities.CommandTimeout = 180; // 3 minutes

            //Get all items from selection
            var items = GetBalanceListItems(entities, es, soeOriginTypeInvoice, soeOriginTypePayment, journal);

            //Current Group holders
            GetReportBalanceListItemsResult currentGroupInvoice = null;
            XElement groupElement = null;
            int groupXmlId = 0;
            int originXmlId = 0;
            int actionId = 0;

            var invoiceItems = SortBalanceListInvoices(es, items, soeOriginTypeInvoice);
            var paymentMethodCache = new Dictionary<int, PaymentMethod>();

            foreach (var invoiceItem in invoiceItems)
            {
                if (!es.SL_IncludeCashSalesInvoices && invoiceItem.IsCashSale)
                {
                    continue;
                }
                // Dont print Invoices with OnlyPayment as a Action
                if (invoiceItem.OnlyPayment)
                {
                    continue;
                }
                #region Group

                DateTime groupDate = CalendarUtility.DATETIME_DEFAULT;

                //Check if group should be created
                if (groupElement == null || CheckNewBalanceListGroup(es, currentGroupInvoice, invoiceItem, groupXmlId))
                {
                    //Add group before create new
                    if (groupElement != null)
                    {
                        balanceListElement.Add(groupElement);
                    }

                    //Supplier
                    string actorNr = "";
                    string actorName = "";

                    if (es.SL_SortOrder == (int)SoeReportSortOrder.ActorNr || es.SL_SortOrder == (int)SoeReportSortOrder.ActorName)
                    {
                        actorNr = invoiceItem.ActorNr;
                        actorName = invoiceItem.ActorName;
                    }
                    else if (es.SL_SortOrder == (int)SoeReportSortOrder.Date)
                    {
                        if (es.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.InvoiceDate && invoiceItem.InvoiceDate.HasValue)
                            groupDate = invoiceItem.InvoiceDate.Value;
                        else if (es.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.VoucherDate && invoiceItem.VoucherDate.HasValue)
                            groupDate = invoiceItem.VoucherDate.Value;
                        else if (es.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.DueDate && invoiceItem.DueDate.HasValue)
                            groupDate = invoiceItem.DueDate.Value;
                        else if (es.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.PaymentDate && invoiceItem.PayDate.HasValue)
                            groupDate = invoiceItem.PayDate.Value;
                    }

                    currentGroupInvoice = invoiceItem;
                    groupXmlId++;
                    originXmlId = 0; //reset

                    string actorNrLabel = "";
                    string actorNameLabel = "";
                    if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                    {
                        actorNrLabel = "GroupSupplierNr";
                        actorNameLabel = "GroupSupplierName";
                    }
                    else if (soeOriginTypeInvoice == SoeOriginType.CustomerInvoice)
                    {
                        actorNrLabel = "GroupCustomerNr";
                        actorNameLabel = "GroupCustomerName";
                    }

                    groupElement = new XElement("Group",
                        new XAttribute("id", groupXmlId),
                        new XElement("GroupSumLabel", GetReportText(34, "Summa")),
                        new XElement("GroupType", es.SL_SortOrder),
                        new XElement(actorNrLabel, actorNr),
                        new XElement(actorNameLabel, actorName),
                        new XElement("GroupDate", groupDate),
                        new XElement("GroupDateType", es.SL_DateRegard));
                }

                #endregion

                #region Invoice

                #region Origin (identifier in group)

                DateTime originDate = invoiceItem.InvoiceDate ?? DateTime.Now;
                if (es.SL_SortOrder == (int)SoeReportSortOrder.Date)
                    originDate = groupDate;

                var paymentSuggestionItem = items.FirstOrDefault(r => r.InvoiceId == invoiceItem.InvoiceId && r.OriginType == (int)SoeOriginType.SupplierPayment);

                string projectNumber = "";
                string projectName = "";
                string workSiteKey = "";
                string workSiteNumber = "";
                bool originFullyPaid = false;

                if (invoiceItem.ProjectId > 0)
                {
                    Project project = ProjectManager.GetProject(invoiceItem.ProjectId, false);
                    if (project != null)
                    {
                        projectNumber = project.Number;
                        projectName = project.Name;
                        workSiteKey = project.WorkSiteKey;
                        workSiteNumber = project.WorkSiteNumber;
                    }
                }

                originXmlId++;
                actionId = 0; //reset
                XElement originElement = new XElement("Origin",
                    new XAttribute("id", originXmlId),
                    new XElement("OriginInvoiceNr", invoiceItem.InvoiceNr),
                    new XElement("OriginInvoiceSeqNr", invoiceItem.SeqNr ?? 0),
                    new XElement("PaymentSuggestionNr", paymentSuggestionItem?.SequenceNumber ?? 0),
                    new XElement("OriginFullyPayed", invoiceItem.FullyPayed),
                    new XElement("OriginInvoiceId", invoiceItem.InvoiceId),
                    new XElement("OriginDate", originDate),
                    new XElement("IsMatched", invoiceItem.IsMatched.ToInt()),
                    new XElement("IsMatchedAgainstInvoice", invoiceItem.IsMatchedAgainstInvoice.ToInt()),
                    new XElement("IsMatchedAgainstPayment", invoiceItem.IsMatchedAgainstPayment.ToInt()),
                    new XElement("MatchedNr", invoiceItem.MatchedNr),
                    new XElement("ProjectNumber", projectNumber),
                    new XElement("ProjectName", projectName),
                    new XElement("WorkSiteKey", workSiteKey),
                    new XElement("WorkSiteNumber", workSiteNumber),
                    new XElement("Description", invoiceItem.Description));

                #endregion

                #region Action (invoice)

                //Dont print Invoices with OnlyPayment as a Action
                if (!invoiceItem.OnlyPayment)
                {
                    //Add action to origin
                    actionId++;
                    originElement.Add(CreateBalanceListAction(es, invoiceItem, actionId, soeOriginTypeInvoice, soeOriginTypePayment, includeHouseholdTaxDeduction, paymentMethodCache));
                }

                #endregion

                #endregion

                #region Payments

                var paymentItems = (from i in items
                                    where ((i.OriginType == (int)soeOriginTypePayment) &&
                                    (i.InvoiceId == invoiceItem.InvoiceId) &&
                                    (i.InvoiceNr == invoiceItem.InvoiceNr))
                                    orderby i.PayDate, i.SeqNr
                                    select i).ToList();

                foreach (var paymentItem in paymentItems)
                {
                    #region Action (payment)

                    paymentItem.FullyPayed = invoiceItem.FullyPayed;

                    //Add action to origin
                    actionId++;
                    originElement.Add(CreateBalanceListAction(es, paymentItem, actionId, soeOriginTypeInvoice, soeOriginTypePayment, includeHouseholdTaxDeduction, paymentMethodCache));

                    #endregion
                }

                //Add origin to group
                if (!originFullyPaid)
                    groupElement.Add(originElement);

                #endregion
            }

            //Add last group
            if (groupElement != null)
            {
                balanceListElement.Add(groupElement);
            }

            #region Default element Group/Origin/Action

            if (groupXmlId == 0)
            {
                groupElement = new XElement("Group",
                    new XAttribute("id", 1));
                XElement originElement = new XElement("Origin",
                    new XAttribute("id", 1));
                XElement actionElement = new XElement("Action",
                    new XAttribute("id", 1));

                originElement.Add(actionElement);
                groupElement.Add(originElement);
                balanceListElement.Add(groupElement);
            }

            #endregion

            #endregion

            result.Success = true;
            result.Value = items;

            return result;
        }

        private ActionResult CreateInterestRateCalculationCommonContent(CompEntities entities, EvaluatedSelection es, XElement interestRateCalculationElement)
        {
            #region Prereq

            ActionResult result = new ActionResult(true);

            if (es == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EvaluatedSelection");
            if (interestRateCalculationElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #endregion

            #region Init

            int invoiceElementCount = 0;
            int customerElementCount = 0;

            int rateMinAmount = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestAccumulatedBeforeInvoice, 0, es.ActorCompanyId, 0);
            int rateMinDays = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerGracePeriodDays, 0, es.ActorCompanyId, 0);
            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, es.ActorCompanyId, 0);

            #endregion

            var invoiceItems = (from i in entities.Invoice.Include("Origin")
                                where i.Origin.ActorCompanyId == es.ActorCompanyId &&
                                i.FullyPayed &&
                                i.Origin.Type == (int)SoeOriginType.CustomerInvoice
                                select i).OrderBy(i => i.ActorId).ToList();

            if (es.SL_HasInvoiceSeqNrInterval)
            {
                invoiceItems = (from s in invoiceItems
                                where s.SeqNr >= es.SL_InvoiceSeqNrFrom &&
                                s.SeqNr <= es.SL_InvoiceSeqNrTo
                                select s).OrderBy(i => i.ActorId).ToList();

            }
            else if (es.SL_HasInvoiceIds)
            {
                invoiceItems = (from s in invoiceItems
                                where es.SL_InvoiceIds.Contains(s.InvoiceId)
                                select s).OrderBy(i => i.ActorId).ToList();
            }

            foreach (var group in invoiceItems.GroupBy(o => o.ActorId.Value))
            {
                invoiceElementCount = 0;

                Customer customer = CustomerManager.GetCustomer(group.Key);

                if (es.SL_HasActorNrInterval && !StringUtility.IsInInterval(customer.CustomerNr, es.SL_ActorNrFrom, es.SL_ActorNrTo))
                    continue;

                string customerNr = customer.CustomerNr;
                string customerName = customer.Name;
                string customerAddress = "", customerAddressCO = "", customerPostalCode = "", customerPostalAddress = "";

                Contact contact = ContactManager.GetContactAndEcomFromActor(entities, customer.ActorCustomerId);
                List<ContactAddress> contactAddresses = ContactManager.GetContactAddresses(entities, contact.ContactId);

                if (contactAddresses.Count > 0)
                {
                    ContactAddress billingAddress = contactAddresses.FirstOrDefault(i => i.SysContactAddressTypeId == (int)ContactAddressItemType.AddressBilling);

                    if (billingAddress != null)
                    {
                        foreach (ContactAddressRow addressRow in billingAddress.ContactAddressRow)
                        {
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.Address)
                                customerAddress = addressRow.Text;
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.AddressCO)
                                customerAddressCO = addressRow.Text;
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalCode)
                                customerPostalCode = addressRow.Text;
                            if (addressRow.SysContactAddressRowTypeId == (int)TermGroup_SysContactAddressRowType.PostalAddress)
                                customerPostalAddress = addressRow.Text;
                        }
                    }
                }

                XElement customerElement = new XElement("Customer");

                customerElement.Add(
                    new XElement("CustomerNr", customerNr),
                    new XElement("CustomerName", customerName),
                    new XElement("CustomerAddress", customerAddress),
                    new XElement("CustomerAddressCO", customerAddressCO),
                    new XElement("CustomerPostalCode", customerPostalCode),
                    new XElement("CustomerPostalAddress", customerPostalAddress));

                foreach (var item in group)
                {
                    List<PaymentRow> paymentRows = PaymentManager.GetPaymentRowsByInvoice(entities, item.InvoiceId).Where(i => i.Status != (int)SoePaymentStatus.Cancel && i.Status != (int)SoePaymentStatus.Error).OrderBy(i => i.PayDate).ToList();

                    if (paymentRows == null || paymentRows.Count == 0)
                        continue;

                    if (es.SL_PaymentRowIds != null && es.SL_PaymentRowIds.Count > 0)
                    {
                        var tempPaymentRows = new List<PaymentRow>();
                        foreach (var row in paymentRows)
                        {
                            if (es.SL_PaymentRowIds.Contains(row.PaymentRowId))
                                tempPaymentRows.Add(row);
                        }
                        paymentRows = tempPaymentRows;
                    }

                    // check that invoice has been dued more than grace period days
                    DateTime dateFrom = item.DueDate.Value;
                    DateTime dateTo = paymentRows.Select(i => i.PayDate).LastOrDefault();
                    int daysDued = Convert.ToInt32(dateTo.Subtract(dateFrom).TotalDays);

                    if (daysDued <= rateMinDays)
                        continue;

                    //invoice element                                                            
                    XElement invoiceElement = new XElement("Invoice");

                    invoiceElement.Add(
                            new XElement("InvoiceNr", item.InvoiceNr),
                            new XElement("InvoiceDate", item.InvoiceDate),
                            new XElement("InvoiceDueDate", item.DueDate),
                            new XElement("InvoiceTotalAmount", item.TotalAmount),
                            new XElement("InvoiceTotalVATAmount", item.VATAmount)
                        );

                    decimal interestAmount = 0;
                    DateTime interestDayFrom = item.DueDate.Value;
                    decimal openBalance = item.TotalAmount;

                    foreach (var payment in paymentRows)
                    {
                        //calculate interest days
                        int interestDays = Convert.ToInt32(payment.PayDate.Subtract(interestDayFrom).TotalDays);

                        //update start date for calculating interest amount (in case of several payments)
                        if (payment.PayDate >= interestDayFrom)
                            interestDayFrom = payment.PayDate;

                        //calculate interest amount from due date or previous payment date until next payment date
                        decimal paymentInterestAmount = 0;
                        if (interestDays > 0)
                            paymentInterestAmount = openBalance * Decimal.Divide(interestPercent, 100) * Decimal.Divide(interestDays, 365);

                        interestAmount += Math.Round(paymentInterestAmount, 2);

                        //update open balance for further interest amount calculation
                        openBalance -= payment.Amount;

                        XElement paymentElement = new XElement("Payment");

                        paymentElement.Add(
                                new XElement("PaymentSeqNr", payment.SeqNr),
                                new XElement("PaymentDate", payment.PayDate),
                                new XElement("PaymentAmount", payment.Amount),
                                new XElement("PaymentRateDays", interestDays > 0 ? interestDays : 0),
                                new XElement("PaymentRateAmount", Math.Round(paymentInterestAmount, 2))
                            );

                        invoiceElement.Add(paymentElement);
                    }

                    //Check that totalamount is larger than minimum amount in company setting
                    if (interestAmount < rateMinAmount)
                        continue;

                    customerElement.Add(invoiceElement);
                    invoiceElementCount++;
                }

                if (invoiceElementCount > 0)
                {
                    interestRateCalculationElement.Add(customerElement);
                    customerElementCount++;
                }
            }

            //add empty element if no other elements created
            if (customerElementCount == 0)
            {
                interestRateCalculationElement.Add(
                        new XElement("Customer",
                            new XElement("CustomerNr", string.Empty),
                            new XElement("CustomerName", string.Empty),
                            new XElement("CustomerAddress", string.Empty),
                            new XElement("CustomerAddressCO", string.Empty),
                            new XElement("CustomerPostalCode", string.Empty),
                            new XElement("Invoice",
                                new XElement("InvoiceNr", string.Empty),
                                new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("InvoiceDueDate", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("InvoiceTotalAmount", 0),
                                new XElement("InvoiceTotalVATAmount", 0),
                                new XElement("Payment",
                                    new XElement("PaymentSeqNr", 0),
                                    new XElement("PaymentDate", CalendarUtility.DATETIME_DEFAULT),
                                    new XElement("PaymentAmount", 0),
                                    new XElement("PaymentRateDays", 0),
                                    new XElement("PaymentRateAmount", 0)))));

            }

            return result;
        }

        private List<GetReportBalanceListItemsResult> SortBalanceListInvoices(EvaluatedSelection es, IEnumerable<GetReportBalanceListItemsResult> items, SoeOriginType soeOriginTypeInvoice)
        {
            List<GetReportBalanceListItemsResult> invoiceItems = new List<GetReportBalanceListItemsResult>();

            int invoiceType = (int)soeOriginTypeInvoice;

            int paymentType = (int)SoeOriginType.CustomerPayment;
            if (invoiceType == (int)SoeOriginType.SupplierInvoice)
                paymentType = (int)SoeOriginType.SupplierPayment;


            //Sort invoices according to given SortOrder
            switch (es.SL_SortOrder)
            {
                case (int)SoeReportSortOrder.SeqNr:
                    #region SeqNr

                    invoiceItems = (from i in items
                                    where i.OriginType == invoiceType ||
                                    (i.OriginType == paymentType && i.OnlyPayment)
                                    orderby i.SeqNr ascending
                                    select i).ToList();
                    break;

                #endregion
                case (int)SoeReportSortOrder.Date:
                    #region Date

                    //Sort invoices according to given DateType
                    switch (es.SL_DateRegard)
                    {
                        case (int)TermGroup_ReportLedgerDateRegard.InvoiceDate:
                            #region InvoiceDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.InvoiceDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                        #endregion
                        case (int)TermGroup_ReportLedgerDateRegard.VoucherDate:
                            #region VoucherDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.VoucherDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                        #endregion
                        case (int)TermGroup_ReportLedgerDateRegard.DueDate:
                            #region DueDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.DueDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                        #endregion
                        case (int)TermGroup_ReportLedgerDateRegard.PaymentDate:
                            #region PaymentDate

                            invoiceItems = (from i in items
                                            where i.OriginType == invoiceType ||
                                            (i.OriginType == paymentType && i.OnlyPayment)
                                            orderby i.PayDate ascending, i.SeqNr ascending
                                            select i).ToList();
                            break;

                            #endregion
                    }
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorNr:
                    #region ActorNr

                    invoiceItems = (from i in items
                                    where i.OriginType == invoiceType ||
                                    (i.OriginType == paymentType && i.OnlyPayment)
                                    orderby i.ActorNr ascending, i.SeqNr ascending
                                    select i).ToList();
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorName:
                    #region ActorName

                    invoiceItems = (from i in items
                                    where i.OriginType == invoiceType ||
                                    (i.OriginType == paymentType && i.OnlyPayment)
                                    orderby i.ActorName ascending, i.SeqNr ascending
                                    select i).ToList();
                    break;
                    #endregion
            }

            return invoiceItems;
        }

        private XElement CreateBalanceListAction(EvaluatedSelection es, GetReportBalanceListItemsResult item, int actionXmlId, SoeOriginType soeOriginTypeInvoice, SoeOriginType soeOriginTypePayment, bool includeHouseholdTaxDeduction, Dictionary<int, PaymentMethod> paymentMethodCache)
        {
            using (CompEntities entities = new CompEntities())
            {
                bool isCustomerInvoice = soeOriginTypeInvoice == SoeOriginType.CustomerInvoice;
                bool isSupplierInvoice = soeOriginTypeInvoice == SoeOriginType.SupplierInvoice;
                bool hasVoucher = item.HasVoucher == true;
                bool showVoucher = es.SL_ShowVoucher && hasVoucher;

                Currency baseCurrency = CountryCurrencyManager.GetCurrencyFromType(es.ActorCompanyId, TermGroup_CurrencyType.TransactionCurrency);
                Currency ledgerCurrency = CountryCurrencyManager.GetCurrencyWithCode(item.ActorCurrencyId);

                //ActionAmount should be zero if a invoice is fully payed (see above) and a negative value if it is a payment
                decimal actionAmount = 0;
                decimal actionAmountCurrency = 0;
                decimal actionAmountEntCurrency = 0;
                decimal actionAmountLedgerCurrency = 0;

                paymentMethodCache.TryGetValue(item.PaymentMethodId, out PaymentMethod paymentMethod);
                if (item.PaymentMethodId > 0 && paymentMethod == null)
                {
                    paymentMethod = PaymentManager.GetPaymentMethod(item.PaymentMethodId, es.ActorCompanyId, false);
                    if (paymentMethod != null)
                    {
                        paymentMethodCache.Add(paymentMethod.PaymentMethodId, paymentMethod);
                    }
                }

                PaymentInformationRow mtdPaymentInformationRow = paymentMethod?.PaymentInformationRow;

                if (!item.FullyPayed)
                {
                    if (item.OriginType == (int)soeOriginTypePayment)
                    {
                        actionAmount = decimal.Negate(item.PaymentAmount);
                        actionAmountCurrency = decimal.Negate(item.PaymentAmountCurrency);
                        actionAmountEntCurrency = decimal.Negate(item.PaymentAmountEntCurrency);
                        actionAmountLedgerCurrency = decimal.Negate(item.PaymentAmountLedgerCurrency);
                    }
                    else
                    {
                        actionAmount = item.InvoiceTotalAmount;
                        actionAmountCurrency = item.InvoiceTotalAmountCurrency;
                        actionAmountEntCurrency = item.InvoiceTotalAmountEntCurrency;
                        actionAmountLedgerCurrency = item.InvoiceTotalAmountLedgerCurrency;
                    }
                }

                XElement actionElement = new XElement("Action",
                    new XAttribute("id", actionXmlId),
                    new XElement("ActionType", item.OriginType), //SupplierInvoice, CustomerInvoice or Payment
                    new XElement("ActionShowVoucher", showVoucher.ToInt()),
                    new XElement("ActionAmount", actionAmount),
                    new XElement("ActionAmountCurrency", actionAmountCurrency),
                    new XElement("ActionAmountEntCurrency", actionAmountEntCurrency),
                    new XElement("ActionAmountLedgerCurrency", actionAmountLedgerCurrency),
                    new XElement(isCustomerInvoice ? "ActionCustomerName" : "ActionSupplierName", item.ActorName));

                if (isSupplierInvoice)
                {
                    PaymentInformationRow paymentInformationRow = PaymentManager.GetPaymentInformationRowForActor(entities, item.ActorId.GetValueOrDefault(), item.PaymentNr);
                    actionElement.Add(
                       new XElement("ActionSupplierNr", item.ActorNr),
                       new XElement("ActionInvoiceReferenceOur", item.ReferenceOur),
                       new XElement("ActionPaymentmethodBIC", mtdPaymentInformationRow?.BIC ?? string.Empty),
                       new XElement("ActionPaymentmethodPaymentNr", mtdPaymentInformationRow?.PaymentNr ?? string.Empty),
                       new XElement("ActionPaymentSeqNr", item.SeqNr ?? 0),
                       new XElement("ActionPaymentBIC", paymentInformationRow?.BIC ?? string.Empty),
                       new XElement("ActionPaymentNr", item.PaymentNr));
                }

                actionElement.Add(
                    new XElement("ActionBatchId", hasVoucher && item.VoucherHeadId.HasValue ? item.VoucherHeadId.Value : 0),
                    new XElement("ActionBatchUser", hasVoucher ? item.VoucherCreatedBy : ""),
                    new XElement("ActionAccountYear", item.AccountYearFrom.ToString("yyyyMM") + "-" + item.AccountYearTo.ToString("yyyyMM")),
                    new XElement("ActionVoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                    new XElement("ActionVoucherDate", item.VoucherDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("ActionVoucherNr", item.VoucherNr ?? 0),
                    //Invoice
                    new XElement("ActionInvoiceBillingType", item.BillingTypeName),
                    new XElement("ActionInvoiceSeqNr", item.SeqNr ?? 0), //Should always have value. Only Drafts have null SeqNr, and Drafts should not be included in any reports
                    new XElement("ActionInvoiceDate", item.InvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("ActionInvoiceDueDate", item.DueDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("ActionInvoiceNr", item.InvoiceNr),
                    new XElement("ActionInvoiceOcr", item.InvoiceOCR),
                    new XElement("ActionInvoiceTotalAmount", item.InvoiceTotalAmount),
                    new XElement("ActionInvoiceTotalAmountCurrency", item.InvoiceTotalAmountCurrency),
                    new XElement("ActionInvoiceVATAmount", item.InvoiceVATAmount));

                actionElement.Add(
                     new XElement("ActionInvoiceCurrency", item.CurrencyCode),
                     new XElement("ActionInvoiceCurrencyRate", item.CurrencyRate),
                     new XElement("ActionInvoiceTotalAmountEntCurrency", item.InvoiceTotalAmountEntCurrency),
                     new XElement("ActionInvoiceTotalAmountLedgerCurrency", item.InvoiceTotalAmountLedgerCurrency),
                     new XElement("ActionInvoiceVatType", item.VatType),
                     new XElement("ActionInvoiceId", item.InvoiceId),
                     //Payment
                     new XElement("ActionPaymentDate", item.PayDate ?? CalendarUtility.DATETIME_DEFAULT),
                     new XElement("ActionPaymentAmount", item.PaymentAmount),
                     new XElement("ActionPaymentAmountCurrency", item.PaymentAmountCurrency),
                     new XElement("ActionPaymentCurrency", item.CurrencyCode),
                     new XElement("ActionPaymentCurrencyRate", item.CurrencyRate),
                     new XElement("ActionPaymentAmountEntCurrency", item.PaymentAmountEntCurrency),
                     new XElement("ActionPaymentAmountLedgerCurrency", item.PaymentAmountLedgerCurrency),
                     new XElement("ActionPaymentmethod", item.PaymentMethodName),
                     new XElement("ActionCurrencyName", baseCurrency?.Name ?? ""),
                     new XElement("ActionCurrencyCode", baseCurrency?.Code ?? ""),
                     new XElement("ActionLedgerCurrencyName", ledgerCurrency?.Name ?? ""),
                     new XElement("ActionLedgerCurrencyCode", ledgerCurrency?.Code ?? ""));

                if (isSupplierInvoice)
                {
                    actionElement.Add(
                    new XElement("ActionInvoiceTimeDiscountDate", item.TimeDiscountDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("ActionInvoiceTimeDiscountPercent", item.TimeDiscountPercent != null ? item.TimeDiscountPercent : 0),
                    new XElement("ActionPaymentIsSuggestion", item.PaymentIsSuggestion.ToInt()));
                }

                if (soeOriginTypeInvoice == SoeOriginType.CustomerInvoice)
                {
                    actionElement.Add(
                        new XElement("ActionInvoiceCentRounding", item.InvoiceCentRounding));
                }

                if (isCustomerInvoice && includeHouseholdTaxDeduction && item.HasHouseholdTaxDeduction)
                {
                    int householdTaxDeductionRowXmlId = 1;
                    List<HouseholdTaxDeductionRow> householdTaxDeductionRows = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRows(item.InvoiceId);
                    foreach (HouseholdTaxDeductionRow householdTaxDeductionRow in householdTaxDeductionRows)
                    {
                        actionElement.Add(new XElement("HouseholdTaxDeductionRow",
                            new XAttribute("id", householdTaxDeductionRowXmlId),
                            new XElement("CustomerInvoiceId", item.InvoiceId),
                            new XElement("Property", householdTaxDeductionRow.Property),
                            new XElement("ApartmentNr", householdTaxDeductionRow.ApartmentNr),
                            new XElement("CooperativeOrgNr", householdTaxDeductionRow.CooperativeOrgNr),
                            new XElement("SocialSecNr", householdTaxDeductionRow.SocialSecNr),
                            new XElement("Name", householdTaxDeductionRow.Name),
                            new XElement("Amount", householdTaxDeductionRow.Amount),
                            new XElement("AmountCurrency", householdTaxDeductionRow.AmountCurrency),
                            new XElement("AmountEntCurrency", householdTaxDeductionRow.AmountEntCurrency),
                            new XElement("AmountLedgerCurrency", householdTaxDeductionRow.AmountLedgerCurrency),
                            new XElement("SequenceNumber", householdTaxDeductionRow.SeqNr),
                            new XElement("Applied", householdTaxDeductionRow.Applied.ToInt()),
                            new XElement("AppliedDate", householdTaxDeductionRow.AppliedDate ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Received", householdTaxDeductionRow.Received.ToInt()),
                            new XElement("ReceivedDate", householdTaxDeductionRow.ReceivedDate ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement("Denied", householdTaxDeductionRow.Denied.ToInt()),
                            new XElement("DeniedDate", householdTaxDeductionRow.DeniedDate ?? CalendarUtility.DATETIME_DEFAULT)));

                        householdTaxDeductionRowXmlId++;
                    }
                }
                return actionElement;
            }
        }

        private List<GetReportBalanceListItemsResult> SetGetReportBalanceListItemsResultTexts(List<GetReportBalanceListItemsResult> items)
        {
            if (items.IsNullOrEmpty())
                return new List<GetReportBalanceListItemsResult>();

            var langId = base.GetLangId();
            var billingTypeTexts = base.GetTermGroupDict(TermGroup.InvoiceBillingType, langId);

            items.ForEach(i =>
            {
                i.BillingTypeName = i.BillingTypeId != 0 ? billingTypeTexts[i.BillingTypeId] : "";
                i.CurrencyCode = CountryCurrencyManager.GetCurrencyCode(i.SysCurrencyId);
            });

            return items;
        }

        private List<GetReportBalanceListItemsResult> GetBalanceListItems(CompEntities entities, EvaluatedSelection es, SoeOriginType soeOriginTypeInvoice, SoeOriginType soeOriginTypePayment, bool journal)
        {
            List<GetReportBalanceListItemsResult> evaluatedItems = new List<GetReportBalanceListItemsResult>();

            #region Prereq

            int invoiceType = (int)soeOriginTypeInvoice;
            int paymentType = (int)soeOriginTypePayment;
            bool showPending = false;
            DateTime reconciliationDateFrom = CalendarUtility.GetFirstDateOfMonth(DateTime.Now);
            DateTime reconciliationDateTo = CalendarUtility.GetLastDateOfMonth(DateTime.Now);
            if (es.DateTo.Year != 9999)
            {
                reconciliationDateFrom = CalendarUtility.GetFirstDateOfMonth(es.DateTo);
                reconciliationDateTo = CalendarUtility.GetLastDateOfMonth(es.DateTo);
                reconciliationDateTo = CalendarUtility.GetEndOfDay(reconciliationDateTo);
            }
            if (es.DateFrom.Year != 1753)
            {
                reconciliationDateFrom = CalendarUtility.GetFirstDateOfMonth(es.DateFrom);
            }
            if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
            {
                if (es.ReportTemplateType == SoeReportTemplateType.SupplierBalanceList)
                {
                    showPending = es.SL_ShowPendingPaymentsInReport;
                }
                else
                {
                    showPending = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.SupplierInvoiceReportShowPendingPayments, es.UserId, es.ActorCompanyId, 0);
                }
            }

            var items = entities.GetReportBalanceListItems(es.ActorCompanyId, invoiceType, paymentType).ToList();
            items = SetGetReportBalanceListItemsResultTexts(items);

            var invoicePaymentMatchingItems = InvoiceManager.GetInvoicePaymentMatches(entities, es.ActorCompanyId, es.DateFrom, DateTime.Now);

            #endregion

            #region InvoiceSeqNr

            if (es.SL_HasInvoiceSeqNrInterval)
            {
                items = FilterReportBalanceItemsOnSeqNr(es, items, invoiceType, paymentType);
            }

            if (!es.SL_ShowPreliminaryInvoices)
            {
                items = FilterReportBalanceItemsOnOriginStatus(es, items, invoiceType, paymentType);
            }

            #endregion

            #region DateRegard

            if (es.HasDateInterval)
            {
                items = FilterReportBalanceItemsOnDateRegard(es, items, invoiceType, paymentType, reconciliationDateFrom, reconciliationDateTo);
            }

            #endregion


            var itemsLookup = items.ToLookup(p => new { p.OriginType, p.InvoiceId });

            var invoiceItems = (from i in items
                                where (i.OriginType == invoiceType ||
                                (i.OriginType == paymentType
                                && i.OnlyPayment
                                ))
                                select i).ToList();

            foreach (var invoiceItem in invoiceItems)
            {
                bool valid = false;

                #region InvoiceSeqNrList

                //Reset
                valid = false;

                if (es.SL_HasInvoiceIds)
                {
                    //Validate each item against the list of InvoiceSeqNr
                    foreach (int invoiceId in es.SL_InvoiceIds)
                    {
                        if (invoiceItem.InvoiceId == invoiceId)
                        {
                            valid = true;
                            break;
                        }
                    }
                }
                else
                {
                    valid = true;
                }

                if (!valid)
                    continue;

                #endregion

                #region ActorNr

                //Reset
                valid = false;

                if (es.SL_HasActorNrInterval)
                {
                    //Validate against ActorNr
                    if (StringUtility.IsInInterval(invoiceItem.ActorNr, es.SL_ActorNrFrom, es.SL_ActorNrTo))
                        valid = true;
                }
                else
                {
                    valid = true;
                }
                if (!valid)
                    continue;

                //Invoice with Totalsum
                if ((es.SL_InvoiceSelection == 4 || es.SL_InvoiceSelection == 5) && invoiceItem.InvoiceTotalAmount == 0)
                    continue;

                #endregion

                #region Payments and matches

                int invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                var validatedPaymentItems = new List<GetReportBalanceListItemsResult>();

                var paymentItems = itemsLookup[new { OriginType = paymentType, InvoiceId = invoiceItem.InvoiceId }].Where(x => !x.OnlyPayment).ToList();

                if (es.SL_PaymentRowIds != null && es.SL_PaymentRowIds.Count > 0)
                {
                    var tempPaymentRows = new List<GetReportBalanceListItemsResult>();
                    foreach (var row in paymentItems)
                    {
                        if (es.SL_PaymentRowIds.Contains(row.PaymentRowId))
                            tempPaymentRows.Add(row);
                    }
                    paymentItems = tempPaymentRows;
                }

                #region Invoice matched

                List<InvoicePaymentMatchingView> matches = new List<InvoicePaymentMatchingView>();
                List<InvoicePaymentMatchingView> allMatches = new List<InvoicePaymentMatchingView>();

                int[] invoicePaymentMatchingId = invoicePaymentMatchingItems.Where(i => i.RecordId == invoiceItem.InvoiceId).Select(i => i.InvoicePaymentMatchingId).ToArray();
                for (int j = 0; j < invoicePaymentMatchingId.Length; j++)
                {
                    //collect first all matches
                    allMatches = invoicePaymentMatchingItems.Where(i => i.InvoicePaymentMatchingId == invoicePaymentMatchingId[j] && i.RecordId != invoiceItem.InvoiceId).ToList();

                    int paymentMatchingId = invoicePaymentMatchingId[j];
                    foreach (var tmpMatch in allMatches)
                    {
                        //compare to voucher date if voucher is created
                        var invoicePaymentMatchingRecord = (from i in entities.InvoicePaymentMatchingRecord
                                                            where i.InvoicePaymentMatchingId == paymentMatchingId
                                                            select i).FirstOrDefault();

                        if (invoicePaymentMatchingRecord?.VoucherId != null)
                        {
                            var voucherHead = (from i in entities.VoucherHead
                                               where i.ActorCompanyId == es.ActorCompanyId &&
                                               i.VoucherHeadId == invoicePaymentMatchingRecord.VoucherId
                                               select i).FirstOrDefault();

                            if (voucherHead.Date < es.DateTo || es.DateTo.Year == 1900)
                                matches.Add(tmpMatch);
                        }
                        else
                        {
                            //compare to created date if voucher is not created
                            if (tmpMatch.Created < es.DateTo || es.DateTo.Year == 1900)
                                matches.Add(tmpMatch);
                        }
                    }

                    bool isMatchCodeUsed = matches.Any(i => i.MatchCodeId != null && i.MatchCodeId != 0);

                    //invoice is fully paid if match code is used
                    if (isMatchCodeUsed)
                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;

                    if (!isMatchCodeUsed && matches.Any())
                    {
                        List<string> matchedInvoiceNr = new List<string>();

                        for (int i = 0; i < matches.Where(m => m.Created < es.DateTo || (es.DateTo.Year == 1900 && m.Created <= DateTime.Now)).ToList().Count; i++)
                        {
                            var match = matches[i];
                            if (i == 0)
                            {
                                invoiceItem.IsMatched = true;
                                invoiceItem.IsMatchedAgainstInvoice = match.IsInvoice;
                                invoiceItem.IsMatchedAgainstPayment = match.IsPayment;
                            }
                            //if (!String.IsNullOrEmpty(invoiceItem.MatchedNr))
                            matchedInvoiceNr.Add(match.InvoiceNr);

                            // do not update payment amount when origin is payment because payment amount is already correct
                            if (invoiceItem.OriginType != (int)SoeOriginType.CustomerPayment)
                            {
                                if (match.InvoiceId == null && match.IsPayment)
                                {
                                    // invoice total amount is null when matched invoice is actually prepayment
                                    invoiceItem.PaymentAmount += match.PaymentAmount ?? 0;
                                    invoiceItem.PaymentAmountCurrency += match.PaymentAmountCurrency ?? 0;
                                    invoiceItem.PaymentAmountLedgerCurrency += match.PaymentAmountLedgerCurrency ?? 0;
                                    invoiceItem.PaymentAmountEntCurrency += match.PaymentAmountEntCurrency ?? 0;
                                }
                                else
                                {
                                    invoiceItem.PaymentAmount += (match.InvoiceTotalAmount ?? match.Amount) ?? 0;
                                    invoiceItem.PaymentAmountCurrency += (match.InvoiceTotalAmountCurrency ?? match.Amount) ?? 0;
                                    invoiceItem.PaymentAmountLedgerCurrency += (match.InvoiceTotalAmountLedgerCurrency ?? match.Amount) ?? 0;
                                    invoiceItem.PaymentAmountEntCurrency += (match.InvoiceTotalAmountEntCurrency ?? match.Amount) ?? 0;
                                }
                            }
                            if (invoiceItem.PaymentAmount != 0 && Math.Abs(invoiceItem.PaymentAmount) >= Math.Abs(invoiceItem.InvoiceTotalAmount))
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                        }

                        invoiceItem.MatchedNr = matchedInvoiceNr.Distinct().ToCommaSeparated();
                    }
                }
                #endregion

                #region Calculate payments

                decimal payedAmount = invoiceItem.PaymentAmount;

                var lastPayment = paymentItems.OrderByDescending(i => i.PayDate).FirstOrDefault();
                bool isPayed = false;
                bool isPayedSet = false;

                foreach (var paymentItem in paymentItems)
                {
                    #region Payment

                    //PayDate
                    if (es.HasDateInterval && soeOriginTypeInvoice == SoeOriginType.SupplierInvoice && paymentItem.PayDate < es.DateFrom)
                        continue;

                    //PaymentAmount
                    payedAmount += paymentItem.PaymentAmount;

                    bool isFullyPayed = invoiceItem.FullyPayed;

                    if (paymentItem.Status == (int)SoePaymentStatus.Checked || paymentItem.Status == (int)SoePaymentStatus.Cancel || paymentItem.Status == (int)SoePaymentStatus.ManualPayment || (paymentItem.Status == (int)SoePaymentStatus.Pending && journal && showPending))
                    {
                        if (!isPayedSet)
                        {
                            isPayed = invoiceItem.FullyPayed;
                            isPayedSet = true;
                        }
                    }
                    else
                    {
                        isPayed = false;
                        isPayedSet = true;
                    }

                    if (journal)
                    {
                        isPayed = invoiceItem.FullyPayed;
                    }
                    else
                    {
                        if (!isPayed)
                        {
                            isFullyPayed = isPayed;
                        }
                    }

                    if (isFullyPayed)
                    {
                        //Check last payment                        
                        if (es.HasDateInterval && es.SL_DateRegard == (int)TermGroup_ReportLedgerDateRegard.VoucherDate && lastPayment != null && lastPayment.VoucherDate > es.DateTo)
                            isFullyPayed = false;
                        else if (es.HasDateInterval && lastPayment != null && lastPayment.PayDate > es.DateTo)
                            isFullyPayed = false;
                        else if (lastPayment != null && lastPayment.Status == (int)SoePaymentStatus.Pending && !journal)
                            isFullyPayed = false;
                    }

                    if (isFullyPayed)
                    {
                        if (showPending && paymentItem.Status == (int)SoePaymentStatus.Pending)
                            invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
                        else
                            invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                    }
                    else
                    {
                        if (invoiceItem.InvoiceTotalAmount >= 0)
                        {
                            //Debit
                            if (payedAmount == 0)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount > 0 && payedAmount != invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount > 0 && payedAmount != invoiceItem.InvoiceTotalAmount)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
                            else if (payedAmount > 0 && payedAmount == invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount > 0 && payedAmount == invoiceItem.InvoiceTotalAmount && lastPayment.Status != (int)SoePaymentStatus.Pending && !journal)
                            {
                                if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                                {
                                    if (es.HasDateInterval && lastPayment != null && lastPayment.PayDate > es.DateTo)
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                    else
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                                }
                                else if (es.HasDateInterval && lastPayment != null && (lastPayment.PayDate < es.DateFrom || lastPayment.PayDate > es.DateTo))
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                else
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                            }

                            if (!isPayed && soeOriginTypeInvoice != SoeOriginType.CustomerInvoice && !journal)
                            {
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            }
                        }
                        else
                        {
                            //Credit
                            if (payedAmount == 0)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount < 0 && payedAmount != invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount < 0 && payedAmount != invoiceItem.InvoiceTotalAmount)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;
                            else if (payedAmount < 0 && payedAmount == invoiceItem.InvoiceTotalAmount && paymentItem.Status == (int)SoePaymentStatus.Pending && !journal)
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            else if (payedAmount < 0 && payedAmount == invoiceItem.InvoiceTotalAmount && lastPayment.Status != (int)SoePaymentStatus.Pending && !journal)
                                if (soeOriginTypeInvoice == SoeOriginType.SupplierInvoice)
                                    if (es.HasDateInterval && lastPayment != null && lastPayment.PayDate > es.DateTo)
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                    else
                                        invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                                else if (es.HasDateInterval && lastPayment != null && (lastPayment.PayDate < es.DateFrom || lastPayment.PayDate > es.DateTo))
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                                else
                                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;
                            if (!isPayed && soeOriginTypeInvoice != SoeOriginType.CustomerInvoice && !journal)
                            {
                                invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed;
                            }
                        }
                    }

                    validatedPaymentItems.Add(paymentItem);

                    #endregion
                }

                #endregion


                //consider as fully paid when invoice is marked as fully paid and still not having any matches or payments  
                //why this? 
                //Because Finnish car dealers are having their cash invoices in A/R, and those invoices are not having
                //any payment or match. Those invoices does not belong to balance list, and this is the only way to catch them -Nancy-
                if (invoiceItem.FullyPayed && allMatches.Count == 0 && paymentItems.Count == 0)
                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed;

                //consider payment without invoice as partly paid when it's not matched against any invoice and it has "open balance"
                if (invoiceItem.OnlyPayment && allMatches.Count == 0)
                    invoiceStatus = (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed;

                invoiceItem.FullyPayed = (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed);

                #endregion

                #region InvoiceSelection

                if (IsInvoiceStatusValid(es.SL_InvoiceSelection, invoiceStatus, reconciliationDateFrom, reconciliationDateTo, invoiceItem.InvoiceDate, invoiceItem.VoucherDate, invoiceItem.PayDate))
                {
                    evaluatedItems.Add(invoiceItem);
                    if (invoiceItem.IsMatched)
                    {
                        evaluatedItems.AddRange(validatedPaymentItems.DistinctBy(x => x.PaymentRowId).ToList());
                    }
                    else
                    {
                        evaluatedItems.AddRange(validatedPaymentItems);
                    }
                }

                #endregion
            }

            return evaluatedItems;
        }

        private bool IsInvoiceStatusValid(int invoiceSelection, int invoiceStatus, DateTime reconciliationDateFrom, DateTime reconciliationDateTo, DateTime? invoiceDate, DateTime? voucherDate, DateTime? payDate)
        {
            bool valid = false;

            if (invoiceSelection == invoiceStatus)
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed && (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed || invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed))
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayedAndPartlyPayed && (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed || invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed))
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayedAndPartlyPayed && (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.FullyPayed || invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed))
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.All)
                valid = true;
            if (invoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.Reconciliation)
            {
                if (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.NotPayed && invoiceDate < reconciliationDateFrom)
                    valid = true;
                if (invoiceStatus == (int)TermGroup_ReportLedgerInvoiceSelection.PartlyPayed && invoiceDate < reconciliationDateFrom)
                    valid = true;
                if ((invoiceDate >= reconciliationDateFrom && invoiceDate <= reconciliationDateTo) ||
                    (voucherDate >= reconciliationDateFrom && voucherDate <= reconciliationDateTo)
                     || (payDate >= reconciliationDateFrom)
                    )
                    valid = true;
            }

            return valid;
        }

        private List<GetReportBalanceListItemsResult> FilterReportBalanceItemsOnSeqNr(EvaluatedSelection es, List<GetReportBalanceListItemsResult> items, int invoiceType, int paymentType)
        {
            var filteredItems = new List<GetReportBalanceListItemsResult>();
            if (es == null || items == null)
                return filteredItems;

            var paymentItems = new List<GetReportBalanceListItemsResult>();

            var invoiceItems = (from i in items
                                where i.SeqNr >= es.SL_InvoiceSeqNrFrom &&
                                i.SeqNr <= es.SL_InvoiceSeqNrTo &&
                                (i.OriginType == invoiceType ||
                                (i.OriginType == paymentType && i.OnlyPayment))
                                select i).ToList();

            //Start with invoices, and then fetch all payments from those invoices
            foreach (var invoice in invoiceItems)
            {
                var paymentsForInvoice = items.Where(i => i.OriginType == paymentType && !i.OnlyPayment && i.InvoiceId == invoice.InvoiceId).ToList();
                if (paymentsForInvoice.Any() && !paymentItems.Any(i => i.PaymentRowId == invoice.PaymentRowId))
                    paymentItems.AddRange(paymentsForInvoice);
            }

            filteredItems.AddRange(invoiceItems);
            filteredItems.AddRange(paymentItems);

            return filteredItems;
        }

        private List<GetReportBalanceListItemsResult> FilterReportBalanceItemsOnOriginStatus(EvaluatedSelection es, List<GetReportBalanceListItemsResult> items, int invoiceType, int paymentType)
        {
            var filteredItems = new List<GetReportBalanceListItemsResult>();
            if (es == null || items == null)
                return filteredItems;

            var invoiceItems = (from i in items
                                where i.Status > 1 &&
                                (i.OriginType == invoiceType ||
                                (i.OriginType == paymentType && i.OnlyPayment))
                                select i).ToList();

            //Start with invoices, and then fetch all payments from those invoices

            var invoiceIds = invoiceItems.Select(i => i.InvoiceId).ToList();
            var paymentItems = items.Where(i => i.OriginType == paymentType && !i.OnlyPayment && invoiceIds.Contains(i.InvoiceId)).Distinct().ToList();

            filteredItems.AddRange(invoiceItems);
            filteredItems.AddRange(paymentItems);

            return filteredItems;
        }

        private List<GetReportBalanceListItemsResult> FilterReportBalanceItemsOnDateRegard(EvaluatedSelection es, List<GetReportBalanceListItemsResult> items, int invoiceType, int paymentType, DateTime reconciliationDateFrom, DateTime reconciliationDateTo)
        {
            if (es == null || items == null)
                return new List<GetReportBalanceListItemsResult>();

            var filteredItems = new List<GetReportBalanceListItemsResult>();

            switch (es.SL_DateRegard)
            {
                case (int)TermGroup_ReportLedgerDateRegard.InvoiceDate:
                    #region InvoiceDate

                    List<GetReportBalanceListItemsResult> invoiceItems = null;

                    if (es.SL_ShowPreliminaryInvoices)
                    {
                        invoiceItems = (from i in items
                                        where
                                        (i.OriginType == invoiceType || (i.OriginType == paymentType && i.OnlyPayment)
                                        && (i.InvoiceDate == null || (i.InvoiceDate >= es.DateFrom && i.InvoiceDate <= es.DateTo))
                                        )
                                        select i).ToList();
                    }
                    else
                    {
                        if (es.SL_InvoiceSelection == (int)TermGroup_ReportLedgerInvoiceSelection.Reconciliation)
                        {
                            invoiceItems = (from i in items
                                            where
                                            (i.OriginType == invoiceType || i.OriginType == paymentType)
                                            && ((i.InvoiceDate >= reconciliationDateFrom && i.InvoiceDate <= reconciliationDateTo)
                                                || (i.PayDate <= reconciliationDateFrom && !i.FullyPayed && i.OriginType == invoiceType)
                                                || (i.PayDate >= reconciliationDateFrom && i.OriginType == invoiceType)
                                                || ((i.PayDate >= reconciliationDateFrom && i.OriginType == invoiceType) &&
                                                    (i.PayDate <= reconciliationDateTo && i.OriginType == paymentType))
                                            )
                                            select i).ToList();

                        }
                        else
                        {
                            invoiceItems = (from i in items
                                            where ((i.OriginType == invoiceType || (i.OriginType == paymentType && i.OnlyPayment)) && (i.InvoiceDate >= es.DateFrom && i.InvoiceDate <= es.DateTo))
                                            select i).ToList();
                        }
                    }

                    // Start with invoices, and then fetch all payments from those invoices
                    var invoiceIdsForInvoiceDate = invoiceItems.Select(i => i.InvoiceId).Distinct().ToList();
                    var paymentsForInvoice = items.Where(i => i.OriginType == paymentType && !i.OnlyPayment && invoiceIdsForInvoiceDate.Contains(i.InvoiceId)).ToList();

                    filteredItems.AddRange(paymentsForInvoice);
                    filteredItems.AddRange(invoiceItems);
                    break;
                #endregion
                case (int)TermGroup_ReportLedgerDateRegard.VoucherDate:
                    #region VoucherDate

                    filteredItems = (from i in items
                                     where ((i.OriginType == paymentType && (i.PayDate >= es.DateFrom && i.PayDate <= es.DateTo)) ||
                                            (i.OriginType == paymentType && (i.PayDate >= es.DateTo)) ||
                                            (i.OriginType == invoiceType && (i.VoucherDate >= es.DateFrom && i.VoucherDate <= es.DateTo)))
                                     select i).ToList();

                    var tempInvoiceItems = (from j in items
                                            where (j.OriginType == invoiceType && (j.VoucherDate < es.DateFrom || j.VoucherDate > es.DateTo))
                                            select j).ToList();

                    if (tempInvoiceItems.Any())
                    {
                        var invoiceIds = tempInvoiceItems.Select(i => i.InvoiceId).ToList();
                        var paymentsForInvoice2 = items.Where(i => i.OriginType == paymentType && invoiceIds.Contains(i.InvoiceId) &&
                                                                 (i.PayDate >= es.DateFrom && i.PayDate <= es.DateTo)).ToList();

                        invoiceIds = paymentsForInvoice2.Select(i => i.InvoiceId).Distinct().ToList();

                        foreach (var invoice in tempInvoiceItems.Where(i => invoiceIds.Contains(i.InvoiceId)).ToList())
                        {
                            invoice.InvoiceTotalAmount = 0;
                            filteredItems.Add(invoice);
                        }
                    }

                    break;
                #endregion
                case (int)TermGroup_ReportLedgerDateRegard.DueDate:
                    #region DueDate

                    filteredItems = (from i in items
                                     where (i.DueDate >= es.DateFrom && i.DueDate <= es.DateTo)
                                     select i).ToList();

                    break;
                #endregion
                case (int)TermGroup_ReportLedgerDateRegard.PaymentDate:
                    #region PaymentDate

                    var paymentItems = (from i in items
                                        where (i.OriginType == paymentType && (i.PayDate >= es.DateFrom && i.PayDate <= es.DateTo))
                                        select i).ToList();

                    //Start with payments, and then fetch all invoices from those payments
                    var invoiceIdsForPayments = paymentItems.Select(i => i.InvoiceId).Distinct().ToList();
                    var invoicesForPayments = items.Where(i => i.OriginType == invoiceType && invoiceIdsForPayments.Contains(i.InvoiceId)).ToList();
                    filteredItems.AddRange(invoicesForPayments);
                    filteredItems.AddRange(paymentItems);

                    break;
                    #endregion
            }

            return filteredItems;
        }

        /// <summary>
        /// Check if new Group should be created for BalanceList report
        /// </summary>
        /// <param name="es">The EvaluatedSelection</param>
        /// <param name="currentGroupInvoice">The current GetReportBalanceListItemsResult item</param>
        /// <param name="newInvoice">The new GetReportBalanceListItemsResult item to check</param>
        /// <param name="groupId">The current group id</param>
        /// <returns>True if new Group should be created, otherwise false</returns>
        private bool CheckNewBalanceListGroup(EvaluatedSelection es, GetReportBalanceListItemsResult currentGroupInvoice, GetReportBalanceListItemsResult newInvoice, int groupId)
        {
            bool result = false;

            switch (es.SL_SortOrder)
            {
                case (int)SoeReportSortOrder.SeqNr:
                    #region SeqNr

                    result = groupId == 0;
                    break;

                #endregion
                case (int)SoeReportSortOrder.Date:
                    #region Date

                    switch (es.SL_DateRegard)
                    {
                        case (int)TermGroup_ReportLedgerDateRegard.InvoiceDate:
                            result = newInvoice.InvoiceDate > currentGroupInvoice.InvoiceDate;
                            break;
                        case (int)TermGroup_ReportLedgerDateRegard.VoucherDate:
                            result = newInvoice.VoucherDate > currentGroupInvoice.VoucherDate;
                            break;
                        case (int)TermGroup_ReportLedgerDateRegard.DueDate:
                            result = newInvoice.DueDate > currentGroupInvoice.DueDate;
                            break;
                        case (int)TermGroup_ReportLedgerDateRegard.PaymentDate:
                            result = newInvoice.PayDate > currentGroupInvoice.PayDate;
                            break;
                    }
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorNr:
                    #region ActorNr

                    result = newInvoice.ActorNr != currentGroupInvoice.ActorNr;
                    break;

                #endregion
                case (int)SoeReportSortOrder.ActorName:
                    #region ActorName

                    result = newInvoice.ActorName != currentGroupInvoice.ActorName;
                    break;

                    #endregion
            }

            return result;
        }

        #endregion

        #endregion

        #region Journals

        private XDocument CreateCustomerInvoiceJournalData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerInvoiceJournal");

            //CustomerInvoiceJournal
            XElement customerInvoiceJournalElement = new XElement("CustomerInvoiceJournal");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateCustomerReportHeaderLabelsElement();
            customerInvoiceJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(es);
            customerInvoiceJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateCustomerInvoiceJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            customerInvoiceJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateCustomerJournalCommonContent(entities, es, customerInvoiceJournalElement, SoeOriginType.CustomerInvoice, accountDimInternals).Success)
                    return null;
            }

            #endregion

            #region Close document

            rootElement.Add(customerInvoiceJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerInvoiceJournal);

            #endregion
        }

        private XDocument CreateCustomerPaymentJournalData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerPaymentJournal");

            //CustomerInvoiceJournal
            XElement customerPaymentJournalElement = new XElement("CustomerPaymentJournal");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateCustomerReportHeaderLabelsElement();
            customerPaymentJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateCustomerReportHeaderElement(es);
            customerPaymentJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateCustomerPaymentJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            customerPaymentJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateCustomerJournalCommonContent(entities, es, customerPaymentJournalElement, SoeOriginType.CustomerPayment, accountDimInternals).Success)
                    return null;
            }

            #endregion

            #region Close document

            rootElement.Add(customerPaymentJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.CustomerPaymentJournal);

            #endregion
        }

        private XDocument CreateSupplierInvoiceJournalData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierInvoiceJournal");

            //SupplierInvoiceJournal
            XElement supplierInvoiceJournalElement = new XElement("SupplierInvoiceJournal");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSupplierReportHeaderLabelsElement();
            supplierInvoiceJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(es);
            supplierInvoiceJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSupplierInvoiceJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            supplierInvoiceJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateSupplierJournalCommonContent(entities, es, supplierInvoiceJournalElement, SoeOriginType.SupplierInvoice, accountDimInternals).Success)
                    return null;
            }

            #region Close document

            rootElement.Add(supplierInvoiceJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierInvoiceJournal);

            #endregion
        }

        private XDocument CreateSupplierPaymentJournalData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            //Get AccountDims
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SupplierPaymentJournal");

            //SupplierInvoiceJournal
            XElement supplierPaymentJournalElement = new XElement("SupplierPaymentJournal");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSupplierReportHeaderLabelsElement();
            supplierPaymentJournalElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSupplierReportHeaderElement(es);
            supplierPaymentJournalElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSupplierPaymentJournalPageHeaderLabelsElement(pageHeaderLabelsElement);
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            supplierPaymentJournalElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                if (!CreateSupplierJournalCommonContent(entities, es, supplierPaymentJournalElement, SoeOriginType.SupplierPayment, accountDimInternals).Success)
                    return null;
            }

            #region Close document

            rootElement.Add(supplierPaymentJournalElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SupplierPaymentJournal);

            #endregion
        }

        #region Help-methods

        private ActionResult CreateCustomerJournalCommonContent(CompEntities entities, EvaluatedSelection es, XElement customerJournalElement, SoeOriginType originType, IEnumerable<AccountDim> accountDimInternals)
        {
            if (es == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EvaluatedSelection");
            if (customerJournalElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #region Content

            var result = CreateBalanceListCommonContent(entities, es, customerJournalElement, SoeOriginType.CustomerInvoice, SoeOriginType.CustomerPayment, true, true);
            if (!result.Success)
                return result;

            var items = result.Value as IEnumerable<GetReportBalanceListItemsResult>;
            if (items == null)
                items = new List<GetReportBalanceListItemsResult>().AsEnumerable();

            items = SortBalanceListInvoices(es, items, originType);

            int journalCounter = 1;
            foreach (var item in items)
            {
                if (!es.SL_IncludeCashSalesInvoices && item.IsCashSale)
                {
                    continue;
                }

                if (item.OriginType != (int)originType)
                    continue;

                XElement journalElement = null;
                if (originType == SoeOriginType.CustomerInvoice)
                    journalElement = CreateCustomerInvoiceJournalElement(entities, es, item, accountDimInternals);
                else if (originType == SoeOriginType.CustomerPayment)
                    journalElement = CreatePaymentJournalElement(entities, es, item, SoeOriginType.CustomerPayment, accountDimInternals);

                if (journalElement != null)
                {
                    journalElement.SetAttributeValue("id", journalCounter);
                    journalCounter++;

                    customerJournalElement.Add(journalElement);
                }
            }

            #region Default element Journal/InvoiceRow/PaymentAccountRow

            if (journalCounter == 1)
            {
                if (originType == SoeOriginType.CustomerInvoice)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("InvoiceNr", 0),
                        new XElement("CustomerNr", String.Empty),
                        new XElement("CustomerName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0)
                        );

                    var invoiceRowElement = new XElement("InvoiceRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                    customerJournalElement.Add(journalElement);
                }
                else if (originType == SoeOriginType.CustomerPayment)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", CalendarUtility.DATETIME_DEFAULT), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", 0),
                        new XElement("PaymentNr", String.Empty), //Differ (added) from InvoiceJournal
                        new XElement("CustomerNr", String.Empty),
                        new XElement("CustomerName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0));

                    var paymentAccountRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        paymentAccountRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(paymentAccountRowElement);
                    customerJournalElement.Add(journalElement);
                }
            }

            #endregion

            #endregion

            return result;
        }

        private ActionResult CreateSupplierJournalCommonContent(CompEntities entities, EvaluatedSelection es, XElement supplierJournalElement, SoeOriginType originType, IEnumerable<AccountDim> accountDimInternals)
        {
            if (es == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "EvaluatedSelection");
            if (supplierJournalElement == null)
                return new ActionResult((int)ActionResultSave.EntityIsNull, "XElement");

            #region Content

            var result = CreateBalanceListCommonContent(entities, es, supplierJournalElement, SoeOriginType.SupplierInvoice, SoeOriginType.SupplierPayment, true, true);
            if (!result.Success)
                return null;

            var items = result.Value as IEnumerable<GetReportBalanceListItemsResult>;
            if (items == null)
                items = new List<GetReportBalanceListItemsResult>().AsEnumerable();

            items = SortBalanceListInvoices(es, items, originType);

            int journalCounter = 1;
            foreach (var item in items)
            {
                if (item.OriginType != (int)originType)
                    continue;

                XElement journalElement = null;
                if (originType == SoeOriginType.SupplierInvoice)
                    journalElement = CreateSupplierInvoiceJournalElement(entities, es, item, accountDimInternals);
                else if (originType == SoeOriginType.SupplierPayment)
                    journalElement = CreatePaymentJournalElement(entities, es, item, SoeOriginType.SupplierPayment, accountDimInternals);

                if (journalElement != null)
                {
                    journalElement.SetAttributeValue("id", journalCounter);
                    journalCounter++;

                    supplierJournalElement.Add(journalElement);
                }
            }

            #region Default element Journal/InvoiceRow/PaymentAccountRow

            if (journalCounter == 1)
            {
                if (originType == SoeOriginType.SupplierInvoice)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("InvoiceNr", 0),
                        new XElement("SupplierNr", String.Empty),
                        new XElement("SupplierName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0)
                        );

                    var invoiceRowElement = new XElement("InvoiceRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                    supplierJournalElement.Add(journalElement);
                }
                else if (originType == SoeOriginType.SupplierPayment)
                {
                    var journalElement = new XElement("Journal",
                        new XAttribute("id", 1),
                        new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", CalendarUtility.DATETIME_DEFAULT), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", 0),
                        new XElement("PaymentNr", String.Empty), //Differ (added) from InvoiceJournal
                        new XElement("SupplierNr", String.Empty),
                        new XElement("SupplierName", String.Empty),
                        new XElement("ShowVoucher", 0),
                        new XElement("VoucherSerie", String.Empty),
                        new XElement("VoucherDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", 0),
                        new XElement("Description", String.Empty),
                        new XElement("InvoiceCurrencyCode", String.Empty),
                        new XElement("InvoiceCurrencyRate", 0)
                        );

                    var paymentAccountRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        paymentAccountRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(paymentAccountRowElement);
                    supplierJournalElement.Add(journalElement);
                }
            }

            #endregion

            #endregion

            return result;
        }

        private XElement CreateCustomerInvoiceJournalElement(CompEntities entities, EvaluatedSelection es, GetReportBalanceListItemsResult item, IEnumerable<AccountDim> accountDimInternals)
        {
            XElement journalElement = null;
            if (es == null || item == null || accountDimInternals == null)
                return journalElement;

            CustomerInvoice customerInvoice = InvoiceManager.GetCustomerInvoiceAndRows(entities, item.InvoiceId, true, true);
            if (customerInvoice != null)
            {
                #region Journal

                bool hasVoucher = item.HasVoucher ?? false;
                bool showVoucher = es.SL_ShowVoucher && hasVoucher;
                string custName = "";
                if (String.IsNullOrEmpty(customerInvoice.CustomerName))
                {
                    custName = item.ActorName;
                }
                else
                {
                    custName = customerInvoice.CustomerName;
                }

                journalElement = new XElement("Journal",
                    new XElement("InvoiceDate", item.InvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("InvoiceNr", item.InvoiceNr),
                    new XElement("SeqNr", item.SeqNr ?? 0),
                    new XElement("CustomerNr", item.ActorNr),
                    new XElement("CustomerName", custName),
                    new XElement("ShowVoucher", showVoucher.ToInt()),
                    new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                    new XElement("VoucherDate", item.VoucherDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("VoucherNr", item.VoucherNr ?? 0),
                    new XElement("Description", item.Description),
                    new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                    new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                    );

                int invoiceRowXmlId = 1;
                foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoice.ActiveCustomerInvoiceRows)
                {
                    bool isHouseholdRow = customerInvoiceRow.IsHouseholdTaxDeductionRow();

                    foreach (CustomerInvoiceAccountRow customerInvoiceAccountRow in customerInvoiceRow.ActiveCustomerInvoiceAccountRows)
                    {
                        #region CustomerInvoiceAccountRow

                        decimal amount = customerInvoiceAccountRow.Amount;
                        decimal amountCurrency = customerInvoiceAccountRow.AmountCurrency;
                        decimal amountEntCurrency = customerInvoiceAccountRow.AmountEntCurrency;
                        decimal amountLedgerCurrency = customerInvoiceAccountRow.AmountLedgerCurrency;

                        if (amount > 0 && customerInvoiceAccountRow.CreditRow)
                        {
                            customerInvoiceAccountRow.CreditRow = false;
                            customerInvoiceAccountRow.DebitRow = true;
                        }
                        if (amount < 0 && customerInvoiceAccountRow.DebitRow)
                        {
                            customerInvoiceAccountRow.CreditRow = true;
                            customerInvoiceAccountRow.DebitRow = false;
                        }

                        if (amount < 0)
                        {
                            amount = Decimal.Negate(amount);
                            amountCurrency = Decimal.Negate(amountCurrency);
                            amountEntCurrency = Decimal.Negate(amountEntCurrency);
                            amountLedgerCurrency = Decimal.Negate(amountLedgerCurrency);
                        }

                        var invoiceRowElement = new XElement("InvoiceRow",
                            new XAttribute("id", invoiceRowXmlId),
                            new XElement("AccountNr", customerInvoiceAccountRow.AccountStd.Account.AccountNr),
                            new XElement("AccountName", customerInvoiceAccountRow.AccountStd.Account.Name),
                            new XElement("Debit", isHouseholdRow ? (customerInvoiceAccountRow.Amount > 0 ? amount : 0) : (customerInvoiceAccountRow.DebitRow ? amount : 0)),
                            new XElement("DebitCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountCurrency > 0 ? amountCurrency : 0) : (customerInvoiceAccountRow.DebitRow ? amountCurrency : 0)), //TODO
                            new XElement("DebitEntCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountEntCurrency > 0 ? amountEntCurrency : 0) : (customerInvoiceAccountRow.DebitRow ? amountEntCurrency : 0)),
                            new XElement("DebitLedgerCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountLedgerCurrency > 0 ? amountLedgerCurrency : 0) : (customerInvoiceAccountRow.DebitRow ? amountLedgerCurrency : 0)),
                            new XElement("Credit", isHouseholdRow ? (customerInvoiceAccountRow.Amount < 0 ? amount : 0) : (customerInvoiceAccountRow.CreditRow ? amount : 0)),
                            new XElement("CreditCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountCurrency < 0 ? amountCurrency : 0) : (customerInvoiceAccountRow.CreditRow ? amountCurrency : 0)), //TODO
                            new XElement("CreditEntCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountEntCurrency < 0 ? amountEntCurrency : 0) : (customerInvoiceAccountRow.CreditRow ? amountEntCurrency : 0)),
                            new XElement("CreditLedgerCurrency", isHouseholdRow ? (customerInvoiceAccountRow.AmountLedgerCurrency < 0 ? amountLedgerCurrency : 0) : (customerInvoiceAccountRow.CreditRow ? amountLedgerCurrency : 0)),
                            new XElement("Quantity", customerInvoiceAccountRow.Quantity.HasValue ? customerInvoiceAccountRow.Quantity : 0));

                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                        {
                            if (i > accountDimInternals.Count<AccountDim>())
                            {
                                invoiceRowElement.Add(
                                    new XElement("AccountInternalNr" + i, String.Empty),
                                    new XElement("AccountInternalName" + i, String.Empty));
                                continue;
                            }

                            AccountInternal accountInternal = null;
                            var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                            if (accountDim != null)
                            {
                                accountInternal = (from ai in customerInvoiceAccountRow.AccountInternal
                                                   where ai.Account.AccountDimId == accountDim.AccountDimId
                                                   select ai).FirstOrDefault();
                            }

                            invoiceRowElement.Add(
                                new XElement("AccountInternalNr" + i, accountInternal?.Account?.AccountNr ?? string.Empty),
                                new XElement("AccountInternalName" + i, accountInternal?.Account?.Name ?? string.Empty));
                        }

                        journalElement.Add(invoiceRowElement);

                        invoiceRowXmlId++;

                        #endregion
                    }
                }

                #region Default element InvoiceRow

                if (invoiceRowXmlId == 1)
                {
                    var invoiceRowElement = new XElement("InvoiceRow",
                       new XAttribute("id", 1),
                       new XElement("AccountNr", String.Empty),
                       new XElement("AccountName", String.Empty),
                       new XElement("Debit", 0),
                       new XElement("DebitCurrency", 0),
                       new XElement("DebitEntCurrency", 0),
                       new XElement("DebitLedgerCurrency", 0),
                       new XElement("Credit", 0),
                       new XElement("CreditCurrency", 0),
                       new XElement("CreditEntCurrency", 0),
                       new XElement("CreditLedgerCurrency", 0),
                       new XElement("Quantity", 0));
                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                }

                #endregion

                #endregion
            }

            return journalElement;
        }

        private XElement CreateSupplierInvoiceJournalElement(CompEntities entities, EvaluatedSelection es, GetReportBalanceListItemsResult item, IEnumerable<AccountDim> accountDimInternals)
        {
            XElement journalElement = null;
            if (es == null || item == null || accountDimInternals == null)
                return journalElement;

            SupplierInvoice supplierInvoice = SupplierInvoiceManager.GetSupplierInvoice(entities, item.InvoiceId, loadInvoiceRow: true, loadInvoiceAccountRow: true);
            if (supplierInvoice != null)
            {
                #region Journal

                bool hasVoucher = item.HasVoucher ?? false;
                bool showVoucher = es.SL_ShowVoucher && hasVoucher;

                journalElement = new XElement("Journal",
                    new XElement("InvoiceDate", item.InvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("InvoiceNr", item.InvoiceNr),
                    new XElement("SeqNr", item.SeqNr ?? 0),
                    new XElement("SupplierNr", item.ActorNr),
                    new XElement("SupplierName", item.ActorName),
                    new XElement("ShowVoucher", showVoucher.ToInt()),
                    new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                    new XElement("VoucherDate", item.VoucherDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("VoucherNr", item.VoucherNr ?? 0),
                    new XElement("Description", item.Description),
                    new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                    new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                    );

                int invoiceRowXmlId = 1;
                foreach (SupplierInvoiceRow supplierInvoiceRow in supplierInvoice.ActiveSupplierInvoiceRows)
                {
                    foreach (SupplierInvoiceAccountRow supplierInvoiceAccountRow in supplierInvoiceRow.SupplierInvoiceAccountRow.Where(r => r.State == (int)SoeEntityState.Active && r.Type == (int)AccountingRowType.AccountingRow))
                    {
                        #region InvoiceRow

                        if (supplierInvoiceAccountRow.State != (int)SoeEntityState.Active)
                            continue;

                        decimal amount = supplierInvoiceAccountRow.Amount;
                        decimal amountCurrency = supplierInvoiceAccountRow.AmountCurrency;
                        decimal amountEntCurrency = supplierInvoiceAccountRow.AmountEntCurrency;
                        decimal amountLedgerCurrency = supplierInvoiceAccountRow.AmountLedgerCurrency;

                        if (amount < 0)
                        {
                            amount = Decimal.Negate(amount);
                            amountCurrency = Decimal.Negate(amountCurrency);
                            amountEntCurrency = Decimal.Negate(amountEntCurrency);
                            amountLedgerCurrency = Decimal.Negate(amountLedgerCurrency);
                        }

                        var invoiceRowElement = new XElement("InvoiceRow",
                            new XAttribute("id", invoiceRowXmlId),
                            new XElement("AccountNr", supplierInvoiceAccountRow.AccountStd.Account.AccountNr),
                            new XElement("AccountName", supplierInvoiceAccountRow.AccountStd.Account.Name),
                            new XElement("Debit", supplierInvoiceAccountRow.Amount > 0 ? amount : 0),
                            new XElement("DebitCurrency", supplierInvoiceAccountRow.Amount > 0 ? amountCurrency : 0),
                            new XElement("DebitEntCurrency", supplierInvoiceAccountRow.Amount > 0 ? amountEntCurrency : 0),
                            new XElement("DebitLedgerCurrency", supplierInvoiceAccountRow.Amount > 0 ? amountLedgerCurrency : 0),
                            new XElement("Credit", supplierInvoiceAccountRow.Amount < 0 ? amount : 0),
                            new XElement("CreditCurrency", supplierInvoiceAccountRow.Amount < 0 ? amountCurrency : 0),
                            new XElement("CreditEntCurrency", supplierInvoiceAccountRow.Amount < 0 ? amountEntCurrency : 0),
                            new XElement("CreditLedgerCurrency", supplierInvoiceAccountRow.Amount < 0 ? amountLedgerCurrency : 0),
                            new XElement("Quantity", supplierInvoiceAccountRow.Quantity.HasValue ? supplierInvoiceAccountRow.Quantity : 0));

                        for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                        {
                            if (i > accountDimInternals.Count<AccountDim>())
                            {
                                invoiceRowElement.Add(
                                    new XElement("AccountInternalNr" + i, String.Empty),
                                    new XElement("AccountInternalName" + i, String.Empty));
                                continue;
                            }

                            AccountInternal accountInternal = null;
                            var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                            if (accountDim != null)
                            {
                                accountInternal = (from ai in supplierInvoiceAccountRow.AccountInternal
                                                   where ai.Account.AccountDimId == accountDim.AccountDimId
                                                   select ai).FirstOrDefault();
                            }

                            invoiceRowElement.Add(
                                new XElement("AccountInternalNr" + i, accountInternal?.Account?.AccountNr ?? string.Empty),
                                new XElement("AccountInternalName" + i, accountInternal?.Account?.Name ?? string.Empty));
                        }

                        journalElement.Add(invoiceRowElement);
                        invoiceRowXmlId++;

                        #endregion
                    }
                }

                #region Default element InvoiceRow

                if (invoiceRowXmlId == 1)
                {
                    var invoiceRowElement = new XElement("InvoiceRow",
                       new XAttribute("id", 1),
                       new XElement("AccountNr", String.Empty),
                       new XElement("AccountName", String.Empty),
                       new XElement("Debit", 0),
                       new XElement("DebitCurrency", 0),
                       new XElement("DebitEntCurrency", 0),
                       new XElement("DebitLedgerCurrency", 0),
                       new XElement("Credit", 0),
                       new XElement("CreditCurrency", 0),
                       new XElement("CreditEntCurrency", 0),
                       new XElement("CreditLedgerCurrency", 0),
                       new XElement("Quantity", 0));
                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(invoiceRowElement);
                }

                #endregion

                #endregion
            }

            return journalElement;
        }

        private XElement CreatePaymentJournalElement(CompEntities entities, EvaluatedSelection es, GetReportBalanceListItemsResult item, SoeOriginType originType, IEnumerable<AccountDim> accountDimInternals)
        {
            XElement journalElement = null;
            if (es == null || item == null || accountDimInternals == null)
                return journalElement;

            PaymentRow paymentRow = PaymentManager.GetPaymentRow(entities, item.PaymentRowId, false, true, true);
            if (paymentRow != null && paymentRow.Status != (int)SoePaymentStatus.Cancel)
            {
                #region Journal

                bool hasVoucher = item.HasVoucher ?? false;
                bool showVoucher = es.SL_ShowVoucher && hasVoucher;
                //if (item.InvoiceNr == null || paymentRow.Invoice == null)
                //{
                //    hasVoucher = item.HasVoucher.HasValue ? item.HasVoucher.Value : false;
                //}
                string actorNrLabel = "";
                string actorNameLabel = "";
                if (originType == SoeOriginType.SupplierPayment)
                {
                    actorNrLabel = "SupplierNr";
                    actorNameLabel = "SupplierName";
                    if (!paymentRow.InvoiceReference.IsLoaded)
                        paymentRow.InvoiceReference.Load();
                    journalElement = new XElement("Journal",
                        new XElement("InvoiceDate", item.InvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", item.PayDate), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", item.InvoiceNr + ' ' + GetText(7009, "Löpnr") + " " + paymentRow.Invoice?.SeqNr.GetValueOrDefault()),
                        new XElement("PaymentNr", item.PaymentNr), //Differ (added) from InvoiceJournal
                        new XElement("SeqNr", item.SeqNr ?? 0),
                        new XElement(actorNrLabel, item.ActorNr),
                        new XElement(actorNameLabel, item.ActorName),
                        new XElement("ShowVoucher", showVoucher.ToInt()),
                        new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                        new XElement("VoucherDate", item.VoucherDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", item.VoucherNr ?? 0),
                        new XElement("Description", item.Description),
                        new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                        new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                        );
                }
                else if (originType == SoeOriginType.CustomerPayment)
                {
                    actorNrLabel = "CustomerNr";
                    actorNameLabel = "CustomerName";

                    journalElement = new XElement("Journal",
                        new XElement("InvoiceDate", item.InvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("PayDate", item.PayDate), //Differ (added) from InvoiceJournal
                        new XElement("InvoiceNr", item.InvoiceNr),
                        new XElement("PaymentNr", item.PaymentNr), //Differ (added) from InvoiceJournal
                        new XElement("SeqNr", item.SeqNr ?? 0),
                        new XElement(actorNrLabel, item.ActorNr),
                        new XElement(actorNameLabel, item.ActorName),
                        new XElement("ShowVoucher", showVoucher.ToInt()),
                        new XElement("VoucherSerie", item.VoucherSeriesTypeNr + ". " + item.VoucherSeriesTypeName),
                        new XElement("VoucherDate", item.VoucherDate ?? CalendarUtility.DATETIME_DEFAULT),
                        new XElement("VoucherNr", item.VoucherNr ?? 0),
                        new XElement("Description", item.Description),
                        new XElement("InvoiceCurrencyCode", item.CurrencyCode),
                        new XElement("InvoiceCurrencyRate", item.CurrencyRate)
                        );
                }


                int paymentAccountRowXmlId = 1;
                foreach (PaymentAccountRow paymentAccountRow in paymentRow.ActivePaymentAccountRows)
                {
                    #region PaymentAccountRow

                    decimal amount = paymentAccountRow.Amount;
                    decimal amountCurrency = paymentAccountRow.AmountCurrency;
                    decimal amountEntCurrency = paymentAccountRow.AmountEntCurrency;
                    decimal amountLedgerCurrency = paymentAccountRow.AmountLedgerCurrency;

                    if (amount < 0)
                    {
                        amount = Decimal.Negate(amount);
                        amountCurrency = Decimal.Negate(amountCurrency);
                        amountEntCurrency = Decimal.Negate(amountEntCurrency);
                        amountLedgerCurrency = Decimal.Negate(amountLedgerCurrency);
                    }

                    var invoiceRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", paymentAccountRowXmlId),
                        new XElement("AccountNr", paymentAccountRow.AccountStd.Account.AccountNr),
                        new XElement("AccountName", paymentAccountRow.AccountStd.Account.Name),
                        new XElement("Debit", paymentAccountRow.DebitRow ? amount : 0),
                        new XElement("DebitCurrency", paymentAccountRow.DebitRow ? amountCurrency : 0),
                        new XElement("DebitEntCurrency", paymentAccountRow.DebitRow ? amountEntCurrency : 0),
                        new XElement("DebitLedgerCurrency", paymentAccountRow.DebitRow ? amountLedgerCurrency : 0),
                        new XElement("Credit", paymentAccountRow.CreditRow ? amount : 0),
                        new XElement("CreditCurrency", paymentAccountRow.CreditRow ? amountCurrency : 0),
                        new XElement("CreditEntCurrency", paymentAccountRow.CreditRow ? amountEntCurrency : 0),
                        new XElement("CreditLedgerCurrency", paymentAccountRow.CreditRow ? amountLedgerCurrency : 0),
                        new XElement("Quantity", paymentAccountRow.Quantity.HasValue ? paymentAccountRow.Quantity : 0));

                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        if (i > accountDimInternals.Count<AccountDim>())
                        {
                            invoiceRowElement.Add(
                                new XElement("AccountInternalNr" + i, String.Empty),
                                new XElement("AccountInternalName" + i, String.Empty));
                            continue;
                        }

                        AccountInternal accountInternal = null;
                        var accountDim = accountDimInternals.Any() ? accountDimInternals.ElementAt(i - 1) : null;
                        if (accountDim != null)
                        {
                            accountInternal = (from ai in paymentAccountRow.AccountInternal
                                               where ai.Account.AccountDimId == accountDim.AccountDimId
                                               select ai).FirstOrDefault();
                        }

                        invoiceRowElement.Add(
                            new XElement("AccountInternalNr" + i, accountInternal?.Account?.AccountNr ?? string.Empty),
                            new XElement("AccountInternalName" + i, accountInternal?.Account?.Name ?? string.Empty));
                    }

                    journalElement.Add(invoiceRowElement);

                    paymentAccountRowXmlId++;

                    #endregion
                }

                #region Default element PaymentAccountRow

                if (paymentAccountRowXmlId == 1)
                {
                    var paymentAccountRowElement = new XElement("PaymentAccountRow",
                        new XAttribute("id", 1),
                        new XElement("AccountNr", String.Empty),
                        new XElement("AccountName", String.Empty),
                        new XElement("Debit", 0),
                        new XElement("DebitCurrency", 0),
                        new XElement("DebitEntCurrency", 0),
                        new XElement("DebitLedgerCurrency", 0),
                        new XElement("Credit", 0),
                        new XElement("CreditCurrency", 0),
                        new XElement("CreditEntCurrency", 0),
                        new XElement("CreditLedgerCurrency", 0),
                        new XElement("Quantity", 0));
                    for (int i = 1; i <= Constants.NOOFDIMENSIONS; i++)
                    {
                        paymentAccountRowElement.Add(
                            new XElement("AccountInternalNr" + i, String.Empty),
                            new XElement("AccountInternalName" + i, String.Empty));
                    }

                    journalElement.Add(paymentAccountRowElement);
                }

                #endregion

                #endregion
            }

            return journalElement;
        }

        #endregion

        #endregion

        #region Billing

        private XDocument CreateBillingInvoiceData(EvaluatedSelection es)
        {
            if (es.ReportTemplateType != SoeReportTemplateType.BillingContract &&
                es.ReportTemplateType != SoeReportTemplateType.BillingInvoice &&
                es.ReportTemplateType != SoeReportTemplateType.BillingOrder &&
                es.ReportTemplateType != SoeReportTemplateType.BillingOffer &&
                es.ReportTemplateType != SoeReportTemplateType.BillingInvoiceInterest &&
                es.ReportTemplateType != SoeReportTemplateType.BillingInvoiceReminder &&
                es.ReportTemplateType != SoeReportTemplateType.OriginStatisticsReport &&
                es.ReportTemplateType != SoeReportTemplateType.BillingOrderOverview)
                return null;

            #region Prereq

            if (es == null)
                return null;



            bool isBillingContractTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingContract);
            bool isBillingOrderTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrder) || es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrderOverview);
            bool isBillingOfferTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOffer);
            bool isBillingInvoiceTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice);
            bool isBillingInvoiceInterestTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoiceInterest);
            bool isBillingInvoiceReminderTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoiceReminder);
            bool isInvoiceTemplate = isBillingInvoiceTemplate || isBillingInvoiceInterestTemplate || isBillingInvoiceReminderTemplate;

            //permissions
            bool showSalesPricePermission = true; // FeatureManager.HasRolePermission(Feature.Billing_Product_Products_ShowSalesPrice, Permission.Readonly, base.RoleId, base.ActorCompanyId);

            //Get settings
            int baseSysCurrencyId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CoreBaseCurrency, 0, es.ActorCompanyId, 0);
            int householdProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductHouseholdTaxDeduction, 0, es.ActorCompanyId, 0);
            int household50ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductHousehold50TaxDeduction, 0, es.ActorCompanyId, 0);
            int householdRutProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductRUTTaxDeduction, 0, es.ActorCompanyId, 0);
            int householdGreen15ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGreen15TaxDeduction, 0, es.ActorCompanyId, 0);
            int householdGreen20ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGreen20TaxDeduction, 0, es.ActorCompanyId, 0);
            int householdGreen50ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGreen50TaxDeduction, 0, es.ActorCompanyId, 0);
            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, es.ActorCompanyId, 0);
            bool showOrdernrOnInvoiceReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingShowOrdernrOnInvoiceReport, 0, es.ActorCompanyId, 0);
            bool doPrintTaxBillText = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingPrintTaxBillText, 0, es.ActorCompanyId, 0);
            bool showCOLabel = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingShowCOLabelOnReport, 0, es.ActorCompanyId, 0);
            bool showRemainingAmountInReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingIncludeRemainingAmountOnInvoice, 0, es.ActorCompanyId, 0);
            bool orderIncludeTimeProjectinReport = true; //SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingOrderIncludeTimeProjectinReport, 0, es.ActorCompanyId, 0); - REMOVED ITEM 49453
            bool invoiceIncludeTimeProjectinReport = true; //SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingIncludeTimeProjectinReport, 0, es.ActorCompanyId, 0); -REMOVED ITEM 49453
            bool UseDeliveryAddressAsBillingAddress = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseDeliveryAddressAsInvoiceAddress, 0, es.ActorCompanyId, 0);
            bool useProjectTimeBlock = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseProjectTimeBlocks, this.UserId, this.ActorCompanyId, 0, false);
            //Disregard copies for interest and reminder, until separate setting exists for them
            if (isBillingInvoiceInterestTemplate || isBillingInvoiceReminderTemplate)
                es.SB_DisableInvoiceCopies = true;

            int nbrOfCopies;
            if (es.SB_DisableInvoiceCopies)
                nbrOfCopies = 0;
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingContract))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfContractCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOffer))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfOfferCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrder))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfOrderCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.OriginStatisticsReport))
                nbrOfCopies = 0;
            else
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfCopies, 0, es.ActorCompanyId, 0);

            // Never send email copys
            if (nbrOfCopies > 0 && es.EmailTemplateId != null && es.EmailTemplateId != 0)
            {
                nbrOfCopies = 0;
            }

            //Get SysCurrencies
            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);

            //AttestLevels
            string attestLevelInitial = string.Empty;
            string attestLevelToInvoice = string.Empty;
            string attestLevelMobileReady = string.Empty;
            string attestLevelOfferToOrder = string.Empty;

            if (es.ReportTemplateType == SoeReportTemplateType.BillingOrder || es.ReportTemplateType == SoeReportTemplateType.OriginStatisticsReport || es.ReportTemplateType == SoeReportTemplateType.BillingOrderOverview)
            {
                var initialAttestState = AttestManager.GetInitialAttestState(es.ActorCompanyId, TermGroup_AttestEntity.Order);
                attestLevelInitial = initialAttestState != null ? initialAttestState.Name : string.Empty;

                int defaultStatusTransferredOrderToInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, 0, es.ActorCompanyId, 0);
                int defaultStatusTransferredOrderReadyMobile = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusOrderReadyMobile, 0, es.ActorCompanyId, 0);

                var orderToInvoiceAttestState = AttestManager.GetAttestState(defaultStatusTransferredOrderToInvoice);
                attestLevelToInvoice = orderToInvoiceAttestState != null ? orderToInvoiceAttestState.Name : string.Empty;

                var orderReadyMobileAttestState = AttestManager.GetAttestState(defaultStatusTransferredOrderReadyMobile);
                attestLevelMobileReady = orderReadyMobileAttestState != null ? orderReadyMobileAttestState.Name : string.Empty;
            }

            if (es.ReportTemplateType == SoeReportTemplateType.BillingOffer)
            {
                var initialAttestState = AttestManager.GetInitialAttestState(es.ActorCompanyId, TermGroup_AttestEntity.Offer);
                attestLevelInitial = initialAttestState != null ? initialAttestState.Name : string.Empty;

                int defaultStatusTransferredOfferToInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOfferToInvoice, 0, es.ActorCompanyId, 0);
                int defaultStatusTransferredOfferToOrder = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOfferToOrder, 0, es.ActorCompanyId, 0);

                var offerToInvoiceAttestState = AttestManager.GetAttestState(defaultStatusTransferredOfferToInvoice);
                attestLevelToInvoice = offerToInvoiceAttestState != null ? offerToInvoiceAttestState.Name : string.Empty;

                var offerToOrderAttestState = AttestManager.GetAttestState(defaultStatusTransferredOfferToOrder);
                attestLevelOfferToOrder = offerToOrderAttestState != null ? offerToOrderAttestState.Name : string.Empty;
            }

            List<TermGroup_AttestEntity> entitys = new List<TermGroup_AttestEntity>()
            {
                TermGroup_AttestEntity.Order,
                TermGroup_AttestEntity.Offer,
            };
            List<AttestState> attestStates = AttestManager.GetAttestStates(es.ActorCompanyId, entitys, SoeModule.Billing);

            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(es.ActorCompanyId);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();

            //Language
            reportLanguageId = es.SB_ReportLanguageId;
            if (es.SB_ReportLanguageId == 0)
            {
                switch (Company.SysCountryId)
                {
                    case (int)TermGroup_Country.SE:
                        reportLanguageId = (int)TermGroup_Languages.Swedish;
                        break;
                    case (int)TermGroup_Country.FI:
                        reportLanguageId = (int)TermGroup_Languages.Finnish;
                        break;
                    case (int)TermGroup_Country.GB:
                        reportLanguageId = (int)TermGroup_Languages.English;
                        break;
                    case (int)TermGroup_Country.NO:
                        reportLanguageId = (int)TermGroup_Languages.Norwegian;
                        break;
                    case (int)TermGroup_Country.DK:
                        reportLanguageId = (int)TermGroup_Languages.Danish;
                        break;
                }
            }

            if (reportLanguageId == 0)
                reportLanguageId = GetLangId();

            SetLanguage(LanguageManager.GetSysLanguageCode(reportLanguageId));

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "BillingInvoice");

            //VoucherList
            XElement billingInvoiceElement = new XElement("BillingInvoice");

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateBillingReportHeaderElement(es);
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
            reportHeaderElement.Add(new XElement("AttestLevelInitial", attestLevelInitial));
            reportHeaderElement.Add(new XElement("AttestLevelInvoiced", attestLevelToInvoice));
            reportHeaderElement.Add(new XElement("AttestLevelMobileReady", attestLevelMobileReady));
            reportHeaderElement.Add(new XElement("AttestLevelOfferToOrder", attestLevelOfferToOrder));

            reportHeaderElement.Add(new XElement("SortByLevel1", es.SortByLevel1));
            reportHeaderElement.Add(new XElement("SortByLevel2", es.SortByLevel2));
            reportHeaderElement.Add(new XElement("SortByLevel3", es.SortByLevel3));
            reportHeaderElement.Add(new XElement("SortByLevel4", es.SortByLevel4));
            reportHeaderElement.Add(new XElement("IsSortAscending", es.IsSortAscending));
            reportHeaderElement.Add(new XElement("GroupByLevel1", es.GroupByLevel1));
            reportHeaderElement.Add(new XElement("GroupByLevel2", es.GroupByLevel2));
            reportHeaderElement.Add(new XElement("GroupByLevel3", es.GroupByLevel3));
            reportHeaderElement.Add(new XElement("GroupByLevel4", es.GroupByLevel4));
            reportHeaderElement.Add(new XElement("Special", es.Special));
            reportHeaderElement.Add(new XElement("HidePrice", !showSalesPricePermission));

            #endregion

            List<XElement> invoiceHeadElements = new List<XElement>();

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                //Get AccountDims
                List<AccountInternal> accountInternalsInInterval = new List<AccountInternal>();
                Dictionary<int, string> customerNameDict = new Dictionary<int, string>();

                SoeOriginType originType = SoeOriginType.None;
                int invoiceHeadXmlId = 1;
                List<CustomerInvoice> customerInvoices;
                if (es.ReportTemplateType == SoeReportTemplateType.OriginStatisticsReport)
                {
                    customerInvoices = InvoiceManager.GetCustomerInvoicesFromSelection(entities, es, es.SB_IncludeDrafts, ref originType, false);
                }
                else
                {
                    customerInvoices = InvoiceManager.GetCustomerInvoicesFromSelection(entities, es, es.SB_IncludeDrafts, ref originType, true);
                }

                // Increase the command timeout
                entities.CommandTimeout = 180; // 3 minutes

                // Get hidden attest states
                List<int> hiddenAttestStateIds = new List<int>();
                if (es.ReportTemplateType == SoeReportTemplateType.BillingOffer)
                    hiddenAttestStateIds = AttestManager.GetHiddenAttestStateIds(entities, es.ActorCompanyId, TermGroup_AttestEntity.Offer, SoeModule.Billing);
                else if (es.ReportTemplateType == SoeReportTemplateType.BillingOrder)
                    hiddenAttestStateIds = AttestManager.GetHiddenAttestStateIds(entities, es.ActorCompanyId, TermGroup_AttestEntity.Order, SoeModule.Billing);

                var attestStateTransferredOrderToInvoiceId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, 0, es.ActorCompanyId, 0);

                var vatCodes = AccountManager.GetVatCodeGridDTOs(entities, es.ActorCompanyId);

                List<GenericType> contractGroupPeriodTerms = base.GetTermGroupContent(TermGroup.ContractGroupPeriod);

                #region Information for QRCode

                PaymentInformation paymentInformation = PaymentManager.GetPaymentInformationFromActor(Company.ActorCompanyId, true, false);
                string bg = PaymentManager.GetPaymentNr(paymentInformation, TermGroup_SysPaymentType.BG);
                string pg = PaymentManager.GetPaymentNr(paymentInformation, TermGroup_SysPaymentType.PG);
                Contact contact = ContactManager.GetContactFromActor(entities, Company.ActorCompanyId);


                List<ContactAddressRow> contactAddressRows = contact != null ? ContactManager.GetContactAddressRows(entities, contact.ContactId) : null;
                string distributionPostalAddress = contactAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Distribution, TermGroup_SysContactAddressRowType.PostalCode) + " " + contactAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Distribution, TermGroup_SysContactAddressRowType.PostalAddress);

                #endregion

                #endregion

                #region Content

                //Fixed price setting (fixedprice type 1)
                int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, es.ActorCompanyId, 0);
                //Fixed price keep prices setting (fixedprice type 2)
                int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, es.ActorCompanyId, 0);
                //Guarantee setting
                int productGuaranteeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, es.ActorCompanyId, 0);
                //defaultReminderProductId
                int defaultReminderProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductReminderFee, es.UserId, es.ActorCompanyId, 0);
                //defaultPriceListType
                int defaultPriceListType = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingDefaultPriceListType, es.UserId, es.ActorCompanyId, 0);

                int defaultInterestAccumulatedBeforeInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestAccumulatedBeforeInvoice, es.UserId, es.ActorCompanyId, 0);

                var productRowDescriptionToUpperCase = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingProductRowTextUppercase, es.UserId, es.ActorCompanyId, 0);

                foreach (CustomerInvoice customerInvoice in customerInvoices)
                {
                    #region CustomerInvoice

                    #region Prereq

                    //Customer
                    Customer customer = customerInvoice.Actor?.Customer;
                    if (customer == null)
                        continue;

                    if (customerInvoices.Count == 1 && customer.SysLanguageId != null && es.SB_ReportLanguageId == 0)
                    {
                        reportLanguageId = (int)customer.SysLanguageId;
                        SetLanguage(LanguageManager.GetSysLanguageCode(reportLanguageId));
                    }

                    ReportDataHistoryRepository repository = ReportDataHistoryRepository.CreateBillingInvoiceRepository(parameterObject, customerInvoice, es.ActorCompanyId);

                    //Customer name
                    bool isOneTimeCustomer = false;
                    isOneTimeCustomer = customer.IsOneTimeCustomer;

                    string customerName = repository.GetHistoryValue(SoeReportDataHistoryHeadTag.BillingInvoice_InvoiceHead, SoeReportDataHistoryTag.BillingInvoice_InvoiceHead_CustomerName);
                    if (String.IsNullOrEmpty(customerName))
                    {
                        if (isOneTimeCustomer)
                            customerName = customerInvoice.CustomerName ?? string.Empty;
                        else
                            customerName = customer?.Name ?? string.Empty;
                    }
                    //Report name
                    if (customerInvoice.SeqNr.HasValue && !customerNameDict.ContainsKey(customerInvoice.SeqNr.Value))
                        customerNameDict.Add(customerInvoice.SeqNr.Value, customerName.Replace('\n', ' '));

                    //Currenty
                    SysCurrency sysCurrency = sysCurrencies.FirstOrDefault(i => i.SysCurrencyId == customerInvoice.Currency.SysCurrencyId);

                    decimal reminderAmount = 0;
                    decimal interestAmount = 0;
                    if (es.ReportTemplateType == SoeReportTemplateType.BillingInvoiceReminder)
                    {
                        //Get PriceListType from Customer if exists, otherwise Company setting
                        int priceListTypeId = InvoiceManager.GetPriceListTypeIdBasedOnPriority(customerInvoice.Actor.Customer, defaultPriceListType);

                        //Get Product reminder
                        InvoiceProduct productReminder = ProductManager.GetInvoiceProduct(entities, defaultReminderProductId, true, false, false);
                        //if (productReminder == null)
                        //    return new ActionResult((int)ActionResultSave.CustomerInvoiceReminderProductNotFound, "InvoiceProduct");

                        //Claim product amount
                        reminderAmount = InvoiceManager.GetReminderProductPrice(entities, productReminder, priceListTypeId);

                        //Check that totalamount is larger than minimum amount in company setting
                        interestAmount = InvoiceManager.CalculateInterestAmount(entities, customerInvoice.InvoiceId, interestPercent, customerInvoice.TotalAmount, customerInvoice.DueDate, true);
                        if (interestAmount < defaultInterestAccumulatedBeforeInvoice)
                        {
                            interestAmount = 0;
                        }
                    }
                        // Timecodetransactions
                        var transactions = es.ReportTemplateType == SoeReportTemplateType.BillingOrderOverview ? entities.GetTimeCodeTransactionsForOrderOverview(customerInvoice.InvoiceId, useProjectTimeBlock).ToList() : new List<GetTimeCodeTransactionsForOrderOverview_Result>();

                    //Account Internals
                    #region Account Internals Validation
                    bool accountsValid = false;

                    if (accountInternalsInInterval.Count != 0)
                    {
                        if ((customerInvoice.DefaultDim1AccountId == null || customerInvoice.DefaultDim1AccountId == 0) &&
                            (customerInvoice.DefaultDim2AccountId == null || customerInvoice.DefaultDim2AccountId == 0) &&
                            (customerInvoice.DefaultDim3AccountId == null || customerInvoice.DefaultDim3AccountId == 0) &&
                            (customerInvoice.DefaultDim4AccountId == null || customerInvoice.DefaultDim4AccountId == 0) &&
                            (customerInvoice.DefaultDim5AccountId == null || customerInvoice.DefaultDim5AccountId == 0) &&
                            (customerInvoice.DefaultDim6AccountId == null || customerInvoice.DefaultDim6AccountId == 0))
                        {
                            accountsValid = false;
                        }
                        else
                        {
                            var accountInternalIds = accountInternalsInInterval.Select(a => a.AccountId).ToList();
                            if (customerInvoice.DefaultDim1AccountId != null && customerInvoice.DefaultDim1AccountId != 0 && accountInternalIds.Contains((int)customerInvoice.DefaultDim1AccountId))
                                accountsValid = true;
                            if (!accountsValid && customerInvoice.DefaultDim2AccountId != null && customerInvoice.DefaultDim2AccountId != 0 && accountInternalIds.Contains((int)customerInvoice.DefaultDim2AccountId))
                                accountsValid = true;
                            if (!accountsValid && customerInvoice.DefaultDim3AccountId != null && customerInvoice.DefaultDim3AccountId != 0 && accountInternalIds.Contains((int)customerInvoice.DefaultDim3AccountId))
                                accountsValid = true;
                            if (!accountsValid && customerInvoice.DefaultDim4AccountId != null && customerInvoice.DefaultDim4AccountId != 0 && accountInternalIds.Contains((int)customerInvoice.DefaultDim4AccountId))
                                accountsValid = true;
                            if (!accountsValid && customerInvoice.DefaultDim5AccountId != null && customerInvoice.DefaultDim5AccountId != 0 && accountInternalIds.Contains((int)customerInvoice.DefaultDim5AccountId))
                                accountsValid = true;
                            if (!accountsValid && customerInvoice.DefaultDim6AccountId != null && customerInvoice.DefaultDim6AccountId != 0 && accountInternalIds.Contains((int)customerInvoice.DefaultDim6AccountId))
                                accountsValid = true;
                        }
                    }
                    else
                    {
                        accountsValid = true;
                    }

                    if (!accountsValid)
                        continue;

                    if (customerInvoice.ContractGroupId.HasValue && !customerInvoice.ContractGroupReference.IsLoaded)
                        customerInvoice.ContractGroupReference.Load();

                    #endregion

                    #endregion

                    #region Contact

                    Contact customerContact = ContactManager.GetContactFromActor(customerInvoice.Actor.ActorId);
                    List<ContactAddressRow> customerContactAddressRows = customerContact != null ? ContactManager.GetContactAddressRows(customerContact.ContactId) : null;

                    if (customerInvoice.DeliveryCustomerId.HasValue && customerInvoice.DeliveryCustomerId.Value != customerInvoice.ActorId)
                    {
                        // Fetch addresses from delivery customer
                        Contact deliveryCustomerContact = ContactManager.GetContactFromActor(customerInvoice.DeliveryCustomerId.Value);
                        if (deliveryCustomerContact != null)
                            customerContactAddressRows.AddRange(ContactManager.GetContactAddressRows(deliveryCustomerContact.ContactId));
                    }

                    #endregion

                    #region Tracing

                    InvoiceTraceViewDTO invoiceOrder = null;
                    InvoiceTraceViewDTO invoiceContract = null;
                    OrderTraceViewDTO orderOffer = null;
                    List<OrderTraceViewDTO> previousInvoices = new List<OrderTraceViewDTO>();
                    List<OfferTraceViewDTO> previousOrders = new List<OfferTraceViewDTO>();
                    string creditedInvoicesText = "";

                    if (isBillingInvoiceTemplate)
                    {
                        //Get the Orders the Invoice was created from. Must be only 1 order (Otherwise unable to track, i.e. merged invoices)
                        var invoiceOrders = InvoiceManager.GetInvoiceTraceViews(entities, customerInvoice.InvoiceId, baseSysCurrencyId, isOrder: true);
                        if (invoiceOrders.Count == 1)
                        {
                            invoiceOrder = invoiceOrders.First();

                            //Get other Invoices the Order created. Can be more than one.
                            previousInvoices = InvoiceManager.GetOrderTraceViews(entities, invoiceOrder.OrderId, baseSysCurrencyId, isInvoice: true);

                            //Filter self
                            previousInvoices = previousInvoices.Where(i => i.InvoiceId != customerInvoice.InvoiceId && !i.IsSupplierInvoice).ToList();
                        }

                        //Get the Contracts the Invoice was created from. Must be only 1 contract (Otherwise unable to track, i.e. merged invoices)
                        var invoiceContracts = InvoiceManager.GetInvoiceTraceViews(entities, customerInvoice.InvoiceId, baseSysCurrencyId, isContract: true);
                        if (invoiceContracts.Count == 1)
                            invoiceContract = invoiceContracts.First();

                        if (customerInvoice.IsCredit)
                        {
                            var originalInvoices = InvoiceManager.GetInvoiceTraceViews(entities, customerInvoice.InvoiceId, baseSysCurrencyId, isInvoice: true);
                            if (originalInvoices.Count > 0)
                            {
                                if (originalInvoices.Count == 1)
                                {
                                    creditedInvoicesText = GetReportText(317, "Avser faktura:") + " " + originalInvoices.First().Number;

                                    if (invoiceOrder == null)
                                    {
                                        var invoiceOrdersCredit = InvoiceManager.GetInvoiceTraceViews(entities, originalInvoices.First().MappedInvoiceId, baseSysCurrencyId, isOrder: true);
                                        if (invoiceOrdersCredit.Count == 1)
                                        {
                                            invoiceOrder = invoiceOrdersCredit.First();

                                            //Get other Invoices the Order created. Can be more than one.
                                            /*previousInvoices = InvoiceManager.GetOrderTraceViews(entities, invoiceOrder.OrderId, baseSysCurrencyId, isInvoice: true);

                                            //Filter self
                                            previousInvoices = previousInvoices.Where(i => i.InvoiceId != customerInvoice.InvoiceId).ToList();*/
                                        }
                                    }
                                }
                                else
                                {
                                    creditedInvoicesText = GetReportText(318, "Avser fakturorna:") + " ";

                                    int count = 0;
                                    foreach (var creditedInvoice in originalInvoices)
                                    {
                                        count++;
                                        creditedInvoicesText += creditedInvoice.Number;
                                        if (count != originalInvoices.Count)
                                            creditedInvoicesText += ", ";
                                    }
                                }
                            }
                        }
                    }
                    else if (isBillingOrderTemplate)
                    {
                        //Get the Offers the Order was created from. Must be only 1 offer (Otherwise unable to track, i.e. merged orders)
                        var orderOffers = InvoiceManager.GetOrderTraceViews(entities, customerInvoice.InvoiceId, baseSysCurrencyId, isOffer: true);
                        if (orderOffers.Count == 1)
                        {
                            orderOffer = orderOffers.First();

                            //Get other Orders the Offer created. Can be more than one.
                            previousOrders = InvoiceManager.GetOfferTraceViews(entities, orderOffer.OfferId, baseSysCurrencyId, isOrder: true);

                            //Filter self
                            previousOrders = previousOrders.Where(i => i.OrderId != customerInvoice.InvoiceId).ToList();
                        }
                    }

                    SoeBillingInvoiceReportType billingInvoiceReportType = SoeBillingInvoiceReportType.Unknown;
                    List<CustomerInvoice> originInvoices = new List<CustomerInvoice>();
                    if (isBillingContractTemplate)
                    {
                        billingInvoiceReportType = SoeBillingInvoiceReportType.Contract;
                    }
                    else if (isBillingOfferTemplate)
                    {
                        billingInvoiceReportType = SoeBillingInvoiceReportType.Offer;
                    }
                    else if (isBillingOrderTemplate)
                    {
                        billingInvoiceReportType = SoeBillingInvoiceReportType.Order;
                    }
                    else if (isBillingInvoiceTemplate)
                    {
                        billingInvoiceReportType = SoeBillingInvoiceReportType.Invoice;
                    }
                    else if (isBillingInvoiceReminderTemplate)
                    {
                        if (customerInvoice.BillingType == (int)TermGroup_BillingType.Debit || customerInvoice.BillingType == (int)TermGroup_BillingType.Credit || customerInvoice.BillingType == (int)TermGroup_BillingType.Interest)
                        {
                            billingInvoiceReportType = SoeBillingInvoiceReportType.ClaimQuick;

                            //Add self
                            originInvoices.Add(customerInvoice);

                            //Increase reminder level
                            if (es.SB_InvoiceReminder)
                                InvoiceManager.IncreaseCustomerInvoiceReminder(entities, customerInvoice, es.ActorCompanyId, true);
                        }
                        else if (customerInvoice.BillingType == (int)TermGroup_BillingType.Reminder)
                        {
                            billingInvoiceReportType = SoeBillingInvoiceReportType.Claim;

                            //Add original CustomerInvoice(s)
                            originInvoices.AddRange(InvoiceManager.GetOriginInvoicesFromReminder(entities, customerInvoice.InvoiceId));
                        }
                    }
                    else if (isBillingInvoiceInterestTemplate)
                    {
                        if (customerInvoice.BillingType == (int)TermGroup_BillingType.Debit)
                        {
                            billingInvoiceReportType = SoeBillingInvoiceReportType.Interest;

                            //Add self
                            originInvoices.Add(customerInvoice);
                        }
                        else if (customerInvoice.BillingType == (int)TermGroup_BillingType.Interest)
                        {
                            billingInvoiceReportType = SoeBillingInvoiceReportType.Interest;

                            //Add original CustomerInvoice(s)
                            originInvoices.AddRange(InvoiceManager.GetOriginInvoicesFromInterest(entities, customerInvoice.InvoiceId));
                        }
                    }

                    #endregion

                    #region OriginUser

                    var originUsers = OriginManager.GetOriginUsers(entities, customerInvoice.InvoiceId);

                    #endregion

                    for (int copy = 0; copy <= nbrOfCopies; copy++)
                    {
                        #region Copy

                        #region ReportHeader (override)

                        if (invoiceHeadXmlId == 1 && customerInvoices.Count == 1 && repository.HasSavedHistory)
                        {
                            //Override ReportHeader if current has history and not multiple reports are printed (in that case keep original ReportHeader)
                            reportHeaderElement = CreateBillingReportHeaderElement(es, repository);
                        }

                        #endregion

                        #region InvoiceHead

                        string invoiceCopyText = "";
                        if (customerInvoice.Origin.Status == (int)SoeOriginStatus.Cancel)
                            invoiceCopyText = GetReportText(264, "Makulerad");
                        else if ((isInvoiceTemplate && es.SB_InvoiceCopy && customerInvoice.BillingInvoicePrinted) || copy > 0)
                            invoiceCopyText = GetReportText(144, "Kopia");
                        else if (Company.Demo)
                            invoiceCopyText = GetReportText(283, "Demo");

                        string invoiceParentOrderNrText = showOrdernrOnInvoiceReport ? customerInvoice.OrderNumbers != string.Empty ? customerInvoice.OrderNumbers : (invoiceOrder != null ? invoiceOrder.Number : string.Empty) : string.Empty;
                        string invoiceParentContractNrText = showOrdernrOnInvoiceReport && invoiceContract != null ? invoiceContract.Number : String.Empty;
                        string invoiceBillingInterestText = interestPercent > 0 ? GetReportText(140, "Dröjsmålsränta debiteras med") + " " + Decimal.Round(interestPercent, 2) + GetReportText(141, "% efter förfallodatum") : "";
                        string InvoiceInvertedVatText = "";
                        if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.Contractor)
                            InvoiceInvertedVatText = GetReportText(143, "Omvänd betalningsskyldighet");
                        else if (customerInvoice.VatType == (int)TermGroup_InvoiceVatType.ExportWithinEU && customer.VatNr != null)
                            InvoiceInvertedVatText = GetReportText(143, "Omvänd betalningsskyldighet");
                        // Reduce amounts on rows with hidden attest states from head
                        if ((billingInvoiceReportType == SoeBillingInvoiceReportType.Order || billingInvoiceReportType == SoeBillingInvoiceReportType.Offer) && hiddenAttestStateIds.Any())
                        {
                            List<CustomerInvoiceRow> customerHiddenInvoiceRows = customerInvoice.ActiveCustomerInvoiceRows.Where(i => i.AttestStateId.HasValue && hiddenAttestStateIds.Contains(i.AttestStateId.Value)).ToList();
                            foreach (CustomerInvoiceRow customerInvoiceRow in customerHiddenInvoiceRows)
                            {
                                customerInvoice.SumAmountCurrency -= customerInvoiceRow.SumAmountCurrency;
                                customerInvoice.SumAmount -= customerInvoiceRow.SumAmount;
                                customerInvoice.VATAmountCurrency -= customerInvoiceRow.VatAmountCurrency;
                                customerInvoice.VATAmount -= customerInvoiceRow.VatAmount;
                                customerInvoice.TotalAmountCurrency -= customerInvoiceRow.SumAmountCurrency;
                                customerInvoice.TotalAmount -= customerInvoiceRow.SumAmount;
                                customerInvoice.TotalAmountCurrency -= customerInvoiceRow.VatAmountCurrency;
                                customerInvoice.TotalAmount -= customerInvoiceRow.VatAmount;
                            }
                        }
                        //If specified in company-settings, add C/O before distributionAddress.
                        XElement invoiceHeadElement = CreateBillingInvoiceHeadElement(invoiceHeadXmlId, billingInvoiceReportType, customerInvoice, customerContactAddressRows, sysCurrency, invoiceCopyText, invoiceParentOrderNrText, invoiceBillingInterestText, InvoiceInvertedVatText, creditedInvoicesText, invoiceParentContractNrText, repository, showCOLabel, originType, UseDeliveryAddressAsBillingAddress, interestPercent, showSalesPricePermission);
                        if (invoiceHeadElement == null)
                            continue;

                        #endregion

                        #region InvoiceRow

                        int invoiceRowXmlId = 1;
                        List<int> targetRowIds = new List<int>();
                        List<XElement> invoiceRowElements = new List<XElement>();
                        bool orderOfferHasLiftRows = false;
                        bool allHasLiftRows = false;
                        bool allIsFixedPrice = false;
                        bool isFixedPriceType1 = false;
                        bool isFixedPriceType2 = false;

                        // Calculate all orders remaing invoice amount
                        decimal remainingAmount = 0;
                        decimal remainingVatAmount = 0;
                        decimal remainingAmountIncVat = 0;
                        decimal retainedGuranteeAmount = 0;
                        decimal retainedGuranteeVatAmount = 0;
                        decimal fixedPriceAmount = 0;
                        decimal fixedPriceVatAmount = 0;

                        List<CustomerInvoiceRow> customerInvoiceRows = customerInvoice.ActiveCustomerInvoiceRows.Where(i => i.State == (int)SoeEntityState.Active).OrderBy(i => i.RowNr).ToList();
                        foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoiceRows)
                        {
                            targetRowIds.Add(customerInvoiceRow.CustomerInvoiceRowId);

                            #region CustomerInvoiceRow

                            // Skip rows with hidden attest states
                            if (customerInvoiceRow.AttestStateId.HasValue && hiddenAttestStateIds.Contains(customerInvoiceRow.AttestStateId.Value))
                                continue;

                            #region Product

                            Product product = null;
                            if (customerInvoiceRow.Type == (int)SoeInvoiceRowType.ProductRow)
                            {
                                //valid
                                if (customerInvoiceRow.Product == null)
                                    continue;

                                if (customerInvoiceRow.ProductId.HasValue)
                                    product = ProductManager.GetProduct(customerInvoiceRow.ProductId.Value, false, loadPriceList: true, loadProductUnit: true);
                            }
                            else if (customerInvoiceRow.Type == (int)SoeInvoiceRowType.TextRow || customerInvoiceRow.Type == (int)SoeInvoiceRowType.PageBreakRow || customerInvoiceRow.Type == (int)SoeInvoiceRowType.SubTotalRow)
                            {
                                //valid
                                product = null;
                            }
                            else
                            {
                                //skip
                                continue;
                            }
                            if ((billingInvoiceReportType == SoeBillingInvoiceReportType.Order || billingInvoiceReportType == SoeBillingInvoiceReportType.Offer))
                            {
                                if (customerInvoiceRow.Product != null && fixedPriceProductId != 0 && customerInvoiceRow.ProductId == fixedPriceProductId)
                                {
                                    isFixedPriceType1 = true;
                                    fixedPriceAmount += customerInvoiceRow.Amount;
                                    fixedPriceVatAmount += customerInvoiceRow.VatAmount;
                                }


                                if (customerInvoiceRow.Product != null && fixedPriceKeepPricesProductId != 0 && customerInvoiceRow.ProductId == fixedPriceKeepPricesProductId)
                                {
                                    isFixedPriceType2 = true;
                                    fixedPriceAmount += customerInvoiceRow.Amount;
                                    fixedPriceVatAmount += customerInvoiceRow.VatAmount;
                                }
                            }
                            #endregion
                            int rowHasStateToInvoice = 0;
                            if (customerInvoiceRow.AttestStateId == attestStateTransferredOrderToInvoiceId)
                            {
                                rowHasStateToInvoice = 1;
                            }

                            XElement invoiceRowElement = CreateBillingInvoiceRowElement(invoiceRowXmlId, es, customerInvoiceRow, product, attestStates, vatCodes, householdProductId, household50ProductId, householdRutProductId, householdGreen15ProductId, householdGreen20ProductId, householdGreen50ProductId, fixedPriceProductId, fixedPriceKeepPricesProductId, rowHasStateToInvoice, transactions, useProjectTimeBlock, showSalesPricePermission, productRowDescriptionToUpperCase);
                            if (invoiceRowElement == null)
                                continue;

                            if ((customerInvoiceRow.Product != null && ((InvoiceProduct)customerInvoiceRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift) && (billingInvoiceReportType == SoeBillingInvoiceReportType.Order || billingInvoiceReportType == SoeBillingInvoiceReportType.Offer))
                                orderOfferHasLiftRows = true;

                            invoiceRowElements.Add(invoiceRowElement);
                            invoiceRowXmlId++;

                            #endregion
                        }

                        #region Default element InvoiceRow

                        if (invoiceRowXmlId == 1)
                            invoiceRowElements.Add(new XElement("InvoiceRow", String.Empty));

                        #endregion

                        #endregion

                        #region Remaining amounts

                        if (isBillingInvoiceTemplate)
                        {
                            var invoiceOrders = InvoiceManager.GetInvoiceTraceViews(entities, customerInvoice.InvoiceId, baseSysCurrencyId, isOrder: true);
                            foreach (var orderId in invoiceOrders.Select(x => x.OrderId))
                            {
                                var cusInvoice = InvoiceManager.GetCustomerInvoice(entities, orderId, loadInvoiceRow: true);

                                if (cusInvoice == null)
                                {
                                    LogWarning($"Printing invoice nr {customerInvoice.InvoiceNr} where orderId {orderId} is deleted");
                                }
                                else
                                {
                                    if (cusInvoice.FixedPriceOrder)
                                    {
                                        allIsFixedPrice = true;

                                        bool hasLiftRows = false;
                                        foreach (var cusInvRow in cusInvoice.ActiveCustomerInvoiceRows.Where(r => r.TargetRowId != null && targetRowIds.Contains((int)r.TargetRowId)))
                                        {
                                            if (cusInvRow.Product != null && ((InvoiceProduct)cusInvRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                                            {
                                                hasLiftRows = true;
                                                allHasLiftRows = true;
                                                break;
                                            }
                                        }

                                        foreach (var cusInvRow in cusInvoice.ActiveCustomerInvoiceRows.Where(r => r.TargetRowId == null))
                                        {
                                            //Product is guaranteeamount 
                                            //if (cusInvRow.Product != null && productGuaranteeId != 0 && cusInvRow.ProductId == productGuaranteeId)
                                            //{
                                            //    retainedGuranteeAmount += cusInvRow.Amount;
                                            //}

                                            if (cusInvRow.Product != null && fixedPriceProductId != 0 && cusInvRow.ProductId == fixedPriceProductId)
                                            {
                                                isFixedPriceType1 = true;
                                                fixedPriceAmount += cusInvRow.Amount;
                                                fixedPriceVatAmount += cusInvRow.VatAmount;
                                            }

                                            if (cusInvRow.Product != null && fixedPriceKeepPricesProductId != 0 && cusInvRow.ProductId == fixedPriceKeepPricesProductId)
                                            {
                                                isFixedPriceType2 = true;
                                                fixedPriceAmount += cusInvRow.Amount;
                                                fixedPriceVatAmount += cusInvRow.VatAmount;
                                            }

                                        }
                                        //Product is guaranteeamount only invoiced rows
                                        foreach (var cusInvRow in cusInvoice.ActiveCustomerInvoiceRows.Where(r => r.Product != null && productGuaranteeId != 0 && r.ProductId == productGuaranteeId))
                                        {
                                            if (cusInvRow.TargetRowId != null)
                                            {
                                                if (!cusInvRow.TargetRowReference.IsLoaded)
                                                {
                                                    cusInvRow.TargetRowReference.Load();
                                                    cusInvRow.TargetRow.CustomerInvoiceReference.Load();
                                                }
                                                if (cusInvRow.TargetRow.CustomerInvoice.InvoiceId <= customerInvoice.InvoiceId)
                                                {
                                                    retainedGuranteeAmount += cusInvRow.Amount;
                                                    retainedGuranteeVatAmount += cusInvRow.VatAmount;
                                                }
                                            }
                                            else
                                            {
                                                retainedGuranteeAmount += cusInvRow.Amount;
                                                retainedGuranteeVatAmount += cusInvRow.VatAmount;
                                            }

                                        }

                                        if (hasLiftRows || showRemainingAmountInReport)
                                        {
                                            remainingAmount += cusInvoice.RemainingAmountExVat != null ? (decimal)cusInvoice.RemainingAmountExVat : 0;
                                            remainingVatAmount += cusInvoice.RemainingAmountVat != null ? (decimal)cusInvoice.RemainingAmountVat : 0;
                                            remainingAmountIncVat += cusInvoice.RemainingAmount != null ? (decimal)cusInvoice.RemainingAmount : 0;
                                        }
                                        else
                                        {
                                            allIsFixedPrice = false;
                                            allHasLiftRows = false;
                                            remainingAmount = 0;
                                            remainingVatAmount = 0;
                                            remainingAmountIncVat = 0;
                                            break;
                                        }
                                    }
                                    else
                                    {
                                        bool hasLiftRows = false;
                                        foreach (var cusInvRow in cusInvoice.ActiveCustomerInvoiceRows)
                                        {
                                            if (cusInvRow.Product != null)
                                            {
                                                if (((InvoiceProduct)cusInvRow.Product).CalculationType == (int)TermGroup_InvoiceProductCalculationType.Lift)
                                                {
                                                    hasLiftRows = true;
                                                    allHasLiftRows = true;
                                                }
                                                else if (cusInvRow.ProductId == fixedPriceProductId)
                                                {
                                                    allIsFixedPrice = true;
                                                    isFixedPriceType1 = true;
                                                    fixedPriceAmount += cusInvRow.Amount;
                                                    fixedPriceVatAmount += cusInvRow.VatAmount;
                                                }
                                                else if (cusInvRow.ProductId == fixedPriceKeepPricesProductId)
                                                {
                                                    allIsFixedPrice = true;
                                                    isFixedPriceType2 = true;
                                                    fixedPriceAmount += cusInvRow.Amount;
                                                    fixedPriceVatAmount += cusInvRow.VatAmount;
                                                }
                                                //Product is guaranteeamount only invoiced rows
                                                if (cusInvRow.Product != null && productGuaranteeId != 0 && cusInvRow.ProductId == productGuaranteeId && cusInvRow.TargetRowId != null)
                                                {
                                                    if (!cusInvRow.TargetRowReference.IsLoaded)
                                                    {
                                                        cusInvRow.TargetRowReference.Load();
                                                        cusInvRow.TargetRow.CustomerInvoiceReference.Load();
                                                    }
                                                    if (cusInvRow.TargetRow.CustomerInvoice.InvoiceId > customerInvoice.InvoiceId)
                                                        continue;
                                                    else
                                                    {
                                                        retainedGuranteeAmount += cusInvRow.Amount;
                                                        retainedGuranteeVatAmount += cusInvRow.VatAmount;
                                                    }
                                                }

                                            }
                                        }

                                        if (hasLiftRows || showRemainingAmountInReport)
                                        {
                                            remainingAmount += cusInvoice.RemainingAmountExVat != null ? (decimal)cusInvoice.RemainingAmountExVat : 0;
                                            remainingVatAmount += cusInvoice.RemainingAmountVat != null ? (decimal)cusInvoice.RemainingAmountVat : 0;
                                            remainingAmountIncVat += cusInvoice.RemainingAmount != null ? (decimal)cusInvoice.RemainingAmount : 0;
                                        }
                                        else
                                        {
                                            allIsFixedPrice = false;
                                            allHasLiftRows = false;
                                            remainingAmount = 0;
                                            remainingVatAmount = 0;
                                            remainingAmountIncVat = 0;
                                            break;
                                        }
                                    }
                                }
                            }
                        }

                        //if (billingInvoiceReportType == SoeBillingInvoiceReportType.Invoice)
                        //{
                        //    remainingAmount = customerInvoice.RemainingAmountExVat != null ? (decimal)customerInvoice.RemainingAmountExVat : 0;
                        //    remainingVatAmount = customerInvoice.RemainingAmountVat != null ? (decimal)customerInvoice.RemainingAmountVat : 0;
                        //    remainingAmountIncVat = customerInvoice.RemainingAmount != null ? (decimal)customerInvoice.RemainingAmount : 0;
                        //}

                        if ((billingInvoiceReportType == SoeBillingInvoiceReportType.Order || billingInvoiceReportType == SoeBillingInvoiceReportType.Offer))
                        {
                            remainingAmount = customerInvoice.RemainingAmountExVat != null ? (decimal)customerInvoice.RemainingAmountExVat : 0;
                            remainingVatAmount = customerInvoice.RemainingAmountVat != null ? (decimal)customerInvoice.RemainingAmountVat : 0;
                            remainingAmountIncVat = customerInvoice.RemainingAmount != null ? (decimal)customerInvoice.RemainingAmount : 0;

                            if (orderOfferHasLiftRows)
                            {
                                allHasLiftRows = true;
                            }

                            if (customerInvoice.FixedPriceOrder)
                            {
                                allIsFixedPrice = true;
                            }

                        }

                        int invoiceHasProject = customerInvoice.ProjectId.HasValue ? 1 : 0;
                        int showTimeProject = 0;
                        int showExpenseReport = 0;
                        int showSignatures = 1;

                        #region TimeProjectReport

                        XElement timeProjectReportElement = new XElement("Project");

                        //Deleted as fix for bug 12509
                        /*XElement timeProjectReportElement = new XElement("Project",
                                new XAttribute("id", 1));*/

                        bool includeTimeProjectSetting = false;
                        int nrOfTimeProjectRows = 0;

                        if ((billingInvoiceReportType == SoeBillingInvoiceReportType.Order && orderIncludeTimeProjectinReport) || (billingInvoiceReportType == SoeBillingInvoiceReportType.Invoice && invoiceIncludeTimeProjectinReport))
                            includeTimeProjectSetting = true;

                        /*if (includeTimeProjectSetting && (customerInvoice.ProjectId.HasValue && (es.SB_IncludeProjectReport || es.SB_IncludeProjectReport2)))
                            timeProjectReportElement = CreateTimeProjectElement(entities, es, null, timeCodes, customerInvoice.InvoiceId, es.ActorCompanyId, true, out nrOfTimeProjectRows);

                        if (nrOfTimeProjectRows != 0)
                            showTimeProject = 1;*/

                        #endregion

                        #region ExpenseReport

                        XElement expenseReportElement = new XElement("Expenses");

                        #endregion

                        invoiceHeadElement.Add(new XElement("InvoiceSumRemainingAmount", remainingAmount));
                        invoiceHeadElement.Add(new XElement("InvoiceSumRemainingAmountVat", remainingVatAmount));
                        invoiceHeadElement.Add(new XElement("InvoiceSumRemainingAmountIncVat", remainingAmountIncVat));
                        invoiceHeadElement.Add(new XElement("InvoiceHasLiftRows", allHasLiftRows));
                        invoiceHeadElement.Add(new XElement("InvoiceHasFixedPriceRows", allIsFixedPrice));
                        invoiceHeadElement.Add(new XElement("InvoiceIsFixedPriceType1", isFixedPriceType1));
                        invoiceHeadElement.Add(new XElement("InvoiceIsFixedPriceType2", isFixedPriceType2));
                        invoiceHeadElement.Add(new XElement("InvoiceRetainedGuaranteeAmount", retainedGuranteeAmount));
                        invoiceHeadElement.Add(new XElement("InvoiceRetainedGuaranteeVatAmount", Math.Abs(retainedGuranteeVatAmount)));
                        invoiceHeadElement.Add(new XElement("InvoiceFixedPriceAmount", fixedPriceAmount));
                        invoiceHeadElement.Add(new XElement("InvoiceFixedPriceVatAmount", fixedPriceVatAmount));
                        invoiceHeadElement.Add(new XElement("InvoiceHasProject", invoiceHasProject));
                        invoiceHeadElement.Add(new XElement("ShowTimeProjectReport", showTimeProject));
                        invoiceHeadElement.Add(new XElement("ShowExpenseReport", showExpenseReport));
                        invoiceHeadElement.Add(new XElement("ShowSignatures", showSignatures));


                        bool hasPreviousInvoices = false;

                        if (previousInvoices.Count > 0 && isBillingInvoiceTemplate)
                        {
                            hasPreviousInvoices = true;
                        }

                        if (hasPreviousInvoices)
                            invoiceHeadElement.Add(new XElement("HasPreviousInvoices", "1"));
                        else
                            invoiceHeadElement.Add(new XElement("HasPreviousInvoices", "0"));

                        invoiceHeadElement.Add(new XElement("ShowRemainingAmountInReport", showRemainingAmountInReport ? "1" : "0"));

                        invoiceHeadElement.Add(new XElement("IsOneTimeCustomer", isOneTimeCustomer ? "1" : "0"));

                        Contact custContact = ContactManager.GetContactFromActor(customer.ActorCustomerId, loadActor: true, loadAllContactInfo: true);
                        string phoneMobile = string.Empty;
                        if (custContact != null && custContact.ContactECom != null)
                        {
                            foreach (var contactEComItem in custContact.ContactECom)
                            {
                                if (contactEComItem.SysContactEComTypeId == (int)TermGroup_SysContactEComType.PhoneMobile)
                                    phoneMobile = contactEComItem.Text;
                            }
                        }
                        invoiceHeadElement.Add(new XElement("CustomerPhoneNr", isOneTimeCustomer ? customerInvoice.CustomerPhoneNr : phoneMobile));
                        #endregion

                        #region Contract values

                        string contractGroupName = "", contractGroupPeriodType = "", contractNextYear = "", contractNextPeriod = "", contractEndYear = "", contractEndPeriod = "", contractCategoryName = "";

                        if (originType == SoeOriginType.Contract)
                        {
                            if (customerInvoice.ContractGroup != null)
                            {
                                contractGroupName = customerInvoice.ContractGroup.Name;
                                GenericType periodType = contractGroupPeriodTerms.FirstOrDefault(p => p.Id == customerInvoice.ContractGroup.Period);
                                if (periodType != null)
                                    contractGroupPeriodType = periodType.Name;

                                contractNextYear = customerInvoice.NextContractPeriodYear.ToString();
                                contractNextPeriod = customerInvoice.NextContractPeriodValue.ToString();

                                if (customerInvoice.DueDate.HasValue)
                                {
                                    Tuple<int, int> tuple = CalendarUtility.CalculateCurrentPeriod((TermGroup_ContractGroupPeriod)customerInvoice.ContractGroup.Period, customerInvoice.DueDate.Value);
                                    contractEndYear = tuple.Item1.ToString();
                                    contractEndPeriod = tuple.Item2.ToString();
                                }
                            }
                            Category category = CategoryManager.GetCategory(SoeCategoryType.Contract, SoeCategoryRecordEntity.Contract, customerInvoice.InvoiceId, (int)customerInvoice.Origin.ActorCompanyId, onlyDefaultCategory: false);
                            if (category != null)
                            {
                                //contractCategoryCode = category.Code;
                                contractCategoryName = category.Name;
                            }
                        }

                        invoiceHeadElement.Add(new XElement("ContractGroupName", contractGroupName));
                        invoiceHeadElement.Add(new XElement("ContractGroupPeriodType", contractGroupPeriodType));
                        invoiceHeadElement.Add(new XElement("ContractNextYear", contractNextYear));
                        invoiceHeadElement.Add(new XElement("ContractNextPeriod", contractNextPeriod));
                        invoiceHeadElement.Add(new XElement("ContractEndYear", contractEndYear));
                        invoiceHeadElement.Add(new XElement("ContractEndPeriod", contractEndPeriod));
                        invoiceHeadElement.Add(new XElement("ContractCategoryName", contractCategoryName));

                        #endregion

                        invoiceHeadElement.Add(new XElement("InvoiceReminderFee", reminderAmount));
                        invoiceHeadElement.Add(new XElement("InvoiceInterestAmount", interestAmount));

                        #region QRCode

                        string qrLink = string.Empty;

                        if (es.GetDetailedInformation && !string.IsNullOrEmpty(customerInvoice.InvoiceNr) && customerInvoice.InvoiceDate.HasValue && customerInvoice.DueDate.HasValue)
                        {
                            QRCode qrCode = new QRCode();

                            string invoiceReference = !string.IsNullOrEmpty(customerInvoice.OCR) ? customerInvoice.OCR : "Nr: " + customerInvoice.InvoiceNr;

                            if (!string.IsNullOrEmpty(bg))
                                qrLink = CreateInvoiceQR(entities, qrCode, invoiceReference, distributionPostalAddress, (DateTime)customerInvoice.InvoiceDate, (DateTime)customerInvoice.DueDate, customerInvoice.TotalAmountCurrency, customerInvoice.VATAmountCurrency, Company.Name, sysCurrency != null ? sysCurrency.Code : "", Company.OrgNr, TermGroup_SysPaymentType.BG, bg);
                            else if (!string.IsNullOrEmpty(pg))
                                qrLink = CreateInvoiceQR(entities, qrCode, invoiceReference, distributionPostalAddress, (DateTime)customerInvoice.InvoiceDate, (DateTime)customerInvoice.DueDate, customerInvoice.TotalAmountCurrency, customerInvoice.VATAmountCurrency, Company.Name, sysCurrency != null ? sysCurrency.Code : "", Company.OrgNr, TermGroup_SysPaymentType.PG, pg);
                        }

                        invoiceHeadElement.Add(new XElement("QrLink", qrLink));

                        #endregion

                        //Add rows
                        foreach (XElement el in invoiceRowElements)
                            invoiceHeadElement.Add(el);

                        #region PreviousInvoiceHead

                        int previousInvoiceHeadXmlId = 1;
                        if (isBillingInvoiceTemplate)
                        {
                            #region Previous invoices

                            foreach (var previousInvoice in previousInvoices)
                            {
                                //Exclude preliminary and invoices with higher number
                                bool valid = !String.IsNullOrEmpty(previousInvoice.Number) && Validator.ValidateStringInterval(previousInvoice.Number, customerInvoice.InvoiceNr);
                                if (!valid)
                                    continue;
                                //Exclude deleted invoices
                                if (previousInvoice.State == SoeEntityState.Deleted)
                                    continue;
                                XElement previousInvoiceHeadElement = new XElement("PreviousInvoiceHead");
                                previousInvoiceHeadElement.Add(
                                    new XAttribute("id", previousInvoiceHeadXmlId),
                                    new XElement("PreviousInvoiceInvoiceNr", previousInvoice.Number),
                                    new XElement("PreviousInvoiceInvoiceVatAmount", previousInvoice.VatAmount),
                                    new XElement("PreviousInvoiceInvoiceTotalAmount", previousInvoice.AmountCurrency),
                                    new XElement("PreviousInvoiceInvoiceTotalAmountBase", previousInvoice.Amount),
                                    new XElement("PreviousInvoiceInvoiceDate", previousInvoice.Date ?? CalendarUtility.DATETIME_DEFAULT));

                                invoiceHeadElement.Add(previousInvoiceHeadElement);
                                previousInvoiceHeadXmlId++;
                            }

                            #endregion
                        }
                        else if (isBillingOrderTemplate)
                        {
                            #region Previous orders

                            foreach (var previousOrder in previousOrders)
                            {
                                //Exclude preliminary and orders with higher number
                                bool valid = !String.IsNullOrEmpty(previousOrder.Number) && Validator.ValidateStringInterval(previousOrder.Number, customerInvoice.InvoiceNr);
                                if (!valid)
                                    continue;

                                XElement previousInvoiceHeadElement = new XElement("PreviousInvoiceHead");
                                previousInvoiceHeadElement.Add(
                                    new XAttribute("id", previousInvoiceHeadXmlId),
                                    new XElement("PreviousInvoiceInvoiceNr", previousOrder.Number),
                                    new XElement("PreviousInvoiceInvoiceVatAmount", previousOrder.VatAmount),
                                    new XElement("PreviousInvoiceInvoiceTotalAmount", previousOrder.AmountCurrency),
                                    new XElement("PreviousInvoiceInvoiceTotalAmountBase", previousOrder.Amount),
                                    new XElement("PreviousInvoiceInvoiceDate", previousOrder.Date ?? CalendarUtility.DATETIME_DEFAULT));

                                invoiceHeadElement.Add(previousInvoiceHeadElement);

                                previousInvoiceHeadXmlId++;
                            }

                            #endregion
                        }

                        #region Default element PreviousInvoiceHead

                        if (previousInvoiceHeadXmlId == 1)
                            invoiceHeadElement.Add(new XElement("PreviousInvoiceHead", String.Empty));

                        #endregion

                        #endregion

                        #region OriginInvoiceHead

                        int originInvoiceHeadXmlId = 1;
                        if (isBillingInvoiceReminderTemplate)
                        {
                            #region Reminder

                            foreach (CustomerInvoice originInvoice in originInvoices)
                            {
                                XElement originInvoiceHeadElement = new XElement("OriginInvoiceHead");
                                originInvoiceHeadElement.Add(
                                    new XAttribute("id", originInvoiceHeadXmlId),
                                    new XElement("InvoiceDate", originInvoice.InvoiceDate),
                                    new XElement("InvoiceDueDate", originInvoice.DueDate),
                                    new XElement("InvoiceNr", originInvoice.InvoiceNr),
                                    new XElement("InvoiceOCR", originInvoice.OCR),
                                    new XElement("InvoiceTotalAmount", originInvoice.TotalAmountCurrency),
                                    new XElement("InvoiceTotalAmountBase", originInvoice.TotalAmount),
                                    new XElement("InvoiceVatAmount", originInvoice.VATAmountCurrency),
                                    new XElement("InvoiceVatAmountBase", originInvoice.VATAmount),
                                    new XElement("InvoicePaidAmount", originInvoice.PaidAmountCurrency),
                                    new XElement("InvoicePaidAmountBase", originInvoice.PaidAmount),
                                    new XElement("OverduedDays", customerInvoice.InvoiceDate.HasValue && originInvoice.DueDate.HasValue ? customerInvoice.InvoiceDate.Value.Subtract(originInvoice.DueDate.Value).TotalDays : 0),
                                    new XElement("ClaimLevel", originInvoice.NoOfReminders),
                                    new XElement("ClaimText", InvoiceManager.GetClaimText(originInvoice, es.ActorCompanyId)));

                                invoiceHeadElement.Add(originInvoiceHeadElement);
                                originInvoiceHeadXmlId++;
                            }

                            #endregion
                        }
                        else if (isBillingInvoiceInterestTemplate)
                        {
                            #region Interest

                            foreach (CustomerInvoice originInvoice in originInvoices)
                            {
                                XElement originInvoiceHeadElement = new XElement("OriginInvoiceHead");
                                originInvoiceHeadElement.Add(
                                    new XAttribute("id", originInvoiceHeadXmlId),
                                    new XElement("InvoiceDate", originInvoice.InvoiceDate),
                                    new XElement("InvoiceDueDate", originInvoice.DueDate),
                                    new XElement("InvoiceNr", originInvoice.InvoiceNr),
                                    new XElement("InvoiceOCR", originInvoice.OCR),
                                    new XElement("InvoiceTotalAmount", originInvoice.TotalAmountCurrency),
                                    new XElement("InvoiceTotalAmountBase", originInvoice.TotalAmount),
                                    new XElement("InvoiceVatAmount", originInvoice.VATAmountCurrency),
                                    new XElement("InvoiceVatAmountBase", originInvoice.VATAmount),
                                    new XElement("InvoicePaidAmount", originInvoice.PaidAmountCurrency),
                                    new XElement("InvoicePaidAmountBase", originInvoice.PaidAmount),
                                    new XElement("OverduedDays", customerInvoice.InvoiceDate.HasValue && originInvoice.DueDate.HasValue ? customerInvoice.InvoiceDate.Value.Subtract(originInvoice.DueDate.Value).TotalDays : 0),
                                    new XElement("ClaimLevel", 0),
                                    new XElement("ClaimText", String.Empty));

                                invoiceHeadElement.Add(originInvoiceHeadElement);
                                originInvoiceHeadXmlId++;
                            }

                            #endregion
                        }

                        #region Default element OriginInvoiceHead

                        if (originInvoiceHeadXmlId == 1)
                        {
                            XElement originInvoiceHeadElement = new XElement("OriginInvoiceHead");
                            originInvoiceHeadElement.Add(
                                new XAttribute("id", originInvoiceHeadXmlId),
                                new XElement("InvoiceDate", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("InvoiceDueDate", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("InvoiceNr", String.Empty),
                                new XElement("InvoiceOCR", String.Empty),
                                new XElement("InvoiceTotalAmount", Decimal.Zero),
                                new XElement("InvoiceTotalAmountBase", Decimal.Zero),
                                new XElement("InvoiceVatAmount", Decimal.Zero),
                                new XElement("InvoiceVatAmountBase", Decimal.Zero),
                                new XElement("InvoicePaidAmount", Decimal.Zero),
                                new XElement("InvoicePaidAmountBase", Decimal.Zero),
                                new XElement("OverduedDays", 0),
                                new XElement("ClaimLevel", 0),
                                new XElement("ClaimText", 0));
                        }

                        #endregion

                        #endregion

                        #region OriginUser

                        int originUserXmlId = 1;
                        foreach (var originUser in originUsers)
                        {
                            XElement originInvoiceHeadElement = new XElement("OriginUser");
                            originInvoiceHeadElement.Add(
                                new XAttribute("id", originUserXmlId),
                                new XElement("Name", originUser.Name),
                                new XElement("LoginName", originUser.LoginName),
                                new XElement("Main", originUser.Main.ToInt()));

                            invoiceHeadElement.Add(originInvoiceHeadElement);
                            originInvoiceHeadXmlId++;
                        }

                        #region Default element OriginUser

                        if (originUserXmlId == 1)
                        {
                            XElement originInvoiceHeadElement = new XElement("OriginUser");
                            originInvoiceHeadElement.Add(
                                new XAttribute("id", originInvoiceHeadXmlId),
                                new XElement("Name", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("LoginName", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("Main", 0));
                        }

                        #endregion

                        #endregion

                        #region Signature

                        List<XElement> invoiceSignatures = null;

                        if (isBillingOrderTemplate)
                        {
                            invoiceSignatures = CreateInvoiceSignatureElements(customerInvoice.InvoiceId);
                            invoiceHeadElement.Add(invoiceSignatures);
                        }

                        if (invoiceSignatures == null && invoiceHeadXmlId == 1)
                        {

                            string description = "";
                            string imagePath = "";
                            string type = "0";

                            XElement invoiceSignatureImage = new XElement("InvoiceSignatureImage",
                                new XAttribute("id", 1),
                                new XElement("ImagePath", imagePath),
                                new XElement("Type", type),
                                new XElement("Description", description));

                            invoiceHeadElement.Add(invoiceSignatureImage);
                        }

                        #endregion

                        #region TimeProjectReport

                        if (includeTimeProjectSetting && customerInvoice.PrintTimeReport && (customerInvoice.ProjectId.HasValue && (es.SB_IncludeProjectReport || es.SB_IncludeProjectReport2)))
                        {
                            // Reset only invoiced
                            es.SB_IncludeOnlyInvoiced = customerInvoice.IncludeOnlyInvoicedTime;

                            //invoiceHeadElement.Add(timeProjectReportElement);
                            invoiceHeadElement = CreateTimeProjectElement(entities, es, invoiceHeadElement, timeCodes, customerInvoice.InvoiceId, es.ActorCompanyId, true, out nrOfTimeProjectRows);

                            if (nrOfTimeProjectRows != 0)
                            {
                                invoiceHeadElement.SetElementValue("ShowTimeProjectReport", 1);
                            }
                        }
                        else if (invoiceHeadXmlId == 1)
                        {
                            #region Default element Project

                            timeProjectReportElement = new XElement("Project",
                                new XAttribute("id", 1),
                                new XElement("ProjectNumber", ""),
                                new XElement("ProjectName", ""),
                                new XElement("ProjectDescription", ""),
                                new XElement("ProjectInvoiceNr", ""),
                                new XElement("ProjectCreated", "00:00"),
                                new XElement("ProjectCreatedBy", ""),
                                new XElement("ProjectState", 0));

                            XElement defaultEmployeeElement = new XElement("Employee",
                                new XAttribute("id", 1),
                                new XElement("EmployeeNr", 0),
                                new XElement("EmployeeName", ""));

                            XElement defaultDayElement = new XElement("ProjectInvoiceDay",
                                new XAttribute("id", 1),
                                new XElement("InvoiceTimeInMinutes", 0),
                                new XElement("Date", CalendarUtility.DATETIME_DEFAULT),
                                new XElement("Note", "00:00"),
                                new XElement("ExternalNote", string.Empty),
                                new XElement("IsoDate", DateTime.Now.Date.ToString("yyyy-MM-dd")),
                                new XElement("TDName", string.Empty),
                                new XElement("TBStartTime", DateTime.Now.TimeOfDay.ToShortTimeString()),
                                new XElement("TBStopTime", DateTime.Now.TimeOfDay.ToShortTimeString()));

                            defaultEmployeeElement.Add(defaultDayElement);
                            timeProjectReportElement.Add(defaultEmployeeElement);
                            invoiceHeadElement.Add(timeProjectReportElement);
                        }

                        #endregion

                        #endregion

                        #region ExpenseReport

                        expenseReportElement = CreateExpenseElement(entities, es, expenseReportElement, customerInvoice, customerInvoice.IncludeExpenseInReport, out int nrOfExpenseRows);
                        invoiceHeadElement.Add(expenseReportElement);
                        if (nrOfExpenseRows != 0)
                        {
                            invoiceHeadElement.SetElementValue("ShowExpenseReport", 1);
                        }

                        #endregion

                        #region InvoicePayments

                        XElement invoicePaymentElements = new XElement("Payments");
                        int invoicePaymentXmlId = 1;

                        List<PaymentRow> paymentRows = PaymentManager.GetPaymentRowsByInvoice(customerInvoice.InvoiceId, false, true);

                        if (paymentRows.Count > 0)
                            foreach (var paymentRow in paymentRows)
                            {
                                if (es.SB_HasPaymentDateInterval && paymentRow.PayDate < es.SB_PaymentDateFrom)
                                {
                                    if (paymentRow.PayDate < es.SB_PaymentDateFrom || paymentRow.PayDate > es.SB_PaymentDateTo.AddHours(23).AddMinutes(59))
                                        continue;
                                }

                                if (paymentRow.Status == (int)SoePaymentStatus.Cancel)
                                {
                                    continue;
                                }

                                XElement paymentElement = new XElement("Payment");
                                paymentElement.Add(
                                    new XAttribute("id", invoicePaymentXmlId),
                                    new XElement("InvoiceNr", customerInvoice.InvoiceNr),
                                    new XElement("PaymentMethodName", paymentRow.Payment.PaymentMethod.Name),
                                    new XElement("PaymentDate", paymentRow.PayDate.ToShortDateString()),
                                    new XElement("PaymentAmount", paymentRow.Amount));

                                invoicePaymentElements.Add(paymentElement);
                                invoicePaymentXmlId++;
                            }
                        if (invoicePaymentXmlId > 1)
                        {
                            invoiceHeadElement.Add(invoicePaymentElements);
                        }
                        #endregion

                        #region Default element InvoicePayment

                        if (invoicePaymentXmlId == 1)
                        {
                            XElement defInvoiceElement = new XElement("Payments");
                            XElement defpaymentElement = new XElement("Payment",
                                        new XAttribute("id", 1),
                                        new XElement("InvoiceNr", " "),
                                        new XElement("PaymentMethodName", " "),
                                        new XElement("PaymentDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                        new XElement("PaymentAmount", 0));
                            defInvoiceElement.Add(defpaymentElement);
                            invoiceHeadElement.Add(defInvoiceElement);
                        }
                        //     invoiceHeadElement.Add(new XElement("Payments", String.Empty));

                        #endregion

                        #endregion

                        invoiceHeadElements.Add(invoiceHeadElement);
                        invoiceHeadXmlId++;
                    }

                    repository.SaveHistory();

                    #endregion
                }

                if (invoiceHeadXmlId == 1)
                {
                    var invoiceHeadElement = new XElement("InvoiceHead",
                        new XAttribute("id", 1));

                    invoiceHeadElement.Add(new XElement("InvoiceRow", new XAttribute("id", 1)));
                    invoiceHeadElement.Add(new XElement("PreviousInvoiceHead", new XAttribute("id", 1)));
                    invoiceHeadElement.Add(new XElement("OriginInvoiceHead", new XAttribute("id", 1)));
                    invoiceHeadElement.Add(new XElement("OriginUser", new XAttribute("id", 1)));
                    invoiceHeadElements.Add(invoiceHeadElement);
                }

                #region Set Printed

                if (isInvoiceTemplate && es.ReportTemplateType != SoeReportTemplateType.OriginStatisticsReport)
                    InvoiceManager.SetCustomerInvoiceAsPrinted(entities, customerInvoices);

                #endregion

                #region Set ReportName

                if (customerNameDict.Count > 0)
                {
                    int min = customerNameDict.Keys.Min();
                    int max = customerNameDict.Keys.Max();
                    if (min == max)
                    {
                        es.ReportNamePostfix = min.ToString();
                        es.ReportNamePostfix += " ";
                        es.ReportNamePostfix += customerNameDict[min];
                    }
                    else
                        es.ReportNamePostfix = min.ToString() + "-" + max.ToString();
                }

                #endregion

                #endregion
            }

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = new XElement(CreateBillingReportHeaderLabelsElement(es.ReportTemplateType));
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateBillingInvoiceHeadReportHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType, doPrintTaxBillText);
            CreateBillingInvoiceRowsReportHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType);

            #endregion

            #region PreviousInvoices

            string previousInvoicesLabel = "";
            if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrder))
                previousInvoicesLabel = GetReportText(292, "Tidigare ordrar");
            else
                previousInvoicesLabel = GetReportText(293, "Tidigare fakturor");

            pageHeaderLabelsElement.Add(
                new XElement("PreviousInvoicesLabel", previousInvoicesLabel));

            //Get AccountDims and add AccountDimLabelElements
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);
            AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);

            #endregion

            #region Contract labels

            pageHeaderLabelsElement.Add(new XElement("ContractGroupNameLabel", GetReportText(806, "Avtalsgrupp")));
            pageHeaderLabelsElement.Add(new XElement("ContractGroupPeriodTypeLabel", GetReportText(807, "Period")));
            pageHeaderLabelsElement.Add(new XElement("ContractNextYearLabel", GetReportText(808, "Nästa år")));
            pageHeaderLabelsElement.Add(new XElement("ContractNextPeriodLabel", GetReportText(809, "Nästa period")));
            pageHeaderLabelsElement.Add(new XElement("ContractEndYearLabel", GetReportText(810, "Avslutsår")));
            pageHeaderLabelsElement.Add(new XElement("ContractEndPeriodLabel", GetReportText(811, "Avslutsperiod")));
            pageHeaderLabelsElement.Add(new XElement("ContractCategoryNameLabel", GetReportText(815, "Avtalskategori")));

            #endregion

            #region Weight

            pageHeaderLabelsElement.Add(new XElement("InvoiceRowProductWeightLabel", GetReportText(1047, "Vikt")));
            pageHeaderLabelsElement.Add(new XElement("InvoiceRowTotalWeightLabel", GetReportText(1048, "Totalvikt")));

            #endregion

            #region Close document

            billingInvoiceElement.Add(reportHeaderLabelsElement);
            billingInvoiceElement.Add(reportHeaderElement);
            billingInvoiceElement.Add(pageHeaderLabelsElement);

            foreach (XElement invoiceHeadElement in invoiceHeadElements)
            {
                billingInvoiceElement.Add(invoiceHeadElement);
            }

            rootElement.Add(billingInvoiceElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.BillingInvoice);

            #endregion
        }

        private XDocument CreateBillingStatisticsData(EvaluatedSelection es)
        {
            if (es.ReportTemplateType != SoeReportTemplateType.BillingStatisticsReport)
                return null;

            #region Prereq

            if (es == null)
                return null;

            bool isBillingContractTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingContract);
            bool isBillingOrderTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrder);
            bool isBillingOfferTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOffer);
            bool isBillingInvoiceTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice);
            bool isBillingInvoiceInterestTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoiceInterest);
            bool isBillingInvoiceReminderTemplate = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoiceReminder);
            bool isInvoiceTemplate = isBillingInvoiceTemplate || isBillingInvoiceInterestTemplate || isBillingInvoiceReminderTemplate;
            bool isOriginStatistics = es.ReportTemplateType.IsValidIn(SoeReportTemplateType.OriginStatisticsReport);

            //permissions
            bool showSalesPricePermission = FeatureManager.HasRolePermission(Feature.Billing_Product_Products_ShowSalesPrice, Permission.Readonly, base.RoleId, base.ActorCompanyId);

            //Get settings
            int baseSysCurrencyId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.CoreBaseCurrency, 0, es.ActorCompanyId, 0);
            decimal interestPercent = SettingManager.GetDecimalSetting(SettingMainType.Company, (int)CompanySettingType.CustomerInterestPercent, 0, es.ActorCompanyId, 0);
            bool showOrdernrOnInvoiceReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingShowOrdernrOnInvoiceReport, 0, es.ActorCompanyId, 0);
            bool doPrintTaxBillText = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingPrintTaxBillText, 0, es.ActorCompanyId, 0);
            bool showCOLabel = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingShowCOLabelOnReport, 0, es.ActorCompanyId, 0);
            bool showRemainingAmountInReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingIncludeRemainingAmountOnInvoice, 0, es.ActorCompanyId, 0);
            bool UseDeliveryAddressAsBillingAddress = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseDeliveryAddressAsInvoiceAddress, 0, es.ActorCompanyId, 0);
            int attestStateTransferredOrderToInvoiceId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, 0, es.ActorCompanyId, 0);
            //Disregard copies for interest and reminder, until separate setting exists for them
            if (isBillingInvoiceInterestTemplate || isBillingInvoiceReminderTemplate)
                es.SB_DisableInvoiceCopies = true;

            int nbrOfCopies;
            if (es.SB_DisableInvoiceCopies)
                nbrOfCopies = 0;
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingContract))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfContractCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOffer))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfOfferCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrder))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfOrderCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingInvoice))
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfCopies, 0, es.ActorCompanyId, 0);
            else if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.OriginStatisticsReport))
                nbrOfCopies = 0;
            else
                nbrOfCopies = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingNbrOfCopies, 0, es.ActorCompanyId, 0);

            // Never send email copys
            if (nbrOfCopies > 0 && es.EmailTemplateId != null && es.EmailTemplateId != 0)
            {
                nbrOfCopies = 0;
            }

            //Get SysCurrencies
            List<SysCurrency> sysCurrencies = CountryCurrencyManager.GetSysCurrencies(true);

            //AttestLevels
            string attestLevelInitial = string.Empty;
            string attestLevelToInvoice = string.Empty;
            string attestLevelMobileReady = string.Empty;
            string attestLevelOfferToOrder = string.Empty;

            if (es.ReportTemplateType == SoeReportTemplateType.BillingOrder || es.ReportTemplateType == SoeReportTemplateType.OriginStatisticsReport)
            {
                var initialAttestState = AttestManager.GetInitialAttestState(es.ActorCompanyId, TermGroup_AttestEntity.Order);
                attestLevelInitial = initialAttestState != null ? initialAttestState.Name : string.Empty;

                int defaultStatusTransferredOrderToInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, 0, es.ActorCompanyId, 0);
                int defaultStatusTransferredOrderReadyMobile = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusOrderReadyMobile, 0, es.ActorCompanyId, 0);

                var orderToInvoiceAttestState = AttestManager.GetAttestState(defaultStatusTransferredOrderToInvoice);
                attestLevelToInvoice = orderToInvoiceAttestState != null ? orderToInvoiceAttestState.Name : string.Empty;

                var orderReadyMobileAttestState = AttestManager.GetAttestState(defaultStatusTransferredOrderReadyMobile);
                attestLevelMobileReady = orderReadyMobileAttestState != null ? orderReadyMobileAttestState.Name : string.Empty;
            }

            if (es.ReportTemplateType == SoeReportTemplateType.BillingOffer)
            {
                var initialAttestState = AttestManager.GetInitialAttestState(es.ActorCompanyId, TermGroup_AttestEntity.Offer);
                attestLevelInitial = initialAttestState != null ? initialAttestState.Name : string.Empty;

                int defaultStatusTransferredOfferToInvoice = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOfferToInvoice, 0, es.ActorCompanyId, 0);
                int defaultStatusTransferredOfferToOrder = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOfferToOrder, 0, es.ActorCompanyId, 0);

                var offerToInvoiceAttestState = AttestManager.GetAttestState(defaultStatusTransferredOfferToInvoice);
                attestLevelToInvoice = offerToInvoiceAttestState != null ? offerToInvoiceAttestState.Name : string.Empty;

                var offerToOrderAttestState = AttestManager.GetAttestState(defaultStatusTransferredOfferToOrder);
                attestLevelOfferToOrder = offerToOrderAttestState != null ? offerToOrderAttestState.Name : string.Empty;
            }

            List<TermGroup_AttestEntity> entitys = new List<TermGroup_AttestEntity>()
            {
                TermGroup_AttestEntity.Order,
                TermGroup_AttestEntity.Offer,
            };
            List<AttestState> attestStates = AttestManager.GetAttestStates(es.ActorCompanyId, entitys, SoeModule.Billing);

            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(es.ActorCompanyId);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();

            //Language
            reportLanguageId = es.SB_ReportLanguageId;
            if (es.SB_ReportLanguageId == 0)
            {
                switch (Company.SysCountryId)
                {
                    case (int)TermGroup_Country.SE:
                        reportLanguageId = (int)TermGroup_Languages.Swedish;
                        break;
                    case (int)TermGroup_Country.FI:
                        reportLanguageId = (int)TermGroup_Languages.Finnish;
                        break;
                    case (int)TermGroup_Country.GB:
                        reportLanguageId = (int)TermGroup_Languages.English;
                        break;
                    case (int)TermGroup_Country.NO:
                        reportLanguageId = (int)TermGroup_Languages.Norwegian;
                        break;
                    case (int)TermGroup_Country.DK:
                        reportLanguageId = (int)TermGroup_Languages.Danish;
                        break;
                }
            }

            if (reportLanguageId == 0)
                reportLanguageId = GetLangId();

            SetLanguage(LanguageManager.GetSysLanguageCode(reportLanguageId));

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "BillingStatistics");

            //VoucherList
            XElement BillingStatistics = new XElement("BillingStatistic");

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateBillingReportHeaderElement(es);
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
            reportHeaderElement.Add(new XElement("AttestLevelInitial", attestLevelInitial));
            reportHeaderElement.Add(new XElement("AttestLevelInvoiced", attestLevelToInvoice));
            reportHeaderElement.Add(new XElement("AttestLevelMobileReady", attestLevelMobileReady));
            reportHeaderElement.Add(new XElement("AttestLevelOfferToOrder", attestLevelOfferToOrder));

            #region Sort and Specials

            reportHeaderElement.Add(new XElement("SortByLevel1", es.SortByLevel1));
            reportHeaderElement.Add(new XElement("SortByLevel2", es.SortByLevel2));
            reportHeaderElement.Add(new XElement("SortByLevel3", es.SortByLevel3));
            reportHeaderElement.Add(new XElement("SortByLevel4", es.SortByLevel4));
            reportHeaderElement.Add(new XElement("IsSortAscending", es.IsSortAscending));
            reportHeaderElement.Add(new XElement("GroupByLevel1", es.GroupByLevel1));
            reportHeaderElement.Add(new XElement("GroupByLevel2", es.GroupByLevel2));
            reportHeaderElement.Add(new XElement("GroupByLevel3", es.GroupByLevel3));
            reportHeaderElement.Add(new XElement("GroupByLevel4", es.GroupByLevel4));
            reportHeaderElement.Add(new XElement("Special", es.Special));
            reportHeaderElement.Add(new XElement("HidePrice", !showSalesPricePermission));
            reportHeaderElement.Add(new XElement("PeriodFrom", es.SB_PeriodFrom));
            reportHeaderElement.Add(new XElement("PeriodTo", es.SB_PeriodTo));

            #endregion

            #endregion

            //           List<XElement> billingStatisticsElements = new XElement("BillingStatisticsElements");
            XElement billingStatisticsElements = new XElement("BillingStatisticsElements");

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                if ((!String.IsNullOrEmpty(es.SB_ProjectNrFrom)) && (String.IsNullOrEmpty(es.SB_ProductNrFrom)))
                {
                    es.SB_ProductNrFrom = es.SB_ProjectNrFrom + 'B';
                }
                if ((!String.IsNullOrEmpty(es.SB_ProjectNrTo)) && (String.IsNullOrEmpty(es.SB_ProductNrTo)))
                {
                    es.SB_ProductNrTo = es.SB_ProjectNrTo + 'R';
                }
                es.SB_PeriodFrom = es.DateFrom.Date.ToString();
                es.SB_PeriodTo = es.DateTo.Date.ToString();
                es.DateFrom = DateTime.MinValue;
                //Get AccountDims
                AccountDim accountDimStds = AccountManager.GetAccountDimStd(es.ActorCompanyId);

                List<AccountStd> accountStdsInInterval = new List<AccountStd>();
                List<AccountInternal> accountInternalsInInterval = new List<AccountInternal>();
                Dictionary<int, string> customerNameDict = new Dictionary<int, string>();


                var accountDims = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId);

                var projAccountDim = accountDims.FirstOrDefault(x => x.SysSieDimNr == 6);
                if ((!String.IsNullOrEmpty(es.SB_ProjectNrTo)))
                {
                    if (es.SA_AccountIntervals == null)
                    {
                        es.SA_HasAccountInterval = true;
                        es.SA_AccountIntervals = new List<AccountIntervalDTO>();
                    }

                    es.SA_AccountIntervals.Add(
                    new AccountIntervalDTO()
                    {
                        AccountDimId = projAccountDim.AccountDimId,
                        AccountNrFrom = es.SB_ProjectNrFrom,
                        AccountNrTo = es.SB_ProjectNrTo,
                    }
                    );
                }

                bool validSelection = AccountManager.GetAccountsInInterval(entities, es, accountDimStds, false, ref accountStdsInInterval, ref accountInternalsInInterval);
                var accountInternalIds = accountInternalsInInterval.Select(a => a.AccountId).ToList();

                int statRowXmlId = 1;
                int year;
                int month;
                int week;
                string yearMonthStr;
                decimal yearMonth;
                decimal yearWeek;
                // Increase the command timeout
                entities.CommandTimeout = 180; // 3 minutes

                //Get invoice rows
                var invoiceRowsGrouped = entities.GetSalesStatisticsFromAccounts(es.ActorCompanyId, es.DateFrom, es.DateTo, es.SB_ProductNrFrom, es.SB_ProductNrTo).GroupBy(r => r.CustomerInvoiceRowId);




                #endregion

                //       #endregion

                #region Content

                //Fixed price setting (fixedprice type 1)
                int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, es.ActorCompanyId, 0);
                //Fixed price keep prices setting (fixedprice type 2)
                int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, es.ActorCompanyId, 0);
                //Guarantee setting
                int productGuaranteeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, es.ActorCompanyId, 0);


                foreach (var groupedRow in invoiceRowsGrouped)
                {
                    // Handle data for common 
                    var mainRow = groupedRow.FirstOrDefault();

                    if (!string.IsNullOrEmpty(es.SB_ProductNrFrom) && (!StringUtility.IsInInterval(mainRow.ProductNumber, es.SB_ProductNrFrom, es.SB_ProductNrTo)))
                    {
                        continue;
                    }
                    week = CalendarUtility.GetWeekNr(mainRow.InvoiceDate.Value);
                    year = mainRow.InvoiceDate.ToValueOrDefault().Year;
                    month = mainRow.InvoiceDate.ToValueOrDefault().Month;
                    yearMonthStr = (year.ToString() + month.ToString());
                    yearMonth = NumberUtility.ToDecimal(yearMonthStr);
                    yearMonthStr = (year.ToString() + week.ToString());
                    yearWeek = NumberUtility.ToDecimal(yearMonthStr);
                    String extraFieldName1 = "";
                    Decimal extraFieldValue1 = 0;
                    String extraFieldName2 = "";
                    Decimal extraFieldValue2 = 0;
                    String extraFieldName3 = "";
                    Decimal extraFieldValue3 = 0;

                    foreach (var row in groupedRow)
                    {
                        //var accountKto = AccountManager.GetAccount(es.ActorCompanyId, mainRow.BaseAccountId, onlyActive: false);
                        var account = accountStdsInInterval.FirstOrDefault(a => a.Account.AccountId == mainRow.BaseAccountId);
                        Account accountKto = null;
                        if (account != null)
                        {
                            accountKto = account.Account;
                        }
                        Account accountInternal = null;
                        AccountInternal aInternal = accountInternalsInInterval.FirstOrDefault(a => a.AccountId == row.InternalAccountId.GetValueOrDefault());
                        // Get info of internal accounts
                        if (aInternal != null)
                        {
                            accountInternal = aInternal.Account;
                            //accountInternal = AccountManager.GetAccount(es.ActorCompanyId, row.InternalAccountId.GetValueOrDefault(), onlyActive: false, loadAccountDim: true);
                        }
                        else
                            continue;

                        //Account Internals
                        bool accountsValid = false;

                        if (accountInternalsInInterval.Count != 0)
                        {
                            if (accountInternal == null)
                            {
                                accountsValid = false;
                            }
                            else
                            {
                                //var accountInternalIds = accountInternalsInInterval.Select(a => a.AccountId).ToList();
                                if (accountInternal != null && accountInternal.AccountId != 0 && accountInternalIds.Contains(accountInternal.AccountId))
                                    accountsValid = true;
                            }
                        }
                        else
                        {
                            accountsValid = true;
                        }

                        if (!accountsValid)
                            continue;

                        AccountDim dim = null;
                        if (accountInternal != null)
                        {
                            //dim = AccountManager.GetAccountDim(accountInternal.AccountDim.AccountDimId, es.ActorCompanyId);
                            dim = accountDims.FirstOrDefault(d => d.AccountDimId == accountInternal.AccountDimId);
                        }
                        else
                        {
                            dim = null;
                        }

                        // Extra fields
                        if (!string.IsNullOrEmpty(mainRow.ExtraFields))
                        {
                            var extraFields = mainRow.ExtraFields.Split(';');

                            foreach (var extraFieldStr in extraFields)
                            {
                                // Should consist of two strings, name and value, after split on ':'
                                var nameAndValue = extraFieldStr.Split(':');

                                foreach (var nValStr in nameAndValue)
                                {
                                    if (string.IsNullOrEmpty(extraFieldName1))
                                    {
                                        extraFieldName1 = nValStr;
                                        extraFieldValue1 = 1;
                                        continue;
                                    }
                                    else if (extraFieldName1 == nValStr)
                                    {
                                        break;
                                    }
                                    if (extraFieldValue1 == 1)
                                    {
                                        extraFieldValue1 = NumberUtility.ToDecimalWithComma(nValStr, 2);
                                        continue;
                                    }
                                    if (string.IsNullOrEmpty(extraFieldName2))
                                    {
                                        extraFieldName2 = nValStr;
                                        extraFieldValue2 = 1;
                                        continue;
                                    }
                                    else if (extraFieldName2 == nValStr)
                                    {
                                        break;
                                    }
                                    if (extraFieldValue2 == 1)
                                    {
                                        extraFieldValue2 = NumberUtility.ToDecimalWithComma(nValStr, 2);
                                        continue;
                                    }
                                    if (string.IsNullOrEmpty(extraFieldName3))
                                    {
                                        extraFieldName3 = nValStr;
                                        extraFieldValue3 = 1;
                                        continue;
                                    }
                                    else if (extraFieldName3 == nValStr)
                                    {
                                        break;
                                    }
                                    if (extraFieldValue3 == 1)
                                    {
                                        extraFieldValue3 = NumberUtility.ToDecimalWithComma(nValStr, 2);
                                    }
                                }
                            }
                        }
                        XElement StatRowElement = new XElement("StatRow");
                        Decimal rowQantity = 0;
                        rowQantity = (decimal)mainRow.Quantity;
                        if (mainRow.BillingType == 2)
                        {
                            var originalInvoices = InvoiceManager.GetInvoiceTraceViews(mainRow.InvoiceId, 0);
                            foreach (var originaInvoice in originalInvoices)
                            {
                                if (originaInvoice.IsInvoice)
                                {
                                    rowQantity = (decimal)mainRow.Quantity * -1;
                                }
                            }
                        }
                        StatRowElement.Add(
                            new XAttribute("id", statRowXmlId)
                            );
                        StatRowElement.Add(
                             new XElement("CustomerName", mainRow.CustomerName),
                             new XElement("CustomerNr", mainRow.CustomerNr),
                             new XElement("AccountName", accountKto != null ? accountKto.Name : ""),
                             new XElement("AccountNr", accountKto != null ? accountKto.AccountNr : ""),
                             new XElement("AccountInternalName", accountInternal != null ? accountInternal.Name : ""),
                             new XElement("AccountInternalNr", accountInternal != null ? accountInternal.AccountNr : ""),
                             new XElement("AccountDimName", accountInternal != null ? dim.Name : ""),
                             new XElement("AccountDimNr", accountInternal != null ? dim.AccountDimNr.ToString() : ""),
                             new XElement("InvoiceNr", mainRow.InvoiceNr),
                             new XElement("InvoiceRowNr", mainRow.RowNr),
                             new XElement("InvoiceDate", mainRow.InvoiceDate.ToString()),
                             new XElement("VoucherDate", mainRow.VoucherDate.ToString()),
                             new XElement("ProductNumber", mainRow.ProductNumber),
                             new XElement("ProductName", mainRow.ProductName),
                             //   new XElement("RowQuantity", mainRow.Quantity ?? 0),
                             new XElement("RowQuantity", rowQantity),
                             new XElement("RowAmount", mainRow.Amount),
                             new XElement("Year", year),
                             new XElement("YearMonth", yearMonth),
                             new XElement("YearWeek", yearWeek),
                             new XElement("ExtraField1Name", extraFieldName1),
                             new XElement("ExtraField1Value", extraFieldValue1),
                             new XElement("ExtraField2Name", extraFieldName2),
                             new XElement("ExtraField2Value", extraFieldValue2),
                             new XElement("ExtraField3Name", extraFieldName3),
                             new XElement("ExtraField3Value", extraFieldValue3)
                             );
                        billingStatisticsElements.Add(StatRowElement);
                        statRowXmlId++;
                    }

                }
                #region Default element
                if (statRowXmlId == 1)
                {
                    XElement StatRowElement = new XElement("StatRow");
                    StatRowElement.Add(
                        new XAttribute("id", statRowXmlId)
                        );

                    StatRowElement.Add(
                         new XElement("CustomerName", ""),
                         new XElement("CustomerNr", ""),
                         new XElement("AccountName", ""),
                         new XElement("AccountNr", ""),
                         new XElement("AccountInternalName", ""),
                         new XElement("AccountInternalNr", ""),
                         new XElement("AccountDimName", ""),
                         new XElement("AccountDimNr", ""),
                         new XElement("InvoiceNr", ""),
                         new XElement("InvoiceRowNr", ""),
                         new XElement("InvoiceDate", ""),
                         new XElement("VoucherDate", ""),
                         new XElement("ProductNumber", ""),
                         new XElement("ProductName", ""),
                         new XElement("RowQuantity", 0),
                         new XElement("RowAmount", 0),
                         new XElement("ExtraField1Name", ""),
                         new XElement("ExtraField1Value", 0),
                         new XElement("ExtraField2Name", ""),
                         new XElement("ExtraField2Value", 0),
                         new XElement("ExtraField3Name", ""),
                         new XElement("ExtraField3Value", 0)
                         );
                    billingStatisticsElements.Add(StatRowElement);
                }

                #endregion

                #endregion
            }

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = new XElement(CreateBillingReportHeaderLabelsElement(es.ReportTemplateType));
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateBillingInvoiceHeadReportHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType, doPrintTaxBillText);
            CreateBillingInvoiceRowsReportHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType);

            #endregion

            #region PreviousInvoices

            string previousInvoicesLabel = "";
            if (es.ReportTemplateType.IsValidIn(SoeReportTemplateType.BillingOrder))
                previousInvoicesLabel = GetReportText(292, "Tidigare ordrar");
            else
                previousInvoicesLabel = GetReportText(293, "Tidigare fakturor");

            pageHeaderLabelsElement.Add(
                new XElement("PreviousInvoicesLabel", previousInvoicesLabel));

            //Get AccountDims and add AccountDimLabelElements
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId);
            AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);

            #endregion

            #region Contract labels

            pageHeaderLabelsElement.Add(new XElement("ContractGroupNameLabel", GetReportText(806, "Avtalsgrupp")));
            pageHeaderLabelsElement.Add(new XElement("ContractGroupPeriodTypeLabel", GetReportText(807, "Period")));
            pageHeaderLabelsElement.Add(new XElement("ContractNextYearLabel", GetReportText(808, "Nästa år")));
            pageHeaderLabelsElement.Add(new XElement("ContractNextPeriodLabel", GetReportText(809, "Nästa period")));
            pageHeaderLabelsElement.Add(new XElement("ContractEndYearLabel", GetReportText(810, "Avslutsår")));
            pageHeaderLabelsElement.Add(new XElement("ContractEndPeriodLabel", GetReportText(811, "Avslutsperiod")));
            pageHeaderLabelsElement.Add(new XElement("ContractCategoryNameLabel", GetReportText(815, "Avtalskategori")));

            #endregion

            #region Close document

            BillingStatistics.Add(reportHeaderLabelsElement);
            BillingStatistics.Add(reportHeaderElement);
            BillingStatistics.Add(pageHeaderLabelsElement);
            BillingStatistics.Add(billingStatisticsElements);


            rootElement.Add(BillingStatistics);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.BillingStatisticsReport);

            #endregion
        }

        private XDocument CreateChecklistsReportData(EvaluatedSelection es)
        {
            if (es.ReportTemplateType != SoeReportTemplateType.OrderChecklistReport)
                return null;

            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ChecklistsReport");

            //ChecklistsReport
            XElement checklistsReportElement = new XElement("ChecklistsReport");

            //Checklists
            XElement checklistsElement = new XElement("Checklists");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateChecklistReportHeaderLabelsElement();
            checklistsReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateChecklistReportHeaderElement(es);
            checklistsReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateChecklistsReportPageHeaderLabelsElement(pageHeaderLabelsElement);
            checklistsReportElement.Add(pageHeaderLabelsElement);

            #endregion

            List<XElement> checklistElements = new List<XElement>();

            using (CompEntities entities = new CompEntities())
            {
                if (es.ReportTemplateType == SoeReportTemplateType.OrderChecklistReport)
                {
                    #region OrderChecklistReport

                    foreach (int invoiceId in es.SB_InvoiceIds)
                    {
                        #region Order

                        #region Prereq

                        List<ChecklistExtendedRowDTO> rowDTOs = ChecklistManager.GetChecklistRows(SoeEntityType.Order, invoiceId, es.ActorCompanyId);

                        //Filter ChecklistHeadRecord
                        if (es.SB_ChecklistHeadRecordId.HasValue)
                            rowDTOs = rowDTOs.Where(i => i.HeadRecordId == es.SB_ChecklistHeadRecordId.Value).ToList();

                        var heads = (from r in rowDTOs
                                     select new
                                     {
                                         r.HeadRecordId,
                                         r.HeadId,
                                         r.Name,
                                         HeadDescription = r.Description,
                                     }).Distinct();

                        #endregion

                        int headXmlId = 1;
                        bool crGen = SettingManager.GetBoolSetting(SettingMainType.Application, (int)ApplicationSettingType.UseCrGen, 0, 0, 0);
                        foreach (var head in heads)
                        {
                            #region Prereq

                            CustomerInvoice customerInvoice = InvoiceManager.GetCustomerInvoiceAndProject(entities, invoiceId, true);
                            if (customerInvoice == null)
                                continue;

                            string orderNr = customerInvoice.InvoiceNr;
                            DateTime orderDate = customerInvoice.OrderDate ?? CalendarUtility.DATETIME_DEFAULT;
                            string projectNr = customerInvoice.Project?.Number ?? string.Empty;
                            string projectName = customerInvoice.Project?.Name ?? string.Empty;
                            string customerNr = customerInvoice.Actor?.Customer?.CustomerNr ?? string.Empty;
                            string customerName = customerInvoice.Actor?.Customer?.Name ?? string.Empty;
                            string referenceYour = customerInvoice.ReferenceYour;
                            string companyName = Company.Name;
                            string referenceOur = customerInvoice.ReferenceOur;

                            #region Addresses

                            #region Company

                            string companyAddress = "";
                            string companyPostalCode = "";
                            string companyPostalAddress = "";

                            Contact companyContact = ContactManager.GetContactFromActor(entities, Company.ActorCompanyId, loadAllContactInfo: true);
                            if (companyContact != null && companyContact.ContactAddress != null)
                            {
                                TermGroup_SysContactAddressType companyBillingAddressType = companyContact.ContactAddress.AddressExists(TermGroup_SysContactAddressType.Billing) ? TermGroup_SysContactAddressType.Billing : TermGroup_SysContactAddressType.Visiting;

                                ContactAddress companyContactAddress = companyContact.ContactAddress.FirstOrDefault(ca => ca.SysContactAddressTypeId == (int)companyBillingAddressType);
                                if (companyContactAddress != null)
                                {
                                    List<ContactAddressRow> companyAddressRows = companyContactAddress.ContactAddressRow.ToList();
                                    companyAddress = companyAddressRows.GetContactAddressRowText(companyBillingAddressType, TermGroup_SysContactAddressRowType.Address);
                                    companyPostalCode = companyAddressRows.GetContactAddressRowText(companyBillingAddressType, TermGroup_SysContactAddressRowType.PostalCode);
                                    companyPostalAddress = companyAddressRows.GetContactAddressRowText(companyBillingAddressType, TermGroup_SysContactAddressRowType.PostalAddress);
                                }
                            }

                            #endregion

                            #region Customer

                            string customerBillingAddress = "";
                            string customerBillingPostalCode = "";
                            string customerBillingPostalAddress = "";
                            string customerDeliveryAddress = "";
                            string customerDeliveryPostalCode = "";
                            string customerDeliveryPostalAddress = "";

                            Contact customerContact = customerInvoice.ActorId.HasValue ? ContactManager.GetContactFromActor(entities, customerInvoice.ActorId.Value, loadAllContactInfo: true) : null;
                            if (customerContact != null && customerContact.ContactAddress != null)
                            {
                                ContactAddress customerBillingContactAddress = customerContact.ContactAddress.FirstOrDefault(ca => ca.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Billing);
                                if (customerBillingContactAddress != null)
                                {
                                    List<ContactAddressRow> customerBillingAddressRows = customerBillingContactAddress.ContactAddressRow.ToList();
                                    customerBillingAddress = customerBillingAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.Address, customerInvoice.BillingAddressId);
                                    customerBillingPostalCode = customerBillingAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.PostalCode, customerInvoice.BillingAddressId);
                                    customerBillingPostalAddress = customerBillingAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Billing, TermGroup_SysContactAddressRowType.PostalAddress, customerInvoice.BillingAddressId);
                                }
                                var customerDeliveryAddressEntity = customerContact.ContactAddress
                                                        .Where(ca => ca.SysContactAddressTypeId == (int)TermGroup_SysContactAddressType.Delivery)
                                                        .Where(ca => customerInvoice.DeliveryAddressId == 0 || ca.ContactAddressId == customerInvoice.DeliveryAddressId)
                                                        .FirstOrDefault();

                                if (customerDeliveryAddressEntity != null)
                                {
                                    var customerDeliveryAddressRows = customerDeliveryAddressEntity.ContactAddressRow.ToList();
                                    customerDeliveryAddress = customerDeliveryAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.Address, customerInvoice.DeliveryAddressId);
                                    customerDeliveryPostalCode = customerDeliveryAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.PostalCode, customerInvoice.DeliveryAddressId);
                                    customerDeliveryPostalAddress = customerDeliveryAddressRows.GetContactAddressRowText(TermGroup_SysContactAddressType.Delivery, TermGroup_SysContactAddressRowType.PostalAddress, customerInvoice.DeliveryAddressId);
                                }
                            }

                            #endregion

                            #endregion

                            #region OrderChecklists

                            List<int> orderChecklistIds = new List<int>();
                            if (es.SB_ChecklistHeadRecordId.HasValue)
                            {
                                orderChecklistIds.Add(es.SB_ChecklistHeadRecordId.Value);
                            }
                            else
                            {
                                List<ChecklistHeadRecord> orderChecklists = ChecklistManager.GetChecklistHeadRecords(SoeEntityType.Order, customerInvoice.InvoiceId, Company.ActorCompanyId);
                                foreach (ChecklistHeadRecord orderChecklist in orderChecklists)
                                {
                                    orderChecklistIds.Add(orderChecklist.ChecklistHeadRecordId);
                                }
                            }

                            #endregion

                            #region Signatures

                            List<int> checklistSignatureImageIds = new List<int>();
                            //List<int> checklistSignatureExecutorImageIds = new List<int>();
                            //foreach (int orderChecklistId in orderChecklistIds)
                            //{
                            //    checklistSignatureImageIds.AddRange(GraphicsManager.GetImagesIds(Company.ActorCompanyId, SoeEntityImageType.ChecklistHeadRecordSignature, SoeEntityType.ChecklistHeadRecord, orderChecklistId));
                            //    checklistSignatureExecutorImageIds.AddRange(GraphicsManager.GetImagesIds(Company.ActorCompanyId, SoeEntityImageType.ChecklistHeadRecordSignatureExecutor, SoeEntityType.ChecklistHeadRecord, orderChecklistId));
                            //}
                            var imageDTOs = new List<ImagesDTO>();

                            if (es.SB_ChecklistHeadRecordId.HasValue)
                            {
                                imageDTOs.AddRange(ChecklistManager.GetEntityChecklistSignatures(Company.ActorCompanyId, SoeEntityType.ChecklistHeadRecord, es.SB_ChecklistHeadRecordId.Value));
                            }
                            else
                            {
                                imageDTOs.AddRange(ChecklistManager.GetEntityChecklistsSignatures(Company.ActorCompanyId, SoeEntityType.Order, invoiceId));
                            }
                            #endregion

                            #endregion

                            #region Content

                            #region Checklist element

                            string strImagePath = "";
                            string strImageDescription = "";
                            if (imageDTOs.Any())
                            {
                                foreach (var imageDTO in imageDTOs)
                                {

                                    if (imageDTO.DataStorageRecordType == SoeDataStorageRecordType.ChecklistHeadRecordSignatureExecutor)
                                    {
                                        string imagePath = GraphicsManager.GetImageFilePath(imageDTO, Company.ActorCompanyId);
                                        if (crGen)
                                            imagePath = AddToCrGenRequestPicturesDTO(imagePath);
                                        strImagePath = imagePath;
                                        strImageDescription = imageDTO.Description;
                                        break;
                                    }
                                }
                            }

                            XElement checklistElement = new XElement("Checklist",
                                new XAttribute("id", headXmlId),
                                new XElement("Name", head.Name),
                                new XElement("Description", head.HeadDescription),
                                new XElement("OrderNr", orderNr),
                                new XElement("OrderDate", orderDate),
                                new XElement("ProjectNr", projectNr),
                                new XElement("ProjectName", projectName),
                                new XElement("CustomerNr", customerNr),
                                new XElement("CustomerName", customerName),
                                new XElement("ReferenceYour", referenceYour),
                                new XElement("ReferenceOur", referenceOur),
                                new XElement("CompanyName", companyName),
                                new XElement("CompanyDeliveryAddress", companyAddress),
                                new XElement("CompanyDeliveryAddressPostalNrCity", String.Format("{0} / {1}", companyPostalCode, companyPostalAddress)),
                                new XElement("CustomerBillingAddress", customerBillingAddress),
                                new XElement("CustomerBillingAddressPostNrCity", String.Format("{0} / {1}", customerBillingPostalCode, customerBillingPostalAddress)),
                                new XElement("DeliveryAddress", customerDeliveryAddress),
                               new XElement("DeliveryAddressPostNrCity", String.Format("{0} / {1}", customerDeliveryPostalCode, customerDeliveryPostalAddress)),
                                new XElement("ImagePath", strImagePath),
                                new XElement("ImageDescription", strImageDescription)
                                );

                            #endregion

                            #region ChecklistRow element

                            int rowXmlId = 1;
                            foreach (ChecklistExtendedRowDTO rowDTO in rowDTOs.Where(i => i.HeadRecordId == head.HeadRecordId))
                            {
                                XElement checklistRowElement = new XElement("ChecklistRow",
                                    new XAttribute("id", rowXmlId),
                                    new XElement("RowNr", rowDTO.RowNr),
                                    new XElement("Mandatory", rowDTO.Mandatory.ToInt()),
                                    new XElement("QuestionType", (int)rowDTO.Type),
                                    new XElement("QuestionText", rowDTO.Text),
                                    new XElement("AnswerDataType", rowDTO.DataTypeId),
                                    new XElement("AnswerValue", rowDTO.Value),
                                    new XElement("Comment", rowDTO.Comment),
                                    new XElement("Date", rowDTO.Date ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement("Created", rowDTO.Created ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement("CreatedBy", rowDTO.CreatedBy),
                                    new XElement("Modified", rowDTO.Modified ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement("ModifiedBy", rowDTO.ModifiedBy));

                                if (rowDTO.Type == TermGroup_ChecklistRowType.Image)
                                {
                                    var rowImageXmlId = 1;
                                    var rowImages = ChecklistManager.GetChecklistRowImages(entities, rowDTO.RowRecordId, es.ActorCompanyId);
                                    if (!rowImages.IsNullOrEmpty())
                                    {
                                        var rowImagesElement = new XElement("ChecklistRowImages");
                                        
                                        foreach (var image in rowImages)
                                        {
                                            string imagePath = GraphicsManager.GetImageFilePath(image, es.ActorCompanyId, !crGen);
                                            if (crGen)
                                                imagePath = AddToCrGenRequestPicturesDTO(imagePath, image.Image);
                                            XElement rowImageElement = new XElement("ChecklistRowImage",
                                                new XAttribute("id", rowImageXmlId),
                                                new XElement("ImagePath", imagePath),
                                                new XElement("Description", image.Description)
                                                );
                                            rowImagesElement.Add(rowImageElement);
                                            rowImageXmlId++;
                                        }

                                        checklistRowElement.Add(rowImagesElement);
                                    }
                                }

                                checklistElement.Add(checklistRowElement);
                                rowXmlId++;
                            }

                            #endregion

                            #region ChecklistImage element

                            int imageXmlId = 1;

                            if (imageDTOs.Any())
                            {
                                foreach (var imageDTO in imageDTOs)
                                {

                                    if (imageDTO.DataStorageRecordType == SoeDataStorageRecordType.ChecklistHeadRecordSignature || imageDTO.DataStorageRecordType == SoeDataStorageRecordType.ChecklistHeadRecordSignatureExecutor)
                                    {
                                        string imagePath = GraphicsManager.GetImageFilePath(imageDTO, es.ActorCompanyId, !crGen);
                                        if (crGen)
                                            imagePath = AddToCrGenRequestPicturesDTO(imagePath, imageDTO.Image);
                                        string type = "1";
                                        XElement checklistImage = new XElement("ChecklistImage",
                                            new XAttribute("id", imageXmlId),
                                            new XElement("ImagePath", imagePath),
                                            new XElement("Type", type),
                                            new XElement("Description", imageDTO.Description));

                                        checklistElement.Add(checklistImage);
                                        imageXmlId++;
                                    }
                                }
                            }

                            #endregion

                            #region Default element ChecklistRow

                            if (rowXmlId == 1)
                                checklistElement.Add(new XElement("ChecklistRow", String.Empty));

                            #endregion

                            checklistElements.Add(checklistElement);
                            headXmlId++;

                            #endregion
                        }

                        #region Default Checklist

                        if (headXmlId == 1)
                        {
                            checklistElements.Add(new XElement("Checklist",
                                new XAttribute("id", 1),
                                new XElement("Name", String.Empty),
                                new XElement("Description", String.Empty),
                                new XElement("OrderNr", String.Empty),
                                new XElement("OrderDate", String.Empty),
                                new XElement("ProjectNr", String.Empty),
                                new XElement("ProjectName", String.Empty),
                                new XElement("CustomerNr", String.Empty),
                                new XElement("CustomerName", String.Empty),
                                new XElement("ReferenceYour", String.Empty),
                                new XElement("ReferenceOur", String.Empty),
                                new XElement("CompanyName", String.Empty),
                                new XElement("CompanyDeliveryAddress", String.Empty),
                                new XElement("CompanyDeliveryAddressPostalNrCity", String.Empty),
                                new XElement("CustomerBillingAddress", String.Empty),
                                new XElement("CustomerBillingAddressPostNrCity", String.Empty),
                                new XElement("DeliveryAddress", String.Empty),
                                new XElement("DeliveryAddressPostNrCity", String.Empty)));

                            XElement ChecklistImage = new XElement("ChecklistImage",
                                new XAttribute("id", 1),
                                new XElement("ImagePath", ""),
                                new XElement("Type", ""),
                                new XElement("Description", ""));

                            checklistElements.Add(ChecklistImage);
                        }

                        #endregion

                        #endregion
                    }

                    #endregion
                }
            }

            #region Close document

            foreach (XElement checklistElement in checklistElements)
            {
                checklistsElement.Add(checklistElement);
            }

            checklistsReportElement.Add(checklistsElement);
            rootElement.Add(checklistsReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.OrderChecklistReport);

            #endregion
        }

        private XDocument CreateProjectStatisticsData(EvaluatedSelection es)
        {
            if (es == null || es.ReportTemplateType != SoeReportTemplateType.ProjectStatisticsReport)
                return null;


            #region Prereq

            bool useProjectTimeBlocks = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseProjectTimeBlocks, this.UserId, this.ActorCompanyId, 0, false);
            List<AccountDimDTO> accountDimInternalDTOs = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ProjectStatistics");

            //VoucherList
            XElement projectStatisticsElement = new XElement("ProjectStatistics");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateProjectReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            projectStatisticsElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateProjectReportHeaderElement(es);
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            reportHeaderElement.Add(CreateEmployeeIntervalElement(es));
            reportHeaderElement.Add(CreateProjectIntervalElement(es));
            reportHeaderElement.Add(CreateCustomerIntervalElement(es));
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalDTOs));

            projectStatisticsElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateProjectReportPageHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType);
            projectStatisticsElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            int projectXmlId = 1;
            List<XElement> projectElements = new List<XElement>();

            if (useProjectTimeBlocks)
                projectElements.AddRange(CreateProjectStatisticsDataContentFromProjectTimeBlocks(es, ref projectXmlId));
            else
                projectElements.AddRange(CreateProjectStatisticsDataContentFromProjectInvoiceDays(es, ref projectXmlId));

            #region Default element Project

            if (projectXmlId == 1)
            {
                XElement defProjectElement = new XElement("Project",
                           new XAttribute("id", 1),
                           new XElement("ProjectNumber", ""),
                           new XElement("ProjectName", ""),
                           new XElement("ProjectDescription", ""),
                           new XElement("ProjectCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                           new XElement("ProjectCreatedBy", ""),
                           new XElement("ProjectState", 0));

                XElement defInvoiceElement = new XElement("Invoice",
                            new XAttribute("id", 1),
                            new XElement("InvoiceNr", ""),
                            new XElement("InvoiceCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceCreatedBy", "")
                            );

                XElement defInvoiceRowElement = new XElement("CustomerInvoiceRow",
                           new XAttribute("id", 1),
                           new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                           new XElement("InvoiceRowCreatedBy", ""),
                           new XElement("InvoiceRowProductNumber", ""),
                           new XElement("InvoiceRowProductName", ""),
                           new XElement("InvoiceRowProductDescription", ""),
                           new XElement("InvoiceRowUnitName", "")
                           );
                XElement invoiceExpenseRowElement = new XElement("CustomerInvoiceExpenseRow",
                               new XAttribute("id", 1),
                               new XElement("ProjectNumber", " "),
                               new XElement("ProjectName", " "),
                               new XElement("InvoiceNr", " "),
                               new XElement("InvoiceCustomerName", " "),
                               new XElement("InvoiceExpenseRowEmployeeName", " "),
                               new XElement("InvoiceExpenseRowTimeCodeName", " "),
                               new XElement("InvoiceExpenseRowPayrollAttestStateName", " "),
                               new XElement("InvoiceExpenseRowQuantity", 0),
                               new XElement("InvoiceExpenseRowQuantityType", 0),
                               new XElement("InvoiceExpenseRowUnitPrice", 0),
                               new XElement("InvoiceExpenseRowAmount", 0),
                               new XElement("InvoiceExpenseRowInvoicedAmount", 0),
                               new XElement("InvoiceExpenseRowDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                               new XElement("InvoiceExpenseRowEmployeeNr", " "),
                               new XElement("InvoiceExpenseRowPayrollProductNr", " "),
                               new XElement("InvoiceExpenseRowPayrollProductName", " ")
                               );

                XElement defPayrollTransactionElement = new XElement("TimePayrollTransaction",
                            new XAttribute("id", 1),
                            new XElement("EmployeeNr", 0),
                            new XElement("EmployeeName", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionQuantity", 0),
                            new XElement("PayrollTransactionCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionCreatedBy", ""),
                            new XElement("PayrollTransactionExported", 0),
                            new XElement("PayrollTransactionProductNumber", ""),
                            new XElement("PayrollTransactionProductName", ""),
                            new XElement("PayrollTransactionProductDescription", ""),
                            new XElement("WeekNumber", ""),
                            new XElement("IsoDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionTimeCodeCode", ""),
                            new XElement("PayrollTransactionTimeCodeName", ""),
                            new XElement("PayrollTransactionTimeCodeDescription", ""),
                            new XElement("PayrollTransactionTimeCodeTransactionId", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionQuantity", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionInvoiceQuantity", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectId", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectNumber", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectName", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectNote", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectNumber", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectName", string.Empty),
                            new XElement("PayrollType", 0),
                            new XElement("isPayed", 0));

                XElement defInvoiceTransactionElement = new XElement("TimeInvoiceTransaction",
                        new XAttribute("id", 1),
                        new XElement("EmployeeNr", 0),
                        new XElement("EmployeeName", ""),
                        new XElement("Date", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                        new XElement("InvoiceTransactionQuantity", 0),
                        new XElement("InvoiceTransactionInvoiceQuantity", 0),
                        new XElement("InvoiceTransactionCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                        new XElement("InvoiceTransactionCreatedBy", ""),
                        new XElement("InvoiceTransactionExported", 0),
                        new XElement("InvoiceTransactionProductNumber", ""),
                        new XElement("InvoiceTransactionProductName", ""),
                        new XElement("InvoiceTransactionProductDescription", ""),
                        new XElement("InvoiceTransactionTimeCodeCode", ""),
                        new XElement("InvoiceTransactionTimeCodeName", ""),
                        new XElement("InvoiceTransactionTimeCodeDescription", ""),
                        new XElement("InvoiceTransactionTimeCodeTransactionId", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionQuantity", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionInvoiceQuantity", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectId", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectNumber", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectName", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectNote", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionParentProjectNumber", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionParentProjectName", string.Empty),
                        new XElement("WeekNumber", string.Empty),
                        new XElement("IsoDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()));

                XElement defMergedTransaction = new XElement("MergedTransaction",
                            new XAttribute("id", 0),
                            new XElement("EmployeeNr", string.Empty),
                            new XElement("EmployeeName", string.Empty),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("Note", string.Empty),
                            new XElement("WeekNumber", 0),
                            new XElement("IsoDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionQuantity", 0),
                            new XElement("PayrollTransactionCreated", 0),
                            new XElement("PayrollTransactionCreatedBy", string.Empty),
                            new XElement("PayrollTransactionExported", 0),
                            new XElement("PayrollTransactionProductNumber", string.Empty),
                            new XElement("PayrollTransactionProductName", string.Empty),
                            new XElement("PayrollTransactionProductDescription", string.Empty),
                            new XElement("InvoiceTransactionQuantity", 0),
                            new XElement("InvoiceTransactionInvoiceQuantity", 0),
                            new XElement("InvoiceTransactionCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceTransactionCreatedBy", string.Empty),
                            new XElement("InvoiceTransactionExported", 0),
                            new XElement("InvoiceTransactionProductNumber", string.Empty),
                            new XElement("InvoiceTransactionProductName", string.Empty),
                            new XElement("InvoiceTransactionProductDescription", string.Empty),
                            new XElement("TimeCodeCode", string.Empty),
                            new XElement("TimeCodeName", string.Empty),
                            new XElement("TimeCodeDescription", string.Empty),
                            new XElement("TimeCodeTransactionId", 0),
                            new XElement("TimeCodeTransactionQuantity", 0),
                            new XElement("TimeCodeTransactionInvoiceQuantity", 0),
                            new XElement("TimeCodeTransactionProjectId", 0),
                            new XElement("TimeCodeTransactionProjectNumber", string.Empty),
                            new XElement("TimeCodeTransactionProjectName", string.Empty),
                            new XElement("TimeCodeTransactionProjectNote", string.Empty),
                            new XElement("TimeCodeTransactionParentProjectNumber", string.Empty),
                            new XElement("TimeCodeTransactionParentProjectName", string.Empty),
                            new XElement("PayrollType", 0),
                            new XElement("isPayed", 0),
                            new XElement("InvoiceNr", string.Empty),
                            new XElement("OriginType", 0),
                            new XElement("PayrollTransactionInvoiceCustomerName", string.Empty),
                            new XElement("PayrollTransactionInvoiceCustomerNr", string.Empty),
                            new XElement("TimeDeviationCauseName", string.Empty),
                            new XElement("PayrollTransactionUnitPrice", 0),
                            new XElement("PayrollAttestStateName", string.Empty)
                            );

                defInvoiceElement.Add(defInvoiceRowElement);
                defInvoiceElement.Add(invoiceExpenseRowElement);
                defProjectElement.Add(defInvoiceElement);
                defProjectElement.Add(defPayrollTransactionElement);
                defProjectElement.Add(defInvoiceTransactionElement);

                projectElements.Add(defProjectElement);
            }

            #endregion

            #region Add Project

            foreach (XElement project in projectElements)
            {
                projectStatisticsElement.Add(project);
            }

            projectElements.Clear();

            #endregion

            #endregion

            #region Close document

            rootElement.Add(projectStatisticsElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ProjectStatisticsReport);

            #endregion
        }

        private XDocument CreateProjectTimeReportData(EvaluatedSelection es)
        {
            if (es == null || es.ReportTemplateType != SoeReportTemplateType.ProjectTimeReport)
                return null;

            #region Prereq

            bool useProjectTimeBlocks = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseProjectTimeBlocks, this.UserId, this.ActorCompanyId, 0, false);
            List<AccountDimDTO> accountDimInternalDTOs = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ProjectTimeReport");

            //VoucherList
            XElement projectTimeReportElement = new XElement("ProjectTimeReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateProjectReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            projectTimeReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateProjectReportHeaderElement(es);
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            reportHeaderElement.Add(CreateEmployeeIntervalElement(es));
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalDTOs));

            projectTimeReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateProjectReportPageHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType);
            projectTimeReportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            int projectXmlId = 1;
            List<XElement> projectElements = new List<XElement>();

            if (useProjectTimeBlocks)
                projectElements.AddRange(CreateProjectTimeReportDataContentFromProjectTimeBlocks(es, ref projectXmlId));

            #region Default element Project

            if (projectXmlId == 1)
            {
                XElement defProjectElement = new XElement("Project",
                           new XAttribute("id", 1),
                           new XElement("ProjectNumber", ""),
                           new XElement("ProjectName", ""),
                           new XElement("ProjectDescription", ""),
                           new XElement("ProjectCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                           new XElement("ProjectCreatedBy", ""),
                           new XElement("ProjectState", 0));

                XElement defInvoiceElement = new XElement("Invoice",
                            new XAttribute("id", 1),
                            new XElement("InvoiceNr", ""),
                            new XElement("InvoiceCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceCreatedBy", "")
                            );

                XElement defInvoiceRowElement = new XElement("CustomerInvoiceRow",
                           new XAttribute("id", 1),
                           new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                           new XElement("InvoiceRowCreatedBy", ""),
                           new XElement("InvoiceRowProductNumber", ""),
                           new XElement("InvoiceRowProductName", ""),
                           new XElement("InvoiceRowProductDescription", ""),
                           new XElement("InvoiceRowUnitName", "")
                           );

                XElement defPayrollTransactionElement = new XElement("TimePayrollTransaction",
                            new XAttribute("id", 1),
                            new XElement("EmployeeNr", 0),
                            new XElement("EmployeeName", ""),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionQuantity", 0),
                            new XElement("PayrollTransactionCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionCreatedBy", ""),
                            new XElement("PayrollTransactionExported", 0),
                            new XElement("PayrollTransactionProductNumber", ""),
                            new XElement("PayrollTransactionProductName", ""),
                            new XElement("PayrollTransactionProductDescription", ""),
                            new XElement("WeekNumber", ""),
                            new XElement("IsoDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionTimeCodeCode", ""),
                            new XElement("PayrollTransactionTimeCodeName", ""),
                            new XElement("PayrollTransactionTimeCodeDescription", ""),
                            new XElement("PayrollTransactionTimeCodeTransactionId", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionQuantity", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionInvoiceQuantity", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectId", 0),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectNumber", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectName", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectNote", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectNumber", string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectName", string.Empty),
                            new XElement("PayrollType", 0),
                            new XElement("isPayed", 0));

                XElement defInvoiceTransactionElement = new XElement("TimeInvoiceTransaction",
                        new XAttribute("id", 1),
                        new XElement("EmployeeNr", 0),
                        new XElement("EmployeeName", ""),
                        new XElement("Date", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                        new XElement("InvoiceTransactionQuantity", 0),
                        new XElement("InvoiceTransactionInvoiceQuantity", 0),
                        new XElement("InvoiceTransactionCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                        new XElement("InvoiceTransactionCreatedBy", ""),
                        new XElement("InvoiceTransactionExported", 0),
                        new XElement("InvoiceTransactionProductNumber", ""),
                        new XElement("InvoiceTransactionProductName", ""),
                        new XElement("InvoiceTransactionProductDescription", ""),
                        new XElement("InvoiceTransactionTimeCodeCode", ""),
                        new XElement("InvoiceTransactionTimeCodeName", ""),
                        new XElement("InvoiceTransactionTimeCodeDescription", ""),
                        new XElement("InvoiceTransactionTimeCodeTransactionId", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionQuantity", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionInvoiceQuantity", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectId", 0),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectNumber", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectName", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionProjectNote", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionParentProjectNumber", string.Empty),
                        new XElement("InvoiceTransactionTimeCodeTransactionParentProjectName", string.Empty),
                        new XElement("WeekNumber", string.Empty),
                        new XElement("IsoDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()));

                XElement defMergedTransaction = new XElement("MergedTransaction",
                            new XAttribute("id", 0),
                            new XElement("EmployeeNr", string.Empty),
                            new XElement("EmployeeName", string.Empty),
                            new XElement("Date", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("Note", string.Empty),
                            new XElement("WeekNumber", 0),
                            new XElement("IsoDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionQuantity", 0),
                            new XElement("PayrollTransactionCreated", 0),
                            new XElement("PayrollTransactionCreatedBy", string.Empty),
                            new XElement("PayrollTransactionExported", 0),
                            new XElement("PayrollTransactionProductNumber", string.Empty),
                            new XElement("PayrollTransactionProductName", string.Empty),
                            new XElement("PayrollTransactionProductDescription", string.Empty),
                            new XElement("InvoiceTransactionQuantity", 0),
                            new XElement("InvoiceTransactionInvoiceQuantity", 0),
                            new XElement("InvoiceTransactionCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceTransactionCreatedBy", string.Empty),
                            new XElement("InvoiceTransactionExported", 0),
                            new XElement("InvoiceTransactionProductNumber", string.Empty),
                            new XElement("InvoiceTransactionProductName", string.Empty),
                            new XElement("InvoiceTransactionProductDescription", string.Empty),
                            new XElement("TimeCodeCode", string.Empty),
                            new XElement("TimeCodeName", string.Empty),
                            new XElement("TimeCodeDescription", string.Empty),
                            new XElement("TimeCodeTransactionId", 0),
                            new XElement("TimeCodeTransactionQuantity", 0),
                            new XElement("TimeCodeTransactionInvoiceQuantity", 0),
                            new XElement("TimeCodeTransactionProjectId", 0),
                            new XElement("TimeCodeTransactionProjectNumber", string.Empty),
                            new XElement("TimeCodeTransactionProjectName", string.Empty),
                            new XElement("TimeCodeTransactionProjectNote", string.Empty),
                            new XElement("TimeCodeTransactionParentProjectNumber", string.Empty),
                            new XElement("TimeCodeTransactionParentProjectName", string.Empty),
                            new XElement("PayrollType", 0),
                            new XElement("isPayed", 0),
                            new XElement("InvoiceNr", string.Empty),
                            new XElement("OriginType", 0),
                            new XElement("PayrollTransactionInvoiceCustomerName", string.Empty),
                            new XElement("PayrollTransactionInvoiceCustomerNr", string.Empty),
                            new XElement("TimeDeviationCauseName", string.Empty),
                            new XElement("PayrollTransactionUnitPrice", 0),
                            new XElement("PayrollAttestStateName", string.Empty)
                            );

                defInvoiceElement.Add(defInvoiceRowElement);
                defProjectElement.Add(defInvoiceElement);
                defProjectElement.Add(defPayrollTransactionElement);
                defProjectElement.Add(defInvoiceTransactionElement);

                projectElements.Add(defProjectElement);
            }

            #endregion

            #region Add Project

            foreach (XElement project in projectElements)
            {
                projectTimeReportElement.Add(project);
            }

            projectElements.Clear();

            #endregion

            #endregion

            #region Close document

            rootElement.Add(projectTimeReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ProjectTimeReport);

            #endregion
        }

        private XDocument CreateTimeProjectReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            int nrOfTimeProjectRows = 0;
            List<TimeCode> timeCodes = TimeCodeManager.GetTimeCodes(es.ActorCompanyId);

            bool showStartStopInTimeReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingShowStartStopInTimeReport, this.UserId, this.ActorCompanyId, 0, false);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TimeProjectReport");

            XElement timeProjectReportElement = new XElement("TimeProjectReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateTimeReportHeaderLabelsElement();
            timeProjectReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateTimeReportHeaderElement(es); //TimeProjectReport
            var extendedTimeRegistration = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ProjectUseExtendedTimeRegistration, 0, es.ActorCompanyId, 0);
            reportHeaderElement.Add(new XElement("ShowStartStop", showStartStopInTimeReport));
            reportHeaderElement.Add(new XElement("ExtendedTimeRegistration", extendedTimeRegistration));
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            timeProjectReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateTimeProjectReportPageHeaderLabelsElement(pageHeaderLabelsElement);
            timeProjectReportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                //can only be 1 for the moment
                int invoiceId = es.SB_InvoiceIds.Any() ? es.SB_InvoiceIds.First() : 0;

                // Här kommer vi in i ny metod
                timeProjectReportElement = CreateTimeProjectElement(entities, es, timeProjectReportElement, timeCodes, invoiceId, es.ActorCompanyId, false, out nrOfTimeProjectRows);

                #endregion
            }

            #region Close document

            rootElement.Add(timeProjectReportElement);
            document.Add(rootElement);
            return GetValidatedDocument(document, SoeReportTemplateType.TimeProjectReport);

            #endregion
        }

        private XDocument CreateConstructionEmployeesReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init repository

            PersonalDataEmployeeReportRepository personalDataRepository = new PersonalDataEmployeeReportRepository(parameterObject, es);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ConstructionReport");

            //ConstructionReportEmployees
            XElement constructionReportElement = new XElement("ConstructionReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateTimeReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            constructionReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateExtendedPersonellReportHeaderElement(es);
            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
            string companyLogoPath = GetCompanyLogoFilePath(entitiesReadOnly, es.ActorCompanyId, false);
            reportHeaderElement.Add(new XElement("CompanyLogo", companyLogoPath));

            constructionReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels",
                new XElement("CustomerNameLabel", "")
                );
            constructionReportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Feature

            bool showSocialSec = FeatureManager.HasRolePermission(Feature.Time_Employee_Employees_Edit_OtherEmployees_SocialSec, Permission.Readonly, es.RoleId, es.ActorCompanyId);

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                List<Employee> employees = EmployeeManager.GetAllEmployees(es.ActorCompanyId, active: true);
                List<Project> projects = ProjectManager.GetProjects(es.ActorCompanyId, TermGroup_ProjectType.TimeProject, true, false, true, false, false);

                //add all employees 
                if (employees != null)
                    constructionReportElement.Add(CreateTimeProjectEmployeeElement(personalDataRepository, showSocialSec, employees: employees));

                //add projects containing projectusers
                if (!projects.IsNullOrEmpty())
                {
                    foreach (var project in projects)
                    {
                        if (project.WorkSiteKey != null || project.WorkSiteNumber != null)
                        {
                            var projectUsers = ProjectManager.GetProjectUsers(project.ProjectId, false);
                            constructionReportElement.Add(CreateTimeProjectEmployeeElement(personalDataRepository, showSocialSec, projectusers: projectUsers, project: project));
                        }
                    }
                }

                //add default elements
                if (employees == null && projects == null)
                    constructionReportElement.Add(CreateTimeProjectEmployeeElement(personalDataRepository, showSocialSec));
            }

            #endregion

            #region Close repository

            personalDataRepository.GenerateLogs();

            #endregion

            #region Close document

            rootElement.Add(constructionReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ConstructionEmployeesReport);

            #endregion
        }

        private XDocument CreateExpenseReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            bool showStartStopInTimeReport = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.BillingShowStartStopInTimeReport, this.UserId, this.ActorCompanyId, 0, false);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ExpensesReport");

            XElement expenseReportElement = new XElement("ExpensesReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateTimeReportHeaderLabelsElement();
            expenseReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountDistributionHeadListReportHeaderElement(es); //TimeProjectReport
            var extendedTimeRegistration = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ProjectUseExtendedTimeRegistration, 0, es.ActorCompanyId, 0);
            reportHeaderElement.Add(new XElement("ShowStartStop", showStartStopInTimeReport));
            reportHeaderElement.Add(new XElement("ExtendedTimeRegistration", extendedTimeRegistration));
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            reportHeaderElement.Add(CreateEmployeeIntervalElement(es));
            reportHeaderElement.Add(CreateProjectIntervalElement(es));
            reportHeaderElement.Add(CreateCustomerIntervalElement(es));
            expenseReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateProjectReportPageHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType);
            expenseReportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {

                SoeOriginType originType = SoeOriginType.None;
                List<CustomerInvoice> customerInvoices = InvoiceManager.GetCustomerInvoicesFromSelection(entities, es, es.SB_IncludeDrafts, ref originType, true);
                //can only be 1 for the moment
                int invoiceId = 0;
                if (es.SB_HasInvoiceIds)
                    invoiceId = es.SB_InvoiceIds.Count > 0 ? es.SB_InvoiceIds.First() : 0;
                // Här kommer vi in i ny metod
                expenseReportElement = CreateExpenseElement(entities, es, expenseReportElement, customerInvoices.FirstOrDefault(), 0, out _);

            }
            #endregion

            #region Close document

            rootElement.Add(expenseReportElement);
            document.Add(rootElement);
            return GetValidatedDocument(document, SoeReportTemplateType.ExpenseReport);

            #endregion
        }

        private List<XElement> CreateProjectStatisticsDataContentFromProjectTimeBlocks(EvaluatedSelection es, ref int projectXmlId)
        {
            int timeInvoiceTransactionXmlId = 1;
            int timePayrollTransactionXmlId = 1;
            List<XElement> projectElements = new List<XElement>();

            #region Prereq

            //Get TimeProject's
            //Get TimeProject's
            var useProjectIntervals = (es.SP_ProjectIds != null && es.SP_ProjectIds.Count > 0) || (es.SB_ProjectNrFrom != null && es.SB_ProjectNrTo != null && (es.SB_ProjectNrFrom.Length > 0 || es.SB_ProjectNrTo.Length > 0));
            List<TimeProject> projects = ProjectManager.GetTimeProjectsFromSelection(es);
            List<int> projectIds = projects.Select(x => x.ProjectId).ToList();

            //Build collections
            List<int> invoiceIdsAll = new List<int>();
            List<int> employeeIds = new List<int>();
            Dictionary<int, List<int>> projectInvoicesDict = new Dictionary<int, List<int>>();
            if (es.SB_EmployeeNrFrom == null)
                employeeIds = EmployeeManager.GetAllEmployeeIds(es.ActorCompanyId);
            else
                employeeIds = EmployeeManager.GetAllEmployeeIdsByEmployeeNrFromTo(es.ActorCompanyId, es.SB_EmployeeNrFrom, es.SB_EmployeeNrTo);
            var timePayrollTransactions = ProjectManager.GetProjectTimeBlockPayrollTransactionsFromSelection(es, useProjectIntervals ? projectIds : null, employeeIds);
            var timeInvoiceTransactions = ProjectManager.GetProjectTimeBlockInvoiceTransactionsFromSelection(es, useProjectIntervals ? projectIds : null, employeeIds);

            var tempIds = timePayrollTransactions.Select(t => t.ProjectId).ToList();
            tempIds.AddRange(timeInvoiceTransactions.Select(t => t.ProjectId));
            projectIds = tempIds.Distinct().ToList();

            #region Removed/Quarantine

            //Get all ProjectTImeBlocks's for Projects
            //List<IGrouping<int?, ProjectTimeBlock>> projectTimeBlocks = ProjectManager.GetProjectTimeBlocksFromSelection(es, projectIds).GroupBy(p => p.ProjectId).ToList();
            //var timePayrollTransactions = ProjectManager.GetProjectTimeBlockPayrollTransactionsFromSelection(es, projectIds);
            //var timeInvoiceTransactions = ProjectManager.GetProjectTimeBlockInvoiceTransactionsFromSelection(es, projectIds);
            //if (es.SB_HasEmployeeNrInterval)
            //            {
            //    //To get better performance against DataTimeBlock table
            //    var employeeIds = EmployeeManager.GetAllEmployeeIds(es.ActorCompanyId);
            //    if (employeeIds.Any())
            //    {
            //        projectTimeCodeTransactions = projectTimeCodeTransactions.Where(d => employeeIds.Contains(d.EmployeeId));
            //    }
            //}
            //To get better performance against DataTimeBlock table
            //int nrId = 22343;
            /*var employeeids = !string.IsNullOrEmpty(es.SB_EmployeeNrFrom) || !string.IsNullOrEmpty(es.SB_EmployeeNrTo) ?
                EmployeeManager.GetAllEmployeeIdsByEmployeeNrFromTo(es.ActorCompanyId, es.SB_EmployeeNrFrom, es.SB_EmployeeNrTo) :
                EmployeeManager.GetAllEmployeeIds(es.ActorCompanyId);
            var allEmployeeids = EmployeeManager.GetAllEmployeeIds(es.ActorCompanyId);
            //var employeeNrIds = EmployeeManager.GetAllEmployeeIdsByEmployeeNr(es.ActorCompanyId);
            //List<int> employeeIds = employeeIds.Where(nrId == ).Select(t => t.Key).ToList();
            //var employeeids = new List<int>() { 22343 };

            var projectTimeBlocks = ProjectManager.GetProjectTimeBlockDTOs(es.DateFrom, es.DateTo, allEmployeeids, projectIds, null, false);


            //var tempIds = timePayrollTransactions.Select(t => t.ProjectId).ToList();
            //tempIds.AddRange(timeInvoiceTransactions.Select(t => t.ProjectId));
            var tempIds = projectTimeBlocks.Select(t => t.ProjectId).ToList();
            //tempIds.AddRange(timeInvoiceTransactions.Select(t => t.ProjectId));
            //Filter
            projectIds = tempIds.Distinct().ToList();*/

            #endregion

            // Map invoices
            ProjectManager.GetProjectInvoiceMappingIds(es.ActorCompanyId, projectIds, ref invoiceIdsAll, ref projectInvoicesDict);

            //Get all CustomerInvoices for Projects
            var invoiceItems = ProjectManager.GetInvoicesForTimeProjectsFromSelection(invoiceIdsAll, es);

            #endregion

            #region Content

            foreach (TimeProject project in projects.Where(p => projectIds.Contains(p.ProjectId)))
            {
                #region Prereq

                //InvoiceId's for current TimeProject
                List<int> invoiceIdsForProject = (from p in projectInvoicesDict
                                                  where p.Key == project.ProjectId
                                                  select p.Value).FirstOrDefault();

                //if we have made a selection on customernr we only want those projects that has an invoice that is connected to the choosen customers
                if (es.SB_HasCustomerNrInterval)
                {
                    bool jumpOverProject = true;
                    foreach (var invoice in invoiceItems)
                    {
                        if (invoiceIdsForProject != null && invoiceIdsForProject.Contains(invoice.InvoiceId))
                        {
                            jumpOverProject = false;
                            break;
                        }
                    }

                    if (jumpOverProject)
                        continue;
                }

                #endregion

                #region Invoice

                List<XElement> invoiceElements = new List<XElement>();
                int invoiceXmlId = 1;

                foreach (var invoiceItem in invoiceItems)
                {
                    if (invoiceIdsForProject == null)
                        continue;

                    //Check that CustomerInvoice belongs to current TimeProject
                    if (!invoiceIdsForProject.Contains(invoiceItem.InvoiceId))
                        continue;

                    #region CustomerInvoice

                    #region Invoice

                    XElement invoiceElement = new XElement("Invoice",
                            new XAttribute("id", invoiceXmlId),
                            new XElement("InvoiceNr", invoiceItem.InvoiceNr),
                            new XElement("InvoiceCreated", invoiceItem.Created.HasValue ? invoiceItem.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceCreatedBy", invoiceItem.CreatedBy),
                            new XElement("InvoiceCustomerNr", invoiceItem.CustomerNr),
                            new XElement("InvoiceCustomerName", invoiceItem.CustomerName));

                    #endregion

                    #region DefaultInvoiceRow

                    XElement invoiceRowElement = new XElement("CustomerInvoiceRow",
                                new XAttribute("id", 1),
                                new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                new XElement("InvoiceRowCreatedBy", ""),
                                new XElement("InvoiceRowProductNumber", ""),
                                new XElement("InvoiceRowProductName", ""),
                                new XElement("InvoiceRowProductDescription", ""),
                                new XElement("InvoiceRowUnitName", ""));

                    invoiceElement.Add(invoiceRowElement);

                    #endregion

                    #region InvoiceExpenseRow

                    int invoiceExpenseRowXmlId = 1;
                    int saveTimeCodeId = 0;
                    //      InvoiceProduct invoiceProduct = null;
                    PayrollProduct payrollProduct = null;

                    var expenseRowsForInvoice = ExpenseManager.GetExpenseRowsForGrid(invoiceItem.InvoiceId, es.ActorCompanyId, this.UserId, es.RoleId);
                    foreach (var expenseRow in expenseRowsForInvoice)
                    {
                        //Check expensrows 
                        //if (expenseRow.InvoiceRowAttestStateId == 0)
                        //    continue;

                        if (es.HasDateInterval && (expenseRow.From < es.DateFrom.Date || expenseRow.From > es.DateTo.Date))
                            continue;

                        if (saveTimeCodeId != expenseRow.TimeCodeId)
                        {
                            saveTimeCodeId = expenseRow.TimeCodeId;
                            //    invoiceProduct = GetInvoiceProductFromTimeCode(CompEntities, expenseRow.TimeCodeId, es.ActorCompanyId);
                            using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                            payrollProduct = GetPayrollProductFromTimeCode(entitiesReadOnly, expenseRow.TimeCodeId, es.ActorCompanyId);
                        }

                        XElement invoiceExpenseRowElement = new XElement("CustomerInvoiceExpenseRow",
                               new XAttribute("id", invoiceExpenseRowXmlId),
                               new XElement("ProjectNumber", project.Number),
                               new XElement("ProjectName", project.Name),
                               new XElement("InvoiceNr", invoiceItem.InvoiceNr),
                               new XElement("InvoiceCustomerName", invoiceItem.CustomerName),
                               new XElement("InvoiceExpenseRowEmployeeName", expenseRow.EmployeeName),
                               new XElement("InvoiceExpenseRowTimeCodeName", expenseRow.TimeCodeName),
                               new XElement("InvoiceExpenseRowPayrollAttestStateName", expenseRow.PayrollAttestStateName),
                               new XElement("InvoiceExpenseRowQuantity", expenseRow.Quantity),
                               new XElement("InvoiceExpenseRowQuantityType", expenseRow.TimeCodeRegistrationType),
                               new XElement("InvoiceExpenseRowUnitPrice", expenseRow.UnitPrice),
                               new XElement("InvoiceExpenseRowAmount", expenseRow.Amount),
                               new XElement("InvoiceExpenseRowInvoicedAmount", expenseRow.InvoicedAmount),
                               new XElement("InvoiceExpenseRowDate", expenseRow.From.ToShortDateString()),
                               new XElement("InvoiceExpenseRowEmployeeNr", expenseRow.EmployeeNumber),
                               new XElement("InvoiceExpenseRowPayrollProductNr", payrollProduct != null ? payrollProduct.Number : ""),
                               new XElement("InvoiceExpenseRowPayrollProductName", payrollProduct != null ? payrollProduct.Name : "")
                               );
                        invoiceElement.Add(invoiceExpenseRowElement);
                        invoiceExpenseRowXmlId++;
                    }
                    #endregion

                    #region Default element InvoiceExpenseRow

                    if (invoiceExpenseRowXmlId == 1)
                    {
                        XElement invoiceExpenseRowElement = new XElement("CustomerInvoiceExpenseRow",
                                new XAttribute("id", 1),
                                new XElement("ProjectNumber", " "),
                                new XElement("ProjectName", " "),
                                new XElement("InvoiceNr", " "),
                                new XElement("InvoiceCustomerName", " "),
                                new XElement("InvoiceExpenseRowEmployeeName", " "),
                                new XElement("InvoiceExpenseRowTimeCodeName", " "),
                                new XElement("InvoiceExpenseRowPayrollAttestStateName", " "),
                                new XElement("InvoiceExpenseRowQuantity", 0),
                                new XElement("InvoiceExpenseRowQuantityType", 0),
                                new XElement("InvoiceExpenseRowUnitPrice", 0),
                                new XElement("InvoiceExpenseRowAmount", 0),
                                new XElement("InvoiceExpenseRowInvoicedAmount", 0),
                                new XElement("InvoiceExpenseRowDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                new XElement("InvoiceExpenseRowEmployeeNr", " "),
                                new XElement("InvoiceExpenseRowPayrollProductNr", " "),
                                new XElement("InvoiceExpenseRowPayrollProductName", " ")
                                );
                        invoiceElement.Add(invoiceExpenseRowElement);
                    }
                    #endregion

                    invoiceElements.Add(invoiceElement);
                    invoiceXmlId++;

                    #endregion
                }

                #endregion

                if (invoiceXmlId == 1)
                {
                    #region Default element Invoice

                    XElement defInvoiceElement = new XElement("Invoice",
                            new XAttribute("id", 1),
                            new XElement("InvoiceNr", ""),
                            new XElement("InvoiceCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceCreatedBy", "")
                            );
                    XElement defInvoiceRowElement = new XElement("CustomerInvoiceRow",
                           new XAttribute("id", 1),
                           new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                           new XElement("InvoiceRowCreatedBy", ""),
                           new XElement("InvoiceRowProductNumber", ""),
                           new XElement("InvoiceRowProductName", ""),
                           new XElement("InvoiceRowProductDescription", ""),
                           new XElement("InvoiceRowUnitName", "")
                           );
                    XElement defInvoiceExpenseRowElement = new XElement("CustomerInvoiceExpenseRow",
                                new XAttribute("id", 1),
                                new XElement("ProjectNumber", " "),
                                new XElement("ProjectName", " "),
                                new XElement("InvoiceNr", " "),
                                new XElement("InvoiceCustomerName", " "),
                                new XElement("InvoiceExpenseRowEmployeeName", " "),
                                new XElement("InvoiceExpenseRowTimeCodeName", " "),
                                new XElement("InvoiceExpenseRowPayrollAttestStateName", " "),
                                new XElement("InvoiceExpenseRowQuantity", 0),
                                new XElement("InvoiceExpenseRowQuantityType", 0),
                                new XElement("InvoiceExpenseRowUnitPrice", 0),
                                new XElement("InvoiceExpenseRowAmount", 0),
                                new XElement("InvoiceExpenseRowInvoicedAmount", 0),
                                new XElement("InvoiceExpenseRowDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                new XElement("InvoiceExpenseRowEmployeeNr", " "),
                                new XElement("InvoiceExpenseRowPayrollProductNr", " "),
                                new XElement("InvoiceExpenseRowPayrollProductName", " ")
                                );

                    defInvoiceElement.Add(defInvoiceRowElement);
                    defInvoiceElement.Add(defInvoiceExpenseRowElement);
                    invoiceElements.Add(defInvoiceElement);

                    #endregion
                }

                #region ProjectInvoiceDay

                List<XElement> invoiceTransactionElements = new List<XElement>();
                List<XElement> payrollTransactionElements = new List<XElement>();

                var timePayrollTransactionsForProject = timePayrollTransactions.Where(p => p.ProjectId == project.ProjectId); //projectTimeBlocks.Where(p => p.ProjectId == project.ProjectId);
                var timeInvoiceTransactionsForProject = timeInvoiceTransactions.Where(p => p.ProjectId == project.ProjectId);

                if (!timePayrollTransactionsForProject.Any() && !timeInvoiceTransactionsForProject.Any())
                    continue;

                #region TimePayrollTransaction
                Employee payrollEmployee = new Employee();

                foreach (var payrollTransaction in timePayrollTransactionsForProject)
                {

                    decimal empCost = 0;
                    if (payrollEmployee.EmployeeId != payrollTransaction.EmployeeId)
                    {
                        payrollEmployee = EmployeeManager.GetEmployee(payrollTransaction.EmployeeId, es.ActorCompanyId);
                    }
                    empCost = EmployeeManager.GetEmployeeCalculatedCost(payrollEmployee, payrollTransaction.Date, payrollTransaction.ProjectId);


                    XElement payrollTransactionElement = new XElement("TimePayrollTransaction",
                                         new XAttribute("id", timePayrollTransactionXmlId),
                                         new XElement("EmployeeNr", payrollTransaction.EmployeeNr),
                                         new XElement("EmployeeName", payrollTransaction.EmployeeName),
                                         new XElement("Date", payrollTransaction.Date.ToShortDateString()),
                                         new XElement("Note", payrollTransaction.ProjectTimeBlockInternalNote),
                                         new XElement("ExternalNote", payrollTransaction.ProjectTimeBlockExternalNote),
                                         new XElement("PayrollTransactionQuantity", payrollTransaction.Quantity),
                                         new XElement("PayrollTransactionCreated", payrollTransaction.Created.HasValue ? payrollTransaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                         new XElement("PayrollTransactionCreatedBy", payrollTransaction.CreatedBy),
                                         new XElement("PayrollTransactionExported", payrollTransaction.Exported.ToInt()),
                                         new XElement("PayrollTransactionProductNumber", payrollTransaction.ProductNumber),
                                         new XElement("PayrollTransactionProductName", payrollTransaction.ProductName),
                                         new XElement("PayrollTransactionProductDescription", payrollTransaction.ProductDescription),
                                         new XElement("WeekNumber", CalendarUtility.GetWeekNr(payrollTransaction.Date)),
                                         new XElement("IsoDate", payrollTransaction.Date.ToString("yyyy-MM-dd")),
                                         new XElement("PayrollTransactionTimeCodeCode", payrollTransaction.TimeCode),
                                         new XElement("PayrollTransactionTimeCodeName", payrollTransaction.TimeCodeName),
                                         new XElement("PayrollTransactionTimeCodeDescription", payrollTransaction.TimeCodeDescription),
                                         new XElement("PayrollTransactionTimeCodeTransactionId", payrollTransaction.TimeCodeTransactionId),
                                         new XElement("PayrollTransactionTimeCodeTransactionQuantity", payrollTransaction.Quantity),
                                         new XElement("PayrollTransactionTimeCodeTransactionInvoiceQuantity", payrollTransaction.TimeCodeTransactionInvoiceQuantity.HasValue ? payrollTransaction.TimeCodeTransactionInvoiceQuantity : 0),
                                         new XElement("PayrollTransactionTimeCodeTransactionProjectId", payrollTransaction.ProjectId),
                                         new XElement("PayrollTransactionTimeCodeTransactionProjectNumber", payrollTransaction.ProjectNr),
                                         new XElement("PayrollTransactionTimeCodeTransactionProjectName", payrollTransaction.ProjectName),
                                         new XElement("PayrollTransactionTimeCodeTransactionProjectNote", payrollTransaction.ProjectNote),
                                         new XElement("PayrollTransactionTimeCodeTransactionParentProjectNumber", payrollTransaction.ParentProjectNumber),
                                         new XElement("PayrollTransactionTimeCodeTransactionParentProjectName", payrollTransaction.ParentProjectName),
                                         new XElement("PayrollType", payrollTransaction.PayrollType),
                                         new XElement("isPayed", payrollTransaction.Payed.ToInt()),
                                         new XElement("InvoiceNr", string.IsNullOrEmpty(payrollTransaction.InvoiceNr) ? "" : payrollTransaction.InvoiceNr),
                                         new XElement("OriginType", payrollTransaction.OriginType.HasValue ? payrollTransaction.OriginType : 0),
                                         new XElement("PayrollTransactionInvoiceCustomerName", string.IsNullOrEmpty(payrollTransaction.CustomerName) ? "" : payrollTransaction.CustomerName),
                                         new XElement("PayrollTransactionInvoiceCustomerNr", string.IsNullOrEmpty(payrollTransaction.CustomerNr) ? "" : payrollTransaction.CustomerNr),
                                         new XElement("TimeDeviationCauseName", string.IsNullOrEmpty(payrollTransaction.TimeDeviationCauseName) ? "" : payrollTransaction.TimeDeviationCauseName),
                                         new XElement("PayrollTransactionUnitPrice", empCost),
                                         new XElement("PayrollAttestStateName", payrollTransaction.AttestStateName)
                                         );

                    payrollTransactionElements.Add(payrollTransactionElement);
                    timePayrollTransactionXmlId++;
                }

                #endregion

                #region TimeInvoiceTransaction

                foreach (var invoiceTransaction in timeInvoiceTransactionsForProject.Where(p => p.CustomerInvoiceId > 0))
                {
                    int weeknr = CalendarUtility.GetWeekNr(invoiceTransaction.Date);

                    XElement invoiceTransactionElement = new XElement("TimeInvoiceTransaction",
                                            new XAttribute("id", timeInvoiceTransactionXmlId),
                                            new XElement("EmployeeNr", invoiceTransaction.EmployeeNr),
                                            new XElement("EmployeeName", invoiceTransaction.EmployeeName),
                                            new XElement("Date", invoiceTransaction.Date.ToShortDateString()),
                                            new XElement("Note", invoiceTransaction.ProjectTimeBlockExternalNote),
                                            new XElement("ExternalNote", invoiceTransaction.Comment),
                                            new XElement("InvoiceTransactionQuantity", invoiceTransaction.Quantity),
                                            new XElement("InvoiceTransactionInvoiceQuantity", invoiceTransaction.InvoiceQuantity),
                                            new XElement("InvoiceTransactionCreated", invoiceTransaction.Created.HasValue ? invoiceTransaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                            new XElement("InvoiceTransactionCreatedBy", invoiceTransaction.CreatedBy),
                                            new XElement("InvoiceTransactionExported", invoiceTransaction.Exported.ToInt()),
                                            new XElement("InvoiceTransactionProductNumber", invoiceTransaction.ProductNumber),
                                            new XElement("InvoiceTransactionProductName", invoiceTransaction.ProductName),
                                            new XElement("InvoiceTransactionProductDescription", invoiceTransaction.ProductDescription),
                                            new XElement("InvoiceTransactionTimeCodeCode", invoiceTransaction.TimeCode),
                                            new XElement("InvoiceTransactionTimeCodeName", invoiceTransaction.TimeCodeName),
                                            new XElement("InvoiceTransactionTimeCodeDescription", invoiceTransaction.TimeCodeDescription),
                                            new XElement("InvoiceTransactionTimeCodeTransactionId", invoiceTransaction.TimeCodeTransactionId),
                                            new XElement("InvoiceTransactionTimeCodeTransactionQuantity", invoiceTransaction.Quantity),
                                            new XElement("InvoiceTransactionTimeCodeTransactionInvoiceQuantity", invoiceTransaction.InvoiceQuantity),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectId", invoiceTransaction.ProjectId),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectNumber", invoiceTransaction.ProjectNr),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectName", invoiceTransaction.ProjectName),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectNote", invoiceTransaction.ProjectNote),
                                            new XElement("InvoiceTransactionTimeCodeTransactionParentProjectNumber", invoiceTransaction.ParentProjectNumber),
                                            new XElement("InvoiceTransactionTimeCodeTransactionParentProjectName", invoiceTransaction.ParentProjectName),
                                            new XElement("WeekNumber", weeknr.ToString()),
                                            new XElement("IsoDate", invoiceTransaction.Date.ToString("yyyy-MM-dd")),
                                            new XElement("InvoiceNr", invoiceTransaction.InvoiceNr),
                                            new XElement("OriginType", invoiceTransaction.OriginType ?? 0),
                                            new XElement("InvoiceTransactionInvoiceCustomerName", invoiceTransaction.CustomerName),
                                            new XElement("InvoiceTransactionInvoiceCustomerNr", invoiceTransaction.CustomerNr));

                    invoiceTransactionElements.Add(invoiceTransactionElement);
                    timeInvoiceTransactionXmlId++;
                }

                #endregion

                #endregion

                #region Project

                XElement projectElement = new XElement("Project",
                               new XAttribute("id", projectXmlId),
                               new XElement("ProjectNumber", project.Number),
                               new XElement("ProjectName", project.Name),
                               new XElement("ProjectDescription", project.Description),
                               new XElement("ProjectCreated", project.Created.HasValue ? project.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                               new XElement("ProjectCreatedBy", project.CreatedBy),
                               new XElement("ProjectState", project.State),
                               new XElement("ProjectCustomerNr", project.Customer == null ? "" : project.Customer.CustomerNr),
                               new XElement("ProjectCustomerName", project.Customer == null ? "" : project.Customer.Name));

                projectXmlId++;

                #endregion

                #region Add Invoices

                foreach (XElement invoice in invoiceElements)
                {
                    projectElement.Add(invoice);
                }

                invoiceElements.Clear();

                #endregion

                #region Add TimePayrollTransaction

                foreach (XElement transaction in payrollTransactionElements)
                {
                    projectElement.Add(transaction);
                }

                #endregion

                #region Add TimeInvoiceTransaction

                foreach (XElement transaction in invoiceTransactionElements)
                {
                    projectElement.Add(transaction);
                }

                #endregion

                #region Create Merged Transactions

                List<XElement> mergedTransactions = new List<XElement>();
                int mergedTransactionXmlId = 1;

                try
                {
                    foreach (XElement transaction in payrollTransactionElements)
                    {

                        XElement mergedTransaction = new XElement("MergedTransaction",
                                new XAttribute("id", mergedTransactionXmlId),
                                new XElement("EmployeeNr", transaction.Element("EmployeeNr").Value),
                                new XElement("EmployeeName", transaction.Element("EmployeeName").Value),
                                new XElement("Date", transaction.Element("Date").Value),
                                new XElement("Note", transaction.Element("Note").Value),
                                new XElement("ExternalNote", transaction.Element("ExternalNote").Value),
                                new XElement("WeekNumber", transaction.Element("WeekNumber").Value),
                                new XElement("IsoDate", transaction.Element("IsoDate").Value),
                                new XElement("PayrollTransactionQuantity", transaction.Element("PayrollTransactionQuantity").Value),
                                new XElement("PayrollTransactionCreated", transaction.Element("PayrollTransactionCreated").Value),
                                new XElement("PayrollTransactionCreatedBy", transaction.Element("PayrollTransactionCreatedBy").Value),
                                new XElement("PayrollTransactionExported", 0),
                                new XElement("PayrollTransactionProductNumber", transaction.Element("PayrollTransactionProductNumber").Value),
                                new XElement("PayrollTransactionProductName", transaction.Element("PayrollTransactionProductName").Value),
                                new XElement("PayrollTransactionProductDescription", string.Empty),
                                new XElement("InvoiceTransactionQuantity", 0),
                                new XElement("InvoiceTransactionInvoiceQuantity", 0),
                                new XElement("InvoiceTransactionCreated", transaction.Element("PayrollTransactionCreated").Value),
                                new XElement("InvoiceTransactionCreatedBy", string.Empty),
                                new XElement("InvoiceTransactionExported", 0),
                                new XElement("InvoiceTransactionProductNumber", string.Empty),
                                new XElement("InvoiceTransactionProductName", string.Empty),
                                new XElement("InvoiceTransactionProductDescription", string.Empty),
                                new XElement("TimeCodeCode", string.Empty),
                                new XElement("TimeCodeName", transaction.Element("PayrollTransactionTimeCodeName").Value),
                                new XElement("TimeCodeDescription", ""),
                                new XElement("TimeCodeTransactionId", 0),
                                new XElement("TimeCodeTransactionQuantity", transaction.Element("PayrollTransactionTimeCodeTransactionQuantity").Value),
                                new XElement("TimeCodeTransactionInvoiceQuantity", transaction.Element("PayrollTransactionTimeCodeTransactionInvoiceQuantity").Value),
                                new XElement("TimeCodeTransactionProjectId", transaction.Element("PayrollTransactionTimeCodeTransactionProjectId").Value),
                                new XElement("TimeCodeTransactionProjectNumber", transaction.Element("PayrollTransactionTimeCodeTransactionProjectNumber").Value),
                                new XElement("TimeCodeTransactionProjectName", transaction.Element("PayrollTransactionTimeCodeTransactionProjectName").Value),
                                new XElement("TimeCodeTransactionProjectNote", string.Empty),
                                new XElement("TimeCodeTransactionParentProjectNumber", string.Empty),
                                new XElement("TimeCodeTransactionParentProjectName", string.Empty),
                                new XElement("PayrollType", 0),
                                new XElement("isPayed", 0),
                                new XElement("InvoiceNr", transaction.Element("InvoiceNr").Value),
                                new XElement("OriginType", 0),
                                new XElement("PayrollTransactionInvoiceCustomerName", transaction.Element("PayrollTransactionInvoiceCustomerName").Value),
                                new XElement("PayrollTransactionInvoiceCustomerNr", string.Empty),
                                new XElement("TimeDeviationCauseName", transaction.Element("TimeDeviationCauseName").Value),
                                new XElement("PayrollTransactionUnitPrice", 0),
                                new XElement("PayrollAttestStateName", string.Empty)
                                );

                        mergedTransactions.Add(mergedTransaction);

                        mergedTransactionXmlId++;
                    }
                }
                catch (Exception ex)
                {
                    LogError(ex, log);
                }

                payrollTransactionElements.Clear();

                try
                {
                    foreach (XElement transaction in invoiceTransactionElements)
                    {
                        XElement mergedTransaction = new XElement("MergedTransaction",
                                new XAttribute("id", mergedTransactionXmlId),
                                new XElement("EmployeeNr", transaction.Element("EmployeeNr").Value),
                                new XElement("EmployeeName", transaction.Element("EmployeeName").Value),
                                new XElement("Date", transaction.Element("Date").Value),
                                new XElement("Note", transaction.Element("Note").Value),
                                new XElement("ExternalNote", transaction.Element("ExternalNote").Value),
                                new XElement("WeekNumber", transaction.Element("WeekNumber").Value),
                                new XElement("IsoDate", transaction.Element("IsoDate").Value),
                                new XElement("PayrollTransactionQuantity", 0),
                                new XElement("PayrollTransactionCreated", 0),
                                new XElement("PayrollTransactionCreatedBy", string.Empty),
                                new XElement("PayrollTransactionExported", 0),
                                new XElement("PayrollTransactionProductNumber", string.Empty),
                                new XElement("PayrollTransactionProductName", string.Empty),
                                new XElement("PayrollTransactionProductDescription", string.Empty),
                                new XElement("InvoiceTransactionQuantity", transaction.Element("InvoiceTransactionQuantity").Value),
                                new XElement("InvoiceTransactionInvoiceQuantity", transaction.Element("InvoiceTransactionInvoiceQuantity").Value),
                                new XElement("InvoiceTransactionCreated", transaction.Element("InvoiceTransactionCreated").Value),
                                new XElement("InvoiceTransactionCreatedBy", transaction.Element("InvoiceTransactionCreatedBy").Value),
                                new XElement("InvoiceTransactionExported", transaction.Element("InvoiceTransactionExported").Value),
                                new XElement("InvoiceTransactionProductNumber", transaction.Element("InvoiceTransactionProductNumber").Value),
                                new XElement("InvoiceTransactionProductName", transaction.Element("InvoiceTransactionProductName").Value),
                                new XElement("InvoiceTransactionProductDescription", transaction.Element("InvoiceTransactionProductDescription").Value),
                                new XElement("TimeCodeCode", transaction.Element("InvoiceTransactionTimeCodeCode").Value),
                                new XElement("TimeCodeName", transaction.Element("InvoiceTransactionTimeCodeName").Value),
                                new XElement("TimeCodeDescription", transaction.Element("InvoiceTransactionTimeCodeDescription").Value),
                                new XElement("TimeCodeTransactionId", transaction.Element("InvoiceTransactionTimeCodeTransactionId").Value),
                                new XElement("TimeCodeTransactionQuantity", transaction.Element("InvoiceTransactionTimeCodeTransactionQuantity").Value),
                                new XElement("TimeCodeTransactionInvoiceQuantity", transaction.Element("InvoiceTransactionTimeCodeTransactionInvoiceQuantity").Value),
                                new XElement("TimeCodeTransactionProjectId", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectId").Value),
                                new XElement("TimeCodeTransactionProjectNumber", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectNumber").Value),
                                new XElement("TimeCodeTransactionProjectName", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectName").Value),
                                new XElement("TimeCodeTransactionProjectNote", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectNote").Value),
                                new XElement("TimeCodeTransactionParentProjectNumber", transaction.Element("InvoiceTransactionTimeCodeTransactionParentProjectNumber").Value),
                                new XElement("TimeCodeTransactionParentProjectName", transaction.Element("InvoiceTransactionTimeCodeTransactionParentProjectName").Value),
                                new XElement("PayrollType", 0),
                                new XElement("isPayed", 0),
                                new XElement("InvoiceNr", transaction.Element("InvoiceNr").Value),
                                new XElement("OriginType", transaction.Element("OriginType").Value),
                                new XElement("PayrollTransactionInvoiceCustomerName", transaction.Element("InvoiceTransactionInvoiceCustomerName").Value),
                                new XElement("PayrollTransactionInvoiceCustomerNr", transaction.Element("InvoiceTransactionInvoiceCustomerNr").Value),
                                new XElement("TimeDeviationCauseName", string.Empty),
                                new XElement("PayrollTransactionUnitPrice", 0),
                                new XElement("PayrollAttestStateName", string.Empty)
                                );

                        mergedTransactions.Add(mergedTransaction);

                        mergedTransactionXmlId++;
                    }
                }
                catch (Exception ex)
                {
                    LogError(ex, log);
                }

                invoiceTransactionElements.Clear();

                #endregion

                projectElement.Add(mergedTransactions);

                mergedTransactions.Clear();

                projectElements.Add(projectElement);
            }

            #endregion

            return projectElements;
        }

        private List<XElement> CreateProjectStatisticsDataContentFromProjectInvoiceDays(EvaluatedSelection es, ref int projectXmlId)
        {
            try
            {
                int timeInvoiceTransactionXmlId = 1;
                int timePayrollTransactionXmlId = 1;
                List<XElement> projectElements = new List<XElement>();

                #region Prereq

                List<Employee> employeeLocalCache = new List<Employee>();
                List<PayrollProduct> payrollProductLocalCache = new List<PayrollProduct>();
                Dictionary<int, PayrollProduct> timeCodePayrollProductDict = new Dictionary<int, PayrollProduct>();
                Dictionary<int, decimal> employeeCalculatedCostDict = new Dictionary<int, decimal>();

                //Get TimeProject's
                List<TimeProject> projects = ProjectManager.GetTimeProjectsFromSelection(es);
                List<int> projectIds = projects.Select(x => x.ProjectId).ToList();

                //Build collections
                List<int> invoiceIdsAll = new List<int>();
                List<int> projectDayIdsAll = new List<int>();
                Dictionary<int, List<int>> projectDaysDict = new Dictionary<int, List<int>>();
                Dictionary<int, List<int>> projectInvoicesDict = new Dictionary<int, List<int>>();

                ProjectManager.GetProjectDayMappingIds(es.ActorCompanyId, projectIds, ref projectDayIdsAll, ref projectDaysDict);

                //Get all ProjectInvoiceDay's for Projects
                var timePayrollTransactions = ProjectManager.GetTimePayrollTransactionsFromSelection(projectDayIdsAll, es);
                var timeInvoiceTransactions = ProjectManager.GetTimeInvoiceTransactionsFromSelection(projectDayIdsAll, es);
                var timeSheetWeekTransactions = ProjectManager.GetTimeSheetTimeCodeTransactionsFromSelection(es);

                var tempIds = timePayrollTransactions.Select(t => t.ProjectId).ToList();
                tempIds.AddRange(timeInvoiceTransactions.Select(t => t.ProjectId));
                tempIds.AddRange(timeSheetWeekTransactions.Select(t => t.ProjectId.Value));

                //Filter
                projectIds = tempIds.Distinct().ToList();

                // Map invoices
                ProjectManager.GetProjectInvoiceMappingIds(es.ActorCompanyId, projectIds, ref invoiceIdsAll, ref projectInvoicesDict);

                //Get all CustomerInvoices for Projects
                var invoiceItems = ProjectManager.GetInvoicesForTimeProjectsFromSelection(invoiceIdsAll, es);

                // Get expenses for interval
                var employeeId = EmployeeManager.GetEmployeeIdForUser(base.UserId, base.ActorCompanyId);
                var allExpenseRows = ExpenseManager.GetExpenseRowsForGridFiltered(base.ActorCompanyId, base.UserId, es.RoleId, employeeId, es.DateFrom, es.DateTo, null, projectIds, null, null);

                #endregion

                #region Content

                foreach (TimeProject project in projects.Where(p => projectIds.Contains(p.ProjectId)))
                {
                    #region Prereq

                    //TimeSheet transactions
                    var timeSheetTransactions = timeSheetWeekTransactions.Where(t => t.ProjectId == project.ProjectId);
                    //var timeSheetTransactions = ProjectManager.GetTimeSheetPayrollTransactionForProject(project.ProjectId);

                    //InvoiceId's for current TimeProject
                    List<int> invoiceIdsForProject = (from p in projectInvoicesDict
                                                      where p.Key == project.ProjectId
                                                      select p.Value).FirstOrDefault();

                    if (invoiceIdsForProject == null && timeSheetTransactions == null)
                        continue;

                    //if we have made a selection on customernr we only want those projects that has an invoice that is connected to the choosen customers
                    if (es.SB_HasCustomerNrInterval)
                    {
                        bool jumpOverProject = true;
                        foreach (var invoice in invoiceItems)
                        {
                            if (invoiceIdsForProject != null && invoiceIdsForProject.Contains(invoice.InvoiceId))
                            {
                                jumpOverProject = false;
                                break;
                            }
                        }

                        if (jumpOverProject)
                            continue;
                    }

                    #endregion

                    #region Invoice

                    List<XElement> invoiceElements = new List<XElement>();
                    int invoiceXmlId = 1;

                    foreach (var invoiceItem in invoiceItems)
                    {
                        if (invoiceIdsForProject == null)
                            continue;

                        //Check that CustomerInvoice belongs to current TimeProject
                        if (!invoiceIdsForProject.Contains(invoiceItem.InvoiceId))
                            continue;

                        #region CustomerInvoice

                        #region Invoice

                        XElement invoiceElement = new XElement("Invoice",
                                new XAttribute("id", invoiceXmlId),
                                new XElement("InvoiceNr", invoiceItem.InvoiceNr),
                                new XElement("InvoiceCreated", invoiceItem.Created.HasValue ? invoiceItem.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                new XElement("InvoiceCreatedBy", invoiceItem.CreatedBy),
                                new XElement("InvoiceCustomerNr", invoiceItem.CustomerNr),
                                new XElement("InvoiceCustomerName", invoiceItem.CustomerName));

                        #endregion

                        #region DefaultInvoiceRow

                        XElement invoiceRowElement = new XElement("CustomerInvoiceRow",
                                    new XAttribute("id", 1),
                                    new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                    new XElement("InvoiceRowCreatedBy", ""),
                                    new XElement("InvoiceRowProductNumber", ""),
                                    new XElement("InvoiceRowProductName", ""),
                                    new XElement("InvoiceRowProductDescription", ""),
                                    new XElement("InvoiceRowUnitName", ""));

                        invoiceElement.Add(invoiceRowElement);

                        #endregion

                        #region InvoiceExpenseRow

                        int invoiceExpenseRowXmlId = 1;
                        //int saveTimeCodeId = 0;
                        //     InvoiceProduct invoiceProduct = null;
                        PayrollProduct payrollProduct = null;
                        var expenseRowsForInvoice = allExpenseRows.Where(r => r.OrderId == invoiceItem.InvoiceId);
                        foreach (var expenseRow in expenseRowsForInvoice)
                        {
                            //Check expensrows 
                            if (expenseRow.InvoiceRowAttestStateId == 0)
                                continue;

                            if (es.HasDateInterval && (expenseRow.From < es.DateFrom.Date || expenseRow.From > es.DateTo.Date))
                                continue;

                            if (timeCodePayrollProductDict.ContainsKey(expenseRow.TimeCodeId))
                            {
                                payrollProduct = timeCodePayrollProductDict.FirstOrDefault(i => i.Key == expenseRow.TimeCodeId).Value;
                            }
                            else
                            {
                                using CompEntities entitiesReadOnly = CompEntitiesProvider.LeaseReadOnlyContext();
                                payrollProduct = GetPayrollProductFromTimeCode(entitiesReadOnly, expenseRow.TimeCodeId, es.ActorCompanyId);
                                timeCodePayrollProductDict.Add(expenseRow.TimeCodeId, payrollProduct);
                                if (payrollProduct != null)
                                    payrollProductLocalCache.Add(payrollProduct);
                            }

                            XElement invoiceExpenseRowElement = new XElement("CustomerInvoiceExpenseRow",
                                   new XAttribute("id", invoiceExpenseRowXmlId),
                                   new XElement("ProjectNumber", project.Number),
                                   new XElement("ProjectName", project.Name),
                                   new XElement("InvoiceNr", invoiceItem.InvoiceNr),
                                   new XElement("InvoiceCustomerName", invoiceItem.CustomerName),
                                   new XElement("InvoiceExpenseRowEmployeeName", expenseRow.EmployeeName),
                                   new XElement("InvoiceExpenseRowTimeCodeName", expenseRow.TimeCodeName),
                                   new XElement("InvoiceExpenseRowPayrollAttestStateName", expenseRow.PayrollAttestStateName),
                                   new XElement("InvoiceExpenseRowQuantity", expenseRow.Quantity),
                                   new XElement("InvoiceExpenseRowQuantityType", expenseRow.TimeCodeRegistrationType),
                                   new XElement("InvoiceExpenseRowUnitPrice", expenseRow.UnitPrice),
                                   new XElement("InvoiceExpenseRowAmount", expenseRow.Amount),
                                   new XElement("InvoiceExpenseRowInvoicedAmount", expenseRow.InvoicedAmount),
                                   new XElement("InvoiceExpenseRowDate", expenseRow.From.ToShortDateString()),
                                   new XElement("InvoiceExpenseRowEmployeeNr", expenseRow.EmployeeNumber),
                                   new XElement("InvoiceExpenseRowPayrollProductNr", payrollProduct != null ? payrollProduct.Number : ""),
                                   new XElement("InvoiceExpenseRowPayrollProductName", payrollProduct != null ? payrollProduct.Name : "")
                                   );

                            invoiceElement.Add(invoiceExpenseRowElement);
                            invoiceExpenseRowXmlId++;
                        }
                        #endregion

                        #region Default element InvoiceExpenseRow

                        if (invoiceExpenseRowXmlId == 1)
                        {
                            XElement invoiceExpenseRowElement = new XElement("CustomerInvoiceExpenseRow",
                                    new XAttribute("id", 1),
                                    new XElement("ProjectNumber", " "),
                                    new XElement("ProjectName", " "),
                                    new XElement("InvoiceNr", " "),
                                    new XElement("InvoiceCustomerName", " "),
                                    new XElement("InvoiceExpenseRowEmployeeName", " "),
                                    new XElement("InvoiceExpenseRowTimeCodeName", " "),
                                    new XElement("InvoiceExpenseRowPayrollAttestStateName", " "),
                                    new XElement("InvoiceExpenseRowQuantity", 0),
                                    new XElement("InvoiceExpenseRowQuantityType", 0),
                                    new XElement("InvoiceExpenseRowUnitPrice", 0),
                                    new XElement("InvoiceExpenseRowAmount", 0),
                                    new XElement("InvoiceExpenseRowInvoicedAmount", 0),
                                    new XElement("InvoiceExpenseRowDate", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                    new XElement("InvoiceExpenseRowEmployeeNr", " "),
                                    new XElement("InvoiceExpenseRowPayrollProductNr", " "),
                                    new XElement("InvoiceExpenseRowPayrollProductName", " ")
                                    );
                            invoiceElement.Add(invoiceExpenseRowElement);
                        }
                        #endregion

                        invoiceElements.Add(invoiceElement);
                        invoiceXmlId++;

                        #endregion
                    }

                    #endregion

                    if (invoiceXmlId == 1)
                    {
                        #region Default element Invoice

                        XElement defInvoiceElement = new XElement("Invoice",
                                new XAttribute("id", 1),
                                new XElement("InvoiceNr", ""),
                                new XElement("InvoiceCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                new XElement("InvoiceCreatedBy", "")
                                );
                        XElement defInvoiceRowElement = new XElement("CustomerInvoiceRow",
                               new XAttribute("id", 1),
                               new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                               new XElement("InvoiceRowCreatedBy", ""),
                               new XElement("InvoiceRowProductNumber", ""),
                               new XElement("InvoiceRowProductName", ""),
                               new XElement("InvoiceRowProductDescription", ""),
                               new XElement("InvoiceRowUnitName", "")
                               );

                        defInvoiceElement.Add(defInvoiceRowElement);
                        invoiceElements.Add(defInvoiceElement);

                        #endregion
                    }

                    #region ProjectInvoiceDay

                    List<XElement> invoiceTransactionElements = new List<XElement>();
                    List<XElement> payrollTransactionElements = new List<XElement>();

                    //ProjectInvoiceDay's for current TimeProject
                    List<int> projectDayIdsForProject = (from p in projectDaysDict
                                                         where p.Key == project.ProjectId
                                                         select p.Value).FirstOrDefault();


                    //Order has been deleted
                    //if (day.ProjectInvoiceWeek.RecordType == (int)SoeProjectRecordType.Order && !invoiceIdsForProject.Contains(day.ProjectInvoiceWeek.RecordId))
                    //    continue;

                    if (projectDayIdsForProject != null && invoiceIdsForProject != null)
                    {
                        #region TimePayrollTransaction
                        Employee payrollEmployee = null;

                        foreach (var payrollTransaction in timePayrollTransactions.Where(x => projectDayIdsForProject.Contains(x.ProjectInvoiceDayId)).ToList())
                        {
                            int weeknr = CalendarUtility.GetWeekNr(payrollTransaction.ProjectInvoiceDayDate);
                            decimal empCost = 0;
                            if (employeeLocalCache.Any(x => x.EmployeeId == payrollTransaction.EmployeeId))
                            {
                                payrollEmployee = employeeLocalCache.FirstOrDefault(x => x.EmployeeId == payrollTransaction.EmployeeId);
                            }
                            else
                            {
                                payrollEmployee = EmployeeManager.GetEmployee(payrollTransaction.EmployeeId, es.ActorCompanyId, onlyActive: false, loadContactPerson: true);
                                if (payrollEmployee != null)
                                    employeeLocalCache.Add(payrollEmployee);
                            }

                            if (employeeCalculatedCostDict.ContainsKey(payrollEmployee.EmployeeId))
                            {
                                empCost = employeeCalculatedCostDict.FirstOrDefault(i => i.Key == payrollEmployee.EmployeeId).Value;
                            }
                            else
                            {
                                empCost = EmployeeManager.GetEmployeeCalculatedCost(payrollEmployee, payrollTransaction.ProjectInvoiceDayDate, payrollTransaction.TimeCodeTransactionProjectId);
                                employeeCalculatedCostDict.Add(payrollEmployee.EmployeeId, empCost);
                            }


                            Project payrollTransactionTimeCodeTransactionProject = new Project();
                            if (payrollTransaction.TimeCodeTransactionProjectId != null)
                            {
                                payrollTransactionTimeCodeTransactionProject = (from t in projects
                                                                                where t.ProjectId == (int)payrollTransaction.TimeCodeTransactionProjectId
                                                                                select t).FirstOrDefault();
                            }

                            XElement payrollTransactionElement = new XElement("TimePayrollTransaction",
                            new XAttribute("id", timePayrollTransactionXmlId),
                            new XElement("EmployeeNr", payrollTransaction.EmployeeNr),
                            new XElement("EmployeeName", payrollTransaction.EmployeeName),
                            new XElement("Date", payrollTransaction.ProjectInvoiceDayDate.ToShortDateString()),
                            new XElement("Note", payrollTransaction.ProjectInvoiceDayNote),
                            new XElement("ExternalNote", payrollTransaction.Comment),
                            new XElement("PayrollTransactionQuantity", payrollTransaction.Quantity),
                            new XElement("PayrollTransactionCreated", payrollTransaction.Created.HasValue ? payrollTransaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("PayrollTransactionCreatedBy", payrollTransaction.CreatedBy),
                            new XElement("PayrollTransactionExported", payrollTransaction.Exported.ToInt()),
                            new XElement("PayrollTransactionProductNumber", payrollTransaction.ProductNumber),
                            new XElement("PayrollTransactionProductName", payrollTransaction.ProductName),
                            new XElement("PayrollTransactionProductDescription", payrollTransaction.ProductDescription),
                            new XElement("WeekNumber", weeknr.ToString()),
                            new XElement("IsoDate", payrollTransaction.ProjectInvoiceDayDate.Date.ToString("yyyy-MM-dd")),
                            new XElement("PayrollTransactionTimeCodeCode", payrollTransaction.TimeCode),
                            new XElement("PayrollTransactionTimeCodeName", payrollTransaction.TimeCodeName),
                            new XElement("PayrollTransactionTimeCodeDescription", payrollTransaction.TimeCodeDescription),
                            new XElement("PayrollTransactionTimeCodeTransactionId", payrollTransaction.TimeCodeTransactionId),
                            new XElement("PayrollTransactionTimeCodeTransactionQuantity", payrollTransaction.TimeCodeTransactionQuantity),
                            new XElement("PayrollTransactionTimeCodeTransactionInvoiceQuantity", payrollTransaction.TimeCodeTransactionInvoiceQuantity),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectId", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.ProjectId : 0),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectNumber", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.Number : string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectName", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.Name : string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionProjectNote", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.Note : string.Empty),
                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectNumber", payrollTransaction.ParentProjectNumber),
                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectName", payrollTransaction.ParentProjectName),
                            new XElement("PayrollType", payrollTransaction.PayrollType),
                            new XElement("isPayed", payrollTransaction.Payed.ToInt()),
                            new XElement("InvoiceNr", payrollTransaction.InvoiceNr),
                            new XElement("OriginType", payrollTransaction.OriginType.HasValue ? payrollTransaction.OriginType : 0),
                            new XElement("PayrollTransactionInvoiceCustomerName", payrollTransaction.CustomerName),
                            new XElement("PayrollTransactionInvoiceCustomerNr", payrollTransaction.CustomerNr),
                            new XElement("TimeDeviationCauseName", string.Empty),
                            new XElement("PayrollTransactionUnitPrice", empCost),
                            new XElement("PayrollAttestStateName", string.Empty)
                            //    new XElement("PayrollAttestStateName", payrollTransaction.TimePayrollAttestStateName)
                            );

                            payrollTransactionElements.Add(payrollTransactionElement);
                            timePayrollTransactionXmlId++;
                        }

                        #endregion

                        #region TimeInvoiceTransaction

                        foreach (var invoiceTransaction in timeInvoiceTransactions.Where(x => projectDayIdsForProject.Contains(x.ProjectInvoiceDayId)).ToList())
                        {
                            Project invoiceTransactionTimeCodeTransactionProject = new Project();

                            if (invoiceTransaction.TimeCodeTransactionProjectId.HasValue)
                            {
                                invoiceTransactionTimeCodeTransactionProject = (from t in projects
                                                                                where t.ProjectId == (int)invoiceTransaction.TimeCodeTransactionProjectId
                                                                                select t).FirstOrDefault();
                            }

                            int weeknr = CalendarUtility.GetWeekNr(invoiceTransaction.ProjectInvoiceDayDate);

                            XElement invoiceTransactionElement = new XElement("TimeInvoiceTransaction",
                                        new XAttribute("id", timeInvoiceTransactionXmlId),
                                        new XElement("EmployeeNr", invoiceTransaction.EmployeeNr),
                                        new XElement("EmployeeName", invoiceTransaction.EmployeeName),
                                        new XElement("Date", invoiceTransaction.ProjectInvoiceDayDate.Date.ToShortDateString()),
                                        new XElement("Note", invoiceTransaction.ProjectInvoiceDayNote),
                                        new XElement("ExternalNote", invoiceTransaction.Comment),
                                        new XElement("InvoiceTransactionQuantity", invoiceTransaction.Quantity),
                                        new XElement("InvoiceTransactionInvoiceQuantity", invoiceTransaction.InvoiceQuantity),
                                        new XElement("InvoiceTransactionCreated", invoiceTransaction.Created.HasValue ? invoiceTransaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                        new XElement("InvoiceTransactionCreatedBy", invoiceTransaction.CreatedBy),
                                        new XElement("InvoiceTransactionExported", invoiceTransaction.Exported.ToInt()),
                                        new XElement("InvoiceTransactionProductNumber", invoiceTransaction.ProductNumber),
                                        new XElement("InvoiceTransactionProductName", invoiceTransaction.ProductName),
                                        new XElement("InvoiceTransactionProductDescription", invoiceTransaction.ProductDescription),
                                        new XElement("InvoiceTransactionTimeCodeCode", invoiceTransaction.TimeCode),
                                        new XElement("InvoiceTransactionTimeCodeName", invoiceTransaction.TimeCodeName),
                                        new XElement("InvoiceTransactionTimeCodeDescription", invoiceTransaction.TimeCodeDescription),
                                        new XElement("InvoiceTransactionTimeCodeTransactionId", invoiceTransaction.TimeCodeTransactionId),
                                        new XElement("InvoiceTransactionTimeCodeTransactionQuantity", invoiceTransaction.TimeCodeTransactionQuantity),
                                        new XElement("InvoiceTransactionTimeCodeTransactionInvoiceQuantity", invoiceTransaction.TimeCodeTransactionInvoiceQuantity),
                                        new XElement("InvoiceTransactionTimeCodeTransactionProjectId", invoiceTransactionTimeCodeTransactionProject != null ? invoiceTransactionTimeCodeTransactionProject.ProjectId : 0),
                                        new XElement("InvoiceTransactionTimeCodeTransactionProjectNumber", invoiceTransactionTimeCodeTransactionProject != null ? invoiceTransactionTimeCodeTransactionProject.Number : string.Empty),
                                        new XElement("InvoiceTransactionTimeCodeTransactionProjectName", invoiceTransactionTimeCodeTransactionProject != null ? invoiceTransactionTimeCodeTransactionProject.Name : string.Empty),
                                        new XElement("InvoiceTransactionTimeCodeTransactionProjectNote", invoiceTransactionTimeCodeTransactionProject != null ? invoiceTransactionTimeCodeTransactionProject.Note : string.Empty),
                                        new XElement("InvoiceTransactionTimeCodeTransactionParentProjectNumber", invoiceTransaction.ParentProjectNumber),
                                        new XElement("InvoiceTransactionTimeCodeTransactionParentProjectName", invoiceTransaction.ParentProjectName),
                                        new XElement("WeekNumber", weeknr.ToString()),
                                        new XElement("IsoDate", invoiceTransaction.ProjectInvoiceDayDate.Date.ToString("yyyy-MM-dd")),
                                        new XElement("InvoiceNr", invoiceTransaction.InvoiceNr),
                                        new XElement("OriginType", invoiceTransaction.OriginType.HasValue ? invoiceTransaction.OriginType : 0),
                                        new XElement("InvoiceTransactionInvoiceCustomerName", invoiceTransaction.CustomerName),
                                        new XElement("InvoiceTransactionInvoiceCustomerNr", invoiceTransaction.CustomerNr));

                            invoiceTransactionElements.Add(invoiceTransactionElement);
                            timeInvoiceTransactionXmlId++;
                        }

                        #endregion
                    }



                    #endregion

                    #region TimePayrollTransactions from TimeSheet

                    string parProjectNumber = string.Empty;
                    string parProjectName = string.Empty;

                    if (project.ParentProjectId != null)
                    {
                        if (project.ParentProjectReference.IsLoaded)
                        {
                            parProjectNumber = project.ParentProject.Number;
                            parProjectName = project.ParentProject.Name;
                        }
                        else
                        {
                            var parProject = projects.FirstOrDefault(p => p.ProjectId == project.ParentProjectId.Value);
                            if (parProject != null)
                            {
                                parProjectNumber = parProject.Number;
                                parProjectName = parProject.Name;
                            }
                            else
                            {
                                project.ParentProjectReference.Load();

                                parProjectNumber = project.ParentProject.Number;
                                parProjectName = project.ParentProject.Name;
                            }
                        }
                    }


                    foreach (TimeCodeTransaction timeCodeTransaction in timeSheetTransactions)
                    {
                        if (timeCodeTransaction.TimePayrollTransaction != null)
                        {
                            if (es.HasDateInterval && (timeCodeTransaction.Start.Date < es.DateFrom.Date || timeCodeTransaction.Stop.Date > es.DateTo.Date))
                                continue;

                            #region Transactions

                            foreach (var transaction in timeCodeTransaction.TimePayrollTransaction.Where(t => t.State == (int)SoeEntityState.Active))
                            {
                                Employee employee = null;
                                if (employeeLocalCache.Any(x => x.EmployeeId == transaction.EmployeeId))
                                {
                                    employee = employeeLocalCache.FirstOrDefault(x => x.EmployeeId == transaction.EmployeeId);
                                }
                                else
                                {
                                    employee = EmployeeManager.GetEmployee(transaction.EmployeeId, es.ActorCompanyId, onlyActive: false, loadContactPerson: true);
                                    if (employee != null)
                                        employeeLocalCache.Add(employee);
                                }

                                if (employee != null && es.SB_HasEmployeeNrInterval && (employee.EmployeeNr.CompareTo(es.SB_EmployeeNrFrom) < 0 || employee.EmployeeNr.CompareTo(es.SB_EmployeeNrTo) > 0))
                                    continue;

                                PayrollProduct payrollProduct = null;
                                if (payrollProductLocalCache.Any(x => x.ProductId == transaction.ProductId))
                                {
                                    payrollProduct = payrollProductLocalCache.FirstOrDefault(x => x.ProductId == transaction.ProductId);
                                }
                                else
                                {
                                    payrollProduct = ProductManager.GetPayrollProduct(transaction.ProductId);
                                    if (payrollProduct != null)
                                        payrollProductLocalCache.Add(payrollProduct);
                                }

                                int weeknr = CalendarUtility.GetWeekNr(timeCodeTransaction.Start);

                                TimeCode timeCode = new TimeCode();

                                Project payrollTransactionTimeCodeTransactionProject = new Project();

                                if (transaction.TimeCodeTransaction != null && transaction.TimeCodeTransaction.ProjectId != null)
                                {
                                    payrollTransactionTimeCodeTransactionProject = (from t in projects
                                                                                    where t.ProjectId == (int)transaction.TimeCodeTransaction.ProjectId
                                                                                    select t).FirstOrDefault();
                                }

                                XElement payrollTransactionElement = new XElement("TimePayrollTransaction",
                                            new XAttribute("id", timePayrollTransactionXmlId),
                                            new XElement("EmployeeNr", employee != null ? employee.EmployeeNr : ""),
                                            new XElement("EmployeeName", employee != null ? employee.Name : ""),
                                            new XElement("Date", timeCodeTransaction.Start.ToShortDateString()),
                                            new XElement("Note", transaction.Comment),
                                            new XElement("ExternalNote", String.Empty),
                                            new XElement("PayrollTransactionQuantity", transaction.Quantity),
                                            new XElement("PayrollTransactionCreated", transaction.Created.HasValue ? transaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                            new XElement("PayrollTransactionCreatedBy", transaction.CreatedBy),
                                            new XElement("PayrollTransactionExported", transaction.Exported.ToInt()),
                                            new XElement("PayrollTransactionProductNumber", payrollProduct != null ? payrollProduct.Number : ""),
                                            new XElement("PayrollTransactionProductName", payrollProduct != null ? payrollProduct.Name : ""),
                                            new XElement("PayrollTransactionProductDescription", payrollProduct != null ? payrollProduct.Description : ""),
                                            new XElement("WeekNumber", weeknr.ToString()),
                                            new XElement("IsoDate", timeCodeTransaction.Start.ToString("yyyy-MM-dd")),
                                            new XElement("PayrollTransactionTimeCodeCode", timeCode != null ? timeCode.Code : ""),
                                            new XElement("PayrollTransactionTimeCodeName", timeCode != null ? timeCode.Name : ""),
                                            new XElement("PayrollTransactionTimeCodeDescription", timeCode != null ? timeCode.Description : ""),
                                            new XElement("PayrollTransactionTimeCodeTransactionId", transaction.TimeCodeTransactionId != null ? transaction.TimeCodeTransactionId : 0),
                                            new XElement("PayrollTransactionTimeCodeTransactionQuantity", timeCodeTransaction != null ? timeCodeTransaction.Quantity : 0),
                                            new XElement("PayrollTransactionTimeCodeTransactionInvoiceQuantity", timeCodeTransaction != null ? timeCodeTransaction.InvoiceQuantity : 0),
                                            new XElement("PayrollTransactionTimeCodeTransactionProjectId", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.ProjectId : 0),
                                            new XElement("PayrollTransactionTimeCodeTransactionProjectNumber", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.Number : string.Empty),
                                            new XElement("PayrollTransactionTimeCodeTransactionProjectName", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.Name : string.Empty),
                                            new XElement("PayrollTransactionTimeCodeTransactionProjectNote", payrollTransactionTimeCodeTransactionProject != null ? payrollTransactionTimeCodeTransactionProject.Note : string.Empty),
                                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectNumber", parProjectNumber),
                                            new XElement("PayrollTransactionTimeCodeTransactionParentProjectName", parProjectName),
                                            new XElement("PayrollType", payrollProduct != null ? payrollProduct.PayrollType : 0),
                                            new XElement("isPayed", payrollProduct != null ? payrollProduct.Payed.ToInt() : 0),
                                            new XElement("InvoiceNr", ""),
                                            new XElement("OriginType", 0),
                                            new XElement("PayrollTransactionInvoiceCustomerName", ""),
                                            new XElement("PayrollTransactionInvoiceCustomerNr", ""),
                                            new XElement("TimeDeviationCauseName", string.Empty),
                                            new XElement("PayrollTransactionUnitPrice", 0),
                                            new XElement("PayrollAttestStateName", string.Empty)
                                            );

                                payrollTransactionElements.Add(payrollTransactionElement);
                                timePayrollTransactionXmlId++;
                            }

                            #endregion
                        }
                    }

                    #endregion

                    #region Project

                    string projectCustomerNr = string.Empty;
                    string projectCustomerName = string.Empty;

                    if (project.Customer != null)
                    {
                        projectCustomerNr = project.Customer.CustomerNr;
                        projectCustomerName = project.Customer.Name;
                    }

                    XElement projectElement = new XElement("Project",
                                   new XAttribute("id", projectXmlId),
                                   new XElement("ProjectNumber", project.Number),
                                   new XElement("ProjectName", project.Name),
                                   new XElement("ProjectDescription", project.Description),
                                   new XElement("ProjectCreated", project.Created.HasValue ? project.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                   new XElement("ProjectCreatedBy", project.CreatedBy),
                                   new XElement("ProjectState", project.State),
                                   new XElement("ProjectCustomerNr", projectCustomerNr),
                                   new XElement("ProjectCustomerName", projectCustomerName));

                    projectXmlId++;

                    #endregion

                    #region Add Invoices

                    foreach (XElement invoice in invoiceElements)
                    {
                        projectElement.Add(invoice);
                    }

                    invoiceElements.Clear();

                    #endregion

                    #region Add TimePayrollTransaction

                    foreach (XElement transaction in payrollTransactionElements)
                    {
                        projectElement.Add(transaction);
                    }

                    #endregion

                    #region Add TimeInvoiceTransaction

                    foreach (XElement transaction in invoiceTransactionElements)
                    {
                        projectElement.Add(transaction);
                    }

                    #endregion

                    #region Create Merged Transactions

                    List<XElement> mergedTransactions = new List<XElement>();
                    int mergedTransactionXmlId = 1;

                    try
                    {
                        foreach (XElement transaction in payrollTransactionElements)
                        {

                            XElement mergedTransaction = new XElement("MergedTransaction",
                                    new XAttribute("id", mergedTransactionXmlId),
                                    new XElement("EmployeeNr", transaction.Element("EmployeeNr").Value),
                                    new XElement("EmployeeName", transaction.Element("EmployeeName").Value),
                                    new XElement("Date", transaction.Element("Date").Value),
                                    new XElement("Note", transaction.Element("Note").Value),
                                    new XElement("ExternalNote", transaction.Element("ExternalNote").Value),
                                    new XElement("WeekNumber", transaction.Element("WeekNumber").Value),
                                    new XElement("IsoDate", transaction.Element("IsoDate").Value),
                                    new XElement("PayrollTransactionQuantity", transaction.Element("PayrollTransactionQuantity").Value),
                                    new XElement("PayrollTransactionCreated", transaction.Element("PayrollTransactionCreated").Value),
                                    new XElement("PayrollTransactionCreatedBy", transaction.Element("PayrollTransactionCreatedBy").Value),
                                    new XElement("PayrollTransactionExported", transaction.Element("PayrollTransactionExported").Value),
                                    new XElement("PayrollTransactionProductNumber", transaction.Element("PayrollTransactionProductNumber").Value),
                                    new XElement("PayrollTransactionProductName", transaction.Element("PayrollTransactionProductName").Value),
                                    new XElement("PayrollTransactionProductDescription", transaction.Element("PayrollTransactionProductDescription").Value),
                                    new XElement("InvoiceTransactionQuantity", 0),
                                    new XElement("InvoiceTransactionInvoiceQuantity", 0),
                                    new XElement("InvoiceTransactionCreated", transaction.Element("PayrollTransactionCreated").Value),
                                    new XElement("InvoiceTransactionCreatedBy", string.Empty),
                                    new XElement("InvoiceTransactionExported", 0),
                                    new XElement("InvoiceTransactionProductNumber", string.Empty),
                                    new XElement("InvoiceTransactionProductName", string.Empty),
                                    new XElement("InvoiceTransactionProductDescription", string.Empty),
                                    new XElement("TimeCodeCode", transaction.Element("PayrollTransactionTimeCodeCode").Value),
                                    new XElement("TimeCodeName", transaction.Element("PayrollTransactionTimeCodeName").Value),
                                    new XElement("TimeCodeDescription", transaction.Element("PayrollTransactionTimeCodeDescription").Value),
                                    new XElement("TimeCodeTransactionId", transaction.Element("PayrollTransactionTimeCodeTransactionId").Value),
                                    new XElement("TimeCodeTransactionQuantity", transaction.Element("PayrollTransactionTimeCodeTransactionQuantity").Value),
                                    new XElement("TimeCodeTransactionInvoiceQuantity", transaction.Element("PayrollTransactionTimeCodeTransactionInvoiceQuantity").Value),
                                    new XElement("TimeCodeTransactionProjectId", transaction.Element("PayrollTransactionTimeCodeTransactionProjectId").Value),
                                    new XElement("TimeCodeTransactionProjectNumber", transaction.Element("PayrollTransactionTimeCodeTransactionProjectNumber").Value),
                                    new XElement("TimeCodeTransactionProjectName", transaction.Element("PayrollTransactionTimeCodeTransactionProjectName").Value),
                                    new XElement("TimeCodeTransactionProjectNote", transaction.Element("PayrollTransactionTimeCodeTransactionProjectNote").Value),
                                    new XElement("TimeCodeTransactionParentProjectNumber", transaction.Element("PayrollTransactionTimeCodeTransactionParentProjectNumber").Value),
                                    new XElement("TimeCodeTransactionParentProjectName", transaction.Element("PayrollTransactionTimeCodeTransactionParentProjectName").Value),
                                    new XElement("PayrollType", transaction.Element("PayrollType").Value),
                                    new XElement("isPayed", transaction.Element("isPayed").Value),
                                    new XElement("InvoiceNr", transaction.Element("InvoiceNr").Value),
                                    new XElement("OriginType", transaction.Element("OriginType").Value),
                                    new XElement("PayrollTransactionInvoiceCustomerName", transaction.Element("PayrollTransactionInvoiceCustomerName").Value),
                                    new XElement("PayrollTransactionInvoiceCustomerNr", transaction.Element("PayrollTransactionInvoiceCustomerNr").Value),
                                    new XElement("TimeDeviationCauseName", transaction.Element("TimeDeviationCauseName").Value),
                                    new XElement("PayrollTransactionUnitPrice", 0),
                                    new XElement("PayrollAttestStateName", string.Empty)
                                    );

                            mergedTransactions.Add(mergedTransaction);

                            mergedTransactionXmlId++;
                        }
                    }
                    catch (Exception ex)
                    {
                        LogError(ex, log);
                    }

                    payrollTransactionElements.Clear();

                    try
                    {
                        foreach (XElement transaction in invoiceTransactionElements)
                        {
                            XElement mergedTransaction = new XElement("MergedTransaction",
                                    new XAttribute("id", mergedTransactionXmlId),
                                    new XElement("EmployeeNr", transaction.Element("EmployeeNr").Value),
                                    new XElement("EmployeeName", transaction.Element("EmployeeName").Value),
                                    new XElement("Date", transaction.Element("Date").Value),
                                    new XElement("Note", transaction.Element("Note").Value),
                                    new XElement("ExternalNote", transaction.Element("ExternalNote").Value),
                                    new XElement("WeekNumber", transaction.Element("WeekNumber").Value),
                                    new XElement("IsoDate", transaction.Element("IsoDate").Value),
                                    new XElement("PayrollTransactionQuantity", 0),
                                    new XElement("PayrollTransactionCreated", 0),
                                    new XElement("PayrollTransactionCreatedBy", string.Empty),
                                    new XElement("PayrollTransactionExported", 0),
                                    new XElement("PayrollTransactionProductNumber", string.Empty),
                                    new XElement("PayrollTransactionProductName", string.Empty),
                                    new XElement("PayrollTransactionProductDescription", string.Empty),
                                    new XElement("InvoiceTransactionQuantity", transaction.Element("InvoiceTransactionQuantity").Value),
                                    new XElement("InvoiceTransactionInvoiceQuantity", transaction.Element("InvoiceTransactionInvoiceQuantity").Value),
                                    new XElement("InvoiceTransactionCreated", transaction.Element("InvoiceTransactionCreated").Value),
                                    new XElement("InvoiceTransactionCreatedBy", transaction.Element("InvoiceTransactionCreatedBy").Value),
                                    new XElement("InvoiceTransactionExported", transaction.Element("InvoiceTransactionExported").Value),
                                    new XElement("InvoiceTransactionProductNumber", transaction.Element("InvoiceTransactionProductNumber").Value),
                                    new XElement("InvoiceTransactionProductName", transaction.Element("InvoiceTransactionProductName").Value),
                                    new XElement("InvoiceTransactionProductDescription", transaction.Element("InvoiceTransactionProductDescription").Value),
                                    new XElement("TimeCodeCode", transaction.Element("InvoiceTransactionTimeCodeCode").Value),
                                    new XElement("TimeCodeName", transaction.Element("InvoiceTransactionTimeCodeName").Value),
                                    new XElement("TimeCodeDescription", transaction.Element("InvoiceTransactionTimeCodeDescription").Value),
                                    new XElement("TimeCodeTransactionId", transaction.Element("InvoiceTransactionTimeCodeTransactionId").Value),
                                    new XElement("TimeCodeTransactionQuantity", transaction.Element("InvoiceTransactionTimeCodeTransactionQuantity").Value),
                                    new XElement("TimeCodeTransactionInvoiceQuantity", transaction.Element("InvoiceTransactionTimeCodeTransactionInvoiceQuantity").Value),
                                    new XElement("TimeCodeTransactionProjectId", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectId").Value),
                                    new XElement("TimeCodeTransactionProjectNumber", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectNumber").Value),
                                    new XElement("TimeCodeTransactionProjectName", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectName").Value),
                                    new XElement("TimeCodeTransactionProjectNote", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectNote").Value),
                                    new XElement("TimeCodeTransactionParentProjectNumber", transaction.Element("InvoiceTransactionTimeCodeTransactionParentProjectNumber").Value),
                                    new XElement("TimeCodeTransactionParentProjectName", transaction.Element("InvoiceTransactionTimeCodeTransactionParentProjectName").Value),
                                    new XElement("PayrollType", 0),
                                    new XElement("isPayed", 0),
                                    new XElement("InvoiceNr", transaction.Element("InvoiceNr").Value),
                                    new XElement("OriginType", transaction.Element("OriginType").Value),
                                    new XElement("PayrollTransactionInvoiceCustomerName", transaction.Element("InvoiceTransactionInvoiceCustomerName").Value),
                                    new XElement("PayrollTransactionInvoiceCustomerNr", transaction.Element("InvoiceTransactionInvoiceCustomerNr").Value),
                                    new XElement("TimeDeviationCauseName", string.Empty),
                                    new XElement("PayrollTransactionUnitPrice", 0),
                                    new XElement("PayrollAttestStateName", string.Empty)
                                    );

                            mergedTransactions.Add(mergedTransaction);

                            mergedTransactionXmlId++;
                        }
                    }
                    catch (Exception ex)
                    {
                        LogError(ex, log);
                    }

                    invoiceTransactionElements.Clear();

                    #endregion

                    projectElement.Add(mergedTransactions);

                    mergedTransactions.Clear();

                    projectElements.Add(projectElement);
                }

                #endregion

                return projectElements;
            }
            catch (Exception)
            {
                if (es != null)
                {
                    var parameters = String.Empty;
                    PropertyInfo[] properties = es.GetType().GetProperties();
                    foreach (var prop in properties)
                    {
                        parameters += prop.Name + ": " + prop.GetValue(es) + ";";
                    }
                    base.LogError("CreateProjectStatisticsDataContentFromProjectInvoiceDays -> " + parameters);
                }
                throw;
            }
        }

        private List<XElement> CreateProjectTimeReportDataContentFromProjectTimeBlocks(EvaluatedSelection es, ref int projectXmlId)
        {
            int timeInvoiceTransactionXmlId = 1;
            int timePayrollTransactionXmlId = 1;
            List<XElement> projectElements = new List<XElement>();

            #region Prereq

            //Get TimeProject's
            var useProjectIntervals = (es.SP_ProjectIds != null && es.SP_ProjectIds.Count > 0) || (es.SB_ProjectNrFrom != null && es.SB_ProjectNrTo != null && (es.SB_ProjectNrFrom.Length > 0 || es.SB_ProjectNrTo.Length > 0));
            List<TimeProject> projects = ProjectManager.GetTimeProjectsFromSelection(es);
            List<int> projectIds = projects.Select(x => x.ProjectId).ToList();

            //Build collections
            List<int> invoiceIdsAll = new List<int>();
            Dictionary<int, List<int>> projectInvoicesDict = new Dictionary<int, List<int>>();

            var employeeIds = (es.SB_EmployeeNrFrom == null) ? EmployeeManager.GetAllEmployeeIds(es.ActorCompanyId) : EmployeeManager.GetAllEmployeeIdsByEmployeeNrFromTo(es.ActorCompanyId, es.SB_EmployeeNrFrom, es.SB_EmployeeNrTo);

            //Get all ProjectTImeBlocks's for Projects
            var timeInvoiceTransactions = ProjectManager.GetProjectTimeBlockInvoiceTransactionsFromSelection(es, useProjectIntervals ? projectIds : null, employeeIds);
            var timePayrollTransactions = ProjectManager.GetProjectTimeBlockDTOs(es.DateFrom, es.DateTo, employeeIds, useProjectIntervals ? projectIds : null, null, false);


            var tempIds = timePayrollTransactions.Select(t => t.ProjectId).ToList();
            tempIds.AddRange(timeInvoiceTransactions.Select(t => t.ProjectId));

            //Filter
            projectIds = tempIds.Distinct().ToList();

            // Map invoices
            ProjectManager.GetProjectInvoiceMappingIds(es.ActorCompanyId, projectIds, ref invoiceIdsAll, ref projectInvoicesDict);

            //Get all CustomerInvoices for Projects
            var invoiceItems = ProjectManager.GetInvoicesForTimeProjectsFromSelection(invoiceIdsAll, es);

            #endregion

            #region Content

            foreach (TimeProject project in projects.Where(p => projectIds.Contains(p.ProjectId)))
            {
                #region Prereq

                //InvoiceId's for current TimeProject
                List<int> invoiceIdsForProject = (from p in projectInvoicesDict
                                                  where p.Key == project.ProjectId
                                                  select p.Value).FirstOrDefault();

                //if we have made a selection on customernr we only want those projects that has an invoice that is connected to the choosen customers
                if (es.SB_HasCustomerNrInterval)
                {
                    bool jumpOverProject = true;
                    foreach (var invoice in invoiceItems)
                    {
                        if (invoiceIdsForProject != null && invoiceIdsForProject.Contains(invoice.InvoiceId))
                        {
                            jumpOverProject = false;
                            break;
                        }
                    }

                    if (jumpOverProject)
                        continue;
                }

                #endregion

                #region Invoice

                List<XElement> invoiceElements = new List<XElement>();
                int invoiceXmlId = 1;

                foreach (var invoiceItem in invoiceItems)
                {
                    if (invoiceIdsForProject == null)
                        continue;

                    //Check that CustomerInvoice belongs to current TimeProject
                    if (!invoiceIdsForProject.Contains(invoiceItem.InvoiceId))
                        continue;

                    #region CustomerInvoice

                    #region Invoice

                    XElement invoiceElement = new XElement("Invoice",
                            new XAttribute("id", invoiceXmlId),
                            new XElement("InvoiceNr", invoiceItem.InvoiceNr),
                            new XElement("InvoiceCreated", invoiceItem.Created.HasValue ? invoiceItem.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceCreatedBy", invoiceItem.CreatedBy),
                            new XElement("InvoiceCustomerNr", invoiceItem.CustomerNr),
                            new XElement("InvoiceCustomerName", invoiceItem.CustomerName));

                    #endregion

                    #region DefaultInvoiceRow

                    XElement invoiceRowElement = new XElement("CustomerInvoiceRow",
                                new XAttribute("id", 1),
                                new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                new XElement("InvoiceRowCreatedBy", ""),
                                new XElement("InvoiceRowProductNumber", ""),
                                new XElement("InvoiceRowProductName", ""),
                                new XElement("InvoiceRowProductDescription", ""),
                                new XElement("InvoiceRowUnitName", ""));

                    invoiceElement.Add(invoiceRowElement);

                    #endregion

                    invoiceElements.Add(invoiceElement);
                    invoiceXmlId++;

                    #endregion
                }

                #endregion

                if (invoiceXmlId == 1)
                {
                    #region Default element Invoice

                    XElement defInvoiceElement = new XElement("Invoice",
                            new XAttribute("id", 1),
                            new XElement("InvoiceNr", ""),
                            new XElement("InvoiceCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                            new XElement("InvoiceCreatedBy", "")
                            );
                    XElement defInvoiceRowElement = new XElement("CustomerInvoiceRow",
                           new XAttribute("id", 1),
                           new XElement("InvoiceRowCreated", CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                           new XElement("InvoiceRowCreatedBy", ""),
                           new XElement("InvoiceRowProductNumber", ""),
                           new XElement("InvoiceRowProductName", ""),
                           new XElement("InvoiceRowProductDescription", ""),
                           new XElement("InvoiceRowUnitName", "")
                           );

                    defInvoiceElement.Add(defInvoiceRowElement);
                    invoiceElements.Add(defInvoiceElement);

                    #endregion
                }

                #region ProjectInvoiceDay

                List<XElement> invoiceTransactionElements = new List<XElement>();
                List<XElement> payrollTransactionElements = new List<XElement>();

                var timePayrollTransactionsForProject = timePayrollTransactions.Where(p => p.ProjectId == project.ProjectId);
                var timeInvoiceTransactionsForProject = timeInvoiceTransactions.Where(p => p.ProjectId == project.ProjectId);

                if (!timePayrollTransactionsForProject.Any() && !timeInvoiceTransactionsForProject.Any())
                    continue;

                #region TimePayrollTransaction
                Employee payrollEmployee = new Employee();
                foreach (var payrollTransaction in timePayrollTransactionsForProject)
                {
                    decimal empCost = 0;
                    if (payrollEmployee.EmployeeId != payrollTransaction.EmployeeId)
                    {
                        payrollEmployee = EmployeeManager.GetEmployee(payrollTransaction.EmployeeId, es.ActorCompanyId);
                    }
                    empCost = EmployeeManager.GetEmployeeCalculatedCost(payrollEmployee, payrollTransaction.Date, payrollTransaction.ProjectId);
                    int weeknr = CalendarUtility.GetWeekNr(payrollTransaction.Date);

                    XElement payrollTransactionElement = new XElement("TimePayrollTransaction",
                                             new XAttribute("id", timePayrollTransactionXmlId),
                                             new XElement("EmployeeNr", payrollTransaction.EmployeeNr),
                                             new XElement("EmployeeName", payrollTransaction.EmployeeName),
                                             new XElement("Date", payrollTransaction.Date.ToShortDateString()),
                                             new XElement("Note", payrollTransaction.InternalNote),
                                             new XElement("ExternalNote", payrollTransaction.ExternalNote),
                                             new XElement("PayrollTransactionQuantity", payrollTransaction.TimePayrollQuantity),
                                             new XElement("PayrollTransactionCreated", payrollTransaction.Created.HasValue ? payrollTransaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                             new XElement("PayrollTransactionCreatedBy", payrollTransaction.CreatedBy),
                                             new XElement("PayrollTransactionExported", 0),
                                             new XElement("PayrollTransactionProductNumber", string.Empty),
                                             new XElement("PayrollTransactionProductName", string.Empty),
                                             new XElement("PayrollTransactionProductDescription", string.Empty),
                                             new XElement("WeekNumber", weeknr),
                                             new XElement("IsoDate", payrollTransaction.Date.ToString("yyyy-MM-dd")),
                                             new XElement("PayrollTransactionTimeCodeCode", payrollTransaction.TimeCodeId),
                                             new XElement("PayrollTransactionTimeCodeName", payrollTransaction.TimeCodeName),
                                             new XElement("PayrollTransactionTimeCodeDescription", string.Empty),
                                             new XElement("PayrollTransactionTimeCodeTransactionId", payrollTransaction.TimePayrollTransactionIds),
                                             new XElement("PayrollTransactionTimeCodeTransactionQuantity", payrollTransaction.TimePayrollQuantity),
                                             new XElement("PayrollTransactionTimeCodeTransactionInvoiceQuantity", payrollTransaction.InvoiceQuantity),
                                             new XElement("PayrollTransactionTimeCodeTransactionProjectId", payrollTransaction.ProjectId),
                                             new XElement("PayrollTransactionTimeCodeTransactionProjectNumber", payrollTransaction.ProjectNr),
                                             new XElement("PayrollTransactionTimeCodeTransactionProjectName", payrollTransaction.ProjectName),
                                             new XElement("PayrollTransactionTimeCodeTransactionProjectNote", string.Empty),
                                             new XElement("PayrollTransactionTimeCodeTransactionParentProjectNumber", 0),
                                             new XElement("PayrollTransactionTimeCodeTransactionParentProjectName", string.Empty),
                                             new XElement("PayrollType", 0),
                                             new XElement("isPayed", 0),
                                             new XElement("InvoiceNr", string.IsNullOrEmpty(payrollTransaction.InvoiceNr) ? "" : payrollTransaction.InvoiceNr),
                                             new XElement("OriginType", 0),
                                             new XElement("PayrollTransactionInvoiceCustomerName", string.IsNullOrEmpty(payrollTransaction.CustomerName) ? "" : payrollTransaction.CustomerName),
                                             new XElement("PayrollTransactionInvoiceCustomerNr", payrollTransaction.CustomerId),
                                             new XElement("TimeDeviationCauseName", string.IsNullOrEmpty(payrollTransaction.TimeDeviationCauseName) ? "" : payrollTransaction.TimeDeviationCauseName),
                                             new XElement("PayrollTransactionUnitPrice", empCost),
                                             new XElement("PayrollAttestStateName", payrollTransaction.TimePayrollAttestStateName)
                                             );

                    payrollTransactionElements.Add(payrollTransactionElement);
                    timePayrollTransactionXmlId++;
                }

                #endregion

                #region TimeInvoiceTransaction

                foreach (var invoiceTransaction in timeInvoiceTransactionsForProject.Where(p => p.CustomerInvoiceId > 0))
                {
                    int weeknr = CalendarUtility.GetWeekNr(invoiceTransaction.Date);

                    XElement invoiceTransactionElement = new XElement("TimeInvoiceTransaction",
                                            new XAttribute("id", timeInvoiceTransactionXmlId),
                                            new XElement("EmployeeNr", invoiceTransaction.EmployeeNr),
                                            new XElement("EmployeeName", invoiceTransaction.EmployeeName),
                                            new XElement("Date", invoiceTransaction.Date.ToShortDateString()),
                                            new XElement("Note", invoiceTransaction.ProjectTimeBlockExternalNote),
                                            new XElement("ExternalNote", invoiceTransaction.Comment),
                                            new XElement("InvoiceTransactionQuantity", invoiceTransaction.Quantity),
                                            new XElement("InvoiceTransactionInvoiceQuantity", invoiceTransaction.InvoiceQuantity),
                                            new XElement("InvoiceTransactionCreated", invoiceTransaction.Created.HasValue ? invoiceTransaction.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                                            new XElement("InvoiceTransactionCreatedBy", invoiceTransaction.CreatedBy),
                                            new XElement("InvoiceTransactionExported", invoiceTransaction.Exported.ToInt()),
                                            new XElement("InvoiceTransactionProductNumber", invoiceTransaction.ProductNumber),
                                            new XElement("InvoiceTransactionProductName", invoiceTransaction.ProductName),
                                            new XElement("InvoiceTransactionProductDescription", invoiceTransaction.ProductDescription),
                                            new XElement("InvoiceTransactionTimeCodeCode", invoiceTransaction.TimeCode),
                                            new XElement("InvoiceTransactionTimeCodeName", invoiceTransaction.TimeCodeName),
                                            new XElement("InvoiceTransactionTimeCodeDescription", invoiceTransaction.TimeCodeDescription),
                                            new XElement("InvoiceTransactionTimeCodeTransactionId", invoiceTransaction.TimeCodeTransactionId),
                                            new XElement("InvoiceTransactionTimeCodeTransactionQuantity", invoiceTransaction.Quantity),
                                            new XElement("InvoiceTransactionTimeCodeTransactionInvoiceQuantity", invoiceTransaction.InvoiceQuantity),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectId", invoiceTransaction.ProjectId),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectNumber", invoiceTransaction.ProjectNr),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectName", invoiceTransaction.ProjectName),
                                            new XElement("InvoiceTransactionTimeCodeTransactionProjectNote", invoiceTransaction.ProjectNote),
                                            new XElement("InvoiceTransactionTimeCodeTransactionParentProjectNumber", invoiceTransaction.ParentProjectNumber),
                                            new XElement("InvoiceTransactionTimeCodeTransactionParentProjectName", invoiceTransaction.ParentProjectName),
                                            new XElement("WeekNumber", weeknr.ToString()),
                                            new XElement("IsoDate", invoiceTransaction.Date.ToString("yyyy-MM-dd")),
                                            new XElement("InvoiceNr", invoiceTransaction.InvoiceNr),
                                            new XElement("OriginType", invoiceTransaction.OriginType ?? 0),
                                            new XElement("InvoiceTransactionInvoiceCustomerName", invoiceTransaction.CustomerName),
                                            new XElement("InvoiceTransactionInvoiceCustomerNr", invoiceTransaction.CustomerNr));

                    invoiceTransactionElements.Add(invoiceTransactionElement);
                    timeInvoiceTransactionXmlId++;
                }

                #endregion

                #endregion

                #region Project

                XElement projectElement = new XElement("Project",
                               new XAttribute("id", projectXmlId),
                               new XElement("ProjectNumber", project.Number),
                               new XElement("ProjectName", project.Name),
                               new XElement("ProjectDescription", project.Description),
                               new XElement("ProjectCreated", project.Created.HasValue ? project.Created.Value.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()),
                               new XElement("ProjectCreatedBy", project.CreatedBy),
                               new XElement("ProjectState", project.State),
                               new XElement("ProjectCustomerNr", project.Customer == null ? "" : project.Customer.CustomerNr),
                               new XElement("ProjectCustomerName", project.Customer == null ? "" : project.Customer.Name));

                projectXmlId++;

                #endregion

                #region Add Invoices

                foreach (XElement invoice in invoiceElements)
                {
                    projectElement.Add(invoice);
                }

                invoiceElements.Clear();

                #endregion

                #region Add TimePayrollTransaction

                foreach (XElement transaction in payrollTransactionElements)
                {
                    projectElement.Add(transaction);
                }

                #endregion

                #region Add TimeInvoiceTransaction

                foreach (XElement transaction in invoiceTransactionElements)
                {
                    projectElement.Add(transaction);
                }

                #endregion

                #region Create Merged Transactions

                List<XElement> mergedTransactions = new List<XElement>();
                int mergedTransactionXmlId = 1;

                try
                {
                    foreach (XElement transaction in payrollTransactionElements)
                    {
                        XElement mergedTransaction = new XElement("MergedTransaction",
                                new XAttribute("id", mergedTransactionXmlId),
                                new XElement("EmployeeNr", transaction.Element("EmployeeNr").Value),
                                new XElement("EmployeeName", transaction.Element("EmployeeName").Value),
                                new XElement("Date", transaction.Element("Date").Value),
                                new XElement("Note", transaction.Element("Note").Value),
                                new XElement("ExternalNote", transaction.Element("ExternalNote").Value),
                                new XElement("WeekNumber", transaction.Element("WeekNumber").Value),
                                new XElement("IsoDate", transaction.Element("IsoDate").Value),
                                new XElement("PayrollTransactionQuantity", transaction.Element("PayrollTransactionQuantity").Value),
                                new XElement("PayrollTransactionCreated", transaction.Element("PayrollTransactionCreated").Value),
                                new XElement("PayrollTransactionCreatedBy", transaction.Element("PayrollTransactionCreatedBy").Value),
                                new XElement("PayrollTransactionExported", transaction.Element("PayrollTransactionExported").Value),
                                new XElement("PayrollTransactionProductNumber", transaction.Element("PayrollTransactionProductNumber").Value),
                                new XElement("PayrollTransactionProductName", transaction.Element("PayrollTransactionProductName").Value),
                                new XElement("PayrollTransactionProductDescription", transaction.Element("PayrollTransactionProductDescription").Value),
                                new XElement("InvoiceTransactionQuantity", 0),
                                new XElement("InvoiceTransactionInvoiceQuantity", 0),
                                new XElement("InvoiceTransactionCreated", transaction.Element("PayrollTransactionCreated").Value),
                                new XElement("InvoiceTransactionCreatedBy", string.Empty),
                                new XElement("InvoiceTransactionExported", 0),
                                new XElement("InvoiceTransactionProductNumber", string.Empty),
                                new XElement("InvoiceTransactionProductName", string.Empty),
                                new XElement("InvoiceTransactionProductDescription", string.Empty),
                                new XElement("TimeCodeCode", transaction.Element("PayrollTransactionTimeCodeCode").Value),
                                new XElement("TimeCodeName", transaction.Element("PayrollTransactionTimeCodeName").Value),
                                new XElement("TimeCodeDescription", transaction.Element("PayrollTransactionTimeCodeDescription").Value),
                                new XElement("TimeCodeTransactionId", transaction.Element("PayrollTransactionTimeCodeTransactionId").Value),
                                new XElement("TimeCodeTransactionQuantity", transaction.Element("PayrollTransactionTimeCodeTransactionQuantity").Value),
                                new XElement("TimeCodeTransactionInvoiceQuantity", transaction.Element("PayrollTransactionTimeCodeTransactionInvoiceQuantity").Value),
                                new XElement("TimeCodeTransactionProjectId", transaction.Element("PayrollTransactionTimeCodeTransactionProjectId").Value),
                                new XElement("TimeCodeTransactionProjectNumber", transaction.Element("PayrollTransactionTimeCodeTransactionProjectNumber").Value),
                                new XElement("TimeCodeTransactionProjectName", transaction.Element("PayrollTransactionTimeCodeTransactionProjectName").Value),
                                new XElement("TimeCodeTransactionProjectNote", transaction.Element("PayrollTransactionTimeCodeTransactionProjectNote").Value),
                                new XElement("TimeCodeTransactionParentProjectNumber", transaction.Element("PayrollTransactionTimeCodeTransactionParentProjectNumber").Value),
                                new XElement("TimeCodeTransactionParentProjectName", transaction.Element("PayrollTransactionTimeCodeTransactionParentProjectName").Value),
                                new XElement("PayrollType", transaction.Element("PayrollType").Value),
                                new XElement("isPayed", transaction.Element("isPayed").Value),
                                new XElement("InvoiceNr", transaction.Element("InvoiceNr").Value),
                                new XElement("OriginType", transaction.Element("OriginType").Value),
                                new XElement("PayrollTransactionInvoiceCustomerName", transaction.Element("PayrollTransactionInvoiceCustomerName").Value),
                                new XElement("PayrollTransactionInvoiceCustomerNr", transaction.Element("PayrollTransactionInvoiceCustomerNr").Value),
                                new XElement("TimeDeviationCauseName", transaction.Element("TimeDeviationCauseName").Value),
                                new XElement("PayrollTransactionUnitPrice", 0),
                                new XElement("PayrollAttestStateName", string.Empty)
                                );

                        mergedTransactions.Add(mergedTransaction);

                        mergedTransactionXmlId++;
                    }
                }
                catch (Exception ex)
                {
                    LogError(ex, log);
                }

                payrollTransactionElements.Clear();

                try
                {
                    foreach (XElement transaction in invoiceTransactionElements)
                    {
                        XElement mergedTransaction = new XElement("MergedTransaction",
                                new XAttribute("id", mergedTransactionXmlId),
                                new XElement("EmployeeNr", transaction.Element("EmployeeNr").Value),
                                new XElement("EmployeeName", transaction.Element("EmployeeName").Value),
                                new XElement("Date", transaction.Element("Date").Value),
                                new XElement("Note", transaction.Element("Note").Value),
                                new XElement("ExternalNote", transaction.Element("ExternalNote").Value),
                                new XElement("WeekNumber", transaction.Element("WeekNumber").Value),
                                new XElement("IsoDate", transaction.Element("IsoDate").Value),
                                new XElement("PayrollTransactionQuantity", 0),
                                new XElement("PayrollTransactionCreated", 0),
                                new XElement("PayrollTransactionCreatedBy", string.Empty),
                                new XElement("PayrollTransactionExported", 0),
                                new XElement("PayrollTransactionProductNumber", string.Empty),
                                new XElement("PayrollTransactionProductName", string.Empty),
                                new XElement("PayrollTransactionProductDescription", string.Empty),
                                new XElement("InvoiceTransactionQuantity", transaction.Element("InvoiceTransactionQuantity").Value),
                                new XElement("InvoiceTransactionInvoiceQuantity", transaction.Element("InvoiceTransactionInvoiceQuantity").Value),
                                new XElement("InvoiceTransactionCreated", transaction.Element("InvoiceTransactionCreated").Value),
                                new XElement("InvoiceTransactionCreatedBy", transaction.Element("InvoiceTransactionCreatedBy").Value),
                                new XElement("InvoiceTransactionExported", transaction.Element("InvoiceTransactionExported").Value),
                                new XElement("InvoiceTransactionProductNumber", transaction.Element("InvoiceTransactionProductNumber").Value),
                                new XElement("InvoiceTransactionProductName", transaction.Element("InvoiceTransactionProductName").Value),
                                new XElement("InvoiceTransactionProductDescription", transaction.Element("InvoiceTransactionProductDescription").Value),
                                new XElement("TimeCodeCode", transaction.Element("InvoiceTransactionTimeCodeCode").Value),
                                new XElement("TimeCodeName", transaction.Element("InvoiceTransactionTimeCodeName").Value),
                                new XElement("TimeCodeDescription", transaction.Element("InvoiceTransactionTimeCodeDescription").Value),
                                new XElement("TimeCodeTransactionId", transaction.Element("InvoiceTransactionTimeCodeTransactionId").Value),
                                new XElement("TimeCodeTransactionQuantity", transaction.Element("InvoiceTransactionTimeCodeTransactionQuantity").Value),
                                new XElement("TimeCodeTransactionInvoiceQuantity", transaction.Element("InvoiceTransactionTimeCodeTransactionInvoiceQuantity").Value),
                                new XElement("TimeCodeTransactionProjectId", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectId").Value),
                                new XElement("TimeCodeTransactionProjectNumber", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectNumber").Value),
                                new XElement("TimeCodeTransactionProjectName", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectName").Value),
                                new XElement("TimeCodeTransactionProjectNote", transaction.Element("InvoiceTransactionTimeCodeTransactionProjectNote").Value),
                                new XElement("TimeCodeTransactionParentProjectNumber", transaction.Element("InvoiceTransactionTimeCodeTransactionParentProjectNumber").Value),
                                new XElement("TimeCodeTransactionParentProjectName", transaction.Element("InvoiceTransactionTimeCodeTransactionParentProjectName").Value),
                                new XElement("PayrollType", 0),
                                new XElement("isPayed", 0),
                                new XElement("InvoiceNr", transaction.Element("InvoiceNr").Value),
                                new XElement("OriginType", transaction.Element("OriginType").Value),
                                new XElement("PayrollTransactionInvoiceCustomerName", transaction.Element("InvoiceTransactionInvoiceCustomerName").Value),
                                new XElement("PayrollTransactionInvoiceCustomerNr", transaction.Element("InvoiceTransactionInvoiceCustomerNr").Value),
                                new XElement("TimeDeviationCauseName", string.Empty),
                                new XElement("PayrollTransactionUnitPrice", 0),
                                new XElement("PayrollAttestStateName", string.Empty)
                                );

                        mergedTransactions.Add(mergedTransaction);

                        mergedTransactionXmlId++;
                    }
                }
                catch (Exception ex)
                {
                    LogError(ex, log);
                }

                invoiceTransactionElements.Clear();

                #endregion

                projectElement.Add(mergedTransactions);

                mergedTransactions.Clear();

                projectElements.Add(projectElement);
            }

            #endregion

            return projectElements;
        }

        private XDocument CreateProjectTransactionsData(EvaluatedSelection es)
        {
            if (es.ReportTemplateType != SoeReportTemplateType.ProjectTransactionsReport)
                return null;

            var projectCentral = new ProjectCentralManager(parameterObject);

            var accountDims = AccountManager.GetAccountDimsByCompany(es.ActorCompanyId);

            #region Prereq

            if (es == null)
                return null;

            bool overheadCostAsFixedAmount = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ProjectOverheadCostAsFixedAmount, 0, es.ActorCompanyId, 0);
            bool overheadCostAsAmountPerHour = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.ProjectOverheadCostAsAmountPerHour, 0, es.ActorCompanyId, 0);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId, true);
            List<AccountDimDTO> accountDimInternalsDTOs = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId).ToDTOs();
            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "ProjectTransactionsReport");

            //ChecklistsReport
            XElement projectTransactionsReportElement = new XElement("ProjectTransactionsReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateProjectTransactionsReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(new XElement("IncludeChildProjectLabel", GetReportText(9239, "Inkludera underprojekt")));
            reportHeaderLabelsElement.Add(new XElement("ExcludeInternalOrdersLabel", GetReportText(9240, "Exkludera internordrar")));
            projectTransactionsReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            var minDate = DateTime.MinValue;
            var maxDate = DateTime.MaxValue;
            if (!es.SP_PayrollTransactionDateFrom.HasValue && !es.SP_PayrollTransactionDateTo.HasValue)
                maxDate = DateTime.MaxValue;
            else if (!es.SP_PayrollTransactionDateFrom.HasValue)
            {
                es.SP_PayrollTransactionDateFrom = minDate;
            }
            else if (!es.SP_PayrollTransactionDateTo.HasValue)
            {
                es.SP_PayrollTransactionDateTo = maxDate;
            }
            if (!es.SP_InvoiceTransactionDateFrom.HasValue && !es.SP_InvoiceTransactionDateTo.HasValue)
                maxDate = DateTime.MaxValue;
            else if (!es.SP_InvoiceTransactionDateFrom.HasValue)
            {
                es.SP_InvoiceTransactionDateFrom = minDate;
            }
            else if (!es.SP_InvoiceTransactionDateTo.HasValue)
            {
                es.SP_InvoiceTransactionDateTo = maxDate;
            }

            XElement reportHeaderElement = CreateProjectTransactionsReportHeaderElement(es);
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));

            int maxNumberOfdims = 6;
            int dimCounter = 1;

            foreach (var accountDim in accountDims.OrderBy(d => d.AccountDimNr).Take(maxNumberOfdims))
            {
                reportHeaderElement.Add(new XElement("AccountDimNr" + dimCounter + "Name", accountDim.Name));
                reportHeaderElement.Add(new XElement("AccountDimNr" + dimCounter + "ShortName", accountDim.ShortName));
                reportHeaderElement.Add(new XElement("AccountDimNr" + dimCounter + "SieDimNr", accountDim.SysSieDimNr));
                dimCounter++;
            }

            //add tags to max dims....
            while (dimCounter <= maxNumberOfdims)
            {
                reportHeaderElement.Add(new XElement("AccountDimNr" + dimCounter + "Name", string.Empty));
                reportHeaderElement.Add(new XElement("AccountDimNr" + dimCounter + "ShortName", string.Empty));
                reportHeaderElement.Add(new XElement("AccountDimNr" + dimCounter + "SieDimNr", string.Empty));
                dimCounter++;
            }

            projectTransactionsReportElement.Add(reportHeaderElement);


            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateProjectTransactionsReportPageHeaderLabelsElement(pageHeaderLabelsElement);
            projectTransactionsReportElement.Add(pageHeaderLabelsElement);

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                entities.TimeCodeTransactionProjectView.NoTracking();

                #region Prereq

                //Get AccountDims
                AccountDim accountDimStds = AccountManager.GetAccountDimStd(es.ActorCompanyId);

                //Accounts
                List<AccountStd> accountStdsInInterval = new List<AccountStd>();
                List<AccountInternal> accountInternalsInInterval = new List<AccountInternal>();

                bool validSelection = AccountManager.GetAccountsInInterval(entities, es, accountDimStds, false, ref accountStdsInInterval, ref accountInternalsInInterval);

                #endregion

                #region ProjectTransactionReport

                #region Projects

                string projectElementName = "Project";
                string timeCodeTransactionElementName = "TimeCodeTransaction";
                string billingRowElementName = "BillingRow";
                string externalTransactionElementName = "ExternalTransaction";
                //Settings
                bool useProjectTimeBlock = SettingManager.GetBoolSetting(SettingMainType.Company, (int)CompanySettingType.UseProjectTimeBlocks, this.UserId, this.ActorCompanyId, 0, false);
                int fixedPriceProductId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.ProductFlatPrice, 0, es.ActorCompanyId, 0);
                int fixedPriceKeepPricesProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductFlatPriceKeepPrices, 0, es.ActorCompanyId, 0);
                List<CompanyCategoryRecord> categoryRecords = CategoryManager.GetCompanyCategoryRecords(entities, SoeCategoryType.Project, SoeCategoryRecordEntity.Project, es.SP_ProjectIds, es.ActorCompanyId);
                int? attestStateTransferredOrderToInvoiceId = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingStatusTransferredOrderToInvoice, 0, es.ActorCompanyId, 0);
                int productGuaranteeId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGuarantee, 0, es.ActorCompanyId, 0);

                var allSelectedProjects = projectCentral.GetProjectsForProjectCentralStatus(entities, es.SP_ProjectIds, es.ActorCompanyId, true).ToLookup(p => p.ProjectId);
                int projectXmlId = 1;

                var bm = new BudgetManager(parameterObject);

                foreach (int projId in es.SP_ProjectIds)
                {
                    List<int> projects = new List<int>();

                    #region Child projects

                    bool isFirst = true;

                    var allProjects = allSelectedProjects[projId].ToList();

                    Project proj = allProjects.FirstOrDefault();

                    if (es.SA_HasAccountInterval && accountInternalsInInterval.Any())
                    {
                        var accountInternalIds = accountInternalsInInterval.Where(a => a.Account.AccountDim.AccountDimNr == 2).Select(a => a.AccountId).ToList();
                        if (proj.DefaultDim2AccountId.HasValue && proj.DefaultDim2AccountId.Value >= 0 || accountInternalIds.Any())
                        {
                            if (proj.DefaultDim2AccountId.HasValue)
                            {

                                var projectaccountInternalId = proj.DefaultDim2AccountId.Value;
                                if (accountInternalIds.Any() && (!accountInternalIds.Contains(projectaccountInternalId)))
                                {
                                    continue;
                                }
                            }
                            else continue;
                        }
                        accountInternalIds = accountInternalsInInterval.Where(a => a.Account.AccountDim.AccountDimNr == 3).Select(a => a.AccountId).ToList();
                        if (proj.DefaultDim3AccountId.HasValue && proj.DefaultDim3AccountId.Value >= 0 || accountInternalIds.Any())
                        {
                            if (proj.DefaultDim3AccountId.HasValue)
                            {
                                var projectaccountInternalId = proj.DefaultDim3AccountId.Value;
                                if (accountInternalIds.Any() && (!accountInternalIds.Contains(projectaccountInternalId)))
                                {
                                    continue;
                                }
                            }
                            else continue;
                        }
                        accountInternalIds = accountInternalsInInterval.Where(a => a.Account.AccountDim.AccountDimNr == 4).Select(a => a.AccountId).ToList();
                        if (proj.DefaultDim4AccountId.HasValue && proj.DefaultDim4AccountId.Value >= 0 || accountInternalIds.Any())
                        {
                            if (proj.DefaultDim4AccountId.HasValue)
                            {
                                var projectaccountInternalId = proj.DefaultDim4AccountId.Value;
                                if (accountInternalIds.Any() && (!accountInternalIds.Contains(projectaccountInternalId)))
                                {
                                    continue;
                                }
                            }
                            else continue;
                        }
                        accountInternalIds = accountInternalsInInterval.Where(a => a.Account.AccountDim.AccountDimNr == 5).Select(a => a.AccountId).ToList();
                        if (proj.DefaultDim5AccountId.HasValue && proj.DefaultDim5AccountId.Value >= 0 || accountInternalIds.Any())
                        {
                            if (proj.DefaultDim5AccountId.HasValue)
                            {
                                var projectaccountInternalId = proj.DefaultDim5AccountId.Value;
                                if (accountInternalIds.Any() && (!accountInternalIds.Contains(projectaccountInternalId)))
                                {
                                    continue;
                                }
                            }
                            else continue;
                        }
                        accountInternalIds = accountInternalsInInterval.Where(a => a.Account.AccountDim.AccountDimNr == 6).Select(a => a.AccountId).ToList();
                        if (proj.DefaultDim6AccountId.HasValue && proj.DefaultDim6AccountId.Value >= 0 || accountInternalIds.Any())
                        {
                            if (proj.DefaultDim6AccountId.HasValue)
                            {
                                var projectaccountInternalId = proj.DefaultDim6AccountId.Value;
                                if (accountInternalIds.Any() && (!accountInternalIds.Contains(projectaccountInternalId)))
                                {
                                    continue;
                                }
                            }
                            else continue;
                        }
                    }

                    if (proj != null)
                    {
                        if (es.SP_IncludeChildProjects)
                        {
                            List<Project> projectsToSearch = new List<Project>();
                            projectsToSearch.Add(proj);

                            // Loop until no further child projects are found
                            while (projectsToSearch.Count > 0)
                            {
                                Project currentProject = projectsToSearch.FirstOrDefault();

                                List<Project> childProjects = projectCentral.GetProjectsForProjectCentralStatus(entities, currentProject.ChildProjects.Select(p => p.ProjectId).ToList(), es.ActorCompanyId);

                                if (isFirst)
                                    isFirst = false;
                                else
                                    allProjects.Add(currentProject);

                                // Add current to all projects list
                                projects.Add(projectsToSearch.FirstOrDefault().ProjectId);

                                // Remove handled project from search list
                                projectsToSearch.Remove(currentProject);

                                // Add all found child projects to search list
                                if (childProjects.Count != 0)
                                    projectsToSearch.AddRange(childProjects);
                            }

                        }
                        else
                        {
                            projects.Add(proj.ProjectId);
                        }
                    }

                    projects.Reverse();

                    #endregion

                    foreach (int projectId in projects)
                    {
                        #region Project                        

                        bool budgetAdded = false;

                        List<TimeCodeTransactionProjectView> timeCodeTransactionItemsForProject = entities.TimeCodeTransactionProjectView.Where(i => i.ProjectId == projectId).ToList();
                        var group = timeCodeTransactionItemsForProject.GroupBy(i => i.TimeCodeTransactionId).FirstOrDefault();
                        var defProject = proj?.ProjectId == projectId ? proj : ProjectManager.GetProject(projectId, false);

                        defProject.Categories = string.Join(", ", categoryRecords.GetCategoryRecords(projectId).Select(c => c.Category.Name));

                        Account accountDim1 = defProject.DefaultDim2AccountId.HasValue ? AccountManager.GetAccount(es.ActorCompanyId, defProject.DefaultDim2AccountId.Value) : null;
                        Account accountDim2 = defProject.DefaultDim3AccountId.HasValue ? AccountManager.GetAccount(es.ActorCompanyId, defProject.DefaultDim3AccountId.Value) : null;
                        Account accountDim3 = defProject.DefaultDim4AccountId.HasValue ? AccountManager.GetAccount(es.ActorCompanyId, defProject.DefaultDim4AccountId.Value) : null;
                        Account accountDim4 = defProject.DefaultDim5AccountId.HasValue ? AccountManager.GetAccount(es.ActorCompanyId, defProject.DefaultDim5AccountId.Value) : null;
                        Account accountDim5 = defProject.DefaultDim6AccountId.HasValue ? AccountManager.GetAccount(es.ActorCompanyId, defProject.DefaultDim6AccountId.Value) : null;

                        TimeCodeTransactionProjectView projectItem = null;

                        #region Project Budget

                        BudgetHead budgetHead = bm.GetBudgetHeadIncludingRowsForProject(entities, projectId);

                        if (budgetHead == null)
                            budgetHead = new BudgetHead();

                        #endregion
                        XElement projectElement;

                        if (group == null || !group.Any())
                        {
                            projectElement = new XElement(projectElementName,
                            new XAttribute("id", projectXmlId),
                            new XElement(projectElementName + "Nr", defProject.Number),
                            new XElement(projectElementName + "Name", defProject.Name),
                            new XElement(projectElementName + "Description", defProject.Description),
                            new XElement(projectElementName + "Type", defProject.Type),
                            new XElement(projectElementName + "Status", defProject.Status),
                            new XElement(projectElementName + "StatusName", defProject.StatusName),
                            new XElement(projectElementName + "StartDate", defProject.StartDate ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement(projectElementName + "StopDate", defProject.StopDate ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement(projectElementName + "Created", defProject.Created),
                            new XElement(projectElementName + "CreatedBy", defProject.CreatedBy),
                            new XElement(projectElementName + "CustomerNr", defProject.Customer),
                            new XElement(projectElementName + "CustomerName", defProject.Customer),
                            new XElement(projectElementName + "AccountInternalNr1", accountDim1?.AccountNr ?? string.Empty),
                            new XElement(projectElementName + "AccountInternalNr2", accountDim2?.AccountNr ?? string.Empty),
                            new XElement(projectElementName + "AccountInternalNr3", accountDim3?.AccountNr ?? string.Empty),
                            new XElement(projectElementName + "AccountInternalNr4", accountDim4?.AccountNr ?? string.Empty),
                            new XElement(projectElementName + "AccountInternalNr5", accountDim5?.AccountNr ?? string.Empty),
                            new XElement(projectElementName + "Category", defProject.Categories)
                            );
                        }
                        else
                        {
                            projectItem = group.FirstOrDefault();
                            projectElement = new XElement(projectElementName,
                            new XAttribute("id", projectXmlId),
                            new XElement(projectElementName + "Nr", projectItem.ProjectNumber),
                            new XElement(projectElementName + "Name", projectItem.ProjectName),
                            new XElement(projectElementName + "Description", projectItem.ProjectDescription),
                            new XElement(projectElementName + "Type", projectItem.ProjectType),
                            new XElement(projectElementName + "Status", projectItem.ProjectStatus),
                            new XElement(projectElementName + "StatusName", GetText(projectItem.ProjectStatus, (int)TermGroup.ProjectStatus)),
                            new XElement(projectElementName + "StartDate", projectItem.ProjectStartDate ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement(projectElementName + "StopDate", projectItem.ProjectStopDate ?? CalendarUtility.DATETIME_DEFAULT),
                            new XElement(projectElementName + "Created", projectItem.ProjectCreated),
                            new XElement(projectElementName + "CreatedBy", projectItem.ProjectCreatedBy),
                            new XElement(projectElementName + "CustomerNr", projectItem.CustomerNr),
                            new XElement(projectElementName + "CustomerName", projectItem.CustomerName),
                            new XElement(projectElementName + "AccountInternalNr1", accountDim1?.AccountNr ?? String.Empty),
                            new XElement(projectElementName + "AccountInternalNr2", accountDim2?.AccountNr ?? String.Empty),
                            new XElement(projectElementName + "AccountInternalNr3", accountDim3?.AccountNr ?? String.Empty),
                            new XElement(projectElementName + "AccountInternalNr4", accountDim4?.AccountNr ?? String.Empty),
                            new XElement(projectElementName + "AccountInternalNr5", accountDim5?.AccountNr ?? String.Empty),
                            new XElement(projectElementName + "Category", defProject.Categories)
                            );
                        }

                        int timeCodeTransactionXmlId = 1;

                        BudgetRow budgetRow = null;

                        decimal projectBillableMinutesPreliminaryInvoicedSum = 0;

                        decimal projectBillableMinutesInvoicedSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.BillableMinutesInvoicedIB);
                        if (budgetRow != null)
                            projectBillableMinutesInvoicedSumIB = budgetRow.TotalAmount;

                        decimal projectPersonellIncomeInvoicedSum = 0;
                        decimal projectPersonellIncomePreliminaryInvoicedSum = 0;
                        decimal projectPersonellIncomeNotInvoicedSum = 0;

                        decimal projectPersonellIncomeInvoicedSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.IncomePersonellTotalIB);
                        if (budgetRow != null)
                            projectPersonellIncomeInvoicedSumIB = budgetRow.TotalAmount;

                        decimal projectPersonellIncomeInvoicedSumBudget = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.IncomePersonellTotal);
                        if (budgetRow != null)
                            projectPersonellIncomeInvoicedSumBudget = budgetRow.TotalAmount;

                        decimal projectMaterialIncomeInvoicedSum = 0;
                        decimal projectMaterialIncomePreliminaryInvoicedSum = 0;
                        decimal projectMaterialIncomeNotInvoicedSum = 0;

                        decimal projectMateriallIncomeInvoicedSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.IncomeMaterialTotalIB);
                        if (budgetRow != null)
                            projectMateriallIncomeInvoicedSumIB = budgetRow.TotalAmount;

                        decimal projectMateriallIncomeInvoicedSumBudget = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.IncomeMaterialTotal);
                        if (budgetRow != null)
                            projectMateriallIncomeInvoicedSumBudget = budgetRow.TotalAmount;

                        decimal projectPersonellCostSum = 0;

                        decimal projectPersonellCostSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.CostPersonellIB);
                        if (budgetRow != null)
                            projectPersonellCostSumIB = budgetRow.TotalAmount;

                        decimal projectBillableMinutesInvoicedSumBudget = 0;
                        decimal projectPersonellCostSumBudget = 0;
                        var budgetRows = budgetHead.BudgetRow.Where(r => r.Type == (int)ProjectCentralBudgetRowType.CostPersonell);
                        foreach (var row in budgetRows)
                        {
                            if (row != null)
                            {
                                projectPersonellCostSumBudget += row.TotalAmount;
                                projectBillableMinutesInvoicedSumBudget += row.TotalQuantity;
                            }
                        }

                        decimal projectMaterialCostSum = 0;
                        decimal projectMaterialCostSumSupplInv = 0;

                        decimal projectMaterialCostSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.CostMaterialIB);
                        if (budgetRow != null)
                            projectMaterialCostSumIB = budgetRow.TotalAmount;

                        decimal projectMaterialCostSumBudget = 0;
                        budgetRows = budgetHead.BudgetRow.Where(r => r.Type == (int)ProjectCentralBudgetRowType.CostMaterial);
                        foreach (var row in budgetRows)
                        {
                            if (row != null)
                                projectMaterialCostSumBudget += row.TotalAmount;
                        }

                        decimal projectExpenceCostSum = 0;

                        decimal projectExpenceCostSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.CostExpenseIB);
                        if (budgetRow != null)
                            projectExpenceCostSumIB = budgetRow.TotalAmount;

                        decimal projectExpenceCostSumBudget = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.CostExpense);
                        if (budgetRow != null)
                            projectExpenceCostSumBudget = budgetRow.TotalAmount;

                        decimal projectOverheadCostSumIB = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.OverheadCostIB);
                        if (budgetRow != null)
                            projectOverheadCostSumIB = budgetRow.TotalAmount;

                        decimal projectOverheadCostPerHour = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.OverheadCostPerHour);
                        if (budgetRow != null)
                            projectOverheadCostPerHour = budgetRow.TotalAmount;

                        decimal projectOverheadCostSumBudget = 0;
                        budgetRow = budgetHead.BudgetRow.FirstOrDefault(r => r.Type == (int)ProjectCentralBudgetRowType.OverheadCost);
                        if (budgetRow != null)
                            projectOverheadCostSumBudget = budgetRow.TotalAmount;

                        decimal projectOverheadCostSum = 0;

                        decimal projectFixedPrice = 0;
                        decimal projectFixedPriceKeepPrices = 0;
                        decimal projectOpenLiftAmount = 0;
                        decimal projectInvoicedLiftAmount = 0;
                        decimal projectGuaranteeAmount = 0;
                        decimal projectPersonellWorkHours = 0;
                        decimal projectPersonellNondebitHours = 0;

                        List<int> processedBillingItems = new List<int>();
                        List<XElement> timeCodeTransactionElements = new List<XElement>();

                        #region Default Transaction element
                        if (timeCodeTransactionXmlId == 1)
                        {
                            XElement timeCodeTransactionElement = new XElement(timeCodeTransactionElementName);

                            timeCodeTransactionElement.Add(new XElement(timeCodeTransactionElementName + "CustomerInvoiceRowId", 0));

                            timeCodeTransactionElement.Add(new XElement(billingRowElementName, String.Empty));

                            timeCodeTransactionElement.Add(new XElement(externalTransactionElementName, String.Empty));

                            timeCodeTransactionElements.Add(timeCodeTransactionElement);

                        }
                        #endregion

                        var projdtos = projectCentral.GetProjectCentralStatus_v4(es.ActorCompanyId, projectId, es.SP_InvoiceTransactionDateFrom, es.SP_InvoiceTransactionDateTo, false, false, false).Select(p => new { p.Type, p.AssociatedId, p.Value, p.Value2, p.OriginType }).ToList();

                        var fixedPriceDtos = projdtos.Where(p => p.Type == ProjectCentralBudgetRowType.FixedPriceTotal).ToList();
                        if (fixedPriceDtos.Count > 0)
                        {
                            // All items connected to orders with fixed price and items of supplier invoice type
                            var fixedDtos = projdtos.Where(p => p.AssociatedId == 0 || fixedPriceDtos.Select(d => d.AssociatedId).Contains(p.AssociatedId) || (p.Type == ProjectCentralBudgetRowType.CostMaterial && p.OriginType == SoeOriginType.SupplierInvoice)).ToList();

                            projectPersonellCostSum = 0;
                            projectPersonellIncomeInvoicedSum = 0;
                            projectPersonellIncomeNotInvoicedSum = 0;
                            projectMaterialCostSum = 0;
                            projectMaterialCostSumSupplInv = 0;
                            projectMaterialIncomeInvoicedSum = 0;
                            projectMaterialIncomeNotInvoicedSum = 0;
                            projectPersonellWorkHours = 0;
                            projectPersonellNondebitHours = 0;
                            projectExpenceCostSum = 0;
                            projectOverheadCostSum = 0;

                            foreach (var projdto in fixedDtos)
                            {
                                //  if (projdto.Name == "Debiterbara timmar, ej fakturerat" || projdto.GroupRowTypeName == "Debiterbara timmar, ej fakturerat")
                                if (projdto.Type == ProjectCentralBudgetRowType.BillableMinutesNotInvoiced)
                                {
                                    projectPersonellNondebitHours += projdto.Value;
                                }
                                //   if (projdto.Name == "Intäkter fakturerat" || projdto.GroupRowTypeName == "Intäkter fakturerat")
                                if (projdto.Type == ProjectCentralBudgetRowType.IncomeInvoiced)
                                {
                                    projectMaterialIncomeInvoicedSum += projdto.Value;
                                    //    projectPersonellIncomeInvoicedSum += projdto.Value2;
                                }

                                //   if (projdto.Name == "Intäkter ofakturerat" || projdto.GroupRowTypeName == "Intäkter ofakturerat")
                                if (projdto.Type == ProjectCentralBudgetRowType.IncomeNotInvoiced)
                                {
                                    projectMaterialIncomeNotInvoicedSum += projdto.Value;
                                }
                                //   if (projdto.Name == "Kostnader material" || projdto.GroupRowTypeName == "Kostnader material")
                                if (projdto.Type == ProjectCentralBudgetRowType.CostMaterial)
                                {
                                    projectMaterialCostSum += projdto.Value;
                                }
                                //     if ((projdto.Name == "Kostnader material" || projdto.GroupRowTypeName == "Kostnader material") && projdto.OriginType == SoeOriginType.SupplierInvoice)
                                if ((projdto.Type == ProjectCentralBudgetRowType.CostMaterial) && projdto.OriginType == SoeOriginType.SupplierInvoice)
                                {
                                    projectMaterialCostSumSupplInv += projdto.Value2;
                                }
                                //   if (projdto.Name == "Kostnader personal" || projdto.GroupRowTypeName == "Kostnader personal")
                                if (projdto.Type == ProjectCentralBudgetRowType.CostPersonell)
                                {
                                    projectPersonellCostSum += projdto.Value;
                                    projectPersonellWorkHours += projdto.Value2 * 60;
                                }
                                //   if (projdto.Name == "FixedPriceTotal" || projdto.GroupRowTypeName == "FixedPriceTotal")
                                if (projdto.Type == ProjectCentralBudgetRowType.FixedPriceTotal)
                                {
                                    projectFixedPrice += projdto.Value;
                                }
                                //   if (projdto.Name == "CostExpense" || projdto.GroupRowTypeName == "CostExpense")
                                if (projdto.Type == ProjectCentralBudgetRowType.CostExpense)
                                {
                                    projectExpenceCostSum += projdto.Value;
                                }
                                if (projdto.Type == ProjectCentralBudgetRowType.OverheadCost)
                                {
                                    projectOverheadCostSum += projdto.Value;
                                }

                            }

                            projectElement.Add(new XElement(projectElementName + "BillableMinutesInvoicedSum", projectPersonellWorkHours),
                            new XElement(projectElementName + "BillableMinutesPreliminaryInvoicedSum", projectBillableMinutesPreliminaryInvoicedSum),
                            new XElement(projectElementName + "BillableMinutesNotInvoicedSum", projectPersonellNondebitHours),
                            new XElement(projectElementName + "BillableMinutesInvoicedSumBudget", projectBillableMinutesInvoicedSumBudget),
                            new XElement(projectElementName + "PersonellIncomeInvoicedSum", projectPersonellIncomeInvoicedSum),
                            new XElement(projectElementName + "PersonellIncomePreliminaryInvoicedSum", projectPersonellIncomePreliminaryInvoicedSum),
                            new XElement(projectElementName + "PersonellIncomeNotInvoicedSum", projectPersonellIncomeNotInvoicedSum),
                            new XElement(projectElementName + "PersonellIncomeInvoicedSumBudget", projectPersonellIncomeInvoicedSumBudget),
                            new XElement(projectElementName + "MaterialIncomeInvoicedSum", projectMaterialIncomeInvoicedSum),
                            new XElement(projectElementName + "MaterialIncomePreliminaryInvoicedSum", projectMaterialIncomePreliminaryInvoicedSum),
                            new XElement(projectElementName + "MaterialIncomeNotInvoicedSum", projectMaterialIncomeNotInvoicedSum),
                            new XElement(projectElementName + "MateriallIncomeInvoicedSumBudget", projectMateriallIncomeInvoicedSumBudget),
                            new XElement(projectElementName + "PersonellCostSum", projectPersonellCostSum),
                            new XElement(projectElementName + "PersonellCostSumBudget", projectPersonellCostSumBudget),
                            new XElement(projectElementName + "MaterialCostSum", projectMaterialCostSum),
                            new XElement(projectElementName + "MaterialCostSumSupplInv", projectMaterialCostSumSupplInv),
                            new XElement(projectElementName + "MaterialCostSumBudget", projectMaterialCostSumBudget),
                            new XElement(projectElementName + "ExpenceCostSum", projectExpenceCostSum),
                            new XElement(projectElementName + "ExpenceCostSumBudget", projectExpenceCostSumBudget),
                            new XElement(projectElementName + "OverheadCostSum", projectOverheadCostSum),
                            new XElement(projectElementName + "OverheadCostSumBudget", projectOverheadCostSumBudget));

                            #region Parent project

                            if (group != null && projectItem.ParentProjectId != null)
                            {
                                Project project = allProjects.FirstOrDefault(p => p.ProjectId == projectItem.ParentProjectId);

                                if (project != null)
                                {
                                    projectElement.Add(new XElement(projectElementName + "ParentProjectId", projectItem.ParentProjectId),
                                    new XElement(projectElementName + "ParentProjectNumber", project.Number));
                                }
                                else
                                {
                                    projectElement.Add(new XElement(projectElementName + "ParentProjectId", 0),
                                    new XElement(projectElementName + "ParentProjectNumber", String.Empty));
                                }
                            }
                            else
                            {
                                projectElement.Add(new XElement(projectElementName + "ParentProjectId", 0),
                                new XElement(projectElementName + "ParentProjectNumber", String.Empty));
                            }

                            #endregion

                            #region Fixed and lift amounts

                            bool fixedPrice = false;
                            bool fixedPriceKeepPrices = false;
                            if (projectFixedPrice != 0)
                            {
                                fixedPrice = true;
                            }
                            else if (projectFixedPriceKeepPrices != 0)
                            {
                                projectFixedPrice = projectFixedPrice + projectFixedPriceKeepPrices; //This for now before the crystal reports is updated
                                fixedPriceKeepPrices = true;
                            }
                            else // Fallback for when amount is zero
                            {
                                fixedPrice = true;
                            }

                            projectElement.Add(
                                new XElement(projectElementName + "IsFixedPriceType1", fixedPrice.ToInt()),
                                new XElement(projectElementName + "IsFixedPriceType2", fixedPriceKeepPrices.ToInt()),
                                //new XElement(projectElementName + "FixedPriceKeepPrices", projectFixedPriceKeepPrices < 0 ? Decimal.Negate(projectFixedPriceKeepPrices) : projectFixedPriceKeepPrices),
                                new XElement(projectElementName + "FixedPrice", projectFixedPrice < 0 ? Decimal.Negate(projectFixedPrice) : projectFixedPrice),
                                new XElement(projectElementName + "OpenLiftAmount", projectOpenLiftAmount < 0 ? Decimal.Negate(projectOpenLiftAmount) : projectOpenLiftAmount),
                                new XElement(projectElementName + "InvoicedLiftAmount", projectInvoicedLiftAmount < 0 ? Decimal.Negate(projectInvoicedLiftAmount) : projectInvoicedLiftAmount),
                                new XElement(projectElementName + "RetainedGuaranteeAmount", projectGuaranteeAmount < 0 ? Decimal.Negate(projectGuaranteeAmount) : projectGuaranteeAmount));

                            #endregion

                            projdtos = projdtos.Where(p => !fixedDtos.Select(d => d.AssociatedId).Contains(p.AssociatedId)).ToList();

                            if (projdtos.Count > 0)
                            {
                                budgetAdded = true;

                                projectFixedPrice = 0;
                                projectFixedPriceKeepPrices = 0;
                                projectOpenLiftAmount = 0;
                                projectInvoicedLiftAmount = 0;
                                projectGuaranteeAmount = 0;
                                projectPersonellWorkHours = 0;
                                projectPersonellNondebitHours = 0;
                                projectExpenceCostSum = 0;
                                projectOverheadCostSum = 0;

                                #region IB
                                projectElement.Add(
                                    new XElement(projectElementName + "BillableMinutesInvoicedSumIB", projectBillableMinutesInvoicedSumIB),
                                    new XElement(projectElementName + "PersonellIncomeInvoicedSumIB", projectPersonellIncomeInvoicedSumIB),
                                    new XElement(projectElementName + "MateriallIncomeInvoicedSumIB", projectMateriallIncomeInvoicedSumIB),
                                    new XElement(projectElementName + "PersonellCostSumIB", projectPersonellCostSumIB),
                                    new XElement(projectElementName + "MaterialCostSumIB", projectMaterialCostSumIB),
                                    new XElement(projectElementName + "ExpenceCostSumIB", projectExpenceCostSumIB),
                                    new XElement(projectElementName + "OverheadCostSumIB", projectOverheadCostSumIB));

                                #endregion

                                projectElement.Add(timeCodeTransactionElements);

                                if (timeCodeTransactionXmlId > 0)
                                {
                                    projectTransactionsReportElement.Add(projectElement);
                                    projectXmlId++;
                                }

                                if (group == null || !group.Any())
                                {
                                    projectElement = new XElement(projectElementName,
                                    new XAttribute("id", projectXmlId),
                                    new XElement(projectElementName + "Nr", defProject.Number),
                                    new XElement(projectElementName + "Name", defProject.Name),
                                    new XElement(projectElementName + "Description", defProject.Description),
                                    new XElement(projectElementName + "Type", defProject.Type),
                                    new XElement(projectElementName + "Status", defProject.Status),
                                    new XElement(projectElementName + "StatusName", defProject.StatusName),
                                    new XElement(projectElementName + "StartDate", defProject.StartDate ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement(projectElementName + "StopDate", defProject.StopDate ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement(projectElementName + "Created", defProject.Created),
                                    new XElement(projectElementName + "CreatedBy", defProject.CreatedBy),
                                    new XElement(projectElementName + "CustomerNr", defProject.Customer),
                                    new XElement(projectElementName + "CustomerName", defProject.Customer),
                                    new XElement(projectElementName + "AccountInternalNr1", accountDim1?.AccountNr ?? string.Empty),
                                    new XElement(projectElementName + "AccountInternalNr2", accountDim2?.AccountNr ?? string.Empty),
                                    new XElement(projectElementName + "AccountInternalNr3", accountDim3?.AccountNr ?? string.Empty),
                                    new XElement(projectElementName + "AccountInternalNr4", accountDim4?.AccountNr ?? string.Empty),
                                    new XElement(projectElementName + "AccountInternalNr5", accountDim5?.AccountNr ?? string.Empty),
                                    new XElement(projectElementName + "Category", defProject.Categories)
                                    );
                                }
                                else
                                {
                                    projectItem = group.FirstOrDefault();
                                    projectElement = new XElement(projectElementName,
                                    new XAttribute("id", projectXmlId),
                                    new XElement(projectElementName + "Nr", projectItem.ProjectNumber),
                                    new XElement(projectElementName + "Name", projectItem.ProjectName),
                                    new XElement(projectElementName + "Description", projectItem.ProjectDescription),
                                    new XElement(projectElementName + "Type", projectItem.ProjectType),
                                    new XElement(projectElementName + "Status", projectItem.ProjectStatus),
                                    new XElement(projectElementName + "StatusName", GetText(projectItem.ProjectStatus, (int)TermGroup.ProjectStatus)),
                                    new XElement(projectElementName + "StartDate", projectItem.ProjectStartDate ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement(projectElementName + "StopDate", projectItem.ProjectStopDate ?? CalendarUtility.DATETIME_DEFAULT),
                                    new XElement(projectElementName + "Created", projectItem.ProjectCreated),
                                    new XElement(projectElementName + "CreatedBy", projectItem.ProjectCreatedBy),
                                    new XElement(projectElementName + "CustomerNr", projectItem.CustomerNr),
                                    new XElement(projectElementName + "CustomerName", projectItem.CustomerName),
                                    new XElement(projectElementName + "AccountInternalNr1", accountDim1?.AccountNr ?? String.Empty),
                                    new XElement(projectElementName + "AccountInternalNr2", accountDim2?.AccountNr ?? String.Empty),
                                    new XElement(projectElementName + "AccountInternalNr3", accountDim3?.AccountNr ?? String.Empty),
                                    new XElement(projectElementName + "AccountInternalNr4", accountDim4?.AccountNr ?? String.Empty),
                                    new XElement(projectElementName + "AccountInternalNr5", accountDim5?.AccountNr ?? String.Empty),
                                    new XElement(projectElementName + "Category", defProject.Categories)
                                    );
                                }
                            }
                            else
                            {
                                projectElement.Add(timeCodeTransactionElements);

                                if (timeCodeTransactionXmlId > 0)
                                {
                                    projectTransactionsReportElement.Add(projectElement);
                                    projectXmlId++;
                                }
                            }
                        }

                        projectPersonellCostSum = 0;
                        projectPersonellIncomeInvoicedSum = 0;
                        projectPersonellIncomeNotInvoicedSum = 0;
                        projectMaterialCostSum = 0;
                        projectMaterialCostSumSupplInv = 0;
                        projectMaterialIncomeInvoicedSum = 0;
                        projectMaterialIncomeNotInvoicedSum = 0;
                        projectPersonellWorkHours = 0;
                        projectPersonellNondebitHours = 0;

                        if (projdtos.Count > 0)
                        {
                            foreach (var projdto in projdtos)
                            {
                                //  if (projdto.Name == "Debiterbara timmar, ej fakturerat" || projdto.GroupRowTypeName == "Debiterbara timmar, ej fakturerat")
                                if (projdto.Type == ProjectCentralBudgetRowType.BillableMinutesNotInvoiced)
                                {
                                    projectPersonellNondebitHours += projdto.Value;
                                }
                                //   if (projdto.Name == "Intäkter fakturerat" || projdto.GroupRowTypeName == "Intäkter fakturerat")
                                if (projdto.Type == ProjectCentralBudgetRowType.IncomeInvoiced)
                                {
                                    projectMaterialIncomeInvoicedSum += projdto.Value;
                                    //    projectPersonellIncomeInvoicedSum += projdto.Value2;
                                }

                                //   if (projdto.Name == "Intäkter ofakturerat" || projdto.GroupRowTypeName == "Intäkter ofakturerat")
                                if (projdto.Type == ProjectCentralBudgetRowType.IncomeNotInvoiced)
                                {
                                    projectMaterialIncomeNotInvoicedSum += projdto.Value;
                                }
                                //   if (projdto.Name == "Kostnader material" || projdto.GroupRowTypeName == "Kostnader material")
                                if (projdto.Type == ProjectCentralBudgetRowType.CostMaterial)
                                {
                                    projectMaterialCostSum += projdto.Value;
                                }
                                //     if ((projdto.Name == "Kostnader material" || projdto.GroupRowTypeName == "Kostnader material") && projdto.OriginType == SoeOriginType.SupplierInvoice)
                                if ((projdto.Type == ProjectCentralBudgetRowType.CostMaterial) && projdto.OriginType == SoeOriginType.SupplierInvoice)
                                {
                                    projectMaterialCostSumSupplInv += projdto.Value2;
                                }
                                //   if (projdto.Name == "Kostnader personal" || projdto.GroupRowTypeName == "Kostnader personal")
                                if (projdto.Type == ProjectCentralBudgetRowType.CostPersonell)
                                {
                                    projectPersonellCostSum += projdto.Value;
                                    projectPersonellWorkHours += projdto.Value2 * 60;
                                }
                                //   if (projdto.Name == "FixedPriceTotal" || projdto.GroupRowTypeName == "FixedPriceTotal")
                                if (projdto.Type == ProjectCentralBudgetRowType.FixedPriceTotal)
                                {
                                    projectFixedPrice += projdto.Value;
                                }
                                //   if (projdto.Name == "CostExpense" || projdto.GroupRowTypeName == "CostExpense")
                                if (projdto.Type == ProjectCentralBudgetRowType.CostExpense)
                                {
                                    projectExpenceCostSum += projdto.Value;
                                }
                                if (projdto.Type == ProjectCentralBudgetRowType.OverheadCost)
                                {
                                    projectOverheadCostSum += projdto.Value;
                                }

                            }

                            #region Project header sums

                            projectElement.Add(new XElement(projectElementName + "BillableMinutesInvoicedSum", projectPersonellWorkHours),
                                new XElement(projectElementName + "BillableMinutesPreliminaryInvoicedSum", projectBillableMinutesPreliminaryInvoicedSum),
                                new XElement(projectElementName + "BillableMinutesNotInvoicedSum", projectPersonellNondebitHours),
                                new XElement(projectElementName + "BillableMinutesInvoicedSumBudget", budgetAdded ? 0 : projectBillableMinutesInvoicedSumBudget),
                                new XElement(projectElementName + "PersonellIncomeInvoicedSum", projectPersonellIncomeInvoicedSum),
                                new XElement(projectElementName + "PersonellIncomePreliminaryInvoicedSum", projectPersonellIncomePreliminaryInvoicedSum),
                                new XElement(projectElementName + "PersonellIncomeNotInvoicedSum", projectPersonellIncomeNotInvoicedSum),
                                new XElement(projectElementName + "PersonellIncomeInvoicedSumBudget", budgetAdded ? 0 : projectPersonellIncomeInvoicedSumBudget),
                                new XElement(projectElementName + "MaterialIncomeInvoicedSum", projectMaterialIncomeInvoicedSum),
                                new XElement(projectElementName + "MaterialIncomePreliminaryInvoicedSum", projectMaterialIncomePreliminaryInvoicedSum),
                                new XElement(projectElementName + "MaterialIncomeNotInvoicedSum", projectMaterialIncomeNotInvoicedSum),
                                new XElement(projectElementName + "MateriallIncomeInvoicedSumBudget", budgetAdded ? 0 : projectMateriallIncomeInvoicedSumBudget),
                                new XElement(projectElementName + "PersonellCostSum", projectPersonellCostSum),
                                new XElement(projectElementName + "PersonellCostSumBudget", budgetAdded ? 0 : projectPersonellCostSumBudget),
                                new XElement(projectElementName + "MaterialCostSum", projectMaterialCostSum),
                                new XElement(projectElementName + "MaterialCostSumSupplInv", projectMaterialCostSumSupplInv),
                                new XElement(projectElementName + "MaterialCostSumBudget", budgetAdded ? 0 : projectMaterialCostSumBudget),
                                new XElement(projectElementName + "ExpenceCostSum", projectExpenceCostSum),
                                new XElement(projectElementName + "ExpenceCostSumBudget", budgetAdded ? 0 : projectExpenceCostSumBudget),
                                new XElement(projectElementName + "OverheadCostSum", projectOverheadCostSum),
                                new XElement(projectElementName + "OverheadCostSumBudget", budgetAdded ? 0 : projectOverheadCostSumBudget));

                            #region Parent project

                            if (group != null && projectItem.ParentProjectId != null)
                            {
                                Project project = allProjects.FirstOrDefault(p => p.ProjectId == projectItem.ParentProjectId);

                                if (project != null)
                                {
                                    projectElement.Add(new XElement(projectElementName + "ParentProjectId", projectItem.ParentProjectId),
                                    new XElement(projectElementName + "ParentProjectNumber", project.Number));
                                }
                                else
                                {
                                    projectElement.Add(new XElement(projectElementName + "ParentProjectId", 0),
                                    new XElement(projectElementName + "ParentProjectNumber", String.Empty));
                                }
                            }
                            else
                            {
                                projectElement.Add(new XElement(projectElementName + "ParentProjectId", 0),
                                new XElement(projectElementName + "ParentProjectNumber", String.Empty));
                            }

                            #endregion

                            #region Fixed and lift amounts

                            bool isFixedPrice = false;
                            bool isFixedPriceKeepPrices = false;
                            if (projectFixedPrice != 0)
                            {
                                isFixedPrice = true;
                            }
                            else if (projectFixedPriceKeepPrices != 0)
                            {
                                projectFixedPrice = projectFixedPrice + projectFixedPriceKeepPrices; //This for now before the crystal reports is updated
                                isFixedPriceKeepPrices = true;
                            }

                            projectElement.Add(
                                new XElement(projectElementName + "IsFixedPriceType1", isFixedPrice.ToInt()),
                                new XElement(projectElementName + "IsFixedPriceType2", isFixedPriceKeepPrices.ToInt()),
                                //new XElement(projectElementName + "FixedPriceKeepPrices", projectFixedPriceKeepPrices < 0 ? Decimal.Negate(projectFixedPriceKeepPrices) : projectFixedPriceKeepPrices),
                                new XElement(projectElementName + "FixedPrice", projectFixedPrice < 0 ? Decimal.Negate(projectFixedPrice) : projectFixedPrice),
                                new XElement(projectElementName + "OpenLiftAmount", projectOpenLiftAmount < 0 ? Decimal.Negate(projectOpenLiftAmount) : projectOpenLiftAmount),
                                new XElement(projectElementName + "InvoicedLiftAmount", projectInvoicedLiftAmount < 0 ? Decimal.Negate(projectInvoicedLiftAmount) : projectInvoicedLiftAmount),
                                new XElement(projectElementName + "RetainedGuaranteeAmount", projectGuaranteeAmount < 0 ? Decimal.Negate(projectGuaranteeAmount) : projectGuaranteeAmount));

                            #endregion

                            #region IB
                            projectElement.Add(
                                new XElement(projectElementName + "BillableMinutesInvoicedSumIB", projectBillableMinutesInvoicedSumIB),
                                new XElement(projectElementName + "PersonellIncomeInvoicedSumIB", projectPersonellIncomeInvoicedSumIB),
                                new XElement(projectElementName + "MateriallIncomeInvoicedSumIB", projectMateriallIncomeInvoicedSumIB),
                                new XElement(projectElementName + "PersonellCostSumIB", projectPersonellCostSumIB),
                                new XElement(projectElementName + "MaterialCostSumIB", projectMaterialCostSumIB),
                                new XElement(projectElementName + "ExpenceCostSumIB", projectExpenceCostSumIB),
                                new XElement(projectElementName + "OverheadCostSumIB", projectOverheadCostSumIB));

                            #endregion

                            projectElement.Add(timeCodeTransactionElements);

                            #endregion

                            #region Default TimeCodeTransaction - Removed, no default element should be added

                            /*if (timeCodeTransactionXmlId == 1)
                                projectElement.Add(new XElement(timeCodeTransactionElementName, String.Empty));*/

                            #endregion

                            if (timeCodeTransactionXmlId > 0)
                            {
                                projectTransactionsReportElement.Add(projectElement);
                                projectXmlId++;
                            }
                        }

                        #endregion
                    }
                }

                #region Default element Project

                if (projectXmlId == 1)
                {
                    projectTransactionsReportElement.Add(new XElement(projectElementName,
                        new XAttribute("id", 1),
                        new XElement(projectElementName + "Nr", String.Empty),
                        new XElement(projectElementName + "Name", String.Empty),
                        new XElement(projectElementName + "Description", String.Empty),
                        new XElement(projectElementName + "Type", 0),
                        new XElement(projectElementName + "Status", 0),
                        new XElement(projectElementName + "StatusName", String.Empty),
                        new XElement(projectElementName + "StartDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement(projectElementName + "StopDate", CalendarUtility.DATETIME_DEFAULT),
                        new XElement(projectElementName + "Created", CalendarUtility.DATETIME_DEFAULT),
                        new XElement(projectElementName + "CreatedBy", String.Empty),
                        new XElement(projectElementName + "CustomerNr", String.Empty),
                        new XElement(projectElementName + "CustomerName", String.Empty)));
                }

                #endregion

                #endregion

                #endregion
            }

            #region Close document

            rootElement.Add(projectTransactionsReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.ProjectTransactionsReport);

            #endregion
        }

        private XDocument CreateHousholdTaxDeductionData(EvaluatedSelection es)
        {
            bool isRut = false;
            bool isGreen = false;
            XElement householdTaxDeductionElement = null;

            #region Prereq

            if (es == null)
                return null;

            List<SysHouseholdType> householdDeductionTypes = ProductManager.GetSysHouseholdType(false);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement baseElement = new XElement(ROOT + "_" + "HousholdTaxDeductionReport");

            XElement rootElement = new XElement("Begaran");
            rootElement.Add(new XElement("BegaranNr", es.SB_HTDSeqNbr));

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                #region Head

                Company receiverCompany = CompanyManager.GetCompany(es.SB_HTDCompanyId);
                if (receiverCompany == null)
                    return null;

                int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, es.ActorCompanyId, 0);

                #endregion

                bool first = true;
                int arendenNr = 0;
                int utfortArbetelXmlId = 0;
                foreach (var htdRowId in es.SB_HTDCustomerInvoiceRowIds)
                {
                    #region Row

                    HouseholdTaxDeductionRow row = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRow(entities, htdRowId, true, true);
                    if (row == null || row.CustomerInvoiceRow == null || row.CustomerInvoiceRow.CustomerInvoice == null)
                        continue;

                    var houseHoldDeductionRowsForThisInvoice = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRowsPerInvoiceDict(entities, row.CustomerInvoiceRow.InvoiceId);
                    int numberOfHouseHoldDeductionsForThisInvoice = houseHoldDeductionRowsForThisInvoice.Count;

                    var customerInvoice = InvoiceManager.GetCustomerInvoice(row.CustomerInvoiceRow.CustomerInvoice.InvoiceId, false, false, false, false, true, false, false, true, true, false, false, false);
                    if (customerInvoice == null || customerInvoice.CustomerInvoiceRow == null)
                        continue;

                    if (first)
                    {
                        isRut = row.HouseHoldTaxDeductionType == (int)TermGroup_HouseHoldTaxDeductionType.RUT;
                        isGreen = (row.HouseHoldTaxDeductionType == (int)TermGroup_HouseHoldTaxDeductionType.GREEN);

                        householdTaxDeductionElement = new XElement("RotBegaran");
                        first = false;
                    }

                    XElement housholdTaxDeductionRow = new XElement("Arenden");

                    arendenNr += 1;

                    #region Calculate Amounts and create type tags

                    List<GenericType<int, decimal, decimal, string>> typesList = new List<GenericType<int, decimal, decimal, string>>();
                    int householdTaxDeductionProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductHouseholdTaxDeduction, 0, es.ActorCompanyId, 0);
                    int household50TaxDeductionProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductHousehold50TaxDeduction, 0, es.ActorCompanyId, 0);
                    List<int> householdDeductionTypeIds = householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == row.HouseHoldTaxDeductionType).Select(t => t.SysHouseholdTypeId).ToList();
                    int nonValidTypeId = householdDeductionTypes.FirstOrDefault(t => t.SysHouseholdTypeClassification == 0)?.SysHouseholdTypeId ?? 0;

                    //ROT TYPES
                    List<GenericType<int, decimal, decimal, string>> rotTypes = new List<GenericType<int, decimal, decimal, string>>();
                    foreach (SysHouseholdType hht in householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == 1))
                    {
                        rotTypes.Add(new GenericType<int, decimal, decimal, string>() { Field1 = hht.SysHouseholdTypeId, Field2 = Decimal.Zero, Field3 = Decimal.Zero, Field4 = hht.XMLTagName });
                    }
                    typesList.AddRange(rotTypes);

                    //RUT TYPES
                    List<GenericType<int, decimal, decimal, string>> rutTypes = new List<GenericType<int, decimal, decimal, string>>();
                    foreach (SysHouseholdType hht in householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == 2))
                    {
                        rutTypes.Add(new GenericType<int, decimal, decimal, string>() { Field1 = hht.SysHouseholdTypeId, Field2 = Decimal.Zero, Field3 = Decimal.Zero, Field4 = hht.XMLTagName });
                    }
                    typesList.AddRange(rutTypes);

                    //GREEN TYPES
                    List<GenericType<int, decimal, decimal, string>> greenTypes = new List<GenericType<int, decimal, decimal, string>>();
                    foreach (SysHouseholdType hht in householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == 3))
                    {
                        greenTypes.Add(new GenericType<int, decimal, decimal, string>() { Field1 = hht.SysHouseholdTypeId, Field2 = Decimal.Zero, Field3 = Decimal.Zero, Field4 = hht.XMLTagName });
                    }
                    typesList.AddRange(greenTypes);

                    decimal amountTotal = Decimal.Zero;
                    decimal amountTotalNonValid = Decimal.Zero;
                    if (customerInvoice.CustomerInvoiceRow != null)
                    {
                        //All CustomerInvoiceRows of type Product
                        List<CustomerInvoiceRow> customerInvoiceProductRows = customerInvoice.ActiveCustomerInvoiceRows.Where(i => i.Type == (int)SoeInvoiceRowType.ProductRow).ToList();

                        bool noType = !customerInvoiceProductRows.Any(r => r.HouseholdDeductionType.HasValue);
                        foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoiceProductRows)
                        {
                            //Check that Product not is HouseholdTaxDeduction 
                            if (customerInvoiceRow.ProductId.HasValue && customerInvoiceRow.ProductId.Value != householdTaxDeductionProductId && customerInvoiceRow.ProductId.Value != household50TaxDeductionProductId)
                            {
                                //Check that Product has VatType Service
                                var invoiceProduct = customerInvoiceRow.Product as InvoiceProduct;
                                if (invoiceProduct != null)
                                {
                                    if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Service)
                                    {
                                        if (noType || (customerInvoiceRow.HouseholdDeductionType.HasValue && householdDeductionTypeIds.Contains((int)customerInvoiceRow.HouseholdDeductionType)) || (isGreen && (!customerInvoiceRow.HouseholdDeductionType.HasValue || customerInvoiceRow.HouseholdDeductionType.Value == nonValidTypeId)))
                                        {
                                            //Accumulate Amount and VatAmount
                                            amountTotal += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                            amountTotal += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);

                                            if (!noType)
                                            {
                                                GenericType<int, decimal, decimal, string> typeRow = (isGreen && (!customerInvoiceRow.HouseholdDeductionType.HasValue || customerInvoiceRow.HouseholdDeductionType.Value == nonValidTypeId)) ? typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType) : typesList.FirstOrDefault(g => g.Field1 == (int)customerInvoiceRow.HouseholdDeductionType);
                                                if (typeRow != null)
                                                {
                                                    if (!customerInvoiceRow.ProductUnitReference.IsLoaded)
                                                        customerInvoiceRow.ProductUnitReference.Load();

                                                    if (customerInvoiceRow.ProductUnit != null)
                                                    {
                                                        if (customerInvoiceRow.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                        else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else
                                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                    }
                                                    else
                                                    {
                                                        if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                                            invoiceProduct.ProductUnitReference.Load();

                                                        if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                        else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else
                                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                GenericType<int, decimal, decimal, string> typeRow = null;
                                                if (invoiceProduct.HouseholdDeductionType.HasValue)
                                                    typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)invoiceProduct.HouseholdDeductionType);
                                                else
                                                    typeRow = typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType);

                                                if (typeRow != null)
                                                {
                                                    if (!customerInvoiceRow.ProductUnitReference.IsLoaded)
                                                        customerInvoiceRow.ProductUnitReference.Load();

                                                    if (customerInvoiceRow.ProductUnit != null)
                                                    {
                                                        if (customerInvoiceRow.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                        else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else
                                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                    }
                                                    else
                                                    {
                                                        if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                                            invoiceProduct.ProductUnitReference.Load();

                                                        if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                        else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                            typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                        else
                                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                    }
                                                }
                                            }
                                        }
                                        else if (customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                        {
                                            amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                            amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                        }
                                    }
                                    else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Merchandise)
                                    {
                                        if (customerInvoiceRow.HouseholdDeductionType.HasValue && householdDeductionTypeIds.Contains((int)customerInvoiceRow.HouseholdDeductionType))
                                        {
                                            GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)customerInvoiceRow.HouseholdDeductionType);
                                            if (typeRow != null)
                                            {
                                                typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                if (isGreen)
                                                    amountTotal += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                            }
                                        }
                                        else if (customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                        {
                                            amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                            amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                        }
                                        else if (noType || (isGreen && (!customerInvoiceRow.HouseholdDeductionType.HasValue || customerInvoiceRow.HouseholdDeductionType.Value == nonValidTypeId)))
                                        {
                                            GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType);
                                            if (typeRow != null)
                                            {
                                                typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                if (isGreen)
                                                {
                                                    amountTotal += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                }
                                            }
                                        }
                                    }
                                    else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.None && customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                    {
                                        amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                        amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                    }
                                }
                            }
                        }
                    }

                    #endregion

                    amountTotal = amountTotal / numberOfHouseHoldDeductionsForThisInvoice;
                    amountTotalNonValid = amountTotalNonValid / numberOfHouseHoldDeductionsForThisInvoice;
                    decimal amountRequest = row.Amount;
                    if (amountRequest == 0 || amountTotal == 0)
                        continue;

                    decimal amountPayed = amountTotal - amountRequest /*/ numberOfHouseHoldDeductionsForThisInvoice*/;
                    DateTime? paymentDate = PaymentManager.GetLastPaymentDateForInvoice(entities, row.CustomerInvoiceRow.CustomerInvoice.InvoiceId);

                    string socialSecNr = row.SocialSecNr;

                    //Rensa bort sånt som inte ska vara med enligt skatteverkets mall
                    socialSecNr = socialSecNr.Replace("-", "");
                    socialSecNr = socialSecNr.Replace(" ", "");

                    //De vill ha tolv siffror, så vi får lägga till om det saknas "19" först
                    if (socialSecNr.Length == 10)
                        socialSecNr = "19" + socialSecNr;

                    string orgNr = row.CooperativeOrgNr;
                    orgNr = orgNr != null ? orgNr.Replace("-", "") : String.Empty;
                    orgNr = orgNr.Replace(" ", "");
                    //if (orgNr.Length == 10)
                    //    orgNr = "16" + orgNr;

                    housholdTaxDeductionRow.Add(
                        new XElement("Id", arendenNr),                                        // ArendeNr
                        new XElement("Kopare", socialSecNr),                                        // Personnummer
                        new XElement("BetalningsDatum", paymentDate.HasValue ? paymentDate.Value.Date.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()), // Betalningsdatum (Betalningens PayDate)
                        new XElement("PrisForArbete", Math.Round(amountTotal)),                         // Pris för arbetet (räknas ut, fakturans andra rader med produkter med typen tjänst)
                        new XElement("BetaltBelopp", Math.Round(amountPayed)),                             // Belopp du fått betalt (AmountTotal - AmountRequest)
                        new XElement("BegartBelopp", Math.Round(row.Amount)),                              // Belopp du begär
                        new XElement("FakturaNr", customerInvoice.InvoiceNr),                       // Fakturans nummer
                        new XElement("Ovrigkostnad", (int)Math.Ceiling(amountTotalNonValid)));                         // Övrig kostnad

                    housholdTaxDeductionRow.Add(
                        new XElement("Fastighetsbeteckning", row.Property),
                        new XElement("LagenhetsNr", row.ApartmentNr),
                        new XElement("BrfOrgNr", orgNr));

                    foreach (var hht in typesList)
                    {
                        if (hht.Field2 == 0 && hht.Field3 == 0)
                            continue;
                        string hhtField2 = ((int)Math.Ceiling(hht.Field2 / numberOfHouseHoldDeductionsForThisInvoice)).ToString();
                        string hhtField3 = ((int)Math.Ceiling(hht.Field3 / numberOfHouseHoldDeductionsForThisInvoice)).ToString();

                        XElement workRow = new XElement("UtfortArbete");
                        utfortArbetelXmlId += 1;
                        workRow.Add(
                            new XElement("Id", utfortArbetelXmlId),
                            new XElement("Typ", hht.Field4),
                            new XElement("AntalTimmar", hhtField2),
                            new XElement("Materialkostnad", hhtField3));
                        housholdTaxDeductionRow.Add(workRow);
                    }
                    householdTaxDeductionElement.Add(housholdTaxDeductionRow);

                    row.SeqNr = es.SB_HTDSeqNbr;

                    #endregion
                }

                entities.SaveChanges();

                #endregion
            }

            // Update latest used sequence number
            if (isRut)
                SequenceNumberManager.UpdateSequenceNumber(es.SB_HTDCompanyId, "RutTaxDeduction", es.SB_HTDSeqNbr);
            else if (isGreen)
                SequenceNumberManager.UpdateSequenceNumber(es.SB_HTDCompanyId, "GreenTaxDeduction", es.SB_HTDSeqNbr);
            else
                SequenceNumberManager.UpdateSequenceNumber(es.SB_HTDCompanyId, "HouseholdTaxDeduction", es.SB_HTDSeqNbr);

            rootElement.Add(householdTaxDeductionElement);
            baseElement.Add(rootElement);
            document.Add(baseElement);

            return GetValidatedDocument(document, SoeReportTemplateType.HousholdTaxDeduction);
        }

        private XDocument CreateHousholdTaxDeductionDataXML(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            if (es.SB_HTDUseGreen)
                return CreateHousholdTaxDeductionDataGreenXML(es);

            bool isRut = false;
            XElement householdTaxDeductionElement = null;
            List<SysHouseholdType> householdDeductionTypes = ProductManager.GetSysHouseholdType(false);

            bool useZerosInTaxDeductionFile = SettingManager.GetBoolSetting(SettingMainType.Application, (int)ApplicationSettingType.UseZerosInTaxDeductionFile, 0, 0, 0, false);

            #endregion

            #region Init document

            const string schema_location = "http://xmls.skatteverket.se/se/skatteverket/ht/begaran/6.0 Begaran.xsd";

            XNamespace xsi = XNamespace.Get("http://www.w3.org/2001/XMLSchema-instance");
            XNamespace defaultNamespace = XNamespace.Get("http://xmls.skatteverket.se/se/skatteverket/ht/begaran/6.0");
            XNamespace htko = XNamespace.Get("http://xmls.skatteverket.se/se/skatteverket/ht/komponent/begaran/6.0");
            XElement rootElement = new XElement(
               new XElement(defaultNamespace + "Begaran",
               new XAttribute(XNamespace.Xmlns + "n1", defaultNamespace),
               new XAttribute(XNamespace.Xmlns + "xsi", xsi.NamespaceName),
               new XAttribute(xsi + "schemaLocation", schema_location),
               new XAttribute(XNamespace.Xmlns + "htko", htko)));

            rootElement.Add(new XElement(htko + "NamnPaBegaran", es.SB_HTDSeqNbr));

            #region OLD VERSION

            /*const string schema_location = "se/skatteverket/hunten/ansokan/1.0 HtAnsokan.xsd";

            XNamespace xsi = XNamespace.Get("http://www.w3.org/2001/XMLSchema-instance");
            XNamespace defaultNamespace = XNamespace.Get("http://xmls.skatteverket.se/se/skatteverket/ht/begaran/3.0");
            XNamespace htko = XNamespace.Get("http://xmls.skatteverket.se/se/skatteverket/ht/komponent/begaran/3.0");
            XElement rootElement = new XElement(
               new XElement(defaultNamespace + "Begaran",
               new XAttribute(XNamespace.Xmlns + "n1", defaultNamespace),
               new XAttribute(XNamespace.Xmlns + "xsi", xsi.NamespaceName),
               new XAttribute(xsi + "schemaLocation", schema_location),
               new XAttribute(XNamespace.Xmlns + "htko", htko)));

            rootElement.Add(new XElement(htko + "BegaranNr", es.SB_HTDSeqNbr));

            #region OLD VERSION

            /*const string schema_location = "se/skatteverket/hunten/ansokan/1.0 HtAnsokan.xsd";

            //Root
            XNamespace xsi = XNamespace.Get("http://www.w3.org/2001/XMLSchema-instance");
            XNamespace defaultNamespace = XNamespace.Get("se/skatteverket/hunten/ansokan/1.0");
            XElement rootElement = new XElement(
               new XElement(defaultNamespace + "HtAnsokan",
               new XAttribute(XNamespace.Xmlns + "xsi", xsi.NamespaceName),
               new XAttribute(xsi + "schemaLocation", schema_location)));

            rootElement.Add(new XElement("ansokningsNummer", es.SB_HTDSeqNbr));*/

            #endregion

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                #region Head

                Company receiverCompany = CompanyManager.GetCompany(es.SB_HTDCompanyId);
                if (receiverCompany == null)
                    return null;

                int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, es.ActorCompanyId, 0);

                #endregion

                bool first = true;

                foreach (var htdRowId in es.SB_HTDCustomerInvoiceRowIds)
                {
                    #region Row

                    HouseholdTaxDeductionRow row = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRow(entities, htdRowId, true, true);
                    if (row == null || row.CustomerInvoiceRow == null || row.CustomerInvoiceRow.CustomerInvoice == null)
                        continue;

                    var houseHoldDeductionRowsForThisInvoice = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRowsPerInvoiceDict(entities, row.CustomerInvoiceRow.InvoiceId);
                    int numberOfHouseHoldDeductionsForThisInvoice = houseHoldDeductionRowsForThisInvoice.Count;
                    decimal sumOfHouseHoldDeductionsForThisInvoice = houseHoldDeductionRowsForThisInvoice.Sum(x => x.Field2);

                    var customerInvoice = InvoiceManager.GetCustomerInvoiceSmallDialogDTO(entities, row.CustomerInvoiceRow.InvoiceId);
                    if (customerInvoice == null)
                        continue;

                    if (first)
                    {
                        isRut = row.HouseHoldTaxDeductionType == (int)TermGroup_HouseHoldTaxDeductionType.RUT;

                        if (isRut)
                            householdTaxDeductionElement = new XElement(htko + "HushallBegaran");
                        else
                            householdTaxDeductionElement = new XElement(htko + "RotBegaran");
                        first = false;
                    }

                    XElement housholdTaxDeductionRow = new XElement(htko + "Arenden");

                    #region Calculate Amounts and create type tags

                    List<GenericType<int, decimal, decimal, string>> typesList = new List<GenericType<int, decimal, decimal, string>>();
                    int householdTaxDeductionProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductHouseholdTaxDeduction, 0, es.ActorCompanyId, 0);
                    int householdRutTaxDeductionProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductRUTTaxDeduction, 0, es.ActorCompanyId, 0);
                    List<int> householdDeductionTypeIds = householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == (isRut ? 2 : 1)).Select(t => t.SysHouseholdTypeId).ToList();
                    int nonValidTypeId = householdDeductionTypes.FirstOrDefault(t => t.SysHouseholdTypeClassification == 0)?.SysHouseholdTypeId ?? 0;

                    foreach (SysHouseholdType hht in householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == (isRut ? 2 : 1)))
                    {
                        typesList.Add(new GenericType<int, decimal, decimal, string>() { Field1 = hht.SysHouseholdTypeId, Field2 = Decimal.Zero, Field3 = Decimal.Zero, Field4 = hht.XMLTagName });
                    }

                    decimal amountTotal = Decimal.Zero;
                    decimal amountTotalNonValid = Decimal.Zero;

                    var customerInvoiceProductRows = InvoiceManager.GetCustomerInvoiceRowsForOrderInvoiceEdit(entities, row.CustomerInvoiceRow.InvoiceId, false, true, false).Where(i => i.Type == (int)SoeInvoiceRowType.ProductRow && !i.IsHouseholdTaxDeductionRow()).ToList();
                    if (!customerInvoiceProductRows.Any())
                        continue;

                    bool noType = !customerInvoiceProductRows.Any(r => r.HouseholdDeductionType.HasValue);
                    foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoiceProductRows)
                    {
                        //Check that Product not is HouseholdTaxDeduction 
                        if (customerInvoiceRow.ProductId.HasValue && customerInvoiceRow.ProductId.Value != householdTaxDeductionProductId && customerInvoiceRow.ProductId.Value != householdRutTaxDeductionProductId)
                        {
                            //Check that Product has VatType Service
                            var invoiceProduct = customerInvoiceRow.Product as InvoiceProduct;
                            if (invoiceProduct != null)
                            {
                                if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Service)
                                {
                                    if (noType || (customerInvoiceRow.HouseholdDeductionType.HasValue && householdDeductionTypeIds.Contains((int)customerInvoiceRow.HouseholdDeductionType)))
                                    {
                                        //Accumulate Amount and VatAmount
                                        amountTotal += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                        amountTotal += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);

                                        if (!noType)
                                        {
                                            GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)customerInvoiceRow.HouseholdDeductionType);
                                            if (typeRow != null)
                                            {
                                                if (!customerInvoiceRow.ProductUnitReference.IsLoaded)
                                                    customerInvoiceRow.ProductUnitReference.Load();

                                                if (customerInvoiceRow.ProductUnit != null)
                                                {
                                                    if (customerInvoiceRow.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                    else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else
                                                        typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                }
                                                else
                                                {
                                                    if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                                        invoiceProduct.ProductUnitReference.Load();

                                                    if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                    else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else
                                                        typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                }
                                            }
                                        }
                                        else
                                        {
                                            GenericType<int, decimal, decimal, string> typeRow = null;
                                            if (invoiceProduct.HouseholdDeductionType.HasValue)
                                                typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)invoiceProduct.HouseholdDeductionType);
                                            else
                                                typeRow = typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType);

                                            if (typeRow != null)
                                            {
                                                if (!customerInvoiceRow.ProductUnitReference.IsLoaded)
                                                    customerInvoiceRow.ProductUnitReference.Load();

                                                if (customerInvoiceRow.ProductUnit != null)
                                                {
                                                    if (customerInvoiceRow.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                    else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else
                                                        typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                }
                                                else
                                                {
                                                    if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                                        invoiceProduct.ProductUnitReference.Load();

                                                    if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                    else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                        typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                    else
                                                        typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                                }
                                            }
                                        }
                                    }
                                    else if (customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                    {
                                        amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                        amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                    }
                                }
                                else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Merchandise)
                                {
                                    if (customerInvoiceRow.HouseholdDeductionType.HasValue && householdDeductionTypeIds.Contains((int)customerInvoiceRow.HouseholdDeductionType))
                                    {
                                        GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)customerInvoiceRow.HouseholdDeductionType);
                                        if (typeRow != null)
                                        {
                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                        }
                                    }
                                    else if (customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                    {
                                        amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                        amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                    }
                                    else if (noType)
                                    {
                                        GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType);

                                        if (typeRow != null)
                                        {
                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                        }
                                    }
                                }
                                else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.None && customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                {
                                    amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                    amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                }
                            }
                        }
                    }

                    #endregion

                    var percentOfTotalDeduction = sumOfHouseHoldDeductionsForThisInvoice != 0 ? row.Amount / sumOfHouseHoldDeductionsForThisInvoice : 0;

                    amountTotal = Math.Round(amountTotal * percentOfTotalDeduction, 0);
                    amountTotalNonValid = Math.Round(amountTotalNonValid * percentOfTotalDeduction, 0);

                    decimal amountRequest = row.Amount;
                    if (amountRequest == 0 || amountTotal == 0)
                        continue;

                    decimal amountPayed = amountTotal - amountRequest /*/ numberOfHouseHoldDeductionsForThisInvoice*/;
                    DateTime? paymentDate = PaymentManager.GetLastPaymentDateForInvoice(entities, row.CustomerInvoiceRow.CustomerInvoice.InvoiceId);


                    string socialSecNr = row.SocialSecNr;

                    //Rensa bort sånt som inte ska vara med enligt skatteverkets mall
                    socialSecNr = socialSecNr.Replace("-", "");
                    socialSecNr = socialSecNr.Replace(" ", "");

                    //De vill ha tolv siffror, så vi får lägga till om det saknas "19" först
                    if (socialSecNr.Length == 10)
                        socialSecNr = "19" + socialSecNr;

                    if (isRut)
                    {
                        housholdTaxDeductionRow.Add(
                            new XElement(htko + "Kopare", socialSecNr),                                        // Personnummer
                            new XElement(htko + "BetalningsDatum", paymentDate.HasValue ? paymentDate.Value.Date.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()), // Betalningsdatum (Betalningens PayDate)
                            new XElement(htko + "PrisForArbete", Math.Round(amountTotal)),                         // Pris för arbetet (räknas ut, fakturans andra rader med produkter med typen tjänst)
                            new XElement(htko + "BetaltBelopp", Math.Round(amountPayed)),                             // Belopp du fått betalt (AmountTotal - AmountRequest)
                            new XElement(htko + "BegartBelopp", Math.Round(row.Amount)),                              // Belopp du begär
                            new XElement(htko + "FakturaNr", customerInvoice.InvoiceNr),                       // Fakturans nummer
                            new XElement(htko + "Ovrigkostnad", (int)Math.Round(amountTotalNonValid)));                          // Belopp du begär
                    }
                    else
                    {
                        string orgNr = row.CooperativeOrgNr;
                        orgNr = orgNr != null ? orgNr.Replace("-", "") : string.Empty;
                        orgNr = orgNr.Replace(" ", "");

                        housholdTaxDeductionRow.Add(
                            new XElement(htko + "Kopare", socialSecNr),                                        // Personnummer
                            new XElement(htko + "BetalningsDatum", paymentDate.HasValue ? paymentDate.Value.Date.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()), // Betalningsdatum (Betalningens PayDate)
                            new XElement(htko + "PrisForArbete", Math.Round(amountTotal)),                         // Pris för arbetet (räknas ut, fakturans andra rader med produkter med typen tjänst)
                            new XElement(htko + "BetaltBelopp", Math.Round(amountPayed)),                             // Belopp du fått betalt (AmountTotal - AmountRequest)
                            new XElement(htko + "BegartBelopp", Math.Round(row.Amount)),                              // Belopp du begär
                            new XElement(htko + "FakturaNr", customerInvoice.InvoiceNr),                       // Fakturans nummer
                            new XElement(htko + "Ovrigkostnad", (int)Math.Round(amountTotalNonValid)));                          // Övrig kostnad

                        if (row.CooperativeOrgNr != null && orgNr.Trim() != string.Empty)
                        {
                            housholdTaxDeductionRow.Add(
                                    new XElement(htko + "LagenhetsNr", row.ApartmentNr),
                                    new XElement(htko + "BrfOrgNr", orgNr));
                        }
                        else
                        {
                            housholdTaxDeductionRow.Add(new XElement(htko + "Fastighetsbeteckning", row.Property.Length > 40 ? row.Property.Substring(0, 40) : row.Property));
                        }
                    }

                    XElement workRow = new XElement(htko + "UtfortArbete");

                    foreach (var hht in typesList)
                    {
                        string hhtField2;
                        string hhtField3;

                        if (useZerosInTaxDeductionFile)
                        {
                            hhtField2 = ((int)Math.Ceiling(hht.Field2 / numberOfHouseHoldDeductionsForThisInvoice)).ToString();
                            hhtField3 = ((int)Math.Ceiling(hht.Field3 / numberOfHouseHoldDeductionsForThisInvoice)).ToString();
                        }
                        else
                        {
                            hhtField2 = hht.Field2 > 0 ? ((int)Math.Ceiling(hht.Field2 / numberOfHouseHoldDeductionsForThisInvoice)).ToString() : "";
                            hhtField3 = hht.Field3 > 0 ? ((int)Math.Ceiling(hht.Field3 / numberOfHouseHoldDeductionsForThisInvoice)).ToString() : "";
                        }

                        var replacement = hht.Field4.Replace(" ", "");
                        replacement = replacement.Replace("å", "a");
                        replacement = replacement.Replace("ä", "a");
                        replacement = replacement.Replace("ö", "o");

                        XElement typeRow = new XElement(htko + replacement);
                        if (hht.Field4 == "Transport till försäljning" || hht.Field4 == "Tvätt vid tvättinrättning" || hht.Field4 == "TransportTillForsaljning" || hht.Field4 == "TvattVidTvattinrattning")
                        {
                            if (hht.Field2 != 0)
                            {
                                typeRow.Add(new XElement(htko + "Utfort", 1));
                            }
                            else
                            {
                                typeRow.Add(new XElement(htko + "Utfort", 0));
                            }
                        }
                        else
                        {
                            typeRow.Add(new XElement(htko + "AntalTimmar", hhtField2),
                            new XElement(htko + "Materialkostnad", hhtField3));
                        }

                        workRow.Add(typeRow);
                    }

                    housholdTaxDeductionRow.Add(workRow);
                    householdTaxDeductionElement.Add(housholdTaxDeductionRow);

                    row.SeqNr = es.SB_HTDSeqNbr;

                    #endregion
                }

                #endregion

                // Save row updates
                entities.SaveChanges();
            }
            // Update latest used sequence number
            SequenceNumberManager.UpdateSequenceNumber(es.SB_HTDCompanyId, isRut ? "RutTaxDeduction" : "HouseholdTaxDeduction", es.SB_HTDSeqNbr);

            #region Close document

            rootElement.Add(householdTaxDeductionElement);

            XDocument document = XmlUtil.CreateDocument(Encoding.UTF8, true);
            document.Add(rootElement);
            return document;

            #endregion
        }

        private XDocument CreateHousholdTaxDeductionDataGreenXML(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            XElement householdTaxDeductionElement = null;
            List<SysHouseholdType> householdDeductionTypes = ProductManager.GetSysHouseholdType(false);

            #endregion

            #region Init document

            XNamespace xsi = XNamespace.Get("http://www.w3.org/2001/XMLSchema-instance");
            XNamespace defaultNamespace = XNamespace.Get("http://xmls.skatteverket.se/se/skatteverket/skattered/begaran/1.0");
            XNamespace p = XNamespace.Get("http://xmls.skatteverket.se/se/skatteverket/skattered/begaran/1.0");
            XElement rootElement = new XElement(
               new XElement(defaultNamespace + "Begaran",
               new XAttribute(XNamespace.Xmlns + "p", defaultNamespace),
               new XAttribute(XNamespace.Xmlns + "xsi", xsi.NamespaceName)));

            rootElement.Add(new XElement(p + "NamnPaBegaran", es.SB_HTDSeqNbr));
            rootElement.Add(new XElement(p + "TypAvBegaran", "GRON_TEKNIK"));

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                #region Content

                #region Head

                Company receiverCompany = CompanyManager.GetCompany(es.SB_HTDCompanyId);
                if (receiverCompany == null)
                    return null;

                // Handle org nr
                string recieverOrgNr = receiverCompany.OrgNr;
                recieverOrgNr = recieverOrgNr != null ? recieverOrgNr.Replace("-", "") : String.Empty;
                recieverOrgNr = recieverOrgNr.Replace(" ", "");
                if (recieverOrgNr.Length == 10)
                    recieverOrgNr = "16" + recieverOrgNr;

                rootElement.Add(new XElement(p + "Utforare", recieverOrgNr));

                int defaultHouseholdDeductionType = SettingManager.GetIntSetting(entities, SettingMainType.Company, (int)CompanySettingType.BillingDefaultHouseholdDeductionType, 0, es.ActorCompanyId, 0);

                #endregion

                foreach (var htdRowId in es.SB_HTDCustomerInvoiceRowIds)
                {
                    #region Row

                    HouseholdTaxDeductionRow row = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRow(entities, htdRowId, true, true);
                    if (row == null || row.CustomerInvoiceRow == null || row.CustomerInvoiceRow.CustomerInvoice == null)
                        continue;

                    var houseHoldDeductionRowsForThisInvoice = HouseholdTaxDeductionManager.GetHouseholdTaxDeductionRowsPerInvoiceDict(entities, row.CustomerInvoiceRow.InvoiceId);
                    int numberOfHouseHoldDeductionsForThisInvoice = houseHoldDeductionRowsForThisInvoice.Count;

                    var customerInvoice = InvoiceManager.GetCustomerInvoiceSmallDialogDTO(entities, row.CustomerInvoiceRow.InvoiceId);
                    if (customerInvoice == null)
                        continue;

                    // Handle social security nr
                    string socialSecNr = row.SocialSecNr;
                    socialSecNr = socialSecNr.Replace("-", "");
                    socialSecNr = socialSecNr.Replace(" ", "");

                    if (socialSecNr.Length == 10)
                        socialSecNr = "19" + socialSecNr;

                    XElement housholdTaxDeductionRow = new XElement(p + "Arende");
                    housholdTaxDeductionRow.Add(new XElement(p + "FakturaNr", customerInvoice.InvoiceNr));
                    housholdTaxDeductionRow.Add(new XElement(p + "Kopare", socialSecNr));

                    // Add object info
                    XElement objectElement = new XElement(p + "Fastighet");
                    if (row.CooperativeOrgNr != null && row.CooperativeOrgNr.Trim() != String.Empty)
                    {
                        string orgNr = row.CooperativeOrgNr;
                        orgNr = orgNr != null ? orgNr.Replace("-", "") : String.Empty;
                        orgNr = orgNr.Replace(" ", "");

                        objectElement.Add(
                                new XElement(p + "LagenhetsNr", row.ApartmentNr),
                                new XElement(p + "BrfOrgNr", orgNr));
                    }
                    else
                    {
                        objectElement.Add(new XElement(p + "Fastighetsbeteckning", row.Property.Length > 40 ? row.Property.Substring(0, 40) : row.Property));
                    }
                    housholdTaxDeductionRow.Add(objectElement);


                    #region Calculate Amounts and create type tags

                    List<GenericType<int, decimal, decimal, string>> typesList = new List<GenericType<int, decimal, decimal, string>>();
                    int green15ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGreen15TaxDeduction, 0, es.ActorCompanyId, 0);
                    int green20ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGreen20TaxDeduction, 0, es.ActorCompanyId, 0);
                    int green50ProductId = SettingManager.GetIntSetting(SettingMainType.Company, (int)CompanySettingType.ProductGreen50TaxDeduction, 0, es.ActorCompanyId, 0);
                    List<int> householdDeductionTypeIds = householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == 3).Select(t => t.SysHouseholdTypeId).ToList();
                    int nonValidTypeId = householdDeductionTypes.FirstOrDefault(t => t.SysHouseholdTypeClassification == 0)?.SysHouseholdTypeId ?? 0;

                    foreach (SysHouseholdType hhType in householdDeductionTypes.Where(t => t.SysHouseholdTypeClassification == 3))
                    {
                        typesList.Add(new GenericType<int, decimal, decimal, string>() { Field1 = hhType.SysHouseholdTypeId, Field2 = Decimal.Zero, Field3 = Decimal.Zero, Field4 = hhType.XMLTagName });
                    }

                    decimal amountTotal = Decimal.Zero;
                    decimal amountTotalNonValid = Decimal.Zero;

                    var customerInvoiceProductRows = InvoiceManager.GetCustomerInvoiceRowsForOrderInvoiceEdit(entities, row.CustomerInvoiceRow.InvoiceId, false, true, false).Where(i => i.Type == (int)SoeInvoiceRowType.ProductRow && !i.IsHouseholdTaxDeductionRow()).ToList();
                    if (!customerInvoiceProductRows.Any())
                        continue;

                    bool noType = !customerInvoiceProductRows.Any(r => r.HouseholdDeductionType.HasValue);
                    foreach (CustomerInvoiceRow customerInvoiceRow in customerInvoiceProductRows)
                    {
                        //Check that Product not is HouseholdTaxDeduction 
                        if (customerInvoiceRow.ProductId.HasValue && customerInvoiceRow.ProductId.Value != green15ProductId && customerInvoiceRow.ProductId.Value != green20ProductId && customerInvoiceRow.ProductId.Value != green50ProductId)
                        {
                            //Check that Product has VatType Service
                            var invoiceProduct = customerInvoiceRow.Product as InvoiceProduct;
                            if (invoiceProduct != null)
                            {
                                /*if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Service)
                                {*/
                                if (noType || (customerInvoiceRow.HouseholdDeductionType.HasValue && householdDeductionTypeIds.Contains((int)customerInvoiceRow.HouseholdDeductionType)))
                                {
                                    //Accumulate Amount and VatAmount
                                    amountTotal += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                    amountTotal += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);

                                    if (!noType)
                                    {
                                        GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)customerInvoiceRow.HouseholdDeductionType);
                                        if (typeRow != null)
                                        {
                                            if (!customerInvoiceRow.ProductUnitReference.IsLoaded)
                                                customerInvoiceRow.ProductUnitReference.Load();

                                            if (customerInvoiceRow.ProductUnit != null)
                                            {
                                                if (customerInvoiceRow.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                            }
                                            else
                                            {
                                                if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                                    invoiceProduct.ProductUnitReference.Load();

                                                if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                            }
                                        }
                                    }
                                    else
                                    {
                                        GenericType<int, decimal, decimal, string> typeRow = null;
                                        if (invoiceProduct.HouseholdDeductionType.HasValue)
                                            typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)invoiceProduct.HouseholdDeductionType);
                                        else
                                            typeRow = typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType);

                                        if (typeRow != null)
                                        {
                                            if (!customerInvoiceRow.ProductUnitReference.IsLoaded)
                                                customerInvoiceRow.ProductUnitReference.Load();

                                            if (customerInvoiceRow.ProductUnit != null)
                                            {
                                                if (customerInvoiceRow.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                else if (customerInvoiceRow.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                            }
                                            else
                                            {
                                                if (!invoiceProduct.ProductUnitReference.IsLoaded)
                                                    invoiceProduct.ProductUnitReference.Load();

                                                if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "min" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += (customerInvoiceRow.Quantity.Value / 60);
                                                else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "tim" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                else if (invoiceProduct.ProductUnit != null && invoiceProduct.ProductUnit.Code.ToLower() == "timmar" && customerInvoiceRow.Quantity.HasValue)
                                                    typeRow.Field2 += customerInvoiceRow.Quantity.Value;
                                                typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                            }
                                        }
                                    }
                                }
                                else if (customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                {
                                    amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                    amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                }
                                /*}
                                else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.Merchandise)
                                {
                                    if (customerInvoiceRow.HouseholdDeductionType.HasValue && householdDeductionTypeIds.Contains((int)customerInvoiceRow.HouseholdDeductionType))
                                    {
                                        GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == (int)customerInvoiceRow.HouseholdDeductionType);
                                        if (typeRow != null)
                                        {
                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                        }
                                    }
                                    else if (customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                    {
                                        amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                        amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                    }
                                    else if (noType)
                                    {
                                        GenericType<int, decimal, decimal, string> typeRow = typesList.FirstOrDefault(g => g.Field1 == defaultHouseholdDeductionType);

                                        if (typeRow != null)
                                        {
                                            typeRow.Field3 += customerInvoiceRow.SumAmountCurrency + customerInvoiceRow.VatAmountCurrency;
                                        }
                                    }
                                }
                                else if (invoiceProduct.VatType == (int)TermGroup_InvoiceProductVatType.None && customerInvoiceRow.HouseholdDeductionType.HasValue && customerInvoiceRow.HouseholdDeductionType == nonValidTypeId)
                                {
                                    amountTotalNonValid += customerInvoiceRow.SumAmount > 0 ? customerInvoiceRow.SumAmount : Decimal.Negate(customerInvoiceRow.SumAmount);
                                    amountTotalNonValid += customerInvoiceRow.VatAmount > 0 ? customerInvoiceRow.VatAmount : Decimal.Negate(customerInvoiceRow.VatAmount);
                                }*/
                            }
                        }
                    }

                    #endregion

                    decimal amountRequest = row.Amount;
                    if (amountRequest == 0 || amountTotal == 0)
                        continue;

                    decimal amountPayed = numberOfHouseHoldDeductionsForThisInvoice > 1 ? amountTotal - houseHoldDeductionRowsForThisInvoice.Sum(r => r.Field2) : amountTotal - amountRequest;
                    DateTime? paymentDate = PaymentManager.GetLastPaymentDateForInvoice(entities, row.CustomerInvoiceRow.CustomerInvoice.InvoiceId);

                    GenericType<int, decimal, decimal, string> hht = null;
                    if (row.CustomerInvoiceRow.ProductId == green15ProductId || row.CustomerInvoiceRow.ProductId == green20ProductId)
                    {
                        // solar cells
                        hht = typesList.FirstOrDefault(t => t.Field1 == 20);
                    }
                    else
                    {
                        // storage or charging point
                        var hhtStore = typesList.FirstOrDefault(t => t.Field1 == 21);
                        var hhtCharge = typesList.FirstOrDefault(t => t.Field1 == 22);
                        if(Math.Ceiling(hhtStore.Field2) > 0 && Math.Ceiling(hhtStore.Field3) > 0 && Math.Ceiling(hhtCharge.Field2) > 0 && Math.Ceiling(hhtCharge.Field3) > 0)
                        {
                            // Both storage and charge eligable product rows
                            if(row.CustomerInvoiceRow.HouseholdDeductionType == 21)
                                hht = hhtStore;
                            else if(row.CustomerInvoiceRow.HouseholdDeductionType == 22)
                                hht = hhtCharge;
                        }
                        else if(Math.Ceiling(hhtStore.Field2) > 0 && Math.Ceiling(hhtStore.Field3) > 0)
                        {
                            // Storage
                            hht = hhtStore;
                        }
                        else if(Math.Ceiling(hhtCharge.Field2) > 0 && Math.Ceiling(hhtCharge.Field3) > 0)
                        {
                            // Charge
                            hht = hhtCharge;
                        }
                    }

                    if (hht != null)
                    {
                        if (Math.Ceiling(hht.Field2) == 0 || Math.Ceiling(hht.Field3) == 0)
                            continue;

                        string type = String.Empty;
                        switch (hht.Field1)
                        {
                            case 20:
                                type = "INSTALLATION_SOLCELLER";
                                break;
                            case 21:
                                type = "INSTALLATION_LAGRING";
                                break;
                            case 22:
                                type = "INSTALLATION_LADDPUNKT";
                                break;
                        }
                        string hhtField2 = ((int)Math.Ceiling(hht.Field2)).ToString();
                        string hhtField3 = ((int)Math.Ceiling(hht.Field3)).ToString();

                        XElement workElement = new XElement(p + "UtfortArbete");

                        workElement.Add(
                                    new XElement(p + "TypAvUtfortArbete", type),
                                    new XElement(p + "AntalTimmar", hhtField2),
                                    new XElement(p + "Kostnad", hhtField3));

                        housholdTaxDeductionRow.Add(workElement);
                    }

                    housholdTaxDeductionRow.Add(new XElement(p + "OvrigKostnad", (int)Math.Round(amountTotalNonValid)));
                    housholdTaxDeductionRow.Add(new XElement(p + "Betalningsdatum", paymentDate.HasValue ? paymentDate.Value.Date.ToShortDateString() : CalendarUtility.DATETIME_DEFAULT.ToShortDateString()));
                    housholdTaxDeductionRow.Add(new XElement(p + "BetaltBelopp", Math.Round(amountPayed)));
                    housholdTaxDeductionRow.Add(new XElement(p + "BegartBelopp", Math.Round(row.Amount)));

                    rootElement.Add(housholdTaxDeductionRow);

                    row.SeqNr = es.SB_HTDSeqNbr;

                    #endregion
                }

                #endregion

                // Save row updates
                entities.SaveChanges();
            }
            // Update latest used sequence number
            SequenceNumberManager.UpdateSequenceNumber(es.SB_HTDCompanyId, "GreenTaxDeduction", es.SB_HTDSeqNbr);

            #region Close document

            rootElement.Add(householdTaxDeductionElement);

            XDocument document = XmlUtil.CreateDocument(Encoding.UTF8, true);
            document.Add(rootElement);
            return document;

            #endregion
        }

        public string CreateInvoiceQR(CompEntities entities, QRCode qrCode, string invoiceReference, string address, DateTime invoiceDate, DateTime dueDate, decimal totalAmountCurreny, decimal vatAmountCurrency, string sellerName, string currency, string orgNr, TermGroup_SysPaymentType paymentType, string paymentNr)
        {
            var path = qrCode.CreateInvoiceQR(invoiceReference, address, invoiceDate, dueDate, totalAmountCurreny, vatAmountCurrency, sellerName, currency, orgNr, paymentType, paymentNr);

            if (!SettingManager.GetBoolSetting(entities, SettingMainType.Application, (int)ApplicationSettingType.UseCrGen, 0, 0, 0))
                return AddToCrGenRequestPicturesDTO(path);

            return path;
        }

        private InvoiceProduct GetInvoiceProductFromTimeCode(CompEntities entities, int timeCodeId, int actorCompanyId)
        {
            TimeCode timecode = TimeCodeManager.GetTimeCodeWithInvoiceProduct(entities, timeCodeId, actorCompanyId);
            if (timecode != null && timecode.TimeCodeInvoiceProduct != null)
            {
                var timecodeinvoiceproduct = timecode.TimeCodeInvoiceProduct.FirstOrDefault();
                if (timecodeinvoiceproduct != null)
                    return timecodeinvoiceproduct.InvoiceProduct;
            }
            return null;
        }

        private PayrollProduct GetPayrollProductFromTimeCode(CompEntities entities, int timeCodeId, int actorCompanyId)
        {
            TimeCode timecode = TimeCodeManager.GetTimeCodeWithPayrollProducts(entities, timeCodeId, actorCompanyId);
            return timecode?.TimeCodePayrollProduct?.FirstOrDefault()?.PayrollProduct;
        }

        #endregion

        #region EDI/Scanning

        public DataSet CreateSymbrioEdiData(SymbrioEdiItem item)
        {
            XDocument xdoc = CreateSymbrioEdiDataDocument(item);
            return ReportGenManager.CreateDataSet(xdoc, SoeReportTemplateType.SymbrioEdiSupplierInvoice);
        }

        public XDocument CreateSymbrioEdiDataDocument(SymbrioEdiItem item)
        {
            #region Prereq

            if (item == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument(Constants.ENCODING_LATIN1);

            //Root
            XElement rootElement = new XElement("Message");

            #endregion

            #region Content

            XElement messageInfoElement = new XElement("MessageInfo",
                new XElement("MessageSenderId", item.MessageSenderId),
                new XElement("MessageType", item.MessageType),
                new XElement("MessageDate", item.MessageDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("MessageImageFileName", item.MessageImageFileName),
                new XElement("MessageCultureInfo", CultureInfo.CurrentCulture.Name));
            rootElement.Add(messageInfoElement);

            XElement sellerElement = new XElement("Seller",
                new XElement("SellerId", item.SellerId),
                new XElement("SellerOrganisationNumber", item.SellerOrganisationNumber),
                new XElement("SellerVatNumber", item.SellerVatNumber),
                new XElement("SellerName", item.SellerName),
                new XElement("SellerAddress", item.SellerAddress),
                new XElement("SellerPostalCode", item.SellerPostalCode),
                new XElement("SellerPostalAddress", item.SellerPostalAddress),
                new XElement("SellerCountryCode", item.SellerCountryCode),
                new XElement("SellerPhone", item.SellerPhone),
                new XElement("SellerFax", item.SellerFax),
                new XElement("SellerReference", item.SellerReference),
                new XElement("SellerReferencePhone", item.SellerReferencePhone));
            rootElement.Add(sellerElement);

            XElement buyerElement = new XElement("Buyer",
                new XElement("BuyerId", item.BuyerId),
                new XElement("BuyerOrganisationNumber", item.BuyerOrganisationNumber),
                new XElement("BuyerVatNumber", item.BuyerVatNumber),
                new XElement("BuyerName", item.BuyerName),
                new XElement("BuyerAddress", item.BuyerAddress),
                new XElement("BuyerPostalCode", item.BuyerPostalCode),
                new XElement("BuyerPostalAddress", item.BuyerPostalAddress),
                new XElement("BuyerCountryCode", item.BuyerCountryCode),
                new XElement("BuyerReference", item.BuyerReference),
                new XElement("BuyerPhone", item.BuyerPhone),
                new XElement("BuyerFax", item.BuyerFax),
                new XElement("BuyerEmailAddress", item.BuyerEmailAddress),
                new XElement("BuyerDeliveryName", item.BuyerDeliveryName),
                new XElement("BuyerDeliveryCoAddress", item.BuyerDeliveryCoAddress),
                new XElement("BuyerDeliveryAddress", item.BuyerDeliveryAddress),
                new XElement("BuyerDeliveryPostalCode", item.BuyerDeliveryPostalCode),
                new XElement("BuyerDeliveryPostalAddress", item.BuyerDeliveryPostalAddress),
                new XElement("BuyerDeliveryCountryCode", item.BuyerDeliveryCountryCode),
                new XElement("BuyerDeliveryNoteText", item.BuyerDeliveryNoteText),
                new XElement("BuyerDeliveryGoodsMarking", item.BuyerDeliveryGoodsMarking));
            rootElement.Add(buyerElement);

            XElement headElement = new XElement("Head",
                new XElement("HeadInvoiceNumber", item.HeadInvoiceNumber),
                new XElement("HeadInvoiceOcr", item.HeadInvoiceOcr),
                new XElement("HeadInvoiceType", item.HeadInvoiceType),
                new XElement("HeadInvoiceDate", item.HeadInvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("HeadInvoiceDueDate", item.HeadInvoiceDueDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("HeadDeliveryDate", item.HeadDeliveryDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("HeadBuyerOrderNumber", item.HeadBuyerOrderNumber),
                new XElement("HeadBuyerProjectNumber", item.HeadBuyerProjectNumber),
                new XElement("HeadBuyerInstallationNumber", item.HeadBuyerInstallationNumber),
                new XElement("HeadSellerOrderNumber", item.HeadSellerOrderNumber),
                new XElement("HeadPostalGiro", item.HeadPostalGiro),
                new XElement("HeadBankGiro", item.HeadBankGiro),
                new XElement("HeadBank", item.HeadBank),
                new XElement("HeadBicAddress", item.HeadBicAddress),
                new XElement("HeadIbanNumber", item.HeadIbanNumber),
                new XElement("HeadCurrencyCode", item.HeadCurrencyCode),
                new XElement("HeadVatPercentage", item.HeadVatPercentage),
                new XElement("HeadPaymentConditionDays", item.HeadPaymentConditionDays),
                new XElement("HeadPaymentConditionText", item.HeadPaymentConditionText),
                new XElement("HeadInterestPaymentPercent", item.HeadInterestPaymentPercent),
                new XElement("HeadInterestPaymentText", item.HeadInterestPaymentText),
                new XElement("HeadInvoiceGrossAmount", item.HeadInvoiceGrossAmount),
                new XElement("HeadInvoiceNetAmount", item.HeadInvoiceNetAmount),
                new XElement("HeadVatBasisAmount", item.HeadVatBasisAmount),
                new XElement("HeadVatAmount", item.HeadVatAmount),
                new XElement("HeadFreightFeeAmount", item.HeadFreightFeeAmount),
                new XElement("HeadHandlingChargeFeeAmount", item.HeadHandlingChargeFeeAmount),
                new XElement("HeadInsuranceFeeAmount", item.HeadInsuranceFeeAmount),
                new XElement("HeadRemainingFeeAmount", item.HeadRemainingFeeAmount),
                new XElement("HeadDiscountAmount", item.HeadDiscountAmount),
                new XElement("HeadRoundingAmount", item.HeadRoundingAmount),
                new XElement("HeadInvoiceArrival", item.HeadInvoiceArrival),
                new XElement("HeadInvoiceAuthorized", item.HeadInvoiceAuthorized.ToInt()),
                new XElement("HeadInvoiceAuthorizedBy", item.HeadInvoiceAuthorizedBy),
                new XElement("HeadInvoiceTaxText", item.HeadInvoiceTaxText));
            rootElement.Add(headElement);

            XElement labelElement = new XElement("Labels",
                new XElement("LabelMessageType", GetReportText(600, "Order")),
                new XElement("LabelNumber", GetReportText(601, "Nummer")),
                new XElement("LabelDate", GetReportText(602, "Datum")),
                new XElement("LabelDeliveryDate", GetReportText(603, "LeveransDatum")),
                new XElement("LabelDueDate", GetReportText(604, "Förfallodatum")),
                new XElement("LabelOCR", GetReportText(605, "OCR")),
                new XElement("LabelDeliveryAddress", GetReportText(606, "Leveransadress")),
                new XElement("LabelSellersOrderNumber", GetReportText(607, "Säljarens ordernr:")),
                new XElement("LabelYourReference", GetReportText(608, "Er Referens:")),
                new XElement("LabelYourOrderNumber", GetReportText(609, "Ert ordernr:")),
                new XElement("LabelOurReference", GetReportText(610, "Vår Referens:")),
                new XElement("LabelProjectNumber", GetReportText(611, "Projektnummer")),
                new XElement("LabelInstallationNumber", GetReportText(612, "Installationsnr:")),
                new XElement("LabelDiscount", GetReportText(613, "Rabatt:")),
                new XElement("LabelOrganizationNumber", GetReportText(614, "Orgnr")),
                new XElement("LabelProductNumber", GetReportText(619, "Artnr")),
                new XElement("LabelProductName", GetReportText(620, "Artikelnamn")),
                new XElement("LabelAmount", GetReportText(621, "Antal")),
                new XElement("LabelUnitPrice", GetReportText(622, "Pris")),
                new XElement("LabelVAT", GetReportText(623, "Moms")),
                new XElement("LabelRowDiscount", GetReportText(624, "Rabatt")),
                new XElement("LabelRowSum", GetReportText(625, "Belopp")),
                new XElement("LabelRowDeliveryDate", GetReportText(626, "Leverans Datum")),
                new XElement("LabelFeeAmount", GetReportText(627, "Fakturaavgift")),
                new XElement("LabelFreightAmount", GetReportText(628, "Frakt")),
                new XElement("LabelVATAmount", GetReportText(629, "Moms")),
                new XElement("LabelCurrencyCode", GetReportText(630, "Valuta")),
                new XElement("LabelRowDiscountPercent", GetReportText(631, "Rabatt")),
                new XElement("LabelTotalGrossAmount", GetReportText(632, "Totalbelopp")),
                new XElement("LabelSellerOrganizationNumber", GetReportText(1112, "Organisationsnr")),
                new XElement("LabelSellerVatNumber", GetReportText(634, "Momsnr")),
                new XElement("LabelHeadpostalGiro", GetReportText(635, "Postgiro")),
                new XElement("LabelHeadBankGiro", GetReportText(636, "Bankgiro")),
                new XElement("LabelHeadBankNumber", GetReportText(637, "IBAN")),
                new XElement("LabelSellerPhone", GetReportText(638, "Telefon")),
                new XElement("LabelSellerFax", GetReportText(639, "Fax")),
                new XElement("LabelSellerAddress", GetReportText(641, "Adress")),
                new XElement("LabelPoweredBySoftOne", GetReportText(642, "PoweredBySoftOne")));

            rootElement.Add(labelElement);

            int rowId = 1;
            foreach (var row in item.Rows)
            {
                XElement rowElement = new XElement("Row",
                    new XAttribute("id", rowId),
                    new XElement("RowSellerArticleNumber", row.RowSellerArticleNumber),
                    new XElement("RowSellerArticleDescription1", row.RowSellerArticleDescription1),
                    new XElement("RowSellerArticleDescription2", row.RowSellerArticleDescription2),
                    new XElement("RowSellerRowNumber", row.RowSellerRowNumber),
                    new XElement("RowBuyerArticleNumber", row.RowBuyerArticleNumber),
                    new XElement("RowBuyerRowNumber", row.RowBuyerRowNumber),
                    new XElement("RowDeliveryDate", row.RowDeliveryDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("RowBuyerReference", row.RowBuyerReference),
                    new XElement("RowBuyerObjectId", row.RowBuyerObjectId),
                    new XElement("RowQuantity", row.RowQuantity),
                    new XElement("RowUnitCode", row.RowUnitCode),
                    new XElement("RowUnitPrice", row.RowUnitPrice),
                    new XElement("RowDiscountPercent", row.RowDiscountPercent),
                    new XElement("RowNetAmount", row.RowNetAmount),
                    new XElement("RowVatAmount", row.RowVatAmount),
                    new XElement("RowVatPercentage", row.RowVatPercentage));
                rootElement.Add(rowElement);
                rowId++;
            }

            int accountCodeXmlId = 1;
            foreach (var accountCode in item.AccountCodes)
            {
                XElement accountCodeElement = new XElement("AccountCode",
                    new XAttribute("id", accountCodeXmlId),
                    new XElement("AccountCodeAccount", accountCode.AccountCodeAccount),
                    new XElement("AccountCodeCostCentre", accountCode.AccountCodeCostCentre),
                    new XElement("AccountCodeProject", accountCode.AccountCodeProject),
                    new XElement("AccountCodeBalance", accountCode.AccountCodeBalance),
                    new XElement("AccountCodeQuantity", accountCode.AccountCodeQuantity),
                    new XElement("AccountCodeText", accountCode.AccountCodeText));
                rootElement.Add(accountCodeElement);
                accountCodeXmlId++;
            }

            #endregion

            #region Close document

            document.Add(rootElement);

            return document;

            #endregion
        }

        public DataSet CreateReadSoftScanningData(ReadSoftScanningItem item)
        {
            XDocument xdoc = CreateReadSoftScanningDataDocument(item);
            return ReportGenManager.CreateDataSet(xdoc, SoeReportTemplateType.ReadSoftScanningSupplierInvoice);
        }

        public XDocument CreateReadSoftScanningDataDocument(ReadSoftScanningItem item)
        {
            #region Prereq

            if (item == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument(Constants.ENCODING_LATIN1);

            //Root
            XElement rootElement = new XElement("Document");

            #endregion

            #region Content

            rootElement.Add(new XElement("Id", item.DocumentId));
            rootElement.Add(new XElement("Version", String.Empty));
            rootElement.Add(new XElement("Type", item.Type));
            rootElement.Add(new XElement("OriginalFileName", item.OriginalFileName));

            XElement partiesElement = new XElement("Parties");
            foreach (var party in item.Parties)
            {
                XElement partyElement = new XElement("Party",
                    new XElement("Type", party.Type),
                    new XElement("Name", party.Name),
                    new XElement("Id", party.Id),
                    new XElement("ExternalId", party.ExternalId));
                partiesElement.Add(partyElement);
            }
            rootElement.Add(partiesElement);

            XElement headerFieldsElement = new XElement("HeaderFields");
            foreach (var headerField in item.HeaderFields)
            {
                XElement headerFieldElement = new XElement("HeaderField",
                    new XElement("Name", headerField.Name),
                    new XElement("Type", headerField.Type),
                    new XElement("Format", headerField.Format),
                    new XElement("Text", headerField.Text),
                    new XElement("ValidationError", headerField.ValidationError),
                    new XElement("Position", headerField.Position),
                    new XElement("PageNumber", headerField.PageNumber));
                headerFieldsElement.Add(headerFieldElement);
            }
            rootElement.Add(headerFieldsElement);

            XElement historiesElement = new XElement("History");
            foreach (var history in item.Histories)
            {
                XElement historyElement = new XElement("Item",
                    new XElement("TimeStamp", history.TimeStamp),
                    new XElement("UserFullName", history.UserFullName),
                    new XElement("Status", history.Status),
                    new XElement("Comment", history.Comment),
                    new XElement("EntryType", history.EntryType),
                    new XElement("Changes", history.Changes));
                historiesElement.Add(historyElement);
            }
            rootElement.Add(historiesElement);

            #endregion

            #region Close document

            document.Add(rootElement);

            return document;

            #endregion
        }

        public DataSet CreateFinvoiceEdiData(FinvoiceEdiItem item)
        {
            XDocument xdoc = CreateFinvoiceEdiDataDocument(item);
            return ReportGenManager.CreateDataSet(xdoc, SoeReportTemplateType.FinvoiceEdiSupplierInvoice);
        }

        public XDocument CreateFinvoiceEdiDataDocument(FinvoiceEdiItem item)
        {
            #region Prereq

            if (item == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument(Constants.ENCODING_LATIN1);

            //Root
            XElement rootElement = new XElement("Message");

            #endregion

            #region Content

            XElement messageInfoElement = new XElement("MessageInfo",
                new XElement("MessageSenderId", item.MessageSenderId),
                new XElement("MessageType", item.MessageType),
                new XElement("MessageDate", item.MessageDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("MessageImageFileName", item.MessageImageFileName),
                new XElement("MessageCultureInfo", CultureInfo.CurrentCulture.Name));
            rootElement.Add(messageInfoElement);

            XElement sellerElement = new XElement("Seller",
                new XElement("SellerId", item.SellerId),
                new XElement("SellerOrganisationNumber", item.SellerOrganisationNumber),
                new XElement("SellerVatNumber", item.SellerVatNumber),
                new XElement("SellerName", item.SellerName),
                new XElement("SellerAddress", item.SellerAddress),
                new XElement("SellerPostalCode", item.SellerPostalCode),
                new XElement("SellerPostalAddress", item.SellerPostalAddress),
                new XElement("SellerCountryCode", item.SellerCountryCode),
                new XElement("SellerPhone", item.SellerPhone),
                new XElement("SellerFax", item.SellerFax),
                new XElement("SellerReference", item.SellerReference),
                new XElement("SellerReferencePhone", item.SellerReferencePhone));
            rootElement.Add(sellerElement);

            XElement buyerElement = new XElement("Buyer",
                new XElement("BuyerId", item.BuyerId),
                new XElement("BuyerOrganisationNumber", item.BuyerOrganisationNumber),
                new XElement("BuyerVatNumber", item.BuyerVatNumber),
                new XElement("BuyerName", item.BuyerName),
                new XElement("BuyerAddress", item.BuyerAddress),
                new XElement("BuyerPostalCode", item.BuyerPostalCode),
                new XElement("BuyerPostalAddress", item.BuyerPostalAddress),
                new XElement("BuyerCountryCode", item.BuyerCountryCode),
                new XElement("BuyerReference", item.BuyerReference),
                new XElement("BuyerPhone", item.BuyerPhone),
                new XElement("BuyerFax", item.BuyerFax),
                new XElement("BuyerEmailAddress", item.BuyerEmailAddress),
                new XElement("BuyerDeliveryName", item.BuyerDeliveryName),
                new XElement("BuyerDeliveryCoAddress", item.BuyerDeliveryCoAddress),
                new XElement("BuyerDeliveryAddress", item.BuyerDeliveryAddress),
                new XElement("BuyerDeliveryPostalCode", item.BuyerDeliveryPostalCode),
                new XElement("BuyerDeliveryPostalAddress", item.BuyerDeliveryPostalAddress),
                new XElement("BuyerDeliveryCountryCode", item.BuyerDeliveryCountryCode),
                new XElement("BuyerDeliveryNoteText", item.BuyerDeliveryNoteText),
                new XElement("BuyerDeliveryGoodsMarking", item.BuyerDeliveryGoodsMarking));
            rootElement.Add(buyerElement);

            XElement headElement = new XElement("Head",
                new XElement("HeadInvoiceNumber", item.HeadInvoiceNumber),
                new XElement("HeadInvoiceOcr", item.HeadInvoiceOcr),
                new XElement("HeadInvoiceType", item.HeadInvoiceType),
                new XElement("HeadInvoiceDate", item.HeadInvoiceDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("HeadInvoiceDueDate", item.HeadInvoiceDueDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("HeadDeliveryDate", item.HeadDeliveryDate ?? CalendarUtility.DATETIME_DEFAULT),
                new XElement("HeadBuyerOrderNumber", item.HeadBuyerOrderNumber),
                new XElement("HeadBuyerProjectNumber", item.HeadBuyerProjectNumber),
                new XElement("HeadBuyerInstallationNumber", item.HeadBuyerInstallationNumber),
                new XElement("HeadSellerOrderNumber", item.HeadSellerOrderNumber),
                new XElement("HeadPostalGiro", item.HeadPostalGiro),
                new XElement("HeadBankGiro", item.HeadBankGiro),
                new XElement("HeadBank", item.HeadBank),
                new XElement("HeadBicAddress", item.HeadBicAddress),
                new XElement("HeadIbanNumber", item.HeadIbanNumber),
                new XElement("HeadCurrencyCode", item.HeadCurrencyCode),
                new XElement("HeadVatPercentage", item.HeadVatPercentage),
                new XElement("HeadPaymentConditionDays", item.HeadPaymentConditionDays),
                new XElement("HeadPaymentConditionText", item.HeadPaymentConditionText),
                new XElement("HeadInterestPaymentPercent", item.HeadInterestPaymentPercent),
                new XElement("HeadInterestPaymentText", item.HeadInterestPaymentText),
                new XElement("HeadInvoiceGrossAmount", item.HeadInvoiceGrossAmount),
                new XElement("HeadInvoiceNetAmount", item.HeadInvoiceNetAmount),
                new XElement("HeadVatBasisAmount", item.HeadVatBasisAmount),
                new XElement("HeadVatAmount", item.HeadVatAmount),
                new XElement("HeadFreightFeeAmount", item.HeadFreightFeeAmount),
                new XElement("HeadHandlingChargeFeeAmount", item.HeadHandlingChargeFeeAmount),
                new XElement("HeadInsuranceFeeAmount", item.HeadInsuranceFeeAmount),
                new XElement("HeadRemainingFeeAmount", item.HeadRemainingFeeAmount),
                new XElement("HeadDiscountAmount", item.HeadDiscountAmount),
                new XElement("HeadRoundingAmount", item.HeadRoundingAmount),
                new XElement("HeadInvoiceArrival", item.HeadInvoiceArrival),
                new XElement("HeadInvoiceAuthorized", item.HeadInvoiceAuthorized.ToInt()),
                new XElement("HeadInvoiceAuthorizedBy", item.HeadInvoiceAuthorizedBy));
            rootElement.Add(headElement);

            XElement labelElement = new XElement("Labels",
                new XElement("LabelMessageType", GetReportText(600, "Order")),
                new XElement("LabelNumber", GetReportText(601, "Nummer")),
                new XElement("LabelDate", GetReportText(602, "Datum")),
                new XElement("LabelDeliveryDate", GetReportText(603, "LeveransDatum")),
                new XElement("LabelDueDate", GetReportText(604, "Förfallodatum")),
                new XElement("LabelOCR", GetReportText(605, "OCR")),
                new XElement("LabelDeliveryAddress", GetReportText(606, "Leveransadress")),
                new XElement("LabelSellersOrderNumber", GetReportText(607, "Säljarens ordernr:")),
                new XElement("LabelYourReference", GetReportText(608, "Er Referens:")),
                new XElement("LabelYourOrderNumber", GetReportText(609, "Ert ordernr:")),
                new XElement("LabelOurReference", GetReportText(610, "Vår Referens:")),
                new XElement("LabelProjectNumber", GetReportText(611, "Projektnummer")),
                new XElement("LabelInstallationNumber", GetReportText(612, "Installationsnr:")),
                new XElement("LabelDiscount", GetReportText(613, "Rabatt:")),
                new XElement("LabelOrganizationNumber", GetReportText(614, "Orgnr")),
                new XElement("LabelProductNumber", GetReportText(619, "Artnr")),
                new XElement("LabelProductName", GetReportText(620, "Artikelnamn")),
                new XElement("LabelAmount", GetReportText(621, "Antal")),
                new XElement("LabelUnitPrice", GetReportText(622, "Pris")),
                new XElement("LabelVAT", GetReportText(623, "Moms")),
                new XElement("LabelRowDiscount", GetReportText(624, "Rabatt")),
                new XElement("LabelRowSum", GetReportText(625, "Belopp")),
                new XElement("LabelRowDeliveryDate", GetReportText(626, "Leverans Datum")),
                new XElement("LabelFeeAmount", GetReportText(627, "Fakturaavgift")),
                new XElement("LabelFreightAmount", GetReportText(628, "Frakt")),
                new XElement("LabelVATAmount", GetReportText(629, "Moms")),
                new XElement("LabelCurrencyCode", GetReportText(630, "Valuta")),
                new XElement("LabelRowDiscountPercent", GetReportText(631, "Rabatt")),
                new XElement("LabelTotalGrossAmount", GetReportText(632, "Totalbelopp")),
                new XElement("LabelSellerOrganizationNumber", GetReportText(633, "Organisationsnr")),
                new XElement("LabelSellerVatNumber", GetReportText(634, "Momsnr")),
                new XElement("LabelHeadpostalGiro", GetReportText(635, "Postgiro")),
                new XElement("LabelHeadBankGiro", GetReportText(636, "Bankgiro")),
                new XElement("LabelHeadBankNumber", GetReportText(637, "IBAN")),
                new XElement("LabelSellerPhone", GetReportText(638, "Telefon")),
                new XElement("LabelSellerFax", GetReportText(639, "Fax")),
                new XElement("LabelSellerAddress", GetReportText(641, "Adress")),
                new XElement("LabelPoweredBySoftOne", GetReportText(642, "PoweredBySoftOne")));

            rootElement.Add(labelElement);

            int rowId = 1;
            foreach (var row in item.Rows)
            {
                XElement rowElement = new XElement("Row",
                    new XAttribute("id", rowId),
                    new XElement("RowSellerArticleNumber", row.RowSellerArticleNumber),
                    new XElement("RowSellerArticleDescription1", row.RowSellerArticleDescription1),
                    new XElement("RowSellerArticleDescription2", row.RowSellerArticleDescription2),
                    new XElement("RowSellerRowNumber", row.RowSellerRowNumber),
                    new XElement("RowBuyerArticleNumber", row.RowBuyerArticleNumber),
                    new XElement("RowBuyerRowNumber", row.RowBuyerRowNumber),
                    new XElement("RowDeliveryDate", row.RowDeliveryDate ?? CalendarUtility.DATETIME_DEFAULT),
                    new XElement("RowBuyerReference", row.RowBuyerReference),
                    new XElement("RowBuyerObjectId", row.RowBuyerObjectId),
                    new XElement("RowQuantity", row.RowQuantity),
                    new XElement("RowUnitCode", row.RowUnitCode),
                    new XElement("RowUnitPrice", row.RowUnitPrice),
                    new XElement("RowDiscountPercent", row.RowDiscountPercent),
                    new XElement("RowNetAmount", row.RowNetAmount),
                    new XElement("RowVatAmount", row.RowVatAmount),
                    new XElement("RowVatPercentage", row.RowVatPercentage));
                rootElement.Add(rowElement);
                rowId++;
            }


            #endregion

            #region Close document

            document.Add(rootElement);

            return document;

            #endregion
        }

        #endregion

        #region Time (TODO)

        private XDocument CreateUserListReportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;
            if (es.ST_EmployeeXml == null)
                return null;

            Company company = CompanyManager.GetCompany(es.ActorCompanyId, loadLicense: true);
            if (company == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "UserReport");

            //TimeStampEntryReport
            XElement userReportElement = new XElement("UserReport");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement =
                    new XElement("ReportHeaderLabels",
                    new XElement("LoginNameLabel", GetReportText(24, "Användare:")),
                    new XElement("PageLabel", GetReportText(4, "Sida:")),
                    new XElement("DateLabel", GetReportText(5, "Datum:")),
                    new XElement("TimeLabel", GetReportText(6, "Tid:")));
            userReportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = new XElement("ReportHeader",
                    new XElement("ReportTitle", es.ReportName),
                    new XElement("ReportDescription", es.ReportDescription),
                    new XElement("ReportNr", es.ReportNr.ToString()),
                    this.CreateCompanyElement(),
                    this.CreateCompanyOrgNrElement());
            userReportElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels",
                new XElement("UserNrLabel", GetReportText(151, "Anst.nr:")),
                new XElement("UserPasswordLabel", GetReportText(562, "Lösenord:")),
                new XElement("UserNameLabel", GetReportText(563, "Användarnamn:")),
                new XElement("UserEmailLabel", GetReportText(564, "Epost:")),
                new XElement("UserCompanyLabel", GetReportText(565, "Företag:")));
            userReportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            int userXmlId = 1;

            XDocument xdoc = XDocument.Parse(es.ST_EmployeeXml);
            if (xdoc != null)
            {
                XElement inputRootElement = xdoc.Elements(TimeUsersListReportDTO.ROOT_TAG).FirstOrDefault();
                if (inputRootElement != null)
                {
                    foreach (XElement inputUserElement in inputRootElement.Elements(TimeUsersListReportDTO.USER_TAG))
                    {
                        XElement employeeNrElement = inputUserElement.Elements(TimeUsersListReportDTO.EMPLOYEENR_TAG).FirstOrDefault();
                        XElement firstNameElement = inputUserElement.Elements(TimeUsersListReportDTO.FIRSTNAME_TAG).FirstOrDefault();
                        XElement lastNameElement = inputUserElement.Elements(TimeUsersListReportDTO.LASTNAME_TAG).FirstOrDefault();
                        XElement loginNameElement = inputUserElement.Elements(TimeUsersListReportDTO.LOGINNAME_TAG).FirstOrDefault();
                        XElement emailElement = inputUserElement.Elements(TimeUsersListReportDTO.EMAIL_TAG).FirstOrDefault();

                        XElement userElement = new XElement("User",
                                    new XAttribute("id", userXmlId),
                                    new XElement("UserNr", StringUtility.NullToEmpty(employeeNrElement.Value)),
                                    new XElement("UserPassword", String.Empty),
                                    new XElement("UserName", loginNameElement != null ? loginNameElement.Value : String.Empty),
                                    new XElement("UserEmail", emailElement != null ? StringUtility.NullToEmpty(emailElement.Value) : String.Empty),
                                    new XElement("UserCompany", company != null ? StringUtility.NullToEmpty(company.Name) : String.Empty),
                                    new XElement("UserLicense", company != null && company.License != null ? StringUtility.NullToEmpty(company.License.Name) : String.Empty));

                        userReportElement.Add(userElement);
                        userXmlId++;
                    }
                }
            }

            #endregion

            #region Close document

            rootElement.Add(userReportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.UserListReport);

            #endregion
        }

        private XDocument CreateTimeSalarySpecificationReportData(EvaluatedSelection es, out bool authorized)
        {
            #region Prereq

            //Default
            authorized = true;

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TimeSalarySpecificationReport");

            //TimeSalarySpecificationReport
            XElement timeSalarySpecificationElement = null;

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                if (!es.ST_DataStorageId.HasValue)
                    return null;

                DataStorage dataStorage = ReportManager.GetDataStorage(entities, es.ST_DataStorageId.Value);
                if (dataStorage == null || dataStorage.XML == null)
                    return null;

                Employee employee = EmployeeManager.GetEmployeeForUser(es.UserId, es.ActorCompanyId);
                if (employee == null || employee.EmployeeId != dataStorage.EmployeeId)
                {
                    //Can only show own salary specifications
                    authorized = false;
                    return null;
                }

                #endregion

                #region Content

                XDocument originalDocument = XDocument.Parse(dataStorage.XML);
                if (originalDocument == null)
                    return null;

                timeSalarySpecificationElement = originalDocument.Root;

                #endregion
            }

            #region Close document

            rootElement.Add(timeSalarySpecificationElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.TimeSalarySpecificationReport);

            #endregion

            #endregion
        }

        private XDocument CreateTimeSalaryControlInfoReportData(EvaluatedSelection es, out bool authorized)
        {
            #region Prereq

            //Default
            authorized = true;

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "TimeSalaryControlInfoReport");

            //TimeSalarySpecificationReport
            XElement timeSalaryControlInfoElement = null;

            #endregion

            #region Content

            using (CompEntities entities = new CompEntities())
            {
                #region Prereq

                if (!es.ST_DataStorageId.HasValue)
                    return null;

                DataStorage dataStorage = ReportManager.GetDataStorage(entities, es.ST_DataStorageId.Value);
                if (dataStorage == null || dataStorage.XML == null)
                    return null;

                Employee employee = EmployeeManager.GetEmployeeForUser(es.UserId, es.ActorCompanyId);
                if (employee == null || employee.EmployeeId != dataStorage.EmployeeId)
                {
                    //Can only show own salary specifications
                    authorized = false;
                    return null;
                }

                #endregion

                #region Content

                XDocument originalDocument = XDocument.Parse(dataStorage.XML);
                if (originalDocument == null)
                    return null;

                timeSalaryControlInfoElement = originalDocument.Root;

                #endregion
            }

            #region Close document

            rootElement.Add(timeSalaryControlInfoElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.TimeSalaryControlInfoReport);

            #endregion

            #endregion
        }

        #endregion

        #region Import

        private XDocument CreateIOVoucherData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            List<AccountYear> accountYears = AccountManager.GetAccountYears(es.ActorCompanyId, false, false);
            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId, true);
            List<AccountDimDTO> accountDimInternalsDTOs = accountDimInternals.ToDTOs();
            List<AccountStd> accountStds = AccountManager.GetAccountStdsByCompany(es.ActorCompanyId, true, false, false);
            List<AccountInternal> accountInternals = AccountManager.GetAccountInternals(es.ActorCompanyId, true);
            List<VoucherHeadIO> voucherHeadIOs = ImportExportManager.GetVoucherHeadIOResult(es.ActorCompanyId, es.SI_VoucherHeadIOIds);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "IOVoucherList");

            //VoucherList
            XElement ioVoucherListElement = new XElement("IOVoucherList");

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateAccountingReportHeaderLabelsElement();
            reportHeaderLabelsElement.Add(CreateLatestVoucherLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateAccountIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateVoucherSerieIntervalLabelReportHeaderLabelsElement());
            reportHeaderLabelsElement.Add(CreateDateIntervalLabelReportHeaderLabelsElement());
            CreateAccountingOrderReportHeaderLabelsElement(reportHeaderLabelsElement);
            CreateEnterpriseCurrencyReportHeaderLabelsElement(reportHeaderLabelsElement);
            ioVoucherListElement.Add(reportHeaderLabelsElement);

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateAccountingReportHeaderElement(es);
            reportHeaderElement.Add(CreateLatestVoucherElement(es));
            reportHeaderElement.Add(CreateAccountIntervalElement(es, accountDimInternalsDTOs));
            reportHeaderElement.Add(CreateVoucherIntervalElement(es));
            reportHeaderElement.Add(CreateVoucherSerieIntervalElement(es));
            reportHeaderElement.Add(CreateDateIntervalElement(es));
            ioVoucherListElement.Add(reportHeaderElement);

            #endregion

            #region PageHeaderLabels

            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            this.AddAccountDimPageHeaderLabelElements(pageHeaderLabelsElement, accountDimStd, accountDimInternals);
            CreateVoucherListPageHeaderLabelsElement(pageHeaderLabelsElement);
            ioVoucherListElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            XElement voucherHeadIOElement = null;
            List<XElement> voucherHeadIOElements = new List<XElement>();

            int voucherHeadIOXmlId = 1;
            foreach (var voucherHeadIO in voucherHeadIOs)
            {
                #region VoucherHead

                #region Prereq

                AccountYear accountYear = null;
                if (voucherHeadIO.AccountYearId != 0)
                    accountYear = accountYears.FirstOrDefault(i => i.AccountYearId == voucherHeadIO.AccountYearId);

                VoucherSeries voucherSeries = null;
                VoucherSeriesType voucherSeriesType = null;
                if (voucherHeadIO.VoucherSeriesId != 0)
                {
                    voucherSeries = VoucherManager.GetVoucherSerie(voucherHeadIO.VoucherSeriesId, es.ActorCompanyId, true);
                    if (voucherSeries != null)
                        voucherSeriesType = voucherSeries.VoucherSeriesType;
                }
                else if (voucherHeadIO.VoucherSeriesTypeNr != null && voucherHeadIO.VoucherSeriesTypeNr != -1 && voucherHeadIO.VoucherSeriesId == 0)
                {
                    if (accountYear == null && voucherHeadIO.Date != null)
                        accountYear = AccountManager.GetAccountYear(voucherHeadIO.Date, voucherHeadIO.ActorCompanyId, false);

                    voucherSeries = VoucherManager.GetVoucherSerieByTypeNr((int)voucherHeadIO.VoucherSeriesTypeNr, accountYear.AccountYearId);
                    if (voucherSeries != null)
                        voucherSeriesType = voucherSeries.VoucherSeriesType;
                }

                #endregion

                #region VoucherHeadIO element

                voucherHeadIOElement = new XElement("VoucherHeadIO",
                    new XAttribute("Id", voucherHeadIOXmlId),
                    new XElement("VoucherBatchdId", voucherHeadIO.BatchId),
                    new XElement("VoucherDate", voucherHeadIO.Date.ToShortDateString()),
                    new XElement("VoucherVoucherNr", voucherHeadIO.VoucherNr.NullToEmpty()),
                    new XElement("VoucherText", voucherHeadIO.Text.NullToEmpty()),
                    new XElement("VoucherNote", voucherHeadIO.Note.NullToEmpty()),
                    new XElement("VoucherErrorMessage", voucherHeadIO.ErrorMessage.NullToEmpty()),
                    new XElement("isVATVoucher", voucherHeadIO.IsVatVoucher.ToInt()),
                    new XElement("AccountYearFrom", accountYear?.From.ToShortDateString() ?? string.Empty),
                    new XElement("AccountYearTo", accountYear?.To.ToShortDateString() ?? string.Empty),
                    new XElement("AccountYearStatusText", accountYear?.StatusText ?? string.Empty),
                    new XElement("VoucherSeriesType", voucherSeriesType?.Name ?? string.Empty));

                #endregion

                int voucherRowIOXMLId = 0;
                if (!voucherHeadIO.VoucherRowIO.IsNullOrEmpty())
                {
                    foreach (var voucherRowIO in voucherHeadIO.VoucherRowIO)
                    {
                        #region VoucherRowIO element

                        voucherRowIOXMLId++;

                        XElement voucherRowIOElement = new XElement("VoucherRowIO",
                            new XAttribute("Id", voucherRowIOXMLId),
                            new XElement("VoucherBatchdId", voucherHeadIO.BatchId),
                            new XElement("VoucherRowText", voucherRowIO.Text.NullToEmpty()),
                            new XElement("VoucherRowAmount", voucherRowIO.Amount ?? 0),
                            new XElement("VoucherRowQuantity", voucherRowIO.Quantity ?? 0),
                            new XElement("VoucherRowAccountNr", voucherRowIO.AccountNr.NullToEmpty()),
                            new XElement("VoucherRowAccountName", accountStds?.FirstOrDefault(a => a.Account?.AccountNr == voucherRowIO.AccountNr)?.Account?.Name ?? "Account not found"),
                            new XElement("VoucherRowAccountDim2Nr", voucherRowIO.AccountDim2Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim3Nr", voucherRowIO.AccountDim3Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim4Nr", voucherRowIO.AccountDim4Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim5Nr", voucherRowIO.AccountDim5Nr.NullToEmpty()),
                            new XElement("VoucherRowAccountDim6Nr", voucherRowIO.AccountDim6Nr.NullToEmpty()),
                            new XElement("VoucherRowDebetAmount", voucherRowIO.DebetAmount ?? 0),
                            new XElement("VoucherRowCreditAmount", voucherRowIO.CreditAmount ?? 0),
                            new XElement("VoucherRowErrorMessage", voucherRowIO.ErrorMessage.NullToEmpty()));

                        List<string> voucherRowErrorMessageDetails = new List<string>();

                        if (!accountStds.Any(a => a.Account.AccountNr == voucherRowIO.AccountNr))
                            voucherRowErrorMessageDetails.Add($"AccountNr not found: {voucherRowIO.AccountNr}");

                        int accountDimNr = 2;
                        foreach (AccountDim dim in accountDimInternals.Where(i => i.AccountDimNr != Constants.ACCOUNTDIM_STANDARD).OrderBy(i => i.AccountDimNr))
                        {
                            if (accountDimNr == 2 && !voucherRowIO.AccountDim2Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim2Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim2Nr}");
                            else if (accountDimNr == 3 && !voucherRowIO.AccountDim3Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim3Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim3Nr}");
                            else if (accountDimNr == 4 && !voucherRowIO.AccountDim4Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim4Nr.NullToEmpty()))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim4Nr}");
                            else if (accountDimNr == 5 && !voucherRowIO.AccountDim5Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim5Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim5Nr}");
                            else if (accountDimNr == 6 && !voucherRowIO.AccountDim6Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == voucherRowIO.AccountDim6Nr))
                                voucherRowErrorMessageDetails.Add($"{dim.Name} not found: {voucherRowIO.AccountDim6Nr}");

                            accountDimNr++;
                        }

                        voucherRowIOElement.Add(
                            new XElement("VoucherRowErrorMessageDetails", voucherRowErrorMessageDetails.ToCommaSeparated()));

                        voucherHeadIOElement.Add(voucherRowIOElement);

                        #endregion
                    }
                }

                voucherHeadIOElements.Add(voucherHeadIOElement);
                voucherHeadIOXmlId++;

                #endregion
            }

            ioVoucherListElement.Add(voucherHeadIOElements);

            #endregion

            #region Close document

            rootElement.Add(ioVoucherListElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.IOVoucher);

            #endregion
        }

        private XDocument CreateIOCustomerInvoiceData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            AccountDim accountDimStd = AccountManager.GetAccountDimStd(es.ActorCompanyId);
            List<AccountDim> accountDimInternals = AccountManager.GetAccountDimInternalsByCompany(es.ActorCompanyId, true);
            List<AccountInternal> accountInternals = AccountManager.GetAccountInternals(es.ActorCompanyId, true);
            List<CustomerInvoiceHeadIO> customerInvoiceHeadIOs = ImportExportManager.GetCustomerInvoiceHeadIOResult(es.ActorCompanyId, es.SI_CustomerInvoiceHeadIOIds);

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "CustomerInvoiceIO");

            //VoucherList
            XElement customerInvoiceIOElement = new XElement("CustomerInvoiceIO");

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateBillingReportHeaderElement(es);
            customerInvoiceIOElement.Add(reportHeaderElement);

            #endregion

            #region ReportHeaderLabels

            //TODO set order/offer or invoice type to get the correct terms
            XElement reportHeaderLabelsElement = new XElement(CreateBillingReportHeaderLabelsElement(es.ReportTemplateType));
            customerInvoiceIOElement.Add(reportHeaderLabelsElement);


            #endregion

            #region PageHeaderLabels

            //TODO set order/offer or invoice type to get the correct terms
            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateBillingInvoiceHeadReportHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType, false);
            CreateBillingInvoiceRowsReportHeaderLabelsElement(pageHeaderLabelsElement, es.ReportTemplateType);

            customerInvoiceIOElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            XElement customerInvoiceHeadIOElement = null;
            var customerInvoiceHeadIOElements = new List<XElement>();
            var accountCache = new List<Account>();

            int customerInvoiceHeadeIOXmlId = 1;
            foreach (var customerInvoiceIO in customerInvoiceHeadIOs)
            {
                #region CustomerInvoiceHead

                #region Prereq

                string customerInvoiceNr = customerInvoiceIO.CustomerInvoiceNr.NullToEmpty();
                int seqNr = customerInvoiceIO.SeqNr ?? 0;
                string oCR = customerInvoiceIO.OCR.NullToEmpty();
                string batchId = customerInvoiceIO.BatchId.NullToEmpty();
                int registrationType = customerInvoiceIO.RegistrationType;
                int originType = customerInvoiceIO.OriginType;
                string customerNr = customerInvoiceIO.CustomerNr.NullToEmpty();
                string customerName = customerInvoiceIO.CustomerName.NullToEmpty();
                string paymentCondition = customerInvoiceIO.PaymentCondition.NullToEmpty();
                string invoiceDate = customerInvoiceIO.InvoiceDate?.ToShortDateString() ?? string.Empty;
                string dueDate = customerInvoiceIO.DueDate?.ToShortDateString() ?? string.Empty;
                string voucherDate = customerInvoiceIO.VoucherDate?.ToShortDateString() ?? string.Empty;
                string referenceOur = customerInvoiceIO.ReferenceOur.NullToEmpty();
                string referenceYour = customerInvoiceIO.ReferenceYour.NullToEmpty();
                decimal currencyRate = customerInvoiceIO.CurrencyRate ?? 1;
                string currencyDate = customerInvoiceIO.CurrencyDate?.ToShortDateString() ?? string.Empty;
                decimal totalAmount = customerInvoiceIO.TotalAmount ?? 0;
                decimal totalAmountCurrency = customerInvoiceIO.TotalAmountCurrency ?? 0;
                decimal vATAmount = customerInvoiceIO.VATAmount ?? 0;
                decimal vATAmountCurrency = customerInvoiceIO.VATAmountCurrency ?? 0;
                decimal paidAmount = customerInvoiceIO.PaidAmount ?? 0;
                decimal paidAmountCurrency = customerInvoiceIO.PaidAmountCurrency ?? 0;
                decimal remainingAmount = customerInvoiceIO.RemainingAmount ?? 0;
                decimal freightAmount = customerInvoiceIO.FreightAmount ?? 0;
                decimal freightAmountCurrency = customerInvoiceIO.FreightAmountCurrency ?? 0;
                decimal invoiceFee = customerInvoiceIO.InvoiceFee ?? 0;
                decimal invoiceFeeCurrency = customerInvoiceIO.InvoiceFeeCurrency ?? 0;
                decimal centRounding = customerInvoiceIO.CentRounding ?? 0;
                int fullyPayed = customerInvoiceIO.FullyPayed == true ? 1 : 0;
                int createAccountingInXE = customerInvoiceIO.CreateAccountingInXE == true ? 1 : 0;
                string paymentNr = customerInvoiceIO.PaymentNr.NullToEmpty();
                string voucherNr = customerInvoiceIO.VoucherNr.NullToEmpty();
                string note = customerInvoiceIO.Note.NullToEmpty();
                int billingType = customerInvoiceIO.BillingType ?? 0;
                string currency = customerInvoiceIO.Currency.NullToEmpty();
                string transferType = customerInvoiceIO.TransferType.NullToEmpty();
                string billingAddressAddress = customerInvoiceIO.BillingAddressAddress.NullToEmpty();
                string billingAddressCO = customerInvoiceIO.BillingAddressCO.NullToEmpty();
                string billingAddressPostNr = customerInvoiceIO.BillingAddressPostNr.NullToEmpty();
                string billingAddressCity = customerInvoiceIO.BillingAddressCity.NullToEmpty();
                string errorMessage = customerInvoiceIO.ErrorMessage.NullToEmpty();
                string errorMessageDetails = string.Empty;
                string created = customerInvoiceIO.Created?.ToShortDateString() ?? string.Empty;
                string createdBy = customerInvoiceIO.CreatedBy.NullToEmpty();
                string modified = customerInvoiceIO.Modified?.ToShortDateString() ?? string.Empty;
                string modifiedBy = customerInvoiceIO.ModifiedBy.NullToEmpty();

                #endregion

                #region CustomerInvoiceHeadIO element

                customerInvoiceHeadIOElement = new XElement("CustomerInvoiceHeadIO",
                    new XAttribute("Id", customerInvoiceHeadeIOXmlId),
                    new XElement("CustomerInvoiceNr", customerInvoiceNr),
                    new XElement("SeqNr", seqNr),
                    new XElement("OCR", oCR),
                    new XElement("BatchId", batchId),
                    new XElement("RegistrationType", registrationType),
                    new XElement("OriginType", originType),
                    new XElement("CustomerName", customerName),
                    new XElement("CustomerNr", customerNr),
                    new XElement("PaymentCondition", paymentCondition),
                    new XElement("InvoiceDate", invoiceDate),
                    new XElement("DueDate", dueDate),
                    new XElement("VoucherDate", voucherDate),
                    new XElement("ReferenceOur", referenceOur),
                    new XElement("ReferenceYour", referenceYour),
                    new XElement("CurrencyRate", currencyRate),
                    new XElement("CurrencyDate", currencyDate),
                    new XElement("TotalAmount", totalAmount),
                    new XElement("TotalAmountCurrency", totalAmountCurrency),
                    new XElement("VATAmount", vATAmount),
                    new XElement("VATAmountCurrency", vATAmountCurrency),
                    new XElement("PaidAmount", paidAmount),
                    new XElement("PaidAmountCurrency", paidAmountCurrency),
                    new XElement("RemainingAmount", remainingAmount),
                    new XElement("FreightAmount", freightAmount),
                    new XElement("FreightAmountCurrency", freightAmountCurrency),
                    new XElement("InvoiceFee", invoiceFee),
                    new XElement("InvoiceFeeCurrency", invoiceFeeCurrency),
                    new XElement("CentRounding", centRounding),
                    new XElement("FullyPayed", fullyPayed),
                    new XElement("CreateAccountingInXE", createAccountingInXE),
                    new XElement("PaymentNr", paymentNr),
                    new XElement("VoucherNr", voucherNr),
                    new XElement("Note", note),
                    new XElement("BillingType", billingType),
                    new XElement("Currency", currency),
                    new XElement("TransferType", transferType),
                    new XElement("ErrorMessage", errorMessage),
                    new XElement("ErrorMessageDetails", errorMessageDetails),
                    new XElement("Created", created),
                    new XElement("CreatedBy", createdBy),
                    new XElement("Modified", modified),
                    new XElement("ModifiedBy", modifiedBy),
                    new XElement("BillingAddressAddress", billingAddressAddress),
                    new XElement("BillingAddressCO", billingAddressCO),
                    new XElement("BillingAddressPostNr", billingAddressPostNr),
                    new XElement("BillingAddressCity", billingAddressCity),
                    new XElement("DeliveryAddressAddress", billingAddressCity),
                    new XElement("DeliveryAddressPostNr", billingAddressCity),
                    new XElement("DeliveryAddressCity", billingAddressCity));

                customerInvoiceHeadeIOXmlId++;

                #endregion

                int customerInvoiceRowXmlId = 1;
                foreach (var customerInvoiceRowIO in customerInvoiceIO.CustomerInvoiceRowIO)
                {
                    #region CustomerInvoiceRowIO element

                    #region Prereq

                    string rowbatchId = customerInvoiceRowIO.BatchId;
                    int rowType = customerInvoiceRowIO.CustomerRowType;
                    string rowinvoiceNr = customerInvoiceRowIO.InvoiceNr ?? string.Empty;
                    string rowProductNr = customerInvoiceRowIO.ProductNr ?? string.Empty;
                    string rowProductName = customerInvoiceRowIO.ProductName ?? string.Empty;
                    decimal rowQuantity = customerInvoiceRowIO.Quantity ?? 0;
                    decimal rowUnitPrice = customerInvoiceRowIO.UnitPrice ?? 0;
                    decimal rowDiscount = customerInvoiceRowIO.Discount ?? 0;
                    string rowAccountNr = customerInvoiceRowIO.AccountNr ?? string.Empty;
                    string rowAccountDim2Nr = customerInvoiceRowIO.AccountDim2Nr ?? string.Empty;
                    string rowAccountDim3Nr = customerInvoiceRowIO.AccountDim3Nr ?? string.Empty;
                    string rowAccountDim4Nr = customerInvoiceRowIO.AccountDim4Nr ?? string.Empty;
                    string rowAccountDim5Nr = customerInvoiceRowIO.AccountDim5Nr ?? string.Empty;
                    string rowAccountDim6Nr = customerInvoiceRowIO.AccountDim6Nr ?? string.Empty;
                    decimal rowPurchasePrice = customerInvoiceRowIO.PurchasePrice ?? 0;
                    decimal rowPurchasePriceCurrency = customerInvoiceRowIO.PurchasePriceCurrency ?? 0;
                    decimal rowAmount = customerInvoiceRowIO.Amount ?? 0;
                    decimal rowAmountCurrency = customerInvoiceRowIO.AmountCurrency ?? 0;
                    decimal rowVatAmount = customerInvoiceRowIO.VatAmount ?? 0;
                    decimal rowVatAmountCurrency = customerInvoiceRowIO.VatAmountCurrency ?? 0;
                    decimal rowDiscountAmount = customerInvoiceRowIO.DiscountAmount ?? 0;
                    decimal rowDiscountAmountCurrency = customerInvoiceRowIO.DiscountAmountCurrency ?? 0;
                    decimal rowMarginalIncome = customerInvoiceRowIO.MarginalIncome ?? 0;
                    decimal rowMarginalIncomeCurrency = customerInvoiceRowIO.MarginalIncomeCurrency ?? 0;
                    decimal rowSumAmount = customerInvoiceRowIO.SumAmount ?? 0;
                    decimal rowSumAmountCurrency = customerInvoiceRowIO.SumAmountCurrency ?? 0;
                    string rowText = customerInvoiceRowIO.Text ?? string.Empty;
                    string rowErrorMessage = customerInvoiceRowIO.ErrorMessage ?? string.Empty;
                    int rowNr = customerInvoiceRowIO.RowNr ?? 0;
                    string rowCreated = customerInvoiceRowIO.Created != null ? ((DateTime)(customerInvoiceRowIO.Created)).ToShortDateString() : string.Empty;
                    string rowCreatedBy = customerInvoiceRowIO.CreatedBy ?? string.Empty;
                    string rowModified = customerInvoiceRowIO.Modified != null ? ((DateTime)(customerInvoiceRowIO.Modified)).ToShortDateString() : string.Empty;
                    string rowModifiedBy = customerInvoiceRowIO.ModifiedBy ?? string.Empty;
                    decimal rowVatRate = customerInvoiceRowIO.VatRate ?? 0;
                    string rowUnit = customerInvoiceRowIO.Unit ?? string.Empty;

                    #endregion

                    XElement customerInvoiceRowIOElement = new XElement("CustomerInvoiceRowIO",
                        new XAttribute("Id", customerInvoiceRowXmlId),
                        new XElement("rowbatchId", rowbatchId),
                        new XElement("rowType", rowType),
                        new XElement("rowinvoiceNr", rowinvoiceNr),
                        new XElement("rowProductNr", rowProductNr),
                        new XElement("rowProductName", rowProductName),
                        new XElement("rowQuantity", rowQuantity),
                        new XElement("rowUnitPrice", rowUnitPrice),
                        new XElement("rowDiscount", rowDiscount),
                        new XElement("rowAccountNr", rowAccountNr),
                        new XElement("rowAccountDim2Nr", rowAccountDim2Nr),
                        new XElement("rowAccountDim3Nr", rowAccountDim3Nr),
                        new XElement("rowAccountDim4Nr", rowAccountDim4Nr),
                        new XElement("rowAccountDim5Nr", rowAccountDim5Nr),
                        new XElement("rowAccountDim6Nr", rowAccountDim6Nr),
                        new XElement("rowPurchasePrice", rowPurchasePrice),
                        new XElement("rowPurchasePriceCurrency", rowPurchasePriceCurrency),
                        new XElement("rowAmount", rowAmount),
                        new XElement("rowAmountCurrency", rowAmountCurrency),
                        new XElement("rowVatAmount", rowVatAmount),
                        new XElement("rowVatAmountCurrency", rowVatAmountCurrency),
                        new XElement("rowDiscountAmount", rowDiscountAmount),
                        new XElement("rowDiscountAmountCurrency", rowDiscountAmountCurrency),
                        new XElement("rowMarginalIncome", rowMarginalIncome),
                        new XElement("rowMarginalIncomeCurrency", rowMarginalIncomeCurrency),
                        new XElement("rowSumAmount", rowSumAmount),
                        new XElement("rowSumAmountCurrency", rowSumAmountCurrency),
                        new XElement("rowText", rowText),
                        new XElement("rowErrorMessage", rowErrorMessage),
                        new XElement("rowNr", rowNr),
                        new XElement("rowCreated", rowCreated),
                        new XElement("rowCreatedBy", rowCreatedBy),
                        new XElement("rowModified", rowModified),
                        new XElement("rowModifiedBy", rowModifiedBy),
                        new XElement("rowVatRate", rowVatRate),
                        new XElement("rowUnit", rowUnit));

                    customerInvoiceRowXmlId++;

                    List<string> rowErrorMessageDetails = new List<string>();

                    Account account = !string.IsNullOrEmpty(rowAccountNr) ? accountCache.FirstOrDefault(x => x.AccountNr == rowAccountNr && x.AccountDimId == accountDimStd.AccountDimId) : null;
                    if (account == null && !string.IsNullOrEmpty(rowAccountNr))
                    {
                        account = AccountManager.GetAccountByNr(rowAccountNr, accountDimStd.AccountDimId, es.ActorCompanyId);
                        if (account != null)
                            accountCache.Add(account);
                    }
                    if (account == null)
                        rowErrorMessageDetails.Add($"AccountNr not found: {rowAccountNr}");

                    int accountDimNr = 2;
                    foreach (AccountDim dim in accountDimInternals.Where(i => i.AccountDimNr != Constants.ACCOUNTDIM_STANDARD).OrderBy(i => i.AccountDimNr))
                    {
                        if (accountDimNr == 2 && !customerInvoiceRowIO.AccountDim2Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == customerInvoiceRowIO.AccountDim2Nr))
                            rowErrorMessageDetails.Add($"{dim.Name} not found: {customerInvoiceRowIO.AccountDim2Nr}");
                        else if (accountDimNr == 3 && !customerInvoiceRowIO.AccountDim3Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == customerInvoiceRowIO.AccountDim3Nr))
                            rowErrorMessageDetails.Add($"{dim.Name} not found: {customerInvoiceRowIO.AccountDim3Nr}");
                        else if (accountDimNr == 4 && !customerInvoiceRowIO.AccountDim4Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == customerInvoiceRowIO.AccountDim4Nr.NullToEmpty()))
                            rowErrorMessageDetails.Add($"{dim.Name} not found: {customerInvoiceRowIO.AccountDim4Nr}");
                        else if (accountDimNr == 5 && !customerInvoiceRowIO.AccountDim5Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == customerInvoiceRowIO.AccountDim5Nr))
                            rowErrorMessageDetails.Add($"{dim.Name} not found: {customerInvoiceRowIO.AccountDim5Nr}");
                        else if (accountDimNr == 6 && !customerInvoiceRowIO.AccountDim6Nr.IsNullOrEmpty() && !accountInternals.Any(i => i.Account.AccountDimId == dim.AccountDimId && i.Account.AccountNr == customerInvoiceRowIO.AccountDim6Nr))
                            rowErrorMessageDetails.Add($"{dim.Name} not found: {customerInvoiceRowIO.AccountDim6Nr}");
                    }

                    customerInvoiceRowIOElement.Add(
                         new XElement("rowErrorMessageDetails", rowErrorMessageDetails.ToCommaSeparated()));

                    customerInvoiceHeadIOElement.Add(customerInvoiceRowIOElement);

                    #endregion
                }

                customerInvoiceHeadIOElements.Add(customerInvoiceHeadIOElement);

                #endregion
            }

            customerInvoiceIOElement.Add(customerInvoiceHeadIOElements);

            #endregion

            #region Close document

            rootElement.Add(customerInvoiceIOElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.IOCustomerInvoice);

            #endregion
        }

        //private XDocument CreateIOSupplierInvoiceData(EvaluatedSelection es)
        //{
        //    #region Prereq

        //    if (es == null)
        //        return null;

        //    IEnumerable<ImportBatchDTO> importBatches = ImportExportManager.GetImportBatches(es.ActorCompanyId, TermGroup_IOImportHeadType.SupplierInvoice);
        //    List<SupplierInvoiceHeadIO> supplierInvoices = new List<SupplierInvoiceHeadIO>();

        //    #endregion

        //    #region Content

        //    foreach (ImportBatchDTO importBatch in importBatches)
        //    {
        //        supplierInvoices.AddRange(ImportExportManager.GetSupplierInvoiceHeadIOResult(es.ActorCompanyId, TermGroup_IOType.Unknown, TermGroup_IOSource.Unknown, importBatch.BatchId));
        //    }

        //    #endregion

        //    #region Close document

        //    return null;

        //    #endregion
        //}

        private XDocument CreateSEPAPaymentImportData(EvaluatedSelection es)
        {
            #region Prereq

            if (es == null)
                return null;

            #endregion

            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement(ROOT + "_" + "SEPAPaymentImport");

            //paymentImportElement
            XElement paymentImportElement = new XElement("SEPAPaymentImport");

            #endregion

            #region ReportHeader

            XElement reportHeaderElement = CreateSEPAPaymentImportReportHeaderElement(es);
            paymentImportElement.Add(reportHeaderElement);

            #endregion

            #region ReportHeaderLabels

            XElement reportHeaderLabelsElement = CreateSEPAPaymentImportReportHeaderLabelsElement();
            paymentImportElement.Add(reportHeaderLabelsElement);

            #endregion

            #region PageHeaderLabels

            //TODO
            XElement pageHeaderLabelsElement = new XElement("PageHeaderLabels");
            CreateSEPAPaymentImportPageHeaderLabelsElement(pageHeaderLabelsElement);

            paymentImportElement.Add(pageHeaderLabelsElement);

            #endregion

            #region Content

            var dataStorage = GeneralManager.GetDataStorages(ActorCompanyId, SoeDataStorageRecordType.SEPAPaymentImport).OrderByDescending(i => i.DataStorageId).FirstOrDefault();

            XElement element = XElement.Parse(dataStorage.XML);
            if (element == null)
                return null;

            List<XElement> paymentElements = element.Elements().ToList();
            foreach (XElement paymentElement in paymentElements)
            {
                paymentImportElement.Add(paymentElement);
            }

            #endregion

            #region Close document

            rootElement.Add(paymentImportElement);
            document.Add(rootElement);

            return GetValidatedDocument(document, SoeReportTemplateType.SEPAPaymentImportReport);

            #endregion

        }

        #endregion

        #region Export

        public XDocument CreateReportTransferXML(List<int> reportIds, int actorCompanyId)
        {
            #region Init document

            //Document
            XDocument document = XmlUtil.CreateDocument();

            //Root
            XElement rootElement = new XElement("Reports");

            #endregion

            using (CompEntities entities = new CompEntities())
            {
                foreach (var reportId in reportIds)
                {
                    #region Report

                    var report = ReportManager.GetReport(entities, reportId, actorCompanyId, false, true, false, true);

                    XElement reportElement = new XElement("Report");

                    reportElement.Add(new XElement("ReportTemplateId", report.ReportTemplateId));
                    reportElement.Add(new XElement("ReportSelectionId", report.ReportSelectionId));
                    reportElement.Add(new XElement("ReportNr", report.ReportNr));
                    reportElement.Add(new XElement("Name", report.Name));
                    reportElement.Add(new XElement("Description", report.Description));
                    reportElement.Add(new XElement("Standard", report.Standard));
                    reportElement.Add(new XElement("Original", report.Original));
                    reportElement.Add(new XElement("ExportType", report.ExportType));
                    reportElement.Add(new XElement("IncludeAllHistoricalData", report.IncludeAllHistoricalData));
                    reportElement.Add(new XElement("IncludeBudget", report.IncludeBudget));
                    reportElement.Add(new XElement("NoOfYearsBackinPreviousYear", report.NoOfYearsBackinPreviousYear));
                    reportElement.Add(new XElement("GetDetailedInformation", report.GetDetailedInformation));
                    reportElement.Add(new XElement("FileType", report.FileType));
                    reportElement.Add(new XElement("ShowInAccountingReports", report.ShowInAccountingReports));
                    reportElement.Add(new XElement("Module", report.Module));

                    #region ReportGroup

                    XElement reportGroupsElement = new XElement("ReportGroups");
                    var reportGroups = ReportManager.GetReportGroupsByReport(entities, reportId, actorCompanyId, true, true);

                    foreach (var reportGroup in reportGroups)
                    {
                        XElement reportGroupElement = new XElement("ReportGroup");

                        reportGroupElement.Add(new XElement("TemplateTypeId", reportGroup.TemplateTypeId));
                        reportGroupElement.Add(new XElement("Name", reportGroup.Name));
                        reportGroupElement.Add(new XElement("Description", reportGroup.Description));
                        reportGroupElement.Add(new XElement("ShowLabel", reportGroup.ShowLabel));
                        reportGroupElement.Add(new XElement("ShowSum", reportGroup.ShowSum));
                        reportGroupElement.Add(new XElement("InvertRow", reportGroup.InvertRow));
                        reportGroupElement.Add(new XElement("Module", reportGroup.Module));

                        #region ReportHeaders

                        XElement reportHeadersElement = new XElement("ReportHeaders");
                        var reportGroupHeaderMapping = reportGroup.ReportGroupHeaderMapping.OrderBy(i => i.Order);

                        foreach (var headerMapping in reportGroupHeaderMapping)
                        {
                            XElement reportHeaderElement = new XElement("ReportHeader");
                            var header = ReportManager.GetReportHeader(entities, headerMapping.ReportHeaderId, actorCompanyId, true);

                            reportHeaderElement.Add(new XElement("TemplateTypeId", header.TemplateTypeId));
                            reportHeaderElement.Add(new XElement("Name", header.Name));
                            reportHeaderElement.Add(new XElement("Description", header.Description));
                            reportHeaderElement.Add(new XElement("ShowRow", header.ShowRow));
                            reportHeaderElement.Add(new XElement("ShowSum", header.ShowSum));
                            reportHeaderElement.Add(new XElement("ShowLabel", header.ShowLabel));
                            reportHeaderElement.Add(new XElement("ShowZeroRow", header.ShowZeroRow));
                            reportHeaderElement.Add(new XElement("Module", header.Module));
                            reportHeaderElement.Add(new XElement("DoNotSummarizeOnGroup", header.DoNotSummarizeOnGroup));
                            reportHeaderElement.Add(new XElement("InvertRow", header.InvertRow));

                            #region ReportHeaderInterval

                            XElement reportHeaderIntervalsElement = new XElement("ReportHeaderIntervals");
                            var reportHeaderIntervals = ReportManager.GetReportHeaderIntervals(entities, header.ReportHeaderId);

                            foreach (var headerInterval in reportHeaderIntervals)
                            {
                                XElement reportHeaderInterval = new XElement("ReportHeaderInterval");

                                reportHeaderInterval.Add(new XElement("IntervalFrom", headerInterval.IntervalFrom));
                                reportHeaderInterval.Add(new XElement("IntervalTo", headerInterval.IntervalTo));
                                reportHeaderInterval.Add(new XElement("SelectValue", headerInterval.SelectValue));

                                reportHeaderIntervalsElement.Add(reportHeaderInterval);
                            }

                            reportHeaderElement.Add(reportHeaderIntervalsElement);

                            #endregion

                            reportGroupElement.Add(reportHeaderElement);
                        }

                        #endregion

                        reportGroupsElement.Add(reportGroupElement);
                    }

                    reportElement.Add(reportGroupsElement);

                    #endregion //ReportGroup

                    #endregion //Report

                    rootElement.Add(reportElement);
                }
            }

            #region Close document

            document.Add(rootElement);

            #endregion

            return document;
        }

        #endregion
    }
}
