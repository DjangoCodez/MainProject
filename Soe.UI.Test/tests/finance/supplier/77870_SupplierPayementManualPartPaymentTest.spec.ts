import { test } from '../../fixtures/finance-fixture';
import * as allure from "allure-js-commons";
import { getAccountExValue } from '../../../utils/properties';
import { SupplierInvoiceUtil } from '../../../apis/utils/SupplierInvoiceUtil';
import { getDateUtil } from '../../../utils/CommonUtil';

let testCaseId: string = '77870';
let envUrl: string;
let invoiceNo_1: string;
let invoiceUtil: SupplierInvoiceUtil;
const payAmount = '100,00';

test.beforeEach(async ({ page, accountEx, financeBasePage }) => {
    await allure.parentSuite("Finance");
    await allure.suite("Supplier");
    await allure.subSuite("Supplier");
    await allure.link('https://dev.azure.com/softonedev/XE/_workitems/edit/' + testCaseId, "Test case : " + testCaseId);
    envUrl = accountEx.baseUrl;
    await financeBasePage.SetupFinance(envUrl, getAccountExValue(accountEx, 'role')?.toString() ?? 'Admin');
    invoiceNo_1 = testCaseId + Math.floor(100000 + Math.random() * 900000);
    invoiceUtil = new SupplierInvoiceUtil(page, envUrl);
    await invoiceUtil.CreateSupplierInvoice(invoiceNo_1);
});

test(testCaseId + ': Supplier Payment ManualPartPayment : AP', { tag: ['@Finance', '@Supplier', '@Regression'] }, async ({ financeBasePage, accountPayableSettingsPage, financeInvoicePageJS, paymentsPage }) => {
    await financeBasePage.goToMenu('Settings_Finance', 'Settings', true, 'Accounts Payable');
    await accountPayableSettingsPage.transferInvoiceToVoucher();
    await accountPayableSettingsPage.saveAccountPayableSettings();
    await financeBasePage.goToMenu('Supplier', 'Invoices');
    await financeInvoicePageJS.filterByInvoiceNo(invoiceNo_1);
    await financeInvoicePageJS.editInvoice();
    await financeInvoicePageJS.expandAttest();
    await financeInvoicePageJS.clickToAttestation();
    await financeBasePage.goToMenu('Supplier', 'Payments');
    await paymentsPage.filterByInvoiceNo(invoiceNo_1);
    await paymentsPage.editPayment();
    await paymentsPage.expandCodingRows();
    await paymentsPage.verifyBalanceOfAccountingRows();
    await paymentsPage.fullyPaid();
    const today = await getDateUtil(0);
    await paymentsPage.enterPayementDate(today, 1);
    const paymentAmount = await paymentsPage.getPaymentAmount();
    await paymentsPage.enterPayAmount(payAmount);
    await paymentsPage.saveandCloseNewPayment();
    const toPay: string = (parseFloat(paymentAmount.replace(/[\s\u00A0]/g, '').split(',')[0]) - parseFloat(payAmount.split(',')[0])).toFixed(2).toString().replace('.', ',');
    await paymentsPage.verifyAmountToPay(toPay);
    await paymentsPage.editPayment();
    await paymentsPage.enterPayementDate(today, 1);
    await paymentsPage.saveandCloseNewPayment();
    await paymentsPage.verifyFilteredRowCount(0);
});







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































